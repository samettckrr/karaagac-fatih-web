<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Ramazan-ı Şerif Personel Tablosu</title>
  <meta name="viewport" content="width=1122" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Amiri:wght@400;700&family=Cormorant+Garamond:wght@500;600;700&family=Noto+Sans+Arabic:wght@400;600&family=Source+Sans+3:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
      --ramazan-green: #0d5c36;
      --ramazan-green-light: #1a7a4c;
      --ramazan-gold: #c9a227;
      --ramazan-gold-light: #e8d48b;
      --ramazan-cream: #faf8f3;
      --ramazan-border: #2d6a4f;
      --ramazan-text: #1a3d2e;
      --ramazan-muted: #5a7c6e;
    }
    body {
      font-family: 'Cormorant Garamond', 'Georgia', serif;
      background: #e8e4dc;
      color: var(--ramazan-text);
      min-height: 100vh;
      padding: 12px;
      -webkit-print-color-adjust: exact;
      print-color-adjust: exact;
      min-width: 297mm;
    }
    @page {
      size: A4 landscape;
      margin: 10mm 12mm;
    }
    @media print {
      body { padding: 0; background: #fff; }
      .no-print { display: none !important; }
      .sheet { box-shadow: none; border: none; }
    }
    .sheet {
      width: 297mm;
      min-width: 297mm;
      min-height: 210mm;
      margin: 0 auto;
      background: var(--ramazan-cream);
      box-shadow: 0 8px 32px rgba(13, 92, 54, 0.12);
      border-radius: 4px;
      overflow: hidden;
      position: relative;
    }
    /* Ramazan temalı üst şerit */
    .header-band {
      background: linear-gradient(135deg, var(--ramazan-green) 0%, var(--ramazan-green-light) 100%);
      padding: 10px 16px 12px;
      text-align: center;
      position: relative;
      border-bottom: 3px solid var(--ramazan-gold);
    }
    .header-band .header-logo {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      height: 36px;
      width: auto;
      max-width: 80px;
      object-fit: contain;
    }
    .header-band .header-logo.left { left: 16px; }
    .header-band .header-logo.right { right: 16px; }
    .header-title {
      font-family: 'Amiri', 'Noto Sans Arabic', serif;
      font-size: 22px;
      font-weight: 700;
      color: #fff;
      letter-spacing: 1px;
    }
    .header-subtitle {
      font-size: 12px;
      color: var(--ramazan-gold-light);
      margin-top: 2px;
      letter-spacing: 0.5px;
    }
    /* Personel adı alanı */
    .personel-name-block {
      padding: 10px 16px 8px;
      text-align: center;
      border-bottom: 1px dashed var(--ramazan-border);
      background: linear-gradient(180deg, rgba(201, 162, 39, 0.06) 0%, transparent 100%);
    }
    .personel-name {
      font-size: 24px;
      font-weight: 900;
      color: var(--ramazan-green);
    }
    /* Tablo - sabit boyut, dar cihazda kullanıcı kaydırsın */
    .table-wrap {
      padding: 8px 12px 16px;
      overflow: visible;
    }
    .ramazan-table {
      width: 100%;
      table-layout: fixed;
      border-collapse: collapse;
      font-size: 10px;
    }
    .ramazan-table thead th {
      background: var(--ramazan-green);
      color: #fff;
      padding: 6px 4px;
      text-align: center;
      font-weight: 600;
      border: 1px solid var(--ramazan-green-light);
      line-height: 1.2;
      font-family: 'Source Sans 3', 'Segoe UI', system-ui, -apple-system, sans-serif;
    }
    .ramazan-table thead th:first-child { width: 11%; }
    .ramazan-table thead th:nth-child(2),
    .ramazan-table thead th:nth-child(3),
    .ramazan-table thead th:nth-child(4) { width: 10%; }
    .ramazan-table thead th:nth-child(5),
    .ramazan-table thead th:nth-child(6) { width: 10%; }
    .ramazan-table thead th:nth-child(7) { width: 8%; }
    .ramazan-table thead th:nth-child(8),
    .ramazan-table thead th:nth-child(9),
    .ramazan-table thead th:nth-child(10) { width: 9%; }
    .ramazan-table tbody td {
      border: 1px solid #c4d4cc;
      padding: 4px 5px;
      background: #fff;
      vertical-align: middle;
    }
    .ramazan-table tbody tr:nth-child(even) td {
      background: #f5f9f6;
    }
    .ramazan-table .col-tarih {
      text-align: center;
      font-weight: 500;
      color: var(--ramazan-text);
      font-family: 'Source Sans 3', 'Segoe UI', system-ui, -apple-system, sans-serif;
      font-variant-numeric: tabular-nums;
    }
    .ramazan-table .col-number,
    .ramazan-table .col-tutar,
    .ramazan-table .col-kalan {
      font-family: 'Source Sans 3', 'Segoe UI', system-ui, -apple-system, sans-serif;
      font-variant-numeric: tabular-nums;
    }
    .ramazan-table .col-iftar-sahur {
      text-align: center;
      font-size: 8px;
      line-height: 1.25;
      word-break: break-word;
      overflow: hidden;
      font-weight: 900;
    }
    .ramazan-table .col-musafir {
      text-align: center;
      font-variant-numeric: tabular-nums;
      font-family: 'Source Sans 3', 'Segoe UI', system-ui, -apple-system, sans-serif;
    }
    .ramazan-table .col-number {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }
    .ramazan-table .col-tutar {
      text-align: right;
      font-variant-numeric: tabular-nums;
      font-weight: 700;
    }
    .ramazan-table .col-tahsilat {
      text-align: right;
      font-variant-numeric: tabular-nums;
      font-weight: 700;
      color: #0d5c36;
      font-family: 'Source Sans 3', 'Segoe UI', system-ui, -apple-system, sans-serif;
    }
    .ramazan-table .col-kalan {
      text-align: right;
      font-variant-numeric: tabular-nums;
      font-weight: 700;
      color: #1a1a1a;
    }
    .ramazan-table .col-kalan.positive {
      color: #b71c1c;
    }
    /* Alt toplam satırı */
    .ramazan-table tfoot td {
      background: linear-gradient(180deg, #e8f0eb 0%, #d4e5da 100%) !important;
      border: 1px solid var(--ramazan-border);
      padding: 6px 5px;
      font-weight: 700;
      text-align: right;
    }
    .ramazan-table tfoot td:first-child {
      text-align: center;
      font-weight: 700;
      color: var(--ramazan-green);
    }
    .ramazan-table tfoot td.tfoot-adet {
      text-align: center;
      font-family: 'Source Sans 3', 'Segoe UI', system-ui, -apple-system, sans-serif;
      font-variant-numeric: tabular-nums;
    }
    /* Dekoratif alt */
    .footer-band {
      margin-top: auto;
      padding: 6px 16px;
      text-align: center;
      font-size: 10px;
      color: var(--ramazan-muted);
      border-top: 1px solid #c4d4cc;
      background: rgba(13, 92, 54, 0.04);
    }
    .no-print {
      text-align: center;
      margin: 10px auto;
      max-width: 297mm;
    }
    .no-print button {
      background: var(--ramazan-green);
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font: 600 14px 'Cormorant Garamond', serif;
      cursor: pointer;
    }
    .no-print button:hover { background: var(--ramazan-green-light); }
  </style>
</head>
<body>
  <div class="sheet">
    <header class="header-band">
      <img src="../img/logo.png" alt="" class="header-logo left" />
      <div class="header-title">Ramazan-ı Şerif</div>
      <div class="header-subtitle">Personele Özel İftar & Sahur Takip Tablosu</div>
      <img src="../img/logo.png" alt="" class="header-logo right" />
    </header>
    <div class="personel-name-block">
      <div class="personel-name" id="personelAdi">—</div>
    </div>
    <div class="table-wrap">
      <table class="ramazan-table">
        <thead>
          <tr>
            <th>Tarih</th>
            <th>İftar 1</th>
            <th>İftar 2</th>
            <th>İftar 3</th>
            <th>Sahur 1</th>
            <th>Sahur 2</th>
            <th>Toplam Müsafir</th>
            <th>Toplam Tutar</th>
            <th>Toplam Tahsilat</th>
            <th>Kalan Borç</th>
          </tr>
        </thead>
        <tbody id="tabloBody"></tbody>
        <tfoot>
          <tr>
            <td>TOPLAM</td>
            <td colspan="3" class="tfoot-adet">İftar toplam adet: <span id="toplamIftarAdet">0</span></td>
            <td colspan="2" class="tfoot-adet">Sahur toplam adedi: <span id="toplamSahurAdet">0</span></td>
            <td class="col-musafir" id="toplamMusafir">0</td>
            <td class="col-tutar" id="toplamTutar">₺0,00</td>
            <td class="col-tahsilat" id="toplamTahsilat">₺0,00</td>
            <td class="col-kalan" id="toplamKalan">₺0,00</td>
          </tr>
        </tfoot>
      </table>
    </div>
  </div>
  <div class="no-print">
    <button type="button" onclick="window.print();">Yazdır / PDF</button>
  </div>

  <script>
    (function () {
      function getRamazanTarihListesiFromRange(baslangicStr, bitisStr) {
        if (!baslangicStr || !bitisStr) return null;
        var basParts = baslangicStr.split('-');
        var bitParts = bitisStr.split('-');
        if (basParts.length < 3 || bitParts.length < 3) return null;
        var ramazanBas = new Date(parseInt(basParts[0], 10), parseInt(basParts[1], 10) - 1, parseInt(basParts[2], 10), 12, 0, 0);
        var ramazanBitis = new Date(parseInt(bitParts[0], 10), parseInt(bitParts[1], 10) - 1, parseInt(bitParts[2], 10), 12, 0, 0);
        if (isNaN(ramazanBas.getTime()) || isNaN(ramazanBitis.getTime()) || ramazanBas > ramazanBitis) return null;
        var list = [];
        var d = new Date(ramazanBas.getFullYear(), ramazanBas.getMonth(), ramazanBas.getDate());
        var end = new Date(ramazanBitis.getFullYear(), ramazanBitis.getMonth(), ramazanBitis.getDate());
        while (d <= end) {
          var y = d.getFullYear(), m = d.getMonth() + 1, day = d.getDate();
          var value = y + '-' + (m < 10 ? '0' : '') + m + '-' + (day < 10 ? '0' : '') + day;
          list.push({
            value: value,
            label: d.toLocaleDateString('tr-TR', { day: 'numeric', month: 'short', year: 'numeric' })
          });
          d.setDate(d.getDate() + 1);
        }
        return list;
      }

      function getRamazanTarihListesi(yil) {
        var ramazanBas, ramazanBitis;
        if (yil === 2026) {
          ramazanBas = new Date(2026, 0, 28);
          ramazanBitis = new Date(2026, 1, 26);
        } else if (yil === 2025) {
          ramazanBas = new Date(2025, 1, 28);
          ramazanBitis = new Date(2025, 2, 29);
        } else {
          ramazanBas = new Date(yil, 2, 11);
          ramazanBitis = new Date(yil, 3, 9);
        }
        var list = [];
        var d = new Date(ramazanBas);
        while (d <= ramazanBitis) {
          list.push({
            value: d.toISOString().slice(0, 10),
            label: d.toLocaleDateString('tr-TR', { day: 'numeric', month: 'short', year: 'numeric' })
          });
          d.setDate(d.getDate() + 1);
        }
        return list;
      }

      function renderEmpty(yil, baslangicStr, bitisStr) {
        yil = parseInt(yil, 10) || new Date().getFullYear();
        if (yil < 2024) yil = 2025;
        var gunler = getRamazanTarihListesiFromRange(baslangicStr, bitisStr) || getRamazanTarihListesi(yil);
        var tbody = document.getElementById('tabloBody');
        tbody.innerHTML = '';
        gunler.forEach(function (g) {
          var tr = document.createElement('tr');
          tr.innerHTML =
            '<td class="col-tarih">' + g.label + '</td>' +
            '<td class="col-iftar-sahur"></td><td class="col-iftar-sahur"></td><td class="col-iftar-sahur"></td>' +
            '<td class="col-iftar-sahur"></td><td class="col-iftar-sahur"></td>' +
            '<td class="col-musafir">0</td>' +
            '<td class="col-tutar">₺0,00</td>' +
            '<td class="col-tutar">₺0,00</td>' +
            '<td class="col-kalan">₺0,00</td>';
          tr.dataset.tarih = g.value;
          tbody.appendChild(tr);
        });
        document.getElementById('toplamMusafir').textContent = '0';
        document.getElementById('toplamIftarAdet').textContent = '0';
        document.getElementById('toplamSahurAdet').textContent = '0';
        document.getElementById('toplamTutar').textContent = '₺0,00';
        document.getElementById('toplamTahsilat').textContent = '₺0,00';
        document.getElementById('toplamKalan').textContent = '₺0,00';
      }

      function formatPara(n) {
        return '₺' + (Number(n) || 0).toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      }

      function renderFromData(data) {
        var personelAdi = data.personelAdi || data.personel_adi || '—';
        var yil = data.yil || new Date().getFullYear();
        var satirlar = data.satirlar || [];
        var gunlukVeriler = data.gunlukVeriler || null;
        var baslangic = data.baslangic || null;
        var bitis = data.bitis || null;
        var gunler = getRamazanTarihListesiFromRange(baslangic, bitis) || getRamazanTarihListesi(yil);

        document.getElementById('personelAdi').textContent = personelAdi;

        var toplamMusafir = 0, toplamTutar = 0, toplamTahsilat = 0;
        var satirMap = {};

        if (gunlukVeriler && typeof gunlukVeriler === 'object') {
          Object.keys(gunlukVeriler).forEach(function (tarihStr) {
            var t = tarihStr.slice(0, 10);
            var g = gunlukVeriler[tarihStr];
            if (!satirMap[t]) satirMap[t] = { iftar: [], sahur: [], musafir: 0, tutar: 0, tahsilat: 0 };
            var row = satirMap[t];
            var iftarlar = g.iftarlar || g.iftar || [];
            var sahurlar = g.sahurlar || g.sahur || [];
            if (!Array.isArray(iftarlar)) iftarlar = [iftarlar];
            if (!Array.isArray(sahurlar)) sahurlar = [sahurlar];
            row.iftar = [iftarlar[0] || '', iftarlar[1] || '', iftarlar[2] || ''];
            row.sahur = [sahurlar[0] || '', sahurlar[1] || ''];
            row.musafir = Number(g.musafir) || 0;
            row.tutar = Number(g.tutar) || 0;
            row.tahsilat = Number(g.tahsilat) || 0;
          });
        }

        satirlar.forEach(function (s) {
          var t = (s.tarih || '').toString().slice(0, 10);
          if (!satirMap[t]) satirMap[t] = { tarih: t, iftar: [], sahur: [], musafir: 0, tutar: 0, tahsilat: 0 };
          var row = satirMap[t];
          if (s.iftar1 !== undefined) row.iftar[0] = s.iftar1;
          if (s.iftar2 !== undefined) row.iftar[1] = s.iftar2;
          if (s.iftar3 !== undefined) row.iftar[2] = s.iftar3;
          if (s.sahur1 !== undefined) row.sahur[0] = s.sahur1;
          if (s.sahur2 !== undefined) row.sahur[1] = s.sahur2;
          row.musafir = (row.musafir || 0) + (Number(s.musafir) || 0);
          row.tutar = (row.tutar || 0) + (Number(s.tutar) || 0);
          row.tahsilat = (row.tahsilat || 0) + (Number(s.tahsilat) || 0);
        });

        var toplamIftarAdet = 0;
        var toplamSahurAdet = 0;
        var tbody = document.getElementById('tabloBody');
        tbody.innerHTML = '';
        gunler.forEach(function (g) {
          var row = satirMap[g.value] || { iftar: [], sahur: [], musafir: 0, tutar: 0, tahsilat: 0 };
          var kalan = (row.tutar || 0) - (row.tahsilat || 0);
          toplamMusafir += row.musafir || 0;
          toplamTutar += row.tutar || 0;
          toplamTahsilat += row.tahsilat || 0;

          var iftar1 = (row.iftar && row.iftar[0]) ? String(row.iftar[0]).trim() : '';
          var iftar2 = (row.iftar && row.iftar[1]) ? String(row.iftar[1]).trim() : '';
          var iftar3 = (row.iftar && row.iftar[2]) ? String(row.iftar[2]).trim() : '';
          var sahur1 = (row.sahur && row.sahur[0]) ? String(row.sahur[0]).trim() : '';
          var sahur2 = (row.sahur && row.sahur[1]) ? String(row.sahur[1]).trim() : '';
          if (iftar1) toplamIftarAdet++;
          if (iftar2) toplamIftarAdet++;
          if (iftar3) toplamIftarAdet++;
          if (sahur1) toplamSahurAdet++;
          if (sahur2) toplamSahurAdet++;

          var tr = document.createElement('tr');
          tr.innerHTML =
            '<td class="col-tarih">' + g.label + '</td>' +
            '<td class="col-iftar-sahur">' + iftar1 + '</td>' +
            '<td class="col-iftar-sahur">' + iftar2 + '</td>' +
            '<td class="col-iftar-sahur">' + iftar3 + '</td>' +
            '<td class="col-iftar-sahur">' + sahur1 + '</td>' +
            '<td class="col-iftar-sahur">' + sahur2 + '</td>' +
            '<td class="col-musafir">' + (row.musafir || 0) + '</td>' +
            '<td class="col-tutar">' + formatPara(row.tutar) + '</td>' +
            '<td class="col-tahsilat">' + formatPara(row.tahsilat) + '</td>' +
            '<td class="col-kalan' + (kalan > 0 ? ' positive' : '') + '">' + formatPara(kalan) + '</td>';
          tbody.appendChild(tr);
        });

        var genelKalan = toplamTutar - toplamTahsilat;
        document.getElementById('toplamMusafir').textContent = toplamMusafir;
        document.getElementById('toplamIftarAdet').textContent = toplamIftarAdet;
        document.getElementById('toplamSahurAdet').textContent = toplamSahurAdet;
        document.getElementById('toplamTutar').textContent = formatPara(toplamTutar);
        document.getElementById('toplamTahsilat').textContent = formatPara(toplamTahsilat);
        document.getElementById('toplamKalan').textContent = formatPara(genelKalan);
        if (genelKalan > 0) document.getElementById('toplamKalan').classList.add('positive');
        else document.getElementById('toplamKalan').classList.remove('positive');
      }

      var params = new URLSearchParams(window.location.search);
      var key = params.get('key');
      var dataParam = params.get('data');
      var yilParam = params.get('yil');

      if (key) {
        try {
          var raw = localStorage.getItem(key);
          if (raw) {
            var data = JSON.parse(raw);
            renderFromData(data);
          } else {
            renderEmpty(yilParam || new Date().getFullYear());
          }
        } catch (e) {
          renderEmpty(yilParam || new Date().getFullYear());
        }
      } else if (dataParam) {
        try {
          var data = JSON.parse(decodeURIComponent(dataParam));
          renderFromData(data);
        } catch (e) {
          renderEmpty(yilParam || new Date().getFullYear());
        }
      } else {
        renderEmpty(yilParam || 2026);
      }
    })();
  </script>
</body>
</html>
