<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Hedef Grafik | Karaağaç Fatih</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <link rel="icon" type="image/png" href="../../img/logo.png" />

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="../../js/firebase/firebase-init.js"></script>

  <style>
    :root{
      /* iOS-layout */
      --appbar-h: calc(56px + env(safe-area-inset-top));
      --tabbar-h: calc(64px + env(safe-area-inset-bottom));
      --radius:14px; --shadow:0 12px 28px rgba(0,0,0,.14);

      /* Dark tema (varsayılan) */
      --bg:#0f172a; --bg2:#0b1324;
      --card:rgba(15,23,42,.92); --stroke:rgba(148,163,184,.18);
      --text:#e5e7eb; --muted:#9aa4b2; --brand:#38bdf8; --brand2:#0ea5e9;
      --pill:#0b1220; --pill-hover:#101a2b; --surface:rgba(2,6,23,.08);
      --good:#22c55e; --warn:#f59e0b; --bad:#ef4444;
      --kpi1:#38bdf8; --kpi2:#22c55e; --kpi3:#f59e0b;
    }
    /* Light override */
    html[data-theme="light"]{
      --bg:#eef6ff; --bg2:#f7fbff;
      --card:rgba(255,255,255,.95); --stroke:rgba(15,23,42,.12);
      --text:#0b1220; --muted:#4b5563; --brand:#0ea5e9; --brand2:#0284c7;
      --pill:#f5f8ff; --pill-hover:#e9f2ff; --surface:#eef3ff;
      --good:#16a34a; --warn:#d97706; --bad:#dc2626;
      --kpi1:#0284c7; --kpi2:#16a34a; --kpi3:#d97706;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      font-family:ui-sans-serif,-apple-system,"Segoe UI",Roboto,Arial;
      background: linear-gradient(140deg, var(--bg), var(--bg2) 60%);
      overflow:hidden; /* gerçek scroll .app’te */
    }

    /* Appbar (çentik dostu, sade) */
    .appbar{
      position:fixed; inset:0 0 auto 0; height:var(--appbar-h);
      padding-top:env(safe-area-inset-top);
      background:linear-gradient(180deg,var(--card),transparent);
      backdrop-filter:saturate(140%) blur(8px);
      border-bottom:1px solid var(--stroke);
      z-index:50; display:flex; align-items:flex-end;
    }
    .appbar .inner{display:flex; align-items:center; justify-content:space-between; width:100%; padding:12px 16px 10px}
    .titleArea{display:flex; flex-direction:column; gap:2px}
    .titleArea .l1{font-weight:800; font-size:18px}
    .titleArea .l2{font-size:12.5px; color:var(--muted)}
    .titleArea .bullet{opacity:.5; padding:0 6px}

    /* Scroll alanı */
    .app{
      height: calc(100vh - var(--appbar-h) - var(--tabbar-h));
      padding-top:var(--appbar-h);
      padding-bottom:var(--tabbar-h);
      overflow:auto; -webkit-overflow-scrolling:touch;
      background: linear-gradient(180deg,var(--bg),var(--bg2));
    }

      /* —— Tabbar kompakt yükseklik —— */
      :root{
        /* önceki 64px yerine biraz kısalttık */
        --tabbar-h: calc(56px + env(safe-area-inset-bottom));
      }

      /* —— Tabbar gövde —— */
      .tabbar{
        position:fixed; inset:auto 0 0 0; height:var(--tabbar-h);
        padding-bottom:env(safe-area-inset-bottom);
        border-top:1px solid var(--stroke);
        background:var(--bg2);
        z-index:60; display:flex; align-items:center; justify-content:center;
        transform:translateZ(0);
      }
      /* üstteki beyaz bant ihtimalini kapatan maske */
      .tabbar::before{
        content:""; position:absolute; left:0; right:0; top:-10px; height:10px;
        background:var(--bg2); pointer-events:none;
      }

      /* —— Rail: tek satır, kaydırılabilir —— */
      .tabbar > .rail{
        display:flex !important;
        flex-direction:row !important;
        flex-wrap:nowrap !important;
        align-items:center; justify-content:center;
        gap:12px; max-width:1100px; width:100%;
        /* alt pedleri azalttık; toplam yükseklik küçülsün */
        padding:6px 10px;
        overflow-x:auto; -webkit-overflow-scrolling:touch;
        white-space:nowrap;
        box-shadow:none;
      }

      /* —— Tıklanabilir butonlar (anchor'ları zorla buton yap) —— */
      .tbtn,
      .tbtn:link, .tbtn:visited, .tbtn:hover, .tbtn:active{
        display:flex; flex-direction:column; align-items:center; gap:4px;
        min-width:72px; padding:6px 8px;
        color:var(--muted) !important;
        text-decoration:none !important;
        border-radius:12px;
      }
      .tbtn .ico{ font-size:20px; line-height:20px }
      .tbtn .lbl{ font-size:11.5px; line-height:1; text-decoration:none }
      .tbtn.active{ color:var(--brand) !important }
      .tbtn.home{ background:transparent; color:inherit; border:1px dashed var(--stroke) }


    /* Sayfa içi bileşenler (mevcudu koruyarak) */
    .container{max-width:1200px; margin:12px auto; padding:0 16px}
    .hero{display:flex; justify-content:space-between; align-items:flex-start; gap:16px; background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius); padding:16px; margin:12px 0; box-shadow:var(--shadow)}
    .hero h2{margin:0 0 6px; font-size:20px}
    .hero-sub{color:var(--muted); font-size:13px; line-height:1.35; margin-bottom:10px;}
    .mini{display:flex; gap:8px; flex-wrap:wrap}
    .pill{padding:6px 10px; border-radius:999px; border:1px solid var(--stroke); background:var(--pill); font-size:12px}
    .pill.small{font-size:11px; padding:4px 8px}

    .grid{display:grid; gap:14px; grid-template-columns:repeat(12, minmax(0,1fr))}
    .col-12{grid-column:span 12} .col-6{grid-column:span 6} .col-4{grid-column:span 4} .col-8{grid-column:span 8}
    .card{background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px}
    .card h3{margin:0 0 10px; font-size:16px}
    .kpi{position:relative; display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px; border-radius:12px; border:1px solid var(--stroke); background:var(--surface)}
    .kpi .val{font-size:22px; font-weight:800}
    .kpi .sub{font-size:12px; color:var(--muted)}
    .kpi.has-bar{ padding-bottom:28px; position:relative }
    .kpi-bar{
      position:absolute; left:12px; right:12px; bottom:10px; height:6px;
      border-radius:999px; background:var(--surface); overflow:hidden; border:1px solid var(--stroke); z-index:1
    }
    .kpi-bar > span{ display:block; height:100%; width:0%; background:linear-gradient(90deg, var(--good), var(--brand2)) }
    .kpi-ok{ margin-left:auto }   /* tik sağda kalsın */

    /* TABLO — tek satır ₺ ve sayılar */
    #hedefTablosu{width:100%; border-collapse:separate; border-spacing:0 8px;}
    #hedefTablosu thead th{background:var(--surface); padding:10px 12px; border-bottom:1px solid var(--stroke); text-align:center}
    #hedefTablosu tbody td{background:var(--card); border:1px solid var(--stroke); padding:12px; text-align:center}
    #hedefTablosu tbody td:first-child{text-align:left; border-top-left-radius:10px; border-bottom-left-radius:10px}
    #hedefTablosu tbody td:last-child{border-top-right-radius:10px; border-bottom-right-radius:10px}

    /* <<< kritik: tek satır para gösterimi */
    td.money{ white-space:nowrap; font-variant-numeric: tabular-nums; line-height:1.1 }
    @media (max-width:480px){ td.money{ font-size:13px } }
    @media (max-width:360px){ td.money{ font-size:12.5px } }

    .progress{position:relative; width:100%; height:28px; border-radius:999px; border:1px solid var(--stroke); background:var(--surface); overflow:hidden}
    .progress > .fill{position:absolute; inset:0 auto 0 0; width:0%; height:100%; background:linear-gradient(90deg, var(--brand2), var(--brand));}
    .progress > .label{position:relative; z-index:2; font-weight:800; line-height:28px}

    /* Modal (değişmedi) */
    .modal-arka{display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:120}
    .modal-icerik{position:relative; max-width:980px; width:95%; margin:40px auto; background:var(--card); border:1px solid var(--stroke); border-radius:12px; box-shadow:var(--shadow); padding:16px; max-height:92vh; overflow:auto}
    .modal-baslik{display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--stroke); padding-bottom:8px; margin-bottom:12px}
    .modal-kapat{border:1px solid var(--stroke); background:var(--pill); color:var(--text); padding:8px 12px; border-radius:999px; cursor:pointer}
    .ozet{display:grid; grid-template-columns:repeat(5,minmax(0,1fr)); gap:10px}
    .hareket-kap{overflow-x:auto; margin-top:12px}
    .hareket-tablo{width:100%; min-width:720px; border-collapse:separate; border-spacing:0 6px}
    .hareket-tablo th,.hareket-tablo td{padding:8px 10px; border-bottom:1px solid var(--stroke); text-align:center; white-space:nowrap}
    .etiket{display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; font-weight:700}
    .etiket-hedef{background:#eaf7ff; color:#0b6dbf; border:1px solid #cde8ff}
    .etiket-teberru{background:#fff2e6; color:#c45a00; border:1px solid #ffd9b3}

    /* Sheet (panel/rapor ile aynı) */
    .sheet-backdrop{position:fixed; inset:0; z-index:59; display:none}
    .sheet{
      position:fixed; left:10px; right:10px; bottom:calc(var(--tabbar-h) + 10px);
      background:var(--card); border:1px solid var(--stroke); border-radius:18px; box-shadow:var(--shadow);
      z-index:61; display:none; max-height:40vh; overflow:auto;
    }
    .sheet .grip{width:44px; height:5px; background:var(--stroke); border-radius:999px; margin:8px auto}
    .sheet .title{padding:6px 14px; font-weight:800}
    .sheet .list{display:flex; flex-direction:column}
    .sheet .item{padding:12px 14px; border-top:1px dashed var(--stroke); display:flex; align-items:center; justify-content:space-between; gap:10px}
    .sheet .item .go{font-size:18px; opacity:.6}

    @media (max-width:1024px){
      .ozet{grid-template-columns:repeat(2,minmax(0,1fr))}
      .col-8,.col-4,.col-6,.col-12{grid-column:span 12}
      .modal-icerik{width:96%; padding:12px}
      .hareket-tablo th,.hareket-tablo td{padding:6px 8px; font-size:13px}
    }
    @media (max-width:640px){ .ozet{grid-template-columns:1fr} .modal-icerik{font-size:14px} }
    
    /* swipe animasyonu için */
    .app.swipeing{ transition:none; will-change: transform; }
    .app.snap{ transition: transform .22s ease; }

    /* pull-to-refresh ipucu */
    .ptr-tip{
      position:fixed; top:calc(env(safe-area-inset-top) + 6px); left:50%; transform:translateX(-50%);
      padding:6px 10px; font-size:12px; background:var(--bg2); border:1px solid var(--stroke);
      color:var(--muted); border-radius:999px; opacity:0; transition:.25s; z-index:52;
    }
    .ptr-tip.show{opacity:1}
    .filters-head{
      display:flex; align-items:center; justify-content:space-between;
      padding:0 2px; margin-bottom:6px; color:var(--muted); font-weight:700; font-size:13px;
    }
    .filters-head .cap-left{ text-align:left }
    .filters-head .cap-right{ text-align:right }
    .filters-head2{
      display:grid; grid-template-columns:1fr 1fr; gap:10px;
      margin-bottom:6px;
    }
    .filters-head2 > div{
      text-align:center; color:var(--muted); font-weight:700; font-size:13px;
    }
    .filters-body{
      display:grid; grid-template-columns:1fr 1fr; gap:10px;
    }
    .filters-body select{
      width:100%; padding:10px; border-radius:10px;
      border:1px solid var(--stroke); background:var(--pill); color:var(--text);
    }
    @media(max-width:420px){
      /* çok dar ekranda hâlâ iki sütun kalsın istersen dokunma;
         tek sütun istersen satırı aç: grid-template-columns:1fr; */
    }
  </style>
</head>
<body>
  <!-- Appbar (sade) -->
  <div class="appbar">
    <div class="inner">
      <div class="titleArea">
        <div class="l1">Hedef Grafik</div>
        <div class="l2"><span id="gun">—</span> <span class="bullet">•</span> <span id="tarih">—</span></div>
      </div>
    </div>
  </div>
  
  <div class="ptr-tip" id="ptrTip">Yenilemek için bırak</div>

  <!-- Scroll container -->
  <div class="app" id="scrollArea">
    <main class="container">
      <!-- Hedef Grafik kartı: “Tema” küçük ve Son Güncelleme yanında -->
      <section class="hero">
        <div>
          <h2>Hedef Grafik</h2>
          <div class="hero-sub">Personel hedef/temin – teberru ayrı, oran yalnızca hedef teminine göre.</div>
          <div class="mini">
            <span class="pill">🕒 Son Güncelleme: <b id="guncellemeZamani">yükleniyor…</b></span>
          </div>
        </div>
      </section>

      <div class="grid">
        <!-- Liste -->
        <div class="card col-8">
          <h3>Liste</h3>
          <div class="filters" style="margin-bottom:12px">
            <div class="filters-head2">
              <div>Kategori</div>
              <div>Filtre</div>
            </div>
            <div class="filters-body">
              <select id="kategoriSecimi">
                <option value="Kitap Kampanyası">Kitap Kampanyası</option>
                <option value="Muhacir Hediye">Muhacir Hediye/İhtiyaç</option>
                <option value="Talebeye İkram">Talebeye İkram</option>
                <option value="Mevlid Kandili">Mevlid Kandili</option>
              </select>
              <select id="filtreSecimi">
                <option value="oran-azalan" selected>Ulaşma Nispeti (Azalan)</option>
                <option value="oran-artan">Ulaşma Nispeti (Artan)</option>
                <option value="personel-az">Personel (A → Z)</option>
                <option value="personel-za">Personel (Z → A)</option>
                <option value="hedef-artan">Hedef (Artan)</option>
                <option value="hedef-azalan">Hedef (Azalan)</option>
                <option value="temin-artan">Temin (Artan)</option>
                <option value="temin-azalan">Temin (Azalan)</option>
                <option value="teberru-artan">Teberru (Artan)</option>
                <option value="teberru-azalan">Teberru (Azalan)</option>
              </select>
            </div>
            <div class="pill" style="margin-top:8px">Satıra tıklayınca detay açılır.</div>
          </div>

          <div style="overflow:auto">
            <table id="hedefTablosu">
              <thead>
                <tr>
                  <th>Personel</th>
                  <th>Hedef (₺)</th>
                  <th>Teberru (₺)</th>
                  <th>Temin Edilen (₺)</th>
                  <th>Ulaşma Nispeti (%)</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>

        <!-- Özet -->
        <div class="card col-4" id="ozetCard">
          <h3>Özet</h3>
          <div class="kpi k1" style="margin-bottom:8px">
            <div><div class="val" id="toplamHedef">₺0</div><div class="sub">Toplam Hedef</div></div><div class="pill">🎯</div>
          </div>
          <div class="kpi k2" style="margin-bottom:8px">
            <div><div class="val" id="toplamTemin">₺0</div><div class="sub">Toplam Temin (Hedef)</div></div><div class="pill">📈</div>
          </div>
          <div class="kpi k3" style="margin-bottom:8px">
            <div><div class="val" id="toplamTeberru">₺0</div><div class="sub">Toplam Teberru</div></div><div class="pill">🤝</div>
          </div>
          <div class="kpi has-bar">
            <div>
              <div class="val" id="toplamOran">%0</div>
              <div class="sub">Genel Ulaşma Oranı</div>
            </div>
            <div class="kpi-ok">✅</div>
            <div class="kpi-bar"><span id="oranBar"></span></div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <!-- Sheet + Tabbar -->
  <div class="sheet-backdrop" id="sheetBackdrop"></div>
  <div class="sheet" id="panelSheet">
    <div class="grip"></div>
    <div class="title" id="sheetTitle">—</div>
    <div class="list" id="sheetList"></div>
  </div>
  <div class="tabbar">
    <div class="rail" id="tabRail"></div>
  </div>

  <!-- Modal (değişmedi) -->
  <div class="modal-arka" id="detayModal">
    <div class="modal-icerik">
      <div class="modal-baslik">
        <h3 id="modalBaslik">Detay</h3>
        <button class="modal-kapat" id="modalKapat">Kapat</button>
      </div>
      <div class="ozet">
        <div class="kpi"><div><div class="sub">Hedef Toplam</div><div class="val" id="m_hedefTop">₺0</div></div></div>
        <div class="kpi"><div><div class="sub">Hedef Temini</div><div class="val" id="m_hedefTeminTop">₺0</div></div></div>
        <div class="kpi"><div><div class="sub">Teberru</div><div class="val" id="m_teberruTop">₺0</div></div></div>
        <div class="kpi"><div><div class="sub">Genel Temin</div><div class="val" id="m_genelTeminTop">₺0</div></div></div>
        <div class="kpi"><div><div class="sub">Ulaşma Nispeti</div><div class="val" id="m_oranTop">%0</div></div></div>
      </div>
      <div class="hareket-kap">
        <table class="hareket-tablo" id="m_hareketTablo">
          <thead><tr><th>Tarih</th><th>Ad Soyad</th><th>Miktar (₺)</th><th>Tür</th><th>Açıklama</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="toast" id="toast" style="position:fixed; left:50%; bottom:24px; transform:translateX(-50%); background:rgba(2,6,23,.95); color:#fff; border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:10px 12px; opacity:0; pointer-events:none; transition:opacity .25s, transform .25s; z-index:200"></div>

<script>
/* ===== Tarih, Tema (profil.html ayarı) ===== */
function fmtDate(d=new Date()){
  const daysTR = ['Pazartesi','Salı','Çarşamba','Perşembe','Cuma','Cumartesi','Pazar'];
  const short = ['Pzt','Sal','Çar','Per','Cum','Cts','Paz'];
  const dayIdx = (d.getDay()+6)%7;
  return { gunKisa: short[dayIdx], tarihTR: d.toLocaleDateString('tr-TR',{day:'2-digit',month:'long',year:'numeric'}) };
}
function $(id){ return document.getElementById(id) }

function setThemeFromProfile(mode){
  const temaYazi = $('temaYazi');
  let eff = 'light', label='Açık';
  if(mode==='koyu'){ eff='dark'; label='Koyu'; }
  else if(mode==='oto' || mode==='auto' || !mode){
    eff = window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
    label='Oto';
  }
  document.documentElement.setAttribute('data-theme', eff);
  if(temaYazi) temaYazi.textContent = label;
  try{ localStorage.setItem('temaSon', mode||'oto'); }catch(e){}
}

/* ===== Alt Tabbar (panel/rapor ile aynı mantık) ===== */
const PATHS = { users:'kullanicilar', manifest:'sayfa_manifesti' };
const ALL_PANELS = ["Talebe","Personel","Nehari","Kermes","Muhasebe","Ayarlar","Admin"];
const ICONS = {Talebe:"👨‍🎓",Personel:"👥",Nehari:"📚",Kermes:"🧺",Muhasebe:"📊",Ayarlar:"⚙️",Admin:"🛡️",Home:"🏠"};

const db = window.db; const auth = firebase.auth();
let CURRENT_PERMS = {};   // panel -> [labels]
let MANIFEST = {};        // panel -> [{label,path,order,key}]

function normPanelName(t){ const m={"Sistem Ayarları":"Ayarlar","Sistem Ayarlari":"Ayarlar","Sistem Ayarları ":"Ayarlar"}; t=(t||'').trim(); return m[t]||t; }

async function loadManifest(){
  const out={};
  const snap = await db.collection(PATHS.manifest).get();
  for(const doc of snap.docs){
    const panelName = normPanelName(doc.id);
    const d = doc.data()||{}; const pages = Array.isArray(d.pages)? d.pages: [];
    out[panelName] = pages.map(p=>{
      const key=(p.key||'').trim(), title=(p.title||'').trim(), path=(p.path||'').trim(), order=Number(p.order||0);
      let label = title || (key.includes(':')? key.split(':')[1].trim(): key || 'Sayfa');
      return { label, path, order, key };
    }).sort((a,b)=>a.order-b.order);
  }
  return out;
}
function renderTabbar(allowed){
  const rail=$('tabRail'); rail.innerHTML='';
  const panels = ALL_PANELS.filter(p=>allowed.includes(p));
  const half = Math.ceil(panels.length/2), left=panels.slice(0,half), right=panels.slice(half);
  left.forEach(p=> rail.appendChild(makeTabBtn(p)));
  rail.appendChild(makeHomeBtn());
  right.forEach(p=> rail.appendChild(makeTabBtn(p)));
}
function makeHomeBtn(){
  const a=document.createElement('a'); a.href="#"; a.className='tbtn home'; a.dataset.panel='Home';
  a.innerHTML=`<div class="ico">${ICONS.Home}</div><div class="lbl">Ana Sayfa</div>`;
  a.addEventListener('click', e=>{ e.preventDefault(); goPath('panel.html'); });
  return a;
}
function makeTabBtn(panel){
  const a=document.createElement('a'); a.href="#"; a.className='tbtn'; a.dataset.panel=panel;
  a.innerHTML=`<div class="ico">${ICONS[panel]||'📁'}</div><div class="lbl">${panel}</div>`;
  a.addEventListener('click', e=>{ e.preventDefault(); openSheet(panel); });
  return a;
}
function goPath(p){
  if(!p) return;
  if(/^https?:\/\//i.test(p)) return location.assign(p);
  const abs = p.startsWith('/') ? p : ('/' + p.replace(/^\.?\//,''));
  location.assign(new URL(abs, location.origin).href);
}
const sheet=$('panelSheet'), sheetList=$('sheetList'), sheetTitle=$('sheetTitle'), sheetBackdrop=$('sheetBackdrop');
function openSheet(panel){
  sheetTitle.textContent = panel;
  sheetList.innerHTML='';
  const allowedLabels = CURRENT_PERMS[panel] || [];  // yetkiler
  const manifestPages = MANIFEST[panel] || [];
  const items = manifestPages.filter(p=>{
    const low = s=>String(s||'').toLowerCase();
    const labelMatch = allowedLabels.some(l=> low(l)===low(p.label));
    const withPanel = `${panel}: ${p.label}`;
    const withPanelMatch = allowedLabels.some(l=> low(l)===low(withPanel));
    const keyMatch = allowedLabels.some(l=> p.key && low(p.key)===low(l));
    return labelMatch || withPanelMatch || keyMatch;
  });

  if(!items.length){
    const it=document.createElement('div'); it.className='item'; it.textContent='Bu panel için sayfa tanımlı değil'; sheetList.appendChild(it);
  }else{
    items.forEach(p=>{
      const it=document.createElement('div'); it.className='item';
      it.innerHTML = `<div>${p.label}</div><div class="go">›</div>`;
      it.addEventListener('click', ()=> goPath(p.path));
      sheetList.appendChild(it);
    });
  }
  sheet.style.display='block'; sheetBackdrop.style.display='block';
}
function closeSheet(){ sheet.style.display='none'; sheetBackdrop.style.display='none'; }
sheetBackdrop.addEventListener('click', closeSheet);
let sStartY=null; sheet.addEventListener('touchstart',e=>{ sStartY=e.touches[0].clientY },{passive:true});
sheet.addEventListener('touchmove',e=>{ if(sStartY==null) return; const dy=e.touches[0].clientY - sStartY; if(dy>40){ closeSheet(); sStartY=null; } },{passive:true});

/* ===== Toast (küçük yardımcı) ===== */
function showToast(msg){
  const t=document.getElementById('toast');
  t.textContent=msg; t.style.opacity='1'; t.style.transform='translateX(-50%)';
  clearTimeout(window.__to); window.__to=setTimeout(()=>{ t.style.opacity='0'; },2200);
}

/* ===== Sayfa veri/kod (orijinal mantık korunarak) ===== */
const kategoriSecimi=$('kategoriSecimi'), filtreSecimi=$('filtreSecimi');
const tabloBody=document.querySelector("#hedefTablosu tbody");
const toplamTeberruEl=$('toplamTeberru'), toplamHedefEl=$('toplamHedef'), toplamTeminEl=$('toplamTemin');
const toplamOranEl=$('toplamOran'), oranBar=$('oranBar'), guncellemeEl=$('guncellemeZamani');

let veriTablosu=[], unsubHedef=null, unsubVeri=null, cacheTeminHedef={}, cacheTeberru={}, sonHedefMap={};

const modalArka=$('detayModal'), modalKapat=$('modalKapat'), m_baslik=$('modalBaslik');
const m_hedefTop=$('m_hedefTop'), m_hedefTeminTop=$('m_hedefTeminTop'), m_teberruTop=$('m_teberruTop'), m_genelTeminTop=$('m_genelTeminTop'), m_oranTop=$('m_oranTop');
const m_hareketTabloBody=document.querySelector('#m_hareketTablo tbody');

modalKapat.addEventListener('click',()=> modalArka.style.display='none');
modalArka.addEventListener('click',(e)=>{ if(e.target===modalArka) modalArka.style.display='none'; });

function toNum(v){ if(typeof v==='number') return v; if(typeof v==='string'){ const n=Number(v.replace(/\./g,'').replace(',', '.')); return isNaN(n)?0:n; } return 0; }

function tabloyuYenidenYaz(veriler){
  tabloBody.innerHTML="";
  veriler.forEach(p=>{
    const tr=document.createElement("tr");
    const td1=document.createElement("td"); td1.textContent=p.personel;

    const td2=document.createElement("td"); td2.className='money'; td2.textContent=`₺${p.hedef.toLocaleString("tr-TR")}`;
    const tdT=document.createElement("td"); tdT.className='money'; tdT.textContent=`₺${p.teberru.toLocaleString("tr-TR")}`;
    const td3=document.createElement("td"); td3.className='money'; td3.textContent=`₺${p.teminHedef.toLocaleString("tr-TR")}`;

    const td4=document.createElement("td");
    const prog=document.createElement('div'); prog.className='progress';
    const fill=document.createElement('div'); fill.className='fill'; fill.style.width=Math.max(0, Math.min(100, p.oran))+'%';
    const lab=document.createElement('div'); lab.className='label'; lab.textContent=`%${p.oran}`;
    prog.appendChild(fill); prog.appendChild(lab); td4.appendChild(prog);

    tr.append(td1, td2, tdT, td3, td4);
    tr.addEventListener('click',()=>acDetayModal(p.personel));
    tabloBody.appendChild(tr);
  });
}

function uygulaFiltre(){
  const f=filtreSecimi.value; let d=[...veriTablosu];
  const by=(k)=> (a,b)=>a[k]-b[k];
  switch(f){
    case "personel-az": d.sort((a,b)=>a.personel.localeCompare(b.personel)); break;
    case "personel-za": d.sort((a,b)=>b.personel.localeCompare(a.personel)); break;
    case "hedef-artan": d.sort(by('hedef')); break;
    case "hedef-azalan": d.sort((a,b)=>b.hedef-a.hedef); break;
    case "temin-artan": d.sort(by('teminHedef')); break;
    case "temin-azalan": d.sort((a,b)=>b.teminHedef-a.teminHedef); break;
    case "teberru-artan": d.sort(by('teberru')); break;
    case "teberru-azalan": d.sort((a,b)=>b.teberru-a.teberru); break;
    case "oran-artan": d.sort(by('oran')); break;
    case "oran-azalan": default: d.sort((a,b)=>b.oran-a.oran); break;
  }
  tabloyuYenidenYaz(d);
}

function toplamlariGuncelle(){
  const sumTeberru=veriTablosu.reduce((s,x)=>s+x.teberru,0);
  const sumHedef  =veriTablosu.reduce((s,x)=>s+x.hedef,0);
  const sumTeminHF=veriTablosu.reduce((s,x)=>s+x.teminHedef,0);
  const oran = sumHedef>0 ? Math.round((sumTeminHF/sumHedef)*100) : 0;

  toplamTeberruEl.textContent=`₺${sumTeberru.toLocaleString("tr-TR")}`;
  toplamHedefEl.textContent  =`₺${sumHedef.toLocaleString("tr-TR")}`;
  toplamTeminEl.textContent  =`₺${sumTeminHF.toLocaleString("tr-TR")}`;
  toplamOranEl.textContent   =`%${oran}`;
  oranBar.style.width=Math.max(0, Math.min(100, oran))+'%';
}

function kategoriDegistiGercekZamanli(kategori){
  if(typeof unsubHedef==='function') unsubHedef();
  if(typeof unsubVeri==='function') unsubVeri();

  const hedefMap={}, teminHedefMap={}, teberruMap={}; let maxUpdateTs=0;

  unsubHedef = db.collection("hedefler").where("kategori","==", kategori).onSnapshot((snap)=>{
    Object.keys(hedefMap).forEach(k=>delete hedefMap[k]);
    snap.forEach(doc=>{
      const d=doc.data(); const p=d.personel||'-';
      hedefMap[p]=toNum(d.hedef);
      const ts=d.updatedAt?.toMillis?.()? d.updatedAt.toMillis(): (d.updatedAt||0);
      if(ts>maxUpdateTs) maxUpdateTs=ts;
    });
    sonHedefMap={...hedefMap};
    tabloyuHazirlaVeYansit();
    cacheTeminHedef={...teminHedefMap};
    cacheTeberru   ={...teberruMap};
  });

  unsubVeri = db.collection("veriler").where("kategori","==", kategori).onSnapshot((snap)=>{
    Object.keys(teminHedefMap).forEach(k=>delete teminHedefMap[k]);
    Object.keys(teberruMap).forEach(k=>delete teberruMap[k]);

    snap.forEach(doc=>{
      const d=doc.data(); const p=d.personel||'-'; const miktar=toNum(d.miktar);
      const tur=(d.tur||'hedef').toLowerCase();
      if(tur==='teberru'){ teberruMap[p]=(teberruMap[p]||0)+miktar; } else { teminHedefMap[p]=(teminHedefMap[p]||0)+miktar; }
      const ts=d.createdAt?.toMillis?.()? d.createdAt.toMillis(): (d.createdAt||0);
      if(ts>maxUpdateTs) maxUpdateTs=ts;
    });

    tabloyuHazirlaVeYansit();
  });

  function tabloyuHazirlaVeYansit(){
    const personeller=new Set([...Object.keys(hedefMap), ...Object.keys(teminHedefMap), ...Object.keys(teberruMap)]);
    const tabloDizi=[];
    personeller.forEach(personel=>{
      const hedef=toNum(hedefMap[personel]||0);
      const teminHedef=toNum(teminHedefMap[personel]||0);
      const teberru=toNum(teberruMap[personel]||0);
      const oran=hedef>0? Math.round((teminHedef/hedef)*100) : 0;
      tabloDizi.push({personel, hedef, teminHedef, teberru, oran});
    });
    veriTablosu=tabloDizi;
    uygulaFiltre();
    toplamlariGuncelle();
    const nowStr=new Date((maxUpdateTs && !isNaN(maxUpdateTs))? maxUpdateTs: Date.now()).toLocaleString("tr-TR");
    guncellemeEl.textContent=nowStr;
  }
}

async function acDetayModal(personel){
  const kategori=kategoriSecimi.value;
  m_baslik.textContent=`${personel} — ${kategori}`;
  modalArka.style.display='block';
  m_hareketTabloBody.innerHTML='<tr><td colspan="5">Yükleniyor...</td></tr>';

  const hedef=toNum(sonHedefMap[personel]||0);
  try{
    const baseQ=db.collection('veriler').where('kategori','==',kategori).where('personel','==',personel);
    let snap; try{ snap=await baseQ.orderBy('createdAt','desc').get(); }catch(e){ snap=await baseQ.get(); }

    let hedefTeminTop=0, teberruTop=0; const satirlar=[];
    snap.forEach(doc=>{
      const d=doc.data(); const tur=(d.tur||'hedef').toLowerCase();
      const miktar=toNum(d.miktar); const adsoyad=d.adSoyad||d.veren||d.verenAdSoyad||'-';
      const aciklama=d.aciklama||d.nereyeGeldi||'-';
      const t=d.createdAt?.toDate? d.createdAt.toDate() : (d.createdAt? new Date(d.createdAt) : null);
      const tStr=t? t.toLocaleString('tr-TR') : '-';
      if(tur==='teberru') teberruTop+=miktar; else hedefTeminTop+=miktar;
      satirlar.push({tStr, adsoyad, miktar, tur, aciklama});
    });

    if(satirlar.length===0){ hedefTeminTop=toNum(cacheTeminHedef[personel]||0); teberruTop=toNum(cacheTeberru[personel]||0); }
    const genelTeminTop=hedefTeminTop+teberruTop;
    const oran=hedef>0? Math.round((hedefTeminTop/hedef)*100) : 0;

    m_hedefTop.textContent='₺'+hedef.toLocaleString('tr-TR');
    m_hedefTeminTop.textContent='₺'+hedefTeminTop.toLocaleString('tr-TR');
    m_teberruTop.textContent='₺'+teberruTop.toLocaleString('tr-TR');
    m_genelTeminTop.textContent='₺'+genelTeminTop.toLocaleString('tr-TR');
    m_oranTop.textContent='%'+oran;

    m_hareketTabloBody.innerHTML='';
    if(satirlar.length===0){
      m_hareketTabloBody.innerHTML='<tr><td colspan="5">Hareket bulunamadı.</td></tr>';
    }else{
      satirlar.forEach(x=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${x.tStr}</td><td>${x.adsoyad}</td><td>₺${x.miktar.toLocaleString('tr-TR')}</td>
          <td><span class="etiket ${x.tur==='teberru'?'etiket-teberru':'etiket-hedef'}">${x.tur==='teberru'?'Teberru':'Hedef'}</span></td>
          <td>${x.aciklama}</td>`;
        m_hareketTabloBody.appendChild(tr);
      });
    }
  }catch(err){
    console.error('[detay modal] hata:',err);
    m_hareketTabloBody.innerHTML=`<tr><td colspan="5">Kayıtlar yüklenemedi.</td></tr>`;
    m_hedefTeminTop.textContent='₺0'; m_teberruTop.textContent='₺0'; m_genelTeminTop.textContent='₺0'; m_oranTop.textContent='%0';
  }
}

    /* ===== Pull-to-Refresh + Edge Swipe Back ===== */
    (function(){
      const area = document.getElementById('scrollArea');
      const tip  = document.getElementById('ptrTip');

      /* ---- PTR ---- */
      const PTR_SHOW = 110, PTR_TRIGGER = 240;
      let tStartY=null, tStartX=null, ptrActive=false, maxPull=0;

      area.addEventListener('touchstart', e=>{
        ptrActive = (area.scrollTop <= 1);
        tStartY = e.touches[0].clientY;
        tStartX = e.touches[0].clientX;
        maxPull = 0;
      }, {passive:true});

      area.addEventListener('touchmove', e=>{
        if(!ptrActive) return;
        const dy = e.touches[0].clientY - tStartY;
        const dx = e.touches[0].clientX - tStartX;
        if(Math.abs(dx) > 50){ ptrActive=false; tip.classList.remove('show'); return; }
        if(dy > PTR_SHOW) tip.classList.add('show'); else tip.classList.remove('show');
        if(dy > maxPull) maxPull = dy;
      }, {passive:true});

      area.addEventListener('touchend', ()=>{
        const shouldRefresh = ptrActive && (maxPull >= PTR_TRIGGER) && (area.scrollTop <= 1);
        tip.classList.remove('show');
        ptrActive=false; tStartY=tStartX=null; maxPull=0;
        if(shouldRefresh) location.reload();
      }, {passive:true});

      /* ---- Edge Swipe Back ---- */
      let sX=0, sY=0, dx=0, tracking=false;
      const EDGE=24, TRIGGER=140, MAXVIS=100, MAXDY=80;

      function setX(x, snap=false){
        area.classList.toggle('snap', snap);
        area.classList.add('swipeing');
        area.style.transform = `translateX(${Math.max(0, Math.min(x, MAXVIS))}px)`;
      }
      function reset(){
        area.classList.remove('swipeing','snap');
        area.style.transform = '';
        tracking=false; dx=0;
      }

      area.addEventListener('touchstart', e=>{
        sX = e.touches[0].clientX; sY = e.touches[0].clientY;
        tracking = (sX <= EDGE); dx = 0;
      }, {passive:true});

      area.addEventListener('touchmove', e=>{
        if(!tracking) return;
        const t = e.touches[0];
        const dy = t.clientY - sY;
        if(Math.abs(dy) > MAXDY){ reset(); return; }
        dx = t.clientX - sX;
        if(dx <= 0){ setX(0); return; }
        setX(dx);
      }, {passive:true});

      area.addEventListener('touchend', ()=>{
        if(!tracking) return;
        if(dx >= TRIGGER){ setX(MAXVIS,true); setTimeout(()=>history.back(), 10); }
        else { setX(0,true); setTimeout(reset, 220); }
      }, {passive:true});
      area.addEventListener('touchcancel', reset, {passive:true});
    })();

/* ===== Başlat ===== */
(async function init(){
  const {gunKisa, tarihTR} = fmtDate();
  $('gun').textContent=gunKisa; $('tarih').textContent=tarihTR;

  auth.onAuthStateChanged(async (user)=>{
    if(!user){ window.location.href='../../index.html'; return; }

    // Profilden tema uygula (profil.html’ün kaydettiği değer: 'oto' | 'acik' | 'koyu')
    const udoc = await db.collection(PATHS.users).doc(user.uid).get();
    const meta = udoc.exists ? udoc.data() : {};
    const kayitliTema = (meta.tema || localStorage.getItem(`temaAyar:${user.uid}`) || 'oto');
    setThemeFromProfile(String(kayitliTema).toLowerCase());

    // Yetkileri panel->label haritasına çevir
    const raw = Array.isArray(meta.yetkiler) ? meta.yetkiler : [];
    const byPanelLabels = {};
    raw.forEach(s=>{
      const i = String(s).indexOf(':'); if(i<0) return;
      let panel = String(s).slice(0,i).trim();
      let label = String(s).slice(i+1).trim();
      panel = normPanelName(panel);
      if(!ALL_PANELS.includes(panel)) return;
      (byPanelLabels[panel] ||= []).push(label);
    });
    CURRENT_PERMS = byPanelLabels;

    // Manifest ve tabbar
    MANIFEST = await loadManifest();
    renderTabbar(Object.keys(byPanelLabels));

    // Veri akışları
    const k=localStorage.getItem('hedefGrafik_kategori'); if(k) kategoriSecimi.value=k;
    const f=localStorage.getItem('hedefGrafik_filtresi'); if(f) filtreSecimi.value=f;
    kategoriSecimi.addEventListener('change',()=>{ localStorage.setItem('hedefGrafik_kategori',kategoriSecimi.value); kategoriDegistiGercekZamanli(kategoriSecimi.value); });
    filtreSecimi.addEventListener('change',()=>{ localStorage.setItem('hedefGrafik_filtresi',filtreSecimi.value); uygulaFiltre(); });
    kategoriDegistiGercekZamanli(kategoriSecimi.value);
  });
})();
</script>
</body>
</html>
