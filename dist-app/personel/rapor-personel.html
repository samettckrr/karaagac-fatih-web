<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Kişi Bazlı Alacak Raporu</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="../../js/firebase/firebase-init.js"></script>

  <!-- html2pdf -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" defer></script>

  <style>
    /* ========= Tema / iOS düzeni (panel.html ile aynı mantık) ========= */
    :root{
      /* Light */
      --bg:#f6f7fb; --bg2:#ffffff; --text:#0f172a; --muted:#6b7280; --stroke:#e5e7eb;
      --brand:#0ea5e9; --brand2:#22d3ee;
      --card:#ffffff; --danger:#ef4444; --ok:#16a34a; --warn:#f59e0b;
      --radius:16px; --shadow:0 12px 28px rgba(0,0,0,.12);
      --appbar-h: calc(56px + env(safe-area-inset-top));
      --tabbar-h: calc(64px + env(safe-area-inset-bottom));
    }
    :root.dark{
      --bg:#0b1324; --bg2:#0f172a; --text:#e5e7eb; --muted:#9aa4b2; --stroke:#1f2937;
      --card:rgba(15,23,42,.9); --shadow:0 10px 24px rgba(0,0,0,.35);
      --danger:#f87171; --ok:#4ade80; --warn:#fbbf24;
    }
    *{box-sizing:border-box}
    html,body{height:100%; overflow:hidden} /* body scroll kapalı; gerçek scroll .app */
    body{
      margin:0; background:linear-gradient(180deg,var(--bg),var(--bg2));
      color:var(--text);
      font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }

    /* Appbar */
    .appbar{
      position:fixed; inset:0 0 auto 0; height:var(--appbar-h);
      padding-top:env(safe-area-inset-top);
      background:linear-gradient(180deg,var(--bg2),transparent);
      backdrop-filter:saturate(140%) blur(8px);
      border-bottom:1px solid var(--stroke); z-index:50;
      display:flex; align-items:flex-end;
    }
    .appbar .inner{display:flex; align-items:center; justify-content:space-between; width:100%; padding:12px 16px 10px}
    .titleArea{display:flex; flex-direction:column; gap:2px}
    .titleArea .l1{font-weight:800; font-size:18px}
    .titleArea .l2{font-size:12.5px; color:var(--muted)}
    .titleArea .bullet{opacity:.5; padding:0 6px}

    /* Pull-to-refresh tip */
    .ptr-tip{
      position:fixed; top:calc(env(safe-area-inset-top) + 6px); left:50%; transform:translateX(-50%);
      padding:6px 10px; font-size:12px; background:var(--bg2); border:1px solid var(--stroke);
      color:var(--muted); border-radius:999px; opacity:0; transition:.25s; z-index:52;
    }
    .ptr-tip.show{opacity:1}

    /* Scroll alanı (gerçek container) */
    .app{
      height: calc(100vh - var(--appbar-h) - var(--tabbar-h));
      padding-top:var(--appbar-h);
      padding-bottom:var(--tabbar-h);
      overflow:auto;
      -webkit-overflow-scrolling: touch; /* iOS momentum */
    }

    /* İçerik genişliği */
    .container{max-width:1180px; margin:12px auto; padding:0 16px}

    .app{ background: linear-gradient(180deg,var(--bg),var(--bg2)); }

    /* Alt tabbar + sheet (panel.html ile aynı stil) */
    .tabbar{
      position:fixed; inset:auto 0 0 0; height:var(--tabbar-h);
      padding-bottom:env(safe-area-inset-bottom);
      border-top:1px solid var(--stroke);
      backdrop-filter:saturate(140%) blur(8px);
      background: var(--bg2);               /* << düz arka plan */
      backdrop-filter: none;                 /* istersen blur kalsın, ama beyazlık için kapatmak en garanti */
      z-index:60; display:flex; align-items:center; justify-content:center;
    }
    .tabbar .rail{display:flex; align-items:center; gap:10px; max-width:1100px; width:100%; overflow-x:auto; padding:8px 12px 10px; scroll-snap-type:x proximity}
    .tabbar .rail{ box-shadow: 0 -1px 0 var(--stroke) inset; }
    .tbtn{
      flex:0 0 auto; scroll-snap-align:center;
      display:flex; flex-direction:column; align-items:center; gap:4px;
      min-width:72px; padding:8px 10px; color:var(--muted); text-decoration:none; border-radius:12px
    }
    .tbtn.active{color:var(--brand)}
    .tbtn .ico{font-size:20px; line-height:20px}
    .tbtn .lbl{font-size:11.5px}
    .tbtn.home{background:transparent; color:inherit; border:1px dashed var(--stroke)}
    .tbtn.home .ico{font-size:22px} .tbtn.home .lbl{font-weight:700}

    .sheet-backdrop{position:fixed; inset:0; z-index:59; display:none}
    .sheet{
      position:fixed; left:10px; right:10px; bottom:calc(var(--tabbar-h) + 10px);
      background:var(--card); border:1px solid var(--stroke); border-radius:18px; box-shadow:var(--shadow);
      z-index:61; display:none; max-height:40vh; overflow:auto;
    }
    .sheet .grip{width:44px; height:5px; background:var(--stroke); border-radius:999px; margin:8px auto}
    .sheet .title{padding:6px 14px; font-weight:800}
    .sheet .list{display:flex; flex-direction:column}
    .sheet .item{padding:12px 14px; border-top:1px dashed var(--stroke); display:flex; align-items:center; justify-content:space-between; gap:10px}
    .sheet .item .go{font-size:18px; opacity:.6}

    /* ======== Rapor sayfası kendi stilleri (aynı görünüm korunarak) ======== */
    .card{background:var(--card);border:1px solid var(--stroke);border-radius:16px;padding:14px}
    header.rapor-hdr{position:sticky;top:0;z-index:5;background:transparent;border:none}
    .rapor-ust{display:flex;gap:16px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    .rapor-baslik{font-size:22px;line-height:1.25;margin:0;white-space:normal;word-break:break-word;overflow-wrap:anywhere}
    .kisi-secim{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    select,button{height:38px;border:1px solid var(--stroke);background:#fff;border-radius:10px;padding:0 12px;font:inherit;color:var(--text)}
    button{background:var(--brand);color:#fff;border:none;cursor:pointer}
    button.secondary{background:#fff;color:var(--text)}
    .row{display:grid;gap:12px}
    .row.cols-3{grid-template-columns:repeat(3,1fr)}
    @media (max-width:900px){.row.cols-3{grid-template-columns:1fr 1fr}}
    @media (max-width:640px){.row.cols-3{grid-template-columns:1fr}}
    .kpi{display:flex;flex-direction:column;gap:4px}
    .kpi .label{color:var(--muted);font-size:12px}
    .kpi .value{font-size:20px;font-weight:600}
    .kpi.warn .value{color:#d35400}
    .kpi.good .value{color:#2d6a4f}
    .siralama-etiketleri{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0 12px}
    .badge-siralama{padding:6px 10px;border-radius:999px;font-size:12px;font-weight:600;border:1px solid #e2e8f0;background:#f8fafc}
    .faaliyet-grid{display:grid;gap:10px;grid-template-columns:repeat(4,1fr)}
    @media (max-width:900px){.faaliyet-grid{grid-template-columns:1fr 1fr}}
    @media (max-width:640px){.faaliyet-grid{grid-template-columns:1fr}}
    .faaliyet-kart{
      display:grid !important;
      grid-template-columns: 1fr auto;
      grid-template-areas:
        "title   ."
        "tah     ."
        "tas     ."
        "kalan   kalan";
      align-items:center;
      gap:6px 12px;
      padding:12px 14px;
      border:1px solid #eef2f7;border-radius:12px;background:#fff;
    }
    .f-title{ grid-area:title; font-weight:700; }
    .f-tah{ grid-area:tah; color:var(--muted); }
    .f-tas{ grid-area:tas; color:var(--muted); }
    .kalan-etiket{ grid-area:kalan; justify-self:center; white-space:nowrap;
      padding:6px 10px;border-radius:999px;font-size:12px;font-weight:700;border:1px solid transparent }
    .kalan-pozitif{ background:#fff7ed; color:#9a3412; border-color:#fdba74 }
    .kalan-non{ background:#ecfdf5; color:#065f46; border-color:#86efac }
    .kalan-negatif{ background:#eff6ff; color:#1d4ed8; border-color:#93c5fd }
    @media (max-width:640px){
      .faaliyet-kart{
        grid-template-columns:1fr;
        grid-template-areas:
          "title"
          "tah"
          "tas"
          "kalan";
      }
      .kalan-etiket{ justify-self:start }
    }
    .table-wrap{overflow:auto;border:1px solid var(--stroke);border-radius:12px}
    table{width:100%;border-collapse:collapse;background:#fff;min-width:760px}
    thead th{position:sticky;top:0;background:#fafbfc;border-bottom:1px solid var(--stroke);font-weight:600;text-align:left;font-size:13px;color:var(--muted);padding:10px;user-select:none;cursor:pointer}
    thead th.sort-asc::after{content:" ▲";font-weight:700}
    thead th.sort-desc::after{content:" ▼";font-weight:700}
    tbody td{border-bottom:1px solid var(--stroke);padding:10px;font-size:14px}
    tbody tr.zero{background:#f2fbf6}
    tfoot td{border-top:2px solid var(--stroke);padding:10px;font-weight:600}
    .right{text-align:right}

    .pill{padding:6px 10px; border-radius:999px; border:1px solid var(--stroke); background:var(--bg2); font-size:12px}

    /* Print */
    .avoid-break{page-break-inside:avoid;break-inside:avoid}
    @media print{
      .appbar,.tabbar,.ptr-tip,.sheet{display:none!important}
      .app{padding:0; height:auto}
      .container{max-width:100%; padding:0 0}
      header.rapor-hdr{position:static;border:none}
      .card{border:none;padding:0}
      .table-wrap{border:none}
      .kisi-secim{display:none!important}
    }
      
      .app.swipeing{ transition:none; will-change: transform; }
      .app.snap{ transition: transform .22s ease; }

  </style>
</head>
<body>
  <!-- Appbar -->
  <div class="appbar">
    <div class="inner">
      <div class="titleArea">
        <div class="l1">Kişi Bazlı Alacak Raporu</div>
        <div class="l2"><span id="gun">—</span> <span class="bullet">•</span> <span id="tarih">—</span> <span class="bullet">•</span> Tema: <span id="temaYazi">—</span></div>
      </div>
    </div>
  </div>

  <div class="ptr-tip" id="ptrTip">Yenilemek için bırak</div>

  <!-- Scroll container -->
  <div class="app" id="scrollArea">
    <div class="container">

      <!-- Rapor header -->
      <header class="rapor-hdr">
        <div class="card">
          <div class="rapor-ust">
            <h1 id="kisiBaslik" class="rapor-baslik" style="margin:0">Kişi Bazlı Alacak Raporu</h1>
            <div class="kisi-secim">
              <select id="personelSecim"></select>
              <select id="selYil">
                <option value="2023">2023</option>
                <option value="2024">2024</option>
                <option value="2025" selected>2025</option>
                <option value="tum">Tüm Yıllar</option>
              </select>
              <button id="btnYukle">Yükle</button>
              <button id="btnPDF" class="secondary">PDF düzeniyle birebir</button>
            </div>
          </div>
        </div>
      </header>

      <main id="pdf-root">
        <div class="card avoid-break" style="margin-top:12px">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
            <div>
              <h2 id="baslik" style="margin:0">Ad Soyad</h2>
              <div class="muted" id="altBaslik" style="color:var(--muted)">Yıl: 2025</div>
            </div>
            <div><span class="pill" id="pillAdet">0 kayıt</span></div>
          </div>
        </div>

        <!-- Sıralama rozetleri -->
        <div id="siralamaEtiketleri" class="siralama-etiketleri"></div>

        <!-- KPI kartları -->
        <div class="row cols-3 avoid-break" style="margin-top:12px">
          <div class="card kpi"><span class="label">Toplam Tahakkuk</span><span class="value" id="kpiTahakkuk">₺0</span></div>
          <div class="card kpi good"><span class="label">Toplam Tahsilat</span><span class="value" id="kpiTahsilat">₺0</span></div>
          <div class="card kpi warn"><span class="label">Kalan</span><span class="value" id="kpiKalan">₺0</span></div>
        </div>

        <!-- Faaliyet özeti -->
        <div class="card avoid-break" style="margin-top:12px">
          <h3 style="margin:0 0 8px">Faaliyet Bazlı Özet</h3>
          <div class="faaliyet-grid" id="faaliyetGrid"></div>
        </div>

        <!-- Detay tablo -->
        <div class="card" style="margin-top:12px">
          <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;flex-wrap:wrap">
            <h3 style="margin:0">Detaylı Liste</h3>
            <span class="muted" style="color:var(--muted)">Yıl / Faaliyet / Borçlu / Ödeyen / Tahakkuk / Tahsilat / Yeni Tahsilat / Kalan</span>
          </div>
          <div class="table-wrap avoid-break">
            <table id="tbl">
              <thead>
                <tr id="hdr">
                  <th data-col="yil" data-type="num">Yıl</th>
                  <th data-col="faaliyet" data-type="str">Faaliyet</th>
                  <th data-col="borclu" data-type="str">Borçlu Adı Soyadı</th>
                  <th data-col="odeyen" data-type="str">Ödeyen Kişi</th>
                  <th class="right" data-col="tahakkuk" data-type="num">Tahakkuk</th>
                  <th class="right" data-col="tahsilat" data-type="num">Tahsilat</th>
                  <th class="right" data-col="yeni" data-type="num">Yeni Tahsilat</th>
                  <th class="right" data-col="kalan" data-type="num">Kalan</th>
                </tr>
              </thead>
              <tbody id="tbody"></tbody>
              <tfoot>
                <tr>
                  <td colspan="4" class="right">TOPLAM</td>
                  <td class="right" id="sumTahakkuk">₺0</td>
                  <td class="right" id="sumTahsilat">₺0</td>
                  <td class="right" id="sumYeni">₺0</td>
                  <td class="right" id="sumKalan">₺0</td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </main>

    </div>
  </div>

  <!-- Sheet -->
  <div class="sheet-backdrop" id="sheetBackdrop"></div>
  <div class="sheet" id="panelSheet">
    <div class="grip"></div>
    <div class="title" id="sheetTitle">—</div>
    <div class="list" id="sheetList"></div>
  </div>

  <!-- Tabbar -->
  <div class="tabbar">
    <div class="rail" id="tabRail"></div>
  </div>

<script>
/* =========================
   Sabitler / globaller
   ========================= */
const PATHS = {
  users: 'kullanicilar',
  manifest: 'sayfa_manifesti'
};
const ALL_PANELS = ["Talebe","Personel","Nehari","Kermes","Muhasebe","Ayarlar","Admin"];
const ICONS = {Talebe:"👨‍🎓",Personel:"👥",Nehari:"📚",Kermes:"🧺",Muhasebe:"📊",Ayarlar:"⚙️",Admin:"🛡️",Home:"🏠"};

const db   = window.db;
const auth = firebase.auth();

/* ====== Tarih/Gün ====== */
function fmtDate(d=new Date()){
  const daysTR = ['Pazartesi','Salı','Çarşamba','Perşembe','Cuma','Cumartesi','Pazar'];
  const short = ['Pzt','Sal','Çar','Per','Cum','Cts','Paz'];
  const dayIdx = (d.getDay()+6)%7;
  return {
    gunKisa: short[dayIdx],
    gunUzun: daysTR[dayIdx],
    tarihTR: d.toLocaleDateString('tr-TR',{day:'2-digit',month:'long',year:'numeric'})
  };
}

/* ====== Tema ====== */
function setTheme(mode){
  const root = document.documentElement;
  if(mode==='oto'){
    const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    root.classList.toggle('dark', prefersDark);
  }else{
    root.classList.toggle('dark', mode==='koyu');
  }
  document.getElementById('temaYazi').textContent = mode==='oto'?'Oto':mode==='acik'?'Açık':'Koyu';
}
function saveThemeLocal(uid,mode){ try{ localStorage.setItem(`temaAyar:${uid}`,mode) }catch(e){} }
function readThemeLocal(uid){ try{ return localStorage.getItem(`temaAyar:${uid}`) }catch(e){ return null } }

/* ====== Yardımcı ====== */
function $(id){ return document.getElementById(id) }

/* ====== Panel ad alias ====== */
const PANEL_ALIAS = {
  "Sistem Ayarları": "Ayarlar",
  "Sistem Ayarlari": "Ayarlar",
  "Sistem Ayarları ": "Ayarlar"
};
function normPanelName(x){
  const t = (x||'').trim();
  return PANEL_ALIAS[t] || t;
}

    function goPath(p){
      if(!p) return;
      // tam URL ise direkt
      if(/^https?:\/\//i.test(p)) { location.assign(p); return; }
      // kökten mutlak değilse köke bağla ("/...")  ->  alt klasörden şaşmasın
      const abs = p.startsWith('/') ? p : ('/' + p.replace(/^\.?\//,''));
      location.assign(new URL(abs, location.origin).href);
    }

/* ====== Manifest yükleme ====== */
async function loadManifest(){
  const out = {};
  const panelsSnap = await db.collection(PATHS.manifest).get();
  for(const doc of panelsSnap.docs){
    const panelName = normPanelName(doc.id);
    const d = doc.data() || {};
    const pages = Array.isArray(d.pages) ? d.pages : [];
    const arr = pages.map(p=>{
      const key   = (p.key||'').trim();
      const title = (p.title||'').trim();
      const path  = (p.path||'').trim();
      const order = Number(p.order||0);
      let label = title;
      if(!label){
        const i = key.indexOf(':');
        label = (i>=0 ? key.slice(i+1) : key).trim();
      }
      return { label, path, order, key };
    }).sort((a,b)=>a.order-b.order);
    out[panelName] = arr;
  }
  return out; // { Panel:[{label,path,order,key}], ... }
}

/* ====== Kullanıcı / Yetkiler ====== */
async function loadUser(uid){
  const snap = await db.collection(PATHS.users).doc(uid).get();
  return snap.exists ? snap.data() : {};
}

let CURRENT_PERMS = {};   // panel -> [labels]
let MANIFEST = {};        // panel -> [{label,path,order,key}]

/* ====== Tabbar & sheet ====== */
function renderTabbar(allowed){
  const rail = $('tabRail'); rail.innerHTML='';
  const panels = ALL_PANELS.filter(p=>allowed.includes(p));
  const half = Math.ceil(panels.length/2);
  const left = panels.slice(0,half), right = panels.slice(half);

  left.forEach(p=> rail.appendChild(makeTabBtn(p)));
  rail.appendChild(makeHomeBtn());
  right.forEach(p=> rail.appendChild(makeTabBtn(p)));
}
function makeHomeBtn(){
  const a = document.createElement('a');
  a.href="#"; a.className='tbtn home'; a.dataset.panel='Home';
  a.innerHTML = `<div class="ico">${ICONS.Home}</div><div class="lbl">Ana Sayfa</div>`;
  a.addEventListener('click', e=>{
    e.preventDefault();
    closeSheet();
    goPath('panel.html');   // kökten çözer; istersen 'index.html' yap
  });
  return a;
}
function makeTabBtn(panel){
  const a = document.createElement('a');
  a.href="#"; a.className='tbtn'; a.dataset.panel=panel;
  a.innerHTML = `<div class="ico">${ICONS[panel]||'📁'}</div><div class="lbl">${panel}</div>`;
  a.addEventListener('click', e=>{ e.preventDefault(); openSheet(panel); });
  return a;
}
const sheet = $('panelSheet'), sheetList=$('sheetList'), sheetTitle=$('sheetTitle'), sheetBackdrop=$('sheetBackdrop');
function openSheet(panel){
  sheetTitle.textContent = panel;
  sheetList.innerHTML = '';

  const allowedLabels = CURRENT_PERMS[panel] || [];
  const manifestPages  = MANIFEST[panel]    || [];

  const items = manifestPages.filter(p => {
    const lwr = s => String(s||'').toLowerCase();
    const labelMatch = allowedLabels.some(l => lwr(l) === lwr(p.label));
    const withPanel  = `${panel}: ${p.label}`;
    const withPanelMatch = allowedLabels.some(l => lwr(l) === lwr(withPanel));
    const keyMatch = allowedLabels.some(l => p.key && lwr(p.key) === lwr(l));
    return labelMatch || withPanelMatch || keyMatch;
  });

  if(!items.length){
    const it = document.createElement('div'); it.className='item';
    it.textContent = 'Bu panel için sayfa tanımlı değil';
    sheetList.appendChild(it);
  }else{
    items.forEach(p=>{
      const it = document.createElement('div'); it.className='item';
      it.innerHTML = `<div>${p.label}</div><div class="go">›</div>`;
      it.addEventListener('click', ()=> goPath(p.path));
      sheetList.appendChild(it);
    });
  }

  sheet.style.display='block';
  sheetBackdrop.style.display='block';
}
function closeSheet(){ sheet.style.display='none'; sheetBackdrop.style.display='none'; }
sheetBackdrop.addEventListener('click', closeSheet);
let sStartY=null;
sheet.addEventListener('touchstart',e=>{ sStartY=e.touches[0].clientY },{passive:true});
sheet.addEventListener('touchmove',e=>{ if(sStartY==null) return; const dy=e.touches[0].clientY - sStartY; if(dy>40){ closeSheet(); sStartY=null; } },{passive:true});

/* ====== Pull-to-Refresh & Swipe-Back (panel ile aynı eşikler) ====== */
const scrollArea = document.getElementById('scrollArea');
const ptrTip = document.getElementById('ptrTip');
const PTR_SHOW = 110;
const PTR_TRIGGER = 240;
let ptrActive=false, touchStartY=null, touchStartX=null, maxPull=0;

scrollArea.addEventListener('touchstart', (e) => {
  const atTop = (scrollArea.scrollTop <= 1);
  ptrActive = atTop;
  touchStartY = e.touches[0].clientY;
  touchStartX = e.touches[0].clientX;
  maxPull = 0;
}, { passive: true });

scrollArea.addEventListener('touchmove', (e) => {
  if (!ptrActive) return;
  const dy = e.touches[0].clientY - touchStartY;
  const dx = e.touches[0].clientX - touchStartX;
  if (Math.abs(dx) > 50) { ptrActive=false; ptrTip.classList.remove('show'); return; }
  if (dy > PTR_SHOW) ptrTip.classList.add('show'); else ptrTip.classList.remove('show');
  if (dy > maxPull) maxPull = dy;
}, { passive: true });

scrollArea.addEventListener('touchend', () => {
  const shouldRefresh = ptrActive && (maxPull >= PTR_TRIGGER) && (scrollArea.scrollTop <= 1);
  ptrTip.classList.remove('show');
  ptrActive=false; touchStartY=touchStartX=null; maxPull=0;
  if (shouldRefresh) location.reload();
}, { passive: true });

// Swipe-back: iOS edge-swipe benzeri
(function(){
  const area = document.getElementById('scrollArea');
  let startX=0, startY=0, tracking=false, dx=0;

  const EDGE = 24;     // yalnızca sol kenardan
  const TRIGGER = 140; // bırakınca bu eşiği geçerse geri
  const MAXVIS = 100;  // görünür maksimum çekme (px)
  const MAXDY = 80;    // çok dikeyse iptal

  function setX(x, snap=false){
    const cl = area.classList;
    if(snap){ cl.add('snap'); } else { cl.remove('snap'); }
    cl.add('swipeing');
    area.style.transform = `translateX(${Math.max(0, Math.min(x, MAXVIS))}px)`;
  }
  function reset(){
    area.classList.remove('swipeing','snap');
    area.style.transform = '';
    tracking=false; dx=0;
  }

  area.addEventListener('touchstart', e=>{
    const t = e.touches[0];
    startX = t.clientX; startY = t.clientY;
    tracking = (startX <= EDGE);   // sadece kenardan başlarsa
    dx = 0;
  }, {passive:true});

  area.addEventListener('touchmove', e=>{
    if(!tracking) return;
    const t = e.touches[0];
    const dy = t.clientY - startY;
    if(Math.abs(dy) > MAXDY){ reset(); return; }  // dikey baskınsa iptal
    dx = t.clientX - startX;
    if(dx <= 0){ setX(0); return; }
    setX(dx);  // canlı önizleme
  }, {passive:true});

  area.addEventListener('touchend', ()=>{
    if(!tracking){ return; }
    if(dx >= TRIGGER){
      setX(MAXVIS, true);
      // küçük bir gecikme ile geçmişe dön
      setTimeout(()=> history.back(), 10);
    }else{
      // geri dön animasyonu
      setX(0, true);
      setTimeout(reset, 220);
    }
  }, {passive:true});

  area.addEventListener('touchcancel', reset, {passive:true});
})();


/* ====== Rapor mantığı (mevcut kodlarınız korunarak) ====== */
const qs  = s => document.querySelector(s);
const qsa = s => [...document.querySelectorAll(s)];
const money = n => new Intl.NumberFormat('tr-TR',{style:'currency',currency:'TRY',maximumFractionDigits:2}).format(n||0);
const norm  = s => (s||'').toString().trim().toLocaleLowerCase('tr-TR');
const tidy   = s => (s||'').toString().trim().replace(/\s+/g,' ');
const normTR = s => tidy(s).toLocaleLowerCase('tr-TR');
function titleTR(s){
  const lower = normTR(s);
  const SEP = /([ \t\r\n\-\u2019'_/.,;:()]+)/;
  return lower.split(SEP).map(part=>{
    if (!part || SEP.test(part)) return part;
    return part.charAt(0).toLocaleUpperCase('tr-TR') + part.slice(1);
  }).join('');
}
const chunk = (arr,size)=>arr.length? [arr.slice(0,size)].concat(chunk(arr.slice(size),size)) : [];
const sevenDaysAgo = (()=>{ const d=new Date(); d.setDate(d.getDate()-7); return d.toISOString().slice(0,10); })();

const params = new URLSearchParams(location.search);
const paramPersonel = params.get('personel') ? decodeURIComponent(params.get('personel')) : 'ALL';
const paramYil = params.get('yil') || '2025';

async function loadPeople(){
  const snap = await db.collection('tahakkuklar').get();
  const set = new Set();
  snap.forEach(d=>{ const p=(d.data().personel||'').toString().trim(); if(p) set.add(p); });
  const arr = [...set].sort((a,b)=>a.localeCompare(b,'tr'));
  const sel = qs('#personelSecim');
  sel.innerHTML = `<option value="ALL">Tüm Personel</option>` +
    arr.map(n=>`<option value="${n}">${titleTR(n)}</option>`).join('');
  qs('#selYil').value = ['2023','2024','2025','tum'].includes(paramYil) ? paramYil : '2025';
  if (arr.includes(paramPersonel)) sel.value = paramPersonel; else sel.value = 'ALL';
}

async function calcRanksForYear(yil){
  let qTah = db.collection('tahakkuklar');
  if(yil!=='tum') qTah = qTah.where('yil','==',Number(yil));
  const tSnap = await qTah.get();
  const sumTah = {};
  tSnap.forEach(d=>{
    const x=d.data(); const p=(x.personel||'').toString().trim();
    sumTah[p]=(sumTah[p]||0)+Number(x.tahakkuk||0);
  });

  let qTsl = db.collection('tahsilatlar');
  if(yil!=='tum') qTsl = qTsl.where('yil','==',Number(yil));
  const sSnap = await qTsl.get();
  const sumTsl = {};
  sSnap.forEach(d=>{
    const x=d.data(); const p=(x.personel||'').toString().trim();
    sumTsl[p]=(sumTsl[p]||0)+Number(x.tutar||0);
  });

  const everyone = Object.keys({...sumTah, ...sumTsl});
  const list = everyone.map(p=>{
    const tah = sumTah[p]||0, tsl=sumTsl[p]||0;
    const oran = tah>0 ? (tsl/tah) : 0;
    return {p, tah, oran};
  });
  const borcOrder = [...list].sort((a,b)=>b.tah - a.tah).map((r,i)=>({p:r.p,sira:i+1}));
  const oranOrder = [...list].sort((a,b)=>b.oran - a.oran).map((r,i)=>({p:r.p,sira:i+1}));

  return function getRank(person){
    const b = borcOrder.find(x=>x.p===person)?.sira ?? '-';
    const o = oranOrder.find(x=>x.p===person)?.sira ?? '-';
    return {borcSira:b, oranSira:o};
  };
}

function renderSiralamaRozetleri({borcSira, oranSira}, toplamTahakkuk, toplamTahsilat){
  const oran = toplamTahakkuk>0 ? (100*toplamTahsilat/toplamTahakkuk) : 0;
  qs('#siralamaEtiketleri').innerHTML =
    `<span class="badge-siralama">Toplam Tahakkuk Borç Sıralaması: <strong>${borcSira}. sıradasınız</strong></span>
     <span class="badge-siralama">Tahsilat Oranı Sıralaması: <strong>${oranSira}. sıradasınız</strong> (Mevcut oran: ${oran.toFixed(1)}%)</span>`;
}

async function loadReport(){
  const person = qs('#personelSecim').value || 'ALL';
  const yil    = qs('#selYil').value;

  qs('#baslik').textContent = person==='ALL' ? 'Tüm Personel' : person;
  qs('#altBaslik').textContent = `Yıl: ${yil==='tum' ? 'Tümü' : yil}`;
  qs('#kisiBaslik').textContent = person==='ALL' ? 'Kişi Bazlı Alacak Raporu' : person;

  let qTah = db.collection('tahakkuklar');
  if (person!=='ALL') qTah = qTah.where('personel','==', person);
  if (yil!=='tum')    qTah = qTah.where('yil','==', Number(yil));
  const tSnap = await qTah.get();
  const tahakkuklar = tSnap.docs.map(d=>({id:d.id, ...d.data()}));

  let tahsilatlar = [];
  const ids = tahakkuklar.map(x=>x.id);
  for (const part of chunk(ids,10)){
    if(part.length===0) continue;
    const s = await db.collection('tahsilatlar').where('tahakkukId','in',part).get();
    tahsilatlar = tahsilatlar.concat(s.docs.map(d=>({id:d.id, ...d.data()})));
  }
  let qTsl = db.collection('tahsilatlar');
  if (person!=='ALL') qTsl = qTsl.where('personel','==', person);
  if (yil!=='tum')    qTsl = qTsl.where('yil','==', Number(yil));
  const sSnap = await qTsl.get();
  const extra = sSnap.docs.map(d=>({id:d.id, ...d.data()}));
  const seen = new Set(tahsilatlar.map(x=>x.id));
  extra.forEach(x=>{ if(!seen.has(x.id)) tahsilatlar.push(x); });

  const byId = new Map();
  tahsilatlar.forEach(s=>{
    const arr = byId.get(s.tahakkukId)||[];
    arr.push(s); byId.set(s.tahakkukId,arr);
  });
  const keyOf = (y,fa,p,bor)=>`${y}|${norm(fa)}|${norm(p)}|${norm(bor)}`;
  const byKey = new Map();
  tahsilatlar.forEach(s=>{
    const k = keyOf(s.yil, s.faaliyet, s.personel||'', s.borclu||'');
    const arr = byKey.get(k)||[]; arr.push(s); byKey.set(k,arr);
  });

  const rows = tahakkuklar.map(t=>{
    const k = keyOf(t.yil, t.faaliyet, t.personel||'', t.borclu||'');
    const rel = (byId.get(t.id)||[]).concat(byKey.get(k)||[]);
    const uniq = []; const mem = new Set();
    rel.forEach(x=>{ if(!mem.has(x.id)){ mem.add(x.id); uniq.push(x); } });
    const sumAll = uniq.reduce((a,b)=>a+Number(b.tutar||0),0);
    const sumNew = uniq.filter(x=>(x.tarih||'')>=sevenDaysAgo).reduce((a,b)=>a+Number(b.tutar||0),0);
    return {
      yil: t.yil,
      faaliyet: titleTR(t.faaliyet),
      borclu:   titleTR(t.borclu||''),
      odeyen:   titleTR(uniq[uniq.length-1]?.odeyen || ''),
      tahakkuk: +Number(t.tahakkuk||0),
      tahsilat: +Number(sumAll - sumNew),
      yeni: +Number(sumNew),
      kalan: +Number(t.tahakkuk||0) - +Number(sumAll)
    };
  });

  renderAll(rows, person, yil);

  if(person==='ALL'){
    qs('#siralamaEtiketleri').innerHTML = '';
  }else{
    const getRank = await calcRanksForYear(yil);
    const totals = rows.reduce((a,b)=>{ a.tah+=(b.tahakkuk||0); a.tsl+=(b.tahsilat||0)+(b.yeni||0); return a; }, {tah:0, tsl:0});
    renderSiralamaRozetleri(getRank(person), totals.tah, totals.tsl);
  }
}

let currentSort = {col:null, dir:'asc'};
const numCols = new Set(['tahakkuk','tahsilat','yeni','kalan','yil']);

function sortRows(rows){
  const {col,dir} = currentSort;
  if(!col) return rows;
  const type = numCols.has(col) ? 'num' : 'str';
  const cmp = (a,b)=> type==='num' ? ((+a||0)-(+b||0)) : String(a||'').localeCompare(String(b||''),'tr',{sensitivity:'base'});
  const arr = rows.slice().sort((x,y)=>cmp(x[col], y[col]));
  return dir==='asc' ? arr : arr.reverse();
}

function renderAll(rows, person, yil){
  qs('#pillAdet').textContent = `${rows.length} kayıt`;

  const tTah = rows.reduce((a,b)=>a+(b.tahakkuk||0),0);
  const tTsl = rows.reduce((a,b)=>a+(b.tahsilat||0)+(b.yeni||0),0);
  const tKal = tTah - tTsl;
  qs('#kpiTahakkuk').textContent = money(tTah);
  qs('#kpiTahsilat').textContent = money(tTsl);
  qs('#kpiKalan').textContent    = money(tKal);

  const fMap = new Map();
  rows.forEach(r=>{
    const key = normTR(r.faaliyet);
    if(!key) return;
    if(!fMap.has(key)) fMap.set(key, { display: titleTR(r.faaliyet), tah:0, tsl:0 });
    const o = fMap.get(key);
    o.tah += +r.tahakkuk || 0;
    o.tsl += (+r.tahsilat || 0) + (+r.yeni || 0);
  });

  const grid = qs('#faaliyetGrid'); grid.innerHTML='';
  [...fMap.values()]
    .map(v => ({ ...v, kalan: v.tah - v.tsl }))
    .sort((a,b) => b.kalan - a.kalan)
    .forEach(item=>{
      let cls='kalan-non'; if(item.kalan>0) cls='kalan-pozitif'; if(item.kalan<0) cls='kalan-negatif';
      const div = document.createElement('div');
      div.className='faaliyet-kart';
      div.innerHTML = `
        <div class="f-title">${item.display}</div>
        <div class="f-tah">Tahakkuk: ${money(item.tah)}</div>
        <div class="f-tas">Tahsilat: ${money(item.tsl)}</div>
        <span class="kalan-etiket ${cls}">Kalan: ${money(item.kalan)}</span>`;
      grid.appendChild(div);
    });

  const tbody = qs('#tbody'); tbody.innerHTML='';
  let sTah=0,sTsl=0,sYeni=0,sKal=0;
  sortRows(rows).forEach(r=>{
    sTah+=r.tahakkuk||0; sTsl+=r.tahsilat||0; sYeni+=r.yeni||0; sKal+=r.kalan||0;
    const tr=document.createElement('tr');
    if(Math.abs(r.kalan)<0.001) tr.classList.add('zero');
    tr.innerHTML = `
      <td>${r.yil}</td>
      <td>${r.faaliyet||''}</td>
      <td>${r.borclu||''}</td>
      <td>${r.odeyen||''}</td>
      <td class="right">${money(r.tahakkuk)}</td>
      <td class="right">${money(r.tahsilat)}</td>
      <td class="right">${money(r.yeni)}</td>
      <td class="right">${money(r.kalan)}</td>`;
    tbody.appendChild(tr);
  });
  qs('#sumTahakkuk').textContent = money(sTah);
  qs('#sumTahsilat').textContent = money(sTsl);
  qs('#sumYeni').textContent     = money(sYeni);
  qs('#sumKalan').textContent    = money(sKal);
}

/* Sıralama başlıkları */
qsa('#hdr th').forEach(th=>{
  th.addEventListener('click', ()=>{
    const col = th.dataset.col; if(!col) return;
    currentSort.dir = (currentSort.col===col && currentSort.dir==='asc') ? 'desc' : 'asc';
    currentSort.col = col;
    qsa('#hdr th').forEach(x=>x.classList.remove('sort-asc','sort-desc'));
    th.classList.add(currentSort.dir==='asc'?'sort-asc':'sort-desc');

    const rows = [...qs('#tbody').querySelectorAll('tr')].map(tr=>{
      const tds = tr.querySelectorAll('td');
      const parseMoney = s => +tds[s].textContent.replace(/\D/g,'')/100;
      return {
        yil: +tds[0].textContent,
        faaliyet: tds[1].textContent,
        borclu: tds[2].textContent,
        odeyen: tds[3].textContent,
        tahakkuk: parseMoney(4),
        tahsilat: parseMoney(5),
        yeni: parseMoney(6),
        kalan: parseMoney(7),
      };
    });
    const person = qs('#personelSecim').value||'ALL';
    const yil    = qs('#selYil').value;
    renderAll(rows, person, yil);
  });
});

/* PDF */
document.addEventListener('click', (e)=>{
  if(e.target && e.target.id==='btnPDF'){
    const el = document.getElementById('pdf-root');
    const person = qs('#personelSecim').value || 'ALL';
    const yil = qs('#selYil').value;
    const opt = {
      margin:[10,10,10,10],
      filename:`${person}-${yil}-alacak-raporu.pdf`,
      image:{type:'jpeg',quality:0.98},
      html2canvas:{scale:2,useCORS:true,scrollY:-window.scrollY},
      pagebreak:{mode:['css','legacy']},
      jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}
    };
    html2pdf().set(opt).from(el).save();
  }
});

/* ====== Başlat ====== */
(async function init(){
  const {gunKisa, tarihTR} = fmtDate();
  $('gun').textContent=gunKisa; $('tarih').textContent=tarihTR;

  auth.onAuthStateChanged(async (user)=>{
    if(!user){ window.location.href = '../../index.html'; return; }

    const uid  = user.uid;
    const meta = await loadUser(uid);

    // Tema (localStorage > meta.tema > 'oto')
    const tema = readThemeLocal(uid) || meta.tema || 'oto';
    setTheme(tema); saveThemeLocal(uid, tema);
    window.addEventListener('storage', (e)=>{
      if(e.key === `temaAyar:${uid}`){ setTheme(e.newValue || 'oto'); }
    });

    // YETKİLER: "Panel: Sayfa" stringlerinden panel->label listesi
    const rawYetkiler = Array.isArray(meta.yetkiler) ? meta.yetkiler : [];
    const byPanelLabels = {};  // { Muhasebe: ["Aylık Gelir/Gider", ...], ... }
    rawYetkiler.forEach(s=>{
      const str = String(s);
      const i = str.indexOf(':');
      if(i<0) return;
      let panel = str.slice(0,i).trim();
      let label = str.slice(i+1).trim();
      panel = normPanelName(panel);
      if(!ALL_PANELS.includes(panel)) return;
      (byPanelLabels[panel] ||= []).push(label);
    });
    CURRENT_PERMS = byPanelLabels;

    // MANIFEST'i çek ve Tabbar'ı çiz
    MANIFEST = await loadManifest();
    renderTabbar(Object.keys(byPanelLabels));

    // Rapor veri
    await loadPeople();
    await loadReport();
  });

  // Buton/Select eventleri
  document.getElementById('btnYukle').addEventListener('click', loadReport);
  document.getElementById('personelSecim').addEventListener('change', loadReport);
  document.getElementById('selYil').addEventListener('change', loadReport);
})();
</script>
</body>
</html>

