<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<title>Nöbet Planı | Karaağaç Fatih</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link rel="icon" type="image/png" href="../img/logo.png" />

<style>
  :root{
    --appbar-h:56px; --radius:14px; --shadow:0 12px 28px rgba(0,0,0,.14);
    --bg:#0f172a; --bg2:#0b1324; --grad1:#0ea5e922; --grad2:#22d3ee22;
    --card:rgba(15,23,42,.92); --stroke:rgba(148,163,184,.18);
    --text:#e5e7eb; --muted:#9aa4b2; --brand:#38bdf8; --brand2:#0ea5e9;
    --pill:#0b1220; --pill-hover:#101a2b; --link:#c7e9ff; --surface:rgba(2,6,23,.08);
  }
  @media (prefers-color-scheme: light){
    :root{--bg:#eef6ff;--bg2:#f7fbff;--grad1:#38bdf822;--grad2:#22d3ee22;
      --card:rgba(255,255,255,.95);--stroke:rgba(15,23,42,.12);
      --text:#0b1220;--muted:#4b5563;--brand:#0ea5e9;--brand2:#0284c7;
      --pill:#f5f8ff;--pill-hover:#e9f2ff;--link:#0b5ea8;--surface:#eef3ff;}
  }
  html[data-theme="dark"]{--bg:#0f172a;--bg2:#0b1324;--grad1:#0ea5e922;--grad2:#22d3ee22;
    --card:rgba(15,23,42,.92);--stroke:rgba(148,163,184,.18);--text:#e5e7eb;--muted:#9aa4b2;
    --brand:#38bdf8;--brand2:#0ea5e9;--pill:#0b1220;--pill-hover:#101a2b;--link:#c7e9ff;--surface:rgba(2,6,23,.08);}
  html[data-theme="light"]{--bg:#eef6ff;--bg2:#f7fbff;--grad1:#38bdf822;--grad2:#22d3ee22;
    --card:rgba(255,255,255,.95);--stroke:rgba(15,23,42,.12);--text:#0b1220;--muted:#4b5563;
    --brand:#0ea5e9;--brand2:#0284c7;--pill:#f5f8ff;--pill-hover:#e9f2ff;--link:#0b5ea8;--surface:#eef3ff;}

  *{box-sizing:border-box}
  html,body{height:100%; overflow-x:hidden;}
  body{
    margin:0; color:var(--text); font-family:ui-sans-serif,-apple-system,"Segoe UI",Roboto,Arial;
    background:
      radial-gradient(900px 680px at 12% 8%, var(--grad1), transparent 45%),
      radial-gradient(800px 640px at 88% 92%, var(--grad2), transparent 50%),
      linear-gradient(140deg, var(--bg), var(--bg2) 60%);
  }
  a{color:var(--link); text-decoration:none} a:hover{text-decoration:underline}

  /* APPBAR */
  .appbar{position:sticky; top:0; z-index:60; height:var(--appbar-h);
    background:var(--card); backdrop-filter:blur(10px); border-bottom:1px solid var(--stroke);
    display:flex; align-items:center; padding:0 12px;}
  .brand{display:flex; align-items:center; gap:10px; cursor:pointer}
  .brand img{width:24px; height:24px} .brand span{font-weight:900; color:var(--text)}
  .nav-center{margin:0 auto; height:100%}
  .nav-list{display:flex; gap:22px; align-items:center; height:100%; list-style:none; margin:0; padding:0}
  .nav-item{position:relative; height:100%}
  .nav-btn{height:100%; display:flex; align-items:center; gap:6px; color:var(--text); font-weight:600; cursor:pointer}
  .nav-btn:hover{color:var(--brand)}
  .dropdown{position:absolute; top:100%; left:0; min-width:240px; background:var(--card);
    border:1px solid var(--stroke); border-radius:10px; box-shadow:var(--shadow); padding:8px; display:none}
  .dropdown a{display:flex; gap:8px; padding:8px 10px; border-radius:8px; color:var(--text)}
  .dropdown a:hover{background:var(--surface)}
  .nav-item.open .dropdown{display:block}
  .nav-right{display:flex; gap:8px; align-items:center}
  .btn{border:1px solid var(--stroke); background:var(--card); color:var(--text); border-radius:999px; padding:8px 12px; cursor:pointer}
  .hamb{display:none}

  /* DRAWER (mobil) */
  .drawer{position:fixed; top:var(--appbar-h); right:0; bottom:0; left:30%;
    transform:translateX(100%); transition:transform .25s ease; background:var(--card);
    border-left:1px solid var(--stroke); z-index:70; overflow:auto; padding:12px}
  .drawer.open{transform:translateX(0)}
  .drawer .panel-title{margin:14px 4px 6px; font-weight:800; color:var(--muted); font-size:13px}
  .drawer a{display:block; padding:10px; border-radius:10px; border:1px solid var(--stroke); margin:6px 0; color:var(--text); background:var(--pill)}
  .drawer a:hover{background:var(--pill-hover)}
  @media (max-width:640px){ .hamb{display:inline-block} .nav-center{display:none} .drawer{left:0; width:100%} }

  /* CONTENT */
  .container{max-width:1100px; margin:0 auto; padding:16px 16px 24px}
  .hero{display:flex; justify-content:space-between; align-items:flex-start; gap:16px;
    background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius);
    padding:16px; margin:16px 0; box-shadow:var(--shadow)}
  .hero h2{margin:0 0 6px; font-size:20px}
  .hero-sub{color:var(--muted); font-size:13px}
  .mini{display:flex; gap:8px; flex-wrap:wrap}
  .pill{padding:6px 10px; border-radius:999px; border:1px solid var(--stroke); background:var(--pill); font-size:12px}

  .card{background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px; margin-bottom:16px}
  .card h3{margin:0 0 10px; font-size:16px; display:flex; justify-content:space-between; align-items:center}

  .toolbar{display:flex; gap:8px; flex-wrap:wrap}
  .tbtn{border:1px solid var(--stroke); background:var(--pill); color:var(--text); padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:700}
  .tbtn.active{background:linear-gradient(90deg,var(--brand2),var(--brand)); color:#fff; border-color:transparent}
  .ctrls{margin-top:10px; display:flex; gap:8px; flex-wrap:wrap}
  .ctrls input,.ctrls select{padding:8px 10px; border:1px solid var(--stroke); border-radius:10px; background:var(--pill); color:var(--text)}

  table{width:100%; border-collapse:collapse}
  th,td{border-bottom:1px solid var(--stroke); padding:12px 10px; text-align:left}
  thead th{font-size:12px; color:var(--muted)}
  .time{font-variant-numeric:tabular-nums; font-weight:700; color:var(--brand2)}
  .muted{color:var(--muted)}
  .caret{font-size:12px; opacity:.6}

  .mobile-only{display:none}
  .desktop-only{display:block}
  @media (max-width:640px){
    .mobile-only{display:block}
    .desktop-only{display:none}
    .card h3{flex-direction:column; align-items:flex-start; gap:8px}
    .toolbar{display:grid; gap:8px; width:100%; grid-template-columns:1fr 1fr}
    .toolbar .tbtn{width:100%}
    .toolbar .tbtn.primary{grid-column:1 / -1}
    .ctrls{display:flex; gap:8px; flex-wrap:wrap; align-items:center}
    .ctrls > *{flex:1 1 auto}
    .ctrls button{flex:0 0 auto}
  }

  /* Aylık grid */
  .cal{display:grid; gap:8px; grid-template-columns:repeat(7,1fr); grid-auto-rows:148px; margin-top:10px}
  .cal-cell{border:1px solid var(--stroke); background:var(--surface); border-radius:12px; padding:8px; display:flex; flex-direction:column; gap:6px; overflow:hidden}
  .cal-date{font-weight:800; font-size:12px; color:var(--muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
  .cal .time{font-size:11px; font-weight:600; color:var(--muted); opacity:.9}
  .badge{display:inline-flex; align-items:center; gap:6px; border:1px solid var(--stroke); border-radius:999px; padding:4px 8px; font-size:11px; background:var(--card); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:100%}
  .role-b::before{content:"B:"; font-weight:800}
  .role-e::before{content:"E:"; font-weight:800}
  @media (max-width:1024px){ .cal{grid-template-columns:repeat(2,1fr)} }

  /* Haftalık görünüm – tek tablo, mobilde tablo scroll */
  .table-wrap{overflow:auto; -webkit-overflow-scrolling:touch; border-radius:12px}

  /* Personel tablosu */
  .per-table{width:100%; border-collapse:collapse; table-layout:fixed}
  .per-table th, .per-table td{border-bottom:1px solid var(--stroke); padding:10px 8px}
  .per-table thead th{font-size:12px; color:var(--muted)}
  .per-table td:nth-child(1){width:26%}
  .per-table td:nth-child(2){width:26%}
  .per-table td:nth-child(3){width:26%}
  .per-table td:nth-child(4){width:22%}

  td, .badge{word-break:break-word;overflow-wrap:anywhere}

  .page-end{
    height:84px; margin-top:16px;
    background:linear-gradient(180deg, rgba(2,6,23,0), rgba(2,6,23,.08) 45%, rgba(2,6,23,.12));
    border-top:1px solid var(--stroke);
    border-bottom-left-radius:16px; border-bottom-right-radius:16px;
  }
  /* === Mobil tablo iyileştirmeleri (yalnızca ≤640px) === */
@media (max-width:640px){
  /* Sayfa değil tablo kayacak */
  .table-wrap{ overflow:auto; -webkit-overflow-scrolling:touch }

  /* Tablo genişliği sabit olsun ki metinler kırılmasın */
  .table-wrap table{ min-width:560px; border-collapse:separate; border-spacing:0 }

  /* Gün, tarih, saat ve kişiler TEK satır kalsın */
  .weekly-table th, .weekly-table td,
  .per-table   th, .per-table   td{ white-space:nowrap }

  /* Saatler daha kompakt */
  .weekly-table .time, .per-table .time{ white-space:nowrap; font-size:12px; }

  /* İlk iki kolon için minimum genişlik (okunurluk) */
  .weekly-table th:nth-child(1), .weekly-table td:nth-child(1){ min-width:80px }
  .weekly-table th:nth-child(2), .weekly-table td:nth-child(2){ min-width:80px }

  /* Satır içi notlar mobilde gizlensin (taşmayı azaltır) */
  .note-inline{ display:none }
}
    :root{
      /* tabbar yüksekliği ve ekstra kaldırma (gap) */
      --tabbar-base: 56px;     /* buton yüksekliği */
      --tabbar-lift: 12px;     /* home indicator’dan uzaklık */
      --tabbar-h: calc(var(--tabbar-base) + env(safe-area-inset-bottom) + var(--tabbar-lift));
    }

    /* body scroll’u kapat, gerçek scroll .app’te olsun (iOS bounce düzgün) */
    html,body{height:100%; overflow:hidden}

    /* İçerik alanı: üstte çentik payı, altta tabbar payı */
    .app{
      height: calc(100vh - var(--tabbar-h));
      padding-top: calc(env(safe-area-inset-top) + 8px);
      padding-bottom: var(--tabbar-h);
      overflow:auto;
      -webkit-overflow-scrolling: touch;
    }
    
    /* iOS-layout */
    --appbar-h: calc(56px + env(safe-area-inset-top));
    --tabbar-h: calc(64px + env(safe-area-inset-bottom));
    --radius:14px; --shadow:0 12px 28px rgba(0,0,0,.14);
    
    /* Videoda gördüğün beyaz bant sorununu önlemek için */
    .app::after{
      content:""; position:fixed; left:0; right:0; bottom:var(--tabbar-h);
      height:10px; background:linear-gradient(180deg, transparent, var(--bg2));
      pointer-events:none; z-index:1;
    }
    /* Tabbar */
    .tabbar{
      position:fixed; left:0; right:0;
      bottom: calc(env(safe-area-inset-bottom) + var(--tabbar-lift));
      height: var(--tabbar-h);
      padding-bottom: env(safe-area-inset-bottom)
      border-top:1px solid var(--stroke);
      background:var(--bg2);
      z-index:60;
      display:flex; align-items:center; justify-content:center;
      transform: translateZ(0);
    }
    .tabbar::before{
      content:""; position:absolute; left:0; right:0; top:-10px; height:10px;
      background:var(--bg2); pointer-events:none;
    }
    .tabbar .rail{
      display:flex !important; flex-direction:row !important; flex-wrap:nowrap !important;
      align-items:center; justify-content:center;
      gap:12px; max-width:1100px; width:100%;
      padding:6px 10px; overflow-x:auto; -webkit-overflow-scrolling:touch; white-space:nowrap;
      !box-shadow:none;
    }
    /* Tabbar butonları */
    .tabbar .tb, .tabbar .tb:link, .tabbar .tb:visited, .tabbar .tb:hover, .tabbar .tb:active{
      display:flex; flex-direction:column; align-items:center; gap:4px;
      min-width:72px; padding:6px 8px;
      color:var(--muted) !important; text-decoration:none !important;
      border-radius:12px;
      background:transparent;           /* toolbar stilini sıfırla */
      border:none;                       /* toolbar stilini sıfırla */
    }
    .tabbar .tb .ico{font-size:20px; line-height:20px}
    .tabbar .tb .lbl{font-size:11.5px; line-height:1}
    .tabbar .tb.active{color:var(--brand) !important}
    .tabbar .tb.home{border:1px dashed var(--stroke)}

    /* Sheet */
    .sheet-backdrop{position:fixed; inset:0; z-index:59; display:none}
    .sheet{
      position:fixed; left:10px; right:10px; bottom:calc(var(--tabbar-h) + 10px);
      background:var(--card); border:1px solid var(--stroke); border-radius:18px; box-shadow:var(--shadow);
      z-index:61; display:none; max-height:40vh; overflow:auto;
    }
    .sheet .grip{width:44px; height:5px; background:var(--stroke); border-radius:999px; margin:8px auto}
    .sheet .title{padding:6px 14px; font-weight:800}
    .sheet .list{display:flex; flex-direction:column}
    .sheet .item{padding:12px 14px; border-top:1px dashed var(--stroke); display:flex; align-items:center; justify-content:space-between; gap:10px}
    .sheet .item .go{font-size:18px; opacity:.6}

    /* Pull-to-refresh ipucu */
    .ptr-tip{
      position:fixed; top:calc(env(safe-area-inset-top) + 6px); left:50%; transform:translateX(-50%);
      padding:6px 10px; font-size:12px; background:var(--bg2); border:1px solid var(--stroke);
      color:var(--muted); border-radius:999px; opacity:0; transition:.25s; z-index:62;
    }
    .ptr-tip.show{opacity:1}

</style>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="../js/firebase/firebase-init.js"></script>
</head>
<body>

<!-- CONTENT -->
<div class="app" id="scrollArea">
<div class="ptr-tip" id="ptrTip">Yenilemek için bırak</div>

<main class="container">
  <section class="hero">
    <div>
      <h2>Nöbet Planı</h2>
      <div class="hero-sub">Bugün: <span id="todayText">—</span></div>
      <div class="mini">
        <span class="pill">Hafta: <b id="outWeek">—</b></span>
        <span class="pill">Özel Pazar: <b id="sumPazar">—</b></span>
      </div>
    </div>
  </section>

  <section class="card">
    <h3>
      <span>Nöbet Görünümleri</span>
      <div class="toolbar">
        <button class="tbtn primary active" data-mode="hafta">Haftalık Nöbet Takvimi</button>
        <button class="tbtn" data-mode="ay">Aylık Nöbet Takvimi</button>
        <button class="tbtn" data-mode="personel">Personel Nöbet Takvimi</button>
      </div>
    </h3>

    <div id="controls" class="ctrls"></div>
    <div id="results" style="margin-top:10px"></div>
  </section>
</main>
</div>

  <!-- Sheet (panel listesi) -->
  <div class="sheet-backdrop" id="sheetBackdrop"></div>
  <div class="sheet" id="panelSheet">
    <div class="grip"></div>
    <div class="title" id="sheetTitle">—</div>
    <div class="list" id="sheetList"></div>
  </div>

  <!-- Tabbar -->
  <div class="tabbar">
    <div class="rail" id="tabRail"></div>
  </div>


<div class="toast" id="toast" style="position:fixed;left:50%;bottom:24px;transform:translateX(-50%) translateY(20px);background:rgba(2,6,23,.95);color:#fff;border:1px solid rgba(255,255,255,.08);border-radius:12px;padding:10px 12px;opacity:0;pointer-events:none;transition:opacity .25s, transform .25s;z-index:200"></div>

<script>
/* ===== Tema ===== */
    /* ===== Tema (profilden alınır) ===== */
    function applyProfileTheme(uid, meta){
      const sysDark = () => window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      const pref = localStorage.getItem(`temaAyar:${uid}`) || meta?.tema || 'oto';   // 'acik' | 'koyu' | 'oto'
      const eff  = pref === 'oto' ? (sysDark() ? 'dark' : 'light') : (pref === 'koyu' ? 'dark' : 'light');
      document.documentElement.setAttribute('data-theme', eff);
    }

/* ===== Firebase & helpers ===== */
const db=firebase.firestore(), auth=firebase.auth();
function showToast(m){const t=document.getElementById('toast'); t.textContent=m; t.style.opacity=1; t.style.transform='translateX(-50%) translateY(0)'; clearTimeout(window.__to); window.__to=setTimeout(()=>{t.style.opacity=0; t.style.transform='translateX(-50%) translateY(20px)';},2400);}
function setToday(){const d=new Date();const days=['Pazar','Pazartesi','Salı','Çarşamba','Perşembe','Cuma','Cumartesi'];document.getElementById('todayText').textContent=`${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()} • ${days[d.getDay()]}`;}
function fmtTR(iso){const d=new Date(iso+'T12:00:00');return `${String(d.getDate()).padStart(2,'0')}-${String(d.getMonth()+1).padStart(2,'0')}-${d.getFullYear()}`;}
function isoWeek(date){const d=new Date(Date.UTC(date.getFullYear(),date.getMonth(),date.getDate()));const day=d.getUTCDay()||7;d.setUTCDate(d.getUTCDate()+4-day);const yStart=new Date(Date.UTC(d.getUTCFullYear(),0,1));const w=Math.ceil((((d-yStart)/86400000)+1)/7);return {isoYear:d.getUTCFullYear(),weekNo:w};}
function weekKeyFrom(date){ const {isoYear,weekNo}=isoWeek(date); return `${isoYear}-W${('0'+weekNo).slice(-2)}`; }
const norm = s => String(s||'').trim().toLowerCase();
function gunTR(y,m,d){ const t=new Date(y,m-1,d); const dn=['Pazar','Pazartesi','Salı','Çarşamba','Perşembe','Cuma','Cumartesi']; return dn[t.getDay()]; }

/* ===== Nav / Manifest / Yetki ===== */
let CURRENT_ALLOW=new Set(), CURRENT_DENY=new Set(), PERMS_READY=false;

const PANEL_ICON  = { 'Admin':'🎛️','Talebe':'📘','Personel':'👤','Muhasebe':'💰','Kermes':'🏪','Nehari':'🕌','Sistem Ayarları':'⚙️' };

function resolveHref(p){
  if(!p) return '#';
  if(/^(https?:)?\/\//i.test(p) || p.startsWith('/') || p.startsWith('./') || p.startsWith('../')) return p;
  // bu dosya panel/nobet.html altında => kardeş klasöre çık
  return '../' + p.replace(/^\/+/, '');
}

async function fetchPanels(allowSet, denySet){
  const res=[];
  try{
    const snap=await db.collection('sayfa_manifesti').get();
    snap.forEach(doc=>{
      const d=doc.data()||{}, id=doc.id;
      const panelTitle=d.title||id;
      const panelGrant = allowSet.has(norm(id)) || allowSet.has(norm(panelTitle));
      let pages = Array.isArray(d.pages)? d.pages : [];
      pages = pages.filter(pg=>{
        const keyNorm = norm(pg.key || pg.title || '');
        const pageGrant = allowSet.has(keyNorm);
        const denied    = denySet.has(keyNorm);
        return !denied && (panelGrant || pageGrant);
      }).map(pg=>({
        baslik: pg.title || pg.key || 'Sayfa',
        url: resolveHref(pg.path || '#'),
        key: pg.key || pg.title || '',
        sira: typeof pg.order==='number'?pg.order:9999
      }))
      .sort((a,b)=>a.sira-b.sira);
      if(pages.length) res.push({ id, baslik:panelTitle, ikon:d.icon||PANEL_ICON[id]||'📁', sira: typeof d.order==='number'?d.order:9999, pages });
    });
    res.sort((a,b)=>a.sira-b.sira);
  }catch(e){ console.warn(e); }
  return res;
}

function renderNav(panels){
  const ul=document.getElementById('navMain'), drawer=document.getElementById('drawer');
  ul.innerHTML=''; drawer.innerHTML='';
  if(!panels.length){ ul.innerHTML='<li class="nav-item"><div class="nav-btn">Menü Yok</div></li>'; return; }

  panels.forEach(p=>{
    const li=document.createElement('li'); li.className='nav-item';
    li.innerHTML=`<div class="nav-btn">${p.baslik} <span class="caret">▾</span></div>`;
    const dd=document.createElement('div'); dd.className='dropdown';
    (p.pages||[]).forEach(pg=>{
      const a=document.createElement('a');
      a.href=pg.url; a.textContent=pg.baslik;
      a.dataset.key=pg.key||pg.baslik; a.dataset.panel=p.id; a.dataset.panelTitle=p.baslik;
      dd.appendChild(a);
    });
    li.appendChild(dd);
    li.querySelector('.nav-btn').addEventListener('click',(e)=>{ e.stopPropagation(); ul.querySelectorAll('.nav-item').forEach(x=>{ if(x!==li) x.classList.remove('open'); }); li.classList.toggle('open'); });
    ul.appendChild(li);
  });

  document.addEventListener('click',(e)=>{ if(!ul.contains(e.target)) ul.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('open')); });

  panels.forEach(p=>{
    const h=document.createElement('div'); h.className='panel-title'; h.textContent=p.baslik; drawer.appendChild(h);
    (p.pages||[]).forEach(pg=>{
      const a=document.createElement('a');
      a.href=pg.url; a.textContent=pg.baslik;
      a.dataset.key=pg.key||pg.baslik; a.dataset.panel=p.id; a.dataset.panelTitle=p.baslik;
      drawer.appendChild(a);
    });
  });
}

/* Link engelleme – sadece izinler hazırsa */
document.addEventListener('click', (e) => {
  const a=e.target.closest('a[data-key]'); if(!a) return;
  const href=a.getAttribute('href')||'#';
  if(href==='#'){ e.preventDefault(); return; }
  if(!PERMS_READY) return;
  const key=norm(a.dataset.key), pnl=norm(a.dataset.panel||''), pnlTitle=norm(a.dataset.panelTitle||'');
  if(CURRENT_DENY.has(key)){ e.preventDefault(); showToast('Bu sayfa için yetkiniz yok.'); return; }
  const allowed = CURRENT_ALLOW.has(key) || CURRENT_ALLOW.has(pnl) || CURRENT_ALLOW.has(pnlTitle);
  if(!allowed){ e.preventDefault(); showToast('Bu sayfa için yetkiniz yok.'); }
});

/* ===== Görünümler ===== */
const controls=document.getElementById('controls');
let currentMode='hafta';
document.querySelectorAll('.tbtn').forEach(b=>b.addEventListener('click',()=>{
  document.querySelectorAll('.tbtn').forEach(x=>x.classList.remove('active'));
  b.classList.add('active'); currentMode=b.dataset.mode; buildControls();
}));

function buildControls(){
  const res=document.getElementById('results'); res.innerHTML='';
  if(currentMode==='hafta'){
    controls.innerHTML = `<input type="date" id="ctlHaftaDate"> <button class="tbtn" id="btnFetchWeek">Getir</button>`;
    const d=new Date(); document.getElementById('ctlHaftaDate').value=d.toISOString().slice(0,10);
    document.getElementById('btnFetchWeek').onclick=()=>loadWeek(new Date(document.getElementById('ctlHaftaDate').value+"T12:00:00"));
    loadWeek(new Date());
  }else if(currentMode==='ay'){
    controls.innerHTML = `<input type="month" id="ctlAy"> <button class="tbtn" id="btnFetchMonth">Getir</button>`;
    const d=new Date(); document.getElementById('ctlAy').value=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
    document.getElementById('btnFetchMonth').onclick=()=>loadMonth(document.getElementById('ctlAy').value);
    loadMonth(document.getElementById('ctlAy').value);
  }else if(currentMode==='personel'){
    controls.innerHTML = `<span id="whoPill" class="pill">Kullanıcı: <b id="meName">—</b></span>
      <select id="ctlYear"></select>
      <button class="tbtn" id="btnFetchPerson">Getir</button>`;
    const ySel=document.getElementById('ctlYear'); const yr=new Date().getFullYear();
    ySel.innerHTML=[yr-1,yr,yr+1].map(y=>`<option ${y===yr?'selected':''}>${y}</option>`).join('');
    document.getElementById('btnFetchPerson').onclick=()=>loadPerson(window.__ME_PERSON__, ySel.value);
    if(window.__ME_PERSON__){ document.getElementById('meName').textContent=window.__ME_PERSON__; loadPerson(window.__ME_PERSON__, yr); }
  }
}

/* === Haftalık (tek tablo) === */
async function loadWeek(date){
  const key=weekKeyFrom(date);
  document.getElementById('outWeek').textContent=key;
  try{
    const snap=await db.collection('nobet_planlari').doc(key).get();
    if(!snap.exists){
      document.getElementById('results').innerHTML='<div class="muted">Plan bulunamadı</div>';
      document.getElementById('sumPazar').textContent='—'; return;
    }
    const data=snap.data();
    document.getElementById('sumPazar').textContent=data.isSpecialPazar?'Var':(data.isPazarTehir?'Tehir':'Yok');

    const rows = (data.rows||[]).map(r=>`
      <tr>
        <td>${r.gun}</td>
        <td>${fmtTR(r.tarihISO)}</td>
        <td class="time">${r.saat||''}</td>
        <td>${r.bekar ? r.bekar : '<span class="muted">—</span>'}</td>
        <td>${r.evli ? r.evli : '<span class="muted">—</span>'}${r.not ? `<span class="note-inline"> • ${r.not}</span>` : ''}</td>
      </tr>`).join('');

    const wrap=document.getElementById('results');
    wrap.innerHTML = `
      <div class="table-wrap">
        <table class="weekly-table">
          <thead><tr><th>Gün</th><th>Tarih</th><th>Saat</th><th>Bekâr</th><th>Evli / İhvan</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>
      </div>`;
  }catch(e){ console.error(e); showToast('Hata'); }
}

/* === Aylık === */
async function loadMonth(ym){
  const wrap = document.getElementById('results');
  wrap.innerHTML = '';
  if(!ym) return;

  try{
    const snap = await db.collection('nobet_index').where('monthKey','==', ym).get();
    const byDate = {};
    snap.forEach(doc=>{
      const x = doc.data(), dt = x.date;
      if(!byDate[dt]) byDate[dt] = { b:new Set(), e:new Set(), s:new Set() };
      (x.role==='bekar' ? byDate[dt].b : byDate[dt].e).add(x.person);
      if(x.saat) byDate[dt].s.add(x.saat);
    });

    const [Y,M] = ym.split('-').map(Number);
    const first = new Date(Y, M-1, 1);
    const daysInMonth = new Date(Y, M, 0).getDate();
    const startPad = (first.getDay()+6) % 7;
    const isMobileGrid = window.matchMedia('(max-width:1024px)').matches;
    const pad = isMobileGrid ? 0 : startPad;

    const h = document.createElement('h3'); h.textContent = `${ym} Aylık Takvim`; wrap.appendChild(h);

    const grid = document.createElement('div'); grid.className = 'cal';
    for(let i=0;i<pad;i++){ const c=document.createElement('div'); c.className='cal-cell'; c.style.visibility='hidden'; grid.appendChild(c); }

    for(let d=1; d<=daysInMonth; d++){
      const iso = `${Y}-${String(M).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
      const info = byDate[iso] || { b:new Set(), e:new Set(), s:new Set() };

      const cell = document.createElement('div'); cell.className = 'cal-cell';
      const dateEl = document.createElement('div'); dateEl.className = 'cal-date';
      dateEl.textContent = `${String(d).padStart(2,'0')}-${String(M).padStart(2,'0')}-${Y}  ${gunTR(Y,M,d)}`;
      cell.appendChild(dateEl);

      const saat = [...info.s].join(' + ');
      if(saat){ const t=document.createElement('div'); t.className='time'; t.textContent=saat; cell.appendChild(t); }

      const fmt = a => a.length<=2 ? a.join(', ') : `${a.slice(0,2).join(', ')} +${a.length-2}`;
      const bBadge = document.createElement('div'); bBadge.className='badge role-b'; bBadge.textContent=' ' + (info.b.size?fmt([...info.b]):'—');
      const eBadge = document.createElement('div'); eBadge.className='badge role-e'; eBadge.textContent=' ' + (info.e.size?fmt([...info.e]):'—');
      cell.appendChild(badgeLimit(bBadge)); cell.appendChild(badgeLimit(eBadge));

      grid.appendChild(cell);
    }
    wrap.appendChild(grid);
  }catch(e){ console.error(e); showToast('Aylık görünüm yüklenemedi.'); }

  function badgeLimit(el){ el.style.maxWidth='100%'; return el; }
}

/* === PERSONEL === */
async function loadPerson(person, year){
  if(!person){ document.getElementById('results').innerHTML='<div class="muted">Kullanıcı ismi eşleşmedi.</div>'; return; }
  const wrap=document.getElementById('results'); wrap.innerHTML='';
  try{
    const qs=await db.collection('nobet_index').where('person','==',person).get();
    const all=qs.docs.map(d=>d.data())
      .filter(x=>String(x.year)===String(year))
      .sort((a,b)=>a.date.localeCompare(b.date));

    if(!all.length){ wrap.innerHTML='<div class="muted">Kayıt bulunamadı.</div>'; return; }

    const haftaiciDays=new Set(['Pazartesi','Salı','Çarşamba','Perşembe','Cuma','Cumartesi']);
    const isEvli = all.some(x=>x.role==='evli' || x.role==='ihvan');

    const haftaici = all.filter(x=>x.type==='24s' && haftaiciDays.has(x.day));
    const pazarG = all.filter(x=>x.day==='Pazar' && x.type==='pazar-gunduz');
    const pazarA = all.filter(x=>x.day==='Pazar' && x.type==='pazar-aksam');

    const mk=(title,rows)=>`
      <h3 style="margin-top:8px">${title}</h3>
      <div class="table-wrap">
        <table class="per-table">
          <thead><tr><th>Gün</th><th>Tarih</th><th>Saat</th><th>Rol</th></tr></thead>
          <tbody>${rows.map(r=>`
            <tr>
              <td>${r.day}</td>
              <td>${fmtTR(r.date)}</td>
              <td class="time">${r.saat||''}</td>
              <td>${r.role}</td>
            </tr>`).join('')}
          </tbody>
        </table>
      </div>`;

    wrap.innerHTML =
      mk('Hafta İçi (Pazartesi–Cumartesi)', haftaici) +
      (isEvli ? mk('Hafta Sonu (Pazar – Gündüz)', pazarG) : mk('Hafta Sonu (Pazar – Akşam)', pazarA));
  }catch(e){ console.error(e); showToast('Hata'); }
}

/* ===== Auth + kullanıcı ===== */
let CAN_VIEW_OTHERS=false;
window.__ME_PERSON__=null;

auth.onAuthStateChanged(async u=>{
  if(!u){ location.replace("../index.html"); return; }
  setToday();

  try{
    const uSnap = await db.collection('kullanicilar').doc(u.uid).get();
    const meta  = uSnap.exists ? uSnap.data() : {};

    // 1) Tema: profil ayarı
    applyProfileTheme(u.uid, meta);

    // 2) Yetkiler -> tabbar
    const raw=Array.isArray(meta.yetkiler) ? meta.yetkiler : [];
    const byPanelLabels={};  // { PanelAdı: ["Sayfa Etiketi", ...] }
    raw.forEach(s=>{
      const str=String(s); const i=str.indexOf(':'); if(i<0) return;
      const panel=str.slice(0,i).trim(); const label=str.slice(i+1).trim();
      if(!ALL_PANELS.includes(panel)) return;
      (byPanelLabels[panel] ||= []).push(label);
    });
    CURRENT_PERMS = byPanelLabels;

    MANIFEST = await loadManifest();
    renderTabbar(Object.keys(byPanelLabels)); // alt tabbarı çiz

    // 3) sayfa içerikleri
    buildControls();

    // kullanıcı eşleşmesi (meName vs.)
    const myPreferred = (meta.adSoyad || u.displayName || (u.email?u.email.split('@')[0]:'')).trim();
    window.__ME_PERSON__ = myPreferred;
    document.getElementById('meName')?.replaceChildren(document.createTextNode(myPreferred));
  }catch(e){
    console.error(e); showToast('Veriler yüklenirken hata.');
  }
});

    /* ===== Pull-to-Refresh & Edge Swipe-Back ===== */
    (function(){
      const area=document.getElementById('scrollArea');
      const tip=document.getElementById('ptrTip');
      // PTR
      const PTR_SHOW=110, PTR_TRIGGER=240;
      let tSY=null,tSX=null,ptrActive=false,maxPull=0;
      area.addEventListener('touchstart',e=>{
        ptrActive=(area.scrollTop<=1);
        tSY=e.touches[0].clientY; tSX=e.touches[0].clientX; maxPull=0;
      },{passive:true});
      area.addEventListener('touchmove',e=>{
        if(!ptrActive) return;
        const dy=e.touches[0].clientY - tSY;
        const dx=e.touches[0].clientX - tSX;
        if(Math.abs(dx)>50){ ptrActive=false; tip.classList.remove('show'); return; }
        if(dy>PTR_SHOW) tip.classList.add('show'); else tip.classList.remove('show');
        if(dy>maxPull) maxPull=dy;
      },{passive:true});
      area.addEventListener('touchend',()=>{
        const shouldRefresh = ptrActive && (maxPull>=PTR_TRIGGER) && (area.scrollTop<=1);
        tip.classList.remove('show'); ptrActive=false; tSY=tSX=null; maxPull=0;
        if(shouldRefresh) location.reload();
      },{passive:true});

      // Edge swipe back
      let sX=0,sY=0,dx=0,tracking=false;
      const EDGE=24, TRIGGER=140, MAXVIS=100, MAXDY=80;
      function setX(x,snap=false){
        area.classList.toggle('snap', snap);
        area.style.transform = `translateX(${Math.max(0, Math.min(x, MAXVIS))}px)`;
      }
      function reset(){ area.classList.remove('snap'); area.style.transform=''; tracking=false; dx=0; }
      area.addEventListener('touchstart',e=>{ sX=e.touches[0].clientX; sY=e.touches[0].clientY; tracking=(sX<=EDGE); dx=0; },{passive:true});
      area.addEventListener('touchmove',e=>{
        if(!tracking) return;
        const t=e.touches[0]; const dy=t.clientY - sY; if(Math.abs(dy)>MAXDY){ reset(); return; }
        dx = t.clientX - sX; if(dx<=0){ setX(0); return; } setX(dx);
      },{passive:true});
      area.addEventListener('touchend',()=>{ if(!tracking) return; if(dx>=TRIGGER){ setX(MAXVIS,true); setTimeout(()=>history.back(),10); } else { setX(0,true); setTimeout(reset,220); } },{passive:true});
      area.addEventListener('touchcancel', reset, {passive:true});
    })();

    /* ====== Tabbar / Manifest ====== */
    const ALL_PANELS = ["Talebe","Personel","Nehari","Kermes","Muhasebe","Ayarlar","Admin"];
    const ICONS = {Talebe:"👨‍🎓",Personel:"👥",Nehari:"📚",Kermes:"🧺",Muhasebe:"📊",Ayarlar:"⚙️",Admin:"🛡️",Home:"🏠"};
    let CURRENT_PERMS = {};   // panel -> [labels]
    let MANIFEST = {};        // panel -> pages

    function normLower(s){ return String(s||'').trim().toLowerCase(); }

    // panel köküne güvenli dönüş (dosya derinliğine göre ../ sayısı)
    function panelHomeHref(){
      const idx = location.pathname.indexOf('/panel/');
      if (idx === -1) return '/panel/panel.html';               // tam yol fallback
      const after = location.pathname.slice(idx + 7);           // '/panel/' sonrası
      const depth = after.split('/').filter(Boolean).length - 1; // aynı klasörde ise 0
      const up = '../'.repeat(Math.max(0, depth));
      return up + 'panel.html';                                 // ../panel.html, ../../panel.html ...
    }

    // …tabbar oluşturan yerde:
    function makeHomeBtn(){
      const a = document.createElement('a');
      a.href = panelHomeHref();           // ARTIK GERÇEK YOL
      a.className = 'tbtn home';
      a.innerHTML = `<div class="ico">🏠</div><div class="lbl">Ana Sayfa</div>`;
      // dikkat: BURADA preventDefault yok!
      return a;
    }

    function makeTabBtn(panel){
      const a=document.createElement('a');
      a.href="#"; a.className='tb'; a.dataset.panel=panel;
      a.innerHTML=`<div class="ico">${ICONS[panel]||'📁'}</div><div class="lbl">${panel}</div>`;
      a.addEventListener('click', e=>{ e.preventDefault(); openSheet(panel); });
      return a;
    }

    function renderTabbar(allowed){
      const rail=document.getElementById('tabRail'); rail.innerHTML='';
      const panels = ALL_PANELS.filter(p=>allowed.includes(p));
      const half = Math.ceil(panels.length/2);
      panels.slice(0,half).forEach(p=> rail.appendChild(makeTabBtn(p)));
      rail.appendChild(makeHomeBtn());
      panels.slice(half).forEach(p=> rail.appendChild(makeTabBtn(p)));
    }

    const sheet=document.getElementById('panelSheet'),
          sheetList=document.getElementById('sheetList'),
          sheetTitle=document.getElementById('sheetTitle'),
          sheetBackdrop=document.getElementById('sheetBackdrop');

    function openSheet(panel){
      sheetTitle.textContent=panel; sheetList.innerHTML='';
      const allowedLabels = CURRENT_PERMS[panel] || [];
      const manifestPages = MANIFEST[panel]    || [];
      const items = manifestPages.filter(p=>{
        const l=allowedLabels.map(x=>x.toLowerCase());
        const key=(p.key||'').toLowerCase();
        const label=(p.label||p.title||'').toLowerCase();
        return l.includes(label) || l.includes(`${panel.toLowerCase()}: ${label}`) || (key && l.includes(key));
      });

      if(!items.length){
        const it=document.createElement('div'); it.className='item'; it.textContent='Bu panel için sayfa tanımlı değil';
        sheetList.appendChild(it);
      }else{
        items.forEach(p=>{
          const it=document.createElement('div'); it.className='item';
          it.innerHTML=`<div>${p.label||p.title}</div><div class="go">›</div>`;
          it.addEventListener('click', ()=>{ if(p.path){ window.location.href = p.path.startsWith('/') ? p.path : '/'+p.path.replace(/^(\.\/|\.\.\/)+/,''); } });
          sheetList.appendChild(it);
        });
      }
      sheet.style.display='block'; sheetBackdrop.style.display='block';
    }
    function closeSheet(){ sheet.style.display='none'; sheetBackdrop.style.display='none'; }
    sheetBackdrop.addEventListener('click', closeSheet);
    let sStartY=null;
    sheet.addEventListener('touchstart',e=>{ sStartY=e.touches[0].clientY },{passive:true});
    sheet.addEventListener('touchmove',e=>{ if(sStartY==null) return; const dy=e.touches[0].clientY - sStartY; if(dy>40){ closeSheet(); sStartY=null; } },{passive:true});

    /* Manifest: sayfa_manifesti/{Panel} -> { pages:[{key,title,path,order}] } */
    async function loadManifest(){
      const out={}; const root=db.collection('sayfa_manifesti'); const panelsSnap=await root.get();
      for(const doc of panelsSnap.docs){
        const panelName=(doc.id||'').trim();
        const d=doc.data()||{}; const pages = Array.isArray(d.pages)? d.pages : [];
        const arr = pages.map(p=>({
          label: (p.title||'').trim() || ((p.key||'').split(':')[1]||'').trim(),
          path:  (p.path||'').trim(),
          key:   (p.key||'').trim(),
          order: Number(p.order||0)
        })).sort((a,b)=>a.order-b.order);
        out[panelName]=arr;
      }
      return out;
    }

</script>
</body>
</html>
