<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bildirim ve G√∂rev</title>
  <link rel="stylesheet" href="../css/stiller.css" />
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background-color: #f4f6f9;
      margin: 0;
    }
    header {
      background-color: #324960;
      color: white;
      padding: 15px 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .header-left {
      font-size: 18px;
      font-weight: bold;
    }
    .header-right button {
      margin-left: 10px;
      background-color: #4a637d;
      border: none;
      color: white;
      padding: 8px 12px;
      border-radius: 4px;
      cursor: pointer;
    }
    .container {
      padding: 30px;
    }
    .kartlar {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
    }
    .kart {
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      transition: 0.3s;
    }
    .kart:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .kart h3 {
      margin-bottom: 10px;
    }
    .kart p {
      font-size: 15px;
      color: #444;
    }
    .kart button {
      margin-top: 10px;
      padding: 8px 14px;
      border: none;
      border-radius: 6px;
      background-color: #2d6a4f;
      color: white;
      cursor: pointer;
    }

    /* Modal */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background-color: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
    }
    .modal-icerik {
      background: white;
      padding: 25px;
      border-radius: 10px;
      width: 100%;
      max-width: 500px;
    }
    .modal input, .modal textarea, .modal select {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    .modal textarea {
      resize: vertical;
    }
    .modal .kapat-btn {
      background-color: #ccc;
      margin-top: 10px;
    }

    .bildirim-item {
      background: #fff;
      padding: 12px 15px;
      margin-top: 10px;
      border-radius: 8px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.08);
    }
  </style>
</head>
<body>

<header>
  <div class="header-left">Karaaƒüa√ß Panel > Bildirim ve G√∂rev</div>
  <div class="header-right">
    <button onclick="window.history.back()">üîô Geri D√∂n</button>
    <button onclick="firebase.auth().signOut()">üö™ √áƒ±kƒ±≈ü Yap</button>
  </div>
</header>

<div class="container">
  <div class="kartlar">
    <div class="kart">
      <h3>üì§ Toplu Bildirim G√∂nder</h3>
      <p>Belirli role veya t√ºm kullanƒ±cƒ±lara bildirim g√∂nder.</p>
      <button onclick="modalAc('toplu')">G√∂nder</button>
    </div>
    <div class="kart">
      <h3>‚úâÔ∏è Ki≈üisel Bildirim / G√∂rev</h3>
      <p>Bir kullanƒ±cƒ±ya √∂zel mesaj veya g√∂rev tanƒ±mlayƒ±n.</p>
      <button onclick="modalAc('kisisel')">G√∂nder</button>
    </div>
    <div class="kart">
      <h3>üìÉ Bildirim Takibi</h3>
      <p>Sisteme g√∂nderilen t√ºm bildirimleri inceleyin.</p>
      <button onclick="bildirimleriListele()">Listele</button>
    </div>
  </div>

  <div id="bildirimListesi"></div>
</div>

<!-- Modal -->
<div class="modal" id="bildirimModal">
  <div class="modal-icerik">
    <h3 id="modalBaslik">Bildirim G√∂nder</h3>
    <input type="text" id="baslik" placeholder="Ba≈ülƒ±k">
    <textarea id="icerik" placeholder="Mesaj i√ßeriƒüi" rows="4"></textarea>

    <div id="kimeToplu">
      <select id="hedefRol">
        <option value="">Rol Se√ßin</option>
        <option value="admin">Admin</option>
        <option value="personel">Personel</option>
        <option value="tum">T√ºm Kullanƒ±cƒ±lar</option>
      </select>
    </div>

    <div id="kimeKisisel" style="display:none;">
      <input type="text" id="hedefUID" placeholder="Kullanƒ±cƒ± UID">
    </div>

    <button onclick="bildirimGonder()">G√∂nder</button>
    <button class="kapat-btn" onclick="modalKapat()">Kapat</button>
  </div>
</div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="../js/firebase/firebase-init.js"></script>

<script>
  const modal = document.getElementById("bildirimModal");
  const hedefRolDiv = document.getElementById("kimeToplu");
  const hedefUIDDiv = document.getElementById("kimeKisisel");
  let aktifTip = "toplu";

  function modalAc(tip) {
    aktifTip = tip;
    document.getElementById("modalBaslik").innerText = tip === "toplu" ? "Toplu Bildirim G√∂nder" : "Ki≈üisel Bildirim G√∂nder";
    hedefRolDiv.style.display = tip === "toplu" ? "block" : "none";
    hedefUIDDiv.style.display = tip === "kisisel" ? "block" : "none";
    modal.style.display = "flex";
  }

  function modalKapat() {
    modal.style.display = "none";
  }

  async function bildirimGonder() {
    const baslik = document.getElementById("baslik").value.trim();
    const icerik = document.getElementById("icerik").value.trim();

    if (!baslik || !icerik) {
      alert("L√ºtfen t√ºm alanlarƒ± doldurun.");
      return;
    }

    const veri = {
      baslik,
      icerik,
      zaman: new Date(),
      tip: aktifTip,
      okunduMu: false
    };

    if (aktifTip === "toplu") {
      const hedefRol = document.getElementById("hedefRol").value;
      if (!hedefRol) return alert("L√ºtfen hedef rol se√ßin.");
      veri.hedefRol = hedefRol;
    } else {
      const hedefUID = document.getElementById("hedefUID").value.trim();
      if (!hedefUID) return alert("UID girin.");
      veri.hedefUID = hedefUID;
    }

    await db.collection("bildirimler").add(veri);
    await db.collection("islem_log").add({
      islem: `Bildirim g√∂nderildi (${aktifTip})`,
      uid: firebase.auth().currentUser.uid,
      zaman: new Date()
    });

    alert("Bildirim ba≈üarƒ±yla g√∂nderildi.");
    modalKapat();
  }

  async function bildirimleriListele() {
    const liste = document.getElementById("bildirimListesi");
    liste.innerHTML = "<h3>üìÉ G√∂nderilen Bildirimler</h3>";

    const snap = await db.collection("bildirimler").orderBy("zaman", "desc").limit(50).get();
    snap.forEach(doc => {
      const d = doc.data();
      const z = d.zaman?.toDate().toLocaleString() || "-";
      const div = document.createElement("div");
      div.className = "bildirim-item";
      div.innerHTML = `
        <b>${d.baslik}</b> (${d.tip})<br/>
        <span>${d.icerik}</span>
        <small><b>Zaman:</b> ${z}</small>
      `;
      liste.appendChild(div);
    });
  }

  firebase.auth().onAuthStateChanged(user => {
    if (!user) location.href = "../index.html";
  });
</script>

</body>
</html>
