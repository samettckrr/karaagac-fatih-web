<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Kullanƒ±cƒ± & Yetki Y√∂netimi</title>
<link rel="icon" type="image/png" href="../img/logo.png" />

<!-- ====== TEMA (panel.html ile aynƒ±) ====== -->
<style>
  :root{
    --appbar-h:56px;
    --radius:14px; --shadow:0 12px 28px rgba(0,0,0,.14);
    --bg:#0f172a; --bg2:#0b1324;
    --grad1:#0ea5e922; --grad2:#22d3ee22;
    --card:rgba(15,23,42,.92); --stroke:rgba(148,163,184,.18);
    --text:#e5e7eb; --muted:#9aa4b2;
    --brand:#38bdf8; --brand2:#0ea5e9;
    --pill:#0b1220; --pill-hover:#101a2b;
    --link:#c7e9ff; --surface:rgba(2,6,23,.08);
  }
  @media (prefers-color-scheme: light){
    :root{
      --bg:#eef6ff; --bg2:#f7fbff;
      --card:rgba(255,255,255,.95); --stroke:rgba(15,23,42,.12);
      --text:#0b1220; --muted:#4b5563; --brand:#0ea5e9; --brand2:#0284c7;
      --pill:#f5f8ff; --pill-hover:#e9f2ff; --link:#0b5ea8; --surface:#eef3ff;
    }
  }
  html[data-theme="dark"]{ --bg:#0f172a; --bg2:#0b1324; --card:rgba(15,23,42,.92); --stroke:rgba(148,163,184,.18); --text:#e5e7eb; --muted:#9aa4b2; --brand:#38bdf8; --brand2:#0ea5e9; --pill:#0b1220; --pill-hover:#101a2b; --link:#c7e9ff; --surface:rgba(2,6,23,.08); }
  html[data-theme="light"]{ --bg:#eef6ff; --bg2:#f7fbff; --card:rgba(255,255,255,.95); --stroke:rgba(15,23,42,.12); --text:#0b1220; --muted:#4b5563; --brand:#0ea5e9; --brand2:#0284c7; --pill:#f5f8ff; --pill-hover:#e9f2ff; --link:#0b5ea8; --surface:#eef3ff; }

  *{box-sizing:border-box}
  body{
    margin:0; color:var(--text);
    font-family:ui-sans-serif,-apple-system,"Segoe UI",Roboto,Arial;
    background:
      radial-gradient(900px 680px at 12% 8%, var(--grad1), transparent 45%),
      radial-gradient(800px 640px at 88% 92%, var(--grad2), transparent 50%),
      linear-gradient(140deg, var(--bg), var(--bg2) 60%);
    overflow-x:hidden;
  }
  a{color:var(--link); text-decoration:none}
  a:hover{text-decoration:underline}

  /* APPBAR */
  .appbar{position:sticky; top:0; z-index:60; height:var(--appbar-h); background:var(--card); backdrop-filter:blur(10px); border-bottom:1px solid var(--stroke); display:flex; align-items:center; gap:12px; padding:0 12px}
  .brand{display:flex; align-items:center; gap:10px; cursor:pointer}
  .brand img{width:24px; height:24px}
  .brand span{font-weight:900; letter-spacing:.02em}
  .nav-center{margin:0 auto; height:100%}
  .nav-list{display:flex; gap:22px; align-items:center; height:100%; list-style:none; margin:0; padding:0}
  .nav-item{position:relative; height:100%}
  .nav-btn{height:100%; display:flex; align-items:center; gap:6px; font-weight:600; cursor:pointer}
  .nav-btn:hover{color:var(--brand)}
  .caret{font-size:12px; opacity:.6}
  .dropdown{position:absolute; top:100%; left:0; min-width:240px; background:var(--card); border:1px solid var(--stroke); border-radius:10px; box-shadow:var(--shadow); padding:8px; display:none}
  .dropdown a{display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:8px}
  .dropdown a:hover{background:var(--surface)}
  .nav-item.open .dropdown{display:block}
  .nav-right{display:flex; gap:8px; align-items:center}
  .btn{border:1px solid var(--stroke); background:var(--card); color:var(--text); border-radius:999px; padding:8px 12px; cursor:pointer}
  .hamb{display:none}
  @media (max-width:1024px){ .nav-center{display:none} .hamb{display:inline-flex} }

  /* DRAWER */
  .drawer{position:fixed; top:var(--appbar-h); right:0; bottom:0; left:30%; transform:translateX(100%); transition:transform .25s ease; background:var(--card); border-left:1px solid var(--stroke); z-index:70; overflow:auto; -webkit-overflow-scrolling:touch; padding:12px}
  .drawer.open{transform:translateX(0)}
  .drawer .panel-title{margin:14px 4px 6px; font-weight:800; color:var(--muted); font-size:13px}
  .drawer a{display:block; padding:10px; border-radius:10px; border:1px solid var(--stroke); margin:6px 0; background:var(--pill)}
  .drawer a:hover{background:var(--pill-hover)}

  /* LAYOUT */
  .container{max-width:1200px; margin:0 auto; padding:16px}
  .grid{display:grid; gap:14px; grid-template-columns:repeat(12, minmax(0,1fr))}
  .col-8{grid-column:span 8}
  .col-4{grid-column:span 4}
  @media (max-width:980px){ .col-8,.col-4{grid-column:span 12} }

  .card{background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px}
  .card h3{margin:0 0 10px; font-size:16px}
  .mini{display:flex; gap:8px; flex-wrap:wrap}
  .pill{padding:6px 10px; border-radius:999px; border:1px solid var(--stroke); background:var(--pill); font-size:12px}

  /* FORM */
  label{font-weight:700; display:block; margin:10px 0 6px}
  input,select,textarea{width:100%; padding:11px 12px; border:1px solid var(--stroke); border-radius:12px; background:transparent; color:var(--text); outline:none}
  input:focus,select:focus,textarea:focus{box-shadow:0 0 0 4px rgba(56,189,248,.18); border-color:var(--brand)}
  .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  @media(max-width:900px){.row{grid-template-columns:1fr}}

  /* PERM TREE */
  .perm-group{border:1px dashed var(--stroke); border-radius:12px; padding:12px; margin:12px 0; background:var(--surface)}
  .perm-head{display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:8px}
  .perm-grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:8px}
  .perm-item{display:flex; align-items:center; gap:8px; background:var(--pill); border:1px solid var(--stroke); border-radius:999px; padding:8px 10px}
  .perm-item input{width:18px;height:18px}

  /* TABLE & CARDS */
  .table{width:100%; border-collapse:collapse}
  .table th,.table td{border-bottom:1px solid var(--stroke); padding:10px 8px; text-align:left; vertical-align:middle}
  .gridcards{display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:12px}
  .ucard{background:var(--card); border:1px solid var(--stroke); border-radius:12px; padding:12px}

  /* MODAL */
  .modal-back{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center;z-index:120;backdrop-filter:blur(2px)}
  .modal{width:min(900px,96vw);max-height:92vh;background:var(--card);border:1px solid var(--stroke);border-radius:16px;box-shadow:var(--shadow);display:flex;flex-direction:column;overflow:hidden}
  .modal .hd{padding:12px 14px;border-bottom:1px solid var(--stroke);font-weight:800}
  .modal .bd{padding:14px;overflow:auto;-webkit-overflow-scrolling:touch}
  .modal .ft{padding:12px 14px;border-top:1px solid var(--stroke);display:flex;gap:8px;justify-content:flex-end}
  @media(max-width:700px){ .modal{width:100vw;height:100dvh;max-height:100dvh;border-radius:0} }

  /* RIGHT SUMMARY */
  .summary{position:sticky; top:calc(var(--appbar-h) + 14px)}

  /* TOAST */
  .toast{position:fixed; left:50%; bottom:24px; transform:translateX(-50%) translateY(20px); background:rgba(2,6,23,.95); color:#fff; border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:10px 12px; opacity:0; pointer-events:none; transition:opacity .25s, transform .25s; z-index:200}
  .toast.show{opacity:1; transform:translateX(-50%) translateY(0)}
</style>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="../js/firebase/firebase-init.js"></script>
</head>
<body>

<!-- ====== APPBAR ====== -->
<div class="appbar">
  <div class="brand" onclick="location.href='../panel.html'">
    <img src="../img/logo.png" alt="logo"><span>KARAAƒûA√á FATƒ∞H</span>
  </div>
  <nav class="nav-center"><ul class="nav-list" id="navMain"></ul></nav>
  <div class="nav-right">
    <button class="btn hamb" id="hamburger" title="Men√º">‚ò∞</button>
    <button class="btn" id="themeToggle" title="Tema: A√ßƒ±k/Koyu/Otomatik">üåó <span id="themeLabel">Auto</span></button>
    <button class="btn" id="btnLogout">√áƒ±kƒ±≈ü Yap</button>
  </div>
</div>
<aside class="drawer" id="drawer"></aside>

<!-- ====== CONTENT ====== -->
<main class="container">
  <div class="grid">
    <!-- SOL -->
    <section class="col-8">
      <div class="card">
        <div class="mini" style="gap:6px">
          <button class="btn" id="tabAdd">Kullanƒ±cƒ± Ekle</button>
          <button class="btn" id="tabMan">Yetki (Manifest)</button>
          <button class="btn" id="tabList">Kullanƒ±cƒ±lar</button>
          <span class="pill">üë§ <b id="meMail">‚Äî</b></span>
        </div>
      </div>

      <!-- EKLE -->
      <section id="viewAdd" class="card">
        <h3>Kullanƒ±cƒ± Ekle</h3>
        <form id="frmAdd" style="margin-top:8px">
          <div class="row">
            <div><label>Ad Soyad</label><input id="adSoyad" required></div>
            <div>
              <label>Rol</label>
              <select id="rol" required>
                <option value="" disabled selected>Se√ßiniz</option>
                <option>admin</option><option>personel</option><option>ziyaret</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div><label>G√∂rev</label><input id="gorev" required></div>
            <div>
              <label>E-posta</label>
              <input id="email" type="email" required>
              <div id="emailHint" style="margin-top:6px;font-size:12px;color:var(--muted)">‚Äî</div>
            </div>
          </div>
          <div class="row">
            <div>
              <label>Ge√ßici ≈ûifre</label>
              <div class="mini" style="align-items:center">
                <input id="sifre" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style="flex:1">
                <button type="button" class="btn" id="togglePw">üëÅ</button>
                <button type="button" class="btn" id="btnPwGen">Rastgele</button>
                <label class="mini" style="align-items:center"><input type="checkbox" id="chkEmailNotify" checked> <span style="font-size:12px;color:var(--muted)">E-posta bildir</span></label>
              </div>
              <div style="margin-top:8px;height:8px;background:var(--surface);border-radius:6px;overflow:hidden"><span id="meterBar" style="display:block;height:100%;width:0%"></span></div>
              <div id="pwLabel" style="margin-top:6px;font-size:12px;color:var(--muted)">G√º√ß: ‚Äî</div>
            </div>
            <div class="mini" style="align-items:center"><span class="pill">Kayƒ±ttan sonra ≈üifre sƒ±fƒ±rlama e-postasƒ± gider.</span></div>
          </div>

          <label style="margin-top:8px">Yetkiler</label>
          <div id="permTreeAdd"><div class="pill">Manifest bo≈üsa ‚ÄúYetki (Manifest)‚Äù sekmesinden ekleyin.</div></div>

          <div class="mini" style="margin-top:12px">
            <button type="button" class="btn" id="btnPreview">√ñnizle</button>
            <button class="btn" id="btnSubmit">Kaydet</button>
          </div>
        </form>
      </section>

      <!-- MANIFEST -->
      <section id="viewMan" class="card" style="display:none">
        <h3>Yetki (Manifest)</h3>
        <form id="frmPanel" style="margin-top:8px">
          <div class="row">
            <div><label>Panel Anahtar</label><input id="p_key" placeholder="Talebe" required></div>
            <div><label>Panel Ba≈ülƒ±k</label><input id="p_title" placeholder="Talebe Paneli" required></div>
          </div>
          <div class="row">
            <div><label>Sƒ±ra</label><input id="p_order" type="number" value="1"></div>
            <div class="mini" style="align-items:end">
              <button class="btn" id="btnPanelSave">Kaydet/G√ºncelle</button>
              <button type="button" class="btn" id="btnQuickPanels">Hƒ±zlƒ± Panel Seti</button>
            </div>
          </div>
        </form>

        <div style="height:12px"></div>
        <form id="frmPage">
          <div class="row">
            <div><label>Panel Se√ß</label><select id="s_panel" required></select></div>
            <div><label>Sayfa Ba≈ülƒ±k</label><input id="s_title" required></div>
          </div>
          <div class="row">
            <div><label>Path</label><input id="s_path" placeholder="talebe/talebe-liste.html" required></div>
            <div><label>Sƒ±ra</label><input id="s_order" type="number" value="1"></div>
          </div>
          <div class="mini"><button class="btn" id="btnPageAdd">Ekle</button></div>
        </form>

        <div style="height:12px"></div>
        <div class="card" style="padding:12px">
          <h3>Mevcut Manifest</h3>
          <div id="manifestList" style="margin-top:6px"><div class="pill">Panel ve sayfalar burada listelenir.</div></div>
        </div>
      </section>

      <!-- Lƒ∞STE -->
      <section id="viewList" class="card" style="display:none">
        <h3 style="display:flex;justify-content:space-between;align-items:center"><span>Kullanƒ±cƒ±lar</span><span class="mini"><button class="btn" id="btnTable">Tablo</button><button class="btn" id="btnCards">Kart</button></span></h3>
        <div class="mini" style="margin-bottom:10px;flex-wrap:wrap">
          <input id="sch" placeholder="Ara (ad, e-posta, g√∂rev)" style="min-width:220px">
          <select id="fltRol"><option value="">Rol (t√ºm√º)</option><option>admin</option><option>personel</option><option>ziyaret</option></select>
          <select id="fltDurum"><option value="">Durum (t√ºm√º)</option><option value="true">Aktif</option><option value="false">Pasif</option></select>
          <button class="btn" id="btnRef">Yenile</button>
        </div>

        <div id="usersTableWrap" style="overflow:auto">
          <table class="table">
            <thead><tr><th>Ad Soyad</th><th>E-posta</th><th>Rol</th><th>G√∂rev</th><th>Durum</th><th>Yetki</th><th>Eklenme</th><th>ƒ∞≈ülem</th></tr></thead>
            <tbody id="rowsUsers"><tr><td colspan="8" class="pill">Veri bekleniyor‚Ä¶</td></tr></tbody>
          </table>
        </div>
        <div id="usersCardsWrap" class="gridcards" style="display:none"></div>
      </section>
    </section>

    <!-- SAƒû -->
    <aside class="col-4">
      <div class="card summary">
        <h3>√ñzet</h3>
        <div class="mini" style="flex-direction:column; gap:10px; margin-top:8px">
          <div class="kpi"><div><div class="val" id="kpiUsers">‚Äî</div><div class="sub">Toplam Kullanƒ±cƒ±</div></div><div>üë•</div></div>
          <div class="kpi"><div><div class="val" id="kpiActive">‚Äî</div><div class="sub">Aktif</div></div><div>‚úÖ</div></div>
          <div class="kpi"><div><div class="val" id="kpiPassive">‚Äî</div><div class="sub">Pasif</div></div><div>‚õî</div></div>
          <div class="kpi"><div><div class="val" id="kpiPanels">‚Äî</div><div class="sub">Panel</div></div><div>üì¶</div></div>
          <div class="kpi"><div><div class="val" id="kpiPages">‚Äî</div><div class="sub">Sayfa</div></div><div>üß©</div></div>
        </div>
      </div>
    </aside>
  </div>
</main>

<div class="toast" id="toast"></div>

<!-- √ñNƒ∞ZLEME MODAL -->
<div class="modal-back" id="mPrev">
  <div class="modal">
    <div class="hd">Kayƒ±t √ñnizleme</div>
    <div class="bd" id="prevContent"></div>
    <div class="ft"><button class="btn" id="btnPrevClose">Vazge√ß</button><button class="btn" id="btnPrevOk">Onayla & Kaydet</button></div>
  </div>
</div>

<!-- D√úZENLE MODAL -->
<div class="modal-back" id="mEdit">
  <div class="modal">
    <div class="hd">Kullanƒ±cƒ± D√ºzenle</div>
    <div class="bd">
      <form id="frmEdit">
        <input type="hidden" id="e_uid">
        <div class="row"><div><label>Ad Soyad</label><input id="e_ad"></div><div><label>Rol</label><select id="e_rol"><option>admin</option><option>personel</option><option>ziyaret</option></select></div></div>
        <div class="row"><div><label>G√∂rev</label><input id="e_gorev"></div><div><label>E-posta</label><input id="e_mail" type="email" disabled></div></div>
        <label style="margin-top:10px">Yetkiler</label>
        <div id="permTreeEdit"></div>
        <div class="row"><div><label><input type="checkbox" id="e_aktif"> Aktif</label></div></div>
      </form>
    </div>
    <div class="ft"><button class="btn" id="btnEditClose">Kapat</button><button class="btn" id="btnEditSave">Kaydet</button></div>
  </div>
</div>

<!-- ====== JS ====== -->
<script>
/* ===== Tema ===== */
(function(){
  const root=document.documentElement, btn=document.getElementById('themeToggle');
  const sysDark=()=>window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches;
  function apply(mode){
    localStorage.setItem('kf_theme',mode);
    const eff=(mode==='auto')?(sysDark()?'dark':'light'):mode;
    root.setAttribute('data-theme',eff);
    const txt=mode[0].toUpperCase()+mode.slice(1);
    btn.innerHTML=(mode==='dark'?'üåô':mode==='light'?'‚òÄÔ∏è':'üåó')+' <span id="themeLabel">'+txt+'</span>';
  }
  apply(localStorage.getItem('kf_theme')||'auto');
  btn.addEventListener('click',()=>{const cur=localStorage.getItem('kf_theme')||'auto'; apply(cur==='dark'?'light':(cur==='light'?'auto':'dark'));});
  if(window.matchMedia){ const m=window.matchMedia('(prefers-color-scheme: dark)'); m.addEventListener?.('change',()=>{ if((localStorage.getItem('kf_theme')||'auto')==='auto') apply('auto'); }); }
})();

/* ===== Shortcuts ===== */
const db=firebase.firestore(), auth=firebase.auth();
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
function toast(msg){const t=$("#toast"); t.textContent=msg; t.classList.add('show'); clearTimeout(window.__to); window.__to=setTimeout(()=>t.classList.remove('show'),2200);}

/* ===== Appbar actions ===== */
$("#btnLogout").onclick=()=>auth.signOut().then(()=>location.href='../index.html');

/* ===== Nav (manifest path i aynen kullan) ===== */
let CURRENT_ALLOW=new Set(), CURRENT_DENY=new Set();
const PANEL_ICON={'Admin':'üéõÔ∏è','Talebe':'üìò','Personel':'üë§','Muhasebe':'üí∞','Kermes':'üè™','Nehari':'üïå','Sistem Ayarlarƒ±':'‚öôÔ∏è'};
const norm = s => String(s||'').trim().toLowerCase();

async function fetchPanels(allowSet, denySet){
  const out=[];
  try{
    const snap=await db.collection('sayfa_manifesti').get();
    snap.forEach(doc=>{
      const d=doc.data()||{}, id=doc.id;
      const title=d.title||id;
      const panelGrant = allowSet.has(norm(id)) || allowSet.has(norm(title));
      let pages = Array.isArray(d.pages) ? d.pages : [];
      pages = pages.filter(pg=>{
        const keyNorm = norm(pg.key || pg.title || '');
        const pageGrant = allowSet.has(keyNorm);
        const denied    = denySet.has(keyNorm);
        return !denied && (panelGrant || pageGrant);
      }).map(pg=>({
        title: pg.title || pg.key || 'Sayfa',
        url:   pg.path  || '#',
        key:   pg.key   || pg.title || '',
        order: typeof pg.order==='number'? pg.order : 9999
      })).sort((a,b)=>a.order-b.order);
      if(!pages.length) return;
      out.push({id, title, order: typeof d.order==='number'? d.order : 9999, pages});
    });
    out.sort((a,b)=>a.order-b.order);
  }catch(e){ console.error(e); toast('Men√º y√ºklenemedi'); }
  return out;
}
function renderNav(panels){
  const ul=$("#navMain"), drawer=$("#drawer");
  ul.innerHTML=''; drawer.innerHTML='';
  if(!panels.length){
    ul.innerHTML='<li class="nav-item"><div class="nav-btn">Hi√ß panel yok</div></li>';
    drawer.innerHTML='<div style="color:var(--muted);padding:8px">Hi√ß panel yok</div>';
    return;
  }
  panels.forEach(p=>{
    const li=document.createElement('li'); li.className='nav-item';
    li.innerHTML=`<div class="nav-btn">${p.title} <span class="caret">‚ñæ</span></div>`;
    const dd=document.createElement('div'); dd.className='dropdown';
    (p.pages||[]).forEach(pg=>{
      const a=document.createElement('a');
      a.href=pg.url; a.textContent=pg.title;
      a.dataset.key=pg.key||pg.title; a.dataset.panel=p.id; a.dataset.panelTitle=p.title;
      dd.appendChild(a);
    });
    li.appendChild(dd);
    li.querySelector('.nav-btn').addEventListener('click',(e)=>{
      e.stopPropagation();
      ul.querySelectorAll('.nav-item').forEach(x=>{ if(x!==li) x.classList.remove('open'); });
      li.classList.toggle('open');
    });
    ul.appendChild(li);
  });
  panels.forEach(p=>{
    const h=document.createElement('div'); h.className='panel-title'; h.textContent=p.title; drawer.appendChild(h);
    (p.pages||[]).forEach(pg=>{
      const a=document.createElement('a'); a.href=pg.url; a.textContent=pg.title;
      a.dataset.key=pg.key||pg.title; a.dataset.panel=p.id; a.dataset.panelTitle=p.title;
      drawer.appendChild(a);
    });
  });
}
document.addEventListener('click', (e) => {
  const a = e.target.closest('a[data-key]'); if (!a) return;
  const key = norm(a.dataset.key), pnl = norm(a.dataset.panel||''), pnlTitle=norm(a.dataset.panelTitle||'');
  if (CURRENT_DENY.has(key)) { e.preventDefault(); toast('Bu sayfa i√ßin yetkiniz yok.'); return; }
  const allowed = CURRENT_ALLOW.has(key) || CURRENT_ALLOW.has(pnl) || CURRENT_ALLOW.has(pnlTitle);
  if (!allowed) { e.preventDefault(); toast('Bu sayfa i√ßin yetkiniz yok.'); }
});
(function(){ const hamb=$("#hamburger"), drawer=$("#drawer"); if(!hamb) return; hamb.addEventListener('click',()=>drawer.classList.toggle('open')); document.addEventListener('click',(e)=>{ if(!drawer.contains(e.target) && !hamb.contains(e.target)) drawer.classList.remove('open'); }); })();

/* ===== Tabs ===== */
$("#tabAdd").onclick=()=>{ $("#viewAdd").style.display="block"; $("#viewMan").style.display="none"; $("#viewList").style.display="none"; };
$("#tabMan").onclick=()=>{ $("#viewAdd").style.display="none"; $("#viewMan").style.display="block"; $("#viewList").style.display="none"; };
$("#tabList").onclick=()=>{ $("#viewAdd").style.display="none"; $("#viewMan").style.display="none"; $("#viewList").style.display="block"; };

/* ===== Manifest & Permission Trees ===== */
let manifest={};

function renderPermTree(targetSel, selected=[]){
  const wrap=document.createElement("div");
  const selectedSet=new Set((selected||[]).map(s=>String(s).trim()));
  Object.keys(manifest).sort((a,b)=>(manifest[a].order||0)-(manifest[b].order||0)).forEach(panelKey=>{
    const grp=document.createElement("div"); grp.className="perm-group"; grp.dataset.group=panelKey;
    grp.innerHTML=`
      <div class="perm-head">
        <div><b>${manifest[panelKey].title}</b> <span class="pill">${panelKey}</span></div>
        <span class="mini">
          <button type="button" class="btn" data-gsel="${panelKey}">Hepsi</button>
          <button type="button" class="btn" data-gclr="${panelKey}">Temizle</button>
        </span>
      </div>
      <div class="perm-grid">
        ${(manifest[panelKey].pages||[]).map(p=>{
          const val=p.key || `${panelKey}: ${p.title}`;
          const chk=selectedSet.has(val)?'checked':'';
          return `<label class="perm-item"><input type="checkbox" value="${val}" ${chk}> <span>${p.title}</span></label>`;
        }).join('')}
      </div>`;
    wrap.appendChild(grp);
  });
  const target=$(targetSel); target.innerHTML=''; target.appendChild(wrap);

  // Grup butonlarƒ±
  target.querySelectorAll("[data-gsel]").forEach(btn=>{
    btn.onclick=()=>{ const g=btn.dataset.gsel; target.querySelectorAll(`.perm-group[data-group="${g}"] input`).forEach(c=>c.checked=true); };
  });
  target.querySelectorAll("[data-gclr]").forEach(btn=>{
    btn.onclick=()=>{ const g=btn.dataset.gclr; target.querySelectorAll(`.perm-group[data-group="${g}"] input`).forEach(c=>c.checked=false); };
  });
}
const getChecked = root => Array.from(document.querySelectorAll(`${root} input[type=checkbox]:checked`)).map(i=>i.value);

function fillPanelSelect(){
  const sel=$("#s_panel"); const keys=Object.keys(manifest).sort((a,b)=> (manifest[a].order||0)-(manifest[b].order||0));
  sel.innerHTML = keys.map(k=>`<option value="${k}">${manifest[k].title} (${k})</option>`).join('');
}
function renderManifestAdmin(){
  const box=$("#manifestList");
  if(!Object.keys(manifest).length){ box.innerHTML='<div class="pill">Hen√ºz panel yok.</div>'; return; }
  box.innerHTML="";
  Object.keys(manifest).sort((a,b)=> (manifest[a].order||0)-(manifest[b].order||0)).forEach(k=>{
    const p=manifest[k]; const it=document.createElement("div"); it.className="perm-group";
    it.innerHTML=`<div class="perm-head"><div><b>${p.title}</b> <span class="pill">${k}</span></div><button class="btn" data-del-panel="${k}">Paneli Sil</button></div>
      ${(p.pages||[]).map(pg=>`
        <div class="mini" style="justify-content:space-between;border:1px solid var(--stroke);border-radius:10px;padding:8px;background:var(--surface);margin-bottom:6px">
          <div><b>${pg.title}</b> <span class="pill" style="margin-left:6px">${pg.path||''}</span></div>
          <span class="mini">
            <button class="btn" data-edit-page='${JSON.stringify({panel:k,key:pg.key||`${k}: ${pg.title}`}).replace(/'/g,"&apos;")}'>D√ºzenle</button>
            <button class="btn" data-del-page='${JSON.stringify({panel:k,key:pg.key||`${k}: ${pg.title}`}).replace(/'/g,"&apos;")}'>Sil</button>
          </span>
        </div>`).join('') || '<div class="pill">Sayfa yok.</div>'}`;
    box.appendChild(it);
  });

  box.querySelectorAll("[data-del-panel]").forEach(b=>{
    b.onclick=async()=>{ if(!confirm("Panel silinsin mi?")) return; await db.collection("sayfa_manifesti").doc(b.dataset.delPanel).delete(); toast("Panel silindi"); };
  });
  box.querySelectorAll("[data-del-page]").forEach(b=>{
    b.onclick=async()=>{ const d=JSON.parse(b.dataset.delPage);
      const ref=db.collection("sayfa_manifesti").doc(d.panel); const doc=await ref.get(); if(!doc.exists) return;
      const v=doc.data(); const arr=(v.pages||[]).filter(x=>(x.key||`${d.panel}: ${x.title}`)!==d.key);
      await ref.update({pages:arr}); toast("Sayfa silindi");
    };
  });
  box.querySelectorAll("[data-edit-page]").forEach(b=>{
    b.onclick=async()=>{ const d=JSON.parse(b.dataset.editPage);
      $("#s_panel").value=d.panel;
      const doc=await db.collection("sayfa_manifesti").doc(d.panel).get(); if(!doc.exists) return;
      const pg=(doc.data().pages||[]).find(x=>(x.key||`${d.panel}: ${x.title}`)===d.key);
      if(pg){ $("#s_title").value=pg.title||""; $("#s_path").value=pg.path||""; $("#s_order").value=pg.order||0; }
      toast("Alanlar dolduruldu");
    };
  });
}

/* ===== Manifest actions ===== */
$("#btnPanelSave").onclick=async(e)=>{
  e.preventDefault();
  const key=$("#p_key").value.trim(), title=$("#p_title").value.trim(), order=parseInt($("#p_order").value||"0");
  if(!key||!title){ toast("Panel anahtar/ba≈ülƒ±k gerekli"); return; }
  await db.collection("sayfa_manifesti").doc(key).set({title,order}, {merge:true});
  $("#frmPanel").reset(); toast("Panel kaydedildi");
};
$("#btnQuickPanels").onclick=async()=>{
  if(!confirm("Standart paneller eklensin mi?")) return;
  const panels=[{key:"Admin",title:"Admin Paneli",order:5},{key:"Talebe",title:"Talebe Paneli",order:10},{key:"Personel",title:"Personel Paneli",order:20},{key:"Nehari",title:"Nehari Paneli",order:30},{key:"Kermes",title:"Kermes Paneli",order:40},{key:"Muhasebe",title:"Muhasebe Paneli",order:50},{key:"Sistem Ayarlarƒ±",title:"Sistem Ayarlarƒ±",order:60},];
  const batch=db.batch(); panels.forEach(p=> batch.set(db.collection("sayfa_manifesti").doc(p.key), {title:p.title, order:p.order}, {merge:true}));
  await batch.commit(); toast("Paneller eklendi");
};
$("#btnPageAdd").onclick=async(e)=>{
  e.preventDefault();
  const panel=$("#s_panel").value, title=$("#s_title").value.trim(), path=$("#s_path").value.trim(), order=parseInt($("#s_order").value||"9999");
  if(!panel||!title||!path){ toast("Panel, ba≈ülƒ±k ve path zorunlu"); return; }
  const ref=db.collection("sayfa_manifesti").doc(panel); const snap=await ref.get();
  const cur=snap.exists? (snap.data()||{}):{pages:[]};
  const key=`${panel}: ${title}`;
  const map=new Map((cur.pages||[]).map(p=>[(p.key||`${panel}: ${p.title}`), p]));
  map.set(key,{key,title,path,order});
  const merged=[...map.values()].sort((a,b)=>(a.order||0)-(b.order||0) || String(a.title).localeCompare(String(b.title),"tr"));
  await ref.set({pages:merged},{merge:true});
  $("#frmPage").reset(); fillPanelSelect(); toast("Sayfa eklendi");
};

/* ===== Password meter ===== */
const pw=$("#sifre"), meterBar=$("#meterBar"), pwLabel=$("#pwLabel");
function scorePw(p){ let s=0; if(p.length>=8) s++; if(/[A-Z]/.test(p)) s++; if(/[0-9]/.test(p)) s++; if(/[^A-Za-z0-9]/.test(p)) s++; return s; }
function renderMeter(){ const s=scorePw(pw.value); let w=0,c="#ef4444",t="Zayƒ±f"; if(s<=1){w=25}else if(s<=3){w=60;c="#f59e0b";t="ƒ∞yi"} else {w=100;c="#22c55e";t="G√º√ßl√º"} meterBar.style.width=w+"%"; meterBar.style.background=c; pwLabel.textContent="G√º√ß: "+t; }
pw.addEventListener("input",renderMeter); renderMeter();
$("#togglePw").onclick=()=>{ pw.type = pw.type==="password" ? "text" : "password"; };
$("#btnPwGen").onclick=()=>{ const chars="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()_+"; const rnd=(len)=>Array.from(crypto.getRandomValues(new Uint32Array(len))).map(n=>chars[n%chars.length]).join(""); pw.value=rnd(12); renderMeter(); toast("Rastgele ≈üifre olu≈üturuldu"); };
$("#email").addEventListener("input",()=>{ const v=$("#email").value.trim(); $("#emailHint").textContent = v? (/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(v) ? "‚úîÔ∏è ge√ßerli g√∂r√ºn√ºyor" : "‚ö†Ô∏è ge√ßersiz e-posta") : "‚Äî"; });

/* ===== √ñnizleme & Ekle ===== */
const mPrev=$("#mPrev");
$("#btnPreview").onclick=()=>{ const yetkiler=getChecked("#permTreeAdd");
  $("#prevContent").innerHTML=`<div class="mini" style="flex-direction:column;gap:6px">
    <div><b>Ad Soyad:</b> ${$("#adSoyad").value||"-"}</div>
    <div><b>Rol:</b> ${$("#rol").value||"-"}</div>
    <div><b>G√∂rev:</b> ${$("#gorev").value||"-"}</div>
    <div><b>E-posta:</b> ${$("#email").value||"-"}</div>
    <div><b>Yetkiler:</b> ${yetkiler.length? yetkiler.join(", "):"‚Äî"}</div>
  </div>`;
  mPrev.style.display='flex';
};
$("#btnPrevClose").onclick=()=> mPrev.style.display='none';
$("#frmAdd").addEventListener("submit",(e)=>{ e.preventDefault(); $("#btnPreview").click(); });

async function createUserSecondary(email,password){
  const cfg=firebase.app().options;
  let sec=firebase.apps.find(a=>a.name==="Secondary");
  if(!sec) sec=firebase.initializeApp(cfg,"Secondary");
  const secAuth=sec.auth();
  const cred=await secAuth.createUserWithEmailAndPassword(email,password);
  try{ await secAuth.sendPasswordResetEmail(email); }catch(e){}
  try{ await sec.delete(); }catch(e){}
  return cred;
}
$("#btnPrevOk").onclick=async()=>{
  mPrev.style.display='none';
  const adSoyad=$("#adSoyad").value.trim(), email=$("#email").value.trim(), sifre=$("#sifre").value, rol=$("#rol").value, gorev=$("#gorev").value.trim();
  const yetkiler=getChecked("#permTreeAdd");
  if(!adSoyad||!email||!sifre||!rol||!gorev){ toast("Zorunlu alanlar bo≈ü"); return; }
  try{
    const cred=await createUserSecondary(email,sifre); const uid=cred.user.uid;
    await db.collection("kullanicilar").doc(uid).set({
      adSoyad,email,rol,gorev,yetkiler,aktif:true,
      eklenmeTarihi: firebase.firestore.FieldValue.serverTimestamp()
    },{merge:true});
    $("#frmAdd").reset(); renderMeter(); renderPermTree("#permTreeAdd");
    toast("Kullanƒ±cƒ± eklendi");
  }catch(err){ toast("Hata: "+(err?.message||err)); }
};

/* ===== Kullanƒ±cƒ±lar ===== */
let USERS=[]; let unsubUsers=null;
function normalizeYetkiler(v){ if(Array.isArray(v)) return v.map(s=>String(s).trim()).filter(Boolean); if(typeof v==='string') return v.split(/[,\n;]+/).map(s=>s.trim()).filter(Boolean); return []; }

function listenUsers(){
  if(unsubUsers) unsubUsers();
  unsubUsers = db.collection("kullanicilar").orderBy("eklenmeTarihi","desc").onSnapshot(snap=>{
    USERS = snap.docs.map(d=>({uid:d.id, ...d.data()}));
    renderKPIs(); renderUsers();
  });
}
function renderKPIs(){
  const total=USERS.length, active=USERS.filter(u=>u.aktif!==false).length, passive=total-active;
  $("#kpiUsers").textContent=total; $("#kpiActive").textContent=active; $("#kpiPassive").textContent=passive;
  $("#kpiPanels").textContent=Object.keys(manifest).length;
  $("#kpiPages").textContent=Object.values(manifest).reduce((s,p)=>s+(p.pages?.length||0),0);
}
$("#btnTable").onclick=()=>{ $("#usersCardsWrap").style.display="none"; $("#usersTableWrap").style.display="block"; };
$("#btnCards").onclick=()=>{ $("#usersCardsWrap").style.display="grid"; $("#usersTableWrap").style.display="none"; };
$("#sch").oninput=renderUsers; $("#fltRol").onchange=renderUsers; $("#fltDurum").onchange=renderUsers; $("#btnRef").onclick=renderUsers;

function bindListButtons(scope){
  scope.querySelectorAll("[data-edit]").forEach(b=> b.onclick=()=> openEdit(b.dataset.edit));
  scope.querySelectorAll("[data-reset]").forEach(b=> b.onclick=()=> resetPass(b.dataset.reset));
  scope.querySelectorAll("[data-toggle]").forEach(b=> b.onclick=()=> toggleActive(JSON.parse(b.dataset.toggle)));
  scope.querySelectorAll("[data-softdel]").forEach(b=> b.onclick=()=> softDelete(b.dataset.softdel));
}
function renderUsers(){
  const q=$("#sch").value.toLowerCase().trim(), fr=$("#fltRol").value, fd=$("#fltDurum").value;
  let list=USERS.slice();
  if(q) list=list.filter(x=>(x.adSoyad||"").toLowerCase().includes(q) || (x.email||"").toLowerCase().includes(q) || (x.gorev||"").toLowerCase().includes(q));
  if(fr) list=list.filter(x=> (x.rol||"")===fr);
  if(fd!=="") list=list.filter(x=> String(!!x.aktif)===fd);

  const rows=$("#rowsUsers"); const wrap=$("#usersCardsWrap");
  rows.innerHTML=""; wrap.innerHTML="";
  if($("#usersTableWrap").style.display!=="none"){
    if(!list.length){ rows.innerHTML='<tr><td colspan="8" class="pill">Kayƒ±t yok</td></tr>'; return; }
    list.forEach(u=>{
      const d=u.eklenmeTarihi?.toDate? u.eklenmeTarihi.toDate() : null;
      const tr=document.createElement('tr');
      tr.innerHTML=`<td><b>${u.adSoyad||"-"}</b></td><td>${u.email||"-"}</td><td>${u.rol||"-"}</td><td>${u.gorev||"-"}</td>
        <td>${u.aktif? '<span class="pill">Aktif</span>':'<span class="pill">Pasif</span>'}</td>
        <td>${(u.yetkiler||[]).length}</td><td>${d? d.toLocaleDateString():"-"}</td>
        <td class="mini"><button class="btn" data-edit="${u.uid}">D√ºzenle</button><button class="btn" data-reset="${u.email}">≈ûifre</button>
        <button class="btn" data-toggle='${JSON.stringify({uid:u.uid,aktif:!!u.aktif}).replace(/'/g,"&apos;")}' >${u.aktif? "Pasifle":"Aktifle"}</button>
        <button class="btn" data-softdel="${u.uid}">Soft Sil</button></td>`;
      rows.appendChild(tr);
    });
    bindListButtons(rows);
  }else{
    if(!list.length){ wrap.innerHTML='<div class="pill">Kayƒ±t yok</div>'; return; }
    list.forEach(u=>{
      const d=u.eklenmeTarihi?.toDate? u.eklenmeTarihi.toDate() : null;
      const card=document.createElement('div'); card.className='ucard';
      card.innerHTML=`<div style="display:flex;justify-content:space-between;gap:8px"><div><div style="font-weight:800">${u.adSoyad||"-"}</div><div style="font-size:12px;color:var(--muted)">${u.email||"-"} ¬∑ ${u.rol||"-"} ¬∑ ${u.gorev||"-"}</div></div><div>${u.aktif? '<span class="pill">Aktif</span>':'<span class="pill">Pasif</span>'}</div></div>
        <div class="mini" style="margin-top:8px"><button class="btn" data-edit="${u.uid}">D√ºzenle</button><button class="btn" data-reset="${u.email}">≈ûifre</button>
        <button class="btn" data-toggle='${JSON.stringify({uid:u.uid,aktif:!!u.aktif}).replace(/'/g,"&apos;")}' >${u.aktif? "Pasifle":"Aktifle"}</button>
        <button class="btn" data-softdel="${u.uid}">Soft Sil</button></div>`;
      wrap.appendChild(card);
    });
    bindListButtons(wrap);
  }
}

/* D√ºzenleme */
const mEdit=$("#mEdit");
async function openEdit(uid){
  const doc=await db.collection("kullanicilar").doc(uid).get(); if(!doc.exists){ toast("Kullanƒ±cƒ± bulunamadƒ±"); return; }
  const u={uid:doc.id, ...doc.data()};
  $("#e_uid").value=u.uid; $("#e_ad").value=u.adSoyad||""; $("#e_rol").value=u.rol||"personel"; $("#e_gorev").value=u.gorev||""; $("#e_mail").value=u.email||""; $("#e_aktif").checked=!!u.aktif;
  renderPermTree("#permTreeEdit", u.yetkiler||[]);
  mEdit.style.display='flex';
}
$("#btnEditClose").onclick=()=> mEdit.style.display='none';
$("#btnEditSave").onclick=async()=>{
  const uid=$("#e_uid").value; const ad=$("#e_ad").value.trim(); const rol=$("#e_rol").value; const gorev=$("#e_gorev").value.trim(); const aktif=$("#e_aktif").checked; const yetkiler=normalizeYetkiler(getChecked("#permTreeEdit"));
  if(!ad||!rol){ toast("Ad ve rol zorunlu"); return; }
  await db.collection("kullanicilar").doc(uid).set({adSoyad:ad, rol, gorev, aktif, yetkiler},{merge:true});
  mEdit.style.display='none'; toast("G√ºncellendi");
};

/* Reset/Toggle/Delete */
async function resetPass(email){ try{ await auth.sendPasswordResetEmail(email); toast("Sƒ±fƒ±rlama e-postasƒ± g√∂nderildi"); }catch(e){ toast("G√∂nderilemedi: "+(e?.message||e)); } }
async function toggleActive(d){ await db.collection("kullanicilar").doc(d.uid).set({aktif: !d.aktif},{merge:true}); toast("Durum g√ºncellendi"); }
async function softDelete(uid){ if(!confirm("Bu kullanƒ±cƒ± soft-silinecek (aktif=false, silindi=true). Onaylƒ±yor musun?")) return; await db.collection("kullanicilar").doc(uid).set({aktif:false, silindi:true},{merge:true}); toast("Soft silindi"); }

/* ===== Manifest listener ===== */
function listenManifest(){
  db.collection("sayfa_manifesti").orderBy("order","asc").onSnapshot(snap=>{
    const m={};
    snap.forEach(d=>{
      const v=d.data()||{};
      m[d.id]={title:v.title||d.id, order:v.order||0, pages:Array.isArray(v.pages)? v.pages.sort((a,b)=>(a.order||0)-(b.order||0)) : []};
    });
    manifest=m;
    fillPanelSelect(); renderPermTree("#permTreeAdd"); if($("#permTreeEdit").children.length) renderPermTree("#permTreeEdit", getChecked("#permTreeEdit")); renderManifestAdmin(); renderKPIs();
  });
}

/* ===== Auth + Yetki + Men√º ===== */
try{ firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL); }catch(e){}
auth.onAuthStateChanged(async (user)=>{
  if(!user){ setTimeout(()=>{ if(!auth.currentUser) location.replace('../index.html'); },150); return; }
  $("#meMail").textContent=user.email||"‚Äî";
  try{
    const uSnap=await db.collection('kullanicilar').doc(user.uid).get();
    const data=uSnap.exists? uSnap.data():{};
    const rawPerms=Array.isArray(data.yetkiler)? data.yetkiler:[];
    CURRENT_ALLOW=new Set(rawPerms.filter(s=>!String(s).trim().startsWith('-') && !String(s).trim().startsWith('!')).map(norm));
    CURRENT_DENY=new Set(rawPerms.filter(s=>String(s).trim().startsWith('-')||String(s).trim().startsWith('!')).map(s=>norm(String(s).replace(/^[-!]\\s*/,''))));
    const panels=await fetchPanels(CURRENT_ALLOW,CURRENT_DENY); renderNav(panels);
    listenManifest(); listenUsers();
  }catch(e){ console.error(e); toast('Veriler y√ºklenirken hata'); }
});
</script>
</body>
</html>
