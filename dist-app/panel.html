<!DOCTYPE html>
<html lang="tr" data-theme="auto">
<head>
  <meta charset="UTF-8" />
  <title>Karaağaç Fatih – iOS Panel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="icon" type="image/png" href="./img/logo.png" />

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="./js/firebase/firebase-init.js"></script>

  <style>
    :root{
      /* Safe area */
      --safe-top: env(safe-area-inset-top);
      --safe-bottom: env(safe-area-inset-bottom);
      --safe-left: env(safe-area-inset-left);
      --safe-right: env(safe-area-inset-right);

      /* Theme tokens (mevcut dilinle uyumlu) */
      --bg:#0f172a; --bg2:#0b1324;
      --grad1:#0ea5e922; --grad2:#22d3ee22;
      --card:rgba(15,23,42,.92); --stroke:rgba(148,163,184,.18);
      --text:#e5e7eb; --muted:#9aa4b2; --brand:#38bdf8; --brand2:#0ea5e9;
      --surface:rgba(2,6,23,.1);
      --radius:16px; --shadow:0 18px 40px rgba(0,0,0,.20);

      --tab-h: 62px;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#eef6ff; --bg2:#f7fbff; --grad1:#38bdf822; --grad2:#22d3ee22;
        --card:rgba(255,255,255,.95); --stroke:rgba(15,23,42,.12);
        --text:#0b1220; --muted:#4b5563; --brand:#0ea5e9; --brand2:#0284c7;
        --surface:#eef3ff;
      }
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      font-family:ui-sans-serif,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;
      background:
        radial-gradient(900px 680px at 12% 8%, var(--grad1), transparent 45%),
        radial-gradient(800px 640px at 88% 92%, var(--grad2), transparent 50%),
        linear-gradient(140deg, var(--bg), var(--bg2) 60%);
      overflow:hidden;
    }

    /* ÜST – Hoş geldiniz alanı (Appbar YOK) */
    .top{
      position:sticky; top:0; z-index:10;
      padding: calc(10px + var(--safe-top)) max(16px, var(--safe-left)) 12px max(16px, var(--safe-left));
      padding-right: max(16px, var(--safe-right));
      background: linear-gradient(180deg, rgba(2,6,23,.55), rgba(2,6,23,.15));
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--stroke);
    }
    .hello{ display:flex; align-items:baseline; justify-content:space-between; gap:12px; }
    .hello h1{ margin:0; font-size:18px; font-weight:900; letter-spacing:.02em }
    .hello .date{ color:var(--muted); font-size:12px; margin-top:2px }
    .top-actions{ display:flex; gap:8px; }
    .btn{
      border:1px solid var(--stroke); background:var(--card); color:var(--text);
      border-radius:999px; padding:8px 12px; cursor:pointer; font-weight:600;
    }

    /* İçerik alanı */
    .content{
      position:relative;
      height: calc(100dvh - var(--tab-h) - var(--safe-bottom));
      overflow:auto; -webkit-overflow-scrolling: touch;
      padding: 14px;
      padding-left: max(14px, var(--safe-left));
      padding-right: max(14px, var(--safe-right));
    }

    /* Kartlar */
    .card{
      background:var(--card); border:1px solid var(--stroke);
      border-radius: var(--radius); box-shadow: var(--shadow);
      padding: 14px; margin-bottom: 12px;
    }
    .card h3{ margin:0 0 10px; font-size:16px; display:flex; justify-content:space-between; align-items:center }
    .kpi{display:flex; align-items:center; justify-content:space-between; gap:8px; padding:12px; border-radius:12px; border:1px solid var(--stroke); background:var(--surface)}
    .kpi .val{font-size:22px; font-weight:800}
    .kpi .sub{font-size:12px; color:var(--muted)}
    .list{display:grid; gap:10px}
    .list-item{display:flex; justify-content:space-between; align-items:center; gap:10px; padding:10px 12px; border-radius:12px; border:1px solid var(--stroke); background:var(--surface)}
    .tag{padding:4px 8px; font-size:12px; border-radius:999px; border:1px solid var(--stroke); background:rgba(56,189,248,.12)}

    /* Temizlik: tam genişlik graf / satır listesi */
    .table{width:100%; border-collapse: collapse; font-size:14px}
    .table th,.table td{border-bottom:1px solid var(--stroke); padding:10px 6px; text-align:left}
    .table th{color:var(--muted); font-weight:700}

    /* Pull to refresh */
    .ptr{
      position:absolute; top:0; left:0; right:0; height:0; overflow:visible; display:flex; justify-content:center; pointer-events:none;
    }
    .ptr .bubble{
      margin-top: -40px; width:28px; height:28px; border-radius:50%;
      border:2px solid rgba(255,255,255,.6); border-top-color:#fff; animation:spin 1s linear infinite; opacity:0; transition:opacity .15s;
    }
    .ptr.show .bubble{ opacity:1 }
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Sheet – panelin sayfaları */
    .sheet{
      position: fixed; left:0; right:0;
      bottom: calc(-100% - 20px); z-index: 50;
      background: var(--card); border-top:1px solid var(--stroke);
      border-top-left-radius: 16px; border-top-right-radius: 16px;
      box-shadow: 0 -12px 30px rgba(0,0,0,.35);
      transition: bottom .25s ease;
      padding: 10px;
      padding-bottom: calc(10px + var(--safe-bottom));
      max-height: calc(70dvh + var(--safe-bottom)); overflow:auto;
    }
    .sheet.open{ bottom: 0 }
    .sheet .drag{ width:46px; height:4px; border-radius:999px; background:var(--stroke); margin:6px auto 10px; }
    .sheet h4{ margin:0 0 8px; font-size:14px; color:var(--muted); text-align:center }
    .sheet a{ display:block; padding:12px; border-radius:12px; border:1px solid var(--stroke); background:var(--surface); color:var(--text); text-decoration:none; margin:6px 0 }

    /* Alt Tab Bar */
    .tabbar{
      position: fixed; left:0; right:0; bottom:0; z-index: 60;
      height: calc(var(--tab-h) + var(--safe-bottom));
      padding-bottom: var(--safe-bottom);
      background: var(--card); border-top:1px solid var(--stroke);
      display:flex; align-items:center; justify-content: space-around; gap:6px;
    }
    .tab{
      min-width: 0;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      padding: 6px 8px; gap:4px; border-radius:10px; flex:1; max-width: 140px;
      color: var(--text); border:1px solid transparent;
    }
    .tab small{ font-size:11px; text-overflow:ellipsis; overflow:hidden; white-space:nowrap; max-width:120px }
    .tab.active{ border-color: var(--stroke); background: var(--surface) }
  </style>
</head>
<body>

  <!-- ÜST – Hoş geldiniz -->
  <div class="top">
    <div class="hello">
      <div>
        <h1 id="helloName">Hoş geldiniz, —</h1>
        <div class="date" id="todayText">—</div>
      </div>
      <div class="top-actions">
        <button class="btn" id="btnTheme">Tema: Auto</button>
        <button class="btn" id="btnLogout">Çıkış</button>
      </div>
    </div>
  </div>

  <!-- İçerik -->
  <main class="content" id="content">
    <!-- Pull to refresh göstergesi -->
    <div class="ptr" id="ptr"><div class="bubble"></div></div>

    <!-- 1) Talebe -->
    <section class="card">
      <h3>Talebe <span class="tag">Güncel</span></h3>
      <div class="kpi">
        <div>
          <div class="val" id="talebeToplam">—</div>
          <div class="sub">Toplam Talebe</div>
        </div>
        <div>
          <div class="sub">Ensar / Muhacir</div>
          <div class="val" style="font-size:18px"><span id="talebeEnsar">—</span> / <span id="talebeMuhacir">—</span></div>
        </div>
      </div>
    </section>

    <!-- 2) Nöbetçi -->
    <section class="card">
      <h3>Nöbetçi</h3>
      <div class="kpi">
        <div>
          <div class="sub">Evli / İhvan</div>
          <div class="val" id="nobetEvli">—</div>
        </div>
        <div>
          <div class="sub">Bekar</div>
          <div class="val" id="nobetBekar">—</div>
        </div>
      </div>
    </section>

    <!-- 3) Temizlik (tam genişlik) -->
    <section class="card">
      <h3>Temizlik – Kat Puanları</h3>
      <table class="table" id="temizlikTable">
        <thead><tr><th>Kat</th><th>Puan</th><th>Not</th></tr></thead>
        <tbody id="temizlikBody"><tr><td colspan="3">—</td></tr></tbody>
      </table>
    </section>

    <!-- 4) Eksikler -->
    <section class="card">
      <h3>Eksikler</h3>
      <div class="list" id="eksikList"><div class="list-item"><div>—</div><div class="muted">—</div></div></div>
    </section>

    <!-- 5) Duyurular -->
    <section class="card">
      <h3>Duyurular</h3>
      <div class="list" id="duyuruList"><div class="list-item"><div>—</div><div class="muted">—</div></div></div>
    </section>

    <div style="height:120px"></div>
  </main>

  <!-- Panel sayfaları için sheet -->
  <div class="sheet" id="sheet">
    <div class="drag"></div>
    <h4 id="sheetTitle">Panel</h4>
    <div id="sheetBody"></div>
  </div>

  <!-- Alt Tab Bar (paneller) -->
  <nav class="tabbar" id="tabbar"></nav>

  <script>
    /*************** THEME + AUTH *****************/
    const auth = firebase.auth();
    const db   = firebase.firestore();
    try{ auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL) }catch(e){}

    const root = document.documentElement;
    const btnTheme = document.getElementById('btnTheme');
    function applyTheme(mode){
      localStorage.setItem('kf_theme', mode);
      const auto = (mode === 'auto');
      const isDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      root.setAttribute('data-theme', auto ? (isDark ? 'dark' : 'light') : mode);
      btnTheme.textContent = 'Tema: ' + (mode[0].toUpperCase()+mode.slice(1));
    }
    applyTheme(localStorage.getItem('kf_theme')||'auto');
    btnTheme.addEventListener('click', ()=>{
      const cur = localStorage.getItem('kf_theme')||'auto';
      applyTheme(cur==='dark'?'light':(cur==='light'?'auto':'dark'));
    });

    document.getElementById('btnLogout').addEventListener('click', async ()=>{
      try{ await auth.signOut(); location.replace('../index.html'); }catch(e){ alert('Çıkış hatası'); }
    });

    /*************** TARİH *****************/
    function setToday(){
      const d=new Date(), days=['Pazar','Pazartesi','Salı','Çar','Per','Cum','Cts'];
      document.getElementById('todayText').textContent =
        `${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()} • ${days[d.getDay()]}`;
    }
    setToday();

    /*************** SAFE DATA HELPERS *****************/
    const norm = (s)=> String(s||'').trim().toLowerCase();
    let CURRENT_ALLOW = new Set(); // yetki listesi (+)
    let CURRENT_DENY  = new Set(); // hariçler (-)

    /*************** MANİFESTTEN PANELLER *****************/
    async function fetchPanels(){
      // sayfa_manifesti -> { panels: {...} } ya da tek tek dokümanlar — senin paylaştığın yapıya uygun
      const res = [];
      try{
        const snap = await db.collection('sayfa_manifesti').get(); // TODO: kendi yolunu kullan
        snap.forEach(doc=>{
          const d = doc.data()||{}, id=doc.id, title=d.title||id;
          let pages = Array.isArray(d.pages) ? d.pages : [];
          // Yetkiye göre sayfaları filtrele
          pages = pages.filter(pg=>{
            const key = norm(pg.key || pg.title || '');
            const inPanel = CURRENT_ALLOW.has(norm(id)) || CURRENT_ALLOW.has(norm(title));
            const allowed = CURRENT_ALLOW.has(key) || inPanel;
            const denied  = CURRENT_DENY.has(key);
            return allowed && !denied;
          });
          if(pages.length){
            res.push({ id, title, pages });
          }
        });
      }catch(e){ console.error('manifest:', e); }
      return res;
    }

    /*************** TAB BAR OLUŞTURMA *****************/
    const tabbar = document.getElementById('tabbar');
    const sheet  = document.getElementById('sheet');
    const sheetTitle = document.getElementById('sheetTitle');
    const sheetBody  = document.getElementById('sheetBody');

    function openSheet(panel){
      sheetTitle.textContent = panel.title;
      sheetBody.innerHTML = '';
      (panel.pages||[]).forEach(pg=>{
        const a = document.createElement('a');
        a.textContent = pg.title || pg.key || 'Sayfa';
        a.href = pg.path || '#';
        a.addEventListener('click', ()=> closeSheet());
        sheetBody.appendChild(a);
      });
      sheet.classList.add('open');
    }
    function closeSheet(){ sheet.classList.remove('open'); }
    sheet.addEventListener('click', (e)=>{ if(e.target===sheet) closeSheet(); });

    function renderTabs(panels){
      tabbar.innerHTML = '';
      panels.forEach((p, idx)=>{
        const btn = document.createElement('button');
        btn.className = 'tab' + (idx===0?' active':'');
        btn.innerHTML = `<small>${p.title}</small>`;
        btn.addEventListener('click', ()=>{
          tabbar.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
          btn.classList.add('active');
          openSheet(p);
        });
        tabbar.appendChild(btn);
      });
    }

    /*************** CANLI VERİ – Firestore ***************/
    async function loadTalebe(){
      try{
        // TODO: kendi yolların
        // istatistik/talebe -> { toplam, ensar, muhacir }
        const ref = db.collection('istatistik').doc('talebe');
        const s = await ref.get();
        const d = s.exists ? s.data() : {};
        document.getElementById('talebeToplam').textContent  = d.toplam ?? '—';
        document.getElementById('talebeEnsar').textContent   = d.ensar ?? '—';
        document.getElementById('talebeMuhacir').textContent = d.muhacir ?? '—';
      }catch(e){ console.log('talebe', e); }
    }

    async function loadNobet(){
      try{
        // TODO: nobet/gunluk/<YYYY-MM-DD> -> { evli, bekar }
        const today = new Date();
        const key = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
        const ref = db.collection('nobet').doc('gunluk').collection('günler').doc(key);
        const s = await ref.get();
        const d = s.exists ? s.data() : {};
        document.getElementById('nobetEvli').textContent  = d.evli_ihvan ?? d.evli ?? '—';
        document.getElementById('nobetBekar').textContent = d.bekar ?? '—';
      }catch(e){ console.log('nöbet', e); }
    }

    async function loadTemizlik(){
      try{
        // TODO: temizlik/gunluk/<YYYY-MM-DD> -> { katlar:[{ad,puan,not}] }
        const today = new Date();
        const key = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
        const ref = db.collection('temizlik').doc('gunluk').collection('günler').doc(key);
        const s = await ref.get();
        const d = s.exists ? s.data() : {};
        const rows = Array.isArray(d.katlar)? d.katlar : [];
        const tbody = document.getElementById('temizlikBody');
        tbody.innerHTML = rows.length ? '' : '<tr><td colspan="3">Kayıt yok</td></tr>';
        rows.forEach(r=>{
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${r.ad||'-'}</td><td><b>${r.puan ?? '-'}</b></td><td>${r.not||''}</td>`;
          tbody.appendChild(tr);
        });
      }catch(e){ console.log('temizlik', e); }
    }

    async function loadEksikler(){
      try{
        // TODO: eksikler (son 10) -> [{baslik, durum}]
        const snap = await db.collection('eksikler').orderBy('ts','desc').limit(10).get();
        const list = document.getElementById('eksikList');
        list.innerHTML = '';
        if(snap.empty){ list.innerHTML='<div class="list-item"><div>Eksik bulunamadı</div><div></div></div>'; return; }
        snap.forEach(doc=>{
          const d=doc.data()||{};
          const el=document.createElement('div');
          el.className='list-item';
          el.innerHTML = `<div>${d.baslik||'Eksik'}</div><div class="tag">${(d.durum||'açık').toUpperCase()}</div>`;
          list.appendChild(el);
        });
      }catch(e){ console.log('eksikler', e); }
    }

    async function loadDuyurular(){
      try{
        // TODO: duyurular (son 10) -> [{baslik, alt, ts}]
        const snap = await db.collection('duyurular').orderBy('ts','desc').limit(10).get();
        const list = document.getElementById('duyuruList');
        list.innerHTML = '';
        if(snap.empty){ list.innerHTML='<div class="list-item"><div>Duyuru yok</div><div></div></div>'; return; }
        snap.forEach(doc=>{
          const d=doc.data()||{};
          const el=document.createElement('div');
          el.className='list-item';
          const when = d.ts && d.ts.toDate ? d.ts.toDate().toLocaleString('tr-TR') : '';
          el.innerHTML = `<div><strong>${d.baslik||'—'}</strong><div class="muted" style="font-size:12px">${d.alt||''}</div></div><div class="muted" style="font-size:12px">${when}</div>`;
          list.appendChild(el);
        });
      }catch(e){ console.log('duyurular', e); }
    }

    async function loadAll(){
      await Promise.all([loadTalebe(), loadNobet(), loadTemizlik(), loadEksikler(), loadDuyurular()]);
    }

    /*************** PULL TO REFRESH *****************/
    (function(){
      const sc = document.getElementById('content');
      const ptr = document.getElementById('ptr');
      let startY=0, pulling=false;
      sc.addEventListener('touchstart', (e)=>{
        if(sc.scrollTop===0){ startY = e.touches[0].clientY; pulling=true; }
      }, {passive:true});
      sc.addEventListener('touchmove', (e)=>{
        if(!pulling) return;
        const dy = e.touches[0].clientY - startY;
        if(dy>60){ ptr.classList.add('show'); }
      }, {passive:true});
      sc.addEventListener('touchend', async ()=>{
        if(!pulling) return;
        pulling=false;
        if(ptr.classList.contains('show')){
          await loadAll();
          setTimeout(()=> ptr.classList.remove('show'), 300);
        }
      }, {passive:true});
    })();

    /*************** AUTH FLOW *****************/
    auth.onAuthStateChanged(async (user)=>{
      if(!user){ location.replace('../index.html'); return; }
      document.getElementById('helloName').textContent = 'Hoş geldiniz, ' + (user.displayName || user.email || 'Kullanıcı');

      // Kullanıcı yetkileri
      try{
        const u = await db.collection('kullanicilar').doc(user.uid).get();
        const d = u.exists ? (u.data()||{}) : {};
        const raw = Array.isArray(d.yetkiler) ? d.yetkiler : [];
        CURRENT_ALLOW = new Set(raw.filter(s=>!String(s).trim().match(/^[-!]/)).map(norm));
        CURRENT_DENY  = new Set(raw.filter(s=> String(s).trim().match(/^[-!]/)).map(s=>norm(String(s).replace(/^[-!]\s*/,''))));
      }catch(e){}

      // Paneller → Tab bar
      const panels = await fetchPanels();
      renderTabs(panels);

      // Veriler
      await loadAll();
    });
  </script>
</body>
</html>
