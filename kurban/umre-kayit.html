<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Karaaƒüa√ß Umre | Kayƒ±t </title>
  <link rel="icon" type="image/png" href="../img/logo.png" />
  <link rel="stylesheet" href="../css/app-shell.css" />

  <style>
    body {
      padding-top: var(--appbar-h) !important;
      overflow-x: hidden;
      overflow-y: auto;
      font-size: 15px;
    }

    main.container {
      max-width: 960px;
      margin: 0 auto;
      padding: 24px 20px;
    }

    .page-title {
      margin: 0 0 24px;
      font-size: 24px;
      font-weight: 700;
      color: var(--text);
    }

    /* KPI kartlarƒ± */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
      margin-bottom: 28px;
    }
    .kpi-card {
      background: var(--card);
      border-radius: 14px;
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      padding: 20px 22px;
      transition: border-color 0.2s, transform 0.15s;
    }
    .kpi-card:hover {
      border-color: var(--brand);
      transform: translateY(-2px);
    }
    .kpi-card .kpi-label {
      font-size: 13px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.03em;
      margin-bottom: 8px;
    }
    .kpi-card .kpi-value {
      font-size: 28px;
      font-weight: 800;
      color: var(--text);
      line-height: 1.2;
    }
    .kpi-card.kpi-toplam .kpi-value { color: var(--brand); }
    .kpi-card.kpi-kisi .kpi-value { color: #2e7d32; }
    .kpi-card.kpi-ortalama .kpi-value { color: #1565c0; }
    @media (max-width: 640px) {
      .kpi-grid { grid-template-columns: 1fr; gap: 12px; margin-bottom: 20px; }
      .kpi-card .kpi-value { font-size: 24px; }
    }

    /* Umre kayƒ±t tablosu */
    .umre-section {
      margin-top: 0;
    }
    .umre-card {
      background: var(--card);
      border-radius: 14px;
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      overflow: hidden;
    }
    .umre-card h2 {
      margin: 0;
      padding: 20px 24px;
      font-size: 18px;
      font-weight: 700;
      color: var(--text);
      border-bottom: 1px solid var(--stroke);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .umre-card h2::before {
      content: '';
      width: 4px;
      height: 22px;
      background: var(--brand);
      border-radius: 2px;
    }
    .umre-table-wrap {
      overflow-x: auto;
    }
    .umre-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    .umre-table th {
      text-align: left;
      padding: 14px 16px;
      background: linear-gradient(180deg, var(--surface), var(--card));
      color: var(--muted);
      font-weight: 600;
      white-space: nowrap;
      border-bottom: 2px solid var(--stroke);
    }
    .umre-table td {
      padding: 14px 16px;
      border-bottom: 1px solid var(--stroke);
      color: var(--text);
    }
    .umre-table tbody tr:hover {
      background: var(--surface);
    }
    .umre-table .col-tarih { width: 140px; }
    .umre-table .col-kisi { width: 80px; text-align: center; }
    .umre-loading, .umre-empty {
      padding: 48px 24px;
      text-align: center;
      color: var(--muted);
      font-size: 15px;
    }
    .umre-loading::before {
      content: '';
      display: inline-block;
      width: 32px;
      height: 32px;
      border: 3px solid var(--stroke);
      border-top-color: var(--brand);
      border-radius: 50%;
      animation: umre-spin 0.8s linear infinite;
      margin-bottom: 12px;
      vertical-align: middle;
    }
    @keyframes umre-spin { to { transform: rotate(360deg); } }
    .umre-empty { padding-top: 40px; }
    @media (max-width: 768px) {
      .umre-table th, .umre-table td { padding: 10px 12px; font-size: 13px; }
      .umre-table .hide-mobile { display: none; }
    }
  </style>

  <!-- Supabase (Auth + Database) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="../src/supabase.js"></script>
  <script src="../src/supabase-auth-wrapper.js"></script>
  <script src="../src/supabase-db-wrapper.js"></script>

  <script>
    // Supabase Auth wrapper'ƒ± hazƒ±rla ve app shell auth'u tetikle
    (function () {
      function initAuth() {
        if (typeof window.getSupabaseAuth === 'function') {
          window.auth = window.getSupabaseAuth();
          return true;
        }
        return false;
      }

      function waitAndTriggerInit() {
        if (typeof window.auth !== 'undefined' && window.auth && typeof window.initAppShellAuth === 'function') {
          try {
            window.initAppShellAuth();
          } catch (e) {
            console.error('initAppShellAuth hatasƒ±:', e);
          }
        } else if (typeof window.initAppShellAuth === 'function') {
          setTimeout(waitAndTriggerInit, 300);
        }
      }

      function bootstrap() {
        if (!initAuth()) {
          setTimeout(bootstrap, 200);
        } else {
          setTimeout(waitAndTriggerInit, 200);
        }
      }

      bootstrap();
    })();
  </script>

  <!-- Ortak JS (app shell, toast, nav, RLS bilin√ßli istekler) -->
  <script src="../js/ortak.js"></script>
</head>
<body>

  <!-- APP SHELL BAR -->
  <div class="appbar">
    <div class="brand" onclick="location.href='../panel.html'">
      <img src="../img/logo.png" alt="logo"><span>KARAAƒûA√á FATƒ∞H</span>
    </div>
    <nav class="nav-center"><ul class="nav-list" id="navMain"></ul></nav>
    <div class="nav-right">
      <button class="btn hamb" id="hamburger" title="Men√º">‚ò∞</button>
      <div class="nav-item">
        <button class="iconbtn" id="btnNotif" title="Bildirimler">üîî
          <span class="badge" id="notifBadge" style="display:none">0</span>
        </button>
        <div class="dropdown drop-right" id="notifDropdown">
          <div class="muted" style="padding:6px 8px">Son bildirimler</div>
          <div id="notifList" style="max-height:300px;overflow:auto"></div>
        </div>
      </div>
      <div class="nav-item">
        <button class="iconbtn" id="btnProfile" title="Profil">
          <span class="avatar"></span> <span id="profName" class="muted">Profil</span>
        </button>
        <div class="dropdown drop-right" id="profDropdown">
          <a href="/diger/kullanici-yonetimi.html">üë§ Profil</a>
          <a href="/diger/sistem-ayarlari.html">‚öôÔ∏è Sistem Ayarlarƒ±</a>
          <a href="#" id="btnLogout">üö™ √áƒ±kƒ±≈ü Yap</a>
        </div>
      </div>
    </div>
  </div>
  <aside class="drawer" id="drawer"></aside>
  <!-- TOAST CONTAINER (ortak.js kullanƒ±r) -->
  <div class="toast-container" id="toastContainer"></div>

  <main class="container">
    <h1 class="page-title">Karaaƒüa√ß Umre - 2026</h1>
    <section class="kpi-grid">
      <div class="kpi-card kpi-toplam">
        <div class="kpi-label">Toplam Ba≈üvuru</div>
        <div class="kpi-value" id="kpiToplam">‚Äì</div>
      </div>
      <div class="kpi-card kpi-kisi">
        <div class="kpi-label">Toplam Ki≈üi</div>
        <div class="kpi-value" id="kpiKisi">‚Äì</div>
      </div>
      <div class="kpi-card kpi-ortalama">
        <div class="kpi-label">Ortalama Ki≈üi / Ba≈üvuru</div>
        <div class="kpi-value" id="kpiOrtalama">‚Äì</div>
      </div>
    </section>

    <section class="umre-section">
      <div class="umre-card">
        <h2>Umre Kayƒ±t Listesi</h2>
        <div class="umre-table-wrap">
          <div id="umreLoading" class="umre-loading">Y√ºkleniyor‚Ä¶</div>
          <div id="umreEmpty" class="umre-empty" style="display:none">Hen√ºz umre kaydƒ± bulunmuyor.</div>
          <table id="umreTable" class="umre-table" style="display:none">
            <thead>
              <tr>
                <th class="col-tarih">Tarih</th>
                <th>Ad Soyad</th>
                <th class="hide-mobile">Telefon</th>
                <th class="hide-mobile">E-posta</th>
                <th class="col-kisi">Ki≈üi</th>
                <th class="hide-mobile">A√ßƒ±klama</th>
              </tr>
            </thead>
            <tbody id="umreBody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <script>
    (function () {
      function formatDate(val) {
        if (!val) return '‚Äì';
        try {
          var d = new Date(val);
          if (isNaN(d.getTime())) return val;
          return d.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit' });
        } catch (e) { return val; }
      }
      function escapeHtml(s) {
        if (s == null || s === '') return '‚Äì';
        var div = document.createElement('div');
        div.textContent = s;
        return div.innerHTML;
      }

      async function loadUmre() {
        var loadingEl = document.getElementById('umreLoading');
        var emptyEl = document.getElementById('umreEmpty');
        var tableEl = document.getElementById('umreTable');
        var bodyEl = document.getElementById('umreBody');
        if (!loadingEl || !emptyEl || !tableEl || !bodyEl) return;

        loadingEl.style.display = 'block';
        emptyEl.style.display = 'none';
        tableEl.style.display = 'none';
        bodyEl.innerHTML = '';
        var kpiToplamEl = document.getElementById('kpiToplam');
        var kpiKisiEl = document.getElementById('kpiKisi');
        var kpiOrtalamaEl = document.getElementById('kpiOrtalama');
        if (kpiToplamEl) kpiToplamEl.textContent = '‚Ä¶';
        if (kpiKisiEl) kpiKisiEl.textContent = '‚Ä¶';
        if (kpiOrtalamaEl) kpiOrtalamaEl.textContent = '‚Ä¶';

        try {
          var sb = window.supabase;
          if (!sb || typeof sb.from !== 'function') {
            loadingEl.style.display = 'none';
            emptyEl.textContent = 'Veritabanƒ± baƒülantƒ±sƒ± hazƒ±r deƒüil.';
            emptyEl.style.display = 'block';
            return;
          }
          var { data, error } = await sb
            .from('umre_onkayit')
            .select('*')
            .order('created_at', { ascending: false });

          loadingEl.style.display = 'none';
          if (error) {
            emptyEl.textContent = 'Veriler y√ºklenirken hata: ' + (error.message || 'Bilinmeyen hata');
            emptyEl.style.display = 'block';
            if (kpiToplamEl) kpiToplamEl.textContent = '‚Äì';
            if (kpiKisiEl) kpiKisiEl.textContent = '‚Äì';
            if (kpiOrtalamaEl) kpiOrtalamaEl.textContent = '‚Äì';
            return;
          }
          var list = data || [];
          var toplam = list.length;
          var toplamKisi = list.reduce(function (sum, r) { return sum + (parseInt(r.kisiler, 10) || 0); }, 0);
          var ortalama = toplam > 0 ? (toplamKisi / toplam).toFixed(1) : '0';
          if (kpiToplamEl) kpiToplamEl.textContent = toplam;
          if (kpiKisiEl) kpiKisiEl.textContent = toplamKisi;
          if (kpiOrtalamaEl) kpiOrtalamaEl.textContent = ortalama;

          if (list.length === 0) {
            emptyEl.style.display = 'block';
            tableEl.style.display = 'none';
            return;
          }
          tableEl.style.display = 'table';
          list.forEach(function (row) {
            var tr = document.createElement('tr');
            tr.innerHTML =
              '<td class="col-tarih">' + escapeHtml(formatDate(row.created_at)) + '</td>' +
              '<td>' + escapeHtml(row.ad_soyad || '‚Äì') + '</td>' +
              '<td class="hide-mobile">' + escapeHtml(row.telefon || '‚Äì') + '</td>' +
              '<td class="hide-mobile">' + escapeHtml(row.email || '‚Äì') + '</td>' +
              '<td class="col-kisi">' + (row.kisiler != null ? row.kisiler : '‚Äì') + '</td>' +
              '<td class="hide-mobile">' + escapeHtml((row.aciklama || '').slice(0, 50)) + (row.aciklama && row.aciklama.length > 50 ? '‚Ä¶' : '') + '</td>';
            bodyEl.appendChild(tr);
          });
        } catch (err) {
          loadingEl.style.display = 'none';
          emptyEl.textContent = 'Y√ºkleme hatasƒ±: ' + (err && err.message ? err.message : 'Bilinmeyen hata');
          emptyEl.style.display = 'block';
          if (kpiToplamEl) kpiToplamEl.textContent = '‚Äì';
          if (kpiKisiEl) kpiKisiEl.textContent = '‚Äì';
          if (kpiOrtalamaEl) kpiOrtalamaEl.textContent = '‚Äì';
        }
      }

      function waitSupabaseThenLoad() {
        if (typeof window.supabase !== 'undefined' && window.supabase && typeof window.supabase.from === 'function') {
          loadUmre();
        } else {
          setTimeout(waitSupabaseThenLoad, 200);
        }
      }
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', waitSupabaseThenLoad);
      } else {
        waitSupabaseThenLoad();
      }
    })();
  </script>

</body>
</html>
