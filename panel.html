<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>KaraaÄŸaÃ§ Fatih</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" type="image/png" href="./img/logo.png" />

  <style>
    :root{
      --appbar-h:56px;
      --radius:14px; --shadow:0 12px 28px rgba(0,0,0,.14);
      --bg:#0f172a; --bg2:#0b1324;
      --grad1:#0ea5e922; --grad2:#22d3ee22;
      --card:rgba(15,23,42,.92); --stroke:rgba(148,163,184,.18);
      --text:#e5e7eb; --muted:#9aa4b2;
      --brand:#38bdf8; --brand2:#0ea5e9;
      --pill:#0b1220; --pill-hover:#101a2b;
      --link:#c7e9ff; --surface:rgba(2,6,23,.08);
      --danger:#ef4444;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#eef6ff; --bg2:#f7fbff; --grad1:#38bdf822; --grad2:#22d3ee22;
        --card:rgba(255,255,255,.95);
        --stroke:rgba(15,23,42,.12);
        --text:#0b1220; --muted:#4b5563; --brand:#0ea5e9; --brand2:#0284c7;
        --pill:#f5f8ff; --pill-hover:#e9f2ff; --link:#0b5ea8; --surface:#eef3ff;
        --danger:#b91c1c;
      }
    }
    html[data-theme="dark"]{
      --bg:#0f172a; --bg2:#0b1324; --grad1:#0ea5e922; --grad2:#22d3ee22;
      --card:rgba(15,23,42,.92); --stroke:rgba(148,163,184,.18);
      --text:#e5e7eb; --muted:#9aa4b2; --brand:#38bdf8; --brand2:#0ea5e9;
      --pill:#0b1220; --pill-hover:#101a2b; --link:#c7e9ff; --surface:rgba(2,6,23,.08);
      --danger:#ef4444;
    }
    html[data-theme="light"]{
      --bg:#eef6ff; --bg2:#f7fbff; --grad1:#38bdf822; --grad2:#22d3ee22;
      --card:rgba(255,255,255,.95); --stroke:rgba(15,23,42,.12);
      --text:#0b1220; --muted:#4b5563; --brand:#0ea5e9; --brand2:#0284c7;
      --pill:#f5f8ff; --pill-hover:#e9f2ff; --link:#0b5ea8; --surface:#eef3ff;
      --danger:#b91c1c;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      font-family:ui-sans-serif,-apple-system,"Segoe UI",Roboto,Arial;
      background: var(--bg);
      overflow-x:hidden; word-wrap:break-word;
    }
    a{color:var(--link); text-decoration:none}
    a:hover{text-decoration:underline}

    /* APPBAR */
    .appbar{
      position:sticky; top:0; z-index:60;
      height:var(--appbar-h);
      background:var(--card); backdrop-filter:blur(10px);
      border-bottom:1px solid var(--stroke);
      display:flex; align-items:center;
      padding:0 max(12px, env(safe-area-inset-right)) 0 max(12px, env(safe-area-inset-left));
    }
    .brand{display:flex; align-items:center; gap:10px; cursor:pointer}
    .brand img{width:24px; height:24px}
    .brand span{font-weight:900; letter-spacing:.02em; color:var(--text)}

    .nav-center{margin:0 auto; height:100%}
    .nav-list{display:flex; gap:22px; align-items:center; height:100%; list-style:none; margin:0; padding:0}
    .nav-item{position:relative; height:100%}
    .nav-btn{height:100%; display:flex; align-items:center; gap:6px; color:var(--text); font-weight:600; cursor:pointer}
    .nav-btn:hover{color:var(--brand)}
    .caret{font-size:12px; opacity:.6}
    .dropdown{position:absolute; top:100%; left:0; min-width:240px; background:var(--card); border:1px solid var(--stroke); border-radius:10px; box-shadow:var(--shadow); padding:8px; display:none}
    .dropdown a{display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:8px; color:var(--text); text-decoration:none}
    .dropdown a:hover{background:var(--surface)}
    .nav-item.open .dropdown{display:block}

    .nav-right{display:flex; gap:8px; align-items:center}
    .btn{border:1px solid var(--stroke); background:var(--card); color:var(--text); border-radius:999px; padding:8px 12px; cursor:pointer}
    .hamb{display:none}

    .iconbtn{position:relative;border:1px solid var(--stroke);background:var(--card);color:var(--text);border-radius:999px;padding:8px 12px;cursor:pointer;display:flex;align-items:center;gap:8px}
    .badge{position:absolute;top:-6px;right:-6px;background:var(--danger);color:#fff;font-size:11px;padding:2px 6px;border-radius:999px;border:2px solid var(--card);min-width:18px;text-align:center}
    .drop-right{left:auto; right:0}
    .avatar{width:22px;height:22px;border-radius:999px;background:linear-gradient(180deg,#94a3b8,#64748b);display:inline-block}

    /* DRAWER (mobil) */
    .drawer{
      position:fixed;
      top:var(--appbar-h); right:0; bottom:0; left:30%;
      transform:translateX(100%); transition:transform .25s ease;
      background:var(--card); border-left:1px solid var(--stroke);
      z-index:70; overflow:auto; -webkit-overflow-scrolling:touch; padding:12px;
    }
    .drawer.open{transform:translateX(0)}
    .drawer .panel-title{margin:14px 4px 6px; font-weight:800; color:var(--muted); font-size:13px}
    .drawer a{display:block; padding:10px; border-radius:10px; border:1px solid var(--stroke); margin:6px 0; color:var(--text); background:var(--pill)}
    .drawer a:hover{background:var(--pill-hover)}

    /* CONTENT */
    .container{max-width:1200px; margin:0 auto; padding:16px}
    .hero{display:flex; justify-content:space-between; align-items:flex-start; gap:16px; background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius); padding:16px; margin:16px 0; box-shadow:var(--shadow)}
    .hero h2{margin:0 0 6px; font-size:20px}
    .hero-sub{color:var(--muted); font-size:13px}

    .grid{display:grid; gap:14px; grid-template-columns:repeat(12, minmax(0,1fr))}
    .col-4{grid-column:span 4} .col-12{grid-column:span 12}
    .card{background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px}
    .card h3{margin:0 0 10px; font-size:16px}
    .kpi{display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px; border-radius:12px; border:1px solid var(--stroke); background:var(--surface)}
    .kpi .val{font-size:22px; font-weight:800}
    .kpi .sub{font-size:12px; color:var(--muted)}
    .list{display:grid; gap:10px}
    .list-item{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 12px; border-radius:12px; border:1px solid var(--stroke); background:var(--surface)}

    .toast{position:fixed; left:50%; bottom:24px; transform:translateX(-50%) translateY(20px); background:rgba(2,6,23,.95); color:#fff; border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:10px 12px; opacity:0; pointer-events:none; transition:opacity .25s, transform .25s; z-index:200}
    .toast.show{opacity:1; transform:translateX(-50%) translateY(0)}
    .page-gap{height:160px}

    @media (max-width: 960px){
      .col-4{grid-column:span 12}
      .hero{flex-direction:column}
      .nav-center{display:none}
      .hamb{display:inline-flex}
    }
    /* --- Top-3 kartlarÄ± iÃ§in ufak gÃ¶rsel dokunuÅŸlar --- */
.rank{min-width:28px;height:28px;display:inline-flex;align-items:center;justify-content:center;
  border-radius:999px;border:1px solid var(--stroke);background:var(--pill);font-weight:800;margin-right:8px}
.amount{font-weight:800}
.meta{font-size:15px;color:var(--muted)}
.bar{height:6px;border-radius:999px;background:var(--surface);overflow:hidden;margin-top:6px}
.bar>span{display:block;height:100%;background:linear-gradient(90deg,var(--brand),var(--brand2));width:0}

  </style>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="./js/firebase/firebase-init.js"></script>
  <script defer src="./js/ortak.js"></script>
</head>
<body>

  <!-- APPBAR -->
  <div class="appbar">
    <div class="brand" onclick="location.href='panel.html'">
      <img src="./img/logo.png" alt="logo"><span>KARAAÄAÃ‡ FATÄ°H</span>
    </div>

    <nav class="nav-center"><ul class="nav-list" id="navMain"></ul></nav>

    <div class="nav-right">
      <button class="btn hamb" id="hamburger" title="MenÃ¼">â˜°</button>

      <!-- Bildirim -->
      <div class="nav-item">
        <button class="iconbtn" id="btnNotif" title="Bildirimler">ğŸ””
          <span class="badge" id="notifBadge" style="display:none">0</span>
        </button>
        <div class="dropdown drop-right" id="notifDropdown" aria-label="Bildirim listesi">
          <div class="muted" style="padding:6px 8px">Son bildirimler</div>
          <div id="notifList" class="list" style="max-height:300px;overflow:auto"></div>
          <a href="diger/bildirim.html">TÃ¼m bildirimleri gÃ¶r â†’</a>
        </div>
      </div>

      <!-- Profil -->
      <div class="nav-item">
        <button class="iconbtn" id="btnProfile" title="Profil">
          <span class="avatar"></span> <span id="profName" class="muted">Profil</span>
        </button>
        <div class="dropdown drop-right" id="profDropdown" aria-label="Profil menÃ¼sÃ¼">
          <a href="diger/kullanici-yonetimi.html">ğŸ‘¤ Profil</a>
          <a href="diger/sistem-ayarlari.html">âš™ï¸ Ayarlar</a>
          <a href="#" id="btnLogout">ğŸšª Ã‡Ä±kÄ±ÅŸ Yap</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Mobil Ã§ekmece -->
  <aside class="drawer" id="drawer"></aside>

  <!-- CONTENT -->
  <main class="container">
    <section class="hero">
      <div>
        <h2>HoÅŸ Geldiniz, <span id="username">â€”</span></h2>
        <div class="hero-sub">BugÃ¼n: <span id="todayText">â€”</span></div>
      </div>
    </section>

    <div class="grid">
      <!-- Talebe istatistiÄŸi -->
      <div class="card col-4">
        <h3>Talebe Ä°statistiÄŸi</h3>
        <div class="kpi">
          <div><div class="val" id="kpiTalebe">--</div><div class="sub">Toplam Talebe</div></div>
          <div>ğŸ‘¥</div>
        </div>
        <div class="kpi" style="margin-top:10px">
          <div><div class="val"><span id="kpiEnsar">--</span> / <span id="kpiMuhacir">--</span></div><div class="sub">Ensar / Muhacir</div></div>
          <div>ğŸ“˜</div>
        </div>
      </div>

            <!-- NÃ¶betÃ§i -->
      <div class="card col-4">
        <h3>NÃ¶betÃ§i (09:00 â†’ 09:00)</h3>
        <div class="list" style="margin-top:10px">
          <div class="list-item"><div>Evli</div><div id="nobetEvli">â€”</div></div>
          <div class="list-item"><div>Bekar</div><div id="nobetBekar">â€”</div></div>
        </div>
      </div>

            <!-- Alacak Raporu -->
      <div class="card col-4">
        <h3>Alacak Raporu</h3>
        <div class="kpi"><div><div class="val" id="nispetToplam">--%</div><div class="sub">Toplam Tahsilat Nisp.</div></div><div>ğŸ“ˆ</div></div>
        <div class="kpi" style="margin-top:10px"><div><div class="val" id="nispet2024">--%</div><div class="sub">2024 Tahsilat Nisp.</div></div><div>ğŸ“†</div></div>
        <div class="kpi" style="margin-top:10px"><div><div class="val" id="nispet2025">--%</div><div class="sub">2025 Tahsilat Nisp.</div></div><div>ğŸ“†</div></div>
      </div>

      <!-- Talebe temizlik puanÄ± (bugÃ¼n) -->
      <div class="card col-4">
        <h3>Talebe Temizlik PuanÄ± (BugÃ¼n)</h3>
        <div class="kpi">
          <div><div class="val" id="kpiTalebeTemizlikOrt">--</div><div class="sub">GÃ¼nlÃ¼k Ortalama</div></div>
          <div>ğŸ§½</div>
        </div>
        <div class="list" id="talebeTemizlikTop5" style="margin-top:10px"></div>
      </div>

      <!-- Genel temizlik puanÄ± (bugÃ¼n â€“ kat bazlÄ±) -->
      <div class="card col-4">
        <h3>Genel Temizlik PuanÄ± (BugÃ¼n)</h3>
        <div class="kpi">
          <div><div class="val" id="kpiGenelTemizlikOrt">--</div><div class="sub">TÃ¼m Katlar Ortalama</div></div>
          <div>ğŸ§¹</div>
        </div>
        <div class="list" id="katOrtList" style="margin-top:10px"></div>
      </div>

      <!-- Teknik Eksikler (bugÃ¼n â€“ kat bazlÄ±) -->
      <div class="card col-4">
        <h3>Teknik Eksikler</h3>
        <div class="kpi">
          <div><div class="val" id="kpiEksikSayisi">--</div><div class="sub">BugÃ¼n Toplam Eksik</div></div>
          <div>ğŸ› ï¸</div>
        </div>
        <div class="list" id="eksikList" style="margin-top:10px"></div>
      </div>

      <!-- AylÄ±k Top-3 (YÃ¼zde) -->
      <div class="card col-4">
        <h3><span id="ayTop3">AÄŸustos AyÄ±</span> â€¢ En Fazla Tahsilat (YÃ¼zde) â€“ Ä°lk 3</h3>
        <div class="list" id="top3List"></div>
      </div>

      <!-- ğŸ†• AylÄ±k Top-3 (Tutar) -->
      <div class="card col-4">
        <h3><span id="ayTop3Tutar">AÄŸustos AyÄ±</span> â€¢ En Fazla Tahsilat (Tutar) â€“ Ä°lk 3</h3>
        <div class="list" id="top3TutarList"></div>
      </div>

      <!-- AylÄ±k HiÃ§ Tahsilat Yok -->
      <div class="card col-4">
        <h3><span id="ayZero">AÄŸustos AyÄ±</span> â€¢ HiÃ§ Tahsilat Yapmayanlar</h3>
        <div class="list" id="zeroList"></div>
      </div>
    </div>

    <div class="page-gap"></div>
  </main>

  <div class="toast" id="toast"></div>

  <script>
    /* Tema */
    (function(){
      const root=document.documentElement;
      const saved=localStorage.getItem('kf_theme')||'auto';
      apply(saved);
      function apply(mode){
        localStorage.setItem('kf_theme',mode);
        const sysDark=()=>window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches;
        const eff=(mode==='auto')?(sysDark()?'dark':'light'):mode;
        root.setAttribute('data-theme',eff);
      }
      if(window.matchMedia){
        const m=window.matchMedia('(prefers-color-scheme: dark)');
        m.addEventListener?.('change',()=>{ if((localStorage.getItem('kf_theme')||'auto')==='auto') apply('auto'); });
      }
    })();

    /* Helpers & Firebase */
    const db=firebase.firestore(), auth=firebase.auth();
    function showToast(msg){const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); clearTimeout(window.__to); window.__to=setTimeout(()=>t.classList.remove('show'),3000);}
    function setToday(){const d=new Date(); const days=['Pazar','Pazartesi','SalÄ±','Ã‡arÅŸamba','PerÅŸembe','Cuma','Cumartesi']; document.getElementById('todayText').textContent=`${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()} â€¢ ${days[d.getDay()]}`;}
    const norm = (s) => String(s || '').trim().toLowerCase();

    /* Yetki setleri */
    let CURRENT_ALLOW = new Set();  // +izinler
    let CURRENT_DENY  = new Set();  // -hariciler

    /* ====== MenÃ¼ manifesti (deÄŸiÅŸmedi) ====== */
    async function fetchPanels(allowSet, denySet){
      const res=[];
      try{
        const snap=await db.collection('sayfa_manifesti').get();
        snap.forEach(doc=>{
          const d=doc.data()||{}, id=doc.id;
          const panelTitle=d.title||id;
          const panelGrant = allowSet.has(norm(id)) || allowSet.has(norm(panelTitle));
          let pages = Array.isArray(d.pages)? d.pages : [];
          pages = pages.filter(pg=>{
            const keyNorm = norm(pg.key || pg.title || '');
            const pageGrant = allowSet.has(keyNorm);
            const denied    = denySet.has(keyNorm);
            return !denied && (panelGrant || pageGrant);
          }).map(pg=>({ baslik: pg.title || pg.key || 'Sayfa', url: pg.path || '#', key: pg.key || pg.title || '', sira: typeof pg.order==='number'? pg.order : 9999 })).sort((a,b)=>a.sira-b.sira);
          if (pages.length===0) return;
          res.push({ id, baslik:panelTitle, sira: typeof d.order==='number'? d.order : 9999, pages });
        });
        res.sort((a,b)=>a.sira-b.sira);
      }catch(e){ console.error('sayfa_manifesti okunamadÄ±:', e); showToast('MenÃ¼ manifesti yÃ¼klenemedi.'); }
      return res;
    }
    function renderNav(panels){
      const ul=document.getElementById('navMain'), drawer=document.getElementById('drawer');
      ul.innerHTML=''; drawer.innerHTML='';
      if(!panels.length){
        ul.innerHTML='<li class="nav-item"><div class="nav-btn">HiÃ§ panel yok</div></li>';
        drawer.innerHTML='<div style="color:var(--muted);padding:8px">HiÃ§ panel bulunamadÄ±</div>';
        return;
      }
      panels.forEach(p=>{
        const li=document.createElement('li'); li.className='nav-item';
        li.innerHTML=`<div class="nav-btn">${p.baslik} <span class="caret">â–¾</span></div>`;
        const dd=document.createElement('div'); dd.className='dropdown';
        (p.pages||[]).forEach(pg=>{
          const a=document.createElement('a');
          a.href=pg.url; a.textContent=pg.baslik;
          a.dataset.key=pg.key||pg.baslik; a.dataset.panel=p.id; a.dataset.panelTitle=p.baslik;
          dd.appendChild(a);
        });
        li.appendChild(dd);
        li.querySelector('.nav-btn').addEventListener('click',(e)=>{
          e.stopPropagation();
          ul.querySelectorAll('.nav-item').forEach(x=>{ if(x!==li) x.classList.remove('open'); });
          li.classList.toggle('open');
        });
        ul.appendChild(li);
      });
      document.addEventListener('click',(e)=>{ if(!ul.contains(e.target)) ul.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('open')); });

      // mobil
      panels.forEach(p=>{
        const h=document.createElement('div'); h.className='panel-title'; h.textContent=p.baslik; drawer.appendChild(h);
        (p.pages||[]).forEach(pg=>{
          const a=document.createElement('a');
          a.href=pg.url; a.textContent=pg.baslik;
          a.dataset.key=pg.key||pg.baslik; a.dataset.panel=p.id; a.dataset.panelTitle=p.baslik;
          drawer.appendChild(a);
        });
      });
    }
    (function(){ const hamb=document.getElementById('hamburger'), drawer=document.getElementById('drawer'); if(!hamb) return; hamb.addEventListener('click',()=>drawer.classList.toggle('open')); document.addEventListener('click',(e)=>{ if(!drawer.contains(e.target) && !hamb.contains(e.target)) drawer.classList.remove('open'); }); })();

    /* Bildirim & Profil dropdown */
    (function(){
      const notifBtn=document.getElementById('btnNotif');
      const notifDD =document.getElementById('notifDropdown');
      const profBtn =document.getElementById('btnProfile');
      const profDD  =document.getElementById('profDropdown');
      function closeAll(e){
        if(!notifDD.contains(e.target) && e.target!==notifBtn) notifDD.parentElement.classList.remove('open');
        if(!profDD.contains(e.target)  && e.target!==profBtn)  profDD.parentElement.classList.remove('open');
      }
      document.addEventListener('click', closeAll);
      notifBtn.addEventListener('click', (e)=>{ e.stopPropagation(); notifDD.parentElement.classList.toggle('open'); profDD.parentElement.classList.remove('open'); });
      profBtn .addEventListener('click', (e)=>{ e.stopPropagation(); profDD.parentElement.classList.toggle('open'); notifDD.parentElement.classList.remove('open'); });
      document.getElementById('btnLogout').addEventListener('click', async (e)=>{ e.preventDefault(); try{ await auth.signOut(); location.replace('index.html'); }catch(err){ showToast('Ã‡Ä±kÄ±ÅŸ yapÄ±lamadÄ±'); } });
    })();

    /* ===== Dinamik Kartlar ===== */
    // Panelde raporlayacaÄŸÄ±n katlarÄ±n etiketi
    const KATLAR = ['2.Kat - Lokal','1.Kat - EtÃ¼t','0 - GiriÅŸ Kat','-1.Kat - Yatakhane','-2.Kat - Yemekhane','BahÃ§e'];
    const monthsTR = ['Ocak','Åubat','Mart','Nisan','MayÄ±s','Haziran','Temmuz','AÄŸustos','EylÃ¼l','Ekim','KasÄ±m','AralÄ±k'];
    function toDate(v){
      if(!v) return null;
      if(typeof v.toDate==='function') return v.toDate();
      if(typeof v==='number') return new Date(v);
      if(typeof v==='string'){ const d=new Date(v); if(!isNaN(d)) return d; }
      return null;
    }
    function rangeYear(year){ return { start:new Date(year,0,1,0,0,0), end:new Date(year,11,31,23,59,59,999) }; }
    function rangeMonth(d){ return { start:new Date(d.getFullYear(), d.getMonth(), 1, 0,0,0), end:new Date(d.getFullYear(), d.getMonth()+1, 0, 23,59,59,999) }; }

        // Ä°sim tekilleÅŸtirme ve gÃ¶rselleÅŸtirme
    const tidy   = s => (s||'').toString().trim().replace(/\s+/g,' ');
    const normTR = s => tidy(s).toLocaleLowerCase('tr-TR');
    function nameKey(s){ return normTR(s).toUpperCase(); }

    // Ã‡ok alanlÄ± isim yakalayÄ±cÄ± (isim eksiklerini azaltÄ±r)
    function coalesceName(obj){
      const cand = [
        obj?.personel, obj?.personelAd, obj?.sorumlu, obj?.adSoyad, obj?.isim, obj?.ad_soyad, obj?.ad_soyad,
        obj?.ad, obj?.name
      ].map(tidy).filter(Boolean);
      if (cand.length) return cand[0];
      // e-posta varsa ad@â€¦ â†’ â€œadâ€ yakala
      const mail = tidy(obj?.email || obj?.mail || obj?.eposta);
      if (mail.includes('@')) return mail.split('@')[0];
      return 'â€”';
    }

    // Para biÃ§imlendirici
    function fmtTL(n){ const v=Number(n||0); return isNaN(v) ? 'â‚º0' : 'â‚º ' + v.toLocaleString('tr-TR'); }

    // === Ortak yardÄ±mcÄ±lar (TR gÃ¼nÃ¼) ===
    function todayStrTR(){
      const now = new Date();
      // Ä°stanbul TZ ile gÃ¼nÃ¼ fixle
      const tz = new Date(now.toLocaleString('en-US',{timeZone:'Europe/Istanbul'}));
      const y = tz.getFullYear(), m = String(tz.getMonth()+1).padStart(2,'0'), d = String(tz.getDate()).padStart(2,'0');
      return `${y}-${m}-${d}`;
    }
    function avg(nums){ if(!nums.length) return 0; const s=nums.reduce((a,b)=>a+(+b||0),0); return Math.round((s/nums.length)*10)/10; }

    // Kattaki toplam mahal sayÄ±sÄ±nÄ± getir (temizlik_listesi > temizlik_katlari fallback)
    async function getToplamMahaller(kat){
      try{
        const snap = await db.collection('temizlik_listesi').doc(kat).collection('mahaller').get();
        if(!snap.empty) return snap.size;
      }catch(_){}
      try{
        const ds = await db.collection('temizlik_katlari').doc(kat).get();
        if(ds.exists){
          const d = ds.data()||{};
          if (Array.isArray(d.mahaller)) return d.mahaller.length;
          if (d.mahaller && typeof d.mahaller==='object') return Object.keys(d.mahaller).length;
        }
      }catch(_){}
      return 0;
    }

    // 1) TEMÄ°ZLÄ°K KONTROLÃœ â€” tek kat, tek gÃ¼n
    async function fetchTemizlikKontrolKatGun(kat, dateStr){
      const col = db.collection('temizlik_kontrol').doc(kat).collection(dateStr);
      const snap = await col.get();
      const puanlar = [], zeroes = [];
      snap.forEach(doc=>{
        const v = doc.data()||{};
        const p = Number(v.puan)||0;
        puanlar.push(p);
        if(p===0) zeroes.push(1);
      });
      const kayitli = snap.size;
      const toplam = await getToplamMahaller(kat);
      const kapsama = toplam>0? kayitli/toplam : null;
      const ortalama = avg(puanlar);
      const eksikMah = toplam>0? Math.max(0, toplam-kayitli): 0;
      const uyari = eksikMah + zeroes.length; // 0 puan + eksik giriÅŸ
      return { kat, kayitli, toplam, kapsama, ortalama, uyari };
    }

    // 2) GENEL TEMÄ°ZLÄ°K â€” _summary varsa onu kullan
    async function fetchGenelSummaryKatGun(kat, dateStr){
      const root = db.collection('genel_temizlik_kontrol').doc(kat).collection(dateStr);
      const sum = await root.doc('_summary').get();
      if(sum.exists){
        const d = sum.data()||{};
        return { kat, submissions: d.submissions||0, avgPuan100: d.avgPuan100 ?? Math.round((d.avgPuan10||0)*10), eksikAny: !!d.eksik_var_any };
      }
      const snap = await root.get();
      let s=0, n=0, eksik=false;
      snap.forEach(doc=>{
        if(doc.id==='_summary') return;
        const v=doc.data()||{};
        if(typeof v.puan10==='number'){ s+=v.puan10; n++; }
        if(v.eksik_var) eksik = true;
      });
      const avg100 = n? Math.round((s/n)*10): 0;
      return { kat, submissions:n, avgPuan100: avg100, eksikAny: eksik };
    }

    // 3) DETAYLI â€” _summary / fallback
    async function fetchDetaySummaryKatGun(kat, dateStr){
      const root = db.collection('genel_temizlik_detay').doc(kat).collection(dateStr);
      const sum = await root.doc('_summary').get();
      if(sum.exists){
        const d = sum.data()||{};
        return { kat, submissions: d.submissions||0, avgPuan100: d.avgPuan100 ?? 0, eksikAny: !!d.eksik_var_any };
      }
      const snap = await root.get();
      let s=0, n=0, eksik=false;
      snap.forEach(doc=>{
        if(doc.id==='_summary') return;
        const v=doc.data()||{};
        if(typeof v.puan100==='number'){ s+=v.puan100; n++; }
        if(v.eksik_var) eksik = true;
      });
      const avg100 = n? Math.round(s/n): 0;
      return { kat, submissions:n, avgPuan100: avg100, eksikAny: eksik };
    }

    // 4) EKSÄ°KLER â€” aÃ§Ä±k kayÄ±tlar
    async function fetchEksikler({dateStr=null, kat=null, status='acik'}={}){
      let q = db.collection('eksik_bildirim').where('status','==', status);
      if(dateStr) q = q.where('tarih','==', dateStr);
      if(kat)     q = q.where('kat','==', kat);
      const snap = await q.get();
      const list = [];
      snap.forEach(doc=>{
        const v=doc.data()||{};
        const parcalar = String(v.aciklama||'').split('/').map(s=>s.trim()).filter(Boolean);
        list.push({ id: doc.id, kat: v.kat||'â€”', tarih: v.tarih||'â€”', uid: v.uid||'', email: v.email||'', aciklama: v.aciklama||'', parcalar, createdAt: v.createdAt||null, status: v.status||'acik' });
      });
      return { count: snap.size, list };
    }

    // === Hepsini toplu: panel kartlarÄ± iÃ§in tek fonksiyon
    async function buildTemizlikDashboard({kats, dateStr = todayStrTR()}){
      // 1) Temizlik KontrolÃ¼
      const tkRows = await Promise.all(kats.map(k=> fetchTemizlikKontrolKatGun(k, dateStr)));
      const tk = {
        toplamMahaller: tkRows.reduce((a,r)=> a + (r.toplam||0), 0),
        doldurulan:     tkRows.reduce((a,r)=> a + (r.kayitli||0), 0),
        ortalamaPuan:   (()=>{ let s=0,c=0; tkRows.forEach(r=>{ if(r.kayitli>0 && Number.isFinite(r.ortalama)){ s += r.ortalama * r.kayitli; c += r.kayitli; } }); return c? Math.round((s/c)*10)/10 : 0; })(),
        uyari:          tkRows.reduce((a,r)=> a + (r.uyari||0), 0),
        katlar:         tkRows
      };

      // 2) Genel Temizlik (Ã¶zet)
      const genelRows = await Promise.all(kats.map(k=> fetchGenelSummaryKatGun(k, dateStr)));
      const genel = {
        submissions:  genelRows.reduce((a,r)=> a+(r.submissions||0), 0),
        avgPuan100:   (()=>{ let s=0,c=0; genelRows.forEach(r=>{ s += (r.avgPuan100||0) * (r.submissions||0); c += (r.submissions||0); }); return c? Math.round(s/c) : 0; })(),
        eksikAny:     genelRows.some(r=> r.eksikAny),
        katlar:       genelRows
      };

      // 3) DetaylÄ± (Ã¶zet) â€” gerekirse ileride kullanÄ±rÄ±z
      const detayRows = await Promise.all(kats.map(k=> fetchDetaySummaryKatGun(k, dateStr)));
      const detay = {
        submissions:  detayRows.reduce((a,r)=> a+(r.submissions||0), 0),
        avgPuan100:   (()=>{ let s=0,c=0; detayRows.forEach(r=>{ s += (r.avgPuan100||0) * (r.submissions||0); c += (r.submissions||0); }); return c? Math.round(s/c) : 0; })(),
        eksikAny:     detayRows.some(r=> r.eksikAny),
        katlar:       detayRows
      };

      // 4) Eksikler (aÃ§Ä±k)
      const eksik = await fetchEksikler({dateStr, status:'acik'});

      return { date: dateStr, temizlik: tk, genel, detay, eksik };
    }

 /* ===== Talebe SayÄ±larÄ± (deÄŸiÅŸmedi) ===== */
  async function loadTalebeStats(){
    try{
      const snap = await db.collection('talebeler').get();
      let toplam=0, ensar=0, muhacir=0;
      snap.forEach(doc=>{
        toplam++;
        const d=doc.data()||{};
        const durum=String(d.durum||'').toLowerCase();
        if(durum==='ensar') ensar++;
        else if(durum==='muhacir') muhacir++;
      });
      document.getElementById('kpiTalebe').textContent = toplam;
      document.getElementById('kpiEnsar').textContent  = ensar;
      document.getElementById('kpiMuhacir').textContent= muhacir;
    }catch(e){ console.error(e); }
  }

  /* ===== Talebe Temizlik PuanÄ± (BugÃ¼n) â€“ kat kat + genel ortalama ===== */
  async function loadTalebeTemizlik(){
    const dateStr = todayStrTR();
    const listEl = document.getElementById("talebeTemizlikTop5");
    const kpiEl  = document.getElementById("kpiTalebeTemizlikOrt");
    listEl.innerHTML = '';

    try{
      const data = await buildTemizlikDashboard({kats: KATLAR, dateStr});
      // KPI: temizlik_kontrol aÄŸÄ±rlÄ±klÄ± ortalama (0â€“100)
      kpiEl.textContent = Number.isFinite(data.temizlik.ortalamaPuan) ? data.temizlik.ortalamaPuan.toFixed(1) : '--';

      // Liste: her kat iÃ§in ortalama + kapsama bilgisi
      data.temizlik.katlar
        .slice() // kopya
        .sort((a,b)=> (b.ortalama||0)-(a.ortalama||0))
        .forEach(r=>{
          const kaps = (r.kapsama!=null) ? Math.round((r.kapsama*100))+'%' : 'â€”';
          const el=document.createElement('div'); el.className='list-item';
          el.innerHTML = `<div><strong>${r.kat}</strong><div class="sub" style="font-size:12px;color:var(--muted)">KayÄ±t: ${r.kayitli}/${r.toplam} â€¢ Kapsama: ${kaps}</div></div><div>${(Number.isFinite(r.ortalama)? r.ortalama.toFixed(1): 'â€”')}</div>`;
          listEl.appendChild(el);
        });
    }catch(e){
      console.error(e);
      kpiEl.textContent='--';
      listEl.innerHTML='<div class="muted">Veri yÃ¼klenemedi.</div>';
    }
  }

  /* ===== Genel Temizlik (bugÃ¼n) â€“ ÅŸimdilik tamamÄ± â€œ-â€ ===== */
  async function loadGenelTemizlik(){
    const dateStr = todayStrTR();
    const kpi = document.getElementById("kpiGenelTemizlikOrt");
    const cont = document.getElementById("katOrtList");
    cont.innerHTML='';

    try{
      const data = await buildTemizlikDashboard({kats: KATLAR, dateStr});
      // KPI: genel avgPuan100 (0â€“100)
      kpi.textContent = Number.isFinite(data.genel.avgPuan100) ? data.genel.avgPuan100 : '--';

      // Liste: kat bazÄ±nda avg + submissions
      data.genel.katlar
        .slice()
        .sort((a,b)=> (b.avgPuan100||0) - (a.avgPuan100||0))
        .forEach(r=>{
          const el=document.createElement('div'); el.className='list-item';
          el.innerHTML = `<div><strong>${r.kat}</strong><div class="sub" style="font-size:12px;color:var(--muted)">Form: ${r.submissions} â€¢ ${r.eksikAny?'Eksik var':'Tam'}</div></div><div>${(r.avgPuan100??'â€”')}</div>`;
          cont.appendChild(el);
        });
    }catch(e){
      console.error(e);
      kpi.textContent='--';
      cont.innerHTML='<div class="muted">Veri yÃ¼klenemedi.</div>';
    }
  }

  /* ===== Alacak Raporu: toplam, 2024, 2025 ===== */
async function loadAlacak(){
  const years = [2024, 2025];
  const tidy   = s => (s||'').toString().trim().replace(/\s+/g,' ');
  const normTR = s => tidy(s).toLocaleLowerCase('tr-TR');

  // Verileri al
  const [tSnap, sSnap] = await Promise.all([
    db.collection('tahakkuklar').get(),
    db.collection('tahsilatlar').get()
  ]);

  // Tahakkuk indeksleri
  const tahById   = new Map();                     // id -> tahakkuk doc
  const keyToId   = new Map();                     // "yil||faaliyet||personel||borclu" -> tahakkuk id
  const yearTah   = Object.fromEntries(years.map(y=>[y,0]));
  const yearThs   = Object.fromEntries(years.map(y=>[y,0]));

  tSnap.forEach(doc=>{
    const v = doc.data()||{};
    const y = Number(v.yil);
    const tahakkuk = Number(v.tahakkuk||0);
    tahById.set(doc.id, v);
    const key = `${y}||${normTR(v.faaliyet)}||${normTR(v.personel)}||${normTR(v.borclu)}`;
    keyToId.set(key, doc.id);
    if (years.includes(y)) yearTah[y] += tahakkuk;
  });

  // TahsilatÄ± sadece eÅŸleÅŸirse say: Ã¶nce id, yoksa composite key
  sSnap.forEach(doc=>{
    const v = doc.data()||{};
    let tahYear = null;

    if (v.tahakkukId && tahById.has(v.tahakkukId)) {
      tahYear = Number(tahById.get(v.tahakkukId).yil);
    } else {
      const y  = Number(v.yil) || (toDate(v.tarih)?.getFullYear());
      const k  = `${y}||${normTR(v.faaliyet)}||${normTR(v.personel)}||${normTR(v.borclu)}`;
      const tk = keyToId.get(k);
      if (tk && tahById.has(tk)) tahYear = Number(tahById.get(tk).yil);
    }

    if (years.includes(tahYear)) yearThs[tahYear] += Number(v.tutar||0);
  });

  // YazdÄ±r
  const totalTah = years.reduce((s,y)=>s+yearTah[y],0);
  const totalThs = years.reduce((s,y)=>s+yearThs[y],0);
  document.getElementById('nispetToplam').textContent = totalTah ? (totalThs/totalTah*100).toFixed(1)+'%' : '--%';
  document.getElementById('nispet2024').textContent   = yearTah[2024] ? (yearThs[2024]/yearTah[2024]*100).toFixed(1)+'%' : '--%';
  document.getElementById('nispet2025').textContent   = yearTah[2025] ? (yearThs[2025]/yearTah[2025]*100).toFixed(1)+'%' : '--%';
}

  /* ===== AylÄ±k performans: Topâ€‘3 (yÃ¼zde) & 0% =====
     - YÃ¼zde = (personelin bu ayki tahsilatÄ±) / (aynÄ± yÄ±ldaki toplam tahakkuku) * 100
  */
async function loadAylik(){
  const tidy   = s => (s||'').toString().trim().replace(/\s+/g,' ');
  const normTR = s => tidy(s).toLocaleLowerCase('tr-TR');

  const now = new Date();
  const { start, end } = (()=>{
    const s = new Date(now.getFullYear(), now.getMonth(), 1);
    const e = new Date(now); e.setHours(23,59,59,999); // ayÄ±n bugÃ¼ne kadarki kÄ±smÄ±
    return { start:s, end:e };
  })();
  const yil = now.getFullYear();
  document.getElementById('ayTop3').textContent     = monthsTR[now.getMonth()]+' AyÄ±';
  document.getElementById('ayTop3Tutar').textContent= monthsTR[now.getMonth()]+' AyÄ±'; // ğŸ†•
  document.getElementById('ayZero').textContent     = monthsTR[now.getMonth()]+' AyÄ±';

  // Veriler
  const [tSnapYear, tSnapAll, sSnap] = await Promise.all([
    db.collection('tahakkuklar').where('yil','==',yil).get().catch(_=>db.collection('tahakkuklar').get()),
    db.collection('tahakkuklar').get(),   // tÃ¼m yÄ±llar
    db.collection('tahsilatlar').get()
  ]);

  // Haritalar
  const tahById = new Map();      // id -> tahakkuk doc (sadece bu yÄ±l)
  const keyToId = new Map();      // eÅŸleÅŸtirme iÃ§in composit key (bu yÄ±l)
  const annualTah  = new Map();   // bu yÄ±l kiÅŸi bazÄ±nda
  const overallTah = new Map();   // tÃ¼m yÄ±llar kiÅŸi bazÄ±nda
  const displayName = new Map();  // gÃ¶sterim adÄ±

      // BU YIL tahakkuklarÄ±
  tSnapYear.forEach(doc=>{
    const t = doc.data()||{};
    if (Number(t.yil) !== yil) return;
    tahById.set(doc.id, t);
    const k = `${yil}||${normTR(t.faaliyet)}||${normTR(t.personel||t.personelAd||t.sorumlu||'')}||${normTR(t.borclu)}`;
    keyToId.set(k, doc.id);
    const pName = coalesceName(t);
    const pk    = nameKey(pName);
    annualTah.set(pk, (annualTah.get(pk)||0) + Number(t.tahakkuk||0));
    displayName.set(pk, pName);
  });

  // TÃœM YILLAR tahakkuklarÄ±
  tSnapAll.forEach(doc=>{
    const t = doc.data()||{};
    const pName = coalesceName(t);
    const pk    = nameKey(pName);
    overallTah.set(pk, (overallTah.get(pk)||0) + Number(t.tahakkuk||0));
    if (!displayName.has(pk)) displayName.set(pk, pName);
  });

  // Bu ayki tahsilatlar (sadece eÅŸleÅŸenler, ve eÅŸleÅŸtiÄŸi tahakkukun PERSONEL'ine yaz)
  const monthlyTh = new Map();           // personKey -> bu ay tahsilat
  sSnap.forEach(doc=>{
    const v = doc.data()||{};
    const dt = toDate(v.tarih);
    if (!dt || dt < start || dt > end) return;

    let tah = null;

    if (v.tahakkukId && tahById.has(v.tahakkukId)) {
      tah = tahById.get(v.tahakkukId);
    } else {
      const y = Number(v.yil) || (dt && dt.getFullYear());
      const k = `${y}||${normTR(v.faaliyet)}||${normTR(v.personel)}||${normTR(v.borclu)}`;
      const id = keyToId.get(k);
      if (id && tahById.has(id)) tah = tahById.get(id);
    }
    if (!tah || Number(tah.yil)!==yil) return;

    // Ä°SÄ°M: tah'da yoksa tahsilattan tamamla
    const pName = coalesceName(tah) !== 'â€”' ? coalesceName(tah) : coalesceName(v);
    const pk    = nameKey(pName);
    displayName.set(pk, pName);

    monthlyTh.set(pk, (monthlyTh.get(pk)||0) + Number(v.tutar||0));
  });

  // Top-3 (yÃ¼zde = aylÄ±k tahsilat / yÄ±llÄ±k tahakkuk)
    const rows = [...displayName.keys()].map(pk=>{
      const tahAll = overallTah.get(pk)||0;   // ğŸ†• tÃ¼m yÄ±llar
      const tahYr  = annualTah.get(pk)||0;    // istersen labelâ€™da gÃ¶stermek iÃ§in
      const th     = monthlyTh.get(pk)||0;    // bu ay tahsilat
      return {
        pk, name: displayName.get(pk)||pk,
        pct: (tahAll>0 ? (th/tahAll*100) : 0),  // ğŸ†• yÃ¼zde artÄ±k tÃ¼m yÄ±llara nispetle
        th, tahAll, tahYr
      };
    });

    // --- Top-3 (YÃœZDE) ---
    const top3Pct = document.getElementById('top3List'); top3Pct.innerHTML='';
    const topPct  = rows.filter(r=>r.pct>0).sort((a,b)=>b.pct-a.pct).slice(0,3);

    if (!topPct.length){
      top3Pct.innerHTML = '<div class="list-item"><div>Veri yok</div><div class="muted">â€”</div></div>';
    } else {
      topPct.forEach((r,i)=>{
        const el=document.createElement('div'); el.className='list-item';
        const w = Math.max(0, Math.min(100, r.pct));
        el.innerHTML = `
          <div style="flex:1">
            <div><span class="rank">${i+1}</span>${r.name}</div>
            <div class="meta">${r.pct.toFixed(1)}% â€¢ Toplam Alacak Tahak.: ${fmtTL(r.tahAll)}</div>
            <div class="bar"><span style="width:${w}%"></span></div>
          </div>
        `;
        top3Pct.appendChild(el);
      });
    }

    // --- ğŸ†• Top-3 (TUTAR) ---
    const top3Amt = document.getElementById('top3TutarList'); top3Amt.innerHTML='';
    const topAmt  = rows.filter(r=>r.th>0).sort((a,b)=>b.th-a.th).slice(0,3);

    if (!topAmt.length){
      top3Amt.innerHTML = '<div class="list-item"><div>Veri yok</div><div class="muted">â€”</div></div>';
    } else {
      topAmt.forEach((r,i)=>{
        // yÃ¼zdeyi "ToplamÄ±na nispetle" (tÃ¼m yÄ±llar) gÃ¶steriyoruz:
        const pctAll = (r.tahAll>0)? (r.th/r.tahAll*100) : 0;
        const w      = Math.max(0, Math.min(100, pctAll));
        const el=document.createElement('div'); el.className='list-item';
        el.innerHTML = `
          <div style="flex:1">
            <div><span class="rank">${i+1}</span>${r.name}</div>
            <div class="meta">${fmtTL(r.th)} â€¢ ${pctAll.toFixed(1)}%</div>
            <div class="bar"><span style="width:${w}%"></span></div>
          </div>
        `;
        top3Amt.appendChild(el);
      });
    }

    // --- 0% listesi ---
    const zero = document.getElementById('zeroList'); zero.innerHTML='';
    const zeros = rows
      .filter(r => r.tahAll > 0 && !monthlyTh.get(r.pk))  // ğŸŸ¢ bu yÄ±l tahakkuku olup ayda tahsilatÄ± yok
      .map(r => r.name)
      .sort();

    if (!zeros.length){
      zero.innerHTML = '<div class="list-item"><div>TÃ¼m personelde tahsilat var</div><div class="muted">â€”</div></div>';
    } else {
      zeros.forEach(n=>{
        const el=document.createElement('div'); el.className='list-item';
        el.innerHTML = `<div>${n}</div><div class="muted">0%</div>`;
        zero.appendChild(el);
      });
    }
    }

  /* ===== NÃ¶betÃ§i (09:00â†’09:00) nobet_planlari/{YYYY-Www} rows.tarihISO ile ===== */
  function isoWeekKey(d){
    // ISO haftasÄ±: PerÅŸembe bazlÄ±
    const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    const dayNum = (date.getUTCDay()+6)%7;
    date.setUTCDate(date.getUTCDate() - dayNum + 3);
    const firstThu = new Date(Date.UTC(date.getUTCFullYear(),0,4));
    const week = 1 + Math.round(((date - firstThu) / 86400000 - 3 + ((firstThu.getUTCDay()+6)%7)) / 7);
    const year = date.getUTCFullYear();
    return `${year}-W${String(week).padStart(2,'0')}`;
  }
  async function loadNobet(){
    const now=new Date();
    const nine=new Date(now.getFullYear(),now.getMonth(),now.getDate(),9,0,0,0);
    const bas=(now<nine)? new Date(nine.getTime()-86400000) : nine;
    const gunKey=bas.toISOString().slice(0,10);
    const haftaKey=isoWeekKey(bas);
    try{
      const doc=await db.collection("nobet_planlari").doc(haftaKey).get();
      if(doc.exists){
        const rows=(doc.data()||{}).rows||[];
        const r=rows.find(x=> String(x.tarihISO)===gunKey);
        if(r){
          document.getElementById("nobetEvli").textContent = r.evli || 'â€”';
          document.getElementById("nobetBekar").textContent= r.bekar|| 'â€”';
          return;
        }
      }
      // bulunamazsa boÅŸ bÄ±rak
      document.getElementById("nobetEvli").textContent = 'â€”';
      document.getElementById("nobetBekar").textContent= 'â€”';
    }catch(e){ console.error(e); }
  }
    /* ===== Teknik Eksikler (iskele) ===== */
  async function loadEksikler(){
    const dateStr = todayStrTR();
    const kpi=document.getElementById('kpiEksikSayisi');
    const list=document.getElementById('eksikList');
    if(!kpi || !list) return;
    list.innerHTML='';

    try{
      const ex = await fetchEksikler({dateStr, status:'acik'});
      kpi.textContent = ex.count || 0;

      if(ex.count===0){
        list.innerHTML='<div class="list-item"><div>BugÃ¼n aÃ§Ä±k eksik yok</div><div class="muted">â€”</div></div>';
        return;
      }

      // Ä°lk 6 kaydÄ±, "kat â€¢ parÃ§a sayÄ±sÄ±" ÅŸeklinde Ã¶zetle
      ex.list
        .slice(0,6)
        .forEach(v=>{
          const el=document.createElement('div'); el.className='list-item';
          const parc = (v.parcalar && v.parcalar.length)? ` â€¢ ${v.parcalar.length} madde` : '';
          el.innerHTML=`<div><strong>${v.kat}</strong>${parc}</div><div class="muted">${v.status.toUpperCase()}</div>`;
          list.appendChild(el);
        });
    }catch(e){
      console.error(e);
      kpi.textContent='--';
      list.innerHTML='<div class="muted">Eksikler yÃ¼klenemedi.</div>';
    }
  }

  /* ===== Bildirim rozet (aynÄ±) ===== */
  async function loadNotifications(){
    const badge=document.getElementById('notifBadge');
    const list =document.getElementById('notifList');
    list.innerHTML='';
    try{
      const snap = await db.collection('duyurular').orderBy('createdAt','desc').limit(5).get();
      const n = snap.size;
      if(n>0){ badge.style.display='block'; badge.textContent = n>99 ? '99+' : String(n); } else { badge.style.display='none'; }
      if(n===0){
        const empty=document.createElement('div'); empty.className='muted'; empty.style.padding='6px 8px'; empty.textContent='Yeni bildirim yok.'; list.appendChild(empty);
      }else{
        snap.forEach(doc=>{ const d=doc.data()||{}; const baslik=d.baslik||d.title||'Duyuru'; const detay=d.detay||d.desc||''; const row=document.createElement('a'); row.href='diger/bildirim.html'; row.innerHTML=`<strong>${baslik}</strong><div class="muted">${detay}</div>`; list.appendChild(row); });
      }
    }catch(e){ console.error(e); badge.style.display='none'; const err=document.createElement('div'); err.className='muted'; err.style.padding='6px 8px'; err.textContent='Bildirimler yÃ¼klenemedi.'; list.appendChild(err); }
  }

  /* Link guard â€“ yetkiye gÃ¶re (aynÄ±) */
  document.addEventListener('click', (e) => {
    const a = e.target.closest('a[data-key]');
    if (!a) return;
    const key = norm(a.dataset.key);
    const pnl = norm(a.dataset.panel || '');
    const pnlTitle = norm(a.dataset.panelTitle || '');
    if (CURRENT_DENY.has(key)) { e.preventDefault(); showToast('Bu sayfa iÃ§in yetkiniz yok.'); return; }
    const allowed = CURRENT_ALLOW.has(key) || CURRENT_ALLOW.has(pnl) || CURRENT_ALLOW.has(pnlTitle);
    if (!allowed) { e.preventDefault(); showToast('Bu sayfa iÃ§in yetkiniz yok.'); }
  });

  /* Auth akÄ±ÅŸÄ± */
  try{ firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL); }catch(e){}
  auth.onAuthStateChanged(async (user)=>{
    if(!user){
      setTimeout(()=>{ if(!auth.currentUser) location.replace('index.html'); },150);
      return;
    }
    try{
      setToday();
      const uSnap = await db.collection('kullanicilar').doc(user.uid).get();
      const data  = uSnap.exists ? uSnap.data() : {};
      document.getElementById('username').textContent = data.adSoyad || user.email || 'KullanÄ±cÄ±';
      document.getElementById('profName').textContent = data.adSoyad ? data.adSoyad.split(' ')[0] : 'Profil';

      // yetkiler
      const rawPerms = Array.isArray(data.yetkiler) ? data.yetkiler : [];
      CURRENT_ALLOW = new Set(rawPerms.filter(s=>!String(s).trim().startsWith('-') && !String(s).trim().startsWith('!')).map(norm));
      CURRENT_DENY  = new Set(rawPerms.filter(s=> String(s).trim().startsWith('-') || String(s).trim().startsWith('!')).map(s=>norm(String(s).replace(/^[-!]\s*/,''))));

      const panels = await fetchPanels(CURRENT_ALLOW, CURRENT_DENY);
      renderNav(panels);

    await Promise.all([
      loadAlacak(),
      loadAylik(),
      loadNobet(),
      loadNotifications(),
      loadTalebeStats(),
      loadTalebeTemizlik(),   // â†©ï¸ yeni sÃ¼rÃ¼m
      loadGenelTemizlik(),    // â†©ï¸ yeni sÃ¼rÃ¼m
      loadEksikler()          // â†©ï¸ fetchEksikler kullanan sÃ¼rÃ¼m
    ]);
    }catch(e){
      console.error(e);
      showToast('Veriler yÃ¼klenirken hata.');
    }
  });
  </script>
</body>
</html>
