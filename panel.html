<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>KaraaÄŸaÃ§ Fatih</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" type="image/png" href="./img/logo.png" />
  <link rel="stylesheet" href="./css/app-shell.css" />

  <style>
    :root{
      --appbar-h:56px;
      --radius:14px; --shadow:0 12px 28px rgba(0,0,0,.14);
      --bg:#0f172a; --bg2:#0b1324;
      --grad1:#0ea5e922; --grad2:#22d3ee22;
      --card:rgba(15,23,42,.92); --stroke:rgba(148,163,184,.18);
      --text:#e5e7eb; --muted:#9aa4b2;
      --brand:#38bdf8; --brand2:#0ea5e9;
      --pill:#0b1220; --pill-hover:#101a2b;
      --link:#c7e9ff; --surface:rgba(2,6,23,.08);
      --danger:#ef4444;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f5f5f0; --bg2:#fafaf5; --grad1:#e5e5e022; --grad2:#d4d4d022;
        --card:rgba(255,255,255,.95);
        --stroke:rgba(15,23,42,.12);
        --text:#0b1220; --muted:#4b5563; --brand:#0ea5e9; --brand2:#0284c7;
        --pill:#f5f5f0; --pill-hover:#e9e9e4; --link:#0b5ea8; --surface:#f0f0eb;
        --danger:#b91c1c; --good:#16a34a; --warn:#d97706;
      }
    }
    html[data-theme="dark"]{
      --bg:#0f172a; --bg2:#0b1324; --grad1:#0ea5e922; --grad2:#22d3ee22;
      --card:rgba(15,23,42,.92); --stroke:rgba(148,163,184,.18);
      --text:#e5e7eb; --muted:#9aa4b2; --brand:#38bdf8; --brand2:#0ea5e9;
      --pill:#0b1220; --pill-hover:#101a2b; --link:#c7e9ff; --surface:rgba(2,6,23,.08);
      --danger:#ef4444; --good:#22c55e; --warn:#f59e0b;
    }
    html[data-theme="light"]{
      --bg:#f5f5f0; --bg2:#fafaf5; --grad1:#e5e5e022; --grad2:#d4d4d022;
      --card:rgba(255,255,255,.95); --stroke:rgba(15,23,42,.12);
      --text:#0b1220; --muted:#4b5563; --brand:#0ea5e9; --brand2:#0284c7;
      --pill:#f5f5f0; --pill-hover:#e9e9e4; --link:#0b5ea8; --surface:#f0f0eb;
      --danger:#b91c1c; --good:#16a34a; --warn:#d97706;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; 
      padding:0;
      padding-top:var(--appbar-h) !important; /* Ãœst panel iÃ§in boÅŸluk */
      color:var(--text);
      font-family:ui-sans-serif,-apple-system,"Segoe UI",Roboto,Arial;
      background: var(--bg);
      overflow-x:hidden; word-wrap:break-word;
    }
    a{color:var(--link); text-decoration:none}
    a:hover{text-decoration:underline}

    /* APPBAR - app-shell.css'den gelen stiller kullanÄ±lÄ±yor, burada sadece Ã¶zel override'lar */
    .appbar{
      position:fixed !important; 
      top:0 !important; 
      left:0 !important;
      right:0 !important;
      z-index:60 !important;
    }
    .nav-center{margin:0 auto; height:100%}
    .avatar{width:22px;height:22px;border-radius:999px;background:linear-gradient(180deg,#94a3b8,#64748b);display:inline-block}

    /* CONTENT */
    .container{max-width:1400px; margin:0 auto; padding:20px}
    .hero{
      display:flex; justify-content:space-between; align-items:flex-start; gap:20px;
      background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius);
      padding:24px; margin:20px 0; box-shadow:var(--shadow);
      position:relative; overflow:hidden;
    }
    .hero::before{
      content:''; position:absolute; top:0; right:0; width:200px; height:200px;
      background:radial-gradient(circle, var(--grad1), transparent 70%);
      opacity:0.3; pointer-events:none;
    }
    .hero h2{margin:0 0 8px; font-size:24px; font-weight:800; background:linear-gradient(135deg, var(--brand), var(--brand2)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text}
    .hero-sub{color:var(--muted); font-size:14px; margin-top:4px}
    .hero-actions{display:flex; gap:8px; flex-wrap:wrap}

    .grid{display:grid; gap:18px; grid-template-columns:repeat(12, minmax(0,1fr))}
    .col-4{grid-column:span 4} .col-12{grid-column:span 12}
    .card{
      background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius);
      box-shadow:var(--shadow); padding:18px; transition:all 0.3s ease;
      position:relative; overflow:hidden;
    }
    .card::before{
      content:''; position:absolute; top:0; left:0; right:0; height:3px;
      background:linear-gradient(90deg, var(--brand), var(--brand2));
      opacity:0; transition:opacity 0.3s;
    }
    .card:hover{
      transform:translateY(-2px); box-shadow:0 16px 32px rgba(0,0,0,.18);
      border-color:var(--brand);
    }
    .card:hover::before{opacity:1}
    .card h3{
      margin:0 0 16px; font-size:17px; font-weight:700;
      display:flex; align-items:center; gap:8px;
      color:var(--text);
    }
    .card h3::before{
      content:''; width:4px; height:20px; background:var(--brand);
      border-radius:2px; display:inline-block; flex-shrink:0;
    }
    .card h3 span{display:flex; align-items:center; gap:8px; flex:1}
    .kpi{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:16px; border-radius:14px; border:1px solid var(--stroke);
      background:linear-gradient(135deg, var(--surface), transparent);
      transition:all 0.2s; position:relative; overflow:hidden;
    }
    .kpi::before{
      content:''; position:absolute; top:0; left:0; width:100%; height:100%;
      background:radial-gradient(circle at top right, var(--grad1), transparent 60%);
      opacity:0; transition:opacity 0.3s;
    }
    .kpi:hover{transform:scale(1.02); border-color:var(--brand)}
    .kpi:hover::before{opacity:1}
    .kpi .val{font-size:26px; font-weight:900; color:var(--brand); position:relative; z-index:1}
    .kpi .sub{font-size:12px; color:var(--muted); position:relative; z-index:1; font-weight:600}
    .kpi > div:last-child{font-size:32px; opacity:0.6; position:relative; z-index:1; filter:drop-shadow(0 2px 4px rgba(0,0,0,.1))}
    .list{display:grid; gap:8px}
    .list-item{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:12px 14px; border-radius:10px; border:1px solid var(--stroke);
      background:var(--surface); transition:all 0.2s;
    }
    .list-item:hover{
      background:var(--pill-hover); transform:translateX(4px);
      border-color:var(--brand);
    }
    .list-item strong{color:var(--text); font-weight:700}
    
    /* Loading states */
    .card-loading{position:relative; opacity:0.6; pointer-events:none}
    .card-loading::after{content:''; position:absolute; top:0; left:0; right:0; bottom:0; background:var(--card); border-radius:var(--radius); display:flex; align-items:center; justify-content:center; z-index:10}
    .card-loading::before{content:'â³'; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); z-index:11; font-size:24px; animation:spin 1s linear infinite}
    @keyframes spin{from{transform:translate(-50%,-50%) rotate(0deg)} to{transform:translate(-50%,-50%) rotate(360deg)}}
    .card-error{border-color:var(--danger)!important; opacity:0.8}
    .card-error::before{content:'âš ï¸'; position:absolute; top:8px; right:8px; font-size:18px; z-index:5}

    /* Toast - app-shell.css'den geliyor */
    .page-gap{height:160px}

    /* Animasyonlar */
    @keyframes fadeInUp{
      from{opacity:0; transform:translateY(20px)}
      to{opacity:1; transform:translateY(0)}
    }
    .card{animation:fadeInUp 0.4s ease-out}
    .card:nth-child(1){animation-delay:0.1s}
    .card:nth-child(2){animation-delay:0.2s}
    .card:nth-child(3){animation-delay:0.3s}
    .card:nth-child(4){animation-delay:0.4s}
    .card:nth-child(5){animation-delay:0.5s}
    .card:nth-child(6){animation-delay:0.6s}
    .card:nth-child(7){animation-delay:0.7s}
    .card:nth-child(8){animation-delay:0.8s}
    .card:nth-child(9){animation-delay:0.9s}

    @media (max-width: 960px){
      .col-4{grid-column:span 12}
      .hero{flex-direction:column; padding:18px}
      .hero h2{font-size:20px}
      .nav-center{display:none}
      .hamb{display:inline-flex}
      .container{padding:12px}
      .card{padding:14px}
      .kpi .val{font-size:22px}
    }
    @media (max-width: 640px){
      .hero{padding:14px; margin:12px 0}
      .hero h2{font-size:18px}
      .hero-sub{font-size:12px}
      .card h3{font-size:15px}
      .kpi{padding:12px}
      .kpi .val{font-size:20px}
      .list-item{padding:10px}
    }
    /* --- Top-3 kartlarÄ± iÃ§in ufak gÃ¶rsel dokunuÅŸlar --- */
    .rank{
      min-width:32px;height:32px;display:inline-flex;align-items:center;justify-content:center;
      border-radius:999px;border:2px solid var(--brand);background:linear-gradient(135deg, var(--brand), var(--brand2));
      font-weight:900;margin-right:10px;color:#fff;font-size:14px;
      box-shadow:0 2px 8px rgba(14,165,233,.3);
    }
    .rank.rank-1{background:linear-gradient(135deg, #fbbf24, #f59e0b); border-color:#f59e0b; box-shadow:0 2px 8px rgba(245,158,11,.4)}
    .rank.rank-2{background:linear-gradient(135deg, #94a3b8, #64748b); border-color:#64748b; box-shadow:0 2px 8px rgba(100,116,139,.3)}
    .rank.rank-3{background:linear-gradient(135deg, #cd7f32, #a0522d); border-color:#a0522d; box-shadow:0 2px 8px rgba(160,82,45,.3)}
    .amount{font-weight:800; color:var(--brand)}
    .meta{font-size:13px;color:var(--muted); margin-top:2px}
    .bar{height:8px;border-radius:999px;background:var(--surface);overflow:hidden;margin-top:8px; position:relative}
    .bar>span{
      display:block;height:100%;background:linear-gradient(90deg,var(--brand),var(--brand2));
      width:0; transition:width 0.6s ease; border-radius:999px;
      box-shadow:0 0 8px rgba(14,165,233,.4);
    }
/* Devre seÃ§ici (baÅŸlÄ±k iÃ§inde metin gibi) */
.devre-pill{
  display:inline-flex; align-items:center; gap:6px;
  font-weight:800; cursor:pointer; user-select:none;
  padding:2px 6px; border-radius:8px;
}
.devre-pill::after{ content:"â–¾"; font-size:12px; opacity:.7; }
.devre-pill:hover{ background:var(--surface); }

.devre-dd{
  position:absolute; margin-top:6px; padding:6px;
  background:var(--card); border:1px solid var(--stroke);
  border-radius:10px; box-shadow:var(--shadow); z-index:30;
}
#statHdr{ position:relative; }
.devre-dd button{
  display:block; width:100%; text-align:left;
  background:transparent; border:none; color:var(--text);
  padding:8px 10px; border-radius:8px; cursor:pointer; font-weight:700;
}
.devre-dd button:hover{ background:var(--surface); }
.devre-dd .active{ background:var(--surface); }
  </style>

  <!-- Supabase (Auth + Database iÃ§in) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="src/supabase.js"></script>
  <script src="src/supabase-auth-wrapper.js"></script>
  <script src="src/supabase-db-wrapper.js"></script>
  
  <!-- NOT: ortak.js kaldÄ±rÄ±ldÄ± - panel.html kendi kodunu kullanÄ±yor, ortak.js sadece Ã§akÄ±ÅŸma yaratÄ±yordu -->
</head>
<body>

  <!-- APPBAR -->
  <div class="appbar">
    <div class="brand" onclick="location.href='panel.html'">
      <img src="./img/logo.png" alt="logo"><span>KARAAÄAÃ‡ FATÄ°H</span>
    </div>

    <nav class="nav-center"><ul class="nav-list" id="navMain"></ul></nav>

    <div class="nav-right">
      <button class="btn hamb" id="hamburger" title="MenÃ¼">â˜°</button>

      <!-- Bildirim -->
      <div class="nav-item">
        <button class="iconbtn" id="btnNotif" title="Bildirimler">ğŸ””
          <span class="badge" id="notifBadge" style="display:none">0</span>
        </button>
        <div class="dropdown drop-right" id="notifDropdown" aria-label="Bildirim listesi">
          <div class="muted" style="padding:6px 8px">Son bildirimler</div>
          <div id="notifList" class="list" style="max-height:300px;overflow:auto"></div>
          <a href="diger/bildirim.html">TÃ¼m bildirimleri gÃ¶r â†’</a>
        </div>
      </div>

      <!-- Profil -->
      <div class="nav-item">
        <button class="iconbtn" id="btnProfile" title="Profil">
          <span id="profName" class="muted">Profil</span>
        </button>
        <div class="dropdown drop-right" id="profDropdown" aria-label="Profil menÃ¼sÃ¼">
          <a href="diger/kullanici-yonetimi.html">ğŸ‘¤ Profil</a>
          <a href="diger/sistem-ayarlari.html">âš™ï¸ Sistem AyarlarÄ±</a>
          <a href="#" id="btnLogout">ğŸšª Ã‡Ä±kÄ±ÅŸ Yap</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Mobil Ã§ekmece -->
  <aside class="drawer" id="drawer"></aside>

  <!-- CONTENT -->
  <main class="container">
    <section class="hero">
      <div style="flex:1">
        <h2>HoÅŸ Geldiniz, <span id="username" style="color:var(--brand)">â€”</span></h2>
        <div class="hero-sub">ğŸ“… BugÃ¼n: <span id="todayText">â€”</span></div>
        <div class="hero-actions" style="margin-top:12px">
        </div>
      </div>
    </section>

    <div class="grid">
      <!-- Talebe istatistiÄŸi -->
      <div class="card col-4" style="background:linear-gradient(135deg, var(--card), color-mix(in oklab, var(--card) 90%, var(--brand) 10%))">
        <h3 id="statHdr" style="margin-bottom:16px">
          <span>ğŸ‘¥ Talebe Ä°statistiÄŸi</span>
          <span id="devreBtn" class="devre-pill" role="button" aria-haspopup="listbox" aria-expanded="false" style="margin-left:auto; font-size:13px">â€”</span>
          <div id="devreDd" class="devre-dd" hidden role="listbox" aria-label="Devre seÃ§imi"></div>
        </h3>
        <div class="kpi" style="background:linear-gradient(135deg, rgba(14,165,233,.1), transparent)">
          <div><div class="val" id="kpiTalebe" style="font-size:28px">--</div><div class="sub">Toplam Talebe</div></div>
          <div style="font-size:36px">ğŸ‘¥</div>
        </div>
        <div class="kpi" style="margin-top:12px; background:linear-gradient(135deg, rgba(34,197,94,.1), transparent)">
          <div><div class="val" style="font-size:22px"><span id="kpiEnsar" style="color:var(--good)">--</span> / <span id="kpiMuhacir" style="color:var(--warn)">--</span></div><div class="sub">Ensar / Muhacir</div></div>
          <div style="font-size:32px">ğŸ“˜</div>
        </div>
      </div>

            <!-- NÃ¶betÃ§i -->
      <div class="card col-4" style="background:linear-gradient(135deg, var(--card), color-mix(in oklab, var(--card) 90%, #f59e0b 10%))">
        <h3><span>ğŸ• NÃ¶betÃ§i (09:00 â†’ 09:00)</span></h3>
        <div class="list" style="margin-top:12px">
          <div class="list-item" style="background:linear-gradient(135deg, rgba(14,165,233,.08), transparent)">
            <div style="display:flex; align-items:center; gap:8px">
              <span style="font-size:18px">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</span>
              <div><strong>Evli</strong></div>
            </div>
            <div id="nobetEvli" style="font-weight:800; color:var(--brand); font-size:16px">â€”</div>
          </div>
          <div class="list-item" style="background:linear-gradient(135deg, rgba(245,158,11,.08), transparent)">
            <div style="display:flex; align-items:center; gap:8px">
              <span style="font-size:18px">ğŸ‘¤</span>
              <div><strong>Bekar</strong></div>
            </div>
            <div id="nobetBekar" style="font-weight:800; color:var(--warn); font-size:16px">â€”</div>
          </div>
        </div>
      </div>

            <!-- Alacak Raporu -->
      <div class="card col-4" style="background:linear-gradient(135deg, var(--card), color-mix(in oklab, var(--card) 90%, #22c55e 10%))">
        <h3><span>ğŸ’° Alacak Raporu</span></h3>
        <div class="kpi" style="background:linear-gradient(135deg, rgba(34,197,94,.1), transparent)">
          <div><div class="val" id="nispetToplam" style="font-size:24px; color:var(--good)">--%</div><div class="sub">Toplam Tahsilat Nisp.</div></div>
          <div style="font-size:32px">ğŸ“ˆ</div>
        </div>
        <div class="kpi" style="margin-top:12px; background:linear-gradient(135deg, rgba(14,165,233,.08), transparent)">
          <div><div class="val" id="nispet2024" style="font-size:20px">--%</div><div class="sub">2024 Tahsilat Nisp.</div></div>
          <div style="font-size:28px">ğŸ“†</div>
        </div>
        <div class="kpi" style="margin-top:12px; background:linear-gradient(135deg, rgba(14,165,233,.08), transparent)">
          <div><div class="val" id="nispet2025" style="font-size:20px">--%</div><div class="sub">2025 Tahsilat Nisp.</div></div>
          <div style="font-size:28px">ğŸ“†</div>
        </div>
      </div>

      <!-- Talebe temizlik puanÄ± (bugÃ¼n) -->
      <div class="card col-4" style="background:linear-gradient(135deg, var(--card), color-mix(in oklab, var(--card) 90%, #38bdf8 10%))">
        <h3><span>ğŸ§½ Talebe Temizlik PuanÄ±</span></h3>
        <div class="kpi" style="background:linear-gradient(135deg, rgba(56,189,248,.1), transparent)">
          <div><div class="val" id="kpiTalebeTemizlikOrt" style="font-size:28px">--</div><div class="sub">GÃ¼nlÃ¼k Ortalama</div></div>
          <div style="font-size:36px">ğŸ§½</div>
        </div>
        <div class="list" id="talebeTemizlikTop5" style="margin-top:12px"></div>
      </div>

      <!-- Genel temizlik puanÄ± (bugÃ¼n â€“ kat bazlÄ±) -->
      <div class="card col-4" style="background:linear-gradient(135deg, var(--card), color-mix(in oklab, var(--card) 90%, #22c55e 10%))">
        <h3><span>ğŸ§¹ Genel Temizlik PuanÄ±</span></h3>
        <div class="kpi" style="background:linear-gradient(135deg, rgba(34,197,94,.1), transparent)">
          <div><div class="val" id="kpiGenelTemizlikOrt" style="font-size:28px">--</div><div class="sub">TÃ¼m Katlar Ortalama</div></div>
          <div style="font-size:36px">ğŸ§¹</div>
        </div>
        <div class="list" id="katOrtList" style="margin-top:12px"></div>
      </div>

      <!-- Teknik Eksikler (bugÃ¼n â€“ kat bazlÄ±) -->
      <div class="card col-4" style="background:linear-gradient(135deg, var(--card), color-mix(in oklab, var(--card) 90%, #ef4444 10%))">
        <h3><span>ğŸ› ï¸ Teknik Eksikler</span></h3>
        <div class="kpi" style="background:linear-gradient(135deg, rgba(239,68,68,.1), transparent)">
          <div><div class="val" id="kpiEksikSayisi" style="font-size:28px; color:var(--danger)">--</div><div class="sub">BugÃ¼n Toplam Eksik</div></div>
          <div style="font-size:36px">ğŸ› ï¸</div>
        </div>
        <div class="list" id="eksikList" style="margin-top:12px"></div>
      </div>

      <!-- AylÄ±k Top-3 (YÃ¼zde) -->
      <div class="card col-4" style="background:linear-gradient(135deg, var(--card), color-mix(in oklab, var(--card) 90%, #f59e0b 10%))">
        <h3><span>ğŸ† <span id="ayTop3">AÄŸustos AyÄ±</span> â€¢ En Fazla Tahsilat (YÃ¼zde)</span></h3>
        <div class="list" id="top3List" style="margin-top:12px"></div>
      </div>

      <!-- ğŸ†• AylÄ±k Top-3 (Tutar) -->
      <div class="card col-4" style="background:linear-gradient(135deg, var(--card), color-mix(in oklab, var(--card) 90%, #22c55e 10%))">
        <h3><span>ğŸ’µ <span id="ayTop3Tutar">AÄŸustos AyÄ±</span> â€¢ En Fazla Tahsilat (Tutar)</span></h3>
        <div class="list" id="top3TutarList" style="margin-top:12px"></div>
      </div>

      <!-- AylÄ±k HiÃ§ Tahsilat Yok -->
      <div class="card col-4" style="background:linear-gradient(135deg, var(--card), color-mix(in oklab, var(--card) 90%, #ef4444 10%))">
        <h3><span>âš ï¸ <span id="ayZero">AÄŸustos AyÄ±</span> â€¢ HiÃ§ Tahsilat Yapmayanlar</span></h3>
        <div class="list" id="zeroList" style="margin-top:12px"></div>
      </div>
    </div>

    <div class="page-gap"></div>
  </main>

  <div class="toast-container" id="toastContainer"></div>

  <script>
    /* Tema */
    (function(){
      const root=document.documentElement;
      const saved=localStorage.getItem('kf_theme')||'auto';
      apply(saved);
      function apply(mode){
        localStorage.setItem('kf_theme',mode);
        const sysDark=()=>window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches;
        const eff=(mode==='auto')?(sysDark()?'dark':'light'):mode;
        root.setAttribute('data-theme',eff);
      }
      if(window.matchMedia){
        const m=window.matchMedia('(prefers-color-scheme: dark)');
        m.addEventListener?.('change',()=>{ if((localStorage.getItem('kf_theme')||'auto')==='auto') apply('auto'); });
      }
    })();

    /* Helpers & Supabase Auth */
    const auth = window.getSupabaseAuth ? window.getSupabaseAuth() : null;
    if (!auth) {
      console.error('Supabase Auth yÃ¼klenemedi');
    }
    // Supabase client (direkt eriÅŸim iÃ§in)
    const getSupabase = () => window.supabase;
    
    // XSS korumasÄ± - HTML escape
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function setToday(){const d=new Date(); const days=['Pazar','Pazartesi','SalÄ±','Ã‡arÅŸamba','PerÅŸembe','Cuma','Cumartesi']; document.getElementById('todayText').textContent=`${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()} â€¢ ${days[d.getDay()]}`;}
    // norm fonksiyonu - string normalizasyonu (TÃ¼rkÃ§e karakterleri kaldÄ±rÄ±r, kÃ¼Ã§Ã¼k harfe Ã§evirir)
    // NOT: ortak.js kaldÄ±rÄ±ldÄ±, burada direkt tanÄ±mlÄ±yoruz
    function norm(s) {
      return String(s || '').normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase().trim();
    }
    // window.norm'u da tanÄ±mla (diÄŸer sayfalar iÃ§in)
    if (typeof window.norm === 'undefined') {
      window.norm = norm;
    }
    
    // Kart loading state yÃ¶netimi
    function setCardLoading(elementId, isLoading){
      const el = document.getElementById(elementId);
      if(!el) return;
      const card = el.closest('.card');
      if(!card) return;
      if(isLoading){
        card.classList.add('card-loading');
        card.classList.remove('card-error');
      } else {
        card.classList.remove('card-loading');
      }
    }
    function setCardError(elementId, hasError){
      const el = document.getElementById(elementId);
      if(!el) return;
      const card = el.closest('.card');
      if(!card) return;
      if(hasError){
        card.classList.add('card-error');
      } else {
        card.classList.remove('card-error');
      }
    }

    /* Yetki setleri - ortak.js'den geliyor */
    // window.CURRENT_ALLOW ve window.CURRENT_DENY ortak.js'den geliyor
    // Bu deÄŸiÅŸkenler window Ã¼zerinden eriÅŸilecek, burada tanÄ±mlamaya gerek yok

    /* ====== MenÃ¼ manifesti (deÄŸiÅŸmedi) ====== */
    // Path normalizasyonu - ortak.js'den geliÅŸtirilmiÅŸ versiyon
    function normalizeUrl(u) {
      if (!u || u === '#') return '#';
      // GÃ¼venlik: Sadece gÃ¼venli protokoller
      if (/^https?:\/\//i.test(u)) {
        try {
          const url = new URL(u);
          if (url.hostname === 'localhost' || url.hostname === '127.0.0.1' || url.hostname.endsWith(window.location.hostname)) {
            return u;
          }
          console.warn('External URL detected:', u);
          return '#';
        } catch (e) {
          return '#';
        }
      }
      if (u.startsWith('//')) return '#';
      // Zaten relative path ise olduÄŸu gibi dÃ¶ndÃ¼r
      if (u.startsWith('../') || u.startsWith('./')) {
        return u;
      }
      // Absolute path ise
      if (u.startsWith('/')) {
        return u;
      }
      // Relative path iÃ§in current directory'den hesapla
      const currentPath = location.pathname;
      const currentDir = currentPath.substring(0, currentPath.lastIndexOf('/'));
      const currentDepth = currentDir.split('/').filter(x => x).length;
      const upLevels = currentDepth > 0 ? '../'.repeat(currentDepth) : '';
      return upLevels + u;
    }
    
    // Global yetki kontrolÃ¼
    function hasGlobalAllow(allowSet) {
      return allowSet.has('*') || allowSet.has('all') || allowSet.has('full') || allowSet.has('admin');
    }
    
    // Sayfa yetki kontrolÃ¼ (wildcard desteÄŸi ile)
    function pageAllowed(panelTitle, pageKey, allowSet, denySet) {
      // Global yetki varsa tÃ¼m sayfalar eriÅŸilebilir
      if (hasGlobalAllow(allowSet)) return true;
      
      const k = norm(pageKey || '');
      const p = norm(panelTitle || '');
      
      // Reddedilen sayfa kontrolÃ¼
      if (k && denySet.has(k)) return false;
      if (p && denySet.has(p)) return false;
      
      // Direkt yetki kontrolÃ¼
      if (k && allowSet.has(k)) return true;
      if (p && allowSet.has(p)) return true;
      
      // Wildcard yetki kontrolÃ¼ (Ã¶rn: "personel:*" -> "personel:temizlik" eriÅŸimi)
      for (const perm of allowSet) {
        if (perm.endsWith(':*')) {
          const prefix = perm.slice(0, -2);
          if (k.startsWith(prefix + ':') || p.startsWith(prefix + ':')) return true;
        }
      }
      
      return false;
    }
    
    async function fetchPanels(allowSet, denySet){
      const res=[];
    try{
      const supabase = getSupabase();
      if (!supabase) {
        console.error('âŒ Supabase client yÃ¼klenmedi');
        throw new Error('Supabase client yÃ¼klenmedi');
      }
      
      // Supabase client kontrolÃ¼
      if (!supabase.from) {
        console.error('âŒ Supabase client eksik: from() metodu bulunamadÄ±');
        throw new Error('Supabase client dÃ¼zgÃ¼n yÃ¼klenmedi');
      }
      
      console.log('âœ… Supabase client hazÄ±r');
        
        // Sayfa manifestini yÃ¼kle (kullanicilar ve sayfa_manifesti tablolarÄ±ndan)
        const { data: panels, error } = await supabase
          .from('sayfa_manifesti')
          .select('id, order, title, pages')
          .order('order', { ascending: true, nullsFirst: false });
        
        if (error) {
          console.error('âŒ sayfa_manifesti okunamadÄ±:', {
            code: error.code,
            message: error.message,
            details: error.details,
            hint: error.hint,
            error: error
          });
          
          // RLS hatasÄ± kontrolÃ¼
          if (error.code === '42501' || error.message?.includes('permission denied') || error.message?.includes('RLS')) {
            console.error('ğŸ”’ RLS (Row Level Security) hatasÄ±: sayfa_manifesti tablosu iÃ§in RLS politikasÄ± gerekli!');
            console.error('ğŸ’¡ Ã‡Ã¶zÃ¼m: Supabase Dashboard > Authentication > Policies > sayfa_manifesti tablosuna politika ekleyin');
          }
          
          throw error;
        }
        
        if (!panels || panels.length === 0) {
          console.warn('âš ï¸ sayfa_manifesti boÅŸ veya bulunamadÄ±');
          console.warn('ğŸ’¡ Kontrol edin: RLS politikalarÄ±, tablo adÄ±, veri varlÄ±ÄŸÄ±');
          return res;
        }
        
        console.log('âœ… sayfa_manifesti yÃ¼klendi:', panels.length, 'panel bulundu');
        
        // Global yetki kontrolÃ¼
        const hasGlobal = hasGlobalAllow(allowSet);
        
        panels.forEach(doc=>{
          const d = doc || {};
          const id = d.id || doc.id;
          const panelTitle = d.title || id;
          
          // Sistem AyarlarÄ± panelini Ã¼st menÃ¼den kaldÄ±r (sadece profil dropdown'unda kalacak)
          const panelTitleNorm = norm(panelTitle);
          const idNorm = norm(id);
          const excludedPanels = ['sistem ayarlarÄ±', 'ayarlar', 'diÄŸer', 'sistemayarlarÄ±', 'sistem-ayarlari'];
          if (excludedPanels.includes(panelTitleNorm) || excludedPanels.includes(idNorm) ||
              (panelTitleNorm.includes('sistem') && panelTitleNorm.includes('ayar'))) {
            return; // Bu paneli atla
          }
          
          // Panel yetki kontrolÃ¼
          const panelGrant = hasGlobal || allowSet.has(idNorm) || allowSet.has(panelTitleNorm);
          
          // Supabase'de pages JSONB olarak gelir
          let pages = Array.isArray(d.pages) ? d.pages : 
                     (typeof d.pages === 'object' && d.pages !== null ? Object.values(d.pages) : []);
          
          // SayfalarÄ± yetkiye gÃ¶re filtrele
          const originalPageCount = pages.length;
          pages = pages
            .filter(pg => {
              const pageKey = pg.key || pg.title || '';
              const allowed = pageAllowed(panelTitle, pageKey, allowSet, denySet);
              if (!allowed) {
                console.log(`   âŒ Sayfa reddedildi: "${pageKey}" (Panel: "${panelTitle}")`);
              }
              return allowed;
            })
            .map(pg => ({
              baslik: pg.title || pg.key || 'Sayfa',
              url: normalizeUrl(pg.path || '#'),
              key: pg.key || pg.title || '',
              sira: typeof pg.order === 'number' ? pg.order : 9999
            }))
            .sort((a, b) => a.sira - b.sira);
          
          console.log(`   ğŸ“‹ Panel: "${panelTitle}" - ${originalPageCount} sayfa, ${pages.length} yetkili sayfa`);
          
          // Panel altÄ±nda yetkili sayfa yoksa paneli gÃ¶sterme
          if (pages.length === 0 && !hasGlobal) {
            console.log(`   âš ï¸ Panel atlandÄ±: "${panelTitle}" - Yetkili sayfa yok`);
            return;
          }
          
          res.push({
            id,
            baslik: panelTitle,
            sira: typeof d.order === 'number' ? d.order : 9999,
            pages
          });
        });
        
        res.sort((a, b) => a.sira - b.sira);
      } catch(e) {
        console.error('âŒ sayfa_manifesti okunamadÄ±:', e);
        
        // DetaylÄ± hata mesajÄ±
        let errorMsg = 'MenÃ¼ manifesti yÃ¼klenemedi.';
        if (e.code === '42501') {
          errorMsg = 'RLS politikasÄ± hatasÄ±: sayfa_manifesti tablosuna eriÅŸim izni yok.';
        } else if (e.message) {
          errorMsg = `Hata: ${e.message}`;
        }
        
        showToast('error', 'Hata', errorMsg);
      }
      return res;
    }
    function renderNav(panels){
      const ul=document.getElementById('navMain'), drawer=document.getElementById('drawer');
      if (!ul || !drawer) {
        console.error('âŒ renderNav: navMain veya drawer bulunamadÄ±');
        return;
      }
      ul.innerHTML=''; drawer.innerHTML='';
      console.log('ğŸ” renderNav: Paneller render ediliyor, sayÄ±:', panels.length);
      if(!panels.length){
        const li = document.createElement('li');
        li.className = 'nav-item';
        const btn = document.createElement('div');
        btn.className = 'nav-btn';
        btn.textContent = 'MenÃ¼ yok';
        li.appendChild(btn);
        ul.appendChild(li);
        const emptyMsg = document.createElement('div');
        emptyMsg.className = 'muted';
        emptyMsg.style.padding = '8px';
        emptyMsg.textContent = 'MenÃ¼ bulunamadÄ±';
        drawer.appendChild(emptyMsg);
        return;
      }
      panels.forEach((p, index)=>{
        console.log(`ğŸ” renderNav: Panel ${index + 1}/${panels.length} - "${p.baslik}" (${p.pages?.length || 0} sayfa)`);
        const li=document.createElement('li'); li.className='nav-item';
        // GÃ¼venli DOM oluÅŸturma - innerHTML yerine
        const btn = document.createElement('div');
        btn.className = 'nav-btn';
        btn.textContent = escapeHtml(p.baslik || 'Panel');
        const caret = document.createElement('span');
        caret.className = 'caret';
        caret.textContent = 'â–¾';
        btn.appendChild(caret);
        li.appendChild(btn);
        
        const dd=document.createElement('div'); dd.className='dropdown';
        
        // Sayfa yoksa dropdown oluÅŸturma
        if (!p.pages || p.pages.length === 0) {
          console.log(`   âš ï¸ Panel "${p.baslik}" - Sayfa yok, dropdown oluÅŸturulmadÄ±`);
          btn.style.cursor = 'default';
        } else {
          console.log(`   âœ… Panel "${p.baslik}" - ${p.pages.length} sayfa eklendi`);
          (p.pages||[]).forEach(pg=>{
            const a=document.createElement('a');
            a.href=normalizeUrl(pg.url || pg.path || '#'); 
            a.textContent=escapeHtml(pg.baslik || 'Sayfa');
            a.dataset.key=escapeHtml(pg.key||pg.baslik||''); 
            a.dataset.panel=escapeHtml(p.id||''); 
            a.dataset.panelTitle=escapeHtml(p.baslik||'');
            dd.appendChild(a);
          });
          li.appendChild(dd);
          
          btn.addEventListener('click',(e)=>{
            e.preventDefault();
            e.stopPropagation();
            ul.querySelectorAll('.nav-item').forEach(x=>{ if(x!==li) x.classList.remove('open'); });
            li.classList.toggle('open');
          });
        }
        ul.appendChild(li);
      });
      
      // Dropdown dÄ±ÅŸÄ±na tÄ±klanÄ±nca kapat
      document.addEventListener('click',(e)=>{
        if (e.target.closest('.dropdown a')) {
          setTimeout(() => {
            ul.querySelectorAll('.nav-item').forEach(x => x.classList.remove('open'));
          }, 100);
          return;
        }
        if (!ul.contains(e.target) && !e.target.closest('.dropdown')) {
          ul.querySelectorAll('.nav-item').forEach(x => x.classList.remove('open'));
        }
      });

      // mobil
      panels.forEach(p=>{
        const h=document.createElement('div'); h.className='panel-title'; h.textContent=escapeHtml(p.baslik||'Panel'); drawer.appendChild(h);
        (p.pages||[]).forEach(pg=>{
          const a=document.createElement('a');
          a.href=normalizeUrl(pg.url || pg.path || '#'); 
          a.textContent=escapeHtml(pg.baslik||'Sayfa');
          a.dataset.key=escapeHtml(pg.key||pg.baslik||''); 
          a.dataset.panel=escapeHtml(p.id||''); 
          a.dataset.panelTitle=escapeHtml(p.baslik||'');
          drawer.appendChild(a);
        });
      });
    }
    /* App Shell init - ortak.js'den */
    function initAppShell() {
      // Hamburger & Drawer
      const hamb = document.getElementById('hamburger'), drawer = document.getElementById('drawer');
      if (hamb && drawer) {
        hamb.addEventListener('click', () => drawer.classList.toggle('open'));
        document.addEventListener('click', (e) => {
          if (!drawer.contains(e.target) && !hamb.contains(e.target)) drawer.classList.remove('open');
        });
      }

      // Bildirim & Profil Dropdown
      const notifBtn = document.getElementById('btnNotif');
      const notifDD = document.getElementById('notifDropdown');
      const profBtn = document.getElementById('btnProfile');
      const profDD = document.getElementById('profDropdown');
      
      function closeAll(e) {
        if (notifDD && !notifDD.contains(e.target) && e.target !== notifBtn) {
          notifDD.parentElement.classList.remove('open');
        }
        if (profDD && !profDD.contains(e.target) && e.target !== profBtn) {
          profDD.parentElement.classList.remove('open');
        }
      }
      document.addEventListener('click', closeAll);
      
      if (notifBtn && notifDD) {
        notifBtn.addEventListener('click', (e) => { 
          e.stopPropagation(); 
          notifDD.parentElement.classList.toggle('open'); 
          if (profDD) profDD.parentElement.classList.remove('open'); 
        });
      }
      
      if (profBtn && profDD) {
        profBtn.addEventListener('click', (e) => { 
          e.stopPropagation(); 
          profDD.parentElement.classList.toggle('open'); 
          if (notifDD) notifDD.parentElement.classList.remove('open'); 
        });
      }
      
      // Logout
      const btnLogout = document.getElementById('btnLogout');
      if (btnLogout) {
        btnLogout.addEventListener('click', async (e) => {
          e.preventDefault();
          try { 
            await auth.signOut(); 
            const indexPath = normalizeUrl('index.html');
            location.assign(indexPath); 
          } catch (err) { 
            console.error('Ã‡Ä±kÄ±ÅŸ hatasÄ±:', err); 
            showToast('error', 'Hata', 'Ã‡Ä±kÄ±ÅŸ yapÄ±lamadÄ±.');
          }
        });
      }

      // Link guard - yetki kontrolÃ¼ (sayfa manifesti ve kullanÄ±cÄ± yetkilerine gÃ¶re)
      document.addEventListener('click', (e) => {
        const a = e.target.closest('a[data-key]');
        if (!a) return;
        
        const allowSet = window.CURRENT_ALLOW || new Set();
        const denySet = window.CURRENT_DENY || new Set();
        
        // Global yetki kontrolÃ¼
        if (hasGlobalAllow(allowSet)) {
          return; // Global yetki varsa tÃ¼m sayfalara eriÅŸim
        }
        
        const key = norm(a.dataset.key || '');
        const pnl = norm(a.dataset.panel || '');
        const pnlTitle = norm(a.dataset.panelTitle || '');
        
        // Panel seviyesinde kontrol (sayfa key yoksa)
        if (!key && (pnl || pnlTitle)) {
          if (pageAllowed(pnlTitle || pnl, '', allowSet, denySet)) {
            return;
          }
        }
        
        // Reddedilen sayfa kontrolÃ¼
        if (key && denySet.has(key)) { 
          e.preventDefault(); 
          showToast('warning', 'Yetki Yok', 'Bu sayfa iÃ§in yetkiniz yok.');
          return; 
        }
        if (pnl && denySet.has(pnl)) {
          e.preventDefault();
          showToast('warning', 'Yetki Yok', 'Bu panel iÃ§in yetkiniz yok.');
          return;
        }
        if (pnlTitle && denySet.has(pnlTitle)) {
          e.preventDefault();
          showToast('warning', 'Yetki Yok', 'Bu panel iÃ§in yetkiniz yok.');
          return;
        }
        
        // Sayfa yetki kontrolÃ¼ (wildcard desteÄŸi ile)
        const allowed = pageAllowed(pnlTitle || pnl, key, allowSet, denySet);
        if (!allowed) { 
          e.preventDefault(); 
          showToast('warning', 'Yetki Yok', 'Bu sayfa iÃ§in yetkiniz yok.');
        }
      });
    }

    /* ===== Dinamik Kartlar ===== */
    // Panelde raporlayacaÄŸÄ±n katlarÄ±n etiketi
    const KATLAR = ['2.Kat - Lokal','1.Kat - EtÃ¼t','0.Kat - GiriÅŸ','-1.Kat - Yatakhane','-2.Kat - Yemekhane','BahÃ§e'];
    const monthsTR = ['Ocak','Åubat','Mart','Nisan','MayÄ±s','Haziran','Temmuz','AÄŸustos','EylÃ¼l','Ekim','KasÄ±m','AralÄ±k'];
    function toDate(v){
      if(!v) return null;
      if(typeof v.toDate==='function') return v.toDate();
      if(typeof v==='number') return new Date(v);
      if(typeof v==='string'){ const d=new Date(v); if(!isNaN(d)) return d; }
      return null;
    }
    function rangeYear(year){ return { start:new Date(year,0,1,0,0,0), end:new Date(year,11,31,23,59,59,999) }; }
    function rangeMonth(d){ return { start:new Date(d.getFullYear(), d.getMonth(), 1, 0,0,0), end:new Date(d.getFullYear(), d.getMonth()+1, 0, 23,59,59,999) }; }

    // Ä°sim tekilleÅŸtirme ve gÃ¶rselleÅŸtirme (global - tekrar kullanÄ±m iÃ§in)
    const tidy   = s => (s||'').toString().trim().replace(/\s+/g,' ');
    const normTR = s => tidy(s).toLocaleLowerCase('tr-TR');
    function nameKey(s){ return normTR(s).toUpperCase(); }

    // Ã‡ok alanlÄ± isim yakalayÄ±cÄ± (isim eksiklerini azaltÄ±r)
    function coalesceName(obj){
      const cand = [
        obj?.personel, obj?.personelAd, obj?.sorumlu, obj?.adSoyad, obj?.isim, obj?.ad_soyad, obj?.ad_soyad,
        obj?.ad, obj?.name
      ].map(tidy).filter(Boolean);
      if (cand.length) return cand[0];
      // e-posta varsa ad@â€¦ â†’ â€œadâ€ yakala
      const mail = tidy(obj?.email || obj?.mail || obj?.eposta);
      if (mail.includes('@')) return mail.split('@')[0];
      return 'â€”';
    }

    // Para biÃ§imlendirici
    function fmtTL(n){ const v=Number(n||0); return isNaN(v) ? 'â‚º0' : 'â‚º ' + v.toLocaleString('tr-TR'); }

    // === Ortak yardÄ±mcÄ±lar (TR gÃ¼nÃ¼) ===
    function todayStrTR(){
      const now = new Date();
      // Ä°stanbul TZ ile gÃ¼nÃ¼ fixle
      const tz = new Date(now.toLocaleString('en-US',{timeZone:'Europe/Istanbul'}));
      const y = tz.getFullYear(), m = String(tz.getMonth()+1).padStart(2,'0'), d = String(tz.getDate()).padStart(2,'0');
      return `${y}-${m}-${d}`;
    }
    function avg(nums){ if(!nums.length) return 0; const s=nums.reduce((a,b)=>a+(+b||0),0); return Math.round((s/nums.length)*10)/10; }

    // Kattaki toplam mahal sayÄ±sÄ±nÄ± getir (temizlik_listesi > temizlik_katlari fallback)
    // TODO: Supabase tablolarÄ± hazÄ±r olunca bu fonksiyon gÃ¼ncellenecek
    async function getToplamMahaller(kat){
      console.warn('getToplamMahaller: temizlik_listesi ve temizlik_katlari tablolarÄ± henÃ¼z Supabase\'de yok');
      return 0;
    }
/* ===== Talebe Ä°statistiÄŸi â€” devreli (yeni/eski ÅŸema uyumlu) ===== */

/** Yeni ÅŸemada alt koleksiyon adÄ± (Ã¶ÄŸrenciler | ogrenciler) */
// TODO: talebeler tablosu Supabase'de hazÄ±r olunca gÃ¼ncellenecek
async function resolveSubcolName(devre){
  console.warn('resolveSubcolName: talebeler tablosu henÃ¼z Supabase\'de yok');
  return null;
}

/** Yeni ÅŸema sayÄ±mÄ±: talebeler/{devre}/{Ã¶ÄŸrenciler|ogrenciler} */
// TODO: talebeler tablosu Supabase'de hazÄ±r olunca gÃ¼ncellenecek
async function countNewSchema(devre){
  console.warn('countNewSchema: talebeler tablosu henÃ¼z Supabase\'de yok');
  return null;
}

/** Eski ÅŸema sayÄ±mÄ±: devre alanÄ±na gÃ¶re (birkaÃ§ olasÄ± koleksiyonda) */
// TODO: talebe tablolarÄ± Supabase'de hazÄ±r olunca gÃ¼ncellenecek
async function countOldSchema(devre){
  console.warn('countOldSchema: talebe tablolarÄ± henÃ¼z Supabase\'de yok');
  return null;
}

/** Devre listesi: yeni ÅŸemada talebeler/{devre} ID'leri; yoksa varsayÄ±lanlar */
// TODO: talebeler tablosu Supabase'de hazÄ±r olunca gÃ¼ncellenecek
async function getDevreList(){
  console.warn('getDevreList: talebeler tablosu henÃ¼z Supabase\'de yok, varsayÄ±lan devreler kullanÄ±lÄ±yor');
  return ['5.Devre','6.Devre','7.Devre'];
}

/** UI: baÅŸlÄ±ktaki devre menÃ¼sÃ¼nÃ¼ kur */
async function initDevreSelector(){
  const btn = document.getElementById('devreBtn');
  const dd  = document.getElementById('devreDd');
  if(!btn || !dd) return;

  const list = await getDevreList();
  const stored = localStorage.getItem('kf_devre');
  let current = list.includes(stored) ? stored : (list[0]||'6.Devre');

  function renderDd(){
    dd.innerHTML = '';
    list.forEach(dev=>{
      const b = document.createElement('button');
      b.textContent = dev;
      if(dev===current) b.classList.add('active');
      b.dataset.devre = dev;
      b.addEventListener('click', async ()=>{
        current = dev;
        localStorage.setItem('kf_devre', current);
        btn.textContent = current;
        dd.hidden = true; btn.setAttribute('aria-expanded','false');
        await loadTalebeStatsByDevre(current);
      });
      dd.appendChild(b);
    });
  }

  btn.textContent = current;
  renderDd();

  btn.addEventListener('click', (e)=>{
    e.stopPropagation();
    const open = dd.hidden === false;
    dd.hidden = open ? true : false;
    btn.setAttribute('aria-expanded', String(!open));
  });
  document.addEventListener('click', (e)=>{
    if(!dd.contains(e.target) && e.target!==btn){ dd.hidden = true; btn.setAttribute('aria-expanded','false'); }
  });

  // ilk yÃ¼k
  await loadTalebeStatsByDevre(current);
}

/** SeÃ§ili devreye gÃ¶re sayÄ±mlarÄ± yÃ¼kle (yeni â†’ eski fallback) */
async function loadTalebeStatsByDevre(devre){
  const elT = document.getElementById('kpiTalebe');
  const elE = document.getElementById('kpiEnsar');
  const elM = document.getElementById('kpiMuhacir');
  if(elT) elT.textContent='â€”';
  if(elE) elE.textContent='â€”';
  if(elM) elM.textContent='â€”';

  try{
    let res = await countNewSchema(devre);
    if(!res) res = await countOldSchema(devre);
    if(!res){ elT.textContent='0'; elE.textContent='0'; elM.textContent='0'; return; }
    elT.textContent = res.toplam || 0;
    elE.textContent = res.ensar  || 0;
    elM.textContent = res.muhacir|| 0;

    // BaÅŸlÄ±ktaki metin â€œTalebe Ä°statistiÄŸi â€“ {devre}â€
    const btn = document.getElementById('devreBtn');
    if(btn) btn.textContent = devre;

  }catch(e){
    console.error('Talebe sayÄ±larÄ± yÃ¼klenemedi:', e);
    if(elT) elT.textContent='--';
    if(elE) elE.textContent='--';
    if(elM) elM.textContent='--';
  }
}

    // 1) TEMÄ°ZLÄ°K KONTROLÃœ â€” tek kat, tek gÃ¼n
    // TODO: temizlik_kontrol tablosu Supabase'de hazÄ±r olunca gÃ¼ncellenecek
    async function fetchTemizlikKontrolKatGun(kat, dateStr){
      console.warn('fetchTemizlikKontrolKatGun: temizlik_kontrol tablosu henÃ¼z Supabase\'de yok');
      return { kat, kayitli: 0, toplam: 0, kapsama: null, ortalama: 0, uyari: 0 };
    }

    // 2) GENEL TEMÄ°ZLÄ°K â€” _summary varsa onu kullan
    // TODO: genel_temizlik_kontrol tablosu Supabase'de hazÄ±r olunca gÃ¼ncellenecek
    async function fetchGenelSummaryKatGun(kat, dateStr){
      console.warn('fetchGenelSummaryKatGun: genel_temizlik_kontrol tablosu henÃ¼z Supabase\'de yok');
      return { kat, submissions: 0, avgPuan100: 0, eksikAny: false };
    }

    // 3) DETAYLI â€” _summary / fallback
    // TODO: genel_temizlik_detay tablosu Supabase'de hazÄ±r olunca gÃ¼ncellenecek
    async function fetchDetaySummaryKatGun(kat, dateStr){
      console.warn('fetchDetaySummaryKatGun: genel_temizlik_detay tablosu henÃ¼z Supabase\'de yok');
      return { kat, submissions: 0, avgPuan100: 0, eksikAny: false };
    }

    // 4) EKSÄ°KLER â€” aÃ§Ä±k kayÄ±tlar
    // TODO: eksik_bildirim tablosu Supabase'de hazÄ±r olunca gÃ¼ncellenecek
    async function fetchEksikler({dateStr=null, kat=null, status='acik'}={}){
      console.warn('fetchEksikler: eksik_bildirim tablosu henÃ¼z Supabase\'de yok');
      return { count: 0, list: [] };
    }

    // Ortalama hesaplama helper (kod tekrarÄ±nÄ± Ã¶nlemek iÃ§in)
    const calcWeightedAvg = (rows, valKey, weightKey) => {
      let s=0, c=0;
      rows.forEach(r=>{
        const val = r[valKey]||0;
        const weight = r[weightKey]||0;
        if(weight > 0 && Number.isFinite(val)){
          s += val * weight;
          c += weight;
        }
      });
      return c ? Math.round((s/c)*10)/10 : 0;
    };

    // === Hepsini toplu: panel kartlarÄ± iÃ§in tek fonksiyon (optimize edilmiÅŸ)
    async function buildTemizlikDashboard({kats, dateStr = todayStrTR()}){
      // TÃ¼m verileri paralel yÃ¼kle (daha hÄ±zlÄ±)
      const [tkRows, genelRows, detayRows, eksik] = await Promise.all([
        Promise.all(kats.map(k=> fetchTemizlikKontrolKatGun(k, dateStr))),
        Promise.all(kats.map(k=> fetchGenelSummaryKatGun(k, dateStr))),
        Promise.all(kats.map(k=> fetchDetaySummaryKatGun(k, dateStr))),
        fetchEksikler({dateStr, status:'acik'})
      ]);
      
      const tk = {
        toplamMahaller: tkRows.reduce((a,r)=> a + (r.toplam||0), 0),
        doldurulan:     tkRows.reduce((a,r)=> a + (r.kayitli||0), 0),
        ortalamaPuan:   calcWeightedAvg(tkRows, 'ortalama', 'kayitli'),
        uyari:          tkRows.reduce((a,r)=> a + (r.uyari||0), 0),
        katlar:         tkRows
      };

      const genel = {
        submissions:  genelRows.reduce((a,r)=> a+(r.submissions||0), 0),
        avgPuan100:   calcWeightedAvg(genelRows, 'avgPuan100', 'submissions'),
        eksikAny:     genelRows.some(r=> r.eksikAny),
        katlar:       genelRows
      };

      const detay = {
        submissions:  detayRows.reduce((a,r)=> a+(r.submissions||0), 0),
        avgPuan100:   calcWeightedAvg(detayRows, 'avgPuan100', 'submissions'),
        eksikAny:     detayRows.some(r=> r.eksikAny),
        katlar:       detayRows
      };

      return { date: dateStr, temizlik: tk, genel, detay, eksik };
    }

  // Temizlik dashboard cache (aynÄ± gÃ¼n iÃ§in tekrar Ã§aÄŸrÄ±lmamasÄ± iÃ§in)
  let _temizlikCache = { date: null, data: null };
  
  // Ortak temizlik verisi yÃ¼kleme (cache'li)
  async function getTemizlikData(dateStr = todayStrTR()){
    if(_temizlikCache.date === dateStr && _temizlikCache.data) return _temizlikCache.data;
    const data = await buildTemizlikDashboard({kats: KATLAR, dateStr});
    _temizlikCache = { date: dateStr, data };
    return data;
  }

  /* ===== Talebe Temizlik PuanÄ± (BugÃ¼n) â€“ kat kat + genel ortalama ===== */
  async function loadTalebeTemizlik(){
    const dateStr = todayStrTR();
    const listEl = document.getElementById("talebeTemizlikTop5");
    const kpiEl  = document.getElementById("kpiTalebeTemizlikOrt");
    if(!listEl || !kpiEl) return;
    listEl.innerHTML = '';

    try{
      const data = await getTemizlikData(dateStr);
      kpiEl.textContent = Number.isFinite(data.temizlik.ortalamaPuan) ? data.temizlik.ortalamaPuan.toFixed(1) : '--';

      data.temizlik.katlar
        .slice()
        .sort((a,b)=> (b.ortalama||0)-(a.ortalama||0))
        .forEach(r=>{
          const kaps = (r.kapsama!=null) ? Math.round((r.kapsama*100))+'%' : 'â€”';
          const el=document.createElement('div'); el.className='list-item';
          el.innerHTML = `<div><strong>${r.kat}</strong><div class="sub" style="font-size:12px;color:var(--muted)">KayÄ±t: ${r.kayitli}/${r.toplam} â€¢ Kapsama: ${kaps}</div></div><div>${(Number.isFinite(r.ortalama)? r.ortalama.toFixed(1): 'â€”')}</div>`;
          listEl.appendChild(el);
        });
    }catch(e){
      console.error('Talebe temizlik hatasÄ±:', e);
      if(kpiEl) kpiEl.textContent='--';
      if(listEl) listEl.innerHTML='<div class="muted">Veri yÃ¼klenemedi.</div>';
    }
  }

  /* ===== Genel Temizlik (bugÃ¼n) ===== */
  async function loadGenelTemizlik(){
    const dateStr = todayStrTR();
    const kpi = document.getElementById("kpiGenelTemizlikOrt");
    const cont = document.getElementById("katOrtList");
    if(!kpi || !cont) return;
    cont.innerHTML='';

    try{
      const data = await getTemizlikData(dateStr);
      kpi.textContent = Number.isFinite(data.genel.avgPuan100) ? data.genel.avgPuan100 : '--';

      data.genel.katlar
        .slice()
        .sort((a,b)=> (b.avgPuan100||0) - (a.avgPuan100||0))
        .forEach(r=>{
          const el=document.createElement('div'); el.className='list-item';
          el.innerHTML = `<div><strong>${r.kat}</strong><div class="sub" style="font-size:12px;color:var(--muted)">Form: ${r.submissions} â€¢ ${r.eksikAny?'Eksik var':'Tam'}</div></div><div>${(r.avgPuan100??'â€”')}</div>`;
          cont.appendChild(el);
        });
    }catch(e){
      console.error('Genel temizlik hatasÄ±:', e);
      if(kpi) kpi.textContent='--';
      if(cont) cont.innerHTML='<div class="muted">Veri yÃ¼klenemedi.</div>';
    }
  }

  /* ===== Alacak Raporu: toplam, 2024, 2025 ===== */
async function loadAlacak(){
  const years = [2024, 2025];

  // Verileri al (Supabase)
  const supabase = getSupabase();
  if (!supabase) { console.error('Supabase client yÃ¼klenmedi'); return; }
  
  const [tahakkukResult, tahsilatResult] = await Promise.all([
    supabase.from('tahakkuklar').select('*'),
    supabase.from('tahsilatlar').select('*')
  ]);

  if (tahakkukResult.error) { console.error('Tahakkuklar okunamadÄ±:', tahakkukResult.error); return; }
  if (tahsilatResult.error) { console.error('Tahsilatlar okunamadÄ±:', tahsilatResult.error); return; }

  const tSnap = tahakkukResult.data || [];
  const sSnap = tahsilatResult.data || [];

  // Tahakkuk indeksleri
  const tahById   = new Map();                     // id -> tahakkuk doc
  const keyToId   = new Map();                     // "yil||faaliyet||personel||borclu" -> tahakkuk id
  const yearTah   = Object.fromEntries(years.map(y=>[y,0]));
  const yearThs   = Object.fromEntries(years.map(y=>[y,0]));

  tSnap.forEach(doc=>{
    const v = doc || {};
    const y = Number(v.yil);
    const tahakkuk = Number(v.tahakkuk||0);
    tahById.set(v.id || doc.id, v);
    const key = `${y}||${normTR(v.faaliyet)}||${normTR(v.personel)}||${normTR(v.borclu)}`;
    keyToId.set(key, v.id || doc.id);
    if (years.includes(y)) yearTah[y] += tahakkuk;
  });

  // TahsilatÄ± sadece eÅŸleÅŸirse say: Ã¶nce id, yoksa composite key
  sSnap.forEach(doc=>{
    const v = doc || {};
    let tahYear = null;

    if (v.tahakkukId && tahById.has(v.tahakkukId)) {
      tahYear = Number(tahById.get(v.tahakkukId).yil);
    } else {
      const y  = Number(v.yil) || (toDate(v.tarih)?.getFullYear());
      const k  = `${y}||${normTR(v.faaliyet)}||${normTR(v.personel)}||${normTR(v.borclu)}`;
      const tk = keyToId.get(k);
      if (tk && tahById.has(tk)) tahYear = Number(tahById.get(tk).yil);
    }

    if (years.includes(tahYear)) yearThs[tahYear] += Number(v.tutar||0);
  });

  // YazdÄ±r
  const totalTah = years.reduce((s,y)=>s+yearTah[y],0);
  const totalThs = years.reduce((s,y)=>s+yearThs[y],0);
  document.getElementById('nispetToplam').textContent = totalTah ? (totalThs/totalTah*100).toFixed(1)+'%' : '--%';
  document.getElementById('nispet2024').textContent   = yearTah[2024] ? (yearThs[2024]/yearTah[2024]*100).toFixed(1)+'%' : '--%';
  document.getElementById('nispet2025').textContent   = yearTah[2025] ? (yearThs[2025]/yearTah[2025]*100).toFixed(1)+'%' : '--%';
}

  /* ===== AylÄ±k performans: Topâ€‘3 (yÃ¼zde) & 0% =====
     - YÃ¼zde = (personelin bu ayki tahsilatÄ±) / (aynÄ± yÄ±ldaki toplam tahakkuku) * 100
  */
async function loadAylik(){

  const now = new Date();
  const { start, end } = (()=>{
    const s = new Date(now.getFullYear(), now.getMonth(), 1);
    const e = new Date(now); e.setHours(23,59,59,999); // ayÄ±n bugÃ¼ne kadarki kÄ±smÄ±
    return { start:s, end:e };
  })();
  const yil = now.getFullYear();
  document.getElementById('ayTop3').textContent     = monthsTR[now.getMonth()]+' AyÄ±';
  document.getElementById('ayTop3Tutar').textContent= monthsTR[now.getMonth()]+' AyÄ±'; // ğŸ†•
  document.getElementById('ayZero').textContent     = monthsTR[now.getMonth()]+' AyÄ±';

  // Veriler (Supabase)
  const supabase = getSupabase();
  if (!supabase) { console.error('Supabase client yÃ¼klenmedi'); return; }
  
  // Supabase sorgularÄ± - catch Promise.all iÃ§inde Ã§alÄ±ÅŸmaz, ayrÄ± ayrÄ± yapÄ±yoruz
  let tahakkukYearResult, tahakkukAllResult, tahsilatResult;
  
  try {
    tahakkukYearResult = await supabase.from('tahakkuklar').select('*').eq('yil', yil);
    // EÄŸer hata varsa tÃ¼m tahakkuklarÄ± al
    if (tahakkukYearResult.error) {
      tahakkukYearResult = await supabase.from('tahakkuklar').select('*');
    }
  } catch (e) {
    tahakkukYearResult = await supabase.from('tahakkuklar').select('*');
  }
  
  [tahakkukAllResult, tahsilatResult] = await Promise.all([
    supabase.from('tahakkuklar').select('*'),   // tÃ¼m yÄ±llar
    supabase.from('tahsilatlar').select('*')
  ]);

  // Hata kontrolÃ¼
  if (tahakkukYearResult.error && tahakkukYearResult.error.code !== 'PGRST116') {
    console.error('Tahakkuklar (yÄ±l) okunamadÄ±:', tahakkukYearResult.error);
  }
  if (tahakkukAllResult.error) {
    console.error('Tahakkuklar (tÃ¼m) okunamadÄ±:', tahakkukAllResult.error);
    return;
  }
  if (tahsilatResult.error) {
    console.error('Tahsilatlar okunamadÄ±:', tahsilatResult.error);
    return;
  }

  const tSnapYear = tahakkukYearResult.data || [];
  const tSnapAll = tahakkukAllResult.data || [];
  const sSnap = tahsilatResult.data || [];

  // Haritalar
  const tahById = new Map();      // id -> tahakkuk doc (sadece bu yÄ±l)
  const keyToId = new Map();      // eÅŸleÅŸtirme iÃ§in composit key (bu yÄ±l)
  const annualTah  = new Map();   // bu yÄ±l kiÅŸi bazÄ±nda
  const overallTah = new Map();   // tÃ¼m yÄ±llar kiÅŸi bazÄ±nda
  const displayName = new Map();  // gÃ¶sterim adÄ±

      // BU YIL tahakkuklarÄ±
  tSnapYear.forEach(doc=>{
    const t = doc || {};
    if (Number(t.yil) !== yil) return;
    tahById.set(t.id || doc.id, t);
    const k = `${yil}||${normTR(t.faaliyet)}||${normTR(t.personel||t.personelAd||t.sorumlu||'')}||${normTR(t.borclu)}`;
    keyToId.set(k, t.id || doc.id);
    const pName = coalesceName(t);
    const pk    = nameKey(pName);
    annualTah.set(pk, (annualTah.get(pk)||0) + Number(t.tahakkuk||0));
    displayName.set(pk, pName);
  });

  // TÃœM YILLAR tahakkuklarÄ±
  tSnapAll.forEach(doc=>{
    const t = doc || {};
    const pName = coalesceName(t);
    const pk    = nameKey(pName);
    overallTah.set(pk, (overallTah.get(pk)||0) + Number(t.tahakkuk||0));
    if (!displayName.has(pk)) displayName.set(pk, pName);
  });

  // Bu ayki tahsilatlar (sadece eÅŸleÅŸenler, ve eÅŸleÅŸtiÄŸi tahakkukun PERSONEL'ine yaz)
  const monthlyTh = new Map();           // personKey -> bu ay tahsilat
  sSnap.forEach(doc=>{
    const v = doc || {};
    const dt = toDate(v.tarih);
    if (!dt || dt < start || dt > end) return;

    let tah = null;

    if (v.tahakkukId && tahById.has(v.tahakkukId)) {
      tah = tahById.get(v.tahakkukId);
    } else {
      const y = Number(v.yil) || (dt && dt.getFullYear());
      const k = `${y}||${normTR(v.faaliyet)}||${normTR(v.personel)}||${normTR(v.borclu)}`;
      const id = keyToId.get(k);
      if (id && tahById.has(id)) tah = tahById.get(id);
    }
    if (!tah || Number(tah.yil)!==yil) return;

    // Ä°SÄ°M: tah'da yoksa tahsilattan tamamla
    const pName = coalesceName(tah) !== 'â€”' ? coalesceName(tah) : coalesceName(v);
    const pk    = nameKey(pName);
    displayName.set(pk, pName);

    monthlyTh.set(pk, (monthlyTh.get(pk)||0) + Number(v.tutar||0));
  });

  // Top-3 (yÃ¼zde = aylÄ±k tahsilat / yÄ±llÄ±k tahakkuk)
    const rows = [...displayName.keys()].map(pk=>{
      const tahAll = overallTah.get(pk)||0;   // ğŸ†• tÃ¼m yÄ±llar
      const tahYr  = annualTah.get(pk)||0;    // istersen labelâ€™da gÃ¶stermek iÃ§in
      const th     = monthlyTh.get(pk)||0;    // bu ay tahsilat
      return {
        pk, name: displayName.get(pk)||pk,
        pct: (tahAll>0 ? (th/tahAll*100) : 0),  // ğŸ†• yÃ¼zde artÄ±k tÃ¼m yÄ±llara nispetle
        th, tahAll, tahYr
      };
    });

    // --- Top-3 (YÃœZDE) ---
    const top3Pct = document.getElementById('top3List'); top3Pct.innerHTML='';
    const topPct  = rows.filter(r=>r.pct>0).sort((a,b)=>b.pct-a.pct).slice(0,3);

    if (!topPct.length){
      top3Pct.innerHTML = '<div class="list-item"><div>Veri yok</div><div class="muted">â€”</div></div>';
    } else {
      topPct.forEach((r,i)=>{
        const el=document.createElement('div'); el.className='list-item';
        const w = Math.max(0, Math.min(100, r.pct));
        const rankClass = i === 0 ? 'rank-1' : i === 1 ? 'rank-2' : 'rank-3';
        el.innerHTML = `
          <div style="flex:1">
            <div><span class="rank ${rankClass}">${i+1}</span>${r.name}</div>
            <div class="meta">${r.pct.toFixed(1)}% â€¢ Toplam Alacak Tahak.: ${fmtTL(r.tahAll)}</div>
            <div class="bar"><span style="width:${w}%"></span></div>
          </div>
        `;
        top3Pct.appendChild(el);
      });
    }

    // --- ğŸ†• Top-3 (TUTAR) ---
    const top3Amt = document.getElementById('top3TutarList'); top3Amt.innerHTML='';
    const topAmt  = rows.filter(r=>r.th>0).sort((a,b)=>b.th-a.th).slice(0,3);

    if (!topAmt.length){
      top3Amt.innerHTML = '<div class="list-item"><div>Veri yok</div><div class="muted">â€”</div></div>';
    } else {
      topAmt.forEach((r,i)=>{
        // yÃ¼zdeyi "ToplamÄ±na nispetle" (tÃ¼m yÄ±llar) gÃ¶steriyoruz:
        const pctAll = (r.tahAll>0)? (r.th/r.tahAll*100) : 0;
        const w      = Math.max(0, Math.min(100, pctAll));
        const rankClass = i === 0 ? 'rank-1' : i === 1 ? 'rank-2' : 'rank-3';
        const el=document.createElement('div'); el.className='list-item';
        el.innerHTML = `
          <div style="flex:1">
            <div><span class="rank ${rankClass}">${i+1}</span>${r.name}</div>
            <div class="meta">${fmtTL(r.th)} â€¢ ${pctAll.toFixed(1)}%</div>
            <div class="bar"><span style="width:${w}%"></span></div>
          </div>
        `;
        top3Amt.appendChild(el);
      });
    }

    // --- 0% listesi ---
    const zero = document.getElementById('zeroList'); zero.innerHTML='';
    const zeros = rows
      .filter(r => r.tahAll > 0 && !monthlyTh.get(r.pk))  // ğŸŸ¢ bu yÄ±l tahakkuku olup ayda tahsilatÄ± yok
      .map(r => r.name)
      .sort();

    if (!zeros.length){
      zero.innerHTML = '<div class="list-item"><div>TÃ¼m personelde tahsilat var</div><div class="muted">â€”</div></div>';
    } else {
      zeros.forEach(n=>{
        const el=document.createElement('div'); el.className='list-item';
        el.innerHTML = `<div>${n}</div><div class="muted">0%</div>`;
        zero.appendChild(el);
      });
    }
    }

  /* ===== NÃ¶betÃ§i (09:00â†’09:00) nobet_planlari/{YYYY-Www} rows.tarihISO ile ===== */
  function isoWeekKey(d){
    // ISO haftasÄ±: PerÅŸembe bazlÄ±
    const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    const dayNum = (date.getUTCDay()+6)%7;
    date.setUTCDate(date.getUTCDate() - dayNum + 3);
    const firstThu = new Date(Date.UTC(date.getUTCFullYear(),0,4));
    const week = 1 + Math.round(((date - firstThu) / 86400000 - 3 + ((firstThu.getUTCDay()+6)%7)) / 7);
    const year = date.getUTCFullYear();
    return `${year}-W${String(week).padStart(2,'0')}`;
  }
  async function loadNobet(){
    const now=new Date();
    const nine=new Date(now.getFullYear(),now.getMonth(),now.getDate(),9,0,0,0);
    const bas=(now<nine)? new Date(nine.getTime()-86400000) : nine;
    const gunKey=bas.toISOString().slice(0,10);
    const haftaKey=isoWeekKey(bas);
    try{
      const supabase = getSupabase();
      if (!supabase) throw new Error('Supabase client yÃ¼klenmedi');
      
      const { data: doc, error } = await supabase.from('nobet_planlari').select('*').eq('id', haftaKey).single();
      if(error && error.code !== 'PGRST116') throw error; // PGRST116 = no rows returned
      
      if(doc){
        // Supabase'de rows JSONB olarak gelir
        const rows = Array.isArray(doc.rows) ? doc.rows : (typeof doc.rows === 'object' && doc.rows !== null ? Object.values(doc.rows) : []);
        const r=rows.find(x=> String(x.tarihISO)===gunKey);
        if(r){
          document.getElementById("nobetEvli").textContent = r.evli || 'â€”';
          document.getElementById("nobetBekar").textContent= r.bekar|| 'â€”';
          return;
        }
      }
      // bulunamazsa boÅŸ bÄ±rak
      document.getElementById("nobetEvli").textContent = 'â€”';
      document.getElementById("nobetBekar").textContent= 'â€”';
    }catch(e){ console.error('NÃ¶bet yÃ¼kleme hatasÄ±:', e); }
  }
    /* ===== Teknik Eksikler ===== */
  async function loadEksikler(){
    const dateStr = todayStrTR();
    const kpi=document.getElementById('kpiEksikSayisi');
    const list=document.getElementById('eksikList');
    if(!kpi || !list) return;
    list.innerHTML='';

    try{
      // Temizlik dashboard'dan eksik verisini al (cache'den)
      const data = await getTemizlikData(dateStr);
      const ex = data.eksik;
      
      kpi.textContent = ex.count || 0;

      if(ex.count===0){
        list.innerHTML='<div class="list-item"><div>BugÃ¼n aÃ§Ä±k eksik yok</div><div class="muted">â€”</div></div>';
        return;
      }

      ex.list.slice(0,6).forEach(v=>{
        const el=document.createElement('div'); el.className='list-item';
        const parc = (v.parcalar && v.parcalar.length)? ` â€¢ ${v.parcalar.length} madde` : '';
        el.innerHTML=`<div><strong>${v.kat}</strong>${parc}</div><div class="muted">${v.status.toUpperCase()}</div>`;
        list.appendChild(el);
      });
    }catch(e){
      console.error('Eksikler hatasÄ±:', e);
      if(kpi) kpi.textContent='--';
      if(list) list.innerHTML='<div class="muted">Eksikler yÃ¼klenemedi.</div>';
    }
  }

  /* ===== Bildirim rozet - ortak.js'den geliÅŸtirilmiÅŸ versiyon ===== */
  async function loadNotifications(){
    const badge=document.getElementById('notifBadge');
    const list =document.getElementById('notifList');
    if (!badge || !list) return;
    list.innerHTML='';
    try{
      // TODO: duyurular tablosu henÃ¼z oluÅŸturulmadÄ±, geÃ§ici olarak skip ediyoruz
      console.warn('duyurular tablosu henÃ¼z oluÅŸturulmadÄ±, bildirimler gÃ¶sterilemiyor');
      badge.style.display='none';
      const empty=document.createElement('div'); 
      empty.className='muted'; 
      empty.style.padding='6px 8px'; 
      empty.textContent='Bildirim sistemi hazÄ±rlanÄ±yor...'; 
      list.appendChild(empty);
      return;
      
      /* Supabase versiyonu (tablo hazÄ±r olunca kullanÄ±lacak):
      const supabase = getSupabase();
      if (!supabase) throw new Error('Supabase client yÃ¼klenmedi');
      
      const { data: duyurular, error } = await supabase
        .from('duyurular')
        .select('*')
        .order('createdAt', { ascending: false })
        .limit(5);
      
      if (error) throw error;
      const n = duyurular?.length || 0;
      if(n>0){ badge.style.display='block'; badge.textContent = n>99 ? '99+' : String(n); } else { badge.style.display='none'; }
      if(n===0){
        const empty=document.createElement('div'); empty.className='muted'; empty.style.padding='6px 8px'; empty.textContent='Yeni bildirim yok.'; list.appendChild(empty);
      }else{
        duyurular.forEach(doc=>{ 
          const d=doc || {}; 
          const baslik=d.baslik||d.title||'Duyuru'; 
          const detay=d.detay||d.desc||''; 
          const row=document.createElement('a'); 
          const bildirimPath = normalizeUrl('diger/bildirim.html');
          row.href=bildirimPath; 
          const strong = document.createElement('strong');
          strong.textContent = escapeHtml(baslik);
          const muted = document.createElement('div');
          muted.className = 'muted';
          muted.textContent = escapeHtml(detay);
          row.appendChild(strong);
          row.appendChild(muted);
          list.appendChild(row); 
        });
      }
      */
    }catch(e){ 
      console.error('Bildirimler yÃ¼klenemedi:', e); 
      if (badge) badge.style.display='none'; 
      if (list) { 
        const err=document.createElement('div'); 
        err.className='muted'; 
        err.style.padding='6px 8px'; 
        err.textContent='Bildirimler yÃ¼klenemedi.'; 
        list.appendChild(err); 
      } 
    }
  }

  /* Link guard â€“ initAppShell iÃ§inde yapÄ±lÄ±yor */

  /* Toast bildirim sistemi - ortak.js'den */
  function showToast(type, title, message) {
    const cont = document.getElementById('toastContainer');
    if (!cont) {
      console.warn('toastContainer bulunamadÄ±');
      return;
    }
    const safeType = ['success', 'error', 'warning', 'info'].includes(type) ? type : 'info';
    const safeTitle = escapeHtml(String(title || ''));
    const safeMessage = escapeHtml(String(message || ''));
    
    const div = document.createElement('div');
    div.className = `toast ${safeType}`;
    
    const icon = document.createElement('div');
    icon.className = 'toast-icon';
    icon.textContent = safeType === 'success' ? 'âœ…' : safeType === 'error' ? 'âš ï¸' : safeType === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
    
    const content = document.createElement('div');
    content.className = 'toast-content';
    
    const titleEl = document.createElement('div');
    titleEl.className = 'toast-title';
    titleEl.textContent = safeTitle;
    
    const messageEl = document.createElement('div');
    messageEl.className = 'toast-message';
    messageEl.textContent = safeMessage;
    
    const closeBtn = document.createElement('button');
    closeBtn.className = 'toast-close';
    closeBtn.type = 'button';
    closeBtn.textContent = 'Ã—';
    closeBtn.setAttribute('aria-label', 'Kapat');
    
    content.appendChild(titleEl);
    content.appendChild(messageEl);
    div.appendChild(icon);
    div.appendChild(content);
    div.appendChild(closeBtn);
    
    cont.appendChild(div);
    requestAnimationFrame(() => div.classList.add('show'));
    const close = () => { 
      div.classList.remove('show'); 
      setTimeout(() => div.remove(), 200); 
    };
    closeBtn.addEventListener('click', close);
    setTimeout(close, 4000);
  }
  window.showToast = showToast;

  /* Auth akÄ±ÅŸÄ± */
  // Supabase otomatik olarak session'Ä± saklar, persistence ayarÄ± gerekmez
  
  // App Shell'i baÅŸlat
  initAppShell();
  
  // DÃ¶ngÃ¼yÃ¼ Ã¶nlemek iÃ§in flag kontrolÃ¼
  let authCheckDone = false;
  let redirectInProgress = false;
  
  auth.onAuthStateChanged(async (user)=>{
    // EÄŸer yÃ¶nlendirme zaten yapÄ±lÄ±yorsa veya kontrol tamamlandÄ±ysa, tekrar yapma
    if (redirectInProgress || (authCheckDone && !user)) {
      return;
    }
    
    if(!user){
      authCheckDone = true;
      // Bir kez daha kontrol et ve yÃ¶nlendir
      setTimeout(()=>{ 
        // Supabase auth wrapper'da currentUser kontrolÃ¼
        const currentUser = auth && auth.currentUser ? auth.currentUser : null;
        if(!currentUser && !redirectInProgress) {
          redirectInProgress = true;
          // SessionStorage flag'ini temizle ki index.html tekrar kontrol edebilsin
          sessionStorage.removeItem('kf_auth_redirect_done');
          const indexPath = normalizeUrl('index.html');
          location.replace(indexPath);
        }
      }, 300);
      return;
    }
    
    // KullanÄ±cÄ± varsa, flag'i set et
    authCheckDone = true;
    redirectInProgress = false;
    try{
      setToday();
      const supabase = getSupabase();
      if (!supabase) {
        console.error('âŒ Supabase client yÃ¼klenmedi');
        showToast('error', 'BaÄŸlantÄ± HatasÄ±', 'Supabase baÄŸlantÄ±sÄ± kurulamadÄ±. LÃ¼tfen sayfayÄ± yenileyin.');
        throw new Error('Supabase client yÃ¼klenmedi');
      }
      
      // Supabase baÄŸlantÄ± testi
      console.log('ğŸ” Supabase baÄŸlantÄ± testi baÅŸlatÄ±lÄ±yor...');
      try {
        const { data: testData, error: testError } = await supabase
          .from('sayfa_manifesti')
          .select('id')
          .limit(1);
        
        if (testError) {
          console.error('âŒ Supabase baÄŸlantÄ± testi baÅŸarÄ±sÄ±z:', {
            code: testError.code,
            message: testError.message,
            details: testError.details,
            hint: testError.hint
          });
          
          // RLS hatasÄ± ise Ã¶zel mesaj
          if (testError.code === '42501' || testError.message?.includes('permission denied') || testError.message?.includes('RLS')) {
            console.error('ğŸ”’ RLS (Row Level Security) PolitikasÄ± HatasÄ±!');
            console.error('ğŸ’¡ Ã‡Ã¶zÃ¼m: Supabase Dashboard > Authentication > Policies bÃ¶lÃ¼mÃ¼nden RLS politikalarÄ±nÄ± ekleyin');
            console.error('ğŸ“‹ Gerekli politikalar:');
            console.error('   1. sayfa_manifesti tablosu iÃ§in SELECT izni');
            console.error('   2. kullanicilar tablosu iÃ§in SELECT izni (kendi kaydÄ±na eriÅŸim)');
            showToast('error', 'RLS PolitikasÄ± HatasÄ±', 'Tablolara eriÅŸim iÃ§in RLS politikasÄ± gerekli. Console\'u kontrol edin.');
          } else {
            showToast('error', 'BaÄŸlantÄ± HatasÄ±', `Supabase baÄŸlantÄ± hatasÄ±: ${testError.message || 'Bilinmeyen hata'}`);
          }
        } else {
          console.log('âœ… Supabase baÄŸlantÄ± testi baÅŸarÄ±lÄ±');
        }
      } catch (testErr) {
        console.error('âŒ Supabase baÄŸlantÄ± testi exception:', testErr);
      }
      
      // KullanÄ±cÄ± bilgilerini kullanicilar tablosundan yÃ¼kle (tablo yapÄ±sÄ±na gÃ¶re)
      // NOT: user.uid UUID formatÄ±nda, id alanÄ± text formatÄ±nda - string'e Ã§evir
      const userId = String(user.uid || '').trim();
      
      console.log('ğŸ” KullanÄ±cÄ± ID:', userId);
      console.log('ğŸ” KullanÄ±cÄ± ID tipi:', typeof userId, userId.length);
      
      // Supabase session'Ä±nÄ± kontrol et
      const { data: { session }, error: sessionError } = await supabase.auth.getSession();
      console.log('ğŸ” Supabase Session:', {
        hasSession: !!session,
        userId: session?.user?.id,
        sessionError: sessionError
      });
      
      // RLS politikasÄ±nÄ± test et - auth.uid() deÄŸerini kontrol et
      // SQL Editor'de ÅŸunu Ã§alÄ±ÅŸtÄ±rabilirsiniz: SELECT auth.uid();
      console.log('ğŸ” RLS Test: auth.uid() deÄŸeri session\'dan:', session?.user?.id);
      console.log('ğŸ” RLS Test: Sorgu ID ile eÅŸleÅŸiyor mu?', session?.user?.id === userId);
      
      // Ã–nce kullanÄ±cÄ±nÄ±n tabloda olup olmadÄ±ÄŸÄ±nÄ± kontrol et
      // RLS politikasÄ± nedeniyle direkt sorgu yapamÄ±yorsak, alternatif yÃ¶ntem dene
      let userData = null;
      let userError = null;
      
      try {
        // Ä°lk deneme: Normal sorgu
        const result = await supabase
          .from('kullanicilar')
          .select('id, adsoyad, email, rol, gorev, aktif, eklenmetarihi, yetkiler')
          .eq('id', userId)
          .maybeSingle();
        
        userData = result.data;
        userError = result.error;
        
        console.log('ğŸ” Sorgu sonucu (1. deneme):', { 
          hasData: !!userData, 
          dataKeys: userData ? Object.keys(userData) : [],
          error: userError 
        });
        
        // EÄŸer veri yoksa ve hata da yoksa, RLS politikasÄ± sorunu olabilir
        if (!userData && !userError) {
          console.warn('âš ï¸ Veri yok ve hata da yok - RLS politikasÄ± sorunu olabilir');
          console.warn('ğŸ’¡ RLS politikasÄ±nÄ± test edin:');
          console.warn('   SQL Editor\'de: SELECT * FROM kullanicilar WHERE id = auth.uid()::text;');
        }
        
        // Alternatif: TÃ¼m kayÄ±tlarÄ± Ã§ek (RLS politikasÄ± varsa sadece kendi kaydÄ±nÄ± gÃ¶recek)
        if (!userData && !userError) {
          console.log('ğŸ” Alternatif sorgu deneniyor: TÃ¼m kayÄ±tlar (RLS filtrelenecek)');
          const altResult = await supabase
            .from('kullanicilar')
            .select('id, adsoyad, email, rol, gorev, aktif, eklenmetarihi, yetkiler')
            .limit(10);
          
          console.log('ğŸ” Alternatif sorgu sonucu:', {
            count: altResult.data?.length || 0,
            data: altResult.data,
            error: altResult.error
          });
          
          // EÄŸer alternatif sorguda veri varsa ama kendi kaydÄ± yoksa, ID formatÄ± sorunu olabilir
          if (altResult.data && altResult.data.length > 0) {
            const found = altResult.data.find(u => u.id === userId);
            if (!found) {
              console.warn('âš ï¸ Alternatif sorguda veri var ama kullanÄ±cÄ± ID eÅŸleÅŸmiyor!');
              console.warn('ğŸ’¡ ID formatÄ± sorunu olabilir. Tablodaki ID formatÄ±nÄ± kontrol edin.');
              console.warn('   Tablodaki ID Ã¶rnekleri:', altResult.data.map(u => ({ id: u.id, type: typeof u.id })));
            } else {
              console.log('âœ… Alternatif sorguda kullanÄ±cÄ± bulundu!');
              userData = found;
            }
          }
        }
      } catch (err) {
        console.error('âŒ Sorgu exception:', err);
        userError = err;
      }
      
      if (userError) {
        console.error('âŒ KullanÄ±cÄ± bilgisi alÄ±namadÄ±:', {
          code: userError.code,
          message: userError.message,
          details: userError.details,
          hint: userError.hint,
          error: userError
        });
        
        // 406 hatasÄ± kontrolÃ¼ (Not Acceptable - genellikle Accept header sorunu)
        if (userError.code === 'PGRST116' || userError.message?.includes('406') || userError.message?.includes('Not Acceptable')) {
          console.warn('âš ï¸ 406 hatasÄ±: Accept header veya API versiyonu sorunu olabilir');
          console.warn('ğŸ’¡ Kontrol: Supabase client ayarlarÄ± ve API key doÄŸru mu?');
        }
        
        // RLS hatasÄ± kontrolÃ¼
        if (userError.code === '42501' || userError.message?.includes('permission denied') || userError.message?.includes('RLS')) {
          console.error('ğŸ”’ RLS hatasÄ± tespit edildi!');
          console.error('ğŸ’¡ Ã‡Ã¶zÃ¼m: scripts/archive/supabase-rls-policies.sql dosyasÄ±nÄ± Ã§alÄ±ÅŸtÄ±rdÄ±nÄ±z mÄ±?');
          showToast('error', 'Yetki HatasÄ±', 'KullanÄ±cÄ± bilgilerine eriÅŸim iÃ§in RLS politikasÄ± gerekli. LÃ¼tfen yÃ¶netici ile iletiÅŸime geÃ§in.');
        } else if (userError.code !== 'PGRST116') {
          // PGRST116 = no rows returned (kayÄ±t bulunamadÄ±) - bu normal olabilir
          showToast('error', 'Hata', `KullanÄ±cÄ± bilgileri yÃ¼klenemedi: ${userError.message || 'Bilinmeyen hata'}`);
        }
      }
      
      const data = userData || {};
      
      // EÄŸer kullanÄ±cÄ± verisi yoksa uyar ve debug bilgisi ver
      if (!userData || Object.keys(userData).length === 0) {
        console.warn('âš ï¸ KullanÄ±cÄ± verisi boÅŸ. KullanÄ±cÄ± ID:', user.uid);
        console.warn('ğŸ’¡ Kontrol edin:');
        console.warn('   1. kullanicilar tablosunda bu ID ile kayÄ±t var mÄ±?');
        console.warn('   2. RLS politikasÄ± doÄŸru mu? (kullanicilar_select_own)');
        console.warn('   3. KullanÄ±cÄ± ID formatÄ± doÄŸru mu? (UUID string)');
        
        // Supabase Dashboard'da kontrol iÃ§in SQL sorgusu Ã¶ner
        console.warn('ğŸ’¡ Test iÃ§in SQL Editor\'de ÅŸunu Ã§alÄ±ÅŸtÄ±rÄ±n:');
        console.warn(`   SELECT * FROM kullanicilar WHERE id = '${userId}';`);
        
        showToast('warning', 'UyarÄ±', 'KullanÄ±cÄ± bilgileri bulunamadÄ±. Console\'u kontrol edin.');
      }
      
      // KullanÄ±cÄ± aktif mi kontrolÃ¼
      if (data.aktif === false) {
        showToast('error', 'Hesap Pasif', 'HesabÄ±nÄ±z pasif durumda. LÃ¼tfen yÃ¶netici ile iletiÅŸime geÃ§in.');
        setTimeout(() => {
          auth.signOut();
          location.replace(normalizeUrl('index.html'));
        }, 2000);
        return;
      }
      
      // KullanÄ±cÄ± adÄ±nÄ± gÃ¶ster (sadece adSoyad - mail deÄŸil)
      const usernameEl = document.getElementById('username');
      if (usernameEl) {
        if (!data.adsoyad || data.adsoyad.trim() === '') {
          console.warn('KullanÄ±cÄ± adSoyad bilgisi bulunamadÄ±');
          usernameEl.textContent = 'KullanÄ±cÄ±';
        } else {
          usernameEl.textContent = data.adsoyad;
        }
      }
      
      // Profil ismi: Emoji + Ad Soyad
      const profNameEl = document.getElementById('profName');
      if (profNameEl) {
        if (!data.adsoyad || data.adsoyad.trim() === '') {
          profNameEl.textContent = 'ğŸ‘¤ Profil';
        } else {
          profNameEl.textContent = `ğŸ‘¤ ${data.adsoyad}`;
        }
      }

      // Yetkiler (Supabase'de text[] olarak gelir)
      const rawPerms = Array.isArray(data.yetkiler) ? data.yetkiler : [];
      console.log('ğŸ” Ham yetkiler (rawPerms):', rawPerms);
      console.log('ğŸ” Yetki sayÄ±sÄ±:', rawPerms.length);
      
      const allowSet = new Set(
        rawPerms
          .filter(s => {
            const str = String(s || '').trim();
            return str && !str.startsWith('-') && !str.startsWith('!');
          })
          .map(norm)
      );
      const denySet = new Set(
        rawPerms
          .filter(s => {
            const str = String(s || '').trim();
            return str && (str.startsWith('-') || str.startsWith('!'));
          })
          .map(s => norm(String(s).replace(/^[-!]\s*/, '')))
      );
      
      console.log('ğŸ” Ä°ÅŸlenmiÅŸ yetkiler (allowSet):', Array.from(allowSet));
      console.log('ğŸ” Ä°ÅŸlenmiÅŸ reddedilenler (denySet):', Array.from(denySet));
      console.log('ğŸ” Global yetki var mÄ±?', hasGlobalAllow(allowSet));
      
      // Window'a kopyala (ortak.js ve diÄŸer sayfalar iÃ§in)
      window.CURRENT_ALLOW = allowSet;
      window.CURRENT_DENY = denySet;

      // Sayfa manifesti ve yetkilere gÃ¶re panelleri yÃ¼kle
      console.log('ğŸ” Paneller yÃ¼kleniyor...');
      const panels = await fetchPanels(allowSet, denySet);
      console.log('ğŸ” YÃ¼klenen panel sayÄ±sÄ±:', panels.length);
      console.log('ğŸ” Paneller:', panels.map(p => ({ id: p.id, baslik: p.baslik, sayfaSayisi: p.pages?.length || 0 })));
      
      if (panels.length === 0 && !hasGlobalAllow(allowSet)) {
        console.warn('âš ï¸ KullanÄ±cÄ±nÄ±n eriÅŸebileceÄŸi panel bulunamadÄ±');
        console.warn('ğŸ’¡ Kontrol edin:');
        console.warn('   1. sayfa_manifesti tablosunda paneller var mÄ±?');
        console.warn('   2. Yetkiler sayfa key\'leri ile eÅŸleÅŸiyor mu?');
        console.warn('   3. sayfa_manifesti RLS politikasÄ± doÄŸru mu?');
        showToast('warning', 'Yetki Yok', 'EriÅŸebileceÄŸiniz panel bulunamadÄ±. Console\'u kontrol edin.');
      }
      
      renderNav(panels);
      
      // Optimize yÃ¼kleme stratejisi: Paralel yÃ¼kleme + cache
      await initDevreSelector();
      
      // Ortak yÃ¼kleme wrapper (kod tekrarÄ±nÄ± Ã¶nlemek iÃ§in)
      const loadCard = async (name, fn, elId) => {
        if(elId) setCardLoading(elId, true);
        try{
          await fn();
          if(elId) setCardLoading(elId, false);
        }catch(e){
          console.error(`${name} hatasÄ±:`, e);
          if(elId) { setCardLoading(elId, false); setCardError(elId, true); }
        }
      };
      
      // HÄ±zlÄ± kartlar (paralel yÃ¼kle - Ã¶nce gÃ¶ster)
      await Promise.all([
        loadCard('Bildirimler', loadNotifications, null),
        loadCard('NÃ¶betÃ§i', loadNobet, 'nobetEvli')
      ]);
      
      // AÄŸÄ±r kartlar + Temizlik kartlarÄ± (hepsini paralel yÃ¼kle - cache sayesinde hÄ±zlÄ±)
      await Promise.all([
        loadCard('Alacak Raporu', loadAlacak, 'nispetToplam'),
        loadCard('AylÄ±k Performans', loadAylik, 'top3List'),
        loadCard('Talebe Temizlik', loadTalebeTemizlik, 'kpiTalebeTemizlikOrt'),
        loadCard('Genel Temizlik', loadGenelTemizlik, 'kpiGenelTemizlikOrt'),
        loadCard('Teknik Eksikler', loadEksikler, 'kpiEksikSayisi')
      ]);
    }catch(e){
      console.error(e);
      showToast('error', 'Hata', 'Veriler yÃ¼klenirken hata.');
    }
  });
  </script>
</body>
</html>
