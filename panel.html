<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>KaraaÄŸaÃ§ Fatih</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" type="image/png" href="./img/logo.png" />
  <link rel="stylesheet" href="./css/app-shell.css" />

  <style>
    :root{
      --appbar-h:56px;
      --radius:14px; --shadow:0 12px 28px rgba(0,0,0,.14);
      --bg:#0f172a; --bg2:#0b1324;
      --grad1:#0ea5e922; --grad2:#22d3ee22;
      --card:rgba(15,23,42,.92); --stroke:rgba(148,163,184,.18);
      --text:#e5e7eb; --muted:#9aa4b2;
      --brand:#38bdf8; --brand2:#0ea5e9;
      --pill:#0b1220; --pill-hover:#101a2b;
      --link:#c7e9ff; --surface:rgba(2,6,23,.08);
      --danger:#ef4444;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f5f5f0; --bg2:#fafaf5; --grad1:#e5e5e022; --grad2:#d4d4d022;
        --card:rgba(255,255,255,.95);
        --stroke:rgba(15,23,42,.12);
        --text:#0b1220; --muted:#4b5563; --brand:#0ea5e9; --brand2:#0284c7;
        --pill:#f5f5f0; --pill-hover:#e9e9e4; --link:#0b5ea8; --surface:#f0f0eb;
        --danger:#b91c1c; --good:#16a34a; --warn:#d97706;
      }
    }
    html[data-theme="dark"]{
      --bg:#0f172a; --bg2:#0b1324; --grad1:#0ea5e922; --grad2:#22d3ee22;
      --card:rgba(15,23,42,.92); --stroke:rgba(148,163,184,.18);
      --text:#e5e7eb; --muted:#9aa4b2; --brand:#38bdf8; --brand2:#0ea5e9;
      --pill:#0b1220; --pill-hover:#101a2b; --link:#c7e9ff; --surface:rgba(2,6,23,.08);
      --danger:#ef4444; --good:#22c55e; --warn:#f59e0b;
    }
    html[data-theme="light"]{
      --bg:#f5f5f0; --bg2:#fafaf5; --grad1:#e5e5e022; --grad2:#d4d4d022;
      --card:rgba(255,255,255,.95); --stroke:rgba(15,23,42,.12);
      --text:#0b1220; --muted:#4b5563; --brand:#0ea5e9; --brand2:#0284c7;
      --pill:#f5f5f0; --pill-hover:#e9e9e4; --link:#0b5ea8; --surface:#f0f0eb;
      --danger:#b91c1c; --good:#16a34a; --warn:#d97706;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; 
      padding:0;
      padding-top:var(--appbar-h) !important; /* Ãœst panel iÃ§in boÅŸluk */
      color:var(--text);
      font-family:ui-sans-serif,-apple-system,"Segoe UI",Roboto,Arial;
      background: var(--bg);
      overflow-x:hidden; word-wrap:break-word;
    }
    a{color:var(--link); text-decoration:none}
    a:hover{text-decoration:underline}

    /* APPBAR - app-shell.css'den gelen stiller kullanÄ±lÄ±yor, burada sadece Ã¶zel override'lar */
    .appbar{
      position:fixed !important; 
      top:0 !important; 
      left:0 !important;
      right:0 !important;
      z-index:60 !important;
    }
    .nav-center{margin:0 auto; height:100%}
    .avatar{width:22px;height:22px;border-radius:999px;background:linear-gradient(180deg,#94a3b8,#64748b);display:inline-block}

    /* CONTENT */
    .container{max-width:1400px; margin:0 auto; padding:20px}
    .hero{
      display:flex; justify-content:space-between; align-items:flex-start; gap:20px;
      background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius);
      padding:24px; margin:20px 0; box-shadow:var(--shadow);
      position:relative; overflow:hidden;
    }
    .hero::before{
      content:''; position:absolute; top:0; right:0; width:200px; height:200px;
      background:radial-gradient(circle, var(--grad1), transparent 70%);
      opacity:0.3; pointer-events:none;
    }
    .hero h2{margin:0 0 8px; font-size:24px; font-weight:800; background:linear-gradient(135deg, var(--brand), var(--brand2)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; background-clip:text}
    .hero-sub{color:var(--muted); font-size:14px; margin-top:4px}
    .hero-actions{display:flex; gap:8px; flex-wrap:wrap}

    .grid{display:grid; gap:18px; grid-template-columns:repeat(12, minmax(0,1fr))}
    .col-4{grid-column:span 4} .col-12{grid-column:span 12}
    .card{
      background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius);
      box-shadow:var(--shadow); padding:18px; transition:all 0.3s ease;
      position:relative; overflow:hidden;
    }
    .card::before{
      content:''; position:absolute; top:0; left:0; right:0; height:3px;
      background:linear-gradient(90deg, var(--brand), var(--brand2));
      opacity:0; transition:opacity 0.3s;
    }
    .card:hover{
      transform:translateY(-2px); box-shadow:0 16px 32px rgba(0,0,0,.18);
      border-color:var(--brand);
    }
    .card:hover::before{opacity:1}
    .card h3{
      margin:0 0 16px; font-size:17px; font-weight:700;
      display:flex; align-items:center; gap:8px;
      color:var(--text);
    }
    .card h3::before{
      content:''; width:4px; height:20px; background:var(--brand);
      border-radius:2px; display:inline-block; flex-shrink:0;
    }
    .card h3 span{display:flex; align-items:center; gap:8px; flex:1}
    .kpi{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:16px; border-radius:14px; border:1px solid var(--stroke);
      background:linear-gradient(135deg, var(--surface), transparent);
      transition:all 0.2s; position:relative; overflow:hidden;
    }
    .kpi::before{
      content:''; position:absolute; top:0; left:0; width:100%; height:100%;
      background:radial-gradient(circle at top right, var(--grad1), transparent 60%);
      opacity:0; transition:opacity 0.3s;
    }
    .kpi:hover{transform:scale(1.02); border-color:var(--brand)}
    .kpi:hover::before{opacity:1}
    .kpi .val{font-size:26px; font-weight:900; color:var(--brand); position:relative; z-index:1}
    .kpi .sub{font-size:12px; color:var(--muted); position:relative; z-index:1; font-weight:600}
    .kpi > div:last-child{font-size:32px; opacity:0.6; position:relative; z-index:1; filter:drop-shadow(0 2px 4px rgba(0,0,0,.1))}
    .list{display:grid; gap:8px}
    .list-item{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:12px 14px; border-radius:10px; border:1px solid var(--stroke);
      background:var(--surface); transition:all 0.2s;
    }
    .list-item:hover{
      background:var(--pill-hover); transform:translateX(4px);
      border-color:var(--brand);
    }
    .list-item strong{color:var(--text); font-weight:700}
    
    /* Loading states */
    .card-loading{position:relative; opacity:0.6; pointer-events:none}
    .card-loading::after{content:''; position:absolute; top:0; left:0; right:0; bottom:0; background:var(--card); border-radius:var(--radius); display:flex; align-items:center; justify-content:center; z-index:10}
    .card-loading::before{content:'â³'; position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); z-index:11; font-size:24px; animation:spin 1s linear infinite}
    @keyframes spin{from{transform:translate(-50%,-50%) rotate(0deg)} to{transform:translate(-50%,-50%) rotate(360deg)}}
    .card-error{border-color:var(--danger)!important; opacity:0.8}
    .card-error::before{content:'âš ï¸'; position:absolute; top:8px; right:8px; font-size:18px; z-index:5}

    /* Toast - app-shell.css'den geliyor */
    .page-gap{height:160px}

    /* Animasyonlar */
    @keyframes fadeInUp{
      from{opacity:0; transform:translateY(20px)}
      to{opacity:1; transform:translateY(0)}
    }
    .card{animation:fadeInUp 0.4s ease-out}
    .card:nth-child(1){animation-delay:0.1s}
    .card:nth-child(2){animation-delay:0.2s}
    .card:nth-child(3){animation-delay:0.3s}
    .card:nth-child(4){animation-delay:0.4s}
    .card:nth-child(5){animation-delay:0.5s}
    .card:nth-child(6){animation-delay:0.6s}
    .card:nth-child(7){animation-delay:0.7s}
    .card:nth-child(8){animation-delay:0.8s}
    .card:nth-child(9){animation-delay:0.9s}

    @media (max-width: 960px){
      .col-4{grid-column:span 12}
      .hero{flex-direction:column; padding:18px}
      .hero h2{font-size:20px}
      .nav-center{display:none}
      .hamb{display:inline-flex}
      .container{padding:12px}
      .card{padding:14px}
      .kpi .val{font-size:22px}
    }
    @media (max-width: 640px){
      .hero{padding:14px; margin:12px 0}
      .hero h2{font-size:18px}
      .hero-sub{font-size:12px}
      .card h3{font-size:15px}
      .kpi{padding:12px}
      .kpi .val{font-size:20px}
      .list-item{padding:10px}
    }
    /* --- Top-3 kartlarÄ± iÃ§in ufak gÃ¶rsel dokunuÅŸlar --- */
    .rank{
      min-width:32px;height:32px;display:inline-flex;align-items:center;justify-content:center;
      border-radius:999px;border:2px solid var(--brand);background:linear-gradient(135deg, var(--brand), var(--brand2));
      font-weight:900;margin-right:10px;color:#fff;font-size:14px;
      box-shadow:0 2px 8px rgba(14,165,233,.3);
    }
    .rank.rank-1{background:linear-gradient(135deg, #fbbf24, #f59e0b); border-color:#f59e0b; box-shadow:0 2px 8px rgba(245,158,11,.4)}
    .rank.rank-2{background:linear-gradient(135deg, #94a3b8, #64748b); border-color:#64748b; box-shadow:0 2px 8px rgba(100,116,139,.3)}
    .rank.rank-3{background:linear-gradient(135deg, #cd7f32, #a0522d); border-color:#a0522d; box-shadow:0 2px 8px rgba(160,82,45,.3)}
    .amount{font-weight:800; color:var(--brand)}
    .meta{font-size:13px;color:var(--muted); margin-top:2px}
    .bar{height:8px;border-radius:999px;background:var(--surface);overflow:hidden;margin-top:8px; position:relative}
    .bar>span{
      display:block;height:100%;background:linear-gradient(90deg,var(--brand),var(--brand2));
      width:0; transition:width 0.6s ease; border-radius:999px;
      box-shadow:0 0 8px rgba(14,165,233,.4);
    }
/* Devre seÃ§ici (baÅŸlÄ±k iÃ§inde metin gibi) */
.devre-pill{
  display:inline-flex; align-items:center; gap:6px;
  font-weight:800; cursor:pointer; user-select:none;
  padding:2px 6px; border-radius:8px;
}
.devre-pill::after{ content:"â–¾"; font-size:12px; opacity:.7; }
.devre-pill:hover{ background:var(--surface); }

.devre-dd{
  position:absolute; margin-top:6px; padding:6px;
  background:var(--card); border:1px solid var(--stroke);
  border-radius:10px; box-shadow:var(--shadow); z-index:30;
}
#statHdr{ position:relative; }
.devre-dd button{
  display:block; width:100%; text-align:left;
  background:transparent; border:none; color:var(--text);
  padding:8px 10px; border-radius:8px; cursor:pointer; font-weight:700;
}
.devre-dd button:hover{ background:var(--surface); }
.devre-dd .active{ background:var(--surface); }
  </style>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="./js/firebase/firebase-init.js"></script>
  <script defer src="./js/ortak.js"></script>
</head>
<body>

  <!-- APPBAR -->
  <div class="appbar">
    <div class="brand" onclick="location.href='panel.html'">
      <img src="./img/logo.png" alt="logo"><span>KARAAÄAÃ‡ FATÄ°H</span>
    </div>

    <nav class="nav-center"><ul class="nav-list" id="navMain"></ul></nav>

    <div class="nav-right">
      <button class="btn hamb" id="hamburger" title="MenÃ¼">â˜°</button>

      <!-- Bildirim -->
      <div class="nav-item">
        <button class="iconbtn" id="btnNotif" title="Bildirimler">ğŸ””
          <span class="badge" id="notifBadge" style="display:none">0</span>
        </button>
        <div class="dropdown drop-right" id="notifDropdown" aria-label="Bildirim listesi">
          <div class="muted" style="padding:6px 8px">Son bildirimler</div>
          <div id="notifList" class="list" style="max-height:300px;overflow:auto"></div>
          <a href="diger/bildirim.html">TÃ¼m bildirimleri gÃ¶r â†’</a>
        </div>
      </div>

      <!-- Profil -->
      <div class="nav-item">
        <button class="iconbtn" id="btnProfile" title="Profil">
          <span id="profName" class="muted">Profil</span>
        </button>
        <div class="dropdown drop-right" id="profDropdown" aria-label="Profil menÃ¼sÃ¼">
          <a href="diger/kullanici-yonetimi.html">ğŸ‘¤ Profil</a>
          <a href="diger/sistem-ayarlari.html">âš™ï¸ Sistem AyarlarÄ±</a>
          <a href="#" id="btnLogout">ğŸšª Ã‡Ä±kÄ±ÅŸ Yap</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Mobil Ã§ekmece -->
  <aside class="drawer" id="drawer"></aside>

  <!-- CONTENT -->
  <main class="container">
    <section class="hero">
      <div style="flex:1">
        <h2>HoÅŸ Geldiniz, <span id="username" style="color:var(--brand)">â€”</span></h2>
        <div class="hero-sub">ğŸ“… BugÃ¼n: <span id="todayText">â€”</span></div>
        <div class="hero-actions" style="margin-top:12px">
        </div>
      </div>
    </section>

    <div class="grid">
      <!-- Talebe istatistiÄŸi -->
      <div class="card col-4" style="background:linear-gradient(135deg, var(--card), color-mix(in oklab, var(--card) 90%, var(--brand) 10%))">
        <h3 id="statHdr" style="margin-bottom:16px">
          <span>ğŸ‘¥ Talebe Ä°statistiÄŸi</span>
          <span id="devreBtn" class="devre-pill" role="button" aria-haspopup="listbox" aria-expanded="false" style="margin-left:auto; font-size:13px">â€”</span>
          <div id="devreDd" class="devre-dd" hidden role="listbox" aria-label="Devre seÃ§imi"></div>
        </h3>
        <div class="kpi" style="background:linear-gradient(135deg, rgba(14,165,233,.1), transparent)">
          <div><div class="val" id="kpiTalebe" style="font-size:28px">--</div><div class="sub">Toplam Talebe</div></div>
          <div style="font-size:36px">ğŸ‘¥</div>
        </div>
        <div class="kpi" style="margin-top:12px; background:linear-gradient(135deg, rgba(34,197,94,.1), transparent)">
          <div><div class="val" style="font-size:22px"><span id="kpiEnsar" style="color:var(--good)">--</span> / <span id="kpiMuhacir" style="color:var(--warn)">--</span></div><div class="sub">Ensar / Muhacir</div></div>
          <div style="font-size:32px">ğŸ“˜</div>
        </div>
      </div>

            <!-- NÃ¶betÃ§i -->
      <div class="card col-4" style="background:linear-gradient(135deg, var(--card), color-mix(in oklab, var(--card) 90%, #f59e0b 10%))">
        <h3><span>ğŸ• NÃ¶betÃ§i (09:00 â†’ 09:00)</span></h3>
        <div class="list" style="margin-top:12px">
          <div class="list-item" style="background:linear-gradient(135deg, rgba(14,165,233,.08), transparent)">
            <div style="display:flex; align-items:center; gap:8px">
              <span style="font-size:18px">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</span>
              <div><strong>Evli</strong></div>
            </div>
            <div id="nobetEvli" style="font-weight:800; color:var(--brand); font-size:16px">â€”</div>
          </div>
          <div class="list-item" style="background:linear-gradient(135deg, rgba(245,158,11,.08), transparent)">
            <div style="display:flex; align-items:center; gap:8px">
              <span style="font-size:18px">ğŸ‘¤</span>
              <div><strong>Bekar</strong></div>
            </div>
            <div id="nobetBekar" style="font-weight:800; color:var(--warn); font-size:16px">â€”</div>
          </div>
        </div>
      </div>

            <!-- Alacak Raporu -->
      <div class="card col-4" style="background:linear-gradient(135deg, var(--card), color-mix(in oklab, var(--card) 90%, #22c55e 10%))">
        <h3><span>ğŸ’° Alacak Raporu</span></h3>
        <div class="kpi" style="background:linear-gradient(135deg, rgba(34,197,94,.1), transparent)">
          <div><div class="val" id="nispetToplam" style="font-size:24px; color:var(--good)">--%</div><div class="sub">Toplam Tahsilat Nisp.</div></div>
          <div style="font-size:32px">ğŸ“ˆ</div>
        </div>
        <div class="kpi" style="margin-top:12px; background:linear-gradient(135deg, rgba(14,165,233,.08), transparent)">
          <div><div class="val" id="nispet2024" style="font-size:20px">--%</div><div class="sub">2024 Tahsilat Nisp.</div></div>
          <div style="font-size:28px">ğŸ“†</div>
        </div>
        <div class="kpi" style="margin-top:12px; background:linear-gradient(135deg, rgba(14,165,233,.08), transparent)">
          <div><div class="val" id="nispet2025" style="font-size:20px">--%</div><div class="sub">2025 Tahsilat Nisp.</div></div>
          <div style="font-size:28px">ğŸ“†</div>
        </div>
      </div>

      <!-- Talebe temizlik puanÄ± (bugÃ¼n) -->
      <div class="card col-4" style="background:linear-gradient(135deg, var(--card), color-mix(in oklab, var(--card) 90%, #38bdf8 10%))">
        <h3><span>ğŸ§½ Talebe Temizlik PuanÄ±</span></h3>
        <div class="kpi" style="background:linear-gradient(135deg, rgba(56,189,248,.1), transparent)">
          <div><div class="val" id="kpiTalebeTemizlikOrt" style="font-size:28px">--</div><div class="sub">GÃ¼nlÃ¼k Ortalama</div></div>
          <div style="font-size:36px">ğŸ§½</div>
        </div>
        <div class="list" id="talebeTemizlikTop5" style="margin-top:12px"></div>
      </div>

      <!-- Genel temizlik puanÄ± (bugÃ¼n â€“ kat bazlÄ±) -->
      <div class="card col-4" style="background:linear-gradient(135deg, var(--card), color-mix(in oklab, var(--card) 90%, #22c55e 10%))">
        <h3><span>ğŸ§¹ Genel Temizlik PuanÄ±</span></h3>
        <div class="kpi" style="background:linear-gradient(135deg, rgba(34,197,94,.1), transparent)">
          <div><div class="val" id="kpiGenelTemizlikOrt" style="font-size:28px">--</div><div class="sub">TÃ¼m Katlar Ortalama</div></div>
          <div style="font-size:36px">ğŸ§¹</div>
        </div>
        <div class="list" id="katOrtList" style="margin-top:12px"></div>
      </div>

      <!-- Teknik Eksikler (bugÃ¼n â€“ kat bazlÄ±) -->
      <div class="card col-4" style="background:linear-gradient(135deg, var(--card), color-mix(in oklab, var(--card) 90%, #ef4444 10%))">
        <h3><span>ğŸ› ï¸ Teknik Eksikler</span></h3>
        <div class="kpi" style="background:linear-gradient(135deg, rgba(239,68,68,.1), transparent)">
          <div><div class="val" id="kpiEksikSayisi" style="font-size:28px; color:var(--danger)">--</div><div class="sub">BugÃ¼n Toplam Eksik</div></div>
          <div style="font-size:36px">ğŸ› ï¸</div>
        </div>
        <div class="list" id="eksikList" style="margin-top:12px"></div>
      </div>

      <!-- AylÄ±k Top-3 (YÃ¼zde) -->
      <div class="card col-4" style="background:linear-gradient(135deg, var(--card), color-mix(in oklab, var(--card) 90%, #f59e0b 10%))">
        <h3><span>ğŸ† <span id="ayTop3">AÄŸustos AyÄ±</span> â€¢ En Fazla Tahsilat (YÃ¼zde)</span></h3>
        <div class="list" id="top3List" style="margin-top:12px"></div>
      </div>

      <!-- ğŸ†• AylÄ±k Top-3 (Tutar) -->
      <div class="card col-4" style="background:linear-gradient(135deg, var(--card), color-mix(in oklab, var(--card) 90%, #22c55e 10%))">
        <h3><span>ğŸ’µ <span id="ayTop3Tutar">AÄŸustos AyÄ±</span> â€¢ En Fazla Tahsilat (Tutar)</span></h3>
        <div class="list" id="top3TutarList" style="margin-top:12px"></div>
      </div>

      <!-- AylÄ±k HiÃ§ Tahsilat Yok -->
      <div class="card col-4" style="background:linear-gradient(135deg, var(--card), color-mix(in oklab, var(--card) 90%, #ef4444 10%))">
        <h3><span>âš ï¸ <span id="ayZero">AÄŸustos AyÄ±</span> â€¢ HiÃ§ Tahsilat Yapmayanlar</span></h3>
        <div class="list" id="zeroList" style="margin-top:12px"></div>
      </div>
    </div>

    <div class="page-gap"></div>
  </main>

  <div class="toast-container" id="toastContainer"></div>

  <script>
    /* Tema */
    (function(){
      const root=document.documentElement;
      const saved=localStorage.getItem('kf_theme')||'auto';
      apply(saved);
      function apply(mode){
        localStorage.setItem('kf_theme',mode);
        const sysDark=()=>window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches;
        const eff=(mode==='auto')?(sysDark()?'dark':'light'):mode;
        root.setAttribute('data-theme',eff);
      }
      if(window.matchMedia){
        const m=window.matchMedia('(prefers-color-scheme: dark)');
        m.addEventListener?.('change',()=>{ if((localStorage.getItem('kf_theme')||'auto')==='auto') apply('auto'); });
      }
    })();

    /* Helpers & Firebase */
    const db=firebase.firestore(), auth=firebase.auth();
    
    // XSS korumasÄ± - HTML escape
    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    function setToday(){const d=new Date(); const days=['Pazar','Pazartesi','SalÄ±','Ã‡arÅŸamba','PerÅŸembe','Cuma','Cumartesi']; document.getElementById('todayText').textContent=`${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()} â€¢ ${days[d.getDay()]}`;}
    const norm = (s) => String(s || '').normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase().trim();
    
    // Kart loading state yÃ¶netimi
    function setCardLoading(elementId, isLoading){
      const el = document.getElementById(elementId);
      if(!el) return;
      const card = el.closest('.card');
      if(!card) return;
      if(isLoading){
        card.classList.add('card-loading');
        card.classList.remove('card-error');
      } else {
        card.classList.remove('card-loading');
      }
    }
    function setCardError(elementId, hasError){
      const el = document.getElementById(elementId);
      if(!el) return;
      const card = el.closest('.card');
      if(!card) return;
      if(hasError){
        card.classList.add('card-error');
      } else {
        card.classList.remove('card-error');
      }
    }

    /* Yetki setleri - ortak.js'den geliyor */
    // window.CURRENT_ALLOW ve window.CURRENT_DENY ortak.js'den geliyor
    // Bu deÄŸiÅŸkenler window Ã¼zerinden eriÅŸilecek, burada tanÄ±mlamaya gerek yok

    /* ====== MenÃ¼ manifesti (deÄŸiÅŸmedi) ====== */
    // Path normalizasyonu - ortak.js'den geliÅŸtirilmiÅŸ versiyon
    function normalizeUrl(u) {
      if (!u || u === '#') return '#';
      // GÃ¼venlik: Sadece gÃ¼venli protokoller
      if (/^https?:\/\//i.test(u)) {
        try {
          const url = new URL(u);
          if (url.hostname === 'localhost' || url.hostname === '127.0.0.1' || url.hostname.endsWith(window.location.hostname)) {
            return u;
          }
          console.warn('External URL detected:', u);
          return '#';
        } catch (e) {
          return '#';
        }
      }
      if (u.startsWith('//')) return '#';
      // Zaten relative path ise olduÄŸu gibi dÃ¶ndÃ¼r
      if (u.startsWith('../') || u.startsWith('./')) {
        return u;
      }
      // Absolute path ise
      if (u.startsWith('/')) {
        return u;
      }
      // Relative path iÃ§in current directory'den hesapla
      const currentPath = location.pathname;
      const currentDir = currentPath.substring(0, currentPath.lastIndexOf('/'));
      const currentDepth = currentDir.split('/').filter(x => x).length;
      const upLevels = currentDepth > 0 ? '../'.repeat(currentDepth) : '';
      return upLevels + u;
    }
    
    async function fetchPanels(allowSet, denySet){
      const res=[];
      try{
        const snap=await db.collection('sayfa_manifesti').get();
        snap.forEach(doc=>{
          const d=doc.data()||{}, id=doc.id;
          const panelTitle=d.title||id;
          
          // Sistem AyarlarÄ± panelini Ã¼st menÃ¼den kaldÄ±r (sadece profil dropdown'unda kalacak)
          const panelTitleNorm = norm(panelTitle);
          const idNorm = norm(id);
          const excludedPanels = ['sistem ayarlarÄ±', 'ayarlar', 'diÄŸer', 'sistemayarlarÄ±', 'sistem-ayarlari'];
          if (excludedPanels.includes(panelTitleNorm) || excludedPanels.includes(idNorm) ||
              (panelTitleNorm.includes('sistem') && panelTitleNorm.includes('ayar'))) {
            return; // Bu paneli atla
          }
          
          const panelGrant = allowSet.has(norm(id)) || allowSet.has(norm(panelTitle));
          let pages = Array.isArray(d.pages)? d.pages : [];
          pages = pages.filter(pg=>{
            const keyNorm = norm(pg.key || pg.title || '');
            const pageGrant = allowSet.has(keyNorm);
            const denied    = denySet.has(keyNorm);
            return !denied && (panelGrant || pageGrant);
          }).map(pg=>({ baslik: pg.title || pg.key || 'Sayfa', url: normalizeUrl(pg.path || '#'), key: pg.key || pg.title || '', sira: typeof pg.order==='number'? pg.order : 9999 })).sort((a,b)=>a.sira-b.sira);
          if (pages.length===0) return;
          res.push({ id, baslik:panelTitle, sira: typeof d.order==='number'? d.order : 9999, pages });
        });
        res.sort((a,b)=>a.sira-b.sira);
      }catch(e){ console.error('sayfa_manifesti okunamadÄ±:', e); }
      return res;
    }
    function renderNav(panels){
      const ul=document.getElementById('navMain'), drawer=document.getElementById('drawer');
      if (!ul || !drawer) return;
      ul.innerHTML=''; drawer.innerHTML='';
      if(!panels.length){
        const li = document.createElement('li');
        li.className = 'nav-item';
        const btn = document.createElement('div');
        btn.className = 'nav-btn';
        btn.textContent = 'MenÃ¼ yok';
        li.appendChild(btn);
        ul.appendChild(li);
        const emptyMsg = document.createElement('div');
        emptyMsg.className = 'muted';
        emptyMsg.style.padding = '8px';
        emptyMsg.textContent = 'MenÃ¼ bulunamadÄ±';
        drawer.appendChild(emptyMsg);
        return;
      }
      panels.forEach(p=>{
        const li=document.createElement('li'); li.className='nav-item';
        // GÃ¼venli DOM oluÅŸturma - innerHTML yerine
        const btn = document.createElement('div');
        btn.className = 'nav-btn';
        btn.textContent = escapeHtml(p.baslik || 'Panel');
        const caret = document.createElement('span');
        caret.className = 'caret';
        caret.textContent = 'â–¾';
        btn.appendChild(caret);
        li.appendChild(btn);
        
        const dd=document.createElement('div'); dd.className='dropdown';
        
        // Sayfa yoksa dropdown oluÅŸturma
        if (!p.pages || p.pages.length === 0) {
          btn.style.cursor = 'default';
        } else {
          (p.pages||[]).forEach(pg=>{
            const a=document.createElement('a');
            a.href=normalizeUrl(pg.url || pg.path || '#'); 
            a.textContent=escapeHtml(pg.baslik || 'Sayfa');
            a.dataset.key=escapeHtml(pg.key||pg.baslik||''); 
            a.dataset.panel=escapeHtml(p.id||''); 
            a.dataset.panelTitle=escapeHtml(p.baslik||'');
            dd.appendChild(a);
          });
          li.appendChild(dd);
          
          btn.addEventListener('click',(e)=>{
            e.preventDefault();
            e.stopPropagation();
            ul.querySelectorAll('.nav-item').forEach(x=>{ if(x!==li) x.classList.remove('open'); });
            li.classList.toggle('open');
          });
        }
        ul.appendChild(li);
      });
      
      // Dropdown dÄ±ÅŸÄ±na tÄ±klanÄ±nca kapat
      document.addEventListener('click',(e)=>{
        if (e.target.closest('.dropdown a')) {
          setTimeout(() => {
            ul.querySelectorAll('.nav-item').forEach(x => x.classList.remove('open'));
          }, 100);
          return;
        }
        if (!ul.contains(e.target) && !e.target.closest('.dropdown')) {
          ul.querySelectorAll('.nav-item').forEach(x => x.classList.remove('open'));
        }
      });

      // mobil
      panels.forEach(p=>{
        const h=document.createElement('div'); h.className='panel-title'; h.textContent=escapeHtml(p.baslik||'Panel'); drawer.appendChild(h);
        (p.pages||[]).forEach(pg=>{
          const a=document.createElement('a');
          a.href=normalizeUrl(pg.url || pg.path || '#'); 
          a.textContent=escapeHtml(pg.baslik||'Sayfa');
          a.dataset.key=escapeHtml(pg.key||pg.baslik||''); 
          a.dataset.panel=escapeHtml(p.id||''); 
          a.dataset.panelTitle=escapeHtml(p.baslik||'');
          drawer.appendChild(a);
        });
      });
    }
    /* App Shell init - ortak.js'den */
    function initAppShell() {
      // Hamburger & Drawer
      const hamb = document.getElementById('hamburger'), drawer = document.getElementById('drawer');
      if (hamb && drawer) {
        hamb.addEventListener('click', () => drawer.classList.toggle('open'));
        document.addEventListener('click', (e) => {
          if (!drawer.contains(e.target) && !hamb.contains(e.target)) drawer.classList.remove('open');
        });
      }

      // Bildirim & Profil Dropdown
      const notifBtn = document.getElementById('btnNotif');
      const notifDD = document.getElementById('notifDropdown');
      const profBtn = document.getElementById('btnProfile');
      const profDD = document.getElementById('profDropdown');
      
      function closeAll(e) {
        if (notifDD && !notifDD.contains(e.target) && e.target !== notifBtn) {
          notifDD.parentElement.classList.remove('open');
        }
        if (profDD && !profDD.contains(e.target) && e.target !== profBtn) {
          profDD.parentElement.classList.remove('open');
        }
      }
      document.addEventListener('click', closeAll);
      
      if (notifBtn && notifDD) {
        notifBtn.addEventListener('click', (e) => { 
          e.stopPropagation(); 
          notifDD.parentElement.classList.toggle('open'); 
          if (profDD) profDD.parentElement.classList.remove('open'); 
        });
      }
      
      if (profBtn && profDD) {
        profBtn.addEventListener('click', (e) => { 
          e.stopPropagation(); 
          profDD.parentElement.classList.toggle('open'); 
          if (notifDD) notifDD.parentElement.classList.remove('open'); 
        });
      }
      
      // Logout
      const btnLogout = document.getElementById('btnLogout');
      if (btnLogout) {
        btnLogout.addEventListener('click', async (e) => {
          e.preventDefault();
          try { 
            await auth.signOut(); 
            const indexPath = normalizeUrl('index.html');
            location.assign(indexPath); 
          } catch (err) { 
            console.error('Ã‡Ä±kÄ±ÅŸ hatasÄ±:', err); 
            showToast('error', 'Hata', 'Ã‡Ä±kÄ±ÅŸ yapÄ±lamadÄ±.');
          }
        });
      }

      // Link guard - yetki kontrolÃ¼
      document.addEventListener('click', (e) => {
        const a = e.target.closest('a[data-key]');
        if (!a) return;
        const key = norm(a.dataset.key || '');
        const pnl = norm(a.dataset.panel || '');
        const pnlTitle = norm(a.dataset.panelTitle || '');
        
        const allowSet = window.CURRENT_ALLOW || new Set();
        const denySet = window.CURRENT_DENY || new Set();
        
        if (!key && (pnl || pnlTitle)) {
          if (allowSet.has(pnl) || allowSet.has(pnlTitle)) {
            return;
          }
        }
        
        if (key && denySet.has(key)) { 
          e.preventDefault(); 
          showToast('warning', 'Yetki Yok', 'Bu sayfa iÃ§in yetkiniz yok.');
          return; 
        }
        
        const allowed = !key || allowSet.has(key) || allowSet.has(pnl) || allowSet.has(pnlTitle);
        if (!allowed) { 
          e.preventDefault(); 
          showToast('warning', 'Yetki Yok', 'Bu sayfa iÃ§in yetkiniz yok.');
        }
      });
    }

    /* ===== Dinamik Kartlar ===== */
    // Panelde raporlayacaÄŸÄ±n katlarÄ±n etiketi
    const KATLAR = ['2.Kat - Lokal','1.Kat - EtÃ¼t','0.Kat - GiriÅŸ','-1.Kat - Yatakhane','-2.Kat - Yemekhane','BahÃ§e'];
    const monthsTR = ['Ocak','Åubat','Mart','Nisan','MayÄ±s','Haziran','Temmuz','AÄŸustos','EylÃ¼l','Ekim','KasÄ±m','AralÄ±k'];
    function toDate(v){
      if(!v) return null;
      if(typeof v.toDate==='function') return v.toDate();
      if(typeof v==='number') return new Date(v);
      if(typeof v==='string'){ const d=new Date(v); if(!isNaN(d)) return d; }
      return null;
    }
    function rangeYear(year){ return { start:new Date(year,0,1,0,0,0), end:new Date(year,11,31,23,59,59,999) }; }
    function rangeMonth(d){ return { start:new Date(d.getFullYear(), d.getMonth(), 1, 0,0,0), end:new Date(d.getFullYear(), d.getMonth()+1, 0, 23,59,59,999) }; }

    // Ä°sim tekilleÅŸtirme ve gÃ¶rselleÅŸtirme (global - tekrar kullanÄ±m iÃ§in)
    const tidy   = s => (s||'').toString().trim().replace(/\s+/g,' ');
    const normTR = s => tidy(s).toLocaleLowerCase('tr-TR');
    function nameKey(s){ return normTR(s).toUpperCase(); }

    // Ã‡ok alanlÄ± isim yakalayÄ±cÄ± (isim eksiklerini azaltÄ±r)
    function coalesceName(obj){
      const cand = [
        obj?.personel, obj?.personelAd, obj?.sorumlu, obj?.adSoyad, obj?.isim, obj?.ad_soyad, obj?.ad_soyad,
        obj?.ad, obj?.name
      ].map(tidy).filter(Boolean);
      if (cand.length) return cand[0];
      // e-posta varsa ad@â€¦ â†’ â€œadâ€ yakala
      const mail = tidy(obj?.email || obj?.mail || obj?.eposta);
      if (mail.includes('@')) return mail.split('@')[0];
      return 'â€”';
    }

    // Para biÃ§imlendirici
    function fmtTL(n){ const v=Number(n||0); return isNaN(v) ? 'â‚º0' : 'â‚º ' + v.toLocaleString('tr-TR'); }

    // === Ortak yardÄ±mcÄ±lar (TR gÃ¼nÃ¼) ===
    function todayStrTR(){
      const now = new Date();
      // Ä°stanbul TZ ile gÃ¼nÃ¼ fixle
      const tz = new Date(now.toLocaleString('en-US',{timeZone:'Europe/Istanbul'}));
      const y = tz.getFullYear(), m = String(tz.getMonth()+1).padStart(2,'0'), d = String(tz.getDate()).padStart(2,'0');
      return `${y}-${m}-${d}`;
    }
    function avg(nums){ if(!nums.length) return 0; const s=nums.reduce((a,b)=>a+(+b||0),0); return Math.round((s/nums.length)*10)/10; }

    // Kattaki toplam mahal sayÄ±sÄ±nÄ± getir (temizlik_listesi > temizlik_katlari fallback)
    async function getToplamMahaller(kat){
      try{
        const snap = await db.collection('temizlik_listesi').doc(kat).collection('mahaller').get();
        if(!snap.empty) return snap.size;
      }catch(_){}
      try{
        const ds = await db.collection('temizlik_katlari').doc(kat).get();
        if(ds.exists){
          const d = ds.data()||{};
          if (Array.isArray(d.mahaller)) return d.mahaller.length;
          if (d.mahaller && typeof d.mahaller==='object') return Object.keys(d.mahaller).length;
        }
      }catch(_){}
      return 0;
    }
/* ===== Talebe Ä°statistiÄŸi â€” devreli (yeni/eski ÅŸema uyumlu) ===== */

/** Yeni ÅŸemada alt koleksiyon adÄ± (Ã¶ÄŸrenciler | ogrenciler) */
async function resolveSubcolName(devre){
  const base = db.collection('talebeler').doc(devre);
  for (const name of ['Ã¶ÄŸrenciler','ogrenciler']){
    try{
      const s = await base.collection(name).limit(1).get();
      if(!s.empty) return name;
    }catch(_){}
  }
  return null;
}

/** Yeni ÅŸema sayÄ±mÄ±: talebeler/{devre}/{Ã¶ÄŸrenciler|ogrenciler} */
async function countNewSchema(devre){
  const base = db.collection('talebeler').doc(devre);
  const sub  = await resolveSubcolName(devre);
  if(!sub) return null;

  const snap = await base.collection(sub).get();
  let toplam = 0, ensar = 0, muhacir = 0;

  snap.forEach(doc=>{
    const d = doc.data() || {};
    toplam++;
    const durum = String(d.durum || d.profil?.durum || '').toLowerCase();
    if(durum==='ensar') ensar++;
    else if(durum==='muhacir') muhacir++;
  });

  return { toplam, ensar, muhacir };
}

/** Eski ÅŸema sayÄ±mÄ±: devre alanÄ±na gÃ¶re (birkaÃ§ olasÄ± koleksiyonda) */
async function countOldSchema(devre){
  const CANDS = ['talebe_index','talebe_kayitlari','talebe_kayit','talebeKayit','talebeler'];
  let toplam=0, ensar=0, muhacir=0, found=false;

  // devre alanÄ± olan belgeleri sorgulamayÄ± dene
  for(const col of CANDS){
    try{
      const q = await db.collection(col).where('devre','==',devre).get();
      if(!q.empty){
        found = true;
        q.forEach(doc=>{
          const d = doc.data() || {};
          toplam++;
          const durum = String(d.durum || d.profil?.durum || '').toLowerCase();
          if(durum==='ensar') ensar++;
          else if(durum==='muhacir') muhacir++;
        });
      }
    }catch(_){}
  }
  if(!found) return null;
  return { toplam, ensar, muhacir };
}

/** Devre listesi: yeni ÅŸemada talebeler/{devre} IDâ€™leri; yoksa varsayÄ±lanlar */
async function getDevreList(){
  try{
    const snap = await db.collection('talebeler').get();
    const ids = [];
    snap.forEach(d=> ids.push(d.id));
    // Sadece 5/6/7.devre gibi olanlarÄ± Ã¶ne al, diÄŸerlerini sona ekle
    const pref = ['5.Devre','6.Devre','7.Devre'];
    const ordered = [
      ...pref.filter(x=>ids.includes(x)),
      ...ids.filter(x=>!pref.includes(x))
    ];
    return ordered.length ? ordered : pref;
  }catch(e){ return ['5.Devre','6.Devre','7.Devre']; }
}

/** UI: baÅŸlÄ±ktaki devre menÃ¼sÃ¼nÃ¼ kur */
async function initDevreSelector(){
  const btn = document.getElementById('devreBtn');
  const dd  = document.getElementById('devreDd');
  if(!btn || !dd) return;

  const list = await getDevreList();
  const stored = localStorage.getItem('kf_devre');
  let current = list.includes(stored) ? stored : (list[0]||'6.Devre');

  function renderDd(){
    dd.innerHTML = '';
    list.forEach(dev=>{
      const b = document.createElement('button');
      b.textContent = dev;
      if(dev===current) b.classList.add('active');
      b.dataset.devre = dev;
      b.addEventListener('click', async ()=>{
        current = dev;
        localStorage.setItem('kf_devre', current);
        btn.textContent = current;
        dd.hidden = true; btn.setAttribute('aria-expanded','false');
        await loadTalebeStatsByDevre(current);
      });
      dd.appendChild(b);
    });
  }

  btn.textContent = current;
  renderDd();

  btn.addEventListener('click', (e)=>{
    e.stopPropagation();
    const open = dd.hidden === false;
    dd.hidden = open ? true : false;
    btn.setAttribute('aria-expanded', String(!open));
  });
  document.addEventListener('click', (e)=>{
    if(!dd.contains(e.target) && e.target!==btn){ dd.hidden = true; btn.setAttribute('aria-expanded','false'); }
  });

  // ilk yÃ¼k
  await loadTalebeStatsByDevre(current);
}

/** SeÃ§ili devreye gÃ¶re sayÄ±mlarÄ± yÃ¼kle (yeni â†’ eski fallback) */
async function loadTalebeStatsByDevre(devre){
  const elT = document.getElementById('kpiTalebe');
  const elE = document.getElementById('kpiEnsar');
  const elM = document.getElementById('kpiMuhacir');
  if(elT) elT.textContent='â€”';
  if(elE) elE.textContent='â€”';
  if(elM) elM.textContent='â€”';

  try{
    let res = await countNewSchema(devre);
    if(!res) res = await countOldSchema(devre);
    if(!res){ elT.textContent='0'; elE.textContent='0'; elM.textContent='0'; return; }
    elT.textContent = res.toplam || 0;
    elE.textContent = res.ensar  || 0;
    elM.textContent = res.muhacir|| 0;

    // BaÅŸlÄ±ktaki metin â€œTalebe Ä°statistiÄŸi â€“ {devre}â€
    const btn = document.getElementById('devreBtn');
    if(btn) btn.textContent = devre;

  }catch(e){
    console.error('Talebe sayÄ±larÄ± yÃ¼klenemedi:', e);
    if(elT) elT.textContent='--';
    if(elE) elE.textContent='--';
    if(elM) elM.textContent='--';
  }
}

    // 1) TEMÄ°ZLÄ°K KONTROLÃœ â€” tek kat, tek gÃ¼n
    async function fetchTemizlikKontrolKatGun(kat, dateStr){
      const col = db.collection('temizlik_kontrol').doc(kat).collection(dateStr);
      const snap = await col.get();
      const puanlar = [], zeroes = [];
      snap.forEach(doc=>{
        const v = doc.data()||{};
        const p = Number(v.puan)||0;
        puanlar.push(p);
        if(p===0) zeroes.push(1);
      });
      const kayitli = snap.size;
      const toplam = await getToplamMahaller(kat);
      const kapsama = toplam>0? kayitli/toplam : null;
      const ortalama = avg(puanlar);
      const eksikMah = toplam>0? Math.max(0, toplam-kayitli): 0;
      const uyari = eksikMah + zeroes.length; // 0 puan + eksik giriÅŸ
      return { kat, kayitli, toplam, kapsama, ortalama, uyari };
    }

    // 2) GENEL TEMÄ°ZLÄ°K â€” _summary varsa onu kullan
    async function fetchGenelSummaryKatGun(kat, dateStr){
      const root = db.collection('genel_temizlik_kontrol').doc(kat).collection(dateStr);
      const sum = await root.doc('_summary').get();
      if(sum.exists){
        const d = sum.data()||{};
        return { kat, submissions: d.submissions||0, avgPuan100: d.avgPuan100 ?? Math.round((d.avgPuan10||0)*10), eksikAny: !!d.eksik_var_any };
      }
      const snap = await root.get();
      let s=0, n=0, eksik=false;
      snap.forEach(doc=>{
        if(doc.id==='_summary') return;
        const v=doc.data()||{};
        if(typeof v.puan10==='number'){ s+=v.puan10; n++; }
        if(v.eksik_var) eksik = true;
      });
      const avg100 = n? Math.round((s/n)*10): 0;
      return { kat, submissions:n, avgPuan100: avg100, eksikAny: eksik };
    }

    // 3) DETAYLI â€” _summary / fallback
    async function fetchDetaySummaryKatGun(kat, dateStr){
      const root = db.collection('genel_temizlik_detay').doc(kat).collection(dateStr);
      const sum = await root.doc('_summary').get();
      if(sum.exists){
        const d = sum.data()||{};
        return { kat, submissions: d.submissions||0, avgPuan100: d.avgPuan100 ?? 0, eksikAny: !!d.eksik_var_any };
      }
      const snap = await root.get();
      let s=0, n=0, eksik=false;
      snap.forEach(doc=>{
        if(doc.id==='_summary') return;
        const v=doc.data()||{};
        if(typeof v.puan100==='number'){ s+=v.puan100; n++; }
        if(v.eksik_var) eksik = true;
      });
      const avg100 = n? Math.round(s/n): 0;
      return { kat, submissions:n, avgPuan100: avg100, eksikAny: eksik };
    }

    // 4) EKSÄ°KLER â€” aÃ§Ä±k kayÄ±tlar
    async function fetchEksikler({dateStr=null, kat=null, status='acik'}={}){
      let q = db.collection('eksik_bildirim').where('status','==', status);
      if(dateStr) q = q.where('tarih','==', dateStr);
      if(kat)     q = q.where('kat','==', kat);
      const snap = await q.get();
      const list = [];
      snap.forEach(doc=>{
        const v=doc.data()||{};
        const parcalar = String(v.aciklama||'').split('/').map(s=>s.trim()).filter(Boolean);
        list.push({ id: doc.id, kat: v.kat||'â€”', tarih: v.tarih||'â€”', uid: v.uid||'', email: v.email||'', aciklama: v.aciklama||'', parcalar, createdAt: v.createdAt||null, status: v.status||'acik' });
      });
      return { count: snap.size, list };
    }

    // Ortalama hesaplama helper (kod tekrarÄ±nÄ± Ã¶nlemek iÃ§in)
    const calcWeightedAvg = (rows, valKey, weightKey) => {
      let s=0, c=0;
      rows.forEach(r=>{
        const val = r[valKey]||0;
        const weight = r[weightKey]||0;
        if(weight > 0 && Number.isFinite(val)){
          s += val * weight;
          c += weight;
        }
      });
      return c ? Math.round((s/c)*10)/10 : 0;
    };

    // === Hepsini toplu: panel kartlarÄ± iÃ§in tek fonksiyon (optimize edilmiÅŸ)
    async function buildTemizlikDashboard({kats, dateStr = todayStrTR()}){
      // TÃ¼m verileri paralel yÃ¼kle (daha hÄ±zlÄ±)
      const [tkRows, genelRows, detayRows, eksik] = await Promise.all([
        Promise.all(kats.map(k=> fetchTemizlikKontrolKatGun(k, dateStr))),
        Promise.all(kats.map(k=> fetchGenelSummaryKatGun(k, dateStr))),
        Promise.all(kats.map(k=> fetchDetaySummaryKatGun(k, dateStr))),
        fetchEksikler({dateStr, status:'acik'})
      ]);
      
      const tk = {
        toplamMahaller: tkRows.reduce((a,r)=> a + (r.toplam||0), 0),
        doldurulan:     tkRows.reduce((a,r)=> a + (r.kayitli||0), 0),
        ortalamaPuan:   calcWeightedAvg(tkRows, 'ortalama', 'kayitli'),
        uyari:          tkRows.reduce((a,r)=> a + (r.uyari||0), 0),
        katlar:         tkRows
      };

      const genel = {
        submissions:  genelRows.reduce((a,r)=> a+(r.submissions||0), 0),
        avgPuan100:   calcWeightedAvg(genelRows, 'avgPuan100', 'submissions'),
        eksikAny:     genelRows.some(r=> r.eksikAny),
        katlar:       genelRows
      };

      const detay = {
        submissions:  detayRows.reduce((a,r)=> a+(r.submissions||0), 0),
        avgPuan100:   calcWeightedAvg(detayRows, 'avgPuan100', 'submissions'),
        eksikAny:     detayRows.some(r=> r.eksikAny),
        katlar:       detayRows
      };

      return { date: dateStr, temizlik: tk, genel, detay, eksik };
    }

  // Temizlik dashboard cache (aynÄ± gÃ¼n iÃ§in tekrar Ã§aÄŸrÄ±lmamasÄ± iÃ§in)
  let _temizlikCache = { date: null, data: null };
  
  // Ortak temizlik verisi yÃ¼kleme (cache'li)
  async function getTemizlikData(dateStr = todayStrTR()){
    if(_temizlikCache.date === dateStr && _temizlikCache.data) return _temizlikCache.data;
    const data = await buildTemizlikDashboard({kats: KATLAR, dateStr});
    _temizlikCache = { date: dateStr, data };
    return data;
  }

  /* ===== Talebe Temizlik PuanÄ± (BugÃ¼n) â€“ kat kat + genel ortalama ===== */
  async function loadTalebeTemizlik(){
    const dateStr = todayStrTR();
    const listEl = document.getElementById("talebeTemizlikTop5");
    const kpiEl  = document.getElementById("kpiTalebeTemizlikOrt");
    if(!listEl || !kpiEl) return;
    listEl.innerHTML = '';

    try{
      const data = await getTemizlikData(dateStr);
      kpiEl.textContent = Number.isFinite(data.temizlik.ortalamaPuan) ? data.temizlik.ortalamaPuan.toFixed(1) : '--';

      data.temizlik.katlar
        .slice()
        .sort((a,b)=> (b.ortalama||0)-(a.ortalama||0))
        .forEach(r=>{
          const kaps = (r.kapsama!=null) ? Math.round((r.kapsama*100))+'%' : 'â€”';
          const el=document.createElement('div'); el.className='list-item';
          el.innerHTML = `<div><strong>${r.kat}</strong><div class="sub" style="font-size:12px;color:var(--muted)">KayÄ±t: ${r.kayitli}/${r.toplam} â€¢ Kapsama: ${kaps}</div></div><div>${(Number.isFinite(r.ortalama)? r.ortalama.toFixed(1): 'â€”')}</div>`;
          listEl.appendChild(el);
        });
    }catch(e){
      console.error('Talebe temizlik hatasÄ±:', e);
      if(kpiEl) kpiEl.textContent='--';
      if(listEl) listEl.innerHTML='<div class="muted">Veri yÃ¼klenemedi.</div>';
    }
  }

  /* ===== Genel Temizlik (bugÃ¼n) ===== */
  async function loadGenelTemizlik(){
    const dateStr = todayStrTR();
    const kpi = document.getElementById("kpiGenelTemizlikOrt");
    const cont = document.getElementById("katOrtList");
    if(!kpi || !cont) return;
    cont.innerHTML='';

    try{
      const data = await getTemizlikData(dateStr);
      kpi.textContent = Number.isFinite(data.genel.avgPuan100) ? data.genel.avgPuan100 : '--';

      data.genel.katlar
        .slice()
        .sort((a,b)=> (b.avgPuan100||0) - (a.avgPuan100||0))
        .forEach(r=>{
          const el=document.createElement('div'); el.className='list-item';
          el.innerHTML = `<div><strong>${r.kat}</strong><div class="sub" style="font-size:12px;color:var(--muted)">Form: ${r.submissions} â€¢ ${r.eksikAny?'Eksik var':'Tam'}</div></div><div>${(r.avgPuan100??'â€”')}</div>`;
          cont.appendChild(el);
        });
    }catch(e){
      console.error('Genel temizlik hatasÄ±:', e);
      if(kpi) kpi.textContent='--';
      if(cont) cont.innerHTML='<div class="muted">Veri yÃ¼klenemedi.</div>';
    }
  }

  /* ===== Alacak Raporu: toplam, 2024, 2025 ===== */
async function loadAlacak(){
  const years = [2024, 2025];

  // Verileri al
  const [tSnap, sSnap] = await Promise.all([
    db.collection('tahakkuklar').get(),
    db.collection('tahsilatlar').get()
  ]);

  // Tahakkuk indeksleri
  const tahById   = new Map();                     // id -> tahakkuk doc
  const keyToId   = new Map();                     // "yil||faaliyet||personel||borclu" -> tahakkuk id
  const yearTah   = Object.fromEntries(years.map(y=>[y,0]));
  const yearThs   = Object.fromEntries(years.map(y=>[y,0]));

  tSnap.forEach(doc=>{
    const v = doc.data()||{};
    const y = Number(v.yil);
    const tahakkuk = Number(v.tahakkuk||0);
    tahById.set(doc.id, v);
    const key = `${y}||${normTR(v.faaliyet)}||${normTR(v.personel)}||${normTR(v.borclu)}`;
    keyToId.set(key, doc.id);
    if (years.includes(y)) yearTah[y] += tahakkuk;
  });

  // TahsilatÄ± sadece eÅŸleÅŸirse say: Ã¶nce id, yoksa composite key
  sSnap.forEach(doc=>{
    const v = doc.data()||{};
    let tahYear = null;

    if (v.tahakkukId && tahById.has(v.tahakkukId)) {
      tahYear = Number(tahById.get(v.tahakkukId).yil);
    } else {
      const y  = Number(v.yil) || (toDate(v.tarih)?.getFullYear());
      const k  = `${y}||${normTR(v.faaliyet)}||${normTR(v.personel)}||${normTR(v.borclu)}`;
      const tk = keyToId.get(k);
      if (tk && tahById.has(tk)) tahYear = Number(tahById.get(tk).yil);
    }

    if (years.includes(tahYear)) yearThs[tahYear] += Number(v.tutar||0);
  });

  // YazdÄ±r
  const totalTah = years.reduce((s,y)=>s+yearTah[y],0);
  const totalThs = years.reduce((s,y)=>s+yearThs[y],0);
  document.getElementById('nispetToplam').textContent = totalTah ? (totalThs/totalTah*100).toFixed(1)+'%' : '--%';
  document.getElementById('nispet2024').textContent   = yearTah[2024] ? (yearThs[2024]/yearTah[2024]*100).toFixed(1)+'%' : '--%';
  document.getElementById('nispet2025').textContent   = yearTah[2025] ? (yearThs[2025]/yearTah[2025]*100).toFixed(1)+'%' : '--%';
}

  /* ===== AylÄ±k performans: Topâ€‘3 (yÃ¼zde) & 0% =====
     - YÃ¼zde = (personelin bu ayki tahsilatÄ±) / (aynÄ± yÄ±ldaki toplam tahakkuku) * 100
  */
async function loadAylik(){

  const now = new Date();
  const { start, end } = (()=>{
    const s = new Date(now.getFullYear(), now.getMonth(), 1);
    const e = new Date(now); e.setHours(23,59,59,999); // ayÄ±n bugÃ¼ne kadarki kÄ±smÄ±
    return { start:s, end:e };
  })();
  const yil = now.getFullYear();
  document.getElementById('ayTop3').textContent     = monthsTR[now.getMonth()]+' AyÄ±';
  document.getElementById('ayTop3Tutar').textContent= monthsTR[now.getMonth()]+' AyÄ±'; // ğŸ†•
  document.getElementById('ayZero').textContent     = monthsTR[now.getMonth()]+' AyÄ±';

  // Veriler
  const [tSnapYear, tSnapAll, sSnap] = await Promise.all([
    db.collection('tahakkuklar').where('yil','==',yil).get().catch(_=>db.collection('tahakkuklar').get()),
    db.collection('tahakkuklar').get(),   // tÃ¼m yÄ±llar
    db.collection('tahsilatlar').get()
  ]);

  // Haritalar
  const tahById = new Map();      // id -> tahakkuk doc (sadece bu yÄ±l)
  const keyToId = new Map();      // eÅŸleÅŸtirme iÃ§in composit key (bu yÄ±l)
  const annualTah  = new Map();   // bu yÄ±l kiÅŸi bazÄ±nda
  const overallTah = new Map();   // tÃ¼m yÄ±llar kiÅŸi bazÄ±nda
  const displayName = new Map();  // gÃ¶sterim adÄ±

      // BU YIL tahakkuklarÄ±
  tSnapYear.forEach(doc=>{
    const t = doc.data()||{};
    if (Number(t.yil) !== yil) return;
    tahById.set(doc.id, t);
    const k = `${yil}||${normTR(t.faaliyet)}||${normTR(t.personel||t.personelAd||t.sorumlu||'')}||${normTR(t.borclu)}`;
    keyToId.set(k, doc.id);
    const pName = coalesceName(t);
    const pk    = nameKey(pName);
    annualTah.set(pk, (annualTah.get(pk)||0) + Number(t.tahakkuk||0));
    displayName.set(pk, pName);
  });

  // TÃœM YILLAR tahakkuklarÄ±
  tSnapAll.forEach(doc=>{
    const t = doc.data()||{};
    const pName = coalesceName(t);
    const pk    = nameKey(pName);
    overallTah.set(pk, (overallTah.get(pk)||0) + Number(t.tahakkuk||0));
    if (!displayName.has(pk)) displayName.set(pk, pName);
  });

  // Bu ayki tahsilatlar (sadece eÅŸleÅŸenler, ve eÅŸleÅŸtiÄŸi tahakkukun PERSONEL'ine yaz)
  const monthlyTh = new Map();           // personKey -> bu ay tahsilat
  sSnap.forEach(doc=>{
    const v = doc.data()||{};
    const dt = toDate(v.tarih);
    if (!dt || dt < start || dt > end) return;

    let tah = null;

    if (v.tahakkukId && tahById.has(v.tahakkukId)) {
      tah = tahById.get(v.tahakkukId);
    } else {
      const y = Number(v.yil) || (dt && dt.getFullYear());
      const k = `${y}||${normTR(v.faaliyet)}||${normTR(v.personel)}||${normTR(v.borclu)}`;
      const id = keyToId.get(k);
      if (id && tahById.has(id)) tah = tahById.get(id);
    }
    if (!tah || Number(tah.yil)!==yil) return;

    // Ä°SÄ°M: tah'da yoksa tahsilattan tamamla
    const pName = coalesceName(tah) !== 'â€”' ? coalesceName(tah) : coalesceName(v);
    const pk    = nameKey(pName);
    displayName.set(pk, pName);

    monthlyTh.set(pk, (monthlyTh.get(pk)||0) + Number(v.tutar||0));
  });

  // Top-3 (yÃ¼zde = aylÄ±k tahsilat / yÄ±llÄ±k tahakkuk)
    const rows = [...displayName.keys()].map(pk=>{
      const tahAll = overallTah.get(pk)||0;   // ğŸ†• tÃ¼m yÄ±llar
      const tahYr  = annualTah.get(pk)||0;    // istersen labelâ€™da gÃ¶stermek iÃ§in
      const th     = monthlyTh.get(pk)||0;    // bu ay tahsilat
      return {
        pk, name: displayName.get(pk)||pk,
        pct: (tahAll>0 ? (th/tahAll*100) : 0),  // ğŸ†• yÃ¼zde artÄ±k tÃ¼m yÄ±llara nispetle
        th, tahAll, tahYr
      };
    });

    // --- Top-3 (YÃœZDE) ---
    const top3Pct = document.getElementById('top3List'); top3Pct.innerHTML='';
    const topPct  = rows.filter(r=>r.pct>0).sort((a,b)=>b.pct-a.pct).slice(0,3);

    if (!topPct.length){
      top3Pct.innerHTML = '<div class="list-item"><div>Veri yok</div><div class="muted">â€”</div></div>';
    } else {
      topPct.forEach((r,i)=>{
        const el=document.createElement('div'); el.className='list-item';
        const w = Math.max(0, Math.min(100, r.pct));
        const rankClass = i === 0 ? 'rank-1' : i === 1 ? 'rank-2' : 'rank-3';
        el.innerHTML = `
          <div style="flex:1">
            <div><span class="rank ${rankClass}">${i+1}</span>${r.name}</div>
            <div class="meta">${r.pct.toFixed(1)}% â€¢ Toplam Alacak Tahak.: ${fmtTL(r.tahAll)}</div>
            <div class="bar"><span style="width:${w}%"></span></div>
          </div>
        `;
        top3Pct.appendChild(el);
      });
    }

    // --- ğŸ†• Top-3 (TUTAR) ---
    const top3Amt = document.getElementById('top3TutarList'); top3Amt.innerHTML='';
    const topAmt  = rows.filter(r=>r.th>0).sort((a,b)=>b.th-a.th).slice(0,3);

    if (!topAmt.length){
      top3Amt.innerHTML = '<div class="list-item"><div>Veri yok</div><div class="muted">â€”</div></div>';
    } else {
      topAmt.forEach((r,i)=>{
        // yÃ¼zdeyi "ToplamÄ±na nispetle" (tÃ¼m yÄ±llar) gÃ¶steriyoruz:
        const pctAll = (r.tahAll>0)? (r.th/r.tahAll*100) : 0;
        const w      = Math.max(0, Math.min(100, pctAll));
        const rankClass = i === 0 ? 'rank-1' : i === 1 ? 'rank-2' : 'rank-3';
        const el=document.createElement('div'); el.className='list-item';
        el.innerHTML = `
          <div style="flex:1">
            <div><span class="rank ${rankClass}">${i+1}</span>${r.name}</div>
            <div class="meta">${fmtTL(r.th)} â€¢ ${pctAll.toFixed(1)}%</div>
            <div class="bar"><span style="width:${w}%"></span></div>
          </div>
        `;
        top3Amt.appendChild(el);
      });
    }

    // --- 0% listesi ---
    const zero = document.getElementById('zeroList'); zero.innerHTML='';
    const zeros = rows
      .filter(r => r.tahAll > 0 && !monthlyTh.get(r.pk))  // ğŸŸ¢ bu yÄ±l tahakkuku olup ayda tahsilatÄ± yok
      .map(r => r.name)
      .sort();

    if (!zeros.length){
      zero.innerHTML = '<div class="list-item"><div>TÃ¼m personelde tahsilat var</div><div class="muted">â€”</div></div>';
    } else {
      zeros.forEach(n=>{
        const el=document.createElement('div'); el.className='list-item';
        el.innerHTML = `<div>${n}</div><div class="muted">0%</div>`;
        zero.appendChild(el);
      });
    }
    }

  /* ===== NÃ¶betÃ§i (09:00â†’09:00) nobet_planlari/{YYYY-Www} rows.tarihISO ile ===== */
  function isoWeekKey(d){
    // ISO haftasÄ±: PerÅŸembe bazlÄ±
    const date = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    const dayNum = (date.getUTCDay()+6)%7;
    date.setUTCDate(date.getUTCDate() - dayNum + 3);
    const firstThu = new Date(Date.UTC(date.getUTCFullYear(),0,4));
    const week = 1 + Math.round(((date - firstThu) / 86400000 - 3 + ((firstThu.getUTCDay()+6)%7)) / 7);
    const year = date.getUTCFullYear();
    return `${year}-W${String(week).padStart(2,'0')}`;
  }
  async function loadNobet(){
    const now=new Date();
    const nine=new Date(now.getFullYear(),now.getMonth(),now.getDate(),9,0,0,0);
    const bas=(now<nine)? new Date(nine.getTime()-86400000) : nine;
    const gunKey=bas.toISOString().slice(0,10);
    const haftaKey=isoWeekKey(bas);
    try{
      const doc=await db.collection("nobet_planlari").doc(haftaKey).get();
      if(doc.exists){
        const rows=(doc.data()||{}).rows||[];
        const r=rows.find(x=> String(x.tarihISO)===gunKey);
        if(r){
          document.getElementById("nobetEvli").textContent = r.evli || 'â€”';
          document.getElementById("nobetBekar").textContent= r.bekar|| 'â€”';
          return;
        }
      }
      // bulunamazsa boÅŸ bÄ±rak
      document.getElementById("nobetEvli").textContent = 'â€”';
      document.getElementById("nobetBekar").textContent= 'â€”';
    }catch(e){ console.error(e); }
  }
    /* ===== Teknik Eksikler ===== */
  async function loadEksikler(){
    const dateStr = todayStrTR();
    const kpi=document.getElementById('kpiEksikSayisi');
    const list=document.getElementById('eksikList');
    if(!kpi || !list) return;
    list.innerHTML='';

    try{
      // Temizlik dashboard'dan eksik verisini al (cache'den)
      const data = await getTemizlikData(dateStr);
      const ex = data.eksik;
      
      kpi.textContent = ex.count || 0;

      if(ex.count===0){
        list.innerHTML='<div class="list-item"><div>BugÃ¼n aÃ§Ä±k eksik yok</div><div class="muted">â€”</div></div>';
        return;
      }

      ex.list.slice(0,6).forEach(v=>{
        const el=document.createElement('div'); el.className='list-item';
        const parc = (v.parcalar && v.parcalar.length)? ` â€¢ ${v.parcalar.length} madde` : '';
        el.innerHTML=`<div><strong>${v.kat}</strong>${parc}</div><div class="muted">${v.status.toUpperCase()}</div>`;
        list.appendChild(el);
      });
    }catch(e){
      console.error('Eksikler hatasÄ±:', e);
      if(kpi) kpi.textContent='--';
      if(list) list.innerHTML='<div class="muted">Eksikler yÃ¼klenemedi.</div>';
    }
  }

  /* ===== Bildirim rozet - ortak.js'den geliÅŸtirilmiÅŸ versiyon ===== */
  async function loadNotifications(){
    const badge=document.getElementById('notifBadge');
    const list =document.getElementById('notifList');
    if (!badge || !list) return;
    list.innerHTML='';
    try{
      const snap = await db.collection('duyurular').orderBy('createdAt','desc').limit(5).get();
      const n = snap.size;
      if(n>0){ badge.style.display='block'; badge.textContent = n>99 ? '99+' : String(n); } else { badge.style.display='none'; }
      if(n===0){
        const empty=document.createElement('div'); empty.className='muted'; empty.style.padding='6px 8px'; empty.textContent='Yeni bildirim yok.'; list.appendChild(empty);
      }else{
        snap.forEach(doc=>{ 
          const d=doc.data()||{}; 
          const baslik=d.baslik||d.title||'Duyuru'; 
          const detay=d.detay||d.desc||''; 
          const row=document.createElement('a'); 
          const bildirimPath = normalizeUrl('diger/bildirim.html');
          row.href=bildirimPath; 
          // GÃ¼venlik: innerHTML yerine textContent kullan
          const strong = document.createElement('strong');
          strong.textContent = escapeHtml(baslik);
          const muted = document.createElement('div');
          muted.className = 'muted';
          muted.textContent = escapeHtml(detay);
          row.appendChild(strong);
          row.appendChild(muted);
          list.appendChild(row); 
        });
      }
    }catch(e){ 
      console.error('Bildirimler yÃ¼klenemedi:', e); 
      if (badge) badge.style.display='none'; 
      if (list) { 
        const err=document.createElement('div'); 
        err.className='muted'; 
        err.style.padding='6px 8px'; 
        err.textContent='Bildirimler yÃ¼klenemedi.'; 
        list.appendChild(err); 
      } 
    }
  }

  /* Link guard â€“ initAppShell iÃ§inde yapÄ±lÄ±yor */

  /* Toast bildirim sistemi - ortak.js'den */
  function showToast(type, title, message) {
    const cont = document.getElementById('toastContainer');
    if (!cont) {
      console.warn('toastContainer bulunamadÄ±');
      return;
    }
    const safeType = ['success', 'error', 'warning', 'info'].includes(type) ? type : 'info';
    const safeTitle = escapeHtml(String(title || ''));
    const safeMessage = escapeHtml(String(message || ''));
    
    const div = document.createElement('div');
    div.className = `toast ${safeType}`;
    
    const icon = document.createElement('div');
    icon.className = 'toast-icon';
    icon.textContent = safeType === 'success' ? 'âœ…' : safeType === 'error' ? 'âš ï¸' : safeType === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
    
    const content = document.createElement('div');
    content.className = 'toast-content';
    
    const titleEl = document.createElement('div');
    titleEl.className = 'toast-title';
    titleEl.textContent = safeTitle;
    
    const messageEl = document.createElement('div');
    messageEl.className = 'toast-message';
    messageEl.textContent = safeMessage;
    
    const closeBtn = document.createElement('button');
    closeBtn.className = 'toast-close';
    closeBtn.type = 'button';
    closeBtn.textContent = 'Ã—';
    closeBtn.setAttribute('aria-label', 'Kapat');
    
    content.appendChild(titleEl);
    content.appendChild(messageEl);
    div.appendChild(icon);
    div.appendChild(content);
    div.appendChild(closeBtn);
    
    cont.appendChild(div);
    requestAnimationFrame(() => div.classList.add('show'));
    const close = () => { 
      div.classList.remove('show'); 
      setTimeout(() => div.remove(), 200); 
    };
    closeBtn.addEventListener('click', close);
    setTimeout(close, 4000);
  }
  window.showToast = showToast;

  /* Auth akÄ±ÅŸÄ± */
  try{ firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL); }catch(e){}
  
  // App Shell'i baÅŸlat
  initAppShell();
  
  auth.onAuthStateChanged(async (user)=>{
    if(!user){
      setTimeout(()=>{ if(!auth.currentUser) {
        const indexPath = normalizeUrl('index.html');
        location.replace(indexPath);
      }},150);
      return;
    }
    try{
      setToday();
      const uSnap = await db.collection('kullanicilar').doc(user.uid).get();
      const data  = uSnap.exists ? uSnap.data() : {};
      document.getElementById('username').textContent = data.adSoyad || user.email || 'KullanÄ±cÄ±';
      
      // Profil ismi: Emoji + Ad Soyad (ortak.js ile aynÄ± format)
      const profNameEl = document.getElementById('profName');
      if (profNameEl) {
        const name = data.adSoyad || user.email?.split('@')[0] || 'Profil';
        profNameEl.textContent = `ğŸ‘¤ ${name}`;
      }

      // yetkiler
      const rawPerms = Array.isArray(data.yetkiler) ? data.yetkiler : [];
      const allowSet = new Set(rawPerms.filter(s=>!String(s).trim().startsWith('-') && !String(s).trim().startsWith('!')).map(norm));
      const denySet  = new Set(rawPerms.filter(s=> String(s).trim().startsWith('-') || String(s).trim().startsWith('!')).map(s=>norm(String(s).replace(/^[-!]\s*/,''))));
      // Window'a kopyala (ortak.js ve diÄŸer sayfalar iÃ§in)
      window.CURRENT_ALLOW = allowSet;
      window.CURRENT_DENY = denySet;

      const panels = await fetchPanels(allowSet, denySet);
      renderNav(panels);
      
      // Optimize yÃ¼kleme stratejisi: Paralel yÃ¼kleme + cache
      await initDevreSelector();
      
      // Ortak yÃ¼kleme wrapper (kod tekrarÄ±nÄ± Ã¶nlemek iÃ§in)
      const loadCard = async (name, fn, elId) => {
        if(elId) setCardLoading(elId, true);
        try{
          await fn();
          if(elId) setCardLoading(elId, false);
        }catch(e){
          console.error(`${name} hatasÄ±:`, e);
          if(elId) { setCardLoading(elId, false); setCardError(elId, true); }
        }
      };
      
      // HÄ±zlÄ± kartlar (paralel yÃ¼kle - Ã¶nce gÃ¶ster)
      await Promise.all([
        loadCard('Bildirimler', loadNotifications, null),
        loadCard('NÃ¶betÃ§i', loadNobet, 'nobetEvli')
      ]);
      
      // AÄŸÄ±r kartlar + Temizlik kartlarÄ± (hepsini paralel yÃ¼kle - cache sayesinde hÄ±zlÄ±)
      await Promise.all([
        loadCard('Alacak Raporu', loadAlacak, 'nispetToplam'),
        loadCard('AylÄ±k Performans', loadAylik, 'top3List'),
        loadCard('Talebe Temizlik', loadTalebeTemizlik, 'kpiTalebeTemizlikOrt'),
        loadCard('Genel Temizlik', loadGenelTemizlik, 'kpiGenelTemizlikOrt'),
        loadCard('Teknik Eksikler', loadEksikler, 'kpiEksikSayisi')
      ]);
    }catch(e){
      console.error(e);
      showToast('error', 'Hata', 'Veriler yÃ¼klenirken hata.');
    }
  });
  </script>
</body>
</html>
