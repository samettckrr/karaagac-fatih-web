<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Karaaƒüa√ß Fatih</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" type="image/png" href="img/logo.png" />

  <style>
    :root{
      --appbar-h:56px;
      --radius:14px; --shadow:0 12px 28px rgba(0,0,0,.14);
      --bg:#0f172a; --bg2:#0b1324;
      --grad1:#0ea5e922; --grad2:#22d3ee22;
      --card:rgba(15,23,42,.92); --stroke:rgba(148,163,184,.18);
      --text:#e5e7eb; --muted:#9aa4b2;
      --brand:#38bdf8; --brand2:#0ea5e9;
      --pill:#0b1220; --pill-hover:#101a2b;
      --link:#c7e9ff; --surface:rgba(2,6,23,.08);
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#eef6ff; --bg2:#f7fbff; --grad1:#38bdf822; --grad2:#22d3ee22;
        --card:rgba(255,255,255,.95);
        --stroke:rgba(15,23,42,.12);
        --text:#0b1220; --muted:#4b5563; --brand:#0ea5e9; --brand2:#0284c7;
        --pill:#f5f8ff; --pill-hover:#e9f2ff; --link:#0b5ea8; --surface:#eef3ff;
      }
    }
    html[data-theme="dark"]{
      --bg:#0f172a; --bg2:#0b1324; --grad1:#0ea5e922; --grad2:#22d3ee22;
      --card:rgba(15,23,42,.92); --stroke:rgba(148,163,184,.18);
      --text:#e5e7eb; --muted:#9aa4b2; --brand:#38bdf8; --brand2:#0ea5e9;
      --pill:#0b1220; --pill-hover:#101a2b; --link:#c7e9ff; --surface:rgba(2,6,23,.08);
    }
    html[data-theme="light"]{
      --bg:#eef6ff; --bg2:#f7fbff; --grad1:#38bdf822; --grad2:#22d3ee22;
      --card:rgba(255,255,255,.95); --stroke:rgba(15,23,42,.12);
      --text:#0b1220; --muted:#4b5563; --brand:#0ea5e9; --brand2:#0284c7;
      --pill:#f5f8ff; --pill-hover:#e9f2ff; --link:#0b5ea8; --surface:#eef3ff;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      font-family:ui-sans-serif,-apple-system,"Segoe UI",Roboto,Arial;
      background:
        radial-gradient(900px 680px at 12% 8%, var(--grad1), transparent 45%),
        radial-gradient(800px 640px at 88% 92%, var(--grad2), transparent 50%),
        linear-gradient(140deg, var(--bg), var(--bg2) 60%);
      overflow-x:hidden; word-wrap:break-word;
    }
    a{color:var(--link); text-decoration:none}
    a:hover{text-decoration:underline}

    /* APPBAR */
    .appbar{
      position:sticky; top:0; z-index:60;
      height:var(--appbar-h);
      background:var(--card); backdrop-filter:blur(10px);
      border-bottom:1px solid var(--stroke);
      display:flex; align-items:center;
      padding-top:0; padding-bottom:0;
      padding-left:max(12px, env(safe-area-inset-left));
      padding-right:max(12px, env(safe-area-inset-right));
    }
    .brand{display:flex; align-items:center; gap:10px; cursor:pointer}
    .brand img{width:24px; height:24px}
    .brand span{font-weight:900; letter-spacing:.02em; color:var(--text)}

    .nav-center{margin:0 auto; height:100%}
    .nav-list{display:flex; gap:22px; align-items:center; height:100%; list-style:none; margin:0; padding:0}
    .nav-item{position:relative; height:100%}
    .nav-btn{height:100%; display:flex; align-items:center; gap:6px; color:var(--text); font-weight:600; cursor:pointer}
    .nav-btn:hover{color:var(--brand)}
    .caret{font-size:12px; opacity:.6}
    .dropdown{position:absolute; top:100%; left:0; min-width:240px; background:var(--card); border:1px solid var(--stroke); border-radius:10px; box-shadow:var(--shadow); padding:8px; display:none}
    .dropdown a{display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:8px; color:var(--text); text-decoration:none}
    .dropdown a:hover{background:var(--surface)}
    .nav-item.open .dropdown{display:block}

    .nav-right{display:flex; gap:8px; align-items:center}
    .btn{border:1px solid var(--stroke); background:var(--card); color:var(--text); border-radius:999px; padding:8px 12px; cursor:pointer}
    .hamb{display:none}

    /* DRAWER (mobil) */
    .drawer{
      position:fixed;
      top:var(--appbar-h); right:0; bottom:0; left:30%;
      transform:translateX(100%); transition:transform .25s ease;
      background:var(--card); border-left:1px solid var(--stroke);
      z-index:70; overflow:auto; -webkit-overflow-scrolling:touch; padding:12px;
    }
    .drawer.open{transform:translateX(0)}
    .drawer .panel-title{margin:14px 4px 6px; font-weight:800; color:var(--muted); font-size:13px}
    .drawer a{display:block; padding:10px; border-radius:10px; border:1px solid var(--stroke); margin:6px 0; color:var(--text); background:var(--pill)}
    .drawer a:hover{background:var(--pill-hover)}

    /* CONTENT */
    .container{max-width:1200px; margin:0 auto; padding:16px}
    .hero{display:flex; justify-content:space-between; align-items:flex-start; gap:16px; background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius); padding:16px; margin:16px 0; box-shadow:var(--shadow)}
    .hero h2{margin:0 0 6px; font-size:20px}
    .hero-sub{color:var(--muted); font-size:13px}
    .mini{display:flex; gap:8px; flex-wrap:wrap}
    .pill{padding:6px 10px; border-radius:999px; border:1px solid var(--stroke); background:var(--pill); font-size:12px}

    .grid{display:grid; gap:14px; grid-template-columns:repeat(12, minmax(0,1fr))}
    .col-3{grid-column:span 3} .col-4{grid-column:span 4} .col-6{grid-column:span 6} .col-8{grid-column:span 8} .col-12{grid-column:span 12}
    .card{background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px}
    .card h3{margin:0 0 10px; font-size:16px}
    .kpi{display:flex; align-items:center; justify-content:space-between; padding:12px; border-radius:12px; border:1px solid var(--stroke); background:var(--surface)}
    .kpi .val{font-size:22px; font-weight:800}
    .kpi .sub{font-size:12px; color:var(--muted)}
    .list{display:grid; gap:10px}
    .list-item{display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 12px; border-radius:12px; border:1px solid var(--stroke); background:var(--surface)}

    .toast{position:fixed; left:50%; bottom:24px; transform:translateX(-50%) translateY(20px); background:rgba(2,6,23,.95); color:#fff; border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:10px 12px; opacity:0; pointer-events:none; transition:opacity .25s, transform .25s; z-index:200}
    .toast.show{opacity:1; transform:translateX(-50%) translateY(0)}
    .page-gap{height:180px}

    @media (max-width: 1024px){ .nav-center{display:none} .hamb{display:inline-flex} }
    @media (max-width: 960px){
      .col-3{grid-column:span 6} .col-4{grid-column:span 6} .col-6{grid-column:span 6} .col-8{grid-column:span 6} .col-12{grid-column:span 6}
      .hero{flex-direction:column}
    }
  </style>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="js/firebase/firebase-init.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <script defer src="js/ortak.js"></script>
</head>
<body>

  <!-- APPBAR -->
  <div class="appbar">
    <div class="brand" onclick="location.reload()">
      <img src="img/logo.png" alt="logo"><span>KARAAƒûA√á FATƒ∞H</span>
    </div>

    <nav class="nav-center"><ul class="nav-list" id="navMain"></ul></nav>

    <div class="nav-right">
      <button class="btn hamb" id="hamburger" title="Men√º">‚ò∞</button>
      <button class="btn" id="themeToggle" title="Tema: A√ßƒ±k/Koyu/Otomatik">üåó <span id="themeLabel">Auto</span></button>
      <button class="btn" onclick="logout()">√áƒ±kƒ±≈ü Yap</button>
    </div>
  </div>

  <!-- Mobil √ßekmece -->
  <aside class="drawer" id="drawer"></aside>

  <!-- CONTENT -->
  <main class="container">
    <section class="hero">
      <div>
        <h2>Ho≈ü geldiniz, <span id="username">‚Äî</span></h2>
        <div class="hero-sub">Bug√ºn: <span id="todayText">‚Äî</span></div>
        <div class="mini">
          <span class="pill">üì¶ <b id="panelCount">0</b> panel</span>
          <span class="pill">üß© <b id="pageCount">0</b> sayfa</span>
          <span class="pill">üîî <b id="duyuruCount">0</b> duyuru</span>
        </div>
      </div>
      <div class="mini"><span class="pill">Tema: <span id="themeLabel2">Auto</span></span></div>
    </section>

    <div class="grid">
      <div class="card col-3">
        <h3>Genel</h3>
        <div class="kpi"><div><div class="val" id="kpiTalebe">--</div><div class="sub">Toplam Talebe</div></div><div>üë•</div></div>
        <div class="kpi" style="margin-top:10px"><div><div class="val"><span id="kpiEnsar">--</span> / <span id="kpiMuhacir">--</span></div><div class="sub">Ensar / Muhacir</div></div><div>üìò</div></div>
      </div>
      <div class="card col-3">
        <h3>Yoklama</h3>
        <div class="kpi"><div><div class="val" id="kpiIzinli">--</div><div class="sub">Bug√ºn ƒ∞zinli</div></div><div>üóìÔ∏è</div></div>
        <canvas id="grafikYoklama" height="120" style="margin-top:10px"></canvas>
      </div>
      <div class="card col-3">
        <h3>Temizlik</h3>
        <div class="kpi"><div><div class="val" id="kpiTemizlik">--</div><div class="sub">Bug√ºn Ortalama</div></div><div>üßπ</div></div>
        <canvas id="grafikTemizlik" height="120" style="margin-top:10px"></canvas>
      </div>
      <div class="card col-3">
        <h3>Kasa</h3>
        <div class="kpi"><div><div class="val" id="kpiKasa">--</div><div class="sub">Son 30 G√ºn Net</div></div><div>üí∞</div></div>
        <canvas id="grafikKasa" height="120" style="margin-top:10px"></canvas>
      </div>

      <div class="card col-8">
        <h3 style="display:flex;justify-content:space-between;align-items:center"><span>Duyurular</span><button id="duyuruEkleBtn" style="display:none" class="btn">+ Ekle</button></h3>
        <div class="list" id="duyuruListe"></div>
      </div>
      <div class="card col-4">
        <h3>G√ºnl√ºk G√∂revlerim</h3>
        <div class="list" id="gorevBugun"></div>
        <div style="margin-top:8px;color:var(--muted);font-size:12px">Bu hafta</div>
        <div class="list" id="gorevHafta"></div>
      </div>
      <div class="card col-6"><h3>Sistem Hareketleri</h3><div class="list" id="logSistem"></div></div>
      <div class="card col-6"><h3>Benim Son ƒ∞≈ülemlerim</h3><div class="list" id="logBenim"></div></div>
    </div>

    <div class="page-gap"></div>
  </main>

  <div class="toast" id="toast"></div>

  <script>
    /* Yalnƒ±zca YETKƒ∞LER ile √ßalƒ±≈üƒ±r */
    let CURRENT_ALLOW = new Set();  // pozitif yetkiler (panel adƒ± ya da sayfa key)
    let CURRENT_DENY  = new Set();  // - ile eklenen hariciler

    const norm = (s) => String(s || '').trim().toLowerCase();

    /* Panel ikonlarƒ± */
    const PANEL_ICON  = { 'Admin':'üéõÔ∏è','Talebe':'üìò','Personel':'üë§','Muhasebe':'üí∞','Kermes':'üè™','Nehari':'üïå','Sistem Ayarlarƒ±':'‚öôÔ∏è' };

    /* Tema */
    (function(){
      const root=document.documentElement, btn=document.getElementById('themeToggle');
      const lab1=document.getElementById('themeLabel'), lab2=document.getElementById('themeLabel2');
      const sysDark=()=>window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches;
      function apply(mode){
        localStorage.setItem('kf_theme',mode);
        const eff=(mode==='auto')?(sysDark()?'dark':'light'):mode;
        root.setAttribute('data-theme',eff);
        const txt=mode[0].toUpperCase()+mode.slice(1);
        if(lab1) lab1.textContent=txt; if(lab2) lab2.textContent=txt;
        const icon=mode==='dark'?'üåô':mode==='light'?'‚òÄÔ∏è':'üåó';
        btn.innerHTML=icon+' <span id="themeLabel">'+txt+'</span>';
      }
      apply(localStorage.getItem('kf_theme')||'auto');
      btn.addEventListener('click',()=>{const cur=localStorage.getItem('kf_theme')||'auto'; apply(cur==='dark'?'light':(cur==='light'?'auto':'dark'));});
      if(window.matchMedia){ const m=window.matchMedia('(prefers-color-scheme: dark)'); m.addEventListener?.('change',()=>{ if((localStorage.getItem('kf_theme')||'auto')==='auto') apply('auto'); }); }
    })();

    /* Helpers & Firebase */
    const db=firebase.firestore(), auth=firebase.auth();
    function showToast(msg){const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); clearTimeout(window.__to); window.__to=setTimeout(()=>t.classList.remove('show'),3000);}
    function setToday(){const d=new Date(); const days=['Pazar','Pazartesi','Salƒ±','√áar≈üamba','Per≈üembe','Cuma','Cumartesi']; document.getElementById('todayText').textContent=`${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()} ‚Ä¢ ${days[d.getDay()]}`;}

    /* ====== Manifesti yalnƒ±zca yetkilere g√∂re s√ºz ====== */
    async function fetchPanels(allowSet, denySet){
      const res=[];
      try{
        const snap=await db.collection('sayfa_manifesti').get();
        snap.forEach(doc=>{
          const d=doc.data()||{}, id=doc.id;
          const panelTitle=d.title||id;
          const ikon=d.icon||(PANEL_ICON[id]||'üìÅ');

          const panelGrant = allowSet.has(norm(id)) || allowSet.has(norm(panelTitle));

          let pages = Array.isArray(d.pages)? d.pages : [];
          pages = pages.filter(pg=>{
            const keyNorm = norm(pg.key || pg.title || '');
            const pageGrant = allowSet.has(keyNorm);
            const denied    = denySet.has(keyNorm);
            return !denied && (panelGrant || pageGrant);
          }).map(pg=>({
            baslik: pg.title || pg.key || 'Sayfa',
            url:    pg.path  || '#',
            key:    pg.key   || pg.title || '',
            sira:   typeof pg.order==='number' ? pg.order : 9999
          })).sort((a,b)=>a.sira-b.sira);

          if (pages.length===0) return;       // panel altƒ±nda yetkili sayfa yoksa paneli g√∂sterme
          res.push({ id, baslik:panelTitle, ikon, sira: typeof d.order==='number'? d.order : 9999, pages });
        });
        res.sort((a,b)=>a.sira-b.sira);
      }catch(e){
        console.error('sayfa_manifesti okunamadƒ±:', e);
        showToast('Men√º manifesti y√ºklenemedi.');
      }
      return res;
    }

    /* Nav √ßizimi (masa√ºst√º dropdown + mobil drawer) */
    function renderNav(panels){
      const ul=document.getElementById('navMain'), drawer=document.getElementById('drawer');
      ul.innerHTML=''; drawer.innerHTML='';
      document.getElementById('panelCount').textContent=panels.length;
      document.getElementById('pageCount').textContent=panels.reduce((a,p)=>a+(p.pages?p.pages.length:0),0);

      if(!panels.length){
        ul.innerHTML='<li class="nav-item"><div class="nav-btn">Hi√ß panel yok</div></li>';
        drawer.innerHTML='<div style="color:var(--muted);padding:8px">Hi√ß panel bulunamadƒ±</div>';
        return;
      }

      // Masa√ºst√º
      panels.forEach(p=>{
        const li=document.createElement('li'); li.className='nav-item';
        li.innerHTML=`<div class="nav-btn">${p.baslik} <span class="caret">‚ñæ</span></div>`;
        const dd=document.createElement('div'); dd.className='dropdown';
        (p.pages||[]).forEach(pg=>{
          const a=document.createElement('a');
          a.href=pg.url; a.textContent=pg.baslik;
          a.dataset.key=pg.key||pg.baslik; 
          a.dataset.panel=p.id; 
          a.dataset.panelTitle=p.baslik;
          dd.appendChild(a);
        });
        li.appendChild(dd);
        li.querySelector('.nav-btn').addEventListener('click',(e)=>{
          e.stopPropagation();
          ul.querySelectorAll('.nav-item').forEach(x=>{ if(x!==li) x.classList.remove('open'); });
          li.classList.toggle('open');
        });
        ul.appendChild(li);
      });
      document.addEventListener('click',(e)=>{ if(!ul.contains(e.target)) ul.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('open')); });

      // Mobil drawer
      panels.forEach(p=>{
        const h=document.createElement('div'); h.className='panel-title'; h.textContent=p.baslik; drawer.appendChild(h);
        (p.pages||[]).forEach(pg=>{
          const a=document.createElement('a');
          a.href=pg.url; a.textContent=pg.baslik;
          a.dataset.key=pg.key||pg.baslik; 
          a.dataset.panel=p.id; 
          a.dataset.panelTitle=p.baslik;
          drawer.appendChild(a);
        });
      });
    }

    /* Drawer toggle */
    (function(){
      const hamb=document.getElementById('hamburger'), drawer=document.getElementById('drawer');
      if(!hamb) return;
      hamb.addEventListener('click',()=>drawer.classList.toggle('open'));
      document.addEventListener('click',(e)=>{ if(!drawer.contains(e.target) && !hamb.contains(e.target)) drawer.classList.remove('open'); });
    })();

    /* Dummy i√ßerikler */
    async function loadKPIs(){ document.getElementById('kpiTalebe').textContent='128'; document.getElementById('kpiEnsar').textContent='79'; document.getElementById('kpiMuhacir').textContent='49'; document.getElementById('kpiIzinli').textContent='6'; document.getElementById('kpiTemizlik').textContent='86'; document.getElementById('kpiKasa').textContent='‚Ç∫ 42.300'; }
    async function loadDuyurular(){ const list=document.getElementById('duyuruListe'); list.innerHTML=''; [{b:'10:00 toplantƒ±',t:'√áayhane',z:'5 dk √∂nce'},{b:'Temizlik form kapanƒ±≈üƒ± 12:00',t:'2. Kat',z:'1 saat √∂nce'},{b:'Kermes hazƒ±rlƒ±ƒüƒ± 16:30',t:'Mal kabul',z:'D√ºn'}].forEach(it=>{const el=document.createElement('div'); el.className='list-item'; el.innerHTML=`<div><strong>${it.b}</strong><div class="meta">${it.t}</div></div><div class="meta">${it.z}</div>`; list.appendChild(el);}); document.getElementById('duyuruCount').textContent=3; }
    function gorevNode(item){ const el=document.createElement('div'); el.className='list-item'; el.innerHTML=`<div>${item.ok?'‚úÖ':'‚¨úÔ∏è'} ${item.txt}</div><button class="btn">${item.ok?'Geri Al':'Tamamla'}</button>`; el.querySelector('button').onclick=()=>{ item.ok=!item.ok; el.querySelector('div').innerHTML=`${item.ok?'‚úÖ':'‚¨úÔ∏è'} ${item.txt}`; el.querySelector('button').textContent=item.ok?'Geri Al':'Tamamla'; }; return el; }
    async function loadGorevler(){ const b=document.getElementById('gorevBugun'), h=document.getElementById('gorevHafta'); b.innerHTML=h.innerHTML=''; [{txt:'10:00‚Äì12:00 Temizlik kontrol',ok:false},{txt:'Ak≈üam yoklamasƒ±',ok:false}].forEach(x=>b.appendChild(gorevNode(x))); [{txt:'Cuma ‚Äì Kermes hazƒ±rlƒ±k',ok:false},{txt:'Cumartesi ‚Äì N√∂bet',ok:true}].forEach(x=>h.appendChild(gorevNode(x))); }
    async function loadLogs(){ const benim=document.getElementById('logBenim'), sistem=document.getElementById('logSistem'); benim.innerHTML=sistem.innerHTML=''; [{t:'Temizlik formu g√∂r√ºnt√ºlendi',z:'10 dk √∂nce'},{t:'Talebe listesi a√ßƒ±ldƒ±',z:'1 saat √∂nce'}].forEach(x=>{const n=document.createElement('div'); n.className='list-item'; n.innerHTML=`<div>${x.t}</div><div class="meta">${x.z}</div>`; benim.appendChild(n);}); [{t:'Yeni kullanƒ±cƒ± eklendi: A. Yƒ±lmaz',z:'3 dk √∂nce'},{t:'Kasa hareketi girildi',z:'20 dk √∂nce'}].forEach(x=>{const n=document.createElement('div'); n.className='list-item'; n.innerHTML=`<div>${x.t}</div><div class="meta">${x.z}</div>`; sistem.appendChild(n);}); }

    /* Charts */
    function chartColors(){ const s=getComputedStyle(document.documentElement); return {grid:s.getPropertyValue('--stroke')||'rgba(148,163,184,.2)', brand:s.getPropertyValue('--brand')||'#38bdf8', brand2:s.getPropertyValue('--brand2')||'#0ea5e9'}; }
function initCharts() {
  const { grid, brand, brand2 } = chartColors();

  // Yoklama
  try {
    const el = document.getElementById('grafikYoklama');
    if (el && window.Chart) {
      const ctx = el.getContext('2d');
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: ['Pzt','Sal','√áar','Per','Cum','Cts','Paz'],
          datasets: [{
            data: [4, 2, 6, 3, 5, 1, 2],
            tension: 0.35,
            borderColor: brand,
            backgroundColor: brand + '33',
            fill: true,
            pointRadius: 2
          }]
        },
        options: {
          plugins: { legend: { display: false } },
          scales: {
            x: { grid: { color: grid } },
            y: { grid: { color: grid } }
          }
        }
      });
    }
  } catch (e) { console.error('Yoklama grafiƒüi:', e); }

  // Temizlik
  try {
    const el2 = document.getElementById('grafikTemizlik');
    if (el2 && window.Chart) {
      const c2 = el2.getContext('2d');
      new Chart(c2, {
        type: 'bar',
        data: {
          labels: ['1.Kat','2.Kat','3.Kat','4.Kat','5.Kat'],
          datasets: [{
            data: [82, 90, 88, 79, 86],
            backgroundColor: brand
          }]
        },
        options: {
          plugins: { legend: { display: false } },
          scales: {
            x: { grid: { color: grid } },
            y: {
              grid: { color: grid },
              suggestedMin: 0,
              suggestedMax: 100
            }
          }
        }
      });
    }
  } catch (e) { console.error('Temizlik grafiƒüi:', e); }

  // Kasa
  try {
    const el3 = document.getElementById('grafikKasa');
    if (el3 && window.Chart) {
      const c3 = el3.getContext('2d');
      new Chart(c3, {
        type: 'line',
        data: {
          labels: ['W1','W2','W3','W4'],
          datasets: [
            {
              data: [12, 18, 14, 20],
              borderColor: brand,
              backgroundColor: brand + '33',
              tension: 0.3,
              fill: true
            },
            {
              data: [9, 10, 15, 12],
              borderColor: brand2,
              backgroundColor: brand2 + '26',
              tension: 0.3,
              fill: true
            }
          ]
        },
        options: {
          plugins: { legend: { display: false } },
          scales: {
            x: { grid: { color: grid } },
            y: { grid: { color: grid } }
          }
        }
      });
    }
  } catch (e) { console.error('Kasa grafiƒüi:', e); }
}

    /* Link guard ‚Äì sadece yetkilere g√∂re (panel adƒ± ya da sayfa key) */
    document.addEventListener('click', (e) => {
      const a = e.target.closest('a[data-key]');
      if (!a) return;

      const key = norm(a.dataset.key);
      const pnl = norm(a.dataset.panel || '');
      const pnlTitle = norm(a.dataset.panelTitle || '');

      if (CURRENT_DENY.has(key)) { e.preventDefault(); showToast('Bu sayfa i√ßin yetkiniz yok.'); return; }

      const allowed = CURRENT_ALLOW.has(key) || CURRENT_ALLOW.has(pnl) || CURRENT_ALLOW.has(pnlTitle);
      if (!allowed) { e.preventDefault(); showToast('Bu sayfa i√ßin yetkiniz yok.'); }
    });

    /* Persist ve Auth akƒ±≈üƒ± */
    try{ firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL); }catch(e){}
    auth.onAuthStateChanged(async (user)=>{
      if(!user){
        setTimeout(()=>{ if(!auth.currentUser) location.replace('index.html'); },150);
        return;
      }
      try{
        setToday();
        const uSnap = await db.collection('kullanicilar').doc(user.uid).get();
        const data  = uSnap.exists ? uSnap.data() : {};

        document.getElementById('username').textContent = data.adSoyad || user.email || 'Kullanƒ±cƒ±';

        // yetkileri hazƒ±rla
        const rawPerms = Array.isArray(data.yetkiler) ? data.yetkiler : [];
        CURRENT_ALLOW = new Set(
          rawPerms.filter(s=>!String(s).trim().startsWith('-') && !String(s).trim().startsWith('!'))
                  .map(norm)
        );
        CURRENT_DENY = new Set(
          rawPerms.filter(s=>String(s).trim().startsWith('-') || String(s).trim().startsWith('!'))
                  .map(s=>norm(String(s).replace(/^[-!]\s*/,'')))
        );

        const panels = await fetchPanels(CURRENT_ALLOW, CURRENT_DENY);
        renderNav(panels);

        await loadKPIs(); await loadDuyurular(); await loadGorevler(); await loadLogs();
        initCharts();
      }catch(e){
        console.error(e);
        showToast('Veriler y√ºklenirken hata.');
      }
    });
  </script>
</body>
</html>
