workflows:
  ios_capacitor_store:
    name: "iOS • Capacitor • App Store"
    instance_type: mac_mini_m2

    environment:
      node: 18
      xcode: 15.4
      cocoapods: default
      vars:
        XCODE_WORKSPACE: "ios/App/App.xcworkspace"
        XCODE_SCHEME: "App"

    scripts:
      - name: ENV sanity check (no B64, direct PEM)
        script: |
          echo "KEY_ID   = ${APP_STORE_CONNECT_KEY_IDENTIFIER:-<empty>}"
          echo "ISSUER_ID= ${APP_STORE_CONNECT_ISSUER_ID:-<empty>}"
          if [ -z "$APP_STORE_CONNECT_PRIVATE_KEY" ]; then
            echo "✗ PRIVATE_KEY MISSING"; exit 1
          fi
          echo "$APP_STORE_CONNECT_PRIVATE_KEY" | head -n 1 | grep -q "BEGIN PRIVATE KEY" || { echo "✗ PRIVATE_KEY not PEM"; exit 1; }
          echo "✓ env ok"

      - name: Install & sync Capacitor
        script: |
          npm ci
          npx cap sync ios

      - name: Fetch signing & build .ipa
        script: |
          app-store-connect fetch-signing-files \
            --type IOS_APP_STORE \
            --issuer-id "$APP_STORE_CONNECT_ISSUER_ID" \
            --key-id "$APP_STORE_CONNECT_KEY_IDENTIFIER" \
            --private-key "$APP_STORE_CONNECT_PRIVATE_KEY" \
            --create
          xcode-project use-profiles
          xcode-project build-ipa \
            --workspace "$XCODE_WORKSPACE" \
            --scheme "$XCODE_SCHEME" \
            --archive-flags="-destination 'generic/platform=iOS'"

    artifacts:
      - build/ios/ipa/*.ipa
      - $HOME/Library/Logs/gym/*.log

    publishing:
      app_store_connect:
        key_id: "$APP_STORE_CONNECT_KEY_IDENTIFIER"
        issuer_id: "$APP_STORE_CONNECT_ISSUER_ID"
        private_key: "$APP_STORE_CONNECT_PRIVATE_KEY"
        # TestFlight için opsiyonel
       