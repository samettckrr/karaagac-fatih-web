<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>AylÄ±k Giderler & Ay Sonu Raporu | Genel Mizan</title>
  <link rel="icon" href="../img/logo.png"/>
  <link rel="stylesheet" href="../css/app-shell.css" />

  <style>
    /* Sayfa Ã¶zel: app-shell.css Ã¼st panel/arka plan kullanÄ±r */
    body {
      padding-top: var(--appbar-h) !important;
      overflow-x: hidden;
      overflow-y: auto;
    }
    @media (min-width: 1025px) {
      .drawer { transform: translateX(100%) !important; }
      .drawer.open { transform: translateX(0) !important; }
    }
    .wrap {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px;
      display: grid;
      gap: 16px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 768px) {
      .wrap { grid-template-columns: 1fr 1fr; }
      .wrap .span-full { grid-column: 1 / -1; }
    }
    @media (min-width: 1024px) {
      .wrap { grid-template-columns: 380px 1fr; gap: 24px; }
    }
    @media (max-width: 768px) { .wrap { padding: 12px; gap: 12px; } }

    .card {
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius, 14px);
      box-shadow: var(--shadow, 0 4px 16px rgba(15,23,42,.08));
    }
    .card .hd {
      padding: 12px 16px;
      border-bottom: 1px solid var(--stroke);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }
    .card .hd h3 { margin: 0; font-size: 15px; font-weight: 700; }
    .card .bd { padding: 16px; }
    .hint { font-size: 12px; color: var(--muted); margin-top: 6px; }
    label { font-size: 12px; color: var(--muted); display: block; margin-bottom: 6px; }
    input, select, textarea {
      width: 100%;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--stroke);
      background: var(--card);
      color: var(--text);
      font-size: 16px;
    }
    select { min-height: 44px; cursor: pointer; }
    .grid-2 { display: grid; gap: 12px; }
    @media (min-width: 480px) { .grid-2 { grid-template-columns: 1fr 1fr; } }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 10px 12px; border-bottom: 1px solid var(--stroke); text-align: left; }
    thead th { background: var(--surface, #f8f8f8); font-weight: 700; font-size: 13px; }
    tr:hover { background: var(--pill-hover, #f5f5f5); }
    .scroll-x { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    .text-right { text-align: right; }
    .rapor-ana-satir { font-weight: 700; background: rgba(59, 130, 246, 0.08); }
    .rapor-toplam-satir { font-weight: 800; border-top: 2px solid var(--stroke); }
    .btn { border: 1px solid var(--stroke); background: var(--pill); color: var(--text); border-radius: 10px; padding: 10px 12px; cursor: pointer; font-weight: 600; }
    .btn:hover { background: var(--pill-hover); }
    .btn.ok { background: var(--good, #10b981); color: #fff; border-color: transparent; }
    .btn.bad { background: var(--bad, #ef4444); color: #fff; border-color: transparent; }
    .kalem-ana { font-weight: 700; background: var(--surface, #f8f8f8); }
    .kalem-alt { padding-left: 24px; }
    .divider { height: 1px; background: var(--stroke); margin: 12px 0; }
  </style>
</head>
<body>
  <!-- ÃœST APPBAR (diÄŸer sayfalarla aynÄ±: nav + sayfa manifesti) -->
  <div class="appbar">
    <div class="brand" onclick="location.href='../panel.html'">
      <img src="../img/logo.png" alt="logo"><span>KARAAÄAÃ‡ FATÄ°H</span>
    </div>
    <nav class="nav-center">
      <ul class="nav-list" id="navMain"></ul>
    </nav>
    <div class="nav-right">
      <button class="btn hamb" id="hamburger" title="MenÃ¼">â˜°</button>
      <div class="nav-item">
        <button class="iconbtn" id="btnNotif" title="Bildirimler">ğŸ””
          <span class="badge" id="notifBadge" style="display:none">0</span>
        </button>
        <div class="dropdown drop-right" id="notifDropdown" aria-label="Bildirim listesi">
          <div class="muted" style="padding:6px 8px">Son bildirimler</div>
          <div id="notifList" class="list" style="max-height:300px;overflow:auto"></div>
        </div>
      </div>
      <div class="nav-item">
        <button class="iconbtn" id="btnProfile" title="Profil">
          <span class="avatar"></span> <span id="profName" class="muted">Profil</span>
        </button>
        <div class="dropdown drop-right" id="profDropdown" aria-label="Profil menÃ¼sÃ¼">
          <a href="../diger/kullanici-yonetimi.html">ğŸ‘¤ Profil</a>
          <a href="../diger/sistem-ayarlari.html">âš™ï¸ Sistem AyarlarÄ±</a>
          <a href="#" id="btnLogout">ğŸšª Ã‡Ä±kÄ±ÅŸ Yap</a>
        </div>
      </div>
    </div>
  </div>
  <aside class="drawer" id="drawer"></aside>

  <main class="wrap">
    <header style="margin-bottom: 20px;">
      <h1 style="margin: 0 0 8px; font-size: 24px; font-weight: 700;">AylÄ±k Giderler & Ay Sonu Raporu</h1>
      <p class="muted" style="margin: 0;">HÄ±zlÄ± gider giriÅŸi, gider kalemleri (Ä°aÅŸe / Domates, SalatalÄ±k vb.) ve ay sonu kalem bazlÄ± rapor.</p>
    </header>

    <!-- HÄ±zlÄ± Gider GiriÅŸi -->
    <section class="card" aria-label="HÄ±zlÄ± gider giriÅŸi">
      <div class="hd"><h3>HÄ±zlÄ± Gider GiriÅŸi</h3></div>
      <div class="bd">
        <form id="frmGider" class="grid-2">
          <div>
            <label for="gTarih">Tarih</label>
            <input type="date" id="gTarih" required/>
          </div>
          <div>
            <label for="gKalem">Gider Kalemi (alt kalem)</label>
            <select id="gKalem" required>
              <option value="">SeÃ§in</option>
            </select>
            <p class="hint">Sadece alt kalemler listelenir (Domates, SalatalÄ±k vb.)</p>
          </div>
          <div>
            <label for="gTutar">Tutar (â‚º)</label>
            <input type="number" id="gTutar" step="0.01" min="0" required placeholder="0,00"/>
          </div>
          <div>
            <label for="gAciklama">AÃ§Ä±klama (opsiyonel)</label>
            <input type="text" id="gAciklama" placeholder="KÄ±sa not"/>
          </div>
          <div style="grid-column:1/-1; display:flex; gap:8px; justify-content:flex-end;">
            <button class="btn" type="reset">Temizle</button>
            <button class="btn ok" type="submit">Kaydet</button>
          </div>
        </form>
      </div>
    </section>

    <!-- Ay Sonu Raporu -->
    <section class="card span-full" aria-label="Ay sonu raporu">
      <div class="hd"><h3>Ay Sonu Raporu</h3></div>
      <div class="bd">
        <div class="grid-2" style="margin-bottom:16px;">
          <div>
            <label for="rYil">YÄ±l</label>
            <input type="number" id="rYil" min="2020" max="2030" placeholder="2025"/>
          </div>
          <div>
            <label for="rAy">Ay</label>
            <select id="rAy">
              <option value="1">Ocak</option><option value="2">Åubat</option><option value="3">Mart</option>
              <option value="4">Nisan</option><option value="5">MayÄ±s</option><option value="6">Haziran</option>
              <option value="7">Temmuz</option><option value="8">AÄŸustos</option><option value="9">EylÃ¼l</option>
              <option value="10">Ekim</option><option value="11">KasÄ±m</option><option value="12">AralÄ±k</option>
            </select>
          </div>
          <div style="display:flex; align-items:flex-end; gap:8px;">
            <button class="btn ok" id="btnRapor">Raporu Getir</button>
          </div>
        </div>
        <div id="raporAlani" class="scroll-x">
          <p class="muted" id="raporPlaceholder">YÄ±l ve ay seÃ§ip "Raporu Getir"e tÄ±klayÄ±n.</p>
          <table id="raporTbl" style="display:none;">
            <thead>
              <tr><th>Kalem</th><th class="text-right">Toplam (â‚º)</th></tr>
            </thead>
            <tbody id="raporTbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Gider Kalemleri YÃ¶netimi (Ana / Alt kategori ekleme) -->
    <section class="card span-full" aria-label="Gider kalemleri yÃ¶netimi">
      <div class="hd"><h3>Gider Kalemleri YÃ¶netimi</h3></div>
      <div class="bd">
        <div class="grid-2" style="margin-bottom:12px;">
          <div>
            <label>Tip</label>
            <select id="katTip">
              <option value="ana">Ana kategori (Ã¼st)</option>
              <option value="alt">Alt kategori (bir ana altÄ±nda)</option>
            </select>
          </div>
          <div id="katParentWrap" style="display:none;">
            <label for="katParent">Ãœst kategori</label>
            <select id="katParent">
              <option value="">SeÃ§in</option>
            </select>
          </div>
        </div>
        <div class="grid-2" style="gap:8px; align-items:flex-end;">
          <div>
            <label for="katAd">Kalem adÄ±</label>
            <input type="text" id="katAd" placeholder="Ã¶rn. Ä°aÅŸe veya Domates"/>
          </div>
          <div>
            <button type="button" class="btn ok" id="btnKatEkle">Ekle</button>
          </div>
        </div>
        <p class="hint">Ana kategori: Ä°aÅŸe, Elektrik vb. Alt kategori: bir ana altÄ±nda (Domates, SalatalÄ±k â†’ Ä°aÅŸe altÄ±). Gider giriÅŸinde sadece alt kalemler seÃ§ilir.</p>
        <div class="divider"></div>
        <div class="scroll-x" style="max-height:280px;">
          <table id="tblKalem">
            <thead>
              <tr><th>Kalem</th><th>Tip</th><th style="width:80px;">Ä°ÅŸlem</th></tr>
            </thead>
            <tbody id="kalemTbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Son Gider Hareketleri -->
    <section class="card span-full" aria-label="Son hareketler">
      <div class="hd"><h3>Son Gider Hareketleri</h3><span class="muted" id="sonHareketSayisi">0 kayÄ±t</span></div>
      <div class="bd">
        <div class="scroll-x">
          <table id="tblHareket">
            <thead>
              <tr><th>Tarih</th><th>Kalem</th><th class="text-right">Tutar</th><th>AÃ§Ä±klama</th></tr>
            </thead>
            <tbody id="hareketTbody"></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <div class="toast-container" id="toastContainer"></div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="../src/supabase.js"></script>
  <script src="../src/supabase-auth-wrapper.js"></script>
  <script src="../js/ortak.js"></script>

  <script>
    (function(){
      const $ = id => document.getElementById(id);
      const fmt = n => (n == null || isNaN(n)) ? 'â‚º0' : 'â‚º' + Number(n).toLocaleString('tr-TR', { maximumFractionDigits: 2 });
      function parseMoney(v){ if (v == null || v === '') return null; return Number(String(v).replace(/[â‚º\s.]/g, '').replace(',', '.')); }
      function showToast(type, title, msg){ if (typeof window.showToast === 'function') window.showToast(type, title, msg); }

      let kalemList = [];
      async function loadKalemler() {
        const sb = window.supabase;
        if (!sb) return;
        const { data, error } = await sb.from('gider_kalemleri').select('id, ad, parent_id, sira').eq('aktif', true).order('sira').order('ad');
        if (error) { showToast('error', 'Hata', 'Kalemler yÃ¼klenemedi: ' + error.message); return; }
        kalemList = data || [];
        const altKalemler = kalemList.filter(k => k.parent_id != null);
        const sel = $('gKalem');
        sel.innerHTML = '<option value="">SeÃ§in</option>';
        altKalemler.forEach(k => {
          const opt = document.createElement('option');
          opt.value = k.id;
          opt.textContent = k.ad;
          sel.appendChild(opt);
        });
        updateKatParentDropdown();
        loadKalemTable();
      }

      function updateKatParentDropdown() {
        const tip = $('katTip').value;
        const wrap = $('katParentWrap');
        const sel = $('katParent');
        if (tip === 'alt') {
          wrap.style.display = '';
          const anaList = kalemList.filter(k => k.parent_id == null);
          sel.innerHTML = '<option value="">SeÃ§in</option>';
          anaList.forEach(k => {
            const opt = document.createElement('option');
            opt.value = k.id;
            opt.textContent = k.ad;
            sel.appendChild(opt);
          });
        } else {
          wrap.style.display = 'none';
          sel.innerHTML = '<option value="">SeÃ§in</option>';
        }
      }

      function loadKalemTable() {
        const tbody = $('kalemTbody');
        if (!tbody) return;
        const anaList = kalemList.filter(k => k.parent_id == null).sort((a, b) => (a.sira || 0) - (b.sira || 0) || (a.ad || '').localeCompare(b.ad || ''));
        const altByParent = {};
        kalemList.filter(k => k.parent_id != null).forEach(k => {
          const pid = k.parent_id;
          if (!altByParent[pid]) altByParent[pid] = [];
          altByParent[pid].push(k);
        });
        Object.keys(altByParent).forEach(pid => altByParent[pid].sort((a, b) => (a.sira || 0) - (b.sira || 0) || (a.ad || '').localeCompare(b.ad || '')));
        const rows = [];
        anaList.forEach(ana => {
          rows.push(`<tr class="kalem-ana"><td>${escapeHtml(ana.ad)}</td><td>Ana</td><td><button type="button" class="btn bad" data-id="${ana.id}" data-pasif>Pasif yap</button></td></tr>`);
          (altByParent[ana.id] || []).forEach(alt => {
            rows.push(`<tr class="kalem-alt"><td>${escapeHtml(alt.ad)}</td><td>Alt</td><td><button type="button" class="btn bad" data-id="${alt.id}" data-pasif>Pasif yap</button></td></tr>`);
          });
        });
        tbody.innerHTML = rows.length ? rows.join('') : '<tr><td colspan="3" class="muted">HenÃ¼z kalem yok. Ãœstte ana veya alt kategori ekleyin.</td></tr>';
      }

      $('kalemTbody') && $('kalemTbody').addEventListener('click', function(e) {
        const btn = e.target.closest('button[data-pasif]');
        if (btn && btn.dataset.id) pasifYap(btn.dataset.id);
      });

      function escapeHtml(s) {
        if (s == null) return '';
        const d = document.createElement('div');
        d.textContent = s;
        return d.innerHTML;
      }

      async function pasifYap(id) {
        if (!confirm('Bu kalemi pasif yapmak istediÄŸinize emin misiniz? Gider giriÅŸinde listelenmez.')) return;
        const sb = window.supabase;
        if (!sb) return;
        const { error } = await sb.from('gider_kalemleri').update({ aktif: false }).eq('id', id);
        if (error) { showToast('error', 'Hata', error.message); return; }
        showToast('success', 'Tamam', 'Kalem pasif yapÄ±ldÄ±');
        await loadKalemler();
      }

      $('katTip').addEventListener('change', updateKatParentDropdown);

      $('btnKatEkle').addEventListener('click', async () => {
        const sb = window.supabase;
        if (!sb) return;
        const ad = ($('katAd').value || '').trim();
        if (!ad) { showToast('warning', 'UyarÄ±', 'Kalem adÄ± girin'); return; }
        const tip = $('katTip').value;
        const parent_id = tip === 'alt' ? ($('katParent').value || null) : null;
        if (tip === 'alt' && !parent_id) { showToast('warning', 'UyarÄ±', 'Ãœst kategori seÃ§in'); return; }
        const { error } = await sb.from('gider_kalemleri').insert({ ad, parent_id: parent_id || null, sira: 0, aktif: true });
        if (error) { showToast('error', 'Hata', error.message); return; }
        showToast('success', 'Tamam', 'Kalem eklendi');
        $('katAd').value = '';
        await loadKalemler();
      });

      async function loadSonHareketler() {
        const sb = window.supabase;
        if (!sb) return;
        const { data, error } = await sb.from('aylik_giderler')
          .select('id, tarih, tutar, aciklama, gider_kalemleri(ad)')
          .order('tarih', { ascending: false })
          .order('created_at', { ascending: false })
          .limit(50);
        if (error) { showToast('error', 'Hata', 'Hareketler yÃ¼klenemedi'); return; }
        const rows = (data || []).map(r => {
          const ad = r.gider_kalemleri?.ad || 'â€”';
          const acik = (r.aciklama || '').replace(/</g, '&lt;');
          return `<tr><td>${(r.tarih || '').slice(0, 10)}</td><td>${ad}</td><td class="text-right">${fmt(r.tutar)}</td><td>${acik}</td></tr>`;
        });
        $('hareketTbody').innerHTML = rows.length ? rows.join('') : '<tr><td colspan="4" class="muted">HenÃ¼z kayÄ±t yok</td></tr>';
        $('sonHareketSayisi').textContent = rows.length + ' kayÄ±t';
      }

      async function loadRapor(yil, ay) {
        const sb = window.supabase;
        if (!sb) return;
        const { data: hareketler, error: errH } = await sb.from('aylik_giderler')
          .select('kalem_id, tutar, gider_kalemleri(id, ad, parent_id)')
          .eq('yil', yil)
          .eq('ay', ay);
        if (errH) { showToast('error', 'Hata', 'Rapor yÃ¼klenemedi: ' + errH.message); return; }

        const byKalem = {};
        (hareketler || []).forEach(h => {
          const kid = h.kalem_id;
          if (!byKalem[kid]) byKalem[kid] = { ad: h.gider_kalemleri?.ad || 'â€”', parent_id: h.gider_kalemleri?.parent_id, toplam: 0 };
          byKalem[kid].toplam += Number(h.tutar || 0);
        });

        const anaByParent = {};
        Object.entries(byKalem).forEach(([kid, v]) => {
          if (v.parent_id) {
            const pid = v.parent_id;
            if (!anaByParent[pid]) anaByParent[pid] = 0;
            anaByParent[pid] += v.toplam;
          }
        });

        const anaAdlar = {};
        kalemList.filter(k => k.parent_id == null).forEach(k => { anaAdlar[k.id] = k.ad; });

        const tbody = $('raporTbody');
        tbody.innerHTML = '';
        let genelToplam = 0;

        Object.entries(byKalem).forEach(([kid, v]) => {
          genelToplam += v.toplam;
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${v.ad}</td><td class="text-right">${fmt(v.toplam)}</td>`;
          tbody.appendChild(tr);
        });
        Object.entries(anaByParent).forEach(([pid, toplam]) => {
          const ad = anaAdlar[pid] || 'Ana kategori';
          const tr = document.createElement('tr');
          tr.className = 'rapor-ana-satir';
          tr.innerHTML = `<td>${ad} (toplam)</td><td class="text-right">${fmt(toplam)}</td>`;
          tbody.appendChild(tr);
        });
        if (Object.keys(byKalem).length > 0) {
          const tr = document.createElement('tr');
          tr.className = 'rapor-toplam-satir';
          tr.innerHTML = `<td>Genel toplam</td><td class="text-right">${fmt(genelToplam)}</td>`;
          tbody.appendChild(tr);
        }

        $('raporPlaceholder').style.display = tbody.children.length ? 'none' : 'block';
        $('raporTbl').style.display = tbody.children.length ? 'table' : 'none';
      }

      $('btnRapor').onclick = async () => {
        const yil = Number($('rYil').value);
        const ay = Number($('rAy').value);
        if (!yil || !ay) { showToast('warning', 'UyarÄ±', 'YÄ±l ve ay seÃ§in'); return; }
        await loadRapor(yil, ay);
        showToast('success', 'Rapor', 'Rapor gÃ¼ncellendi');
      };

      $('frmGider').addEventListener('submit', async e => {
        e.preventDefault();
        const sb = window.supabase;
        if (!sb) { showToast('error', 'Hata', 'BaÄŸlantÄ± yok'); return; }
        const tarih = $('gTarih').value;
        const kalem_id = $('gKalem').value;
        const tutar = parseMoney($('gTutar').value);
        const aciklama = ($('gAciklama').value || '').trim() || null;
        if (!tarih || !kalem_id || tutar == null || tutar < 0) { showToast('error', 'Hata', 'Tarih, kalem ve tutar gerekli'); return; }
        const d = new Date(tarih);
        const yil = d.getFullYear();
        const ay = d.getMonth() + 1;
        const { error } = await sb.from('aylik_giderler').insert({ yil, ay, kalem_id, tutar, tarih, aciklama });
        if (error) { showToast('error', 'Hata', 'KayÄ±t hatasÄ±: ' + error.message); return; }
        showToast('success', 'BaÅŸarÄ±lÄ±', 'Kaydedildi');
        e.target.reset();
        $('gTarih').value = new Date().toISOString().slice(0, 10);
        await loadSonHareketler();
      });

      async function initPageContent() {
        const now = new Date();
        $('gTarih').value = now.toISOString().slice(0, 10);
        $('rYil').value = now.getFullYear();
        $('rAy').value = String(now.getMonth() + 1);
        await loadKalemler();
        await loadSonHareketler();
      }

      window.initPage = async function() {
        try {
          await initPageContent();
        } catch (e) {
          console.error('initPage hatasÄ±:', e);
          showToast('error', 'Hata', (e && e.message) || 'Sayfa yÃ¼klenirken hata.');
        }
      };
    })();
  </script>
</body>
</html>
