<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8"/>
  <title>Genel Mizan | Muhasebe</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="icon" href="../img/logo.png"/>

  <style>
    /* =====================  AÃ‡IK TEMA & MOBÄ°L Ã–NCELÄ°K  ===================== */
    :root{
      --bg:#f7fafc; --surface:#ffffff; --text:#0f172a; --muted:#475569; --stroke:#e2e8f0;
      --brand:#0ea5e9; --brand2:#6366f1; --ok:#16a34a; --warn:#f59e0b; --bad:#ef4444;
      --radius:14px; --shadow:0 8px 24px rgba(2,6,23,.08);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,Segoe UI,Arial}

    /* Ãœst Bar */
    .appbar{position:sticky;top:0;z-index:5;height:56px;background:#ffffffd9;
      backdrop-filter:saturate(120%) blur(6px);border-bottom:1px solid var(--stroke);
      display:flex;align-items:center;justify-content:space-between;padding:0 12px}
    .appbar h1{margin:0;font-size:17px;font-weight:800}
    .btn{appearance:none;border:1px solid var(--stroke);background:#fff;border-radius:12px;padding:9px 12px;cursor:pointer;color:var(--text)}
    .btn:hover{background:#f8fafc}
    .btn.acc{background:linear-gradient(90deg,var(--brand),var(--brand2));border:0;color:#fff;font-weight:700}
    .btn.ok{background:linear-gradient(90deg,#22c55e,#16a34a);border:0;color:#fff}
    .btn.warn{background:linear-gradient(90deg,#fbbf24,#f59e0b);border:0;color:#1f2937}
    .btn.bad{background:linear-gradient(90deg,#fda4af,#ef4444);border:0;color:#fff}

    /* YerleÅŸim (mobil Ã¶ncelik) */
    .wrap{max-width:1250px;margin:16px auto;padding:0 12px;display:grid;gap:12px}
    .row{display:grid;gap:12px}
    /* KÃ¼Ã§Ã¼k ekran: tek sÃ¼tun; md: 2; lg: 3/4 */
    @media(min-width:700px){.cols-2{grid-template-columns:1fr 1fr}}
    @media(min-width:980px){.cols-3{grid-template-columns:1fr 1fr 1fr}}
    @media(min-width:1180px){.cols-4{grid-template-columns:1fr 1fr 1fr 1fr}}

    /* Kart */
    .card{background:var(--surface);border:1px solid var(--stroke);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card .hd{padding:12px;border-bottom:1px solid var(--stroke);display:flex;align-items:center;justify-content:space-between;gap:8px}
    .card .hd h3{margin:0;font-size:15px}
    .card .bd{padding:12px}
    .muted{color:var(--muted)}
    .hint{font-size:12px;color:var(--muted)}
    .divider{height:1px;background:var(--stroke);margin:8px 0}

    /* Formlar */
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input,select,textarea{width:100%;padding:10px;border-radius:12px;border:1px solid var(--stroke);background:#fff;color:var(--text)}
    input[type="date"]{padding:8px 10px}
    .grid-2{display:grid;gap:10px}
    @media(min-width:700px){.grid-2{grid-template-columns:1fr 1fr}}

    /* Tablo */
    table{width:100%;border-collapse:collapse}
    th,td{padding:9px;border-bottom:1px solid var(--stroke);text-align:left;vertical-align:top}
    thead th{background:#f1f5f9;font-weight:700}
    tr:hover{background:#f8fafc}
    .scroll-x{overflow:auto}

    /* Rozetler */
    .pill{display:inline-flex;align-items:center;gap:6px;border-radius:999px;padding:3px 8px;font-size:12px;border:1px solid var(--stroke)}
    .pill.gelir{background:#ecfdf5;border-color:#bbf7d0;color:#14532d}
    .pill.gider{background:#fff1f2;border-color:#fecdd3;color:#7f1d1d}
    .pill.tah{background:#eef2ff;border-color:#c7d2fe;color:#1e1b4b}

    /* Modal */
    .modal{position:fixed;inset:0;background:rgba(15,23,42,.35);display:none;align-items:center;justify-content:center;padding:12px}
    .modal .panel{width:min(880px,100%);max-height:90vh;overflow:auto}

    /* Toast */
    .toast{position:fixed;right:12px;bottom:12px;display:grid;gap:8px;z-index:9}
    .toast .t{background:#fff;border:1px solid var(--stroke);border-left:6px solid var(--brand);border-radius:10px;padding:10px 12px;box-shadow:var(--shadow)}

    /* EriÅŸilebilirlik */
    .sr-only{position:absolute;width:1px;height:1px;margin:-1px;border:0;padding:0;clip:rect(0 0 0 0);overflow:hidden}
  </style>
</head>
<body>
  <!-- ============ APPBAR ============ -->
  <div class="appbar" role="banner">
    <h1>ðŸ“š Genel Mizan (Muhasebe)</h1>
    <div style="display:flex;gap:8px">
      <button class="btn" onclick="history.back()">Geri</button>
      <button class="btn acc" id="btnLogout">Ã‡Ä±kÄ±ÅŸ</button>
    </div>
  </div>

  <main class="wrap">

    <!-- ===== 1) Ã–ZET: BugÃ¼n / Bu Ay / Bu YÄ±l (aynÄ± dÃ¼zen) ===== -->
    <section class="row cols-3" aria-label="Ã–zet">
      <!-- Ortak kart ÅŸablonu: iÃ§inde gelir-gider-tahakkuk-son csv -->
      <article class="card" aria-live="polite">
        <div class="hd"><h3>BugÃ¼n</h3></div>
        <div class="bd grid-2">
          <div><div class="muted">Gelir (cash)</div><div id="sumTodayGelir" style="font-weight:800;font-size:18px">â‚º0</div></div>
          <div><div class="muted">Gider (cash)</div><div id="sumTodayGider" style="font-weight:800;font-size:18px">â‚º0</div></div>
          <div><div class="muted">AÃ§Ä±k Tahakkuk</div><div id="sumTodayTah" style="font-weight:800;font-size:18px">â‚º0</div></div>
          <div><div class="muted">Son CSV</div><div id="sumTodayCSV" class="pill">â€”</div></div>
        </div>
      </article>
      <article class="card" aria-live="polite">
        <div class="hd"><h3>Bu Ay</h3></div>
        <div class="bd grid-2">
          <div><div class="muted">Gelir (cash)</div><div id="sumMonthGelir" style="font-weight:800;font-size:18px">â‚º0</div></div>
          <div><div class="muted">Gider (cash)</div><div id="sumMonthGider" style="font-weight:800;font-size:18px">â‚º0</div></div>
          <div><div class="muted">AÃ§Ä±k Tahakkuk</div><div id="sumMonthTah" style="font-weight:800;font-size:18px">â‚º0</div></div>
          <div><div class="muted">Son CSV</div><div id="sumMonthCSV" class="pill">â€”</div></div>
        </div>
      </article>
      <article class="card" aria-live="polite">
        <div class="hd"><h3>Bu YÄ±l</h3></div>
        <div class="bd grid-2">
          <div><div class="muted">Gelir (cash)</div><div id="sumYearGelir" style="font-weight:800;font-size:18px">â‚º0</div></div>
          <div><div class="muted">Gider (cash)</div><div id="sumYearGider" style="font-weight:800;font-size:18px">â‚º0</div></div>
          <div><div class="muted">AÃ§Ä±k Tahakkuk</div><div id="sumYearTah" style="font-weight:800;font-size:18px">â‚º0</div></div>
          <div><div class="muted">Son CSV</div><div id="sumYearCSV" class="pill">â€”</div></div>
        </div>
      </article>
    </section>

    <!-- ===== 2) Kategori YÃ¶neticisi + Kategori CSV + Ä°ÅŸlem CSV ===== -->
    <section class="row cols-3">
      <!-- Kategori YÃ¶neticisi -->
      <article class="card">
        <div class="hd"><h3>Kategori YÃ¶neticisi</h3></div>
        <div class="bd">
          <div class="grid-2">
            <div><label>Ãœst Kategori (path)</label><input id="katParent" placeholder="Ã¶rn. Kurban"/></div>
            <div><label>Yeni Kategori AdÄ±</label><input id="katAd" placeholder="BÃ¼yÃ¼kbaÅŸ, Ä°ftar..."/></div>
            <div>
              <label>Tip</label>
              <select id="katTip"><option value="gelir">gelir</option><option value="gider">gider</option><option value="herikisi">herikisi</option></select>
            </div>
            <div style="display:flex;align-items:end"><button class="btn ok" id="btnKatEkle">Ekle</button></div>
          </div>
          <div class="divider"></div>
          <p class="hint">KayÄ±tlÄ± kategoriler</p>
          <div class="scroll-x" style="max-height:260px">
            <table id="tblKat">
              <thead><tr><th>Path</th><th>Tip</th><th>Sil</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </article>

      <!-- Kategori CSV -->
      <article class="card">
        <div class="hd"><h3>Kategori CSV YÃ¼kleme</h3></div>
        <div class="bd">
          <div class="grid-2">
            <div><label>CSV DosyasÄ±</label><input type="file" id="csvKat" accept=".csv"/></div>
            <div style="display:flex;gap:8px;align-items:end">
              <button class="btn acc" id="btnKatImport">YÃ¼kle</button>
              <a class="btn" id="btnKatSample" href="#" download="kategori-sablon.csv">Åžablon</a>
            </div>
          </div>
          <div class="divider"></div>
          <p class="hint">BaÅŸlÄ±klar: <b>path,tip</b> (tip: gelir/gider/herikisi)</p>
          <div id="katImpRes" class="hint">HazÄ±r.</div>
        </div>
      </article>

      <!-- Ä°ÅŸlem CSV -->
      <article class="card">
        <div class="hd"><h3>Ä°ÅŸlem CSV YÃ¼kleme (Gelir/Gider)</h3></div>
        <div class="bd">
          <div class="grid-2">
            <div><label>CSV DosyasÄ±</label><input type="file" id="csvFile" accept=".csv"/></div>
            <div style="display:flex;gap:8px;align-items:end">
              <button class="btn acc" id="btnImport">Ä°Ã§e Aktar</button>
              <a class="btn" id="btnSample" href="#" download="islem-sablon.csv">Åžablon</a>
            </div>
          </div>
          <div class="divider"></div>
          <p class="hint">BaÅŸlÄ±klar: <b>tarih,yil,tip,kategori_path,personel_kodu,bagisci_vendor_kodu,tutar,adet,tahakkuk,etiketler,varlik_kodu,aciklama,iliski_kodu</b></p>
          <div aria-live="polite" id="importRes" class="hint">HazÄ±r.</div>
        </div>
      </article>
    </section>

    <!-- ===== 3) HÄ±zlÄ± GiriÅŸ + Tahakkuk Tahsilat + Personel YÃ¶netimi ===== -->
    <section class="row cols-3">
      <!-- HÄ±zlÄ± Ä°ÅŸlem GiriÅŸi -->
      <article class="card">
        <div class="hd"><h3>HÄ±zlÄ± Ä°ÅŸlem GiriÅŸi</h3></div>
        <div class="bd">
          <form id="frmQuick" class="grid-2">
            <div>
              <label for="qTip">Tip</label>
              <select id="qTip" required>
                <option value="gelir">Gelir</option><option value="gider">Gider</option>
              </select>
            </div>
            <div>
              <label for="qTarih">Tarih</label>
              <input type="date" id="qTarih" required/>
            </div>

            <div class="grid-2" style="grid-column:1/-1">
              <div>
                <label for="qKategoriPath">Kategori (Path)</label>
                <input id="qKategoriPath" placeholder="Ã–rn: Ramazan>Ä°ftar" list="katList" required/>
                <datalist id="katList"></datalist>
                <div class="hint">Tipâ€™e gÃ¶re liste (gelir/gider/herikisi) filtrelenir.</div>
              </div>
              <div>
                <label for="qEtiketler">Alt Etiket(ler)</label>
                <input id="qEtiketler" placeholder="virgÃ¼l ile: yakÄ±t,ÅŸube-2"/>
              </div>
            </div>

            <div><label for="qPersonel">Personel</label><input id="qPersonel" placeholder="ID ya da ad soyad" required/></div>
            <div><label for="qBV">BaÄŸÄ±ÅŸÃ§Ä±/TedarikÃ§i</label><input id="qBV" placeholder="Opsiyonel"/></div>

            <div><label for="qTutar">Tutar (â‚º)</label><input type="number" step="0.01" id="qTutar" required/></div>
            <div><label for="qAdet">Adet</label><input type="number" step="1" id="qAdet"/></div>

            <div class="grid-2" style="grid-column:1/-1">
              <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
                <input type="checkbox" id="qTahakkuk"/><label for="qTahakkuk" style="margin:0">Tahakkuk (kasayÄ± etkilemez)</label>
              </div>
              <div>
                <label for="qIliski">Ä°liÅŸki Kodu</label>
                <input id="qIliski" placeholder="Ã¶rn. RF-00001 (tahakkuksa TRF-00001)"/>
              </div>
            </div>

            <div style="grid-column:1/-1">
              <label for="qAciklama">AÃ§Ä±klama</label>
              <textarea id="qAciklama" rows="2" placeholder="KÄ±sa not"></textarea>
            </div>

            <div style="grid-column:1/-1;display:flex;gap:8px;justify-content:end">
              <button class="btn ok" type="submit">Kaydet</button>
              <button class="btn" type="reset">Temizle</button>
            </div>
          </form>
        </div>
      </article>

      <!-- Tahakkuk Tahsilat -->
      <article class="card">
        <div class="hd"><h3>Tahakkuk Tahsilat</h3></div>
        <div class="bd grid-2">
          <div><label>Ä°liÅŸki Kodu</label><input id="tsIliski" placeholder="(Ã¶rn. TRF-00001)"/></div>
          <div><label>Tutar (â‚º)</label><input id="tsTutar" type="number" step="0.01"/></div>
          <div><label>Kategori (ops.)</label><input id="tsPath" list="katList" placeholder="Tahsil kaydÄ± iÃ§in kategori"/></div>
          <div style="display:flex;align-items:end;gap:8px">
            <button class="btn ok" id="btnTahsil">Tahsil Et</button>
          </div>
          <div class="hint" id="tsRes">AÃ§Ä±k tahakkuktan dÃ¼ÅŸer + kasa kaydÄ± oluÅŸturur.</div>
        </div>
      </article>

      <!-- Personel YÃ¶netimi -->
      <article class="card">
        <div class="hd"><h3>Personel YÃ¶netimi</h3></div>
        <div class="bd">
          <div class="grid-2">
            <div><label>Personel ID</label><input id="pId" placeholder="P001" /></div>
            <div><label>Ad Soyad</label><input id="pAd" placeholder="Ad Soyad"/></div>
            <div>
              <label>Durum</label>
              <select id="pDurum"><option value="aktif">aktif</option><option value="pasif">pasif</option></select>
            </div>
            <div style="display:flex;align-items:end;gap:8px">
              <button class="btn ok" id="btnPerKaydet">Kaydet/GÃ¼ncelle</button>
              <button class="btn" id="btnPerTemizle">Temizle</button>
            </div>
          </div>
          <div class="divider"></div>
          <div class="scroll-x" style="max-height:240px">
            <table id="tblPer">
              <thead><tr><th>ID</th><th>Ad Soyad</th><th>Durum</th><th>Sil</th></tr></thead>
              <tbody></tbody>
            </table>
          </div>
          <p class="hint">Ä°ÅŸlem giriÅŸlerinde personel ID/ad eÅŸleÅŸmesi iÃ§in referans.</p>
        </div>
      </article>
    </section>

    <!-- ===== 4) BÃ¼tÃ§e PlanÄ± + BÃ¼tÃ§e Pay Et + Ä°ÅŸlem Filtreleri ===== -->
    <section class="row cols-3">
      <!-- BÃ¼tÃ§e PlanÄ± -->
      <article class="card">
        <div class="hd"><h3>BÃ¼tÃ§e PlanÄ± (OluÅŸtur/GÃ¼ncelle)</h3></div>
        <div class="bd">
          <form id="frmButce" class="grid-2">
            <div><label>YÄ±l</label><input id="bYil" type="number" placeholder="2026" required/></div>
            <div><label>Tip</label>
              <select id="bTip"><option value="gelir">gelir</option><option value="gider">gider</option></select>
            </div>
            <div style="grid-column:1/-1"><label>Path</label>
              <input id="bPath" placeholder="Kurban veya Ramazan>Ä°ftar" required list="katList"/>
            </div>
            <div><label>Hedef Tutar (â‚º)</label><input id="bHedef" type="number" step="0.01" required/></div>
            <div><label>Not (ops.)</label><input id="bNot" placeholder="AÃ§Ä±klama"/></div>
            <div style="grid-column:1/-1;display:flex;justify-content:end;gap:8px">
              <button class="btn ok" type="submit">Kaydet</button>
            </div>
          </form>
        </div>
      </article>

      <!-- BÃ¼tÃ§e â†’ Personele Pay Et -->
      <article class="card">
        <div class="hd"><h3>BÃ¼tÃ§e â†’ Personele Pay Et</h3></div>
        <div class="bd grid-2">
          <div><label>YÄ±l</label><input id="bpYil" type="number" placeholder="2026"/></div>
          <div><label>Tip</label><select id="bpTip"><option value="gelir">gelir</option><option value="gider">gider</option></select></div>
          <div><label>Kategori (Ã¼st/alt)</label><input id="bpPath" list="katList" placeholder="Ramazan>Ä°ftar"/></div>
          <div><label>Personel ID</label><input id="bpPer" placeholder="P001"/></div>
          <div><label>Miktar (â‚º)</label><input id="bpMiktar" type="number" step="0.01"/></div>
          <div><label>YÃ¼zde (%)</label><input id="bpYuzde" type="number" step="0.01" placeholder="Miktar boÅŸsa yÃ¼zdeden hesap"/></div>
          <div style="grid-column:1/-1;display:flex;justify-content:end"><button class="btn ok" id="btnButcePay">Kaydet</button></div>
          <div class="hint">Miktar doluysa yÃ¼zdeyi sistem hesaplar; yÃ¼zde doluysa miktarÄ± sistem hesaplar.</div>
        </div>
      </article>

      <!-- Ä°ÅŸlem Filtreleri -->
      <article class="card">
        <div class="hd"><h3>Ä°ÅŸlem Filtreleri</h3></div>
        <div class="bd grid-2">
          <div><label>Tarih (BaÅŸlangÄ±Ã§)</label><input type="date" id="fStart"/></div>
          <div><label>Tarih (BitiÅŸ)</label><input type="date" id="fEnd"/></div>
          <div>
            <label>Tip</label>
            <select id="fTip"><option value="">Hepsi</option><option value="gelir">Gelir</option><option value="gider">Gider</option></select>
          </div>
          <div><label>Kategori (path)</label><input id="fPath" placeholder="Ã–rn: Kurban>BÃ¼yÃ¼kbaÅŸ"/></div>
          <div><label>Personel</label><input id="fPersonel" placeholder="Ad soyad veya ID"/></div>
          <div style="display:flex;gap:8px;align-items:end">
            <button class="btn ok" id="btnFiltreUygula">Uygula</button>
            <button class="btn" id="btnFiltreTemizle">Temizle</button>
          </div>
        </div>
      </article>
    </section>

    <!-- ===== 5) Son Ä°ÅŸlemler ===== -->
    <section class="card" aria-label="Son Ä°ÅŸlemler">
      <div class="hd">
        <h3>Son Ä°ÅŸlemler</h3>
        <div style="display:flex;gap:8px;align-items:center">
          <button class="btn" id="btnExcel">CSV DÄ±ÅŸa Aktar</button>
          <span class="muted" id="cntInfo">0 kayÄ±t</span>
        </div>
      </div>
      <div class="bd">
        <div class="sr-only" aria-live="polite" id="liveTable"></div>
        <div class="scroll-x">
          <table id="tbl">
            <thead>
              <tr><th>Tarih</th><th>Tip</th><th>Kategori</th><th>Personel</th><th>Tutar</th><th>Tahakkuk</th><th>Ä°liÅŸki</th><th>AÃ§Ä±klama</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>
  </main>

  <!-- ===== Kategori Modal (opsiyonel geniÅŸletme) ===== -->
  <div class="modal" id="modalKat" role="dialog" aria-modal="true" aria-labelledby="katTitle">
    <div class="panel card">
      <div class="hd">
        <h3 id="katTitle">ðŸ“‚ Kategori YÃ¶neticisi</h3>
        <button class="btn" onclick="hideKat()">Kapat</button>
      </div>
      <div class="bd">
        <!-- Åžimdilik ana sayfadaki yÃ¶neticiyi kullanÄ±yoruz; bu modal yedek -->
        <p class="hint">Modal yedek alan. Ana ekrandaki yÃ¶neticiyi kullanabilirsiniz.</p>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- Firebase + PapaParse -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="../js/firebase/firebase-init.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

  <script>
    /* =====================  JS: LOJÄ°K  ===================== */
    const auth = firebase.auth();
    const db = window.db;
    const $ = (id)=>document.getElementById(id);
    const toastBox = $('toast');

    function toast(msg){const d=document.createElement('div');d.className='t';d.textContent=msg;toastBox.appendChild(d);setTimeout(()=>d.remove(),3500)}
    const fmt = n => (n==null||isNaN(n)) ? 'â‚º0' : 'â‚º' + Number(n).toLocaleString('tr-TR',{maximumFractionDigits:2});
    const toDateInput = d => new Date(d).toISOString().slice(0,10);
    function parseMoney(v){ if(v==null||v==='') return null; return Number(String(v).replace(/[â‚º\s\.]/g,'').replace(',', '.')); }

    // SHA-256 â†’ hex (idempotent satÄ±r anahtarÄ±)
    async function sha256Hex(s){
      const enc=new TextEncoder().encode(s);const buf=await crypto.subtle.digest('SHA-256',enc);
      return Array.from(new Uint8Array(buf)).map(b=>b.toString(16).padStart(2,'0')).join('');
    }
    async function rowUID(o){ const raw=`${o.yil}|${o.tip}|${o.path}|${o.tarih}|${o.tutar||''}|${o.bv||''}|${o.iliski||''}`; return sha256Hex(raw); }

    /* ---- Yetki + sayfa log ---- */
    auth.onAuthStateChanged(async (u)=>{
      if(!u){ location.href='../index.html'; return; }
      await db.collection('sayfa_loglari').add({sayfa:'genelmizan', uid:u.uid, zaman:new Date(), ua:navigator.userAgent});
      initPage();
    });
    $('btnLogout').onclick = ()=> auth.signOut();

    /* =====================  KATEGORÄ°LER  ===================== */
    const tblKatBody = ()=>$('tblKat').querySelector('tbody');

    async function loadKategoriler(){
      const body = tblKatBody(); body.innerHTML='<tr><td colspan="3" class="muted">YÃ¼kleniyor...</td></tr>';
      const snap = await db.collection('kategoriler').orderBy('path').get();
      const rows=[];
      snap.forEach(doc=>{
        const d=doc.data();
        rows.push(`<tr><td>${d.path}</td><td>${d.tip}</td><td><button class="btn bad" onclick="silKat('${doc.id}','${d.path}')">Sil</button></td></tr>`);
      });
      body.innerHTML = rows.join('') || '<tr><td colspan="3" class="muted">Kategori yok</td></tr>';
      // datalist
      const dl=$('katList'); dl.innerHTML='';
      snap.forEach(doc=>{ const d=doc.data(); const o=document.createElement('option'); o.value=d.path; dl.appendChild(o); });
    }
    async function silKat(id, path){
      if(!confirm(`Silinsin mi?\n${path}`)) return;
      await db.collection('kategoriler').doc(id).delete();
      toast('Kategori silindi'); loadKategoriler();
    }
    $('btnKatEkle').onclick = async ()=>{
      const parent=$('katParent').value.trim();
      const ad=$('katAd').value.trim();
      const tip=$('katTip').value;
      if(!ad){toast('Kategori adÄ± gerekli');return}
      const path = parent ? `${parent}>${ad}` : ad;
      const dup = await db.collection('kategoriler').where('path','==',path).limit(1).get();
      if(!dup.empty){toast('Bu path zaten var');return}
      await db.collection('kategoriler').add({ad,tip,parent_id:null,path,seviye:path.split('>').length-1,aktif:true,sira:0});
      $('katAd').value='';
      toast('Kategori eklendi'); loadKategoriler();
    };

    // Tip'e gÃ¶re kategori listesi filtreleme
    async function updateKatDatalistForTip(formTip){
      const q = await db.collection('kategoriler').get();
      const dl=$('katList'); dl.innerHTML='';
      q.forEach(doc=>{
        const d=doc.data();
        if(d.tip==='herikisi' || d.tip===formTip){
          const o=document.createElement('option'); o.value=d.path; dl.appendChild(o);
        }
      });
    }
    window.silKat = silKat; // inline onclick iÃ§in

    /* =====================  PERSONEL  ===================== */
    async function loadPersoneller(){
      const body=$('tblPer').querySelector('tbody'); body.innerHTML='<tr><td colspan="4" class="muted">YÃ¼kleniyor...</td></tr>';
      const snap = await db.collection('personeller').orderBy('personel_id').get();
      const rows=[];
      snap.forEach(doc=>{
        const d=doc.data();
        rows.push(`<tr>
          <td>${d.personel_id||'-'}</td>
          <td>${d.ad||'-'}</td>
          <td>${d.durum||'-'}</td>
          <td><button class="btn bad" onclick="silPer('${doc.id}')">Sil</button></td>
        </tr>`);
      });
      body.innerHTML = rows.join('') || '<tr><td colspan="4" class="muted">KayÄ±t yok</td></tr>';
    }
    async function silPer(id){
      if(!confirm('Personel silinsin mi?')) return;
      await db.collection('personeller').doc(id).delete();
      toast('Personel silindi'); loadPersoneller();
    }
    window.silPer = silPer;

    $('btnPerKaydet').onclick = async ()=>{
      const id=$('pId').value.trim(); const ad=$('pAd').value.trim(); const durum=$('pDurum').value;
      if(!id || !ad){ toast('ID ve Ad Soyad gerekli'); return; }
      await db.collection('personeller').doc(id).set({personel_id:id, ad, durum, guncel_at:new Date()},{merge:true});
      toast('Personel kaydedildi/gÃ¼ncellendi'); $('pAd').value=''; $('pId').value='';
      loadPersoneller();
    };
    $('btnPerTemizle').onclick = ()=>{ $('pId').value=''; $('pAd').value=''; $('pDurum').value='aktif'; };

    /* =====================  Ä°LÄ°ÅžKÄ° KODU & TAHAKKUK UZLAÅžTIRMA  ===================== */
    function initialsFromPath(path){
      // "Ramazan-Ä± Åžerif>Ä°ftar" -> "RF" (ilk iki segmentin ilk harfi)
      const segs = String(path||'').split('>').map(s=>s.trim()).filter(Boolean);
      const letters = segs.map(s=>{
        const clean = s.replace(/[^A-Za-zÃ‡ÄžÄ°Ã–ÅžÃœÃ§ÄŸÄ±Ã¶ÅŸÃ¼]/g,' ').trim().split(/\s+/)[0]||'';
        return clean[0] ? clean[0].toUpperCase() : '';
      }).join('');
      return letters.slice(0,2) || 'XX';
    }
    async function nextIliskiCode(prefix){
      const id = `iliski_${prefix}`;
      const ref = db.collection('sayaclar').doc(id);
      const n = await db.runTransaction(async (trx)=>{
        const snap = await trx.get(ref);
        const cur = snap.exists ? (snap.data().seq||0) : 0;
        const next = cur+1;
        trx.set(ref,{seq:next, updated_at:new Date()},{merge:true});
        return next;
      });
      return `${prefix}-${String(n).padStart(5,'0')}`;
    }
    async function reconcileAccrualsByIliski(iliskiId, tahsilTutar, tip='gelir') {
      if(!iliskiId || !tahsilTutar || tahsilTutar <= 0) return {applied:0, items:[], kalan:tahsilTutar};
      const q = await db.collection('islemler')
        .where('tahakkuk','==',true)
        .where('durum','==','acik')
        .where('tip','==',tip)
        .where('iliski_id','==',iliskiId)
        .orderBy('tarih','asc').get();

      let kalan = tahsilTutar; const items=[];
      for(const doc of q.docs){
        if(kalan<=0) break;
        await db.runTransaction(async (trx)=>{
          const snap = await trx.get(doc.ref); const cur=snap.data();
          const bakiye = (cur.kalan_tutar ?? cur.tutar ?? 0) - (cur.tahsilat_toplam||0);
          if(bakiye<=0) return;
          const dusulecek = Math.min(kalan, bakiye);
          kalan -= dusulecek;
          const yeniToplam = (cur.tahsilat_toplam||0) + dusulecek;
          const yeniKalan = Math.max(0, (cur.kalan_tutar ?? cur.tutar ?? 0) - yeniToplam);
          const patch = {tahsilat_toplam:yeniToplam, kalan_tutar:yeniKalan};
          if(yeniKalan===0){ patch.durum='tamam'; patch.kapandi_at=new Date(); }
          trx.set(doc.ref, patch, {merge:true});
          items.push({id:doc.id, dusulen:dusulecek});
        });
      }
      return {applied: tahsilTutar-kalan, items, kalan};
    }

    /* =====================  HIZLI Ä°ÅžLEM GÄ°RÄ°ÅžÄ°  ===================== */
    $('qTarih').value = toDateInput(new Date());
    $('qTip').addEventListener('change', ()=>updateKatDatalistForTip($('qTip').value));

    $('qKategoriPath').addEventListener('blur', ()=>{
      // kullanÄ±cÄ± yazdÄ±ysa placeholder'da bir Ã¶nizleme gÃ¶ster
      const base = initialsFromPath($('qKategoriPath').value);
      const prefix = ($('qTahakkuk').checked? 'T':'' ) + base;
      $('qIliski').placeholder = `${prefix}-00000`;
    });

    $('frmQuick').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const tip=$('qTip').value;
      const tarih=new Date($('qTarih').value||Date.now());
      const yil=tarih.getFullYear(); const ay=tarih.getMonth()+1;
      const path=$('qKategoriPath').value.trim();
      const etiketler=$('qEtiketler').value.trim()? $('qEtiketler').value.split(',').map(s=>s.trim()).filter(Boolean):[];
      const personel=$('qPersonel').value.trim(); const bv=$('qBV').value.trim();
      const tutar=parseMoney($('qTutar').value); const adet=Number($('qAdet').value||0)||null;
      const tahakkuk=$('qTahakkuk').checked; let iliski=$('qIliski').value.trim();
      const aciklama=$('qAciklama').value.trim()||null;

      if(!path || !tutar){toast('Kategori ve tutar zorunlu');return}

      // otomatik iliÅŸki kodu
      if(!iliski){
        const base = initialsFromPath(path);
        const prefix = (tahakkuk? 'T' : '') + base; // Ã¶rn: TRF
        iliski = await nextIliskiCode(prefix);
      }

      const uid=await rowUID({yil,tip,path,tarih:tarih.toISOString().slice(0,10),tutar,bv,iliski});
      const doc={
        tarih,yil,ay,hafta:Number(new Intl.DateTimeFormat('tr-TR',{week:'numeric'}).format(tarih))||0,
        gun:tarih.toISOString().slice(0,10),
        tip,kategori_path:path,kategori_id:null,
        personel_id:personel||null,bagisci_vendor_id:bv||null,
        tutar,adet,para_birimi:'TRY',
        tahakkuk, durum:tahakkuk?'acik':'tamam',
        iliski_id: iliski||null, etiketler, varlik_id:null,
        kaynak:'form', row_uid:uid, aciklama
      };

      // tahakkuksa baÅŸlangÄ±Ã§ metrikleri
      if (tahakkuk) {
        doc.tahsilat_toplam = 0;
        doc.kalan_tutar = tutar;
        doc.kapandi_at = null;
      }

      await db.collection('islemler').doc(uid).set(doc,{merge:true});

      // eÄŸer tahakkuk DEÄžÄ°L ve iliski varsa; girilen tahsilatÄ± aÃ§Ä±k tahakkuklardan dÃ¼ÅŸ
      if(!tahakkuk && iliski){
        const rec = await reconcileAccrualsByIliski(iliski, tutar, tip);
        await db.collection('islemler').doc(uid).set({tahakkuk_settle:rec.items},{merge:true});
        if(rec.kalan>0){ toast(`UyarÄ±: ${fmt(rec.kalan)} tahsil aÃ§Ä±k tahakkukla eÅŸleÅŸmedi`); }
      }

      toast('Kaydedildi');
      e.target.reset(); $('qTarih').value = toDateInput(new Date());
      await Promise.all([refreshSummary(), loadSonIslemler()]);
    });

    /* =====================  TAHAKKUK TAHSÄ°LAT BUTONU  ===================== */
    $('btnTahsil').onclick = async ()=>{
      const il = $('tsIliski').value.trim();
      const tutar = parseMoney($('tsTutar').value);
      const path = $('tsPath').value.trim() || 'Tahsilatlar';
      if(!il || !tutar){ toast('Ä°liÅŸki ve tutar gerekli'); return; }
      const tarih = new Date(); const yil=tarih.getFullYear(); const ay=tarih.getMonth()+1;

      // Ã–nce reconcile
      const rec = await reconcileAccrualsByIliski(il, tutar, 'gelir');

      // Sonra kasa geliri
      const uid = await rowUID({yil, tip:'gelir', path, tarih:tarih.toISOString().slice(0,10), tutar, bv:'', iliski:il});
      await db.collection('islemler').doc(uid).set({
        tarih, yil, ay, hafta:Number(new Intl.DateTimeFormat('tr-TR',{week:'numeric'}).format(tarih))||0,
        gun:tarih.toISOString().slice(0,10), tip:'gelir', kategori_path:path,
        personel_id:null, bagisci_vendor_id:null, tutar, para_birimi:'TRY',
        tahakkuk:false, durum:'tamam', iliski_id:il, etiketler:['tahsil'], varlik_id:null,
        kaynak:'form', row_uid:uid, aciklama:'Tahakkuk tahsilat', tahakkuk_settle:rec.items
      },{merge:true});

      $('tsRes').textContent = `Mahsup: ${fmt(rec.applied)} â€¢ Kalan: ${fmt(rec.kalan)}`;
      toast('Tahsil kaydedildi & mahsup edildi');
      $('tsIliski').value=''; $('tsTutar').value=''; $('tsPath').value='';
      await Promise.all([refreshSummary(), loadSonIslemler()]);
    };

    /* =====================  CSV: Ä°ÅžLEM & KATEGORÄ°  ===================== */
    // Ä°ÅŸlem CSV ÅŸablonu
    $('btnSample').addEventListener('click',(e)=>{
      e.preventDefault();
      const head='tarih,yil,tip,kategori_path,personel_kodu,bagisci_vendor_kodu,tutar,adet,tahakkuk,etiketler,varlik_kodu,aciklama,iliski_kodu\n';
      const sample=[
        '2025-03-20,2025,gelir,"Ramazan>Ä°ftar",P001,B123,15555,,true,,,"Ä°ftar taahhÃ¼dÃ¼","TRF-00001"',
        '2025-04-05,2025,gelir,"Ramazan>Ä°ftar",P001,B123,15555,,false,,,"Tahsilat","TRF-00001"',
        '2025-02-12,2025,gider,"Ä°aÅŸe>Yemekhane",,V045,3250,,false,,,"Pazar alÄ±ÅŸveriÅŸi",'
      ].join('\n');
      downloadCSV('islem-sablon.csv', head+sample);
    });

    // Ä°ÅŸlem CSV iÃ§e aktar
    $('btnImport').onclick = ()=>{
      const file=$('csvFile').files[0]; if(!file){toast('CSV dosyasÄ± seÃ§');return}
      Papa.parse(file,{
        header:true,skipEmptyLines:true,
        complete: async ({data,errors})=>{
          if(errors.length){ $('importRes').textContent='CSV hata: '+errors[0].message; toast('CSV hata'); return;}
          let done=0,total=data.length; const chunkSize=400;
          for(let i=0;i<data.length;i+=chunkSize){
            const chunk=data.slice(i,i+chunkSize); const batch=db.batch();
            for(const r of chunk){
              const tarih=new Date(r.tarih||Date.now()); const yil=Number(r.yil||tarih.getFullYear());
              const tip=(r.tip||'').trim(); const path=(r.kategori_path||'').trim(); const tutar=parseMoney(r.tutar);
              if(!yil||!tip||!path||!tutar) continue;
              const uid=await rowUID({yil,tip,path,tarih:tarih.toISOString().slice(0,10),tutar,bv:r.bagisci_vendor_kodu||'',iliski:r.iliski_kodu||''});
              const ref=db.collection('islemler').doc(uid);
              const tah = String(r.tahakkuk).toLowerCase()==='true';
              batch.set(ref,{
                tarih,yil,ay:tarih.getMonth()+1,hafta:Number(new Intl.DateTimeFormat('tr-TR',{week:'numeric'}).format(tarih))||0,
                gun:tarih.toISOString().slice(0,10),
                tip,kategori_path:path,kategori_id:null,
                personel_id:(r.personel_kodu||null),bagisci_vendor_id:(r.bagisci_vendor_kodu||null),
                tutar,adet:r.adet?Number(r.adet):null,para_birimi:'TRY',
                tahakkuk:tah, durum:tah?'acik':'tamam',
                iliski_id:r.iliski_kodu||null,
                etiketler:r.etiketler?String(r.etiketler).split(',').map(s=>s.trim()).filter(Boolean):[],
                varlik_id:r.varlik_kodu||null,
                kaynak:'csv',row_uid:uid,aciklama:r.aciklama||null,
                ...(tah ? {tahsilat_toplam:0, kalan_tutar:tutar, kapandi_at:null} : {})
              },{merge:true});
            }
            await batch.commit(); done+=chunk.length;
            $('importRes').textContent=`AktarÄ±ldÄ±: ${done}/${total}`;
          }
          await db.collection('sayfa_loglari').add({sayfa:'genelmizan_csv',adet:data.length,zaman:new Date()});
          toast('CSV iÃ§e aktarÄ±m tamam');
          window.lastCSVAt = new Date(); // Ã¶zet kartlarÄ±nda kullan
          await Promise.all([refreshSummary(), loadSonIslemler()]);
        }
      });
    };

    // Kategori CSV ÅŸablonu
    $('btnKatSample').addEventListener('click',(e)=>{
      e.preventDefault();
      const head='path,tip\n';
      const sample=[
        'Ramazan-Ä± Åžerif,herikisi',
        'Ramazan-Ä± Åžerif>Ä°ftar,gelir',
        'Ramazan-Ä± Åžerif>Sahur,gelir',
        'Kurban,herikisi',
        'Kurban>BÃ¼yÃ¼kbaÅŸ,gelir'
      ].join('\n');
      downloadCSV('kategori-sablon.csv', head+sample);
    });

    // Kategori CSV yÃ¼kleme
    $('btnKatImport').onclick = ()=>{
      const file=$('csvKat').files[0]; if(!file){toast('CSV dosyasÄ± seÃ§');return}
      Papa.parse(file,{
        header:true,skipEmptyLines:true,
        complete: async ({data,errors})=>{
          if(errors.length){ $('katImpRes').textContent='CSV hata: '+errors[0].message; toast('CSV hata'); return;}
          let done=0,total=data.length; const batch=db.batch();
          for(const r of data){
            const path=(r.path||'').trim(); const tip=(r.tip||'').trim();
            if(!path || !tip) continue;
            const ref = db.collection('kategoriler').doc(path);
            batch.set(ref,{path, tip, aktif:true, seviye:path.split('>').length-1, sira:0},{merge:true});
            done++;
          }
          await batch.commit();
          $('katImpRes').textContent = `YÃ¼klendi: ${done}/${total}`;
          toast('Kategori CSV yÃ¼klendi'); loadKategoriler();
        }
      });
    };

    function downloadCSV(name, content){
      const blob=new Blob([content],{type:'text/csv;charset=utf-8'});
      const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=name; a.click(); URL.revokeObjectURL(url);
    }

    /* =====================  BÃœTÃ‡E  ===================== */
    async function getBudget(yil, path, tip){
      const doc = await db.collection('butce_planlari').doc(String(yil)).get();
      if(!doc.exists) return null;
      const d=doc.data();
      if(Array.isArray(d.kalemler)){
        if(path){
          const list = d.kalemler.filter(k=>k.tip===tip && String(k.path).startsWith(path));
          if(!list.length) return null;
          return {hedef_tutar: list.reduce((a,b)=>a+(b.hedef_tutar||0),0), paths:list.map(k=>k.path)};
        }else{
          const toplam = d.kalemler.filter(k=>k.tip===tip).reduce((a,b)=>a+(b.hedef_tutar||0),0);
          return {path:'*', tip, hedef_tutar:toplam};
        }
      }
      return null;
    }

    // BÃ¼tÃ§e oluÅŸtur/gÃ¼ncelle
    $('frmButce').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const yil = Number($('bYil').value);
      const tip = $('bTip').value;
      const path = $('bPath').value.trim();
      const hedef = parseMoney($('bHedef').value);
      const not = $('bNot').value.trim() || null;
      if(!yil || !path || !hedef){ toast('YÄ±l/Path/Hedef gereklidir'); return; }

      const docRef = db.collection('butce_planlari').doc(String(yil));
      await db.runTransaction(async (trx)=>{
        const snap = await trx.get(docRef);
        const base = snap.exists ? snap.data() : {kalemler:[], versiyon:0};
        const arr = base.kalemler || [];
        const idx = arr.findIndex(k=>k.path===path && k.tip===tip);
        const yeni = {path, tip, hedef_tutar:hedef, not};
        if(idx>=0) arr[idx] = {...arr[idx], ...yeni};
        else arr.push(yeni);
        trx.set(docRef, {kalemler:arr, versiyon:(base.versiyon||0)+1, published_at:new Date()}, {merge:true});
      });
      toast('BÃ¼tÃ§e kalemi eklendi/gÃ¼ncellendi');
      e.target.reset();
      refreshSummary(); // yÄ±l toplamlarÄ± deÄŸiÅŸebilir
    });

    // Personele pay
    $('btnButcePay').onclick = async ()=>{
      const yil=Number($('bpYil').value), tip=$('bpTip').value, path=$('bpPath').value.trim(), per=$('bpPer').value.trim();
      let miktar=parseMoney($('bpMiktar').value), yuzde=Number($('bpYuzde').value||0);
      if(!yil || !path || !per || (!miktar && !yuzde)){ toast('Zorunlu alanlar eksik'); return; }
      const b = await getBudget(yil, path, tip);
      if(!b){ toast('Ã–nce kategori iÃ§in bÃ¼tÃ§e hedefi giriniz'); return; }
      if(!miktar && yuzde){ miktar = b.hedef_tutar * (yuzde/100); }
      if(miktar && !yuzde){ yuzde = (miktar / b.hedef_tutar)*100; }
      await db.collection('butce_planlari').doc(String(yil))
        .collection('personel_pay').doc(`${tip}:${path}:${per}`).set({
          tip, path, personel_id:per, miktar, yuzde, updated_at:new Date()
        },{merge:true});
      toast('Personel hedefi kaydedildi');
      $('bpPer').value=''; $('bpMiktar').value=''; $('bpYuzde').value='';
    };

    /* =====================  FÄ°LTRE + LÄ°STE  ===================== */
    async function loadSonIslemler(){
      const fs=$('fStart').value, fe=$('fEnd').value, fTip=$('fTip').value, fPath=$('fPath').value.trim(), fPer=$('fPersonel').value.trim();
      let ref=db.collection('islemler');
      // Firestoreâ€™da bir aralÄ±ÄŸa gÃ¶re filtre kullanÄ±yorsak aynÄ± alana orderBy gerekli
      if(fs) ref=ref.where('gun','>=',fs);
      if(fe) ref=ref.where('gun','<=',fe);
      ref=ref.orderBy('gun','desc').limit(800);

      const snap=await ref.get(); const rows=[]; let count=0;
      snap.forEach(doc=>{
        const d=doc.data();
        if(fTip && d.tip!==fTip) return;
        if(fPath && !String(d.kategori_path||'').startsWith(fPath)) return;
        if(fPer && String(d.personel_id||'').toLowerCase().indexOf(fPer.toLowerCase())===-1) return;
        count++;
        rows.push(`<tr>
          <td>${(d.gun||'').slice(0,10)}</td>
          <td><span class="pill ${d.tip}">${d.tip}</span></td>
          <td>${d.kategori_path||'-'}</td>
          <td>${d.personel_id||'-'}</td>
          <td>${fmt(d.tutar)}</td>
          <td>${d.tahakkuk?'<span class="pill tah">tahakkuk</span>':'-'}</td>
          <td>${d.iliski_id||'-'}</td>
          <td>${d.aciklama? d.aciklama.replace(/</g,'&lt;') : ''}</td>
        </tr>`);
      });
      $('tbl').querySelector('tbody').innerHTML = rows.join('') || `<tr><td colspan="8" class="muted">KayÄ±t bulunamadÄ±</td></tr>`;
      $('cntInfo').textContent = `${count} kayÄ±t`;
      $('liveTable').textContent = `Tablo gÃ¼ncellendi, ${count} kayÄ±t.`;
    }
    $('btnFiltreUygula').onclick = loadSonIslemler;
    $('btnFiltreTemizle').onclick = ()=>{['fStart','fEnd','fTip','fPath','fPersonel'].forEach(id=>$(id).value=''); loadSonIslemler();};

    // CSV dÄ±ÅŸa aktar (listede gÃ¶rÃ¼lenler)
    $('btnExcel').onclick = ()=>{
      const rows=[['tarih','tip','kategori','personel','tutar','tahakkuk','iliski','aciklama']];
      document.querySelectorAll('#tbl tbody tr').forEach(tr=>{
        rows.push([...tr.children].map(td=>td.textContent.trim()));
      });
      const csv=rows.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
      downloadCSV('genelmizan-export.csv', csv);
    };

    /* =====================  Ã–ZETLER (BugÃ¼n/Ay/YÄ±l)  ===================== */
    async function refreshSummary(){
      const today = new Date().toISOString().slice(0,10);
      const now = new Date();
      const y = now.getFullYear();
      const m = String(now.getMonth()+1).padStart(2,'0');
      const monthStart = `${y}-${m}-01`;
      const yearStart = `${y}-01-01`;

      // YardÄ±mcÄ±: cash toplam (gelir/gider), aÃ§Ä±k tahakkuk toplamÄ±
      async function sumsBetween(start, end){
        let gelir=0, gider=0;
        // cash (tahakkuk=false)
        let ref = db.collection('islemler').where('tahakkuk','==',false);
        if(start) ref=ref.where('gun','>=',start);
        if(end) ref=ref.where('gun','<=',end);
        const cash = await ref.get();
        cash.forEach(s=>{const x=s.data(); if(x.tip==='gelir') gelir+=x.tutar||0; else if(x.tip==='gider') gider+=x.tutar||0;});
        // aÃ§Ä±k tahakkuk (kalan Ã¼zerinden)
        const acc = await db.collection('islemler').where('tahakkuk','==',true).where('durum','==','acik').get();
        let tah=0; acc.forEach(d=>{
          const x=d.data();
          const kalan = (x.kalan_tutar != null) ? x.kalan_tutar : Math.max(0,(x.tutar||0) - (x.tahsilat_toplam||0));
          tah += kalan;
        });
        return {gelir,gider,tah};
      }

      const [tS, mS, yS] = await Promise.all([
        sumsBetween(today, today),
        sumsBetween(monthStart, today),
        sumsBetween(yearStart, today),
      ]);

      $('sumTodayGelir').textContent=fmt(tS.gelir);
      $('sumTodayGider').textContent=fmt(tS.gider);
      $('sumTodayTah').textContent=fmt(tS.tah);
      $('sumTodayCSV').textContent = window.lastCSVAt ? new Date(window.lastCSVAt).toLocaleString('tr-TR') : 'â€”';

      $('sumMonthGelir').textContent=fmt(mS.gelir);
      $('sumMonthGider').textContent=fmt(mS.gider);
      $('sumMonthTah').textContent=fmt(mS.tah);
      $('sumMonthCSV').textContent = window.lastCSVAt ? new Date(window.lastCSVAt).toLocaleString('tr-TR') : 'â€”';

      $('sumYearGelir').textContent=fmt(yS.gelir);
      $('sumYearGider').textContent=fmt(yS.gider);
      $('sumYearTah').textContent=fmt(yS.tah);
      $('sumYearCSV').textContent = window.lastCSVAt ? new Date(window.lastCSVAt).toLocaleString('tr-TR') : 'â€”';
    }

    /* =====================  INIT ===================== */
    async function initPage(){
      // Son 30 gÃ¼n default filtre
      const now=new Date(); const s=new Date(now); s.setDate(now.getDate()-30);
      $('fStart').value=toDateInput(s); $('fEnd').value=toDateInput(now);

      // VarsayÄ±lanlar
      await Promise.all([
        loadKategoriler(),
        loadPersoneller()
      ]);
      await updateKatDatalistForTip($('qTip').value);
      await refreshSummary();
      await loadSonIslemler();
    }
  </script>
</body>
</html>
