<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Karaaƒüa√ß Fatih | Kumbara Takibi</title>
<link rel="icon" type="image/png" href="../img/logo.png" />

<style>
  /* ========== Tema ========== */
  :root{
    --appbar-h:56px;
    --radius:14px; --shadow:0 12px 28px rgba(0,0,0,.12);
    --bg:#0f172a; --card:rgba(15,23,42,.98);
    --stroke:rgba(148,163,184,.16); --text:#e5e7eb; --muted:#9aa4b2;
    --brand:#38bdf8; --brand2:#0ea5e9;
    --surface:rgba(2,6,23,.10); --surface2:rgba(2,6,23,.06);
    --danger:#ef4444; --success:#22c55e;
    --gap-lg:20px; --gap:14px; --gap-sm:10px;
  }
  @media (prefers-color-scheme: light){
    :root{
      --bg:#f3f6fc; --card:#ffffff; --stroke:rgba(15,23,42,.12);
      --text:#0b1220; --muted:#4b5563; --surface:#f1f5ff; --surface2:#f6f8ff;
      --brand:#0ea5e9; --brand2:#0284c7;
    }
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:'Segoe UI',system-ui,-apple-system,Arial,sans-serif}
  img,svg,video{max-width:100%;height:auto;display:block}

  /* ========== Appbar ========== */
  .appbar{
    position:sticky; top:0; z-index:60; height:var(--appbar-h);
    background:var(--card); backdrop-filter:blur(10px);
    border-bottom:1px solid var(--stroke);
    display:flex; align-items:center; gap:10px; padding:0 12px;
  }
  .brand{display:flex; align-items:center; gap:10px; cursor:pointer}
  .brand img{width:24px; height:24px}
  .brand span{font-weight:900; letter-spacing:.02em}
  .nav-center{margin:0 auto; height:100%}
  .nav-list{display:flex; gap:22px; align-items:center; height:100%; list-style:none; margin:0; padding:0}
  .nav-item{position:relative; height:100%}
  .nav-btn{height:100%; display:flex; align-items:center; gap:6px; font-weight:800; cursor:pointer}
  .nav-btn:hover{color:var(--brand)}
  .caret{font-size:12px; opacity:.6}
  .dropdown{position:absolute; top:100%; left:0; min-width:240px; background:var(--card); border:1px solid var(--stroke); border-radius:12px; box-shadow:var(--shadow); padding:8px; display:none}
  .dropdown a{display:flex; align-items:center; gap:8px; padding:10px 12px; border-radius:10px; color:var(--text); text-decoration:none}
  .dropdown a:hover{background:var(--surface2)}
  .nav-item.open .dropdown{display:block}
  .nav-right{display:flex; gap:8px; align-items:center}
  .btn{border:1px solid var(--stroke); background:var(--card); color:var(--text); border-radius:999px; padding:8px 12px; cursor:pointer; white-space:nowrap}
  .hamb{display:none}
  .iconbtn{position:relative; border:1px solid var(--stroke); background:var(--card); color:var(--text); border-radius:999px; padding:8px 12px; cursor:pointer; display:flex; align-items:center; gap:8px}
  .badge{position:absolute; top:-6px; right:-6px; background:var(--danger); color:#fff; font-size:11px; padding:2px 6px; border-radius:999px; border:2px solid var(--card)}
  .drop-right{left:auto; right:0}
  .avatar{width:22px;height:22px;border-radius:999px;background:linear-gradient(180deg,#94a3b8,#64748b)}
  @media (max-width: 960px){ .nav-center{display:none} .hamb{display:inline-flex} }

  /* ========== Drawer ========== */
  .drawer{position:fixed; top:var(--appbar-h); right:0; bottom:0; left:34%; transform:translateX(100%); transition:.25s; background:var(--card); border-left:1px solid var(--stroke); z-index:70; overflow:auto; padding:16px}
  .drawer.open{transform:translateX(0)}
  .drawer .panel-title{margin:14px 4px 6px; font-weight:800; color:var(--muted); font-size:13px}
  .drawer a{display:block; padding:12px; border-radius:12px; border:1px solid var(--stroke); margin:8px 0; color:var(--text); background:var(--surface2)}
  .drawer a:hover{background:var(--surface)}

  /* ========== Layout ========== */
  .container{max-width:1120px; margin:0 auto; padding:18px; display:grid; gap:var(--gap-lg)}
  .card{background:var(--card); border:1px solid var(--stroke); border-radius:16px; box-shadow:var(--shadow); padding:16px}
  .stack-lg{display:grid; gap:var(--gap-lg)}
  .stack   {display:grid; gap:var(--gap)}
  .row{display:grid; grid-template-columns:repeat(12,minmax(0,1fr)); gap:var(--gap)}
  .col-6{grid-column:span 6} .col-4{grid-column:span 4} .col-3{grid-column:span 3} .col-12{grid-column:span 12}

  @media (max-width: 960px){
    .container{padding:14px}
    .row{grid-template-columns:repeat(6,minmax(0,1fr))}
    .col-6{grid-column:span 6} .col-4{grid-column:span 6} .col-3{grid-column:span 3} .col-12{grid-column:span 6}
  }
  @media (max-width: 640px){
    .row{grid-template-columns:repeat(4,minmax(0,1fr))}
    .col-6,.col-4,.col-3,.col-12{grid-column:span 4}
  }

  .muted{color:var(--muted)}

  /* ========== Form ========== */
  label{display:block; margin-bottom:6px; font-size:13px; color:var(--muted)}
  .field{display:flex; flex-direction:column; gap:6px}
  input,select,textarea{
    width:100%; height:44px; padding:10px 12px; border:1px solid var(--stroke);
    border-radius:12px; background:var(--surface2); color:var(--text); outline:none;
  }
  textarea{height:auto; min-height:88px; resize:vertical}
  input:focus,select:focus,textarea:focus{ box-shadow:0 0 0 3px rgba(14,165,233,.25); border-color:#0ea5e9; background:var(--surface) }
  .hint{font-size:12px; color:var(--muted)}

  /* ========== Minimal Tabs ========== */
  .mini-tabs{
    display:flex; gap:16px; align-items:center;
    border-bottom:1px solid rgba(148,163,184,.16);
    overflow-x:auto; scrollbar-width:none;
  }
  .mini-tabs::-webkit-scrollbar{display:none}
  .mini-tab{
    background:none; border:none; padding:10px 0; font-weight:700; color:var(--muted); cursor:pointer;
    position:relative; white-space:nowrap; font-size:14px;
  }
  .mini-tab.active{color:var(--text)}
  .mini-tab.active::after{
    content:''; position:absolute; left:0; right:0; bottom:-1px; height:2px;
    background:linear-gradient(90deg,var(--brand),var(--brand2));
    border-radius:99px;
  }

  /* ========== Buttons ========== */
  .actions{display:flex; gap:10px; flex-wrap:wrap}
  .cta{border:none; border-radius:999px; padding:10px 18px; font-weight:800; cursor:pointer; background:linear-gradient(180deg,var(--brand),var(--brand2)); color:#fff}
  .ghost{border:1px solid var(--stroke); background:var(--surface2); border-radius:999px; padding:10px 14px; cursor:pointer}
  .btn-ghost{
    background:transparent; border:1px solid rgba(148,163,184,.16); border-radius:999px;
    padding:4px 10px; font-size:12px; cursor:pointer; color:var(--text);
  }

  /* ========== Tables ========== */
  .table-wrap{border:1px solid var(--stroke); border-radius:14px; overflow:auto; background:var(--card)}
  table{width:100%; border-collapse:collapse; min-width:600px}
  th,td{padding:12px 14px; text-align:left; border-bottom:1px solid var(--stroke); font-size:14px}
  thead th{position:sticky; top:0; background:var(--surface); font-weight:800}

  /* ========== Modal & Toast ========== */
  .modal{display:none; position:fixed; inset:0; background:rgba(2,6,23,.6); z-index:99; align-items:center; justify-content:center; padding:18px}
  .modal.show{display:flex}
  .modal-icerik{background:var(--card); border:1px solid var(--stroke); width:96%; max-width:640px; border-radius:16px; box-shadow:var(--shadow); padding:18px; position:relative; display:grid; gap:var(--gap)}
  .modal-kapat{position:absolute; right:12px; top:10px; font-size:22px; cursor:pointer; color:var(--danger)}
  .toast{position:fixed; left:50%; bottom:24px; transform:translateX(-50%) translateY(20px); background:rgba(2,6,23,.95); color:#fff; border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:10px 12px; opacity:0; pointer-events:none; transition:opacity .25s, transform .25s; z-index:200}
  .toast.show{opacity:1; transform:translateX(-50%) translateY(0)}

  /* ========== √ñnizleme ve Liste ========== */
  .onizleme-box{
    border:1px solid var(--stroke); border-radius:12px; padding:12px; background:var(--surface2);
    margin-top:10px; max-height:200px; overflow-y:auto;
  }
  .numara-list{
    display:flex; flex-wrap:wrap; gap:6px;
  }
  .numara-badge{
    padding:4px 10px; border-radius:6px; font-size:12px; font-weight:600;
    background:var(--surface); border:1px solid var(--stroke);
  }
  .numara-badge.kayitli{background:rgba(34,197,94,.15); border-color:rgba(34,197,94,.3); color:var(--success)}
  .numara-badge.mevcut{background:rgba(14,165,233,.15); border-color:rgba(14,165,233,.3); color:var(--brand)}
  .numara-badge.cakisma{background:rgba(239,68,68,.15); border-color:rgba(239,68,68,.3); color:var(--danger)}

  /* ========== Giri≈ü Tipi Se√ßimi ========== */
  .giris-tip{
    display:flex; gap:10px; margin-bottom:16px;
  }
  .giris-tip-btn{
    flex:1; padding:10px; border:2px solid var(--stroke); border-radius:12px;
    background:var(--surface2); cursor:pointer; text-align:center; font-weight:700;
    transition:all .15s;
  }
  .giris-tip-btn.active{
    border-color:var(--brand); background:rgba(14,165,233,.15); color:var(--brand);
  }

  /* ========== √áoklu Giri≈ü Listesi ========== */
  .coklu-item{
    border:1px solid var(--stroke); border-radius:12px; padding:14px;
    background:var(--surface2); margin-bottom:12px;
  }
  .coklu-item-header{
    display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;
  }
  .coklu-item-remove{
    background:transparent; border:none; color:var(--danger);
    cursor:pointer; font-size:18px; padding:4px 8px;
  }
</style>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="../js/firebase/firebase-init.js"></script>
</head>
<body>

<!-- APPBAR -->
<div class="appbar">
  <div class="brand" onclick="location.href='../panel.html'">
    <img src="../img/logo.png" alt="logo"><span>KARAAƒûA√á FATƒ∞H</span>
  </div>
  <nav class="nav-center"><ul class="nav-list" id="navMain"></ul></nav>
  <div class="nav-right">
    <button class="btn hamb" id="hamburger" title="Men√º">‚ò∞</button>
    <div class="nav-item">
      <button class="iconbtn" id="btnNotif" title="Bildirimler">üîî
        <span class="badge" id="notifBadge" style="display:none">0</span>
      </button>
      <div class="dropdown drop-right" id="notifDropdown">
        <div class="muted" style="padding:6px 8px">Son bildirimler</div>
        <div id="notifList" style="max-height:300px;overflow:auto"></div>
        <a href="/diger/bildirim.html">T√ºm bildirimleri g√∂r ‚Üí</a>
      </div>
    </div>
    <div class="nav-item">
      <button class="iconbtn" id="btnProfile" title="Profil">
        <span class="avatar"></span> <span id="profName" class="muted">Profil</span>
      </button>
      <div class="dropdown drop-right" id="profDropdown">
        <a href="/diger/kullanici-yonetimi.html" >üë§ Profil</a>
        <a href="/diger/sistem-ayarlari.html" >‚öôÔ∏è Ayarlar</a>
        <a href="#" id="btnLogout">üö™ √áƒ±kƒ±≈ü Yap</a>
      </div>
    </div>
  </div>
</div>
<aside class="drawer" id="drawer"></aside>

<!-- CONTENT -->
<main class="container stack-lg">
  <!-- Ba≈ülƒ±k -->
  <section class="card stack">
    <h2 style="margin:0">Kumbara Takibi Y√∂netimi</h2>
    <div class="muted">Kumbara kayƒ±tlarƒ± ve personele zimmetleme i≈ülemleri</div>
  </section>

  <!-- √úst Tabs -->
  <section class="card stack">
    <div class="mini-tabs" id="mainTabs">
      <button class="mini-tab active" data-target="kayitWrap">Kumbara Kayƒ±t</button>
      <button class="mini-tab" data-target="zimmetWrap">Kumbara Zimmetleme</button>
      <button class="mini-tab" data-target="toplamaWrap">Toplama Takibi</button>
      <button class="mini-tab" data-target="duzenleWrap">D√ºzenle &amp; Ayarlar</button>
    </div>
  </section>

  <!-- Kumbara Kayƒ±t -->
  <section class="card stack" id="kayitWrap">
    <h3 style="margin:0">Kumbara Kayƒ±t</h3>
    
    <!-- Tek Giri≈ü Formu -->
    <div id="kayitTekForm" class="stack">
      <div class="row">
        <div class="col-6 field">
          <label>Kumbara T√ºr√º</label>
          <select id="kayitTur">
            <option value="kumbara">Kumbara</option>
            <option value="sadaka">Sadaka</option>
          </select>
        </div>
        <div class="col-6 field">
          <label>Toplam Adet</label>
          <input type="number" id="kayitAdet" min="1" placeholder="10" />
        </div>
      </div>

      <div class="row">
        <div class="col-6 field">
          <label>Numara Ba≈ülangƒ±√ß</label>
          <input type="number" id="kayitBaslangic" min="1" placeholder="1" />
        </div>
        <div class="col-6 field">
          <label>Numara Biti≈ü (opsiyonel, bo≈ü bƒ±rakƒ±lƒ±rsa otomatik)</label>
          <input type="number" id="kayitBitis" min="1" placeholder="10" />
        </div>
      </div>

      <div class="field">
        <label>√ñnizleme - Se√ßili T√ºrden Kayƒ±tlƒ± Numaralar</label>
        <div class="onizleme-box" id="kayitOnizleme">
          <div class="muted">T√ºr se√ßildikten sonra y√ºklenecek...</div>
        </div>
      </div>

      <div class="hint" id="kayitPreview">√ñnizleme ‚Äî</div>
      <div class="actions">
        <button class="cta" id="btnKayitKaydet">Kaydet</button>
        <button class="ghost" id="btnKayitOnizlemeYenile">√ñnizlemeyi Yenile</button>
      </div>
    </div>
  </section>

  <!-- Kumbara Zimmetleme -->
  <section class="card stack" id="zimmetWrap" style="display:none">
    <h3 style="margin:0">Kumbara Zimmetleme</h3>
    
    <!-- Giri≈ü Tipi Se√ßimi -->
    <div class="giris-tip" id="zimmetGirisTip">
      <button class="giris-tip-btn active" data-tip="tek">Tek Giri≈ü</button>
      <button class="giris-tip-btn" data-tip="coklu">√áoklu Giri≈ü</button>
    </div>

    <!-- Tek Giri≈ü Formu -->
    <div id="zimmetTekForm" class="stack">
      <div class="row">
        <div class="col-6 field">
          <label>Kumbara T√ºr√º</label>
          <select id="zimmetTur">
            <option value="kumbara">Kumbara</option>
            <option value="sadaka">Sadaka</option>
          </select>
        </div>
        <div class="col-6 field">
          <label>Personel</label>
          <select id="zimmetPersonel"></select>
        </div>
      </div>

      <div class="field">
        <label>Zimmetlenmemi≈ü Numaralar</label>
        <select id="zimmetNumara" size="8" style="height:auto; min-height:200px;">
          <option value="">T√ºr se√ßildikten sonra y√ºklenecek...</option>
        </select>
      </div>

      <div class="hint" id="zimmetPreview">√ñnizleme ‚Äî</div>
      <div class="actions">
        <button class="cta" id="btnZimmetKaydet">Kaydet</button>
        <button class="ghost" id="btnZimmetListeYenile">Listeyi Yenile</button>
      </div>
    </div>

    <!-- √áoklu Giri≈ü -->
    <div id="zimmetCokluForm" class="stack" style="display:none">
      <div class="actions">
        <button class="ghost" id="btnCokluZimmetEkle">+ Yeni Zimmet Ekle</button>
      </div>
      <div id="cokluZimmetListesi"></div>
      <div class="actions">
        <button class="cta" id="btnCokluZimmetKaydet">T√ºm√ºn√º Kaydet</button>
      </div>
    </div>
  </section>

  <!-- Toplama Takibi -->
  <section class="card stack" id="toplamaWrap" style="display:none">
    <h3 style="margin:0">Kumbara Toplama Takibi</h3>
    
    <!-- Filtreler -->
    <div class="row" style="margin-bottom:16px">
      <div class="col-4 field">
        <label>Kumbara T√ºr√º</label>
        <select id="toplamaTur">
          <option value="">T√ºm√º</option>
          <option value="kumbara">Kumbara</option>
          <option value="sadaka">Sadaka</option>
        </select>
      </div>
      <div class="col-4 field">
        <label>Durum</label>
        <select id="toplamaDurum">
          <option value="">T√ºm√º</option>
          <option value="dagitildi">Daƒüƒ±tƒ±ldƒ± (Toplanmayƒ± Bekliyor)</option>
          <option value="toplandi">Teslim Alƒ±ndƒ± (Toplandƒ±)</option>
          <option value="sayim">Sayƒ±m A≈üamasƒ±nda</option>
          <option value="tamamlandi">Tamamlandƒ±</option>
        </select>
      </div>
      <div class="col-4 field" style="align-self:flex-end">
        <button class="cta" id="btnToplamaYukle">Y√ºkle</button>
      </div>
    </div>
    
    <!-- Toplama Listesi -->
    <div id="toplamaListe" class="table-wrap">
      <div class="muted" style="padding:12px">Filtre se√ßip y√ºkleyiniz...</div>
    </div>
  </section>

  <!-- D√ºzenle & Ayarlar -->
  <section class="card stack" id="duzenleWrap" style="display:none">
    <h3 style="margin:0">D√ºzenle &amp; Ayarlar</h3>
    
    <!-- Alt Tabs -->
    <div class="mini-tabs" style="margin-bottom:16px">
      <button class="mini-tab active" data-target="duzenle-kayit">Kumbara Kayƒ±tlarƒ±</button>
      <button class="mini-tab" data-target="duzenle-zimmet">Zimmetleme Kayƒ±tlarƒ±</button>
    </div>

    <!-- Kumbara Kayƒ±tlarƒ± -->
    <div id="duzenle-kayit" class="stack">
      <div class="row">
        <div class="col-6 field">
          <label>Kumbara T√ºr√º</label>
          <select id="duzenleKayitTur">
            <option value="">T√ºm√º</option>
            <option value="kumbara">Kumbara</option>
            <option value="sadaka">Sadaka</option>
          </select>
        </div>
        <div class="col-6 field" style="align-self:flex-end">
          <button class="cta" id="btnDuzenleKayitYukle">Y√ºkle</button>
        </div>
      </div>
      
      <div id="duzenleKayitListe" class="table-wrap" style="margin-top:16px">
        <div class="muted" style="padding:12px">T√ºr se√ßip y√ºkleyiniz...</div>
      </div>
    </div>

    <!-- Zimmetleme Kayƒ±tlarƒ± -->
    <div id="duzenle-zimmet" class="stack" style="display:none">
      <div class="row">
        <div class="col-6 field">
          <label>Kumbara T√ºr√º</label>
          <select id="duzenleZimmetTur">
            <option value="">T√ºm√º</option>
            <option value="kumbara">Kumbara</option>
            <option value="sadaka">Sadaka</option>
          </select>
        </div>
        <div class="col-6 field">
          <label>Personel (opsiyonel)</label>
          <select id="duzenleZimmetPersonel">
            <option value="">T√ºm√º</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div class="col-12 field" style="align-self:flex-end">
          <button class="cta" id="btnDuzenleZimmetYukle">Y√ºkle</button>
        </div>
      </div>
      
      <div id="duzenleZimmetListe" class="table-wrap" style="margin-top:16px">
        <div class="muted" style="padding:12px">Filtre se√ßip y√ºkleyiniz...</div>
      </div>
    </div>
  </section>

  <div style="height:40px"></div>
</main>

<!-- Toplama D√ºzenleme Modal -->
<div class="modal" id="toplamaDuzenleModal">
  <div class="modal-icerik" style="max-width:600px">
    <button class="modal-kapat" onclick="toplamaDuzenleKapat()">‚úñ</button>
    <h3 class="modal-title">Toplama ƒ∞≈ülemi D√ºzenle</h3>
    <input type="hidden" id="duzenleToplamaId" />
    
    <div class="field">
      <label>Kumbara/Sadaka Bilgisi</label>
      <div id="duzenleToplamaBilgi" class="muted" style="padding:8px; background:var(--surface2); border-radius:8px"></div>
    </div>
    
    <div class="field">
      <label>Mevcut Durum</label>
      <div id="duzenleToplamaDurum" style="padding:8px; background:var(--surface2); border-radius:8px"></div>
    </div>
    
    <div class="field">
      <label>ƒ∞√ßinden √áƒ±kan Miktar (‚Ç∫)</label>
      <input type="number" id="duzenleToplamaMiktar" step="0.01" min="0" placeholder="0.00" />
      <div class="hint">Mevcut miktar: <span id="duzenleToplamaMevcutMiktar">-</span></div>
    </div>
    
    <div class="field">
      <label>Durum ƒ∞≈ülemleri</label>
      <div class="stack" style="gap:8px">
        <button class="ghost" id="btnGeriAlToplandi" style="text-align:left; justify-content:flex-start">‚Ü©Ô∏è Toplandƒ± Durumunu Geri Al (Daƒüƒ±tƒ±ldƒ±'ya d√∂nd√ºr)</button>
        <button class="ghost" id="btnGeriAlSayim" style="text-align:left; justify-content:flex-start">‚Ü©Ô∏è Sayƒ±m Durumunu Geri Al (Toplandƒ±'ya d√∂nd√ºr)</button>
        <button class="ghost" id="btnGeriAlTamamlandi" style="text-align:left; justify-content:flex-start">‚Ü©Ô∏è Tamamlandƒ± Durumunu Geri Al (Sayƒ±m'a d√∂nd√ºr)</button>
      </div>
    </div>
    
    <div class="actions" style="display:flex; gap:10px; justify-content:flex-end; margin-top:10px">
      <button class="btn" onclick="toplamaDuzenleKapat()">ƒ∞ptal</button>
      <button class="cta" id="btnToplamaDuzenleKaydet">Kaydet</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* ===== Helpers ===== */
const db=firebase.firestore(), auth=firebase.auth();
const userAgent = navigator.userAgent || '';
const cihazTipi = ()=> (window.innerWidth<700?'mobile':(window.innerWidth<960?'tablet':'desktop'));
const tsISO = ()=> new Date().toISOString();
const norm=(s)=> String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
function toast(msg){const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); clearTimeout(window.__to); window.__to=setTimeout(()=>t.classList.remove('show'),2400);}

/* ===== Personel Listesi ===== */
const personeller = [
  "Muhsin √áelik","Faruk Nafiz √ñzgan","ƒ∞brahim Ay","Samet √áakƒ±r",
  "Kerem Kocaoƒülu","Serhan Durak","Mahmut Solmaz","Mehmet Taha Keskin","Ahmetali Emre ≈ûahin"
];
function fillPersonelSelect(id){ 
  const el=document.getElementById(id); 
  if(!el) return; 
  el.innerHTML = personeller.map(p=>`<option value="${p}">${p}</option>`).join(''); 
}
fillPersonelSelect('zimmetPersonel');

/* ===== NAV (manifest) ===== */
let CURRENT_ALLOW=new Set(), CURRENT_DENY=new Set();
async function fetchPanels(allowSet, denySet){
  const res=[]; try{
    const snap=await db.collection('sayfa_manifesti').get();
    snap.forEach(doc=>{
      const d=doc.data()||{}, id=doc.id, panelTitle=d.title||id;
      const panelGrant = allowSet.has(norm(id)) || allowSet.has(norm(panelTitle));
      let pages = Array.isArray(d.pages)? d.pages : [];
      pages = pages.filter(pg=>{
        const keyNorm=norm(pg.key||pg.title||'');
        const pageGrant=allowSet.has(keyNorm), denied=denySet.has(keyNorm);
        return !denied && (panelGrant || pageGrant);
      }).map(pg=>({ baslik: pg.title||pg.key||'Sayfa', url: pg.path||'#', key: pg.key||pg.title||'', sira: typeof pg.order==='number'? pg.order:9999 }))
        .sort((a,b)=>a.sira-b.sira);
      if(pages.length) res.push({ id, baslik:panelTitle, sira: typeof d.order==='number'? d.order:9999, pages });
    });
    res.sort((a,b)=>a.sira-b.sira);
  }catch(e){ console.error(e); toast('Men√º y√ºklenemedi'); }
  return res;
}
function renderNav(panels){
  const ul=document.getElementById('navMain'), drawer=document.getElementById('drawer');
  ul.innerHTML=''; drawer.innerHTML='';
  if(!panels.length){
    ul.innerHTML='<li class="nav-item"><div class="nav-btn">Panel yok</div></li>';
    drawer.innerHTML='<div class="muted" style="padding:8px">Men√º bulunamadƒ±</div>'; return;
  }
  panels.forEach(p=>{
    const li=document.createElement('li'); li.className='nav-item';
    li.innerHTML=`<div class="nav-btn">${p.baslik} <span class="caret">‚ñæ</span></div>`;
    const dd=document.createElement('div'); dd.className='dropdown';
    (p.pages||[]).forEach(pg=>{
      const a=document.createElement('a');
      a.href=normalizeUrl(pg.url || pg.path || '#'); a.textContent=pg.baslik;
      a.dataset.key=pg.key||pg.baslik; a.dataset.panel=p.id; a.dataset.panelTitle=p.baslik;
      dd.appendChild(a);
    });
    li.appendChild(dd);
    li.querySelector('.nav-btn').addEventListener('click',(e)=>{
      e.stopPropagation();
      ul.querySelectorAll('.nav-item').forEach(x=>{ if(x!==li) x.classList.remove('open'); });
      li.classList.toggle('open');
    });
    ul.appendChild(li);

    const h=document.createElement('div'); h.className='panel-title'; h.textContent=p.baslik; drawer.appendChild(h);
    (p.pages||[]).forEach(pg=>{
      const a=document.createElement('a');
      a.href=normalizeUrl(pg.url || pg.path || '#'); a.textContent=pg.baslik;
      a.dataset.key=pg.key||pg.baslik; a.dataset.panel=p.id; a.dataset.panelTitle=p.baslik;
      drawer.appendChild(a);
    });
  });
  document.addEventListener('click',(e)=>{ if(!ul.contains(e.target)) ul.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('open')); });
}
function normalizeUrl(u){ if(!u) return '#'; if(/^https?:\/\//i.test(u)) return u; if(u.startsWith('/')) return u; return '/'+u.replace(/^\.?\//,''); }
(function(){ const hamb=document.getElementById('hamburger'), drawer=document.getElementById('drawer'); if(!hamb) return; hamb.addEventListener('click',()=>drawer.classList.toggle('open')); document.addEventListener('click',(e)=>{ if(!drawer.contains(e.target) && !hamb.contains(e.target)) drawer.classList.remove('open'); }); })();
document.addEventListener('click',(e)=>{
  const a=e.target.closest('a[data-key]'); if(!a) return;
  const key=norm(a.dataset.key), pnl=norm(a.dataset.panel||''), pnlTitle=norm(a.dataset.panelTitle||'');
  if(CURRENT_DENY.has(key)){ e.preventDefault(); toast('Bu sayfa i√ßin yetkiniz yok.'); return; }
  const allowed = CURRENT_ALLOW.has(key) || CURRENT_ALLOW.has(pnl) || CURRENT_ALLOW.has(pnlTitle);
  if(!allowed){ e.preventDefault(); toast('Bu sayfa i√ßin yetkiniz yok.'); }
});
(function(){
  const notifBtn=document.getElementById('btnNotif'), notifDD=document.getElementById('notifDropdown');
  const profBtn=document.getElementById('btnProfile'), profDD=document.getElementById('profDropdown');
  function closeAll(e){
    if(!notifDD.contains(e.target) && e.target!==notifBtn) notifDD.parentElement.classList.remove('open');
    if(!profDD.contains(e.target)  && e.target!==profBtn)  profDD.parentElement.classList.remove('open');
  }
  document.addEventListener('click', closeAll);
  notifBtn?.addEventListener('click',(e)=>{ e.stopPropagation(); notifDD.parentElement.classList.toggle('open'); profDD.parentElement.classList.remove('open'); });
  profBtn ?.addEventListener('click',(e)=>{ e.stopPropagation(); profDD.parentElement.classList.toggle('open'); notifDD.parentElement.classList.remove('open'); });
  document.getElementById('btnLogout')?.addEventListener('click', async (e) => {
    e.preventDefault();
    try { await auth.signOut(); location.assign('/index.html'); }
    catch(err){ console.error(err); toast('√áƒ±kƒ±≈ü yapƒ±lamadƒ±'); }
  });
})();

/* ===== Auth & profil adƒ± ===== */
let currentUser=null;
try{ firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL); }catch(e){}
auth.onAuthStateChanged(async (user)=>{
  currentUser=user||null;
  if(!user){
    setTimeout(()=>{ if(!auth.currentUser) location.replace('index.html'); },150);
    return;
  }
  try{
    const profEl = document.getElementById('profName');
    const uSnap = await db.collection('kullanicilar').doc(user.uid).get();
    const data  = uSnap.exists ? (uSnap.data()||{}) : {};
    let gosterilecek = (data.adSoyad || '').trim();
    if(!gosterilecek && user.displayName) gosterilecek = user.displayName.trim();
    if(!gosterilecek && user.email){
      const namePart = user.email.split('@')[0];
      gosterilecek = namePart.charAt(0).toUpperCase() + namePart.slice(1);
    }
    profEl.textContent = (gosterilecek.split(' ')[0] || 'Profil');

    const rawPerms=Array.isArray(data.yetkiler)? data.yetkiler : [];
    CURRENT_ALLOW=new Set(rawPerms.filter(s=>!String(s).trim().startsWith('-') && !String(s).trim().startsWith('!')).map(norm));
    CURRENT_DENY =new Set(rawPerms.filter(s=> String(s).trim().startsWith('-') || String(s).trim().startsWith('!')).map(s=>norm(String(s).replace(/^[-!]\s*/,''))));
    const panels=await fetchPanels(CURRENT_ALLOW, CURRENT_DENY);
    renderNav(panels);
  }catch(e){ console.error(e); }
});

/* ===== Bildirimler (ops.) ===== */
(async function(){
  try{
    const snap=await db.collection('duyurular').orderBy('createdAt','desc').limit(5).get();
    const badge=document.getElementById('notifBadge'), list=document.getElementById('notifList');
    const n=snap.size; if(n>0){ badge.style.display='block'; badge.textContent=n>99?'99+':String(n); }
    if(n===0){ list.innerHTML='<div class="muted" style="padding:6px 8px">Yeni bildirim yok.</div>'; }
    else snap.forEach(doc=>{ const d=doc.data()||{}; const row=document.createElement('a'); row.href='/diger/bildirim.html'; row.innerHTML=`<strong>${d.baslik||'Duyuru'}</strong><div class="muted">${d.detay||''}</div>`; list.appendChild(row); });
  }catch(e){}
})();

/* ===== √úst Tabs ===== */
(function(){
  const tabs=document.querySelectorAll('#mainTabs .mini-tab');
  tabs.forEach(t=>t.addEventListener('click',()=>{
    tabs.forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    const target=t.dataset.target;
    document.getElementById('kayitWrap').style.display = (target==='kayitWrap')?'':'none';
    document.getElementById('zimmetWrap').style.display = (target==='zimmetWrap')?'':'none';
    document.getElementById('toplamaWrap').style.display = (target==='toplamaWrap')?'':'none';
    document.getElementById('duzenleWrap').style.display = (target==='duzenleWrap')?'':'none';
  }));
})();

/* ===== D√ºzenle Alt Tabs ===== */
(function(){
  const tabs=document.querySelectorAll('#duzenleWrap .mini-tabs .mini-tab');
  tabs.forEach(t=>t.addEventListener('click',()=>{
    tabs.forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    const target=t.dataset.target;
    document.getElementById('duzenle-kayit').style.display = (target==='duzenle-kayit')?'':'none';
    document.getElementById('duzenle-zimmet').style.display = (target==='duzenle-zimmet')?'':'none';
  }));
})();

/* ===== Giri≈ü Tipi Se√ßimi ===== */
function initGirisTip(containerId, tekFormId, cokluFormId){
  const container = document.getElementById(containerId);
  const tekForm = document.getElementById(tekFormId);
  const cokluForm = document.getElementById(cokluFormId);
  if(!container) return;
  
  container.addEventListener('click', (e)=>{
    const btn = e.target.closest('.giris-tip-btn');
    if(!btn) return;
    container.querySelectorAll('.giris-tip-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const tip = btn.dataset.tip;
    if(tip === 'tek'){
      tekForm.style.display = 'grid';
      cokluForm.style.display = 'none';
    } else {
      tekForm.style.display = 'none';
      cokluForm.style.display = 'grid';
    }
  });
}
initGirisTip('zimmetGirisTip', 'zimmetTekForm', 'zimmetCokluForm');

/* ===== Kumbara Kayƒ±t - Numara Kontrol√º ve √ñnizleme ===== */
let KAYITLI_NUMARALAR = { kumbara: new Set(), sadaka: new Set() };

async function yukleKayitliNumaralar(tur){
  try{
    const snap = await db.collection('kumbaralar')
      .where('tur', '==', tur)
      .get();
    KAYITLI_NUMARALAR[tur] = new Set();
    snap.forEach(doc=>{
      const numara = doc.data().numara;
      if(typeof numara === 'number') KAYITLI_NUMARALAR[tur].add(numara);
    });
  }catch(e){
    console.error('Numaralar y√ºklenemedi:', e);
    KAYITLI_NUMARALAR[tur] = new Set();
  }
}

async function guncelleKayitOnizleme(){
  const tur = document.getElementById('kayitTur').value;
  const onizlemeBox = document.getElementById('kayitOnizleme');
  
  if(!tur){
    onizlemeBox.innerHTML = '<div class="muted">T√ºr se√ßiniz...</div>';
    return;
  }

  await yukleKayitliNumaralar(tur);
  const kayitli = Array.from(KAYITLI_NUMARALAR[tur]).sort((a,b)=>a-b);
  
  if(kayitli.length === 0){
    onizlemeBox.innerHTML = '<div class="muted">Bu t√ºrden hen√ºz kayƒ±t yok.</div>';
  } else {
    const html = kayitli.map(n=>`<span class="numara-badge kayitli">${n}</span>`).join('');
    onizlemeBox.innerHTML = `<div class="numara-list">${html}</div>`;
  }
}

function hesaplaNumaraAraligi(){
  const tur = document.getElementById('kayitTur').value;
  const adet = parseInt(document.getElementById('kayitAdet').value) || 0;
  const baslangic = parseInt(document.getElementById('kayitBaslangic').value) || 0;
  const bitis = parseInt(document.getElementById('kayitBitis').value) || 0;
  
  if(!tur || !adet || !baslangic) return null;
  
  const gercekBitis = bitis || (baslangic + adet - 1);
  const numaralar = [];
  const cakisanlar = [];
  
  for(let i = baslangic; i <= gercekBitis; i++){
    numaralar.push(i);
    if(KAYITLI_NUMARALAR[tur].has(i)){
      cakisanlar.push(i);
    }
  }
  
  return { numaralar, cakisanlar, baslangic, gercekBitis };
}

function guncelleKayitPreview(){
  const tur = document.getElementById('kayitTur').value;
  const adet = parseInt(document.getElementById('kayitAdet').value) || 0;
  const baslangic = parseInt(document.getElementById('kayitBaslangic').value) || 0;
  const bitis = parseInt(document.getElementById('kayitBitis').value) || 0;
  
  const preview = document.getElementById('kayitPreview');
  
  if(!tur || !adet || !baslangic){
    preview.textContent = '√ñnizleme ‚Äî T√ºm alanlarƒ± doldurunuz.';
    return;
  }
  
  const hesaplama = hesaplaNumaraAraligi();
  if(!hesaplama){
    preview.textContent = '√ñnizleme ‚Äî Hesaplama yapƒ±lamadƒ±.';
    return;
  }
  
  const { numaralar, cakisanlar, baslangic: bas, gercekBitis: bit } = hesaplama;
  
  if(cakisanlar.length > 0){
    preview.innerHTML = `‚ö†Ô∏è <strong>UYARI:</strong> ${cakisanlar.length} numara zaten kayƒ±tlƒ±: ${cakisanlar.join(', ')}. Bu numaralar atlanacak veya deƒüi≈ütirilecek.`;
    preview.style.color = 'var(--danger)';
  } else {
    preview.textContent = `√ñnizleme ‚Äî ${bas}-${bit} arasƒ± ${numaralar.length} adet ${tur} kaydedilecek.`;
    preview.style.color = 'var(--muted)';
  }
}

document.getElementById('kayitTur').addEventListener('change', async ()=>{
  await guncelleKayitOnizleme();
  guncelleKayitPreview();
});
['kayitAdet','kayitBaslangic','kayitBitis'].forEach(id=>{
  document.getElementById(id).addEventListener('input', guncelleKayitPreview);
});
document.getElementById('btnKayitOnizlemeYenile').addEventListener('click', async ()=>{
  await guncelleKayitOnizleme();
  guncelleKayitPreview();
});

/* ===== Kumbara Kayƒ±t - Kaydet ===== */
document.getElementById('btnKayitKaydet').addEventListener('click', async ()=>{
  const tur = document.getElementById('kayitTur').value;
  const adet = parseInt(document.getElementById('kayitAdet').value) || 0;
  const baslangic = parseInt(document.getElementById('kayitBaslangic').value) || 0;
  const bitis = parseInt(document.getElementById('kayitBitis').value) || 0;
  
  if(!tur || !adet || !baslangic){
    toast('T√ºr, adet ve ba≈ülangƒ±√ß numarasƒ± zorunludur.');
    return;
  }
  
  const hesaplama = hesaplaNumaraAraligi();
  if(!hesaplama){
    toast('Numara aralƒ±ƒüƒ± hesaplanamadƒ±.');
    return;
  }
  
  const { numaralar, cakisanlar } = hesaplama;
  const kaydedilecekler = numaralar.filter(n=>!cakisanlar.includes(n));
  
  if(kaydedilecekler.length === 0){
    toast('T√ºm numaralar zaten kayƒ±tlƒ±. Farklƒ± bir aralƒ±k se√ßiniz.');
    return;
  }
  
  if(cakisanlar.length > 0){
    if(!confirm(`${cakisanlar.length} numara zaten kayƒ±tlƒ± (${cakisanlar.join(', ')}). Diƒüer ${kaydedilecekler.length} numarayƒ± kaydetmek istiyor musunuz?`)){
      return;
    }
  }
  
  try{
    const batch = db.batch();
    kaydedilecekler.forEach(numara=>{
      const ref = db.collection('kumbaralar').doc();
      batch.set(ref, {
        tur: tur,
        numara: numara,
        zimmetli: false,
        zimmetliPersonel: null,
        zimmetTarihi: null,
        kayitTarihi: tsISO(),
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        createdBy: currentUser?.email || null,
        uid: currentUser?.uid || null,
        userAgent: userAgent,
        cihaz: cihazTipi()
      });
    });
    
    await batch.commit();
    toast(`‚úÖ ${kaydedilecekler.length} adet ${tur} kaydedildi.`);
    
    // Formu temizle
    document.getElementById('kayitAdet').value = '';
    document.getElementById('kayitBaslangic').value = '';
    document.getElementById('kayitBitis').value = '';
    
    await guncelleKayitOnizleme();
    guncelleKayitPreview();
  }catch(e){
    console.error(e);
    toast('Kayƒ±t sƒ±rasƒ±nda hata olu≈ütu.');
  }
});

/* ===== Kumbara Zimmetleme - Liste Y√ºkleme ===== */
async function yukleZimmetlenmemisNumaralar(){
  const tur = document.getElementById('zimmetTur').value;
  const select = document.getElementById('zimmetNumara');
  
  if(!tur){
    select.innerHTML = '<option value="">T√ºr se√ßiniz...</option>';
    return;
  }
  
  try{
    // orderBy olmadan √ßek, sonra client-side sƒ±rala
    const snap = await db.collection('kumbaralar')
      .where('tur', '==', tur)
      .where('zimmetli', '==', false)
      .get();
    
    if(snap.empty){
      select.innerHTML = '<option value="">Zimmetlenmemi≈ü numara bulunamadƒ±.</option>';
      return;
    }
    
    // Numaralarƒ± topla ve sƒ±rala
    const numaralar = [];
    snap.forEach(doc=>{
      const numara = doc.data().numara;
      if(typeof numara === 'number'){
        numaralar.push(numara);
      }
    });
    
    // Sƒ±rala
    numaralar.sort((a,b)=>a-b);
    
    select.innerHTML = '';
    numaralar.forEach(numara=>{
      const option = document.createElement('option');
      option.value = numara;
      option.textContent = `Numara: ${numara}`;
      select.appendChild(option);
    });
  }catch(e){
    console.error('Numaralar y√ºklenemedi:', e);
    select.innerHTML = '<option value="">Hata: Numaralar y√ºklenemedi. ' + e.message + '</option>';
  }
}

document.getElementById('zimmetTur').addEventListener('change', yukleZimmetlenmemisNumaralar);
document.getElementById('btnZimmetListeYenile').addEventListener('click', yukleZimmetlenmemisNumaralar);

function guncelleZimmetPreview(){
  const tur = document.getElementById('zimmetTur').value;
  const numara = document.getElementById('zimmetNumara').value;
  const personel = document.getElementById('zimmetPersonel').value;
  const preview = document.getElementById('zimmetPreview');
  
  if(!tur || !numara || !personel){
    preview.textContent = '√ñnizleme ‚Äî T√ºm alanlarƒ± doldurunuz.';
    return;
  }
  
  preview.textContent = `√ñnizleme ‚Äî ${tur} numara ${numara} ‚Üí ${personel} zimmetlenecek.`;
}

['zimmetTur','zimmetNumara','zimmetPersonel'].forEach(id=>{
  document.getElementById(id).addEventListener('change', guncelleZimmetPreview);
});

/* ===== Kumbara Zimmetleme - Kaydet ===== */
document.getElementById('btnZimmetKaydet').addEventListener('click', async ()=>{
  const tur = document.getElementById('zimmetTur').value;
  const numara = parseInt(document.getElementById('zimmetNumara').value);
  const personel = document.getElementById('zimmetPersonel').value;
  
  if(!tur || !numara || !personel){
    toast('T√ºr, numara ve personel se√ßimi zorunludur.');
    return;
  }
  
  try{
    // √ñnce numarayƒ± bul
    const snap = await db.collection('kumbaralar')
      .where('tur', '==', tur)
      .where('numara', '==', numara)
      .where('zimmetli', '==', false)
      .limit(1)
      .get();
    
    if(snap.empty){
      toast('Bu numara bulunamadƒ± veya zaten zimmetli.');
      await yukleZimmetlenmemisNumaralar();
      return;
    }
    
    const doc = snap.docs[0];
    await doc.ref.update({
      zimmetli: true,
      zimmetliPersonel: personel,
      zimmetTarihi: tsISO(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedBy: currentUser?.email || null
    });
    
    toast(`‚úÖ ${tur} numara ${numara} ‚Üí ${personel} zimmetlendi.`);
    
    // Listeyi yenile
    await yukleZimmetlenmemisNumaralar();
    guncelleZimmetPreview();
  }catch(e){
    console.error(e);
    toast('Zimmetleme sƒ±rasƒ±nda hata olu≈ütu.');
  }
});

/* ===== √áoklu Zimmetleme ===== */
let cokluZimmetListesi = [];
let cokluZimmetCounter = 0;

function cokluZimmetItemOlustur(){
  const id = `coklu-zimmet-${++cokluZimmetCounter}`;
  const item = {
    id: id,
    tur: 'kumbara',
    numaralar: [], // Array olarak tutulacak
    personel: ''
  };
  cokluZimmetListesi.push(item);
  renderCokluZimmetListesi();
  return item;
}

async function renderCokluZimmetListesi(){
  const container = document.getElementById('cokluZimmetListesi');
  if(!container) return;
  
  if(cokluZimmetListesi.length === 0){
    container.innerHTML = '<div class="muted">Hen√ºz zimmet eklenmedi.</div>';
    return;
  }
  
  // Her item i√ßin zimmetlenmemi≈ü numaralarƒ± y√ºkle
  const html = await Promise.all(cokluZimmetListesi.map(async (item, idx)=>{
    const tur = item.tur || 'kumbara';
    let numaraOptions = '<option value="">Y√ºkleniyor...</option>';
    
    try{
      const snap = await db.collection('kumbaralar')
        .where('tur', '==', tur)
        .where('zimmetli', '==', false)
        .get();
      
      if(!snap.empty){
        const numaralar = [];
        snap.forEach(doc=>{
          const n = doc.data().numara;
          if(typeof n === 'number'){
            numaralar.push(n);
          }
        });
        numaralar.sort((a,b)=>a-b);
        
        const seciliNumaralar = Array.isArray(item.numaralar) ? item.numaralar : [];
        numaraOptions = numaralar.map(n=>`<option value="${n}" ${seciliNumaralar.includes(n)?'selected':''}>Numara: ${n}</option>`).join('');
      } else {
        numaraOptions = '<option value="">Zimmetlenmemi≈ü numara yok</option>';
      }
    }catch(e){
      numaraOptions = '<option value="">Hata: ' + e.message + '</option>';
    }
    
    return `
      <div class="coklu-item" data-id="${item.id}">
        <div class="coklu-item-header">
          <div class="coklu-item-title">Zimmet ${idx + 1}</div>
          <button class="coklu-item-remove" onclick="cokluZimmetSil('${item.id}')">‚úñ</button>
        </div>
        <div class="row">
          <div class="col-4 field">
            <label>Kumbara T√ºr√º</label>
            <select class="coklu-zimmet-tur" data-id="${item.id}">
              <option value="kumbara" ${item.tur==='kumbara'?'selected':''}>Kumbara</option>
              <option value="sadaka" ${item.tur==='sadaka'?'selected':''}>Sadaka</option>
            </select>
          </div>
          <div class="col-4 field">
            <label>Numara(lar) - √áoklu se√ßim i√ßin Ctrl/Cmd tu≈üu ile</label>
            <select class="coklu-zimmet-numara" data-id="${item.id}" multiple size="6" style="height:auto; min-height:120px;">
              ${numaraOptions}
            </select>
            <div class="hint" style="margin-top:4px">Se√ßili: <span class="coklu-zimmet-secilen-${item.id}">0</span> numara</div>
          </div>
          <div class="col-4 field">
            <label>Personel</label>
            <select class="coklu-zimmet-personel" data-id="${item.id}">
              ${personeller.map(p=>`<option value="${p}" ${item.personel===p?'selected':''}>${p}</option>`).join('')}
            </select>
          </div>
        </div>
      </div>
    `;
  }));
  
  container.innerHTML = html.join('');
  
  // Event listener'larƒ± ekle
  container.querySelectorAll('.coklu-zimmet-tur, .coklu-zimmet-personel').forEach(el=>{
    el.addEventListener('change', async (e)=>{
      const itemId = e.target.dataset.id;
      const item = cokluZimmetListesi.find(i=>i.id === itemId);
      if(!item) return;
      
      if(e.target.classList.contains('coklu-zimmet-tur')){
        item.tur = e.target.value;
        item.numaralar = []; // T√ºr deƒüi≈üince numaralarƒ± sƒ±fƒ±rla
        await renderCokluZimmetListesi(); // Listeyi yeniden y√ºkle
      }
      if(e.target.classList.contains('coklu-zimmet-personel')) item.personel = e.target.value;
    });
  });
  
  // Multi-select i√ßin √∂zel event listener
  container.querySelectorAll('.coklu-zimmet-numara').forEach(el=>{
    el.addEventListener('change', (e)=>{
      const itemId = e.target.dataset.id;
      const item = cokluZimmetListesi.find(i=>i.id === itemId);
      if(!item) return;
      
      const selected = Array.from(e.target.selectedOptions).map(opt=>parseInt(opt.value)).filter(n=>!isNaN(n));
      item.numaralar = selected;
      
      // Se√ßili sayƒ±sƒ±nƒ± g√ºncelle
      const sayac = container.querySelector(`.coklu-zimmet-secilen-${itemId}`);
      if(sayac) sayac.textContent = selected.length;
    });
    
    // ƒ∞lk y√ºklemede se√ßili sayƒ±sƒ±nƒ± g√∂ster
    const itemId = el.dataset.id;
    const item = cokluZimmetListesi.find(i=>i.id === itemId);
    if(item){
      const sayac = container.querySelector(`.coklu-zimmet-secilen-${itemId}`);
      if(sayac) sayac.textContent = (Array.isArray(item.numaralar) ? item.numaralar.length : 0);
    }
  });
}

window.cokluZimmetSil = function(id){
  cokluZimmetListesi = cokluZimmetListesi.filter(i=>i.id !== id);
  renderCokluZimmetListesi();
}

document.getElementById('btnCokluZimmetEkle').addEventListener('click', ()=>{
  cokluZimmetItemOlustur();
});

document.getElementById('btnCokluZimmetKaydet').addEventListener('click', async ()=>{
  if(cokluZimmetListesi.length === 0){
    toast('Zimmet ekleyiniz.');
    return;
  }
  
  // Validasyon
  for(const item of cokluZimmetListesi){
    if(!item.tur || !item.personel){
      toast(`Zimmet ${cokluZimmetListesi.indexOf(item) + 1}: T√ºr ve personel se√ßimi zorunlu.`);
      return;
    }
    if(!Array.isArray(item.numaralar) || item.numaralar.length === 0){
      toast(`Zimmet ${cokluZimmetListesi.indexOf(item) + 1}: En az bir numara se√ßiniz.`);
      return;
    }
  }
  
  try{
    let basarili = 0, hatali = 0;
    
    for(const item of cokluZimmetListesi){
      // Her numara i√ßin ayrƒ± ayrƒ± zimmetle
      for(const numara of item.numaralar){
        try{
          const snap = await db.collection('kumbaralar')
            .where('tur', '==', item.tur)
            .where('numara', '==', numara)
            .where('zimmetli', '==', false)
            .limit(1)
            .get();
          
          if(snap.empty){
            hatali++;
            continue;
          }
          
          const doc = snap.docs[0];
          await doc.ref.update({
            zimmetli: true,
            zimmetliPersonel: item.personel,
            zimmetTarihi: tsISO(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedBy: currentUser?.email || null
          });
          
          basarili++;
        }catch(e){
          console.error('Zimmet hatasƒ±:', e);
          hatali++;
        }
      }
    }
    
    if(basarili > 0){
      toast(`‚úÖ ${basarili} adet zimmet kaydedildi.${hatali>0?` ${hatali} adet ba≈üarƒ±sƒ±z.`:''}`);
    } else {
      toast('Hi√ßbir zimmet kaydedilemedi.');
    }
    
    cokluZimmetListesi = [];
    await renderCokluZimmetListesi();
    await yukleZimmetlenmemisNumaralar();
    guncelleZimmetPreview();
  }catch(e){
    console.error(e);
    toast('Zimmetleme sƒ±rasƒ±nda hata olu≈ütu.');
  }
});

/* ===== D√ºzenle & Ayarlar - Personel Listesi ===== */
fillPersonelSelect('duzenleZimmetPersonel');

/* ===== D√ºzenle & Ayarlar - Kumbara Kayƒ±tlarƒ± ===== */
document.getElementById('btnDuzenleKayitYukle').addEventListener('click', async ()=>{
  const tur = document.getElementById('duzenleKayitTur').value;
  const container = document.getElementById('duzenleKayitListe');
  
  container.innerHTML = '<div class="muted" style="padding:12px">Y√ºkleniyor...</div>';
  
  try{
    let q = db.collection('kumbaralar');
    if(tur) q = q.where('tur', '==', tur);
    
    const snap = await q.get();
    
    if(snap.empty){
      container.innerHTML = '<div class="muted" style="padding:12px">Kayƒ±t bulunamadƒ±.</div>';
      return;
    }
    
    let html = `
      <table>
        <thead>
          <tr>
            <th>T√ºr</th><th>Numara</th><th>Zimmetli</th><th>Personel</th><th>Kayƒ±t Tarihi</th><th>ƒ∞≈ülem</th>
          </tr>
        </thead>
        <tbody>
    `;
    
    const docs = snap.docs.map(d=>({id: d.id, ...d.data()})).sort((a,b)=>{
      const numA = a.numara || 0;
      const numB = b.numara || 0;
      return numA - numB;
    });
    
    docs.forEach(doc=>{
      const kayitTarihi = doc.kayitTarihi ? new Date(doc.kayitTarihi).toLocaleString('tr-TR') : '-';
      html += `
        <tr data-id="${doc.id}">
          <td>${doc.tur || '-'}</td>
          <td>${doc.numara || '-'}</td>
          <td>${doc.zimmetli ? '‚úÖ Evet' : '‚ùå Hayƒ±r'}</td>
          <td>${doc.zimmetliPersonel || '-'}</td>
          <td>${kayitTarihi}</td>
          <td>
            <button class="btn-ghost duzenle-kayit-btn" data-id="${doc.id}">D√ºzenle</button>
            <button class="btn-ghost sil-kayit-btn" data-id="${doc.id}" style="border-color:#ef444422;color:#ef4444">Sil</button>
          </td>
        </tr>
      `;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
    
    // Event listener'lar
    container.querySelectorAll('.duzenle-kayit-btn').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        const id = e.target.dataset.id;
        duzenleKayitAc(id);
      });
    });
    
    container.querySelectorAll('.sil-kayit-btn').forEach(btn=>{
      btn.addEventListener('click', async (e)=>{
        const id = e.target.dataset.id;
        if(confirm('Bu kaydƒ± silmek istediƒüinize emin misiniz?')){
          await silKayit(id);
        }
      });
    });
  }catch(e){
    console.error(e);
    container.innerHTML = '<div class="muted" style="padding:12px">Hata: ' + e.message + '</div>';
  }
});

async function duzenleKayitAc(docId){
  try{
    const doc = await db.collection('kumbaralar').doc(docId).get();
    if(!doc.exists){
      toast('Kayƒ±t bulunamadƒ±.');
      return;
    }
    
    const data = doc.data();
    const yeniTur = prompt('Yeni T√ºr (kumbara/sadaka):', data.tur || 'kumbara');
    if(!yeniTur) return;
    
    const yeniNumara = prompt('Yeni Numara:', data.numara || '');
    if(!yeniNumara || isNaN(yeniNumara)){
      toast('Ge√ßerli bir numara giriniz.');
      return;
    }
    
    await db.collection('kumbaralar').doc(docId).update({
      tur: yeniTur,
      numara: parseInt(yeniNumara),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedBy: currentUser?.email || null
    });
    
    toast('‚úÖ Kayƒ±t g√ºncellendi.');
    document.getElementById('btnDuzenleKayitYukle').click();
  }catch(e){
    console.error(e);
    toast('G√ºncelleme hatasƒ±.');
  }
}

async function silKayit(docId){
  try{
    await db.collection('kumbaralar').doc(docId).delete();
    toast('‚úÖ Kayƒ±t silindi.');
    document.getElementById('btnDuzenleKayitYukle').click();
  }catch(e){
    console.error(e);
    toast('Silme hatasƒ±.');
  }
}

/* ===== D√ºzenle & Ayarlar - Zimmetleme Kayƒ±tlarƒ± ===== */
document.getElementById('btnDuzenleZimmetYukle').addEventListener('click', async ()=>{
  const tur = document.getElementById('duzenleZimmetTur').value;
  const personel = document.getElementById('duzenleZimmetPersonel').value;
  const container = document.getElementById('duzenleZimmetListe');
  
  container.innerHTML = '<div class="muted" style="padding:12px">Y√ºkleniyor...</div>';
  
  try{
    let q = db.collection('kumbaralar').where('zimmetli', '==', true);
    if(tur) q = q.where('tur', '==', tur);
    if(personel) q = q.where('zimmetliPersonel', '==', personel);
    
    const snap = await q.get();
    
    if(snap.empty){
      container.innerHTML = '<div class="muted" style="padding:12px">Kayƒ±t bulunamadƒ±.</div>';
      return;
    }
    
    let html = `
      <table>
        <thead>
          <tr>
            <th>T√ºr</th><th>Numara</th><th>Personel</th><th>Zimmet Tarihi</th><th>ƒ∞≈ülem</th>
          </tr>
        </thead>
        <tbody>
    `;
    
    const docs = snap.docs.map(d=>({id: d.id, ...d.data()})).sort((a,b)=>{
      const numA = a.numara || 0;
      const numB = b.numara || 0;
      return numA - numB;
    });
    
    docs.forEach(doc=>{
      const zimmetTarihi = doc.zimmetTarihi ? new Date(doc.zimmetTarihi).toLocaleString('tr-TR') : '-';
      html += `
        <tr data-id="${doc.id}">
          <td>${doc.tur || '-'}</td>
          <td>${doc.numara || '-'}</td>
          <td>${doc.zimmetliPersonel || '-'}</td>
          <td>${zimmetTarihi}</td>
          <td>
            <button class="btn-ghost duzenle-zimmet-btn" data-id="${doc.id}">D√ºzenle</button>
            <button class="btn-ghost iptal-zimmet-btn" data-id="${doc.id}" style="border-color:#ef444422;color:#ef4444">Zimmeti ƒ∞ptal Et</button>
          </td>
        </tr>
      `;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
    
    // Event listener'lar
    container.querySelectorAll('.duzenle-zimmet-btn').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        const id = e.target.dataset.id;
        duzenleZimmetAc(id);
      });
    });
    
    container.querySelectorAll('.iptal-zimmet-btn').forEach(btn=>{
      btn.addEventListener('click', async (e)=>{
        const id = e.target.dataset.id;
        if(confirm('Zimmeti iptal etmek istediƒüinize emin misiniz?')){
          await iptalZimmet(id);
        }
      });
    });
  }catch(e){
    console.error(e);
    container.innerHTML = '<div class="muted" style="padding:12px">Hata: ' + e.message + '</div>';
  }
});

async function duzenleZimmetAc(docId){
  try{
    const doc = await db.collection('kumbaralar').doc(docId).get();
    if(!doc.exists){
      toast('Kayƒ±t bulunamadƒ±.');
      return;
    }
    
    const data = doc.data();
    const yeniPersonel = prompt('Yeni Personel:', data.zimmetliPersonel || '');
    if(!yeniPersonel){
      toast('Personel adƒ± bo≈ü olamaz.');
      return;
    }
    
    await db.collection('kumbaralar').doc(docId).update({
      zimmetliPersonel: yeniPersonel,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedBy: currentUser?.email || null
    });
    
    toast('‚úÖ Zimmet g√ºncellendi.');
    document.getElementById('btnDuzenleZimmetYukle').click();
  }catch(e){
    console.error(e);
    toast('G√ºncelleme hatasƒ±.');
  }
}

async function iptalZimmet(docId){
  try{
    await db.collection('kumbaralar').doc(docId).update({
      zimmetli: false,
      zimmetliPersonel: null,
      zimmetTarihi: null,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedBy: currentUser?.email || null
    });
    
    toast('‚úÖ Zimmet iptal edildi.');
    document.getElementById('btnDuzenleZimmetYukle').click();
  }catch(e){
    console.error(e);
    toast('ƒ∞ptal hatasƒ±.');
  }
}

/* ===== Toplama Takibi ===== */
document.getElementById('btnToplamaYukle').addEventListener('click', async ()=>{
  const tur = document.getElementById('toplamaTur').value;
  const durum = document.getElementById('toplamaDurum').value;
  const container = document.getElementById('toplamaListe');
  
  container.innerHTML = '<div class="muted" style="padding:12px">Y√ºkleniyor...</div>';
  
  try{
    let q = db.collection('kumbaralar').where('dagitildi', '==', true);
    if(tur) q = q.where('tur', '==', tur);
    
    const snap = await q.get();
    
    if(snap.empty){
      container.innerHTML = '<div class="muted" style="padding:12px">Kayƒ±t bulunamadƒ±.</div>';
      return;
    }
    
    let docs = snap.docs.map(d=>({id: d.id, ...d.data()}));
    
    // Durum filtresi (client-side)
    if(durum){
      if(durum === 'dagitildi'){
        docs = docs.filter(d=>!d.toplandi);
      } else if(durum === 'toplandi'){
        docs = docs.filter(d=>d.toplandi && !d.sayimAsamasinda);
      } else if(durum === 'sayim'){
        docs = docs.filter(d=>d.sayimAsamasinda && !d.tamamlandi);
      } else if(durum === 'tamamlandi'){
        docs = docs.filter(d=>d.tamamlandi);
      }
    }
    
    docs.sort((a,b)=>{
      const numA = a.numara || 0;
      const numB = b.numara || 0;
      return numA - numB;
    });
    
    if(docs.length === 0){
      container.innerHTML = '<div class="muted" style="padding:12px">Filtreye uygun kayƒ±t bulunamadƒ±.</div>';
      return;
    }
    
    let html = `
      <table>
        <thead>
          <tr>
            <th>T√ºr</th><th>Numara</th><th>Personel</th><th>Verilen Ki≈üi</th><th>Durum</th><th>ƒ∞√ßinden √áƒ±kan Miktar</th><th>ƒ∞≈ülem</th><th>D√ºzenle</th>
          </tr>
        </thead>
        <tbody>
    `;
    
    docs.forEach(doc=>{
      const turLabel = doc.tur === 'kumbara' ? 'Kumbara' : 'Sadaka';
      let durumBadge = '';
      let islemButonlari = '';
      
      if(!doc.toplandi){
        durumBadge = '<span style="padding:4px 8px; border-radius:6px; background:rgba(34,197,94,.15); color:var(--success); font-size:12px">Daƒüƒ±tƒ±ldƒ±</span>';
        islemButonlari = `<button class="btn-ghost topla-btn" data-id="${doc.id}">Teslim Al</button>`;
      } else if(doc.sayimAsamasinda && !doc.tamamlandi){
        durumBadge = '<span style="padding:4px 8px; border-radius:6px; background:rgba(14,165,233,.15); color:var(--brand); font-size:12px">Sayƒ±m A≈üamasƒ±nda</span>';
        islemButonlari = `<button class="btn-ghost miktar-btn" data-id="${doc.id}">Miktar Gir</button>`;
      } else if(doc.tamamlandi){
        durumBadge = '<span style="padding:4px 8px; border-radius:6px; background:rgba(34,197,94,.15); color:var(--success); font-size:12px">‚úì Tamamlandƒ±</span>';
        islemButonlari = `<span class="muted" style="font-size:12px">${doc.icindenCikanMiktar ? doc.icindenCikanMiktar + ' ‚Ç∫' : '-'}</span>`;
      } else {
        durumBadge = '<span style="padding:4px 8px; border-radius:6px; background:rgba(245,158,11,.15); color:var(--warning); font-size:12px">Toplandƒ±</span>';
        islemButonlari = `<button class="btn-ghost sayim-btn" data-id="${doc.id}">Sayƒ±ma Al</button>`;
      }
      
      html += `
        <tr data-id="${doc.id}">
          <td>${turLabel}</td>
          <td>#${doc.numara || '-'}</td>
          <td>${doc.zimmetliPersonel || '-'}</td>
          <td>${doc.verilenKisiAdSoyad || '-'}</td>
          <td>${durumBadge}</td>
          <td>${doc.icindenCikanMiktar ? doc.icindenCikanMiktar + ' ‚Ç∫' : '-'}</td>
          <td>${islemButonlari}</td>
          <td><button class="btn-ghost duzenle-toplama-btn" data-id="${doc.id}" style="border-color:rgba(14,165,233,.3);color:var(--brand)">‚úèÔ∏è D√ºzenle</button></td>
        </tr>
      `;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
    
    // Event listener'lar
    container.querySelectorAll('.topla-btn').forEach(btn=>{
      btn.addEventListener('click', async (e)=>{
        const id = e.target.dataset.id;
        if(confirm('Bu kumbara/sadaka kutusunu teslim almak istediƒüinize emin misiniz?')){
          await toplamaTeslimAl(id);
        }
      });
    });
    
    container.querySelectorAll('.sayim-btn').forEach(btn=>{
      btn.addEventListener('click', async (e)=>{
        const id = e.target.dataset.id;
        await toplamaSayimaAl(id);
      });
    });
    
    container.querySelectorAll('.miktar-btn').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        const id = e.target.dataset.id;
        toplamaMiktarGir(id);
      });
    });
    
    container.querySelectorAll('.duzenle-toplama-btn').forEach(btn=>{
      btn.addEventListener('click', (e)=>{
        const id = e.target.dataset.id;
        toplamaDuzenleAc(id);
      });
    });
  }catch(e){
    console.error(e);
    container.innerHTML = '<div class="muted" style="padding:12px">Hata: ' + e.message + '</div>';
  }
});

async function toplamaTeslimAl(docId){
  try{
    await db.collection('kumbaralar').doc(docId).update({
      toplandi: true,
      toplamaTarihi: tsISO(),
      sayimAsamasinda: false,
      tamamlandi: false,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedBy: currentUser?.email || null
    });
    
    toast('‚úÖ Kumbara teslim alƒ±ndƒ±.');
    document.getElementById('btnToplamaYukle').click();
  }catch(e){
    console.error(e);
    toast('Teslim alma hatasƒ±.');
  }
}

async function toplamaSayimaAl(docId){
  try{
    await db.collection('kumbaralar').doc(docId).update({
      sayimAsamasinda: true,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedBy: currentUser?.email || null
    });
    
    toast('‚úÖ Kumbara sayƒ±m a≈üamasƒ±na alƒ±ndƒ±.');
    document.getElementById('btnToplamaYukle').click();
  }catch(e){
    console.error(e);
    toast('Sayƒ±ma alma hatasƒ±.');
  }
}

function toplamaMiktarGir(docId){
  const miktar = prompt('ƒ∞√ßinden √ßƒ±kan miktarƒ± giriniz (‚Ç∫):', '');
  if(!miktar || isNaN(parseFloat(miktar))){
    toast('Ge√ßerli bir miktar giriniz.');
    return;
  }
  
  const miktarNum = parseFloat(miktar);
  if(miktarNum < 0){
    toast('Miktar negatif olamaz.');
    return;
  }
  
  db.collection('kumbaralar').doc(docId).update({
    icindenCikanMiktar: miktarNum,
    tamamlandi: true,
    tamamlanmaTarihi: tsISO(),
    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
    updatedBy: currentUser?.email || null
  }).then(()=>{
    toast(`‚úÖ Miktar kaydedildi: ${miktarNum} ‚Ç∫`);
    
    // Kullanƒ±cƒ±ya bildirim g√∂nder (eƒüer zimmetli personel varsa)
    db.collection('kumbaralar').doc(docId).get().then(doc=>{
      if(doc.exists){
        const data = doc.data();
        const personel = data.zimmetliPersonel;
        if(personel){
          // Bildirim kaydƒ± olu≈ütur
          db.collection('bildirimler').add({
            alici: personel,
            baslik: 'Kumbara Sayƒ±mƒ± Tamamlandƒ±',
            mesaj: `${data.tur === 'kumbara' ? 'Kumbara' : 'Sadaka'} #${data.numara} sayƒ±mƒ± tamamlandƒ±. ƒ∞√ßinden ${miktarNum} ‚Ç∫ √ßƒ±ktƒ±.`,
            okundu: false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            tur: 'kumbara-sayim'
          }).catch(e=>console.error('Bildirim kaydedilemedi:', e));
        }
      }
    });
    
    document.getElementById('btnToplamaYukle').click();
  }).catch(e=>{
    console.error(e);
    toast('Miktar kaydedilemedi.');
  });
}

/* ===== Toplama D√ºzenleme Modal ===== */
let duzenleToplamaData = null;

async function toplamaDuzenleAc(docId){
  const modal = document.getElementById('toplamaDuzenleModal');
  document.getElementById('duzenleToplamaId').value = docId;
  
  try{
    const doc = await db.collection('kumbaralar').doc(docId).get();
    if(!doc.exists){
      toast('Kayƒ±t bulunamadƒ±.');
      return;
    }
    
    duzenleToplamaData = doc.data();
    const turLabel = duzenleToplamaData.tur === 'kumbara' ? 'Kumbara' : 'Sadaka';
    
    // Bilgi g√∂ster
    document.getElementById('duzenleToplamaBilgi').innerHTML = `
      <strong>${turLabel} #${duzenleToplamaData.numara || '-'}</strong><br>
      <span class="muted">Personel: ${duzenleToplamaData.zimmetliPersonel || '-'}</span><br>
      <span class="muted">Verilen Ki≈üi: ${duzenleToplamaData.verilenKisiAdSoyad || '-'}</span>
    `;
    
    // Durum g√∂ster
    let durumText = '';
    if(!duzenleToplamaData.toplandi){
      durumText = '<span style="padding:4px 8px; border-radius:6px; background:rgba(34,197,94,.15); color:var(--success); font-size:12px">Daƒüƒ±tƒ±ldƒ±</span>';
    } else if(duzenleToplamaData.sayimAsamasinda && !duzenleToplamaData.tamamlandi){
      durumText = '<span style="padding:4px 8px; border-radius:6px; background:rgba(14,165,233,.15); color:var(--brand); font-size:12px">Sayƒ±m A≈üamasƒ±nda</span>';
    } else if(duzenleToplamaData.tamamlandi){
      durumText = '<span style="padding:4px 8px; border-radius:6px; background:rgba(34,197,94,.15); color:var(--success); font-size:12px">‚úì Tamamlandƒ±</span>';
    } else {
      durumText = '<span style="padding:4px 8px; border-radius:6px; background:rgba(245,158,11,.15); color:var(--warning); font-size:12px">Toplandƒ±</span>';
    }
    document.getElementById('duzenleToplamaDurum').innerHTML = durumText;
    
    // Miktar g√∂ster
    const mevcutMiktar = duzenleToplamaData.icindenCikanMiktar || 0;
    document.getElementById('duzenleToplamaMiktar').value = mevcutMiktar;
    document.getElementById('duzenleToplamaMevcutMiktar').textContent = mevcutMiktar > 0 ? mevcutMiktar + ' ‚Ç∫' : 'Miktar girilmemi≈ü';
    
    // Geri alma butonlarƒ±nƒ± g√∂ster/gizle
    document.getElementById('btnGeriAlToplandi').style.display = duzenleToplamaData.toplandi && !duzenleToplamaData.sayimAsamasinda && !duzenleToplamaData.tamamlandi ? 'flex' : 'none';
    document.getElementById('btnGeriAlSayim').style.display = duzenleToplamaData.sayimAsamasinda && !duzenleToplamaData.tamamlandi ? 'flex' : 'none';
    document.getElementById('btnGeriAlTamamlandi').style.display = duzenleToplamaData.tamamlandi ? 'flex' : 'none';
    
    modal.classList.add('show');
  }catch(e){
    console.error(e);
    toast('Veri y√ºklenemedi.');
  }
}

function toplamaDuzenleKapat(){
  document.getElementById('toplamaDuzenleModal').classList.remove('show');
  duzenleToplamaData = null;
}

// Geri alma butonlarƒ±
document.getElementById('btnGeriAlToplandi').addEventListener('click', async ()=>{
  const id = document.getElementById('duzenleToplamaId').value;
  if(!confirm('Toplandƒ± durumunu geri almak istediƒüinize emin misiniz? Kumbara "Daƒüƒ±tƒ±ldƒ±" durumuna d√∂necektir.')){
    return;
  }
  
  try{
    await db.collection('kumbaralar').doc(id).update({
      toplandi: false,
      toplamaTarihi: null,
      sayimAsamasinda: false,
      tamamlandi: false,
      icindenCikanMiktar: null,
      tamamlanmaTarihi: null,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedBy: currentUser?.email || null
    });
    
    toast('‚úÖ Durum geri alƒ±ndƒ±. Kumbara "Daƒüƒ±tƒ±ldƒ±" durumuna d√∂nd√º.');
    toplamaDuzenleKapat();
    document.getElementById('btnToplamaYukle').click();
  }catch(e){
    console.error(e);
    toast('Geri alma hatasƒ±.');
  }
});

document.getElementById('btnGeriAlSayim').addEventListener('click', async ()=>{
  const id = document.getElementById('duzenleToplamaId').value;
  if(!confirm('Sayƒ±m durumunu geri almak istediƒüinize emin misiniz? Kumbara "Toplandƒ±" durumuna d√∂necektir.')){
    return;
  }
  
  try{
    await db.collection('kumbaralar').doc(id).update({
      sayimAsamasinda: false,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedBy: currentUser?.email || null
    });
    
    toast('‚úÖ Durum geri alƒ±ndƒ±. Kumbara "Toplandƒ±" durumuna d√∂nd√º.');
    toplamaDuzenleKapat();
    document.getElementById('btnToplamaYukle').click();
  }catch(e){
    console.error(e);
    toast('Geri alma hatasƒ±.');
  }
});

document.getElementById('btnGeriAlTamamlandi').addEventListener('click', async ()=>{
  const id = document.getElementById('duzenleToplamaId').value;
  if(!confirm('Tamamlandƒ± durumunu geri almak istediƒüinize emin misiniz? Kumbara "Sayƒ±m A≈üamasƒ±nda" durumuna d√∂necektir. Miktar bilgisi korunacaktƒ±r.')){
    return;
  }
  
  try{
    await db.collection('kumbaralar').doc(id).update({
      tamamlandi: false,
      tamamlanmaTarihi: null,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedBy: currentUser?.email || null
    });
    
    toast('‚úÖ Durum geri alƒ±ndƒ±. Kumbara "Sayƒ±m A≈üamasƒ±nda" durumuna d√∂nd√º.');
    toplamaDuzenleKapat();
    document.getElementById('btnToplamaYukle').click();
  }catch(e){
    console.error(e);
    toast('Geri alma hatasƒ±.');
  }
});

// Miktar kaydet
document.getElementById('btnToplamaDuzenleKaydet').addEventListener('click', async ()=>{
  const id = document.getElementById('duzenleToplamaId').value;
  const miktar = parseFloat(document.getElementById('duzenleToplamaMiktar').value) || 0;
  
  if(miktar < 0){
    toast('Miktar negatif olamaz.');
    return;
  }
  
  try{
    const updateData = {
      icindenCikanMiktar: miktar > 0 ? miktar : null,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedBy: currentUser?.email || null
    };
    
    // Eƒüer miktar girildiyse ve sayƒ±m a≈üamasƒ±ndaysa, tamamlandƒ± yap
    if(miktar > 0 && duzenleToplamaData && duzenleToplamaData.sayimAsamasinda && !duzenleToplamaData.tamamlandi){
      updateData.tamamlandi = true;
      updateData.tamamlanmaTarihi = tsISO();
      
      // Bildirim g√∂nder
      if(duzenleToplamaData.zimmetliPersonel){
        db.collection('bildirimler').add({
          alici: duzenleToplamaData.zimmetliPersonel,
          baslik: 'Kumbara Sayƒ±mƒ± Tamamlandƒ±',
          mesaj: `${duzenleToplamaData.tur === 'kumbara' ? 'Kumbara' : 'Sadaka'} #${duzenleToplamaData.numara} sayƒ±mƒ± tamamlandƒ±. ƒ∞√ßinden ${miktar} ‚Ç∫ √ßƒ±ktƒ±.`,
          okundu: false,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          tur: 'kumbara-sayim'
        }).catch(e=>console.error('Bildirim kaydedilemedi:', e));
      }
    }
    
    await db.collection('kumbaralar').doc(id).update(updateData);
    
    toast(`‚úÖ Miktar g√ºncellendi: ${miktar > 0 ? miktar + ' ‚Ç∫' : 'Temizlendi'}`);
    toplamaDuzenleKapat();
    document.getElementById('btnToplamaYukle').click();
  }catch(e){
    console.error(e);
    toast('G√ºncelleme hatasƒ±.');
  }
});

/* ===== ƒ∞lk Y√ºkleme ===== */
(async function initOnce(){
  await guncelleKayitOnizleme();
  guncelleKayitPreview();
  await yukleZimmetlenmemisNumaralar();
  guncelleZimmetPreview();
  await renderCokluZimmetListesi();
})();
</script>
</body>
</html>

