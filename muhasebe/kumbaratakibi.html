<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>KaraaÄŸaÃ§ Fatih | Kumbara Takibi</title>
<link rel="icon" type="image/png" href="../img/logo.png" />
<link rel="stylesheet" href="../css/app-shell.css" />

<style>
  /* Sayfa Ã¶zel stilleri - app-shell.css'deki stiller kullanÄ±lÄ±yor */
  /* Sadece sayfa Ã¶zel ekstra stiller buraya */

  /* ========== Modal Temel Stilleri ========== */
  .modal {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0, 0, 0, 0.6); /* Daha koyu arka plan */
    backdrop-filter: blur(4px); /* Modern bulanÄ±klÄ±k efekti */
    -webkit-backdrop-filter: blur(4px); /* Safari desteÄŸi */
    z-index: 99999 !important; /* En Ã¼stte olmalÄ± */
    opacity: 0; visibility: hidden; pointer-events: none;
    display: flex; align-items: center; justify-content: center;
    transition: all 0.25s ease-out;
  }
  .modal.show {
    opacity: 1; visibility: visible; pointer-events: auto;
  }
  /* Modal Ä°Ã§erik Animasyonu */
  .modal .sheet, .modal .modal-icerik {
    transform: scale(0.95) translateY(10px);
    transition: all 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
    opacity: 0;
    position: relative;
    z-index: 1;
    max-width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    background: var(--card);
    border-radius: 16px;
    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
  }
  .modal.show .sheet, .modal.show .modal-icerik {
    transform: scale(1) translateY(0);
    opacity: 1;
  }
  
  /* Modal iÃ§eriÄŸi iÃ§in ek stiller */
  .modal .modal-icerik {
    padding: 24px;
    position: relative;
  }
  
  /* Modal kapat butonu */
  .modal .modal-kapat {
    position: absolute;
    top: 16px;
    right: 16px;
    background: transparent;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: var(--muted);
    padding: 4px 8px;
    border-radius: 8px;
    transition: all 0.2s ease;
    z-index: 10;
  }
  .modal .modal-kapat:hover {
    background: var(--surface2);
    color: var(--text);
  }

  /* ========== Ã–nizleme ve Liste ========== */
  .onizleme-box{
    border:1px solid var(--stroke); 
    border-radius:14px; 
    padding:16px; 
    background:var(--card);
    margin-top:12px; 
    max-height:200px; 
    overflow-y:auto;
    box-shadow:0 2px 8px rgba(0,0,0,.04);
  }
  .numara-list{
    display:flex; 
    flex-wrap:wrap; 
    gap:8px;
  }
  .numara-badge{
    padding:6px 12px; 
    border-radius:8px; 
    font-size:12px; 
    font-weight:600;
    background:var(--surface); 
    border:1px solid var(--stroke);
    transition:all .2s ease;
  }
  .numara-badge:hover{
    transform:translateY(-1px);
    box-shadow:0 2px 4px rgba(0,0,0,.1);
  }
  .numara-badge.kayitli{
    background:rgba(34,197,94,.15); 
    border-color:rgba(34,197,94,.3); 
    color:var(--success);
  }
  .numara-badge.mevcut{
    background:rgba(14,165,233,.15); 
    border-color:rgba(14,165,233,.3); 
    color:var(--brand);
  }
  .numara-badge.cakisma{
    background:rgba(239,68,68,.15); 
    border-color:rgba(239,68,68,.3); 
    color:var(--danger);
  }

  /* ========== Progress Bar ========== */
  .progress-bar-container{
    width:100%; height:24px; background:var(--surface); border-radius:12px; overflow:hidden;
    border:1px solid var(--stroke); position:relative;
  }
  .progress-bar-fill{
    height:100%; border-radius:12px; transition:width .3s ease, background-color .3s ease;
    display:flex; align-items:center; justify-content:center; font-size:11px; font-weight:700;
    color:#fff; text-shadow:0 1px 2px rgba(0,0,0,.2); padding:0 6px;
  }
  .progress-bar-text{
    position:absolute; left:50%; top:50%; transform:translate(-50%, -50%);
    font-size:11px; font-weight:700; color:var(--text); pointer-events:none;
    z-index:1;
  }

  /* ========== GiriÅŸ Tipi SeÃ§imi ========== */
  .giris-tip{
    display:flex; 
    gap:12px; 
    margin-bottom:20px;
  }
  .giris-tip-btn{
    flex:1; 
    padding:12px 16px; 
    border:2px solid var(--stroke); 
    border-radius:12px;
    background:var(--card); 
    cursor:pointer; 
    text-align:center; 
    font-weight:600;
    font-size:14px;
    transition:all .2s ease;
    color:var(--text);
  }
  .giris-tip-btn:hover{
    border-color:var(--brand);
    background:var(--surface);
    transform:translateY(-1px);
  }
  .giris-tip-btn.active{
    border-color:var(--brand); 
    background:linear-gradient(180deg, rgba(14,165,233,.15), rgba(14,165,233,.1)); 
    color:var(--brand);
    box-shadow:0 2px 8px rgba(59,130,246,.2);
  }

  /* ========== Ã‡oklu GiriÅŸ Listesi ========== */
  .coklu-item{
    border:1px solid var(--stroke); 
    border-radius:14px; 
    padding:16px;
    background:var(--card); 
    margin-bottom:16px;
    box-shadow:0 2px 8px rgba(0,0,0,.04);
    transition:all .2s ease;
  }
  .coklu-item:hover{
    box-shadow:0 4px 12px rgba(0,0,0,.08);
    border-color:var(--brand);
  }
  .coklu-item-header{
    display:flex; 
    justify-content:space-between; 
    align-items:center; 
    margin-bottom:16px;
    padding-bottom:12px;
    border-bottom:1px solid var(--stroke);
  }
  .coklu-item-title{
    font-weight:700;
    font-size:15px;
    color:var(--text);
  }
  .coklu-item-remove{
    background:transparent; 
    border:none; 
    color:var(--danger);
    cursor:pointer; 
    font-size:18px; 
    padding:4px 8px;
    border-radius:8px;
    transition:all .2s ease;
  }
  .coklu-item-remove:hover{
    background:rgba(239,68,68,.1);
    transform:scale(1.1);
  }

  /* ========== Badge Temel SÄ±nÄ±fÄ± (GÃ¶rÃ¼nÃ¼rlÃ¼k ZorlamasÄ±) ========== */
  .badge{
    display: inline-block !important;
    opacity: 1 !important;
    visibility: visible !important;
    position: static !important;
    padding: 6px 12px !important;
    border-radius: 8px !important;
    font-size: 12px !important;
    font-weight: 600 !important;
    border: 1px solid var(--stroke) !important;
    background: var(--surface2) !important;
    color: var(--text) !important;
    line-height: 1.4 !important;
    white-space: nowrap !important;
    vertical-align: middle !important;
  }

  /* ========== Badge VaryantlarÄ± ========== */
  .badge-blue{
    background: rgba(59,130,246,.2) !important;
    color: #1e40af !important;
    border-color: rgba(59,130,246,.4) !important;
  }
  .badge-orange{
    background: rgba(245,158,11,.2) !important;
    color: #b45309 !important;
    border-color: rgba(245,158,11,.4) !important;
  }
  .badge-red{
    background: rgba(239,68,68,.2) !important;
    color: #b91c1c !important;
    border-color: rgba(239,68,68,.4) !important;
  }
  .badge-gray{
    background: var(--surface2) !important;
    color: var(--muted) !important;
    border-color: var(--stroke) !important;
  }
  .badge-success,
  .badge.green{
    background: rgba(34,197,94,.2) !important;
    color: #15803d !important;
    border-color: rgba(34,197,94,.4) !important;
  }
  .badge.error{
    background: rgba(239,68,68,.2) !important;
    color: #b91c1c !important;
    border-color: rgba(239,68,68,.4) !important;
  }

  /* ========== Modern Tablo GÃ¶rÃ¼nÃ¼mÃ¼ ========== */
  .table{
    border-collapse:separate;
    border-spacing:0 8px;
  }
  .table thead th{
    padding:12px 16px;
    background:var(--surface);
    border-bottom:2px solid var(--stroke);
  }
  .table tbody tr{
    background:var(--surface);
    border-radius:12px;
    box-shadow:0 2px 4px rgba(0,0,0,.04);
    transition:all .2s ease;
  }
  .table tbody tr:hover{
    box-shadow:0 4px 8px rgba(0,0,0,.08);
    transform:translateY(-1px);
  }
  .table tbody td{
    padding:12px 16px;
    border:none;
    vertical-align:middle !important;
  }
  .table thead th{
    vertical-align:middle !important;
  }
  .table tbody tr:first-child td:first-child{
    border-top-left-radius:12px;
  }
  .table tbody tr:first-child td:last-child{
    border-top-right-radius:12px;
  }
  .table tbody tr:last-child td:first-child{
    border-bottom-left-radius:12px;
  }
  .table tbody tr:last-child td:last-child{
    border-bottom-right-radius:12px;
  }

  /* ========== Ä°yileÅŸtirilmiÅŸ Tablo ButonlarÄ± ========== */
  .table-action-btn{
    padding:6px 12px;
    font-size:13px;
    border-radius:8px;
    font-weight:600;
    transition: background-color .2s ease, transform .15s ease !important;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:4px;
    position: relative !important;
    border:1px solid transparent;
    cursor:pointer;
    white-space:nowrap;
    vertical-align:middle;
    overflow:visible;
  }
  .table-action-btn::before,
  .table-action-btn::after{
    display:none !important;
  }
  .table-action-btn.btn-edit{
    background:rgba(59,130,246,.1) !important;
    color:var(--brand) !important;
    border:1px solid rgba(59,130,246,.2) !important;
  }
  .table-action-btn.btn-edit:hover{
    background:rgba(59,130,246,.18) !important;
    border-color:var(--brand) !important;
    transform:translateY(-1px) scale(1.02) !important;
    box-shadow:0 2px 4px rgba(59,130,246,.25) !important;
  }
  .table-action-btn.btn-delete{
    background:rgba(239,68,68,.1) !important;
    color:var(--danger) !important;
    border:1px solid rgba(239,68,68,.2) !important;
  }
  .table-action-btn.btn-delete:hover{
    background:rgba(239,68,68,.18) !important;
    border-color:var(--danger) !important;
    transform:translateY(-1px) scale(1.02) !important;
    box-shadow:0 2px 4px rgba(239,68,68,.25) !important;
  }
  .table-action-btn.btn-cancel{
    background:rgba(245,158,11,.1) !important;
    color:#b45309 !important;
    border:1px solid rgba(245,158,11,.2) !important;
  }
  .table-action-btn.btn-cancel:hover{
    background:rgba(245,158,11,.18) !important;
    border-color:#f59e0b !important;
    transform:translateY(-1px) scale(1.02) !important;
    box-shadow:0 2px 4px rgba(245,158,11,.25) !important;
  }
  .table-action-btn.btn-success{
    background:rgba(34,197,94,.1) !important;
    color:#15803d !important;
    border:1px solid rgba(34,197,94,.2) !important;
  }
  .table-action-btn.btn-success:hover{
    background:rgba(34,197,94,.18) !important;
    border-color:#22c55e !important;
    transform:translateY(-1px) scale(1.02) !important;
    box-shadow:0 2px 4px rgba(34,197,94,.25) !important;
  }
</style>

<!-- Supabase (Auth + Database iÃ§in) - Ã–NCE YÃœKLENMELÄ° -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script>
  // Supabase client'Ä±n yÃ¼klendiÄŸinden emin ol
  (function() {
    const SUPABASE_URL = 'https://lmwfibippjvqctccxiwb.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxtd2ZpYmlwcGp2cWN0Y2N4aXdiIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NjE2NzA1NCwiZXhwIjoyMDgxNzQzMDU0fQ.lzoudrJx_V4RdCCxPRfgLA1riWNKZ3HyFzeqRynYHeQ';
    
    function initSupabase() {
      if (typeof supabase !== 'undefined' && typeof supabase.createClient === 'function') {
        window.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        return true;
      }
      return false;
    }
    
    // Hemen dene
    if (!initSupabase()) {
      // Biraz bekle ve tekrar dene
      let retries = 0;
      const maxRetries = 30;
      const retryInterval = setInterval(function() {
        retries++;
        if (initSupabase() || retries >= maxRetries) {
          clearInterval(retryInterval);
          if (window.supabase) {
            console.log('âœ… Supabase client hazÄ±r');
          }
        }
      }, 100);
    } else {
      console.log('âœ… Supabase client hazÄ±r');
    }
  })();
</script>
<script src="../src/supabase-auth-wrapper.js"></script>
<script src="../js/ortak.js"></script>
</head>
<body>

<!-- APPBAR -->
<div class="appbar">
  <div class="brand" onclick="location.href='../panel.html'">
    <img src="../img/logo.png" alt="logo"><span>KARAAÄAÃ‡ FATÄ°H</span>
  </div>
  <nav class="nav-center"><ul class="nav-list" id="navMain"></ul></nav>
  <div class="nav-right">
    <button class="btn hamb" id="hamburger" title="MenÃ¼">â˜°</button>
    <div class="nav-item">
      <button class="iconbtn" id="btnNotif" title="Bildirimler">ğŸ””
        <span class="badge" id="notifBadge" style="display:none">0</span>
      </button>
      <div class="dropdown drop-right" id="notifDropdown" aria-label="Bildirim listesi">
        <div class="muted" style="padding:6px 8px">Son bildirimler</div>
        <div id="notifList" class="list" style="max-height:300px;overflow:auto"></div>
        <a href="../diger/bildirim.html">TÃ¼m bildirimleri gÃ¶r â†’</a>
      </div>
    </div>
    <div class="nav-item">
      <button class="iconbtn" id="btnProfile" title="Profil">
        <span id="profName" class="muted">Profil</span>
      </button>
      <div class="dropdown drop-right" id="profDropdown">
        <a href="../diger/kullanici-yonetimi.html">ğŸ‘¤ Profil</a>
        <a href="../diger/sistem-ayarlari.html">âš™ï¸ Sistem AyarlarÄ±</a>
        <a href="#" id="btnLogout">ğŸšª Ã‡Ä±kÄ±ÅŸ Yap</a>
      </div>
    </div>
  </div>
</div>
<aside class="drawer" id="drawer"></aside>

<!-- CONTENT -->
<main class="container stack-lg">
  <!-- BaÅŸlÄ±k -->
  <section class="card stack">
    <h2 style="margin:0">Kumbara Takibi YÃ¶netimi</h2>
    <div class="muted">Kumbara kayÄ±tlarÄ± ve personele zimmetleme iÅŸlemleri</div>
  </section>

  <!-- Ãœst Tabs -->
  <section class="card stack">
    <div class="mini-tabs" id="mainTabs">
      <button class="mini-tab active" data-target="kayitWrap">Kumbara KayÄ±t</button>
      <button class="mini-tab" data-target="zimmetWrap">Kumbara Zimmetleme</button>
      <button class="mini-tab" data-target="toplamaWrap">Toplama Takibi</button>
      <button class="mini-tab" data-target="duzenleWrap">DÃ¼zenle &amp; Ayarlar</button>
      <button class="mini-tab" data-target="dashboardWrap">ğŸ“Š Dashboard/Rapor</button>
    </div>
  </section>

  <!-- Kumbara KayÄ±t -->
  <section class="card stack" id="kayitWrap">
    <h3 style="margin:0">Kumbara KayÄ±t</h3>
    
    <!-- Tek GiriÅŸ Formu -->
    <div id="kayitTekForm" class="stack">
      <div class="row">
        <div class="col-6 field">
          <label>Kumbara TÃ¼rÃ¼</label>
          <select id="kayitTur">
            <option value="kumbara">Kumbara</option>
            <option value="sadaka">Sadaka</option>
          </select>
        </div>
        <div class="col-6 field">
          <label>Toplam Adet</label>
          <input type="number" id="kayitAdet" min="1" placeholder="10" />
        </div>
      </div>

      <div class="row">
        <div class="col-6 field">
          <label>Numara BaÅŸlangÄ±Ã§</label>
          <input type="number" id="kayitBaslangic" min="1" placeholder="1" />
        </div>
        <div class="col-6 field">
          <label>Numara BitiÅŸ (opsiyonel, boÅŸ bÄ±rakÄ±lÄ±rsa otomatik)</label>
          <input type="number" id="kayitBitis" min="1" placeholder="10" />
        </div>
      </div>

      <div class="field">
        <label>Ã–nizleme - SeÃ§ili TÃ¼rden KayÄ±tlÄ± Numaralar</label>
        <div class="onizleme-box" id="kayitOnizleme">
          <div class="muted">TÃ¼r seÃ§ildikten sonra yÃ¼klenecek...</div>
        </div>
      </div>

      <div class="hint" id="kayitPreview">Ã–nizleme â€”</div>
      <div class="actions" style="display:flex; gap:10px; flex-wrap:wrap; margin-top:16px">
        <button class="btn btn-primary" id="btnKayitKaydet">ğŸ’¾ Kaydet</button>
        <button class="btn btn-ghost" id="btnKayitOnizlemeYenile">ğŸ”„ Ã–nizlemeyi Yenile</button>
      </div>
    </div>
  </section>

  <!-- Kumbara Zimmetleme -->
  <section class="card stack" id="zimmetWrap" style="display:none">
    <h3 style="margin:0">Kumbara Zimmetleme</h3>
    
    <!-- GiriÅŸ Tipi SeÃ§imi -->
    <div class="giris-tip" id="zimmetGirisTip">
      <button class="giris-tip-btn active" data-tip="tek">Tek GiriÅŸ</button>
      <button class="giris-tip-btn" data-tip="coklu">Ã‡oklu GiriÅŸ</button>
    </div>

    <!-- Tek GiriÅŸ Formu -->
    <div id="zimmetTekForm" class="stack">
      <div class="row">
        <div class="col-6 field">
          <label>Kumbara TÃ¼rÃ¼</label>
          <select id="zimmetTur">
            <option value="kumbara">Kumbara</option>
            <option value="sadaka">Sadaka</option>
          </select>
        </div>
        <div class="col-6 field">
          <label>Personel</label>
          <select id="zimmetPersonel"></select>
        </div>
      </div>

      <div class="field">
        <label>ZimmetlenmemiÅŸ Numaralar</label>
        <select id="zimmetNumara" size="8" style="height:auto; min-height:200px;">
          <option value="">TÃ¼r seÃ§ildikten sonra yÃ¼klenecek...</option>
        </select>
      </div>

      <div class="hint" id="zimmetPreview">Ã–nizleme â€”</div>
      <div class="actions" style="display:flex; gap:10px; flex-wrap:wrap; margin-top:16px">
        <button class="btn btn-primary" id="btnZimmetKaydet">ğŸ’¾ Kaydet</button>
        <button class="btn btn-ghost" id="btnZimmetListeYenile">ğŸ”„ Listeyi Yenile</button>
      </div>
    </div>

    <!-- Ã‡oklu GiriÅŸ -->
    <div id="zimmetCokluForm" class="stack" style="display:none">
      <div class="actions" style="display:flex; gap:10px; flex-wrap:wrap; margin-top:16px">
        <button class="btn btn-ghost" id="btnCokluZimmetEkle">â• Yeni Zimmet Ekle</button>
      </div>
      <div id="cokluZimmetListesi"></div>
      <div class="actions" style="display:flex; gap:10px; flex-wrap:wrap; margin-top:16px">
        <button class="btn btn-primary" id="btnCokluZimmetKaydet">ğŸ’¾ TÃ¼mÃ¼nÃ¼ Kaydet</button>
      </div>
    </div>
  </section>

  <!-- Toplama Takibi -->
  <section class="card stack" id="toplamaWrap" style="display:none">
    <h3 style="margin:0">Kumbara Toplama Takibi</h3>
    
    <!-- Filtreler -->
    <div class="row" style="margin-bottom:16px">
      <div class="col-4 field">
        <label>Kumbara TÃ¼rÃ¼</label>
        <select id="toplamaTur">
          <option value="">TÃ¼mÃ¼</option>
          <option value="kumbara">Kumbara</option>
          <option value="sadaka">Sadaka</option>
        </select>
      </div>
      <div class="col-4 field">
        <label>Durum</label>
        <select id="toplamaDurum">
          <option value="">TÃ¼mÃ¼</option>
          <option value="dagitildi">DaÄŸÄ±tÄ±ldÄ± (ToplanmayÄ± Bekliyor)</option>
          <option value="toplandi">Teslim AlÄ±ndÄ± (ToplandÄ±)</option>
          <option value="sayim">SayÄ±m AÅŸamasÄ±nda</option>
          <option value="tamamlandi">TamamlandÄ±</option>
        </select>
      </div>
      <div class="col-4 field" style="align-self:flex-end">
        <button class="btn btn-primary" id="btnToplamaYukle">ğŸ“¥ YÃ¼kle</button>
      </div>
    </div>
    
    <!-- Toplama Listesi -->
    <div id="toplamaListe" class="table-wrap">
      <div class="muted" style="padding:12px">Filtre seÃ§ip yÃ¼kleyiniz...</div>
    </div>
  </section>

  <!-- DÃ¼zenle & Ayarlar -->
  <section class="card stack" id="duzenleWrap" style="display:none">
    <h3 style="margin:0">DÃ¼zenle &amp; Ayarlar</h3>
    
    <!-- Alt Tabs -->
    <div class="mini-tabs" style="margin-bottom:16px">
      <button class="mini-tab active" data-target="duzenle-kayit">Kumbara KayÄ±tlarÄ±</button>
      <button class="mini-tab" data-target="duzenle-zimmet">Zimmetleme KayÄ±tlarÄ±</button>
    </div>

    <!-- Kumbara KayÄ±tlarÄ± -->
    <div id="duzenle-kayit" class="stack">
      <div class="row">
        <div class="col-6 field">
          <label>Kumbara TÃ¼rÃ¼</label>
          <select id="duzenleKayitTur">
            <option value="">TÃ¼mÃ¼</option>
            <option value="kumbara">Kumbara</option>
            <option value="sadaka">Sadaka</option>
          </select>
        </div>
        <div class="col-6 field" style="align-self:flex-end">
          <button class="cta" id="btnDuzenleKayitYukle">YÃ¼kle</button>
        </div>
      </div>
      
      <div id="duzenleKayitListe" class="table-wrap" style="margin-top:16px">
        <div class="muted" style="padding:12px">TÃ¼r seÃ§ip yÃ¼kleyiniz...</div>
      </div>
    </div>

    <!-- Zimmetleme KayÄ±tlarÄ± -->
    <div id="duzenle-zimmet" class="stack" style="display:none">
      <div class="row">
        <div class="col-6 field">
          <label>Kumbara TÃ¼rÃ¼</label>
          <select id="duzenleZimmetTur">
            <option value="">TÃ¼mÃ¼</option>
            <option value="kumbara">Kumbara</option>
            <option value="sadaka">Sadaka</option>
          </select>
        </div>
        <div class="col-6 field">
          <label>Personel (opsiyonel)</label>
          <select id="duzenleZimmetPersonel">
            <option value="">TÃ¼mÃ¼</option>
          </select>
        </div>
      </div>
      <div class="row">
        <div class="col-12 field" style="align-self:flex-end">
          <button class="btn btn-primary" id="btnDuzenleZimmetYukle">ğŸ“¥ YÃ¼kle</button>
        </div>
      </div>
      
      <div id="duzenleZimmetListe" class="table-wrap" style="margin-top:16px">
        <div class="muted" style="padding:12px">Filtre seÃ§ip yÃ¼kleyiniz...</div>
      </div>
    </div>
  </section>

  <!-- Dashboard/Rapor -->
  <section class="card stack" id="dashboardWrap" style="display:none">
    <!-- SÃ¼tun Gizleme/GÃ¶sterme (Ãœstte) -->
    <details style="margin-bottom:16px">
      <summary style="cursor:pointer; padding:6px 10px; background:var(--surface2); border:1px solid var(--stroke); border-radius:6px; font-size:12px; font-weight:600; color:var(--muted); user-select:none; display:inline-block">
        âš™ï¸ SÃ¼tun Gizle/GÃ¶ster
      </summary>
      <div style="margin-top:8px; padding:10px; background:var(--surface2); border:1px solid var(--stroke); border-radius:8px; display:grid; grid-template-columns:repeat(auto-fit, minmax(130px, 1fr)); gap:6px">
        <label style="display:flex; align-items:center; gap:4px; cursor:pointer; font-size:11px; padding:2px 0">
          <input type="checkbox" class="col-toggle" data-col="personel" checked />
          <span>Personel</span>
        </label>
        <label style="display:flex; align-items:center; gap:4px; cursor:pointer; font-size:11px; padding:2px 0">
          <input type="checkbox" class="col-toggle" data-col="zimmetlenen" checked />
          <span>Zimmetlenen</span>
        </label>
        <label style="display:flex; align-items:center; gap:4px; cursor:pointer; font-size:11px; padding:2px 0">
          <input type="checkbox" class="col-toggle" data-col="dagitilan" checked />
          <span>DaÄŸÄ±tÄ±lan</span>
        </label>
        <label style="display:flex; align-items:center; gap:4px; cursor:pointer; font-size:11px; padding:2px 0">
          <input type="checkbox" class="col-toggle" data-col="dagitmaNispeti" checked />
          <span>DaÄŸÄ±tma Nispeti</span>
        </label>
        <label style="display:flex; align-items:center; gap:4px; cursor:pointer; font-size:11px; padding:2px 0">
          <input type="checkbox" class="col-toggle" data-col="toplanan" checked />
          <span>Toplanan</span>
        </label>
        <label style="display:flex; align-items:center; gap:4px; cursor:pointer; font-size:11px; padding:2px 0">
          <input type="checkbox" class="col-toggle" data-col="kalan" checked />
          <span>Kalan</span>
        </label>
        <label style="display:flex; align-items:center; gap:4px; cursor:pointer; font-size:11px; padding:2px 0">
          <input type="checkbox" class="col-toggle" data-col="toplamaNispeti" checked />
          <span>Toplama Nispeti</span>
        </label>
        <label style="display:flex; align-items:center; gap:4px; cursor:pointer; font-size:11px; padding:2px 0">
          <input type="checkbox" class="col-toggle" data-col="miktar" checked />
          <span>Miktar</span>
        </label>
      </div>
    </details>
    
    <!-- Filtreler ve Butonlar -->
    <div class="row" style="margin-bottom:16px">
      <div class="col-4 field">
        <label>Kumbara TÃ¼rÃ¼</label>
        <select id="dashboardTur">
          <option value="">TÃ¼mÃ¼</option>
          <option value="kumbara">Kumbara</option>
          <option value="sadaka">Sadaka</option>
        </select>
      </div>
      <div class="col-4 field" style="align-self:flex-end">
        <button class="btn btn-primary" id="btnDashboardYukle">ğŸ“Š Raporu YÃ¼kle</button>
      </div>
      <div class="col-4 field" style="align-self:flex-end">
        <button class="btn btn-ghost" id="btnDashboardYenile">ğŸ”„ Yenile</button>
      </div>
    </div>
    
    <!-- BaÅŸlÄ±k -->
    <div style="margin-bottom:25px">
      <h3 style="margin:0">ğŸ“Š Sadaka Kutusu & Kumbara Ä°statistikleri</h3>
      <div class="muted" style="margin-top:4px">Personel bazlÄ± kumbara istatistikleri</div>
    </div>
    
    <!-- Ã–zet Kartlar -->
    <div class="row" id="dashboardOzet" style="margin-bottom:20px">
      <!-- JavaScript ile doldurulacak -->
    </div>
    
    <!-- Rapor Tablosu -->
    <div id="dashboardRapor" class="table-wrap">
      <div class="muted" style="padding:12px">Filtre seÃ§ip raporu yÃ¼kleyiniz...</div>
    </div>
  </section>

  <div style="height:40px"></div>
</main>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Modal Sistemi (Confirm, Prompt, Alert) -->
<div class="modal" id="customModal">
  <div class="sheet" style="max-width:500px">
    <header>
      <h3 id="modalTitle">BaÅŸlÄ±k</h3>
      <button class="btn btn-ghost" onclick="closeCustomModal()" style="padding:4px 8px; min-width:auto">âœ–</button>
    </header>
    <div class="body">
      <p id="modalMessage" style="margin:0 0 16px 0">Mesaj</p>
      <div id="modalInputWrap" style="display:none">
        <input type="text" id="modalInput" placeholder="DeÄŸer giriniz..." style="width:100%" />
      </div>
    </div>
    <footer>
      <button class="btn btn-ghost" id="modalCancelBtn" onclick="closeCustomModal()">Ä°ptal</button>
      <button class="btn btn-primary" id="modalOkBtn" onclick="confirmCustomModal()">Tamam</button>
    </footer>
  </div>
</div>

<!-- Toplama DÃ¼zenleme Modal -->
<div class="modal" id="toplamaDuzenleModal">
  <div class="modal-icerik" style="max-width:600px">
    <button class="modal-kapat" onclick="toplamaDuzenleKapat()">âœ–</button>
    <h3 class="modal-title">Toplama Ä°ÅŸlemi DÃ¼zenle</h3>
    <input type="hidden" id="duzenleToplamaId" />
    
    <div class="field">
      <label>Kumbara/Sadaka Bilgisi</label>
      <div id="duzenleToplamaBilgi" class="muted" style="padding:8px; background:var(--surface2); border-radius:8px"></div>
    </div>
    
    <div class="field">
      <label>Mevcut Durum</label>
      <div id="duzenleToplamaDurum" style="padding:8px; background:var(--surface2); border-radius:8px"></div>
    </div>
    
    <div class="field">
      <label>Ä°Ã§inden Ã‡Ä±kan Miktar (â‚º)</label>
      <input type="number" id="duzenleToplamaMiktar" step="0.01" min="0" placeholder="0.00" />
      <div class="hint">Mevcut miktar: <span id="duzenleToplamaMevcutMiktar">-</span></div>
    </div>
    
    <div class="field">
      <label>Durum Ä°ÅŸlemleri</label>
      <div class="stack" style="gap:8px">
        <button class="btn btn-ghost" id="btnGeriAlToplandi" style="text-align:left; justify-content:flex-start; width:100%">â†©ï¸ ToplandÄ± Durumunu Geri Al (DaÄŸÄ±tÄ±ldÄ±'ya dÃ¶ndÃ¼r)</button>
        <button class="btn btn-ghost" id="btnGeriAlSayim" style="text-align:left; justify-content:flex-start; width:100%">â†©ï¸ SayÄ±m Durumunu Geri Al (ToplandÄ±'ya dÃ¶ndÃ¼r)</button>
        <button class="btn btn-ghost" id="btnGeriAlTamamlandi" style="text-align:left; justify-content:flex-start; width:100%">â†©ï¸ TamamlandÄ± Durumunu Geri Al (SayÄ±m'a dÃ¶ndÃ¼r)</button>
      </div>
    </div>
    
    <div class="actions">
      <button class="btn btn-ghost" onclick="toplamaDuzenleKapat()">Ä°ptal</button>
      <button class="btn btn-primary" id="btnToplamaDuzenleKaydet">Kaydet</button>
    </div>
  </div>
</div>

<script>
/* ===== Helpers ===== */
// Supabase client'Ä± window'dan al (zaten ortak.js'de tanÄ±mlÄ±)
const getSupabase = () => {
  if (!window.supabase) {
    console.error('Supabase client yÃ¼klenmedi!');
    toast('Supabase baÄŸlantÄ±sÄ± kurulamadÄ±. SayfayÄ± yenileyin.', 'error');
    return null;
  }
  return window.supabase;
};

/* ===== Modal Sistemi (Confirm, Prompt, Alert yerine) ===== */
let modalResolve = null;
let modalType = 'alert'; // 'alert', 'confirm', 'prompt'

function showCustomModal(title, message, type = 'alert', defaultValue = '') {
  return new Promise((resolve) => {
    modalResolve = resolve;
    modalType = type;
    const modal = document.getElementById('customModal');
    if (!modal) {
      console.error('Modal elementi bulunamadÄ±!');
      resolve(false);
      return;
    }
    
    const modalTitle = document.getElementById('modalTitle');
    const modalMessage = document.getElementById('modalMessage');
    const modalInputWrap = document.getElementById('modalInputWrap');
    const modalInput = document.getElementById('modalInput');
    const modalCancelBtn = document.getElementById('modalCancelBtn');
    const modalOkBtn = document.getElementById('modalOkBtn');
    
    if (!modalTitle || !modalMessage || !modalCancelBtn || !modalOkBtn) {
      console.error('Modal elementleri bulunamadÄ±!');
      resolve(false);
      return;
    }
    
    modalTitle.textContent = title;
    modalMessage.textContent = message;
    
    // Prompt iÃ§in input gÃ¶ster
    if (type === 'prompt') {
      modalInputWrap.style.display = 'block';
      modalInput.value = defaultValue;
      setTimeout(() => modalInput.focus(), 100);
    } else {
      modalInputWrap.style.display = 'none';
    }
    
    // Alert iÃ§in sadece Tamam butonu
    if (type === 'alert') {
      modalCancelBtn.style.display = 'none';
      modalOkBtn.textContent = 'Tamam';
    } else {
      modalCancelBtn.style.display = 'inline-flex';
      modalOkBtn.textContent = type === 'prompt' ? 'Tamam' : 'Evet';
    }
    
    // Body scroll'u engelle
    document.body.style.overflow = 'hidden';
    
    modal.classList.add('show');
  });
}

function closeCustomModal() {
  const modal = document.getElementById('customModal');
  if (!modal) return;
  
  // Modal'Ä± kapat
  modal.classList.remove('show');
  
  // Body scroll'u geri aÃ§ (kÄ±sa bir gecikme ile transition'Ä±n bitmesini bekle)
  setTimeout(() => {
    // EÄŸer baÅŸka bir modal aÃ§Ä±k deÄŸilse scroll'u geri aÃ§
    const anyModalOpen = document.querySelector('.modal.show');
    if (!anyModalOpen) {
      document.body.style.overflow = '';
    }
  }, 250);
  
  if (modalResolve) {
    if (modalType === 'prompt') {
      modalResolve(null); // Ä°ptal edildi
    } else {
      modalResolve(false); // Ä°ptal edildi
    }
    modalResolve = null;
  }
}

function confirmCustomModal() {
  const modal = document.getElementById('customModal');
  if (!modal) return;
  
  // Modal'Ä± kapat
  modal.classList.remove('show');
  
  // Body scroll'u geri aÃ§ (kÄ±sa bir gecikme ile transition'Ä±n bitmesini bekle)
  setTimeout(() => {
    // EÄŸer baÅŸka bir modal aÃ§Ä±k deÄŸilse scroll'u geri aÃ§
    const anyModalOpen = document.querySelector('.modal.show');
    if (!anyModalOpen) {
      document.body.style.overflow = '';
    }
  }, 250);
  
  if (modalResolve) {
    if (modalType === 'prompt') {
      const modalInput = document.getElementById('modalInput');
      const value = modalInput ? modalInput.value : '';
      modalResolve(value);
    } else {
      modalResolve(true);
    }
    modalResolve = null;
  }
}

// Enter tuÅŸu ile onaylama
document.addEventListener('DOMContentLoaded', () => {
  const modalInput = document.getElementById('modalInput');
  if (modalInput) {
    modalInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        confirmCustomModal();
      }
    });
  }
  
  // ESC tuÅŸu ile kapatma
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      // Ã–nce toplamaDuzenleModal'Ä± kontrol et
      const toplamaModal = document.getElementById('toplamaDuzenleModal');
      if (toplamaModal && toplamaModal.classList.contains('show')) {
        toplamaDuzenleKapat();
        return;
      }
      // Sonra customModal'Ä± kontrol et
      const customModal = document.getElementById('customModal');
      if (customModal && customModal.classList.contains('show')) {
        closeCustomModal();
      }
    }
  });
  
  // Modal arka planÄ±na tÄ±klanÄ±nca kapatma - customModal
  const customModal = document.getElementById('customModal');
  if (customModal) {
    customModal.addEventListener('click', (e) => {
      // EÄŸer tÄ±klama modal'Ä±n kendisine (arka plan) yapÄ±ldÄ±ysa kapat
      if (e.target === customModal) {
        closeCustomModal();
      }
    });
    
    // Modal iÃ§eriÄŸine tÄ±klanÄ±nca kapanmasÄ±nÄ± engelle
    const modalSheet = customModal.querySelector('.sheet');
    if (modalSheet) {
      modalSheet.addEventListener('click', (e) => {
        e.stopPropagation();
      });
    }
  }
  
  // Modal arka planÄ±na tÄ±klanÄ±nca kapatma - toplamaDuzenleModal
  const toplamaDuzenleModal = document.getElementById('toplamaDuzenleModal');
  if (toplamaDuzenleModal) {
    toplamaDuzenleModal.addEventListener('click', (e) => {
      // EÄŸer tÄ±klama modal'Ä±n kendisine (arka plan) yapÄ±ldÄ±ysa kapat
      if (e.target === toplamaDuzenleModal) {
        toplamaDuzenleKapat();
      }
    });
    
    // Modal iÃ§eriÄŸine tÄ±klanÄ±nca kapanmasÄ±nÄ± engelle
    const modalIcerik = toplamaDuzenleModal.querySelector('.modal-icerik');
    if (modalIcerik) {
      modalIcerik.addEventListener('click', (e) => {
        e.stopPropagation();
      });
    }
  }
});

// TarayÄ±cÄ± fonksiyonlarÄ±nÄ± override et
window.customConfirm = async (message) => {
  return await showCustomModal('Onay', message, 'confirm');
};

window.customPrompt = async (message, defaultValue = '') => {
  return await showCustomModal('GiriÅŸ', message, 'prompt', defaultValue);
};

window.customAlert = async (message) => {
  await showCustomModal('Bilgi', message, 'alert');
};

const userAgent = navigator.userAgent || '';
const cihazTipi = ()=> (window.innerWidth<700?'mobile':(window.innerWidth<960?'tablet':'desktop'));
const tsISO = ()=> new Date().toISOString();
// norm deÄŸiÅŸkeni ortak.js'de tanÄ±mlÄ± olabilir, kontrol et
if (typeof window.norm === 'undefined') {
  window.norm = (s)=> String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
}

// Toast fonksiyonu - ortak.js'deki showToast kullan
function toast(msg, type = 'info') {
  if (typeof showToast === 'function') {
    showToast(type, '', msg);
  } else {
    console.log(msg);
  }
}

// EÄŸer escapeHtml tanÄ±mlÄ± deÄŸilse (ortak.js yÃ¼klenemediyse) window Ã¼zerine tanÄ±mla
if (typeof escapeHtml === 'undefined') {
  window.escapeHtml = (text) => {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  };
}

/* ===== Personel Listesi ===== */
const personeller = [
  "Muhsin Ã‡elik","Faruk Nafiz Ã–zgan","Ä°brahim Ay","Samet Ã‡akÄ±r",
  "Kerem KocaoÄŸlu","Serhan Durak","Mahmut Solmaz","Mehmet Taha Keskin","Ahmetali Emre Åahin"
];
function fillPersonelSelect(id){ 
  const el=document.getElementById(id); 
  if(!el) return; 
  
  // Mevcut ilk seÃ§eneÄŸi (genellikle "TÃ¼mÃ¼") koru
  const firstOption = el.querySelector('option[value=""]');
  const firstOptionHTML = firstOption ? firstOption.outerHTML : '';
  
  // Personel listesini oluÅŸtur
  const personelOptions = personeller.map(p=>`<option value="${p}">${p}</option>`).join('');
  
  // Ä°lk seÃ§eneÄŸi koruyarak iÃ§eriÄŸi gÃ¼ncelle
  if(firstOptionHTML) {
    el.innerHTML = firstOptionHTML + personelOptions;
  } else {
    el.innerHTML = personelOptions;
  }
}
fillPersonelSelect('zimmetPersonel');

/* ===== Auth & Init ===== */
let currentUser = null;

/* ===== Ä°lk YÃ¼kleme ===== */
async function initOnce(){
  try {
    await guncelleKayitOnizleme();
    guncelleKayitPreview();
    await yukleZimmetlenmemisNumaralar();
    guncelleZimmetPreview();
    await renderCokluZimmetListesi();
  } catch(e) {
    console.error('Ä°lk yÃ¼kleme hatasÄ±:', e);
  }
}

// Auth kontrolÃ¼ ortak.js'deki initAppShellAuth tarafÄ±ndan yapÄ±lacak
// Sayfa yÃ¼klendiÄŸinde mevcut kullanÄ±cÄ±yÄ± al
document.addEventListener('DOMContentLoaded', async () => {
  // ===== UI BAÅLATMA (VeritabanÄ±ndan baÄŸÄ±msÄ±z - Ã–NCE Ã‡ALIÅMALI) =====
  // Ãœst Tabs baÅŸlatma
  try {
    initTabs();
  } catch (e) {
    console.error('Tab baÅŸlatma hatasÄ±:', e);
  }
  
  // Alt Tabs baÅŸlatma
  try {
    initAltTabs();
  } catch (e) {
    console.error('Alt tab baÅŸlatma hatasÄ±:', e);
  }
  
  // Event listener'larÄ± baÅŸlat
  try {
    initKayitEventListeners();
    initZimmetEventListeners();
    initZimmetPreviewListeners();
    initCokluZimmetListeners();
    initDuzenleEventListeners();
    initToplamaEventListeners();
    initToplamaDuzenleEventListeners();
    initDashboardEventListeners();
    console.log('TÃ¼m event listener\'lar baÅŸlatÄ±ldÄ±');
  } catch (e) {
    console.error('Event listener baÅŸlatma hatasÄ±:', e);
  }
  
  // ===== VERÄ°TABANI BAÄLANTISI (UI'dan sonra) =====
  // Supabase client'Ä±n yÃ¼klendiÄŸinden emin ol
  let retries = 0;
  const maxRetries = 50;
  while (!window.supabase && retries < maxRetries) {
    await new Promise(resolve => setTimeout(resolve, 100));
    retries++;
  }
  
  if (!window.supabase) {
    console.error('Supabase client yÃ¼klenemedi!');
    toast('Supabase baÄŸlantÄ±sÄ± kurulamadÄ±. SayfayÄ± yenileyin.', 'error');
    // UI zaten baÅŸlatÄ±ldÄ±, sadece veritabanÄ± iÅŸlemleri yapÄ±lamayacak
    return;
  }
  
  const sb = getSupabase();
  if (!sb) {
    // UI zaten baÅŸlatÄ±ldÄ±, sadece veritabanÄ± iÅŸlemleri yapÄ±lamayacak
    return;
  }
  
  try {
    const { data: { session }, error: sessionError } = await sb.auth.getSession();
    if (sessionError) {
      console.error('Session hatasÄ±:', sessionError);
    } else if (session?.user) {
      currentUser = session.user;
      console.log('KullanÄ±cÄ± yÃ¼klendi:', currentUser.email);
    }
  } catch (e) {
    console.error('Auth kontrolÃ¼ hatasÄ±:', e);
  }
  
  // initAppShellAuth zaten ortak.js'de Ã§alÄ±ÅŸÄ±yor
  // Sayfa Ã¶zel init fonksiyonu
  if (typeof window.initPage === 'function') {
    await window.initPage();
  }
  
  // Ä°lk veri yÃ¼kleme (veritabanÄ± baÄŸlantÄ±sÄ± gerektirir)
  try {
    await initOnce();
  } catch (e) {
    console.error('Ä°lk yÃ¼kleme hatasÄ±:', e);
  }
});

/* ===== Ãœst Tabs ===== */
function initTabs(){
  const tabs=document.querySelectorAll('#mainTabs .mini-tab');
  if(tabs.length === 0) {
    console.warn('Tab\'lar bulunamadÄ±');
    return;
  }
  
  const sections = {
    'kayitWrap': document.getElementById('kayitWrap'),
    'zimmetWrap': document.getElementById('zimmetWrap'),
    'toplamaWrap': document.getElementById('toplamaWrap'),
    'duzenleWrap': document.getElementById('duzenleWrap'),
    'dashboardWrap': document.getElementById('dashboardWrap')
  };
  
  // Section'larÄ±n varlÄ±ÄŸÄ±nÄ± kontrol et
  Object.keys(sections).forEach(key => {
    if (!sections[key]) {
      console.warn(`Section bulunamadÄ±: ${key}`);
    }
  });
  
  // Ä°lk yÃ¼klemede sadece ilk sekme gÃ¶rÃ¼nÃ¼r
  Object.values(sections).forEach((sec, idx) => {
    if (sec) {
      if (idx === 0) {
        sec.style.display = 'block';
      } else {
        sec.style.display = 'none';
      }
    }
  });
  
  tabs.forEach(t=>{
    t.addEventListener('click',(e)=>{
      e.preventDefault();
      e.stopPropagation();
      
      tabs.forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      const target=t.dataset.target;
      
      if(!target) {
        console.warn('Tab target bulunamadÄ±:', t);
        return;
      }
      
      // TÃ¼m section'larÄ± gizle
      Object.values(sections).forEach(sec => {
        if (sec) sec.style.display = 'none';
      });
      
      // SeÃ§ili section'Ä± gÃ¶ster
      if (sections[target]) {
        sections[target].style.display = 'block';
        console.log(`Tab aÃ§Ä±ldÄ±: ${target}`);
      } else {
        console.warn(`Section bulunamadÄ±: ${target}`);
      }
      
      // Dashboard aÃ§Ä±ldÄ±ÄŸÄ±nda otomatik yÃ¼kle
      if(target==='dashboardWrap'){
        setTimeout(()=>{
          const btn = document.getElementById('btnDashboardYukle');
          if (btn) {
            btn.click();
          }
        }, 100);
      }
    });
  });
  
  console.log('Tab sistemi baÅŸlatÄ±ldÄ±, toplam tab:', tabs.length);
}

/* ===== DÃ¼zenle Alt Tabs ===== */
function initAltTabs(){
  const tabs=document.querySelectorAll('#duzenleWrap .mini-tabs .mini-tab');
  if(tabs.length === 0) return; // Tab'lar yoksa Ã§Ä±k
  tabs.forEach(t=>t.addEventListener('click',()=>{
    tabs.forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    const target=t.dataset.target;
    const kayitDiv = document.getElementById('duzenle-kayit');
    const zimmetDiv = document.getElementById('duzenle-zimmet');
    if(kayitDiv) kayitDiv.style.display = (target==='duzenle-kayit')?'':'none';
    if(zimmetDiv) zimmetDiv.style.display = (target==='duzenle-zimmet')?'':'none';
  }));
}

/* ===== GiriÅŸ Tipi SeÃ§imi ===== */
function initGirisTip(containerId, tekFormId, cokluFormId){
  const container = document.getElementById(containerId);
  const tekForm = document.getElementById(tekFormId);
  const cokluForm = document.getElementById(cokluFormId);
  if(!container) return;
  
  container.addEventListener('click', (e)=>{
    const btn = e.target.closest('.giris-tip-btn');
    if(!btn) return;
    container.querySelectorAll('.giris-tip-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const tip = btn.dataset.tip;
    if(tip === 'tek'){
      tekForm.style.display = 'grid';
      cokluForm.style.display = 'none';
    } else {
      tekForm.style.display = 'none';
      cokluForm.style.display = 'grid';
    }
  });
}
initGirisTip('zimmetGirisTip', 'zimmetTekForm', 'zimmetCokluForm');

/* ===== Kumbara KayÄ±t - Numara KontrolÃ¼ ve Ã–nizleme ===== */
let KAYITLI_NUMARALAR = { kumbara: new Set(), sadaka: new Set() };

async function yukleKayitliNumaralar(tur){
  try{
    const sb = getSupabase();
    if (!sb) {
      throw new Error('Supabase client yÃ¼klenmedi');
    }
    
    const { data, error } = await sb
      .from('kumbaralar')
      .select('numara')
      .eq('tur', tur);
    
    if (error) {
      console.error('Supabase sorgu hatasÄ±:', error);
      throw error;
    }
    
    KAYITLI_NUMARALAR[tur] = new Set();
    if (data && Array.isArray(data)) {
      data.forEach(row => {
        const numara = row.numara;
        if(typeof numara === 'number') {
          KAYITLI_NUMARALAR[tur].add(numara);
        }
      });
      console.log(`${tur} tÃ¼rÃ¼ iÃ§in ${KAYITLI_NUMARALAR[tur].size} numara yÃ¼klendi`);
    }
  }catch(e){
    console.error('Numaralar yÃ¼klenemedi:', e);
    toast('Numaralar yÃ¼klenemedi: ' + (e.message || e), 'error');
    KAYITLI_NUMARALAR[tur] = new Set();
  }
}

async function guncelleKayitOnizleme(){
  const tur = document.getElementById('kayitTur').value;
  const onizlemeBox = document.getElementById('kayitOnizleme');
  
  if(!tur){
    onizlemeBox.innerHTML = '<div class="muted">TÃ¼r seÃ§iniz...</div>';
    return;
  }

  await yukleKayitliNumaralar(tur);
  const kayitli = Array.from(KAYITLI_NUMARALAR[tur]).sort((a,b)=>a-b);
  
  if(kayitli.length === 0){
    onizlemeBox.innerHTML = '<div class="muted">Bu tÃ¼rden henÃ¼z kayÄ±t yok.</div>';
  } else {
    const html = kayitli.map(n=>`<span class="numara-badge kayitli">${n}</span>`).join('');
    onizlemeBox.innerHTML = `<div class="numara-list">${html}</div>`;
  }
}

function hesaplaNumaraAraligi(){
  const tur = document.getElementById('kayitTur').value;
  const adet = parseInt(document.getElementById('kayitAdet').value) || 0;
  const baslangic = parseInt(document.getElementById('kayitBaslangic').value) || 0;
  const bitis = parseInt(document.getElementById('kayitBitis').value) || 0;
  
  if(!tur || !adet || !baslangic) return null;
  
  const gercekBitis = bitis || (baslangic + adet - 1);
  const numaralar = [];
  const cakisanlar = [];
  
  for(let i = baslangic; i <= gercekBitis; i++){
    numaralar.push(i);
    if(KAYITLI_NUMARALAR[tur].has(i)){
      cakisanlar.push(i);
    }
  }
  
  return { numaralar, cakisanlar, baslangic, gercekBitis };
}

function guncelleKayitPreview(){
  const tur = document.getElementById('kayitTur').value;
  const adet = parseInt(document.getElementById('kayitAdet').value) || 0;
  const baslangic = parseInt(document.getElementById('kayitBaslangic').value) || 0;
  const bitis = parseInt(document.getElementById('kayitBitis').value) || 0;
  
  const preview = document.getElementById('kayitPreview');
  
  if(!tur || !adet || !baslangic){
    preview.textContent = 'Ã–nizleme â€” TÃ¼m alanlarÄ± doldurunuz.';
    return;
  }
  
  const hesaplama = hesaplaNumaraAraligi();
  if(!hesaplama){
    preview.textContent = 'Ã–nizleme â€” Hesaplama yapÄ±lamadÄ±.';
    return;
  }
  
  const { numaralar, cakisanlar, baslangic: bas, gercekBitis: bit } = hesaplama;
  
  if(cakisanlar.length > 0){
    preview.innerHTML = `âš ï¸ <strong>UYARI:</strong> ${cakisanlar.length} numara zaten kayÄ±tlÄ±: ${cakisanlar.join(', ')}. Bu numaralar atlanacak veya deÄŸiÅŸtirilecek.`;
    preview.style.color = 'var(--danger)';
  } else {
    preview.textContent = `Ã–nizleme â€” ${bas}-${bit} arasÄ± ${numaralar.length} adet ${tur} kaydedilecek.`;
    preview.style.color = 'var(--muted)';
  }
}

// Event listener'larÄ± DOMContentLoaded iÃ§inde baÄŸla
function initKayitEventListeners(){
  const kayitTur = document.getElementById('kayitTur');
  if(kayitTur) {
    kayitTur.addEventListener('change', async ()=>{
      await guncelleKayitOnizleme();
      guncelleKayitPreview();
    });
  }
  
  ['kayitAdet','kayitBaslangic','kayitBitis'].forEach(id=>{
    const el = document.getElementById(id);
    if(el) {
      el.addEventListener('input', guncelleKayitPreview);
    }
  });
  
  const btnKayitOnizlemeYenile = document.getElementById('btnKayitOnizlemeYenile');
  if(btnKayitOnizlemeYenile) {
    btnKayitOnizlemeYenile.addEventListener('click', async ()=>{
      await guncelleKayitOnizleme();
      guncelleKayitPreview();
    });
  }
  
  const btnKayitKaydet = document.getElementById('btnKayitKaydet');
  if(btnKayitKaydet) {
    btnKayitKaydet.addEventListener('click', async ()=>{
  const tur = document.getElementById('kayitTur').value;
  const adet = parseInt(document.getElementById('kayitAdet').value) || 0;
  const baslangic = parseInt(document.getElementById('kayitBaslangic').value) || 0;
  const bitis = parseInt(document.getElementById('kayitBitis').value) || 0;
  
  if(!tur || !adet || !baslangic){
    toast('TÃ¼r, adet ve baÅŸlangÄ±Ã§ numarasÄ± zorunludur.');
    return;
  }
  
  const hesaplama = hesaplaNumaraAraligi();
  if(!hesaplama){
    toast('Numara aralÄ±ÄŸÄ± hesaplanamadÄ±.');
    return;
  }
  
  const { numaralar, cakisanlar } = hesaplama;
  const kaydedilecekler = numaralar.filter(n=>!cakisanlar.includes(n));
  
  if(kaydedilecekler.length === 0){
    toast('TÃ¼m numaralar zaten kayÄ±tlÄ±. FarklÄ± bir aralÄ±k seÃ§iniz.');
    return;
  }
  
  if(cakisanlar.length > 0){
    const confirmed = await window.customConfirm(`${cakisanlar.length} numara zaten kayÄ±tlÄ± (${cakisanlar.join(', ')}). DiÄŸer ${kaydedilecekler.length} numarayÄ± kaydetmek istiyor musunuz?`);
    if(!confirmed){
      return;
    }
  }
  
  try{
    const sb = getSupabase();
    if (!sb) throw new Error('Supabase client yÃ¼klenmedi');
    const { data: { session } } = await sb.auth.getSession();
    const userId = session?.user?.id || null;
    const userEmail = session?.user?.email || null;
    
    // Her numara iÃ§in ayrÄ± insert
    const inserts = kaydedilecekler.map(numara => ({
      tur: tur,
      numara: numara,
      zimmetli: false,
      zimmetlipersonel: null,
      zimmettarihi: null,
      kayittarihi: tsISO(),
      createdat: tsISO(),
      createdby: userEmail,
      uid: userId,
      useragent: userAgent,
      cihaz: cihazTipi()
    }));
    
    const { error } = await sb
      .from('kumbaralar')
      .insert(inserts);
    
    if (error) throw error;
    
    toast(`âœ… ${kaydedilecekler.length} adet ${tur} kaydedildi.`, 'success');
    
    // Formu temizle
    document.getElementById('kayitAdet').value = '';
    document.getElementById('kayitBaslangic').value = '';
    document.getElementById('kayitBitis').value = '';
    
    await guncelleKayitOnizleme();
    guncelleKayitPreview();
  }catch(e){
    console.error(e);
    toast('KayÄ±t sÄ±rasÄ±nda hata oluÅŸtu: ' + (e.message || e), 'error');
  }
    });
  }
}

/* ===== Kumbara Zimmetleme - Liste YÃ¼kleme ===== */
async function yukleZimmetlenmemisNumaralar(){
  const tur = document.getElementById('zimmetTur')?.value;
  const select = document.getElementById('zimmetNumara');
  
  if(!select) {
    console.error('Zimmet numara select elementi bulunamadÄ±');
    return;
  }
  
  if(!tur){
    select.innerHTML = '<option value="">TÃ¼r seÃ§iniz...</option>';
    return;
  }
  
  try{
    const sb = getSupabase();
    if (!sb) {
      throw new Error('Supabase client yÃ¼klenmedi');
    }
    
    const { data, error } = await sb
      .from('kumbaralar')
      .select('numara')
      .eq('tur', tur)
      .eq('zimmetli', false);
    
    if (error) {
      console.error('Supabase sorgu hatasÄ±:', error);
      throw error;
    }
    
    if(!data || !Array.isArray(data) || data.length === 0){
      select.innerHTML = '<option value="">ZimmetlenmemiÅŸ numara bulunamadÄ±.</option>';
      return;
    }
    
    // NumaralarÄ± topla ve sÄ±rala
    const numaralar = [];
    data.forEach(row => {
      const numara = row.numara;
      if(typeof numara === 'number'){
        numaralar.push(numara);
      }
    });
    
    // SÄ±rala
    numaralar.sort((a,b)=>a-b);
    
    select.innerHTML = '';
    numaralar.forEach(numara=>{
      const option = document.createElement('option');
      option.value = numara;
      option.textContent = `Numara: ${numara}`;
      select.appendChild(option);
    });
    
    console.log(`${tur} tÃ¼rÃ¼ iÃ§in ${numaralar.length} zimmetlenmemiÅŸ numara yÃ¼klendi`);
  }catch(e){
    console.error('Numaralar yÃ¼klenemedi:', e);
    select.innerHTML = '<option value="">Hata: Numaralar yÃ¼klenemedi. ' + (e.message || e) + '</option>';
  }
}

function initZimmetEventListeners(){
  const zimmetTur = document.getElementById('zimmetTur');
  if(zimmetTur) {
    zimmetTur.addEventListener('change', yukleZimmetlenmemisNumaralar);
  }
  
  const btnZimmetListeYenile = document.getElementById('btnZimmetListeYenile');
  if(btnZimmetListeYenile) {
    btnZimmetListeYenile.addEventListener('click', yukleZimmetlenmemisNumaralar);
  }
}

function guncelleZimmetPreview(){
  const tur = document.getElementById('zimmetTur').value;
  const numara = document.getElementById('zimmetNumara').value;
  const personel = document.getElementById('zimmetPersonel').value;
  const preview = document.getElementById('zimmetPreview');
  
  if(!tur || !numara || !personel){
    preview.textContent = 'Ã–nizleme â€” TÃ¼m alanlarÄ± doldurunuz.';
    return;
  }
  
  preview.textContent = `Ã–nizleme â€” ${tur} numara ${numara} â†’ ${personel} zimmetlenecek.`;
}

function initZimmetPreviewListeners(){
  ['zimmetTur','zimmetNumara','zimmetPersonel'].forEach(id=>{
    const el = document.getElementById(id);
    if(el) {
      el.addEventListener('change', guncelleZimmetPreview);
    }
  });
  
  const btnZimmetKaydet = document.getElementById('btnZimmetKaydet');
  if(btnZimmetKaydet) {
    btnZimmetKaydet.addEventListener('click', async ()=>{
  const tur = document.getElementById('zimmetTur').value;
  const numara = parseInt(document.getElementById('zimmetNumara').value);
  const personel = document.getElementById('zimmetPersonel').value;
  
  if(!tur || !numara || !personel){
    toast('TÃ¼r, numara ve personel seÃ§imi zorunludur.');
    return;
  }
  
  try{
    const sb = getSupabase();
    if (!sb) throw new Error('Supabase client yÃ¼klenmedi');
    const { data: { session } } = await sb.auth.getSession();
    const userEmail = session?.user?.email || null;
    
    // Ã–nce numarayÄ± bul
    const { data: kumbaraData, error: findError } = await sb
      .from('kumbaralar')
      .select('id')
      .eq('tur', tur)
      .eq('numara', numara)
      .eq('zimmetli', false)
      .limit(1)
      .single();
    
    if(findError || !kumbaraData){
      toast('Bu numara bulunamadÄ± veya zaten zimmetli.', 'error');
      await yukleZimmetlenmemisNumaralar();
      return;
    }
    
    const { error: updateError } = await sb
      .from('kumbaralar')
      .update({
        zimmetli: true,
        zimmetlipersonel: personel,
        zimmettarihi: tsISO(),
        updatedat: tsISO(),
        updatedby: userEmail
      })
      .eq('id', kumbaraData.id);
    
    if (updateError) throw updateError;
    
    toast(`âœ… ${tur} numara ${numara} â†’ ${personel} zimmetlendi.`, 'success');
    
    // Listeyi yenile
    await yukleZimmetlenmemisNumaralar();
    guncelleZimmetPreview();
  }catch(e){
    console.error(e);
    toast('Zimmetleme sÄ±rasÄ±nda hata oluÅŸtu: ' + (e.message || e), 'error');
  }
    });
  }
}

/* ===== Ã‡oklu Zimmetleme ===== */
let cokluZimmetListesi = [];
let cokluZimmetCounter = 0;

function cokluZimmetItemOlustur(){
  const id = `coklu-zimmet-${++cokluZimmetCounter}`;
  const item = {
    id: id,
    tur: 'kumbara',
    numaralar: [], // Array olarak tutulacak
    personel: ''
  };
  cokluZimmetListesi.push(item);
  renderCokluZimmetListesi();
  return item;
}

async function renderCokluZimmetListesi(){
  const container = document.getElementById('cokluZimmetListesi');
  if(!container) return;
  
  if(cokluZimmetListesi.length === 0){
    container.innerHTML = '<div class="muted">HenÃ¼z zimmet eklenmedi.</div>';
    return;
  }
  
  // Her item iÃ§in zimmetlenmemiÅŸ numaralarÄ± yÃ¼kle
  const html = await Promise.all(cokluZimmetListesi.map(async (item, idx)=>{
    const tur = item.tur || 'kumbara';
    let numaraOptions = '<option value="">YÃ¼kleniyor...</option>';
    
    try{
      const sb = getSupabase();
    if (!sb) throw new Error('Supabase client yÃ¼klenmedi');
    const { data, error } = await sb
        .from('kumbaralar')
        .select('numara')
        .eq('tur', tur)
        .eq('zimmetli', false);
      
      if (error) throw error;
      
      if(data && data.length > 0){
        const numaralar = [];
        data.forEach(row => {
          const n = row.numara;
          if(typeof n === 'number'){
            numaralar.push(n);
          }
        });
        numaralar.sort((a,b)=>a-b);
        
        const seciliNumaralar = Array.isArray(item.numaralar) ? item.numaralar : [];
        numaraOptions = numaralar.map(n=>`<option value="${n}" ${seciliNumaralar.includes(n)?'selected':''}>Numara: ${n}</option>`).join('');
      } else {
        numaraOptions = '<option value="">ZimmetlenmemiÅŸ numara yok</option>';
      }
    }catch(e){
      numaraOptions = '<option value="">Hata: ' + (e.message || e) + '</option>';
    }
    
    return `
      <div class="coklu-item" data-id="${item.id}">
        <div class="coklu-item-header">
          <div class="coklu-item-title">Zimmet ${idx + 1}</div>
          <button class="btn btn-ghost coklu-item-remove" onclick="cokluZimmetSil('${item.id}')" style="padding:4px 8px; min-width:auto">âœ–</button>
        </div>
        <div class="row">
          <div class="col-4 field">
            <label>Kumbara TÃ¼rÃ¼</label>
            <select class="coklu-zimmet-tur" data-id="${item.id}">
              <option value="kumbara" ${item.tur==='kumbara'?'selected':''}>Kumbara</option>
              <option value="sadaka" ${item.tur==='sadaka'?'selected':''}>Sadaka</option>
            </select>
          </div>
          <div class="col-4 field">
            <label>Numara(lar) - Ã‡oklu seÃ§im iÃ§in Ctrl/Cmd tuÅŸu ile</label>
            <select class="coklu-zimmet-numara" data-id="${item.id}" multiple size="6" style="height:auto; min-height:120px;">
              ${numaraOptions}
            </select>
            <div class="hint" style="margin-top:4px">SeÃ§ili: <span class="coklu-zimmet-secilen-${item.id}">0</span> numara</div>
          </div>
          <div class="col-4 field">
            <label>Personel</label>
            <select class="coklu-zimmet-personel" data-id="${item.id}">
              ${personeller.map(p=>`<option value="${p}" ${item.personel===p?'selected':''}>${p}</option>`).join('')}
            </select>
          </div>
        </div>
      </div>
    `;
  }));
  
  container.innerHTML = html.join('');
  
  // Event listener'larÄ± ekle
  container.querySelectorAll('.coklu-zimmet-tur, .coklu-zimmet-personel').forEach(el=>{
    el.addEventListener('change', async (e)=>{
      const itemId = e.target.dataset.id;
      const item = cokluZimmetListesi.find(i=>i.id === itemId);
      if(!item) return;
      
      if(e.target.classList.contains('coklu-zimmet-tur')){
        item.tur = e.target.value;
        item.numaralar = []; // TÃ¼r deÄŸiÅŸince numaralarÄ± sÄ±fÄ±rla
        await renderCokluZimmetListesi(); // Listeyi yeniden yÃ¼kle
      }
      if(e.target.classList.contains('coklu-zimmet-personel')) item.personel = e.target.value;
    });
  });
  
  // Multi-select iÃ§in Ã¶zel event listener
  container.querySelectorAll('.coklu-zimmet-numara').forEach(el=>{
    el.addEventListener('change', (e)=>{
      const itemId = e.target.dataset.id;
      const item = cokluZimmetListesi.find(i=>i.id === itemId);
      if(!item) return;
      
      const selected = Array.from(e.target.selectedOptions).map(opt=>parseInt(opt.value)).filter(n=>!isNaN(n));
      item.numaralar = selected;
      
      // SeÃ§ili sayÄ±sÄ±nÄ± gÃ¼ncelle
      const sayac = container.querySelector(`.coklu-zimmet-secilen-${itemId}`);
      if(sayac) sayac.textContent = selected.length;
    });
    
    // Ä°lk yÃ¼klemede seÃ§ili sayÄ±sÄ±nÄ± gÃ¶ster
    const itemId = el.dataset.id;
    const item = cokluZimmetListesi.find(i=>i.id === itemId);
    if(item){
      const sayac = container.querySelector(`.coklu-zimmet-secilen-${itemId}`);
      if(sayac) sayac.textContent = (Array.isArray(item.numaralar) ? item.numaralar.length : 0);
    }
  });
}

window.cokluZimmetSil = function(id){
  cokluZimmetListesi = cokluZimmetListesi.filter(i=>i.id !== id);
  renderCokluZimmetListesi();
}

function initCokluZimmetListeners(){
  const btnCokluZimmetEkle = document.getElementById('btnCokluZimmetEkle');
  if(btnCokluZimmetEkle) {
    btnCokluZimmetEkle.addEventListener('click', ()=>{
      cokluZimmetItemOlustur();
    });
  }
  
  const btnCokluZimmetKaydet = document.getElementById('btnCokluZimmetKaydet');
  if(btnCokluZimmetKaydet) {
    btnCokluZimmetKaydet.addEventListener('click', async ()=>{
  if(cokluZimmetListesi.length === 0){
    toast('Zimmet ekleyiniz.');
    return;
  }
  
  // Validasyon
  for(const item of cokluZimmetListesi){
    if(!item.tur || !item.personel){
      toast(`Zimmet ${cokluZimmetListesi.indexOf(item) + 1}: TÃ¼r ve personel seÃ§imi zorunlu.`);
      return;
    }
    if(!Array.isArray(item.numaralar) || item.numaralar.length === 0){
      toast(`Zimmet ${cokluZimmetListesi.indexOf(item) + 1}: En az bir numara seÃ§iniz.`);
      return;
    }
  }
  
  try{
    const sb = getSupabase();
    if (!sb) throw new Error('Supabase client yÃ¼klenmedi');
    const { data: { session } } = await sb.auth.getSession();
    const userEmail = session?.user?.email || null;
    
    let basarili = 0, hatali = 0;
    
    for(const item of cokluZimmetListesi){
      // Her numara iÃ§in ayrÄ± ayrÄ± zimmetle
      for(const numara of item.numaralar){
        try{
          const { data: kumbaraData, error: findError } = await sb
            .from('kumbaralar')
            .select('id')
            .eq('tur', item.tur)
            .eq('numara', numara)
            .eq('zimmetli', false)
            .limit(1)
            .single();
          
          if(findError || !kumbaraData){
            hatali++;
            continue;
          }
          
          const { error: updateError } = await sb
            .from('kumbaralar')
            .update({
              zimmetli: true,
              zimmetlipersonel: item.personel,
              zimmettarihi: tsISO(),
              updatedat: tsISO(),
              updatedby: userEmail
            })
            .eq('id', kumbaraData.id);
          
          if (updateError) throw updateError;
          
          basarili++;
        }catch(e){
          console.error('Zimmet hatasÄ±:', e);
          hatali++;
        }
      }
    }
    
    if(basarili > 0){
      toast(`âœ… ${basarili} adet zimmet kaydedildi.${hatali>0?` ${hatali} adet baÅŸarÄ±sÄ±z.`:''}`, 'success');
    } else {
      toast('HiÃ§bir zimmet kaydedilemedi.', 'error');
    }
    
    cokluZimmetListesi = [];
    await renderCokluZimmetListesi();
    await yukleZimmetlenmemisNumaralar();
    guncelleZimmetPreview();
  }catch(e){
    console.error(e);
    toast('Zimmetleme sÄ±rasÄ±nda hata oluÅŸtu: ' + (e.message || e), 'error');
  }
    });
  }
}

/* ===== DÃ¼zenle & Ayarlar - Personel Listesi ===== */
fillPersonelSelect('duzenleZimmetPersonel');

/* ===== DÃ¼zenle & Ayarlar - Kumbara KayÄ±tlarÄ± ===== */
function initDuzenleEventListeners(){
  const btnDuzenleKayitYukle = document.getElementById('btnDuzenleKayitYukle');
  if(btnDuzenleKayitYukle) {
    btnDuzenleKayitYukle.addEventListener('click', async ()=>{
      const tur = document.getElementById('duzenleKayitTur').value;
      const container = document.getElementById('duzenleKayitListe');
      
      // Buton geri bildirimi
      const originalText = btnDuzenleKayitYukle.textContent;
      const originalDisabled = btnDuzenleKayitYukle.disabled;
      try {
        btnDuzenleKayitYukle.disabled = true;
        btnDuzenleKayitYukle.textContent = 'YÃ¼kleniyor...';
        
        container.innerHTML = '<div class="muted" style="padding:12px">YÃ¼kleniyor...</div>';
        
        const sb = getSupabase();
        if (!sb) throw new Error('Supabase client yÃ¼klenmedi');
        let query = sb.from('kumbaralar').select('id, tur, numara, zimmetli, zimmetlipersonel, kayittarihi');
        if(tur) query = query.eq('tur', tur);
    
        const { data, error } = await query;
    
        if (error) throw error;
    
        if(!data || data.length === 0){
          container.innerHTML = '<div class="muted" style="padding:12px">KayÄ±t bulunamadÄ±.</div>';
          return;
        }
    
    // SÄ±ralama state'i
    let sortState = { key: null, dir: 'asc' };
    
    // SÄ±ralama fonksiyonu
    function sortTable(key) {
      if(sortState.key === key) {
        sortState.dir = sortState.dir === 'asc' ? 'desc' : 'asc';
      } else {
        sortState.key = key;
        sortState.dir = 'asc';
      }
      renderDuzenleKayitTable(data, sortState);
    }
    
    function renderDuzenleKayitTable(data, sortState) {
      const container = document.getElementById('duzenleKayitListe');
      let sortedData = [...data];
      
      if(sortState.key) {
        sortedData.sort((a,b)=>{
          let valA = a[sortState.key];
          let valB = b[sortState.key];
          
          if(sortState.key === 'numara') {
            valA = valA || 0;
            valB = valB || 0;
          } else if(typeof valA === 'string') {
            valA = valA.toLowerCase();
            valB = valB ? valB.toLowerCase() : '';
          }
          
          if(sortState.dir === 'asc') {
            return valA > valB ? 1 : (valA < valB ? -1 : 0);
          } else {
            return valA < valB ? 1 : (valA > valB ? -1 : 0);
          }
        });
      } else {
        // VarsayÄ±lan: numara sÄ±ralamasÄ±
        sortedData.sort((a,b)=>{
          const numA = a.numara || 0;
          const numB = b.numara || 0;
          return numA - numB;
        });
      }
      
      const sortIcon = (key) => {
        if(sortState.key !== key) return ' â†•ï¸';
        return sortState.dir === 'asc' ? ' â†‘' : ' â†“';
      };
      
      let html = `
        <table class="table">
          <thead>
            <tr>
              <th class="sortable" data-key="tur" style="cursor:pointer">TÃ¼r${sortIcon('tur')}</th>
              <th class="sortable" data-key="numara" style="cursor:pointer">Numara${sortIcon('numara')}</th>
              <th class="sortable" data-key="zimmetli" style="cursor:pointer">Zimmetli${sortIcon('zimmetli')}</th>
              <th class="sortable" data-key="zimmetlipersonel" style="cursor:pointer">Personel${sortIcon('zimmetlipersonel')}</th>
              <th class="sortable" data-key="kayittarihi" style="cursor:pointer">KayÄ±t Tarihi${sortIcon('kayittarihi')}</th>
              <th>Ä°ÅŸlem</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      sortedData.forEach(doc=>{
        const kayitTarihi = doc.kayittarihi ? new Date(doc.kayittarihi).toLocaleString('tr-TR') : '-';
        const zimmetBadge = doc.zimmetli 
          ? '<span class="badge success">Zimmetli</span>' 
          : '<span class="badge">ZimmetlenmemiÅŸ</span>';
        html += `
          <tr data-id="${doc.id}">
            <td style="vertical-align:middle"><span class="pill">${escapeHtml(doc.tur || '-')}</span></td>
            <td style="vertical-align:middle"><strong>#${doc.numara || '-'}</strong></td>
            <td style="vertical-align:middle">${zimmetBadge}</td>
            <td style="vertical-align:middle">${escapeHtml(doc.zimmetlipersonel || '-')}</td>
            <td style="vertical-align:middle"><span class="muted">${kayitTarihi}</span></td>
            <td style="vertical-align:middle">
              <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
                <button class="table-action-btn btn-edit duzenle-kayit-btn" data-id="${doc.id}">âœï¸ DÃ¼zenle</button>
                <button class="table-action-btn btn-delete sil-kayit-btn" data-id="${doc.id}">ğŸ—‘ï¸ Sil</button>
              </div>
            </td>
          </tr>
        `;
      });
      
      html += '</tbody></table>';
      container.innerHTML = html;
      
      // SÄ±ralama event listener'larÄ±
      container.querySelectorAll('.sortable').forEach(th=>{
        th.addEventListener('click', ()=>{
          const key = th.dataset.key;
          sortTable(key);
        });
      });
      
      // Event listener'lar
      container.querySelectorAll('.duzenle-kayit-btn').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          const id = e.target.dataset.id;
          duzenleKayitAc(id);
        });
      });
      
      container.querySelectorAll('.sil-kayit-btn').forEach(btn=>{
        btn.addEventListener('click', async (e)=>{
          const id = e.target.dataset.id;
          const confirmed = await window.customConfirm('Bu kaydÄ± silmek istediÄŸinize emin misiniz?');
          if(confirmed){
            await silKayit(id);
          }
        });
      });
    }
    
    renderDuzenleKayitTable(data, sortState);
      } catch(e) {
        console.error(e);
        container.innerHTML = '<div class="muted" style="padding:12px">Hata: ' + e.message + '</div>';
      } finally {
        // Buton geri bildirimini geri al
        btnDuzenleKayitYukle.disabled = originalDisabled;
        btnDuzenleKayitYukle.textContent = originalText;
      }
    });
  }
  
  const btnDuzenleZimmetYukle = document.getElementById('btnDuzenleZimmetYukle');
  if(btnDuzenleZimmetYukle) {
    btnDuzenleZimmetYukle.addEventListener('click', async ()=>{
      const tur = document.getElementById('duzenleZimmetTur').value;
      const personel = document.getElementById('duzenleZimmetPersonel').value;
      const container = document.getElementById('duzenleZimmetListe');
      
      container.innerHTML = '<div class="muted" style="padding:12px">YÃ¼kleniyor...</div>';
      
      try{
        const sb = getSupabase();
        if (!sb) throw new Error('Supabase client yÃ¼klenmedi');
        let query = sb.from('kumbaralar').select('id, tur, numara, zimmetlipersonel, zimmettarihi').eq('zimmetli', true);
        if(tur) query = query.eq('tur', tur);
        if(personel) query = query.eq('zimmetlipersonel', personel);
        
        const { data, error } = await query;
        
        if (error) throw error;
        
        if(!data || data.length === 0){
          container.innerHTML = '<div class="muted" style="padding:12px">KayÄ±t bulunamadÄ±.</div>';
          return;
        }
        
        // SÄ±ralama state'i
        let sortStateZimmet = { key: null, dir: 'asc' };
        
        function sortZimmetTable(key) {
          if(sortStateZimmet.key === key) {
            sortStateZimmet.dir = sortStateZimmet.dir === 'asc' ? 'desc' : 'asc';
          } else {
            sortStateZimmet.key = key;
            sortStateZimmet.dir = 'asc';
          }
          renderDuzenleZimmetTable(data, sortStateZimmet);
        }
        
        function renderDuzenleZimmetTable(data, sortState) {
          const container = document.getElementById('duzenleZimmetListe');
          let sortedData = [...data];
          
          if(sortState.key) {
            sortedData.sort((a,b)=>{
              let valA = a[sortState.key];
              let valB = b[sortState.key];
              
              if(sortState.key === 'numara') {
                valA = valA || 0;
                valB = valB || 0;
              } else if(typeof valA === 'string') {
                valA = valA.toLowerCase();
                valB = valB ? valB.toLowerCase() : '';
              }
              
              if(sortState.dir === 'asc') {
                return valA > valB ? 1 : (valA < valB ? -1 : 0);
              } else {
                return valA < valB ? 1 : (valA > valB ? -1 : 0);
              }
            });
          } else {
            sortedData.sort((a,b)=>{
              const numA = a.numara || 0;
              const numB = b.numara || 0;
              return numA - numB;
            });
          }
          
          const sortIcon = (key) => {
            if(sortState.key !== key) return ' â†•ï¸';
            return sortState.dir === 'asc' ? ' â†‘' : ' â†“';
          };
          
          let html = `
            <table class="table">
              <thead>
                <tr>
                  <th class="sortable" data-key="tur" style="cursor:pointer">TÃ¼r${sortIcon('tur')}</th>
                  <th class="sortable" data-key="numara" style="cursor:pointer">Numara${sortIcon('numara')}</th>
                  <th class="sortable" data-key="zimmetlipersonel" style="cursor:pointer">Personel${sortIcon('zimmetlipersonel')}</th>
                  <th class="sortable" data-key="zimmettarihi" style="cursor:pointer">Zimmet Tarihi${sortIcon('zimmettarihi')}</th>
                  <th>Ä°ÅŸlem</th>
                </tr>
              </thead>
              <tbody>
          `;
          
          sortedData.forEach(doc=>{
            const zimmetTarihi = doc.zimmettarihi ? new Date(doc.zimmettarihi).toLocaleString('tr-TR') : '-';
            html += `
              <tr data-id="${doc.id}">
                <td style="vertical-align:middle"><span class="pill">${escapeHtml(doc.tur || '-')}</span></td>
                <td style="vertical-align:middle"><strong>#${doc.numara || '-'}</strong></td>
                <td style="vertical-align:middle">${escapeHtml(doc.zimmetlipersonel || '-')}</td>
                <td style="vertical-align:middle"><span class="muted">${zimmetTarihi}</span></td>
                <td style="vertical-align:middle">
                  <div style="display:flex; gap:8px; flex-wrap:wrap; align-items:center;">
                    <button class="table-action-btn btn-edit duzenle-zimmet-btn" data-id="${doc.id}">âœï¸ DÃ¼zenle</button>
                    <button class="table-action-btn btn-cancel iptal-zimmet-btn" data-id="${doc.id}">â†©ï¸ Ä°ptal Et</button>
                  </div>
                </td>
              </tr>
            `;
          });
          
          html += '</tbody></table>';
          container.innerHTML = html;
          
          // SÄ±ralama event listener'larÄ±
          container.querySelectorAll('.sortable').forEach(th=>{
            th.addEventListener('click', ()=>{
              const key = th.dataset.key;
              sortZimmetTable(key);
            });
          });
          
          // Event listener'lar
          container.querySelectorAll('.duzenle-zimmet-btn').forEach(btn=>{
            btn.addEventListener('click', (e)=>{
              const id = e.target.dataset.id;
              duzenleZimmetAc(id);
            });
          });
          
          container.querySelectorAll('.iptal-zimmet-btn').forEach(btn=>{
            btn.addEventListener('click', async (e)=>{
              const id = e.target.dataset.id;
              const confirmed = await window.customConfirm('Zimmeti iptal etmek istediÄŸinize emin misiniz?');
              if(confirmed){
                await iptalZimmet(id);
              }
            });
          });
        }
        
        renderDuzenleZimmetTable(data, sortStateZimmet);
      }catch(e){
        console.error(e);
        container.innerHTML = '<div class="muted" style="padding:12px">Hata: ' + e.message + '</div>';
      }
    });
  }
}

async function duzenleKayitAc(docId){
  try{
    const sb = getSupabase();
    if (!sb) throw new Error('Supabase client yÃ¼klenmedi');
    const { data: { session } } = await sb.auth.getSession();
    const userEmail = session?.user?.email || null;
    
    const { data, error: fetchError } = await sb
      .from('kumbaralar')
      .select('id, tur, numara')
      .eq('id', docId)
      .single();
    
    if(fetchError || !data){
      toast('KayÄ±t bulunamadÄ±.', 'error');
      return;
    }
    
    const yeniTur = await window.customPrompt('Yeni TÃ¼r (kumbara/sadaka):', data.tur || 'kumbara');
    if(!yeniTur) return;
    
    const yeniNumara = await window.customPrompt('Yeni Numara:', data.numara || '');
    if(!yeniNumara || isNaN(yeniNumara)){
      toast('GeÃ§erli bir numara giriniz.', 'error');
      return;
    }
    
    const { error: updateError } = await sb
      .from('kumbaralar')
      .update({
        tur: yeniTur,
        numara: parseInt(yeniNumara),
        updatedat: tsISO(),
        updatedby: userEmail
      })
      .eq('id', docId);
    
    if (updateError) throw updateError;
    
    toast('âœ… KayÄ±t gÃ¼ncellendi.', 'success');
    document.getElementById('btnDuzenleKayitYukle').click();
  }catch(e){
    console.error(e);
    toast('GÃ¼ncelleme hatasÄ±: ' + (e.message || e), 'error');
  }
}

async function silKayit(docId){
  try{
    const sb = getSupabase();
    if (!sb) throw new Error('Supabase client yÃ¼klenmedi');
    const { error } = await sb
      .from('kumbaralar')
      .delete()
      .eq('id', docId);
    
    if (error) throw error;
    
    toast('âœ… KayÄ±t silindi.', 'success');
    document.getElementById('btnDuzenleKayitYukle').click();
  }catch(e){
    console.error(e);
    toast('Silme hatasÄ±: ' + (e.message || e), 'error');
  }
}

/* ===== DÃ¼zenle & Ayarlar - Zimmetleme KayÄ±tlarÄ± ===== */
// Bu fonksiyon initDuzenleEventListeners iÃ§inde Ã§aÄŸrÄ±lÄ±yor

async function duzenleZimmetAc(docId){
  try{
    const sb = getSupabase();
    if (!sb) throw new Error('Supabase client yÃ¼klenmedi');
    const { data: { session } } = await sb.auth.getSession();
    const userEmail = session?.user?.email || null;
    
    const { data, error: fetchError } = await sb
      .from('kumbaralar')
      .select('id, zimmetlipersonel')
      .eq('id', docId)
      .single();
    
    if(fetchError || !data){
      toast('KayÄ±t bulunamadÄ±.', 'error');
      return;
    }
    
    const yeniPersonel = await window.customPrompt('Yeni Personel:', data.zimmetlipersonel || '');
    if(!yeniPersonel){
      toast('Personel adÄ± boÅŸ olamaz.', 'error');
      return;
    }
    
    const { error: updateError } = await sb
      .from('kumbaralar')
      .update({
        zimmetlipersonel: yeniPersonel,
        updatedat: tsISO(),
        updatedby: userEmail
      })
      .eq('id', docId);
    
    if (updateError) throw updateError;
    
    toast('âœ… Zimmet gÃ¼ncellendi.', 'success');
    document.getElementById('btnDuzenleZimmetYukle').click();
  }catch(e){
    console.error(e);
    toast('GÃ¼ncelleme hatasÄ±: ' + (e.message || e), 'error');
  }
}

async function iptalZimmet(docId){
  try{
    const sb = getSupabase();
    if (!sb) throw new Error('Supabase client yÃ¼klenmedi');
    const { data: { session } } = await sb.auth.getSession();
    const userEmail = session?.user?.email || null;
    
    const { error } = await sb
      .from('kumbaralar')
      .update({
        zimmetli: false,
        zimmetlipersonel: null,
        zimmettarihi: null,
        updatedat: tsISO(),
        updatedby: userEmail
      })
      .eq('id', docId);
    
    if (error) throw error;
    
    toast('âœ… Zimmet iptal edildi.', 'success');
    document.getElementById('btnDuzenleZimmetYukle').click();
  }catch(e){
    console.error(e);
    toast('Ä°ptal hatasÄ±: ' + (e.message || e), 'error');
  }
}

/* ===== Toplama Takibi ===== */
function initToplamaEventListeners(){
  const btnToplamaYukle = document.getElementById('btnToplamaYukle');
  if(btnToplamaYukle) {
    btnToplamaYukle.addEventListener('click', async ()=>{
      const tur = document.getElementById('toplamaTur').value;
      const durum = document.getElementById('toplamaDurum').value;
      const container = document.getElementById('toplamaListe');
      
      // Buton geri bildirimi
      const originalText = btnToplamaYukle.textContent;
      const originalDisabled = btnToplamaYukle.disabled;
      try {
        btnToplamaYukle.disabled = true;
        btnToplamaYukle.textContent = 'YÃ¼kleniyor...';
        
        container.innerHTML = '<div class="muted" style="padding:12px">YÃ¼kleniyor...</div>';
        
        const sb = getSupabase();
        if (!sb) throw new Error('Supabase client yÃ¼klenmedi');
        
        // TÃ¼m gerekli alanlarÄ± seÃ§
        let query = sb.from('kumbaralar').select('id, tur, numara, zimmetlipersonel, verilenkisiadsoyad, dagitildi, dagitimtarihi, toplandi, toplamatarihi, sayimasamasinda, sayimtarihi, tamamlandi, tamamlanmatarihi, icindencikanmiktar').eq('dagitildi', true);
        if(tur) query = query.eq('tur', tur);
        
        const { data, error } = await query;
        
        if (error) throw error;
        
        if(!data || data.length === 0){
          container.innerHTML = '<div class="muted" style="padding:12px">KayÄ±t bulunamadÄ±.</div>';
          return;
        }
    
    let docs = data;
    
    // Durum filtresi (client-side)
    if(durum){
      if(durum === 'dagitildi'){
        // Sadece daÄŸÄ±tÄ±lanlar (tÃ¼m kayÄ±tlar zaten dagitildi=true olarak filtrelenmiÅŸ)
        docs = docs;
      } else       if(durum === 'toplandi'){
        // Toplananlar
        docs = docs.filter(doc => doc.toplandi === true);
      } else if(durum === 'sayim'){
        // SayÄ±m aÅŸamasÄ±nda olanlar
        docs = docs.filter(doc => doc.sayimasamasinda === true);
      } else if(durum === 'tamamlandi'){
        // Tamamlananlar
        docs = docs.filter(doc => doc.tamamlandi === true);
      }
    }
    
    docs.sort((a,b)=>{
      const numA = a.numara || 0;
      const numB = b.numara || 0;
      return numA - numB;
    });
    
    if(docs.length === 0){
      container.innerHTML = '<div class="muted" style="padding:12px">Filtreye uygun kayÄ±t bulunamadÄ±.</div>';
      return;
    }
    
    // SÄ±ralama state'i (try bloÄŸu dÄ±ÅŸÄ±nda tanÄ±mla)
    let sortStateToplama = { key: null, dir: 'asc' };
    
    function sortToplamaTable(key) {
      if(sortStateToplama.key === key) {
        sortStateToplama.dir = sortStateToplama.dir === 'asc' ? 'desc' : 'asc';
      } else {
        sortStateToplama.key = key;
        sortStateToplama.dir = 'asc';
      }
      renderToplamaTable(docs, sortStateToplama);
    }
    
    function renderToplamaTable(docs, sortState) {
      const container = document.getElementById('toplamaListe');
      let sortedData = [...docs];
      
      if(sortState.key) {
        sortedData.sort((a,b)=>{
          let valA = a[sortState.key];
          let valB = b[sortState.key];
          
          if(sortState.key === 'numara') {
            valA = valA || 0;
            valB = valB || 0;
          } else if(typeof valA === 'string') {
            valA = valA.toLowerCase();
            valB = valB ? valB.toLowerCase() : '';
          }
          
          if(sortState.dir === 'asc') {
            return valA > valB ? 1 : (valA < valB ? -1 : 0);
          } else {
            return valA < valB ? 1 : (valA > valB ? -1 : 0);
          }
        });
      } else {
        sortedData.sort((a,b)=>{
          const numA = a.numara || 0;
          const numB = b.numara || 0;
          return numA - numB;
        });
      }
      
      const sortIcon = (key) => {
        if(sortState.key !== key) return ' â†•ï¸';
        return sortState.dir === 'asc' ? ' â†‘' : ' â†“';
      };
      
      let html = `
        <table class="table">
          <thead>
            <tr>
              <th class="sortable" data-key="tur" style="cursor:pointer">TÃ¼r${sortIcon('tur')}</th>
              <th class="sortable" data-key="numara" style="cursor:pointer">Numara${sortIcon('numara')}</th>
              <th class="sortable" data-key="zimmetlipersonel" style="cursor:pointer">Personel${sortIcon('zimmetlipersonel')}</th>
              <th class="sortable" data-key="verilenkisiadsoyad" style="cursor:pointer">Verilen KiÅŸi${sortIcon('verilenkisiadsoyad')}</th>
              <th>Durum</th>
              <th>Ä°Ã§inden Ã‡Ä±kan Miktar</th>
              <th>Ä°ÅŸlem</th>
              <th>DÃ¼zenle</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      sortedData.forEach(doc=>{
        const turLabel = doc.tur === 'kumbara' ? 'Kumbara' : 'Sadaka';
        
        // Durum badge'i
        let durumBadge = '<span class="badge success">DaÄŸÄ±tÄ±ldÄ±</span>';
        if(doc.tamamlandi === true){
          durumBadge = '<span class="badge badge-blue">TamamlandÄ±</span>';
        } else if(doc.sayimasamasinda === true){
          durumBadge = '<span class="badge badge-orange">SayÄ±m AÅŸamasÄ±nda</span>';
        } else if(doc.toplandi === true){
          durumBadge = '<span class="badge badge-orange">ToplandÄ±</span>';
        }
        
        // Ä°ÅŸlem butonlarÄ±
        let islemButonlari = '';
        if(!doc.toplandi && !doc.sayimasamasinda && !doc.tamamlandi){
          islemButonlari = `<button class="table-action-btn btn-success topla-btn" data-id="${doc.id}">ğŸ“¦ Teslim Al</button>`;
        } else if(doc.toplandi && !doc.sayimasamasinda && !doc.tamamlandi){
          islemButonlari = `<button class="table-action-btn btn-edit sayim-btn" data-id="${doc.id}">ğŸ” SayÄ±ma Al</button>`;
        } else if(doc.sayimasamasinda && !doc.tamamlandi){
          islemButonlari = `<button class="table-action-btn btn-primary miktar-btn" data-id="${doc.id}">ğŸ’° Miktar Gir</button>`;
        }
        
        // Ä°Ã§inden Ã§Ä±kan miktar
        const miktarText = doc.icindencikanmiktar && doc.icindencikanmiktar > 0 
          ? `${doc.icindencikanmiktar.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2})} â‚º`
          : '<span class="muted">-</span>';
        
        html += `
          <tr data-id="${doc.id}">
            <td style="vertical-align:middle"><span class="pill">${escapeHtml(turLabel)}</span></td>
            <td style="vertical-align:middle"><strong>#${doc.numara || '-'}</strong></td>
            <td style="vertical-align:middle">${escapeHtml(doc.zimmetlipersonel || '-')}</td>
            <td style="vertical-align:middle">${escapeHtml(doc.verilenkisiadsoyad || '-')}</td>
            <td style="vertical-align:middle">${durumBadge}</td>
            <td style="vertical-align:middle">${miktarText}</td>
            <td style="vertical-align:middle">${islemButonlari}</td>
            <td style="vertical-align:middle"><button class="table-action-btn btn-edit duzenle-toplama-btn" data-id="${doc.id}">âœï¸ DÃ¼zenle</button></td>
          </tr>
        `;
      });
      
      html += '</tbody></table>';
      container.innerHTML = html;
      
      // SÄ±ralama event listener'larÄ±
      container.querySelectorAll('.sortable').forEach(th=>{
        th.addEventListener('click', ()=>{
          const key = th.dataset.key;
          sortToplamaTable(key);
        });
      });
      
      // Event listener'lar
      container.querySelectorAll('.topla-btn').forEach(btn=>{
        btn.addEventListener('click', async (e)=>{
          const id = e.target.dataset.id;
          const confirmed = await window.customConfirm('Bu kumbara/sadaka kutusunu teslim almak istediÄŸinize emin misiniz?');
          if(confirmed){
            await toplamaTeslimAl(id);
          }
        });
      });
      
      container.querySelectorAll('.sayim-btn').forEach(btn=>{
        btn.addEventListener('click', async (e)=>{
          const id = e.target.dataset.id;
          await toplamaSayimaAl(id);
        });
      });
      
      container.querySelectorAll('.miktar-btn').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          const id = e.target.dataset.id;
          toplamaMiktarGir(id);
        });
      });
      
      container.querySelectorAll('.duzenle-toplama-btn').forEach(btn=>{
        btn.addEventListener('click', (e)=>{
          const id = e.target.dataset.id;
          toplamaDuzenleAc(id);
        });
      });
    }
    
        renderToplamaTable(docs, sortStateToplama);
      } catch(e) {
        console.error(e);
        container.innerHTML = '<div class="muted" style="padding:12px">Hata: ' + e.message + '</div>';
      } finally {
        // Buton geri bildirimini geri al
        btnToplamaYukle.disabled = originalDisabled;
        btnToplamaYukle.textContent = originalText;
      }
    });
  }
}

async function toplamaTeslimAl(docId){
  try{
    const sb = getSupabase();
    if (!sb) throw new Error('Supabase client yÃ¼klenmedi');
    const { data: { session } } = await sb.auth.getSession();
    const userEmail = session?.user?.email || null;
    
    // KullanÄ±cÄ± adÄ±nÄ± al
    let toplayanPersonel = null;
    if (session?.user?.id) {
      const { data: userData } = await sb
        .from('kullanicilar')
        .select('adsoyad')
        .eq('id', session.user.id)
        .single();
      toplayanPersonel = userData?.adsoyad || userEmail || null;
    }
    
    const { error } = await sb
      .from('kumbaralar')
      .update({
        toplandi: true,
        toplamatarihi: tsISO(),
        toplayanpersonel: toplayanPersonel,
        sayimasamasinda: false, // Toplama yapÄ±ldÄ±ÄŸÄ±nda sayÄ±m durumunu sÄ±fÄ±rla
        updatedat: tsISO(),
        updatedby: userEmail
      })
      .eq('id', docId);
    
    if (error) throw error;
    
    toast('âœ… Kumbara teslim alÄ±ndÄ± ve toplandÄ± olarak iÅŸaretlendi.', 'success');
    document.getElementById('btnToplamaYukle').click();
  }catch(e){
    console.error(e);
    toast('Teslim alma hatasÄ±: ' + (e.message || e), 'error');
  }
}

async function toplamaSayimaAl(docId){
  try{
    const sb = getSupabase();
    if (!sb) throw new Error('Supabase client yÃ¼klenmedi');
    const { data: { session } } = await sb.auth.getSession();
    const userEmail = session?.user?.email || null;
    
    const { error } = await sb
      .from('kumbaralar')
      .update({
        sayimasamasinda: true,
        sayimtarihi: tsISO(),
        toplandi: false, // SayÄ±ma geÃ§ildiÄŸinde toplandÄ± durumunu sÄ±fÄ±rla
        updatedat: tsISO(),
        updatedby: userEmail
      })
      .eq('id', docId);
    
    if (error) throw error;
    
    toast('âœ… Kumbara sayÄ±m aÅŸamasÄ±na alÄ±ndÄ±.', 'success');
    document.getElementById('btnToplamaYukle').click();
  }catch(e){
    console.error(e);
    toast('SayÄ±ma alma hatasÄ±: ' + (e.message || e), 'error');
  }
}

async function toplamaMiktarGir(docId){
  const miktar = prompt('Ä°Ã§inden Ã§Ä±kan miktarÄ± giriniz (â‚º):', '');
  if(!miktar || isNaN(parseFloat(miktar))){
    toast('GeÃ§erli bir miktar giriniz.', 'error');
    return;
  }
  
  const miktarNum = parseFloat(miktar);
  if(miktarNum < 0){
    toast('Miktar negatif olamaz.', 'error');
    return;
  }
  
  try{
    const sb = getSupabase();
    if (!sb) throw new Error('Supabase client yÃ¼klenmedi');
    const { data: { session } } = await sb.auth.getSession();
    const userEmail = session?.user?.email || null;
    
    const { error: updateError } = await sb
      .from('kumbaralar')
      .update({
        icindencikanmiktar: miktarNum,
        tamamlandi: true,
        tamamlanmatarihi: tsISO(),
        sayimasamasinda: false, // Miktar girildiÄŸinde sayÄ±m durumunu sÄ±fÄ±rla
        updatedat: tsISO(),
        updatedby: userEmail
      })
      .eq('id', docId);
    
    if (updateError) throw updateError;
    
    toast(`âœ… Miktar kaydedildi: ${miktarNum.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2})} â‚º`, 'success');
    
    // KullanÄ±cÄ±ya bildirim gÃ¶nder (eÄŸer zimmetli personel varsa)
    const { data: kumbaraData } = await sb
      .from('kumbaralar')
      .select('zimmetlipersonel, tur, numara')
      .eq('id', docId)
      .single();
    
    if(kumbaraData && kumbaraData.zimmetlipersonel){
      // Bildirim kaydÄ± oluÅŸtur
      const { error: notifError } = await sb
        .from('bildirimler')
        .insert({
          baslik: 'Kumbara SayÄ±mÄ± TamamlandÄ±',
          icerik: `${kumbaraData.tur === 'kumbara' ? 'Kumbara' : 'Sadaka'} #${kumbaraData.numara} sayÄ±mÄ± tamamlandÄ±. Ä°Ã§inden ${miktarNum} â‚º Ã§Ä±ktÄ±.`,
          tip: 'kisisel',
          gonderici_uid: session?.user?.id || '',
          hedef_uid: null,
          hedef_rol: null
        });
      
      if(notifError) console.error('Bildirim kaydedilemedi:', notifError);
    }
    
    document.getElementById('btnToplamaYukle').click();
  }catch(e){
    console.error(e);
    toast('Miktar kaydedilemedi: ' + (e.message || e), 'error');
  }
}

/* ===== Toplama DÃ¼zenleme Modal ===== */
let duzenleToplamaData = null;

async function toplamaDuzenleAc(docId){
  const modal = document.getElementById('toplamaDuzenleModal');
  if (!modal) {
    console.error('Toplama dÃ¼zenleme modal elementi bulunamadÄ±!');
    return;
  }
  
  document.getElementById('duzenleToplamaId').value = docId;
  
  try{
    const sb = getSupabase();
    if (!sb) throw new Error('Supabase client yÃ¼klenmedi');
    const { data, error } = await sb
      .from('kumbaralar')
      .select('id, tur, numara, zimmetlipersonel, verilenkisiadsoyad, dagitildi, dagitimtarihi, toplandi, toplamatarihi, sayimasamasinda, sayimtarihi, tamamlandi, tamamlanmatarihi, icindencikanmiktar')
      .eq('id', docId)
      .single();
    
    if(error || !data){
      toast('KayÄ±t bulunamadÄ±.', 'error');
      return;
    }
    
    duzenleToplamaData = data;
    const turLabel = duzenleToplamaData.tur === 'kumbara' ? 'Kumbara' : 'Sadaka';
    
    // Bilgi gÃ¶ster
    document.getElementById('duzenleToplamaBilgi').innerHTML = `
      <strong>${escapeHtml(turLabel)} #${duzenleToplamaData.numara || '-'}</strong><br>
      <span class="muted">Personel: ${escapeHtml(duzenleToplamaData.zimmetlipersonel || '-')}</span><br>
      <span class="muted">Verilen KiÅŸi: ${escapeHtml(duzenleToplamaData.verilenkisiadsoyad || '-')}</span>
    `;
    
    // Durum gÃ¶ster
    let durumText = '<span style="padding:4px 8px; border-radius:6px; background:rgba(34,197,94,.15); color:var(--success); font-size:12px">DaÄŸÄ±tÄ±ldÄ±</span>';
    if(duzenleToplamaData.tamamlandi === true){
      durumText = '<span style="padding:4px 8px; border-radius:6px; background:rgba(59,130,246,.15); color:var(--brand); font-size:12px">TamamlandÄ±</span>';
    } else if(duzenleToplamaData.sayimasamasinda === true){
      durumText = '<span style="padding:4px 8px; border-radius:6px; background:rgba(245,158,11,.15); color:#d97706; font-size:12px">SayÄ±m AÅŸamasÄ±nda</span>';
    } else if(duzenleToplamaData.toplandi === true){
      durumText = '<span style="padding:4px 8px; border-radius:6px; background:rgba(245,158,11,.15); color:#d97706; font-size:12px">ToplandÄ±</span>';
    }
    document.getElementById('duzenleToplamaDurum').innerHTML = durumText;
    
    // Miktar gÃ¶ster
    const mevcutMiktar = duzenleToplamaData.icindencikanmiktar || 0;
    document.getElementById('duzenleToplamaMiktar').value = mevcutMiktar > 0 ? mevcutMiktar : '';
    document.getElementById('duzenleToplamaMevcutMiktar').textContent = mevcutMiktar > 0 
      ? `${mevcutMiktar.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2})} â‚º`
      : 'HenÃ¼z miktar girilmemiÅŸ';
    
    // Geri alma butonlarÄ±nÄ± gÃ¶ster/gizle
    document.getElementById('btnGeriAlToplandi').style.display = duzenleToplamaData.toplandi === true ? 'block' : 'none';
    document.getElementById('btnGeriAlSayim').style.display = duzenleToplamaData.sayimasamasinda === true ? 'block' : 'none';
    document.getElementById('btnGeriAlTamamlandi').style.display = duzenleToplamaData.tamamlandi === true ? 'block' : 'none';
    
    // Body scroll'u engelle
    document.body.style.overflow = 'hidden';
    
    // Modal'Ä± gÃ¶ster
    modal.classList.add('show');
  }catch(e){
    console.error(e);
    toast('Veri yÃ¼klenemedi: ' + (e.message || e), 'error');
  }
}

function toplamaDuzenleKapat(){
  const modal = document.getElementById('toplamaDuzenleModal');
  if (!modal) return;
  
  // Modal'Ä± kapat
  modal.classList.remove('show');
  
  // Body scroll'u geri aÃ§ (kÄ±sa bir gecikme ile transition'Ä±n bitmesini bekle)
  setTimeout(() => {
    // EÄŸer baÅŸka bir modal aÃ§Ä±k deÄŸilse scroll'u geri aÃ§
    const anyModalOpen = document.querySelector('.modal.show');
    if (!anyModalOpen) {
      document.body.style.overflow = '';
    }
  }, 250);
  
  duzenleToplamaData = null;
}

// Geri alma butonlarÄ±
function initToplamaDuzenleEventListeners(){
  const btnGeriAlToplandi = document.getElementById('btnGeriAlToplandi');
  if(btnGeriAlToplandi) {
    btnGeriAlToplandi.addEventListener('click', async ()=>{
  const id = document.getElementById('duzenleToplamaId').value;
  const confirmed = await window.customConfirm('ToplandÄ± durumunu geri almak istediÄŸinize emin misiniz? Kumbara "DaÄŸÄ±tÄ±ldÄ±" durumuna dÃ¶necektir.');
  if(!confirmed){
    return;
  }
  
  try{
    const sb = getSupabase();
    if (!sb) throw new Error('Supabase client yÃ¼klenmedi');
    const { data: { session } } = await sb.auth.getSession();
    const userEmail = session?.user?.email || null;
    
    const { error } = await sb
      .from('kumbaralar')
      .update({
        toplandi: false,
        toplamatarihi: null,
        toplayanpersonel: null,
        sayimasamasinda: false,
        sayimtarihi: null,
        tamamlandi: false,
        tamamlanmatarihi: null,
        icindencikanmiktar: null,
        updatedat: tsISO(),
        updatedby: userEmail
      })
      .eq('id', id);
    
    if (error) throw error;
    
    toast('âœ… Durum geri alÄ±ndÄ±. Kumbara "DaÄŸÄ±tÄ±ldÄ±" durumuna dÃ¶ndÃ¼.', 'success');
    toplamaDuzenleKapat();
    document.getElementById('btnToplamaYukle').click();
  }catch(e){
    console.error(e);
    toast('Geri alma hatasÄ±: ' + (e.message || e), 'error');
  }
});

document.getElementById('btnGeriAlSayim').addEventListener('click', async ()=>{
  const id = document.getElementById('duzenleToplamaId').value;
  const confirmed = await window.customConfirm('SayÄ±m durumunu geri almak istediÄŸinize emin misiniz? Kumbara "ToplandÄ±" durumuna dÃ¶necektir.');
  if(!confirmed){
    return;
  }
  
  try{
    const sb = getSupabase();
    if (!sb) throw new Error('Supabase client yÃ¼klenmedi');
    const { data: { session } } = await sb.auth.getSession();
    const userEmail = session?.user?.email || null;
    
    const { error } = await sb
      .from('kumbaralar')
      .update({
        sayimasamasinda: false,
        sayimtarihi: null,
        toplandi: true, // SayÄ±mdan toplandÄ±ya geri dÃ¶n
        updatedat: tsISO(),
        updatedby: userEmail
      })
      .eq('id', id);
    
    if (error) throw error;
    
    toast('âœ… Durum geri alÄ±ndÄ±. Kumbara "ToplandÄ±" durumuna dÃ¶ndÃ¼.', 'success');
    toplamaDuzenleKapat();
    document.getElementById('btnToplamaYukle').click();
  }catch(e){
    console.error(e);
    toast('Geri alma hatasÄ±: ' + (e.message || e), 'error');
  }
    });
  }
  
  const btnGeriAlTamamlandi = document.getElementById('btnGeriAlTamamlandi');
  if(btnGeriAlTamamlandi) {
    btnGeriAlTamamlandi.addEventListener('click', async ()=>{
  const id = document.getElementById('duzenleToplamaId').value;
  const confirmed = await window.customConfirm('TamamlandÄ± durumunu geri almak istediÄŸinize emin misiniz? Kumbara "SayÄ±m AÅŸamasÄ±nda" durumuna dÃ¶necektir. Miktar bilgisi korunacaktÄ±r.');
  if(!confirmed){
    return;
  }
  
  try{
    const sb = getSupabase();
    if (!sb) throw new Error('Supabase client yÃ¼klenmedi');
    const { data: { session } } = await sb.auth.getSession();
    const userEmail = session?.user?.email || null;
    
    const { error } = await sb
      .from('kumbaralar')
      .update({
        tamamlandi: false,
        tamamlanmatarihi: null,
        sayimasamasinda: true, // TamamlandÄ±dan sayÄ±ma geri dÃ¶n (miktar korunur)
        updatedat: tsISO(),
        updatedby: userEmail
      })
      .eq('id', id);
    
    if (error) throw error;
    
    toast('âœ… Durum geri alÄ±ndÄ±. Kumbara "SayÄ±m AÅŸamasÄ±nda" durumuna dÃ¶ndÃ¼. Miktar bilgisi korundu.', 'success');
    toplamaDuzenleKapat();
    document.getElementById('btnToplamaYukle').click();
  }catch(e){
    console.error(e);
    toast('Geri alma hatasÄ±: ' + (e.message || e), 'error');
  }
});

// Miktar kaydet
document.getElementById('btnToplamaDuzenleKaydet').addEventListener('click', async ()=>{
  const id = document.getElementById('duzenleToplamaId').value;
  const miktar = parseFloat(document.getElementById('duzenleToplamaMiktar').value) || 0;
  
  if(miktar < 0){
    toast('Miktar negatif olamaz.', 'error');
    return;
  }
  
  try{
    const sb = getSupabase();
    if (!sb) throw new Error('Supabase client yÃ¼klenmedi');
    const { data: { session } } = await sb.auth.getSession();
    const userEmail = session?.user?.email || null;
    
    const updateData = {
      icindencikanmiktar: miktar > 0 ? miktar : null,
      tamamlandi: miktar > 0 ? true : false,
      tamamlanmatarihi: miktar > 0 ? tsISO() : null,
      sayimasamasinda: false, // Miktar girildiÄŸinde sayÄ±m durumunu sÄ±fÄ±rla
      updatedat: tsISO(),
      updatedby: userEmail
    };
    
    // Bildirim gÃ¶nder (miktar kaydedilemese bile bildirim gÃ¶nderilebilir)
    if(miktar > 0 && duzenleToplamaData && duzenleToplamaData.zimmetlipersonel){
      const { error: notifError } = await sb
        .from('bildirimler')
        .insert({
          baslik: 'Kumbara SayÄ±mÄ± TamamlandÄ±',
          icerik: `${duzenleToplamaData.tur === 'kumbara' ? 'Kumbara' : 'Sadaka'} #${duzenleToplamaData.numara} sayÄ±mÄ± tamamlandÄ±. Ä°Ã§inden ${miktar} â‚º Ã§Ä±ktÄ±.`,
          tip: 'kisisel',
          gonderici_uid: session?.user?.id || '',
          hedef_uid: null,
          hedef_rol: null
        });
      
      if(notifError) console.error('Bildirim kaydedilemedi:', notifError);
    }
    
    const { error } = await sb
      .from('kumbaralar')
      .update(updateData)
      .eq('id', id);
    
    if (error) throw error;
    
    toast(`âœ… Miktar gÃ¼ncellendi: ${miktar > 0 ? miktar + ' â‚º' : 'Temizlendi'}`, 'success');
    toplamaDuzenleKapat();
    document.getElementById('btnToplamaYukle').click();
  }catch(e){
    console.error(e);
    toast('GÃ¼ncelleme hatasÄ±: ' + (e.message || e), 'error');
  }
    });
  }
}

/* ===== Dashboard/Rapor ===== */
let dashboardPersonelList = [];
let dashboardSortState = { key: null, dir: 'asc' };

async function yukleDashboardRapor(){
  const tur = document.getElementById('dashboardTur').value;
  const container = document.getElementById('dashboardRapor');
  const ozetContainer = document.getElementById('dashboardOzet');
  
  container.innerHTML = '<div class="muted" style="padding:12px">YÃ¼kleniyor...</div>';
  ozetContainer.innerHTML = '';
  
  try{
    const sb = getSupabase();
    if (!sb) throw new Error('Supabase client yÃ¼klenmedi');
    let query = sb.from('kumbaralar').select('id, tur, numara, zimmetli, zimmetlipersonel, dagitildi, dagitimtarihi, toplandi, toplamatarihi, sayimasamasinda, tamamlandi, icindencikanmiktar');
    if(tur) query = query.eq('tur', tur);
    
    const { data, error } = await query;
    
    if (error) throw error;
    
    if(!data || data.length === 0){
      container.innerHTML = '<div class="muted" style="padding:12px">KayÄ±t bulunamadÄ±.</div>';
      return;
    }
    
    // Personel bazÄ±nda grupla
    const personelMap = new Map();
    
    data.forEach(row => {
      const personel = row.zimmetlipersonel || 'ZimmetlenmemiÅŸ';
      
      if(!personelMap.has(personel)){
        personelMap.set(personel, {
          personel: personel,
          zimmetlenen: 0,
          dagitilan: 0,
          toplanan: 0,
          toplamMiktar: 0
        });
      }
      
      const stats = personelMap.get(personel);
      
      // Zimmetlenen
      if(row.zimmetli === true){
        stats.zimmetlenen++;
      }
      
      // DaÄŸÄ±tÄ±lan
      if(row.dagitildi === true){
        stats.dagitilan++;
      }
      
      // Toplanan
      if(row.toplandi === true){
        stats.toplanan++;
      }
      
      // Toplam Miktar (sadece tamamlananlar iÃ§in)
      if(row.tamamlandi === true && row.icindencikanmiktar){
        stats.toplamMiktar += Number(row.icindencikanmiktar) || 0;
      }
    });
    
    // Hesaplamalar ekle
    const personelList = Array.from(personelMap.values()).map(p=>{
      const kalan = p.zimmetlenen - p.toplanan;
      const dagitmaNispeti = p.zimmetlenen > 0 ? Math.round((p.dagitilan / p.zimmetlenen) * 100) : 0;
      const toplamaNispeti = p.zimmetlenen > 0 ? Math.round((p.toplanan / p.zimmetlenen) * 100) : 0;
      return {
        ...p,
        kalan: kalan,
        dagitmaNispeti: dagitmaNispeti,
        toplamaNispeti: toplamaNispeti
      };
    });
    
    // Personel listesini sÄ±rala (zimmetlenmemiÅŸ en sonda)
    dashboardPersonelList = personelList.sort((a,b)=>{
      if(a.personel === 'ZimmetlenmemiÅŸ') return 1;
      if(b.personel === 'ZimmetlenmemiÅŸ') return -1;
      return a.personel.localeCompare(b.personel, 'tr-TR');
    });
    
    // Ã–zet kartlarÄ±
    const toplamZimmetlenen = dashboardPersonelList.reduce((sum, p)=>sum + p.zimmetlenen, 0);
    const toplamDagitilan = dashboardPersonelList.reduce((sum, p)=>sum + p.dagitilan, 0);
    const toplamToplanan = dashboardPersonelList.reduce((sum, p)=>sum + p.toplanan, 0);
    const toplamMiktar = dashboardPersonelList.reduce((sum, p)=>sum + p.toplamMiktar, 0);
    
    ozetContainer.innerHTML = `
      <div class="col-3">
        <div style="background:var(--surface2); border:1px solid var(--stroke); border-radius:12px; padding:16px; text-align:center">
          <div style="font-size:24px; font-weight:800; color:var(--brand); margin-bottom:4px">${toplamZimmetlenen}</div>
          <div style="font-size:13px; color:var(--muted)">Toplam Zimmetlenen</div>
        </div>
      </div>
      <div class="col-3">
        <div style="background:var(--surface2); border:1px solid var(--stroke); border-radius:12px; padding:16px; text-align:center">
          <div style="font-size:24px; font-weight:800; color:var(--success); margin-bottom:4px">${toplamDagitilan}</div>
          <div style="font-size:13px; color:var(--muted)">Toplam DaÄŸÄ±tÄ±lan</div>
        </div>
      </div>
      <div class="col-3">
        <div style="background:var(--surface2); border:1px solid var(--stroke); border-radius:12px; padding:16px; text-align:center">
          <div style="font-size:24px; font-weight:800; color:rgba(245,158,11,1); margin-bottom:4px">${toplamToplanan}</div>
          <div style="font-size:13px; color:var(--muted)">Toplam Toplanan</div>
        </div>
      </div>
      <div class="col-3">
        <div style="background:var(--surface2); border:1px solid var(--stroke); border-radius:12px; padding:16px; text-align:center">
          <div style="font-size:24px; font-weight:800; color:var(--brand2); margin-bottom:4px">${toplamMiktar.toLocaleString('tr-TR', {minimumFractionDigits: 0, maximumFractionDigits: 0})} â‚º</div>
          <div style="font-size:13px; color:var(--muted)">Toplam Miktar</div>
        </div>
      </div>
    `;
    
    renderDashboardTable();
    
  }catch(e){
    console.error(e);
    container.innerHTML = '<div class="muted" style="padding:12px">Hata: ' + e.message + '</div>';
  }
}

// Nispet iÃ§in renk hesaplama (kÄ±rmÄ±zÄ±dan yeÅŸile)
function getProgressColor(percent){
  percent = Math.max(0, Math.min(100, percent));
  if(percent <= 50){
    // 0-50: kÄ±rmÄ±zÄ±dan sarÄ±ya
    const ratio = percent / 50;
    const r = Math.round(239 + (245 - 239) * ratio); // 239 -> 245
    const g = Math.round(68 + (158 - 68) * ratio);   // 68 -> 158
    const b = Math.round(68 + (11 - 68) * ratio);     // 68 -> 11
    return `rgb(${r}, ${g}, ${b})`;
  } else {
    // 50-100: sarÄ±dan yeÅŸile
    const ratio = (percent - 50) / 50;
    const r = Math.round(245 + (34 - 245) * ratio);  // 245 -> 34
    const g = Math.round(158 + (197 - 158) * ratio);  // 158 -> 197
    const b = Math.round(11 + (94 - 11) * ratio);      // 11 -> 94
    return `rgb(${r}, ${g}, ${b})`;
  }
}

function renderDashboardTable(){
  const container = document.getElementById('dashboardRapor');
  
  // SÄ±ralama
  if(dashboardSortState.key){
    dashboardPersonelList.sort((a,b)=>{
      let valA = a[dashboardSortState.key];
      let valB = b[dashboardSortState.key];
      
      if(typeof valA === 'string') valA = valA.toLowerCase();
      if(typeof valB === 'string') valB = valB.toLowerCase();
      
      if(dashboardSortState.dir === 'asc'){
        return valA > valB ? 1 : (valA < valB ? -1 : 0);
      } else {
        return valA < valB ? 1 : (valA > valB ? -1 : 0);
      }
    });
  }
  
  // SÃ¼tun gÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼ kontrolÃ¼
  const colVisibility = {
    personel: document.querySelector('.col-toggle[data-col="personel"]')?.checked ?? true,
    zimmetlenen: document.querySelector('.col-toggle[data-col="zimmetlenen"]')?.checked ?? true,
    dagitilan: document.querySelector('.col-toggle[data-col="dagitilan"]')?.checked ?? true,
    dagitmaNispeti: document.querySelector('.col-toggle[data-col="dagitmaNispeti"]')?.checked ?? true,
    toplanan: document.querySelector('.col-toggle[data-col="toplanan"]')?.checked ?? true,
    kalan: document.querySelector('.col-toggle[data-col="kalan"]')?.checked ?? true,
    toplamaNispeti: document.querySelector('.col-toggle[data-col="toplamaNispeti"]')?.checked ?? true,
    miktar: document.querySelector('.col-toggle[data-col="miktar"]')?.checked ?? true
  };
  
  // Tablo oluÅŸtur
  let html = `
    <table class="table" id="dashboardTable">
      <thead>
        <tr>
          ${colVisibility.personel ? `<th class="sortable" data-key="personel" style="text-align:left; cursor:pointer">Personel AdÄ± SoyadÄ±</th>` : ''}
          ${colVisibility.zimmetlenen ? `<th class="sortable" data-key="zimmetlenen" style="text-align:center; cursor:pointer">Zimmetlenen</th>` : ''}
          ${colVisibility.dagitilan ? `<th class="sortable" data-key="dagitilan" style="text-align:center; cursor:pointer">DaÄŸÄ±tÄ±lan</th>` : ''}
          ${colVisibility.dagitmaNispeti ? `<th class="sortable" data-key="dagitmaNispeti" style="text-align:center; cursor:pointer">DaÄŸÄ±tma Nispeti (%)</th>` : ''}
          ${colVisibility.toplanan ? `<th class="sortable" data-key="toplanan" style="text-align:center; cursor:pointer">Toplanan</th>` : ''}
          ${colVisibility.kalan ? `<th class="sortable" data-key="kalan" style="text-align:center; cursor:pointer">Kalan</th>` : ''}
          ${colVisibility.toplamaNispeti ? `<th class="sortable" data-key="toplamaNispeti" style="text-align:center; cursor:pointer">Toplama Nispeti (%)</th>` : ''}
          ${colVisibility.miktar ? `<th class="sortable" data-key="toplamMiktar" style="text-align:right; cursor:pointer">Miktar (â‚º)</th>` : ''}
        </tr>
      </thead>
      <tbody>
  `;
  
  dashboardPersonelList.forEach(p=>{
    const personelAd = p.personel === 'ZimmetlenmemiÅŸ' ? '<span class="muted">ZimmetlenmemiÅŸ</span>' : p.personel;
    const miktarFormat = p.toplamMiktar > 0 ? 
      p.toplamMiktar.toLocaleString('tr-TR', {minimumFractionDigits: 0, maximumFractionDigits: 0}) + ' â‚º' : 
      '<span class="muted">-</span>';
    
    // DaÄŸÄ±tma Nispeti iÃ§in ilerleme Ã§ubuÄŸu
    const dagitmaNispetiColor = getProgressColor(p.dagitmaNispeti);
    const dagitmaNispetiBar = colVisibility.dagitmaNispeti ? `
      <td style="text-align:center; padding:8px 12px; vertical-align:middle">
        <div class="progress-bar-container" style="max-width:180px; margin:0 auto">
          <div class="progress-bar-fill" style="width:${p.dagitmaNispeti}%; background-color:${dagitmaNispetiColor}">
            ${p.dagitmaNispeti > 15 ? `%${p.dagitmaNispeti}` : ''}
          </div>
          <div class="progress-bar-text" style="${p.dagitmaNispeti > 15 ? 'display:none' : ''}">%${p.dagitmaNispeti}</div>
        </div>
      </td>
    ` : '';
    
    // Toplama Nispeti iÃ§in ilerleme Ã§ubuÄŸu
    const toplamaNispetiColor = getProgressColor(p.toplamaNispeti);
    const toplamaNispetiBar = colVisibility.toplamaNispeti ? `
      <td style="text-align:center; padding:8px 12px; vertical-align:middle">
        <div class="progress-bar-container" style="max-width:180px; margin:0 auto">
          <div class="progress-bar-fill" style="width:${p.toplamaNispeti}%; background-color:${toplamaNispetiColor}">
            ${p.toplamaNispeti > 15 ? `%${p.toplamaNispeti}` : ''}
          </div>
          <div class="progress-bar-text" style="${p.toplamaNispeti > 15 ? 'display:none' : ''}">%${p.toplamaNispeti}</div>
        </div>
      </td>
    ` : '';
    
    html += '<tr>';
    if(colVisibility.personel) html += `<td style="vertical-align:middle"><strong>${personelAd}</strong></td>`;
    if(colVisibility.zimmetlenen) html += `<td style="text-align:center; vertical-align:middle"><span class="badge badge-blue">${p.zimmetlenen || 0}</span></td>`;
    if(colVisibility.dagitilan) html += `<td style="text-align:center; vertical-align:middle"><span class="badge success">${p.dagitilan || 0}</span></td>`;
    if(colVisibility.dagitmaNispeti) html += dagitmaNispetiBar;
    if(colVisibility.toplanan) html += `<td style="text-align:center; vertical-align:middle"><span class="badge badge-orange">${p.toplanan || 0}</span></td>`;
    if(colVisibility.kalan) html += `<td style="text-align:center; vertical-align:middle"><span class="badge badge-red">${p.kalan || 0}</span></td>`;
    if(colVisibility.toplamaNispeti) html += toplamaNispetiBar;
    if(colVisibility.miktar) html += `<td style="text-align:right; vertical-align:middle"><strong style="color:var(--brand2)">${miktarFormat}</strong></td>`;
    html += '</tr>';
  });
  
  html += '</tbody></table>';
  container.innerHTML = html;
  
  // SÄ±ralama event listener'larÄ±
  container.querySelectorAll('.sortable').forEach(th=>{
    th.addEventListener('click', ()=>{
      const key = th.dataset.key;
      if(dashboardSortState.key === key){
        dashboardSortState.dir = dashboardSortState.dir === 'asc' ? 'desc' : 'asc';
      } else {
        dashboardSortState.key = key;
        dashboardSortState.dir = 'asc';
      }
      renderDashboardTable();
    });
  });
}

function getSortIcon(key){
  // OklarÄ± gizle, sadece boÅŸ string dÃ¶ndÃ¼r
  return '';
}

// SÃ¼tun gizleme/gÃ¶sterme
document.addEventListener('change', (e)=>{
  if(e.target.classList.contains('col-toggle')){
    renderDashboardTable();
  }
});

/* ===== Dashboard Event Listeners ===== */
function initDashboardEventListeners(){
  const btnDashboardYukle = document.getElementById('btnDashboardYukle');
  const btnDashboardYenile = document.getElementById('btnDashboardYenile');
  
  if(btnDashboardYukle) {
    btnDashboardYukle.addEventListener('click', yukleDashboardRapor);
  }
  
  if(btnDashboardYenile) {
    btnDashboardYenile.addEventListener('click', yukleDashboardRapor);
  }
}
</script>
</body>
</html>

