<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>BÃ¼tÃ§e Planlama Sunumu | KaraaÄŸaÃ§ Fatih</title>
<link rel="icon" type="image/png" href="../img/logo.png" />

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="../js/firebase/firebase-init.js"></script>

<style>
  :root{
    --radius:12px; 
    --shadow:0 2px 8px rgba(0,0,0,.06);
    --shadow-lg:0 8px 24px rgba(0,0,0,.12);
    --bg:#ffffff; 
    --bg2:#f8fafc;
    --card:#ffffff; 
    --stroke:#e5e7eb;
    --text:#111827; 
    --muted:#6b7280;
    --brand:#2563eb; 
    --brand2:#1d4ed8;
    --pill:#f3f4f6; 
    --pill-hover:#e5e7eb;
    --danger:#dc2626; 
    --success:#16a34a; 
    --warn:#ca8a04;
    --transition:all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  }

  *{box-sizing:border-box}
  html,body{height:100%; margin:0; padding:0; overflow:hidden}
  body{
    font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;
    background:var(--bg);
    color:var(--text);
    display:flex;
    font-size:14px;
    line-height:1.5;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
  }

  /* Sol Panel - Kategoriler */
  .sidebar{
    width:300px;
    background:var(--bg2);
    border-right:1px solid var(--stroke);
    overflow-y:auto;
    padding:24px 20px;
    display:flex;
    flex-direction:column;
    gap:16px;
  }

  .sidebar-header{
    margin-bottom:4px;
    padding-bottom:20px;
    border-bottom:1px solid var(--stroke);
  }

  .sidebar-header h2{
    margin:0 0 6px;
    font-size:18px;
    font-weight:700;
    letter-spacing:-0.02em;
    color:var(--text);
  }

  .sidebar-header .muted{
    font-size:12px;
    color:var(--muted);
    font-weight:400;
  }

  .category-card{
    background:var(--card);
    border:1px solid var(--stroke);
    border-radius:var(--radius);
    padding:14px 16px;
    cursor:pointer;
    transition:var(--transition);
    position:relative;
    box-shadow:var(--shadow);
  }

  .category-card:hover{
    background:var(--pill);
    border-color:var(--brand);
    transform:translateY(-1px);
    box-shadow:0 4px 12px rgba(37, 99, 235, 0.1);
  }

  .category-card.active{
    background:var(--brand);
    border-color:var(--brand);
    box-shadow:0 4px 16px rgba(37, 99, 235, 0.25);
  }

  .category-card.active .category-name{
    color:#fff;
    font-weight:600;
  }

  .category-name{
    font-size:15px;
    font-weight:500;
    color:var(--text);
    margin-bottom:4px;
    letter-spacing:-0.01em;
  }

  .category-meta{
    font-size:11px;
    color:var(--muted);
    display:flex;
    gap:12px;
    font-weight:400;
  }

  .category-card.active .category-meta{
    color:rgba(255,255,255,0.85);
  }

  .category-badge{
    position:absolute;
    top:14px;
    right:14px;
    width:6px;
    height:6px;
    border-radius:50%;
    background:var(--muted);
    opacity:0.5;
  }

  .category-card.active .category-badge{
    background:#fff;
    opacity:1;
  }

  /* Ana Sunum AlanÄ± */
  .presentation-area{
    flex:1;
    display:flex;
    flex-direction:column;
    background:var(--bg);
    overflow:hidden;
  }

  .presentation-header{
    padding:28px 40px;
    border-bottom:1px solid var(--stroke);
    background:var(--card);
    box-shadow:0 1px 3px rgba(0,0,0,.05);
  }

  .presentation-header h1{
    margin:0 0 6px;
    font-size:28px;
    font-weight:700;
    letter-spacing:-0.03em;
    color:var(--text);
  }

  .presentation-header .subtitle{
    font-size:14px;
    color:var(--muted);
    font-weight:400;
  }

  .presentation-content{
    flex:1;
    padding:32px 40px;
    overflow-y:auto;
    display:flex;
    flex-direction:column;
    gap:28px;
    background:var(--bg2);
  }

  /* KPI KartlarÄ± */
  .kpi-grid{
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));
    gap:16px;
    margin-bottom:24px;
  }

  .kpi-group{
    margin-bottom:36px;
  }

  .kpi-group-title{
    font-size:16px;
    font-weight:600;
    color:var(--text);
    margin-bottom:20px;
    padding-bottom:12px;
    border-bottom:1px solid var(--stroke);
    letter-spacing:-0.01em;
  }

  .kpi-group-grid{
    display:grid;
    grid-template-columns:repeat(3, 1fr);
    gap:16px;
  }

  @media (max-width: 1200px){
    .kpi-group-grid{
      grid-template-columns:repeat(auto-fit, minmax(200px, 1fr));
    }
  }

  .kpi-card{
    background:var(--card);
    border:1px solid var(--stroke);
    border-radius:var(--radius);
    padding:24px 20px;
    text-align:center;
    box-shadow:var(--shadow);
    transition:var(--transition);
  }

  .kpi-card:hover{
    transform:translateY(-2px);
    box-shadow:0 4px 12px rgba(0,0,0,.1);
  }

  .kpi-label{
    font-size:11px;
    color:var(--muted);
    text-transform:uppercase;
    letter-spacing:0.5px;
    margin-bottom:12px;
    font-weight:500;
  }

  .kpi-value{
    font-size:32px;
    font-weight:700;
    color:var(--text);
    margin-bottom:6px;
    letter-spacing:-0.02em;
    line-height:1.2;
  }

  .kpi-sub{
    font-size:12px;
    color:var(--muted);
    font-weight:400;
  }

  /* Grafik KartlarÄ± */
  .chart-card{
    background:var(--card);
    border:1px solid var(--stroke);
    border-radius:var(--radius);
    padding:28px;
    box-shadow:var(--shadow);
    transition:var(--transition);
  }

  .chart-card:hover{
    box-shadow:0 4px 16px rgba(0,0,0,.08);
  }

  .chart-card h3{
    margin:0 0 20px;
    font-size:16px;
    font-weight:600;
    color:var(--text);
    letter-spacing:-0.01em;
  }

  .chart-container{
    position:relative;
    height:400px;
  }

  /* Kategori AÃ§Ä±klamasÄ± */
  .category-description{
    background:var(--card);
    border-left:3px solid var(--brand);
    border-radius:var(--radius);
    padding:20px 24px;
    margin-bottom:24px;
    box-shadow:var(--shadow);
  }

  .category-description h3{
    margin:0 0 10px;
    font-size:15px;
    font-weight:600;
    color:var(--text);
    letter-spacing:-0.01em;
  }

  .category-description p{
    margin:0;
    line-height:1.6;
    color:var(--muted);
    font-size:14px;
  }

  /* BoÅŸ Durum */
  .empty-state{
    text-align:center;
    padding:80px 20px;
    color:var(--muted);
  }

  .empty-state h2{
    font-size:24px;
    margin-bottom:12px;
  }

  /* --- YENÄ° EKLENEN STÄ°LLER --- */

  /* 1. SimÃ¼lasyon KartÄ± (Koyu Tema) */
  .simulation-card {
    background: linear-gradient(135deg, #1e293b, #0f172a);
    color: white;
    padding: 28px;
    border-radius: var(--radius);
    box-shadow: var(--shadow-lg);
    border: 1px solid #334155;
    margin-bottom: 24px;
  }
  
  .sim-input {
    background: transparent;
    border: none;
    color: white;
    font-size: 24px;
    font-weight: 700;
    width: 80px;
    text-align: right;
    outline: none;
    border-bottom: 2px solid rgba(255,255,255,0.2);
    font-family: inherit;
    transition:var(--transition);
  }
  
  .sim-input:focus {
    border-bottom-color: #60a5fa;
  }

  .sim-btn {
    background: var(--brand);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    font-weight: 500;
    cursor: pointer;
    transition: var(--transition);
    font-size: 14px;
  }
  
  .sim-btn:hover {
    background: var(--brand2);
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(37, 99, 235, 0.3);
  }

  /* 2. Smart Insights (AkÄ±llÄ± Ä°Ã§gÃ¶rÃ¼) KartÄ± */
  .insight-wrapper {
    background: var(--card);
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    margin-bottom: 24px;
    overflow: hidden;
    border: 1px solid var(--stroke);
    position: relative;
    animation: slideDown 0.4s cubic-bezier(0.16, 1, 0.3, 1);
  }

  .insight-header {
    padding: 18px 24px;
    background: var(--bg2);
    border-bottom: 1px solid var(--stroke);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .insight-title {
    font-size: 12px;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--brand);
    display: flex;
    align-items: center;
    gap: 8px;
  }

  .insight-body {
    padding: 24px;
    display: grid;
    grid-template-columns: 72px 1fr;
    gap: 20px;
    align-items: start;
  }

  .insight-score-box {
    width: 72px;
    height: 72px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 28px;
    background: var(--bg2);
    border: 2px solid var(--stroke);
  }

  .insight-content ul {
    margin: 0;
    padding: 0;
    list-style: none;
  }

  .insight-content li {
    margin-bottom: 14px;
    position: relative;
    padding-left: 20px;
    color: var(--text);
    font-size: 14px;
    line-height: 1.6;
  }

  .insight-content li::before {
    content: "â€¢";
    position: absolute;
    left: 4px;
    color: var(--brand);
    font-weight: bold;
    font-size: 18px;
  }

  .insight-tag {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 6px;
    font-size: 10px;
    font-weight: 600;
    text-transform: uppercase;
    margin-right: 6px;
    letter-spacing: 0.3px;
  }

  /* Durum Renkleri */
  .status-success { background: #dcfce7; color: #166534; }
  .status-danger { background: #fee2e2; color: #991b1b; }
  .status-warn { background: #fef3c7; color: #92400e; }
  .status-neutral { background: #f3f4f6; color: #475569; }

  @keyframes slideDown {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Scrollbar */
  .sidebar::-webkit-scrollbar,
  .presentation-content::-webkit-scrollbar{
    width:8px;
  }

  .sidebar::-webkit-scrollbar-track,
  .presentation-content::-webkit-scrollbar-track{
    background:var(--bg2);
  }

  .sidebar::-webkit-scrollbar-thumb,
  .presentation-content::-webkit-scrollbar-thumb{
    background:var(--pill);
    border-radius:4px;
  }

  .sidebar::-webkit-scrollbar-thumb:hover,
  .presentation-content::-webkit-scrollbar-thumb:hover{
    background:var(--pill-hover);
  }

  /* Modal */
  .modal{
    display:none;
    position:fixed;
    top:0;
    left:0;
    right:0;
    bottom:0;
    background:rgba(0,0,0,0.6);
    backdrop-filter:blur(4px);
    z-index:1000;
    align-items:center;
    justify-content:center;
    padding:24px;
    animation:fadeIn 0.2s ease-out;
  }

  @keyframes fadeIn{
    from{opacity:0}
    to{opacity:1}
  }

  .modal-content{
    background:var(--card);
    border-radius:16px;
    box-shadow:0 20px 60px rgba(0,0,0,0.3);
    max-width:1200px;
    width:100%;
    max-height:90vh;
    overflow-y:auto;
    padding:32px;
    animation:slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    border:1px solid var(--stroke);
  }

  @keyframes slideUp{
    from{
      opacity:0;
      transform:translateY(20px) scale(0.95);
    }
    to{
      opacity:1;
      transform:translateY(0) scale(1);
    }
  }

  .modal-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:28px;
    padding-bottom:20px;
    border-bottom:1px solid var(--stroke);
  }

  .modal-header h3{
    margin:0;
    font-size:22px;
    font-weight:700;
    color:var(--text);
    letter-spacing:-0.02em;
  }

  .close-btn{
    background:none;
    border:none;
    font-size:20px;
    cursor:pointer;
    color:var(--muted);
    padding:0;
    width:36px;
    height:36px;
    display:flex;
    align-items:center;
    justify-content:center;
    border-radius:8px;
    transition:var(--transition);
    font-weight:300;
  }

  .close-btn:hover{
    background:var(--pill);
    color:var(--text);
    transform:rotate(90deg);
  }

  .cta{
    background:var(--brand);
    color:#fff;
    border:none;
    padding:10px 20px;
    border-radius:8px;
    font-weight:500;
    font-size:14px;
    cursor:pointer;
    transition:var(--transition);
    box-shadow:0 2px 4px rgba(37, 99, 235, 0.2);
  }

  .cta:hover{
    background:var(--brand2);
    transform:translateY(-1px);
    box-shadow:0 4px 12px rgba(37, 99, 235, 0.3);
  }

  .cta:active{
    transform:translateY(0);
  }
</style>
</head>
<body>

<div class="sidebar">
  <div class="sidebar-header">
    <h2>ğŸ“Š Kategoriler</h2>
    <div class="muted">Sunum iÃ§in kategori seÃ§in</div>
  </div>
  <div id="categoryList">
    <div class="empty-state">
      <div>YÃ¼kleniyor...</div>
    </div>
  </div>
</div>

<div class="presentation-area">
  <div class="presentation-header">
    <div style="display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:16px">
      <div>
        <h1 id="presentationTitle">BÃ¼tÃ§e Planlama Sunumu</h1>
        <div class="subtitle" id="presentationSubtitle">Kategori seÃ§in</div>
      </div>
      <div style="display:flex; gap:12px; flex-wrap:wrap">
        <button class="cta" id="btnBudgetSimulator" style="white-space:nowrap">ğŸš€ 2026 BÃ¼tÃ§e SimÃ¼latÃ¶rÃ¼</button>
        <button class="cta" id="btnRiskAnalysis" style="white-space:nowrap; background:var(--warn); display:none">âš ï¸ Risk Analizi</button>
        <button class="cta" id="btnPrint" style="white-space:nowrap; background:var(--muted); display:none" onclick="openPrintPage()">ğŸ–¨ï¸ YazdÄ±r</button>
      </div>
    </div>
  </div>

  <div class="presentation-content" id="presentationContent">
    <div class="empty-state">
      <h2>ğŸ‘ˆ Sol panelden bir kategori seÃ§in</h2>
      <p>Kategori seÃ§ildiÄŸinde detaylÄ± analiz, yapay zeka iÃ§gÃ¶rÃ¼sÃ¼ ve 2026 simÃ¼lasyonu burada gÃ¶rÃ¼ntÃ¼lenecektir.</p>
    </div>
  </div>
</div>

<!-- 2026 BÃœTÃ‡E SÄ°MÃœLATÃ–RÃœ MODAL -->
<div class="modal" id="budgetSimulatorModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>ğŸš€ 2026 BÃ¼tÃ§e SimÃ¼latÃ¶rÃ¼</h3>
      <button class="close-btn" onclick="closeModal('budgetSimulatorModal')">âœ•</button>
    </div>

    <!-- Ã–zet Bilgiler -->
    <div style="display:grid; grid-template-columns:repeat(4, 1fr); gap:16px; margin-bottom:24px">
      <div class="kpi-card">
        <div class="kpi-label">2024 Gider</div>
        <div class="kpi-value" id="simGider2024">0,00 â‚º</div>
        <div class="kpi-sub" id="simGider2024Yuzde">-</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">2025 Gider</div>
        <div class="kpi-value" id="simGider2025">0,00 â‚º</div>
        <div class="kpi-sub" id="simGider2025Yuzde">-</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">2025 Planlanan Gider</div>
        <div class="kpi-value" id="simPlanGider2025">0,00 â‚º</div>
        <div class="kpi-sub" id="simPlanGider2025Yuzde">-</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">2025 GerÃ§ekleÅŸen Gider</div>
        <div class="kpi-value" id="simGercekGider2025">0,00 â‚º</div>
        <div class="kpi-sub" id="simGercekGider2025Yuzde">-</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">2024 Gelir</div>
        <div class="kpi-value" id="simGelir2024">0,00 â‚º</div>
        <div class="kpi-sub" id="simGelir2024Yuzde">-</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">2025 Gelir</div>
        <div class="kpi-value" id="simGelir2025">0,00 â‚º</div>
        <div class="kpi-sub" id="simGelir2025Yuzde">-</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">2025 Planlanan Gelir</div>
        <div class="kpi-value" id="simPlanGelir2025">0,00 â‚º</div>
        <div class="kpi-sub" id="simPlanGelir2025Yuzde">-</div>
      </div>
      <div class="kpi-card">
        <div class="kpi-label">2025 GerÃ§ekleÅŸen Gelir</div>
        <div class="kpi-value" id="simGercekGelir2025">0,00 â‚º</div>
        <div class="kpi-sub" id="simGercekGelir2025Yuzde">-</div>
      </div>
    </div>

    <!-- Yeni BÃ¼tÃ§e Ekleme Formu -->
    <div class="card" style="margin-bottom:24px; padding:20px">
      <h4 style="margin:0 0 16px">Yeni 2026 BÃ¼tÃ§e PlanÄ± Ekle</h4>
      <div style="display:grid; grid-template-columns:1fr 1fr 1fr auto; gap:12px; align-items:end">
        <div>
          <label style="display:block; margin-bottom:6px; font-size:13px; font-weight:600">Heyet</label>
          <select id="simHeyet" style="width:100%; padding:10px; border:1px solid var(--stroke); border-radius:8px; background:var(--card)">
            <option value="">SeÃ§in...</option>
            <option value="personel">Personel</option>
            <option value="hesap">Hesap Heyeti</option>
          </select>
        </div>
        <div>
          <label style="display:block; margin-bottom:6px; font-size:13px; font-weight:600">Tip</label>
          <select id="simTip" style="width:100%; padding:10px; border:1px solid var(--stroke); border-radius:8px; background:var(--card)">
            <option value="">SeÃ§in...</option>
            <option value="gider">Gider</option>
            <option value="gelir">Gelir</option>
          </select>
        </div>
        <div>
          <label style="display:block; margin-bottom:6px; font-size:13px; font-weight:600">YÃ¼zde ArtÄ±ÅŸ (%)</label>
          <input type="number" id="simArtis" step="0.1" placeholder="45" style="width:100%; padding:10px; border:1px solid var(--stroke); border-radius:8px; background:var(--card)">
        </div>
        <button class="cta" onclick="addBudget2026()" style="white-space:nowrap">â• Ekle</button>
      </div>
    </div>

    <!-- KaydedilmiÅŸ BÃ¼tÃ§eler Listesi -->
    <div>
      <h4 style="margin:0 0 16px">KaydedilmiÅŸ 2026 BÃ¼tÃ§e PlanlarÄ±</h4>
      <div id="savedBudgetsList" style="display:grid; gap:12px">
        <div style="padding:20px; text-align:center; color:var(--muted)">YÃ¼kleniyor...</div>
      </div>
    </div>
  </div>
</div>

<!-- RÄ°SK ANALÄ°ZÄ° MODAL -->
<div class="modal" id="riskAnalysisModal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>âš ï¸ Risk Analizi</h3>
      <button class="close-btn" onclick="closeModal('riskAnalysisModal')">âœ•</button>
    </div>

    <div id="riskAnalysisContent">
      <div style="padding:48px; text-align:center; color:var(--muted); font-size:14px">YÃ¼kleniyor...</div>
    </div>
  </div>
</div>

<script>
  /* Firebase & helpers */
  const db = firebase.firestore();
  const auth = firebase.auth();
  const monthsTR = ["Ocak","Åubat","Mart","Nisan","MayÄ±s","Haziran","Temmuz","AÄŸustos","EylÃ¼l","Ekim","KasÄ±m","AralÄ±k"];
  const fmt = (n) => (Number(n||0)).toLocaleString("tr-TR",{minimumFractionDigits:2, maximumFractionDigits:2}) + " â‚º";
  
  // Veri yapÄ±larÄ±
  let allKategoriler = [];
  let kategoriAciklamalari = {};
  let planlamaData = {};
  let gerceklesenData = {};
  let selectedCategory = null;
  let chartInstances = {};
  let baseAmountForSim = 0; // SimÃ¼lasyon iÃ§in baz tutar
  let altKategorilerData = {}; // {tip: {kategori: [{id, isim, aciklama, tutar}]}}

  // Kategorileri yÃ¼kle
  async function loadKategoriler(){
    try{
      const snap = await db.collection('muhasebe_kategoriler').get();
      allKategoriler = [];
      kategoriAciklamalari = {};
      
      snap.forEach(doc => {
        const d = doc.data();
        allKategoriler.push({
          id: doc.id,
          ad: d.ad || doc.id,
          tip: d.tip || 'gider',
          aciklama: d.aciklama || ''
        });
        if(d.aciklama) kategoriAciklamalari[d.ad || doc.id] = d.aciklama;
      });

      renderCategoryList();
    }catch(e){
      console.error('Kategoriler yÃ¼klenemedi:', e);
    }
  }

  // Alt kategorileri yÃ¼kle
  async function loadAltKategoriler(){
    try{
      const snap = await db.collection('muhasebe_alt_kategoriler').get();
      altKategorilerData = {};
      snap.forEach(doc => {
        const d = doc.data();
        const tip = (d.tip || 'gider').toLowerCase();
        const kategori = d.kategori || '';
        if(!altKategorilerData[tip]) altKategorilerData[tip] = {};
        if(!altKategorilerData[tip][kategori]) altKategorilerData[tip][kategori] = [];
        altKategorilerData[tip][kategori].push({
          id: doc.id,
          isim: d.isim || '',
          aciklama: d.aciklama || '',
          tutar: +(d.tutar || 0),
          siraNo: +(d.siraNo || 999)
        });
      });
    }catch(e){
      console.error('Alt kategoriler yÃ¼klenirken hata:', e);
    }
  }

  // Kategori listesini render et
  function renderCategoryList(){
    const container = document.getElementById('categoryList');
    
    // Genel kategorisi ekle
    let html = '<div style="margin-bottom:20px">';
    html += '<div style="font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:1px; margin-bottom:8px">GENEL</div>';
    html += createCategoryCard({ ad: 'GENEL', tip: 'genel', aciklama: '' }, true);
    html += '</div>';

    if(allKategoriler.length === 0){
      container.innerHTML = html + '<div class="empty-state">Kategori bulunamadÄ±</div>';
      attachCategoryListeners();
      return;
    }

    // Gelir ve Gider olarak ayÄ±r ve A'dan Z'ye sÄ±rala
    const gelirKategoriler = allKategoriler.filter(k => k.tip === 'gelir')
      .sort((a, b) => a.ad.localeCompare(b.ad, 'tr'));
    const giderKategoriler = allKategoriler.filter(k => k.tip === 'gider')
      .sort((a, b) => a.ad.localeCompare(b.ad, 'tr'));

    if(giderKategoriler.length > 0){
      html += '<div style="margin-bottom:16px"><div style="font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:1px; margin-bottom:8px">GÄ°DERLER</div>';
      giderKategoriler.forEach(kat => {
        html += createCategoryCard(kat);
      });
      html += '</div>';
    }

    if(gelirKategoriler.length > 0){
      html += '<div><div style="font-size:11px; color:var(--muted); text-transform:uppercase; letter-spacing:1px; margin-bottom:8px">GELÄ°RLER</div>';
      gelirKategoriler.forEach(kat => {
        html += createCategoryCard(kat);
      });
      html += '</div>';
    }

    container.innerHTML = html;
    attachCategoryListeners();
  }
  
  // Event listener'larÄ± ekle
  function attachCategoryListeners(){
    const container = document.getElementById('categoryList');
    container.querySelectorAll('.category-card').forEach(card => {
      card.addEventListener('click', () => {
        const kategoriAd = card.dataset.kategori;
        const kategoriTip = card.dataset.tip;
        const kategoriKey = card.dataset.key;
        selectCategory(kategoriAd, kategoriTip, kategoriKey);
      });
    });
  }

  // Kategori kartÄ± oluÅŸtur
  function createCategoryCard(kat, isGenel = false){
    const kategoriKey = isGenel ? kat.ad : `${kat.ad}_${kat.tip}`;
    const isActive = selectedCategory === kategoriKey ? 'active' : '';
    const icon = isGenel ? 'ğŸ“Š' : (kat.tip === 'gelir' ? 'ğŸ’° Gelir' : 'ğŸ’¸ Gider');
    return `
      <div class="category-card ${isActive}" data-kategori="${kat.ad}" data-tip="${kat.tip}" data-key="${kategoriKey}">
        <div class="category-badge"></div>
        <div class="category-name">${kat.ad}</div>
        <div class="category-meta">
          <span>${icon}</span>
        </div>
      </div>
    `;
  }

  // Kategori seÃ§
  async function selectCategory(kategoriAd, kategoriTip, kategoriKey){
    selectedCategory = kategoriKey || kategoriAd;
    
    // UI gÃ¼ncelle
    document.querySelectorAll('.category-card').forEach(card => {
      card.classList.remove('active');
      const cardKey = card.dataset.key || card.dataset.kategori;
      if(cardKey === selectedCategory){
        card.classList.add('active');
      }
    });

    // Verileri yÃ¼kle ve sunumu gÃ¶ster
    await loadData();
    await renderPresentation(kategoriAd, kategoriTip);
  }

  // Verileri yÃ¼kle
  async function loadData(){
    try{
      // Planlama verilerini yÃ¼kle
      const planlamaSnap = await db.collection('muhasebe_planlama').get();
      planlamaData = {};
      planlamaSnap.forEach(doc => {
        const d = doc.data();
        const yil = d.yil || 2025;
        const tip = (d.tip || 'gider').toLowerCase();
        const kategori = d.kategori || 'DiÄŸer';
        const planlanan = +(d.planlanan || 0);
        
        if(!planlamaData[yil]) planlamaData[yil] = {};
        if(!planlamaData[yil][tip]) planlamaData[yil][tip] = {};
        planlamaData[yil][tip][kategori] = (planlamaData[yil][tip][kategori] || 0) + planlanan;
      });

      // GerÃ§ekleÅŸen verilerini yÃ¼kle
      const gerceklesenSnap = await db.collection('muhasebe_gerceklesen').get();
      gerceklesenData = {};
      gerceklesenSnap.forEach(doc => {
        const d = doc.data();
        const yil = d.yil || 2024;
        const ay = d.ay || 1;
        const tip = (d.tip || 'gider').toLowerCase();
        const kategori = d.kategori || 'DiÄŸer';
        const gerceklesen = +(d.gerceklesen || 0);
        
        if(!gerceklesenData[yil]) gerceklesenData[yil] = {};
        if(!gerceklesenData[yil][ay]) gerceklesenData[yil][ay] = {};
        if(!gerceklesenData[yil][ay][tip]) gerceklesenData[yil][ay][tip] = {};
        gerceklesenData[yil][ay][tip][kategori] = (gerceklesenData[yil][ay][tip][kategori] || 0) + gerceklesen;
      });
      
      // Alt kategorileri yÃ¼kle
      await loadAltKategoriler();
    }catch(e){
      console.error('Veri yÃ¼klenirken hata:', e);
    }
  }

  // Modal aÃ§/kapa
  function openModal(id){
    document.getElementById(id).style.display = 'flex';
  }

  window.closeModal = function(id){
    document.getElementById(id).style.display = 'none';
  };

  // 2026 BÃ¼tÃ§e SimÃ¼latÃ¶rÃ¼ - Yeni sayfaya yÃ¶nlendir
  function openBudgetSimulator(){
    window.location.href = 'bucesimulatoru.html';
  }

  // SimÃ¼latÃ¶r Ã¶zet bilgilerini gÃ¼ncelle
  async function updateSimulatorSummary(){
    // Toplam giderler
    let gider2024 = 0, gider2025 = 0, planlananGider2025 = 0;
    if(gerceklesenData[2024]){
      Object.keys(gerceklesenData[2024]).forEach(a => {
        if(gerceklesenData[2024][a].gider){
          Object.keys(gerceklesenData[2024][a].gider).forEach(kat => {
            gider2024 += gerceklesenData[2024][a].gider[kat] || 0;
          });
        }
      });
    }
    if(gerceklesenData[2025]){
      Object.keys(gerceklesenData[2025]).forEach(a => {
        if(gerceklesenData[2025][a].gider){
          Object.keys(gerceklesenData[2025][a].gider).forEach(kat => {
            gider2025 += gerceklesenData[2025][a].gider[kat] || 0;
          });
        }
      });
    }
    if(planlamaData[2025] && planlamaData[2025].gider){
      Object.keys(planlamaData[2025].gider).forEach(kat => {
        planlananGider2025 += planlamaData[2025].gider[kat] || 0;
      });
    }

    // Toplam gelirler
    let gelir2024 = 0, gelir2025 = 0, planlananGelir2025 = 0;
    if(gerceklesenData[2024]){
      Object.keys(gerceklesenData[2024]).forEach(a => {
        if(gerceklesenData[2024][a].gelir){
          Object.keys(gerceklesenData[2024][a].gelir).forEach(kat => {
            gelir2024 += gerceklesenData[2024][a].gelir[kat] || 0;
          });
        }
      });
    }
    if(gerceklesenData[2025]){
      Object.keys(gerceklesenData[2025]).forEach(a => {
        if(gerceklesenData[2025][a].gelir){
          Object.keys(gerceklesenData[2025][a].gelir).forEach(kat => {
            gelir2025 += gerceklesenData[2025][a].gelir[kat] || 0;
          });
        }
      });
    }
    if(planlamaData[2025] && planlamaData[2025].gelir){
      Object.keys(planlamaData[2025].gelir).forEach(kat => {
        planlananGelir2025 += planlamaData[2025].gelir[kat] || 0;
      });
    }

    // YÃ¼zdeleri hesapla
    const gider2024Yuzde = gider2024 > 0 ? ((gider2025 - gider2024) / gider2024 * 100).toFixed(1) : '0';
    const gider2025Yuzde = planlananGider2025 > 0 ? ((gider2025 / planlananGider2025) * 100).toFixed(1) : '0';
    const gelir2024Yuzde = gelir2024 > 0 ? ((gelir2025 - gelir2024) / gelir2024 * 100).toFixed(1) : '0';
    const gelir2025Yuzde = planlananGelir2025 > 0 ? ((gelir2025 / planlananGelir2025) * 100).toFixed(1) : '0';

    // GÃ¼ncelle
    document.getElementById('simGider2024').textContent = fmt(gider2024);
    document.getElementById('simGider2024Yuzde').textContent = `${gider2024Yuzde}% (2024â†’2025)`;
    document.getElementById('simGider2025').textContent = fmt(gider2025);
    document.getElementById('simGider2025Yuzde').textContent = `${gider2024Yuzde}% artÄ±ÅŸ`;
    document.getElementById('simPlanGider2025').textContent = fmt(planlananGider2025);
    document.getElementById('simPlanGider2025Yuzde').textContent = 'Planlanan';
    document.getElementById('simGercekGider2025').textContent = fmt(gider2025);
    document.getElementById('simGercekGider2025Yuzde').textContent = `${gider2025Yuzde}% gerÃ§ekleÅŸme`;

    document.getElementById('simGelir2024').textContent = fmt(gelir2024);
    document.getElementById('simGelir2024Yuzde').textContent = `${gelir2024Yuzde}% (2024â†’2025)`;
    document.getElementById('simGelir2025').textContent = fmt(gelir2025);
    document.getElementById('simGelir2025Yuzde').textContent = `${gelir2024Yuzde}% artÄ±ÅŸ`;
    document.getElementById('simPlanGelir2025').textContent = fmt(planlananGelir2025);
    document.getElementById('simPlanGelir2025Yuzde').textContent = 'Planlanan';
    document.getElementById('simGercekGelir2025').textContent = fmt(gelir2025);
    document.getElementById('simGercekGelir2025Yuzde').textContent = `${gelir2025Yuzde}% gerÃ§ekleÅŸme`;
  }

  // 2026 BÃ¼tÃ§e Ekle
  window.addBudget2026 = async function(){
    const heyet = document.getElementById('simHeyet').value;
    const tip = document.getElementById('simTip').value;
    const artis = parseFloat(document.getElementById('simArtis').value) || 0;

    if(!heyet || !tip || !artis){
      alert('LÃ¼tfen tÃ¼m alanlarÄ± doldurun!');
      return;
    }

    // 2025 baz tutarÄ±nÄ± al
    let baseAmount = 0;
    if(tip === 'gider'){
      if(gerceklesenData[2025]){
        Object.keys(gerceklesenData[2025]).forEach(a => {
          if(gerceklesenData[2025][a].gider){
            Object.keys(gerceklesenData[2025][a].gider).forEach(kat => {
              baseAmount += gerceklesenData[2025][a].gider[kat] || 0;
            });
          }
        });
      }
    } else {
      if(gerceklesenData[2025]){
        Object.keys(gerceklesenData[2025]).forEach(a => {
          if(gerceklesenData[2025][a].gelir){
            Object.keys(gerceklesenData[2025][a].gelir).forEach(kat => {
              baseAmount += gerceklesenData[2025][a].gelir[kat] || 0;
            });
          }
        });
      }
    }

    const target2026 = baseAmount * (1 + (artis / 100));

    try{
      await db.collection('muhasebe_planlama_2026').add({
        heyet: heyet,
        tip: tip,
        artisYuzde: artis,
        baseAmount: baseAmount,
        targetAmount: target2026,
        yil: 2026,
        olusturmaTarihi: firebase.firestore.FieldValue.serverTimestamp()
      });

      // Formu temizle
      document.getElementById('simHeyet').value = '';
      document.getElementById('simTip').value = '';
      document.getElementById('simArtis').value = '';

      // Listeyi yenile
      await loadSavedBudgets2026();
      alert('2026 bÃ¼tÃ§e planÄ± baÅŸarÄ±yla kaydedildi!');
    }catch(e){
      console.error('Kaydetme hatasÄ±:', e);
      alert('Kaydetme sÄ±rasÄ±nda hata oluÅŸtu: ' + e.message);
    }
  };

  // KaydedilmiÅŸ 2026 bÃ¼tÃ§eleri yÃ¼kle
  async function loadSavedBudgets2026(){
    const container = document.getElementById('savedBudgetsList');
    try{
      const snap = await db.collection('muhasebe_planlama_2026').orderBy('olusturmaTarihi', 'desc').get();
      
      if(snap.empty){
        container.innerHTML = '<div style="padding:40px; text-align:center; color:var(--muted)">HenÃ¼z kaydedilmiÅŸ bÃ¼tÃ§e planÄ± yok</div>';
        return;
      }

      let html = '';
      snap.forEach(doc => {
        const d = doc.data();
        const heyetText = d.heyet === 'personel' ? 'Personel' : 'Hesap Heyeti';
        const tipText = d.tip === 'gider' ? 'Gider' : 'Gelir';
        const tipIcon = d.tip === 'gider' ? 'ğŸ’¸' : 'ğŸ’°';
        
        html += `
          <div class="card" style="padding:16px; display:flex; justify-content:space-between; align-items:center; gap:16px">
            <div style="flex:1">
              <div style="display:flex; gap:12px; align-items:center; margin-bottom:8px">
                <span style="font-size:20px">${tipIcon}</span>
                <div>
                  <div style="font-weight:700; font-size:16px">${heyetText} - ${tipText}</div>
                  <div style="font-size:13px; color:var(--muted)">%${d.artisYuzde} artÄ±ÅŸ â€¢ ${fmt(d.baseAmount)} â†’ ${fmt(d.targetAmount)}</div>
                </div>
              </div>
            </div>
            <div style="display:flex; gap:8px">
              <button onclick="editBudget2026('${doc.id}')" style="padding:8px 16px; background:var(--brand); color:#fff; border:none; border-radius:6px; cursor:pointer; font-size:13px">âœï¸ DÃ¼zenle</button>
              <button onclick="deleteBudget2026('${doc.id}')" style="padding:8px 16px; background:var(--danger); color:#fff; border:none; border-radius:6px; cursor:pointer; font-size:13px">ğŸ—‘ï¸ Sil</button>
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }catch(e){
      console.error('YÃ¼kleme hatasÄ±:', e);
      container.innerHTML = '<div style="padding:40px; text-align:center; color:var(--danger)">Veriler yÃ¼klenirken hata oluÅŸtu</div>';
    }
  }

  // 2026 BÃ¼tÃ§e DÃ¼zenle
  window.editBudget2026 = async function(docId){
    const doc = await db.collection('muhasebe_planlama_2026').doc(docId).get();
    if(!doc.exists){
      alert('KayÄ±t bulunamadÄ±!');
      return;
    }

    const d = doc.data();
    const yeniArtis = prompt(`Yeni yÃ¼zde artÄ±ÅŸ girin (Mevcut: %${d.artisYuzde}):`, d.artisYuzde);
    
    if(yeniArtis === null) return;
    
    const artis = parseFloat(yeniArtis);
    if(isNaN(artis)){
      alert('GeÃ§erli bir sayÄ± girin!');
      return;
    }

    const target2026 = d.baseAmount * (1 + (artis / 100));

    try{
      await db.collection('muhasebe_planlama_2026').doc(docId).update({
        artisYuzde: artis,
        targetAmount: target2026,
        guncellemeTarihi: firebase.firestore.FieldValue.serverTimestamp()
      });

      await loadSavedBudgets2026();
      alert('BÃ¼tÃ§e planÄ± gÃ¼ncellendi!');
    }catch(e){
      console.error('GÃ¼ncelleme hatasÄ±:', e);
      alert('GÃ¼ncelleme sÄ±rasÄ±nda hata oluÅŸtu: ' + e.message);
    }
  };

  // 2026 BÃ¼tÃ§e Sil
  window.deleteBudget2026 = async function(docId){
    if(!confirm('Bu bÃ¼tÃ§e planÄ±nÄ± silmek istediÄŸinize emin misiniz?')) return;

    try{
      await db.collection('muhasebe_planlama_2026').doc(docId).delete();
      await loadSavedBudgets2026();
      alert('BÃ¼tÃ§e planÄ± silindi!');
    }catch(e){
      console.error('Silme hatasÄ±:', e);
      alert('Silme sÄ±rasÄ±nda hata oluÅŸtu: ' + e.message);
    }
  };

  /* --- YENÄ° Ã–ZELLÄ°K 2: SMART INSIGHTS OLUÅTURUCU --- */
/* --- YENÄ° Ã–ZELLÄ°K 2: SMART INSIGHTS (GÃœNCELLENMÄ°Å - DEMO MODLU) --- */
function renderSmartInsights(val2024, val2025, plan2025, tip) {
    // Container'a eriÅŸ
    const container = document.getElementById('presentationContent');
    
    // DEMO MODU: EÄŸer hiÃ§ veri yoksa, kartÄ± gÃ¶rebilmen iÃ§in sahte veri kullanalÄ±m.
    // Veriler gelince bu if bloÄŸu Ã§alÄ±ÅŸmaz, gerÃ§ek veri gÃ¶rÃ¼nÃ¼r.
    let isDemo = false;
    if(val2025 === 0 && val2024 === 0 && plan2025 === 0) {
        isDemo = true;
        val2024 = 150000;
        val2025 = 215000;
        plan2025 = 200000;
        // KullanÄ±cÄ±ya demo olduÄŸunu belli etmeyelim veya konsola yazalÄ±m
        console.log("Veri yok, Smart Insights Demo Modunda Ã§alÄ±ÅŸÄ±yor.");
    }

    // --- HESAPLAMALAR ---
    const isGider = tip === 'gider';
    const artis = val2025 - val2024;
    const artisOran = val2024 > 0 ? (artis / val2024) * 100 : 100;
    
    const butceFark = plan2025 - val2025;
    const butceGerceklesme = plan2025 > 0 ? (val2025 / plan2025) * 100 : 0;
    
    // --- KARAR MEKANÄ°ZMASI ---
    let status = 'neutral'; 
    let icon = 'âš–ï¸';
    let mainMessage = '';
    let trendMessage = '';
    let forecastMessage = '';
    let tags = [];

    // 1. BÃ¼tÃ§e Durumu Analizi
    if(plan2025 > 0) {
      if(isGider) {
        if(val2025 > plan2025) {
          status = 'danger'; icon = 'âš ï¸';
          tags.push({text: 'BÃ¼tÃ§e AÅŸÄ±ldÄ±', type: 'status-danger'});
          mainMessage = `Kategori bÃ¼tÃ§esi <strong style="color:var(--danger)">%${(butceGerceklesme-100).toFixed(1)} oranÄ±nda aÅŸÄ±lmÄ±ÅŸtÄ±r</strong>. Mali disiplin tedbirleri gerekebilir.`;
        } else if(val2025 > plan2025 * 0.9) {
          status = 'warn'; icon = 'âœ‹';
          tags.push({text: 'Limit SÄ±nÄ±rÄ±nda', type: 'status-warn'});
          mainMessage = `BÃ¼tÃ§e kullanÄ±m oranÄ± <strong style="color:var(--warn)">%${butceGerceklesme.toFixed(1)}</strong> seviyesindedir. Harcamalar sÄ±nÄ±ra yaklaÅŸmÄ±ÅŸtÄ±r.`;
        } else {
          status = 'success'; icon = 'âœ…';
          tags.push({text: 'BÃ¼tÃ§e Ä°Ã§i', type: 'status-success'});
          mainMessage = `Harcamalar bÃ¼tÃ§e projeksiyonlarÄ± ile <strong style="color:var(--success)">tam uyumlu</strong> ilerlemektedir (KullanÄ±m: %${butceGerceklesme.toFixed(1)}).`;
        }
      } else { // Gelir
        if(val2025 > plan2025) {
          status = 'success'; icon = 'ğŸš€';
          tags.push({text: 'Hedef AÅŸÄ±ldÄ±', type: 'status-success'});
          mainMessage = `Gelir hedefleri <strong style="color:var(--success)">baÅŸarÄ±yla aÅŸÄ±lmÄ±ÅŸtÄ±r</strong>. Finansal performans beklentilerin Ã¼zerindedir.`;
        } else if(val2025 < plan2025 * 0.8) {
          status = 'danger'; icon = 'ğŸ“‰';
          tags.push({text: 'Hedefin AltÄ±nda', type: 'status-danger'});
          mainMessage = `Gelir performansÄ± hedeflerin <strong style="color:var(--danger)">%${(100-butceGerceklesme).toFixed(1)} altÄ±nda</strong> kalmÄ±ÅŸtÄ±r.`;
        } else {
          status = 'neutral'; icon = 'ğŸ¯';
          tags.push({text: 'Hedefe YakÄ±n', type: 'status-neutral'});
          mainMessage = `Gelirler planlanan hedefler doÄŸrultusunda ilerlemektedir.`;
        }
      }
    } else {
      mainMessage = "Bu dÃ¶nem iÃ§in bÃ¼tÃ§e planlamasÄ± bulunmamaktadÄ±r, sadece geÃ§miÅŸ yÄ±l karÅŸÄ±laÅŸtÄ±rmasÄ± yapÄ±lmaktadÄ±r.";
    }

    // 2. Trend Analizi
    const direction = artis >= 0 ? 'artÄ±ÅŸ' : 'azalÄ±ÅŸ';
    trendMessage = `GeÃ§en yÄ±lÄ±n aynÄ± dÃ¶nemine gÃ¶re <strong>%${Math.abs(artisOran).toFixed(1)} ${direction}</strong> gÃ¶zlemlenmiÅŸtir. Nominal fark: ${fmt(artis)}.`;

    // 3. 2026 Ä°Ã§gÃ¶rÃ¼sÃ¼
    const enflasyonTahmini = 45;
    if(artisOran > enflasyonTahmini && isGider) {
       forecastMessage = `ğŸ”´ <strong>Kritik Tespit:</strong> Gider artÄ±ÅŸ hÄ±zÄ± (%${artisOran.toFixed(1)}), enflasyon beklentisinin Ã¼zerindedir. Reel maliyet artÄ±ÅŸÄ± var.`;
    } else if(artisOran < enflasyonTahmini && isGider && artisOran > 0) {
       forecastMessage = `ğŸŸ¢ <strong>Verimlilik:</strong> ArtÄ±ÅŸ oranÄ± enflasyonun altÄ±nda tutulmuÅŸtur. Reel anlamda tasarruf saÄŸlanmÄ±ÅŸtÄ±r.`;
    } else {
       forecastMessage = `ğŸ”µ <strong>Projeksiyon:</strong> Mevcut trend devam ederse, gelecek yÄ±l iÃ§in ${fmt(val2025 * 1.45)} seviyesinde bÃ¼tÃ§e Ã¶ngÃ¶rÃ¼lmektedir.`;
    }

    // HTML DÃ¶ndÃ¼r
    return `
      <div id="smartInsightCard" class="insight-wrapper">
        <div class="insight-header">
          <div class="insight-title">
            <svg width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
            </svg>
            AI Finansal Ä°Ã§gÃ¶rÃ¼ ${isDemo ? '(DEMO)' : ''}
          </div>
          <div>
            ${tags.map(t => `<span class="insight-tag ${t.type}">${t.text}</span>`).join('')}
          </div>
        </div>
        <div class="insight-body">
          <div class="insight-score-box" style="color:${status === 'success' ? '#16a34a' : (status === 'danger' ? '#dc2626' : '#ca8a04')}">
            ${icon}
          </div>
          <div class="insight-content">
            <ul>
              <li style="font-size:16px">${mainMessage}</li>
              <li>${trendMessage}</li>
              <li style="color:var(--muted); font-style:italic; border-top:1px dashed var(--stroke); padding-top:8px; margin-top:8px;">${forecastMessage}</li>
            </ul>
          </div>
        </div>
      </div>
    `;
  }

  // SÄ°MÃœLASYON HESAPLAMA
  window.calculateSim = function(){
    const rateInput = document.getElementById('simRate');
    if(!rateInput) return;
    
    const rate = parseFloat(rateInput.value) || 0;
    
    // Hesaplama
    const target2026 = baseAmountForSim * (1 + (rate / 100));
    const diff = target2026 - baseAmountForSim;
    const monthly = target2026 / 12;
    
    // DeÄŸerleri YazdÄ±r
    const simResult = document.getElementById('simResult');
    const simMonthly = document.getElementById('simMonthly');
    const diffEl = document.getElementById('simDifference');
    
    if(simResult) simResult.textContent = fmt(target2026);
    if(simMonthly) simMonthly.textContent = fmt(monthly);
    
    if(diffEl){
      diffEl.textContent = `${diff >= 0 ? '+' : ''}${fmt(diff)} fark`;
      diffEl.style.color = diff >= 0 ? '#4ade80' : '#f87171';
    }
  };

  // TASLAK KAYDETME
  window.saveBudgetDraft = function(){
    const category = document.getElementById('presentationTitle')?.textContent || 'Kategori';
    const rateInput = document.getElementById('simRate');
    const resultEl = document.getElementById('simResult');
    
    if(!rateInput || !resultEl){
      alert('SimÃ¼lasyon verileri bulunamadÄ±!');
      return;
    }
    
    const rate = rateInput.value;
    const amount = resultEl.textContent;
    
    alert(`${category} iÃ§in %${rate} artÄ±ÅŸ ile ${amount} tutarÄ±nda 2026 bÃ¼tÃ§e taslaÄŸÄ± kaydedildi!`);
  };

  // Sunumu render et
  async function renderPresentation(kategoriAd, kategoriTip = null){
    const content = document.getElementById('presentationContent');
    const title = document.getElementById('presentationTitle');
    const subtitle = document.getElementById('presentationSubtitle');

    // Risk analizi ve yazdÄ±r butonlarÄ±nÄ± gÃ¶ster
    if(kategoriAd === 'GENEL'){
      document.getElementById('btnRiskAnalysis').style.display = 'block';
    } else {
      document.getElementById('btnRiskAnalysis').style.display = 'none';
    }
    document.getElementById('btnPrint').style.display = 'block';

    // Genel kategorisi iÃ§in Ã¶zel render
    if(kategoriAd === 'GENEL'){
      await renderGenelPresentation();
      return;
    }

    // Kategori bul (tip ile birlikte)
    let kategori;
    if(kategoriTip){
      kategori = allKategoriler.find(k => k.ad === kategoriAd && k.tip === kategoriTip);
    } else {
      kategori = allKategoriler.find(k => k.ad === kategoriAd);
    }
    
    if(!kategori){
      content.innerHTML = '<div class="empty-state"><h2>Kategori bulunamadÄ±</h2></div>';
      return;
    }

    title.textContent = kategoriAd;
    subtitle.textContent = `${kategori.tip === 'gelir' ? 'Gelir' : 'Gider'} Kategorisi Analizi`;

    // Kategori verilerini hesapla
    const tip = kategori.tip;
    
    // 2024 gerÃ§ekleÅŸen toplam
    let gerceklesen2024 = 0;
    if(gerceklesenData[2024]){
      Object.keys(gerceklesenData[2024]).forEach(a => {
        if(gerceklesenData[2024][a][tip] && gerceklesenData[2024][a][tip][kategoriAd]){
          gerceklesen2024 += gerceklesenData[2024][a][tip][kategoriAd];
        }
      });
    }

    // 2025 gerÃ§ekleÅŸen toplam
    let gerceklesen2025 = 0;
    if(gerceklesenData[2025]){
      Object.keys(gerceklesenData[2025]).forEach(a => {
        if(gerceklesenData[2025][a][tip] && gerceklesenData[2025][a][tip][kategoriAd]){
          gerceklesen2025 += gerceklesenData[2025][a][tip][kategoriAd];
        }
      });
    }
    
    // SimÃ¼lasyon iÃ§in bazÄ± ayarla
    baseAmountForSim = gerceklesen2025;

    // 2025 planlanan
    let planlanan2025 = 0;
    if(planlamaData[2025] && planlamaData[2025][tip] && planlamaData[2025][tip][kategoriAd]){
      planlanan2025 = planlamaData[2025][tip][kategoriAd];
    }

    // ArtÄ±ÅŸ hesapla
    const artis = gerceklesen2025 - gerceklesen2024;
    const artisYuzde = gerceklesen2024 > 0 ? ((artis / gerceklesen2024) * 100).toFixed(1) : (gerceklesen2025 > 0 ? '100' : '0');
    const planlananGecmesiYuzde = planlanan2025 > 0 ? ((gerceklesen2025 / planlanan2025) * 100).toFixed(1) : (gerceklesen2025 > 0 ? 'âˆ' : '0');

    // AylÄ±k veriler (2024 ve 2025)
    const aylik2024 = monthsTR.map((_, idx) => {
      const ay = idx + 1;
      return gerceklesenData[2024] && gerceklesenData[2024][ay] && gerceklesenData[2024][ay][tip] && gerceklesenData[2024][ay][tip][kategoriAd]
        ? gerceklesenData[2024][ay][tip][kategoriAd] : 0;
    });

    const aylik2025 = monthsTR.map((_, idx) => {
      const ay = idx + 1;
      return gerceklesenData[2025] && gerceklesenData[2025][ay] && gerceklesenData[2025][ay][tip] && gerceklesenData[2025][ay][tip][kategoriAd]
        ? gerceklesenData[2025][ay][tip][kategoriAd] : 0;
    });

    // 1. ADIM: Smart Insight HTML'ini oluÅŸtur
    const smartInsightsHTML = renderSmartInsights(gerceklesen2024, gerceklesen2025, planlanan2025, tip);

    // 2. ADIM: HTML birleÅŸtir
    content.innerHTML = `
      ${smartInsightsHTML}
      
      ${kategori.aciklama ? `
        <div class="category-description">
          <h3>ğŸ“‹ AÃ§Ä±klama</h3>
          <p>${kategori.aciklama}</p>
        </div>
      ` : ''}

      <div class="kpi-grid">
        <div class="kpi-card">
          <div class="kpi-label">2024 GerÃ§ekleÅŸen</div>
          <div class="kpi-value">${fmt(gerceklesen2024)}</div>
          <div class="kpi-sub">Toplam</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">2025 GerÃ§ekleÅŸen</div>
          <div class="kpi-value">${fmt(gerceklesen2025)}</div>
          <div class="kpi-sub">Toplam</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">2025 Planlanan</div>
          <div class="kpi-value">${fmt(planlanan2025)}</div>
          <div class="kpi-sub">BÃ¼tÃ§e</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">ArtÄ±ÅŸ</div>
          <div class="kpi-value" style="color:${artis >= 0 ? 'var(--danger)' : 'var(--success)'}">
            ${artis >= 0 ? '+' : ''}${fmt(artis)}
          </div>
          <div class="kpi-sub">${artisYuzde}%</div>
        </div>
        <div class="kpi-card">
          <div class="kpi-label">Planlanan GeÃ§mesi</div>
          <div class="kpi-value" style="color:${parseFloat(planlananGecmesiYuzde) > 100 ? 'var(--danger)' : 'var(--success)'}">
            ${planlananGecmesiYuzde}%
          </div>
          <div class="kpi-sub">${parseFloat(planlananGecmesiYuzde) > 100 ? 'AÅŸÄ±ldÄ±' : 'Hedef AltÄ±nda'}</div>
        </div>
      </div>

      <div class="chart-card">
        <h3>ğŸ“Š 2024 vs 2025 AylÄ±k KarÅŸÄ±laÅŸtÄ±rma</h3>
        <div class="chart-container">
          <canvas id="lineChart"></canvas>
        </div>
      </div>

      <div style="display:grid; grid-template-columns:1fr 1fr; gap:24px">
        <div class="chart-card">
          <h3>ğŸ“ˆ Plan vs GerÃ§ekleÅŸen</h3>
          <div class="chart-container">
            <canvas id="barChart"></canvas>
          </div>
        </div>
        <div class="chart-card">
          <h3>ğŸ“‹ Alt Kategoriler</h3>
          <div id="altKategorilerList" style="max-height:400px; overflow-y:auto; padding:8px">
            <div style="padding:20px; text-align:center; color:var(--muted); font-size:14px">YÃ¼kleniyor...</div>
          </div>
        </div>
      </div>
    `;

    // Grafikleri oluÅŸtur
    renderLineChart(aylik2024, aylik2025);
    renderBarChart(gerceklesen2024, gerceklesen2025, planlanan2025);
    
    // Alt kategorileri gÃ¶ster
    renderAltKategoriler(kategoriAd, tip);
  }

  // Alt kategorileri render et
  function renderAltKategoriler(kategoriAd, tip){
    const container = document.getElementById('altKategorilerList');
    if(!container) return;
    
    let altKategoriler = altKategorilerData[tip] && altKategorilerData[tip][kategoriAd] 
      ? [...altKategorilerData[tip][kategoriAd]] : [];
    
    // SÄ±ra no'ya gÃ¶re sÄ±rala
    altKategoriler.sort((a, b) => {
      const siraA = (a.siraNo || 999);
      const siraB = (b.siraNo || 999);
      if(siraA !== siraB) return siraA - siraB;
      return (a.isim || '').localeCompare(b.isim || '', 'tr');
    });
    
    if(altKategoriler.length === 0){
      container.innerHTML = '<div style="padding:40px; text-align:center; color:var(--muted); font-size:14px">Bu kategori iÃ§in alt kategori bulunamadÄ±</div>';
      return;
    }
    
    let html = '<div style="display:flex; flex-direction:column; gap:12px">';
    altKategoriler.forEach(alt => {
      html += `
        <div style="padding:16px; background:var(--bg2); border:1px solid var(--stroke); border-radius:8px; border-left:3px solid var(--brand)">
          <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:8px">
            <div style="flex:1">
              <div style="display:flex; align-items:center; gap:8px; margin-bottom:4px">
                <span style="font-size:11px; color:var(--muted); font-weight:600; background:var(--pill); padding:2px 6px; border-radius:4px">SÄ±ra: ${alt.siraNo || '-'}</span>
                <div style="font-weight:600; font-size:14px; color:var(--text)">${alt.isim}</div>
              </div>
              ${alt.aciklama ? `<div style="font-size:12px; color:var(--muted); margin-bottom:8px">${alt.aciklama}</div>` : ''}
            </div>
            <div style="font-weight:700; font-size:16px; color:var(--brand)">${fmt(alt.tutar)}</div>
          </div>
        </div>
      `;
    });
    html += '</div>';
    container.innerHTML = html;
  }

  // Genel sunumu render et
  async function renderGenelPresentation(){
    const content = document.getElementById('presentationContent');
    const title = document.getElementById('presentationTitle');
    const subtitle = document.getElementById('presentationSubtitle');

    title.textContent = 'GENEL BÃœTÃ‡E ANALÄ°ZÄ°';
    subtitle.textContent = '2024 vs 2025 KarÅŸÄ±laÅŸtÄ±rmasÄ±';

    // Toplam giderler
    let gider2024 = 0, gider2025 = 0;
    if(gerceklesenData[2024]){
      Object.keys(gerceklesenData[2024]).forEach(a => {
        if(gerceklesenData[2024][a].gider){
          Object.keys(gerceklesenData[2024][a].gider).forEach(kat => {
            gider2024 += gerceklesenData[2024][a].gider[kat] || 0;
          });
        }
      });
    }
    if(gerceklesenData[2025]){
      Object.keys(gerceklesenData[2025]).forEach(a => {
        if(gerceklesenData[2025][a].gider){
          Object.keys(gerceklesenData[2025][a].gider).forEach(kat => {
            gider2025 += gerceklesenData[2025][a].gider[kat] || 0;
          });
        }
      });
    }

    // Toplam gelirler
    let gelir2024 = 0, gelir2025 = 0;
    if(gerceklesenData[2024]){
      Object.keys(gerceklesenData[2024]).forEach(a => {
        if(gerceklesenData[2024][a].gelir){
          Object.keys(gerceklesenData[2024][a].gelir).forEach(kat => {
            gelir2024 += gerceklesenData[2024][a].gelir[kat] || 0;
          });
        }
      });
    }
    if(gerceklesenData[2025]){
      Object.keys(gerceklesenData[2025]).forEach(a => {
        if(gerceklesenData[2025][a].gelir){
          Object.keys(gerceklesenData[2025][a].gelir).forEach(kat => {
            gelir2025 += gerceklesenData[2025][a].gelir[kat] || 0;
          });
        }
      });
    }
    
    // SimÃ¼lasyon iÃ§in baz: GENEL GÄ°DERLER
    baseAmountForSim = gider2025;

    // 2025 Planlanan toplam
    let planlananGider2025 = 0, planlananGelir2025 = 0;
    if(planlamaData[2025]){
      if(planlamaData[2025].gider){
        Object.keys(planlamaData[2025].gider).forEach(kat => {
          planlananGider2025 += planlamaData[2025].gider[kat] || 0;
        });
      }
      if(planlamaData[2025].gelir){
        Object.keys(planlamaData[2025].gelir).forEach(kat => {
          planlananGelir2025 += planlamaData[2025].gelir[kat] || 0;
        });
      }
    }

    // ArtÄ±ÅŸ/azalÄ±ÅŸ hesapla
    const giderArtis = gider2025 - gider2024;
    const giderArtisYuzde = gider2024 > 0 ? ((giderArtis / gider2024) * 100).toFixed(1) : (gider2025 > 0 ? '100' : '0');
    const gelirArtis = gelir2025 - gelir2024;
    const gelirArtisYuzde = gelir2024 > 0 ? ((gelirArtis / gelir2024) * 100).toFixed(1) : (gelir2025 > 0 ? '100' : '0');

    // Planlanan geÃ§mesi
    const giderPlanlananGecmesi = planlananGider2025 > 0 ? ((gider2025 / planlananGider2025) * 100).toFixed(1) : (gider2025 > 0 ? 'âˆ' : '0');
    const gelirPlanlananGecmesi = planlananGelir2025 > 0 ? ((gelir2025 / planlananGelir2025) * 100).toFixed(1) : (gelir2025 > 0 ? 'âˆ' : '0');

    // Net durum hesapla
    const giderNetDurum = planlananGider2025 - gider2025; 
    const giderNetDurumYuzde = planlananGider2025 > 0 ? ((giderNetDurum / planlananGider2025) * 100).toFixed(1) : '0';
    
    const gelirNetDurum = gelir2025 - planlananGelir2025; 
    const gelirNetDurumYuzde = planlananGelir2025 > 0 ? ((gelirNetDurum / planlananGelir2025) * 100).toFixed(1) : '0';

    const giderRenk = (giderArtis > 0 || gider2025 > planlananGider2025) ? 'var(--danger)' : 'var(--success)';
    const giderArtisText = giderArtis > 0 ? 'ArtÄ±ÅŸ Var' : (giderArtis < 0 ? 'AzalÄ±ÅŸ Var' : 'DeÄŸiÅŸim Yok');
    const giderPlanText = gider2025 > planlananGider2025 ? 'PlanlamayÄ± GeÃ§miÅŸ' : 'Planlama AltÄ±nda';

    const gelirRenk = (gelir2025 > gelir2024 && gelir2025 > planlananGelir2025) ? 'var(--success)' : 'var(--danger)';
    const gelirDurumText = (gelir2025 > gelir2024 && gelir2025 > planlananGelir2025) ? 'Hedefleri AÅŸtÄ±' : 
                          (gelir2025 <= gelir2024 && gelir2025 <= planlananGelir2025) ? 'Hedeflerin AltÄ±nda' :
                          (gelir2025 > gelir2024) ? 'GeÃ§en YÄ±lÄ± GeÃ§ti' : 'PlanlananÄ± GeÃ§ti';

    // AylÄ±k veriler
    const aylikPlanlananGider = monthsTR.map(() => planlananGider2025 / 12);
    const aylikPlanlananGelir = monthsTR.map(() => planlananGelir2025 / 12);

    const aylikGerceklesenGider2024 = monthsTR.map((_, idx) => {
      const ay = idx + 1;
      let toplam = 0;
      if(gerceklesenData[2024] && gerceklesenData[2024][ay] && gerceklesenData[2024][ay].gider){
        Object.keys(gerceklesenData[2024][ay].gider).forEach(kat => {
          toplam += gerceklesenData[2024][ay].gider[kat] || 0;
        });
      }
      return toplam;
    });

    const aylikGerceklesenGider2025 = monthsTR.map((_, idx) => {
      const ay = idx + 1;
      let toplam = 0;
      if(gerceklesenData[2025] && gerceklesenData[2025][ay] && gerceklesenData[2025][ay].gider){
        Object.keys(gerceklesenData[2025][ay].gider).forEach(kat => {
          toplam += gerceklesenData[2025][ay].gider[kat] || 0;
        });
      }
      return toplam;
    });

    const aylikGerceklesenGelir2024 = monthsTR.map((_, idx) => {
      const ay = idx + 1;
      let toplam = 0;
      if(gerceklesenData[2024] && gerceklesenData[2024][ay] && gerceklesenData[2024][ay].gelir){
        Object.keys(gerceklesenData[2024][ay].gelir).forEach(kat => {
          toplam += gerceklesenData[2024][ay].gelir[kat] || 0;
        });
      }
      return toplam;
    });

    const aylikGerceklesenGelir2025 = monthsTR.map((_, idx) => {
      const ay = idx + 1;
      let toplam = 0;
      if(gerceklesenData[2025] && gerceklesenData[2025][ay] && gerceklesenData[2025][ay].gelir){
        Object.keys(gerceklesenData[2025][ay].gelir).forEach(kat => {
          toplam += gerceklesenData[2025][ay].gelir[kat] || 0;
        });
      }
      return toplam;
    });

    // Risk analizi butonunu gÃ¶ster
    document.getElementById('btnRiskAnalysis').style.display = 'block';

    // 1. ADIM: Smart Insight HTML'ini oluÅŸtur (Giderler iÃ§in)
    const smartInsightsHTML = renderSmartInsights(gider2024, gider2025, planlananGider2025, 'gider');

    // 2. ADIM: HTML BirleÅŸtirme
    content.innerHTML = `
      ${smartInsightsHTML}

      <div class="kpi-group">
        <div class="kpi-group-title">ğŸ’¸ 2024 - 2025 Toplam Gider Analizi</div>
        <div class="kpi-group-grid">
          <div class="kpi-card">
            <div class="kpi-label">2024 Toplam Gider</div>
            <div class="kpi-value">${fmt(gider2024)}</div>
            <div class="kpi-sub">GerÃ§ekleÅŸen</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">2025 Toplam Gider</div>
            <div class="kpi-value">${fmt(gider2025)}</div>
            <div class="kpi-sub">GerÃ§ekleÅŸen</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Gider ArtÄ±ÅŸ/AzalÄ±ÅŸ</div>
            <div class="kpi-value" style="color:${giderRenk}">
              ${giderArtis >= 0 ? '+' : ''}${fmt(giderArtis)}
            </div>
            <div class="kpi-sub">${giderArtisYuzde}% â€¢ ${giderArtisText}</div>
            ${gider2025 > planlananGider2025 ? `<div class="kpi-sub" style="color:var(--danger); font-weight:600">âš ï¸ ${giderPlanText}</div>` : ''}
          </div>
        </div>
      </div>

      <div class="kpi-group">
        <div class="kpi-group-title">ğŸ’° 2024 - 2025 Toplam Gelir Analizi</div>
        <div class="kpi-group-grid">
          <div class="kpi-card">
            <div class="kpi-label">2024 Toplam Gelir</div>
            <div class="kpi-value">${fmt(gelir2024)}</div>
            <div class="kpi-sub">GerÃ§ekleÅŸen</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">2025 Toplam Gelir</div>
            <div class="kpi-value">${fmt(gelir2025)}</div>
            <div class="kpi-sub">GerÃ§ekleÅŸen</div>
          </div>
          <div class="kpi-card">
            <div class="kpi-label">Gelir ArtÄ±ÅŸ/AzalÄ±ÅŸ</div>
            <div class="kpi-value" style="color:${gelirArtis >= 0 ? 'var(--success)' : 'var(--danger)'}">
              ${gelirArtis >= 0 ? '+' : ''}${fmt(gelirArtis)}
            </div>
            <div class="kpi-sub">${gelirArtisYuzde}% â€¢ ${gelirDurumText}</div>
          </div>
        </div>
      </div>

      <div class="kpi-group">
        <div class="kpi-group-title">ğŸ“Š 2025 Planlanan - GerÃ§ekleÅŸen Analizi</div>
        
        <div style="margin-bottom:24px">
          <div style="font-size:14px; font-weight:700; color:var(--text); margin-bottom:12px">ğŸ’¸ Gider</div>
          <div class="kpi-group-grid">
            <div class="kpi-card">
              <div class="kpi-label">Planlanan</div>
              <div class="kpi-value">${fmt(planlananGider2025)}</div>
              <div class="kpi-sub">2025 BÃ¼tÃ§e</div>
            </div>
            <div class="kpi-card">
              <div class="kpi-label">GerÃ§ekleÅŸen</div>
              <div class="kpi-value" style="color:${gider2025 > planlananGider2025 ? 'var(--danger)' : 'var(--success)'}">
                ${fmt(gider2025)}
              </div>
              <div class="kpi-sub">${gider2025 > planlananGider2025 ? 'âš ï¸ PlanlamayÄ± GeÃ§miÅŸ' : 'âœ“ Planlama AltÄ±nda'}</div>
            </div>
            <div class="kpi-card">
              <div class="kpi-label">Net Durum</div>
              <div class="kpi-value" style="color:${giderNetDurum >= 0 ? 'var(--success)' : 'var(--danger)'}">
                ${giderNetDurum >= 0 ? '+' : ''}${fmt(giderNetDurum)}
              </div>
              <div class="kpi-sub">${giderNetDurum >= 0 ? 'ArtÄ±' : 'Eksi'} â€¢ ${giderNetDurumYuzde}%</div>
            </div>
          </div>
        </div>

        <div>
          <div style="font-size:14px; font-weight:700; color:var(--text); margin-bottom:12px">ğŸ’° Gelir</div>
          <div class="kpi-group-grid">
            <div class="kpi-card">
              <div class="kpi-label">Planlanan</div>
              <div class="kpi-value">${fmt(planlananGelir2025)}</div>
              <div class="kpi-sub">2025 BÃ¼tÃ§e</div>
            </div>
            <div class="kpi-card">
              <div class="kpi-label">GerÃ§ekleÅŸen</div>
              <div class="kpi-value" style="color:${gelir2025 > planlananGelir2025 ? 'var(--success)' : 'var(--danger)'}">
                ${fmt(gelir2025)}
              </div>
              <div class="kpi-sub">${gelir2025 > planlananGelir2025 ? 'âœ“ PlanlamayÄ± GeÃ§ti' : 'âš ï¸ Planlama AltÄ±nda'}</div>
            </div>
            <div class="kpi-card">
              <div class="kpi-label">Net Durum</div>
              <div class="kpi-value" style="color:${gelirNetDurum >= 0 ? 'var(--success)' : 'var(--danger)'}">
                ${gelirNetDurum >= 0 ? '+' : ''}${fmt(gelirNetDurum)}
              </div>
              <div class="kpi-sub">${gelirNetDurum >= 0 ? 'ArtÄ±' : 'Eksi'} â€¢ ${gelirNetDurumYuzde}%</div>
            </div>
          </div>
        </div>
      </div>

      <div class="chart-card">
        <h3>ğŸ“Š Gider: Planlanan vs GerÃ§ekleÅŸen (AylÄ±k)</h3>
        <div class="chart-container">
          <canvas id="giderPlanGercekChart"></canvas>
        </div>
      </div>

      <div class="chart-card">
        <h3>ğŸ“Š Gelir: Planlanan vs GerÃ§ekleÅŸen (AylÄ±k)</h3>
        <div class="chart-container">
          <canvas id="gelirPlanGercekChart"></canvas>
        </div>
      </div>

      <div class="chart-card">
        <h3>ğŸ“ˆ 2024 vs 2025 Gider KarÅŸÄ±laÅŸtÄ±rmasÄ±</h3>
        <div class="chart-container">
          <canvas id="giderKarsilastirmaChart"></canvas>
        </div>
      </div>

      <div class="chart-card">
        <h3>ğŸ“ˆ 2024 vs 2025 Gelir KarÅŸÄ±laÅŸtÄ±rmasÄ±</h3>
        <div class="chart-container">
          <canvas id="gelirKarsilastirmaChart"></canvas>
        </div>
      </div>
    `;
    
    // SimÃ¼lasyonu baÅŸlat
    calculateSim();

    // Grafikleri oluÅŸtur
    renderGiderPlanGercekChart(aylikPlanlananGider, aylikGerceklesenGider2025);
    renderGelirPlanGercekChart(aylikPlanlananGelir, aylikGerceklesenGelir2025);
    renderGiderKarsilastirmaChart(aylikGerceklesenGider2024, aylikGerceklesenGider2025);
    renderGelirKarsilastirmaChart(aylikGerceklesenGelir2024, aylikGerceklesenGelir2025);
  }

  // Gider Plan vs GerÃ§ekleÅŸen Chart
  function renderGiderPlanGercekChart(planlanan, gerceklesen){
    const ctx = document.getElementById('giderPlanGercekChart');
    if(chartInstances.giderPlanGercek) chartInstances.giderPlanGercek.destroy();

    chartInstances.giderPlanGercek = new Chart(ctx, {
      type: 'line',
      data: {
        labels: monthsTR,
        datasets: [{
          label: '2025 Planlanan (AylÄ±k)',
          data: planlanan,
          borderColor: '#3b82f6',
          backgroundColor: 'rgba(59, 130, 246, 0.1)',
          tension: 0.4,
          fill: true,
          borderWidth: 3,
          borderDash: [5, 5]
        }, {
          label: '2025 GerÃ§ekleÅŸen',
          data: gerceklesen,
          borderColor: '#ef4444',
          backgroundColor: 'rgba(239, 68, 68, 0.1)',
          tension: 0.4,
          fill: true,
          borderWidth: 3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { 
            display: true, 
            position: 'top',
            labels: { color: '#1e293b', font: { size: 14, weight: 'bold' } }
          },
          tooltip: {
            backgroundColor: 'rgba(255, 255, 255, 0.95)',
            titleColor: '#1e293b',
            bodyColor: '#1e293b',
            borderColor: '#e2e8f0',
            borderWidth: 1,
            callbacks: {
              label: function(context) {
                return context.dataset.label + ': ' + fmt(context.parsed.y);
              }
            }
          }
        },
        scales: {
          x: {
            ticks: { color: '#64748b', font: { size: 12 } },
            grid: { color: '#e2e8f0' }
          },
          y: {
            beginAtZero: true,
            ticks: { 
              color: '#64748b',
              font: { size: 12 },
              callback: function(value) {
                return 'â‚º' + (value/1000).toFixed(0) + 'K';
              }
            },
            grid: { color: '#e2e8f0' }
          }
        }
      }
    });
  }

  // Gelir Plan vs GerÃ§ekleÅŸen Chart
  function renderGelirPlanGercekChart(planlanan, gerceklesen){
    const ctx = document.getElementById('gelirPlanGercekChart');
    if(chartInstances.gelirPlanGercek) chartInstances.gelirPlanGercek.destroy();

    chartInstances.gelirPlanGercek = new Chart(ctx, {
      type: 'line',
      data: {
        labels: monthsTR,
        datasets: [{
          label: '2025 Planlanan (AylÄ±k)',
          data: planlanan,
          borderColor: '#3b82f6',
          backgroundColor: 'rgba(59, 130, 246, 0.1)',
          tension: 0.4,
          fill: true,
          borderWidth: 3,
          borderDash: [5, 5]
        }, {
          label: '2025 GerÃ§ekleÅŸen',
          data: gerceklesen,
          borderColor: '#22c55e',
          backgroundColor: 'rgba(34, 197, 94, 0.1)',
          tension: 0.4,
          fill: true,
          borderWidth: 3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { 
            display: true, 
            position: 'top',
            labels: { color: '#1e293b', font: { size: 14, weight: 'bold' } }
          },
          tooltip: {
            backgroundColor: 'rgba(255, 255, 255, 0.95)',
            titleColor: '#1e293b',
            bodyColor: '#1e293b',
            borderColor: '#e2e8f0',
            borderWidth: 1,
            callbacks: {
              label: function(context) {
                return context.dataset.label + ': ' + fmt(context.parsed.y);
              }
            }
          }
        },
        scales: {
          x: {
            ticks: { color: '#64748b', font: { size: 12 } },
            grid: { color: '#e2e8f0' }
          },
          y: {
            beginAtZero: true,
            ticks: { 
              color: '#64748b',
              font: { size: 12 },
              callback: function(value) {
                return 'â‚º' + (value/1000).toFixed(0) + 'K';
              }
            },
            grid: { color: '#e2e8f0' }
          }
        }
      }
    });
  }

  // Gider KarÅŸÄ±laÅŸtÄ±rma Chart
  function renderGiderKarsilastirmaChart(data2024, data2025){
    const ctx = document.getElementById('giderKarsilastirmaChart');
    if(chartInstances.giderKarsilastirma) chartInstances.giderKarsilastirma.destroy();

    chartInstances.giderKarsilastirma = new Chart(ctx, {
      type: 'line',
      data: {
        labels: monthsTR,
        datasets: [{
          label: '2024 GerÃ§ekleÅŸen',
          data: data2024,
          borderColor: '#ef4444',
          backgroundColor: 'rgba(239, 68, 68, 0.1)',
          tension: 0.4,
          fill: true,
          borderWidth: 3
        }, {
          label: '2025 GerÃ§ekleÅŸen',
          data: data2025,
          borderColor: '#dc2626',
          backgroundColor: 'rgba(220, 38, 38, 0.1)',
          tension: 0.4,
          fill: true,
          borderWidth: 3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { 
            display: true, 
            position: 'top',
            labels: { color: '#1e293b', font: { size: 14, weight: 'bold' } }
          },
          tooltip: {
            backgroundColor: 'rgba(255, 255, 255, 0.95)',
            titleColor: '#1e293b',
            bodyColor: '#1e293b',
            borderColor: '#e2e8f0',
            borderWidth: 1,
            callbacks: {
              label: function(context) {
                return context.dataset.label + ': ' + fmt(context.parsed.y);
              }
            }
          }
        },
        scales: {
          x: {
            ticks: { color: '#64748b', font: { size: 12 } },
            grid: { color: '#e2e8f0' }
          },
          y: {
            beginAtZero: true,
            ticks: { 
              color: '#64748b',
              font: { size: 12 },
              callback: function(value) {
                return 'â‚º' + (value/1000).toFixed(0) + 'K';
              }
            },
            grid: { color: '#e2e8f0' }
          }
        }
      }
    });
  }

  // Gelir KarÅŸÄ±laÅŸtÄ±rma Chart
  function renderGelirKarsilastirmaChart(data2024, data2025){
    const ctx = document.getElementById('gelirKarsilastirmaChart');
    if(chartInstances.gelirKarsilastirma) chartInstances.gelirKarsilastirma.destroy();

    chartInstances.gelirKarsilastirma = new Chart(ctx, {
      type: 'line',
      data: {
        labels: monthsTR,
        datasets: [{
          label: '2024 GerÃ§ekleÅŸen',
          data: data2024,
          borderColor: '#22c55e',
          backgroundColor: 'rgba(34, 197, 94, 0.1)',
          tension: 0.4,
          fill: true,
          borderWidth: 3
        }, {
          label: '2025 GerÃ§ekleÅŸen',
          data: data2025,
          borderColor: '#16a34a',
          backgroundColor: 'rgba(22, 163, 74, 0.1)',
          tension: 0.4,
          fill: true,
          borderWidth: 3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { 
            display: true, 
            position: 'top',
            labels: { color: '#1e293b', font: { size: 14, weight: 'bold' } }
          },
          tooltip: {
            backgroundColor: 'rgba(255, 255, 255, 0.95)',
            titleColor: '#1e293b',
            bodyColor: '#1e293b',
            borderColor: '#e2e8f0',
            borderWidth: 1,
            callbacks: {
              label: function(context) {
                return context.dataset.label + ': ' + fmt(context.parsed.y);
              }
            }
          }
        },
        scales: {
          x: {
            ticks: { color: '#64748b', font: { size: 12 } },
            grid: { color: '#e2e8f0' }
          },
          y: {
            beginAtZero: true,
            ticks: { 
              color: '#64748b',
              font: { size: 12 },
              callback: function(value) {
                return 'â‚º' + (value/1000).toFixed(0) + 'K';
              }
            },
            grid: { color: '#e2e8f0' }
          }
        }
      }
    });
  }

  // Line Chart
  function renderLineChart(data2024, data2025){
    const ctx = document.getElementById('lineChart');
    if(chartInstances.line) chartInstances.line.destroy();

    chartInstances.line = new Chart(ctx, {
      type: 'line',
      data: {
        labels: monthsTR,
        datasets: [{
          label: '2024 GerÃ§ekleÅŸen',
          data: data2024,
          borderColor: '#ef4444',
          backgroundColor: 'rgba(239, 68, 68, 0.1)',
          tension: 0.4,
          fill: true,
          borderWidth: 3
        }, {
          label: '2025 GerÃ§ekleÅŸen',
          data: data2025,
          borderColor: '#22c55e',
          backgroundColor: 'rgba(34, 197, 94, 0.1)',
          tension: 0.4,
          fill: true,
          borderWidth: 3
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { 
            display: true, 
            position: 'top',
            labels: { color: '#1e293b', font: { size: 14, weight: 'bold' } }
          },
          tooltip: {
            backgroundColor: 'rgba(255, 255, 255, 0.95)',
            titleColor: '#1e293b',
            bodyColor: '#1e293b',
            borderColor: '#e2e8f0',
            borderWidth: 1,
            callbacks: {
              label: function(context) {
                return context.dataset.label + ': ' + fmt(context.parsed.y);
              }
            }
          }
        },
        scales: {
          x: {
            ticks: { color: '#64748b', font: { size: 12 } },
            grid: { color: '#e2e8f0' }
          },
          y: {
            beginAtZero: true,
            ticks: { 
              color: '#64748b',
              font: { size: 12 },
              callback: function(value) {
                return 'â‚º' + (value/1000).toFixed(0) + 'K';
              }
            },
            grid: { color: '#e2e8f0' }
          }
        }
      }
    });
  }

  // Bar Chart
  function renderBarChart(gerceklesen2024, gerceklesen2025, planlanan2025){
    const ctx = document.getElementById('barChart');
    if(chartInstances.bar) chartInstances.bar.destroy();

    chartInstances.bar = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: ['2024 GerÃ§ekleÅŸen', '2025 GerÃ§ekleÅŸen', '2025 Planlanan'],
        datasets: [{
          label: 'Tutar',
          data: [gerceklesen2024, gerceklesen2025, planlanan2025],
          backgroundColor: ['rgba(239, 68, 68, 0.8)', 'rgba(34, 197, 94, 0.8)', 'rgba(59, 130, 246, 0.8)'],
          borderColor: ['#ef4444', '#22c55e', '#3b82f6'],
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { 
            display: false
          },
          tooltip: {
            backgroundColor: 'rgba(255, 255, 255, 0.95)',
            titleColor: '#1e293b',
            bodyColor: '#1e293b',
            borderColor: '#e2e8f0',
            borderWidth: 1,
            callbacks: {
              label: function(context) {
                return context.label + ': ' + fmt(context.parsed.y);
              }
            }
          }
        },
        scales: {
          x: {
            ticks: { color: '#64748b', font: { size: 12 } },
            grid: { color: '#e2e8f0' }
          },
          y: {
            beginAtZero: true,
            ticks: { 
              color: '#64748b',
              font: { size: 12 },
              callback: function(value) {
                return 'â‚º' + (value/1000).toFixed(0) + 'K';
              }
            },
            grid: { color: '#e2e8f0' }
          }
        }
      }
    });
  }


  // Modal aÃ§/kapa
  function openModal(id){
    document.getElementById(id).style.display = 'flex';
  }

  window.closeModal = function(id){
    document.getElementById(id).style.display = 'none';
  };

  // 2026 BÃ¼tÃ§e SimÃ¼latÃ¶rÃ¼ - Yeni sayfaya yÃ¶nlendir
  function openBudgetSimulator(){
    window.location.href = 'butcesimulatoru.html';
  }

  // SimÃ¼latÃ¶r Ã¶zet bilgilerini gÃ¼ncelle
  async function updateSimulatorSummary(){
    // Toplam giderler
    let gider2024 = 0, gider2025 = 0, planlananGider2025 = 0;
    if(gerceklesenData[2024]){
      Object.keys(gerceklesenData[2024]).forEach(a => {
        if(gerceklesenData[2024][a].gider){
          Object.keys(gerceklesenData[2024][a].gider).forEach(kat => {
            gider2024 += gerceklesenData[2024][a].gider[kat] || 0;
          });
        }
      });
    }
    if(gerceklesenData[2025]){
      Object.keys(gerceklesenData[2025]).forEach(a => {
        if(gerceklesenData[2025][a].gider){
          Object.keys(gerceklesenData[2025][a].gider).forEach(kat => {
            gider2025 += gerceklesenData[2025][a].gider[kat] || 0;
          });
        }
      });
    }
    if(planlamaData[2025] && planlamaData[2025].gider){
      Object.keys(planlamaData[2025].gider).forEach(kat => {
        planlananGider2025 += planlamaData[2025].gider[kat] || 0;
      });
    }

    // Toplam gelirler
    let gelir2024 = 0, gelir2025 = 0, planlananGelir2025 = 0;
    if(gerceklesenData[2024]){
      Object.keys(gerceklesenData[2024]).forEach(a => {
        if(gerceklesenData[2024][a].gelir){
          Object.keys(gerceklesenData[2024][a].gelir).forEach(kat => {
            gelir2024 += gerceklesenData[2024][a].gelir[kat] || 0;
          });
        }
      });
    }
    if(gerceklesenData[2025]){
      Object.keys(gerceklesenData[2025]).forEach(a => {
        if(gerceklesenData[2025][a].gelir){
          Object.keys(gerceklesenData[2025][a].gelir).forEach(kat => {
            gelir2025 += gerceklesenData[2025][a].gelir[kat] || 0;
          });
        }
      });
    }
    if(planlamaData[2025] && planlamaData[2025].gelir){
      Object.keys(planlamaData[2025].gelir).forEach(kat => {
        planlananGelir2025 += planlamaData[2025].gelir[kat] || 0;
      });
    }

    // YÃ¼zdeleri hesapla
    const gider2024Yuzde = gider2024 > 0 ? ((gider2025 - gider2024) / gider2024 * 100).toFixed(1) : '0';
    const gider2025Yuzde = planlananGider2025 > 0 ? ((gider2025 / planlananGider2025) * 100).toFixed(1) : '0';
    const gelir2024Yuzde = gelir2024 > 0 ? ((gelir2025 - gelir2024) / gelir2024 * 100).toFixed(1) : '0';
    const gelir2025Yuzde = planlananGelir2025 > 0 ? ((gelir2025 / planlananGelir2025) * 100).toFixed(1) : '0';

    // GÃ¼ncelle
    document.getElementById('simGider2024').textContent = fmt(gider2024);
    document.getElementById('simGider2024Yuzde').textContent = `${gider2024Yuzde}% (2024â†’2025)`;
    document.getElementById('simGider2025').textContent = fmt(gider2025);
    document.getElementById('simGider2025Yuzde').textContent = `${gider2024Yuzde}% artÄ±ÅŸ`;
    document.getElementById('simPlanGider2025').textContent = fmt(planlananGider2025);
    document.getElementById('simPlanGider2025Yuzde').textContent = 'Planlanan';
    document.getElementById('simGercekGider2025').textContent = fmt(gider2025);
    document.getElementById('simGercekGider2025Yuzde').textContent = `${gider2025Yuzde}% gerÃ§ekleÅŸme`;

    document.getElementById('simGelir2024').textContent = fmt(gelir2024);
    document.getElementById('simGelir2024Yuzde').textContent = `${gelir2024Yuzde}% (2024â†’2025)`;
    document.getElementById('simGelir2025').textContent = fmt(gelir2025);
    document.getElementById('simGelir2025Yuzde').textContent = `${gelir2024Yuzde}% artÄ±ÅŸ`;
    document.getElementById('simPlanGelir2025').textContent = fmt(planlananGelir2025);
    document.getElementById('simPlanGelir2025Yuzde').textContent = 'Planlanan';
    document.getElementById('simGercekGelir2025').textContent = fmt(gelir2025);
    document.getElementById('simGercekGelir2025Yuzde').textContent = `${gelir2025Yuzde}% gerÃ§ekleÅŸme`;
  }

  // 2026 BÃ¼tÃ§e Ekle
  window.addBudget2026 = async function(){
    const heyet = document.getElementById('simHeyet').value;
    const tip = document.getElementById('simTip').value;
    const artis = parseFloat(document.getElementById('simArtis').value) || 0;

    if(!heyet || !tip || !artis){
      alert('LÃ¼tfen tÃ¼m alanlarÄ± doldurun!');
      return;
    }

    // 2025 baz tutarÄ±nÄ± al
    let baseAmount = 0;
    if(tip === 'gider'){
      if(gerceklesenData[2025]){
        Object.keys(gerceklesenData[2025]).forEach(a => {
          if(gerceklesenData[2025][a].gider){
            Object.keys(gerceklesenData[2025][a].gider).forEach(kat => {
              baseAmount += gerceklesenData[2025][a].gider[kat] || 0;
            });
          }
        });
      }
    } else {
      if(gerceklesenData[2025]){
        Object.keys(gerceklesenData[2025]).forEach(a => {
          if(gerceklesenData[2025][a].gelir){
            Object.keys(gerceklesenData[2025][a].gelir).forEach(kat => {
              baseAmount += gerceklesenData[2025][a].gelir[kat] || 0;
            });
          }
        });
      }
    }

    const target2026 = baseAmount * (1 + (artis / 100));

    try{
      await db.collection('muhasebe_planlama_2026').add({
        heyet: heyet,
        tip: tip,
        artisYuzde: artis,
        baseAmount: baseAmount,
        targetAmount: target2026,
        yil: 2026,
        olusturmaTarihi: firebase.firestore.FieldValue.serverTimestamp()
      });

      // Formu temizle
      document.getElementById('simHeyet').value = '';
      document.getElementById('simTip').value = '';
      document.getElementById('simArtis').value = '';

      // Listeyi yenile
      await loadSavedBudgets2026();
      alert('2026 bÃ¼tÃ§e planÄ± baÅŸarÄ±yla kaydedildi!');
    }catch(e){
      console.error('Kaydetme hatasÄ±:', e);
      alert('Kaydetme sÄ±rasÄ±nda hata oluÅŸtu: ' + e.message);
    }
  };

  // KaydedilmiÅŸ 2026 bÃ¼tÃ§eleri yÃ¼kle
  async function loadSavedBudgets2026(){
    const container = document.getElementById('savedBudgetsList');
    try{
      const snap = await db.collection('muhasebe_planlama_2026').orderBy('olusturmaTarihi', 'desc').get();
      
      if(snap.empty){
        container.innerHTML = '<div style="padding:40px; text-align:center; color:var(--muted)">HenÃ¼z kaydedilmiÅŸ bÃ¼tÃ§e planÄ± yok</div>';
        return;
      }

      let html = '';
      snap.forEach(doc => {
        const d = doc.data();
        const heyetText = d.heyet === 'personel' ? 'Personel' : 'Hesap Heyeti';
        const tipText = d.tip === 'gider' ? 'Gider' : 'Gelir';
        const tipIcon = d.tip === 'gider' ? 'ğŸ’¸' : 'ğŸ’°';
        
        html += `
          <div class="card" style="padding:16px; display:flex; justify-content:space-between; align-items:center; gap:16px">
            <div style="flex:1">
              <div style="display:flex; gap:12px; align-items:center; margin-bottom:8px">
                <span style="font-size:20px">${tipIcon}</span>
                <div>
                  <div style="font-weight:700; font-size:16px">${heyetText} - ${tipText}</div>
                  <div style="font-size:13px; color:var(--muted)">%${d.artisYuzde} artÄ±ÅŸ â€¢ ${fmt(d.baseAmount)} â†’ ${fmt(d.targetAmount)}</div>
                </div>
              </div>
            </div>
            <div style="display:flex; gap:8px">
              <button onclick="editBudget2026('${doc.id}')" style="padding:8px 16px; background:var(--brand); color:#fff; border:none; border-radius:6px; cursor:pointer; font-size:13px">âœï¸ DÃ¼zenle</button>
              <button onclick="deleteBudget2026('${doc.id}')" style="padding:8px 16px; background:var(--danger); color:#fff; border:none; border-radius:6px; cursor:pointer; font-size:13px">ğŸ—‘ï¸ Sil</button>
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }catch(e){
      console.error('YÃ¼kleme hatasÄ±:', e);
      container.innerHTML = '<div style="padding:40px; text-align:center; color:var(--danger)">Veriler yÃ¼klenirken hata oluÅŸtu</div>';
    }
  }

  // 2026 BÃ¼tÃ§e DÃ¼zenle
  window.editBudget2026 = async function(docId){
    const doc = await db.collection('muhasebe_planlama_2026').doc(docId).get();
    if(!doc.exists){
      alert('KayÄ±t bulunamadÄ±!');
      return;
    }

    const d = doc.data();
    const yeniArtis = prompt(`Yeni yÃ¼zde artÄ±ÅŸ girin (Mevcut: %${d.artisYuzde}):`, d.artisYuzde);
    
    if(yeniArtis === null) return;
    
    const artis = parseFloat(yeniArtis);
    if(isNaN(artis)){
      alert('GeÃ§erli bir sayÄ± girin!');
      return;
    }

    const target2026 = d.baseAmount * (1 + (artis / 100));

    try{
      await db.collection('muhasebe_planlama_2026').doc(docId).update({
        artisYuzde: artis,
        targetAmount: target2026,
        guncellemeTarihi: firebase.firestore.FieldValue.serverTimestamp()
      });

      await loadSavedBudgets2026();
      alert('BÃ¼tÃ§e planÄ± gÃ¼ncellendi!');
    }catch(e){
      console.error('GÃ¼ncelleme hatasÄ±:', e);
      alert('GÃ¼ncelleme sÄ±rasÄ±nda hata oluÅŸtu: ' + e.message);
    }
  };

  // 2026 BÃ¼tÃ§e Sil
  window.deleteBudget2026 = async function(docId){
    if(!confirm('Bu bÃ¼tÃ§e planÄ±nÄ± silmek istediÄŸinize emin misiniz?')) return;

    try{
      await db.collection('muhasebe_planlama_2026').doc(docId).delete();
      await loadSavedBudgets2026();
      alert('BÃ¼tÃ§e planÄ± silindi!');
    }catch(e){
      console.error('Silme hatasÄ±:', e);
      alert('Silme sÄ±rasÄ±nda hata oluÅŸtu: ' + e.message);
    }
  };

  // Risk Analizi ModalÄ±nÄ± AÃ§
  async function openRiskAnalysis(){
    await loadData();
    await renderRiskAnalysis();
    openModal('riskAnalysisModal');
  }

  // Risk Analizi Render
  async function renderRiskAnalysis(){
    const content = document.getElementById('riskAnalysisContent');
    
    // Giderlerde planlamayÄ± aÅŸan kategoriler
    const riskliGiderler = [];
    if(planlamaData[2025] && planlamaData[2025].gider && gerceklesenData[2025]){
      Object.keys(planlamaData[2025].gider).forEach(kategori => {
        let gerceklesenToplam = 0;
        Object.keys(gerceklesenData[2025]).forEach(a => {
          if(gerceklesenData[2025][a].gider && gerceklesenData[2025][a].gider[kategori]){
            gerceklesenToplam += gerceklesenData[2025][a].gider[kategori];
          }
        });
        const planlanan = planlamaData[2025].gider[kategori] || 0;
        if(gerceklesenToplam > planlanan){
          const fark = gerceklesenToplam - planlanan;
          const farkYuzde = planlanan > 0 ? ((fark / planlanan) * 100).toFixed(1) : '0';
          riskliGiderler.push({
            kategori: kategori,
            planlanan: planlanan,
            gerceklesen: gerceklesenToplam,
            fark: fark,
            farkYuzde: farkYuzde
          });
        }
      });
    }

    // Gelirlerde planlamanÄ±n altÄ±nda kalan kategoriler
    const riskliGelirler = [];
    if(planlamaData[2025] && planlamaData[2025].gelir && gerceklesenData[2025]){
      Object.keys(planlamaData[2025].gelir).forEach(kategori => {
        let gerceklesenToplam = 0;
        Object.keys(gerceklesenData[2025]).forEach(a => {
          if(gerceklesenData[2025][a].gelir && gerceklesenData[2025][a].gelir[kategori]){
            gerceklesenToplam += gerceklesenData[2025][a].gelir[kategori];
          }
        });
        const planlanan = planlamaData[2025].gelir[kategori] || 0;
        if(gerceklesenToplam < planlanan){
          const fark = planlanan - gerceklesenToplam;
          const farkYuzde = planlanan > 0 ? ((fark / planlanan) * 100).toFixed(1) : '0';
          riskliGelirler.push({
            kategori: kategori,
            planlanan: planlanan,
            gerceklesen: gerceklesenToplam,
            fark: fark,
            farkYuzde: farkYuzde
          });
        }
      });
    }

    // SÄ±rala (en yÃ¼ksek farktan en dÃ¼ÅŸÃ¼ÄŸe)
    riskliGiderler.sort((a, b) => b.fark - a.fark);
    riskliGelirler.sort((a, b) => b.fark - a.fark);

    let html = '';

    if(riskliGiderler.length === 0 && riskliGelirler.length === 0){
      html = '<div style="padding:48px; text-align:center; color:var(--success)"><h3 style="font-size:20px; font-weight:600; margin:0 0 12px; letter-spacing:-0.01em">âœ… Risk Yok</h3><p style="font-size:14px; color:var(--muted); margin:0">TÃ¼m kategoriler planlama hedeflerine uygun ilerliyor.</p></div>';
    } else {
      if(riskliGiderler.length > 0){
        html += `
          <div style="margin-bottom:32px">
            <h4 style="margin:0 0 20px; color:var(--danger); font-size:16px; font-weight:600; letter-spacing:-0.01em">ğŸ’¸ PlanlamayÄ± AÅŸan Gider Kategorileri</h4>
            <div style="display:grid; gap:12px">
        `;
        riskliGiderler.forEach(item => {
          html += `
            <div class="card" style="padding:20px; border-left:3px solid var(--danger); background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius); box-shadow:var(--shadow)">
              <div style="display:flex; justify-content:space-between; align-items:start; gap:16px">
                <div style="flex:1">
                  <div style="font-weight:600; font-size:15px; margin-bottom:12px; color:var(--text); letter-spacing:-0.01em">${item.kategori}</div>
                  <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:16px; font-size:13px">
                    <div>
                      <div style="color:var(--muted); font-size:11px; margin-bottom:4px; font-weight:500">Planlanan</div>
                      <div style="font-weight:600; color:var(--text); font-size:14px">${fmt(item.planlanan)}</div>
                    </div>
                    <div>
                      <div style="color:var(--muted); font-size:11px; margin-bottom:4px; font-weight:500">GerÃ§ekleÅŸen</div>
                      <div style="font-weight:600; color:var(--danger); font-size:14px">${fmt(item.gerceklesen)}</div>
                    </div>
                    <div>
                      <div style="color:var(--muted); font-size:11px; margin-bottom:4px; font-weight:500">AÅŸÄ±m</div>
                      <div style="font-weight:600; color:var(--danger); font-size:14px">+${fmt(item.fark)} (${item.farkYuzde}%)</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `;
        });
        html += '</div></div>';
      }

      if(riskliGelirler.length > 0){
        html += `
          <div>
            <h4 style="margin:0 0 20px; color:var(--warn); font-size:16px; font-weight:600; letter-spacing:-0.01em">ğŸ’° PlanlamanÄ±n AltÄ±nda Kalan Gelir Kategorileri</h4>
            <div style="display:grid; gap:12px">
        `;
        riskliGelirler.forEach(item => {
          html += `
            <div class="card" style="padding:20px; border-left:3px solid var(--warn); background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius); box-shadow:var(--shadow)">
              <div style="display:flex; justify-content:space-between; align-items:start; gap:16px">
                <div style="flex:1">
                  <div style="font-weight:600; font-size:15px; margin-bottom:12px; color:var(--text); letter-spacing:-0.01em">${item.kategori}</div>
                  <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:16px; font-size:13px">
                    <div>
                      <div style="color:var(--muted); font-size:11px; margin-bottom:4px; font-weight:500">Planlanan</div>
                      <div style="font-weight:600; color:var(--text); font-size:14px">${fmt(item.planlanan)}</div>
                    </div>
                    <div>
                      <div style="color:var(--muted); font-size:11px; margin-bottom:4px; font-weight:500">GerÃ§ekleÅŸen</div>
                      <div style="font-weight:600; color:var(--danger); font-size:14px">${fmt(item.gerceklesen)}</div>
                    </div>
                    <div>
                      <div style="color:var(--muted); font-size:11px; margin-bottom:4px; font-weight:500">Eksik</div>
                      <div style="font-weight:600; color:var(--danger); font-size:14px">-${fmt(item.fark)} (${item.farkYuzde}%)</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          `;
        });
        html += '</div></div>';
      }
    }

    content.innerHTML = html;
  }

  // YazdÄ±rma sayfasÄ±nÄ± aÃ§
  window.openPrintPage = function(){
    const kategoriAd = selectedCategory || 'GENEL';
    const kategori = allKategoriler.find(k => {
      if(kategoriAd === 'GENEL') return false;
      const key = `${k.ad}_${k.tip}`;
      return key === kategoriAd || k.ad === kategoriAd;
    });
    const tip = kategori ? kategori.tip : null;
    const url = `bÃ¼tceplanlamayazdir.html?kategori=${encodeURIComponent(kategoriAd)}${tip ? '&tip=' + encodeURIComponent(tip) : ''}`;
    window.open(url, '_blank');
  };

  // Event Listeners
  document.getElementById('btnBudgetSimulator').addEventListener('click', openBudgetSimulator);
  document.getElementById('btnRiskAnalysis').addEventListener('click', openRiskAnalysis);

  // Auth kontrolÃ¼
  try{
    firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL);
  }catch(e){}

  auth.onAuthStateChanged(async (user) => {
    if(!user){
      setTimeout(() => {
        if(!auth.currentUser) window.location.replace('index.html');
      }, 150);
      return;
    }

    // Kategorileri yÃ¼kle
    await loadKategoriler();
  });
</script>
</body>
</html>