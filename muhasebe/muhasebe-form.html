<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>KF | Aidat¬∑Kitap ¬∑ Hedef¬∑Teberru¬∑Kurban</title>
<link rel="icon" type="image/png" href="../img/logo.png" />
<link rel="stylesheet" href="../css/app-shell.css" />

<style>
  /* Sayfa √∂zel stiller - app-shell.css √ºzerine eklenecek */
  
  /* G√úVENLƒ∞K: Body ba≈ülangƒ±√ßta gizli, erken auth kontrol√º ba≈üarƒ±lƒ± olunca g√∂sterilir */
  body { visibility: hidden; }
  html { visibility: hidden; }

  /* APPBAR - app-shell.css'den geliyor, burada sadece √∂zel override'lar */
  .appbar{
    position:fixed !important; 
    top:0 !important; 
    left:0 !important;
    right:0 !important;
    z-index:60 !important;
  }

  /* Sayfa √∂zel utility'ler */
  .stack-lg{display:grid; gap:20px}
  .stack{display:grid; gap:14px}

  /* ========== Minimal Tabs (√ºst) ========== */
  .mini-tabs{
    display:flex; gap:16px; align-items:center;
    border-bottom:1px solid rgba(148,163,184,.16);
    overflow-x:auto; scrollbar-width:none;
  }
  .mini-tabs::-webkit-scrollbar{display:none}
  .mini-tab{
    background:none; border:none; padding:10px 0; font-weight:700; color:var(--muted); cursor:pointer;
    position:relative; white-space:nowrap; font-size:14px;
  }
  .mini-tab.active{color:var(--text)}
  .mini-tab.active::after{
    content:''; position:absolute; left:0; right:0; bottom:-1px; height:2px;
    background:linear-gradient(90deg,var(--brand),var(--brand2));
    border-radius:99px;
  }

  /* ========== Hedef-Teberru alt tabbar ========== */
  .sub-tabs{
    display:flex; gap:14px; margin-bottom:8px;
    overflow-x:auto; scrollbar-width:none;
    padding:3px 3px 2px;
    background:rgba(15,23,42,.04);
    border:1px solid rgba(148,163,184,.08);
    border-radius:999px;
  }
  .sub-tabs::-webkit-scrollbar{display:none}

  .sub-tab{
    background:transparent;
    border:none;
    padding:7px 14px 8px;
    font-weight:600;
    color:var(--muted);
    cursor:pointer;
    white-space:nowrap;
    position:relative;
    font-size:13px;
    border-radius:999px;
    transition:.15s ease-out;
  }

  .sub-tab:hover{
    background:rgba(148,163,184,.07);
    color:var(--text);
  }

  .sub-tab.active{
    color:var(--text);
    background:rgba(14,165,233,.16);
    box-shadow:0 8px 18px rgba(14,165,233,.22);
  }

  .sub-tab.active::after{
    content:'';
    position:absolute;
    right:10px;
    top:8px;
    width:6px; height:6px;
    background:var(--brand);
    border-radius:999px;
  }

  /* ========== Buttons ========== */
  .actions{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    margin-top:12px;
  }

  /* ========== Tables ========== */
  .table-wrap table{min-width:860px}
  
  /* ========== Form Inputs in Tables ========== */
  .table input[type="number"],
  .table input[type="text"]{
    width:100%;
    max-width:200px;
    margin:0;
  }
  
  /* ========== Modern Input Design ========== */
  .field label{
    font-weight:600;
    color:var(--text);
    font-size:13px;
    margin-bottom:6px;
    display:block;
    letter-spacing:0.01em;
  }
  
  .field input:not([type="checkbox"]):not([type="radio"]),
  .field select,
  .field textarea{
    transition:all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
    border:1.5px solid var(--stroke);
    background:var(--card);
    box-shadow:0 1px 2px rgba(0,0,0,0.02);
  }
  
  .field input:focus:not([type="checkbox"]):not([type="radio"]),
  .field select:focus,
  .field textarea:focus{
    outline:none;
    border-color:var(--brand);
    box-shadow:0 0 0 3px rgba(59, 130, 246, 0.1), 0 1px 2px rgba(0,0,0,0.04);
    background:var(--card);
    transform:translateY(-1px);
  }
  
  .field input::placeholder,
  .field textarea::placeholder{
    color:var(--muted);
    opacity:0.65;
  }
  
  .field input:hover:not([type="checkbox"]):not([type="radio"]):not(:focus),
  .field select:hover:not(:focus),
  .field textarea:hover:not(:focus){
    border-color:var(--border);
    box-shadow:0 1px 3px rgba(0,0,0,0.03);
  }
  
  .field input:disabled,
  .field select:disabled,
  .field textarea:disabled{
    opacity:0.6;
    cursor:not-allowed;
    background:var(--surface2);
  }
  
  /* Input i√ßindeki ikonlar i√ßin */
  .field{
    position:relative;
  }
  
  /* ========== Modern Input Design ========== */
  .field label{
    font-weight:600;
    color:var(--text);
    font-size:13px;
    margin-bottom:4px;
    display:block;
  }
  
  .field input:not([type="checkbox"]):not([type="radio"]),
  .field select,
  .field textarea{
    transition:all 0.2s ease;
    border:1.5px solid var(--stroke);
    background:var(--card);
  }
  
  .field input:focus:not([type="checkbox"]):not([type="radio"]),
  .field select:focus,
  .field textarea:focus{
    outline:none;
    border-color:var(--brand);
    box-shadow:0 0 0 3px rgba(59, 130, 246, 0.1);
    background:var(--card);
  }
  
  .field input::placeholder,
  .field textarea::placeholder{
    color:var(--muted);
    opacity:0.6;
  }
  
  .field input:hover:not([type="checkbox"]):not([type="radio"]):not(:focus),
  .field select:hover:not(:focus),
  .field textarea:hover:not(:focus){
    border-color:var(--border);
  }
  
  /* ========== Loading Spinner ========== */
  #vd-loading.show{
    display:flex !important;
  }

  /* ========== Modal - app-shell.css'den geliyor, burada √∂zel override'lar ========== */
  .modal-icerik{
    background:var(--card); 
    border:1px solid var(--stroke); 
    width:96%; 
    max-width:640px; 
    border-radius:16px; 
    box-shadow:var(--shadow-lg); 
    padding:18px; 
    position:relative; 
    display:grid; 
    gap:14px;
  }
  .modal-kapat{
    position:absolute; 
    right:12px; 
    top:10px; 
    font-size:22px; 
    cursor:pointer; 
    color:var(--bad);
    background:transparent;
    border:none;
    width:32px;
    height:32px;
    display:flex;
    align-items:center;
    justify-content:center;
    border-radius:8px;
    transition:all .2s ease;
  }
  .modal-kapat:hover{
    background:var(--surface2);
  }

  @media (max-width:720px){
    .mini-tabs{gap:10px}
    .sub-tabs{gap:10px}
  }
</style>

<!-- Supabase (Auth + Database i√ßin) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script src="../src/supabase.js"></script>
<script src="../src/supabase-auth-wrapper.js"></script>
<script src="../src/supabase-db-wrapper.js"></script>
  
<script>
  // window.auth'u Supabase Auth Wrapper ile initialize et (ortak.js i√ßin gerekli)
  (function() {
    function initAuth() {
      if (typeof window.getSupabaseAuth === 'function') {
        window.auth = window.getSupabaseAuth();
        // ortak.js'deki initWhenReady() i√ßin window.auth'u hazƒ±rla
        // Eƒüer ortak.js'deki initWhenReady() Firebase kontrol√º yapƒ±yorsa, Supabase i√ßin de √ßalƒ±≈ümasƒ± i√ßin window.auth'u hazƒ±r tutuyoruz
        return true;
      }
      return false;
    }
    
    function waitAndTriggerInit() {
      if (typeof window.auth !== 'undefined' && window.auth && typeof window.initAppShellAuth === 'function') {
        // window.auth hazƒ±r, initAppShellAuth'u manuel √ßaƒüƒ±r (ortak.js'deki initWhenReady Firebase kontrol√º yapƒ±yor)
        console.log('‚úÖ Supabase Auth hazƒ±r, initAppShellAuth manuel √ßaƒürƒ±lƒ±yor');
        try {
          window.initAppShellAuth();
        } catch (e) {
          console.error('initAppShellAuth hatasƒ±:', e);
        }
      } else if (typeof window.initAppShellAuth === 'function') {
        // Biraz daha bekle
        setTimeout(waitAndTriggerInit, 100);
      }
    }
    
    if (!initAuth()) {
      let retries = 0;
      const maxRetries = 50;
      const retryInterval = setInterval(function() {
        retries++;
        if (initAuth() || retries >= maxRetries) {
          clearInterval(retryInterval);
          if (window.auth) {
            console.log('‚úÖ Supabase Auth Wrapper hazƒ±r');
            // initAppShellAuth'u tetikle
            setTimeout(waitAndTriggerInit, 200);
          }
        }
      }, 100);
    } else {
      console.log('‚úÖ Supabase Auth Wrapper hazƒ±r');
      // initAppShellAuth'u tetikle
      setTimeout(waitAndTriggerInit, 200);
    }
  })();
</script>

<!-- Ortak JS (navigation, toast, vs) -->
<script src="../js/ortak.js"></script>
</head>
<body>

<!-- APPBAR -->
<div class="appbar">
  <div class="brand" onclick="location.href='../panel.html'">
    <img src="../img/logo.png" alt="logo"><span>KARAAƒûA√á FATƒ∞H</span>
  </div>
  <nav class="nav-center"><ul class="nav-list" id="navMain"></ul></nav>
  <div class="nav-right">
    <button class="btn hamb" id="hamburger" title="Men√º">‚ò∞</button>
    <div class="nav-item">
      <button class="iconbtn" id="btnNotif" title="Bildirimler">üîî
        <span class="badge" id="notifBadge" style="display:none">0</span>
      </button>
      <div class="dropdown drop-right" id="notifDropdown">
        <div class="muted" style="padding:6px 8px">Son bildirimler</div>
        <div id="notifList" style="max-height:300px;overflow:auto"></div>
        <a href="/diger/bildirim.html">T√ºm bildirimleri g√∂r ‚Üí</a>
      </div>
    </div>
    <div class="nav-item">
      <button class="iconbtn" id="btnProfile" title="Profil">
        <span class="avatar"></span> <span id="profName" class="muted">Profil</span>
      </button>
      <div class="dropdown drop-right" id="profDropdown">
        <a href="/diger/kullanici-yonetimi.html" >üë§ Profil</a>
        <a href="/diger/sistem-ayarlari.html" >‚öôÔ∏è Sistem Ayarlarƒ±</a>
        <a href="#" id="btnLogout">üö™ √áƒ±kƒ±≈ü Yap</a>
      </div>
    </div>
  </div>
</div>
<aside class="drawer" id="drawer"></aside>

<!-- CONTENT -->
<main class="container stack-lg">
  <!-- Ba≈ülƒ±k + √úst Se√ßim -->
  <section class="card stack" id="ustKart">
    <div class="row">
      <div class="col-12">
        <h2 style="margin:0">Form Giri≈üi & D√ºzenleme</h2>
      </div>
      <div class="col-12 muted">Aidat, kitap, hedef, teberru ve kurban i√ßin formlarƒ± aynƒ± panelden y√∂netin.</div>
    </div>
    <!-- √úst minimal tabs (Aidat & Kitap | Hedef & Teberru) -->
    <div class="mini-tabs" id="mainFormTabs">
      <button class="mini-tab active" data-target="aidatKitapWrap">Aidat &amp; Kitap</button>
      <button class="mini-tab" data-target="hedefTeberruWrap">Hedef &amp; Teberru</button>
    </div>
  </section>

  <!-- Aidat ¬∑ Kitap -->
  <section class="card stack" id="aidatKitapWrap">
    <h3 style="margin:0">Aidat ¬∑ Kitap</h3>
    <div class="muted">Koleksiyonlar: <strong>talebe_borclar</strong> &amp; <strong>aidat_kitap</strong></div>

    <div class="row">
      <!-- Bor√ß Tanƒ±mlama -->
      <div class="col-6">
        <div class="card stack">
          <h4 style="margin:0">1) Talebe Bor√ß Tanƒ±mlama</h4>

          <div class="field">
            <label>Talebe Adƒ±</label>
            <input id="talebeAd" placeholder="√ñrn: Mehmet Yƒ±lmaz" />
          </div>

          <div class="row">
            <div class="col-6 field">
              <label>Umumi Aidat (‚Ç∫)</label>
              <input type="number" id="aidatTutar" placeholder="7500" />
            </div>
            <div class="col-6 field">
              <label>Aidat ƒ∞ndirimi</label>
              <select id="aidatIndirim">
                <option value="0">ƒ∞ndirim Yok (0%)</option>
                <option value="0.25">Karde≈ü (%25)</option>
                <option value="0.5">Personel (%50)</option>
                <option value="1">Muhacir (%100)</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div class="col-6 field">
              <label>Umumi Kitap (‚Ç∫)</label>
              <input type="number" id="kitapTutar" placeholder="2250" />
            </div>
            <div class="col-6 field">
              <label>Kitap ƒ∞ndirimi</label>
              <select id="kitapIndirim">
                <option value="0">ƒ∞ndirim Yok</option>
                <option value="custom">ƒ∞ndirim Var (Rakam Gir)</option>
              </select>
            </div>
          </div>

          <div id="kitapIndirimWrap" class="field" style="display:none">
            <label>Kitap ƒ∞ndirimi (‚Ç∫)</label>
            <input type="number" id="kitapIndirimMiktar" placeholder="0" />
          </div>

          <div class="hint" id="kayitPreview">√ñnizleme ‚Äî</div>
          <div class="actions"><button class="btn btn-primary" id="btnBorcuKaydet">Kaydet</button></div>
        </div>
      </div>

      <!-- Tahsilat -->
      <div class="col-6">
        <div class="card stack">
          <h4 style="margin:0">2) Tahsilat (√ñdeme Giri≈üi)</h4>

          <div class="field">
            <label>Talebe Adƒ±</label>
            <input id="odemeTalebe" placeholder="√ñrn: Mehmet Yƒ±lmaz" />
          </div>

          <div class="row">
            <div class="col-6 field">
              <label>ƒ∞≈ülem T√ºr√º</label>
              <select id="odemeTuru">
                <option value="Aidat">Aidat</option>
                <option value="Kitap">Kitap</option>
              </select>
            </div>
            <div class="col-6 field">
              <label>Miktar (‚Ç∫)</label>
              <input type="number" id="odemeMiktar" placeholder="0" />
            </div>
          </div>

          <div class="field">
            <label>√ñdeme Y√∂ntemi</label>
            <select id="odemeYontemi">
              <option value="Nakit">Nakit</option>
              <option value="Banka">Banka</option>
            </select>
          </div>

          <div class="hint" id="odemePreview">√ñnizleme ‚Äî</div>
          <div class="actions"><button class="btn btn-primary" id="btnOdemeKaydet">Kaydet</button></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Hedef ¬∑ Teberru -->
  <section class="card stack" id="hedefTeberruWrap" style="display:none">
    <h3 style="margin:0">Hedef ¬∑ Teberru</h3>
    <div class="muted">Koleksiyonlar: <strong>hedefler</strong>, <strong>veriler</strong>, <strong>kategoriler</strong></div>

    <!-- alt mini tabs -->
    <div class="sub-tabs" id="htSubTabs">
      <button type="button" class="sub-tab active" data-open="sec-ht">Hedef Tanƒ±mlama</button>
      <button type="button" class="sub-tab" data-open="sec-hd">Hedef D√ºzenleme</button>
      <button type="button" class="sub-tab" data-open="sec-vg">Veri Giri≈üi</button>
      <button type="button" class="sub-tab" data-open="sec-vd">Veri D√ºzeltme</button>
      <button type="button" class="sub-tab" data-open="sec-kg">Kategori Y√∂netimi</button>
    </div>

    <!-- 1) Hedef Tanƒ±mla -->
    <section id="sec-ht" class="stack">
      <div class="row">
        <div class="col-12 field">
          <label>Kategori</label>
          <select id="kategoriHT">
            <option value="">Y√ºkleniyor‚Ä¶</option>
          </select>
        </div>
      </div>

      <div class="table-wrap">
        <table class="table" style="min-width:520px">
          <thead><tr><th>Personel</th><th>Hedef (‚Ç∫)</th></tr></thead>
          <tbody id="hedefTanimTBody"></tbody>
        </table>
      </div>

      <div class="actions"><button class="btn btn-primary" id="btnHedefTanimOnay">Kaydet (√ñzet)</button></div>
    </section>

    <!-- 2) Hedef D√ºzenle -->
    <section id="sec-hd" class="stack" style="display:none">
      <div class="row">
        <div class="col-6 field">
          <label>Kategori</label>
          <select id="kategoriHD">
            <option value="">Y√ºkleniyor‚Ä¶</option>
          </select>
        </div>
        <div class="col-6 field">
          <label>Personel</label>
          <select id="hd-personel">
            <option value="">Y√ºkleniyor...</option>
          </select>
        </div>
      </div>

      <div class="field">
        <label>Mevcut Hedef</label>
        <div id="hd-mevcut" class="hint">‚Ç∫0</div>
      </div>

      <div class="field">
        <label>Yeni Hedef (‚Ç∫)</label>
        <input type="number" id="hd-yeni" min="0" placeholder="0" />
      </div>

      <div class="actions">
        <button class="btn btn-ghost" id="hdGetirBtn">Mevcut Hedefi Getir</button>
        <button class="btn btn-primary" id="hdKaydetBtn">Kaydet (√ñzet)</button>
      </div>
    </section>

    <!-- 3) Veri Giri≈üi -->
    <section id="sec-vg" class="stack" style="display:none">
      <!-- MOD: Hedef / Teberru / Kurban se√ßimi -->
      <div class="sub-tabs" id="vgMode">
        <button type="button" class="sub-tab active" data-mode="hedef">Hedef</button>
        <button type="button" class="sub-tab" data-mode="teberru">Teberru</button>
        <button type="button" class="sub-tab" data-mode="kurban">Kurban</button>
      </div>

      <!-- HEDEF FORMU -->
      <div id="formHedef" class="stack">
        <div class="row" id="vgKatRow">
          <div class="col-6 field">
            <label>Kategori</label>
            <select id="kategoriVG">
              <option value="">Y√ºkleniyor‚Ä¶</option>
            </select>
          </div>
          <div class="col-6 field">
            <label>Personel</label>
            <select id="giris-personel">
              <option value="">Y√ºkleniyor...</option>
            </select>
          </div>
        </div>

        <div class="field">
          <label>Parayƒ± Verenin Adƒ± Soyadƒ±</label>
          <input id="giris-veren" placeholder="√ñrn: Mehmet Yƒ±lmaz" />
        </div>

        <div class="row">
          <div class="col-6 field">
            <label>Miktar (‚Ç∫)</label>
            <input type="number" id="giris-miktar" min="0" />
          </div>
          <div class="col-6 field">
            <label>Para Nereye Geldi?</label>
            <select id="giris-turu">
              <option value="Nakit">Nakit</option>
              <option value="Banka">Banka</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="col-6 field">
            <label>A√ßƒ±klama (opsiyonel)</label>
            <input id="giris-aciklama" placeholder="-" />
          </div>
          <div class="col-6 field">
            <label>Tarih/Saat (ops.)</label>
            <input type="datetime-local" id="giris-tarih" />
          </div>
        </div>
      </div>

      <!-- TEBERRU FORMU (revize) -->
      <div id="formTeberru" class="stack" style="display:none">
        <div class="row">
          <div class="col-6 field">
            <label>Tarih (Ay / Yƒ±l)</label>
            <input type="month" id="tbr-tarih" />
          </div>
          <div class="col-6 field">
            <label>Se√ßilen D√∂nem</label>
            <input id="tbr-tarih-goster" readonly placeholder="Kasƒ±m 2025 gibi" />
          </div>
        </div>

        <div class="row">
          <div class="col-6 field">
            <label>Personel</label>
            <select id="tbr-personel">
              <option value="">Y√ºkleniyor...</option>
            </select>
          </div>
          <div class="col-6 field">
            <label>Parayƒ± Verenin Adƒ± Soyadƒ±</label>
            <input id="tbr-veren" placeholder="√ñrn: Mehmet Yƒ±lmaz" />
          </div>
        </div>

        <div class="row">
          <div class="col-6 field">
            <label>Miktar (‚Ç∫)</label>
            <input type="text" id="tbr-miktar" placeholder="√ñrn: 10,50 veya 1000" inputmode="decimal" />
            <div class="hint">Virg√ºl ile ondalƒ±k girebilirsiniz (√∂rn: 10,50)</div>
          </div>
          <div class="col-6 field">
            <label>Para Nereye Geldi?</label>
            <select id="tbr-nereye">
              <option value="Nakit">Nakit</option>
              <option value="Banka">Banka</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="col-6 field">
            <label>A√ßƒ±klama (ops.)</label>
            <input id="tbr-aciklama" placeholder="-" />
          </div>
          <div class="col-6 field">
            <label>Tarih (ops.)</label>
            <input type="datetime-local" id="tbr-tarih-ops" />
          </div>
        </div>
      </div>

      <!-- KURBAN FORMU (g√ºncel) -->
      <div id="formKurban" class="stack" style="display:none">
        <div class="row">
          <div class="col-4 field">
            <label>Kategori</label>
            <!-- deƒüerler artƒ±k sorgu ile aynƒ± -->
            <select id="krb-kategori">
              <option value="kucukbas">K√º√ß√ºkba≈ü</option>
              <option value="buyukbas">B√ºy√ºkba≈ü</option>
            </select>
          </div>
          <div class="col-4 field">
            <label>Personel</label>
            <select id="krb-personel">
              <option value="">Y√ºkleniyor...</option>
            </select>
          </div>
          <div class="col-4 field">
            <label>Kurban Sahibinin Adƒ± Soyadƒ±</label>
            <input id="krb-sahip" placeholder="Ad Soyad" />
          </div>
        </div>

        <div class="row">
          <div class="col-6 field">
            <label>Kesim Yeri</label>
            <input id="krb-kesim-yeri" placeholder="√ñrn: Kurs / Mezbahane" />
          </div>
          <div class="col-6 field">
            <label>Kesim Tarihi</label>
            <input type="date" id="krb-kesim-tarih" />
          </div>
        </div>

        <div class="field">
          <label>A√ßƒ±klama</label>
          <input id="krb-aciklama" placeholder="Opsiyonel" />
        </div>
      </div>

      <div class="actions"><button class="btn btn-primary" id="btnVeriGirisOnay">Kaydet (√ñzet)</button></div>
    </section>

    <!-- 4) Veri D√ºzeltme (KART) -->
    <section id="sec-vd" class="stack" style="display:none">
      <div class="row">
        <div class="col-6 field">
          <label>Kategori</label>
          <select id="kategoriVD">
            <option value="">Y√ºkleniyor‚Ä¶</option>
          </select>
        </div>
        <div class="col-6 field">
          <label>Personel (opsiyonel)</label>
          <select id="vd-personel">
            <option value="">Y√ºkleniyor...</option>
          </select>
        </div>
      </div>

      <div class="actions"><button class="btn btn-primary" id="vdYukleBtn" type="button">Y√ºkle</button></div>

      <!-- Loader -->
      <div id="vd-loading" class="flex items-center justify-center gap-2" aria-live="polite" style="display:none; padding:20px; background:var(--surface2); border-radius:12px; border:1px solid var(--stroke); margin:12px 0;">
        <div class="spinner"></div>
        <span class="muted">Veriler y√ºkleniyor‚Ä¶</span>
      </div>

      <!-- Liste -->
      <div id="vd-liste" class="table-wrap" style="margin-top:10px"></div>
    </section>

    <!-- 5) Kategori Y√∂netimi -->
    <section id="sec-kg" class="stack" style="display:none">
      <div class="row">
        <div class="col-4 field">
          <label>Kategori Adƒ±</label>
          <input type="text" id="kgAd" placeholder="√ñrn: Kitap Kampanyasƒ±" />
        </div>
        <div class="col-3 field">
          <label>Tip</label>
          <select id="kgTip">
            <option value="hedef">Hedef</option>
            <option value="teberru">Teberru</option>
            <option value="herikisi">Her ikisi</option>
          </select>
        </div>
        <div class="col-3 field" style="align-self:flex-end">
          <button class="btn btn-primary" id="kgKaydetBtn" type="button">Kategori Kaydet</button>
        </div>
      </div>
      <p class="muted" style="margin:0">Kaydedilen t√ºm kategoriler diƒüer formlardaki "Kategori" alanlarƒ±na otomatik d√º≈üer. Kayƒ±t tarihleri de tutulur.</p>
      <div class="table-wrap" style="margin-top:10px">
        <table class="table">
          <thead>
            <tr><th>Ad</th><th>Tip</th><th>Kayƒ±t Tarihi</th><th>ƒ∞≈ülem</th></tr>
          </thead>
          <tbody id="kgListe">
            <tr><td colspan="4" class="muted">Kategoriler y√ºkleniyor‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>
    </section>

  </section> <!-- /hedefTeberruWrap -->

  <div style="height:40px"></div>
</main>

<!-- √ñzet/Kaydet Modal -->
<div class="modal" id="onayModali" role="dialog" aria-modal="true" aria-labelledby="modal-baslik">
  <div class="sheet">
    <header>
      <h3 id="modal-baslik">ƒ∞≈ülem √ñzeti</h3>
      <button class="modal-kapat" id="modalKapatBtn" type="button" aria-label="Kapat">‚úñ</button>
    </header>
    <div class="body">
      <div id="modal-veriler"></div>
    </div>
    <footer>
      <button class="btn btn-primary" id="modal-kaydet-btn">Kaydet ve G√∂nder</button>
    </footer>
  </div>
</div>

<!-- Veri D√ºzenle Modal (TEK ADET) -->
<div class="modal" id="veriDuzenleModal" role="dialog" aria-modal="true" aria-labelledby="vdModalBaslik">
  <div class="sheet">
    <header>
      <h3 id="vdModalBaslik">Veri D√ºzenle</h3>
      <button class="modal-kapat" id="vdModalKapat" type="button" aria-label="Kapat">‚úñ</button>
    </header>
    <div class="body">

    <input type="hidden" id="vdDocId" />

    <div class="row">
      <div class="col-6 field">
        <label for="vdAdSoyad">Ad Soyad</label>
        <input type="text" id="vdAdSoyad" />
      </div>
      <div class="col-6 field">
        <label for="vdMiktar">Miktar (‚Ç∫)</label>
        <input type="number" id="vdMiktar" min="0" />
      </div>
    </div>

    <div class="row">
      <div class="col-6 field">
        <label for="vdNereyeGeldi">Giri≈ü</label>
        <select id="vdNereyeGeldi">
          <option value="Nakit">Nakit</option>
          <option value="Banka">Banka</option>
        </select>
      </div>
      <div class="col-6 field">
        <label for="vdTur">T√ºr</label>
        <select id="vdTur">
          <option value="hedef">Hedef</option>
          <option value="teberru">Teberru</option>
          <option value="kucukbas">Kurban ‚Äì K√º√ß√ºkba≈ü</option>
          <option value="buyukbas">Kurban ‚Äì B√ºy√ºkba≈ü</option>
        </select>
      </div>
    </div>

    <div class="field">
      <label for="vdAciklama">A√ßƒ±klama (opsiyonel)</label>
      <input type="text" id="vdAciklama" placeholder="-" />
    </div>

    </div>
    <footer>
      <button class="btn btn-primary" id="vdKaydetBtn" type="button">Kaydet</button>
    </footer>
  </div>
</div>

<!-- Kategori D√ºzenle Modal -->
<div class="modal" id="kgModal" role="dialog" aria-modal="true">
  <div class="sheet">
    <header>
      <h3>Kategori D√ºzenle</h3>
      <button class="modal-kapat" id="kgModalKapat" type="button">‚úñ</button>
    </header>
    <div class="body">
      <input type="hidden" id="kgEditId" />
      <div class="field">
        <label>Kategori Adƒ±</label>
        <input id="kgEditAd" />
      </div>
      <div class="field">
        <label>Tip</label>
        <select id="kgEditTip">
          <option value="hedef">Hedef</option>
          <option value="teberru">Teberru</option>
          <option value="herikisi">Her ikisi</option>
        </select>
      </div>
    </div>
    <footer>
      <button class="btn btn-primary" id="kgEditKaydet">Kaydet</button>
    </footer>
  </div>
</div>

<div class="toast-container" id="toastContainer"></div>
<script>
/* ===== Helpers ===== */
// sb dinamik olarak alƒ±nmalƒ± (supabase.js y√ºklenene kadar beklemeli)
const getSb = () => window.supabase;
const userAgent = navigator.userAgent || '';
const cihazTipi = ()=> (window.innerWidth<700?'mobile':(window.innerWidth<960?'tablet':'desktop'));

/* === SORUN 1: T√ºrkiye Saati (+03:00) === */
function getTurkeyISOString() {
  const now = new Date();
  // UTC saatine 3 saat ekle (T√ºrkiye saati)
  const turkeyTime = new Date(now.getTime() + (3 * 60 * 60 * 1000));
  // ISO string formatƒ±na √ßevir (YYYY-MM-DDTHH:mm:ss.sssZ)
  return turkeyTime.toISOString();
}

/* === SORUN 2: UUID Olu≈üturma (Polyfill) === */
function uuidv4() {
  // crypto.randomUUID() mevcut deƒüilse polyfill kullan
  if (typeof crypto !== 'undefined' && crypto.randomUUID && typeof crypto.randomUUID === 'function') {
    try {
      return crypto.randomUUID();
    } catch (e) {
      // G√ºvensiz context'te hata verirse polyfill'e ge√ß
    }
  }
  // Manuel UUID v4 olu≈ütur (RFC 4122 uyumlu)
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
    const r = Math.random() * 16 | 0;
    const v = c === 'x' ? r : (r & 0x3 | 0x8);
    return v.toString(16);
  });
}

/* === SORUN 3: Sayƒ± Formatlama (Sadele≈ütirilmi≈ü) === */
function toNum(v) {
  if (v === null || v === undefined || v === '') return 0;
  if (typeof v === 'number') return isNaN(v) ? 0 : v;
  if (typeof v === 'string') {
    // Bo≈üluklarƒ± temizle
    let s = v.trim().replace(/\s/g, '');
    if (!s) return 0;
    
    // T√ºrk√ße format: nokta binlik, virg√ºl ondalƒ±k ayƒ±rƒ±cƒ±
    // Hem nokta hem virg√ºl varsa: nokta binlik, virg√ºl ondalƒ±k
    if (s.includes(',') && s.includes('.')) {
      s = s.replace(/\./g, '').replace(',', '.');
    }
    // Sadece virg√ºl varsa: ondalƒ±k ayƒ±rƒ±cƒ± (virg√ºl√º noktaya √ßevir)
    else if (s.includes(',') && !s.includes('.')) {
      s = s.replace(',', '.');
    }
    // Sadece nokta varsa: binlik mi ondalƒ±k mƒ± kontrol et
    else if (s.includes('.')) {
      const parts = s.split('.');
      // Eƒüer son kƒ±sƒ±m 3 karakterden fazlaysa ondalƒ±k, deƒüilse binlik ayƒ±rƒ±cƒ±
      if (parts.length === 2 && parts[1].length <= 2) {
        // Ondalƒ±k: noktayƒ± koru (√∂rn: "10.50")
        s = s;
      } else {
        // Binlik: noktalarƒ± kaldƒ±r (√∂rn: "1.000" -> "1000")
        s = s.replace(/\./g, '');
      }
    }
    
    const n = parseFloat(s);
    return isNaN(n) ? 0 : n;
  }
  return 0;
}
// normalizeUrl ortak.js'de tanƒ±mlƒ±
const MONTHS_TR=["Ocak","≈ûubat","Mart","Nisan","Mayƒ±s","Haziran","Temmuz","Aƒüustos","Eyl√ºl","Ekim","Kasƒ±m","Aralƒ±k"];
function formatMonthLabel(val){
  if(!val) return '';
  const [y, m] = val.split('-');
  const mi = Number(m);
  const ad = MONTHS_TR[mi-1] || m;
  return ad + ' ' + y;
}

/* ===== YARDIMCI FONKSƒ∞YONLAR ===== */
// XSS korumasƒ± - HTML escape (ortak.js'de de var ama sayfa i√ßinde kullanƒ±lƒ±yor)
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

/* === Gereksiz auth kodlarƒ± kaldƒ±rƒ±ldƒ± - ortak.js kullanƒ±lƒ±yor === */
// loadNotifications, fetchPanels, renderNav, initAppShell, initAppShellAuth, loadUserDataAndInit
// fonksiyonlarƒ± ortak.js'de mevcut, burada kaldƒ±rƒ±ldƒ±

/* === DEBUG VE HATA Y√ñNETƒ∞Mƒ∞ === */
const DEBUG = true; // Production'da false yapƒ±n - konsol loglarƒ±nƒ± kapatƒ±r

function debugLog(...args) { if (DEBUG) console.log(...args); }
function debugError(...args) { console.error(...args); } // Hatalar her zaman konsola yazƒ±lmalƒ±
function debugWarn(...args) { if (DEBUG) console.warn(...args); }

// Hata mesajƒ±nƒ± daha okunabilir formata √ßevir
function formatErrorMessage(error) {
  if (!error) return 'Bilinmeyen hata';
  if (typeof error === 'string') return error;
  if (error.message) return error.message;
  if (error.error_description) return error.error_description;
  if (error.hint) return `${error.message || 'Hata'}: ${error.hint}`;
  if (error.code) return `[${error.code}] ${error.message || 'Hata olu≈ütu'}`;
  return JSON.stringify(error);
}


// Test fonksiyonu: T√ºm tablolarƒ± test et (konsoldan √ßaƒürƒ±labilir)
window.testSupabaseTables = async function() {
  console.log('üîç T√ºm tablolar test ediliyor...');
  console.log('üîç window.supabase var mƒ±?', !!window.supabase);
  console.log('üîç window.supabase tipi:', typeof window.supabase);
  
  const sb = getSb();
  if (!sb) {
    console.error('‚ùå Supabase client y√ºklenmedi');
    console.error('üí° Kontrol: window.supabase var mƒ±?', !!window.supabase);
    console.error('üí° Kontrol: getSb() fonksiyonu ne d√∂nd√ºr√ºyor?', getSb);
    return;
  }
  
  console.log('‚úÖ Supabase client bulundu');
  console.log('üîç Supabase client tipi:', typeof sb);
  console.log('üîç Supabase from() metodu var mƒ±?', typeof sb.from === 'function');
  console.log('üîç Supabase auth var mƒ±?', !!sb.auth);
  
  // Session kontrol√º (timeout ile)
  try {
    const sessionTimeout = new Promise((_, reject) => 
      setTimeout(() => reject(new Error('Session kontrol√º timeout (3 saniye)')), 3000)
    );
    const sessionPromise = sb.auth.getSession();
    const { data: { session }, error: sessionError } = await Promise.race([sessionPromise, sessionTimeout]);
    console.log('üîç Session kontrol√º:', {
      hasSession: !!session,
      userId: session?.user?.id,
      sessionError: sessionError
    });
  } catch (e) {
    console.error('‚ùå Session kontrol√º hatasƒ±:', e);
    if (e.message?.includes('timeout')) {
      console.error('   ‚è±Ô∏è Session kontrol√º timeout - Auth state takƒ±lƒ±yor olabilir');
    }
  }
  
  const tables = ['kullanicilar', 'sayfa_manifesti', 'kategoriler', 'veriler'];
  
  for (const table of tables) {
    try {
      console.log(`\nüìä ${table} tablosu test ediliyor...`);
      
      // Timeout ekle - 5 saniye i√ßinde cevap gelmezse hata ver
      const timeoutPromise = new Promise((_, reject) => 
        setTimeout(() => reject(new Error(`${table} timeout (5 saniye)`)), 5000)
      );
      
      // Sorguyu ba≈ülat
      const queryStartTime = Date.now();
      console.log(`   ‚è±Ô∏è Sorgu ba≈ülatƒ±ldƒ± (${new Date().toISOString()})`);
      
      // Query builder olu≈ütur
      const queryBuilder = sb.from(table).select('id').limit(1);
      console.log(`   üîç Query builder olu≈üturuldu:`, typeof queryBuilder);
      console.log(`   üîç Query builder then() var mƒ±?`, typeof queryBuilder.then === 'function');
      
      // Promise.race ile timeout ekle
      const queryPromise = queryBuilder;
      const result = await Promise.race([queryPromise, timeoutPromise]);
      
      const queryDuration = Date.now() - queryStartTime;
      console.log(`   ‚è±Ô∏è Sorgu tamamlandƒ± (${queryDuration}ms)`);
      
      if (result.error) {
        console.error(`‚ùå ${table} hatasƒ±:`, {
          code: result.error.code,
          message: result.error.message,
          details: result.error.details,
          hint: result.error.hint
        });
        
        if (result.error.code === '42501' || result.error.message?.includes('permission denied') || result.error.message?.includes('RLS')) {
          console.error(`üîí ${table} i√ßin RLS politikasƒ± gerekli!`);
          console.error(`üí° √á√∂z√ºm: Supabase Dashboard > Authentication > Policies > ${table} tablosuna politika ekleyin`);
        }
      } else {
        console.log(`‚úÖ ${table} ba≈üarƒ±lƒ± - Veri sayƒ±sƒ±: ${result.data?.length || 0}`);
        if (result.data && result.data.length > 0) {
          console.log(`   ƒ∞lk kayƒ±t ID:`, result.data[0].id);
        }
      }
    } catch (e) {
      console.error(`‚ùå ${table} exception:`, e);
      console.error(`   Hata tipi:`, e.name);
      console.error(`   Hata mesajƒ±:`, e.message);
      console.error(`   Stack:`, e.stack);
      if (e.message?.includes('timeout')) {
        console.error(`   ‚è±Ô∏è ${table} sorgusu 5 saniye i√ßinde cevap vermedi`);
        console.error(`   üí° Bu genellikle RLS politikasƒ± olmadƒ±ƒüƒ±nda veya baƒülantƒ± sorununda olur`);
        console.error(`   üí° Supabase Dashboard'da RLS politikalarƒ±nƒ± kontrol edin`);
      }
    }
  }
  
  console.log('\n‚úÖ Test tamamlandƒ±!');
  console.log('üí° Eƒüer t√ºm tablolar timeout veriyorsa:');
  console.log('   1. RLS politikalarƒ±nƒ± kontrol edin');
  console.log('   2. Network sekmesinde istekleri kontrol edin');
  console.log('   3. Supabase Dashboard > Logs b√∂l√ºm√ºn√º kontrol edin');
};

// Daha basit test: Direkt REST API ile test et
window.testSupabaseDirect = async function() {
  console.log('üîç Direkt REST API testi ba≈ülatƒ±lƒ±yor...');
  
  const SUPABASE_URL = 'https://lmwfibippjvqctccxiwb.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxtd2ZpYmlwcGp2cWN0Y2N4aXdiIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NjE2NzA1NCwiZXhwIjoyMDgxNzQzMDU0fQ.lzoudrJx_V4RdCCxPRfgLA1riWNKZ3HyFzeqRynYHeQ';
  
  const tables = ['kullanicilar', 'sayfa_manifesti', 'kategoriler', 'veriler'];
  
  for (const table of tables) {
    try {
      console.log(`\nüìä ${table} tablosu REST API ile test ediliyor...`);
      
      const url = `${SUPABASE_URL}/rest/v1/${table}?select=id&limit=1`;
      console.log(`   üîó URL: ${url}`);
      
      const response = await fetch(url, {
        method: 'GET',
        headers: {
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`,
          'Content-Type': 'application/json',
          'Prefer': 'return=representation'
        }
      });
      
      console.log(`   üì° Response status: ${response.status} ${response.statusText}`);
      
      if (!response.ok) {
        const errorText = await response.text();
        console.error(`‚ùå ${table} REST API hatasƒ±:`, {
          status: response.status,
          statusText: response.statusText,
          error: errorText
        });
        
        if (response.status === 401) {
          console.error('   üîí 401 Unauthorized - API key veya auth sorunu');
        } else if (response.status === 403) {
          console.error('   üîí 403 Forbidden - RLS politikasƒ± sorunu olabilir');
        }
      } else {
        const data = await response.json();
        console.log(`‚úÖ ${table} REST API ba≈üarƒ±lƒ± - Veri sayƒ±sƒ±: ${data?.length || 0}`);
      }
    } catch (e) {
      console.error(`‚ùå ${table} REST API exception:`, e);
    }
  }
  
  console.log('\n‚úÖ REST API testi tamamlandƒ±!');
  console.log('üí° Eƒüer REST API √ßalƒ±≈üƒ±yorsa ama SDK √ßalƒ±≈ümƒ±yorsa, Supabase client sorunu var');
};

/* === Gereksiz auth fonksiyonlarƒ± kaldƒ±rƒ±ldƒ± (ortak.js'de mevcut) === */
// fetchPanels, renderNav, initAppShell, initAppShellAuth, loadUserDataAndInit, initWhenReady
// fonksiyonlarƒ± ortak.js'de mevcut, burada kaldƒ±rƒ±ldƒ±

/* ===== √úst minimal sekmeler ===== */
(function(){
  const tabs=document.querySelectorAll('#mainFormTabs .mini-tab');
  tabs.forEach(t=>t.addEventListener('click',()=>{
    tabs.forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    const target=t.dataset.target;
    document.getElementById('aidatKitapWrap').style.display = (target==='aidatKitapWrap')?'':'none';
    document.getElementById('hedefTeberruWrap').style.display = (target==='hedefTeberruWrap')?'':'none';
  }));
})();

/* ===== Hedef¬∑Teberru alt sekmeler ===== */
(function(){
  const wrap = document.getElementById('htSubTabs');
  if(!wrap) return;
  wrap.addEventListener('click',(e)=>{
    const btn=e.target.closest('.sub-tab'); if(!btn) return;
    wrap.querySelectorAll('.sub-tab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const openId=btn.dataset.open;
    ['sec-ht','sec-hd','sec-vg','sec-vd','sec-kg'].forEach(id=>{
      const el=document.getElementById(id);
      if(el) el.style.display = (id===openId)?'':'none';
    });
    if(openId==='sec-vd') autoListVD();
  });
})();

/* ===== Sayfa √∂zel init === */
// DOMContentLoaded'da √ßalƒ±≈ütƒ±r - ortak.js y√ºklenene kadar bekle
document.addEventListener('DOMContentLoaded', function () {
  // Supabase ve ortak.js y√ºklenene kadar bekle
  function waitForSupabaseAndOrtak(callback) {
    if (typeof window.supabase !== 'undefined' && typeof window.norm !== 'undefined' && typeof window.showToast !== 'undefined') {
      callback();
    } else {
      setTimeout(() => waitForSupabaseAndOrtak(callback), 50);
    }
  }

  waitForSupabaseAndOrtak(() => {
    console.log('‚úÖ waitForSupabaseAndOrtak callback √ßalƒ±≈ütƒ±');
    // ortak.js y√ºklendikten ve auth tamamlandƒ±ktan sonra √ßaƒürƒ±lƒ±r
    window.initPage = async function () {
      console.log('üöÄ window.initPage √ßaƒürƒ±ldƒ±');
      // Supabase client ve auth helper'larƒ±
      const getSupabase = () => window.supabase;
      const getAuth = () => window.getSupabaseAuth ? window.getSupabaseAuth() : null;
      const showToast = window.showToast;
      
      try {
        // Sayfa √∂zel i≈ülemleri - kategorileri y√ºkle
        console.log('üîµ kategorileriYukle √ßaƒürƒ±lacak');
    try {
      await kategorileriYukle();
          console.log('‚úÖ kategorileriYukle tamamlandƒ±');
    } catch (katErr) {
          console.error('‚ùå kategorileriYukle hatasƒ±:', katErr);
      // Hata olsa bile devam et - static kategoriler zaten kategorileriYukle i√ßinde y√ºkleniyor
    }
    
        console.log('üîµ kayitPreviewGuncelle √ßaƒürƒ±lacak');
    kayitPreviewGuncelle();
        console.log('‚úÖ kayitPreviewGuncelle tamamlandƒ±');
    
        console.log('üîµ odemePreviewGuncelle √ßaƒürƒ±lacak');
    odemePreviewGuncelle();
        console.log('‚úÖ odemePreviewGuncelle tamamlandƒ±');
    
        console.log('‚úÖ initPage tamamlandƒ±');
  } catch (e) {
        console.error('‚ùå initPage hatasƒ±:', e);
      }
    };
  });
});

/* ===== Aidat¬∑Kitap ===== */
const kitapIndirimSel = document.getElementById('kitapIndirim');
const kitapIndWrap = document.getElementById('kitapIndirimWrap');
kitapIndirimSel.addEventListener('change', e=>{
  kitapIndWrap.style.display = (e.target.value === 'custom' ? 'block' : 'none');
  kayitPreviewGuncelle();
});
['#talebeAd','#aidatTutar','#aidatIndirim','#kitapTutar','#kitapIndirim','#kitapIndirimMiktar']
  .forEach(sel=> document.querySelector(sel).addEventListener('input', kayitPreviewGuncelle));

function kayitPreviewGuncelle(){
  const ad = document.getElementById('talebeAd').value.trim();
  const aidat = toNum(document.getElementById('aidatTutar').value||0);
  const aidatInd = parseFloat(document.getElementById('aidatIndirim').value||0);
  const kitap = toNum(document.getElementById('kitapTutar').value||0);
  const kitapIndSec = document.getElementById('kitapIndirim').value;
  const kitapIndMiktar = toNum(document.getElementById('kitapIndirimMiktar').value||0);
  const aidatOdenecek = Math.max(0, aidat - (aidat * aidatInd));
  const kitapOdenecek = Math.max(0, kitapIndSec==='custom' ? (kitap - kitapIndMiktar) : kitap);
  document.getElementById('kayitPreview').innerText =
    `${ad || '‚Äî'} toplam bor√ß: ${(aidatOdenecek+kitapOdenecek).toLocaleString('tr-TR')} ‚Ç∫  (Aidat: ${aidatOdenecek.toLocaleString('tr-TR')} ‚Ç∫, Kitap: ${kitapOdenecek.toLocaleString('tr-TR')} ‚Ç∫)`;
}
kayitPreviewGuncelle();

document.getElementById('btnBorcuKaydet').addEventListener('click', async ()=>{
  const ad = document.getElementById('talebeAd').value.trim();
  if(!ad) return showToast('error', 'Hata', 'Talebe adƒ± bo≈ü olamaz.');
  const aidat = toNum(document.getElementById('aidatTutar').value||0);
  const aidatInd = parseFloat(document.getElementById('aidatIndirim').value||0);
  const kitap = toNum(document.getElementById('kitapTutar').value||0);
  const kitapIndSec = document.getElementById('kitapIndirim').value;
  const kitapIndMiktar = toNum(document.getElementById('kitapIndirimMiktar').value||0);
  const aidatOdenecek = Math.max(0, aidat - (aidat * aidatInd));
  const kitapOdenecek = Math.max(0, kitapIndSec==='custom' ? (kitap - kitapIndMiktar) : kitap);

  try{
    const sb = getSb();
    if (!sb) {
      throw new Error('Supabase client bulunamadƒ±');
    }
    const { error } = await sb.from('talebe_borclar').insert({
      id: uuidv4(),
      isim: ad,
      toplamaidat: aidatOdenecek,
      toplamkitap: kitapOdenecek,
      tarih: getTurkeyISOString()
    });
    if(error) throw error;
    showToast('success', 'Ba≈üarƒ±lƒ±', 'Talebe bor√ß kaydƒ± olu≈üturuldu.');
    ['talebeAd','aidatTutar','kitapTutar','kitapIndirimMiktar'].forEach(id=> document.getElementById(id).value='');
    document.getElementById('aidatIndirim').value='0';
    document.getElementById('kitapIndirim').value='0';
    kitapIndWrap.style.display='none';
    kayitPreviewGuncelle();
  }catch(e){
    const errorMsg = formatErrorMessage(e);
    debugError('‚ùå Bor√ß kaydƒ± hatasƒ±:', e);
    showToast('error', 'Kayƒ±t Hatasƒ±', errorMsg);
  }
});

['#odemeTalebe','#odemeTuru','#odemeMiktar','#odemeYontemi'].forEach(sel=>{
  document.querySelector(sel).addEventListener('input', odemePreviewGuncelle);
});
function odemePreviewGuncelle(){
  const ad = document.getElementById('odemeTalebe').value.trim();
  const tur = document.getElementById('odemeTuru').value;
  const miktar = toNum(document.getElementById('odemeMiktar').value||0);
  const yontem = document.getElementById('odemeYontemi').value;
  document.getElementById('odemePreview').innerText =
    `${ad || '‚Äî'}: ${miktar.toLocaleString('tr-TR')} ‚Ç∫ ${tur} tahsil edildi (${yontem}).`;
}
odemePreviewGuncelle();

document.getElementById('btnOdemeKaydet').addEventListener('click', async ()=>{
  const ad = document.getElementById('odemeTalebe').value.trim();
  const tur = document.getElementById('odemeTuru').value;
  const miktar = toNum(document.getElementById('odemeMiktar').value||0);
  const yontem = document.getElementById('odemeYontemi').value;
  if(!ad || !miktar) return showToast('error', 'Hata', 'Talebe adƒ± ve miktar zorunlu.');
  try{
    const sb = getSb();
    if (!sb) {
      throw new Error('Supabase client bulunamadƒ±');
    }
    const { error } = await sb.from('aidat_kitap').insert({
      id: uuidv4(),
      isim: ad,
      islemturu: tur,
      miktar: miktar,
      odemeyontemi: yontem,
      tarih: getTurkeyISOString()
    });
    if(error) throw error;
    showToast('success', 'Ba≈üarƒ±lƒ±', 'Tahsilat kaydedildi.');
    ['odemeTalebe','odemeMiktar'].forEach(id=> document.getElementById(id).value='');
    odemePreviewGuncelle();
  }catch(e){
    const errorMsg = formatErrorMessage(e);
    debugError('‚ùå Tahsilat kaydƒ± hatasƒ±:', e);
    showToast('error', 'Kayƒ±t Hatasƒ±', errorMsg);
  }
});

/* ===== Hedef ¬∑ Teberru ¬∑ Kurban ===== */
const personeller = [
  "Muhsin √áelik","Faruk Nafiz √ñzgan","ƒ∞brahim Ay","Samet √áakƒ±r",
  "Kerem Kocaoƒülu","Serhan Durak","Mahmut Solmaz","Mehmet Taha Keskin","Ahmetali Emre ≈ûahin"
];
function fillSelect(id, arr){ 
  const el=document.getElementById(id); 
  if(!el) return; 
  el.innerHTML = arr.map(p=>`<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join(''); 
}
// Personelleri y√ºkle ve select kutularƒ±nƒ± doldur
fillSelect('hd-personel', personeller);
fillSelect('giris-personel', personeller);
fillSelect('tbr-personel', personeller);
fillSelect('krb-personel', personeller);
const vdPersonel = document.getElementById('vd-personel');
if(vdPersonel) {
  vdPersonel.innerHTML = '<option value="">(T√ºm√º)</option>' + personeller.map(p=>`<option value="${escapeHtml(p)}">${escapeHtml(p)}</option>`).join('');
}

// Hedef tanƒ±mlama tablo satƒ±rlarƒ±
const hedefTBody=document.getElementById('hedefTanimTBody');
personeller.forEach(p=>{
  const tr=document.createElement('tr');
  const safeId = escapeHtml(`hedef-${p}`);
  const safeP = escapeHtml(p);
  tr.innerHTML = `<td>${safeP}</td><td><input type="number" id="${safeId}" placeholder="0" min="0" class="field" style="width:100%; max-width:200px" /></td>`;
  hedefTBody.appendChild(tr);
});

/* ===== √ñzet Modal ===== */
const onayModal = document.getElementById('onayModali');
const modalBaslik = document.getElementById('modal-baslik');
const modalVeriler = document.getElementById('modal-veriler');
const modalKaydetBtn = document.getElementById('modal-kaydet-btn');
const modalKapatBtn = document.getElementById('modalKapatBtn');
function modalOpen(){ onayModal.classList.add('open'); document.body.style.overflow='hidden'; }
function modalClose(){ onayModal.classList.remove('open'); document.body.style.overflow=''; }
modalKapatBtn.addEventListener('click', modalClose);
onayModal.addEventListener('click',(e)=>{ if(e.target===onayModal) modalClose(); });

/* ===== Hedef Tanƒ±mla ===== */
document.getElementById('btnHedefTanimOnay').addEventListener('click', ()=>{
  const kat = (document.getElementById('kategoriHT').value || '').trim();
  if(!kat) return showToast('error', 'Hata', 'Kategori se√ßiniz.');
  let liste=[];
  personeller.forEach(p=>{
    const val = toNum(document.getElementById('hedef-'+p).value);
    if(val>0) liste.push({ kategori: kat, personel:p, hedef: val });
  });
  if(liste.length===0) return showToast('error', 'Hata', 'Hedef giri≈üi yapƒ±lmadƒ±.');
  modalBaslik.textContent = `Hedef Tanƒ±mlama > ${escapeHtml(kat)}`;
  modalVeriler.innerHTML = liste.map(l=>`<p>‚û§ ${escapeHtml(l.personel)} ‚Üí ${l.hedef.toLocaleString('tr-TR')} ‚Ç∫</p>`).join('');
  modalKaydetBtn.onclick = null; // √ñnceki handler'ƒ± temizle
  modalKaydetBtn.onclick = ()=> hedefleriKaydet(liste);
  modalOpen();
});
async function hedefleriKaydet(liste){
  try{
    const sb = getSb();
    if (!sb) {
      throw new Error('Supabase client bulunamadƒ±');
    }
    const { data: { user } } = await sb.auth.getUser();
    if (!user) {
      throw new Error('Kullanƒ±cƒ± oturumu bulunamadƒ±');
    }
    const updates = liste.map(h => ({
      id: `${h.kategori}_${h.personel}`,
      kategori: h.kategori,
      personel: h.personel,
      hedef: toNum(h.hedef),
      updatedat: getTurkeyISOString(),
      updatedby: user?.email || null,
      uid: user?.id || null
    }));
    // Tek seferde t√ºm verileri upsert et (performans optimizasyonu)
    const { error } = await sb.from('hedefler').upsert(updates, { onConflict: 'id' });
    if(error) throw error;
    showToast('success', 'Ba≈üarƒ±lƒ±', 'Hedef(ler) kaydedildi.');
    modalClose();
  }catch(e){
    const errorMsg = formatErrorMessage(e);
    debugError('‚ùå Hedef kaydƒ± hatasƒ±:', e);
    showToast('error', 'Kayƒ±t Hatasƒ±', errorMsg);
    modalClose();
  }
}

/* ===== Hedef D√ºzenle ===== */
document.getElementById('hdGetirBtn').addEventListener('click', hedefMevcutGetir);
document.getElementById('hdKaydetBtn').addEventListener('click', hedefDuzenleOnay);

async function hedefMevcutGetir(){
  const kat = (document.getElementById('kategoriHD').value || '').trim();
  const per = (document.getElementById('hd-personel').value || '').trim();
  if(!kat || !per) return;
  const sb = getSb();
  const { data, error } = await sb.from('hedefler').select('hedef').eq('id', `${kat}_${per}`).single();
  const mevcut = data?.hedef ? toNum(data.hedef) : 0;
  document.getElementById('hd-mevcut').textContent = '‚Ç∫' + mevcut.toLocaleString('tr-TR');
  document.getElementById('hd-yeni').value = mevcut || '';
}
function hedefDuzenleOnay(){
  const kat = (document.getElementById('kategoriHD').value || '').trim();
  const per = (document.getElementById('hd-personel').value || '').trim();
  const yeni = toNum(document.getElementById('hd-yeni').value);
  if(!kat || !per) return showToast('error', 'Hata', 'Kategori ve personel se√ßiniz.');
  modalBaslik.textContent = `Hedef D√ºzenleme > ${escapeHtml(kat)}`;
  modalVeriler.innerHTML = `<p>Personel: ${escapeHtml(per)}</p><p>Yeni Hedef: ${yeni.toLocaleString('tr-TR')} ‚Ç∫</p>`;
  modalKaydetBtn.onclick = null; // √ñnceki handler'ƒ± temizle
  modalKaydetBtn.onclick = ()=> hedefDuzenleKaydet({kategori:kat, personel:per, hedef:yeni});
  modalOpen();
}
async function hedefDuzenleKaydet(h){
  try{
    const sb = getSb();
    if (!sb) {
      throw new Error('Supabase client bulunamadƒ±');
    }
    const { data: { user } } = await sb.auth.getUser();
    if (!user) {
      throw new Error('Kullanƒ±cƒ± oturumu bulunamadƒ±');
    }
    const { error } = await sb.from('hedefler').upsert({
      id: `${h.kategori}_${h.personel}`,
      kategori: h.kategori,
      personel: h.personel,
      hedef: toNum(h.hedef),
      updatedat: getTurkeyISOString(),
      updatedby: user?.email || null,
      uid: user?.id || null
    }, { onConflict: 'id' });
    if(error) throw error;
    showToast('success', 'Ba≈üarƒ±lƒ±', 'Hedef g√ºncellendi.');
    modalClose();
    hedefMevcutGetir();
  }catch(e){
    const errorMsg = formatErrorMessage(e);
    debugError('‚ùå Hedef g√ºncelleme hatasƒ±:', e);
    showToast('error', 'G√ºncelleme Hatasƒ±', errorMsg);
    modalClose();
  }
}

/* ===== Veri Giri≈üi (3 mod) ===== */
(function(){
  const vgMode = document.getElementById('vgMode');
  const formHedef = document.getElementById('formHedef');
  const formTeberru = document.getElementById('formTeberru');
  const formKurban = document.getElementById('formKurban');
  const tbrTarih = document.getElementById('tbr-tarih');
  const tbrTarihGoster = document.getElementById('tbr-tarih-goster');

  // varsayƒ±lan teberru ay-yƒ±l = bug√ºn
  if(tbrTarih){
    const now = new Date();
    const iso = now.toISOString().slice(0,7); // YYYY-MM
    tbrTarih.value = iso;
    tbrTarihGoster.value = formatMonthLabel(iso);
    tbrTarih.addEventListener('change', ()=>{
      tbrTarihGoster.value = formatMonthLabel(tbrTarih.value);
    });
  }

  vgMode?.addEventListener('click', (e)=>{
    const btn = e.target.closest('.sub-tab'); if(!btn) return;
    vgMode.querySelectorAll('.sub-tab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const mode = btn.dataset.mode;
    if(mode==='hedef'){
      formHedef.style.display='grid';
      formTeberru.style.display='none';
      formKurban.style.display='none';
    }else if(mode==='teberru'){
      formHedef.style.display='none';
      formTeberru.style.display='grid';
      formKurban.style.display='none';
    }else{
      formHedef.style.display='none';
      formTeberru.style.display='none';
      formKurban.style.display='grid';
    }
  });
})();

/* ===== Veri Giri≈üi Kaydet ===== */
document.getElementById('btnVeriGirisOnay').addEventListener('click', ()=>{
  const mode = document.querySelector('#vgMode .sub-tab.active')?.dataset.mode || 'hedef';

  /* ===== HEDEF ===== */
  if(mode === 'hedef'){
    const kategori = (document.getElementById('kategoriVG').value || '').trim();
    const personel = document.getElementById('giris-personel').value;
    const veren    = (document.getElementById('giris-veren').value || '').trim();
    const miktar   = toNum(document.getElementById('giris-miktar').value);
    const nereyeGeldi = document.getElementById('giris-turu').value;
    const aciklama = (document.getElementById('giris-aciklama').value || '').trim();
    const tarihSel = document.getElementById('giris-tarih')?.value || '';

    if(!kategori) return showToast('error', 'Hata', 'Kategori se√ßiniz.');
    if(!personel || !veren || !miktar || !nereyeGeldi){
      return showToast('error', 'Hata', 'T√ºm zorunlu alanlarƒ± doldurunuz.');
    }

    modalBaslik.textContent = `Veri Giri≈üi > ${escapeHtml(kategori)}`;
    modalVeriler.innerHTML = `
      <p>T√ºr: <strong>Hedef</strong></p>
      <p>Kategori: ${escapeHtml(kategori)}</p>
      <p>Personel: ${escapeHtml(personel)}</p>
      <p>Veren: ${escapeHtml(veren)}</p>
      <p>Miktar: ${miktar.toLocaleString('tr-TR')} ‚Ç∫</p>
      <p>Giri≈ü: ${escapeHtml(nereyeGeldi)}</p>
      ${aciklama ? `<p>A√ßƒ±klama: ${escapeHtml(aciklama)}</p>`:''}
      ${tarihSel ? `<p>Kayƒ±t Zamanƒ±: ${escapeHtml(tarihSel.replace('T',' '))}</p>`:''}
    `;

    // √ñnceki onclick handler'ƒ± temizle
    modalKaydetBtn.onclick = null;
    modalKaydetBtn.onclick = async ()=>{
      try{
        const sb = getSb();
        if (!sb) {
          throw new Error('Supabase client bulunamadƒ±');
        }
        const { data: { user } } = await sb.auth.getUser();
        if (!user) {
          throw new Error('Kullanƒ±cƒ± oturumu bulunamadƒ±');
        }
        const payload = {
          id: uuidv4(),
          kategori,
          personel,
          adsoyad: veren,
          miktar,
          nereyegeldi: nereyeGeldi,
          tur: 'hedef',
          aciklama: aciklama || '',
          createdat: getTurkeyISOString(),
          tarih: tarihSel || getTurkeyISOString(),
          createdby: user?.email || null,
          uid: user?.id || null,
          useragent: navigator.userAgent || '',
          cihaz: cihazTipi()
        };
        debugLog('üîµ Hedef veri kaydediliyor:', payload);
        const { error, data } = await sb.from('veriler').insert(payload).select();
        if(error) throw error;
        debugLog('‚úÖ Hedef veri kaydedildi:', data);
        showToast('success', 'Ba≈üarƒ±lƒ±', 'Veri (hedef) kaydedildi.');
        ['giris-veren','giris-miktar','giris-aciklama','giris-tarih'].forEach(id=>{
          const el=document.getElementById(id); if(el) el.value='';
        });
        modalClose();
      }catch(e){
        const errorMsg = formatErrorMessage(e);
        debugError('‚ùå Hedef veri kaydƒ± hatasƒ±:', e);
        showToast('error', 'Kayƒ±t Hatasƒ±', errorMsg);
        modalClose();
      }
    };
    onayModal.classList.add('open');
    document.body.style.overflow='hidden';
  }

  /* ===== TEBERRU ===== */
  else if(mode === 'teberru'){
    const donemVal = document.getElementById('tbr-tarih').value;
    const donemLabel = formatMonthLabel(donemVal);
    const personel = document.getElementById('tbr-personel').value;
    const veren = (document.getElementById('tbr-veren').value || '').trim();
    const miktar = toNum(document.getElementById('tbr-miktar').value);
    const nereye = document.getElementById('tbr-nereye').value;
    const aciklama = (document.getElementById('tbr-aciklama').value || '').trim();
    const tarihOps = document.getElementById('tbr-tarih-ops').value;

    if(!donemVal) return showToast('error', 'Hata', 'Tarih (Ay/Yƒ±l) se√ßiniz.');
    if(!personel || !veren || !miktar || !nereye){
      return showToast('error', 'Hata', 'Tarih, personel, veren, miktar ve giri≈ü alanlarƒ± zorunlu.');
    }
    const [yilStr, ayStr] = donemVal.split('-');
    const yil = Number(yilStr);
    const ay = Number(ayStr);

    modalBaslik.textContent = `Veri Giri≈üi > Teberru (${escapeHtml(donemLabel)})`;
    modalVeriler.innerHTML = `
      <p>T√ºr: <strong>Teberru</strong></p>
      <p>D√∂nem: ${escapeHtml(donemLabel)}</p>
      <p>Personel: ${escapeHtml(personel)}</p>
      <p>Veren: ${escapeHtml(veren)}</p>
      <p>Miktar: ${miktar.toLocaleString('tr-TR')} ‚Ç∫</p>
      <p>Giri≈ü: ${escapeHtml(nereye)}</p>
      ${aciklama ? `<p>A√ßƒ±klama: ${escapeHtml(aciklama)}</p>`:''}
      ${tarihOps ? `<p>Kayƒ±t Zamanƒ±: ${escapeHtml(tarihOps.replace('T',' '))}</p>`:''}
    `;

    // √ñnceki onclick handler'ƒ± temizle
    modalKaydetBtn.onclick = null;
    modalKaydetBtn.onclick = async ()=>{
      try{
        const sb = getSb();
        if (!sb) {
          throw new Error('Supabase client bulunamadƒ±');
        }
        const { data: { user } } = await sb.auth.getUser();
        if (!user) {
          throw new Error('Kullanƒ±cƒ± oturumu bulunamadƒ±');
        }
        const payload = {
          id: uuidv4(),
          kategori: 'Teberru',
          personel: personel,
          adsoyad: veren,
          miktar: miktar,
          nereyegeldi: nereye,
          tur: 'teberru',
          aciklama: aciklama || '',
          ay: ay,
          yil: yil,
          ayyilkey: donemVal,
          createdat: getTurkeyISOString(),
          tarih: tarihOps || getTurkeyISOString(),
          createdby: user?.email || null,
          uid: user?.id || null,
          useragent: navigator.userAgent || '',
          cihaz: cihazTipi()
        };
        debugLog('üîµ Teberru veri kaydediliyor:', payload);
        const { error, data } = await sb.from('veriler').insert(payload).select();
        if(error) throw error;
        debugLog('‚úÖ Teberru veri kaydedildi:', data);
        showToast('success', 'Ba≈üarƒ±lƒ±', 'Teberru kaydedildi.');
        ['tbr-veren','tbr-miktar','tbr-aciklama','tbr-tarih-ops'].forEach(id=>{
          const el=document.getElementById(id); if(el) el.value='';
        });
        modalClose();
      }catch(e){
        const errorMsg = formatErrorMessage(e);
        debugError('‚ùå Teberru kaydƒ± hatasƒ±:', e);
        showToast('error', 'Kayƒ±t Hatasƒ±', errorMsg);
        modalClose();
      }
    };
    onayModal.classList.add('open');
    document.body.style.overflow='hidden';
  }

  /* ===== KURBAN ===== */
  else if(mode === 'kurban'){
    const kategori = document.getElementById('krb-kategori').value; // kucukbas | buyukbas
    const personel = document.getElementById('krb-personel').value;
    const sahip = (document.getElementById('krb-sahip').value || '').trim();
    const kesimYeri = (document.getElementById('krb-kesim-yeri').value || '').trim();
    const kesimTarih = document.getElementById('krb-kesim-tarih').value;
    const aciklama = (document.getElementById('krb-aciklama').value || '').trim();

    if(!kategori) return showToast('error', 'Hata', 'Kurban kategorisi se√ßiniz.');
    if(!personel) return showToast('error', 'Hata', 'Personel se√ßiniz.');
    if(!sahip) return showToast('error', 'Hata', 'Kurban sahibinin adƒ±nƒ± giriniz.');

    // kesim tarihi yoksa bug√ºn
    const kesimISO = kesimTarih ? new Date(kesimTarih+'T00:00:00').toISOString() : getTurkeyISOString();
    const kesimDate = new Date(kesimISO);
    const yil = kesimDate.getFullYear();
    const ay = kesimDate.getMonth()+1;
    const ayKey = kesimDate.toISOString().slice(0,7);
    const ayLabel = formatMonthLabel(ayKey);

    const kurbanKatLabel = kategori === 'kucukbas' ? 'K√º√ß√ºkba≈ü' : 'B√ºy√ºkba≈ü';
    modalBaslik.textContent = `Veri Giri≈üi > Kurban (${escapeHtml(kurbanKatLabel)})`;
    modalVeriler.innerHTML = `
      <p>T√ºr: <strong>Kurban</strong></p>
      <p>Kategori: ${escapeHtml(kurbanKatLabel)}</p>
      <p>Personel: ${escapeHtml(personel)}</p>
      <p>Kurban Sahibi: ${escapeHtml(sahip)}</p>
      <p>Kesim Yeri: ${escapeHtml(kesimYeri || '-')}</p>
      <p>Kesim Tarihi: ${escapeHtml(kesimTarih ? kesimTarih : 'Bug√ºn (otomatik)')} </p>
      ${aciklama ? `<p>A√ßƒ±klama: ${escapeHtml(aciklama)}</p>`:''}
      <p>Miktar: 1</p>
      <p>D√∂nem: ${escapeHtml(ayLabel)}</p>
    `;

    // √ñnceki onclick handler'ƒ± temizle
    modalKaydetBtn.onclick = null;
    modalKaydetBtn.onclick = async ()=>{
      try{
        const sb = getSb();
        if (!sb) {
          throw new Error('Supabase client bulunamadƒ±');
        }
        const { data: { user } } = await sb.auth.getUser();
        if (!user) {
          throw new Error('Kullanƒ±cƒ± oturumu bulunamadƒ±');
        }
        const payload = {
          id: uuidv4(),
          kategori: 'Kurban',
          personel: personel,
          adsoyad: sahip,
          miktar: 1,
          tur: kategori,  // kucukbas | buyukbas
          ay: ay,
          yil: yil,
          ayyilkey: ayKey,
          aciklama: aciklama || '',
          createdat: getTurkeyISOString(),
          tarih: getTurkeyISOString().split('T')[0],
          createdby: user?.email || null,
          uid: user?.id || null,
          useragent: navigator.userAgent || '',
          cihaz: cihazTipi()
        };
        debugLog('üîµ Kurban veri kaydediliyor:', payload);
        const { error, data } = await sb.from('veriler').insert(payload).select();
        if(error) throw error;
        debugLog('‚úÖ Kurban veri kaydedildi:', data);
        showToast('success', 'Ba≈üarƒ±lƒ±', 'Kurban kaydedildi.');
        ['krb-sahip','krb-kesim-yeri','krb-kesim-tarih','krb-aciklama'].forEach(id=>{
          const el=document.getElementById(id); if(el) el.value='';
        });
        modalClose();
      }catch(e){
        const errorMsg = formatErrorMessage(e);
        debugError('‚ùå Kurban kaydƒ± hatasƒ±:', e);
        showToast('error', 'Kayƒ±t Hatasƒ±', errorMsg);
        modalClose();
      }
    };

    onayModal.classList.add('open');
    document.body.style.overflow='hidden';
  }
});

/* ===== Veri Listeleme / D√ºzenleme ===== */
document.getElementById('vdYukleBtn').addEventListener('click', ()=> verileriListele(true));
document.getElementById('kategoriVD').addEventListener('change', ()=> verileriListele(true));
document.getElementById('vd-personel').addEventListener('change', ()=> verileriListele(true));

async function autoListVD(){ try{ await verileriListele(); }catch(e){} }

async function verileriListele(showLoading = false){
  const kat = (document.getElementById('kategoriVD').value || '').trim();
  const per = document.getElementById('vd-personel').value;
  const kon = document.getElementById('vd-liste');
  const btn = document.getElementById('vdYukleBtn');
  const loader = document.getElementById('vd-loading');

  if(!kat){
    kon.innerHTML = '<div class="muted" style="padding:8px">Kategori se√ßiniz.</div>';
    return;
  }

  if(showLoading){
    loader.style.display = 'flex';
    loader.classList.add('show');
    btn.disabled = true;
    btn.textContent = 'Y√ºkleniyor‚Ä¶';
  }
  kon.innerHTML = '';

  const sb = getSb();
  let query = sb.from('veriler').select('id, kategori, personel, adsoyad, veren, miktar, nereyegeldi, tur, aciklama, createdat, tarih').eq('kategori', kat).order('createdat', { ascending: false }).limit(300);
  if (per) query = query.eq('personel', per);

  let rows = null;
  try {
    const { data, error } = await query;
    if(error) throw error;
    rows = data || [];
  } catch (err) {
    debugError(err);
    showToast('error', 'Hata', 'Liste alƒ±namadƒ±.');
    rows = [];
  }

  if (!rows || rows.length === 0) {
    kon.innerHTML = '<div class="muted" style="padding:8px">Kayƒ±t bulunamadƒ±.</div>';
  } else {
    let html = `
      <table class="table">
        <thead><tr>
          <th>Tarih</th><th>Personel</th><th>Ad Soyad</th><th>Miktar</th><th>Giri≈ü</th><th>T√ºr</th><th>A√ßƒ±klama</th><th>ƒ∞≈ülem</th>
        </tr></thead><tbody>
    `;
    rows.forEach(d=>{
      const t = d.createdat ? new Date(d.createdat) : (d.tarih ? new Date(d.tarih) : null);
      const tStr = t ? t.toLocaleString('tr-TR') : '-';
      // tur g√∂sterimi
      let turGoster = d.tur || 'hedef';
      if (turGoster === 'kucukbas') turGoster = 'Kurban (K√º√ß√ºkba≈ü)';
      else if (turGoster === 'buyukbas') turGoster = 'Kurban (B√ºy√ºkba≈ü)';

      html += `
        <tr data-id="${d.id}">
          <td>${escapeHtml(tStr)}</td>
          <td>${escapeHtml(d.personel || '-')}</td>
          <td>${escapeHtml(d.adsoyad || d.veren || '-')}</td>
          <td>${d.miktar !== undefined && d.miktar !== null ? '‚Ç∫'+(Number(d.miktar||0)).toLocaleString('tr-TR') : '-'}</td>
          <td>${escapeHtml(d.nereyegeldi || '-')}</td>
          <td>${escapeHtml(turGoster)}</td>
          <td>${escapeHtml(d.aciklama || '-')}</td>
          <td>
            <button class="btn btn-ghost duzenle">D√ºzenle</button>
            <button class="btn btn-danger sil">Sil</button>
          </td>
        </tr>`;
    });
    html += `</tbody></table>`;
    kon.innerHTML = html;

    kon.querySelector('tbody').addEventListener('click', (e)=>{
      const tr = e.target.closest('tr'); if(!tr) return;
      const id = tr.getAttribute('data-id');
      if (e.target.classList.contains('duzenle')) veriDuzenleAc(id);
      if (e.target.classList.contains('sil')) veriSil(id);
    });
  }

  if(showLoading){
    loader.style.display = 'none';
    loader.classList.remove('show');
    btn.disabled = false;
    btn.textContent = 'Y√ºkle';
  }
}

/* ===== D√ºzenle Modal ===== */
const vdModal=document.getElementById('veriDuzenleModal');
document.getElementById('vdModalKapat').addEventListener('click', ()=> { vdModal.classList.remove('open'); document.body.style.overflow=''; });
vdModal.addEventListener('click',(e)=>{ if(e.target===vdModal) { vdModal.classList.remove('open'); document.body.style.overflow=''; } });
async function veriDuzenleAc(docId){
  try{
    const sb = getSb();
    const { data, error } = await sb.from('veriler').select('id, adsoyad, veren, miktar, nereyegeldi, tur, aciklama').eq('id', docId).single();
    if(error || !data) return showToast('error', 'Hata', 'Kayƒ±t bulunamadƒ±.');
    document.getElementById('vdDocId').value=docId;
    document.getElementById('vdAdSoyad').value=data.adsoyad || data.veren || '';
    document.getElementById('vdMiktar').value=toNum(data.miktar);
    document.getElementById('vdNereyeGeldi').value=data.nereyegeldi || 'Nakit';
    // tur bilinmiyorsa hedef
    const turVal = data.tur || 'hedef';
    document.getElementById('vdTur').value = (turVal === 'kucukbas' || turVal === 'buyukbas') ? turVal : turVal;
    document.getElementById('vdAciklama').value=data.aciklama || '';
    vdModal.classList.add('open');
    document.body.style.overflow='hidden';
  }catch(e){
    const errorMsg = formatErrorMessage(e);
    debugError('‚ùå Veri getirme hatasƒ±:', e);
    showToast('error', 'Hata', errorMsg);
  }
}
document.getElementById('vdKaydetBtn').addEventListener('click', async ()=>{
  const id=document.getElementById('vdDocId').value;
  if(!id) return;
  try{
    const sb = getSb();
    const { data: { user } } = await sb.auth.getUser();
    const { error } = await sb.from('veriler').update({
      adsoyad: (document.getElementById('vdAdSoyad').value || '').trim(),
      miktar: toNum(document.getElementById('vdMiktar').value),
      nereyegeldi: document.getElementById('vdNereyeGeldi').value,
      tur: document.getElementById('vdTur').value,
      aciklama: (document.getElementById('vdAciklama').value || '').trim()
    }).eq('id', id);
    if(error) throw error;
    showToast('success', 'Ba≈üarƒ±lƒ±', 'Kayƒ±t g√ºncellendi.');
    vdModal.classList.remove('open');
    document.body.style.overflow='';
    verileriListele();
  }catch(e){
    const errorMsg = formatErrorMessage(e);
    debugError('‚ùå Veri g√ºncelleme hatasƒ±:', e);
    showToast('error', 'G√ºncelleme Hatasƒ±', errorMsg);
  }
});
async function veriSil(docId){
  if(!confirm('Bu kaydƒ± silmek istiyor musunuz?')) return;
  try{
    const sb = getSb();
    if (!sb) {
      throw new Error('Supabase client bulunamadƒ±');
    }
    const { error } = await sb.from('veriler').delete().eq('id', docId);
    if(error) throw error;
    showToast('success', 'Ba≈üarƒ±lƒ±', 'Kayƒ±t silindi.'); 
    verileriListele(); 
  }
  catch(e){
    const errorMsg = formatErrorMessage(e);
    debugError('‚ùå Veri silme hatasƒ±:', e);
    showToast('error', 'Silme Hatasƒ±', errorMsg);
  }
}

/* ===== KATEGORƒ∞ Y√ñNETƒ∞Mƒ∞ ===== */
let KATEGORILER = [];
async function kategorileriYukle(){
  debugLog('üîµ kategorileriYukle ba≈üladƒ±');
  try{
    const sb = getSb();
    if (!sb) {
      debugError('‚ùå Supabase client y√ºklenmedi');
      throw new Error('Supabase client y√ºklenmedi');
    }
    
    // Supabase client kontrol√º
    if (!sb.from) {
      debugError('‚ùå Supabase client eksik: from() metodu bulunamadƒ±');
      throw new Error('Supabase client d√ºzg√ºn y√ºklenmedi');
    }
    
    debugLog('‚úÖ Supabase client hazƒ±r');
    debugLog('üîµ kategoriler sorgusu yapƒ±lƒ±yor');
    debugLog('üîç kategoriler sorgu parametreleri:', { table: 'kategoriler' });
    
    let data, error;
    try {
      // Timeout ekle - 5 saniye i√ßinde cevap gelmezse REST API'ye ge√ß
      const queryTimeout = new Promise((_, reject) => 
        setTimeout(() => reject(new Error('kategoriler timeout (5 saniye)')), 5000)
      );
      
      const queryPromise = sb
        .from('kategoriler')
        .select('id, ad, tip, kayittarihi, createdat')
        .order('ad', { ascending: true });
      
      const result = await Promise.race([queryPromise, queryTimeout]);
      data = result.data;
      error = result.error;
    } catch (timeoutErr) {
      if (timeoutErr.message?.includes('timeout')) {
        debugWarn('‚ö†Ô∏è SDK sorgusu timeout, REST API ile denenecek...');
        
        // REST API ile dene (ge√ßici √ß√∂z√ºm)
        const SUPABASE_URL = 'https://lmwfibippjvqctccxiwb.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxtd2ZpYmlwcGp2cWN0Y2N4aXdiIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NjE2NzA1NCwiZXhwIjoyMDgxNzQzMDU0fQ.lzoudrJx_V4RdCCxPRfgLA1riWNKZ3HyFzeqRynYHeQ';
        
        const restUrl = `${SUPABASE_URL}/rest/v1/kategoriler?select=id,ad,tip,kayittarihi,createdat&order=ad.asc`;
        const restResponse = await fetch(restUrl, {
          method: 'GET',
          headers: {
            'apikey': SUPABASE_KEY,
            'Authorization': `Bearer ${SUPABASE_KEY}`,
            'Content-Type': 'application/json',
            'Prefer': 'return=representation'
          }
        });
        
        if (restResponse.ok) {
          data = await restResponse.json();
          error = null;
          debugLog('‚úÖ REST API sorgusu ba≈üarƒ±lƒ±:', data?.length || 0, 'kategori');
        } else {
          const errorText = await restResponse.text();
          error = { code: restResponse.status, message: errorText };
          debugError('‚ùå REST API sorgusu hatasƒ±:', error);
        }
      } else {
        throw timeoutErr;
      }
    }
    
    debugLog('üîç kategoriler sorgu sonucu:', {
      hasData: !!data,
      dataCount: data?.length || 0,
      hasError: !!error,
      errorCode: error?.code,
      errorMessage: error?.message
    });
    
    if (error) {
      debugError('‚ùå kategoriler okunamadƒ±:', {
        code: error.code,
        message: error.message,
        details: error.details,
        hint: error.hint,
        error: error
      });
      
      // RLS hatasƒ± kontrol√º
      if (error.code === '42501' || error.message?.includes('permission denied') || error.message?.includes('RLS')) {
        debugError('üîí RLS (Row Level Security) hatasƒ±: kategoriler tablosu i√ßin RLS politikasƒ± gerekli!');
        debugError('üí° √á√∂z√ºm: Supabase Dashboard > Authentication > Policies > kategoriler tablosuna politika ekleyin');
        debugError('üí° Test i√ßin konsolda: testSupabaseTables()');
        showToast('error', 'RLS Hatasƒ±', 'kategoriler tablosu i√ßin RLS politikasƒ± gerekli. Console\'u kontrol edin.');
      }
      
      throw error;
    }
    
    if (!data || data.length === 0) {
      debugWarn('‚ö†Ô∏è kategoriler bo≈ü veya bulunamadƒ±');
      debugWarn('üí° Kontrol edin: RLS politikalarƒ±, tablo adƒ±, veri varlƒ±ƒüƒ±');
      // Bo≈ü veri durumunda static kategorilere ge√ß
      debugLog('‚ö†Ô∏è Static kategoriler y√ºkleniyor (veri yok)');
      KATEGORILER = [
        {id:'static1',ad:'Kitap Kampanyasƒ±',tip:'hedef',kayitTarihi:null},
        {id:'static2',ad:'Mevlid Kandili',tip:'hedef',kayitTarihi:null},
        {id:'static3',ad:'Eyl√ºl Kermesi',tip:'hedef',kayitTarihi:null},
        {id:'static4',ad:'Kurs Arabasƒ±',tip:'hedef',kayitTarihi:null},
        {id:'static5',ad:'Talebeye ƒ∞kram',tip:'hedef',kayitTarihi:null},
        {id:'static6',ad:'Teberru',tip:'teberru',kayitTarihi:null}
      ];
    } else {
      debugLog('‚úÖ kategoriler sorgusu tamamlandƒ±, kategori sayƒ±sƒ±:', data.length);
      KATEGORILER = data.map(d=>({
        id: d.id,
        ad: d.ad || 'Adsƒ±z',
        tip: d.tip || 'hedef',
        kayitTarihi: d.kayittarihi || d.createdat || null,
        createdAt: d.createdat || null
      }));
    }
  }catch(e){
    debugError('‚ùå kategorileriYukle hatasƒ±:', e);
    debugLog('‚ö†Ô∏è Static kategoriler y√ºkleniyor (hata durumu)');
    KATEGORILER = [
      {id:'static1',ad:'Kitap Kampanyasƒ±',tip:'hedef',kayitTarihi:null},
      {id:'static2',ad:'Mevlid Kandili',tip:'hedef',kayitTarihi:null},
      {id:'static3',ad:'Eyl√ºl Kermesi',tip:'hedef',kayitTarihi:null},
      {id:'static4',ad:'Kurs Arabasƒ±',tip:'hedef',kayitTarihi:null},
      {id:'static5',ad:'Talebeye ƒ∞kram',tip:'hedef',kayitTarihi:null},
      {id:'static6',ad:'Teberru',tip:'teberru',kayitTarihi:null}
    ];
  }
  debugLog('üîµ renderKategoriList √ßaƒürƒ±lƒ±yor');
  renderKategoriList();
  debugLog('‚úÖ renderKategoriList tamamlandƒ±');
  
  debugLog('üîµ kategorileriFormlaraYay √ßaƒürƒ±lƒ±yor');
  kategorileriFormlaraYay();
  debugLog('‚úÖ kategorileriFormlaraYay tamamlandƒ±');
  
  debugLog('‚úÖ kategorileriYukle tamamlandƒ±, toplam kategori:', KATEGORILER.length);
}
function renderKategoriList(){
  const tb = document.getElementById('kgListe');
  if(!tb) return;
  if(!KATEGORILER.length){
    tb.innerHTML = `<tr><td colspan="4" class="muted">Kategori bulunamadƒ±.</td></tr>`;
    return;
  }
  tb.innerHTML = KATEGORILER.map(k=>{
    const t = k.kayitTarihi ? new Date(k.kayitTarihi).toLocaleString('tr-TR') : '-';
    return `<tr data-id="${escapeHtml(k.id)}">
      <td>${escapeHtml(k.ad)}</td>
      <td>${escapeHtml(k.tip)}</td>
      <td>${escapeHtml(t)}</td>
      <td>
        <button class="btn btn-ghost kg-edit">D√ºzenle</button>
        <button class="btn btn-danger kg-del">Sil</button>
      </td>
    </tr>`;
  }).join('');
  tb.querySelectorAll('.kg-edit').forEach(btn=>{
    btn.addEventListener('click',(e)=>{
      const id=e.target.closest('tr').dataset.id;
      kategoriEditAc(id);
    });
  });
  tb.querySelectorAll('.kg-del').forEach(btn=>{
    btn.addEventListener('click',async (e)=>{
      const id=e.target.closest('tr').dataset.id;
      await kategoriSil(id);
    });
  });
}
function kategorileriFormlaraYay(){
  const hedefKats = KATEGORILER.filter(k=>k.tip==='hedef' || k.tip==='herikisi');
  const teberruKats = KATEGORILER.filter(k=>k.tip==='teberru' || k.tip==='herikisi');
  const elHT = document.getElementById('kategoriHT');
  if(elHT){
    elHT.innerHTML = '<option value="">Se√ßiniz</option>' + hedefKats.map(k=>`<option value="${escapeHtml(k.ad)}">${escapeHtml(k.ad)}</option>`).join('');
  }
  const elHD = document.getElementById('kategoriHD');
  if(elHD){
    elHD.innerHTML = '<option value="">Se√ßiniz</option>' + hedefKats.map(k=>`<option value="${escapeHtml(k.ad)}">${escapeHtml(k.ad)}</option>`).join('');
  }
  const elVG = document.getElementById('kategoriVG');
  if(elVG){
    elVG.innerHTML = '<option value="">Se√ßiniz</option>' + hedefKats.map(k=>`<option value="${escapeHtml(k.ad)}">${escapeHtml(k.ad)}</option>`).join('');
  }
  const elVD = document.getElementById('kategoriVD');
  if(elVD){
    elVD.innerHTML = '<option value="">Se√ßiniz</option>'
      + hedefKats.map(k=>`<option value="${escapeHtml(k.ad)}">${escapeHtml(k.ad)}</option>`).join('')
      + `<option value="Teberru">Teberru</option>`
      + `<option value="Kurban">Kurban</option>`;
  }
}
document.getElementById('kgKaydetBtn').addEventListener('click', async ()=>{
  const ad=(document.getElementById('kgAd').value||'').trim();
  const tip=(document.getElementById('kgTip').value||'hedef');
  if(!ad) return showToast('error', 'Hata', 'Kategori adƒ± bo≈ü olamaz.');
  try{
    const sb = getSb();
    const { data: { user } } = await sb.auth.getUser();
    const { error } = await sb.from('kategoriler').insert({
      id: uuidv4(),
      ad, tip,
      aktif: true,
      kayittarihi: getTurkeyISOString(),
      createdat: getTurkeyISOString(),
      createdby: user?.email || null,
      uid: user?.id || null,
      useragent: userAgent,
      cihaz: cihazTipi()
    });
    if(error) throw error;
    showToast('success', 'Ba≈üarƒ±lƒ±', 'Kategori eklendi.');
    document.getElementById('kgAd').value='';
    await kategorileriYukle();
  }catch(e){ debugError(e); showToast('error', 'Hata', 'Kategori kaydedilemedi.'); }
});
const kgModal=document.getElementById('kgModal');
document.getElementById('kgModalKapat').addEventListener('click',()=>{ kgModal.classList.remove('open'); document.body.style.overflow=''; });
kgModal.addEventListener('click',(e)=>{ if(e.target===kgModal) { kgModal.classList.remove('open'); document.body.style.overflow=''; } });
function kategoriEditAc(id){
  const k = KATEGORILER.find(x=>x.id===id);
  if(!k) return;
  document.getElementById('kgEditId').value = k.id;
  document.getElementById('kgEditAd').value = k.ad;
  document.getElementById('kgEditTip').value = k.tip;
  kgModal.classList.add('open');
  document.body.style.overflow='hidden';
}
document.getElementById('kgEditKaydet').addEventListener('click', async ()=>{
  const id=document.getElementById('kgEditId').value;
  const ad=(document.getElementById('kgEditAd').value||'').trim();
  const tip=document.getElementById('kgEditTip').value;
  if(!id || !ad) return showToast('error', 'Hata', 'Eksik bilgi.');
  try{
    const sb = getSb();
    const { data: { user } } = await sb.auth.getUser();
    const { error } = await sb.from('kategoriler').update({
      ad, tip,
      updatedat: getTurkeyISOString(),
      updatedby: user?.email || null
    }).eq('id', id);
    if(error) throw error;
    showToast('success', 'Ba≈üarƒ±lƒ±', 'Kategori g√ºncellendi.');
    kgModal.classList.remove('open');
    document.body.style.overflow='';
    await kategorileriYukle();
  }catch(e){ debugError(e); showToast('error', 'Hata', 'Kategori g√ºncellenemedi.'); }
});
async function kategoriSil(id){
  if(!confirm('Bu kategoriyi silmek istiyor musunuz?')) return;
  try{
    const sb = getSb();
    const { error } = await sb.from('kategoriler').delete().eq('id', id);
    if(error) throw error;
    showToast('success', 'Ba≈üarƒ±lƒ±', 'Kategori silindi.');
    await kategorileriYukle();
  }catch(e){ debugError(e); showToast('error', 'Hata', 'Kategori silinemedi.'); }
}

/* ===== ƒ∞lk y√ºk - initPage fonksiyonu i√ßinde yapƒ±lƒ±yor ===== */
</script>
</body>
</html>
