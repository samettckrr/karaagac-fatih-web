<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Muhasebe Form Girişi</title>
  <link rel="icon" type="image/png" href="img/logo.png">

  <!-- Stil -->
  <link rel="stylesheet" href="../muhasebe/muhasebe-form.css" />

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="../js/firebase/firebase-init.js"></script>
</head>
<body>
  <div class="toast-bildirim" id="toast">Bildirim</div>

  <div class="ust-logo">
    <h1>KARAAĞAÇ FATİH</h1>
    <h2>Daimi Tekâmülaltı</h2>
  </div>

  <div class="form-container">
    <h2>| Muhasebe Form Girişi</h2>

    <div class="secimler">
      <label for="islemTuru">İşlem Türünü Seçiniz</label>
      <select id="islemTuru">
        <option value="">Seçiniz</option>
        <option value="hedef-tanimlama">Hedef Tanımlama</option>
        <option value="hedef-duzenleme">Hedef Düzenleme</option>
        <option value="veri-giris">Veri Girişi</option>
        <option value="veri-duzeltme">Veri Düzeltme</option>
      </select>

      <label for="kategori">Kategori Seçiniz</label>
      <select id="kategori">
        <option value="">Seçiniz</option>
        <option value="Kitap Kampanyası">Kitap Kampanyası</option>
        <option value="Mevlid Kandili">Mevlid Kandili</option>
        <option value="Muhacir Hediye">Muhacir Hediye/İhtiyaç</option>
        <option value="Talebeye İkram">Talebeye İkram</option>
      </select>
    </div>

    <div id="form-icerik"></div>

    <button class="buton" id="formuGonderBtn">Kaydet ve Formu Gönder</button>
  </div>

  <!-- Onay Modali (özet / kaydet) -->
  <div class="modal" id="onayModali">
    <div class="modal-icerik">
      <div class="modal-kapat" id="modalKapatBtn">✖</div>
      <h3 id="modal-baslik">İşlem Özeti</h3>
      <div id="modal-veriler" class="modal-veriler"></div>
      <div class="modal-butonlar">
        <button class="btn-kaydet" id="modal-kaydet-btn">Kaydet ve Formu Gönder</button>
      </div>
    </div>
  </div>

  <!-- Veri DÜZENLE Modali -->
  <div class="modal" id="veriDuzenleModal">
    <div class="modal-icerik">
      <div class="modal-kapat" id="vdModalKapat">✖</div>
      <h3 id="vdModalBaslik">Veri Düzenle</h3>
      <div class="modal-veriler">
        <input type="hidden" id="vdDocId" />
        <div class="grid">
          <label>Ad Soyad</label>
          <input type="text" id="vdAdSoyad" />

          <label>Miktar (₺)</label>
          <input type="number" id="vdMiktar" min="0" />

          <label>Giriş</label>
          <select id="vdNereyeGeldi">
            <option value="Nakit">Nakit</option>
            <option value="Banka">Banka</option>
          </select>

          <label>Tür</label>
          <select id="vdTur">
            <option value="hedef">Hedef</option>
            <option value="teberru">Teberru</option>
          </select>

          <label>Açıklama (opsiyonel)</label>
          <input type="text" id="vdAciklama" placeholder="-" />
        </div>
      </div>
      <div class="modal-butonlar">
        <button class="btn-kaydet" id="vdKaydetBtn">Kaydet</button>
      </div>
    </div>
  </div>

  <script>
  document.addEventListener("DOMContentLoaded", function () {
    const db = firebase.firestore();

    const personeller = [
      "Muhsin Çelik", "Faruk Nafiz Özgan", "İbrahim Ay", "Samet Çakır",
      "Kerem Kocaoğlu", "Serhan Durak", "Mahmut Solmaz", "Mehmet Taha Keskin", "Ahmetali Emre Şahin"
    ];

    const islemSelect      = document.getElementById("islemTuru");
    const kategoriSelect   = document.getElementById("kategori");
    const formIcerik       = document.getElementById("form-icerik");
    const onayModal        = document.getElementById("onayModali");
    const modalBaslik      = document.getElementById("modal-baslik");
    const modalVeriler     = document.getElementById("modal-veriler");
    const modalKaydetBtn   = document.getElementById("modal-kaydet-btn");
    const modalKapatBtn    = document.getElementById("modalKapatBtn");

    // Veri düzenleme modalı
    const vdModal          = document.getElementById("veriDuzenleModal");
    const vdModalKapat     = document.getElementById("vdModalKapat");
    const vdDocId          = document.getElementById("vdDocId");
    const vdAdSoyad        = document.getElementById("vdAdSoyad");
    const vdMiktar         = document.getElementById("vdMiktar");
    const vdNereyeGeldi    = document.getElementById("vdNereyeGeldi");
    const vdTur            = document.getElementById("vdTur");
    const vdAciklama       = document.getElementById("vdAciklama");
    const vdKaydetBtn      = document.getElementById("vdKaydetBtn");

    // Güvenli sayı çevirici: "55.000" -> 55000
    function toNum(v){
      if (typeof v === 'number') return v;
      if (typeof v === 'string') {
        const n = Number(v.replace(/\./g,'').replace(',', '.'));
        return isNaN(n) ? 0 : n;
      }
      return 0;
    }

    // ==== FORM GÖVDELERİ ====
    window.formuGuncelle = function () {
      const islem = islemSelect.value;
      const kat = kategoriSelect.value;
      formIcerik.innerHTML = "";
      if (!islem || !kat) return;

      // HEDEF TANIMLAMA
      if (islem === "hedef-tanimlama") {
        let html = `<table class="mini-table"><tr><th>Personel</th><th>Hedef (₺)</th></tr>`;
        personeller.forEach(p => {
          html += `<tr>
            <td>${p}</td>
            <td><input type="number" id="hedef-${p}" placeholder="0" min="0"></td>
          </tr>`;
        });
        html += `</table>`;
        formIcerik.innerHTML = html;
      }

      // HEDEF DÜZENLEME
      if (islem === "hedef-duzenleme") {
        formIcerik.innerHTML = `
          <div class="grid">
            <label>Personel Seçiniz</label>
            <select id="hd-personel">
              ${personeller.map(p => `<option value="${p}">${p}</option>`).join('')}
            </select>

            <label>Mevcut Hedef</label>
            <div id="hd-mevcut" class="readonly">₺0</div>

            <label>Yeni Hedef (₺)</label>
            <input type="number" id="hd-yeni" min="0" placeholder="0" />
          </div>
          <div style="margin-top:10px;display:flex;gap:10px;flex-wrap:wrap">
            <button class="buton" id="hdGetirBtn">Mevcut Hedefi Getir</button>
            <button class="buton" id="hdKaydetBtn">Kaydet</button>
          </div>
        `;
        document.getElementById('hdGetirBtn').addEventListener('click', hedefMevcutGetir);
        document.getElementById('hdKaydetBtn').addEventListener('click', hedefDuzenleOnay);
        // Sayfa açılır açılmaz bir kez getir
        hedefMevcutGetir();
      }

      // VERİ GİRİŞİ
      if (islem === "veri-giris") {
        formIcerik.innerHTML = `
          <label>Personeli Seçiniz</label>
          <select id="giris-personel">
            ${personeller.map(p => `<option value="${p}">${p}</option>`).join("")}
          </select>

          <label>Parayı Verenin Adı Soyadı</label>
          <input type="text" id="giris-veren" placeholder="Örn: Mehmet Yılmaz" />

          <label>Miktar (₺)</label>
          <input type="number" id="giris-miktar" min="0" />

          <label>Para Nereye Geldi?</label>
          <select id="giris-turu">
            <option value="Nakit">Nakit</option>
            <option value="Banka">Banka</option>
          </select>

          <label>Teberru mu? Hedef mi?</label>
          <select id="teberru-hedef">
            <option value="hedef" selected>Hedef</option>
            <option value="teberru">Teberru</option>
          </select>

          <label>Açıklama (opsiyonel)</label>
          <input type="text" id="giris-aciklama" placeholder="-" />
        `;
      }

      // VERİ DÜZELTME
      if (islem === "veri-duzeltme") {
        formIcerik.innerHTML = `
          <div class="grid">
            <label>Personel (opsiyonel)</label>
            <select id="vd-personel">
              <option value="">(Tümü)</option>
              ${personeller.map(p => `<option value="${p}">${p}</option>`).join("")}
            </select>
          </div>
          <div style="margin:10px 0;display:flex;gap:10px;flex-wrap:wrap">
            <button class="buton" id="vdListeleBtn">Listele</button>
          </div>
          <div id="vd-liste"></div>
        `;
        document.getElementById('vdListeleBtn').addEventListener('click', verileriListele);
      }
    };

    // ==== FORM SUBMIT ====
    window.formuGonder = function () {
      const islem = islemSelect.value;
      const kat = kategoriSelect.value;
      if (!islem || !kat) return toastGoster("Lütfen işlem türü ve kategori seçiniz.", true);

      // HEDEF TANIMLAMA
      if (islem === "hedef-tanimlama") {
        let liste = [];
        personeller.forEach(p => {
          const el = document.getElementById("hedef-" + p);
          const val = toNum(el && el.value);
          if (val > 0) liste.push({ kategori: kat, personel: p, hedef: val });
        });
        if (liste.length === 0) return toastGoster("Hedef girişi yapılmadı", true);

        modalBaslik.innerText = `Hedef Tanımlaması > ${kat}`;
        modalVeriler.innerHTML = liste.map(l => `<p>➤ ${l.personel} → ${l.hedef.toLocaleString('tr-TR')} ₺</p>`).join("");
        modalKaydetBtn.onclick = () => hedefleriKaydet(liste);
        onayModal.style.display = "flex";
      }

      // VERİ GİRİŞ
      if (islem === "veri-giris") {
        const personel     = document.getElementById("giris-personel").value;
        const veren        = document.getElementById("giris-veren").value.trim();
        const miktarStr    = document.getElementById("giris-miktar").value;
        const nereyeGeldi  = document.getElementById("giris-turu").value;
        const turSel       = document.getElementById("teberru-hedef").value;  // hedef/teberru
        const aciklama     = document.getElementById("giris-aciklama").value.trim();

        const miktar = toNum(miktarStr);
        if (!personel || !veren || !miktar || !nereyeGeldi || !turSel) {
          return toastGoster("Tüm alanlar doldurulmalı", true);
        }

        const veri = {
          kategori: kat,
          personel,
          adSoyad: veren,
          miktar,
          nereyeGeldi,
          tur: turSel.toLowerCase(),   // "hedef" | "teberru"
          aciklama: aciklama || '',
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        modalBaslik.innerText = `Veri Girişi > ${kat}`;
        modalVeriler.innerHTML = `
          <p>Personel: ${personel}</p>
          <p>Veren: ${veren}</p>
          <p>Miktar: ${miktar.toLocaleString('tr-TR')} ₺</p>
          <p>Giriş: ${nereyeGeldi}</p>
          <p>Tür: ${turSel === 'teberru' ? 'Teberru' : 'Hedef'}</p>
          ${aciklama ? `<p>Açıklama: ${aciklama}</p>`: '' }
        `;
        modalKaydetBtn.onclick = () => veriKaydet(veri);
        onayModal.style.display = "flex";
      }

      // HEDEF DÜZENLEME → kendi Kaydet butonu var (hedefDuzenleOnay)
      // VERİ DÜZELTME → 'Listele' ve satır butonları ile yönetilir
    };

    // ==== HEDEF: MEVCUT GETİR & DÜZENLE ====
    async function hedefMevcutGetir() {
      const kat = kategoriSelect.value;
      const per = document.getElementById('hd-personel').value;
      if (!kat || !per) return;

      const ref = db.collection("hedefler").doc(`${kat}_${per}`);
      const snap = await ref.get();
      const mevcut = snap.exists ? toNum(snap.data().hedef) : 0;
      document.getElementById('hd-mevcut').textContent = '₺' + mevcut.toLocaleString('tr-TR');
      document.getElementById('hd-yeni').value = mevcut || '';
    }

    function hedefDuzenleOnay() {
      const kat = kategoriSelect.value;
      const per = document.getElementById('hd-personel').value;
      const yeni = toNum(document.getElementById('hd-yeni').value);
      if (!kat || !per) return toastGoster("Kategori ve personel seçiniz.", true);

      modalBaslik.innerText = `Hedef Düzenleme > ${kat}`;
      modalVeriler.innerHTML = `
        <p>Personel: ${per}</p>
        <p>Yeni Hedef: ${yeni.toLocaleString('tr-TR')} ₺</p>
      `;
      modalKaydetBtn.onclick = () => hedefDuzenleKaydet({ kategori: kat, personel: per, hedef: yeni });
      onayModal.style.display = "flex";
    }

    async function hedefDuzenleKaydet(h) {
      try {
        const ref = db.collection("hedefler").doc(`${h.kategori}_${h.personel}`);
        await ref.set({
          kategori: h.kategori,
          personel: h.personel,
          hedef: toNum(h.hedef),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
        toastGoster("✅ Hedef güncellendi.");
      } catch (e) {
        console.error(e);
        toastGoster("Hedef güncellenirken hata oluştu.", true);
      } finally {
        kapatOnayModal();
        hedefMevcutGetir();
      }
    }

    // ==== VERİ: LİSTELE / DÜZENLE / SİL ====
    async function verileriListele() {
      const kat = kategoriSelect.value;
      const per = document.getElementById('vd-personel').value;
      const kon = document.getElementById('vd-liste');

      kon.innerHTML = 'Yükleniyor...';

      try {
        let q = db.collection('veriler').where('kategori','==', kat);
        if (per) q = q.where('personel','==', per);
        q = q.orderBy('createdAt','desc'); // index gerekebilir

        const snap = await q.limit(100).get();
        if (snap.empty) {
          kon.innerHTML = `<div class="info">Kayıt bulunamadı.</div>`;
          return;
        }

        // tablo
        let html = `
          <div class="tablo-kapsayici">
            <table class="mini-table">
              <thead>
                <tr>
                  <th>Tarih</th><th>Personel</th><th>Ad Soyad</th><th>Miktar</th><th>Giriş</th><th>Tür</th><th>Açıklama</th><th>İşlem</th>
                </tr>
              </thead>
              <tbody>
        `;
        snap.forEach(doc => {
          const d = doc.data();
          const t = d.createdAt?.toDate ? d.createdAt.toDate() : (d.createdAt ? new Date(d.createdAt) : null);
          const tStr = t ? t.toLocaleString('tr-TR') : (d.tarih || '-');
          html += `
            <tr data-id="${doc.id}">
              <td>${tStr}</td>
              <td>${d.personel || '-'}</td>
              <td>${d.adSoyad || d.veren || '-'}</td>
              <td>₺${toNum(d.miktar).toLocaleString('tr-TR')}</td>
              <td>${d.nereyeGeldi || '-'}</td>
              <td>${(d.tur || 'hedef')}</td>
              <td>${d.aciklama || '-'}</td>
              <td>
                <button class="btn-kucuk duzenle">Düzenle</button>
                <button class="btn-kucuk sil">Sil</button>
              </td>
            </tr>
          `;
        });
        html += `</tbody></table></div>`;
        kon.innerHTML = html;

        // Event delegation
        kon.querySelector('tbody').addEventListener('click', async (e) => {
          const tr = e.target.closest('tr');
          if (!tr) return;
          const id = tr.getAttribute('data-id');
          if (e.target.classList.contains('duzenle')) {
            veriDuzenleAc(id);
          }
          if (e.target.classList.contains('sil')) {
            veriSil(id);
          }
        });

      } catch (e) {
        console.error(e);
        // olası index uyarısı
        toastGoster("Liste alınırken hata oluştu. Gerekirse Firestore indeksini oluşturun.", true);
        kon.innerHTML = '';
      }
    }

    async function veriDuzenleAc(docId) {
      const ref = db.collection('veriler').doc(docId);
      const snap = await ref.get();
      if (!snap.exists) return toastGoster("Kayıt bulunamadı.", true);

      const d = snap.data();
      vdDocId.value     = docId;
      vdAdSoyad.value   = d.adSoyad || d.veren || '';
      vdMiktar.value    = toNum(d.miktar);
      vdNereyeGeldi.value = d.nereyeGeldi || 'Nakit';
      vdTur.value       = (d.tur || 'hedef');
      vdAciklama.value  = d.aciklama || '';

      vdModal.style.display = 'flex';
    }

    vdKaydetBtn.addEventListener('click', async () => {
      const id = vdDocId.value;
      if (!id) return;

      const ref = db.collection('veriler').doc(id);
      try {
        await ref.set({
          adSoyad: vdAdSoyad.value.trim(),
          miktar: toNum(vdMiktar.value),
          nereyeGeldi: vdNereyeGeldi.value,
          tur: vdTur.value,
          aciklama: vdAciklama.value.trim(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });

        toastGoster("✅ Kayıt güncellendi.");
        vdModal.style.display = 'none';
        // Listeyi tazele
        if (document.getElementById('vd-liste')) verileriListele();
      } catch (e) {
        console.error(e);
        toastGoster("Güncelleme sırasında hata oluştu.", true);
      }
    });

    async function veriSil(docId) {
      if (!confirm("Bu kaydı silmek istediğinize emin misiniz?")) return;
      try {
        await db.collection('veriler').doc(docId).delete();
        toastGoster("🗑️ Kayıt silindi.");
        verileriListele();
      } catch (e) {
        console.error(e);
        toastGoster("Silme sırasında hata oluştu.", true);
      }
    }

    // ==== KAYIT FONKSİYONLARI ====
    async function hedefleriKaydet(liste) {
      try {
        const batch = db.batch();
        liste.forEach(h => {
          const ref = db.collection("hedefler").doc(`${h.kategori}_${h.personel}`);
          batch.set(ref, {
            kategori: h.kategori,
            personel: h.personel,
            hedef: toNum(h.hedef),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          }, { merge: true });
        });
        await batch.commit();
        toastGoster("✅ Hedef(ler) başarıyla kaydedildi.");
      } catch (e) {
        console.error(e);
        toastGoster("Hedef kaydedilirken hata oluştu.", true);
      } finally {
        kapatOnayModal();
      }
    }

    async function veriKaydet(veri) {
      try {
        await db.collection("veriler").add(veri);
        toastGoster("✅ Veri başarıyla kaydedildi.");
      } catch (e) {
        console.error(e);
        toastGoster("Veri kaydedilirken hata oluştu.", true);
      } finally {
        kapatOnayModal();
      }
    }

    // ==== MODAL / TOAST ====
    function kapatOnayModal() { onayModal.style.display = "none"; }
    modalKapatBtn.addEventListener('click', kapatOnayModal);
    onayModal.addEventListener('click', (e)=>{ if(e.target===onayModal) kapatOnayModal(); });

    vdModalKapat.addEventListener('click', ()=> vdModal.style.display='none');
    vdModal.addEventListener('click', (e)=>{ if(e.target===vdModal) vdModal.style.display='none'; });

    function toastGoster(mesaj, hata = false) {
      const t = document.getElementById("toast");
      t.textContent = mesaj;
      t.className = "toast-bildirim" + (hata ? " hata" : "");
      t.style.display = "block";
      requestAnimationFrame(()=> t.style.opacity = 1);
      setTimeout(() => {
        t.style.opacity = 0;
        setTimeout(() => t.style.display = "none", 300);
      }, 2500);
    }

    // ==== EVENT ====
    document.getElementById("islemTuru").addEventListener("change", formuGuncelle);
    document.getElementById("kategori").addEventListener("change", formuGuncelle);
    document.getElementById("formuGonderBtn").addEventListener("click", formuGonder);
  });
  </script>
</body>
</html>
