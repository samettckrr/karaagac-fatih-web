<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>KF | Aidat¬∑Kitap ¬∑ Hedef¬∑Teberru¬∑Kurban</title>
<link rel="icon" type="image/png" href="../img/logo.png" />

<style>
  /* ========== Tema ========== */
  :root{
    --appbar-h:56px;
    --radius:14px; --shadow:0 12px 28px rgba(0,0,0,.12);
    --bg:#0f172a; --card:rgba(15,23,42,.98);
    --stroke:rgba(148,163,184,.16); --text:#e5e7eb; --muted:#9aa4b2;
    --brand:#38bdf8; --brand2:#0ea5e9;
    --surface:rgba(2,6,23,.10); --surface2:rgba(2,6,23,.06);
    --danger:#ef4444; --success:#22c55e;
    --gap-lg:20px; --gap:14px; --gap-sm:10px;
  }
  @media (prefers-color-scheme: light){
    :root{
      --bg:#f3f6fc; --card:#ffffff; --stroke:rgba(15,23,42,.12);
      --text:#0b1220; --muted:#4b5563; --surface:#f1f5ff; --surface2:#f6f8ff;
      --brand:#0ea5e9; --brand2:#0284c7;
    }
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:'Segoe UI',system-ui,-apple-system,Arial,sans-serif}
  img,svg,video{max-width:100%;height:auto;display:block}

  /* ========== Appbar ========== */
  .appbar{
    position:sticky; top:0; z-index:60; height:var(--appbar-h);
    background:var(--card); backdrop-filter:blur(10px);
    border-bottom:1px solid var(--stroke);
    display:flex; align-items:center; gap:10px; padding:0 12px;
  }
  .brand{display:flex; align-items:center; gap:10px; cursor:pointer}
  .brand img{width:24px; height:24px}
  .brand span{font-weight:900; letter-spacing:.02em}
  .nav-center{margin:0 auto; height:100%}
  .nav-list{display:flex; gap:22px; align-items:center; height:100%; list-style:none; margin:0; padding:0}
  .nav-item{position:relative; height:100%}
  .nav-btn{height:100%; display:flex; align-items:center; gap:6px; font-weight:800; cursor:pointer}
  .nav-btn:hover{color:var(--brand)}
  .caret{font-size:12px; opacity:.6}
  .dropdown{position:absolute; top:100%; left:0; min-width:240px; background:var(--card); border:1px solid var(--stroke); border-radius:12px; box-shadow:var(--shadow); padding:8px; display:none}
  .dropdown a{display:flex; align-items:center; gap:8px; padding:10px 12px; border-radius:10px; color:var(--text); text-decoration:none}
  .dropdown a:hover{background:var(--surface2)}
  .nav-item.open .dropdown{display:block}
  .nav-right{display:flex; gap:8px; align-items:center}
  .btn{border:1px solid var(--stroke); background:var(--card); color:var(--text); border-radius:999px; padding:8px 12px; cursor:pointer; white-space:nowrap}
  .hamb{display:none}
  .iconbtn{position:relative; border:1px solid var(--stroke); background:var(--card); color:var(--text); border-radius:999px; padding:8px 12px; cursor:pointer; display:flex; align-items:center; gap:8px}
  .badge{position:absolute; top:-6px; right:-6px; background:var(--danger); color:#fff; font-size:11px; padding:2px 6px; border-radius:999px; border:2px solid var(--card)}
  .drop-right{left:auto; right:0}
  .avatar{width:22px;height:22px;border-radius:999px;background:linear-gradient(180deg,#94a3b8,#64748b)}
  @media (max-width: 960px){ .nav-center{display:none} .hamb{display:inline-flex} }

  /* ========== Drawer ========== */
  .drawer{position:fixed; top:var(--appbar-h); right:0; bottom:0; left:34%; transform:translateX(100%); transition:.25s; background:var(--card); border-left:1px solid var(--stroke); z-index:70; overflow:auto; padding:16px}
  .drawer.open{transform:translateX(0)}
  .drawer .panel-title{margin:14px 4px 6px; font-weight:800; color:var(--muted); font-size:13px}
  .drawer a{display:block; padding:12px; border-radius:12px; border:1px solid var(--stroke); margin:8px 0; color:var(--text); background:var(--surface2)}
  .drawer a:hover{background:var(--surface)}

  /* ========== Layout ========== */
  .container{max-width:1120px; margin:0 auto; padding:18px; display:grid; gap:var(--gap-lg)}
  .card{background:var(--card); border:1px solid var(--stroke); border-radius:16px; box-shadow:var(--shadow); padding:16px}
  .stack-lg{display:grid; gap:var(--gap-lg)}
  .stack   {display:grid; gap:var(--gap)}
  .row{display:grid; grid-template-columns:repeat(12,minmax(0,1fr)); gap:var(--gap)}
  .col-6{grid-column:span 6} .col-4{grid-column:span 4} .col-3{grid-column:span 3} .col-12{grid-column:span 12}

  @media (max-width: 960px){
    .container{padding:14px}
    .row{grid-template-columns:repeat(6,minmax(0,1fr))}
    .col-6{grid-column:span 6} .col-4{grid-column:span 6} .col-3{grid-column:span 3} .col-12{grid-column:span 6}
  }
  @media (max-width: 640px){
    .row{grid-template-columns:repeat(4,minmax(0,1fr))}
    .col-6,.col-4,.col-3,.col-12{grid-column:span 4}
  }

  .muted{color:var(--muted)}

  /* ========== Form ========== */
  label{display:block; margin-bottom:6px; font-size:13px; color:var(--muted)}
  .field{display:flex; flex-direction:column; gap:6px}
  input,select,textarea{
    width:100%; height:44px; padding:10px 12px; border:1px solid var(--stroke);
    border-radius:12px; background:var(--surface2); color:var(--text); outline:none;
  }
  textarea{height:auto; min-height:88px; resize:vertical}
  input:focus,select:focus,textarea:focus{ box-shadow:0 0 0 3px rgba(14,165,233,.25); border-color:#0ea5e9; background:var(--surface) }
  .hint{font-size:12px; color:var(--muted)}

  /* ========== Minimal Tabs (√ºst) ========== */
  .mini-tabs{
    display:flex; gap:16px; align-items:center;
    border-bottom:1px solid rgba(148,163,184,.16);
    overflow-x:auto; scrollbar-width:none;
  }
  .mini-tabs::-webkit-scrollbar{display:none}
  .mini-tab{
    background:none; border:none; padding:10px 0; font-weight:700; color:var(--muted); cursor:pointer;
    position:relative; white-space:nowrap; font-size:14px;
  }
  .mini-tab.active{color:var(--text)}
  .mini-tab.active::after{
    content:''; position:absolute; left:0; right:0; bottom:-1px; height:2px;
    background:linear-gradient(90deg,var(--brand),var(--brand2));
    border-radius:99px;
  }

  /* ========== Hedef-Teberru alt tabbar ========== */
  .sub-tabs{
    display:flex; gap:14px; margin-bottom:8px;
    overflow-x:auto; scrollbar-width:none;
    padding:3px 3px 2px;
    background:rgba(15,23,42,.04);
    border:1px solid rgba(148,163,184,.08);
    border-radius:999px;
  }
  .sub-tabs::-webkit-scrollbar{display:none}

  .sub-tab{
    background:transparent;
    border:none;
    padding:7px 14px 8px;
    font-weight:600;
    color:var(--muted);
    cursor:pointer;
    white-space:nowrap;
    position:relative;
    font-size:13px;
    border-radius:999px;
    transition:.15s ease-out;
  }

  .sub-tab:hover{
    background:rgba(148,163,184,.07);
    color:var(--text);
  }

  .sub-tab.active{
    color:var(--text);
    background:rgba(14,165,233,.16);
    box-shadow:0 8px 18px rgba(14,165,233,.22);
  }

  .sub-tab.active::after{
    content:'';
    position:absolute;
    right:10px;
    top:8px;
    width:6px; height:6px;
    background:var(--brand);
    border-radius:999px;
  }

  /* ========== Buttons ========== */
  .actions{display:flex; gap:10px; flex-wrap:wrap}
  .cta{border:none; border-radius:999px; padding:10px 18px; font-weight:800; cursor:pointer; background:linear-gradient(180deg,var(--brand),var(--brand2)); color:#fff}
  .ghost{border:1px solid var(--stroke); background:var(--surface2); border-radius:999px; padding:10px 14px; cursor:pointer}

  /* ========== Tables ========== */
  .table-wrap{border:1px solid var(--stroke); border-radius:14px; overflow:auto; background:var(--card)}
  table{width:100%; border-collapse:collapse; min-width:860px}
  th,td{padding:12px 14px; text-align:left; border-bottom:1px solid var(--stroke); font-size:14px}
  thead th{position:sticky; top:0; background:var(--surface)}

  /* ========== Modal & Toast ========== */
  .modal{display:none; position:fixed; inset:0; background:rgba(2,6,23,.6); z-index:99; align-items:center; justify-content:center; padding:18px}
  .modal.show{display:flex}
  .modal-icerik{background:var(--card); border:1px solid var(--stroke); width:96%; max-width:640px; border-radius:16px; box-shadow:var(--shadow); padding:18px; position:relative; display:grid; gap:var(--gap)}
  .modal-kapat{position:absolute; right:12px; top:10px; font-size:22px; cursor:pointer; color:var(--danger)}
  .toast{position:fixed; left:50%; bottom:24px; transform:translateX(-50%) translateY(20px); background:rgba(2,6,23,.95); color:#fff; border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:10px 12px; opacity:0; pointer-events:none; transition:opacity .25s, transform .25s; z-index:200}
  .toast.show{opacity:1; transform:translateX(-50%) translateY(0)}

  /* ==== Y√ºkleniyor ==== */
  .loading{
    display:flex; align-items:center; gap:10px;
    padding:10px 12px; border:1px dashed var(--stroke);
    border-radius:12px; background:var(--surface);
    margin-top:10px;
  }
  .spinner{
    width:18px; height:18px; border:2px solid rgba(148,163,184,.4);
    border-top-color: var(--brand); border-radius:50%;
    animation: spin .8s linear infinite;
  }
  @keyframes spin{ to{ transform: rotate(360deg); } }

  .btn-ghost{
    background:transparent; border:1px solid rgba(148,163,184,.16); border-radius:999px;
    padding:4px 10px; font-size:12px; cursor:pointer; color:var(--text);
  }

  @media (max-width:720px){
    .mini-tabs{gap:10px}
    .sub-tabs{gap:10px}
  }
</style>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="../js/firebase/firebase-init.js"></script>
</head>
<body>

<!-- APPBAR -->
<div class="appbar">
  <div class="brand" onclick="location.href='../panel.html'">
    <img src="../img/logo.png" alt="logo"><span>KARAAƒûA√á FATƒ∞H</span>
  </div>
  <nav class="nav-center"><ul class="nav-list" id="navMain"></ul></nav>
  <div class="nav-right">
    <button class="btn hamb" id="hamburger" title="Men√º">‚ò∞</button>
    <div class="nav-item">
      <button class="iconbtn" id="btnNotif" title="Bildirimler">üîî
        <span class="badge" id="notifBadge" style="display:none">0</span>
      </button>
      <div class="dropdown drop-right" id="notifDropdown">
        <div class="muted" style="padding:6px 8px">Son bildirimler</div>
        <div id="notifList" style="max-height:300px;overflow:auto"></div>
        <a href="/diger/bildirim.html">T√ºm bildirimleri g√∂r ‚Üí</a>
      </div>
    </div>
    <div class="nav-item">
      <button class="iconbtn" id="btnProfile" title="Profil">
        <span class="avatar"></span> <span id="profName" class="muted">Profil</span>
      </button>
      <div class="dropdown drop-right" id="profDropdown">
        <a href="/diger/kullanici-yonetimi.html" >üë§ Profil</a>
        <a href="/diger/sistem-ayarlari.html" >‚öôÔ∏è Sistem Ayarlarƒ±</a>
        <a href="#" id="btnLogout">üö™ √áƒ±kƒ±≈ü Yap</a>
      </div>
    </div>
  </div>
</div>
<aside class="drawer" id="drawer"></aside>

<!-- CONTENT -->
<main class="container stack-lg">
  <!-- Ba≈ülƒ±k + √úst Se√ßim -->
  <section class="card stack" id="ustKart">
    <div class="row">
      <div class="col-12">
        <h2 style="margin:0">Form Giri≈üi & D√ºzenleme</h2>
      </div>
      <div class="col-12 muted">Aidat, kitap, hedef, teberru ve kurban i√ßin formlarƒ± aynƒ± panelden y√∂netin.</div>
    </div>
    <!-- √úst minimal tabs (Aidat & Kitap | Hedef & Teberru) -->
    <div class="mini-tabs" id="mainFormTabs">
      <button class="mini-tab active" data-target="aidatKitapWrap">Aidat &amp; Kitap</button>
      <button class="mini-tab" data-target="hedefTeberruWrap">Hedef &amp; Teberru</button>
    </div>
  </section>

  <!-- Aidat ¬∑ Kitap -->
  <section class="card stack" id="aidatKitapWrap">
    <h3 style="margin:0">Aidat ¬∑ Kitap</h3>
    <div class="muted">Koleksiyonlar: <strong>talebe_borclar</strong> &amp; <strong>aidat_kitap</strong></div>

    <div class="row">
      <!-- Bor√ß Tanƒ±mlama -->
      <div class="col-6">
        <div class="card stack">
          <h4 style="margin:0">1) Talebe Bor√ß Tanƒ±mlama</h4>

          <div class="field">
            <label>Talebe Adƒ±</label>
            <input id="talebeAd" placeholder="√ñrn: Mehmet Yƒ±lmaz" />
          </div>

          <div class="row">
            <div class="col-6 field">
              <label>Umumi Aidat (‚Ç∫)</label>
              <input type="number" id="aidatTutar" placeholder="7500" />
            </div>
            <div class="col-6 field">
              <label>Aidat ƒ∞ndirimi</label>
              <select id="aidatIndirim">
                <option value="0">ƒ∞ndirim Yok (0%)</option>
                <option value="0.25">Karde≈ü (%25)</option>
                <option value="0.5">Personel (%50)</option>
                <option value="1">Muhacir (%100)</option>
              </select>
            </div>
          </div>

          <div class="row">
            <div class="col-6 field">
              <label>Umumi Kitap (‚Ç∫)</label>
              <input type="number" id="kitapTutar" placeholder="2250" />
            </div>
            <div class="col-6 field">
              <label>Kitap ƒ∞ndirimi</label>
              <select id="kitapIndirim">
                <option value="0">ƒ∞ndirim Yok</option>
                <option value="custom">ƒ∞ndirim Var (Rakam Gir)</option>
              </select>
            </div>
          </div>

          <div id="kitapIndirimWrap" class="field" style="display:none">
            <label>Kitap ƒ∞ndirimi (‚Ç∫)</label>
            <input type="number" id="kitapIndirimMiktar" placeholder="0" />
          </div>

          <div class="hint" id="kayitPreview">√ñnizleme ‚Äî</div>
          <div class="actions"><button class="cta" id="btnBorcuKaydet">Kaydet</button></div>
        </div>
      </div>

      <!-- Tahsilat -->
      <div class="col-6">
        <div class="card stack">
          <h4 style="margin:0">2) Tahsilat (√ñdeme Giri≈üi)</h4>

          <div class="field">
            <label>Talebe Adƒ±</label>
            <input id="odemeTalebe" placeholder="√ñrn: Mehmet Yƒ±lmaz" />
          </div>

          <div class="row">
            <div class="col-6 field">
              <label>ƒ∞≈ülem T√ºr√º</label>
              <select id="odemeTuru">
                <option value="Aidat">Aidat</option>
                <option value="Kitap">Kitap</option>
              </select>
            </div>
            <div class="col-6 field">
              <label>Miktar (‚Ç∫)</label>
              <input type="number" id="odemeMiktar" placeholder="0" />
            </div>
          </div>

          <div class="field">
            <label>√ñdeme Y√∂ntemi</label>
            <select id="odemeYontemi">
              <option value="Nakit">Nakit</option>
              <option value="Banka">Banka</option>
            </select>
          </div>

          <div class="hint" id="odemePreview">√ñnizleme ‚Äî</div>
          <div class="actions"><button class="cta" id="btnOdemeKaydet">Kaydet</button></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Hedef ¬∑ Teberru -->
  <section class="card stack" id="hedefTeberruWrap" style="display:none">
    <h3 style="margin:0">Hedef ¬∑ Teberru</h3>
    <div class="muted">Koleksiyonlar: <strong>hedefler</strong>, <strong>veriler</strong>, <strong>kategoriler</strong></div>

    <!-- alt mini tabs -->
    <div class="sub-tabs" id="htSubTabs">
      <button type="button" class="sub-tab active" data-open="sec-ht">Hedef Tanƒ±mlama</button>
      <button type="button" class="sub-tab" data-open="sec-hd">Hedef D√ºzenleme</button>
      <button type="button" class="sub-tab" data-open="sec-vg">Veri Giri≈üi</button>
      <button type="button" class="sub-tab" data-open="sec-vd">Veri D√ºzeltme</button>
      <button type="button" class="sub-tab" data-open="sec-kg">Kategori Y√∂netimi</button>
    </div>

    <!-- 1) Hedef Tanƒ±mla -->
    <section id="sec-ht" class="stack">
      <div class="row">
        <div class="col-12 field">
          <label>Kategori</label>
          <select id="kategoriHT">
            <option value="">Y√ºkleniyor‚Ä¶</option>
          </select>
        </div>
      </div>

      <div class="table-wrap">
        <table style="min-width:520px">
          <thead><tr><th>Personel</th><th>Hedef (‚Ç∫)</th></tr></thead>
          <tbody id="hedefTanimTBody"></tbody>
        </table>
      </div>

      <div class="actions"><button class="cta" id="btnHedefTanimOnay">Kaydet (√ñzet)</button></div>
    </section>

    <!-- 2) Hedef D√ºzenle -->
    <section id="sec-hd" class="stack" style="display:none">
      <div class="row">
        <div class="col-6 field">
          <label>Kategori</label>
          <select id="kategoriHD">
            <option value="">Y√ºkleniyor‚Ä¶</option>
          </select>
        </div>
        <div class="col-6 field">
          <label>Personel</label>
          <select id="hd-personel"></select>
        </div>
      </div>

      <div class="field">
        <label>Mevcut Hedef</label>
        <div id="hd-mevcut" class="hint">‚Ç∫0</div>
      </div>

      <div class="field">
        <label>Yeni Hedef (‚Ç∫)</label>
        <input type="number" id="hd-yeni" min="0" placeholder="0" />
      </div>

      <div class="actions">
        <button class="ghost" id="hdGetirBtn">Mevcut Hedefi Getir</button>
        <button class="cta" id="hdKaydetBtn">Kaydet (√ñzet)</button>
      </div>
    </section>

    <!-- 3) Veri Giri≈üi -->
    <section id="sec-vg" class="stack" style="display:none">
      <!-- MOD: Hedef / Teberru / Kurban se√ßimi -->
      <div class="sub-tabs" id="vgMode">
        <button type="button" class="sub-tab active" data-mode="hedef">Hedef</button>
        <button type="button" class="sub-tab" data-mode="teberru">Teberru</button>
        <button type="button" class="sub-tab" data-mode="kurban">Kurban</button>
      </div>

      <!-- HEDEF FORMU -->
      <div id="formHedef" class="stack">
        <div class="row" id="vgKatRow">
          <div class="col-6 field">
            <label>Kategori</label>
            <select id="kategoriVG">
              <option value="">Y√ºkleniyor‚Ä¶</option>
            </select>
          </div>
          <div class="col-6 field">
            <label>Personel</label>
            <select id="giris-personel"></select>
          </div>
        </div>

        <div class="field">
          <label>Parayƒ± Verenin Adƒ± Soyadƒ±</label>
          <input id="giris-veren" placeholder="√ñrn: Mehmet Yƒ±lmaz" />
        </div>

        <div class="row">
          <div class="col-6 field">
            <label>Miktar (‚Ç∫)</label>
            <input type="number" id="giris-miktar" min="0" />
          </div>
          <div class="col-6 field">
            <label>Para Nereye Geldi?</label>
            <select id="giris-turu">
              <option value="Nakit">Nakit</option>
              <option value="Banka">Banka</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="col-6 field">
            <label>A√ßƒ±klama (opsiyonel)</label>
            <input id="giris-aciklama" placeholder="-" />
          </div>
          <div class="col-6 field">
            <label>Tarih/Saat (ops.)</label>
            <input type="datetime-local" id="giris-tarih" />
          </div>
        </div>
      </div>

      <!-- TEBERRU FORMU (revize) -->
      <div id="formTeberru" class="stack" style="display:none">
        <div class="row">
          <div class="col-6 field">
            <label>Tarih (Ay / Yƒ±l)</label>
            <input type="month" id="tbr-tarih" />
          </div>
          <div class="col-6 field">
            <label>Se√ßilen D√∂nem</label>
            <input id="tbr-tarih-goster" readonly placeholder="Kasƒ±m 2025 gibi" />
          </div>
        </div>

        <div class="row">
          <div class="col-6 field">
            <label>Personel</label>
            <select id="tbr-personel"></select>
          </div>
          <div class="col-6 field">
            <label>Parayƒ± Verenin Adƒ± Soyadƒ±</label>
            <input id="tbr-veren" placeholder="√ñrn: Mehmet Yƒ±lmaz" />
          </div>
        </div>

        <div class="row">
          <div class="col-6 field">
            <label>Miktar (‚Ç∫)</label>
            <input type="text" id="tbr-miktar" placeholder="√ñrn: 10,50 veya 1000" inputmode="decimal" />
            <div class="hint">Virg√ºl ile ondalƒ±k girebilirsiniz (√∂rn: 10,50)</div>
          </div>
          <div class="col-6 field">
            <label>Para Nereye Geldi?</label>
            <select id="tbr-nereye">
              <option value="Nakit">Nakit</option>
              <option value="Banka">Banka</option>
            </select>
          </div>
        </div>

        <div class="row">
          <div class="col-6 field">
            <label>A√ßƒ±klama (ops.)</label>
            <input id="tbr-aciklama" placeholder="-" />
          </div>
          <div class="col-6 field">
            <label>Tarih (ops.)</label>
            <input type="datetime-local" id="tbr-tarih-ops" />
          </div>
        </div>
      </div>

      <!-- KURBAN FORMU (g√ºncel) -->
      <div id="formKurban" class="stack" style="display:none">
        <div class="row">
          <div class="col-4 field">
            <label>Kategori</label>
            <!-- deƒüerler artƒ±k sorgu ile aynƒ± -->
            <select id="krb-kategori">
              <option value="kucukbas">K√º√ß√ºkba≈ü</option>
              <option value="buyukbas">B√ºy√ºkba≈ü</option>
            </select>
          </div>
          <div class="col-4 field">
            <label>Personel</label>
            <select id="krb-personel"></select>
          </div>
          <div class="col-4 field">
            <label>Kurban Sahibinin Adƒ± Soyadƒ±</label>
            <input id="krb-sahip" placeholder="Ad Soyad" />
          </div>
        </div>

        <div class="row">
          <div class="col-6 field">
            <label>Kesim Yeri</label>
            <input id="krb-kesim-yeri" placeholder="√ñrn: Kurs / Mezbahane" />
          </div>
          <div class="col-6 field">
            <label>Kesim Tarihi</label>
            <input type="date" id="krb-kesim-tarih" />
          </div>
        </div>

        <div class="field">
          <label>A√ßƒ±klama</label>
          <input id="krb-aciklama" placeholder="Opsiyonel" />
        </div>
      </div>

      <div class="actions"><button class="cta" id="btnVeriGirisOnay">Kaydet (√ñzet)</button></div>
    </section>

    <!-- 4) Veri D√ºzeltme (KART) -->
    <section id="sec-vd" class="stack" style="display:none">
      <div class="row">
        <div class="col-6 field">
          <label>Kategori</label>
          <select id="kategoriVD">
            <option value="">Y√ºkleniyor‚Ä¶</option>
          </select>
        </div>
        <div class="col-6 field">
          <label>Personel (opsiyonel)</label>
          <select id="vd-personel">
            <option value="">(T√ºm√º)</option>
          </select>
        </div>
      </div>

      <div class="actions"><button class="cta" id="vdYukleBtn" type="button">Y√ºkle</button></div>

      <!-- Loader -->
      <div id="vd-loading" class="loading" aria-live="polite" style="display:none">
        <div class="spinner"></div>
        <span>Veriler y√ºkleniyor‚Ä¶</span>
      </div>

      <!-- Liste -->
      <div id="vd-liste" class="table-wrap" style="margin-top:10px"></div>
    </section>

    <!-- 5) Kategori Y√∂netimi -->
    <section id="sec-kg" class="stack" style="display:none">
      <div class="row">
        <div class="col-4 field">
          <label>Kategori Adƒ±</label>
          <input type="text" id="kgAd" placeholder="√ñrn: Kitap Kampanyasƒ±" />
        </div>
        <div class="col-3 field">
          <label>Tip</label>
          <select id="kgTip">
            <option value="hedef">Hedef</option>
            <option value="teberru">Teberru</option>
            <option value="herikisi">Her ikisi</option>
          </select>
        </div>
        <div class="col-3 field" style="align-self:flex-end">
          <button class="cta" id="kgKaydetBtn" type="button">Kategori Kaydet</button>
        </div>
      </div>
      <p class="muted" style="margin:0">Kaydedilen t√ºm kategoriler diƒüer formlardaki "Kategori" alanlarƒ±na otomatik d√º≈üer. Kayƒ±t tarihleri de tutulur.</p>
      <div class="table-wrap" style="margin-top:10px">
        <table>
          <thead>
            <tr><th>Ad</th><th>Tip</th><th>Kayƒ±t Tarihi</th><th>ƒ∞≈ülem</th></tr>
          </thead>
          <tbody id="kgListe">
            <tr><td colspan="4" class="muted">Kategoriler y√ºkleniyor‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>
    </section>

  </section> <!-- /hedefTeberruWrap -->

  <div style="height:40px"></div>
</main>

<!-- √ñzet/Kaydet Modal -->
<div class="modal" id="onayModali" role="dialog" aria-modal="true" aria-labelledby="modal-baslik">
  <div class="modal-icerik">
    <button class="modal-kapat" id="modalKapatBtn" type="button" aria-label="Kapat">‚úñ</button>
    <h3 id="modal-baslik" style="margin:0">ƒ∞≈ülem √ñzeti</h3>
    <div id="modal-veriler"></div>
    <div class="actions" style="justify-content:flex-end">
      <button class="cta" id="modal-kaydet-btn">Kaydet ve G√∂nder</button>
    </div>
  </div>
</div>

<!-- Veri D√ºzenle Modal (TEK ADET) -->
<div class="modal" id="veriDuzenleModal" role="dialog" aria-modal="true" aria-labelledby="vdModalBaslik">
  <div class="modal-icerik">
    <button class="modal-kapat" id="vdModalKapat" type="button" aria-label="Kapat">‚úñ</button>
    <h3 id="vdModalBaslik" style="margin:0">Veri D√ºzenle</h3>

    <input type="hidden" id="vdDocId" />

    <div class="row">
      <div class="col-6 field">
        <label for="vdAdSoyad">Ad Soyad</label>
        <input type="text" id="vdAdSoyad" />
      </div>
      <div class="col-6 field">
        <label for="vdMiktar">Miktar (‚Ç∫)</label>
        <input type="number" id="vdMiktar" min="0" />
      </div>
    </div>

    <div class="row">
      <div class="col-6 field">
        <label for="vdNereyeGeldi">Giri≈ü</label>
        <select id="vdNereyeGeldi">
          <option value="Nakit">Nakit</option>
          <option value="Banka">Banka</option>
        </select>
      </div>
      <div class="col-6 field">
        <label for="vdTur">T√ºr</label>
        <select id="vdTur">
          <option value="hedef">Hedef</option>
          <option value="teberru">Teberru</option>
          <option value="kucukbas">Kurban ‚Äì K√º√ß√ºkba≈ü</option>
          <option value="buyukbas">Kurban ‚Äì B√ºy√ºkba≈ü</option>
        </select>
      </div>
    </div>

    <div class="field">
      <label for="vdAciklama">A√ßƒ±klama (opsiyonel)</label>
      <input type="text" id="vdAciklama" placeholder="-" />
    </div>

    <div class="actions" style="justify-content:flex-end">
      <button class="cta" id="vdKaydetBtn" type="button">Kaydet</button>
    </div>
  </div>
</div>

<!-- Kategori D√ºzenle Modal -->
<div class="modal" id="kgModal" role="dialog" aria-modal="true">
  <div class="modal-icerik">
    <button class="modal-kapat" id="kgModalKapat" type="button">‚úñ</button>
    <h3 style="margin:0">Kategori D√ºzenle</h3>
    <input type="hidden" id="kgEditId" />
    <div class="field">
      <label>Kategori Adƒ±</label>
      <input id="kgEditAd" />
    </div>
    <div class="field">
      <label>Tip</label>
      <select id="kgEditTip">
        <option value="hedef">Hedef</option>
        <option value="teberru">Teberru</option>
        <option value="herikisi">Her ikisi</option>
      </select>
    </div>
    <div class="actions" style="justify-content:flex-end">
      <button class="cta" id="kgEditKaydet">Kaydet</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>
<script>
/* ===== Helpers ===== */
const db=firebase.firestore(), auth=firebase.auth();
const userAgent = navigator.userAgent || '';
const cihazTipi = ()=> (window.innerWidth<700?'mobile':(window.innerWidth<960?'tablet':'desktop'));
const tsISO = ()=> new Date().toISOString();
const norm=(s)=> String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
function toast(msg){const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); clearTimeout(window.__to); window.__to=setTimeout(()=>t.classList.remove('show'),2400);}
function toNum(v){ 
  if (typeof v === 'number') return v; 
  if (typeof v === 'string'){ 
    // T√ºrk√ße format: nokta binlik, virg√ºl ondalƒ±k ayƒ±rƒ±cƒ±
    // √ñnce bo≈üluklarƒ± temizle
    let s = v.trim().replace(/\s/g, '');
    // Eƒüer hem nokta hem virg√ºl varsa: nokta binlik, virg√ºl ondalƒ±k
    if (s.includes(',') && s.includes('.')) {
      s = s.replace(/\./g, '').replace(',', '.');
    }
    // Sadece virg√ºl varsa: ondalƒ±k ayƒ±rƒ±cƒ±
    else if (s.includes(',') && !s.includes('.')) {
      s = s.replace(',', '.');
    }
    // Sadece nokta varsa: binlik ayƒ±rƒ±cƒ± (kaldƒ±r) veya ondalƒ±k (bƒ±rak)
    else if (s.includes('.') && !s.includes(',')) {
      // Son noktadan sonra 3 karakter varsa binlik, yoksa ondalƒ±k
      const lastDotIndex = s.lastIndexOf('.');
      const afterDot = s.substring(lastDotIndex + 1);
      if (afterDot.length <= 2) {
        // Ondalƒ±k ayƒ±rƒ±cƒ± (bƒ±rak)
        s = s;
      } else {
        // Binlik ayƒ±rƒ±cƒ± (kaldƒ±r)
        s = s.replace(/\./g, '');
      }
    }
    const n = Number(s);
    return isNaN(n) ? 0 : n; 
  } 
  return 0; 
}
function normalizeUrl(u){
  if(!u || u === '#') return '#';
  // HTTP/HTTPS URL'leri olduƒüu gibi bƒ±rak
  if(/^https?:\/\//i.test(u)) return u;
  if(u.startsWith('//')) return u;
  // Zaten relative path'ler (../ veya ./ ile ba≈ülayan) olduƒüu gibi bƒ±rak
  if(u.startsWith('../') || u.startsWith('./')) return u;
  
  // Mevcut dosyanƒ±n konumuna g√∂re relative hale getir
  const currentPath = location.pathname;
  const currentDir = currentPath.substring(0, currentPath.lastIndexOf('/'));
  // Mevcut dizin seviyesini hesapla (ka√ß seviye yukarƒ± √ßƒ±kmalƒ±yƒ±z)
  const currentDepth = currentDir.split('/').filter(x => x).length;
  
  // Root'a d√∂nmek i√ßin ../ sayƒ±sƒ±
  const upLevels = currentDepth > 0 ? '../'.repeat(currentDepth) : '';
  
  // Path'i temizle: / ile ba≈ülƒ±yorsa kaldƒ±r, yoksa olduƒüu gibi kullan
  const targetPath = u.startsWith('/') ? u.substring(1) : u;
  
  return upLevels + targetPath;
}
const MONTHS_TR=["Ocak","≈ûubat","Mart","Nisan","Mayƒ±s","Haziran","Temmuz","Aƒüustos","Eyl√ºl","Ekim","Kasƒ±m","Aralƒ±k"];
function formatMonthLabel(val){
  if(!val) return '';
  const [y, m] = val.split('-');
  const mi = Number(m);
  const ad = MONTHS_TR[mi-1] || m;
  return ad + ' ' + y;
}

/* ===== NAV (manifest) ===== */
let CURRENT_ALLOW=new Set(), CURRENT_DENY=new Set();
async function fetchPanels(allowSet, denySet){
  const res=[]; try{
    const snap=await db.collection('sayfa_manifesti').get();
    snap.forEach(doc=>{
      const d=doc.data()||{}, id=doc.id, panelTitle=d.title||id;
      const panelGrant = allowSet.has(norm(id)) || allowSet.has(norm(panelTitle));
      let pages = Array.isArray(d.pages)? d.pages : [];
      pages = pages.filter(pg=>{
        const keyNorm=norm(pg.key||pg.title||'');
        const pageGrant=allowSet.has(keyNorm), denied=denySet.has(keyNorm);
        return !denied && (panelGrant || pageGrant);
      }).map(pg=>({ baslik: pg.title||pg.key||'Sayfa', url: normalizeUrl(pg.path||'#'), key: pg.key||pg.title||'', sira: typeof pg.order==='number'? pg.order:9999 }))
        .sort((a,b)=>a.sira-b.sira);
      if(pages.length) res.push({ id, baslik:panelTitle, sira: typeof d.order==='number'? d.order:9999, pages });
    });
    res.sort((a,b)=>a.sira-b.sira);
  }catch(e){ console.error(e); toast('Men√º y√ºklenemedi'); }
  return res;
}
function renderNav(panels){
  const ul=document.getElementById('navMain'), drawer=document.getElementById('drawer');
  ul.innerHTML=''; drawer.innerHTML='';
  if(!panels.length){
    ul.innerHTML='<li class="nav-item"><div class="nav-btn">Panel yok</div></li>';
    drawer.innerHTML='<div class="muted" style="padding:8px">Men√º bulunamadƒ±</div>'; return;
  }
  panels.forEach(p=>{
    const li=document.createElement('li'); li.className='nav-item';
    li.innerHTML=`<div class="nav-btn">${p.baslik} <span class="caret">‚ñæ</span></div>`;
    const dd=document.createElement('div'); dd.className='dropdown';
    (p.pages||[]).forEach(pg=>{
      const a=document.createElement('a');
      a.href=normalizeUrl(pg.url || pg.path || '#'); a.textContent=pg.baslik;
      a.dataset.key=pg.key||pg.baslik; a.dataset.panel=p.id; a.dataset.panelTitle=p.baslik;
      dd.appendChild(a);
    });
    li.appendChild(dd);
    li.querySelector('.nav-btn').addEventListener('click',(e)=>{
      e.stopPropagation();
      ul.querySelectorAll('.nav-item').forEach(x=>{ if(x!==li) x.classList.remove('open'); });
      li.classList.toggle('open');
    });
    ul.appendChild(li);

    const h=document.createElement('div'); h.className='panel-title'; h.textContent=p.baslik; drawer.appendChild(h);
    (p.pages||[]).forEach(pg=>{
      const a=document.createElement('a');
      a.href=normalizeUrl(pg.url || pg.path || '#'); a.textContent=pg.baslik;
      a.dataset.key=pg.key||pg.baslik; a.dataset.panel=p.id; a.dataset.panelTitle=p.baslik;
      drawer.appendChild(a);
    });
  });
  document.addEventListener('click',(e)=>{ if(!ul.contains(e.target)) ul.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('open')); });
}
(function(){ const hamb=document.getElementById('hamburger'), drawer=document.getElementById('drawer'); if(!hamb) return; hamb.addEventListener('click',()=>drawer.classList.toggle('open')); document.addEventListener('click',(e)=>{ if(!drawer.contains(e.target) && !hamb.contains(e.target)) drawer.classList.remove('open'); }); })();
document.addEventListener('click',(e)=>{
  const a=e.target.closest('a[data-key]'); if(!a) return;
  const key=norm(a.dataset.key), pnl=norm(a.dataset.panel||''), pnlTitle=norm(a.dataset.panelTitle||'');
  if(CURRENT_DENY.has(key)){ e.preventDefault(); toast('Bu sayfa i√ßin yetkiniz yok.'); return; }
  const allowed = CURRENT_ALLOW.has(key) || CURRENT_ALLOW.has(pnl) || CURRENT_ALLOW.has(pnlTitle);
  if(!allowed){ e.preventDefault(); toast('Bu sayfa i√ßin yetkiniz yok.'); }
});
(function(){
  const notifBtn=document.getElementById('btnNotif'), notifDD=document.getElementById('notifDropdown');
  const profBtn=document.getElementById('btnProfile'), profDD=document.getElementById('profDropdown');
  function closeAll(e){
    if(!notifDD.contains(e.target) && e.target!==notifBtn) notifDD.parentElement.classList.remove('open');
    if(!profDD.contains(e.target)  && e.target!==profBtn)  profDD.parentElement.classList.remove('open');
  }
  document.addEventListener('click', closeAll);
  notifBtn?.addEventListener('click',(e)=>{ e.stopPropagation(); notifDD.parentElement.classList.toggle('open'); profDD.parentElement.classList.remove('open'); });
  profBtn ?.addEventListener('click',(e)=>{ e.stopPropagation(); profDD.parentElement.classList.toggle('open'); notifDD.parentElement.classList.remove('open'); });
  document.getElementById('btnLogout')?.addEventListener('click', async (e) => {
    e.preventDefault();
    try { await auth.signOut(); location.assign('/index.html'); }
    catch(err){ console.error(err); toast('√áƒ±kƒ±≈ü yapƒ±lamadƒ±'); }
  });
})();

/* ===== √úst minimal sekmeler ===== */
(function(){
  const tabs=document.querySelectorAll('#mainFormTabs .mini-tab');
  tabs.forEach(t=>t.addEventListener('click',()=>{
    tabs.forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    const target=t.dataset.target;
    document.getElementById('aidatKitapWrap').style.display = (target==='aidatKitapWrap')?'':'none';
    document.getElementById('hedefTeberruWrap').style.display = (target==='hedefTeberruWrap')?'':'none';
  }));
})();

/* ===== Hedef¬∑Teberru alt sekmeler ===== */
(function(){
  const wrap = document.getElementById('htSubTabs');
  if(!wrap) return;
  wrap.addEventListener('click',(e)=>{
    const btn=e.target.closest('.sub-tab'); if(!btn) return;
    wrap.querySelectorAll('.sub-tab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const openId=btn.dataset.open;
    ['sec-ht','sec-hd','sec-vg','sec-vd','sec-kg'].forEach(id=>{
      const el=document.getElementById(id);
      if(el) el.style.display = (id===openId)?'':'none';
    });
    if(openId==='sec-vd') autoListVD();
  });
})();

/* ===== Auth & profil adƒ± ===== */
let currentUser=null;
try{ firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL); }catch(e){}
auth.onAuthStateChanged(async (user)=>{
  currentUser=user||null;
  if(!user){
    setTimeout(()=>{ if(!auth.currentUser) location.replace('index.html'); },150);
    return;
  }
  try{
    const profEl = document.getElementById('profName');
    const uSnap = await db.collection('kullanicilar').doc(user.uid).get();
    const data  = uSnap.exists ? (uSnap.data()||{}) : {};
    let gosterilecek = (data.adSoyad || '').trim();
    if(!gosterilecek && user.displayName) gosterilecek = user.displayName.trim();
    if(!gosterilecek && user.email){
      const namePart = user.email.split('@')[0];
      gosterilecek = namePart.charAt(0).toUpperCase() + namePart.slice(1);
    }
    profEl.textContent = (gosterilecek.split(' ')[0] || 'Profil');

    const rawPerms=Array.isArray(data.yetkiler)? data.yetkiler : [];
    CURRENT_ALLOW=new Set(rawPerms.filter(s=>!String(s).trim().startsWith('-') && !String(s).trim().startsWith('!')).map(norm));
    CURRENT_DENY =new Set(rawPerms.filter(s=> String(s).trim().startsWith('-') || String(s).trim().startsWith('!')).map(s=>norm(String(s).replace(/^[-!]\s*/,''))));
    const panels=await fetchPanels(CURRENT_ALLOW, CURRENT_DENY);
    renderNav(panels);
  }catch(e){ console.error(e); }
});

/* ===== Bildirimler (ops.) ===== */
(async function(){
  try{
    const snap=await db.collection('duyurular').orderBy('createdAt','desc').limit(5).get();
    const badge=document.getElementById('notifBadge'), list=document.getElementById('notifList');
    const n=snap.size; if(n>0){ badge.style.display='block'; badge.textContent=n>99?'99+':String(n); }
    if(n===0){ list.innerHTML='<div class="muted" style="padding:6px 8px">Yeni bildirim yok.</div>'; }
    else snap.forEach(doc=>{ const d=doc.data()||{}; const row=document.createElement('a'); row.href='/diger/bildirim.html'; row.innerHTML=`<strong>${d.baslik||'Duyuru'}</strong><div class="muted">${d.detay||''}</div>`; list.appendChild(row); });
  }catch(e){}
})();

/* ===== Aidat¬∑Kitap ===== */
const kitapIndirimSel = document.getElementById('kitapIndirim');
const kitapIndWrap = document.getElementById('kitapIndirimWrap');
kitapIndirimSel.addEventListener('change', e=>{
  kitapIndWrap.style.display = (e.target.value === 'custom' ? 'block' : 'none');
  kayitPreviewGuncelle();
});
['#talebeAd','#aidatTutar','#aidatIndirim','#kitapTutar','#kitapIndirim','#kitapIndirimMiktar']
  .forEach(sel=> document.querySelector(sel).addEventListener('input', kayitPreviewGuncelle));

function kayitPreviewGuncelle(){
  const ad = document.getElementById('talebeAd').value.trim();
  const aidat = toNum(document.getElementById('aidatTutar').value||0);
  const aidatInd = parseFloat(document.getElementById('aidatIndirim').value||0);
  const kitap = toNum(document.getElementById('kitapTutar').value||0);
  const kitapIndSec = document.getElementById('kitapIndirim').value;
  const kitapIndMiktar = toNum(document.getElementById('kitapIndirimMiktar').value||0);
  const aidatOdenecek = Math.max(0, aidat - (aidat * aidatInd));
  const kitapOdenecek = Math.max(0, kitapIndSec==='custom' ? (kitap - kitapIndMiktar) : kitap);
  document.getElementById('kayitPreview').innerText =
    `${ad || '‚Äî'} toplam bor√ß: ${(aidatOdenecek+kitapOdenecek).toLocaleString('tr-TR')} ‚Ç∫  (Aidat: ${aidatOdenecek.toLocaleString('tr-TR')} ‚Ç∫, Kitap: ${kitapOdenecek.toLocaleString('tr-TR')} ‚Ç∫)`;
}
kayitPreviewGuncelle();

document.getElementById('btnBorcuKaydet').addEventListener('click', async ()=>{
  const ad = document.getElementById('talebeAd').value.trim();
  if(!ad) return toast('Talebe adƒ± bo≈ü olamaz.');
  const aidat = toNum(document.getElementById('aidatTutar').value||0);
  const aidatInd = parseFloat(document.getElementById('aidatIndirim').value||0);
  const kitap = toNum(document.getElementById('kitapTutar').value||0);
  const kitapIndSec = document.getElementById('kitapIndirim').value;
  const kitapIndMiktar = toNum(document.getElementById('kitapIndirimMiktar').value||0);
  const aidatOdenecek = Math.max(0, aidat - (aidat * aidatInd));
  const kitapOdenecek = Math.max(0, kitapIndSec==='custom' ? (kitap - kitapIndMiktar) : kitap);

  try{
    await db.collection('talebe_borclar').add({
      isim: ad,
      toplamAidat: aidatOdenecek,
      toplamKitap: kitapOdenecek,
      tarih: tsISO(),
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      createdBy: currentUser?.email || null,
      uid: currentUser?.uid || null,
      userAgent, cihaz: cihazTipi()
    });
    toast('‚úÖ Talebe bor√ß kaydƒ± olu≈üturuldu.');
    ['talebeAd','aidatTutar','kitapTutar','kitapIndirimMiktar'].forEach(id=> document.getElementById(id).value='');
    document.getElementById('aidatIndirim').value='0';
    document.getElementById('kitapIndirim').value='0';
    kitapIndWrap.style.display='none';
    kayitPreviewGuncelle();
  }catch(e){ console.error(e); toast('Kayƒ±t sƒ±rasƒ±nda hata.'); }
});

['#odemeTalebe','#odemeTuru','#odemeMiktar','#odemeYontemi'].forEach(sel=>{
  document.querySelector(sel).addEventListener('input', odemePreviewGuncelle);
});
function odemePreviewGuncelle(){
  const ad = document.getElementById('odemeTalebe').value.trim();
  const tur = document.getElementById('odemeTuru').value;
  const miktar = toNum(document.getElementById('odemeMiktar').value||0);
  const yontem = document.getElementById('odemeYontemi').value;
  document.getElementById('odemePreview').innerText =
    `${ad || '‚Äî'}: ${miktar.toLocaleString('tr-TR')} ‚Ç∫ ${tur} tahsil edildi (${yontem}).`;
}
odemePreviewGuncelle();

document.getElementById('btnOdemeKaydet').addEventListener('click', async ()=>{
  const ad = document.getElementById('odemeTalebe').value.trim();
  const tur = document.getElementById('odemeTuru').value;
  const miktar = toNum(document.getElementById('odemeMiktar').value||0);
  const yontem = document.getElementById('odemeYontemi').value;
  if(!ad || !miktar) return toast('Talebe adƒ± ve miktar zorunlu.');
  try{
    await db.collection('aidat_kitap').add({
      isim: ad,
      islemTuru: tur,
      miktar: miktar,
      odemeYontemi: yontem,
      tarih: tsISO(),
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      createdBy: currentUser?.email || null,
      uid: currentUser?.uid || null,
      userAgent, cihaz: cihazTipi()
    });
    toast('üí∞ Tahsilat kaydedildi.');
    ['odemeTalebe','odemeMiktar'].forEach(id=> document.getElementById(id).value='');
    odemePreviewGuncelle();
  }catch(e){ console.error(e); toast('Tahsilat kaydedilemedi.'); }
});

/* ===== Hedef ¬∑ Teberru ¬∑ Kurban ===== */
const personeller = [
  "Muhsin √áelik","Faruk Nafiz √ñzgan","ƒ∞brahim Ay","Samet √áakƒ±r",
  "Kerem Kocaoƒülu","Serhan Durak","Mahmut Solmaz","Mehmet Taha Keskin","Ahmetali Emre ≈ûahin"
];
function fillSelect(id, arr){ const el=document.getElementById(id); if(!el) return; el.innerHTML = arr.map(p=>`<option value="${p}">${p}</option>`).join(''); }
fillSelect('hd-personel', personeller);
fillSelect('giris-personel', personeller);
fillSelect('tbr-personel', personeller);
fillSelect('krb-personel', personeller);
const vdPersonel = document.getElementById('vd-personel');
if(vdPersonel) vdPersonel.innerHTML = '<option value="">(T√ºm√º)</option>' + personeller.map(p=>`<option value="${p}">${p}</option>`).join('');

// Hedef tanƒ±mlama tablo satƒ±rlarƒ±
const hedefTBody=document.getElementById('hedefTanimTBody');
personeller.forEach(p=>{
  const tr=document.createElement('tr');
  tr.innerHTML = `<td>${p}</td><td><input type="number" id="hedef-${p}" placeholder="0" min="0" style="height:38px; width:140px" /></td>`;
  hedefTBody.appendChild(tr);
});

/* ===== √ñzet Modal ===== */
const onayModal = document.getElementById('onayModali');
const modalBaslik = document.getElementById('modal-baslik');
const modalVeriler = document.getElementById('modal-veriler');
const modalKaydetBtn = document.getElementById('modal-kaydet-btn');
const modalKapatBtn = document.getElementById('modalKapatBtn');
function modalOpen(){ onayModal.classList.add('show'); }
function modalClose(){ onayModal.classList.remove('show'); }
modalKapatBtn.addEventListener('click', modalClose);
onayModal.addEventListener('click',(e)=>{ if(e.target===onayModal) modalClose(); });

/* ===== Hedef Tanƒ±mla ===== */
document.getElementById('btnHedefTanimOnay').addEventListener('click', ()=>{
  const kat = (document.getElementById('kategoriHT').value || '').trim();
  if(!kat) return toast('Kategori se√ßiniz.');
  let liste=[];
  personeller.forEach(p=>{
    const val = toNum(document.getElementById('hedef-'+p).value);
    if(val>0) liste.push({ kategori: kat, personel:p, hedef: val });
  });
  if(liste.length===0) return toast('Hedef giri≈üi yapƒ±lmadƒ±.');
  modalBaslik.textContent = `Hedef Tanƒ±mlama > ${kat}`;
  modalVeriler.innerHTML = liste.map(l=>`<p>‚û§ ${l.personel} ‚Üí ${l.hedef.toLocaleString('tr-TR')} ‚Ç∫</p>`).join('');
  modalKaydetBtn.onclick = ()=> hedefleriKaydet(liste);
  modalOpen();
});
async function hedefleriKaydet(liste){
  try{
    const batch=db.batch();
    liste.forEach(h=>{
      const ref=db.collection('hedefler').doc(`${h.kategori}_${h.personel}`);
      batch.set(ref,{
        kategori:h.kategori, personel:h.personel, hedef:toNum(h.hedef),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedBy: currentUser?.email || null, uid: currentUser?.uid || null
      },{merge:true});
    });
    await batch.commit(); toast('‚úÖ Hedef(ler) kaydedildi.');
  }catch(e){ console.error(e); toast('Hedef kaydƒ± sƒ±rasƒ±nda hata.'); }
  finally{ modalClose(); }
}

/* ===== Hedef D√ºzenle ===== */
document.getElementById('hdGetirBtn').addEventListener('click', hedefMevcutGetir);
document.getElementById('hdKaydetBtn').addEventListener('click', hedefDuzenleOnay);

async function hedefMevcutGetir(){
  const kat = (document.getElementById('kategoriHD').value || '').trim();
  const per = (document.getElementById('hd-personel').value || '').trim();
  if(!kat || !per) return;
  const ref=db.collection('hedefler').doc(`${kat}_${per}`);
  const snap=await ref.get();
  const mevcut = snap.exists ? toNum(snap.data().hedef) : 0;
  document.getElementById('hd-mevcut').textContent = '‚Ç∫' + mevcut.toLocaleString('tr-TR');
  document.getElementById('hd-yeni').value = mevcut || '';
}
function hedefDuzenleOnay(){
  const kat = (document.getElementById('kategoriHD').value || '').trim();
  const per = (document.getElementById('hd-personel').value || '').trim();
  const yeni = toNum(document.getElementById('hd-yeni').value);
  if(!kat || !per) return toast('Kategori ve personel se√ßiniz.');
  modalBaslik.textContent = `Hedef D√ºzenleme > ${kat}`;
  modalVeriler.innerHTML = `<p>Personel: ${per}</p><p>Yeni Hedef: ${yeni.toLocaleString('tr-TR')} ‚Ç∫</p>`;
  modalKaydetBtn.onclick = ()=> hedefDuzenleKaydet({kategori:kat, personel:per, hedef:yeni});
  modalOpen();
}
async function hedefDuzenleKaydet(h){
  try{
    const ref=db.collection('hedefler').doc(`${h.kategori}_${h.personel}`);
    await ref.set({
      kategori:h.kategori, personel:h.personel, hedef:toNum(h.hedef),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedBy: currentUser?.email || null, uid: currentUser?.uid || null
    },{merge:true});
    toast('‚úÖ Hedef g√ºncellendi.');
  }catch(e){ console.error(e); toast('G√ºncelleme hatasƒ±.'); }
  finally{ modalClose(); hedefMevcutGetir(); }
}

/* ===== Veri Giri≈üi (3 mod) ===== */
(function(){
  const vgMode = document.getElementById('vgMode');
  const formHedef = document.getElementById('formHedef');
  const formTeberru = document.getElementById('formTeberru');
  const formKurban = document.getElementById('formKurban');
  const tbrTarih = document.getElementById('tbr-tarih');
  const tbrTarihGoster = document.getElementById('tbr-tarih-goster');

  // varsayƒ±lan teberru ay-yƒ±l = bug√ºn
  if(tbrTarih){
    const now = new Date();
    const iso = now.toISOString().slice(0,7); // YYYY-MM
    tbrTarih.value = iso;
    tbrTarihGoster.value = formatMonthLabel(iso);
    tbrTarih.addEventListener('change', ()=>{
      tbrTarihGoster.value = formatMonthLabel(tbrTarih.value);
    });
  }

  vgMode?.addEventListener('click', (e)=>{
    const btn = e.target.closest('.sub-tab'); if(!btn) return;
    vgMode.querySelectorAll('.sub-tab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const mode = btn.dataset.mode;
    if(mode==='hedef'){
      formHedef.style.display='grid';
      formTeberru.style.display='none';
      formKurban.style.display='none';
    }else if(mode==='teberru'){
      formHedef.style.display='none';
      formTeberru.style.display='grid';
      formKurban.style.display='none';
    }else{
      formHedef.style.display='none';
      formTeberru.style.display='none';
      formKurban.style.display='grid';
    }
  });
})();

/* ===== Veri Giri≈üi Kaydet ===== */
document.getElementById('btnVeriGirisOnay').addEventListener('click', ()=>{
  const mode = document.querySelector('#vgMode .sub-tab.active')?.dataset.mode || 'hedef';

  /* ===== HEDEF ===== */
  if(mode === 'hedef'){
    const kategori = (document.getElementById('kategoriVG').value || '').trim();
    const personel = document.getElementById('giris-personel').value;
    const veren    = (document.getElementById('giris-veren').value || '').trim();
    const miktar   = toNum(document.getElementById('giris-miktar').value);
    const nereyeGeldi = document.getElementById('giris-turu').value;
    const aciklama = (document.getElementById('giris-aciklama').value || '').trim();
    const tarihSel = document.getElementById('giris-tarih')?.value || '';

    if(!kategori) return toast('Kategori se√ßiniz.');
    if(!personel || !veren || !miktar || !nereyeGeldi){
      return toast('T√ºm zorunlu alanlarƒ± doldurunuz.');
    }

    modalBaslik.textContent = `Veri Giri≈üi > ${kategori}`;
    modalVeriler.innerHTML = `
      <p>T√ºr: <strong>Hedef</strong></p>
      <p>Kategori: ${kategori}</p>
      <p>Personel: ${personel}</p>
      <p>Veren: ${veren}</p>
      <p>Miktar: ${miktar.toLocaleString('tr-TR')} ‚Ç∫</p>
      <p>Giri≈ü: ${nereyeGeldi}</p>
      ${aciklama ? `<p>A√ßƒ±klama: ${aciklama}</p>`:''}
      ${tarihSel ? `<p>Kayƒ±t Zamanƒ±: ${tarihSel.replace('T',' ')}</p>`:''}
    `;

    modalKaydetBtn.onclick = async ()=>{
      try{
        const payload = {
          kategori,
          personel,
          adSoyad: veren,
          miktar,
          nereyeGeldi,
          tur: 'hedef',
          aciklama: aciklama || '',
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          tarih: tarihSel ? new Date(tarihSel).toISOString() : new Date().toISOString(),
          createdBy: (window.currentUser?.email) || null,
          uid: (window.currentUser?.uid) || null,
          userAgent: navigator.userAgent || '',
          cihaz: cihazTipi()
        };
        await db.collection('veriler').add(payload);
        toast('‚úÖ Veri (hedef) kaydedildi.');
        ['giris-veren','giris-miktar','giris-aciklama','giris-tarih'].forEach(id=>{
          const el=document.getElementById(id); if(el) el.value='';
        });
      }catch(e){
        console.error(e);
        toast('Veri kaydƒ± sƒ±rasƒ±nda hata olu≈ütu.');
      }finally{
        onayModal.classList.remove('show');
      }
    };
    onayModal.classList.add('show');
  }

  /* ===== TEBERRU ===== */
  else if(mode === 'teberru'){
    const donemVal = document.getElementById('tbr-tarih').value;
    const donemLabel = formatMonthLabel(donemVal);
    const personel = document.getElementById('tbr-personel').value;
    const veren = (document.getElementById('tbr-veren').value || '').trim();
    const miktar = toNum(document.getElementById('tbr-miktar').value);
    const nereye = document.getElementById('tbr-nereye').value;
    const aciklama = (document.getElementById('tbr-aciklama').value || '').trim();
    const tarihOps = document.getElementById('tbr-tarih-ops').value;

    if(!donemVal) return toast('Tarih (Ay/Yƒ±l) se√ßiniz.');
    if(!personel || !veren || !miktar || !nereye){
      return toast('Tarih, personel, veren, miktar ve giri≈ü alanlarƒ± zorunlu.');
    }
    const [yilStr, ayStr] = donemVal.split('-');
    const yil = Number(yilStr);
    const ay = Number(ayStr);

    modalBaslik.textContent = `Veri Giri≈üi > Teberru (${donemLabel})`;
    modalVeriler.innerHTML = `
      <p>T√ºr: <strong>Teberru</strong></p>
      <p>D√∂nem: ${donemLabel}</p>
      <p>Personel: ${personel}</p>
      <p>Veren: ${veren}</p>
      <p>Miktar: ${miktar.toLocaleString('tr-TR')} ‚Ç∫</p>
      <p>Giri≈ü: ${nereye}</p>
      ${aciklama ? `<p>A√ßƒ±klama: ${aciklama}</p>`:''}
      ${tarihOps ? `<p>Kayƒ±t Zamanƒ±: ${tarihOps.replace('T',' ')}</p>`:''}
    `;

    modalKaydetBtn.onclick = async ()=>{
      try{
        const payload = {
          kategori: 'Teberru',
          personel: personel,
          adSoyad: veren,
          miktar: miktar,
          nereyeGeldi: nereye,
          tur: 'teberru',
          aciklama: aciklama || '',
          ay: ay,
          yil: yil,
          ayYilKey: donemVal,
          ayYilLabel: donemLabel,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          tarih: tarihOps ? new Date(tarihOps).toISOString() : new Date().toISOString(),
          createdBy: (window.currentUser?.email) || null,
          uid: (window.currentUser?.uid) || null,
          userAgent: navigator.userAgent || '',
          cihaz: cihazTipi()
        };
        await db.collection('veriler').add(payload);
        toast('‚úÖ Teberru kaydedildi.');
        ['tbr-veren','tbr-miktar','tbr-aciklama','tbr-tarih-ops'].forEach(id=>{
          const el=document.getElementById(id); if(el) el.value='';
        });
      }catch(e){
        console.error(e);
        toast('Teberru kaydƒ± sƒ±rasƒ±nda hata.');
      }finally{
        onayModal.classList.remove('show');
      }
    };
    onayModal.classList.add('show');
  }

  /* ===== KURBAN ===== */
  else if(mode === 'kurban'){
    const kategori = document.getElementById('krb-kategori').value; // kucukbas | buyukbas
    const personel = document.getElementById('krb-personel').value;
    const sahip = (document.getElementById('krb-sahip').value || '').trim();
    const kesimYeri = (document.getElementById('krb-kesim-yeri').value || '').trim();
    const kesimTarih = document.getElementById('krb-kesim-tarih').value;
    const aciklama = (document.getElementById('krb-aciklama').value || '').trim();

    if(!kategori) return toast('Kurban kategorisi se√ßiniz.');
    if(!personel) return toast('Personel se√ßiniz.');
    if(!sahip) return toast('Kurban sahibinin adƒ±nƒ± giriniz.');

    // kesim tarihi yoksa bug√ºn
    const kesimISO = kesimTarih ? new Date(kesimTarih+'T00:00:00').toISOString() : new Date().toISOString();
    const kesimDate = new Date(kesimISO);
    const yil = kesimDate.getFullYear();
    const ay = kesimDate.getMonth()+1;
    const ayKey = kesimDate.toISOString().slice(0,7);
    const ayLabel = formatMonthLabel(ayKey);

    modalBaslik.textContent = `Veri Giri≈üi > Kurban (${kategori === 'kucukbas' ? 'K√º√ß√ºkba≈ü' : 'B√ºy√ºkba≈ü'})`;
    modalVeriler.innerHTML = `
      <p>T√ºr: <strong>Kurban</strong></p>
      <p>Kategori: ${kategori === 'kucukbas' ? 'K√º√ß√ºkba≈ü' : 'B√ºy√ºkba≈ü'}</p>
      <p>Personel: ${personel}</p>
      <p>Kurban Sahibi: ${sahip}</p>
      <p>Kesim Yeri: ${kesimYeri || '-'}</p>
      <p>Kesim Tarihi: ${kesimTarih ? kesimTarih : 'Bug√ºn (otomatik)'} </p>
      ${aciklama ? `<p>A√ßƒ±klama: ${aciklama}</p>`:''}
      <p>Miktar: 1</p>
      <p>D√∂nem: ${ayLabel}</p>
    `;

    modalKaydetBtn.onclick = async ()=>{
      try{
        const payload = {
          kategori: 'Kurban',
          kurbanKategori: kategori,      // eski alanƒ± da yazƒ±yoruz
          personel: personel,
          adSoyad: sahip,
          kesimYeri: kesimYeri || '',
          kesimTarihi: kesimISO,
          miktar: 1,
          tur: kategori,                 // >>> √ñNEMLƒ∞: kucukbas | buyukbas
          ay: ay,
          yil: yil,
          ayYilKey: ayKey,
          ayYilLabel: ayLabel,
          aciklama: aciklama || '',
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          tarih: new Date().toISOString(),
          createdBy: (window.currentUser?.email) || null,
          uid: (window.currentUser?.uid) || null,
          userAgent: navigator.userAgent || '',
          cihaz: cihazTipi()
        };
        await db.collection('veriler').add(payload);
        toast('‚úÖ Kurban kaydedildi.');
        ['krb-sahip','krb-kesim-yeri','krb-kesim-tarih','krb-aciklama'].forEach(id=>{
          const el=document.getElementById(id); if(el) el.value='';
        });
      }catch(e){
        console.error(e);
        toast('Kurban kaydedilemedi.');
      }finally{
        onayModal.classList.remove('show');
      }
    };

    onayModal.classList.add('show');
  }
});

/* ===== Veri Listeleme / D√ºzenleme ===== */
document.getElementById('vdYukleBtn').addEventListener('click', ()=> verileriListele(true));
document.getElementById('kategoriVD').addEventListener('change', ()=> verileriListele(true));
document.getElementById('vd-personel').addEventListener('change', ()=> verileriListele(true));

async function autoListVD(){ try{ await verileriListele(); }catch(e){} }

async function verileriListele(showLoading = false){
  const kat = (document.getElementById('kategoriVD').value || '').trim();
  const per = document.getElementById('vd-personel').value;
  const kon = document.getElementById('vd-liste');
  const btn = document.getElementById('vdYukleBtn');
  const loader = document.getElementById('vd-loading');

  if(!kat){
    kon.innerHTML = '<div class="muted" style="padding:8px">Kategori se√ßiniz.</div>';
    return;
  }

  if(showLoading){
    loader.style.display = 'flex';
    btn.disabled = true;
    btn.textContent = 'Y√ºkleniyor‚Ä¶';
  }
  kon.innerHTML = '';

  let q = db.collection('veriler').where('kategori','==', kat);
  if (per) q = q.where('personel','==', per);

  let rows = null;
  try {
    const snap = await q.orderBy('createdAt','desc').limit(300).get();
    rows = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  } catch (err) {
    if (err?.code === 'failed-precondition' || /index/i.test(err?.message||'')) {
      try {
        const snap = await q.limit(300).get();
        rows = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }))
          .sort((a,b)=>{
            const ta = a.createdAt?.toDate ? a.createdAt.toDate().getTime() : (a.tarih ? new Date(a.tarih).getTime() : 0);
            const tb = b.createdAt?.toDate ? b.createdAt.toDate().getTime() : (b.tarih ? new Date(b.tarih).getTime() : 0);
            return tb - ta;
          });
      } catch (e2) {
        console.error(e2);
        toast('Liste alƒ±namadƒ±.');
        rows = [];
      }
    } else {
      console.error(err);
      toast('Liste alƒ±namadƒ±.');
      rows = [];
    }
  }

  if (!rows || rows.length === 0) {
    kon.innerHTML = '<div class="muted" style="padding:8px">Kayƒ±t bulunamadƒ±.</div>';
  } else {
    let html = `
      <table>
        <thead><tr>
          <th>Tarih</th><th>Personel</th><th>Ad Soyad</th><th>Miktar</th><th>Giri≈ü</th><th>T√ºr</th><th>A√ßƒ±klama</th><th>ƒ∞≈ülem</th>
        </tr></thead><tbody>
    `;
    rows.forEach(d=>{
      const t = d.createdAt?.toDate ? d.createdAt.toDate() : (d.tarih ? new Date(d.tarih) : null);
      const tStr = t ? t.toLocaleString('tr-TR') : '-';
      // tur g√∂sterimi
      let turGoster = d.tur || 'hedef';
      if (turGoster === 'kucukbas') turGoster = 'Kurban (K√º√ß√ºkba≈ü)';
      else if (turGoster === 'buyukbas') turGoster = 'Kurban (B√ºy√ºkba≈ü)';

      html += `
        <tr data-id="${d.id}">
          <td>${tStr}</td>
          <td>${d.personel || '-'}</td>
          <td>${d.adSoyad || d.veren || d.kurbanSahibi || '-'}</td>
          <td>${d.miktar !== undefined ? '‚Ç∫'+(Number(d.miktar||0)).toLocaleString('tr-TR') : '-'}</td>
          <td>${d.nereyeGeldi || '-'}</td>
          <td>${turGoster}</td>
          <td>${d.aciklama || '-'}</td>
          <td>
            <button class="btn-ghost duzenle">D√ºzenle</button>
            <button class="btn-ghost sil" style="border-color:#ef444422;color:#ef4444">Sil</button>
          </td>
        </tr>`;
    });
    html += `</tbody></table>`;
    kon.innerHTML = html;

    kon.querySelector('tbody').addEventListener('click', (e)=>{
      const tr = e.target.closest('tr'); if(!tr) return;
      const id = tr.getAttribute('data-id');
      if (e.target.classList.contains('duzenle')) veriDuzenleAc(id);
      if (e.target.classList.contains('sil')) veriSil(id);
    });
  }

  if(showLoading){
    loader.style.display = 'none';
    btn.disabled = false;
    btn.textContent = 'Y√ºkle';
  }
}

/* ===== D√ºzenle Modal ===== */
const vdModal=document.getElementById('veriDuzenleModal');
document.getElementById('vdModalKapat').addEventListener('click', ()=> vdModal.classList.remove('show'));
vdModal.addEventListener('click',(e)=>{ if(e.target===vdModal) vdModal.classList.remove('show'); });
async function veriDuzenleAc(docId){
  try{
    const ref=db.collection('veriler').doc(docId);
    const snap=await ref.get();
    if(!snap.exists) return toast('Kayƒ±t bulunamadƒ±.');
    const d=snap.data()||{};
    document.getElementById('vdDocId').value=docId;
    document.getElementById('vdAdSoyad').value=d.adSoyad || d.veren || '';
    document.getElementById('vdMiktar').value=toNum(d.miktar);
    document.getElementById('vdNereyeGeldi').value=d.nereyeGeldi || 'Nakit';
    // tur bilinmiyorsa hedef
    const turVal = d.tur || 'hedef';
    document.getElementById('vdTur').value = (turVal === 'kucukbas' || turVal === 'buyukbas') ? turVal : turVal;
    document.getElementById('vdAciklama').value=d.aciklama || '';
    vdModal.classList.add('show');
  }catch(e){ console.error(e); toast('Kayƒ±t getirilemedi.'); }
}
document.getElementById('vdKaydetBtn').addEventListener('click', async ()=>{
  const id=document.getElementById('vdDocId').value;
  if(!id) return;
  try{
    await db.collection('veriler').doc(id).set({
      adSoyad: (document.getElementById('vdAdSoyad').value || '').trim(),
      miktar: toNum(document.getElementById('vdMiktar').value),
      nereyeGeldi: document.getElementById('vdNereyeGeldi').value,
      tur: document.getElementById('vdTur').value,
      aciklama: (document.getElementById('vdAciklama').value || '').trim(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedBy: currentUser?.email || null
    }, { merge:true });
    toast('‚úÖ Kayƒ±t g√ºncellendi.');
    vdModal.classList.remove('show');
    verileriListele();
  }catch(e){ console.error(e); toast('G√ºncelleme hatasƒ±.'); }
});
async function veriSil(docId){
  if(!confirm('Bu kaydƒ± silmek istiyor musunuz?')) return;
  try{ await db.collection('veriler').doc(docId).delete(); toast('üóëÔ∏è Kayƒ±t silindi.'); verileriListele(); }
  catch(e){ console.error(e); toast('Silme sƒ±rasƒ±nda hata.'); }
}

/* ===== KATEGORƒ∞ Y√ñNETƒ∞Mƒ∞ ===== */
let KATEGORILER = [];
async function kategorileriYukle(){
  try{
    const snap = await db.collection('kategoriler').orderBy('ad','asc').get();
    KATEGORILER = [];
    snap.forEach(doc=>{
      const d=doc.data()||{};
      KATEGORILER.push({
        id:doc.id,
        ad:d.ad || d.isim || 'Adsƒ±z',
        tip:d.tip || 'hedef',
        kayitTarihi:d.kayitTarihi || d.createdAt?.toDate?.()?.toISOString?.() || null,
        createdAt:d.createdAt || null
      });
    });
  }catch(e){
    console.error(e);
    KATEGORILER = [
      {id:'static1',ad:'Kitap Kampanyasƒ±',tip:'hedef',kayitTarihi:null},
      {id:'static2',ad:'Mevlid Kandili',tip:'hedef',kayitTarihi:null},
      {id:'static3',ad:'Eyl√ºl Kermesi',tip:'hedef',kayitTarihi:null},
      {id:'static4',ad:'Kurs Arabasƒ±',tip:'hedef',kayitTarihi:null},
      {id:'static5',ad:'Talebeye ƒ∞kram',tip:'hedef',kayitTarihi:null},
      {id:'static6',ad:'Teberru',tip:'teberru',kayitTarihi:null}
    ];
  }
  renderKategoriList();
  kategorileriFormlaraYay();
}
function renderKategoriList(){
  const tb = document.getElementById('kgListe');
  if(!tb) return;
  if(!KATEGORILER.length){
    tb.innerHTML = `<tr><td colspan="4" class="muted">Kategori bulunamadƒ±.</td></tr>`;
    return;
  }
  tb.innerHTML = KATEGORILER.map(k=>{
    const t = k.kayitTarihi ? new Date(k.kayitTarihi).toLocaleString('tr-TR') : '-';
    return `<tr data-id="${k.id}">
      <td>${k.ad}</td>
      <td>${k.tip}</td>
      <td>${t}</td>
      <td>
        <button class="btn-ghost kg-edit">D√ºzenle</button>
        <button class="btn-ghost kg-del" style="color:#ef4444;border-color:#ef444422">Sil</button>
      </td>
    </tr>`;
  }).join('');
  tb.querySelectorAll('.kg-edit').forEach(btn=>{
    btn.addEventListener('click',(e)=>{
      const id=e.target.closest('tr').dataset.id;
      kategoriEditAc(id);
    });
  });
  tb.querySelectorAll('.kg-del').forEach(btn=>{
    btn.addEventListener('click',async (e)=>{
      const id=e.target.closest('tr').dataset.id;
      await kategoriSil(id);
    });
  });
}
function kategorileriFormlaraYay(){
  const hedefKats = KATEGORILER.filter(k=>k.tip==='hedef' || k.tip==='herikisi');
  const teberruKats = KATEGORILER.filter(k=>k.tip==='teberru' || k.tip==='herikisi');
  const elHT = document.getElementById('kategoriHT');
  if(elHT){
    elHT.innerHTML = '<option value="">Se√ßiniz</option>' + hedefKats.map(k=>`<option value="${k.ad}">${k.ad}</option>`).join('');
  }
  const elHD = document.getElementById('kategoriHD');
  if(elHD){
    elHD.innerHTML = '<option value="">Se√ßiniz</option>' + hedefKats.map(k=>`<option value="${k.ad}">${k.ad}</option>`).join('');
  }
  const elVG = document.getElementById('kategoriVG');
  if(elVG){
    elVG.innerHTML = '<option value="">Se√ßiniz</option>' + hedefKats.map(k=>`<option value="${k.ad}">${k.ad}</option>`).join('');
  }
  const elVD = document.getElementById('kategoriVD');
  if(elVD){
    elVD.innerHTML = '<option value="">Se√ßiniz</option>'
      + hedefKats.map(k=>`<option value="${k.ad}">${k.ad}</option>`).join('')
      + `<option value="Teberru">Teberru</option>`
      + `<option value="Kurban">Kurban</option>`;
  }
}
document.getElementById('kgKaydetBtn').addEventListener('click', async ()=>{
  const ad=(document.getElementById('kgAd').value||'').trim();
  const tip=(document.getElementById('kgTip').value||'hedef');
  if(!ad) return toast('Kategori adƒ± bo≈ü olamaz.');
  try{
    await db.collection('kategoriler').add({
      ad, tip,
      aktif:true,
      kayitTarihi: new Date().toISOString(),
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      createdBy: currentUser?.email || null,
      uid: currentUser?.uid || null,
      userAgent, cihaz: cihazTipi()
    });
    toast('‚úÖ Kategori eklendi.');
    document.getElementById('kgAd').value='';
    await kategorileriYukle();
  }catch(e){ console.error(e); toast('Kategori kaydedilemedi.'); }
});
const kgModal=document.getElementById('kgModal');
document.getElementById('kgModalKapat').addEventListener('click',()=>kgModal.classList.remove('show'));
kgModal.addEventListener('click',(e)=>{ if(e.target===kgModal) kgModal.classList.remove('show'); });
function kategoriEditAc(id){
  const k = KATEGORILER.find(x=>x.id===id);
  if(!k) return;
  document.getElementById('kgEditId').value = k.id;
  document.getElementById('kgEditAd').value = k.ad;
  document.getElementById('kgEditTip').value = k.tip;
  kgModal.classList.add('show');
}
document.getElementById('kgEditKaydet').addEventListener('click', async ()=>{
  const id=document.getElementById('kgEditId').value;
  const ad=(document.getElementById('kgEditAd').value||'').trim();
  const tip=document.getElementById('kgEditTip').value;
  if(!id || !ad) return toast('Eksik bilgi.');
  try{
    await db.collection('kategoriler').doc(id).set({
      ad, tip,
      updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedBy: currentUser?.email || null
    }, {merge:true});
    toast('‚úÖ Kategori g√ºncellendi.');
    kgModal.classList.remove('show');
    await kategorileriYukle();
  }catch(e){ console.error(e); toast('Kategori g√ºncellenemedi.'); }
});
async function kategoriSil(id){
  if(!confirm('Bu kategoriyi silmek istiyor musunuz?')) return;
  try{
    await db.collection('kategoriler').doc(id).delete();
    toast('üóëÔ∏è Kategori silindi.');
    await kategorileriYukle();
  }catch(e){ console.error(e); toast('Kategori silinemedi.'); }
}

/* ===== ƒ∞lk y√ºk ===== */
(async function initOnce(){
  await kategorileriYukle();
  kayitPreviewGuncelle();
  odemePreviewGuncelle();
})();
</script>
</body>
</html>
