<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Personel Ã–deme Takibi</title>
<link rel="icon" type="image/png" href="../img/logo.png" />

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<!-- html2pdf.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
<!-- App Shell CSS -->
<link rel="stylesheet" href="../css/app-shell.css" />

<style>
  /* app-shell.css Ã¼st bar/arka plan/toast/yetki yapÄ±sÄ±nÄ± kullanÄ±r.
     Burada sadece sayfa-Ã¶zel kÃ¼Ã§Ã¼k dÃ¼zenlemeler var. */
  body {
    padding-top: var(--appbar-h) !important;
    overflow-x: hidden;
    overflow-y: auto;
  }

  /* Drawer masaÃ¼stÃ¼nde kapalÄ± kalmalÄ± */
  @media (min-width: 1025px) {
    .drawer {
      transform: translateX(100%) !important;
    }

    .drawer.open {
      transform: translateX(0) !important;
    }
  }

  .wrap {
    max-width: 1750px;
    margin: 0 auto;
    padding: 16px
  }

  .toolbar {
    display: flex;
    gap: 10px;
    flex-wrap: nowrap;
    align-items: center;
    overflow: auto;
    padding-bottom: 6px
  }

  .toolbar select {
    min-width: 100px;
    max-width: 120px;
  }

  /* Mobil SÄ±ralama SeÃ§im Kutusu - Modern TasarÄ±m */
  .mobile-sort-select {
    width: 100%;
    min-width: 140px;
    height: 44px;
    padding: 0 16px;
    padding-right: 40px;
    border: 2px solid var(--border);
    border-radius: 12px;
    background: var(--card);
    color: var(--text);
    font-size: 14px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.2s ease;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 16 16' fill='none'%3E%3Cpath d='M4 6L8 10L12 6' stroke='%2364748b' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 12px center;
    background-size: 16px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
  }

  .mobile-sort-select:hover {
    border-color: var(--brand);
    box-shadow: 0 2px 6px rgba(59, 130, 246, 0.1);
  }

  .mobile-sort-select:focus {
    outline: none;
    border-color: var(--brand);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  .mobile-sort-select option {
    padding: 12px;
    font-size: 14px;
    background: var(--card);
    color: var(--text);
  }

  .mobile-sort-select optgroup {
    font-weight: 600;
    color: var(--muted);
    font-size: 13px;
    padding: 8px 12px;
  }

  .mobile-sort-clear-btn {
    white-space: nowrap;
    padding: 0 16px;
    height: 44px;
    border-radius: 12px;
    font-weight: 500;
    font-size: 14px;
    transition: all 0.2s ease;
    border: 2px solid var(--border);
  }

  .mobile-sort-clear-btn:hover {
    background: var(--pill-hover);
    border-color: var(--brand);
    transform: translateY(-1px);
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
  }

  .toolbar::-webkit-scrollbar {
    height: 6px
  }

  .toolbar::-webkit-scrollbar-thumb {
    background: #d7dde6;
    border-radius: 999px
  }

  .line {
    height: 1px;
    background: var(--border);
    margin: 8px 0
  }

  header strong {
    font-size: clamp(16px, 3.8vw, 18px);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 40vw
  }

  .chip {
    padding: 8px 10px;
    border-radius: 999px;
    border: 1px solid var(--border);
    background: #fff;
    color: var(--muted);
    font-size: 12px;
    white-space: nowrap
  }

  select,
  input,
  button {
    height: 38px;
    border: 1px solid var(--border);
    background: #fff;
    border-radius: 10px;
    padding: 0 12px;
    font: inherit;
    color: var(--ink)
  }

  button {
    background: var(--accent);
    color: #fff;
    border: none;
    cursor: pointer;
    font-weight: 500
  }

  button.secondary {
    background: #fff;
    color: var(--ink);
    border: 1px solid var(--border)
  }

  button:hover {
    opacity: 0.9
  }

  button.danger {
    background: var(--bad);
    color: #fff
  }

  /* Tablo */
  .table-wrap {
    overflow: auto;
    border: 1px solid var(--border);
    border-radius: 12px
  }

  table {
    width: 100%;
    border-collapse: collapse;
    background: #fff;
    min-width: 900px
  }

  thead th {
    position: sticky;
    top: 0;
    background: #fafbfc;
    border-bottom: 2px solid var(--border);
    font-weight: 600;
    text-align: left;
    font-size: 13px;
    color: var(--muted);
    padding: 12px;
    z-index: 1
  }

  tbody td {
    border-bottom: 1px solid var(--border);
    padding: 12px;
    font-size: 14px
  }

  tbody tr:hover {
    background: #f8f9fa
  }

  .right {
    text-align: right
  }
  
  table{
    width:100%; 
    border-collapse:collapse; 
    table-layout:fixed;
    background:#fff;
    font-size:13px;
  }
  
  thead{
    background:#f8fafc;
    border-bottom:2px solid #e2e8f0;
  }
  
  th{
    padding:12px 8px; 
    text-align:center; 
    font-size:12px;
    font-weight:700;
    color:#475569;
    white-space:nowrap;
    background:#f8fafc;
    border-bottom:2px solid #e2e8f0;
    letter-spacing:0.3px;
    text-transform:uppercase;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  
  th:first-child{
    text-align:left; 
    padding-left:16px; 
    width:160px;
    text-transform:none;
    font-size:13px;
    font-weight:800;
    color:#0f172a;
  }
  
  /* Kategori sÃ¼tunlarÄ± - eÅŸit geniÅŸlik */
  th:not(:first-child):not(:last-child):not(:nth-last-child(2)){
    width:calc((100% - 160px - 240px) / 11);
    min-width:75px;
    max-width:100px;
  }
  
  /* ResmÃ® MaaÅŸ sÃ¼tunu */
  th:nth-last-child(3){
    width:110px;
  }
  
  /* Toplam sÃ¼tunu */
  th:nth-last-child(2){
    width:120px;
  }
  
  /* Kalan sÃ¼tunu */
  th:last-child{
    width:120px;
  }
  
  td{
    padding:12px 8px; 
    text-align:center; 
    font-size:13px;
    color:#334155;
    white-space:nowrap;
    border-bottom:1px solid #f1f5f9;
    background:#fff;
    transition:background 0.15s ease;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  
  td:first-child{
    text-align:left; 
    padding-left:16px; 
    font-weight:600; 
    color:#0f172a;
    font-size:13px;
    background:#fafbfc;
    border-right:1px solid #f1f5f9;
  }
  
  thead th{
    cursor:pointer; 
    user-select:none; 
    transition:all .15s;
  }
  
  thead th:hover{
    background:#f1f5f9;
    color:var(--brand);
  }
  
  thead th.sortable::after{
    content:' â†•'; 
    opacity:.3; 
    margin-left:6px; 
    font-size:10px;
  }
  
  thead th.sort-asc::after{
    content:' â†‘'; 
    opacity:1; 
    color:var(--brand); 
    font-weight:900;
    font-size:11px;
  }
  
  thead th.sort-desc::after{
    content:' â†“'; 
    opacity:1; 
    color:var(--brand); 
    font-weight:900;
    font-size:11px;
  }
  
  tbody tr{
    transition:background 0.15s ease;
  }
  
  tbody tr:hover{
    background:#f8fafc;
  }
  
  tbody tr:hover td:first-child{
    background:#f1f5f9;
  }
  
  tbody tr:last-child td{
    border-bottom:none;
  }
  
  /* Chip Design - Readable */
  .chip{
    border-radius:5px; 
    padding:5px 10px; 
    font-weight:600; 
    font-size:12px; 
    display:inline-block; 
    white-space:nowrap; 
    text-align:center;
    line-height:1.4;
    min-width:65px;
  }
  
  .chip.ok{
    background:#dcfce7;
    color:#166534;
    border:1px solid #86efac;
  }
  
  .chip.no{
    background:#fee2e2;
    color:#991b1b;
    border:1px solid #fca5a5;
  }
  
  td strong{
    font-size:14px; 
    font-weight:700;
  }
  
  /* Toplam ve Kalan sÃ¼tunlarÄ± */
  td:nth-last-child(2){
    font-weight:700;
    color:#2563eb;
    font-size:13px;
  }
  
  td:last-child{
    font-weight:700;
    font-size:13px;
  }
  
  /* Empty cells */
  td.muted{
    opacity:0.4;
    font-size:12px;
  }

  /* Desktop/Mobile gÃ¶rÃ¼nÃ¼m kontrolÃ¼ */
  .desktop-only {
    display: block;
  }
  
  .mobile-only {
    display: none;
  }

  /* Mobile Card View */
  .mobile-cards{display:none}
  .mobile-summary-cards{display:none}
  @media (max-width: 960px){
    .desktop-only {
      display: none !important;
    }
    
    .mobile-only {
      display: block;
    }
    
    .table-wrap{display:none !important}
    .mobile-cards{display:block}
    .person-card{
      background:var(--card); border:1px solid var(--stroke); border-radius:12px;
      padding:14px; margin-bottom:12px; box-shadow:var(--shadow);
    }
    .person-card-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; padding-bottom:10px; border-bottom:1px solid var(--stroke)}
    .person-card-header h3{margin:0; font-size:16px; color:var(--text)}
    .person-card-row{display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:8px}
    .person-card-row:last-child{margin-bottom:0}
    .person-card-label{font-size:12px; color:var(--muted); font-weight:600}
    .person-card-value{font-size:14px; font-weight:700; color:var(--text)}
    .person-card-total{background:var(--pill); padding:10px; border-radius:8px; margin-top:10px; text-align:center}
    .person-card-total .person-card-label{font-size:14px; margin-bottom:4px}
    .person-card-total .person-card-value{font-size:18px; color:var(--brand)}
    
    /* Summary mobile */
    .mobile-summary-cards{display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin-top:12px}
    .summary-card{
      background:var(--card); border:1px solid var(--stroke); border-radius:12px;
      padding:12px; box-shadow:var(--shadow);
    }
    .summary-card-label{font-size:11px; color:var(--muted); font-weight:600; text-transform:capitalize; margin-bottom:6px}
    .summary-card-value{font-size:16px; font-weight:700; color:var(--text); margin-bottom:4px}
    .summary-card-kalan{font-size:13px; color:var(--brand); font-weight:600}
    .summary-card-total{
      grid-column:1/-1; background:var(--pill); padding:14px; border-radius:10px;
      text-align:center; margin-top:8px;
    }
    .summary-card-total .summary-card-label{font-size:14px; margin-bottom:6px}
    .summary-card-total .summary-card-value{font-size:20px; color:var(--brand)}
  }

  /* Modal */
  body.modal-open {
    overflow: hidden
  }

  .modal {
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, .4);
    display: none;
    align-items: center;
    justify-content: center;
    padding: 16px;
    z-index: 9999;
    backdrop-filter: blur(4px);
    pointer-events: none
  }

  .modal.show {
    display: flex !important;
    pointer-events: auto !important
  }

  .modal.show .sheet {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
    position: relative !important;
    z-index: 10001 !important;
    pointer-events: auto !important
  }

  .sheet {
    max-width: 700px;
    width: 100%;
    max-height: 90vh;
    overflow-y: auto;
    background: #fff;
    border-radius: 16px;
    padding: 20px;
    border: 1px solid var(--border);
    box-shadow: 0 20px 40px rgba(0, 0, 0, .2);
    pointer-events: auto
  }

  .sheet-visible {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
    position: relative !important;
    z-index: 10001 !important;
    pointer-events: auto !important
  }

  .sheet button,
  .sheet input,
  .sheet select,
  .sheet textarea,
  .sheet form {
    pointer-events: auto !important;
    z-index: 10002 !important;
    position: relative
  }

  .sheet h3 {
    margin: 0 0 16px 0;
    font-size: 20px;
    color: var(--ink)
  }

  .form-grid {
    display: grid;
    gap: 14px
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 6px
  }

  .form-group label {
    font-size: 13px;
    font-weight: 600;
    color: var(--muted)
  }

  .form-group input,
  .form-group select {
    width: 100%;
    height: 42px;
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 0 12px;
    font: inherit;
    font-size: 14px
  }

  .actions {
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    margin-top: 20px;
    padding-top: 16px;
    border-top: 1px solid var(--border)
  }
  
  /* Ã–deme modalÄ± iÃ§in Ã¶zel stil - uzun iÃ§erik iÃ§in */
  #odemeModal .sheet {
    max-width: 800px;
    max-height: 90vh;
  }
  
  #odemeModal #odemeKategoriAlani {
    max-height: 400px;
    overflow-y: auto;
    overflow-x: hidden;
    padding-right: 4px;
  }
  
  #odemeModal #odemeTutarAlani {
    max-height: 300px;
    overflow-y: auto;
    overflow-x: hidden;
  }
  
  /* Scrollbar stilleri */
  .sheet::-webkit-scrollbar,
  #odemeModal #odemeKategoriAlani::-webkit-scrollbar,
  #odemeModal #odemeTutarAlani::-webkit-scrollbar {
    width: 8px;
  }
  
  .sheet::-webkit-scrollbar-track,
  #odemeModal #odemeKategoriAlani::-webkit-scrollbar-track,
  #odemeModal #odemeTutarAlani::-webkit-scrollbar-track {
    background: #f1f5f9;
    border-radius: 4px;
  }
  
  .sheet::-webkit-scrollbar-thumb,
  #odemeModal #odemeKategoriAlani::-webkit-scrollbar-thumb,
  #odemeModal #odemeTutarAlani::-webkit-scrollbar-thumb {
    background: var(--muted);
    border-radius: 4px;
  }
  
  .sheet::-webkit-scrollbar-thumb:hover,
  #odemeModal #odemeKategoriAlani::-webkit-scrollbar-thumb:hover,
  #odemeModal #odemeTutarAlani::-webkit-scrollbar-thumb:hover {
    background: var(--text);
  }

  button.good {
    background: var(--good);
    color: #fff
  }

  button.danger {
    background: var(--bad);
    color: #fff
  }

  /* === Toplu toolbar: beyaz kart + pastel butonlar === */
  .bulk-toolbar{
    display:grid;
    grid-template-columns: 1fr auto auto; /* kategori | Ã¶dendi | Ã¶denmedi */
    gap:10px; align-items:center; margin-top:10px;
    background:#fff; border:1px solid var(--stroke);
    border-radius:14px; padding:10px 14px;
    box-shadow:0 2px 6px rgba(0,0,0,.04);
  }
  .bulk-select{ display:flex; align-items:center; gap:10px; min-width:0 }
  .bulk-select span{ white-space:nowrap; font-weight:600; color:#111827 }
  .bulk-select select{
    appearance:none; border:1px solid #d1d5db; border-radius:8px;
    background:#fff url("data:image/svg+xml,%3Csvg width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E") no-repeat right 10px center;
    background-size:16px;
    padding:6px 34px 6px 10px; font-size:14px; font-weight:600; color:#111827;
    box-shadow:0 1px 2px rgba(0,0,0,.05) inset; outline:none; min-width:140px;
  }
  .bulk-select select:hover{ border-color:#0ea5e9 }
  .bulk-select select:focus{ border-color:#0ea5e9; box-shadow:0 0 0 3px rgba(14,165,233,.25) }

  .bulk-buttons{ display:flex; gap:8px; justify-content:flex-end }
  .pill-btn{
    border-radius:999px; padding:6px 16px; font-weight:600; font-size:14px; cursor:pointer;
    border:1px solid transparent; transition:background .2s, color .2s, border .2s;
  }
  .pill-btn.ok{ background:#dcfce7; color:#166534; border-color:#22c55e33 }
  .pill-btn.no{ background:#fee2e2; color:#991b1b; border-color:#ef444433 }
  .pill-btn.ok:hover{ background:#bbf7d0 }
  .pill-btn.no:hover{ background:#fecaca }

  /* Mobile: kategori Ã¼stte, butonlar altta yan yana */
  @media (max-width: 768px){
    .bulk-toolbar{ grid-template-columns:1fr; }
    .bulk-buttons{ justify-content:flex-start; }
  }

  /* Analiz Modal - AylÄ±k DaÄŸÄ±lÄ±m - Responsive Grid */
  #analizAylikDagilim{
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(80px, 1fr));
    gap:8px;
  }
  
  /* Minimum geniÅŸlik garantisi - her zaman en az 2 sÃ¼tun */
  @media (min-width: 1200px){
    #analizAylikDagilim{
      grid-template-columns:repeat(6,1fr);
    }
  }
  
  @media (min-width: 960px) and (max-width: 1199px){
    #analizAylikDagilim{
      grid-template-columns:repeat(4,1fr);
    }
  }
  
  @media (min-width: 640px) and (max-width: 959px){
    #analizAylikDagilim{
      grid-template-columns:repeat(3,1fr);
    }
  }
  
  @media (max-width: 639px){
    #analizAylikDagilim{
      grid-template-columns:repeat(2,1fr);
    }
  }

  /* Analiz Modal - Mobil dÃ¼zenlemeler */
  @media (max-width: 640px){
    #analizDataArea > div:first-child > div{
      flex-direction:column;
      align-items:flex-start !important;
      gap:12px;
    }
    #analizDataArea > div:first-child > div > div:last-child{
      text-align:left !important;
    }
    #analizTable{
      font-size:12px;
    }
    #analizTable th,
    #analizTable td{
      padding:8px 4px;
    }
    /* Kategori detay Ã¶zet kartlarÄ± mobilde 2 sÃ¼tun */
    #kategoriDetayArea > div:first-child{
      grid-template-columns:repeat(2,1fr) !important;
    }
  }
</style>

<!-- Supabase (Auth + Database iÃ§in) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script src="../src/supabase.js"></script>
<script src="../src/supabase-auth-wrapper.js"></script>
<script src="../src/supabase-db-wrapper.js"></script>

<!-- Ortak JS (navigation, toast, vs) -->
<script src="../js/ortak.js"></script>
</head>
<body>

<!-- APPBAR -->
<div class="appbar">
  <div class="brand" onclick="location.href='../panel.html'">
    <img src="../img/logo.png" alt="logo"><span>KARAAÄAÃ‡ FATÄ°H</span>
  </div>

  <nav class="nav-center"><ul class="nav-list" id="navMain"></ul></nav>

  <div class="nav-right">
    <button class="btn hamb" id="hamburger" title="MenÃ¼">â˜°</button>

    <div class="nav-item">
      <button class="iconbtn" id="btnNotif" title="Bildirimler">ğŸ””
        <span class="badge" id="notifBadge" style="display:none">0</span>
      </button>
      <div class="dropdown drop-right" id="notifDropdown">
        <div class="muted" style="padding:6px 8px">Son bildirimler</div>
        <div id="notifList" style="max-height:300px;overflow:auto"></div>
        <a href="/diger/bildirim.html">TÃ¼m bildirimleri gÃ¶r â†’</a>
      </div>
    </div>

    <div class="nav-item">
      <button class="iconbtn" id="btnProfile" title="Profil">
        <span class="avatar"></span> <span id="profName" class="muted">Profil</span>
      </button>
      <div class="dropdown drop-right" id="profDropdown">
        <a href="/diger/kullanici-yonetimi.html" >ğŸ‘¤ Profil</a>
        <a href="/diger/sistem-ayarlari.html" >âš™ï¸ Sistem AyarlarÄ±</a>
        <a href="#" id="btnLogout">ğŸšª Ã‡Ä±kÄ±ÅŸ Yap</a>
      </div>
    </div>
  </div>
</div>

<aside class="drawer" id="drawer"></aside>

<main class="wrap">

  <header>
    <div class="bar">
      <strong>Personel Ã–deme Takibi</strong>
      <div class="right">
        <span class="chip" id="todayText">â€”</span>
      </div>
    </div>
  </header>

  <div class="toolbar">
    <select id="aySec"></select>
    <select id="yilSec"></select>
    <input id="searchInput" type="text" placeholder="Ä°sim araâ€¦" style="flex: 1; min-width: 200px" />
    <button id="btnAdd">+ Personel Tahakkuk</button>
    <button class="secondary" id="btnCopy">âŸ³ Kopyala</button>
    <button class="secondary" id="btnBulkManage">âš™ï¸ Toplu</button>
    <button class="secondary" id="btnPersonelManage">ğŸ‘¤ Personel</button>
    <button class="secondary" id="btnAnaliz">ğŸ“Š Analiz</button>
  </div>

  <div class="line"></div>

  <!-- SUMMARY -->
  <div class="card">
    <h4 style="margin:0 0 12px; font-size:14px; color:var(--text)">Kategori ToplamlarÄ±</h4>
    <div class="chip" style="margin-bottom:12px" id="ozetTarihBilgisi">â€”</div>
    <div class="table-wrap desktop-only">
      <table id="ozetTable">
        <thead>
          <tr><th>Kategori</th><th class="right">Toplam</th><th class="right">Ã–denen</th><th class="right">Kalan</th></tr>
        </thead>
        <tbody id="ozetAlani"></tbody>
        <tfoot>
          <tr><td colspan="4" style="text-align:right;padding:12px 16px" id="ozetToplamSatir"></td></tr>
        </tfoot>
      </table>
    </div>
    <div class="mobile-summary-cards" id="mobileSummaryCards"></div>
  </div>

  <!-- Mobil SÄ±ralama ButonlarÄ± -->
  <div class="mobile-only" style="margin:12px 0">
    <div class="card" style="padding:16px; border:1px solid var(--border); box-shadow:0 2px 8px rgba(0,0,0,0.04)">
      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center">
        <div style="position:relative; flex:1; min-width:0">
          <select id="mobileSortSelect" class="mobile-sort-select">
            <option value="">ğŸ”½ SÄ±ralama seÃ§in</option>
            <option value="kalan_desc">ğŸ“‰ Toplam BorÃ§ (YÃ¼ksek â†’ DÃ¼ÅŸÃ¼k)</option>
            <option value="kalan_asc">ğŸ“ˆ Toplam BorÃ§ (DÃ¼ÅŸÃ¼k â†’ YÃ¼ksek)</option>
            <optgroup label="Kategori BorÃ§larÄ±">
              <option value="hediye_desc">Hediye Borcu (YÃ¼ksek â†’ DÃ¼ÅŸÃ¼k)</option>
              <option value="hediye_asc">Hediye Borcu (DÃ¼ÅŸÃ¼k â†’ YÃ¼ksek)</option>
              <option value="kira_desc">Kira Borcu (YÃ¼ksek â†’ DÃ¼ÅŸÃ¼k)</option>
              <option value="kira_asc">Kira Borcu (DÃ¼ÅŸÃ¼k â†’ YÃ¼ksek)</option>
              <option value="cocuk_desc">Ã‡ocuk Borcu (YÃ¼ksek â†’ DÃ¼ÅŸÃ¼k)</option>
              <option value="cocuk_asc">Ã‡ocuk Borcu (DÃ¼ÅŸÃ¼k â†’ YÃ¼ksek)</option>
              <option value="yol_desc">Yol Borcu (YÃ¼ksek â†’ DÃ¼ÅŸÃ¼k)</option>
              <option value="yol_asc">Yol Borcu (DÃ¼ÅŸÃ¼k â†’ YÃ¼ksek)</option>
              <option value="haberlesme_desc">HaberleÅŸme Borcu (YÃ¼ksek â†’ DÃ¼ÅŸÃ¼k)</option>
              <option value="haberlesme_asc">HaberleÅŸme Borcu (DÃ¼ÅŸÃ¼k â†’ YÃ¼ksek)</option>
              <option value="ikramiye_desc">Ä°kramiye Borcu (YÃ¼ksek â†’ DÃ¼ÅŸÃ¼k)</option>
              <option value="ikramiye_asc">Ä°kramiye Borcu (DÃ¼ÅŸÃ¼k â†’ YÃ¼ksek)</option>
              <option value="yakacak_desc">Yakacak Borcu (YÃ¼ksek â†’ DÃ¼ÅŸÃ¼k)</option>
              <option value="yakacak_asc">Yakacak Borcu (DÃ¼ÅŸÃ¼k â†’ YÃ¼ksek)</option>
              <option value="elbise_desc">Elbise Borcu (YÃ¼ksek â†’ DÃ¼ÅŸÃ¼k)</option>
              <option value="elbise_asc">Elbise Borcu (DÃ¼ÅŸÃ¼k â†’ YÃ¼ksek)</option>
              <option value="ssk_desc">SSK Borcu (YÃ¼ksek â†’ DÃ¼ÅŸÃ¼k)</option>
              <option value="ssk_asc">SSK Borcu (DÃ¼ÅŸÃ¼k â†’ YÃ¼ksek)</option>
            </optgroup>
            <option value="ad_asc">ğŸ”¤ Ä°sim (A â†’ Z)</option>
            <option value="ad_desc">ğŸ”¤ Ä°sim (Z â†’ A)</option>
          </select>
        </div>
        <button type="button" class="secondary mobile-sort-clear-btn" id="mobileSortClear">ğŸ—‘ï¸ Temizle</button>
      </div>
    </div>
  </div>

  <!-- TABLE -->
  <div class="card">
    <div class="table-wrap desktop-only">
      <table>
        <thead>
          <tr>
            <th class="sortable" data-sort="ad">Ad</th>
            <th class="sortable right" data-sort="hediye">Hediye</th>
            <th class="sortable right" data-sort="kira">Kira</th>
            <th class="sortable right" data-sort="cocuk">Ã‡ocuk</th>
            <th class="sortable right" data-sort="yol">Yol</th>
            <th class="sortable right" data-sort="haberlesme">HaberleÅŸme</th>
            <th class="sortable right" data-sort="ikramiye">Ä°kramiye</th>
            <th class="sortable right" data-sort="yakacak">Yakacak</th>
            <th class="sortable right" data-sort="elbise">Elbise</th>
            <th class="sortable right" data-sort="ssk">SSK</th>
            <th class="sortable" data-sort="maas">ResmÃ® MaaÅŸ</th>
            <th class="sortable right" data-sort="toplam">Toplam</th>
            <th class="sortable right" data-sort="kalan">Kalan</th>
          </tr>
        </thead>
        <tbody id="listeAlani"></tbody>
      </table>
    </div>
    <div class="mobile-cards" id="mobileCards"></div>
  </div>

  <div style="height:120px"></div>
</main>

<!-- MODALS -->
<div class="modal" id="ekleModal">
  <div class="sheet">
    <h3>Yeni Personel Tahakkuk</h3>
    <form class="form-grid" onsubmit="event.preventDefault(); kaydetEkle();">
      <div class="form-group">
        <label>Ad Soyad</label>
        <input id="adInput" type="text" placeholder="Ã–rn: Samet Ã‡AKIR" required>
      </div>
      <div style="display:grid; grid-template-columns:repeat(2,1fr); gap:14px">
        <div class="form-group">
          <label>Ay</label>
          <select id="ayInput" required></select>
        </div>
        <div class="form-group">
          <label>YÄ±l</label>
          <select id="yilInput" required></select>
        </div>
      </div>
      <div style="display:grid; grid-template-columns:repeat(2,1fr); gap:14px">
        <div class="form-group">
          <label>Hediye</label>
          <input id="hediyeInput" type="number" value="0" min="0" step="0.01">
        </div>
        <div class="form-group">
          <label>Kira</label>
          <input id="kiraInput" type="number" value="0" min="0" step="0.01">
        </div>
        <div class="form-group">
          <label>Ã‡ocuk</label>
          <input id="cocukInput" type="number" value="0" min="0" step="0.01">
        </div>
        <div class="form-group">
          <label>Yol</label>
          <input id="yolInput" type="number" value="0" min="0" step="0.01">
        </div>
        <div class="form-group">
          <label>HaberleÅŸme</label>
          <input id="haberInput" type="number" value="0" min="0" step="0.01">
        </div>
        <div class="form-group">
          <label>Ä°kramiye</label>
          <input id="ikramiyeInput" type="number" value="0" min="0" step="0.01">
        </div>
        <div class="form-group">
          <label>Yakacak</label>
          <input id="yakacakInput" type="number" value="0" min="0" step="0.01">
        </div>
        <div class="form-group">
          <label>Elbise</label>
          <input id="elbiseInput" type="number" value="0" min="0" step="0.01">
        </div>
        <div class="form-group">
          <label>SSK</label>
          <input id="sskInput" type="number" value="0" min="0" step="0.01">
        </div>
      </div>
      <div class="actions">
        <button type="button" class="secondary" onclick="closeModals()">Ä°ptal</button>
        <button type="submit" class="good">Kaydet</button>
      </div>
    </form>
  </div>
</div>

<div class="modal" id="odemeModal">
  <div class="sheet">
    <h3 id="odemeModalBaslik">Ã–deme Durumu</h3>
    <div id="odemeUyariAlani" style="display:none; margin-bottom:12px; padding:10px; background:#fef3c7; border:1px solid #fbbf24; border-radius:8px; color:#92400e; font-size:13px"></div>
    <div id="odemeKategoriAlani"></div>
    <div id="odemeTutarAlani" style="display:none; margin-top:16px; padding-top:16px; border-top:1px solid var(--stroke)">
      <h4 style="margin:0 0 12px; font-size:14px; color:var(--muted)">Tutar DÃ¼zenleme</h4>
      <div class="form-grid" style="grid-template-columns:repeat(2,1fr)">
        <div class="form-group">
          <label>Hediye</label>
          <input id="edit_hediye" type="number" value="0" min="0" step="0.01">
        </div>
        <div class="form-group">
          <label>Kira</label>
          <input id="edit_kira" type="number" value="0" min="0" step="0.01">
        </div>
        <div class="form-group">
          <label>Ã‡ocuk</label>
          <input id="edit_cocuk" type="number" value="0" min="0" step="0.01">
        </div>
        <div class="form-group">
          <label>Yol</label>
          <input id="edit_yol" type="number" value="0" min="0" step="0.01">
        </div>
        <div class="form-group">
          <label>HaberleÅŸme</label>
          <input id="edit_haberlesme" type="number" value="0" min="0" step="0.01">
        </div>
        <div class="form-group">
          <label>Ä°kramiye</label>
          <input id="edit_ikramiye" type="number" value="0" min="0" step="0.01">
        </div>
        <div class="form-group">
          <label>Yakacak</label>
          <input id="edit_yakacak" type="number" value="0" min="0" step="0.01">
        </div>
        <div class="form-group">
          <label>Elbise</label>
          <input id="edit_elbise" type="number" value="0" min="0" step="0.01">
        </div>
        <div class="form-group">
          <label>SSK</label>
          <input id="edit_ssk" type="number" value="0" min="0" step="0.01">
        </div>
      </div>
      <div style="margin-top:12px; padding:10px; background:var(--pill); border-radius:8px; text-align:center">
        <div style="font-size:12px; color:var(--muted); margin-bottom:4px">Yeni Toplam</div>
        <div id="editToplamGoster" style="font-size:18px; font-weight:700; color:var(--brand)">0 â‚º</div>
      </div>
    </div>
    <div class="actions">
      <button type="button" class="secondary" onclick="closeModals()">Kapat</button>
      <button type="button" class="secondary" id="btnEditTutarlar" onclick="toggleEditMode()" style="display:none">DÃ¼zenle</button>
      <button type="button" class="danger" id="btnSilVeri" onclick="silVeri()" style="display:none">Sil</button>
      <button type="button" class="good" id="btnKaydetOdeme" onclick="kaydetOdeme()" style="display:none">Kaydet</button>
    </div>
  </div>
</div>

<div class="modal" id="copyModal">
  <div class="sheet">
    <h3>Tahakkuk Kopyala</h3>
    <form class="form-grid" onsubmit="event.preventDefault();">
      <div style="display:grid; grid-template-columns:repeat(2,1fr); gap:14px">
        <div class="form-group">
          <label>Kaynak Ay</label>
          <select id="srcAy"></select>
        </div>
        <div class="form-group">
          <label>Kaynak YÄ±l</label>
          <select id="srcYil"></select>
        </div>
        <div class="form-group">
          <label>Hedef Ay</label>
          <select id="dstAy"></select>
        </div>
        <div class="form-group">
          <label>Hedef YÄ±l</label>
          <select id="dstYil"></select>
        </div>
      </div>
      <div class="form-group">
        <label style="display:flex; align-items:center; gap:8px; cursor:pointer">
          <input type="checkbox" id="overwriteChk" style="width:auto; height:auto">
          <span>Var olan kayÄ±tlar Ã¼zerine yaz</span>
        </label>
      </div>
      <div class="card" style="margin-top:10px">
        <div class="muted" style="margin-bottom:8px">Kaynak Ã¶nizleme:</div>
        <div class="table-wrap" style="max-height:220px">
          <table>
            <thead><tr><th>Ad</th><th class="right">Toplam</th><th class="right">Ã–denen Alan SayÄ±sÄ±</th></tr></thead>
            <tbody id="copyPreviewBody"></tbody>
          </table>
        </div>
      </div>
      <div class="actions">
        <button type="button" class="secondary" onclick="closeModals()">Kapat</button>
        <button type="button" class="good" id="btnDoCopy">Kopyala</button>
      </div>
    </form>
  </div>
</div>

<div class="modal" id="bulkModal">
  <div class="sheet">
    <h3>Toplu Kategori YÃ¶netimi</h3>
    <form class="form-grid" onsubmit="event.preventDefault();">
      <div class="form-group">
        <label>Kategori SeÃ§in</label>
        <select id="bulkKategoriModal">
          <option value="hediye">Hediye</option>
          <option value="kira">Kira</option>
          <option value="cocuk">Ã‡ocuk</option>
          <option value="yol">Yol</option>
          <option value="haberlesme">HaberleÅŸme</option>
          <option value="ikramiye">Ä°kramiye</option>
          <option value="yakacak">Yakacak</option>
          <option value="elbise">Elbise</option>
          <option value="ssk">SSK</option>
          <option value="maas">ResmÃ® MaaÅŸ</option>
        </select>
      </div>
      <div class="muted" style="padding:10px; background:var(--pill); border-radius:8px; font-size:13px">
        <strong>Bilgi:</strong> SeÃ§ili ay/yÄ±l ve arama filtresi kapsamÄ±ndaki tÃ¼m personeller iÃ§in iÅŸlem yapÄ±lacaktÄ±r.
      </div>
      <div class="actions">
        <button type="button" class="secondary" onclick="closeModals()">Ä°ptal</button>
        <button type="button" class="good" id="btnBulkOkModal">Toplu: Ã–dendi</button>
        <button type="button" class="danger" id="btnBulkNoModal">Toplu: Ã–denmedi</button>
      </div>
    </form>
  </div>
</div>

<div class="modal" id="personelManageModal">
  <div class="sheet" style="max-width:900px; max-height:90vh; overflow-y:auto">
    <h3 style="margin-bottom:20px">ğŸ‘¤ Personel YÃ¶netim</h3>
    
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:20px">
      <div>
        <label style="display:block; margin-bottom:6px; font-weight:600; color:var(--text)">Personel SeÃ§in</label>
        <select id="personelSelect" style="width:100%; padding:10px 12px; border:1px solid var(--stroke); border-radius:10px; background:var(--pill); color:var(--text); font-weight:600; font-size:14px">
          <option value="">YÃ¼kleniyor...</option>
        </select>
      </div>
      <div>
        <label style="display:block; margin-bottom:6px; font-weight:600; color:var(--text)">YÄ±l SeÃ§in</label>
        <select id="personelYilSelect" style="width:100%; padding:10px 12px; border:1px solid var(--stroke); border-radius:10px; background:var(--pill); color:var(--text); font-weight:600; font-size:14px">
          <option value="">YÄ±l seÃ§in</option>
        </select>
      </div>
    </div>

    <div id="personelDataArea" style="display:none">
      <div style="background:linear-gradient(135deg, var(--brand)15, var(--brand2)15); border:1px solid var(--stroke); border-radius:12px; padding:16px; margin-bottom:16px">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px">
          <div>
            <h4 id="personelAdGoster" style="margin:0; font-size:18px; color:var(--text)">â€”</h4>
            <div class="muted" id="personelYilGoster" style="font-size:13px; margin-top:4px">â€”</div>
          </div>
          <div style="text-align:right">
            <div style="font-size:12px; color:var(--muted); margin-bottom:4px">YÄ±llÄ±k Toplam</div>
            <div id="yillikToplamGoster" style="font-size:24px; font-weight:700; color:var(--brand)">0 â‚º</div>
          </div>
        </div>
      </div>

      <div id="personelAylarListesi" style="display:grid; gap:12px"></div>
    </div>

    <div id="personelEmptyState" style="text-align:center; padding:40px; color:var(--muted)">
      <div style="font-size:48px; margin-bottom:12px">ğŸ“‹</div>
      <div style="font-size:16px; font-weight:600">Personel ve yÄ±l seÃ§in</div>
      <div style="font-size:13px; margin-top:6px">SeÃ§im yaptÄ±ÄŸÄ±nÄ±zda veriler burada gÃ¶rÃ¼necek</div>
    </div>

    <div class="actions">
      <button type="button" class="secondary" onclick="closeModals()">Kapat</button>
      <button type="button" class="good" id="btnPersonelKaydet" style="display:none" onclick="kaydetPersonelYonetim()">TÃ¼m DeÄŸiÅŸiklikleri Kaydet</button>
    </div>
  </div>
</div>

<div class="modal" id="analizModal">
  <div class="sheet" style="max-width:1000px; max-height:90vh; overflow-y:auto">
    <h3 style="margin-bottom:20px">ğŸ“Š Personel Ã–deme Analizi</h3>
    
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:20px">
      <div>
        <label style="display:block; margin-bottom:6px; font-weight:600; color:var(--text)">Personel SeÃ§imi</label>
        <select id="analizPersonelSelect" style="width:100%; padding:10px 12px; border:1px solid var(--stroke); border-radius:10px; background:var(--pill); color:var(--text); font-weight:600; font-size:14px">
          <option value="tum">TÃ¼m Personeller</option>
        </select>
      </div>
      <div>
        <label style="display:block; margin-bottom:6px; font-weight:600; color:var(--text)">YÄ±l SeÃ§in</label>
        <select id="analizYilSelect" style="width:100%; padding:10px 12px; border:1px solid var(--stroke); border-radius:10px; background:var(--pill); color:var(--text); font-weight:600; font-size:14px">
          <option value="">YÄ±l seÃ§in</option>
        </select>
      </div>
    </div>

    <div id="analizDataArea" style="display:none">
      <div style="background:linear-gradient(135deg, var(--brand)15, var(--brand2)15); border:1px solid var(--stroke); border-radius:12px; padding:16px; margin-bottom:16px">
        <div style="display:flex; justify-content:space-between; align-items:center">
          <div>
            <h4 id="analizBaslikGoster" style="margin:0; font-size:18px; color:var(--text)">â€”</h4>
            <div class="muted" id="analizYilGoster" style="font-size:13px; margin-top:4px">â€”</div>
          </div>
          <div style="text-align:right">
            <div style="font-size:12px; color:var(--muted); margin-bottom:4px">YÄ±llÄ±k Toplam</div>
            <div id="analizYillikToplamGoster" style="font-size:24px; font-weight:700; color:var(--brand)">0 â‚º</div>
          </div>
        </div>
      </div>

      <div class="tablo-kart" style="padding:0">
        <table id="analizTable">
          <thead>
            <tr>
              <th style="text-align:left; padding-left:16px">Kategori</th>
              <th>Toplam</th>
              <th>Ã–denen</th>
              <th>Kalan</th>
            </tr>
          </thead>
          <tbody id="analizTableBody"></tbody>
          <tfoot>
            <tr style="background:var(--pill)">
              <td style="text-align:right; padding:12px 16px; font-weight:700" colspan="4" id="analizToplamSatir"></td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div style="margin-top:16px; padding:16px; background:var(--pill); border-radius:12px">
        <h4 style="margin:0 0 12px; font-size:16px">AylÄ±k DaÄŸÄ±lÄ±m</h4>
        <div id="analizAylikDagilim"></div>
      </div>

      <!-- Kategori Detay Analizi -->
      <div style="margin-top:20px; padding:16px; background:var(--card); border:1px solid var(--stroke); border-radius:12px">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px">
          <h4 style="margin:0; font-size:16px">Kategori Detay Analizi</h4>
          <select id="analizKategoriSelect" style="padding:8px 12px; border:1px solid var(--stroke); border-radius:8px; background:var(--pill); color:var(--text); font-weight:600; font-size:14px; min-width:150px">
            <option value="">Kategori seÃ§in</option>
            <option value="tum">TÃ¼m Kategoriler</option>
            <option value="hediye">Hediye</option>
            <option value="kira">Kira</option>
            <option value="cocuk">Ã‡ocuk</option>
            <option value="yol">Yol</option>
            <option value="haberlesme">HaberleÅŸme</option>
            <option value="ikramiye">Ä°kramiye</option>
            <option value="yakacak">Yakacak</option>
            <option value="elbise">Elbise</option>
            <option value="ssk">SSK</option>
          </select>
        </div>

        <div id="kategoriDetayArea" style="display:none">
          <!-- Tek Kategori Ä°Ã§in -->
          <div id="tekKategoriDetay">
            <!-- Ã–zet Kartlar -->
            <div style="display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin-bottom:20px">
              <div style="background:linear-gradient(135deg, var(--brand)15, var(--brand2)15); border:1px solid var(--stroke); border-radius:10px; padding:12px">
                <div style="font-size:11px; color:var(--muted); font-weight:600; margin-bottom:6px">Toplam</div>
                <div id="kategoriToplam" style="font-size:20px; font-weight:700; color:var(--text)">0 â‚º</div>
              </div>
              <div style="background:#dcfce7; border:1px solid #86efac; border-radius:10px; padding:12px">
                <div style="font-size:11px; color:#166534; font-weight:600; margin-bottom:6px">Ã–denen</div>
                <div id="kategoriOdenen" style="font-size:20px; font-weight:700; color:#166534">0 â‚º</div>
              </div>
              <div style="background:#fee2e2; border:1px solid #fca5a5; border-radius:10px; padding:12px">
                <div style="font-size:11px; color:#991b1b; font-weight:600; margin-bottom:6px">Kalan</div>
                <div id="kategoriKalan" style="font-size:20px; font-weight:700; color:#991b1b">0 â‚º</div>
              </div>
              <div style="background:var(--pill); border:1px solid var(--stroke); border-radius:10px; padding:12px">
                <div style="font-size:11px; color:var(--muted); font-weight:600; margin-bottom:6px">Ã–deme %</div>
                <div id="kategoriYuzde" style="font-size:20px; font-weight:700; color:var(--brand)">0%</div>
              </div>
            </div>

            <!-- Grafik -->
            <div style="margin-bottom:20px">
              <canvas id="kategoriChart" style="max-height:300px"></canvas>
            </div>

            <!-- AylÄ±k Detay Tablosu -->
            <div class="tablo-kart" style="padding:0">
              <table id="kategoriDetayTable">
                <thead>
                  <tr>
                    <th style="text-align:left; padding-left:16px">Ay</th>
                    <th>Toplam</th>
                    <th>Ã–denen</th>
                    <th>Kalan</th>
                    <th>Durum</th>
                  </tr>
                </thead>
                <tbody id="kategoriDetayTableBody"></tbody>
              </table>
            </div>
          </div>
          
          <!-- TÃ¼m Kategoriler Ä°Ã§in -->
          <div id="tumKategorilerDetay" style="display:none"></div>
        </div>

        <div id="kategoriDetayEmpty" style="text-align:center; padding:40px; color:var(--muted); display:block">
          <div style="font-size:48px; margin-bottom:12px">ğŸ“ˆ</div>
          <div style="font-size:14px; font-weight:600">Kategori seÃ§in</div>
          <div style="font-size:12px; margin-top:6px">DetaylÄ± analiz iÃ§in bir kategori seÃ§in</div>
        </div>
      </div>
    </div>

    <div id="analizEmptyState" style="text-align:center; padding:40px; color:var(--muted)">
      <div style="font-size:48px; margin-bottom:12px">ğŸ“Š</div>
      <div style="font-size:16px; font-weight:600">YÄ±l seÃ§in</div>
      <div style="font-size:13px; margin-top:6px">Analiz iÃ§in bir yÄ±l seÃ§in</div>
    </div>

    <div class="actions">
      <button type="button" class="secondary" onclick="closeModals()">Kapat</button>
      <button type="button" class="good" id="btnAnalizPDF" onclick="exportAnalizPDF()" style="display:none">ğŸ“„ PDF Ä°ndir</button>
    </div>
  </div>
</div>

<div class="toast-container" id="toastContainer"></div>

<script>
  // DOMContentLoaded'da Ã§alÄ±ÅŸtÄ±r - ortak.js yÃ¼klenene kadar bekle
  document.addEventListener('DOMContentLoaded', function () {
    // Supabase ve ortak.js yÃ¼klenene kadar bekle
    function waitForSupabaseAndOrtak(callback) {
      if (typeof window.supabase !== 'undefined' && typeof window.norm !== 'undefined' && typeof window.showToast !== 'undefined') {
        callback();
      } else {
        setTimeout(() => waitForSupabaseAndOrtak(callback), 50);
      }
    }

    waitForSupabaseAndOrtak(() => {
      const getSupabase = () => window.supabase;
      const getAuth = () => window.getSupabaseAuth ? window.getSupabaseAuth() : null;
      const showToast = window.showToast; // Ortak.js'den gelen showToast

      /* Tarih */
      (function(){
        const d=new Date(); const days=['Pazar','Pazartesi','SalÄ±','Ã‡arÅŸamba','PerÅŸembe','Cuma','Cumartesi'];
        document.getElementById('todayText').textContent=`${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()} â€¢ ${days[d.getDay()]}`;
      })();

      /* Supabase & helpers */
      const sb = window.supabase;
      if (!sb) {
        console.error('Supabase client yÃ¼klenmedi');
      }
  const monthsTR=["Ocak","Åubat","Mart","Nisan","MayÄ±s","Haziran","Temmuz","AÄŸustos","EylÃ¼l","Ekim","KasÄ±m","AralÄ±k"];
  const KATEGORILER = ["hediye","kira","cocuk","yol","haberlesme","ikramiye","yakacak","elbise","ssk"]; // SÄ±ralÄ± kategori listesi
  const fmt=(n)=> (Number(n||0)).toLocaleString("tr-TR",{minimumFractionDigits:2, maximumFractionDigits:2}) + " â‚º";
  // norm fonksiyonu ortak.js'den geliyor (window.norm), burada tekrar tanÄ±mlamaya gerek yok
  // window.norm kullanÄ±lacak, const ile tekrar tanÄ±mlanmayacak
  // showToast fonksiyonu ortak.js'den geliyor, burada sadece fallback
  function toast(msg){
    if (typeof showToast === 'function') {
      showToast('info', 'Bilgi', msg);
    } else {
      const t=document.getElementById('toast'); 
      if (t) {
        t.textContent=msg; 
        t.classList.add('show'); 
        clearTimeout(window.__to); 
        window.__to=setTimeout(()=>t.classList.remove('show'),2500);
      }
    }
  }
  function closeModals(){
    ['ekleModal','odemeModal','copyModal','bulkModal','personelManageModal','analizModal'].forEach(id=>{
      const el=document.getElementById(id); 
      if(el) el.classList.remove('show');
    });
    document.body.classList.remove('modal-open');
  }
  // Global scope'a ekle
  window.closeModals = closeModals;
  
  function openModal(modalId) {
    const modal = document.getElementById(modalId);
    if(modal) {
      modal.classList.add('show');
      document.body.classList.add('modal-open');
      
      // ESC tuÅŸu ile kapatma
      const escHandler = (e) => {
        if(e.key === 'Escape') {
          closeModals();
          document.removeEventListener('keydown', escHandler);
        }
      };
      document.addEventListener('keydown', escHandler);
      
      // Modal dÄ±ÅŸÄ±na tÄ±klayÄ±nca kapatma
      const clickHandler = (e) => {
        if(e.target === modal) {
          closeModals();
          modal.removeEventListener('click', clickHandler);
        }
      };
      modal.addEventListener('click', clickHandler);
    }
  }
  // Global scope'a ekle
  window.openModal = openModal;

  // normalizeUrl fonksiyonu ortak.js'den geliyor (window.normalizeUrl), burada tekrar tanÄ±mlamaya gerek yok
  // window.normalizeUrl kullanÄ±lacak

  /* MenÃ¼ ve yetki yÃ¶netimi ortak.js'den geliyor */
  // CURRENT_ALLOW ve CURRENT_DENY ortak.js'den window.CURRENT_ALLOW ve window.CURRENT_DENY olarak geliyor
  let CURRENT_ALLOW = window.CURRENT_ALLOW || new Set();
  let CURRENT_DENY = window.CURRENT_DENY || new Set();
  
  // fetchPanels ve renderNav fonksiyonlarÄ± ortak.js'den geliyor, burada tanÄ±mlamaya gerek yok
  // Hamburger ve drawer iÅŸlemleri ortak.js'de initAppShell iÃ§inde yapÄ±lÄ±yor
  // Link guard ve bildirim/profil dropdown iÅŸlemleri ortak.js'de yapÄ±lÄ±yor

  /* ===== Sayfa verileri ===== */
  let CACHE_ROWS = [];   // SeÃ§ili Ay/YÄ±l'Ä±n tamamÄ± (tek sorgu)
  let LAST_ROWS  = [];   // Arama filtresi sonrasÄ± ekranda gÃ¶rÃ¼nen
  let SORT_COL = null;   // Aktif sÄ±ralama kolonu
  let SORT_DIR = 'asc';  // SÄ±ralama yÃ¶nÃ¼: 'asc' veya 'desc'
  let IS_ADMIN = false;  // Yetkili kullanÄ±cÄ± kontrolÃ¼

  const aktifKoleksiyon="personel_odeme";
  const aySec=document.getElementById("aySec"), yilSec=document.getElementById("yilSec");
  const searchInput=document.getElementById("searchInput");
  const btnAdd=document.getElementById("btnAdd"), btnCopy=document.getElementById("btnCopy");
  const btnBulkManage=document.getElementById("btnBulkManage");
  const btnBulkOkModal=document.getElementById("btnBulkOkModal"), btnBulkNoModal=document.getElementById("btnBulkNoModal");

  // Select doldurma
  (function(){
    const bugun=new Date(), sy=bugun.getFullYear()-3, ey=bugun.getFullYear()+5;
    monthsTR.forEach((m,i)=> aySec.add(new Option(m,i+1)));
    for(let y=sy;y<=ey;y++) yilSec.add(new Option(y,y));
    aySec.value=bugun.getMonth()+1; yilSec.value=bugun.getFullYear();
  })();

  // Ekle modal selectleri + copy modal selectleri
  const ayInput=document.getElementById("ayInput"), yilInput=document.getElementById("yilInput");
  const srcAy=document.getElementById("srcAy"), srcYil=document.getElementById("srcYil");
  const dstAy=document.getElementById("dstAy"), dstYil=document.getElementById("dstYil");
  (function(){
    const bugun=new Date(), sy=bugun.getFullYear()-3, ey=bugun.getFullYear()+5;
    monthsTR.forEach((m,i)=>{ ayInput.add(new Option(m,i+1)); srcAy.add(new Option(m,i+1)); dstAy.add(new Option(m,i+1)); });
    for(let y=sy;y<=ey;y++){ yilInput.add(new Option(y,y)); srcYil.add(new Option(y,y)); dstYil.add(new Option(y,y)); }
    ayInput.value=bugun.getMonth()+1; yilInput.value=bugun.getFullYear();
    srcAy.value=aySec.value; srcYil.value=yilSec.value;
    const next=new Date(bugun.getFullYear(), bugun.getMonth()+1, 1);
    dstAy.value=String(next.getMonth()+1); dstYil.value=String(next.getFullYear());
  })();

  srcAy.addEventListener('change', loadCopyPreview);
  srcYil.addEventListener('change', loadCopyPreview);

  // Modallar - Yetki kontrolÃ¼ ile
  btnAdd.onclick=()=> {
    if(!IS_ADMIN) { toast('Bu iÅŸlem iÃ§in yetkiniz yok.'); return; }
    openModal("ekleModal");
  };
  btnCopy.onclick=async ()=> {
    if(!IS_ADMIN) { toast('Bu iÅŸlem iÃ§in yetkiniz yok.'); return; }
    await loadCopyPreview(); 
    openModal("copyModal"); 
  };
  btnBulkManage.onclick=()=> {
    if(!IS_ADMIN) { toast('Bu iÅŸlem iÃ§in yetkiniz yok.'); return; }
    openModal("bulkModal"); 
  };
  document.getElementById("btnPersonelManage").onclick=async ()=> {
    if(!IS_ADMIN) { toast('Bu iÅŸlem iÃ§in yetkiniz yok.'); return; }
    await openPersonelManageModal(); 
  };
  document.getElementById("btnAnaliz").onclick=async ()=>{ await openAnalizModal(); };

  async function loadCopyPreview(){
    const sb = getSupabase();
    const sa=Number(srcAy.value), sy=Number(srcYil.value);
    const body=document.getElementById("copyPreviewBody"); body.innerHTML="";
    try {
      const { data, error } = await sb.from(aktifKoleksiyon)
        .select('*')
        .eq('ay', sa)
        .eq('yil', sy);
      if(error) throw error;
      if(!data || data.length === 0){ 
        body.innerHTML='<tr><td colspan="3" class="muted" style="text-align:center;padding:12px">KayÄ±t yok</td></tr>'; 
        return; 
      }
      data.forEach(d=>{
        const odSay=KATEGORILER.reduce((c,k)=> c + (d.odemeler?.[k]?1:0), 0);
        const tr=document.createElement('tr');
        tr.innerHTML=`<td style="text-align:left">${d.ad||'-'}</td><td>${fmt(d.toplam||0)}</td><td>${odSay}</td>`;
        body.appendChild(tr);
      });
    } catch(e) {
      console.error(e);
      toast('Kopya Ã¶nizleme yÃ¼klenirken hata.');
    }
  }
  document.getElementById("btnDoCopy").onclick=async ()=>{
    const sb = getSupabase();
    const sa=Number(srcAy.value), sy=Number(srcYil.value);
    const da=Number(dstAy.value), dy=Number(dstYil.value);
    const overwrite=document.getElementById("overwriteChk").checked;
    if(sa===da && sy===dy){ toast("Kaynak ve hedef aynÄ± olamaz."); return; }

    try {
      const { data: srcData, error: srcError } = await sb.from(aktifKoleksiyon)
        .select('*')
        .eq('ay', sa)
        .eq('yil', sy);
      if(srcError) throw srcError;
      if(!srcData || srcData.length === 0){ toast("Kaynakta kayÄ±t yok."); return; }

      const { data: dstData, error: dstError } = await sb.from(aktifKoleksiyon)
        .select('id, ad')
        .eq('ay', da)
        .eq('yil', dy);
      if(dstError) throw dstError;
      const existingByName=new Map(); 
      (dstData || []).forEach(doc=> existingByName.set(window.norm(doc.ad||''), doc.id));

      let copied=0, skipped=0, overwritten=0;
      for(const d of srcData){
        const key=window.norm(d.ad||'');
        const payload = {
          ad: d.ad || '',
          ay: da,
          yil: dy,
          hediye: +(d.hediye || 0),
          kira: +(d.kira || 0),
          cocuk: +(d.cocuk || 0),
          ssk: +(d.ssk || 0),
          yol: +(d.yol || 0),
          haberlesme: +(d.haberlesme || 0),
          ikramiye: +(d.ikramiye || 0),
          yakacak: +(d.yakacak || 0),
          elbise: +(d.elbise || 0),
          odemeler: {
            hediye: false,
            kira: false,
            cocuk: false,
            yol: false,
            haberlesme: false,
            ikramiye: false,
            yakacak: false,
            elbise: false,
            ssk: false
          },
          maas: "Ã¶denmedi",
          toplam: KATEGORILER.reduce((sum, k) => sum + (+(d[k] || 0)), 0),
          tarih: new Date().toISOString()
        };
        
        if(existingByName.has(key)){
          if(overwrite){ 
            const { error: updateError } = await sb.from(aktifKoleksiyon)
              .update(payload)
              .eq('id', existingByName.get(key));
            if(updateError) throw updateError;
            overwritten++; 
          } else {
            skipped++;
          }
        } else {
          // Yeni ID oluÅŸtur (text tipinde)
          payload.id = `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
          const { error: insertError } = await sb.from(aktifKoleksiyon).insert(payload);
          if(insertError) throw insertError;
          copied++;
        }
      }
      closeModals();
      toast(`Kopya tamam: ${copied}${overwrite?`, Ã¼zerine yazÄ±lan: ${overwritten}`:''}${skipped?`, atlanan: ${skipped}`:''}`);
      aySec.value=da; yilSec.value=dy; await listele();
    } catch(e) {
      console.error(e);
      toast('Kopya iÅŸlemi baÅŸarÄ±sÄ±z.');
    }
  };

  // Ekle â€“ tek kayÄ±t
  async function kaydetEkle(){
    const sb = getSupabase();
    const veri={
      id: `${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
      ad:(document.getElementById("adInput").value||"").trim(),
      ay:+document.getElementById("ayInput").value, 
      yil:+document.getElementById("yilInput").value,
      hediye:+document.getElementById("hediyeInput").value||0, 
      kira:+document.getElementById("kiraInput").value||0,
      cocuk:+document.getElementById("cocukInput").value||0, 
      yol:+document.getElementById("yolInput").value||0,
      haberlesme:+document.getElementById("haberInput").value||0, 
      ikramiye:+document.getElementById("ikramiyeInput").value||0,
      yakacak:+document.getElementById("yakacakInput").value||0, 
      elbise:+document.getElementById("elbiseInput").value||0,
      ssk:+document.getElementById("sskInput").value||0,
      maas:"Ã¶denmedi",
      odemeler:{hediye:false,kira:false,cocuk:false,yol:false,haberlesme:false,ikramiye:false,yakacak:false,elbise:false,ssk:false},
      tarih:new Date().toISOString()
    };
    veri.toplam = KATEGORILER.reduce((sum, k) => sum + (veri[k] || 0), 0);
    if(!veri.ad){ toast("Ad Soyad boÅŸ olamaz."); return; }
    try{ 
      const { error } = await sb.from(aktifKoleksiyon).insert(veri);
      if(error) throw error;
      closeModals(); 
      toast("Tahakkuk oluÅŸturuldu."); 
      listele(); 
    }
    catch(e){ console.error(e); toast("KayÄ±t baÅŸarÄ±sÄ±z."); }
  }
  // Global scope'a ekle
  window.kaydetEkle = kaydetEkle;

  // Listele + filtre
  function filterByName(d){ const q=window.norm(searchInput.value); return !q || window.norm(d.ad||'').includes(q); }

function applySearch() {
  const q = window.norm(searchInput.value);
  LAST_ROWS = CACHE_ROWS.filter(d => !q || window.norm(d.ad||'').includes(q));
  applySort();
}

function applySort() {
  if(!SORT_COL) return;
  LAST_ROWS.sort((a, b) => {
    let valA, valB;
    if(SORT_COL === 'ad') {
      valA = (a.ad || '').toLowerCase();
      valB = (b.ad || '').toLowerCase();
    } else if(SORT_COL === 'maas') {
      valA = a.maas === 'Ã¶dendi' ? 1 : 0;
      valB = b.maas === 'Ã¶dendi' ? 1 : 0;
    } else if(SORT_COL === 'kalan') {
      // Kalan hesapla
      const calcKalan = (d) => {
        let kalan = 0;
        KATEGORILER.forEach(k => {
          const tutar = +(d[k] || 0);
          if(tutar > 0 && !d.odemeler?.[k]) kalan += tutar;
        });
        return kalan;
      };
      valA = calcKalan(a);
      valB = calcKalan(b);
    } else {
      // Kategori borcu hesapla (sadece Ã¶denmemiÅŸ kÄ±sÄ±m)
      const calcKategoriBorcu = (d, kategori) => {
        const tutar = +(d[kategori] || 0);
        if(tutar > 0 && !d.odemeler?.[kategori]) return tutar;
        return 0;
      };
      if(KATEGORILER.includes(SORT_COL)) {
        valA = calcKategoriBorcu(a, SORT_COL);
        valB = calcKategoriBorcu(b, SORT_COL);
      } else {
        valA = +(a[SORT_COL] || 0);
        valB = +(b[SORT_COL] || 0);
      }
    }
    if(valA < valB) return SORT_DIR === 'asc' ? -1 : 1;
    if(valA > valB) return SORT_DIR === 'asc' ? 1 : -1;
    return 0;
  });
}

  // Mobil sÄ±ralama
  const mobileSortSelect = document.getElementById("mobileSortSelect");
  const mobileSortClear = document.getElementById("mobileSortClear");
  
  if(mobileSortSelect) {
    mobileSortSelect.addEventListener('change', () => {
      const value = mobileSortSelect.value;
      if(!value) {
        SORT_COL = null;
        SORT_DIR = 'asc';
        applySort();
        renderTableAndSummary(LAST_ROWS);
        return;
      }
      
      const [col, dir] = value.split('_');
      SORT_COL = col;
      SORT_DIR = dir;
      applySort();
      renderTableAndSummary(LAST_ROWS);
    });
  }
  
  if(mobileSortClear) {
    mobileSortClear.addEventListener('click', () => {
      mobileSortSelect.value = '';
      SORT_COL = null;
      SORT_DIR = 'asc';
      applySort();
      renderTableAndSummary(LAST_ROWS);
    });
  }

function renderTableAndSummary(rows) {
  const tbody = document.getElementById("listeAlani");
  const mobileCards = document.getElementById("mobileCards");
  tbody.innerHTML = "";
  mobileCards.innerHTML = "";

  let ozet = {};
  KATEGORILER.forEach(k => { ozet[k] = {toplam:0,odenen:0}; });
  let genelKalan = 0;

  const fmt=(n)=> (Number(n||0)).toLocaleString("tr-TR",{minimumFractionDigits:2, maximumFractionDigits:2}) + " â‚º";
  const cell=(val,ok)=> Number(val||0)===0
    ? `<td class="muted" style="opacity:0.4; font-size:12px">â€”</td>`
    : `<td>${ ok ? `<span class="chip ok">${fmt(val)}</span>` : `<span class="chip no">${fmt(val)}</span>` }</td>`;

  rows.forEach(d=>{
    // Kalan hesapla
    let kalanTutar = 0;
    KATEGORILER.forEach(k => {
      const tutar = +(d[k] || 0);
      if(tutar > 0 && !d.odemeler?.[k]) {
        kalanTutar += tutar;
      }
    });
    
    // Desktop table row
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td style="text-align:left;font-weight:600; color:#0f172a; font-size:13px">${d.ad||'-'}</td>
      ${KATEGORILER.map(k => cell(d[k], d.odemeler?.[k])).join('')}
      <td>${ d.maas==='Ã¶dendi' ? '<span class="chip ok">Ã–dendi</span>' : '<span class="chip no">Ã–denmedi</span>' }</td>
      <td style="font-weight:700; color:#2563eb; font-size:13px">${fmt(d.toplam||0)}</td>
      <td style="font-weight:700; color:${kalanTutar > 0 ? '#dc2626' : '#16a34a'}; font-size:13px">${fmt(kalanTutar)}</td>
    `;
    // Sadece admin iÃ§in tÄ±klanabilir
    if(IS_ADMIN) {
      tr.style.cursor='pointer';
      tr.onclick=()=> openOdeme(d.id, d);
    } else {
      tr.style.cursor='default';
    }
    tbody.appendChild(tr);

    // Mobile card
    const card = document.createElement('div');
    card.className = 'person-card';
    // Sadece admin iÃ§in tÄ±klanabilir
    if(IS_ADMIN) {
      card.style.cursor = 'pointer';
      card.onclick = () => openOdeme(d.id, d);
    } else {
      card.style.cursor = 'default';
    }
    const cellValue = (val, ok) => {
      if(Number(val||0) === 0) return '<span class="muted">-</span>';
      return ok ? `<span class="chip ok">${fmt(val)}</span>` : `<span class="chip no">${fmt(val)}</span>`;
    };
    const kategoriLabels = {hediye:'Hediye',kira:'Kira',cocuk:'Ã‡ocuk',yol:'Yol',haberlesme:'HaberleÅŸme',ikramiye:'Ä°kramiye',yakacak:'Yakacak',elbise:'Elbise',ssk:'SSK'};
    const kategoriRows = [];
    for(let i=0; i<KATEGORILER.length; i+=2) {
      const k1 = KATEGORILER[i];
      const k2 = KATEGORILER[i+1];
      kategoriRows.push(`
        <div class="person-card-row">
          <div><div class="person-card-label">${kategoriLabels[k1]}</div><div class="person-card-value">${cellValue(d[k1], d.odemeler?.[k1])}</div></div>
          ${k2 ? `<div><div class="person-card-label">${kategoriLabels[k2]}</div><div class="person-card-value">${cellValue(d[k2], d.odemeler?.[k2])}</div></div>` : '<div></div>'}
        </div>
      `);
    }
    card.innerHTML = `
      <div class="person-card-header">
        <h3>${d.ad||'-'}</h3>
      </div>
      ${kategoriRows.join('')}
      <div class="person-card-row">
        <div><div class="person-card-label">ResmÃ® MaaÅŸ</div><div class="person-card-value">${d.maas==='Ã¶dendi' ? '<span class="chip ok">Ã–dendi</span>' : '<span class="chip no">Ã–denmedi</span>'}</div></div>
      </div>
      <div class="person-card-row">
        <div><div class="person-card-label">Toplam</div><div class="person-card-value">${fmt(d.toplam||0)}</div></div>
        <div><div class="person-card-label">Kalan</div><div class="person-card-value" style="color:${kalanTutar > 0 ? 'var(--danger)' : 'var(--success)'}">${fmt(kalanTutar)}</div></div>
      </div>
    `;
    mobileCards.appendChild(card);

    for(const k of Object.keys(ozet)){
      ozet[k].toplam += +(d[k]||0);
      if(d.odemeler?.[k]) ozet[k].odenen += +(d[k]||0);
    }
  });

  const ozetAlani=document.getElementById("ozetAlani");
  const mobileSummaryCards=document.getElementById("mobileSummaryCards");
  const ozetTarihBilgisi=document.getElementById("ozetTarihBilgisi");
  const ay = +aySec.value, yil = +yilSec.value;
  const ayAdi = monthsTR[ay - 1] || '';
  
  // Tarih bilgisini gÃ¼ncelle
  ozetTarihBilgisi.textContent = `${ayAdi} ${yil}`;
  
  ozetAlani.innerHTML="";
  mobileSummaryCards.innerHTML="";
  
  let toplamBorÃ§ = 0, toplamÃ–denen = 0;
  
  Object.entries(ozet).forEach(([k,{toplam,odenen}])=>{
    const kalan = (+(toplam||0) - +(odenen||0)); 
    genelKalan+=kalan;
    toplamBorÃ§ += +(toplam||0);
    toplamÃ–denen += +(odenen||0);
    
    // Desktop table
    const tr=document.createElement('tr');
    tr.innerHTML=`<td style="text-transform:capitalize">${k}</td><td>${fmt(toplam)}</td><td>${fmt(odenen)}</td><td>${fmt(kalan)}</td>`;
    ozetAlani.appendChild(tr);
    
    // Mobile card
    const card=document.createElement('div');
    card.className='summary-card';
    card.innerHTML=`
      <div class="summary-card-label">${k}</div>
      <div class="summary-card-value">${fmt(toplam)}</div>
      <div style="font-size:12px; color:var(--muted); margin-bottom:4px">Ã–denen: ${fmt(odenen)}</div>
      <div class="summary-card-kalan">Kalan: ${fmt(kalan)}</div>
    `;
    mobileSummaryCards.appendChild(card);
  });
  
  // Toplam satÄ±rÄ± - Desktop
  const ozetToplamSatir = document.getElementById("ozetToplamSatir");
  ozetToplamSatir.innerHTML = `
    <strong>Toplam BorÃ§: ${fmt(toplamBorÃ§)}</strong> + 
    <strong style="color:var(--success)">Ã–denen: ${fmt(toplamÃ–denen)}</strong> + 
    <strong style="color:var(--danger)">Kalan: ${fmt(genelKalan)}</strong>
  `;
  
  // Total card - Mobile
  const totalCard=document.createElement('div');
  totalCard.className='summary-card summary-card-total';
  totalCard.innerHTML=`
    <div class="summary-card-label">Toplam BorÃ§</div>
    <div class="summary-card-value">${fmt(toplamBorÃ§)}</div>
    <div style="margin-top:8px; padding-top:8px; border-top:1px solid var(--stroke)">
      <div style="font-size:13px; margin-bottom:4px"><strong style="color:var(--success)">Ã–denen: ${fmt(toplamÃ–denen)}</strong></div>
      <div style="font-size:13px"><strong style="color:var(--danger)">Kalan: ${fmt(genelKalan)}</strong></div>
    </div>
  `;
  mobileSummaryCards.appendChild(totalCard);
}

async function listele() {
  const ay = +aySec.value, yil = +yilSec.value;

  // Supabase: yalnÄ±zca Ay/YÄ±l DEÄÄ°ÅTÄ°ÄÄ°NDE Ã§aÄŸrÄ±lmalÄ±
  try {
    const sb = getSupabase();
    if (!sb) {
      console.error('Supabase client bulunamadÄ±');
      toast('VeritabanÄ± baÄŸlantÄ±sÄ± kurulamadÄ±. SayfayÄ± yenileyin.');
      return;
    }

    const { data, error } = await sb.from(aktifKoleksiyon)
      .select('*')
      .eq('ay', ay)
      .eq('yil', yil);
    
    if(error) {
      console.error('VeritabanÄ± hatasÄ±:', error);
      // RLS hatasÄ± kontrolÃ¼
      if (error.code === '42501' || error.message?.includes('permission') || error.message?.includes('policy')) {
        toast('Bu verilere eriÅŸim yetkiniz yok. LÃ¼tfen yÃ¶netici ile iletiÅŸime geÃ§in.');
      } else {
        toast(`Veriler yÃ¼klenirken hata: ${error.message || 'Bilinmeyen hata'}`);
      }
      return;
    }
    
    CACHE_ROWS = (data || []).map(doc => ({ id: doc.id, ...doc }));
    applySearch();                   // arama kutusundaki mevcut deÄŸere gÃ¶re filtrele
    renderTableAndSummary(LAST_ROWS);
    
    if (CACHE_ROWS.length === 0) {
      toast(`${monthsTR[ay-1]} ${yil} iÃ§in kayÄ±t bulunamadÄ±.`);
    }
  } catch(e) {
    console.error('listele hatasÄ±:', e);
    toast(`Veriler yÃ¼klenirken hata: ${e.message || 'Bilinmeyen hata'}`);
  }
}

  // SÄ±ralama
  document.querySelectorAll('th.sortable').forEach(th => {
    th.addEventListener('click', () => {
      const col = th.dataset.sort;
      if(SORT_COL === col) {
        SORT_DIR = SORT_DIR === 'asc' ? 'desc' : 'asc';
      } else {
        SORT_COL = col;
        SORT_DIR = 'asc';
      }
      // SÄ±ralama iÅŸaretlerini gÃ¼ncelle
      document.querySelectorAll('th.sortable').forEach(t => {
        t.classList.remove('sort-asc', 'sort-desc');
      });
      th.classList.add(SORT_DIR === 'asc' ? 'sort-asc' : 'sort-desc');
      applySort();
      renderTableAndSummary(LAST_ROWS);
    });
  });

  // Arama debounce
  let sTO=null;
  searchInput.addEventListener('input', ()=>{
    clearTimeout(sTO);
    sTO = setTimeout(()=>{
      applySearch();                    // uzak sorgu yok
      renderTableAndSummary(LAST_ROWS); // sadece yerelde filtre
    }, 120);
  });
  aySec.onchange = yilSec.onchange = listele;

  // Toplu set
  async function bulkSet(paid){
    const sb = getSupabase();
    if(!LAST_ROWS.length){ toast("Ä°ÅŸaretlenecek kayÄ±t yok."); return; }
    const cat=document.getElementById("bulkKategoriModal").value;
    try {
      for(const r of LAST_ROWS){
        if(cat==="maas"){
          const { error } = await sb.from(aktifKoleksiyon)
            .update({ maas: paid ? "Ã¶dendi":"Ã¶denmedi" })
            .eq('id', r.id);
          if(error) throw error;
        }else{
          // JSONB alanÄ±nÄ± gÃ¼ncellemek iÃ§in Ã¶nce mevcut deÄŸeri al
          const { data: current, error: fetchError } = await sb.from(aktifKoleksiyon)
            .select('odemeler')
            .eq('id', r.id)
            .single();
          if(fetchError) throw fetchError;
          
          const odemeler = current.odemeler || {};
          odemeler[cat] = !!paid;
          
          const { error: updateError } = await sb.from(aktifKoleksiyon)
            .update({ odemeler })
            .eq('id', r.id);
          if(updateError) throw updateError;
        }
      }
      closeModals();
      toast(`Toplu gÃ¼ncellendi: ${LAST_ROWS.length} kayÄ±t`); 
      listele();
    } catch(e) {
      console.error(e);
      toast('Toplu gÃ¼ncelleme baÅŸarÄ±sÄ±z.');
    }
  }
  btnBulkOkModal.onclick=()=>bulkSet(true);
  btnBulkNoModal.onclick=()=>bulkSet(false);

  // Ã–deme modal
  let aktifID=null, aktifVeri=null, editMode=false;
  function openOdeme(id, veri){
    if(!IS_ADMIN) {
      toast('Bu iÅŸlem iÃ§in yetkiniz yok.');
      return;
    }
    aktifID=id;
    aktifVeri=veri;
    editMode=false;
    const ayAdi = monthsTR[veri.ay - 1] || veri.ay;
    document.getElementById("odemeModalBaslik").textContent=`${veri.ad||'-'} (${String(veri.ay).padStart(2,'0')}/${veri.yil})`;
    
    // UyarÄ± kontrolÃ¼
    const uyariAlani = document.getElementById("odemeUyariAlani");
    const odemelerYapildi = KATEGORILER.some(k => veri.odemeler?.[k]) || veri.maas==="Ã¶dendi";
    if(odemelerYapildi) {
      const kategoriLabels = {hediye:'Hediye',kira:'Kira',cocuk:'Ã‡ocuk',yol:'Yol',haberlesme:'HaberleÅŸme',ikramiye:'Ä°kramiye',yakacak:'Yakacak',elbise:'Elbise',ssk:'SSK'};
      const odenenKategoriler = [];
      KATEGORILER.forEach(k => {
        if(veri.odemeler?.[k]) odenenKategoriler.push(kategoriLabels[k]);
      });
      if(veri.maas==="Ã¶dendi") odenenKategoriler.push("ResmÃ® MaaÅŸ");
      uyariAlani.innerHTML = `âš ï¸ <strong>${veri.ad}</strong> personelinin ${ayAdi} ${veri.yil} ayÄ±ndaki ${odenenKategoriler.join(", ")} Ã¶denmiÅŸ.`;
      uyariAlani.style.display = "block";
    } else {
      uyariAlani.style.display = "none";
    }
    
    const div=document.getElementById("odemeKategoriAlani"); div.innerHTML="";
    const disabledAttr = IS_ADMIN ? '' : 'disabled';
    
    // Form grid yapÄ±sÄ±
    div.innerHTML = '<div class="form-grid">';
    const kategoriLabels = {hediye:'Hediye',kira:'Kira',cocuk:'Ã‡ocuk',yol:'Yol',haberlesme:'HaberleÅŸme',ikramiye:'Ä°kramiye',yakacak:'Yakacak',elbise:'Elbise',ssk:'SSK'};
    
    KATEGORILER.forEach(key=>{
      div.innerHTML += `
        <div class="form-group">
          <label>${kategoriLabels[key] || key.toUpperCase()}</label>
          <select id="odeme_${key}" ${disabledAttr}>
            <option value="true"  ${veri.odemeler?.[key] ? "selected":""}>Ã–dendi</option>
            <option value="false" ${!veri.odemeler?.[key] ? "selected":""}>Ã–denmedi</option>
          </select>
        </div>`;
    });
    div.innerHTML += `
      <div class="form-group">
        <label>ResmÃ® MaaÅŸ</label>
        <select id="odeme_maas" ${disabledAttr}>
          <option value="Ã¶dendi"   ${veri.maas==="Ã¶dendi" ? "selected":""}>Ã–dendi</option>
          <option value="Ã¶denmedi" ${veri.maas==="Ã¶denmedi" ? "selected":""}>Ã–denmedi</option>
        </select>
      </div>
    </div>`;
    
    // Tutar alanlarÄ±nÄ± doldur
    KATEGORILER.forEach(k => {
      const input = document.getElementById(`edit_${k}`);
      if(input) {
        input.value = veri[k] || 0;
        if(!IS_ADMIN) input.disabled = true;
      }
    });
    updateEditToplam();
    
    // Edit mode'u kapat
    document.getElementById("odemeTutarAlani").style.display = "none";
    const btnEdit = document.getElementById("btnEditTutarlar");
    const btnSil = document.getElementById("btnSilVeri");
    const btnKaydet = document.getElementById("btnKaydetOdeme");
    
    if(btnEdit) {
      btnEdit.textContent = "DÃ¼zenle";
      btnEdit.style.display = IS_ADMIN ? "inline-block" : "none";
    }
    if(btnSil) {
      btnSil.style.display = IS_ADMIN ? "inline-block" : "none";
    }
    if(btnKaydet) {
      btnKaydet.style.display = IS_ADMIN ? "inline-block" : "none";
    }
    
    // Event listener'larÄ± ekle (her modal aÃ§Ä±lÄ±ÅŸÄ±nda)
    setTimeout(() => {
      KATEGORILER.forEach(k => {
        const input = document.getElementById(`edit_${k}`);
        if(input) {
          input.removeEventListener('input', updateEditToplam);
          input.addEventListener('input', updateEditToplam);
        }
      });
    }, 100);
    
    openModal("odemeModal");
  }
  // Global scope'a ekle
  window.openOdeme = openOdeme;
  
  function toggleEditMode() {
    editMode = !editMode;
    const tutarAlani = document.getElementById("odemeTutarAlani");
    const btnEdit = document.getElementById("btnEditTutarlar");
    
    if(editMode) {
      tutarAlani.style.display = "block";
      btnEdit.textContent = "Ä°ptal";
    } else {
      tutarAlani.style.display = "none";
      btnEdit.textContent = "DÃ¼zenle";
      // Orijinal deÄŸerlere geri dÃ¶n
      if(aktifVeri) {
        KATEGORILER.forEach(k => {
          const input = document.getElementById(`edit_${k}`);
          if(input) input.value = aktifVeri[k] || 0;
        });
        updateEditToplam();
      }
    }
  }
  // Global scope'a ekle
  window.toggleEditMode = toggleEditMode;
  
  function updateEditToplam() {
    const toplam = KATEGORILER.reduce((sum, k) => {
      const input = document.getElementById(`edit_${k}`);
      return sum + (+(input?.value || 0));
    }, 0);
    document.getElementById("editToplamGoster").textContent = fmt(toplam);
  }
  // Global scope'a ekle
  window.updateEditToplam = updateEditToplam;
  
  // Tutar inputlarÄ±na event listener ekle (modal aÃ§Ä±ldÄ±ÄŸÄ±nda)
  // Bu fonksiyon openOdeme iÃ§inde Ã§aÄŸrÄ±lacak
  async function kaydetOdeme(){
    const sb = getSupabase();
    if(!IS_ADMIN) {
      toast('Bu iÅŸlem iÃ§in yetkiniz yok.');
      return;
    }
    const odemeler={}; 
    KATEGORILER.forEach(k=> odemeler[k] = document.getElementById(`odeme_${k}`)?.value==="true");
    const maas=document.getElementById("odeme_maas").value;
    
    const updateData = { odemeler, maas };
    
    // EÄŸer edit mode aktifse tutarlarÄ± da gÃ¼ncelle
    if(editMode) {
      const yeniTutarlar = {};
      KATEGORILER.forEach(k => {
        const input = document.getElementById(`edit_${k}`);
        yeniTutarlar[k] = +(input?.value || 0);
      });
      yeniTutarlar.toplam = KATEGORILER.reduce((sum, k) => sum + (yeniTutarlar[k] || 0), 0);
      Object.assign(updateData, yeniTutarlar);
    }
    
    try{ 
      const { error } = await sb.from(aktifKoleksiyon)
        .update(updateData)
        .eq('id', aktifID);
      if(error) throw error;
      closeModals(); 
      toast(editMode ? "Tutarlar ve Ã¶demeler gÃ¼ncellendi." : "Ã–demeler gÃ¼ncellendi."); 
      listele(); 
    }
    catch(e){ console.error(e); toast("GÃ¼ncelleme hata."); }
  }
  // Global scope'a ekle
  window.kaydetOdeme = kaydetOdeme;
  async function silVeri(){
    const sb = getSupabase();
    if(!IS_ADMIN) {
      toast('Bu iÅŸlem iÃ§in yetkiniz yok.');
      return;
    }
    if(!aktifID) return;
    if(confirm("Bu personel kaydÄ± silinsin mi?")){
      try{ 
        const { error } = await sb.from(aktifKoleksiyon)
          .delete()
          .eq('id', aktifID);
        if(error) throw error;
        closeModals(); 
        toast("KayÄ±t silindi."); 
        listele(); 
      }
      catch(e){ console.error(e); toast("Silme hata."); }
    }
  }
  // Global scope'a ekle
  window.silVeri = silVeri;

  // Personel YÃ¶netim Modal
  let personelManageData = {};
  
  async function openPersonelManageModal() {
    const sb = getSupabase();
    const modal = document.getElementById("personelManageModal");
    const personelSelect = document.getElementById("personelSelect");
    const yilSelect = document.getElementById("personelYilSelect");
    
    // Personel listesini yÃ¼kle
    try {
      const { data, error } = await sb.from(aktifKoleksiyon).select('ad');
      if(error) throw error;
      const personeller = new Set();
      (data || []).forEach(d => {
        if(d.ad) personeller.add(d.ad);
      });
      
      personelSelect.innerHTML = '<option value="">Personel seÃ§in</option>';
      Array.from(personeller).sort().forEach(ad => {
        personelSelect.add(new Option(ad, ad));
      });
    } catch(e) {
      console.error(e);
      toast('Personel listesi yÃ¼klenemedi.');
    }
    
    // YÄ±l listesini doldur
    const bugun = new Date();
    const sy = bugun.getFullYear() - 5;
    const ey = bugun.getFullYear() + 1;
    yilSelect.innerHTML = '<option value="">YÄ±l seÃ§in</option>';
    for(let y = ey; y >= sy; y--) {
      yilSelect.add(new Option(y, y));
    }
    
    // Event listener'lar
    personelSelect.onchange = yilSelect.onchange = async () => {
      const personelAd = personelSelect.value;
      const yil = yilSelect.value;
      
      if(!personelAd || !yil) {
        document.getElementById("personelDataArea").style.display = "none";
        document.getElementById("personelEmptyState").style.display = "block";
        return;
      }
      
      await loadPersonelYilData(personelAd, +yil);
    };
    
    document.getElementById("personelDataArea").style.display = "none";
    document.getElementById("personelEmptyState").style.display = "block";
    openModal("personelManageModal");
  }
  
  async function loadPersonelYilData(personelAd, yil) {
    const sb = getSupabase();
    try {
      const { data, error } = await sb.from(aktifKoleksiyon)
        .select('*')
        .eq('ad', personelAd)
        .eq('yil', yil);
      
      if(error) throw error;
      
      personelManageData = {};
      let yillikToplam = 0;
      
      (data || []).forEach(doc => {
        const ay = doc.ay;
        personelManageData[ay] = {
          id: doc.id,
          ...doc
        };
        yillikToplam += +(doc.toplam || 0);
      });
      
      // UI gÃ¼ncelle
      document.getElementById("personelAdGoster").textContent = personelAd;
      document.getElementById("personelYilGoster").textContent = `${yil} YÄ±lÄ± - ${Object.keys(personelManageData).length} Ay`;
      document.getElementById("yillikToplamGoster").textContent = fmt(yillikToplam);
      
      renderPersonelAylar();
      
      document.getElementById("personelDataArea").style.display = "block";
      document.getElementById("personelEmptyState").style.display = "none";
      document.getElementById("btnPersonelKaydet").style.display = "inline-block";
    } catch(e) {
      console.error(e);
      toast('Veriler yÃ¼klenirken hata.');
    }
  }
  
  function renderPersonelAylar() {
    const container = document.getElementById("personelAylarListesi");
    container.innerHTML = "";
    
    const aylar = Object.keys(personelManageData).sort((a, b) => +a - +b);
    
    if(aylar.length === 0) {
      container.innerHTML = '<div style="text-align:center; padding:20px; color:var(--muted)">Bu yÄ±l iÃ§in kayÄ±t bulunamadÄ±.</div>';
      return;
    }
    
    aylar.forEach(ay => {
      const data = personelManageData[ay];
      const ayAdi = monthsTR[+ay - 1] || ay;
      
      const card = document.createElement('div');
      card.style.cssText = 'background:var(--card); border:1px solid var(--stroke); border-radius:12px; padding:16px; box-shadow:0 2px 8px rgba(0,0,0,.06)';
      
      card.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; padding-bottom:12px; border-bottom:1px solid var(--stroke)">
          <div>
            <h4 style="margin:0; font-size:16px; color:var(--text)">${ayAdi} ${data.yil}</h4>
            <div class="muted" style="font-size:12px; margin-top:4px">Toplam: <strong style="color:var(--brand)">${fmt(data.toplam || 0)}</strong></div>
          </div>
          <div style="text-align:right">
            <div style="font-size:11px; color:var(--muted); margin-bottom:4px">Kalan</div>
            <div style="font-size:18px; font-weight:700; color:var(--danger)">${fmt(calculateKalan(data))}</div>
          </div>
        </div>
        
        <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-bottom:12px">
          ${KATEGORILER.map(k => {
            const labels = {hediye:'Hediye',kira:'Kira',cocuk:'Ã‡ocuk',yol:'Yol',haberlesme:'HaberleÅŸme',ikramiye:'Ä°kramiye',yakacak:'Yakacak',elbise:'Elbise',ssk:'SSK'};
            return `
              <div>
                <label style="display:block; font-size:11px; color:var(--muted); margin-bottom:4px">${labels[k]}</label>
                <input type="number" data-ay="${ay}" data-field="${k}" value="${data[k] || 0}" min="0" step="0.01" 
                  style="width:100%; padding:6px 8px; border:1px solid var(--stroke); border-radius:6px; background:var(--pill); color:var(--text); font-size:13px">
              </div>
            `;
          }).join('')}
        </div>
        
        <div style="display:grid; grid-template-columns:repeat(2,1fr); gap:8px; margin-top:12px">
          <div>
            <label style="display:block; font-size:11px; color:var(--muted); margin-bottom:4px">Ã–deme DurumlarÄ±</label>
            <div style="display:flex; flex-wrap:wrap; gap:6px">
              ${KATEGORILER.map(k => {
                const labels = {hediye:'Hediye',kira:'Kira',cocuk:'Ã‡ocuk',yol:'Yol',haberlesme:'HaberleÅŸme',ikramiye:'Ä°kramiye',yakacak:'Yakacak',elbise:'Elbise',ssk:'SSK'};
                return `
                  <label style="display:flex; align-items:center; gap:4px; font-size:11px; cursor:pointer; padding:4px 8px; background:${data.odemeler?.[k] ? 'var(--success)22' : 'var(--pill)'}; border:1px solid ${data.odemeler?.[k] ? 'var(--success)' : 'var(--stroke)'}; border-radius:6px">
                    <input type="checkbox" data-ay="${ay}" data-field="${k}" ${data.odemeler?.[k] ? 'checked' : ''} style="cursor:pointer">
                    <span style="text-transform:capitalize; font-weight:600; color:${data.odemeler?.[k] ? 'var(--success)' : 'var(--text)'}">${labels[k]}</span>
                  </label>
                `;
              }).join('')}
            </div>
          </div>
          <div>
            <label style="display:block; font-size:11px; color:var(--muted); margin-bottom:4px">ResmÃ® MaaÅŸ</label>
            <select data-ay="${ay}" data-field="maas" style="width:100%; padding:6px 8px; border:1px solid var(--stroke); border-radius:6px; background:var(--pill); color:var(--text); font-size:13px">
              <option value="Ã¶denmedi" ${data.maas==='Ã¶denmedi' ? 'selected' : ''}>Ã–denmedi</option>
              <option value="Ã¶dendi" ${data.maas==='Ã¶dendi' ? 'selected' : ''}>Ã–dendi</option>
            </select>
          </div>
        </div>
      `;
      
      container.appendChild(card);
    });
    
    // Input deÄŸiÅŸikliklerinde toplam gÃ¼ncelle
    container.querySelectorAll('input[type="number"]').forEach(input => {
      input.addEventListener('input', () => {
        const ay = input.dataset.ay;
        updateAyToplam(ay);
      });
    });
  }
  
  function calculateKalan(data) {
    let kalan = 0;
    KATEGORILER.forEach(k => {
      const tutar = +(data[k] || 0);
      if(tutar > 0 && !data.odemeler?.[k]) kalan += tutar;
    });
    return kalan;
  }
  
  function updateAyToplam(ay) {
    const data = personelManageData[ay];
    if(!data) return;
    
    const inputs = document.querySelectorAll(`input[data-ay="${ay}"][data-field]`);
    let toplam = 0;
    inputs.forEach(input => {
      if(input.type === 'number') {
        const field = input.dataset.field;
        data[field] = +(input.value || 0);
        toplam += data[field];
      }
    });
    
    data.toplam = toplam;
    
    // UI'da toplamÄ± gÃ¼ncelle
    const card = document.querySelector(`input[data-ay="${ay}"]`)?.closest('div[style*="border-radius:12px"]');
    if(card) {
      const toplamEl = card.querySelector('strong[style*="color:var(--brand)"]');
      if(toplamEl) toplamEl.textContent = fmt(toplam);
      
      // Kalan hesapla ve gÃ¼ncelle
      const checkboxes = card.querySelectorAll('input[type="checkbox"]');
      checkboxes.forEach(cb => {
        const field = cb.dataset.field;
        data.odemeler = data.odemeler || {};
        data.odemeler[field] = cb.checked;
      });
      
      const kalanEl = card.querySelector('div[style*="color:var(--danger)"]');
      if(kalanEl) kalanEl.textContent = fmt(calculateKalan(data));
    }
    
    // YÄ±llÄ±k toplamÄ± gÃ¼ncelle
    let yillikToplam = 0;
    Object.keys(personelManageData).forEach(a => {
      yillikToplam += +(personelManageData[a].toplam || 0);
    });
    document.getElementById("yillikToplamGoster").textContent = fmt(yillikToplam);
  }
  
  async function kaydetPersonelYonetim() {
    if(Object.keys(personelManageData).length === 0) {
      toast('Kaydedilecek veri yok.');
      return;
    }
    
    try {
      let updated = 0;
      
      for(const ay of Object.keys(personelManageData)) {
        const data = personelManageData[ay];
        
        // Checkbox'larÄ± gÃ¼ncelle
        const card = document.querySelector(`input[data-ay="${ay}"]`)?.closest('div[style*="border-radius:12px"]');
        if(card) {
          const checkboxes = card.querySelectorAll('input[type="checkbox"]');
          checkboxes.forEach(cb => {
            const field = cb.dataset.field;
            data.odemeler = data.odemeler || {};
            data.odemeler[field] = cb.checked;
          });
          
          const maasSelect = card.querySelector('select[data-field="maas"]');
          if(maasSelect) data.maas = maasSelect.value;
        }
        
        // ToplamÄ± hesapla
        data.toplam = KATEGORILER.reduce((sum, k) => sum + (+(data[k] || 0)), 0);
        
        const updateObj = { toplam: data.toplam, odemeler: data.odemeler || {}, maas: data.maas || 'Ã¶denmedi' };
        KATEGORILER.forEach(k => {
          updateObj[k] = +(data[k] || 0);
        });
        
        const sb = getSupabase();
        const { error } = await sb.from(aktifKoleksiyon)
          .update(updateObj)
          .eq('id', data.id);
        if(error) throw error;
        updated++;
      }
      
      closeModals();
      toast(`${updated} ay verisi gÃ¼ncellendi.`);
      listele();
    } catch(e) {
      console.error(e);
      toast('KayÄ±t sÄ±rasÄ±nda hata oluÅŸtu.');
    }
  }
  // Global scope'a ekle
  window.kaydetPersonelYonetim = kaydetPersonelYonetim;

  // Analiz Modal - Global deÄŸiÅŸkenler
  let kategoriChartInstance = null;
  
  // PDF Export Fonksiyonu - Yeni sayfaya yÃ¶nlendir
  async function exportAnalizPDF() {
    try {
      const analizDataArea = document.getElementById("analizDataArea");
      if(!analizDataArea || analizDataArea.style.display === "none") {
        toast("Ã–nce analiz verilerini yÃ¼kleyin.");
        return;
      }
      
      // Verileri topla
      const baslik = document.getElementById("analizBaslikGoster").textContent;
      const yil = document.getElementById("analizYilGoster").textContent;
      const yillikToplam = document.getElementById("analizYillikToplamGoster").textContent;
      
      // Analiz tablosu verilerini topla
      const analizTable = document.getElementById("analizTable");
      const tableData = [];
      if(analizTable) {
        const rows = analizTable.querySelectorAll("tbody tr");
        rows.forEach(row => {
          const cells = row.querySelectorAll("td");
          if(cells.length >= 4) {
            tableData.push({
              kategori: cells[0].textContent.trim(),
              toplam: cells[1].textContent.trim(),
              odenen: cells[2].textContent.trim(),
              kalan: cells[3].textContent.trim()
            });
          }
        });
      }
      
      // AylÄ±k daÄŸÄ±lÄ±m verilerini topla
      const aylikDagilim = document.getElementById("analizAylikDagilim");
      const aylikData = [];
      if(aylikDagilim && aylikDagilim.children.length > 0) {
        Array.from(aylikDagilim.children).forEach(card => {
          const text = card.textContent.trim();
          const lines = text.split('\n').filter(l => l.trim());
          if(lines.length >= 4) {
            aylikData.push({
              ay: lines[0].trim(),
              toplam: lines[1].trim(),
              odenen: lines[2].trim(),
              kalan: lines[3].trim()
            });
          }
        });
      }
      
      // Kategori detay verilerini topla (eÄŸer varsa)
      const kategoriDetayArea = document.getElementById("kategoriDetayArea");
      let kategoriDetay = null;
      
      if(kategoriDetayArea && kategoriDetayArea.style.display !== "none") {
        const kategoriSelect = document.getElementById("analizKategoriSelect");
        const seciliKategori = kategoriSelect.value;
        
        // TÃ¼m kategoriler seÃ§ildiyse
        if(seciliKategori === 'tum') {
          const tumKategorilerDiv = document.getElementById("tumKategorilerDetay");
          const tumKategoriler = ['hediye', 'kira', 'cocuk', 'yol', 'haberlesme', 'ikramiye', 'yakacak', 'elbise'];
          const kategoriLabels = {
            hediye: 'Hediye',
            kira: 'Kira',
            cocuk: 'Ã‡ocuk',
            yol: 'Yol',
            haberlesme: 'HaberleÅŸme',
            ikramiye: 'Ä°kramiye',
            yakacak: 'Yakacak',
            elbise: 'Elbise'
          };
          
          const tumKategoriDetaylari = [];
          
          // window.currentAnalizSnap kullanarak doÄŸrudan hesapla
          const analizSnap = window.currentAnalizSnap;
          const monthsTR = ["Ocak","Åubat","Mart","Nisan","MayÄ±s","Haziran","Temmuz","AÄŸustos","EylÃ¼l","Ekim","KasÄ±m","AralÄ±k"];
          const fmt = (n) => (Number(n||0)).toLocaleString("tr-TR",{minimumFractionDigits:2, maximumFractionDigits:2}) + " â‚º";
          
          tumKategoriler.forEach(kat => {
            // Her kategori iÃ§in veri topla (loadKategoriDetay ile aynÄ± mantÄ±k)
            const aylikKategoriData = {};
            for(let ay = 1; ay <= 12; ay++) {
              aylikKategoriData[ay] = { toplam: 0, odenen: 0, kalan: 0 };
            }
            
            if(analizSnap) {
              analizSnap.forEach(doc => {
                const d = doc.data();
                const ay = d.ay || 1;
                const tutar = +(d[kat] || 0);
                
                if(tutar > 0) {
                  aylikKategoriData[ay].toplam += tutar;
                  if(d.odemeler?.[kat]) {
                    aylikKategoriData[ay].odenen += tutar;
                  } else {
                    aylikKategoriData[ay].kalan += tutar;
                  }
                }
              });
            }
            
            // Toplam hesapla
            let kategoriToplam = 0, kategoriOdenen = 0, kategoriKalan = 0;
            Object.values(aylikKategoriData).forEach(data => {
              kategoriToplam += data.toplam;
              kategoriOdenen += data.odenen;
              kategoriKalan += data.kalan;
            });
            
            const yuzde = kategoriToplam > 0 ? ((kategoriOdenen / kategoriToplam) * 100).toFixed(1) : 0;
            
            // Detay tablosu verilerini topla
            const kategoriSection = tumKategorilerDiv.querySelector(`#kategoriDetayTableBody_${kat}`);
            const detayTableData = [];
            
            if(kategoriSection) {
              const rows = kategoriSection.querySelectorAll("tr");
              rows.forEach(row => {
                const cells = row.querySelectorAll("td");
                if(cells.length >= 5) {
                  detayTableData.push({
                    ay: cells[0].textContent.trim(),
                    toplam: cells[1].textContent.trim(),
                    odenen: cells[2].textContent.trim(),
                    kalan: cells[3].textContent.trim(),
                    durum: cells[4].textContent.trim()
                  });
                }
              });
            } else {
              // Tablo yoksa aylÄ±k verilerden oluÅŸtur
              const monthsTR = ["Ocak","Åubat","Mart","Nisan","MayÄ±s","Haziran","Temmuz","AÄŸustos","EylÃ¼l","Ekim","KasÄ±m","AralÄ±k"];
              for(let ay = 1; ay <= 12; ay++) {
                const ayData = aylikKategoriData[ay];
                const ayAdi = monthsTR[ay - 1] || ay;
                
                let durum = 'â€”';
                if(ayData.toplam === 0) {
                  durum = 'â€”';
                } else if(ayData.kalan === 0) {
                  durum = 'TamamlandÄ±';
                } else if(ayData.odenen === 0) {
                  durum = 'Ã–denmedi';
                } else {
                  const durumYuzde = ((ayData.odenen / ayData.toplam) * 100).toFixed(0);
                  durum = `%${durumYuzde}`;
                }
                
                detayTableData.push({
                  ay: ayAdi,
                  toplam: fmt(ayData.toplam),
                  odenen: fmt(ayData.odenen),
                  kalan: fmt(ayData.kalan),
                  durum: durum
                });
              }
            }
            
            tumKategoriDetaylari.push({
              kategoriAdi: kategoriLabels[kat],
              toplam: fmt(kategoriToplam),
              odenen: fmt(kategoriOdenen),
              kalan: fmt(kategoriKalan),
              yuzde: `${yuzde}%`,
              detayTable: detayTableData
            });
          });
          
          kategoriDetay = {
            kategoriAdi: 'TÃ¼m Kategoriler',
            tumKategoriler: tumKategoriDetaylari
          };
        } else {
          // Tek kategori seÃ§ildiyse
          const kategoriAdi = kategoriSelect.options[kategoriSelect.selectedIndex]?.text || "Kategori";
          
          const toplam = document.getElementById("kategoriToplam").textContent;
          const odenen = document.getElementById("kategoriOdenen").textContent;
          const kalan = document.getElementById("kategoriKalan").textContent;
          const yuzde = document.getElementById("kategoriYuzde").textContent;
          
          // Chart.js grafiÄŸini base64'e Ã§evir
          let chartImage = null;
          const chartCanvas = document.getElementById("kategoriChart");
          if(chartCanvas && kategoriChartInstance) {
            chartImage = chartCanvas.toDataURL("image/png");
          }
          
          // Kategori detay tablosu verilerini topla
          const kategoriDetayTable = document.getElementById("kategoriDetayTable");
          const detayTableData = [];
          if(kategoriDetayTable) {
            const rows = kategoriDetayTable.querySelectorAll("tbody tr");
            rows.forEach(row => {
              const cells = row.querySelectorAll("td");
              if(cells.length >= 5) {
                detayTableData.push({
                  ay: cells[0].textContent.trim(),
                  toplam: cells[1].textContent.trim(),
                  odenen: cells[2].textContent.trim(),
                  kalan: cells[3].textContent.trim(),
                  durum: cells[4].textContent.trim()
                });
              }
            });
          }
          
          kategoriDetay = {
            kategoriAdi,
            toplam,
            odenen,
            kalan,
            yuzde,
            chartImage,
            detayTable: detayTableData
          };
        }
      }
      
      // Verileri localStorage'a kaydet
      const exportData = {
        baslik,
        yil,
        yillikToplam,
        tableData,
        aylikData,
        kategoriDetay,
        timestamp: Date.now()
      };
      
      localStorage.setItem('analizPDFData', JSON.stringify(exportData));
      
      // Yeni sayfaya yÃ¶nlendir
      window.open('personelodemeanaliz.html', '_blank');
      
    } catch(e) {
      console.error(e);
      toast("Veriler hazÄ±rlanÄ±rken hata oluÅŸtu.");
    }
  }
  
  // Analiz Modal
  async function openAnalizModal() {
    const sb = getSupabase();
    const modal = document.getElementById("analizModal");
    const personelSelect = document.getElementById("analizPersonelSelect");
    const yilSelect = document.getElementById("analizYilSelect");
    
    // Personel listesini yÃ¼kle
    try {
      const { data, error } = await sb.from(aktifKoleksiyon).select('ad');
      if(error) throw error;
      const personeller = new Set();
      (data || []).forEach(d => {
        if(d.ad) personeller.add(d.ad);
      });
      
      personelSelect.innerHTML = '<option value="tum">TÃ¼m Personeller</option>';
      Array.from(personeller).sort().forEach(ad => {
        personelSelect.add(new Option(ad, ad));
      });
    } catch(e) {
      console.error(e);
      toast('Personel listesi yÃ¼klenemedi.');
    }
    
    // YÄ±l listesini doldur
    const bugun = new Date();
    const sy = bugun.getFullYear() - 5;
    const ey = bugun.getFullYear() + 1;
    yilSelect.innerHTML = '<option value="">YÄ±l seÃ§in</option>';
    for(let y = ey; y >= sy; y--) {
      yilSelect.add(new Option(y, y));
    }
    
    // Event listener'lar
    personelSelect.onchange = yilSelect.onchange = async () => {
      const personelAd = personelSelect.value;
      const yil = yilSelect.value;
      
      if(!yil) {
        document.getElementById("analizDataArea").style.display = "none";
        document.getElementById("analizEmptyState").style.display = "block";
        return;
      }
      
      await loadAnalizData(personelAd === "tum" ? null : personelAd, +yil);
    };
    
    document.getElementById("analizDataArea").style.display = "none";
    document.getElementById("analizEmptyState").style.display = "block";
    
    // Kategori detay alanÄ±nÄ± sÄ±fÄ±rla
    document.getElementById("analizKategoriSelect").value = "";
    document.getElementById("kategoriDetayArea").style.display = "none";
    document.getElementById("kategoriDetayEmpty").style.display = "block";
    if(kategoriChartInstance) {
      kategoriChartInstance.destroy();
      kategoriChartInstance = null;
    }
    
    openModal("analizModal");
  }
  
  async function loadAnalizData(personelAd, yil) {
    const sb = getSupabase();
    try {
      let query = sb.from(aktifKoleksiyon).select('*').eq('yil', yil);
      if(personelAd) {
        query = query.eq('ad', personelAd);
      }
      
      const { data, error } = await query;
      if(error) throw error;
      
      if(!data || data.length === 0) {
        document.getElementById("analizDataArea").style.display = "none";
        document.getElementById("analizEmptyState").style.display = "block";
        document.getElementById("analizEmptyState").innerHTML = `
          <div style="font-size:48px; margin-bottom:12px">ğŸ“Š</div>
          <div style="font-size:16px; font-weight:600">Veri bulunamadÄ±</div>
          <div style="font-size:13px; margin-top:6px">SeÃ§ilen kriterlere uygun kayÄ±t bulunamadÄ±</div>
        `;
        return;
      }
      
      // Verileri topla
      const analizData = {
        kategoriler: {},
        aylik: {},
        toplam: 0,
        odenen: 0,
        kalan: 0
      };
      
      // Kategorileri baÅŸlat
      KATEGORILER.forEach(k => {
        analizData.kategoriler[k] = { toplam: 0, odenen: 0, kalan: 0 };
      });
      
      // AylarÄ± baÅŸlat
      for(let ay = 1; ay <= 12; ay++) {
        analizData.aylik[ay] = { toplam: 0, odenen: 0, kalan: 0 };
      }
      
      data.forEach(d => {
        const ay = d.ay || 1;
        
        // Kategori toplamlarÄ±
        KATEGORILER.forEach(k => {
          const tutar = +(d[k] || 0);
          if(tutar > 0) {
            analizData.kategoriler[k].toplam += tutar;
            analizData.toplam += tutar;
            
            if(d.odemeler?.[k]) {
              analizData.kategoriler[k].odenen += tutar;
              analizData.odenen += tutar;
            } else {
              analizData.kategoriler[k].kalan += tutar;
              analizData.kalan += tutar;
            }
          }
        });
        
        // AylÄ±k toplamlar (sadece kategori toplamlarÄ±)
        let ayToplam = 0;
        let ayOdenen = 0;
        KATEGORILER.forEach(k => {
          const tutar = +(d[k] || 0);
          if(tutar > 0) {
            ayToplam += tutar;
            if(d.odemeler?.[k]) {
              ayOdenen += tutar;
            }
          }
        });
        analizData.aylik[ay].toplam += ayToplam;
        analizData.aylik[ay].odenen += ayOdenen;
        analizData.aylik[ay].kalan += (ayToplam - ayOdenen);
      });
      
      // UI gÃ¼ncelle
      const baslik = personelAd ? personelAd : "TÃ¼m Personeller";
      document.getElementById("analizBaslikGoster").textContent = baslik;
      document.getElementById("analizYilGoster").textContent = `${yil} YÄ±lÄ± Analizi`;
      document.getElementById("analizYillikToplamGoster").textContent = fmt(analizData.toplam);
      
      // Tablo oluÅŸtur
      const tbody = document.getElementById("analizTableBody");
      tbody.innerHTML = "";
      
      const kategoriLabels = {
        hediye: 'Hediye',
        kira: 'Kira',
        cocuk: 'Ã‡ocuk',
        yol: 'Yol',
        haberlesme: 'HaberleÅŸme',
        ikramiye: 'Ä°kramiye',
        yakacak: 'Yakacak',
        elbise: 'Elbise',
        ssk: 'SSK'
      };
      
      KATEGORILER.forEach(k => {
        const data = analizData.kategoriler[k];
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="text-align:left; padding-left:16px; font-weight:600">${kategoriLabels[k]}</td>
          <td style="text-align:center; font-weight:600">${fmt(data.toplam)}</td>
          <td style="text-align:center; color:var(--success); font-weight:600">${fmt(data.odenen)}</td>
          <td style="text-align:center; color:var(--danger); font-weight:600">${fmt(data.kalan)}</td>
        `;
        tbody.appendChild(tr);
      });
      
      // Toplam satÄ±rÄ±
      document.getElementById("analizToplamSatir").innerHTML = `
        <strong>Toplam: ${fmt(analizData.toplam)}</strong> | 
        <strong style="color:var(--success)">Ã–denen: ${fmt(analizData.odenen)}</strong> | 
        <strong style="color:var(--danger)">Kalan: ${fmt(analizData.kalan)}</strong>
      `;
      
      // AylÄ±k daÄŸÄ±lÄ±m
      const aylikDagilim = document.getElementById("analizAylikDagilim");
      aylikDagilim.innerHTML = "";
      
      for(let ay = 1; ay <= 12; ay++) {
        const ayData = analizData.aylik[ay];
        const ayAdi = monthsTR[ay - 1] || ay;
        const card = document.createElement('div');
        card.style.cssText = 'background:var(--card); border:1px solid var(--stroke); border-radius:8px; padding:10px; text-align:center';
        card.innerHTML = `
          <div style="font-size:11px; color:var(--muted); font-weight:600; margin-bottom:6px">${ayAdi}</div>
          <div style="font-size:14px; font-weight:700; color:var(--text); margin-bottom:4px">${fmt(ayData.toplam)}</div>
          <div style="font-size:11px; color:var(--success)">Ã–: ${fmt(ayData.odenen)}</div>
          <div style="font-size:11px; color:var(--danger)">K: ${fmt(ayData.kalan)}</div>
        `;
        aylikDagilim.appendChild(card);
      }
      
      document.getElementById("analizDataArea").style.display = "block";
      document.getElementById("analizEmptyState").style.display = "none";
      
      // PDF butonunu gÃ¶ster
      document.getElementById("btnAnalizPDF").style.display = "inline-block";
      
      // Analiz verilerini global deÄŸiÅŸkene kaydet (kategori detay iÃ§in)
      window.currentAnalizData = analizData;
      window.currentAnalizYil = yil;
      window.currentAnalizPersonel = personelAd;
      window.currentAnalizDataArray = data; // snap yerine data array'i sakla
      
      // Kategori seÃ§imi event listener
      const kategoriSelect = document.getElementById("analizKategoriSelect");
      if(kategoriSelect) {
        kategoriSelect.onchange = () => {
          const kategori = kategoriSelect.value;
          if(kategori) {
            loadKategoriDetay(kategori, analizData, yil, data);
          } else {
            document.getElementById("kategoriDetayArea").style.display = "none";
            document.getElementById("kategoriDetayEmpty").style.display = "block";
            if(kategoriChartInstance) {
              kategoriChartInstance.destroy();
              kategoriChartInstance = null;
            }
          }
        };
      }
    } catch(e) {
      console.error(e);
      toast('Analiz verileri yÃ¼klenirken hata.');
    }
  }
  
  // Kategori detay analizi
  function loadKategoriDetay(kategori, analizData, yil, dataArray) {
    try {
      const kategoriLabels = {
        hediye: 'Hediye',
        kira: 'Kira',
        cocuk: 'Ã‡ocuk',
        yol: 'Yol',
        haberlesme: 'HaberleÅŸme',
        ikramiye: 'Ä°kramiye',
        yakacak: 'Yakacak',
        elbise: 'Elbise',
        ssk: 'SSK'
      };
      
      // TÃ¼m kategoriler seÃ§ildiyse
      if(kategori === 'tum') {
        document.getElementById("tekKategoriDetay").style.display = "none";
        document.getElementById("tumKategorilerDetay").style.display = "block";
        
        const tumKategorilerDiv = document.getElementById("tumKategorilerDetay");
        tumKategorilerDiv.innerHTML = "";
        
        // SÄ±ralÄ± kategori listesi (SSK hariÃ§)
        const tumKategoriler = ['hediye', 'kira', 'cocuk', 'yol', 'haberlesme', 'ikramiye', 'yakacak', 'elbise'];
        
        tumKategoriler.forEach((kat, index) => {
          // Her kategori iÃ§in veri topla
          const aylikKategoriData = {};
          for(let ay = 1; ay <= 12; ay++) {
            aylikKategoriData[ay] = { toplam: 0, odenen: 0, kalan: 0 };
          }
          
          dataArray.forEach(d => {
            const ay = d.ay || 1;
            const tutar = +(d[kat] || 0);
            
            if(tutar > 0) {
              aylikKategoriData[ay].toplam += tutar;
              if(d.odemeler?.[kat]) {
                aylikKategoriData[ay].odenen += tutar;
              } else {
                aylikKategoriData[ay].kalan += tutar;
              }
            }
          });
          
          // Toplam hesapla
          let kategoriToplam = 0, kategoriOdenen = 0, kategoriKalan = 0;
          Object.values(aylikKategoriData).forEach(data => {
            kategoriToplam += data.toplam;
            kategoriOdenen += data.odenen;
            kategoriKalan += data.kalan;
          });
          
          const yuzde = kategoriToplam > 0 ? ((kategoriOdenen / kategoriToplam) * 100).toFixed(1) : 0;
          
          // Kategori bÃ¶lÃ¼mÃ¼ oluÅŸtur
          const kategoriSection = document.createElement('div');
          kategoriSection.style.cssText = 'margin-bottom:32px; padding:20px; background:var(--card); border:1px solid var(--stroke); border-radius:12px';
          
          kategoriSection.innerHTML = `
            <h4 style="margin:0 0 16px; font-size:18px; font-weight:700; color:var(--text); border-bottom:2px solid var(--brand); padding-bottom:8px">
              ${kategoriLabels[kat]}
            </h4>
            
            <div style="display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin-bottom:20px">
              <div style="background:linear-gradient(135deg, var(--brand)15, var(--brand2)15); border:1px solid var(--stroke); border-radius:10px; padding:12px">
                <div style="font-size:11px; color:var(--muted); font-weight:600; margin-bottom:6px">Toplam</div>
                <div style="font-size:20px; font-weight:700; color:var(--text)">${fmt(kategoriToplam)}</div>
              </div>
              <div style="background:#dcfce7; border:1px solid #86efac; border-radius:10px; padding:12px">
                <div style="font-size:11px; color:#166534; font-weight:600; margin-bottom:6px">Ã–denen</div>
                <div style="font-size:20px; font-weight:700; color:#166534">${fmt(kategoriOdenen)}</div>
              </div>
              <div style="background:#fee2e2; border:1px solid #fca5a5; border-radius:10px; padding:12px">
                <div style="font-size:11px; color:#991b1b; font-weight:600; margin-bottom:6px">Kalan</div>
                <div style="font-size:20px; font-weight:700; color:#991b1b">${fmt(kategoriKalan)}</div>
              </div>
              <div style="background:var(--pill); border:1px solid var(--stroke); border-radius:10px; padding:12px">
                <div style="font-size:11px; color:var(--muted); font-weight:600; margin-bottom:6px">Ã–deme %</div>
                <div style="font-size:20px; font-weight:700; color:var(--brand)">${yuzde}%</div>
              </div>
            </div>
            
            <div class="tablo-kart" style="padding:0">
              <table>
                <thead>
                  <tr>
                    <th style="text-align:left; padding-left:16px">Ay</th>
                    <th>Toplam</th>
                    <th>Ã–denen</th>
                    <th>Kalan</th>
                    <th>Durum</th>
                  </tr>
                </thead>
                <tbody id="kategoriDetayTableBody_${kat}"></tbody>
              </table>
            </div>
          `;
          
          tumKategorilerDiv.appendChild(kategoriSection);
          
          // AylÄ±k detay tablosu
          const tbody = document.getElementById(`kategoriDetayTableBody_${kat}`);
          for(let ay = 1; ay <= 12; ay++) {
            const ayData = aylikKategoriData[ay];
            const ayAdi = monthsTR[ay - 1] || ay;
            const tr = document.createElement('tr');
            
            let durumHTML = '';
            if(ayData.toplam === 0) {
              durumHTML = '<span class="muted" style="opacity:0.5">â€”</span>';
            } else if(ayData.kalan === 0) {
              durumHTML = '<span class="chip ok">TamamlandÄ±</span>';
            } else if(ayData.odenen === 0) {
              durumHTML = '<span class="chip no">Ã–denmedi</span>';
            } else {
              const durumYuzde = ((ayData.odenen / ayData.toplam) * 100).toFixed(0);
              durumHTML = `<span style="color:var(--warn); font-weight:600">%${durumYuzde}</span>`;
            }
            
            tr.innerHTML = `
              <td style="text-align:left; padding-left:16px; font-weight:600">${ayAdi}</td>
              <td style="text-align:center; font-weight:600">${fmt(ayData.toplam)}</td>
              <td style="text-align:center; color:var(--success); font-weight:600">${fmt(ayData.odenen)}</td>
              <td style="text-align:center; color:var(--danger); font-weight:600">${fmt(ayData.kalan)}</td>
              <td style="text-align:center">${durumHTML}</td>
            `;
            tbody.appendChild(tr);
          }
        });
        
        document.getElementById("kategoriDetayArea").style.display = "block";
        document.getElementById("kategoriDetayEmpty").style.display = "none";
        return;
      }
      
      // Tek kategori seÃ§ildiyse (eski kod)
      document.getElementById("tekKategoriDetay").style.display = "block";
      document.getElementById("tumKategorilerDetay").style.display = "none";
      
      // AylÄ±k kategori verilerini topla
      const aylikKategoriData = {};
      for(let ay = 1; ay <= 12; ay++) {
        aylikKategoriData[ay] = { toplam: 0, odenen: 0, kalan: 0 };
      }
      
      dataArray.forEach(d => {
        const ay = d.ay || 1;
        const tutar = +(d[kategori] || 0);
        
        if(tutar > 0) {
          aylikKategoriData[ay].toplam += tutar;
          if(d.odemeler?.[kategori]) {
            aylikKategoriData[ay].odenen += tutar;
          } else {
            aylikKategoriData[ay].kalan += tutar;
          }
        }
      });
      
      // Toplam hesapla
      let kategoriToplam = 0, kategoriOdenen = 0, kategoriKalan = 0;
      Object.values(aylikKategoriData).forEach(data => {
        kategoriToplam += data.toplam;
        kategoriOdenen += data.odenen;
        kategoriKalan += data.kalan;
      });
      
      // Ã–zet kartlarÄ± gÃ¼ncelle
      document.getElementById("kategoriToplam").textContent = fmt(kategoriToplam);
      document.getElementById("kategoriOdenen").textContent = fmt(kategoriOdenen);
      document.getElementById("kategoriKalan").textContent = fmt(kategoriKalan);
      const yuzde = kategoriToplam > 0 ? ((kategoriOdenen / kategoriToplam) * 100).toFixed(1) : 0;
      document.getElementById("kategoriYuzde").textContent = `${yuzde}%`;
      
      // Grafik oluÅŸtur
      const ctx = document.getElementById("kategoriChart");
      if(ctx) {
        if(kategoriChartInstance) {
          kategoriChartInstance.destroy();
        }
        
        const ayLabels = monthsTR;
        const toplamData = [];
        const odenenData = [];
        const kalanData = [];
        
        for(let ay = 1; ay <= 12; ay++) {
          toplamData.push(aylikKategoriData[ay].toplam);
          odenenData.push(aylikKategoriData[ay].odenen);
          kalanData.push(aylikKategoriData[ay].kalan);
        }
        
        kategoriChartInstance = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ayLabels,
            datasets: [
              {
                label: 'Toplam',
                data: toplamData,
                backgroundColor: 'rgba(100, 116, 139, 0.3)',
                borderColor: 'rgb(100, 116, 139)',
                borderWidth: 1
              },
              {
                label: 'Ã–denen',
                data: odenenData,
                backgroundColor: 'rgba(34, 197, 94, 0.5)',
                borderColor: 'rgb(34, 197, 94)',
                borderWidth: 1
              },
              {
                label: 'Kalan',
                data: kalanData,
                backgroundColor: 'rgba(239, 68, 68, 0.5)',
                borderColor: 'rgb(239, 68, 68)',
                borderWidth: 1
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                display: true,
                position: 'top'
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return context.dataset.label + ': ' + fmt(context.parsed.y);
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function(value) {
                    if(value >= 1000) {
                      return (value / 1000).toFixed(1) + 'K â‚º';
                    }
                    return value + ' â‚º';
                  }
                }
              }
            }
          }
        });
      }
      
      // AylÄ±k detay tablosu
      const tbody = document.getElementById("kategoriDetayTableBody");
      tbody.innerHTML = "";
      
      for(let ay = 1; ay <= 12; ay++) {
        const ayData = aylikKategoriData[ay];
        const ayAdi = monthsTR[ay - 1] || ay;
        const tr = document.createElement('tr');
        
        let durumHTML = '';
        if(ayData.toplam === 0) {
          durumHTML = '<span class="muted" style="opacity:0.5">â€”</span>';
        } else if(ayData.kalan === 0) {
          durumHTML = '<span class="chip ok">TamamlandÄ±</span>';
        } else if(ayData.odenen === 0) {
          durumHTML = '<span class="chip no">Ã–denmedi</span>';
        } else {
          const durumYuzde = ((ayData.odenen / ayData.toplam) * 100).toFixed(0);
          durumHTML = `<span style="color:var(--warn); font-weight:600">%${durumYuzde}</span>`;
        }
        
        tr.innerHTML = `
          <td style="text-align:left; padding-left:16px; font-weight:600">${ayAdi}</td>
          <td style="text-align:center; font-weight:600">${fmt(ayData.toplam)}</td>
          <td style="text-align:center; color:var(--success); font-weight:600">${fmt(ayData.odenen)}</td>
          <td style="text-align:center; color:var(--danger); font-weight:600">${fmt(ayData.kalan)}</td>
          <td style="text-align:center">${durumHTML}</td>
        `;
        tbody.appendChild(tr);
      }
      
      document.getElementById("kategoriDetayArea").style.display = "block";
      document.getElementById("kategoriDetayEmpty").style.display = "none";
    } catch(e) {
      console.error(e);
      toast('Kategori detay analizi yÃ¼klenirken hata.');
    }
  }

  // Bildirimler ortak.js'den geliyor, burada yapmaya gerek yok

  // Yetkili kullanÄ±cÄ± kontrolÃ¼ ve UI gÃ¼ncelleme
  function updateAdminUI(isAdmin) {
    IS_ADMIN = isAdmin;
    
    // ButonlarÄ± gÃ¶ster/gizle
    const btnAdd = document.getElementById("btnAdd");
    const btnCopy = document.getElementById("btnCopy");
    const btnBulkManage = document.getElementById("btnBulkManage");
    const btnPersonelManage = document.getElementById("btnPersonelManage");
    
    if(btnAdd) btnAdd.style.display = isAdmin ? "inline-block" : "none";
    if(btnCopy) btnCopy.style.display = isAdmin ? "inline-block" : "none";
    if(btnBulkManage) btnBulkManage.style.display = isAdmin ? "inline-block" : "none";
    if(btnPersonelManage) btnPersonelManage.style.display = isAdmin ? "inline-block" : "none";
    
    // Tablo satÄ±rlarÄ±na tÄ±klama - sadece admin iÃ§in aktif
    // renderTableAndSummary iÃ§inde de kontrol ediliyor, burada sadece mevcut satÄ±rlarÄ± gÃ¼ncelle
    const tbody = document.getElementById("listeAlani");
    if(tbody) {
      tbody.querySelectorAll('tr').forEach(tr => {
        if(isAdmin) {
          tr.style.cursor = "pointer";
        } else {
          tr.style.cursor = "default";
          tr.onclick = null;
        }
      });
    }
    
    // Mobil kartlara tÄ±klama - sadece admin iÃ§in aktif
    const mobileCards = document.getElementById("mobileCards");
    if(mobileCards) {
      mobileCards.querySelectorAll('.person-card').forEach(card => {
        if(isAdmin) {
          card.style.cursor = "pointer";
        } else {
          card.style.cursor = "default";
          card.onclick = null;
        }
      });
    }
  }

  // Auth + yetki - ortak.js'den initAppShellAuth kullanÄ±lÄ±yor
  // Sayfa Ã¶zel init fonksiyonu
  window.initPage = async function() {
    try {
      const sb = getSupabase();
      if (!sb) {
        console.error('Supabase client bulunamadÄ±');
        toast('VeritabanÄ± baÄŸlantÄ±sÄ± kurulamadÄ±. SayfayÄ± yenileyin.');
        return;
      }

      const { data: { user }, error: authError } = await sb.auth.getUser();
      
      if (authError) {
        console.error('Auth hatasÄ±:', authError);
        toast('KullanÄ±cÄ± doÄŸrulamasÄ± yapÄ±lamadÄ±. LÃ¼tfen tekrar giriÅŸ yapÄ±n.');
        return;
      }

      if(!user) {
        console.warn('KullanÄ±cÄ± bulunamadÄ±');
        return;
      }
      
      // Email kontrolÃ¼ - sadece samettckrr@gmail.com yetkili
      const userEmail = user.email || '';
      const isAdmin = userEmail.toLowerCase() === 'samettckrr@gmail.com';
      IS_ADMIN = isAdmin;
      updateAdminUI(isAdmin);
      
      console.log('KullanÄ±cÄ±:', userEmail, 'Admin:', isAdmin);
      await listele();
    } catch(e) { 
      console.error('initPage hatasÄ±:', e); 
      toast(`Sayfa yÃ¼klenirken hata: ${e.message || 'Bilinmeyen hata'}`); 
    }
  };
    }); // waitForSupabaseAndOrtak callback kapanÄ±ÅŸÄ±
  }); // DOMContentLoaded kapanÄ±ÅŸÄ±
</script>
</body>
</html>
