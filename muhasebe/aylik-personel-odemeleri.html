<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Personel Ödeme Takibi</title>
<link rel="icon" type="image/png" href="../img/logo.png" />

<style>
  :root{
    --appbar-h:56px;
    --radius:14px; --shadow:0 12px 28px rgba(0,0,0,.14);
    --bg:#0f172a; --bg2:#0b1324;
    --grad1:#0ea5e922; --grad2:#22d3ee22;
    --card:rgba(15,23,42,.92); --stroke:rgba(148,163,184,.18);
    --text:#e5e7eb; --muted:#9aa4b2;
    --brand:#38bdf8; --brand2:#0ea5e9;
    --pill:#0b1220; --pill-hover:#101a2b; --surface:rgba(2,6,23,.08);
    --danger:#ef4444; --success:#22c55e;
  }
  @media (prefers-color-scheme: light){
    :root{
      --bg:#eef6ff; --bg2:#f7fbff; --grad1:#38bdf822; --grad2:#22d3ee22;
      --card:rgba(255,255,255,.96); --stroke:rgba(15,23,42,.12);
      --text:#0b1220; --muted:#4b5563; --brand:#0ea5e9; --brand2:#0284c7;
      --pill:#f5f8ff; --pill-hover:#e9f2ff; --surface:#eef3ff;
      --danger:#b91c1c; --success:#16a34a;
    }
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;padding:0;font-family:'Segoe UI',system-ui,-apple-system,Arial,sans-serif;background:var(--bg);color:var(--text)}
  a{color:#c7e9ff; text-decoration:none}
  a:hover{text-decoration:underline}

  /* APPBAR */
  .appbar{
    position:sticky; top:0; z-index:60; height:var(--appbar-h);
    background:var(--card); backdrop-filter:blur(10px);
    border-bottom:1px solid var(--stroke);
    display:flex; align-items:center; gap:10px; padding:0 12px;
  }
  .brand{display:flex; align-items:center; gap:10px; cursor:pointer}
  .brand img{width:24px; height:24px}
  .brand span{font-weight:900; letter-spacing:.02em}
  .nav-center{margin:0 auto; height:100%}
  .nav-list{display:flex; gap:22px; align-items:center; height:100%; list-style:none; margin:0; padding:0}
  .nav-item{position:relative; height:100%}
  .nav-btn{height:100%; display:flex; align-items:center; gap:6px; font-weight:800; cursor:pointer}
  .nav-btn:hover{color:var(--brand)}
  .caret{font-size:12px; opacity:.6}
  .dropdown{position:absolute; top:100%; left:0; min-width:240px; background:var(--card); border:1px solid var(--stroke); border-radius:10px; box-shadow:var(--shadow); padding:8px; display:none}
  .dropdown a{display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:8px; color:var(--text); text-decoration:none}
  .dropdown a:hover{background:var(--surface)}
  .nav-item.open .dropdown{display:block}
  .nav-right{display:flex; gap:8px; align-items:center}
  .btn{border:1px solid var(--stroke); background:var(--card); color:var(--text); border-radius:999px; padding:8px 12px; cursor:pointer; white-space:nowrap}
  .hamb{display:none}
  .iconbtn{position:relative; border:1px solid var(--stroke); background:var(--card); color:var(--text); border-radius:999px; padding:8px 12px; cursor:pointer; display:flex; align-items:center; gap:8px}
  .badge{position:absolute; top:-6px; right:-6px; background:var(--danger); color:#fff; font-size:11px; padding:2px 6px; border-radius:999px; border:2px solid var(--card)}
  .drop-right{left:auto; right:0}
  .avatar{width:22px;height:22px;border-radius:999px;background:linear-gradient(180deg,#94a3b8,#64748b)}
  @media (max-width: 960px){ .nav-center{display:none} .hamb{display:inline-flex} }

  /* Drawer */
  .drawer{position:fixed; top:var(--appbar-h); right:0; bottom:0; left:30%; transform:translateX(100%); transition:.25s; background:var(--card); border-left:1px solid var(--stroke); z-index:70; overflow:auto; padding:12px}
  .drawer.open{transform:translateX(0)}
  .drawer .panel-title{margin:14px 4px 6px; font-weight:800; color:var(--muted); font-size:13px}
  .drawer a{display:block; padding:10px; border-radius:10px; border:1px solid var(--stroke); margin:6px 0; color:var(--text); background:var(--pill)}
  .drawer a:hover{background:var(--pill-hover)}

  /* CONTENT */
  .container{max-width:1200px; margin:0 auto; padding:16px}
  .card{background:var(--card); border:1px solid var(--stroke); border-radius:14px; box-shadow:var(--shadow); padding:14px}
  .muted{color:var(--muted)}

  /* Header Card */
  .header-card{display:flex; justify-content:space-between; align-items:center; gap:16px; margin:16px 0}
  .header-left h2{margin:0 0 6px; font-size:18px}
  .primary-actions{display:flex; gap:10px; flex-wrap:wrap}
  .cta{border:1px solid var(--stroke); background:linear-gradient(180deg,var(--brand),var(--brand2)); color:#fff; border-radius:999px; padding:10px 16px; cursor:pointer; font-weight:800; white-space:nowrap}
  .btn-ghost{border:1px solid var(--stroke); background:var(--pill); border-radius:999px; padding:10px 14px; cursor:pointer; white-space:nowrap}

  /* Filters Card */
  .filters-card{margin:10px 0 14px}
  .controls-grid{
    display:grid; grid-template-columns:repeat(12,minmax(0,1fr)); gap:10px; align-items:center;
  }
  .ctrl{grid-column:span 3; display:flex; align-items:center; gap:10px; padding:6px 10px; border:1px solid var(--stroke); background:var(--pill); border-radius:999px; height:40px; min-width:0}
  .ctrl span{white-space:nowrap}
  .ctrl select{appearance:none; background:transparent; color:var(--text); border:none; outline:none; font-weight:700; height:26px; line-height:26px; width:100%}
  .ctrl input{background:transparent; border:none; outline:none; color:var(--text); font-weight:600; width:100%}
  .ctrl.wide{grid-column:span 6}

  @media (max-width: 960px){
    .nav-center{display:none}
    .hamb{display:inline-flex}
    .controls-grid{grid-template-columns:repeat(6,minmax(0,1fr))}
    .ctrl{grid-column:span 3}
    .ctrl.wide{grid-column:span 6}
  }

  /* Tables */
  .tablo-kart{background:var(--card); border:1px solid var(--stroke); border-radius:12px; box-shadow:var(--shadow); padding:10px 12px; overflow:auto}
  table{width:100%; border-collapse:collapse; min-width:880px}
  th,td{padding:10px 12px; text-align:center; border-bottom:1px solid var(--stroke); font-size:14px}
  thead th{position:sticky; top:0; background:var(--pill); z-index:1}
  tbody tr:hover{background:var(--surface)}
  .chip{border-radius:999px; padding:4px 10px; font-weight:700; font-size:12px; display:inline-block}
  .chip.ok{background:rgba(34,197,94,.16); color:var(--success); border:1px solid rgba(34,197,94,.28)}
  .chip.no{background:rgba(239,68,68,.16); color:var(--danger); border:1px solid rgba(239,68,68,.28)}

  /* Modals & Toast */
  .modal{display:none; position:fixed; inset:0; background:rgba(2,6,23,.6); z-index:99; align-items:center; justify-content:center; padding:16px}
  .modal-content{background:var(--card); border:1px solid var(--stroke); width:95%; max-width:640px; border-radius:16px; box-shadow:var(--shadow); padding:16px}
  .modal-content h3{margin:0 0 10px; text-align:center}
  .modal-content label{display:block; margin-top:8px; font-size:13px; color:var(--muted)}
  .modal-content input{width:100%; padding:10px 12px; border:1px solid var(--stroke); border-radius:10px; background:var(--pill); color:var(--text); margin-top:4px}

  /* Modal ve Bulk içindeki selectler: sade beyaz */
  .modal-content select{
    width:100%;
    border:1px solid #d1d5db;
    border-radius:12px;
    background:#fff url("data:image/svg+xml,%3Csvg width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E") no-repeat right 10px center;
    background-size:16px;
    padding:8px 36px 8px 12px;
    color:#111827;
    font-weight:600;
    box-shadow:0 1px 2px rgba(0,0,0,.05) inset;
    outline:none;
  }
  .modal-content select:hover{ border-color:#0ea5e9; }
  .modal-content select:focus{ border-color:#0ea5e9; box-shadow:0 0 0 3px rgba(14,165,233,.25); }

  .modal-buttons{display:flex; justify-content:flex-end; gap:8px; margin-top:14px}
  .btn-danger{border:1px solid #ef444422; background:#ef4444; color:#fff; border-radius:10px; padding:8px 12px; cursor:pointer}
  .toast{position:fixed; left:50%; bottom:24px; transform:translateX(-50%) translateY(20px); background:rgba(2,6,23,.95); color:#fff; border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:10px 12px; opacity:0; pointer-events:none; transition:opacity .25s, transform .25s; z-index:200}
  .toast.show{opacity:1; transform:translateX(-50%) translateY(0)}

  /* === Toplu toolbar: beyaz kart + pastel butonlar === */
  .bulk-toolbar{
    display:grid;
    grid-template-columns: 1fr auto auto; /* kategori | ödendi | ödenmedi */
    gap:10px; align-items:center; margin-top:10px;
    background:#fff; border:1px solid var(--stroke);
    border-radius:14px; padding:10px 14px;
    box-shadow:0 2px 6px rgba(0,0,0,.04);
  }
  .bulk-select{ display:flex; align-items:center; gap:10px; min-width:0 }
  .bulk-select span{ white-space:nowrap; font-weight:600; color:#111827 }
  .bulk-select select{
    appearance:none; border:1px solid #d1d5db; border-radius:8px;
    background:#fff url("data:image/svg+xml,%3Csvg width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E") no-repeat right 10px center;
    background-size:16px;
    padding:6px 34px 6px 10px; font-size:14px; font-weight:600; color:#111827;
    box-shadow:0 1px 2px rgba(0,0,0,.05) inset; outline:none; min-width:140px;
  }
  .bulk-select select:hover{ border-color:#0ea5e9 }
  .bulk-select select:focus{ border-color:#0ea5e9; box-shadow:0 0 0 3px rgba(14,165,233,.25) }

  .bulk-buttons{ display:flex; gap:8px; justify-content:flex-end }
  .pill-btn{
    border-radius:999px; padding:6px 16px; font-weight:600; font-size:14px; cursor:pointer;
    border:1px solid transparent; transition:background .2s, color .2s, border .2s;
  }
  .pill-btn.ok{ background:#dcfce7; color:#166534; border-color:#22c55e33 }
  .pill-btn.no{ background:#fee2e2; color:#991b1b; border-color:#ef444433 }
  .pill-btn.ok:hover{ background:#bbf7d0 }
  .pill-btn.no:hover{ background:#fecaca }

  /* Mobile: kategori üstte, butonlar altta yan yana */
  @media (max-width: 768px){
    .bulk-toolbar{ grid-template-columns:1fr; }
    .bulk-buttons{ justify-content:flex-start; }
  }
</style>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="../js/firebase/firebase-init.js"></script>
</head>
<body>

<!-- APPBAR -->
<div class="appbar">
  <div class="brand" onclick="location.href='../panel.html'">
    <img src="../img/logo.png" alt="logo"><span>KARAAĞAÇ FATİH</span>
  </div>

  <nav class="nav-center"><ul class="nav-list" id="navMain"></ul></nav>

  <div class="nav-right">
    <button class="btn hamb" id="hamburger" title="Menü">☰</button>

    <div class="nav-item">
      <button class="iconbtn" id="btnNotif" title="Bildirimler">🔔
        <span class="badge" id="notifBadge" style="display:none">0</span>
      </button>
      <div class="dropdown drop-right" id="notifDropdown">
        <div class="muted" style="padding:6px 8px">Son bildirimler</div>
        <div id="notifList" style="max-height:300px;overflow:auto"></div>
        <a href="/diger/bildirim.html">Tüm bildirimleri gör →</a>
      </div>
    </div>

    <div class="nav-item">
      <button class="iconbtn" id="btnProfile" title="Profil">
        <span class="avatar"></span> <span id="profName" class="muted">Profil</span>
      </button>
      <div class="dropdown drop-right" id="profDropdown">
        <a href="/diger/kullanici-yonetimi.html" >👤 Profil</a>
        <a href="/diger/sistem-ayarlari.html" >⚙️ Ayarlar</a>
        <a href="#" id="btnLogout">🚪 Çıkış Yap</a>
      </div>
    </div>
  </div>
</div>

<aside class="drawer" id="drawer"></aside>

<main class="container">

  <!-- HEADER CARD -->
  <section class="card header-card">
    <div class="header-left">
      <h2>Personel Ödeme Takibi</h2>
      <div class="muted">Bugün: <span id="todayText">—</span></div>
    </div>
  </section>

  <section class="card header-card">
    <div class="primary-actions">
      <button class="cta" id="btnAdd">+ Personel Tahakkuk</button>
      <button class="btn-ghost" id="btnCopy">⟳ Tahakkuk Kopyala</button>
    </div>
  </section>

  <!-- FILTERS / BULK CARD -->
  <section class="card filters-card">
    <div class="controls-grid">
      <div class="ctrl"><span>Ay</span><select id="aySec"></select></div>
      <div class="ctrl"><span>Yıl</span><select id="yilSec"></select></div>

      <div class="ctrl wide">🔎 <input id="searchInput" type="text" placeholder="İsim ara…"></div>
  </section>

  <section class="card filters-card">
    <!-- YENİ: 3’lü responsive toolbar -->
    <div class="bulk-toolbar" role="group" aria-label="Toplu işlem">
      <div class="bulk-select">
        <span>Toplu Kategori</span>
        <select id="bulkKategori">
          <option value="hediye">Hediye</option>
          <option value="kira">Kira</option>
          <option value="cocuk">Çocuk</option>
          <option value="ssk">SSK</option>
          <option value="yol">Yol</option>
          <option value="haberlesme">Haberleşme</option>
          <option value="maas">Resmî Maaş</option>
        </select>
      </div>

      <div class="bulk-buttons">
        <button class="pill-btn ok" id="btnBulkOk">Toplu: Ödendi</button>
        <button class="pill-btn no" id="btnBulkNo">Toplu: Ödenmedi</button>
      </div>
    </div>

    </div>
    <div class="muted" style="margin-top:8px;font-size:13px">
      Hücre renkleri: <span class="chip ok">Ödendi</span> / <span class="chip no">Ödenmedi</span>   • Toplu işaretleme, arama filtresi + seçili ay/yıl kapsamındadır.
    </div>
  </section>

  <!-- TABLE -->
  <section class="tablo-kart">
    <table>
      <thead>
        <tr>
          <th style="text-align:left">Ad</th>
          <th>Hediye</th><th>Kira</th><th>Çocuk</th><th>SSK</th><th>Yol</th><th>Haberleşme</th>
          <th>Resmî Maaş</th><th>Toplam</th>
        </tr>
      </thead>
      <tbody id="listeAlani"></tbody>
    </table>
  </section>

  <!-- SUMMARY -->
  <section class="card" style="margin:16px 0 8px">
    <h3>Kategori Toplamları</h3>
    <div class="tablo-kart" style="padding:0">
      <table>
        <thead>
          <tr><th>Kategori</th><th>Toplam</th><th>Ödenen</th><th>Kalan</th></tr>
        </thead>
        <tbody id="ozetAlani"></tbody>
        <tfoot>
          <tr><td colspan="4" style="text-align:right;padding:12px 16px">Kalan Toplam: <span id="kalanToplamGoster">0 ₺</span></td></tr>
        </tfoot>
      </table>
    </div>
  </section>

  <div style="height:120px"></div>
</main>

<!-- MODALS -->
<div class="modal" id="ekleModal">
  <div class="modal-content">
    <h3>Yeni Personel Tahakkuk</h3>
    <label>Ad Soyad</label><input id="adInput" type="text" placeholder="Örn: Samet ÇAKIR">
    <div style="display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px">
      <div><label>Ay</label><select id="ayInput"></select></div>
      <div><label>Yıl</label><select id="yilInput"></select></div>
    </div>
    <div style="display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px">
      <div><label>Hediye</label><input id="hediyeInput" type="number" value="0" min="0" step="0.01"></div>
      <div><label>Kira</label><input id="kiraInput" type="number" value="0" min="0" step="0.01"></div>
      <div><label>Çocuk</label><input id="cocukInput" type="number" value="0" min="0" step="0.01"></div>
      <div><label>SSK</label><input id="sskInput" type="number" value="0" min="0" step="0.01"></div>
      <div><label>Yol</label><input id="yolInput" type="number" value="0" min="0" step="0.01"></div>
      <div><label>Haberleşme</label><input id="haberInput" type="number" value="0" min="0" step="0.01"></div>
    </div>
    <div class="modal-buttons">
      <button class="btn-ghost" onclick="closeModals()">İptal</button>
      <button class="cta" onclick="kaydetEkle()">Kaydet</button>
    </div>
  </div>
</div>

<div class="modal" id="odemeModal">
  <div class="modal-content">
    <h3 id="odemeModalBaslik">Ödeme Durumu</h3>
    <div id="odemeKategoriAlani"></div>
    <div class="modal-buttons">
      <button class="btn-ghost" onclick="closeModals()">Kapat</button>
      <button class="btn-danger" onclick="silVeri()">Sil</button>
      <button class="cta" onclick="kaydetOdeme()">Kaydet</button>
    </div>
  </div>
</div>

<div class="modal" id="copyModal">
  <div class="modal-content">
    <h3>Tahakkuk Kopyala</h3>
    <div style="display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px">
      <div><label>Kaynak Ay</label><select id="srcAy"></select></div>
      <div><label>Kaynak Yıl</label><select id="srcYil"></select></div>
      <div><label>Hedef Ay</label><select id="dstAy"></select></div>
      <div><label>Hedef Yıl</label><select id="dstYil"></select></div>
    </div>
    <label style="margin-top:10px"><input type="checkbox" id="overwriteChk"> Var olan kayıtlar üzerine yaz</label>
    <div class="card" style="margin-top:10px">
      <div class="muted" style="margin-bottom:8px">Kaynak önizleme:</div>
      <div class="tablo-kart" style="padding:0; max-height:220px; overflow:auto">
        <table>
          <thead><tr><th style="text-align:left">Ad</th><th>Toplam</th><th>Ödenen Alan Sayısı</th></tr></thead>
          <tbody id="copyPreviewBody"></tbody>
        </table>
      </div>
    </div>
    <div class="modal-buttons">
      <button class="btn-ghost" onclick="closeModals()">Kapat</button>
      <button class="cta" id="btnDoCopy">Kopyala</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  /* Tema + Tarih */
  (function(){
    const root=document.documentElement, saved=localStorage.getItem('kf_theme')||'auto';
    function apply(mode){
      localStorage.setItem('kf_theme',mode);
      const sysDark=()=>window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches;
      const eff=(mode==='auto')?(sysDark()?'dark':'light'):mode;
      root.setAttribute('data-theme',eff);
    }
    apply(saved);
    if(window.matchMedia){
      const m=window.matchMedia('(prefers-color-scheme: dark)');
      m.addEventListener?.('change',()=>{ if((localStorage.getItem('kf_theme')||'auto')==='auto') apply('auto'); });
    }
    const d=new Date(); const days=['Pazar','Pazartesi','Salı','Çarşamba','Perşembe','Cuma','Cumartesi'];
    document.getElementById('todayText').textContent=`${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()} • ${days[d.getDay()]}`;
  })();

  /* Firebase & helpers */
  const db=firebase.firestore(), auth=firebase.auth();
  const monthsTR=["Ocak","Şubat","Mart","Nisan","Mayıs","Haziran","Temmuz","Ağustos","Eylül","Ekim","Kasım","Aralık"];
  const fmt=(n)=> (Number(n||0)).toLocaleString("tr-TR",{minimumFractionDigits:2, maximumFractionDigits:2}) + " ₺";
  const norm = (s) => String(s||'')
  .normalize('NFD').replace(/[\u0300-\u036f]/g,'') // diakritik temizle
  .toLowerCase().trim();
  function toast(msg){const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); clearTimeout(window.__to); window.__to=setTimeout(()=>t.classList.remove('show'),2500);}
  function closeModals(){['ekleModal','odemeModal','copyModal'].forEach(id=>{const el=document.getElementById(id); if(el) el.style.display='none';});}

  function normalizeUrl(u){
  if(!u) return '#';
  if(/^https?:\/\//i.test(u)) return u;      // tam URL ise dokunma
  if(u.startsWith('/')) return u;            // zaten root-relative
  return '/'+u.replace(/^\.?\//,'');         // başına / koy
}

  /* Menü (manifest – linki olduğu gibi kullan) */
  let CURRENT_ALLOW=new Set(), CURRENT_DENY=new Set();
  async function fetchPanels(allowSet, denySet){
    const res=[];
    try{
      const snap=await db.collection('sayfa_manifesti').get();
      snap.forEach(doc=>{
        const d=doc.data()||{}, id=doc.id, panelTitle=d.title||id;
        const panelGrant = allowSet.has(norm(id)) || allowSet.has(norm(panelTitle));
        let pages = Array.isArray(d.pages)? d.pages : [];
        pages = pages.filter(pg=>{
          const keyNorm=norm(pg.key||pg.title||'');
          const pageGrant=allowSet.has(keyNorm), denied=denySet.has(keyNorm);
          return !denied && (panelGrant || pageGrant);
        }).map(pg=>({ baslik: pg.title||pg.key||'Sayfa', url: pg.path||'#', key: pg.key||pg.title||'', sira: typeof pg.order==='number'? pg.order:9999 }))
          .sort((a,b)=>a.sira-b.sira);
        if(pages.length) res.push({ id, baslik:panelTitle, sira: typeof d.order==='number'? d.order:9999, pages });
      });
      res.sort((a,b)=>a.sira-b.sira);
    }catch(e){ console.error(e); toast('Menü manifesti yüklenemedi.'); }
    return res;
  }
  function renderNav(panels){
    const ul=document.getElementById('navMain'), drawer=document.getElementById('drawer');
    ul.innerHTML=''; drawer.innerHTML='';
    if(!panels.length){
      ul.innerHTML='<li class="nav-item"><div class="nav-btn">Hiç panel yok</div></li>';
      drawer.innerHTML='<div style="color:var(--muted);padding:8px">Hiç panel bulunamadı</div>';
      return;
    }
    panels.forEach(p=>{
      const li=document.createElement('li'); li.className='nav-item';
      li.innerHTML=`<div class="nav-btn">${p.baslik} <span class="caret">▾</span></div>`;
      const dd=document.createElement('div'); dd.className='dropdown';
      (p.pages||[]).forEach(pg=>{
        const a=document.createElement('a');
        const url = normalizeUrl(pg.url || pg.path || '#');
        a.href = url;
        a.textContent = pg.baslik;
        a.dataset.key=pg.key||pg.baslik; a.dataset.panel=p.id; a.dataset.panelTitle=p.baslik;
        dd.appendChild(a);
      });
      li.appendChild(dd);
      li.querySelector('.nav-btn').addEventListener('click',(e)=>{
        e.stopPropagation();
        ul.querySelectorAll('.nav-item').forEach(x=>{ if(x!==li) x.classList.remove('open'); });
        li.classList.toggle('open');
      });
      ul.appendChild(li);

      // drawer
      const h=document.createElement('div'); h.className='panel-title'; h.textContent=p.baslik; drawer.appendChild(h);
      (p.pages||[]).forEach(pg=>{
        const a=document.createElement('a');
        const url = normalizeUrl(pg.url || pg.path || '#');
        a.href = url;
        a.textContent = pg.baslik;
        a.dataset.key=pg.key||pg.baslik; a.dataset.panel=p.id; a.dataset.panelTitle=p.baslik;
        drawer.appendChild(a);
      });
    });
    document.addEventListener('click',(e)=>{ if(!ul.contains(e.target)) ul.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('open')); });
  }
  (function(){ const hamb=document.getElementById('hamburger'), drawer=document.getElementById('drawer'); if(!hamb) return; hamb.addEventListener('click',()=>drawer.classList.toggle('open')); document.addEventListener('click',(e)=>{ if(!drawer.contains(e.target) && !hamb.contains(e.target)) drawer.classList.remove('open'); }); })();

  // Link guard
  document.addEventListener('click',(e)=>{
    const a=e.target.closest('a[data-key]'); if(!a) return;
    const key=norm(a.dataset.key), pnl=norm(a.dataset.panel||''), pnlTitle=norm(a.dataset.panelTitle||'');
    if(CURRENT_DENY.has(key)){ e.preventDefault(); toast('Bu sayfa için yetkiniz yok.'); return; }
    const allowed = CURRENT_ALLOW.has(key) || CURRENT_ALLOW.has(pnl) || CURRENT_ALLOW.has(pnlTitle);
    if(!allowed){ e.preventDefault(); toast('Bu sayfa için yetkiniz yok.'); }
  });

  // Bildirim/Profil dropdown
  (function(){
    const notifBtn=document.getElementById('btnNotif'), notifDD=document.getElementById('notifDropdown');
    const profBtn=document.getElementById('btnProfile'), profDD=document.getElementById('profDropdown');
    function closeAll(e){
      if(!notifDD.contains(e.target) && e.target!==notifBtn) notifDD.parentElement.classList.remove('open');
      if(!profDD.contains(e.target)  && e.target!==profBtn)  profDD.parentElement.classList.remove('open');
    }
    document.addEventListener('click', closeAll);
    notifBtn?.addEventListener('click',(e)=>{ e.stopPropagation(); notifDD.parentElement.classList.toggle('open'); profDD.parentElement.classList.remove('open'); });
    profBtn ?.addEventListener('click',(e)=>{ e.stopPropagation(); profDD.parentElement.classList.toggle('open'); notifDD.parentElement.classList.remove('open'); });
document.getElementById('btnLogout')?.addEventListener('click', async (e) => {
  e.preventDefault();
  try {
    await auth.signOut();
    location.assign('/index.html');   // kökten yönlendir
  } catch (err) {
    console.error(err);
    toast('Çıkış yapılamadı');
  }
});
  })();

  /* ===== Sayfa verileri ===== */
  let CACHE_ROWS = [];   // Seçili Ay/Yıl’ın tamamı (tek sorgu)
  let LAST_ROWS  = [];   // Arama filtresi sonrası ekranda görünen

  const aktifKoleksiyon="personel_odeme";
  const aySec=document.getElementById("aySec"), yilSec=document.getElementById("yilSec");
  const searchInput=document.getElementById("searchInput");
  const bulkKategori=document.getElementById("bulkKategori");
  const btnBulkOk=document.getElementById("btnBulkOk"), btnBulkNo=document.getElementById("btnBulkNo");
  const btnAdd=document.getElementById("btnAdd"), btnCopy=document.getElementById("btnCopy");

  // Select doldurma
  (function(){
    const bugun=new Date(), sy=bugun.getFullYear()-3, ey=bugun.getFullYear()+5;
    monthsTR.forEach((m,i)=> aySec.add(new Option(m,i+1)));
    for(let y=sy;y<=ey;y++) yilSec.add(new Option(y,y));
    aySec.value=bugun.getMonth()+1; yilSec.value=bugun.getFullYear();
  })();

  // Ekle modal selectleri + copy modal selectleri
  const ayInput=document.getElementById("ayInput"), yilInput=document.getElementById("yilInput");
  const srcAy=document.getElementById("srcAy"), srcYil=document.getElementById("srcYil");
  const dstAy=document.getElementById("dstAy"), dstYil=document.getElementById("dstYil");
  (function(){
    const bugun=new Date(), sy=bugun.getFullYear()-3, ey=bugun.getFullYear()+5;
    monthsTR.forEach((m,i)=>{ ayInput.add(new Option(m,i+1)); srcAy.add(new Option(m,i+1)); dstAy.add(new Option(m,i+1)); });
    for(let y=sy;y<=ey;y++){ yilInput.add(new Option(y,y)); srcYil.add(new Option(y,y)); dstYil.add(new Option(y,y)); }
    ayInput.value=bugun.getMonth()+1; yilInput.value=bugun.getFullYear();
    srcAy.value=aySec.value; srcYil.value=yilSec.value;
    const next=new Date(bugun.getFullYear(), bugun.getMonth()+1, 1);
    dstAy.value=String(next.getMonth()+1); dstYil.value=String(next.getFullYear());
  })();

  srcAy.addEventListener('change', loadCopyPreview);
  srcYil.addEventListener('change', loadCopyPreview);

  // Modallar
  btnAdd.onclick=()=> document.getElementById("ekleModal").style.display="flex";
  btnCopy.onclick=async ()=>{ await loadCopyPreview(); document.getElementById("copyModal").style.display="flex"; };

  async function loadCopyPreview(){
    const sa=Number(srcAy.value), sy=Number(srcYil.value);
    const body=document.getElementById("copyPreviewBody"); body.innerHTML="";
    const snap=await db.collection(aktifKoleksiyon).where("ay","==",sa).where("yil","==",sy).get();
    if(snap.empty){ body.innerHTML='<tr><td colspan="3" class="muted" style="text-align:center;padding:12px">Kayıt yok</td></tr>'; return; }
    snap.forEach(doc=>{
      const d=doc.data()||{};
      const odSay=["hediye","kira","cocuk","ssk","yol","haberlesme"].reduce((c,k)=> c + (d.odemeler?.[k]?1:0), 0);
      const tr=document.createElement('tr');
      tr.innerHTML=`<td style="text-align:left">${d.ad||'-'}</td><td>${fmt(d.toplam||0)}</td><td>${odSay}</td>`;
      body.appendChild(tr);
    });
  }
  document.getElementById("btnDoCopy").onclick=async ()=>{
    const sa=Number(srcAy.value), sy=Number(srcYil.value);
    const da=Number(dstAy.value), dy=Number(dstYil.value);
    const overwrite=document.getElementById("overwriteChk").checked;
    if(sa===da && sy===dy){ toast("Kaynak ve hedef aynı olamaz."); return; }

    const srcSnap=await db.collection(aktifKoleksiyon).where("ay","==",sa).where("yil","==",sy).get();
    if(srcSnap.empty){ toast("Kaynakta kayıt yok."); return; }

    const dstSnap=await db.collection(aktifKoleksiyon).where("ay","==",da).where("yil","==",dy).get();
    const existingByName=new Map(); dstSnap.forEach(doc=> existingByName.set(norm(doc.data().ad||''), doc.id));

    const batch=db.batch(); let copied=0, skipped=0, overwritten=0;
    srcSnap.forEach(doc=>{
      const d=doc.data()||{}; const key=norm(d.ad||'');
      const payload = {
        ad: d.ad || '',
        ay: da,
        yil: dy,
        hediye: +(d.hediye || 0),
        kira: +(d.kira || 0),
        cocuk: +(d.cocuk || 0),
        ssk: +(d.ssk || 0),
        yol: +(d.yol || 0),
        haberlesme: +(d.haberlesme || 0),
        odemeler: {
          hediye: false,
          kira: false,
          cocuk: false,
          ssk: false,
          yol: false,
          haberlesme: false
        },
        maas: "ödenmedi",
        toplam:
          (+(d.hediye || 0)) +
          (+(d.kira || 0)) +
          (+(d.cocuk || 0)) +
          (+(d.ssk || 0)) +
          (+(d.yol || 0)) +
          (+(d.haberlesme || 0)),
        tarih: new Date()
      };    
      if(existingByName.has(key)){
        if(overwrite){ batch.set(db.collection(aktifKoleksiyon).doc(existingByName.get(key)), payload, {merge:false}); overwritten++; }
        else skipped++;
      }else{ batch.set(db.collection(aktifKoleksiyon).doc(), payload); copied++; }
    });
    await batch.commit();
    closeModals();
    toast(`Kopya tamam: ${copied}${overwrite?`, üzerine yazılan: ${overwritten}`:''}${skipped?`, atlanan: ${skipped}`:''}`);
    aySec.value=da; yilSec.value=dy; await listele();
  };

  // Ekle – tek kayıt
  async function kaydetEkle(){
    const veri={
      ad:(document.getElementById("adInput").value||"").trim(),
      ay:+document.getElementById("ayInput").value, yil:+document.getElementById("yilInput").value,
      hediye:+document.getElementById("hediyeInput").value||0, kira:+document.getElementById("kiraInput").value||0,
      cocuk:+document.getElementById("cocukInput").value||0, ssk:+document.getElementById("sskInput").value||0,
      yol:+document.getElementById("yolInput").value||0, haberlesme:+document.getElementById("haberInput").value||0,
      maas:"ödenmedi",
      odemeler:{hediye:false,kira:false,cocuk:false,ssk:false,yol:false,haberlesme:false},
      tarih:new Date()
    };
    veri.toplam = veri.hediye+veri.kira+veri.cocuk+veri.ssk+veri.yol+veri.haberlesme;
    if(!veri.ad){ toast("Ad Soyad boş olamaz."); return; }
    try{ await db.collection(aktifKoleksiyon).add(veri); closeModals(); toast("Tahakkuk oluşturuldu."); listele(); }
    catch(e){ console.error(e); toast("Kayıt başarısız."); }
  }

  // Listele + filtre
  function filterByName(d){ const q=norm(searchInput.value); return !q || norm(d.ad||'').includes(q); }

function applySearch() {
  const q = norm(searchInput.value);
  LAST_ROWS = CACHE_ROWS.filter(d => !q || norm(d.ad||'').includes(q));
}

function renderTableAndSummary(rows) {
  const tbody = document.getElementById("listeAlani");
  tbody.innerHTML = "";

  let ozet = {
    hediye:{toplam:0,odenen:0},
    kira:{toplam:0,odenen:0},
    cocuk:{toplam:0,odenen:0},
    ssk:{toplam:0,odenen:0},
    yol:{toplam:0,odenen:0},
    haberlesme:{toplam:0,odenen:0}
  };
  let genelKalan = 0;

  const fmt=(n)=> (Number(n||0)).toLocaleString("tr-TR",{minimumFractionDigits:2, maximumFractionDigits:2}) + " ₺";
  const cell=(val,ok)=> Number(val||0)===0
    ? `<td class="muted">-</td>`
    : `<td>${ ok ? `<span class="chip ok">${fmt(val)}</span>` : `<span class="chip no">${fmt(val)}</span>` }</td>`;

  rows.forEach(d=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td style="text-align:left;font-weight:700">${d.ad||'-'}</td>
      ${cell(d.hediye, d.odemeler?.hediye)}
      ${cell(d.kira, d.odemeler?.kira)}
      ${cell(d.cocuk, d.odemeler?.cocuk)}
      ${cell(d.ssk, d.odemeler?.ssk)}
      ${cell(d.yol, d.odemeler?.yol)}
      ${cell(d.haberlesme, d.odemeler?.haberlesme)}
      <td>${ d.maas==='ödendi' ? '<span class="chip ok">Ödendi</span>' : '<span class="chip no">Ödenmedi</span>' }</td>
      <td><strong>${fmt(d.toplam||0)}</strong></td>
    `;
    tr.style.cursor='pointer';
    tr.onclick=()=> openOdeme(d.id, d);
    tbody.appendChild(tr);

    for(const k of Object.keys(ozet)){
      ozet[k].toplam += +(d[k]||0);
      if(d.odemeler?.[k]) ozet[k].odenen += +(d[k]||0);
    }
  });

  const ozetAlani=document.getElementById("ozetAlani");
  ozetAlani.innerHTML="";
  Object.entries(ozet).forEach(([k,{toplam,odenen}])=>{
    const kalan = (+(toplam||0) - +(odenen||0)); genelKalan+=kalan;
    const tr=document.createElement('tr');
    tr.innerHTML=`<td style="text-transform:capitalize">${k}</td><td>${fmt(toplam)}</td><td>${fmt(odenen)}</td><td>${fmt(kalan)}</td>`;
    ozetAlani.appendChild(tr);
  });
  document.getElementById("kalanToplamGoster").textContent = fmt(genelKalan);
}

async function listele() {
  const ay = +aySec.value, yil = +yilSec.value;

  // Firestore: yalnızca Ay/Yıl DEĞİŞTİĞİNDE çağrılmalı
  const snap = await db.collection(aktifKoleksiyon)
    .where("ay","==",ay).where("yil","==",yil).get();

  CACHE_ROWS = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  applySearch();                   // arama kutusundaki mevcut değere göre filtrele
  renderTableAndSummary(LAST_ROWS);
}

  // Arama debounce
  let sTO=null;
  searchInput.addEventListener('input', ()=>{
    clearTimeout(sTO);
    sTO = setTimeout(()=>{
      applySearch();                    // uzak sorgu yok
      renderTableAndSummary(LAST_ROWS); // sadece yerelde filtre
    }, 120);
  });
  aySec.onchange = yilSec.onchange = listele;

  // Toplu set
  async function bulkSet(paid){
    if(!LAST_ROWS.length){ toast("İşaretlenecek kayıt yok."); return; }
    const cat=bulkKategori.value;
    const batch=db.batch();
    if(cat==="maas"){
      LAST_ROWS.forEach(r=> batch.update(db.collection(aktifKoleksiyon).doc(r.id), { maas: paid ? "ödendi":"ödenmedi" }));
    }else{
      LAST_ROWS.forEach(r=> batch.update(db.collection(aktifKoleksiyon).doc(r.id), { [`odemeler.${cat}`]: !!paid }));
    }
    await batch.commit(); toast(`Toplu güncellendi: ${LAST_ROWS.length} kayıt`); listele();
  }
  btnBulkOk.onclick=()=>bulkSet(true);
  btnBulkNo.onclick=()=>bulkSet(false);

  // Ödeme modal
  let aktifID=null;
  function openOdeme(id, veri){
    aktifID=id;
    document.getElementById("odemeModalBaslik").textContent=`${veri.ad||'-'} (${String(veri.ay).padStart(2,'0')}/${veri.yil})`;
    const div=document.getElementById("odemeKategoriAlani"); div.innerHTML="";
    ["hediye","kira","cocuk","ssk","yol","haberlesme"].forEach(key=>{
      div.innerHTML += `
        <label>${key.toUpperCase()}</label>
        <select id="odeme_${key}">
          <option value="true"  ${veri.odemeler?.[key] ? "selected":""}>Ödendi</option>
          <option value="false" ${!veri.odemeler?.[key] ? "selected":""}>Ödenmedi</option>
        </select>`;
    });
    div.innerHTML += `
      <label>RESMÎ MAAŞ</label>
      <select id="odeme_maas">
        <option value="ödendi"   ${veri.maas==="ödendi" ? "selected":""}>Ödendi</option>
        <option value="ödenmedi" ${veri.maas==="ödenmedi" ? "selected":""}>Ödenmedi</option>
      </select>`;
    document.getElementById("odemeModal").style.display="flex";
  }
  async function kaydetOdeme(){
    const fields=["hediye","kira","cocuk","ssk","yol","haberlesme"];
    const odemeler={}; fields.forEach(k=> odemeler[k] = document.getElementById(`odeme_${k}`).value==="true");
    const maas=document.getElementById("odeme_maas").value;
    try{ await db.collection(aktifKoleksiyon).doc(aktifID).update({ odemeler, maas }); closeModals(); toast("Ödemeler güncellendi."); listele(); }
    catch(e){ console.error(e); toast("Güncelleme hata."); }
  }
  async function silVeri(){
    if(!aktifID) return;
    if(confirm("Bu personel kaydı silinsin mi?")){
      try{ await db.collection(aktifKoleksiyon).doc(aktifID).delete(); closeModals(); toast("Kayıt silindi."); listele(); }
      catch(e){ console.error(e); toast("Silme hata."); }
    }
  }

  // Bildirim örnek (opsiyonel)
  (async function(){
    try{
      const snap=await db.collection('duyurular').orderBy('createdAt','desc').limit(5).get();
      const badge=document.getElementById('notifBadge'), list=document.getElementById('notifList');
      const n=snap.size; if(n>0){ badge.style.display='block'; badge.textContent=n>99?'99+':String(n); }
      if(n===0){ list.innerHTML='<div class="muted" style="padding:6px 8px">Yeni bildirim yok.</div>'; }
      else snap.forEach(doc=>{ const d=doc.data()||{}; const row=document.createElement('a'); row.href='diger/bildirim.html'; row.innerHTML=`<strong>${d.baslik||'Duyuru'}</strong><div class="muted">${d.detay||''}</div>`; list.appendChild(row); });
    }catch(e){}
  })();

  // Auth + yetki
  try{ firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL); }catch(e){}
  auth.onAuthStateChanged(async (user)=>{
    if(!user){ setTimeout(()=>{ if(!auth.currentUser) location.replace('index.html'); },150); return; }
    try{
      const uSnap=await db.collection('kullanicilar').doc(user.uid).get();
      const data=uSnap.exists?uSnap.data():{};
      document.getElementById('profName').textContent = data.adSoyad ? (data.adSoyad.split(' ')[0]) : 'Profil';
      const rawPerms=Array.isArray(data.yetkiler)? data.yetkiler : [];
      CURRENT_ALLOW=new Set(rawPerms.filter(s=>!String(s).trim().startsWith('-') && !String(s).trim().startsWith('!')).map(norm));
      CURRENT_DENY =new Set(rawPerms.filter(s=> String(s).trim().startsWith('-') || String(s).trim().startsWith('!')).map(s=>norm(String(s).replace(/^[-!]\s*/,''))));
      const panels=await fetchPanels(CURRENT_ALLOW, CURRENT_DENY);
      renderNav(panels);
      await listele();
    }catch(e){ console.error(e); toast('Veriler yüklenirken hata.'); }
  });
</script>
</body>
</html>
