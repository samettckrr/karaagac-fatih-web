<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Personel Ã–deme Takibi</title>
<link rel="icon" type="image/png" href="../img/logo.png" />

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<!-- html2pdf.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

<style>
  :root{
    --appbar-h:56px;
    --radius:14px; --shadow:0 4px 12px rgba(0,0,0,.08);
    --bg:#f8fafc; --bg2:#f1f5f9;
    --grad1:#3b82f622; --grad2:#06b6d422;
    --card:#ffffff; --stroke:#e2e8f0;
    --text:#1e293b; --muted:#64748b;
    --brand:#3b82f6; --brand2:#2563eb;
    --pill:#f1f5f9; --pill-hover:#e2e8f0; --surface:#f8fafc;
    --danger:#ef4444; --success:#22c55e;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;padding:0;font-family:'Segoe UI',system-ui,-apple-system,Arial,sans-serif;background:var(--bg);color:var(--text)}
  a{color:var(--brand); text-decoration:none}
  a:hover{text-decoration:underline}

  /* APPBAR */
  .appbar{
    position:sticky; top:0; z-index:60; height:var(--appbar-h);
    background:var(--card); backdrop-filter:blur(10px);
    border-bottom:1px solid var(--stroke);
    display:flex; align-items:center; gap:10px; padding:0 12px;
  }
  .brand{display:flex; align-items:center; gap:10px; cursor:pointer}
  .brand img{width:24px; height:24px}
  .brand span{font-weight:900; letter-spacing:.02em}
  .nav-center{margin:0 auto; height:100%}
  .nav-list{display:flex; gap:22px; align-items:center; height:100%; list-style:none; margin:0; padding:0}
  .nav-item{position:relative; height:100%}
  .nav-btn{height:100%; display:flex; align-items:center; gap:6px; font-weight:800; cursor:pointer}
  .nav-btn:hover{color:var(--brand)}
  .caret{font-size:12px; opacity:.6}
  .dropdown{position:absolute; top:100%; left:0; min-width:240px; background:var(--card); border:1px solid var(--stroke); border-radius:10px; box-shadow:var(--shadow); padding:8px; display:none}
  .dropdown a{display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:8px; color:var(--text); text-decoration:none}
  .dropdown a:hover{background:var(--surface)}
  .nav-item.open .dropdown{display:block}
  .nav-right{display:flex; gap:8px; align-items:center}
  .btn{border:1px solid var(--stroke); background:var(--card); color:var(--text); border-radius:999px; padding:8px 12px; cursor:pointer; white-space:nowrap}
  .hamb{display:none}
  .iconbtn{position:relative; border:1px solid var(--stroke); background:var(--card); color:var(--text); border-radius:999px; padding:8px 12px; cursor:pointer; display:flex; align-items:center; gap:8px}
  .badge{position:absolute; top:-6px; right:-6px; background:var(--danger); color:#fff; font-size:11px; padding:2px 6px; border-radius:999px; border:2px solid var(--card)}
  .drop-right{left:auto; right:0}
  .avatar{width:22px;height:22px;border-radius:999px;background:linear-gradient(180deg,var(--brand),var(--brand2))}
  @media (max-width: 960px){ .nav-center{display:none} .hamb{display:inline-flex} }

  /* Drawer */
  .drawer{position:fixed; top:var(--appbar-h); right:0; bottom:0; left:30%; transform:translateX(100%); transition:.25s; background:var(--card); border-left:1px solid var(--stroke); z-index:70; overflow:auto; padding:12px}
  .drawer.open{transform:translateX(0)}
  .drawer .panel-title{margin:14px 4px 6px; font-weight:800; color:var(--muted); font-size:13px}
  .drawer a{display:block; padding:10px; border-radius:10px; border:1px solid var(--stroke); margin:6px 0; color:var(--text); background:var(--pill)}
  .drawer a:hover{background:var(--pill-hover)}

  /* CONTENT */
  .container{max-width:100%; margin:0 auto; padding:16px}
  .card{background:var(--card); border:1px solid var(--stroke); border-radius:14px; box-shadow:var(--shadow); padding:14px}
  .muted{color:var(--muted)}

  /* Header Card */
  .header-card{display:flex; justify-content:space-between; align-items:center; gap:16px; margin:16px 0}
  .header-left h2{margin:0 0 6px; font-size:18px}
  .primary-actions{display:flex; gap:10px; flex-wrap:wrap}
  .cta{border:1px solid var(--stroke); background:linear-gradient(180deg,var(--brand),var(--brand2)); color:#fff; border-radius:999px; padding:10px 16px; cursor:pointer; font-weight:800; white-space:nowrap}
  .btn-ghost{border:1px solid var(--stroke); background:var(--pill); border-radius:999px; padding:10px 14px; cursor:pointer; white-space:nowrap}

  /* Filters Card */
  .filters-card{margin:10px 0 14px}
  .controls-grid{
    display:grid; grid-template-columns:repeat(12,minmax(0,1fr)); gap:10px; align-items:center;
  }
  .ctrl{grid-column:span 3; display:flex; align-items:center; gap:10px; padding:6px 10px; border:1px solid var(--stroke); background:var(--pill); border-radius:999px; height:40px; min-width:0}
  .ctrl span{white-space:nowrap}
  .ctrl select{appearance:none; background:transparent; color:var(--text); border:none; outline:none; font-weight:700; height:26px; line-height:26px; width:100%}
  .ctrl input{background:transparent; border:none; outline:none; color:var(--text); font-weight:600; width:100%}
  .ctrl.wide{grid-column:span 6}

  @media (max-width: 960px){
    .nav-center{display:none}
    .hamb{display:inline-flex}
    .controls-grid{grid-template-columns:repeat(6,minmax(0,1fr))}
    .ctrl{grid-column:span 3}
    .ctrl.wide{grid-column:span 6}
  }

  /* Tables - Compact Single Screen Design */
  .tablo-kart{
    background:var(--card); 
    border:1px solid var(--stroke); 
    border-radius:12px; 
    box-shadow:0 2px 8px rgba(0,0,0,.06); 
    padding:16px; 
    overflow:visible;
    background:#fff;
  }
  
  table{
    width:100%; 
    border-collapse:collapse; 
    table-layout:fixed;
    background:#fff;
    font-size:13px;
  }
  
  thead{
    background:#f8fafc;
    border-bottom:2px solid #e2e8f0;
  }
  
  th{
    padding:12px 8px; 
    text-align:center; 
    font-size:12px;
    font-weight:700;
    color:#475569;
    white-space:nowrap;
    background:#f8fafc;
    border-bottom:2px solid #e2e8f0;
    letter-spacing:0.3px;
    text-transform:uppercase;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  
  th:first-child{
    text-align:left; 
    padding-left:16px; 
    width:160px;
    text-transform:none;
    font-size:13px;
    font-weight:800;
    color:#0f172a;
  }
  
  /* Kategori sÃ¼tunlarÄ± - eÅŸit geniÅŸlik */
  th:not(:first-child):not(:last-child):not(:nth-last-child(2)){
    width:calc((100% - 160px - 240px) / 11);
    min-width:75px;
    max-width:100px;
  }
  
  /* ResmÃ® MaaÅŸ sÃ¼tunu */
  th:nth-last-child(3){
    width:110px;
  }
  
  /* Toplam sÃ¼tunu */
  th:nth-last-child(2){
    width:120px;
  }
  
  /* Kalan sÃ¼tunu */
  th:last-child{
    width:120px;
  }
  
  td{
    padding:12px 8px; 
    text-align:center; 
    font-size:13px;
    color:#334155;
    white-space:nowrap;
    border-bottom:1px solid #f1f5f9;
    background:#fff;
    transition:background 0.15s ease;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  
  td:first-child{
    text-align:left; 
    padding-left:16px; 
    font-weight:600; 
    color:#0f172a;
    font-size:13px;
    background:#fafbfc;
    border-right:1px solid #f1f5f9;
  }
  
  thead th{
    cursor:pointer; 
    user-select:none; 
    transition:all .15s;
  }
  
  thead th:hover{
    background:#f1f5f9;
    color:var(--brand);
  }
  
  thead th.sortable::after{
    content:' â†•'; 
    opacity:.3; 
    margin-left:6px; 
    font-size:10px;
  }
  
  thead th.sort-asc::after{
    content:' â†‘'; 
    opacity:1; 
    color:var(--brand); 
    font-weight:900;
    font-size:11px;
  }
  
  thead th.sort-desc::after{
    content:' â†“'; 
    opacity:1; 
    color:var(--brand); 
    font-weight:900;
    font-size:11px;
  }
  
  tbody tr{
    transition:background 0.15s ease;
  }
  
  tbody tr:hover{
    background:#f8fafc;
  }
  
  tbody tr:hover td:first-child{
    background:#f1f5f9;
  }
  
  tbody tr:last-child td{
    border-bottom:none;
  }
  
  /* Chip Design - Readable */
  .chip{
    border-radius:5px; 
    padding:5px 10px; 
    font-weight:600; 
    font-size:12px; 
    display:inline-block; 
    white-space:nowrap; 
    text-align:center;
    line-height:1.4;
    min-width:65px;
  }
  
  .chip.ok{
    background:#dcfce7;
    color:#166534;
    border:1px solid #86efac;
  }
  
  .chip.no{
    background:#fee2e2;
    color:#991b1b;
    border:1px solid #fca5a5;
  }
  
  td strong{
    font-size:14px; 
    font-weight:700;
  }
  
  /* Toplam ve Kalan sÃ¼tunlarÄ± */
  td:nth-last-child(2){
    font-weight:700;
    color:#2563eb;
    font-size:13px;
  }
  
  td:last-child{
    font-weight:700;
    font-size:13px;
  }
  
  /* Empty cells */
  td.muted{
    opacity:0.4;
    font-size:12px;
  }

  /* Mobile Card View */
  .mobile-cards{display:none}
  .mobile-summary-cards{display:none}
  @media (max-width: 960px){
    .tablo-kart table{display:none}
    .mobile-cards{display:block}
    .person-card{
      background:var(--card); border:1px solid var(--stroke); border-radius:12px;
      padding:14px; margin-bottom:12px; box-shadow:var(--shadow);
    }
    .person-card-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; padding-bottom:10px; border-bottom:1px solid var(--stroke)}
    .person-card-header h3{margin:0; font-size:16px; color:var(--text)}
    .person-card-row{display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:8px}
    .person-card-row:last-child{margin-bottom:0}
    .person-card-label{font-size:12px; color:var(--muted); font-weight:600}
    .person-card-value{font-size:14px; font-weight:700; color:var(--text)}
    .person-card-total{background:var(--pill); padding:10px; border-radius:8px; margin-top:10px; text-align:center}
    .person-card-total .person-card-label{font-size:14px; margin-bottom:4px}
    .person-card-total .person-card-value{font-size:18px; color:var(--brand)}
    
    /* Summary mobile */
    #ozetTable{display:none}
    .mobile-summary-cards{display:grid; grid-template-columns:repeat(2,1fr); gap:10px; margin-top:12px}
    .summary-card{
      background:var(--card); border:1px solid var(--stroke); border-radius:12px;
      padding:12px; box-shadow:var(--shadow);
    }
    .summary-card-label{font-size:11px; color:var(--muted); font-weight:600; text-transform:capitalize; margin-bottom:6px}
    .summary-card-value{font-size:16px; font-weight:700; color:var(--text); margin-bottom:4px}
    .summary-card-kalan{font-size:13px; color:var(--brand); font-weight:600}
    .summary-card-total{
      grid-column:1/-1; background:var(--pill); padding:14px; border-radius:10px;
      text-align:center; margin-top:8px;
    }
    .summary-card-total .summary-card-label{font-size:14px; margin-bottom:6px}
    .summary-card-total .summary-card-value{font-size:20px; color:var(--brand)}
  }

  /* Modals & Toast */
  .modal{
    display:none; 
    position:fixed; 
    inset:0; 
    background:rgba(30,41,59,.6); 
    backdrop-filter:blur(4px); 
    z-index:99; 
    align-items:center; 
    justify-content:center; 
    padding:16px;
    overflow-y:auto;
    overflow-x:hidden;
  }
  .modal-content{
    background:var(--card); 
    border:1px solid var(--stroke); 
    width:95%; 
    max-width:640px; 
    max-height:90vh;
    border-radius:16px; 
    box-shadow:var(--shadow); 
    padding:16px;
    margin:auto;
    position:relative;
    overflow-y:auto;
    overflow-x:hidden;
  }
  .modal-content h3{margin:0 0 10px; text-align:center}
  .modal-content label{display:block; margin-top:8px; font-size:13px; color:var(--muted)}
  .modal-content input{width:100%; padding:10px 12px; border:1px solid var(--stroke); border-radius:10px; background:var(--pill); color:var(--text); margin-top:4px}
  
  /* Modal aÃ§Ä±ldÄ±ÄŸÄ±nda body scroll'unu engelle */
  body.modal-open{
    overflow:hidden;
    position:fixed;
    width:100%;
  }
  
  /* Ã–deme modalÄ± iÃ§in Ã¶zel stil - uzun iÃ§erik iÃ§in */
  #odemeModal .modal-content{
    max-height:85vh;
    display:flex;
    flex-direction:column;
  }
  #odemeModal #odemeKategoriAlani{
    max-height:400px;
    overflow-y:auto;
    overflow-x:hidden;
    padding-right:4px;
  }
  #odemeModal #odemeTutarAlani{
    max-height:300px;
    overflow-y:auto;
    overflow-x:hidden;
  }
  
  /* Scrollbar stilleri */
  .modal-content::-webkit-scrollbar,
  #odemeModal #odemeKategoriAlani::-webkit-scrollbar,
  #odemeModal #odemeTutarAlani::-webkit-scrollbar{
    width:8px;
  }
  .modal-content::-webkit-scrollbar-track,
  #odemeModal #odemeKategoriAlani::-webkit-scrollbar-track,
  #odemeModal #odemeTutarAlani::-webkit-scrollbar-track{
    background:var(--pill);
    border-radius:4px;
  }
  .modal-content::-webkit-scrollbar-thumb,
  #odemeModal #odemeKategoriAlani::-webkit-scrollbar-thumb,
  #odemeModal #odemeTutarAlani::-webkit-scrollbar-thumb{
    background:var(--muted);
    border-radius:4px;
  }
  .modal-content::-webkit-scrollbar-thumb:hover,
  #odemeModal #odemeKategoriAlani::-webkit-scrollbar-thumb:hover,
  #odemeModal #odemeTutarAlani::-webkit-scrollbar-thumb:hover{
    background:var(--text);
  }

  /* Modal ve Bulk iÃ§indeki selectler: sade beyaz */
  .modal-content select{
    width:100%;
    border:1px solid #d1d5db;
    border-radius:12px;
    background:#fff url("data:image/svg+xml,%3Csvg width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E") no-repeat right 10px center;
    background-size:16px;
    padding:8px 36px 8px 12px;
    color:#111827;
    font-weight:600;
    box-shadow:0 1px 2px rgba(0,0,0,.05) inset;
    outline:none;
  }
  .modal-content select:hover{ border-color:#0ea5e9; }
  .modal-content select:focus{ border-color:#0ea5e9; box-shadow:0 0 0 3px rgba(14,165,233,.25); }

  .modal-buttons{display:flex; justify-content:flex-end; gap:8px; margin-top:14px}
  .btn-danger{border:1px solid #ef444422; background:#ef4444; color:#fff; border-radius:10px; padding:8px 12px; cursor:pointer}
  .toast{position:fixed; left:50%; bottom:24px; transform:translateX(-50%) translateY(20px); background:#1e293b; color:#fff; border:1px solid var(--stroke); border-radius:12px; padding:10px 12px; opacity:0; pointer-events:none; transition:opacity .25s, transform .25s; z-index:200; box-shadow:var(--shadow)}
  .toast.show{opacity:1; transform:translateX(-50%) translateY(0)}

  /* === Toplu toolbar: beyaz kart + pastel butonlar === */
  .bulk-toolbar{
    display:grid;
    grid-template-columns: 1fr auto auto; /* kategori | Ã¶dendi | Ã¶denmedi */
    gap:10px; align-items:center; margin-top:10px;
    background:#fff; border:1px solid var(--stroke);
    border-radius:14px; padding:10px 14px;
    box-shadow:0 2px 6px rgba(0,0,0,.04);
  }
  .bulk-select{ display:flex; align-items:center; gap:10px; min-width:0 }
  .bulk-select span{ white-space:nowrap; font-weight:600; color:#111827 }
  .bulk-select select{
    appearance:none; border:1px solid #d1d5db; border-radius:8px;
    background:#fff url("data:image/svg+xml,%3Csvg width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E") no-repeat right 10px center;
    background-size:16px;
    padding:6px 34px 6px 10px; font-size:14px; font-weight:600; color:#111827;
    box-shadow:0 1px 2px rgba(0,0,0,.05) inset; outline:none; min-width:140px;
  }
  .bulk-select select:hover{ border-color:#0ea5e9 }
  .bulk-select select:focus{ border-color:#0ea5e9; box-shadow:0 0 0 3px rgba(14,165,233,.25) }

  .bulk-buttons{ display:flex; gap:8px; justify-content:flex-end }
  .pill-btn{
    border-radius:999px; padding:6px 16px; font-weight:600; font-size:14px; cursor:pointer;
    border:1px solid transparent; transition:background .2s, color .2s, border .2s;
  }
  .pill-btn.ok{ background:#dcfce7; color:#166534; border-color:#22c55e33 }
  .pill-btn.no{ background:#fee2e2; color:#991b1b; border-color:#ef444433 }
  .pill-btn.ok:hover{ background:#bbf7d0 }
  .pill-btn.no:hover{ background:#fecaca }

  /* Mobile: kategori Ã¼stte, butonlar altta yan yana */
  @media (max-width: 768px){
    .bulk-toolbar{ grid-template-columns:1fr; }
    .bulk-buttons{ justify-content:flex-start; }
  }

  /* Analiz Modal - AylÄ±k DaÄŸÄ±lÄ±m - Responsive Grid */
  #analizAylikDagilim{
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(80px, 1fr));
    gap:8px;
  }
  
  /* Minimum geniÅŸlik garantisi - her zaman en az 2 sÃ¼tun */
  @media (min-width: 1200px){
    #analizAylikDagilim{
      grid-template-columns:repeat(6,1fr);
    }
  }
  
  @media (min-width: 960px) and (max-width: 1199px){
    #analizAylikDagilim{
      grid-template-columns:repeat(4,1fr);
    }
  }
  
  @media (min-width: 640px) and (max-width: 959px){
    #analizAylikDagilim{
      grid-template-columns:repeat(3,1fr);
    }
  }
  
  @media (max-width: 639px){
    #analizAylikDagilim{
      grid-template-columns:repeat(2,1fr);
    }
  }

  /* Analiz Modal - Mobil dÃ¼zenlemeler */
  @media (max-width: 640px){
    #analizDataArea > div:first-child > div{
      flex-direction:column;
      align-items:flex-start !important;
      gap:12px;
    }
    #analizDataArea > div:first-child > div > div:last-child{
      text-align:left !important;
    }
    #analizTable{
      font-size:12px;
    }
    #analizTable th,
    #analizTable td{
      padding:8px 4px;
    }
    /* Kategori detay Ã¶zet kartlarÄ± mobilde 2 sÃ¼tun */
    #kategoriDetayArea > div:first-child{
      grid-template-columns:repeat(2,1fr) !important;
    }
  }
</style>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="../js/firebase/firebase-init.js"></script>
</head>
<body>

<!-- APPBAR -->
<div class="appbar">
  <div class="brand" onclick="location.href='../panel.html'">
    <img src="../img/logo.png" alt="logo"><span>KARAAÄAÃ‡ FATÄ°H</span>
  </div>

  <nav class="nav-center"><ul class="nav-list" id="navMain"></ul></nav>

  <div class="nav-right">
    <button class="btn hamb" id="hamburger" title="MenÃ¼">â˜°</button>

    <div class="nav-item">
      <button class="iconbtn" id="btnNotif" title="Bildirimler">ğŸ””
        <span class="badge" id="notifBadge" style="display:none">0</span>
      </button>
      <div class="dropdown drop-right" id="notifDropdown">
        <div class="muted" style="padding:6px 8px">Son bildirimler</div>
        <div id="notifList" style="max-height:300px;overflow:auto"></div>
        <a href="/diger/bildirim.html">TÃ¼m bildirimleri gÃ¶r â†’</a>
      </div>
    </div>

    <div class="nav-item">
      <button class="iconbtn" id="btnProfile" title="Profil">
        <span class="avatar"></span> <span id="profName" class="muted">Profil</span>
      </button>
      <div class="dropdown drop-right" id="profDropdown">
        <a href="/diger/kullanici-yonetimi.html" >ğŸ‘¤ Profil</a>
        <a href="/diger/sistem-ayarlari.html" >âš™ï¸ Sistem AyarlarÄ±</a>
        <a href="#" id="btnLogout">ğŸšª Ã‡Ä±kÄ±ÅŸ Yap</a>
      </div>
    </div>
  </div>
</div>

<aside class="drawer" id="drawer"></aside>

<main class="container">

  <!-- HEADER CARD -->
  <section class="card header-card">
    <div class="header-left">
      <h2>Personel Ã–deme Takibi</h2>
      <div class="muted">BugÃ¼n: <span id="todayText">â€”</span></div>
    </div>
  </section>

  <!-- SUMMARY - Moved here -->
  <section class="card" style="margin:0 0 16px">
    <h3 style="margin:0 0 6px; font-size:16px">Kategori ToplamlarÄ±</h3>
    <div class="muted" style="margin-bottom:12px; font-size:13px" id="ozetTarihBilgisi">â€”</div>
    <div class="tablo-kart" style="padding:0">
      <table id="ozetTable">
        <thead>
          <tr><th>Kategori</th><th>Toplam</th><th>Ã–denen</th><th>Kalan</th></tr>
        </thead>
        <tbody id="ozetAlani"></tbody>
        <tfoot>
          <tr><td colspan="4" style="text-align:right;padding:12px 16px" id="ozetToplamSatir"></td></tr>
        </tfoot>
      </table>
    </div>
    <div class="mobile-summary-cards" id="mobileSummaryCards"></div>
  </section>

  <!-- FILTERS - 2. sÄ±ra -->
  <section class="card filters-card">
    <div class="controls-grid">
      <div class="ctrl"><span>Ay</span><select id="aySec"></select></div>
      <div class="ctrl"><span>YÄ±l</span><select id="yilSec"></select></div>
      <div class="ctrl wide">ğŸ” <input id="searchInput" type="text" placeholder="Ä°sim araâ€¦"></div>
    </div>
  </section>

  <section class="card header-card">
    <div class="primary-actions">
      <button class="cta" id="btnAdd">+ Personel Tahakkuk</button>
      <button class="btn-ghost" id="btnCopy">âŸ³ Tahakkuk Kopyala</button>
      <button class="btn-ghost" id="btnBulkManage">âš™ï¸ Toplu YÃ¶netim</button>
      <button class="btn-ghost" id="btnPersonelManage">ğŸ‘¤ Personel YÃ¶netim</button>
      <button class="btn-ghost" id="btnAnaliz">ğŸ“Š Analiz</button>
    </div>
  </section>

  <!-- TABLE -->
  <section class="tablo-kart">
    <table>
      <thead>
        <tr>
          <th class="sortable" data-sort="ad" style="text-align:left">Ad</th>
          <th class="sortable" data-sort="hediye">Hediye</th>
          <th class="sortable" data-sort="kira">Kira</th>
          <th class="sortable" data-sort="cocuk">Ã‡ocuk</th>
          <th class="sortable" data-sort="yol">Yol</th>
          <th class="sortable" data-sort="haberlesme">HaberleÅŸme</th>
          <th class="sortable" data-sort="ikramiye">Ä°kramiye</th>
          <th class="sortable" data-sort="yakacak">Yakacak</th>
          <th class="sortable" data-sort="elbise">Elbise</th>
          <th class="sortable" data-sort="ssk">SSK</th>
          <th class="sortable" data-sort="maas">ResmÃ® MaaÅŸ</th>
          <th class="sortable" data-sort="toplam">Toplam</th>
          <th class="sortable" data-sort="kalan">Kalan</th>
        </tr>
      </thead>
      <tbody id="listeAlani"></tbody>
    </table>
    <div class="mobile-cards" id="mobileCards"></div>
  </section>

  <div style="height:120px"></div>
</main>

<!-- MODALS -->
<div class="modal" id="ekleModal">
  <div class="modal-content">
    <h3>Yeni Personel Tahakkuk</h3>
    <label>Ad Soyad</label><input id="adInput" type="text" placeholder="Ã–rn: Samet Ã‡AKIR">
    <div style="display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px">
      <div><label>Ay</label><select id="ayInput"></select></div>
      <div><label>YÄ±l</label><select id="yilInput"></select></div>
    </div>
    <div style="display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px">
      <div><label>Hediye</label><input id="hediyeInput" type="number" value="0" min="0" step="0.01"></div>
      <div><label>Kira</label><input id="kiraInput" type="number" value="0" min="0" step="0.01"></div>
      <div><label>Ã‡ocuk</label><input id="cocukInput" type="number" value="0" min="0" step="0.01"></div>
      <div><label>Yol</label><input id="yolInput" type="number" value="0" min="0" step="0.01"></div>
      <div><label>HaberleÅŸme</label><input id="haberInput" type="number" value="0" min="0" step="0.01"></div>
      <div><label>Ä°kramiye</label><input id="ikramiyeInput" type="number" value="0" min="0" step="0.01"></div>
      <div><label>Yakacak</label><input id="yakacakInput" type="number" value="0" min="0" step="0.01"></div>
      <div><label>Elbise</label><input id="elbiseInput" type="number" value="0" min="0" step="0.01"></div>
      <div><label>SSK</label><input id="sskInput" type="number" value="0" min="0" step="0.01"></div>
    </div>
    <div class="modal-buttons">
      <button class="btn-ghost" onclick="closeModals()">Ä°ptal</button>
      <button class="cta" onclick="kaydetEkle()">Kaydet</button>
    </div>
  </div>
</div>

<div class="modal" id="odemeModal">
  <div class="modal-content">
    <h3 id="odemeModalBaslik">Ã–deme Durumu</h3>
    <div id="odemeUyariAlani" style="display:none; margin-bottom:12px; padding:10px; background:#fef3c7; border:1px solid #fbbf24; border-radius:8px; color:#92400e; font-size:13px"></div>
    <div id="odemeKategoriAlani"></div>
    <div id="odemeTutarAlani" style="display:none; margin-top:16px; padding-top:16px; border-top:1px solid var(--stroke)">
      <h4 style="margin:0 0 12px; font-size:14px; color:var(--muted)">Tutar DÃ¼zenleme</h4>
      <div style="display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px">
        <div><label>Hediye</label><input id="edit_hediye" type="number" value="0" min="0" step="0.01" style="width:100%; padding:8px 12px; border:1px solid var(--stroke); border-radius:8px; background:var(--pill); color:var(--text)"></div>
        <div><label>Kira</label><input id="edit_kira" type="number" value="0" min="0" step="0.01" style="width:100%; padding:8px 12px; border:1px solid var(--stroke); border-radius:8px; background:var(--pill); color:var(--text)"></div>
        <div><label>Ã‡ocuk</label><input id="edit_cocuk" type="number" value="0" min="0" step="0.01" style="width:100%; padding:8px 12px; border:1px solid var(--stroke); border-radius:8px; background:var(--pill); color:var(--text)"></div>
        <div><label>Yol</label><input id="edit_yol" type="number" value="0" min="0" step="0.01" style="width:100%; padding:8px 12px; border:1px solid var(--stroke); border-radius:8px; background:var(--pill); color:var(--text)"></div>
        <div><label>HaberleÅŸme</label><input id="edit_haberlesme" type="number" value="0" min="0" step="0.01" style="width:100%; padding:8px 12px; border:1px solid var(--stroke); border-radius:8px; background:var(--pill); color:var(--text)"></div>
        <div><label>Ä°kramiye</label><input id="edit_ikramiye" type="number" value="0" min="0" step="0.01" style="width:100%; padding:8px 12px; border:1px solid var(--stroke); border-radius:8px; background:var(--pill); color:var(--text)"></div>
        <div><label>Yakacak</label><input id="edit_yakacak" type="number" value="0" min="0" step="0.01" style="width:100%; padding:8px 12px; border:1px solid var(--stroke); border-radius:8px; background:var(--pill); color:var(--text)"></div>
        <div><label>Elbise</label><input id="edit_elbise" type="number" value="0" min="0" step="0.01" style="width:100%; padding:8px 12px; border:1px solid var(--stroke); border-radius:8px; background:var(--pill); color:var(--text)"></div>
        <div><label>SSK</label><input id="edit_ssk" type="number" value="0" min="0" step="0.01" style="width:100%; padding:8px 12px; border:1px solid var(--stroke); border-radius:8px; background:var(--pill); color:var(--text)"></div>
      </div>
      <div style="margin-top:12px; padding:10px; background:var(--pill); border-radius:8px; text-align:center">
        <div style="font-size:12px; color:var(--muted); margin-bottom:4px">Yeni Toplam</div>
        <div id="editToplamGoster" style="font-size:18px; font-weight:700; color:var(--brand)">0 â‚º</div>
      </div>
    </div>
    <div class="modal-buttons">
      <button class="btn-ghost" onclick="closeModals()">Kapat</button>
      <button class="btn-ghost" id="btnEditTutarlar" onclick="toggleEditMode()" style="display:none">DÃ¼zenle</button>
      <button class="btn-danger" id="btnSilVeri" onclick="silVeri()" style="display:none">Sil</button>
      <button class="cta" id="btnKaydetOdeme" onclick="kaydetOdeme()" style="display:none">Kaydet</button>
    </div>
  </div>
</div>

<div class="modal" id="copyModal">
  <div class="modal-content">
    <h3>Tahakkuk Kopyala</h3>
    <div style="display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:10px">
      <div><label>Kaynak Ay</label><select id="srcAy"></select></div>
      <div><label>Kaynak YÄ±l</label><select id="srcYil"></select></div>
      <div><label>Hedef Ay</label><select id="dstAy"></select></div>
      <div><label>Hedef YÄ±l</label><select id="dstYil"></select></div>
    </div>
    <label style="margin-top:10px"><input type="checkbox" id="overwriteChk"> Var olan kayÄ±tlar Ã¼zerine yaz</label>
    <div class="card" style="margin-top:10px">
      <div class="muted" style="margin-bottom:8px">Kaynak Ã¶nizleme:</div>
      <div class="tablo-kart" style="padding:0; max-height:220px; overflow:auto">
        <table>
          <thead><tr><th style="text-align:left">Ad</th><th>Toplam</th><th>Ã–denen Alan SayÄ±sÄ±</th></tr></thead>
          <tbody id="copyPreviewBody"></tbody>
        </table>
      </div>
    </div>
    <div class="modal-buttons">
      <button class="btn-ghost" onclick="closeModals()">Kapat</button>
      <button class="cta" id="btnDoCopy">Kopyala</button>
    </div>
  </div>
</div>

<div class="modal" id="bulkModal">
  <div class="modal-content">
    <h3>Toplu Kategori YÃ¶netimi</h3>
    <label>Kategori SeÃ§in</label>
    <select id="bulkKategoriModal">
      <option value="hediye">Hediye</option>
      <option value="kira">Kira</option>
      <option value="cocuk">Ã‡ocuk</option>
      <option value="yol">Yol</option>
      <option value="haberlesme">HaberleÅŸme</option>
      <option value="ikramiye">Ä°kramiye</option>
      <option value="yakacak">Yakacak</option>
      <option value="elbise">Elbise</option>
      <option value="ssk">SSK</option>
      <option value="maas">ResmÃ® MaaÅŸ</option>
    </select>
    <div class="muted" style="margin-top:12px; padding:10px; background:var(--pill); border-radius:8px; font-size:13px">
      <strong>Bilgi:</strong> SeÃ§ili ay/yÄ±l ve arama filtresi kapsamÄ±ndaki tÃ¼m personeller iÃ§in iÅŸlem yapÄ±lacaktÄ±r.
    </div>
    <div class="modal-buttons" style="margin-top:16px">
      <button class="btn-ghost" onclick="closeModals()">Ä°ptal</button>
      <button class="pill-btn ok" id="btnBulkOkModal" style="padding:10px 16px">Toplu: Ã–dendi</button>
      <button class="pill-btn no" id="btnBulkNoModal" style="padding:10px 16px">Toplu: Ã–denmedi</button>
    </div>
  </div>
</div>

<div class="modal" id="personelManageModal">
  <div class="modal-content" style="max-width:900px; max-height:90vh; overflow-y:auto">
    <h3 style="margin-bottom:20px">ğŸ‘¤ Personel YÃ¶netim</h3>
    
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:20px">
      <div>
        <label style="display:block; margin-bottom:6px; font-weight:600; color:var(--text)">Personel SeÃ§in</label>
        <select id="personelSelect" style="width:100%; padding:10px 12px; border:1px solid var(--stroke); border-radius:10px; background:var(--pill); color:var(--text); font-weight:600; font-size:14px">
          <option value="">YÃ¼kleniyor...</option>
        </select>
      </div>
      <div>
        <label style="display:block; margin-bottom:6px; font-weight:600; color:var(--text)">YÄ±l SeÃ§in</label>
        <select id="personelYilSelect" style="width:100%; padding:10px 12px; border:1px solid var(--stroke); border-radius:10px; background:var(--pill); color:var(--text); font-weight:600; font-size:14px">
          <option value="">YÄ±l seÃ§in</option>
        </select>
      </div>
    </div>

    <div id="personelDataArea" style="display:none">
      <div style="background:linear-gradient(135deg, var(--brand)15, var(--brand2)15); border:1px solid var(--stroke); border-radius:12px; padding:16px; margin-bottom:16px">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px">
          <div>
            <h4 id="personelAdGoster" style="margin:0; font-size:18px; color:var(--text)">â€”</h4>
            <div class="muted" id="personelYilGoster" style="font-size:13px; margin-top:4px">â€”</div>
          </div>
          <div style="text-align:right">
            <div style="font-size:12px; color:var(--muted); margin-bottom:4px">YÄ±llÄ±k Toplam</div>
            <div id="yillikToplamGoster" style="font-size:24px; font-weight:700; color:var(--brand)">0 â‚º</div>
          </div>
        </div>
      </div>

      <div id="personelAylarListesi" style="display:grid; gap:12px"></div>
    </div>

    <div id="personelEmptyState" style="text-align:center; padding:40px; color:var(--muted)">
      <div style="font-size:48px; margin-bottom:12px">ğŸ“‹</div>
      <div style="font-size:16px; font-weight:600">Personel ve yÄ±l seÃ§in</div>
      <div style="font-size:13px; margin-top:6px">SeÃ§im yaptÄ±ÄŸÄ±nÄ±zda veriler burada gÃ¶rÃ¼necek</div>
    </div>

    <div class="modal-buttons" style="margin-top:20px; border-top:1px solid var(--stroke); padding-top:16px">
      <button class="btn-ghost" onclick="closeModals()">Kapat</button>
      <button class="cta" id="btnPersonelKaydet" style="display:none" onclick="kaydetPersonelYonetim()">TÃ¼m DeÄŸiÅŸiklikleri Kaydet</button>
    </div>
  </div>
</div>

<div class="modal" id="analizModal">
  <div class="modal-content" style="max-width:1000px; max-height:90vh; overflow-y:auto">
    <h3 style="margin-bottom:20px">ğŸ“Š Personel Ã–deme Analizi</h3>
    
    <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; margin-bottom:20px">
      <div>
        <label style="display:block; margin-bottom:6px; font-weight:600; color:var(--text)">Personel SeÃ§imi</label>
        <select id="analizPersonelSelect" style="width:100%; padding:10px 12px; border:1px solid var(--stroke); border-radius:10px; background:var(--pill); color:var(--text); font-weight:600; font-size:14px">
          <option value="tum">TÃ¼m Personeller</option>
        </select>
      </div>
      <div>
        <label style="display:block; margin-bottom:6px; font-weight:600; color:var(--text)">YÄ±l SeÃ§in</label>
        <select id="analizYilSelect" style="width:100%; padding:10px 12px; border:1px solid var(--stroke); border-radius:10px; background:var(--pill); color:var(--text); font-weight:600; font-size:14px">
          <option value="">YÄ±l seÃ§in</option>
        </select>
      </div>
    </div>

    <div id="analizDataArea" style="display:none">
      <div style="background:linear-gradient(135deg, var(--brand)15, var(--brand2)15); border:1px solid var(--stroke); border-radius:12px; padding:16px; margin-bottom:16px">
        <div style="display:flex; justify-content:space-between; align-items:center">
          <div>
            <h4 id="analizBaslikGoster" style="margin:0; font-size:18px; color:var(--text)">â€”</h4>
            <div class="muted" id="analizYilGoster" style="font-size:13px; margin-top:4px">â€”</div>
          </div>
          <div style="text-align:right">
            <div style="font-size:12px; color:var(--muted); margin-bottom:4px">YÄ±llÄ±k Toplam</div>
            <div id="analizYillikToplamGoster" style="font-size:24px; font-weight:700; color:var(--brand)">0 â‚º</div>
          </div>
        </div>
      </div>

      <div class="tablo-kart" style="padding:0">
        <table id="analizTable">
          <thead>
            <tr>
              <th style="text-align:left; padding-left:16px">Kategori</th>
              <th>Toplam</th>
              <th>Ã–denen</th>
              <th>Kalan</th>
            </tr>
          </thead>
          <tbody id="analizTableBody"></tbody>
          <tfoot>
            <tr style="background:var(--pill)">
              <td style="text-align:right; padding:12px 16px; font-weight:700" colspan="4" id="analizToplamSatir"></td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div style="margin-top:16px; padding:16px; background:var(--pill); border-radius:12px">
        <h4 style="margin:0 0 12px; font-size:16px">AylÄ±k DaÄŸÄ±lÄ±m</h4>
        <div id="analizAylikDagilim"></div>
      </div>

      <!-- Kategori Detay Analizi -->
      <div style="margin-top:20px; padding:16px; background:var(--card); border:1px solid var(--stroke); border-radius:12px">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px">
          <h4 style="margin:0; font-size:16px">Kategori Detay Analizi</h4>
          <select id="analizKategoriSelect" style="padding:8px 12px; border:1px solid var(--stroke); border-radius:8px; background:var(--pill); color:var(--text); font-weight:600; font-size:14px; min-width:150px">
            <option value="">Kategori seÃ§in</option>
            <option value="tum">TÃ¼m Kategoriler</option>
            <option value="hediye">Hediye</option>
            <option value="kira">Kira</option>
            <option value="cocuk">Ã‡ocuk</option>
            <option value="yol">Yol</option>
            <option value="haberlesme">HaberleÅŸme</option>
            <option value="ikramiye">Ä°kramiye</option>
            <option value="yakacak">Yakacak</option>
            <option value="elbise">Elbise</option>
            <option value="ssk">SSK</option>
          </select>
        </div>

        <div id="kategoriDetayArea" style="display:none">
          <!-- Tek Kategori Ä°Ã§in -->
          <div id="tekKategoriDetay">
            <!-- Ã–zet Kartlar -->
            <div style="display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin-bottom:20px">
              <div style="background:linear-gradient(135deg, var(--brand)15, var(--brand2)15); border:1px solid var(--stroke); border-radius:10px; padding:12px">
                <div style="font-size:11px; color:var(--muted); font-weight:600; margin-bottom:6px">Toplam</div>
                <div id="kategoriToplam" style="font-size:20px; font-weight:700; color:var(--text)">0 â‚º</div>
              </div>
              <div style="background:#dcfce7; border:1px solid #86efac; border-radius:10px; padding:12px">
                <div style="font-size:11px; color:#166534; font-weight:600; margin-bottom:6px">Ã–denen</div>
                <div id="kategoriOdenen" style="font-size:20px; font-weight:700; color:#166534">0 â‚º</div>
              </div>
              <div style="background:#fee2e2; border:1px solid #fca5a5; border-radius:10px; padding:12px">
                <div style="font-size:11px; color:#991b1b; font-weight:600; margin-bottom:6px">Kalan</div>
                <div id="kategoriKalan" style="font-size:20px; font-weight:700; color:#991b1b">0 â‚º</div>
              </div>
              <div style="background:var(--pill); border:1px solid var(--stroke); border-radius:10px; padding:12px">
                <div style="font-size:11px; color:var(--muted); font-weight:600; margin-bottom:6px">Ã–deme %</div>
                <div id="kategoriYuzde" style="font-size:20px; font-weight:700; color:var(--brand)">0%</div>
              </div>
            </div>

            <!-- Grafik -->
            <div style="margin-bottom:20px">
              <canvas id="kategoriChart" style="max-height:300px"></canvas>
            </div>

            <!-- AylÄ±k Detay Tablosu -->
            <div class="tablo-kart" style="padding:0">
              <table id="kategoriDetayTable">
                <thead>
                  <tr>
                    <th style="text-align:left; padding-left:16px">Ay</th>
                    <th>Toplam</th>
                    <th>Ã–denen</th>
                    <th>Kalan</th>
                    <th>Durum</th>
                  </tr>
                </thead>
                <tbody id="kategoriDetayTableBody"></tbody>
              </table>
            </div>
          </div>
          
          <!-- TÃ¼m Kategoriler Ä°Ã§in -->
          <div id="tumKategorilerDetay" style="display:none"></div>
        </div>

        <div id="kategoriDetayEmpty" style="text-align:center; padding:40px; color:var(--muted); display:block">
          <div style="font-size:48px; margin-bottom:12px">ğŸ“ˆ</div>
          <div style="font-size:14px; font-weight:600">Kategori seÃ§in</div>
          <div style="font-size:12px; margin-top:6px">DetaylÄ± analiz iÃ§in bir kategori seÃ§in</div>
        </div>
      </div>
    </div>

    <div id="analizEmptyState" style="text-align:center; padding:40px; color:var(--muted)">
      <div style="font-size:48px; margin-bottom:12px">ğŸ“Š</div>
      <div style="font-size:16px; font-weight:600">YÄ±l seÃ§in</div>
      <div style="font-size:13px; margin-top:6px">Analiz iÃ§in bir yÄ±l seÃ§in</div>
    </div>

    <div class="modal-buttons" style="margin-top:20px; border-top:1px solid var(--stroke); padding-top:16px">
      <button class="btn-ghost" onclick="closeModals()">Kapat</button>
      <button class="cta" id="btnAnalizPDF" onclick="exportAnalizPDF()" style="display:none">ğŸ“„ PDF Ä°ndir</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  /* Tarih */
  (function(){
    const d=new Date(); const days=['Pazar','Pazartesi','SalÄ±','Ã‡arÅŸamba','PerÅŸembe','Cuma','Cumartesi'];
    document.getElementById('todayText').textContent=`${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()} â€¢ ${days[d.getDay()]}`;
  })();

  /* Firebase & helpers */
  const db=firebase.firestore(), auth=firebase.auth();
  const monthsTR=["Ocak","Åubat","Mart","Nisan","MayÄ±s","Haziran","Temmuz","AÄŸustos","EylÃ¼l","Ekim","KasÄ±m","AralÄ±k"];
  const KATEGORILER = ["hediye","kira","cocuk","yol","haberlesme","ikramiye","yakacak","elbise","ssk"]; // SÄ±ralÄ± kategori listesi
  const fmt=(n)=> (Number(n||0)).toLocaleString("tr-TR",{minimumFractionDigits:2, maximumFractionDigits:2}) + " â‚º";
  const norm = (s) => String(s||'')
  .normalize('NFD').replace(/[\u0300-\u036f]/g,'') // diakritik temizle
  .toLowerCase().trim();
  function toast(msg){const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); clearTimeout(window.__to); window.__to=setTimeout(()=>t.classList.remove('show'),2500);}
  function closeModals(){
    ['ekleModal','odemeModal','copyModal','bulkModal','personelManageModal','analizModal'].forEach(id=>{
      const el=document.getElementById(id); 
      if(el) el.style.display='none';
    });
    // Body scroll'unu geri aÃ§
    document.body.classList.remove('modal-open');
    document.body.style.overflow = '';
    document.body.style.position = '';
    document.body.style.width = '';
  }
  
  function openModal(modalId) {
    const modal = document.getElementById(modalId);
    if(modal) {
      modal.style.display = 'flex';
      // Body scroll'unu engelle
      document.body.classList.add('modal-open');
      document.body.style.overflow = 'hidden';
      document.body.style.position = 'fixed';
      document.body.style.width = '100%';
      
      // ESC tuÅŸu ile kapatma
      const escHandler = (e) => {
        if(e.key === 'Escape') {
          closeModals();
          document.removeEventListener('keydown', escHandler);
        }
      };
      document.addEventListener('keydown', escHandler);
      
      // Modal dÄ±ÅŸÄ±na tÄ±klayÄ±nca kapatma
      const clickHandler = (e) => {
        if(e.target === modal) {
          closeModals();
          modal.removeEventListener('click', clickHandler);
        }
      };
      modal.addEventListener('click', clickHandler);
    }
  }

  function normalizeUrl(u){
    if(!u || u === '#') return '#';
    // HTTP/HTTPS URL'leri olduÄŸu gibi bÄ±rak
    if(/^https?:\/\//i.test(u)) return u;
    if(u.startsWith('//')) return u;
    // Zaten relative path'ler (../ veya ./ ile baÅŸlayan) olduÄŸu gibi bÄ±rak
    if(u.startsWith('../') || u.startsWith('./')) return u;
    
    // Mevcut dosyanÄ±n konumuna gÃ¶re relative hale getir
    const currentPath = location.pathname;
    const currentDir = currentPath.substring(0, currentPath.lastIndexOf('/'));
    // Mevcut dizin seviyesini hesapla (kaÃ§ seviye yukarÄ± Ã§Ä±kmalÄ±yÄ±z)
    const currentDepth = currentDir.split('/').filter(x => x).length;
    
    // Root'a dÃ¶nmek iÃ§in ../ sayÄ±sÄ±
    const upLevels = currentDepth > 0 ? '../'.repeat(currentDepth) : '';
    
    // Path'i temizle: / ile baÅŸlÄ±yorsa kaldÄ±r, yoksa olduÄŸu gibi kullan
    const targetPath = u.startsWith('/') ? u.substring(1) : u;
    
    return upLevels + targetPath;
  }

  /* MenÃ¼ (manifest â€“ linki olduÄŸu gibi kullan) */
  let CURRENT_ALLOW=new Set(), CURRENT_DENY=new Set();
  async function fetchPanels(allowSet, denySet){
    const res=[];
    try{
      const snap=await db.collection('sayfa_manifesti').get();
      snap.forEach(doc=>{
        const d=doc.data()||{}, id=doc.id, panelTitle=d.title||id;
        const panelGrant = allowSet.has(norm(id)) || allowSet.has(norm(panelTitle));
        let pages = Array.isArray(d.pages)? d.pages : [];
        pages = pages.filter(pg=>{
          const keyNorm=norm(pg.key||pg.title||'');
          const pageGrant=allowSet.has(keyNorm), denied=denySet.has(keyNorm);
          return !denied && (panelGrant || pageGrant);
        }).map(pg=>({ baslik: pg.title||pg.key||'Sayfa', url: normalizeUrl(pg.path||'#'), key: pg.key||pg.title||'', sira: typeof pg.order==='number'? pg.order:9999 }))
          .sort((a,b)=>a.sira-b.sira);
        if(pages.length) res.push({ id, baslik:panelTitle, sira: typeof d.order==='number'? d.order:9999, pages });
      });
      res.sort((a,b)=>a.sira-b.sira);
    }catch(e){ console.error(e); toast('MenÃ¼ manifesti yÃ¼klenemedi.'); }
    return res;
  }
  function renderNav(panels){
    const ul=document.getElementById('navMain'), drawer=document.getElementById('drawer');
    ul.innerHTML=''; drawer.innerHTML='';
    if(!panels.length){
      ul.innerHTML='<li class="nav-item"><div class="nav-btn">HiÃ§ panel yok</div></li>';
      drawer.innerHTML='<div style="color:var(--muted);padding:8px">HiÃ§ panel bulunamadÄ±</div>';
      return;
    }
    panels.forEach(p=>{
      const li=document.createElement('li'); li.className='nav-item';
      li.innerHTML=`<div class="nav-btn">${p.baslik} <span class="caret">â–¾</span></div>`;
      const dd=document.createElement('div'); dd.className='dropdown';
      (p.pages||[]).forEach(pg=>{
        const a=document.createElement('a');
        const url = normalizeUrl(pg.url || pg.path || '#');
        a.href = url;
        a.textContent = pg.baslik;
        a.dataset.key=pg.key||pg.baslik; a.dataset.panel=p.id; a.dataset.panelTitle=p.baslik;
        dd.appendChild(a);
      });
      li.appendChild(dd);
      li.querySelector('.nav-btn').addEventListener('click',(e)=>{
        e.stopPropagation();
        ul.querySelectorAll('.nav-item').forEach(x=>{ if(x!==li) x.classList.remove('open'); });
        li.classList.toggle('open');
      });
      ul.appendChild(li);

      // drawer
      const h=document.createElement('div'); h.className='panel-title'; h.textContent=p.baslik; drawer.appendChild(h);
      (p.pages||[]).forEach(pg=>{
        const a=document.createElement('a');
        const url = normalizeUrl(pg.url || pg.path || '#');
        a.href = url;
        a.textContent = pg.baslik;
        a.dataset.key=pg.key||pg.baslik; a.dataset.panel=p.id; a.dataset.panelTitle=p.baslik;
        drawer.appendChild(a);
      });
    });
    document.addEventListener('click',(e)=>{ if(!ul.contains(e.target)) ul.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('open')); });
  }
  (function(){ const hamb=document.getElementById('hamburger'), drawer=document.getElementById('drawer'); if(!hamb) return; hamb.addEventListener('click',()=>drawer.classList.toggle('open')); document.addEventListener('click',(e)=>{ if(!drawer.contains(e.target) && !hamb.contains(e.target)) drawer.classList.remove('open'); }); })();

  // Link guard
  document.addEventListener('click',(e)=>{
    const a=e.target.closest('a[data-key]'); if(!a) return;
    const key=norm(a.dataset.key), pnl=norm(a.dataset.panel||''), pnlTitle=norm(a.dataset.panelTitle||'');
    if(CURRENT_DENY.has(key)){ e.preventDefault(); toast('Bu sayfa iÃ§in yetkiniz yok.'); return; }
    const allowed = CURRENT_ALLOW.has(key) || CURRENT_ALLOW.has(pnl) || CURRENT_ALLOW.has(pnlTitle);
    if(!allowed){ e.preventDefault(); toast('Bu sayfa iÃ§in yetkiniz yok.'); }
  });

  // Bildirim/Profil dropdown
  (function(){
    const notifBtn=document.getElementById('btnNotif'), notifDD=document.getElementById('notifDropdown');
    const profBtn=document.getElementById('btnProfile'), profDD=document.getElementById('profDropdown');
    function closeAll(e){
      if(!notifDD.contains(e.target) && e.target!==notifBtn) notifDD.parentElement.classList.remove('open');
      if(!profDD.contains(e.target)  && e.target!==profBtn)  profDD.parentElement.classList.remove('open');
    }
    document.addEventListener('click', closeAll);
    notifBtn?.addEventListener('click',(e)=>{ e.stopPropagation(); notifDD.parentElement.classList.toggle('open'); profDD.parentElement.classList.remove('open'); });
    profBtn ?.addEventListener('click',(e)=>{ e.stopPropagation(); profDD.parentElement.classList.toggle('open'); notifDD.parentElement.classList.remove('open'); });
document.getElementById('btnLogout')?.addEventListener('click', async (e) => {
  e.preventDefault();
  try {
    await auth.signOut();
    location.assign('/index.html');   // kÃ¶kten yÃ¶nlendir
  } catch (err) {
    console.error(err);
    toast('Ã‡Ä±kÄ±ÅŸ yapÄ±lamadÄ±');
  }
});
  })();

  /* ===== Sayfa verileri ===== */
  let CACHE_ROWS = [];   // SeÃ§ili Ay/YÄ±l'Ä±n tamamÄ± (tek sorgu)
  let LAST_ROWS  = [];   // Arama filtresi sonrasÄ± ekranda gÃ¶rÃ¼nen
  let SORT_COL = null;   // Aktif sÄ±ralama kolonu
  let SORT_DIR = 'asc';  // SÄ±ralama yÃ¶nÃ¼: 'asc' veya 'desc'
  let IS_ADMIN = false;  // Yetkili kullanÄ±cÄ± kontrolÃ¼

  const aktifKoleksiyon="personel_odeme";
  const aySec=document.getElementById("aySec"), yilSec=document.getElementById("yilSec");
  const searchInput=document.getElementById("searchInput");
  const btnAdd=document.getElementById("btnAdd"), btnCopy=document.getElementById("btnCopy");
  const btnBulkManage=document.getElementById("btnBulkManage");
  const btnBulkOkModal=document.getElementById("btnBulkOkModal"), btnBulkNoModal=document.getElementById("btnBulkNoModal");

  // Select doldurma
  (function(){
    const bugun=new Date(), sy=bugun.getFullYear()-3, ey=bugun.getFullYear()+5;
    monthsTR.forEach((m,i)=> aySec.add(new Option(m,i+1)));
    for(let y=sy;y<=ey;y++) yilSec.add(new Option(y,y));
    aySec.value=bugun.getMonth()+1; yilSec.value=bugun.getFullYear();
  })();

  // Ekle modal selectleri + copy modal selectleri
  const ayInput=document.getElementById("ayInput"), yilInput=document.getElementById("yilInput");
  const srcAy=document.getElementById("srcAy"), srcYil=document.getElementById("srcYil");
  const dstAy=document.getElementById("dstAy"), dstYil=document.getElementById("dstYil");
  (function(){
    const bugun=new Date(), sy=bugun.getFullYear()-3, ey=bugun.getFullYear()+5;
    monthsTR.forEach((m,i)=>{ ayInput.add(new Option(m,i+1)); srcAy.add(new Option(m,i+1)); dstAy.add(new Option(m,i+1)); });
    for(let y=sy;y<=ey;y++){ yilInput.add(new Option(y,y)); srcYil.add(new Option(y,y)); dstYil.add(new Option(y,y)); }
    ayInput.value=bugun.getMonth()+1; yilInput.value=bugun.getFullYear();
    srcAy.value=aySec.value; srcYil.value=yilSec.value;
    const next=new Date(bugun.getFullYear(), bugun.getMonth()+1, 1);
    dstAy.value=String(next.getMonth()+1); dstYil.value=String(next.getFullYear());
  })();

  srcAy.addEventListener('change', loadCopyPreview);
  srcYil.addEventListener('change', loadCopyPreview);

  // Modallar - Yetki kontrolÃ¼ ile
  btnAdd.onclick=()=> {
    if(!IS_ADMIN) { toast('Bu iÅŸlem iÃ§in yetkiniz yok.'); return; }
    openModal("ekleModal");
  };
  btnCopy.onclick=async ()=> {
    if(!IS_ADMIN) { toast('Bu iÅŸlem iÃ§in yetkiniz yok.'); return; }
    await loadCopyPreview(); 
    openModal("copyModal"); 
  };
  btnBulkManage.onclick=()=> {
    if(!IS_ADMIN) { toast('Bu iÅŸlem iÃ§in yetkiniz yok.'); return; }
    openModal("bulkModal"); 
  };
  document.getElementById("btnPersonelManage").onclick=async ()=> {
    if(!IS_ADMIN) { toast('Bu iÅŸlem iÃ§in yetkiniz yok.'); return; }
    await openPersonelManageModal(); 
  };
  document.getElementById("btnAnaliz").onclick=async ()=>{ await openAnalizModal(); };

  async function loadCopyPreview(){
    const sa=Number(srcAy.value), sy=Number(srcYil.value);
    const body=document.getElementById("copyPreviewBody"); body.innerHTML="";
    const snap=await db.collection(aktifKoleksiyon).where("ay","==",sa).where("yil","==",sy).get();
    if(snap.empty){ body.innerHTML='<tr><td colspan="3" class="muted" style="text-align:center;padding:12px">KayÄ±t yok</td></tr>'; return; }
    snap.forEach(doc=>{
      const d=doc.data()||{};
      const odSay=KATEGORILER.reduce((c,k)=> c + (d.odemeler?.[k]?1:0), 0);
      const tr=document.createElement('tr');
      tr.innerHTML=`<td style="text-align:left">${d.ad||'-'}</td><td>${fmt(d.toplam||0)}</td><td>${odSay}</td>`;
      body.appendChild(tr);
    });
  }
  document.getElementById("btnDoCopy").onclick=async ()=>{
    const sa=Number(srcAy.value), sy=Number(srcYil.value);
    const da=Number(dstAy.value), dy=Number(dstYil.value);
    const overwrite=document.getElementById("overwriteChk").checked;
    if(sa===da && sy===dy){ toast("Kaynak ve hedef aynÄ± olamaz."); return; }

    const srcSnap=await db.collection(aktifKoleksiyon).where("ay","==",sa).where("yil","==",sy).get();
    if(srcSnap.empty){ toast("Kaynakta kayÄ±t yok."); return; }

    const dstSnap=await db.collection(aktifKoleksiyon).where("ay","==",da).where("yil","==",dy).get();
    const existingByName=new Map(); dstSnap.forEach(doc=> existingByName.set(norm(doc.data().ad||''), doc.id));

    const batch=db.batch(); let copied=0, skipped=0, overwritten=0;
    srcSnap.forEach(doc=>{
      const d=doc.data()||{}; const key=norm(d.ad||'');
      const payload = {
        ad: d.ad || '',
        ay: da,
        yil: dy,
        hediye: +(d.hediye || 0),
        kira: +(d.kira || 0),
        cocuk: +(d.cocuk || 0),
        ssk: +(d.ssk || 0),
        yol: +(d.yol || 0),
        haberlesme: +(d.haberlesme || 0),
        odemeler: {
          hediye: false,
          kira: false,
          cocuk: false,
          yol: false,
          haberlesme: false,
          ikramiye: false,
          yakacak: false,
          elbise: false,
          ssk: false
        },
        maas: "Ã¶denmedi",
        toplam: KATEGORILER.reduce((sum, k) => sum + (+(d[k] || 0)), 0),
        tarih: new Date()
      };    
      if(existingByName.has(key)){
        if(overwrite){ batch.set(db.collection(aktifKoleksiyon).doc(existingByName.get(key)), payload, {merge:false}); overwritten++; }
        else skipped++;
      }else{ batch.set(db.collection(aktifKoleksiyon).doc(), payload); copied++; }
    });
    await batch.commit();
    closeModals();
    toast(`Kopya tamam: ${copied}${overwrite?`, Ã¼zerine yazÄ±lan: ${overwritten}`:''}${skipped?`, atlanan: ${skipped}`:''}`);
    aySec.value=da; yilSec.value=dy; await listele();
  };

  // Ekle â€“ tek kayÄ±t
  async function kaydetEkle(){
    const veri={
      ad:(document.getElementById("adInput").value||"").trim(),
      ay:+document.getElementById("ayInput").value, 
      yil:+document.getElementById("yilInput").value,
      hediye:+document.getElementById("hediyeInput").value||0, 
      kira:+document.getElementById("kiraInput").value||0,
      cocuk:+document.getElementById("cocukInput").value||0, 
      yol:+document.getElementById("yolInput").value||0,
      haberlesme:+document.getElementById("haberInput").value||0, 
      ikramiye:+document.getElementById("ikramiyeInput").value||0,
      yakacak:+document.getElementById("yakacakInput").value||0, 
      elbise:+document.getElementById("elbiseInput").value||0,
      ssk:+document.getElementById("sskInput").value||0,
      maas:"Ã¶denmedi",
      odemeler:{hediye:false,kira:false,cocuk:false,yol:false,haberlesme:false,ikramiye:false,yakacak:false,elbise:false,ssk:false},
      tarih:new Date()
    };
    veri.toplam = KATEGORILER.reduce((sum, k) => sum + (veri[k] || 0), 0);
    if(!veri.ad){ toast("Ad Soyad boÅŸ olamaz."); return; }
    try{ await db.collection(aktifKoleksiyon).add(veri); closeModals(); toast("Tahakkuk oluÅŸturuldu."); listele(); }
    catch(e){ console.error(e); toast("KayÄ±t baÅŸarÄ±sÄ±z."); }
  }

  // Listele + filtre
  function filterByName(d){ const q=norm(searchInput.value); return !q || norm(d.ad||'').includes(q); }

function applySearch() {
  const q = norm(searchInput.value);
  LAST_ROWS = CACHE_ROWS.filter(d => !q || norm(d.ad||'').includes(q));
  applySort();
}

function applySort() {
  if(!SORT_COL) return;
  LAST_ROWS.sort((a, b) => {
    let valA, valB;
    if(SORT_COL === 'ad') {
      valA = (a.ad || '').toLowerCase();
      valB = (b.ad || '').toLowerCase();
    } else if(SORT_COL === 'maas') {
      valA = a.maas === 'Ã¶dendi' ? 1 : 0;
      valB = b.maas === 'Ã¶dendi' ? 1 : 0;
    } else if(SORT_COL === 'kalan') {
      // Kalan hesapla
      const calcKalan = (d) => {
        let kalan = 0;
        KATEGORILER.forEach(k => {
          const tutar = +(d[k] || 0);
          if(tutar > 0 && !d.odemeler?.[k]) kalan += tutar;
        });
        return kalan;
      };
      valA = calcKalan(a);
      valB = calcKalan(b);
    } else {
      valA = +(a[SORT_COL] || 0);
      valB = +(b[SORT_COL] || 0);
    }
    if(valA < valB) return SORT_DIR === 'asc' ? -1 : 1;
    if(valA > valB) return SORT_DIR === 'asc' ? 1 : -1;
    return 0;
  });
}

function renderTableAndSummary(rows) {
  const tbody = document.getElementById("listeAlani");
  const mobileCards = document.getElementById("mobileCards");
  tbody.innerHTML = "";
  mobileCards.innerHTML = "";

  let ozet = {};
  KATEGORILER.forEach(k => { ozet[k] = {toplam:0,odenen:0}; });
  let genelKalan = 0;

  const fmt=(n)=> (Number(n||0)).toLocaleString("tr-TR",{minimumFractionDigits:2, maximumFractionDigits:2}) + " â‚º";
  const cell=(val,ok)=> Number(val||0)===0
    ? `<td class="muted" style="opacity:0.4; font-size:12px">â€”</td>`
    : `<td>${ ok ? `<span class="chip ok">${fmt(val)}</span>` : `<span class="chip no">${fmt(val)}</span>` }</td>`;

  rows.forEach(d=>{
    // Kalan hesapla
    let kalanTutar = 0;
    KATEGORILER.forEach(k => {
      const tutar = +(d[k] || 0);
      if(tutar > 0 && !d.odemeler?.[k]) {
        kalanTutar += tutar;
      }
    });
    
    // Desktop table row
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td style="text-align:left;font-weight:600; color:#0f172a; font-size:13px">${d.ad||'-'}</td>
      ${KATEGORILER.map(k => cell(d[k], d.odemeler?.[k])).join('')}
      <td>${ d.maas==='Ã¶dendi' ? '<span class="chip ok">Ã–dendi</span>' : '<span class="chip no">Ã–denmedi</span>' }</td>
      <td style="font-weight:700; color:#2563eb; font-size:13px">${fmt(d.toplam||0)}</td>
      <td style="font-weight:700; color:${kalanTutar > 0 ? '#dc2626' : '#16a34a'}; font-size:13px">${fmt(kalanTutar)}</td>
    `;
    // Sadece admin iÃ§in tÄ±klanabilir
    if(IS_ADMIN) {
      tr.style.cursor='pointer';
      tr.onclick=()=> openOdeme(d.id, d);
    } else {
      tr.style.cursor='default';
    }
    tbody.appendChild(tr);

    // Mobile card
    const card = document.createElement('div');
    card.className = 'person-card';
    // Sadece admin iÃ§in tÄ±klanabilir
    if(IS_ADMIN) {
      card.style.cursor = 'pointer';
      card.onclick = () => openOdeme(d.id, d);
    } else {
      card.style.cursor = 'default';
    }
    const cellValue = (val, ok) => {
      if(Number(val||0) === 0) return '<span class="muted">-</span>';
      return ok ? `<span class="chip ok">${fmt(val)}</span>` : `<span class="chip no">${fmt(val)}</span>`;
    };
    const kategoriLabels = {hediye:'Hediye',kira:'Kira',cocuk:'Ã‡ocuk',yol:'Yol',haberlesme:'HaberleÅŸme',ikramiye:'Ä°kramiye',yakacak:'Yakacak',elbise:'Elbise',ssk:'SSK'};
    const kategoriRows = [];
    for(let i=0; i<KATEGORILER.length; i+=2) {
      const k1 = KATEGORILER[i];
      const k2 = KATEGORILER[i+1];
      kategoriRows.push(`
        <div class="person-card-row">
          <div><div class="person-card-label">${kategoriLabels[k1]}</div><div class="person-card-value">${cellValue(d[k1], d.odemeler?.[k1])}</div></div>
          ${k2 ? `<div><div class="person-card-label">${kategoriLabels[k2]}</div><div class="person-card-value">${cellValue(d[k2], d.odemeler?.[k2])}</div></div>` : '<div></div>'}
        </div>
      `);
    }
    card.innerHTML = `
      <div class="person-card-header">
        <h3>${d.ad||'-'}</h3>
      </div>
      ${kategoriRows.join('')}
      <div class="person-card-row">
        <div><div class="person-card-label">ResmÃ® MaaÅŸ</div><div class="person-card-value">${d.maas==='Ã¶dendi' ? '<span class="chip ok">Ã–dendi</span>' : '<span class="chip no">Ã–denmedi</span>'}</div></div>
      </div>
      <div class="person-card-row">
        <div><div class="person-card-label">Toplam</div><div class="person-card-value">${fmt(d.toplam||0)}</div></div>
        <div><div class="person-card-label">Kalan</div><div class="person-card-value" style="color:${kalanTutar > 0 ? 'var(--danger)' : 'var(--success)'}">${fmt(kalanTutar)}</div></div>
      </div>
    `;
    mobileCards.appendChild(card);

    for(const k of Object.keys(ozet)){
      ozet[k].toplam += +(d[k]||0);
      if(d.odemeler?.[k]) ozet[k].odenen += +(d[k]||0);
    }
  });

  const ozetAlani=document.getElementById("ozetAlani");
  const mobileSummaryCards=document.getElementById("mobileSummaryCards");
  const ozetTarihBilgisi=document.getElementById("ozetTarihBilgisi");
  const ay = +aySec.value, yil = +yilSec.value;
  const ayAdi = monthsTR[ay - 1] || '';
  
  // Tarih bilgisini gÃ¼ncelle
  ozetTarihBilgisi.textContent = `${ayAdi} ${yil}`;
  
  ozetAlani.innerHTML="";
  mobileSummaryCards.innerHTML="";
  
  let toplamBorÃ§ = 0, toplamÃ–denen = 0;
  
  Object.entries(ozet).forEach(([k,{toplam,odenen}])=>{
    const kalan = (+(toplam||0) - +(odenen||0)); 
    genelKalan+=kalan;
    toplamBorÃ§ += +(toplam||0);
    toplamÃ–denen += +(odenen||0);
    
    // Desktop table
    const tr=document.createElement('tr');
    tr.innerHTML=`<td style="text-transform:capitalize">${k}</td><td>${fmt(toplam)}</td><td>${fmt(odenen)}</td><td>${fmt(kalan)}</td>`;
    ozetAlani.appendChild(tr);
    
    // Mobile card
    const card=document.createElement('div');
    card.className='summary-card';
    card.innerHTML=`
      <div class="summary-card-label">${k}</div>
      <div class="summary-card-value">${fmt(toplam)}</div>
      <div style="font-size:12px; color:var(--muted); margin-bottom:4px">Ã–denen: ${fmt(odenen)}</div>
      <div class="summary-card-kalan">Kalan: ${fmt(kalan)}</div>
    `;
    mobileSummaryCards.appendChild(card);
  });
  
  // Toplam satÄ±rÄ± - Desktop
  const ozetToplamSatir = document.getElementById("ozetToplamSatir");
  ozetToplamSatir.innerHTML = `
    <strong>Toplam BorÃ§: ${fmt(toplamBorÃ§)}</strong> + 
    <strong style="color:var(--success)">Ã–denen: ${fmt(toplamÃ–denen)}</strong> + 
    <strong style="color:var(--danger)">Kalan: ${fmt(genelKalan)}</strong>
  `;
  
  // Total card - Mobile
  const totalCard=document.createElement('div');
  totalCard.className='summary-card summary-card-total';
  totalCard.innerHTML=`
    <div class="summary-card-label">Toplam BorÃ§</div>
    <div class="summary-card-value">${fmt(toplamBorÃ§)}</div>
    <div style="margin-top:8px; padding-top:8px; border-top:1px solid var(--stroke)">
      <div style="font-size:13px; margin-bottom:4px"><strong style="color:var(--success)">Ã–denen: ${fmt(toplamÃ–denen)}</strong></div>
      <div style="font-size:13px"><strong style="color:var(--danger)">Kalan: ${fmt(genelKalan)}</strong></div>
    </div>
  `;
  mobileSummaryCards.appendChild(totalCard);
}

async function listele() {
  const ay = +aySec.value, yil = +yilSec.value;

  // Firestore: yalnÄ±zca Ay/YÄ±l DEÄÄ°ÅTÄ°ÄÄ°NDE Ã§aÄŸrÄ±lmalÄ±
  const snap = await db.collection(aktifKoleksiyon)
    .where("ay","==",ay).where("yil","==",yil).get();

  CACHE_ROWS = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  applySearch();                   // arama kutusundaki mevcut deÄŸere gÃ¶re filtrele
  renderTableAndSummary(LAST_ROWS);
}

  // SÄ±ralama
  document.querySelectorAll('th.sortable').forEach(th => {
    th.addEventListener('click', () => {
      const col = th.dataset.sort;
      if(SORT_COL === col) {
        SORT_DIR = SORT_DIR === 'asc' ? 'desc' : 'asc';
      } else {
        SORT_COL = col;
        SORT_DIR = 'asc';
      }
      // SÄ±ralama iÅŸaretlerini gÃ¼ncelle
      document.querySelectorAll('th.sortable').forEach(t => {
        t.classList.remove('sort-asc', 'sort-desc');
      });
      th.classList.add(SORT_DIR === 'asc' ? 'sort-asc' : 'sort-desc');
      applySort();
      renderTableAndSummary(LAST_ROWS);
    });
  });

  // Arama debounce
  let sTO=null;
  searchInput.addEventListener('input', ()=>{
    clearTimeout(sTO);
    sTO = setTimeout(()=>{
      applySearch();                    // uzak sorgu yok
      renderTableAndSummary(LAST_ROWS); // sadece yerelde filtre
    }, 120);
  });
  aySec.onchange = yilSec.onchange = listele;

  // Toplu set
  async function bulkSet(paid){
    if(!LAST_ROWS.length){ toast("Ä°ÅŸaretlenecek kayÄ±t yok."); return; }
    const cat=document.getElementById("bulkKategoriModal").value;
    const batch=db.batch();
    if(cat==="maas"){
      LAST_ROWS.forEach(r=> batch.update(db.collection(aktifKoleksiyon).doc(r.id), { maas: paid ? "Ã¶dendi":"Ã¶denmedi" }));
    }else{
      LAST_ROWS.forEach(r=> batch.update(db.collection(aktifKoleksiyon).doc(r.id), { [`odemeler.${cat}`]: !!paid }));
    }
    await batch.commit(); 
    closeModals();
    toast(`Toplu gÃ¼ncellendi: ${LAST_ROWS.length} kayÄ±t`); 
    listele();
  }
  btnBulkOkModal.onclick=()=>bulkSet(true);
  btnBulkNoModal.onclick=()=>bulkSet(false);

  // Ã–deme modal
  let aktifID=null, aktifVeri=null, editMode=false;
  function openOdeme(id, veri){
    if(!IS_ADMIN) {
      toast('Bu iÅŸlem iÃ§in yetkiniz yok.');
      return;
    }
    aktifID=id;
    aktifVeri=veri;
    editMode=false;
    const ayAdi = monthsTR[veri.ay - 1] || veri.ay;
    document.getElementById("odemeModalBaslik").textContent=`${veri.ad||'-'} (${String(veri.ay).padStart(2,'0')}/${veri.yil})`;
    
    // UyarÄ± kontrolÃ¼
    const uyariAlani = document.getElementById("odemeUyariAlani");
    const odemelerYapildi = KATEGORILER.some(k => veri.odemeler?.[k]) || veri.maas==="Ã¶dendi";
    if(odemelerYapildi) {
      const kategoriLabels = {hediye:'Hediye',kira:'Kira',cocuk:'Ã‡ocuk',yol:'Yol',haberlesme:'HaberleÅŸme',ikramiye:'Ä°kramiye',yakacak:'Yakacak',elbise:'Elbise',ssk:'SSK'};
      const odenenKategoriler = [];
      KATEGORILER.forEach(k => {
        if(veri.odemeler?.[k]) odenenKategoriler.push(kategoriLabels[k]);
      });
      if(veri.maas==="Ã¶dendi") odenenKategoriler.push("ResmÃ® MaaÅŸ");
      uyariAlani.innerHTML = `âš ï¸ <strong>${veri.ad}</strong> personelinin ${ayAdi} ${veri.yil} ayÄ±ndaki ${odenenKategoriler.join(", ")} Ã¶denmiÅŸ.`;
      uyariAlani.style.display = "block";
    } else {
      uyariAlani.style.display = "none";
    }
    
    const div=document.getElementById("odemeKategoriAlani"); div.innerHTML="";
    const disabledAttr = IS_ADMIN ? '' : 'disabled';
    KATEGORILER.forEach(key=>{
      div.innerHTML += `
        <label>${key.toUpperCase()}</label>
        <select id="odeme_${key}" ${disabledAttr}>
          <option value="true"  ${veri.odemeler?.[key] ? "selected":""}>Ã–dendi</option>
          <option value="false" ${!veri.odemeler?.[key] ? "selected":""}>Ã–denmedi</option>
        </select>`;
    });
    div.innerHTML += `
      <label>RESMÃ MAAÅ</label>
      <select id="odeme_maas" ${disabledAttr}>
        <option value="Ã¶dendi"   ${veri.maas==="Ã¶dendi" ? "selected":""}>Ã–dendi</option>
        <option value="Ã¶denmedi" ${veri.maas==="Ã¶denmedi" ? "selected":""}>Ã–denmedi</option>
      </select>`;
    
    // Tutar alanlarÄ±nÄ± doldur
    KATEGORILER.forEach(k => {
      const input = document.getElementById(`edit_${k}`);
      if(input) {
        input.value = veri[k] || 0;
        if(!IS_ADMIN) input.disabled = true;
      }
    });
    updateEditToplam();
    
    // Edit mode'u kapat
    document.getElementById("odemeTutarAlani").style.display = "none";
    const btnEdit = document.getElementById("btnEditTutarlar");
    const btnSil = document.getElementById("btnSilVeri");
    const btnKaydet = document.getElementById("btnKaydetOdeme");
    
    if(btnEdit) {
      btnEdit.textContent = "DÃ¼zenle";
      btnEdit.style.display = IS_ADMIN ? "inline-block" : "none";
    }
    if(btnSil) {
      btnSil.style.display = IS_ADMIN ? "inline-block" : "none";
    }
    if(btnKaydet) {
      btnKaydet.style.display = IS_ADMIN ? "inline-block" : "none";
    }
    
    // Event listener'larÄ± ekle (her modal aÃ§Ä±lÄ±ÅŸÄ±nda)
    setTimeout(() => {
      KATEGORILER.forEach(k => {
        const input = document.getElementById(`edit_${k}`);
        if(input) {
          input.removeEventListener('input', updateEditToplam);
          input.addEventListener('input', updateEditToplam);
        }
      });
    }, 100);
    
    openModal("odemeModal");
  }
  
  function toggleEditMode() {
    editMode = !editMode;
    const tutarAlani = document.getElementById("odemeTutarAlani");
    const btnEdit = document.getElementById("btnEditTutarlar");
    
    if(editMode) {
      tutarAlani.style.display = "block";
      btnEdit.textContent = "Ä°ptal";
    } else {
      tutarAlani.style.display = "none";
      btnEdit.textContent = "DÃ¼zenle";
      // Orijinal deÄŸerlere geri dÃ¶n
      if(aktifVeri) {
        KATEGORILER.forEach(k => {
          const input = document.getElementById(`edit_${k}`);
          if(input) input.value = aktifVeri[k] || 0;
        });
        updateEditToplam();
      }
    }
  }
  
  function updateEditToplam() {
    const toplam = KATEGORILER.reduce((sum, k) => {
      const input = document.getElementById(`edit_${k}`);
      return sum + (+(input?.value || 0));
    }, 0);
    document.getElementById("editToplamGoster").textContent = fmt(toplam);
  }
  
  // Tutar inputlarÄ±na event listener ekle (modal aÃ§Ä±ldÄ±ÄŸÄ±nda)
  // Bu fonksiyon openOdeme iÃ§inde Ã§aÄŸrÄ±lacak
  async function kaydetOdeme(){
    if(!IS_ADMIN) {
      toast('Bu iÅŸlem iÃ§in yetkiniz yok.');
      return;
    }
    const odemeler={}; 
    KATEGORILER.forEach(k=> odemeler[k] = document.getElementById(`odeme_${k}`)?.value==="true");
    const maas=document.getElementById("odeme_maas").value;
    
    const updateData = { odemeler, maas };
    
    // EÄŸer edit mode aktifse tutarlarÄ± da gÃ¼ncelle
    if(editMode) {
      const yeniTutarlar = {};
      KATEGORILER.forEach(k => {
        const input = document.getElementById(`edit_${k}`);
        yeniTutarlar[k] = +(input?.value || 0);
      });
      yeniTutarlar.toplam = KATEGORILER.reduce((sum, k) => sum + (yeniTutarlar[k] || 0), 0);
      Object.assign(updateData, yeniTutarlar);
    }
    
    try{ 
      await db.collection(aktifKoleksiyon).doc(aktifID).update(updateData); 
      closeModals(); 
      toast(editMode ? "Tutarlar ve Ã¶demeler gÃ¼ncellendi." : "Ã–demeler gÃ¼ncellendi."); 
      listele(); 
    }
    catch(e){ console.error(e); toast("GÃ¼ncelleme hata."); }
  }
  async function silVeri(){
    if(!IS_ADMIN) {
      toast('Bu iÅŸlem iÃ§in yetkiniz yok.');
      return;
    }
    if(!aktifID) return;
    if(confirm("Bu personel kaydÄ± silinsin mi?")){
      try{ await db.collection(aktifKoleksiyon).doc(aktifID).delete(); closeModals(); toast("KayÄ±t silindi."); listele(); }
      catch(e){ console.error(e); toast("Silme hata."); }
    }
  }

  // Personel YÃ¶netim Modal
  let personelManageData = {};
  
  async function openPersonelManageModal() {
    const modal = document.getElementById("personelManageModal");
    const personelSelect = document.getElementById("personelSelect");
    const yilSelect = document.getElementById("personelYilSelect");
    
    // Personel listesini yÃ¼kle
    try {
      const snap = await db.collection(aktifKoleksiyon).get();
      const personeller = new Set();
      snap.forEach(doc => {
        const d = doc.data();
        if(d.ad) personeller.add(d.ad);
      });
      
      personelSelect.innerHTML = '<option value="">Personel seÃ§in</option>';
      Array.from(personeller).sort().forEach(ad => {
        personelSelect.add(new Option(ad, ad));
      });
    } catch(e) {
      console.error(e);
      toast('Personel listesi yÃ¼klenemedi.');
    }
    
    // YÄ±l listesini doldur
    const bugun = new Date();
    const sy = bugun.getFullYear() - 5;
    const ey = bugun.getFullYear() + 1;
    yilSelect.innerHTML = '<option value="">YÄ±l seÃ§in</option>';
    for(let y = ey; y >= sy; y--) {
      yilSelect.add(new Option(y, y));
    }
    
    // Event listener'lar
    personelSelect.onchange = yilSelect.onchange = async () => {
      const personelAd = personelSelect.value;
      const yil = yilSelect.value;
      
      if(!personelAd || !yil) {
        document.getElementById("personelDataArea").style.display = "none";
        document.getElementById("personelEmptyState").style.display = "block";
        return;
      }
      
      await loadPersonelYilData(personelAd, +yil);
    };
    
    document.getElementById("personelDataArea").style.display = "none";
    document.getElementById("personelEmptyState").style.display = "block";
    openModal("personelManageModal");
  }
  
  async function loadPersonelYilData(personelAd, yil) {
    try {
      const snap = await db.collection(aktifKoleksiyon)
        .where("ad", "==", personelAd)
        .where("yil", "==", yil)
        .get();
      
      personelManageData = {};
      let yillikToplam = 0;
      
      snap.forEach(doc => {
        const d = doc.data();
        const ay = d.ay;
        personelManageData[ay] = {
          id: doc.id,
          ...d
        };
        yillikToplam += +(d.toplam || 0);
      });
      
      // UI gÃ¼ncelle
      document.getElementById("personelAdGoster").textContent = personelAd;
      document.getElementById("personelYilGoster").textContent = `${yil} YÄ±lÄ± - ${Object.keys(personelManageData).length} Ay`;
      document.getElementById("yillikToplamGoster").textContent = fmt(yillikToplam);
      
      renderPersonelAylar();
      
      document.getElementById("personelDataArea").style.display = "block";
      document.getElementById("personelEmptyState").style.display = "none";
      document.getElementById("btnPersonelKaydet").style.display = "inline-block";
    } catch(e) {
      console.error(e);
      toast('Veriler yÃ¼klenirken hata.');
    }
  }
  
  function renderPersonelAylar() {
    const container = document.getElementById("personelAylarListesi");
    container.innerHTML = "";
    
    const aylar = Object.keys(personelManageData).sort((a, b) => +a - +b);
    
    if(aylar.length === 0) {
      container.innerHTML = '<div style="text-align:center; padding:20px; color:var(--muted)">Bu yÄ±l iÃ§in kayÄ±t bulunamadÄ±.</div>';
      return;
    }
    
    aylar.forEach(ay => {
      const data = personelManageData[ay];
      const ayAdi = monthsTR[+ay - 1] || ay;
      
      const card = document.createElement('div');
      card.style.cssText = 'background:var(--card); border:1px solid var(--stroke); border-radius:12px; padding:16px; box-shadow:0 2px 8px rgba(0,0,0,.06)';
      
      card.innerHTML = `
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; padding-bottom:12px; border-bottom:1px solid var(--stroke)">
          <div>
            <h4 style="margin:0; font-size:16px; color:var(--text)">${ayAdi} ${data.yil}</h4>
            <div class="muted" style="font-size:12px; margin-top:4px">Toplam: <strong style="color:var(--brand)">${fmt(data.toplam || 0)}</strong></div>
          </div>
          <div style="text-align:right">
            <div style="font-size:11px; color:var(--muted); margin-bottom:4px">Kalan</div>
            <div style="font-size:18px; font-weight:700; color:var(--danger)">${fmt(calculateKalan(data))}</div>
          </div>
        </div>
        
        <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:10px; margin-bottom:12px">
          ${KATEGORILER.map(k => {
            const labels = {hediye:'Hediye',kira:'Kira',cocuk:'Ã‡ocuk',yol:'Yol',haberlesme:'HaberleÅŸme',ikramiye:'Ä°kramiye',yakacak:'Yakacak',elbise:'Elbise',ssk:'SSK'};
            return `
              <div>
                <label style="display:block; font-size:11px; color:var(--muted); margin-bottom:4px">${labels[k]}</label>
                <input type="number" data-ay="${ay}" data-field="${k}" value="${data[k] || 0}" min="0" step="0.01" 
                  style="width:100%; padding:6px 8px; border:1px solid var(--stroke); border-radius:6px; background:var(--pill); color:var(--text); font-size:13px">
              </div>
            `;
          }).join('')}
        </div>
        
        <div style="display:grid; grid-template-columns:repeat(2,1fr); gap:8px; margin-top:12px">
          <div>
            <label style="display:block; font-size:11px; color:var(--muted); margin-bottom:4px">Ã–deme DurumlarÄ±</label>
            <div style="display:flex; flex-wrap:wrap; gap:6px">
              ${KATEGORILER.map(k => {
                const labels = {hediye:'Hediye',kira:'Kira',cocuk:'Ã‡ocuk',yol:'Yol',haberlesme:'HaberleÅŸme',ikramiye:'Ä°kramiye',yakacak:'Yakacak',elbise:'Elbise',ssk:'SSK'};
                return `
                  <label style="display:flex; align-items:center; gap:4px; font-size:11px; cursor:pointer; padding:4px 8px; background:${data.odemeler?.[k] ? 'var(--success)22' : 'var(--pill)'}; border:1px solid ${data.odemeler?.[k] ? 'var(--success)' : 'var(--stroke)'}; border-radius:6px">
                    <input type="checkbox" data-ay="${ay}" data-field="${k}" ${data.odemeler?.[k] ? 'checked' : ''} style="cursor:pointer">
                    <span style="text-transform:capitalize; font-weight:600; color:${data.odemeler?.[k] ? 'var(--success)' : 'var(--text)'}">${labels[k]}</span>
                  </label>
                `;
              }).join('')}
            </div>
          </div>
          <div>
            <label style="display:block; font-size:11px; color:var(--muted); margin-bottom:4px">ResmÃ® MaaÅŸ</label>
            <select data-ay="${ay}" data-field="maas" style="width:100%; padding:6px 8px; border:1px solid var(--stroke); border-radius:6px; background:var(--pill); color:var(--text); font-size:13px">
              <option value="Ã¶denmedi" ${data.maas==='Ã¶denmedi' ? 'selected' : ''}>Ã–denmedi</option>
              <option value="Ã¶dendi" ${data.maas==='Ã¶dendi' ? 'selected' : ''}>Ã–dendi</option>
            </select>
          </div>
        </div>
      `;
      
      container.appendChild(card);
    });
    
    // Input deÄŸiÅŸikliklerinde toplam gÃ¼ncelle
    container.querySelectorAll('input[type="number"]').forEach(input => {
      input.addEventListener('input', () => {
        const ay = input.dataset.ay;
        updateAyToplam(ay);
      });
    });
  }
  
  function calculateKalan(data) {
    let kalan = 0;
    KATEGORILER.forEach(k => {
      const tutar = +(data[k] || 0);
      if(tutar > 0 && !data.odemeler?.[k]) kalan += tutar;
    });
    return kalan;
  }
  
  function updateAyToplam(ay) {
    const data = personelManageData[ay];
    if(!data) return;
    
    const inputs = document.querySelectorAll(`input[data-ay="${ay}"][data-field]`);
    let toplam = 0;
    inputs.forEach(input => {
      if(input.type === 'number') {
        const field = input.dataset.field;
        data[field] = +(input.value || 0);
        toplam += data[field];
      }
    });
    
    data.toplam = toplam;
    
    // UI'da toplamÄ± gÃ¼ncelle
    const card = document.querySelector(`input[data-ay="${ay}"]`)?.closest('div[style*="border-radius:12px"]');
    if(card) {
      const toplamEl = card.querySelector('strong[style*="color:var(--brand)"]');
      if(toplamEl) toplamEl.textContent = fmt(toplam);
      
      // Kalan hesapla ve gÃ¼ncelle
      const checkboxes = card.querySelectorAll('input[type="checkbox"]');
      checkboxes.forEach(cb => {
        const field = cb.dataset.field;
        data.odemeler = data.odemeler || {};
        data.odemeler[field] = cb.checked;
      });
      
      const kalanEl = card.querySelector('div[style*="color:var(--danger)"]');
      if(kalanEl) kalanEl.textContent = fmt(calculateKalan(data));
    }
    
    // YÄ±llÄ±k toplamÄ± gÃ¼ncelle
    let yillikToplam = 0;
    Object.keys(personelManageData).forEach(a => {
      yillikToplam += +(personelManageData[a].toplam || 0);
    });
    document.getElementById("yillikToplamGoster").textContent = fmt(yillikToplam);
  }
  
  async function kaydetPersonelYonetim() {
    if(Object.keys(personelManageData).length === 0) {
      toast('Kaydedilecek veri yok.');
      return;
    }
    
    try {
      const batch = db.batch();
      let updated = 0;
      
      Object.keys(personelManageData).forEach(ay => {
        const data = personelManageData[ay];
        const docRef = db.collection(aktifKoleksiyon).doc(data.id);
        
        // Checkbox'larÄ± gÃ¼ncelle
        const card = document.querySelector(`input[data-ay="${ay}"]`)?.closest('div[style*="border-radius:12px"]');
        if(card) {
          const checkboxes = card.querySelectorAll('input[type="checkbox"]');
          checkboxes.forEach(cb => {
            const field = cb.dataset.field;
            data.odemeler = data.odemeler || {};
            data.odemeler[field] = cb.checked;
          });
          
          const maasSelect = card.querySelector('select[data-field="maas"]');
          if(maasSelect) data.maas = maasSelect.value;
        }
        
        // ToplamÄ± hesapla
        data.toplam = KATEGORILER.reduce((sum, k) => sum + (+(data[k] || 0)), 0);
        
        const updateObj = { toplam: data.toplam, odemeler: data.odemeler || {}, maas: data.maas || 'Ã¶denmedi' };
        KATEGORILER.forEach(k => {
          updateObj[k] = +(data[k] || 0);
        });
        
        batch.update(docRef, updateObj);
        updated++;
      });
      
      await batch.commit();
      closeModals();
      toast(`${updated} ay verisi gÃ¼ncellendi.`);
      listele();
    } catch(e) {
      console.error(e);
      toast('KayÄ±t sÄ±rasÄ±nda hata oluÅŸtu.');
    }
  }

  // Analiz Modal - Global deÄŸiÅŸkenler
  let kategoriChartInstance = null;
  
  // PDF Export Fonksiyonu - Yeni sayfaya yÃ¶nlendir
  async function exportAnalizPDF() {
    try {
      const analizDataArea = document.getElementById("analizDataArea");
      if(!analizDataArea || analizDataArea.style.display === "none") {
        toast("Ã–nce analiz verilerini yÃ¼kleyin.");
        return;
      }
      
      // Verileri topla
      const baslik = document.getElementById("analizBaslikGoster").textContent;
      const yil = document.getElementById("analizYilGoster").textContent;
      const yillikToplam = document.getElementById("analizYillikToplamGoster").textContent;
      
      // Analiz tablosu verilerini topla
      const analizTable = document.getElementById("analizTable");
      const tableData = [];
      if(analizTable) {
        const rows = analizTable.querySelectorAll("tbody tr");
        rows.forEach(row => {
          const cells = row.querySelectorAll("td");
          if(cells.length >= 4) {
            tableData.push({
              kategori: cells[0].textContent.trim(),
              toplam: cells[1].textContent.trim(),
              odenen: cells[2].textContent.trim(),
              kalan: cells[3].textContent.trim()
            });
          }
        });
      }
      
      // AylÄ±k daÄŸÄ±lÄ±m verilerini topla
      const aylikDagilim = document.getElementById("analizAylikDagilim");
      const aylikData = [];
      if(aylikDagilim && aylikDagilim.children.length > 0) {
        Array.from(aylikDagilim.children).forEach(card => {
          const text = card.textContent.trim();
          const lines = text.split('\n').filter(l => l.trim());
          if(lines.length >= 4) {
            aylikData.push({
              ay: lines[0].trim(),
              toplam: lines[1].trim(),
              odenen: lines[2].trim(),
              kalan: lines[3].trim()
            });
          }
        });
      }
      
      // Kategori detay verilerini topla (eÄŸer varsa)
      const kategoriDetayArea = document.getElementById("kategoriDetayArea");
      let kategoriDetay = null;
      
      if(kategoriDetayArea && kategoriDetayArea.style.display !== "none") {
        const kategoriSelect = document.getElementById("analizKategoriSelect");
        const seciliKategori = kategoriSelect.value;
        
        // TÃ¼m kategoriler seÃ§ildiyse
        if(seciliKategori === 'tum') {
          const tumKategorilerDiv = document.getElementById("tumKategorilerDetay");
          const tumKategoriler = ['hediye', 'kira', 'cocuk', 'yol', 'haberlesme', 'ikramiye', 'yakacak', 'elbise'];
          const kategoriLabels = {
            hediye: 'Hediye',
            kira: 'Kira',
            cocuk: 'Ã‡ocuk',
            yol: 'Yol',
            haberlesme: 'HaberleÅŸme',
            ikramiye: 'Ä°kramiye',
            yakacak: 'Yakacak',
            elbise: 'Elbise'
          };
          
          const tumKategoriDetaylari = [];
          
          // window.currentAnalizSnap kullanarak doÄŸrudan hesapla
          const analizSnap = window.currentAnalizSnap;
          const monthsTR = ["Ocak","Åubat","Mart","Nisan","MayÄ±s","Haziran","Temmuz","AÄŸustos","EylÃ¼l","Ekim","KasÄ±m","AralÄ±k"];
          const fmt = (n) => (Number(n||0)).toLocaleString("tr-TR",{minimumFractionDigits:2, maximumFractionDigits:2}) + " â‚º";
          
          tumKategoriler.forEach(kat => {
            // Her kategori iÃ§in veri topla (loadKategoriDetay ile aynÄ± mantÄ±k)
            const aylikKategoriData = {};
            for(let ay = 1; ay <= 12; ay++) {
              aylikKategoriData[ay] = { toplam: 0, odenen: 0, kalan: 0 };
            }
            
            if(analizSnap) {
              analizSnap.forEach(doc => {
                const d = doc.data();
                const ay = d.ay || 1;
                const tutar = +(d[kat] || 0);
                
                if(tutar > 0) {
                  aylikKategoriData[ay].toplam += tutar;
                  if(d.odemeler?.[kat]) {
                    aylikKategoriData[ay].odenen += tutar;
                  } else {
                    aylikKategoriData[ay].kalan += tutar;
                  }
                }
              });
            }
            
            // Toplam hesapla
            let kategoriToplam = 0, kategoriOdenen = 0, kategoriKalan = 0;
            Object.values(aylikKategoriData).forEach(data => {
              kategoriToplam += data.toplam;
              kategoriOdenen += data.odenen;
              kategoriKalan += data.kalan;
            });
            
            const yuzde = kategoriToplam > 0 ? ((kategoriOdenen / kategoriToplam) * 100).toFixed(1) : 0;
            
            // Detay tablosu verilerini topla
            const kategoriSection = tumKategorilerDiv.querySelector(`#kategoriDetayTableBody_${kat}`);
            const detayTableData = [];
            
            if(kategoriSection) {
              const rows = kategoriSection.querySelectorAll("tr");
              rows.forEach(row => {
                const cells = row.querySelectorAll("td");
                if(cells.length >= 5) {
                  detayTableData.push({
                    ay: cells[0].textContent.trim(),
                    toplam: cells[1].textContent.trim(),
                    odenen: cells[2].textContent.trim(),
                    kalan: cells[3].textContent.trim(),
                    durum: cells[4].textContent.trim()
                  });
                }
              });
            } else {
              // Tablo yoksa aylÄ±k verilerden oluÅŸtur
              const monthsTR = ["Ocak","Åubat","Mart","Nisan","MayÄ±s","Haziran","Temmuz","AÄŸustos","EylÃ¼l","Ekim","KasÄ±m","AralÄ±k"];
              for(let ay = 1; ay <= 12; ay++) {
                const ayData = aylikKategoriData[ay];
                const ayAdi = monthsTR[ay - 1] || ay;
                
                let durum = 'â€”';
                if(ayData.toplam === 0) {
                  durum = 'â€”';
                } else if(ayData.kalan === 0) {
                  durum = 'TamamlandÄ±';
                } else if(ayData.odenen === 0) {
                  durum = 'Ã–denmedi';
                } else {
                  const durumYuzde = ((ayData.odenen / ayData.toplam) * 100).toFixed(0);
                  durum = `%${durumYuzde}`;
                }
                
                detayTableData.push({
                  ay: ayAdi,
                  toplam: fmt(ayData.toplam),
                  odenen: fmt(ayData.odenen),
                  kalan: fmt(ayData.kalan),
                  durum: durum
                });
              }
            }
            
            tumKategoriDetaylari.push({
              kategoriAdi: kategoriLabels[kat],
              toplam: fmt(kategoriToplam),
              odenen: fmt(kategoriOdenen),
              kalan: fmt(kategoriKalan),
              yuzde: `${yuzde}%`,
              detayTable: detayTableData
            });
          });
          
          kategoriDetay = {
            kategoriAdi: 'TÃ¼m Kategoriler',
            tumKategoriler: tumKategoriDetaylari
          };
        } else {
          // Tek kategori seÃ§ildiyse
          const kategoriAdi = kategoriSelect.options[kategoriSelect.selectedIndex]?.text || "Kategori";
          
          const toplam = document.getElementById("kategoriToplam").textContent;
          const odenen = document.getElementById("kategoriOdenen").textContent;
          const kalan = document.getElementById("kategoriKalan").textContent;
          const yuzde = document.getElementById("kategoriYuzde").textContent;
          
          // Chart.js grafiÄŸini base64'e Ã§evir
          let chartImage = null;
          const chartCanvas = document.getElementById("kategoriChart");
          if(chartCanvas && kategoriChartInstance) {
            chartImage = chartCanvas.toDataURL("image/png");
          }
          
          // Kategori detay tablosu verilerini topla
          const kategoriDetayTable = document.getElementById("kategoriDetayTable");
          const detayTableData = [];
          if(kategoriDetayTable) {
            const rows = kategoriDetayTable.querySelectorAll("tbody tr");
            rows.forEach(row => {
              const cells = row.querySelectorAll("td");
              if(cells.length >= 5) {
                detayTableData.push({
                  ay: cells[0].textContent.trim(),
                  toplam: cells[1].textContent.trim(),
                  odenen: cells[2].textContent.trim(),
                  kalan: cells[3].textContent.trim(),
                  durum: cells[4].textContent.trim()
                });
              }
            });
          }
          
          kategoriDetay = {
            kategoriAdi,
            toplam,
            odenen,
            kalan,
            yuzde,
            chartImage,
            detayTable: detayTableData
          };
        }
      }
      
      // Verileri localStorage'a kaydet
      const exportData = {
        baslik,
        yil,
        yillikToplam,
        tableData,
        aylikData,
        kategoriDetay,
        timestamp: Date.now()
      };
      
      localStorage.setItem('analizPDFData', JSON.stringify(exportData));
      
      // Yeni sayfaya yÃ¶nlendir
      window.open('personelodemeanaliz.html', '_blank');
      
    } catch(e) {
      console.error(e);
      toast("Veriler hazÄ±rlanÄ±rken hata oluÅŸtu.");
    }
  }
  
  // Analiz Modal
  async function openAnalizModal() {
    const modal = document.getElementById("analizModal");
    const personelSelect = document.getElementById("analizPersonelSelect");
    const yilSelect = document.getElementById("analizYilSelect");
    
    // Personel listesini yÃ¼kle
    try {
      const snap = await db.collection(aktifKoleksiyon).get();
      const personeller = new Set();
      snap.forEach(doc => {
        const d = doc.data();
        if(d.ad) personeller.add(d.ad);
      });
      
      personelSelect.innerHTML = '<option value="tum">TÃ¼m Personeller</option>';
      Array.from(personeller).sort().forEach(ad => {
        personelSelect.add(new Option(ad, ad));
      });
    } catch(e) {
      console.error(e);
      toast('Personel listesi yÃ¼klenemedi.');
    }
    
    // YÄ±l listesini doldur
    const bugun = new Date();
    const sy = bugun.getFullYear() - 5;
    const ey = bugun.getFullYear() + 1;
    yilSelect.innerHTML = '<option value="">YÄ±l seÃ§in</option>';
    for(let y = ey; y >= sy; y--) {
      yilSelect.add(new Option(y, y));
    }
    
    // Event listener'lar
    personelSelect.onchange = yilSelect.onchange = async () => {
      const personelAd = personelSelect.value;
      const yil = yilSelect.value;
      
      if(!yil) {
        document.getElementById("analizDataArea").style.display = "none";
        document.getElementById("analizEmptyState").style.display = "block";
        return;
      }
      
      await loadAnalizData(personelAd === "tum" ? null : personelAd, +yil);
    };
    
    document.getElementById("analizDataArea").style.display = "none";
    document.getElementById("analizEmptyState").style.display = "block";
    
    // Kategori detay alanÄ±nÄ± sÄ±fÄ±rla
    document.getElementById("analizKategoriSelect").value = "";
    document.getElementById("kategoriDetayArea").style.display = "none";
    document.getElementById("kategoriDetayEmpty").style.display = "block";
    if(kategoriChartInstance) {
      kategoriChartInstance.destroy();
      kategoriChartInstance = null;
    }
    
    openModal("analizModal");
  }
  
  async function loadAnalizData(personelAd, yil) {
    try {
      let query = db.collection(aktifKoleksiyon).where("yil", "==", yil);
      if(personelAd) {
        query = query.where("ad", "==", personelAd);
      }
      
      const snap = await query.get();
      
      if(snap.empty) {
        document.getElementById("analizDataArea").style.display = "none";
        document.getElementById("analizEmptyState").style.display = "block";
        document.getElementById("analizEmptyState").innerHTML = `
          <div style="font-size:48px; margin-bottom:12px">ğŸ“Š</div>
          <div style="font-size:16px; font-weight:600">Veri bulunamadÄ±</div>
          <div style="font-size:13px; margin-top:6px">SeÃ§ilen kriterlere uygun kayÄ±t bulunamadÄ±</div>
        `;
        return;
      }
      
      // Verileri topla
      const analizData = {
        kategoriler: {},
        aylik: {},
        toplam: 0,
        odenen: 0,
        kalan: 0
      };
      
      // Kategorileri baÅŸlat
      KATEGORILER.forEach(k => {
        analizData.kategoriler[k] = { toplam: 0, odenen: 0, kalan: 0 };
      });
      
      // AylarÄ± baÅŸlat
      for(let ay = 1; ay <= 12; ay++) {
        analizData.aylik[ay] = { toplam: 0, odenen: 0, kalan: 0 };
      }
      
      snap.forEach(doc => {
        const d = doc.data();
        const ay = d.ay || 1;
        
        // Kategori toplamlarÄ±
        KATEGORILER.forEach(k => {
          const tutar = +(d[k] || 0);
          if(tutar > 0) {
            analizData.kategoriler[k].toplam += tutar;
            analizData.toplam += tutar;
            
            if(d.odemeler?.[k]) {
              analizData.kategoriler[k].odenen += tutar;
              analizData.odenen += tutar;
            } else {
              analizData.kategoriler[k].kalan += tutar;
              analizData.kalan += tutar;
            }
          }
        });
        
        // AylÄ±k toplamlar (sadece kategori toplamlarÄ±)
        let ayToplam = 0;
        let ayOdenen = 0;
        KATEGORILER.forEach(k => {
          const tutar = +(d[k] || 0);
          if(tutar > 0) {
            ayToplam += tutar;
            if(d.odemeler?.[k]) {
              ayOdenen += tutar;
            }
          }
        });
        analizData.aylik[ay].toplam += ayToplam;
        analizData.aylik[ay].odenen += ayOdenen;
        analizData.aylik[ay].kalan += (ayToplam - ayOdenen);
      });
      
      // UI gÃ¼ncelle
      const baslik = personelAd ? personelAd : "TÃ¼m Personeller";
      document.getElementById("analizBaslikGoster").textContent = baslik;
      document.getElementById("analizYilGoster").textContent = `${yil} YÄ±lÄ± Analizi`;
      document.getElementById("analizYillikToplamGoster").textContent = fmt(analizData.toplam);
      
      // Tablo oluÅŸtur
      const tbody = document.getElementById("analizTableBody");
      tbody.innerHTML = "";
      
      const kategoriLabels = {
        hediye: 'Hediye',
        kira: 'Kira',
        cocuk: 'Ã‡ocuk',
        yol: 'Yol',
        haberlesme: 'HaberleÅŸme',
        ikramiye: 'Ä°kramiye',
        yakacak: 'Yakacak',
        elbise: 'Elbise',
        ssk: 'SSK'
      };
      
      KATEGORILER.forEach(k => {
        const data = analizData.kategoriler[k];
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="text-align:left; padding-left:16px; font-weight:600">${kategoriLabels[k]}</td>
          <td style="text-align:center; font-weight:600">${fmt(data.toplam)}</td>
          <td style="text-align:center; color:var(--success); font-weight:600">${fmt(data.odenen)}</td>
          <td style="text-align:center; color:var(--danger); font-weight:600">${fmt(data.kalan)}</td>
        `;
        tbody.appendChild(tr);
      });
      
      // Toplam satÄ±rÄ±
      document.getElementById("analizToplamSatir").innerHTML = `
        <strong>Toplam: ${fmt(analizData.toplam)}</strong> | 
        <strong style="color:var(--success)">Ã–denen: ${fmt(analizData.odenen)}</strong> | 
        <strong style="color:var(--danger)">Kalan: ${fmt(analizData.kalan)}</strong>
      `;
      
      // AylÄ±k daÄŸÄ±lÄ±m
      const aylikDagilim = document.getElementById("analizAylikDagilim");
      aylikDagilim.innerHTML = "";
      
      for(let ay = 1; ay <= 12; ay++) {
        const ayData = analizData.aylik[ay];
        const ayAdi = monthsTR[ay - 1] || ay;
        const card = document.createElement('div');
        card.style.cssText = 'background:var(--card); border:1px solid var(--stroke); border-radius:8px; padding:10px; text-align:center';
        card.innerHTML = `
          <div style="font-size:11px; color:var(--muted); font-weight:600; margin-bottom:6px">${ayAdi}</div>
          <div style="font-size:14px; font-weight:700; color:var(--text); margin-bottom:4px">${fmt(ayData.toplam)}</div>
          <div style="font-size:11px; color:var(--success)">Ã–: ${fmt(ayData.odenen)}</div>
          <div style="font-size:11px; color:var(--danger)">K: ${fmt(ayData.kalan)}</div>
        `;
        aylikDagilim.appendChild(card);
      }
      
      document.getElementById("analizDataArea").style.display = "block";
      document.getElementById("analizEmptyState").style.display = "none";
      
      // PDF butonunu gÃ¶ster
      document.getElementById("btnAnalizPDF").style.display = "inline-block";
      
      // Analiz verilerini global deÄŸiÅŸkene kaydet (kategori detay iÃ§in)
      window.currentAnalizData = analizData;
      window.currentAnalizYil = yil;
      window.currentAnalizPersonel = personelAd;
      window.currentAnalizSnap = snap;
      
      // Kategori seÃ§imi event listener
      const kategoriSelect = document.getElementById("analizKategoriSelect");
      if(kategoriSelect) {
        kategoriSelect.onchange = () => {
          const kategori = kategoriSelect.value;
          if(kategori) {
            loadKategoriDetay(kategori, analizData, yil, snap);
          } else {
            document.getElementById("kategoriDetayArea").style.display = "none";
            document.getElementById("kategoriDetayEmpty").style.display = "block";
            if(kategoriChartInstance) {
              kategoriChartInstance.destroy();
              kategoriChartInstance = null;
            }
          }
        };
      }
    } catch(e) {
      console.error(e);
      toast('Analiz verileri yÃ¼klenirken hata.');
    }
  }
  
  // Kategori detay analizi
  function loadKategoriDetay(kategori, analizData, yil, snap) {
    try {
      const kategoriLabels = {
        hediye: 'Hediye',
        kira: 'Kira',
        cocuk: 'Ã‡ocuk',
        yol: 'Yol',
        haberlesme: 'HaberleÅŸme',
        ikramiye: 'Ä°kramiye',
        yakacak: 'Yakacak',
        elbise: 'Elbise',
        ssk: 'SSK'
      };
      
      // TÃ¼m kategoriler seÃ§ildiyse
      if(kategori === 'tum') {
        document.getElementById("tekKategoriDetay").style.display = "none";
        document.getElementById("tumKategorilerDetay").style.display = "block";
        
        const tumKategorilerDiv = document.getElementById("tumKategorilerDetay");
        tumKategorilerDiv.innerHTML = "";
        
        // SÄ±ralÄ± kategori listesi (SSK hariÃ§)
        const tumKategoriler = ['hediye', 'kira', 'cocuk', 'yol', 'haberlesme', 'ikramiye', 'yakacak', 'elbise'];
        
        tumKategoriler.forEach((kat, index) => {
          // Her kategori iÃ§in veri topla
          const aylikKategoriData = {};
          for(let ay = 1; ay <= 12; ay++) {
            aylikKategoriData[ay] = { toplam: 0, odenen: 0, kalan: 0 };
          }
          
          snap.forEach(doc => {
            const d = doc.data();
            const ay = d.ay || 1;
            const tutar = +(d[kat] || 0);
            
            if(tutar > 0) {
              aylikKategoriData[ay].toplam += tutar;
              if(d.odemeler?.[kat]) {
                aylikKategoriData[ay].odenen += tutar;
              } else {
                aylikKategoriData[ay].kalan += tutar;
              }
            }
          });
          
          // Toplam hesapla
          let kategoriToplam = 0, kategoriOdenen = 0, kategoriKalan = 0;
          Object.values(aylikKategoriData).forEach(data => {
            kategoriToplam += data.toplam;
            kategoriOdenen += data.odenen;
            kategoriKalan += data.kalan;
          });
          
          const yuzde = kategoriToplam > 0 ? ((kategoriOdenen / kategoriToplam) * 100).toFixed(1) : 0;
          
          // Kategori bÃ¶lÃ¼mÃ¼ oluÅŸtur
          const kategoriSection = document.createElement('div');
          kategoriSection.style.cssText = 'margin-bottom:32px; padding:20px; background:var(--card); border:1px solid var(--stroke); border-radius:12px';
          
          kategoriSection.innerHTML = `
            <h4 style="margin:0 0 16px; font-size:18px; font-weight:700; color:var(--text); border-bottom:2px solid var(--brand); padding-bottom:8px">
              ${kategoriLabels[kat]}
            </h4>
            
            <div style="display:grid; grid-template-columns:repeat(4,1fr); gap:12px; margin-bottom:20px">
              <div style="background:linear-gradient(135deg, var(--brand)15, var(--brand2)15); border:1px solid var(--stroke); border-radius:10px; padding:12px">
                <div style="font-size:11px; color:var(--muted); font-weight:600; margin-bottom:6px">Toplam</div>
                <div style="font-size:20px; font-weight:700; color:var(--text)">${fmt(kategoriToplam)}</div>
              </div>
              <div style="background:#dcfce7; border:1px solid #86efac; border-radius:10px; padding:12px">
                <div style="font-size:11px; color:#166534; font-weight:600; margin-bottom:6px">Ã–denen</div>
                <div style="font-size:20px; font-weight:700; color:#166534">${fmt(kategoriOdenen)}</div>
              </div>
              <div style="background:#fee2e2; border:1px solid #fca5a5; border-radius:10px; padding:12px">
                <div style="font-size:11px; color:#991b1b; font-weight:600; margin-bottom:6px">Kalan</div>
                <div style="font-size:20px; font-weight:700; color:#991b1b">${fmt(kategoriKalan)}</div>
              </div>
              <div style="background:var(--pill); border:1px solid var(--stroke); border-radius:10px; padding:12px">
                <div style="font-size:11px; color:var(--muted); font-weight:600; margin-bottom:6px">Ã–deme %</div>
                <div style="font-size:20px; font-weight:700; color:var(--brand)">${yuzde}%</div>
              </div>
            </div>
            
            <div class="tablo-kart" style="padding:0">
              <table>
                <thead>
                  <tr>
                    <th style="text-align:left; padding-left:16px">Ay</th>
                    <th>Toplam</th>
                    <th>Ã–denen</th>
                    <th>Kalan</th>
                    <th>Durum</th>
                  </tr>
                </thead>
                <tbody id="kategoriDetayTableBody_${kat}"></tbody>
              </table>
            </div>
          `;
          
          tumKategorilerDiv.appendChild(kategoriSection);
          
          // AylÄ±k detay tablosu
          const tbody = document.getElementById(`kategoriDetayTableBody_${kat}`);
          for(let ay = 1; ay <= 12; ay++) {
            const ayData = aylikKategoriData[ay];
            const ayAdi = monthsTR[ay - 1] || ay;
            const tr = document.createElement('tr');
            
            let durumHTML = '';
            if(ayData.toplam === 0) {
              durumHTML = '<span class="muted" style="opacity:0.5">â€”</span>';
            } else if(ayData.kalan === 0) {
              durumHTML = '<span class="chip ok">TamamlandÄ±</span>';
            } else if(ayData.odenen === 0) {
              durumHTML = '<span class="chip no">Ã–denmedi</span>';
            } else {
              const durumYuzde = ((ayData.odenen / ayData.toplam) * 100).toFixed(0);
              durumHTML = `<span style="color:var(--warn); font-weight:600">%${durumYuzde}</span>`;
            }
            
            tr.innerHTML = `
              <td style="text-align:left; padding-left:16px; font-weight:600">${ayAdi}</td>
              <td style="text-align:center; font-weight:600">${fmt(ayData.toplam)}</td>
              <td style="text-align:center; color:var(--success); font-weight:600">${fmt(ayData.odenen)}</td>
              <td style="text-align:center; color:var(--danger); font-weight:600">${fmt(ayData.kalan)}</td>
              <td style="text-align:center">${durumHTML}</td>
            `;
            tbody.appendChild(tr);
          }
        });
        
        document.getElementById("kategoriDetayArea").style.display = "block";
        document.getElementById("kategoriDetayEmpty").style.display = "none";
        return;
      }
      
      // Tek kategori seÃ§ildiyse (eski kod)
      document.getElementById("tekKategoriDetay").style.display = "block";
      document.getElementById("tumKategorilerDetay").style.display = "none";
      
      // AylÄ±k kategori verilerini topla
      const aylikKategoriData = {};
      for(let ay = 1; ay <= 12; ay++) {
        aylikKategoriData[ay] = { toplam: 0, odenen: 0, kalan: 0 };
      }
      
      snap.forEach(doc => {
        const d = doc.data();
        const ay = d.ay || 1;
        const tutar = +(d[kategori] || 0);
        
        if(tutar > 0) {
          aylikKategoriData[ay].toplam += tutar;
          if(d.odemeler?.[kategori]) {
            aylikKategoriData[ay].odenen += tutar;
          } else {
            aylikKategoriData[ay].kalan += tutar;
          }
        }
      });
      
      // Toplam hesapla
      let kategoriToplam = 0, kategoriOdenen = 0, kategoriKalan = 0;
      Object.values(aylikKategoriData).forEach(data => {
        kategoriToplam += data.toplam;
        kategoriOdenen += data.odenen;
        kategoriKalan += data.kalan;
      });
      
      // Ã–zet kartlarÄ± gÃ¼ncelle
      document.getElementById("kategoriToplam").textContent = fmt(kategoriToplam);
      document.getElementById("kategoriOdenen").textContent = fmt(kategoriOdenen);
      document.getElementById("kategoriKalan").textContent = fmt(kategoriKalan);
      const yuzde = kategoriToplam > 0 ? ((kategoriOdenen / kategoriToplam) * 100).toFixed(1) : 0;
      document.getElementById("kategoriYuzde").textContent = `${yuzde}%`;
      
      // Grafik oluÅŸtur
      const ctx = document.getElementById("kategoriChart");
      if(ctx) {
        if(kategoriChartInstance) {
          kategoriChartInstance.destroy();
        }
        
        const ayLabels = monthsTR;
        const toplamData = [];
        const odenenData = [];
        const kalanData = [];
        
        for(let ay = 1; ay <= 12; ay++) {
          toplamData.push(aylikKategoriData[ay].toplam);
          odenenData.push(aylikKategoriData[ay].odenen);
          kalanData.push(aylikKategoriData[ay].kalan);
        }
        
        kategoriChartInstance = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: ayLabels,
            datasets: [
              {
                label: 'Toplam',
                data: toplamData,
                backgroundColor: 'rgba(100, 116, 139, 0.3)',
                borderColor: 'rgb(100, 116, 139)',
                borderWidth: 1
              },
              {
                label: 'Ã–denen',
                data: odenenData,
                backgroundColor: 'rgba(34, 197, 94, 0.5)',
                borderColor: 'rgb(34, 197, 94)',
                borderWidth: 1
              },
              {
                label: 'Kalan',
                data: kalanData,
                backgroundColor: 'rgba(239, 68, 68, 0.5)',
                borderColor: 'rgb(239, 68, 68)',
                borderWidth: 1
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                display: true,
                position: 'top'
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return context.dataset.label + ': ' + fmt(context.parsed.y);
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function(value) {
                    if(value >= 1000) {
                      return (value / 1000).toFixed(1) + 'K â‚º';
                    }
                    return value + ' â‚º';
                  }
                }
              }
            }
          }
        });
      }
      
      // AylÄ±k detay tablosu
      const tbody = document.getElementById("kategoriDetayTableBody");
      tbody.innerHTML = "";
      
      for(let ay = 1; ay <= 12; ay++) {
        const ayData = aylikKategoriData[ay];
        const ayAdi = monthsTR[ay - 1] || ay;
        const tr = document.createElement('tr');
        
        let durumHTML = '';
        if(ayData.toplam === 0) {
          durumHTML = '<span class="muted" style="opacity:0.5">â€”</span>';
        } else if(ayData.kalan === 0) {
          durumHTML = '<span class="chip ok">TamamlandÄ±</span>';
        } else if(ayData.odenen === 0) {
          durumHTML = '<span class="chip no">Ã–denmedi</span>';
        } else {
          const durumYuzde = ((ayData.odenen / ayData.toplam) * 100).toFixed(0);
          durumHTML = `<span style="color:var(--warn); font-weight:600">%${durumYuzde}</span>`;
        }
        
        tr.innerHTML = `
          <td style="text-align:left; padding-left:16px; font-weight:600">${ayAdi}</td>
          <td style="text-align:center; font-weight:600">${fmt(ayData.toplam)}</td>
          <td style="text-align:center; color:var(--success); font-weight:600">${fmt(ayData.odenen)}</td>
          <td style="text-align:center; color:var(--danger); font-weight:600">${fmt(ayData.kalan)}</td>
          <td style="text-align:center">${durumHTML}</td>
        `;
        tbody.appendChild(tr);
      }
      
      document.getElementById("kategoriDetayArea").style.display = "block";
      document.getElementById("kategoriDetayEmpty").style.display = "none";
    } catch(e) {
      console.error(e);
      toast('Kategori detay analizi yÃ¼klenirken hata.');
    }
  }

  // Bildirim Ã¶rnek (opsiyonel)
  (async function(){
    try{
      const snap=await db.collection('duyurular').orderBy('createdAt','desc').limit(5).get();
      const badge=document.getElementById('notifBadge'), list=document.getElementById('notifList');
      const n=snap.size; if(n>0){ badge.style.display='block'; badge.textContent=n>99?'99+':String(n); }
      if(n===0){ list.innerHTML='<div class="muted" style="padding:6px 8px">Yeni bildirim yok.</div>'; }
      else snap.forEach(doc=>{ const d=doc.data()||{}; const row=document.createElement('a'); row.href='diger/bildirim.html'; row.innerHTML=`<strong>${d.baslik||'Duyuru'}</strong><div class="muted">${d.detay||''}</div>`; list.appendChild(row); });
    }catch(e){}
  })();

  // Yetkili kullanÄ±cÄ± kontrolÃ¼ ve UI gÃ¼ncelleme
  function updateAdminUI(isAdmin) {
    IS_ADMIN = isAdmin;
    
    // ButonlarÄ± gÃ¶ster/gizle
    const btnAdd = document.getElementById("btnAdd");
    const btnCopy = document.getElementById("btnCopy");
    const btnBulkManage = document.getElementById("btnBulkManage");
    const btnPersonelManage = document.getElementById("btnPersonelManage");
    
    if(btnAdd) btnAdd.style.display = isAdmin ? "inline-block" : "none";
    if(btnCopy) btnCopy.style.display = isAdmin ? "inline-block" : "none";
    if(btnBulkManage) btnBulkManage.style.display = isAdmin ? "inline-block" : "none";
    if(btnPersonelManage) btnPersonelManage.style.display = isAdmin ? "inline-block" : "none";
    
    // Tablo satÄ±rlarÄ±na tÄ±klama - sadece admin iÃ§in aktif
    const tbody = document.getElementById("listeAlani");
    if(tbody) {
      tbody.querySelectorAll('tr').forEach(tr => {
        if(isAdmin) {
          tr.style.cursor = "pointer";
        } else {
          tr.style.cursor = "default";
          tr.onclick = null;
        }
      });
    }
  }

  // Auth + yetki
  try{ firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL); }catch(e){}
  auth.onAuthStateChanged(async (user)=>{
    if(!user){ setTimeout(()=>{ if(!auth.currentUser) location.replace('index.html'); },150); return; }
    try{
      const uSnap=await db.collection('kullanicilar').doc(user.uid).get();
      const data=uSnap.exists?uSnap.data():{};
      document.getElementById('profName').textContent = data.adSoyad ? (data.adSoyad.split(' ')[0]) : 'Profil';
      const rawPerms=Array.isArray(data.yetkiler)? data.yetkiler : [];
      CURRENT_ALLOW=new Set(rawPerms.filter(s=>!String(s).trim().startsWith('-') && !String(s).trim().startsWith('!')).map(norm));
      CURRENT_DENY =new Set(rawPerms.filter(s=> String(s).trim().startsWith('-') || String(s).trim().startsWith('!')).map(s=>norm(String(s).replace(/^[-!]\s*/,''))));
      const panels=await fetchPanels(CURRENT_ALLOW, CURRENT_DENY);
      renderNav(panels);
      
      // Email kontrolÃ¼ - sadece samettckrr@gmail.com yetkili
      const userEmail = user.email || '';
      const isAdmin = userEmail.toLowerCase() === 'samettckrr@gmail.com';
      updateAdminUI(isAdmin);
      
      await listele();
    }catch(e){ console.error(e); toast('Veriler yÃ¼klenirken hata.'); }
  });
</script>
</body>
</html>
