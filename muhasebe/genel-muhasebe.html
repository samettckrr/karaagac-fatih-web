<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8" />
  <title>Muhasebe | Karaaƒüa√ß Fatih</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" href="/img/logo.png" />

  <style>
    :root {
      --appbar-h: 56px;
      --radius: 14px;
      --shadow: 0 12px 28px rgba(0, 0, 0, .14);
      --bg: #0f172a;
      --bg2: #0b1324;
      --grad1: #0ea5e922;
      --grad2: #22d3ee22;
      --card: rgba(15, 23, 42, .92);
      --stroke: rgba(148, 163, 184, .18);
      --text: #e5e7eb;
      --muted: #9aa4b2;
      --brand: #38bdf8;
      --brand2: #0ea5e9;
      --pill: #0b1220;
      --pill-hover: #101a2b;
      --link: #c7e9ff;
      --surface: rgba(2, 6, 23, .08);
      --danger: #ef4444;
      --success: #16a34a;
      --warn: #eab308;
      --tableStripe: rgba(148, 163, 184, .06);
    }

    @media (prefers-color-scheme: light) {
      :root {
        --bg: #eef6ff;
        --bg2: #f7fbff;
        --grad1: #38bdf822;
        --grad2: #22d3ee22;
        --card: rgba(255, 255, 255, .95);
        --stroke: rgba(15, 23, 42, .12);
        --text: #0b1220;
        --muted: #4b5563;
        --brand: #0ea5e9;
        --brand2: #0284c7;
        --pill: #f5f8ff;
        --pill-hover: #e9f2ff;
        --link: #0b5ea8;
        --surface: #eef3ff;
        --danger: #b91c1c;
        --success: #15803d;
        --warn: #a16207;
        --tableStripe: rgba(2, 6, 23, .04);
      }
    }

    html[data-theme="dark"] {
      /* varsayƒ±lan zaten dark */
    }

    html[data-theme="light"] {
      /* varsayƒ±lan zaten light */
    }

    * {
      box-sizing: border-box
    }

    html,
    body {
      height: 100%
    }

    body {
      margin: 0;
      color: var(--text);
      font-family: ui-sans-serif, -apple-system, "Segoe UI", Roboto, Arial;
      background:
        radial-gradient(900px 680px at 12% 8%, var(--grad1), transparent 45%),
        radial-gradient(800px 640px at 88% 92%, var(--grad2), transparent 50%),
        linear-gradient(140deg, var(--bg), var(--bg2) 60%);
      overflow-x: hidden;
      word-wrap: break-word;
    }

    a {
      color: var(--link);
      text-decoration: none
    }

    a:hover {
      text-decoration: underline
    }

    .muted {
      color: var(--muted)
    }

    /* APPBAR (birebir) */
    .appbar {
      position: sticky;
      top: 0;
      z-index: 60;
      height: var(--appbar-h);
      background: var(--card);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--stroke);
      display: flex;
      align-items: center;
      padding: 0 max(12px, env(safe-area-inset-right)) 0 max(12px, env(safe-area-inset-left));
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer
    }

    .brand img {
      width: 24px;
      height: 24px
    }

    .brand span {
      font-weight: 900;
      letter-spacing: .02em;
      color: var(--text)
    }

    .nav-center {
      margin: 0 auto;
      height: 100%
    }

    .nav-list {
      display: flex;
      gap: 22px;
      align-items: center;
      height: 100%;
      list-style: none;
      margin: 0;
      padding: 0
    }

    .nav-item {
      position: relative;
      height: 100%
    }

    .nav-btn {
      height: 100%;
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--text);
      font-weight: 600;
      cursor: pointer
    }

    .nav-btn:hover {
      color: var(--brand)
    }

    .caret {
      font-size: 12px;
      opacity: .6
    }

    .dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      min-width: 240px;
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: 10px;
      box-shadow: var(--shadow);
      padding: 8px;
      display: none
    }

    .dropdown a {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 8px;
      color: var(--text);
      text-decoration: none
    }

    .dropdown a:hover {
      background: var(--surface)
    }

    .nav-item.open .dropdown {
      display: block
    }

    .nav-right {
      display: flex;
      gap: 8px;
      align-items: center
    }

    .btn {
      border: 1px solid var(--stroke);
      background: var(--card);
      color: var(--text);
      border-radius: 999px;
      padding: 8px 12px;
      cursor: pointer
    }

    .hamb {
      display: none
    }

    .iconbtn {
      position: relative;
      border: 1px solid var(--stroke);
      background: var(--card);
      color: var(--text);
      border-radius: 999px;
      padding: 8px 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px
    }

    .badge {
      position: absolute;
      top: -6px;
      right: -6px;
      background: var(--danger);
      color: #fff;
      font-size: 11px;
      padding: 2px 6px;
      border-radius: 999px;
      border: 2px solid var(--card);
      min-width: 18px;
      text-align: center
    }

    .drop-right {
      left: auto;
      right: 0
    }

    .avatar {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background: linear-gradient(180deg, #94a3b8, #64748b);
      display: inline-block
    }

    /* DRAWER */
    .drawer {
      position: fixed;
      top: var(--appbar-h);
      right: 0;
      bottom: 0;
      left: 30%;
      transform: translateX(100%);
      transition: transform .25s ease;
      background: var(--card);
      border-left: 1px solid var(--stroke);
      z-index: 70;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      padding: 12px;
    }

    .drawer.open {
      transform: translateX(0)
    }

    .drawer .panel-title {
      margin: 14px 4px 6px;
      font-weight: 800;
      color: var(--muted);
      font-size: 13px
    }

    .drawer a {
      display: block;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid var(--stroke);
      margin: 6px 0;
      color: var(--text);
      background: var(--pill)
    }

    .drawer a:hover {
      background: var(--pill-hover)
    }

    /* CONTENT */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px
    }

    .hero {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      padding: 16px;
      margin: 16px 0;
      box-shadow: var(--shadow)
    }

    .hero h2 {
      margin: 0 0 6px;
      font-size: 20px
    }

    .hero-sub {
      color: var(--muted);
      font-size: 13px
    }

    /* Muhasebe sekme butonlarƒ± */
    .tabs {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin: 12px 0
    }

    .tab {
      border: 1px solid var(--stroke);
      background: var(--pill);
      color: var(--text);
      border-radius: 999px;
      padding: 8px 14px;
      cursor: pointer;
      font-weight: 700
    }

    .tab.active {
      outline: 2px solid var(--brand);
      background: var(--pill-hover)
    }

    /* Alt sekmeler */
    .subtabs {
      display: flex;
      gap: 8px;
      margin: 10px 0 16px
    }

    .subtab {
      border: 1px dashed var(--stroke);
      background: transparent;
      color: var(--text);
      border-radius: 999px;
      padding: 6px 12px;
      cursor: pointer;
      font-weight: 600
    }

    .subtab.active {
      border-style: solid;
      background: var(--surface)
    }

    .card {
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px
    }

    /* tablo */
    .table-wrap {
      overflow: auto;
      border: 1px solid var(--stroke);
      border-radius: 12px
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px
    }

    th,
    td {
      padding: 10px 12px;
      border-bottom: 1px solid var(--stroke);
      white-space: nowrap
    }

    tbody tr:nth-child(even) {
      background: var(--tableStripe)
    }

    tbody tr {
      cursor: pointer
    }

    tbody tr:hover {
      background: var(--pill-hover)
    }

    .pill-badge {
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      border: 1px solid var(--stroke)
    }

    .ok {
      background: rgba(22, 163, 74, .12);
      color: #22c55e;
      border-color: rgba(22, 163, 74, .35)
    }

    .no {
      background: rgba(239, 68, 68, .12);
      color: #ef4444;
      border-color: rgba(239, 68, 68, .35)
    }

    .grid {
      display: grid;
      gap: 14px;
      grid-template-columns: repeat(12, minmax(0, 1fr))
    }

    .col-12 {
      grid-column: span 12
    }

    .col-6 {
      grid-column: span 6
    }

    .col-4 {
      grid-column: span 4
    }

    @media (max-width: 960px) {

      .col-6,
      .col-4 {
        grid-column: span 12
      }

      .nav-center {
        display: none
      }

      .hamb {
        display: inline-flex
      }
    }

    /* Modal (ta≈üma fix) */
    .modal-back {
      position: fixed;
      inset: 0;
      background: rgba(2, 6, 23, .55);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 120;
      padding: 16px
    }

    .modal {
      width: min(760px, 100%);
      max-height: 90vh;
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: 16px;
      box-shadow: var(--shadow);
      display: flex;
      flex-direction: column
    }

    .modal header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 12px 14px;
      border-bottom: 1px solid var(--stroke)
    }

    .modal .content {
      padding: 14px;
      overflow: auto;
      max-height: calc(90vh - 120px)
    }

    .modal footer {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
      padding: 12px 14px;
      border-top: 1px solid var(--stroke)
    }

    .input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid var(--stroke);
      background: var(--surface);
      color: var(--text)
    }

    .row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px
    }

    .btn2 {
      border: 1px solid var(--stroke);
      background: var(--pill);
      color: var(--text);
      border-radius: 10px;
      padding: 10px 12px;
      cursor: pointer;
      font-weight: 700
    }

    .btn2.brand {
      background: var(--brand);
      color: #001b2e;
      border-color: transparent
    }

    .btn2.danger {
      background: var(--danger);
      color: #fff;
      border-color: transparent
    }

    .toast {
      position: fixed;
      left: 50%;
      bottom: 24px;
      transform: translateX(-50%) translateY(20px);
      background: rgba(2, 6, 23, .95);
      color: #fff;
      border: 1px solid rgba(255, 255, 255, .08);
      border-radius: 12px;
      padding: 10px 12px;
      opacity: 0;
      pointer-events: none;
      transition: opacity .25s, transform .25s;
      z-index: 200
    }

    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0)
    }

    /* √ñzel Stiller */
    .orphan-row {
      background: #fff1f2 !important
    }

    .orphan-row td {
      color: #b91c1c
    }

    .detail-card {
      background: var(--surface);
      border: 1px solid var(--stroke);
      border-radius: 10px;
      padding: 10px;
      margin-top: 10px
    }

    .detail-row {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      border-bottom: 1px dashed var(--stroke)
    }
  </style>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="/js/firebase/firebase-init.js"></script>
  <!-- Ortak js (varsa) -->
  <script defer src="/js/ortak.js"></script>
</head>

<body>

  <!-- APPBAR -->
  <div class="appbar">
    <div class="brand" onclick="location.href='../panel.html'">
      <img src="/img/logo.png" alt="logo"><span>KARAAƒûA√á FATƒ∞H</span>
    </div>

    <nav class="nav-center">
      <ul class="nav-list" id="navMain"></ul>
    </nav>

    <div class="nav-right">
      <button class="btn hamb" id="hamburger" title="Men√º">‚ò∞</button>

      <!-- Bildirim -->
      <div class="nav-item">
        <button class="iconbtn" id="btnNotif" title="Bildirimler">üîî
          <span class="badge" id="notifBadge" style="display:none">0</span>
        </button>
        <div class="dropdown drop-right" id="notifDropdown" aria-label="Bildirim listesi">
          <div class="muted" style="padding:6px 8px">Son bildirimler</div>
          <div id="notifList" class="list" style="max-height:300px;overflow:auto"></div>
          <a href="/diger/bildirim.html">T√ºm bildirimleri g√∂r ‚Üí</a>
        </div>
      </div>

      <!-- Profil -->
      <div class="nav-item">
        <button class="iconbtn" id="btnProfile" title="Profil">
          <span class="avatar"></span> <span id="profName" class="muted">Profil</span>
        </button>
        <div class="dropdown drop-right" id="profDropdown" aria-label="Profil men√ºs√º">
          <a href="/diger/kullanici-yonetimi.html">üë§ Profil</a>
          <a href="/diger/sistem-ayarlari.html">‚öôÔ∏è Ayarlar</a>
          <a href="#" id="btnLogout">üö™ √áƒ±kƒ±≈ü Yap</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Mobil √ßekmece -->
  <aside class="drawer" id="drawer"></aside>

  <main class="container">
    <section class="hero">
      <div>
        <h2>Muhasebe</h2>
        <div class="hero-sub">Bug√ºn: <span id="todayText">‚Äî</span></div>
      </div>
      <button class="btn2" onclick="printCurrentTab()">üñ®Ô∏è Yazdƒ±r</button>
    </section>

    <!-- √úst sekmeler -->
    <div class="tabs">
      <button class="tab active" data-tab="alacaklar">Alacaklar</button>
      <button class="tab" data-tab="hedef">Hedef</button>
      <button class="tab" data-tab="teberru">Teberru</button>
      <button class="tab" data-tab="aidat">Aidat</button>
      <button class="tab" data-tab="kitap">Kitap</button>
      <button class="tab" data-tab="personel-odeme">Personel √ñdeme</button>
    </div>

    <!-- ƒ∞√ßerik -->
    <div id="content" class="grid">
      <!-- Varsayƒ±lan: Alacaklar/Tahakkuk -->
      <div class="col-12">
        <div class="card">
          <div id="alacaklarWrap"></div>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal -->
  <div class="modal-back" id="modalBack" role="dialog" aria-modal="true">
    <div class="modal">
      <header>
        <strong id="modalTitle">D√ºzenle</strong>
        <button class="btn2" onclick="closeModal()">‚úï</button>
      </header>
      <div class="content" id="modalContent"></div>
      <footer id="modalFooter">
        <button class="btn2 danger" id="modalDelete">Sil</button>
        <button class="btn2 brand" id="modalSave">Kaydet</button>
      </footer>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    /* ===== Tema ===== */
    (function () {
      const root = document.documentElement;
      const saved = localStorage.getItem('kf_theme') || 'auto';
      apply(saved);
      function apply(mode) {
        localStorage.setItem('kf_theme', mode);
        const sysDark = () => window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        const eff = (mode === 'auto') ? (sysDark() ? 'dark' : 'light') : mode;
        root.setAttribute('data-theme', eff);
      }
      if (window.matchMedia) {
        const m = window.matchMedia('(prefers-color-scheme: dark)');
        m.addEventListener?.('change', () => { if ((localStorage.getItem('kf_theme') || 'auto') === 'auto') apply('auto'); });
      }
    })();

    /* ===== Firebase ===== */
    const db = firebase.firestore(), auth = firebase.auth();

    /* ===== Utils ===== */
    function showToast(msg) { const t = document.getElementById('toast'); t.textContent = msg; t.classList.add('show'); clearTimeout(window.__to); window.__to = setTimeout(() => t.classList.remove('show'), 3000); }
    function setToday() { const d = new Date(); const days = ['Pazar', 'Pazartesi', 'Salƒ±', '√áar≈üamba', 'Per≈üembe', 'Cuma', 'Cumartesi']; document.getElementById('todayText').textContent = `${String(d.getDate()).padStart(2, '0')}.${String(d.getMonth() + 1).padStart(2, '0')}.${d.getFullYear()} ‚Ä¢ ${days[d.getDay()]}`; }
    const toDate = v => v && typeof v.toDate === 'function' ? v.toDate() : (typeof v === 'number' ? new Date(v) : (typeof v === 'string' ? new Date(v) : null));
    const fmtDate = d => !d ? '‚Äî' : `${String(d.getDate()).padStart(2, '0')}.${String(d.getMonth() + 1).padStart(2, '0')}.${d.getFullYear()} ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
    const norm = s => String(s || '').trim().toLowerCase();
    const money = n => Number(n || 0).toLocaleString('tr-TR', { style: 'currency', currency: 'TRY' });

    /* ===== Yazdƒ±rma ===== */
    function printCurrentTab() {
      const activeTabBtn = document.querySelector('.tab.active');
      if (!activeTabBtn) return showToast('Aktif sekme bulunamadƒ±');

      const tabName = activeTabBtn.textContent;
      // Aktif tabloyu bul (g√∂r√ºn√ºr olan)
      const table = document.querySelector('#content table');

      if (!table) return showToast('Bu sekmede yazdƒ±rƒ±lacak tablo bulunamadƒ±');

      // Ba≈ülƒ±klar (Son s√ºtun genelde i≈ülem butonlarƒ±dƒ±r, onu almayalƒ±m diye kontrol edebiliriz ama ≈üimdilik basit tutalƒ±m)
      // Not: Eƒüer son s√ºtun "ƒ∞≈ülem" ise hari√ß tutmak mantƒ±klƒ±.
      const headers = Array.from(table.querySelectorAll('thead th')).map(th => th.textContent.trim());

      // Satƒ±rlar
      const rows = Array.from(table.querySelectorAll('tbody tr')).map(tr => {
        // Gizli satƒ±rlarƒ± alma
        if (tr.style.display === 'none') return null;
        return Array.from(tr.querySelectorAll('td')).map(td => td.textContent.trim());
      }).filter(r => r !== null);

      const printData = {
        title: tabName + ' Raporu',
        user: document.getElementById('profName')?.textContent || 'Kullanƒ±cƒ±',
        headers: headers,
        rows: rows
      };

      localStorage.setItem('kf_print_data', JSON.stringify(printData));
      window.open('/personel/rapor-yazdir.html', '_blank');
    }

    /* ===== Men√º Manifest: Linkleri doƒüal yoldan y√∂nlendir ===== */
    // Path normalizasyonu - mevcut sayfanƒ±n konumuna g√∂re relative path olu≈ütur
    function normalizeUrl(u){
      if(!u || u === '#') return '#';
      // HTTP/HTTPS URL'leri olduƒüu gibi bƒ±rak
      if(/^https?:\/\//i.test(u)) return u;
      if(u.startsWith('//')) return u;
      // Zaten relative path'ler (../ veya ./ ile ba≈ülayan) olduƒüu gibi bƒ±rak
      if(u.startsWith('../') || u.startsWith('./')) return u;
      
      // Mevcut dosyanƒ±n konumuna g√∂re relative hale getir
      const currentPath = location.pathname;
      const currentDir = currentPath.substring(0, currentPath.lastIndexOf('/'));
      // Mevcut dizin seviyesini hesapla (ka√ß seviye yukarƒ± √ßƒ±kmalƒ±yƒ±z)
      const currentDepth = currentDir.split('/').filter(x => x).length;
      
      // Root'a d√∂nmek i√ßin ../ sayƒ±sƒ±
      const upLevels = currentDepth > 0 ? '../'.repeat(currentDepth) : '';
      
      // Path'i temizle: / ile ba≈ülƒ±yorsa kaldƒ±r, yoksa olduƒüu gibi kullan
      const targetPath = u.startsWith('/') ? u.substring(1) : u;
      
      return upLevels + targetPath;
    }
    
    async function fetchPanels() {
      const res = [];
      try {
        const snap = await db.collection('sayfa_manifesti').get();
        snap.forEach(doc => {
          const d = doc.data() || {}, id = doc.id;
          const panelTitle = d.title || id;
          let pages = Array.isArray(d.pages) ? d.pages : [];
          pages = pages.map(pg => {
            const url = normalizeUrl(pg.path || pg.url || '#');
            return {
              baslik: pg.title || pg.key || 'Sayfa',
              url, key: pg.key || pg.title || '', sira: typeof pg.order === 'number' ? pg.order : 9999
            };
          }).sort((a, b) => a.sira - b.sira);
          if (pages.length) res.push({ id, baslik: panelTitle, sira: typeof d.order === 'number' ? d.order : 9999, pages });
        });
        res.sort((a, b) => a.sira - b.sira);
      } catch (e) { console.error('sayfa_manifesti okunamadƒ±:', e); }
      return res;
    }
    function renderNav(panels) {
      const ul = document.getElementById('navMain'), drawer = document.getElementById('drawer');
      ul.innerHTML = ''; drawer.innerHTML = '';
      if (!panels.length) {
        ul.innerHTML = '<li class="nav-item"><div class="nav-btn">Hi√ß panel yok</div></li>';
        drawer.innerHTML = '<div style="color:var(--muted);padding:8px">Hi√ß panel bulunamadƒ±</div>';
        return;
      }
      panels.forEach(p => {
        const li = document.createElement('li'); li.className = 'nav-item';
        li.innerHTML = `<div class="nav-btn">${p.baslik} <span class="caret">‚ñæ</span></div>`;
        const dd = document.createElement('div'); dd.className = 'dropdown';
        (p.pages || []).forEach(pg => {
          const a = document.createElement('a');
          a.href = normalizeUrl(pg.url || pg.path || '#'); a.textContent = pg.baslik;
          dd.appendChild(a);
        });
        li.appendChild(dd);
        li.querySelector('.nav-btn').addEventListener('click', (e) => {
          e.stopPropagation();
          ul.querySelectorAll('.nav-item').forEach(x => { if (x !== li) x.classList.remove('open'); });
          li.classList.toggle('open');
        });
        ul.appendChild(li);
      });
      document.addEventListener('click', (e) => { if (!ul.contains(e.target)) ul.querySelectorAll('.nav-item').forEach(x => x.classList.remove('open')); });

      // mobil drawer
      panels.forEach(p => {
        const h = document.createElement('div'); h.className = 'panel-title'; h.textContent = p.baslik; drawer.appendChild(h);
        (p.pages || []).forEach(pg => {
          const a = document.createElement('a');
          a.href = normalizeUrl(pg.url || pg.path || '#'); a.textContent = pg.baslik;
          drawer.appendChild(a);
        });
      });
    }
    /* Drawer toggle */
    (function () { const hamb = document.getElementById('hamburger'), drawer = document.getElementById('drawer'); if (!hamb) return; hamb.addEventListener('click', () => drawer.classList.toggle('open')); document.addEventListener('click', (e) => { if (!drawer.contains(e.target) && !hamb.contains(e.target)) drawer.classList.remove('open'); }); })();

    /* Bildirim & Profil dropdown */
    (function () {
      const notifBtn = document.getElementById('btnNotif');
      const notifDD = document.getElementById('notifDropdown');
      const profBtn = document.getElementById('btnProfile');
      const profDD = document.getElementById('profDropdown');
      function closeAll(e) {
        if (!notifDD.contains(e.target) && e.target !== notifBtn) notifDD.parentElement?.classList.remove('open');
        if (!profDD.contains(e.target) && e.target !== profBtn) profDD.parentElement?.classList.remove('open');
      }
      document.addEventListener('click', closeAll);
      notifBtn?.addEventListener('click', (e) => { e.stopPropagation(); notifDD.parentElement.classList.toggle('open'); profDD.parentElement.classList.remove('open'); });
      profBtn?.addEventListener('click', (e) => { e.stopPropagation(); profDD.parentElement.classList.toggle('open'); notifDD.parentElement.classList.remove('open'); });
      document.getElementById('btnLogout')?.addEventListener('click', async (e) => { e.preventDefault(); try { await auth.signOut(); location.replace('/index.html'); } catch (err) { showToast('√áƒ±kƒ±≈ü yapƒ±lamadƒ±'); } });
    })();

    /* ===== Tab Y√∂netimi ===== */
    const content = document.getElementById('content');
    document.querySelectorAll('.tab').forEach(btn => {
      btn.addEventListener('click', async () => {
        document.querySelectorAll('.tab').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        await renderMainTab(btn.dataset.tab);
      });
    });
    async function renderMainTab(key) {
      if (key === 'alacaklar') {
        content.innerHTML = `
      <div class="col-12">
        <div class="card">
          <div id="alacaklarWrap"></div>
        </div>
      </div>`;
        renderAlacaklar();
      }
      else if (key === 'hedef') {
        content.innerHTML = `
      <div class="col-12">
        <div class="card">
          <div class="subtabs">
            <button class="subtab active" data-sub="hedef-gor">Hedef G√∂r</button>
            <button class="subtab" data-sub="verileri-gor">Verileri G√∂r</button>
          </div>
          <div id="hedefWrap"></div>
        </div>
      </div>`;
        bindSubtabs(['hedef-gor', 'verileri-gor'], renderHedef);
        renderHedef('hedef-gor');
      }
      else if (key === 'teberru') {
        content.innerHTML = `
      <div class="col-12">
        <div class="card">
          <div id="teberruWrap"></div>
        </div>
      </div>`;
        renderTeberru();
      }
      else if (key === 'aidat') {
        content.innerHTML = `<div class="col-12"><div class="card"><div class="muted">Veri yok ‚Äì sonradan eklenecek.</div></div></div>`;
      }
      else if (key === 'kitap') {
        content.innerHTML = `<div class="col-12"><div class="card"><div class="muted">Veri yok ‚Äì sonradan eklenecek.</div></div></div>`;
      }
      else if (key === 'personel-odeme') {
        content.innerHTML = `
      <div class="col-12">
        <div class="card">
          <div id="poWrap"></div>
        </div>
      </div>`;
        renderPersonelOdeme();
      }
    }
    function bindSubtabs(keys, renderer) {
      document.querySelectorAll('.subtab').forEach(b => {
        b.addEventListener('click', () => {
          document.querySelectorAll('.subtab').forEach(x => x.classList.remove('active'));
          b.classList.add('active');
          renderer(b.dataset.sub);
        });
      });
    }

    /* ====== Alacaklar (YENƒ∞ TASARIM) ====== */
    let allTahakkuk = [];
    let allTahsilat = [];

    async function renderAlacaklar() {
      const wrap = document.getElementById('alacaklarWrap');
      wrap.innerHTML = `
    <div class="grid">
      <div class="col-12">
        <div style="display:flex; gap:10px; margin-bottom:12px">
          <select id="selPersonel" class="input" style="max-width:300px"></select>
          <button class="btn2 brand" id="btnRefresh">Yenile</button>
        </div>
      </div>
      
      <!-- Tahakkuk Listesi -->
      <div class="col-12">
        <h3>Tahakkuk Listesi</h3>
        <div class="table-wrap" style="max-height:400px">
          <table id="tTahakkuk">
            <thead><tr>
              <th>Yƒ±l</th><th>Faaliyet</th><th>Personel</th><th>Bor√ßlu</th><th>Tahakkuk</th><th>Tahsilat</th><th>Kalan</th><th>Durum</th>
            </tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Yetim Tahsilatlar -->
      <div class="col-12" style="margin-top:20px">
        <h3 style="color:var(--danger)">Tahakkuksuz (Yetim) Tahsilatlar</h3>
        <div class="muted" style="font-size:13px; margin-bottom:8px">Bu tahsilatlar herhangi bir tahakkuk kaydƒ±yla e≈üle≈ümiyor. Hatalƒ±ysa silebilirsiniz.</div>
        <div class="table-wrap" style="max-height:300px">
          <table id="tYetim">
            <thead><tr>
              <th>Tarih</th><th>Yƒ±l</th><th>Faaliyet</th><th>Personel</th><th>Bor√ßlu</th><th>Tutar</th><th>√ñdeyen</th><th>ƒ∞≈ülem</th>
            </tr></thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
  `;

      // Eventler
      document.getElementById('btnRefresh').onclick = loadAlacakData;
      document.getElementById('selPersonel').onchange = renderAlacakTables;

      await loadAlacakData();
    }

    async function loadAlacakData() {
      try {
        showToast('Veriler y√ºkleniyor...');
        const [tSnap, sSnap] = await Promise.all([
          db.collection('tahakkuklar').get(),
          db.collection('tahsilatlar').get()
        ]);

        allTahakkuk = tSnap.docs.map(d => ({ id: d.id, ...d.data() }));
        allTahsilat = sSnap.docs.map(d => ({ id: d.id, ...d.data() }));

        // Personel Listesi
        const pSet = new Set();
        allTahakkuk.forEach(x => pSet.add(x.personel));
        allTahsilat.forEach(x => pSet.add(x.personel));
        const pList = [...pSet].sort((a, b) => String(a).localeCompare(String(b), 'tr'));

        const sel = document.getElementById('selPersonel');
        const oldVal = sel.value;
        sel.innerHTML = `<option value="ALL">T√ºm Personel</option>` + pList.map(p => `<option>${p}</option>`).join('');
        if (oldVal && pList.includes(oldVal)) sel.value = oldVal;

        renderAlacakTables();
        showToast('Veriler y√ºklendi.');
      } catch (e) {
        console.error(e);
        showToast('Veri y√ºkleme hatasƒ±!');
      }
    }

    function getRelated(tahakkuk) {
      return allTahsilat.filter(s => {
        if (s.tahakkukId && s.tahakkukId === tahakkuk.id) return true;
        // Normalize string match
        if (String(s.yil) === String(tahakkuk.yil) &&
          norm(s.faaliyet) === norm(tahakkuk.faaliyet) &&
          norm(s.personel) === norm(tahakkuk.personel) &&
          norm(s.borclu) === norm(tahakkuk.borclu)) return true;
        return false;
      });
    }

    function renderAlacakTables() {
      const selP = document.getElementById('selPersonel').value;
      const tBody = document.querySelector('#tTahakkuk tbody');
      const yBody = document.querySelector('#tYetim tbody');
      tBody.innerHTML = ''; yBody.innerHTML = '';

      const usedTahsilatIds = new Set();

      // 1. Tahakkuklarƒ± Listele
      const filteredTahakkuk = selP === 'ALL' ? allTahakkuk : allTahakkuk.filter(x => x.personel === selP);

      filteredTahakkuk.forEach(t => {
        const related = getRelated(t);
        related.forEach(s => usedTahsilatIds.add(s.id));

        const sumTsl = related.reduce((a, b) => a + (b.tutar || 0), 0);
        const kalan = (t.tahakkuk || 0) - sumTsl;

        const tr = document.createElement('tr');
        tr.innerHTML = `
      <td>${t.yil}</td>
      <td>${t.faaliyet}</td>
      <td>${t.personel}</td>
      <td>${t.borclu}</td>
      <td>${money(t.tahakkuk)}</td>
      <td>${money(sumTsl)}</td>
      <td style="color:${kalan > 0 ? 'var(--warn)' : 'var(--success)'}">${money(kalan)}</td>
      <td>${kalan <= 0 ? '<span class="pill-badge ok">Tamamlandƒ±</span>' : '<span class="pill-badge no">Bor√ßlu</span>'}</td>
    `;
        tr.onclick = () => openTahakkukModal(t, related);
        tBody.appendChild(tr);
      });

      // 2. Yetim Tahsilatlarƒ± Listele
      const orphans = allTahsilat.filter(s => !usedTahsilatIds.has(s.id));
      const filteredOrphans = selP === 'ALL' ? orphans : orphans.filter(x => x.personel === selP);

      if (filteredOrphans.length === 0) {
        yBody.innerHTML = '<tr><td colspan="8" class="muted" style="text-align:center">Temiz! Yetim tahsilat yok.</td></tr>';
      } else {
        filteredOrphans.forEach(s => {
          const tr = document.createElement('tr');
          tr.className = 'orphan-row';
          tr.innerHTML = `
        <td>${fmtDate(toDate(s.tarih))}</td>
        <td>${s.yil}</td>
        <td>${s.faaliyet}</td>
        <td>${s.personel}</td>
        <td>${s.borclu}</td>
        <td>${money(s.tutar)}</td>
        <td>${s.odeyen || '‚Äî'}</td>
        <td><button class="btn2 danger" style="padding:4px 8px;font-size:12px" onclick="deleteTahsilat('${s.id}')">Sil</button></td>
      `;
          yBody.appendChild(tr);
        });
      }
    }

    function openTahakkukModal(t, related) {
      const modal = document.querySelector('.modal');
      const content = document.getElementById('modalContent');
      const footer = document.getElementById('modalFooter');

      document.getElementById('modalTitle').textContent = 'Tahakkuk Detayƒ±';
      footer.style.display = 'none'; // Standart footer gizle, √∂zel i√ßerik basacaƒüƒ±z

      content.innerHTML = `
    <div class="detail-card">
      <div class="detail-row"><span>Yƒ±l:</span> <strong>${t.yil}</strong></div>
      <div class="detail-row"><span>Faaliyet:</span> <strong>${t.faaliyet}</strong></div>
      <div class="detail-row"><span>Personel:</span> <strong>${t.personel}</strong></div>
      <div class="detail-row"><span>Bor√ßlu:</span> <strong>${t.borclu}</strong></div>
      <div class="detail-row"><span>Tutar:</span> <strong>${money(t.tahakkuk)}</strong></div>
      <div class="detail-row"><span>A√ßƒ±klama:</span> <span>${t.aciklama || '‚Äî'}</span></div>
    </div>
    
    <h4 style="margin:16px 0 8px">E≈üle≈üen Tahsilatlar</h4>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Tarih</th><th>Tutar</th><th>√ñdeyen</th><th>Y√∂ntem</th></tr></thead>
        <tbody>
          ${related.map(r => `
            <tr>
              <td>${fmtDate(toDate(r.tarih))}</td>
              <td>${money(r.tutar)}</td>
              <td>${r.odeyen || '‚Äî'}</td>
              <td>${r.yontem || '‚Äî'}</td>
            </tr>
          `).join('')}
          ${related.length === 0 ? '<tr><td colspan="4" class="muted">Hi√ß tahsilat yok.</td></tr>' : ''}
        </tbody>
      </table>
    </div>
  `;

      document.getElementById('modalBack').style.display = 'flex';
    }

    async function deleteTahsilat(id) {
      if (!confirm('Bu tahsilat kaydƒ±nƒ± kalƒ±cƒ± olarak silmek istediƒüinize emin misiniz?')) return;
      try {
        await db.collection('tahsilatlar').doc(id).delete();
        showToast('Tahsilat silindi.');
        // Listeden kaldƒ±r (local update)
        allTahsilat = allTahsilat.filter(x => x.id !== id);
        renderAlacakTables();
      } catch (e) {
        console.error(e);
        showToast('Silme hatasƒ±!');
      }
    }

    /* ====== Hedef ====== */
    async function renderHedef(which) {
      const wrap = document.getElementById('hedefWrap');
      if (which === 'hedef-gor') {
        wrap.innerHTML = `
      <div class="grid">
        <div class="col-6">
          <div class="card">
            <h3>Personel bazƒ±nda hedefler</h3>
            <div class="row" style="margin:10px 0">
              <select id="selHedefPersonel" class="input"></select>
              <button class="btn2 brand" id="btnPerLoad">Listele</button>
            </div>
            <div class="table-wrap"><table><thead><tr><th>Personel</th><th>Kategori</th><th>Hedef</th><th>DocID</th></tr></thead><tbody id="tbHedefPer"></tbody></table></div>
          </div>
        </div>
        <div class="col-6">
          <div class="card">
            <h3>Kategori bazƒ±nda hedefler</h3>
            <div class="row" style="margin:10px 0">
              <select id="selHedefKategori" class="input"></select>
              <button class="btn2 brand" id="btnKatLoad">Listele</button>
            </div>
            <div class="table-wrap"><table><thead><tr><th>Kategori</th><th>Personel</th><th>Hedef</th><th>DocID</th></tr></thead><tbody id="tbHedefKat"></tbody></table></div>
          </div>
        </div>
      </div>`;
        const snap = await db.collection('hedefler').get();
        const persons = new Set(), cats = new Set();
        const cache = []; snap.forEach(doc => { const d = doc.data() || {}; persons.add(d.personel || '‚Äî'); cats.add(d.kategori || '‚Äî'); cache.push({ id: doc.id, ...d }); });

        const selP = document.getElementById('selHedefPersonel');
        const selK = document.getElementById('selHedefKategori');
        selP.innerHTML = `<option value="">‚Äî Personel se√ß ‚Äî</option>` + [...persons].sort().map(x => `<option>${x}</option>`).join('');
        selK.innerHTML = `<option value="">‚Äî Kategori se√ß ‚Äî</option>` + [...cats].sort().map(x => `<option>${x}</option>`).join('');

        document.getElementById('btnPerLoad').onclick = () => {
          const val = selP.value || ''; const tb = document.getElementById('tbHedefPer'); tb.innerHTML = '';
          cache.filter(r => (r.personel || '') === val).forEach(r => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${r.personel}</td><td>${r.kategori}</td><td>${Number(r.hedef || 0).toLocaleString('tr-TR')}</td><td class="muted">${r.id}</td>`;
            tr.addEventListener('click', () => openEdit('hedefler', r.id, r, { title: 'Hedef D√ºzenle' }));
            tb.appendChild(tr);
          });
        };
        document.getElementById('btnKatLoad').onclick = () => {
          const val = selK.value || ''; const tb = document.getElementById('tbHedefKat'); tb.innerHTML = '';
          cache.filter(r => (r.kategori || '') === val).forEach(r => {
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${r.kategori}</td><td>${r.personel}</td><td>${Number(r.hedef || 0).toLocaleString('tr-TR')}</td><td class="muted">${r.id}</td>`;
            tr.addEventListener('click', () => openEdit('hedefler', r.id, r, { title: 'Hedef D√ºzenle' }));
            tb.appendChild(tr);
          });
        };
      } else { // verileri-gor (tur: 'hedef')
        wrap.innerHTML = `
      <div class="card" style="margin-bottom:12px">
        <div class="grid">
          <div class="col-4"><label class="muted">Kategori</label><select id="vgKategori" class="input"></select></div>
          <div class="col-4"><label class="muted">Personel</label><select id="vgPersonel" class="input"></select></div>
          <div class="col-4"><label class="muted">&nbsp;</label><button class="btn2 brand" id="vgListele">Listele</button></div>
        </div>
      </div>
      <div class="table-wrap"><table>
        <thead><tr><th>Tarih</th><th>Kategori</th><th>Personel</th><th>Ad Soyad</th><th>Miktar</th><th>T√ºr</th><th>Nereye Geldi</th><th>DocID</th></tr></thead>
        <tbody id="vgBody"></tbody>
      </table></div>`;
        const allSnap = await db.collection('veriler').where('tur', '==', 'hedef').get();
        const cats = new Set(), per = new Set(); const cache = [];
        allSnap.forEach(doc => { const d = doc.data() || {}; cats.add(d.kategori || '‚Äî'); per.add(d.personel || '‚Äî'); cache.push({ id: doc.id, ...d }); });
        const selK = document.getElementById('vgKategori');
        const selP = document.getElementById('vgPersonel');
        selK.innerHTML = `<option value="">(T√ºm√º)</option>` + [...cats].sort().map(x => `<option>${x}</option>`).join('');
        selP.innerHTML = `<option value="">(T√ºm√º)</option>` + [...per].sort().map(x => `<option>${x}</option>`).join('');
        document.getElementById('vgListele').onclick = () => {
          const k = selK.value || ''; const p = selP.value || '';
          const tb = document.getElementById('vgBody'); tb.innerHTML = '';
          cache.filter(r => (!k || r.kategori === k) && (!p || r.personel === p)).forEach(r => {
            const tr = document.createElement('tr');
            const dt = fmtDate(toDate(r.createdAt));
            tr.innerHTML = `<td>${dt}</td><td>${r.kategori || '‚Äî'}</td><td>${r.personel || '‚Äî'}</td><td>${r.adSoyad || '‚Äî'}</td><td>${Number(r.miktar || 0).toLocaleString('tr-TR')}</td><td>${r.tur || '‚Äî'}</td><td>${r.nereyeGeldi || '‚Äî'}</td><td class="muted">${r.id}</td>`;
            tr.addEventListener('click', () => openEdit('veriler', r.id, r, { title: 'Veri D√ºzenle' }));
            tb.appendChild(tr);
          });
        };
      }
    }

    /* ====== Teberru (tur: 'teberru') ====== */
    async function renderTeberru() {
      const wrap = document.getElementById('teberruWrap');
      wrap.innerHTML = `
    <div class="card" style="margin-bottom:12px">
      <div class="grid">
        <div class="col-4"><label class="muted">Personel</label><select id="tbPersonel" class="input"></select></div>
        <div class="col-4"><label class="muted">Ba≈ülangƒ±√ß</label><input type="date" id="tbStart" class="input"></div>
        <div class="col-4"><label class="muted">Biti≈ü</label><input type="date" id="tbEnd" class="input"></div>
      </div>
      <div style="margin-top:10px; display:flex; gap:8px; justify-content:flex-end">
        <button class="btn2 brand" id="tbListele">Listele</button>
      </div>
    </div>
    <div class="table-wrap"><table>
      <thead><tr><th>Tarih</th><th>Personel</th><th>Ad Soyad</th><th>Miktar</th><th>√ñdeme T√ºr√º</th><th>Kategori</th><th>DocID</th></tr></thead>
      <tbody id="tbBody"></tbody>
    </table></div>`;
      const snap = await db.collection('veriler').where('tur', '==', 'teberru').get();
      const per = new Set(); const cache = [];
      snap.forEach(doc => { const d = doc.data() || {}; per.add(d.personel || '‚Äî'); cache.push({ id: doc.id, ...d }); });
      const sel = document.getElementById('tbPersonel');
      sel.innerHTML = `<option value="">(T√ºm personel)</option>` + [...per].sort().map(x => `<option>${x}</option>`).join('');
      document.getElementById('tbListele').onclick = () => {
        const p = sel.value || ''; const s = document.getElementById('tbStart').value; const e = document.getElementById('tbEnd').value;
        const sDate = s ? new Date(s + 'T00:00:00') : null;
        const eDate = e ? new Date(e + 'T23:59:59') : null;
        const tb = document.getElementById('tbBody'); tb.innerHTML = '';
        cache.filter(r => {
          if (p && r.personel !== p) return false;
          const d = toDate(r.createdAt);
          if (sDate && (!d || d < sDate)) return false;
          if (eDate && (!d || d > eDate)) return false;
          return true;
        }).forEach(r => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${fmtDate(toDate(r.createdAt))}</td><td>${r.personel || '‚Äî'}</td><td>${r.adSoyad || '‚Äî'}</td><td>${Number(r.miktar || 0).toLocaleString('tr-TR')}</td><td>${r.nereyeGeldi || '‚Äî'}</td><td>${r.kategori || '‚Äî'}</td><td class="muted">${r.id}</td>`;
          tr.addEventListener('click', () => openEdit('veriler', r.id, r, { title: 'Teberru D√ºzenle' }));
          tb.appendChild(tr);
        });
      };
    }

    /* ====== Personel √ñdeme ====== */
    async function renderPersonelOdeme() {
      const host = document.getElementById('poWrap');
      host.innerHTML = `
    <div class="card" style="margin-bottom:12px">
      <div class="grid">
        <div class="col-4"><label class="muted">√ñdeme T√ºr√º</label>
          <select id="poTur" class="input">
            <option value="hediye">Hediye</option>
            <option value="kira">Kira</option>
            <option value="diger">Diƒüer (√ßocuk-yol-haberle≈üme)</option>
            <option value="maas">Resmi Maa≈ü</option>
          </select>
        </div>
        <div class="col-4"><label class="muted">Personel</label><select id="poPer" class="input"></select></div>
        <div class="col-2"><label class="muted">Yƒ±l</label><input id="poYil" class="input" type="number" placeholder="2025"></div>
        <div class="col-2"><label class="muted">Ay</label>
          <select id="poAy" class="input">
            <option value="">(T√ºm√º)</option>
            ${[1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12].map(m => `<option value="${m}">${m}</option>`).join('')}
          </select>
        </div>
      </div>
      <div style="margin-top:10px; display:flex; gap:8px; justify-content:flex-end">
        <button class="btn2 brand" id="poListele">Listele</button>
      </div>
    </div>
    <div class="table-wrap"><table>
      <thead id="poHead"></thead><tbody id="poBody"></tbody>
    </table></div>`;

      const snap = await db.collection('personel_odeme').get();
      const per = new Set(); const cache = [];
      snap.forEach(doc => { const d = doc.data() || {}; per.add(d.ad || d.personel || '‚Äî'); cache.push({ id: doc.id, ...d }); });
      document.getElementById('poPer').innerHTML = `<option value="">(T√ºm√º)</option>` + [...per].sort().map(x => `<option>${x}</option>`).join('');
      document.getElementById('poYil').value = new Date().getFullYear();

      function renderRows() {
        const tur = document.getElementById('poTur').value;
        const p = document.getElementById('poPer').value || '';
        const y = Number(document.getElementById('poYil').value || 0);
        const m = document.getElementById('poAy').value || '';
        const head = document.getElementById('poHead');
        const body = document.getElementById('poBody'); body.innerHTML = '';

        if (tur === 'hediye') {
          head.innerHTML = `<tr><th>Yƒ±l</th><th>Ay</th><th>Personel</th><th>Hediye</th><th>√ñdendi?</th><th>Toplam</th><th>DocID</th></tr>`;
          cache.filter(r => (!p || (r.ad || r.personel) === p) && (!y || r.yil == y) && (!m || r.ay == m)).forEach(r => {
            const od = r.odemeler?.hediye === true;
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${r.yil || '‚Äî'}</td><td>${r.ay || '‚Äî'}</td><td>${r.ad || r.personel || '‚Äî'}</td><td>${Number(r.hediye || 0).toLocaleString('tr-TR')}</td><td><span class="pill-badge ${od ? 'ok' : 'no'}">${od ? '√∂dendi' : '√∂denmedi'}</span></td><td>${Number(r.toplam || 0).toLocaleString('tr-TR')}</td><td class="muted">${r.id}</td>`;
            tr.addEventListener('click', () => openEdit('personel_odeme', r.id, r, { title: 'Hediye √ñdemesi' }));
            body.appendChild(tr);
          });
        } else if (tur === 'kira') {
          head.innerHTML = `<tr><th>Yƒ±l</th><th>Ay</th><th>Personel</th><th>Kira</th><th>√ñdendi?</th><th>Toplam</th><th>DocID</th></tr>`;
          cache.filter(r => (!p || (r.ad || r.personel) === p) && (!y || r.yil == y) && (!m || r.ay == m)).forEach(r => {
            const od = r.odemeler?.kira === true;
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${r.yil || '‚Äî'}</td><td>${r.ay || '‚Äî'}</td><td>${r.ad || r.personel || '‚Äî'}</td><td>${Number(r.kira || 0).toLocaleString('tr-TR')}</td><td><span class="pill-badge ${od ? 'ok' : 'no'}">${od ? '√∂dendi' : '√∂denmedi'}</span></td><td>${Number(r.toplam || 0).toLocaleString('tr-TR')}</td><td class="muted">${r.id}</td>`;
            tr.addEventListener('click', () => openEdit('personel_odeme', r.id, r, { title: 'Kira √ñdemesi' }));
            body.appendChild(tr);
          });
        } else if (tur === 'diger') {
          head.innerHTML = `<tr><th>Yƒ±l</th><th>Ay</th><th>Personel</th><th>√áocuk</th><th>Yol</th><th>Haberle≈üme</th><th>√ñdenenler</th><th>Toplam</th><th>DocID</th></tr>`;
          cache.filter(r => (!p || (r.ad || r.personel) === p) && (!y || r.yil == y) && (!m || r.ay == m)).forEach(r => {
            const flags = r.odemeler || {};
            const odList = ['cocuk', 'yol', 'haberlesme'].filter(k => flags[k]).join(', ') || '‚Äî';
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${r.yil || '‚Äî'}</td><td>${r.ay || '‚Äî'}</td><td>${r.ad || r.personel || '‚Äî'}</td>
          <td>${Number(r.cocuk || 0).toLocaleString('tr-TR')}</td>
          <td>${Number(r.yol || 0).toLocaleString('tr-TR')}</td>
          <td>${Number(r.haberlesme || 0).toLocaleString('tr-TR')}</td>
          <td>${odList}</td>
          <td>${Number(r.toplam || 0).toLocaleString('tr-TR')}</td>
          <td class="muted">${r.id}</td>`;
            tr.addEventListener('click', () => openEdit('personel_odeme', r.id, r, { title: 'Diƒüer √ñdemeler' }));
            body.appendChild(tr);
          });
        } else {
          head.innerHTML = `<tr><th>Yƒ±l</th><th>Ay</th><th>Personel</th><th>Maa≈ü</th><th>Durum</th><th>DocID</th></tr>`;
          cache.filter(r => (!p || (r.ad || r.personel) === p) && (!y || r.yil == y) && (!m || r.ay == m)).forEach(r => {
            const durum = (r.maas || '-').toString().toLowerCase();
            const od = durum === '√∂dendi' || durum === 'odendi';
            const tr = document.createElement('tr');
            tr.innerHTML = `<td>${r.yil || '‚Äî'}</td><td>${r.ay || '‚Äî'}</td><td>${r.ad || r.personel || '‚Äî'}</td><td>-</td><td><span class="pill-badge ${od ? 'ok' : 'no'}">${od ? '√∂dendi' : '√∂denmedi'}</span></td><td class="muted">${r.id}</td>`;
            tr.addEventListener('click', () => openEdit('personel_odeme', r.id, r, { title: 'Resmi Maa≈ü' }));
            body.appendChild(tr);
          });
        }
      }
      document.getElementById('poListele').onclick = renderRows;
      document.getElementById('poTur').onchange = renderRows;
      renderRows();
    }

    /* ===== Modal: D√ºzenle & Sil (GENEL) ===== */
    let __modalCtx = null;
    function openEdit(col, id, data, opt = {}) {
      __modalCtx = { col, id, orig: data };
      document.getElementById('modalTitle').textContent = opt.title || 'D√ºzenle';
      document.getElementById('modalFooter').style.display = 'flex'; // Standart footer g√∂ster

      const keys = Object.keys(data || {}).sort();
      const form = document.createElement('div');
      form.innerHTML = keys.map(k => {
        const v = data[k];
        const isTime = (v instanceof Date) || (v && typeof v.toDate === 'function') || /tarih|createdat/i.test(k);
        const t = isTime ? 'datetime-local' : (typeof v === 'number' ? 'number' : 'text');
        const val = isTime
          ? (toDate(v) ? new Date(toDate(v).getTime() - new Date().getTimezoneOffset() * 60000).toISOString().slice(0, 16) : '')
          : (v ?? '');
        return `<div style="margin:8px 0">
      <label class="muted" style="display:block;margin-bottom:6px">${k}</label>
      <input class="input" data-k="${k}" type="${t}" value="${val}">
    </div>`;
      }).join('');
      const cont = document.getElementById('modalContent'); cont.innerHTML = ''; cont.appendChild(form);

      document.getElementById('modalSave').onclick = async () => {
        try {
          const inputs = [...form.querySelectorAll('input[data-k]')];
          const patch = {};
          inputs.forEach(inp => {
            const key = inp.dataset.k; let val = inp.value;
            if (inp.type === 'number') { val = Number(val); if (isNaN(val)) val = 0; }
            else if (inp.type === 'datetime-local') { val = val ? new Date(val) : null; }
            patch[key] = val;
          });
          for (const k of Object.keys(__modalCtx.orig || {})) {
            if ((/createdat|tarih/i).test(k) && (patch[k] === '' || patch[k] === null)) delete patch[k];
          }
          await db.collection(__modalCtx.col).doc(__modalCtx.id).update(patch);
          showToast('G√ºncellendi.');
          closeModal(true);
        } catch (e) { console.error(e); showToast('G√ºncelleme hatasƒ±.'); }
      };
      document.getElementById('modalDelete').onclick = async () => {
        if (!confirm('Bu kaydƒ± silmek istediƒüine emin misin?')) return;
        try {
          await db.collection(__modalCtx.col).doc(__modalCtx.id).delete();
          showToast('Silindi.');
          closeModal(true);
        } catch (e) { console.error(e); showToast('Silme hatasƒ±.'); }
      };

      document.getElementById('modalBack').style.display = 'flex';
    }
    function closeModal(refresh) {
      document.getElementById('modalBack').style.display = 'none';
      if (refresh) {
        const activeMain = document.querySelector('.tab.active')?.dataset.tab || 'alacaklar';
        renderMainTab(activeMain);
      }
    }

    /* ===== Auth & Ba≈ülat ===== */
    auth.onAuthStateChanged(async (user) => {
      if (!user) { location.replace('/index.html'); return; }
      try {
        setToday();
        const uSnap = await db.collection('kullanicilar').doc(user.uid).get().catch(() => null);
        const data = uSnap?.exists ? uSnap.data() : {};
        document.getElementById('profName').textContent = (data.adSoyad?.split(' ')[0]) || 'Profil';
        const panels = await fetchPanels();
        renderNav(panels);
        await renderMainTab('alacaklar');
      } catch (e) { console.error(e); showToast('Sayfa y√ºklenirken hata.'); }
    });
  </script>

</body>

</html>