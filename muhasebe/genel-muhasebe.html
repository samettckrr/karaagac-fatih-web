<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Muhasebe | Karaağaç Fatih</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" type="image/png" href="/img/logo.png" />

  <style>
    :root{
      --appbar-h:56px;
      --radius:14px; --shadow:0 12px 28px rgba(0,0,0,.14);
      --bg:#0f172a; --bg2:#0b1324;
      --grad1:#0ea5e922; --grad2:#22d3ee22;
      --card:rgba(15,23,42,.92); --stroke:rgba(148,163,184,.18);
      --text:#e5e7eb; --muted:#9aa4b2;
      --brand:#38bdf8; --brand2:#0ea5e9;
      --pill:#0b1220; --pill-hover:#101a2b;
      --link:#c7e9ff; --surface:rgba(2,6,23,.08);
      --danger:#ef4444; --success:#16a34a; --warn:#eab308;
      --tableStripe: rgba(148,163,184,.06);
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#eef6ff; --bg2:#f7fbff; --grad1:#38bdf822; --grad2:#22d3ee22;
        --card:rgba(255,255,255,.95);
        --stroke:rgba(15,23,42,.12);
        --text:#0b1220; --muted:#4b5563; --brand:#0ea5e9; --brand2:#0284c7;
        --pill:#f5f8ff; --pill-hover:#e9f2ff; --link:#0b5ea8; --surface:#eef3ff;
        --danger:#b91c1c; --success:#15803d; --warn:#a16207;
        --tableStripe: rgba(2,6,23,.04);
      }
    }
    html[data-theme="dark"]{ /* varsayılan zaten dark */ }
    html[data-theme="light"]{ /* varsayılan zaten light */ }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      font-family:ui-sans-serif,-apple-system,"Segoe UI",Roboto,Arial;
      background:
        radial-gradient(900px 680px at 12% 8%, var(--grad1), transparent 45%),
        radial-gradient(800px 640px at 88% 92%, var(--grad2), transparent 50%),
        linear-gradient(140deg, var(--bg), var(--bg2) 60%);
      overflow-x:hidden; word-wrap:break-word;
    }
    a{color:var(--link); text-decoration:none}
    a:hover{text-decoration:underline}
    .muted{color:var(--muted)}

    /* APPBAR (birebir) */
    .appbar{position:sticky; top:0; z-index:60; height:var(--appbar-h); background:var(--card); backdrop-filter:blur(10px); border-bottom:1px solid var(--stroke); display:flex; align-items:center; padding:0 max(12px, env(safe-area-inset-right)) 0 max(12px, env(safe-area-inset-left));}
    .brand{display:flex; align-items:center; gap:10px; cursor:pointer}
    .brand img{width:24px; height:24px}
    .brand span{font-weight:900; letter-spacing:.02em; color:var(--text)}
    .nav-center{margin:0 auto; height:100%}
    .nav-list{display:flex; gap:22px; align-items:center; height:100%; list-style:none; margin:0; padding:0}
    .nav-item{position:relative; height:100%}
    .nav-btn{height:100%; display:flex; align-items:center; gap:6px; color:var(--text); font-weight:600; cursor:pointer}
    .nav-btn:hover{color:var(--brand)}
    .caret{font-size:12px; opacity:.6}
    .dropdown{position:absolute; top:100%; left:0; min-width:240px; background:var(--card); border:1px solid var(--stroke); border-radius:10px; box-shadow:var(--shadow); padding:8px; display:none}
    .dropdown a{display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:8px; color:var(--text); text-decoration:none}
    .dropdown a:hover{background:var(--surface)}
    .nav-item.open .dropdown{display:block}
    .nav-right{display:flex; gap:8px; align-items:center}
    .btn{border:1px solid var(--stroke); background:var(--card); color:var(--text); border-radius:999px; padding:8px 12px; cursor:pointer}
    .hamb{display:none}
    .iconbtn{position:relative;border:1px solid var(--stroke);background:var(--card);color:var(--text);border-radius:999px;padding:8px 12px;cursor:pointer;display:flex;align-items:center;gap:8px}
    .badge{position:absolute;top:-6px;right:-6px;background:var(--danger);color:#fff;font-size:11px;padding:2px 6px;border-radius:999px;border:2px solid var(--card);min-width:18px;text-align:center}
    .drop-right{left:auto; right:0}
    .avatar{width:22px;height:22px;border-radius:999px;background:linear-gradient(180deg,#94a3b8,#64748b);display:inline-block}

    /* DRAWER */
    .drawer{position:fixed; top:var(--appbar-h); right:0; bottom:0; left:30%; transform:translateX(100%); transition:transform .25s ease; background:var(--card); border-left:1px solid var(--stroke); z-index:70; overflow:auto; -webkit-overflow-scrolling:touch; padding:12px;}
    .drawer.open{transform:translateX(0)}
    .drawer .panel-title{margin:14px 4px 6px; font-weight:800; color:var(--muted); font-size:13px}
    .drawer a{display:block; padding:10px; border-radius:10px; border:1px solid var(--stroke); margin:6px 0; color:var(--text); background:var(--pill)}
    .drawer a:hover{background:var(--pill-hover)}

    /* CONTENT */
    .container{max-width:1200px; margin:0 auto; padding:16px}
    .hero{display:flex; justify-content:space-between; align-items:flex-start; gap:16px; background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius); padding:16px; margin:16px 0; box-shadow:var(--shadow)}
    .hero h2{margin:0 0 6px; font-size:20px}
    .hero-sub{color:var(--muted); font-size:13px}

    /* Muhasebe sekme butonları */
    .tabs{display:flex; gap:8px; flex-wrap:wrap; margin:12px 0}
    .tab{border:1px solid var(--stroke); background:var(--pill); color:var(--text); border-radius:999px; padding:8px 14px; cursor:pointer; font-weight:700}
    .tab.active{outline:2px solid var(--brand); background:var(--pill-hover)}

    /* Alt sekmeler */
    .subtabs{display:flex; gap:8px; margin:10px 0 16px}
    .subtab{border:1px dashed var(--stroke); background:transparent; color:var(--text); border-radius:999px; padding:6px 12px; cursor:pointer; font-weight:600}
    .subtab.active{border-style:solid; background:var(--surface)}

    .card{background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px}

    /* tablo */
    .table-wrap{overflow:auto; border:1px solid var(--stroke); border-radius:12px}
    table{width:100%; border-collapse:collapse; font-size:14px}
    th, td{padding:10px 12px; border-bottom:1px solid var(--stroke); white-space:nowrap}
    tbody tr:nth-child(even){background:var(--tableStripe)}
    tbody tr{cursor:pointer}
    tbody tr:hover{background:var(--pill-hover)}
    .pill-badge{padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid var(--stroke)}
    .ok{background:rgba(22,163,74,.12); color:#22c55e; border-color:rgba(22,163,74,.35)}
    .no{background:rgba(239,68,68,.12); color:#ef4444; border-color:rgba(239,68,68,.35)}

    .grid{display:grid; gap:14px; grid-template-columns:repeat(12, minmax(0,1fr))}
    .col-12{grid-column:span 12} .col-6{grid-column:span 6} .col-4{grid-column:span 4}
    @media (max-width: 960px){ .col-6,.col-4{grid-column:span 12} .nav-center{display:none} .hamb{display:inline-flex} }

    /* Modal (taşma fix) */
    .modal-back{position:fixed; inset:0; background:rgba(2,6,23,.55); display:none; align-items:center; justify-content:center; z-index:120; padding:16px}
    .modal{width:min(760px, 100%); max-height:90vh; background:var(--card); border:1px solid var(--stroke); border-radius:16px; box-shadow:var(--shadow); display:flex; flex-direction:column}
    .modal header{display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid var(--stroke)}
    .modal .content{padding:14px; overflow:auto; max-height:calc(90vh - 120px)}
    .modal footer{display:flex; gap:8px; justify-content:flex-end; padding:12px 14px; border-top:1px solid var(--stroke)}
    .input{width:100%; padding:10px 12px; border-radius:10px; border:1px solid var(--stroke); background:var(--surface); color:var(--text)}
    .row{display:grid; grid-template-columns:1fr 1fr; gap:10px}
    .btn2{border:1px solid var(--stroke); background:var(--pill); color:var(--text); border-radius:10px; padding:10px 12px; cursor:pointer; font-weight:700}
    .btn2.brand{background:var(--brand); color:#001b2e; border-color:transparent}
    .btn2.danger{background:var(--danger); color:#fff; border-color:transparent}

    .toast{position:fixed; left:50%; bottom:24px; transform:translateX(-50%) translateY(20px); background:rgba(2,6,23,.95); color:#fff; border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:10px 12px; opacity:0; pointer-events:none; transition:opacity .25s, transform .25s; z-index:200}
    .toast.show{opacity:1; transform:translateX(-50%) translateY(0)}
  </style>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="/js/firebase/firebase-init.js"></script>
  <!-- Ortak js (varsa) -->
  <script defer src="/js/ortak.js"></script>
</head>
<body>

  <!-- APPBAR -->
  <div class="appbar">
    <div class="brand" onclick="location.href='/panel.html'">
      <img src="/img/logo.png" alt="logo"><span>KARAAĞAÇ FATİH</span>
    </div>

    <nav class="nav-center"><ul class="nav-list" id="navMain"></ul></nav>

    <div class="nav-right">
      <button class="btn hamb" id="hamburger" title="Menü">☰</button>

      <!-- Bildirim -->
      <div class="nav-item">
        <button class="iconbtn" id="btnNotif" title="Bildirimler">🔔
          <span class="badge" id="notifBadge" style="display:none">0</span>
        </button>
        <div class="dropdown drop-right" id="notifDropdown" aria-label="Bildirim listesi">
          <div class="muted" style="padding:6px 8px">Son bildirimler</div>
          <div id="notifList" class="list" style="max-height:300px;overflow:auto"></div>
          <a href="/diger/bildirim.html">Tüm bildirimleri gör →</a>
        </div>
      </div>

      <!-- Profil -->
      <div class="nav-item">
        <button class="iconbtn" id="btnProfile" title="Profil">
          <span class="avatar"></span> <span id="profName" class="muted">Profil</span>
        </button>
        <div class="dropdown drop-right" id="profDropdown" aria-label="Profil menüsü">
          <a href="/diger/kullanici-yonetimi.html">👤 Profil</a>
          <a href="/diger/sistem-ayarlari.html">⚙️ Ayarlar</a>
          <a href="#" id="btnLogout">🚪 Çıkış Yap</a>
        </div>
      </div>
    </div>
  </div>

  <!-- Mobil çekmece -->
  <aside class="drawer" id="drawer"></aside>

  <main class="container">
    <section class="hero">
      <div>
        <h2>Muhasebe</h2>
        <div class="hero-sub">Bugün: <span id="todayText">—</span></div>
      </div>
    </section>

    <!-- Üst sekmeler -->
    <div class="tabs">
      <button class="tab active" data-tab="alacaklar">Alacaklar</button>
      <button class="tab" data-tab="hedef">Hedef</button>
      <button class="tab" data-tab="teberru">Teberru</button>
      <button class="tab" data-tab="aidat">Aidat</button>
      <button class="tab" data-tab="kitap">Kitap</button>
      <button class="tab" data-tab="personel-odeme">Personel Ödeme</button>
    </div>

    <!-- İçerik -->
    <div id="content" class="grid">
      <!-- Varsayılan: Alacaklar/Tahakkuk -->
      <div class="col-12">
        <div class="card">
          <div class="subtabs">
            <button class="subtab active" data-sub="tahakkuk">Tahakkuk</button>
            <button class="subtab" data-sub="tahsilat">Tahsilat</button>
          </div>
          <div id="alacaklarWrap"></div>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal -->
  <div class="modal-back" id="modalBack" role="dialog" aria-modal="true">
    <div class="modal">
      <header>
        <strong id="modalTitle">Düzenle</strong>
        <button class="btn2" onclick="closeModal()">✕</button>
      </header>
      <div class="content" id="modalContent"></div>
      <footer>
        <button class="btn2 danger" id="modalDelete">Sil</button>
        <button class="btn2 brand" id="modalSave">Kaydet</button>
      </footer>
    </div>
  </div>

  <div class="toast" id="toast"></div>

<script>
/* ===== Tema ===== */
(function(){
  const root=document.documentElement;
  const saved=localStorage.getItem('kf_theme')||'auto';
  apply(saved);
  function apply(mode){
    localStorage.setItem('kf_theme',mode);
    const sysDark=()=>window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches;
    const eff=(mode==='auto')?(sysDark()?'dark':'light'):mode;
    root.setAttribute('data-theme',eff);
  }
  if(window.matchMedia){
    const m=window.matchMedia('(prefers-color-scheme: dark)');
    m.addEventListener?.('change',()=>{ if((localStorage.getItem('kf_theme')||'auto')==='auto') apply('auto'); });
  }
})();

/* ===== Firebase ===== */
const db=firebase.firestore(), auth=firebase.auth();

/* ===== Utils ===== */
function showToast(msg){const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); clearTimeout(window.__to); window.__to=setTimeout(()=>t.classList.remove('show'),3000);}
function setToday(){const d=new Date(); const days=['Pazar','Pazartesi','Salı','Çarşamba','Perşembe','Cuma','Cumartesi']; document.getElementById('todayText').textContent=`${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()} • ${days[d.getDay()]}`;}
const toDate=v=>v&&typeof v.toDate==='function'? v.toDate(): (typeof v==='number'? new Date(v): (typeof v==='string'? new Date(v): null));
const fmtDate=d=>!d?'—':`${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()} ${String(d.getHours()).padStart(2,'0')}:${String(d.getMinutes()).padStart(2,'0')}`;
const norm=s=>String(s||'').trim().toLowerCase();

/* ===== Menü Manifest: Linkleri kökten çöz ===== */
async function fetchPanels(){
  const res=[];
  try{
    const snap=await db.collection('sayfa_manifesti').get();
    snap.forEach(doc=>{
      const d=doc.data()||{}, id=doc.id;
      const panelTitle=d.title||id;
      let pages = Array.isArray(d.pages)? d.pages : [];
      pages = pages.map(pg=>{
        let url = String(pg.path || pg.url || '#');
        // kökten yolu garanti et
        if(!url.startsWith('/')) url = '/'+url.replace(/^\/+/,'');
        return {
          baslik: pg.title || pg.key || 'Sayfa',
          url, key: pg.key || pg.title || '', sira: typeof pg.order==='number'? pg.order : 9999
        };
      }).sort((a,b)=>a.sira-b.sira);
      if(pages.length) res.push({ id, baslik:panelTitle, sira: typeof d.order==='number'? d.order : 9999, pages });
    });
    res.sort((a,b)=>a.sira-b.sira);
  }catch(e){ console.error('sayfa_manifesti okunamadı:', e); }
  return res;
}
function renderNav(panels){
  const ul=document.getElementById('navMain'), drawer=document.getElementById('drawer');
  ul.innerHTML=''; drawer.innerHTML='';
  if(!panels.length){
    ul.innerHTML='<li class="nav-item"><div class="nav-btn">Hiç panel yok</div></li>';
    drawer.innerHTML='<div style="color:var(--muted);padding:8px">Hiç panel bulunamadı</div>';
    return;
  }
  panels.forEach(p=>{
    const li=document.createElement('li'); li.className='nav-item';
    li.innerHTML=`<div class="nav-btn">${p.baslik} <span class="caret">▾</span></div>`;
    const dd=document.createElement('div'); dd.className='dropdown';
    (p.pages||[]).forEach(pg=>{
      const a=document.createElement('a');
      a.href=pg.url; a.textContent=pg.baslik;
      dd.appendChild(a);
    });
    li.appendChild(dd);
    li.querySelector('.nav-btn').addEventListener('click',(e)=>{
      e.stopPropagation();
      ul.querySelectorAll('.nav-item').forEach(x=>{ if(x!==li) x.classList.remove('open'); });
      li.classList.toggle('open');
    });
    ul.appendChild(li);
  });
  document.addEventListener('click',(e)=>{ if(!ul.contains(e.target)) ul.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('open')); });

  // mobil drawer
  panels.forEach(p=>{
    const h=document.createElement('div'); h.className='panel-title'; h.textContent=p.baslik; drawer.appendChild(h);
    (p.pages||[]).forEach(pg=>{
      const a=document.createElement('a');
      a.href=pg.url; a.textContent=pg.baslik;
      drawer.appendChild(a);
    });
  });
}
/* Drawer toggle */
(function(){ const hamb=document.getElementById('hamburger'), drawer=document.getElementById('drawer'); if(!hamb) return; hamb.addEventListener('click',()=>drawer.classList.toggle('open')); document.addEventListener('click',(e)=>{ if(!drawer.contains(e.target) && !hamb.contains(e.target)) drawer.classList.remove('open'); }); })();

/* Bildirim & Profil dropdown */
(function(){
  const notifBtn=document.getElementById('btnNotif');
  const notifDD =document.getElementById('notifDropdown');
  const profBtn =document.getElementById('btnProfile');
  const profDD  =document.getElementById('profDropdown');
  function closeAll(e){
    if(!notifDD.contains(e.target) && e.target!==notifBtn) notifDD.parentElement?.classList.remove('open');
    if(!profDD.contains(e.target)  && e.target!==profBtn)  profDD.parentElement?.classList.remove('open');
  }
  document.addEventListener('click', closeAll);
  notifBtn?.addEventListener('click', (e)=>{ e.stopPropagation(); notifDD.parentElement.classList.toggle('open'); profDD.parentElement.classList.remove('open'); });
  profBtn ?.addEventListener('click', (e)=>{ e.stopPropagation(); profDD.parentElement.classList.toggle('open'); notifDD.parentElement.classList.remove('open'); });
  document.getElementById('btnLogout')?.addEventListener('click', async (e)=>{ e.preventDefault(); try{ await auth.signOut(); location.replace('/index.html'); }catch(err){ showToast('Çıkış yapılamadı'); } });
})();

/* ===== Tab Yönetimi ===== */
const content = document.getElementById('content');
document.querySelectorAll('.tab').forEach(btn=>{
  btn.addEventListener('click', async ()=>{
    document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    await renderMainTab(btn.dataset.tab);
  });
});
async function renderMainTab(key){
  if(key==='alacaklar'){
    content.innerHTML = `
      <div class="col-12">
        <div class="card">
          <div class="subtabs">
            <button class="subtab active" data-sub="tahakkuk">Tahakkuk</button>
            <button class="subtab" data-sub="tahsilat">Tahsilat</button>
          </div>
          <div id="alacaklarWrap"></div>
        </div>
      </div>`;
    bindSubtabs(['tahakkuk','tahsilat'], renderAlacaklar);
    renderAlacaklar('tahakkuk');
  }
  else if(key==='hedef'){
    content.innerHTML = `
      <div class="col-12">
        <div class="card">
          <div class="subtabs">
            <button class="subtab active" data-sub="hedef-gor">Hedef Gör</button>
            <button class="subtab" data-sub="verileri-gor">Verileri Gör</button>
          </div>
          <div id="hedefWrap"></div>
        </div>
      </div>`;
    bindSubtabs(['hedef-gor','verileri-gor'], renderHedef);
    renderHedef('hedef-gor');
  }
  else if(key==='teberru'){
    content.innerHTML = `
      <div class="col-12">
        <div class="card">
          <div id="teberruWrap"></div>
        </div>
      </div>`;
    renderTeberru();
  }
  else if(key==='aidat'){
    content.innerHTML = `<div class="col-12"><div class="card"><div class="muted">Veri yok – sonradan eklenecek.</div></div></div>`;
  }
  else if(key==='kitap'){
    content.innerHTML = `<div class="col-12"><div class="card"><div class="muted">Veri yok – sonradan eklenecek.</div></div></div>`;
  }
  else if(key==='personel-odeme'){
    content.innerHTML = `
      <div class="col-12">
        <div class="card">
          <div id="poWrap"></div>
        </div>
      </div>`;
    renderPersonelOdeme();
  }
}
function bindSubtabs(keys, renderer){
  document.querySelectorAll('.subtab').forEach(b=>{
    b.addEventListener('click', ()=>{
      document.querySelectorAll('.subtab').forEach(x=>x.classList.remove('active'));
      b.classList.add('active');
      renderer(b.dataset.sub);
    });
  });
}

/* ====== Alacaklar ====== */
async function renderAlacaklar(which){
  const wrap = document.getElementById('alacaklarWrap');
  if(which==='tahakkuk'){
    wrap.innerHTML = `<div class="grid">
      <div class="col-12">
        <div class="table-wrap"><table id="tTahakkuk">
          <thead><tr>
            <th>Yıl</th><th>Faaliyet</th><th>Personel</th><th>Borçlu</th><th>Tahakkuk</th><th>Not</th><th>DocID</th>
          </tr></thead><tbody></tbody>
        </table></div>
      </div></div>`;
    const snap = await db.collection('tahakkuklar').get();
    const tb = document.querySelector('#tTahakkuk tbody'); tb.innerHTML='';
    snap.forEach(doc=>{
      const d=doc.data()||{};
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${d.yil ?? '—'}</td>
        <td>${d.faaliyet ?? '—'}</td>
        <td>${d.personel ?? '—'}</td>
        <td>${d.borclu ?? '—'}</td>
        <td>${Number(d.tahakkuk||0).toLocaleString('tr-TR')}</td>
        <td>${d.not ?? ''}</td>
        <td class="muted">${doc.id}</td>`;
      tr.addEventListener('click',()=>openEdit('tahakkuklar', doc.id, d, {title:'Tahakkuk Düzenle'}));
      tb.appendChild(tr);
    });
  }else{
    wrap.innerHTML = `<div class="grid">
      <div class="col-12">
        <div class="table-wrap"><table id="tTahsilat">
          <thead><tr>
            <th>Tarih</th><th>Yıl</th><th>Faaliyet</th><th>Personel</th><th>Borçlu</th><th>Tutar</th><th>Ödeme Türü</th><th>Not</th><th>TahakkukID</th><th>DocID</th>
          </tr></thead><tbody></tbody>
        </table></div>
      </div></div>`;
    const snap = await db.collection('tahsilatlar').orderBy('tarih','desc').get().catch(()=>db.collection('tahsilatlar').get());
    const tb = document.querySelector('#tTahsilat tbody'); tb.innerHTML='';
    snap.forEach(doc=>{
      const d=doc.data()||{};
      const tr=document.createElement('tr');
      const dt=fmtDate(toDate(d.tarih));
      tr.innerHTML = `
        <td>${dt}</td>
        <td>${d.yil ?? '—'}</td>
        <td>${d.faaliyet ?? '—'}</td>
        <td>${d.personel ?? '—'}</td>
        <td>${d.borclu ?? '—'}</td>
        <td>${Number(d.tutar||0).toLocaleString('tr-TR')}</td>
        <td>${d.odemeTuru || d.nereyeGeldi || '—'}</td>
        <td>${d.not ?? ''}</td>
        <td class="muted">${d.tahakkukId || '—'}</td>
        <td class="muted">${doc.id}</td>`;
      tr.addEventListener('click',()=>openEdit('tahsilatlar', doc.id, d, {title:'Tahsilat Düzenle'}));
      tb.appendChild(tr);
    });
  }
}

/* ====== Hedef ====== */
async function renderHedef(which){
  const wrap = document.getElementById('hedefWrap');
  if(which==='hedef-gor'){
    wrap.innerHTML = `
      <div class="grid">
        <div class="col-6">
          <div class="card">
            <h3>Personel bazında hedefler</h3>
            <div class="row" style="margin:10px 0">
              <select id="selHedefPersonel" class="input"></select>
              <button class="btn2 brand" id="btnPerLoad">Listele</button>
            </div>
            <div class="table-wrap"><table><thead><tr><th>Personel</th><th>Kategori</th><th>Hedef</th><th>DocID</th></tr></thead><tbody id="tbHedefPer"></tbody></table></div>
          </div>
        </div>
        <div class="col-6">
          <div class="card">
            <h3>Kategori bazında hedefler</h3>
            <div class="row" style="margin:10px 0">
              <select id="selHedefKategori" class="input"></select>
              <button class="btn2 brand" id="btnKatLoad">Listele</button>
            </div>
            <div class="table-wrap"><table><thead><tr><th>Kategori</th><th>Personel</th><th>Hedef</th><th>DocID</th></tr></thead><tbody id="tbHedefKat"></tbody></table></div>
          </div>
        </div>
      </div>`;
    const snap = await db.collection('hedefler').get();
    const persons=new Set(), cats=new Set();
    const cache=[]; snap.forEach(doc=>{ const d=doc.data()||{}; persons.add(d.personel||'—'); cats.add(d.kategori||'—'); cache.push({id:doc.id,...d}); });

    const selP=document.getElementById('selHedefPersonel');
    const selK=document.getElementById('selHedefKategori');
    selP.innerHTML = `<option value="">— Personel seç —</option>` + [...persons].sort().map(x=>`<option>${x}</option>`).join('');
    selK.innerHTML = `<option value="">— Kategori seç —</option>` + [...cats].sort().map(x=>`<option>${x}</option>`).join('');

    document.getElementById('btnPerLoad').onclick=()=>{
      const val=selP.value||''; const tb=document.getElementById('tbHedefPer'); tb.innerHTML='';
      cache.filter(r=>(r.personel||'')===val).forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${r.personel}</td><td>${r.kategori}</td><td>${Number(r.hedef||0).toLocaleString('tr-TR')}</td><td class="muted">${r.id}</td>`;
        tr.addEventListener('click',()=>openEdit('hedefler', r.id, r, {title:'Hedef Düzenle'}));
        tb.appendChild(tr);
      });
    };
    document.getElementById('btnKatLoad').onclick=()=>{
      const val=selK.value||''; const tb=document.getElementById('tbHedefKat'); tb.innerHTML='';
      cache.filter(r=>(r.kategori||'')===val).forEach(r=>{
        const tr=document.createElement('tr');
        tr.innerHTML=`<td>${r.kategori}</td><td>${r.personel}</td><td>${Number(r.hedef||0).toLocaleString('tr-TR')}</td><td class="muted">${r.id}</td>`;
        tr.addEventListener('click',()=>openEdit('hedefler', r.id, r, {title:'Hedef Düzenle'}));
        tb.appendChild(tr);
      });
    };
  }else{ // verileri-gor (tur: 'hedef')
    wrap.innerHTML = `
      <div class="card" style="margin-bottom:12px">
        <div class="grid">
          <div class="col-4"><label class="muted">Kategori</label><select id="vgKategori" class="input"></select></div>
          <div class="col-4"><label class="muted">Personel</label><select id="vgPersonel" class="input"></select></div>
          <div class="col-4"><label class="muted">&nbsp;</label><button class="btn2 brand" id="vgListele">Listele</button></div>
        </div>
      </div>
      <div class="table-wrap"><table>
        <thead><tr><th>Tarih</th><th>Kategori</th><th>Personel</th><th>Ad Soyad</th><th>Miktar</th><th>Tür</th><th>Nereye Geldi</th><th>DocID</th></tr></thead>
        <tbody id="vgBody"></tbody>
      </table></div>`;
    const allSnap = await db.collection('veriler').where('tur','==','hedef').get();
    const cats=new Set(), per=new Set(); const cache=[];
    allSnap.forEach(doc=>{ const d=doc.data()||{}; cats.add(d.kategori||'—'); per.add(d.personel||'—'); cache.push({id:doc.id,...d}); });
    const selK=document.getElementById('vgKategori');
    const selP=document.getElementById('vgPersonel');
    selK.innerHTML=`<option value="">(Tümü)</option>`+[...cats].sort().map(x=>`<option>${x}</option>`).join('');
    selP.innerHTML=`<option value="">(Tümü)</option>`+[...per].sort().map(x=>`<option>${x}</option>`).join('');
    document.getElementById('vgListele').onclick=()=>{
      const k=selK.value||''; const p=selP.value||'';
      const tb=document.getElementById('vgBody'); tb.innerHTML='';
      cache.filter(r=>(!k || r.kategori===k) && (!p || r.personel===p)).forEach(r=>{
        const tr=document.createElement('tr');
        const dt=fmtDate(toDate(r.createdAt));
        tr.innerHTML=`<td>${dt}</td><td>${r.kategori||'—'}</td><td>${r.personel||'—'}</td><td>${r.adSoyad||'—'}</td><td>${Number(r.miktar||0).toLocaleString('tr-TR')}</td><td>${r.tur||'—'}</td><td>${r.nereyeGeldi||'—'}</td><td class="muted">${r.id}</td>`;
        tr.addEventListener('click',()=>openEdit('veriler', r.id, r, {title:'Veri Düzenle'}));
        tb.appendChild(tr);
      });
    };
  }
}

/* ====== Teberru (tur: 'teberru') ====== */
async function renderTeberru(){
  const wrap=document.getElementById('teberruWrap');
  wrap.innerHTML = `
    <div class="card" style="margin-bottom:12px">
      <div class="grid">
        <div class="col-4"><label class="muted">Personel</label><select id="tbPersonel" class="input"></select></div>
        <div class="col-4"><label class="muted">Başlangıç</label><input type="date" id="tbStart" class="input"></div>
        <div class="col-4"><label class="muted">Bitiş</label><input type="date" id="tbEnd" class="input"></div>
      </div>
      <div style="margin-top:10px; display:flex; gap:8px; justify-content:flex-end">
        <button class="btn2 brand" id="tbListele">Listele</button>
      </div>
    </div>
    <div class="table-wrap"><table>
      <thead><tr><th>Tarih</th><th>Personel</th><th>Ad Soyad</th><th>Miktar</th><th>Ödeme Türü</th><th>Kategori</th><th>DocID</th></tr></thead>
      <tbody id="tbBody"></tbody>
    </table></div>`;
  const snap = await db.collection('veriler').where('tur','==','teberru').get();
  const per = new Set(); const cache=[];
  snap.forEach(doc=>{ const d=doc.data()||{}; per.add(d.personel||'—'); cache.push({id:doc.id,...d}); });
  const sel=document.getElementById('tbPersonel');
  sel.innerHTML = `<option value="">(Tüm personel)</option>` + [...per].sort().map(x=>`<option>${x}</option>`).join('');
  document.getElementById('tbListele').onclick=()=>{
    const p=sel.value||''; const s=document.getElementById('tbStart').value; const e=document.getElementById('tbEnd').value;
    const sDate = s? new Date(s+'T00:00:00'): null;
    const eDate = e? new Date(e+'T23:59:59'): null;
    const tb=document.getElementById('tbBody'); tb.innerHTML='';
    cache.filter(r=>{
      if(p && r.personel!==p) return false;
      const d=toDate(r.createdAt);
      if(sDate && (!d || d<sDate)) return false;
      if(eDate && (!d || d>eDate)) return false;
      return true;
    }).forEach(r=>{
      const tr=document.createElement('tr');
      tr.innerHTML = `<td>${fmtDate(toDate(r.createdAt))}</td><td>${r.personel||'—'}</td><td>${r.adSoyad||'—'}</td><td>${Number(r.miktar||0).toLocaleString('tr-TR')}</td><td>${r.nereyeGeldi||'—'}</td><td>${r.kategori||'—'}</td><td class="muted">${r.id}</td>`;
      tr.addEventListener('click',()=>openEdit('veriler', r.id, r, {title:'Teberru Düzenle'}));
      tb.appendChild(tr);
    });
  };
}

/* ====== Personel Ödeme ====== */
async function renderPersonelOdeme(){
  const host=document.getElementById('poWrap');
  host.innerHTML = `
    <div class="card" style="margin-bottom:12px">
      <div class="grid">
        <div class="col-4"><label class="muted">Ödeme Türü</label>
          <select id="poTur" class="input">
            <option value="hediye">Hediye</option>
            <option value="kira">Kira</option>
            <option value="diger">Diğer (çocuk-yol-haberleşme)</option>
            <option value="maas">Resmi Maaş</option>
          </select>
        </div>
        <div class="col-4"><label class="muted">Personel</label><select id="poPer" class="input"></select></div>
        <div class="col-2"><label class="muted">Yıl</label><input id="poYil" class="input" type="number" placeholder="2025"></div>
        <div class="col-2"><label class="muted">Ay</label>
          <select id="poAy" class="input">
            <option value="">(Tümü)</option>
            ${[1,2,3,4,5,6,7,8,9,10,11,12].map(m=>`<option value="${m}">${m}</option>`).join('')}
          </select>
        </div>
      </div>
      <div style="margin-top:10px; display:flex; gap:8px; justify-content:flex-end">
        <button class="btn2 brand" id="poListele">Listele</button>
      </div>
    </div>
    <div class="table-wrap"><table>
      <thead id="poHead"></thead><tbody id="poBody"></tbody>
    </table></div>`;

  const snap = await db.collection('personel_odeme').get();
  const per=new Set(); const cache=[];
  snap.forEach(doc=>{ const d=doc.data()||{}; per.add(d.ad||d.personel||'—'); cache.push({id:doc.id,...d}); });
  document.getElementById('poPer').innerHTML = `<option value="">(Tümü)</option>` + [...per].sort().map(x=>`<option>${x}</option>`).join('');
  document.getElementById('poYil').value = new Date().getFullYear();

  function renderRows(){
    const tur=document.getElementById('poTur').value;
    const p = document.getElementById('poPer').value||'';
    const y = Number(document.getElementById('poYil').value||0);
    const m = document.getElementById('poAy').value||'';
    const head=document.getElementById('poHead');
    const body=document.getElementById('poBody'); body.innerHTML='';

    if(tur==='hediye'){
      head.innerHTML=`<tr><th>Yıl</th><th>Ay</th><th>Personel</th><th>Hediye</th><th>Ödendi?</th><th>Toplam</th><th>DocID</th></tr>`;
      cache.filter(r=>(!p|| (r.ad||r.personel)===p) && (!y || r.yil==y) && (!m || r.ay==m)).forEach(r=>{
        const od = r.odemeler?.hediye===true;
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${r.yil||'—'}</td><td>${r.ay||'—'}</td><td>${r.ad||r.personel||'—'}</td><td>${Number(r.hediye||0).toLocaleString('tr-TR')}</td><td><span class="pill-badge ${od?'ok':'no'}">${od?'ödendi':'ödenmedi'}</span></td><td>${Number(r.toplam||0).toLocaleString('tr-TR')}</td><td class="muted">${r.id}</td>`;
        tr.addEventListener('click',()=>openEdit('personel_odeme', r.id, r, {title:'Hediye Ödemesi'}));
        body.appendChild(tr);
      });
    }else if(tur==='kira'){
      head.innerHTML=`<tr><th>Yıl</th><th>Ay</th><th>Personel</th><th>Kira</th><th>Ödendi?</th><th>Toplam</th><th>DocID</th></tr>`;
      cache.filter(r=>(!p|| (r.ad||r.personel)===p) && (!y || r.yil==y) && (!m || r.ay==m)).forEach(r=>{
        const od = r.odemeler?.kira===true;
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${r.yil||'—'}</td><td>${r.ay||'—'}</td><td>${r.ad||r.personel||'—'}</td><td>${Number(r.kira||0).toLocaleString('tr-TR')}</td><td><span class="pill-badge ${od?'ok':'no'}">${od?'ödendi':'ödenmedi'}</span></td><td>${Number(r.toplam||0).toLocaleString('tr-TR')}</td><td class="muted">${r.id}</td>`;
        tr.addEventListener('click',()=>openEdit('personel_odeme', r.id, r, {title:'Kira Ödemesi'}));
        body.appendChild(tr);
      });
    }else if(tur==='diger'){
      head.innerHTML=`<tr><th>Yıl</th><th>Ay</th><th>Personel</th><th>Çocuk</th><th>Yol</th><th>Haberleşme</th><th>Ödenenler</th><th>Toplam</th><th>DocID</th></tr>`;
      cache.filter(r=>(!p|| (r.ad||r.personel)===p) && (!y || r.yil==y) && (!m || r.ay==m)).forEach(r=>{
        const flags = r.odemeler||{};
        const odList = ['cocuk','yol','haberlesme'].filter(k=>flags[k]).join(', ') || '—';
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${r.yil||'—'}</td><td>${r.ay||'—'}</td><td>${r.ad||r.personel||'—'}</td>
          <td>${Number(r.cocuk||0).toLocaleString('tr-TR')}</td>
          <td>${Number(r.yol||0).toLocaleString('tr-TR')}</td>
          <td>${Number(r.haberlesme||0).toLocaleString('tr-TR')}</td>
          <td>${odList}</td>
          <td>${Number(r.toplam||0).toLocaleString('tr-TR')}</td>
          <td class="muted">${r.id}</td>`;
        tr.addEventListener('click',()=>openEdit('personel_odeme', r.id, r, {title:'Diğer Ödemeler'}));
        body.appendChild(tr);
      });
    }else{
      head.innerHTML=`<tr><th>Yıl</th><th>Ay</th><th>Personel</th><th>Maaş</th><th>Durum</th><th>DocID</th></tr>`;
      cache.filter(r=>(!p|| (r.ad||r.personel)===p) && (!y || r.yil==y) && (!m || r.ay==m)).forEach(r=>{
        const durum = (r.maas||'-').toString().toLowerCase();
        const od = durum==='ödendi' || durum==='odendi';
        const tr=document.createElement('tr');
        tr.innerHTML = `<td>${r.yil||'—'}</td><td>${r.ay||'—'}</td><td>${r.ad||r.personel||'—'}</td><td>-</td><td><span class="pill-badge ${od?'ok':'no'}">${od?'ödendi':'ödenmedi'}</span></td><td class="muted">${r.id}</td>`;
        tr.addEventListener('click',()=>openEdit('personel_odeme', r.id, r, {title:'Resmi Maaş'}));
        body.appendChild(tr);
      });
    }
  }
  document.getElementById('poListele').onclick=renderRows;
  document.getElementById('poTur').onchange=renderRows;
  renderRows();
}

/* ===== Modal: Düzenle & Sil (GENEL) ===== */
let __modalCtx = null;
function openEdit(col, id, data, opt={}){
  __modalCtx = {col,id,orig:data};
  document.getElementById('modalTitle').textContent = opt.title || 'Düzenle';

  const keys = Object.keys(data||{}).sort();
  const form = document.createElement('div');
  form.innerHTML = keys.map(k=>{
    const v = data[k];
    const isTime = (v instanceof Date) || (v && typeof v.toDate==='function') || /tarih|createdat/i.test(k);
    const t = isTime ? 'datetime-local' : (typeof v === 'number' ? 'number' : 'text');
    const val = isTime
      ? (toDate(v)? new Date(toDate(v).getTime()-new Date().getTimezoneOffset()*60000).toISOString().slice(0,16) : '')
      : (v ?? '');
    return `<div style="margin:8px 0">
      <label class="muted" style="display:block;margin-bottom:6px">${k}</label>
      <input class="input" data-k="${k}" type="${t}" value="${val}">
    </div>`;
  }).join('');
  const cont=document.getElementById('modalContent'); cont.innerHTML=''; cont.appendChild(form);

  document.getElementById('modalSave').onclick = async ()=>{
    try{
      const inputs=[...form.querySelectorAll('input[data-k]')];
      const patch={};
      inputs.forEach(inp=>{
        const key=inp.dataset.k; let val=inp.value;
        if(inp.type==='number'){ val = Number(val); if(isNaN(val)) val = 0; }
        else if(inp.type==='datetime-local'){ val = val? new Date(val): null; }
        patch[key]=val;
      });
      // timestamp alanı boş bırakıldıysa orijinali koru
      for(const k of Object.keys(__modalCtx.orig||{})){
        if((/createdat|tarih/i).test(k) && (patch[k]==='' || patch[k]===null)) delete patch[k];
      }
      await db.collection(__modalCtx.col).doc(__modalCtx.id).update(patch);
      showToast('Güncellendi.');
      closeModal(true);
    }catch(e){ console.error(e); showToast('Güncelleme hatası.'); }
  };
  document.getElementById('modalDelete').onclick = async ()=>{
    if(!confirm('Bu kaydı silmek istediğine emin misin?')) return;
    try{
      await db.collection(__modalCtx.col).doc(__modalCtx.id).delete();
      showToast('Silindi.');
      closeModal(true);
    }catch(e){ console.error(e); showToast('Silme hatası.'); }
  };

  document.getElementById('modalBack').style.display='flex';
}
function closeModal(refresh){
  document.getElementById('modalBack').style.display='none';
  if(refresh){
    const activeMain = document.querySelector('.tab.active')?.dataset.tab || 'alacaklar';
    renderMainTab(activeMain);
  }
}

/* ===== Auth & Başlat ===== */
auth.onAuthStateChanged(async (user)=>{
  if(!user){ location.replace('/index.html'); return; }
  try{
    setToday();
    // kullanıcı adı (opsiyonel)
    const uSnap = await db.collection('kullanicilar').doc(user.uid).get().catch(()=>null);
    const data = uSnap?.exists ? uSnap.data(): {};
    document.getElementById('profName').textContent = (data.adSoyad?.split(' ')[0]) || 'Profil';

    // menü manifest + nav
    const panels = await fetchPanels();
    renderNav(panels);

    // ilk sekme
    await renderMainTab('alacaklar');
  }catch(e){ console.error(e); showToast('Sayfa yüklenirken hata.'); }
});
</script>

</body>
</html>
