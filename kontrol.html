<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8"/>
  <title>N√∂bet Tekerr√ºr Kontrol√º</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <!-- Projene uygun: window.db saƒülayan init -->
  <script src="../js/firebase/firebase-init.js"></script>

  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --ink:#111; --muted:#778; --danger:#ffeded; --danger-ink:#a11;
      --ok:#e8fff0; --ok-ink:#0a8833; --border:#e5e7eb; --radius:14px;
      --thead-top:64px; /* sticky thead ofseti (header y√ºksekliƒüi) */
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);font:14px/1.5 system-ui,-apple-system,Segoe UI,Roboto,Arial}
    header{position:sticky;top:0;background:var(--card);border-bottom:1px solid var(--border);padding:10px 16px;z-index:5}
    h1{margin:0;font-size:18px}
    .wrap{max-width:1100px;margin:18px auto;padding:0 16px}

    .toolbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin:12px 0}
    .toolbar .card{background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:10px 12px;display:flex;gap:12px;align-items:center}
    .toolbar input[type="search"]{border:1px solid var(--border);border-radius:10px;padding:8px 10px;min-width:220px;background:#fff}
    .toolbar label{display:flex;align-items:center;gap:6px;color:var(--muted)}
    .btn{border:1px solid var(--border);background:#111;color:#fff;border-radius:10px;padding:8px 12px;cursor:pointer}
    .btn.secondary{background:#fff;color:#111}
    .btn.danger{background:#b91818}
    .btn:disabled{opacity:.5;cursor:not-allowed}

    .footer{display:flex;justify-content:space-between;align-items:center;margin-top:10px;color:var(--muted)}
    .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid var(--border);font-size:12px;color:#333;background:#fff}
    .pill.role{font-weight:600}
    .pill.week{color:#0a3b8a;border-color:#bcd}
    .muted{color:var(--muted)}
    .count-ok{color:var(--ok-ink);background:var(--ok);padding:2px 6px;border-radius:8px}
    .count-dup{color:var(--danger-ink);background:var(--danger);padding:2px 6px;border-radius:8px}
    .reason{font-size:12px}
    .id-cell{font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;font-size:12px;color:#555}

    /* TABLO ‚Äî hizalama i√ßin colgroup + fixed layout */
    .table-wrap{margin-top:8px;border:1px solid var(--border);border-radius:12px;overflow:hidden;background:var(--card)}
    .table-scroll{max-height:65vh;overflow:auto}
    table{width:100%;border-collapse:separate;border-spacing:0;table-layout:fixed}
    col.select-col{width:36px}
    col.date{width:130px}
    col.day{width:110px}
    col.person{width:220px}
    col.role{width:90px}
    col.time{width:130px}
    col.week{width:110px}
    col.reason{width:auto}
    col.id{width:200px}

    thead th{position:sticky;top:var(--thead-top);background:#fafafa;border-bottom:1px solid var(--border);padding:10px;font-weight:600;font-size:12px;color:#555;z-index:2;text-align:left}
    tbody td{border-bottom:1px solid var(--border);padding:10px;vertical-align:middle}
    tbody tr:nth-child(even){background:#fcfcfe}
    tbody tr.dup{background:var(--danger);color:var(--danger-ink)}
    tbody tr.ok{background:#fff}
    .select-col input{display:block;margin:auto}
  </style>
</head>
<body>
  <header>
    <h1>üßπ N√∂bet Tekerr√ºr Kontrol√º</h1>
    <div class="muted" style="font-size:12px">Aynƒ± <b>g√ºn-rol</b> veya aynƒ± <b>g√ºn-ki≈üi</b> √ßakƒ±≈ümalarƒ± kƒ±rmƒ±zƒ± g√∂sterilir. Se√ßip silebilirsin.</div>
  </header>

  <div class="wrap">
    <div class="toolbar">
      <div class="card">
        <button class="btn secondary" id="btnRefresh">Yenile</button>
        <input id="q" type="search" placeholder="Ara: ki≈üi, g√ºn, YYYY-MM-DD‚Ä¶"/>
        <label><input id="onlyDup" type="checkbox"/> Sadece tekerr√ºrleri g√∂ster</label>
        <label><input id="alsoPlan" type="checkbox" checked/> <b>nobet_planlari</b>'ndan da sil</label>
      </div>
      <div class="card">
        <button class="btn danger" id="btnDelete" disabled>Sil (se√ßili)</button>
        <button class="btn secondary" id="btnExport">CSV indir</button>
      </div>
    </div>

    <div class="footer">
      <div>
        <span id="countTotal" class="pill">0 kayƒ±t</span>
        <span id="countDup" class="pill count-dup">0 tekerr√ºr</span>
      </div>
      <div class="muted">Koleksiyon: <code>nobet_index</code> ‚Ä¢ Plan: <code>nobet_planlari/{weekKey}</code></div>
    </div>

    <div class="table-wrap">
      <div class="table-scroll">
        <table id="tbl">
          <!-- S√ºtun geni≈üliklerini sabitle -->
          <colgroup>
            <col class="select-col"><col class="date"><col class="day"><col class="person">
            <col class="role"><col class="time"><col class="week"><col class="reason"><col class="id">
          </colgroup>
          <thead>
          <tr>
            <th class="select-col"><input type="checkbox" id="chkAll"/></th>
            <th>Tarih</th>
            <th>G√ºn</th>
            <th>Ki≈üi</th>
            <th>Rol</th>
            <th>Saat</th>
            <th>Hafta</th>
            <th>Neden</th>
            <th>Doc ID</th>
          </tr>
          </thead>
          <tbody id="tbody">
            <tr><td colspan="9" class="muted" style="text-align:center;padding:24px">Veri y√ºkleniyor‚Ä¶</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <div class="footer">
      <div class="muted" style="font-size:12px">Temizlik sonrasƒ±, ‚Äún√∂bet ayarla‚Äù kaydƒ±na g√ºn-rol / g√ºn-ki≈üi kontrol√º ekleyeceƒüiz ki tekrar olu≈ümasƒ±n.</div>
    </div>
  </div>

<script>
/** =========  AYARLAR  ========= **/
const COLL_INDEX = 'nobet_index';
const COLL_PLAN  = 'nobet_planlari';

/** =========  DURUM  ========= **/
let ALL = [];
let VIEW = [];
let DUP_REASON = {};
let SELECTED = new Set();

const $ = (s) => document.querySelector(s);
const $$ = (s) => document.querySelectorAll(s);

/** =========  Y√úKLEME (Tarihe g√∂re SIRALI) ========= **/
async function loadAll() {
  $('#tbody').innerHTML = `<tr><td colspan="9" class="muted" style="text-align:center;padding:24px">Y√ºkleniyor‚Ä¶</td></tr>`;
  SELECTED.clear();
  $('#btnDelete').disabled = true;

  // Tarihe g√∂re artan sƒ±ra. En yeniler √ºstte olsun dersen: orderBy('date','desc')
  const snap = await db.collection(COLL_INDEX).orderBy('date').get();
  ALL = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));

  DUP_REASON = findDuplicates(ALL);
  applyFilters();
}

/** =========  TEKERR√úR TESPƒ∞Tƒ∞ ========= **/
function findDuplicates(rows) {
  const reasonsById = {};
  const byDateRole = new Map();
  const byDatePerson = new Map();

  for (const r of rows) {
    const k1 = `${r.date}__${(r.role||'').toLowerCase()}`;
    const k2 = `${r.date}__${(r.person||'').toLowerCase()}`;
    if (!byDateRole.has(k1)) byDateRole.set(k1, []);
    if (!byDatePerson.has(k2)) byDatePerson.set(k2, []);
    byDateRole.get(k1).push(r);
    byDatePerson.get(k2).push(r);
  }

  const mark = (arr, reason) => {
    if (!arr || arr.length < 2) return;
    for (const r of arr) {
      if (!reasonsById[r.id]) reasonsById[r.id] = [];
      reasonsById[r.id].push(reason);
    }
  };

  for (const [, arr] of byDateRole) mark(arr, 'Aynƒ± g√ºn-rol √ßakƒ±≈ümasƒ±');
  for (const [, arr] of byDatePerson) mark(arr, 'Aynƒ± g√ºn-ki≈üi √ßakƒ±≈ümasƒ±');

  return reasonsById;
}

/** =========  Fƒ∞LTRE / RENDER ========= **/
function applyFilters() {
  const q = $('#q').value.trim().toLowerCase();
  const onlyDup = $('#onlyDup').checked;

  VIEW = ALL.filter(r => {
    if (onlyDup && !DUP_REASON[r.id]) return false;
    if (!q) return true;
    const hay = `${r.person} ${r.role} ${r.date} ${r.day} ${r.weekKey} ${r.id}`.toLowerCase();
    return hay.includes(q);
  });

  renderTable(VIEW);
  $('#countTotal').textContent = `${ALL.length} kayƒ±t`;
  $('#countDup').textContent = `${Object.keys(DUP_REASON).length} tekerr√ºr`;
}

function renderTable(rows) {
  const tbody = $('#tbody');
  if (!rows.length) {
    tbody.innerHTML = `<tr><td colspan="9" class="muted" style="text-align:center;padding:24px">Kayƒ±t bulunamadƒ±.</td></tr>`;
    return;
  }

  tbody.innerHTML = rows.map(r => {
    const dup = !!DUP_REASON[r.id];
    const reasons = (DUP_REASON[r.id] || []).join(' + ');
    const checked = SELECTED.has(r.id) ? 'checked' : '';
    return `
      <tr class="${dup ? 'dup' : 'ok'}" data-id="${r.id}">
        <td class="select-col"><input type="checkbox" class="rowchk" data-id="${r.id}" ${checked}/></td>
        <td><span class="pill">${r.date || '-'}</span></td>
        <td>${r.day || '-'}</td>
        <td>${r.person || '-'}</td>
        <td><span class="pill role">${r.role || '-'}</span></td>
        <td>${r.saat || '-'}</td>
        <td><span class="pill week">${r.weekKey || '-'}</span></td>
        <td class="reason">${reasons || '<span class="muted">‚Äî</span>'}</td>
        <td class="id-cell">${r.id}</td>
      </tr>
    `;
  }).join('');

  $$('.rowchk').forEach(chk => {
    chk.addEventListener('change', (e) => {
      const id = e.target.dataset.id;
      if (e.target.checked) SELECTED.add(id); else SELECTED.delete(id);
      $('#btnDelete').disabled = SELECTED.size === 0;
    });
  });

  // T√ºm√ºn√º se√ß
  $('#chkAll').checked = rows.length && rows.every(r => SELECTED.has(r.id));
}

/** =========  Sƒ∞LME ========= **/
async function deleteSelected() {
  if (SELECTED.size === 0) return;
  const alsoPlan = $('#alsoPlan').checked;
  if (!confirm(`${SELECTED.size} kaydƒ± silmek √ºzeresin. ${alsoPlan ? "Planlardan da kaldƒ±rƒ±lacak." : ""} Emin misin?`)) return;

  const toDelete = ALL.filter(r => SELECTED.has(r.id));

  // 1) nobet_index sil
  let batch = db.batch();
  let i = 0;
  for (const r of toDelete) {
    batch.delete(db.collection(COLL_INDEX).doc(r.id));
    i++;
    if (i % 450 === 0) { await batch.commit(); batch = db.batch(); }
  }
  if (i % 450) await batch.commit();

  // 2) Planlardan √ßƒ±kar (opsiyonel)
  if (alsoPlan) {
    const planByWeek = new Map();
    for (const r of toDelete) {
      if (!r.weekKey) continue;
      if (!planByWeek.has(r.weekKey)) planByWeek.set(r.weekKey, []);
      planByWeek.get(r.weekKey).push(r);
    }

    for (const [week, rows] of planByWeek) {
      const docRef = db.collection(COLL_PLAN).doc(week);
      const snap = await docRef.get();
      if (!snap.exists) continue;
      const data = snap.data() || {};
      const arr = Array.isArray(data.rows) ? data.rows : [];

      const filtered = arr.filter(item => {
        const tarihISO = item.tarihISO || item.tarih || '';
        return !rows.some(r => {
          const sameDay = r.date === tarihISO;
          if (!sameDay) return false;
          const rl = (r.role||'').toLowerCase();
          if (rl === 'bekar') return item.bekar === r.person;
          if (rl === 'evli')  return item.evli  === r.person;
          return (item.bekar === r.person) || (item.evli === r.person);
        });
      });

      await docRef.update({ rows: filtered });
    }
  }

  alert('Silme i≈ülemi tamamlandƒ±.');
  await loadAll();
}

/** =========  CSV ========= **/
function exportCSV() {
  const rows = VIEW;
  if (!rows.length) return;
  const header = ['id','date','day','person','role','saat','weekKey','year','monthKey','type','duplicateReasons'];
  const lines = [header.join(',')];
  for (const r of rows) {
    const reasons = (DUP_REASON[r.id]||[]).join('|');
    const vals = [
      r.id, r.date||'', r.day||'', r.person||'', r.role||'', r.saat||'',
      r.weekKey||'', r.year||'', r.monthKey||'', r.type||'', reasons
    ].map(v => `"${String(v).replace(/"/g,'""')}"`);
    lines.push(vals.join(','));
  }
  const blob = new Blob([lines.join('\n')], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `nobet_kontrol_${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a); a.click(); a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 500);
}

/** =========  OLAYLAR ========= **/
$('#btnRefresh').addEventListener('click', loadAll);
$('#q').addEventListener('input', applyFilters);
$('#onlyDup').addEventListener('change', applyFilters);
$('#chkAll').addEventListener('change', (e) => {
  if (!VIEW.length) return;
  if (e.target.checked) VIEW.forEach(r => SELECTED.add(r.id));
  else VIEW.forEach(r => SELECTED.delete(r.id));
  $('#btnDelete').disabled = SELECTED.size === 0;
  renderTable(VIEW);
});
$('#btnDelete').addEventListener('click', deleteSelected);
$('#btnExport').addEventListener('click', exportCSV);

/** =========  BA≈ûLAT ========= **/
loadAll().catch(err => {
  console.error(err);
  $('#tbody').innerHTML = `<tr><td colspan="9" style="color:#a11;text-align:center;padding:24px">Hata: ${err.message}</td></tr>`;
});
</script>
</body>
</html>
