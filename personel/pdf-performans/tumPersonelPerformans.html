<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Tüm Personel Performans Özet Raporu</title>
  <style>
    /* ===== Kurum İçi Personel Değerlendirme – Modern, yumuşak, renkli tasarım ===== */
    html { overflow-x: hidden; }
    body {
      margin: 0;
      font-family: Calibri, Candara, 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(180deg, #f0f7f4 0%, #e8f2ee 50%, #f5f9f7 100%);
      color: #1a1a2e;
      overflow-x: hidden;
      word-wrap: break-word;
    }
    .sayfa {
      width: 100%;
      max-width: 800px;
      margin: 20px auto;
      background-color: #fffefc;
      padding: 36px 44px;
      box-sizing: border-box;
      border-radius: 15px;
      box-shadow: 0 6px 28px rgba(45, 90, 58, 0.08);
      border: 1px solid rgba(45, 106, 79, 0.12);
      page-break-after: auto;
      overflow-x: hidden;
      overflow-wrap: break-word;
    }
    /* Kapak – minimal, okunaklı, kurum içi */
    .kapak-sayfa {
      text-align: center;
      padding: 88px 48px 72px;
      min-height: 560px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 6px 24px rgba(45, 106, 79, 0.06);
      border: 1px solid rgba(45, 106, 79, 0.12);
      margin: 20px auto;
      max-width: 800px;
    }
    .kapak-icerik {
      width: 100%;
      max-width: 460px;
    }
    .kapak-baslik {
      font-size: 56px;
      font-weight: 700;
      color: #0f172a;
      margin: 0;
      letter-spacing: 3px;
      font-family: Calibri, Candara, 'Segoe UI', Arial, sans-serif;
      line-height: 1.15;
    }
    .kapak-cizgi {
      width: 200px;
      height: 4px;
      background: linear-gradient(90deg, transparent, #2d6a4f, transparent);
      margin: 40px auto 44px;
      border-radius: 2px;
    }
    .kapak-alt-baslik {
      font-size: 21px;
      color: #374151;
      margin-bottom: 10px;
      font-weight: 600;
      letter-spacing: 0.4px;
      line-height: 1.35;
    }
    .kapak-alt-baslik::before {
      content: '1. ';
      color: #2d6a4f;
      font-weight: 700;
    }
    .kapak-ozet-alt {
      font-size: 13px;
      color: #6b7280;
      margin: 0 0 38px 0;
      line-height: 1.55;
      padding: 0 4px;
    }
    .kapak-alt-baslik--ikinci {
      margin-bottom: 10px;
      margin-top: 4px;
      font-size: 21px;
      color: #1b5e20;
    }
    .kapak-alt-baslik--ikinci::before {
      content: '2. ';
      color: #2d6a4f;
      font-weight: 700;
    }
    .kapak-personel-ismi {
      font-size: 40px;
      font-weight: 600;
      color: #1f2937;
      margin-top: 16px;
      margin-bottom: 44px;
    }
    .kapak-ozet {
      text-align: center;
      font-size: 12px;
      line-height: 1.7;
      color: #4b5563;
      margin: 0;
      padding: 24px 12px 0;
      border-top: 1px solid rgba(45, 106, 79, 0.08);
    }
    .kapak-ozet h3 {
      display: none;
    }
    .kapak-ozet p {
      margin: 0;
    }
    .kapak-tarih {
      font-size: 18px;
      color: #9ca3af;
      margin-top: 40px;
      padding-top: 20px;
      border-top: 1px solid #e5e7eb;
      letter-spacing: 0.3px;
    }
    /* Sayfa başlıkları – kapak hariç içerik sıkı */
    .baslik {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 10px;
      border-bottom: 2px solid transparent;
      border-image: linear-gradient(90deg, #2d6a4f 0%, #40916c 50%, transparent 100%) 1;
    }
    .baslik-sag {
      text-align: right;
      font-size: 10px;
      color: #5c6b73;
      line-height: 1.3;
    }
    .baslik-sol h1 {
      font-size: 17px;
      margin: 0 0 4px 0;
      color: #1b5e20;
      letter-spacing: 0.5px;
    }
    .baslik-sol h2 {
      font-size: 13px;
      font-weight: normal;
      margin: 0;
      color: #5c6b73;
      letter-spacing: 0.3px;
    }
    .filtre-bilgi {
      font-size: 11px;
      color: #5c6b73;
      margin-bottom: 10px;
      padding: 6px 10px;
      background: rgba(232, 245, 233, 0.6);
      border-radius: 10px;
      border: 1px solid rgba(46, 125, 50, 0.15);
    }
    .kpi-container {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-bottom: 16px;
    }
    .kpi-item {
      background: #fff;
      border: 1px solid rgba(45, 106, 79, 0.15);
      padding: 8px 10px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 2px 12px rgba(0, 0, 0, 0.04);
    }
    .kpi-item .lbl { font-size: 10px; color: #5c6b73; margin-bottom: 4px; }
    .kpi-item .val { font-size: 14px; font-weight: bold; color: #2d6a4f; }
    .kpi-item .val.iyi { color: #2d6a4f; }
    .kpi-item .val.kotu { color: #1a1a2e; }

    .alt-baslik {
      font-size: 14px;
      font-weight: 600;
      margin: 18px 0 10px 0;
      color: #1b5e20;
      letter-spacing: 0.5px;
      padding-bottom: 6px;
      border-bottom: 2px solid rgba(45, 106, 79, 0.2);
      border-radius: 0 0 4px 0;
    }

    .personel-kimlik {
      display: grid;
      grid-template-columns: 1.3fr 1.7fr;
      gap: 10px;
      font-size: 11px;
      margin-bottom: 12px;
    }
    .personel-kimlik .etiket { font-weight: 600; color: #374151; width: 130px; display: inline-block; }
    .personel-kimlik p { margin: 2px 0; color: #1a1a2e; }
    .personel-not { font-size: 10px; color: #5c6b73; margin-top: 4px; }

    /* Kart sistemi – veri blokları, sık satır aralığı */
    .rapor-bolumu {
      margin-top: 14px;
      padding: 14px 16px;
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
      border: 1px solid rgba(45, 106, 79, 0.1);
      max-width: 100%;
      overflow-wrap: break-word;
    }
    .rapor-bolumu h3 {
      margin: 0 0 10px 0;
      font-size: 14px;
      color: #1b5e20;
      letter-spacing: 0.4px;
      padding-bottom: 6px;
      border-bottom: 2px solid transparent;
      border-image: linear-gradient(90deg, #40916c 0%, transparent 100%) 1;
    }
    .rapor-bolumu p {
      margin: 4px 0;
      font-size: 11px;
      line-height: 1.4;
      color: #1a1a2e;
    }
    .yil-ozetleri { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-top: 8px; }
    .yil-kutu {
      background: #f8fbf9;
      border-radius: 10px;
      border: 1px solid rgba(45, 106, 79, 0.12);
      padding: 8px 10px;
      font-size: 10px;
      box-shadow: 0 1px 8px rgba(0, 0, 0, 0.03);
    }
    .yil-kutu h4 { margin: 0 0 4px 0; font-size: 11px; color: #1b5e20; }
    .yil-kutu ul { margin: 0; padding-left: 14px; }
    .yil-kutu li { margin: 2px 0; }
    .yorum-listesi { margin: 4px 0 0 0; padding-left: 16px; font-size: 11px; line-height: 1.35; }
    .yorum-listesi li { margin: 2px 0; }
    .yorum-etiket { font-weight: 600; color: #1a1a2e; }

    /* Tablolar – daha sık satır aralığı */
    .tablo {
      width: 100%;
      max-width: 100%;
      border-collapse: collapse;
      margin: 8px 0;
      font-size: 11px;
      table-layout: fixed;
      border-radius: 10px;
      overflow: hidden;
    }
    .tablo th, .tablo td {
      border: 1px solid rgba(45, 106, 79, 0.12);
      padding: 5px 8px;
      text-align: left;
      word-wrap: break-word;
      overflow-wrap: break-word;
      line-height: 1.3;
    }
    .tablo th {
      color: #fff;
      font-weight: 600;
      letter-spacing: 0.3px;
    }
    .tablo.tablo--genel thead th {
      background: linear-gradient(135deg, #2d6a4f 0%, #40916c 100%);
    }
    .tablo.tablo--mavi thead th {
      background: linear-gradient(135deg, #3d5a80 0%, #5c7cfa 100%);
    }
    .tablo.tablo--kahve thead th {
      background: linear-gradient(135deg, #6b5b4f 0%, #8b7355 100%);
    }
    .tablo.tablo--mor thead th {
      background: linear-gradient(135deg, #5a4d6a 0%, #7c6b8f 100%);
    }
    .tablo.tablo--kira thead th {
      background: linear-gradient(135deg, #c46c43 0%, #e07a5f 100%);
    }
    /* Ödeme Tipleri tablosu – sütun genişlikleri (manuel ayarlanabilir) */
    .tablo.tablo--odeme-artis { table-layout: fixed; width: 100%; }
    .tablo.tablo--odeme-artis col:nth-child(1) { width: 120px; }  /* Ödeme Tipi */
    .tablo.tablo--odeme-artis col:nth-child(2) { width: 90px; }   /* 2023 */
    .tablo.tablo--odeme-artis col:nth-child(3) { width: 90px; }   /* 2024 */
    .tablo.tablo--odeme-artis col:nth-child(4) { width: 90px; }   /* 2025 */
    .tablo.tablo--odeme-artis col:nth-child(5) { width: 100px; }  /* 2026 Planlanan */
    .tablo.tablo--odeme-artis col:nth-child(6) { width: 130px; }  /* 2025-2026 Artış */
    .tablo.tablo--hedef thead th {
      background: linear-gradient(135deg, #2d6a4f 0%, #40916c 100%);
    }
    /* Personel Sıralaması – sütun genişlikleri (taşma önleme), yatay kaydırma gerekirse */
    .tablo-wrapper--siralama { overflow-x: auto; max-width: 100%; margin: 8px 0; -webkit-overflow-scrolling: touch; }
    .tablo.tablo--personel-siralama { table-layout: fixed; width: 100%; min-width: 680px; font-size: 10px; }
    .tablo.tablo--personel-siralama col:nth-child(1) { width: 28px; }
    .tablo.tablo--personel-siralama col:nth-child(2) { width: 110px; }
    .tablo.tablo--personel-siralama col:nth-child(3) { width: 88px; }
    .tablo.tablo--personel-siralama col:nth-child(4) { width: 88px; }
    .tablo.tablo--personel-siralama col:nth-child(5) { width: 80px; }
    .tablo.tablo--personel-siralama col:nth-child(6) { width: 88px; }
    .tablo.tablo--personel-siralama col:nth-child(7) { width: 78px; }
    .tablo.tablo--personel-siralama col:nth-child(8) { width: 58px; }
    .tablo.tablo--hedef-detay { table-layout: fixed; width: 100%; }
    .tablo.tablo--hedef-detay col:nth-child(1) { width: 50px; }
    .tablo.tablo--hedef-detay col:nth-child(2) { width: 140px; }
    .tablo.tablo--hedef-detay col:nth-child(3) { width: 85px; }
    .tablo.tablo--hedef-detay col:nth-child(4) { width: 85px; }
    .tablo.tablo--hedef-detay col:nth-child(5) { width: 60px; }
    .tablo.tablo--hedef-detay col:nth-child(6) { width: 65px; }
    .tablo.tablo--hedef-detay col:nth-child(7) { width: 95px; }
    .rapor-bolumu--kucuk { margin-top: 10px; padding: 10px 12px; }
    .rapor-bolumu--kucuk h3 { margin: 0 0 8px 0; font-size: 12px; }
    .tablo.tablo--kucuk { font-size: 10px; margin: 6px 0; }
    .tablo.tablo--kucuk th, .tablo.tablo--kucuk td { padding: 4px 6px; }
    .tablo tr:nth-child(even) {
      background-color: #f8fbf9;
    }
    .tablo .sayi {
      text-align: right;
      font-family: Calibri, Candara, 'Segoe UI', Arial, sans-serif;
    }
    .artis-pozitif {
      color: #2d6a4f;
      font-weight: 600;
    }
    .artis-negatif {
      color: #c46c43;
      font-weight: 600;
    }
    .artis-nor {
      color: #3d5a80;
      font-weight: 600;
    }
    .sayfa-ayirici {
      page-break-before: always;
      margin-top: 28px;
      padding-top: 20px;
      border-top: 2px solid transparent;
      border-image: linear-gradient(90deg, #2d6a4f 0%, #40916c 40%, transparent 100%) 1;
    }
    .btn-alani { text-align: center; margin-top: 32px; }
    button {
      padding: 12px 24px;
      background: linear-gradient(135deg, #3d5a80 0%, #5c7cfa 100%);
      border: none;
      color: #fff;
      font-size: 15px;
      font-family: Calibri, Candara, 'Segoe UI', Arial, sans-serif;
      border-radius: 15px;
      cursor: pointer;
      box-shadow: 0 4px 14px rgba(61, 90, 128, 0.35);
      letter-spacing: 0.3px;
    }
    button:hover {
      filter: brightness(1.05);
      box-shadow: 0 6px 18px rgba(61, 90, 128, 0.4);
    }

    /* PDF çıktısında renklerin korunması */
    @media print {
      html, body { overflow-x: hidden; }
      body {
        background: #fff;
        font-family: Calibri, Candara, Arial, sans-serif;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      .sayfa {
        box-shadow: none;
        border: 1px solid #ddd;
        border-radius: 12px;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      .kapak-sayfa, .kapak-icerik, .rapor-bolumu, .tablo thead th, .kpi-item, .yil-kutu, .alt-baslik, .baslik {
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      .btn-alani { display: none; }
      .sayfa { margin: 0; padding: 20px; max-width: 100%; overflow: visible; }
      .sayfa-ayirici { page-break-before: always; }
      .alt-baslik.rapor-bolumu-baslik { page-break-after: avoid; }
      .rapor-bolumu { page-break-inside: avoid; }
      .rapor-bolumu h3 { page-break-after: avoid; }
      .tablo { page-break-inside: avoid; }
      .tablo tr { page-break-inside: avoid; page-break-after: auto; }
      .yil-kutu { page-break-inside: avoid; }
    }
  </style>
</head>
<body>
  <div class="sayfa" id="pdfAlani">
    <!-- 1. SAYFA: KAPAK -->
    <div class="kapak-sayfa">
      <div class="kapak-icerik">
        <h1 class="kapak-baslik">KARAAĞAÇ FATİH</h1>
        <div class="kapak-cizgi"></div>
        <div class="kapak-alt-baslik">Personel Performans Analizi 2023 – 2025 Yılları</div>
        <p class="kapak-ozet-alt">Ramazan-ı Şerif ve diğer teberru verileri ile yapılan ödemelerin değerlendirmesi.</p>
        <div class="kapak-alt-baslik kapak-alt-baslik--ikinci">2026 Personel Performans Planlaması</div>
        <p class="kapak-ozet-alt">Planlanan giderler, Ramazan-ı Şerif hedefleri ve bütçe karşılaştırması.</p>
        <div class="kapak-cizgi"></div>
        <div class="kapak-ozet" id="personelKimlikKapak">
          <div id="personelKimlikKapakIcerik">
            <p>Bu rapor, tüm personelin 2023–2025 dönemine ait ödeme, hedef ve teberru verilerinin toplu değerlendirmesini ve 2026 yılı personel performans planlamasını içerir.</p>
          </div>
        </div>
        <div class="kapak-tarih">Rapor Tarihi: <span id="raporTarihiKapak"></span></div>
      </div>
    </div>

    <!-- 2. SAYFA: GENEL BAKIŞ VE YILLIK PERFORMANS -->
    <div class="sayfa-ayirici">
      <div class="baslik">
        <div class="baslik-sol">
          <h1>KARAAĞAÇ FATİH DAİMİ TEKÂMÜLALTI</h1>
          <h2>Tüm Personel Performans Özet Raporu (2023 - 2025)</h2>
        </div>
        <div class="baslik-sag">
          <div><strong>Rapor Tarihi:</strong> <span id="raporTarihi"></span></div>
        </div>
      </div>

      <div class="filtre-bilgi" id="filtreBilgi" style="display: none;">
        Filtreler yükleniyor...
      </div>

      <div class="alt-baslik">Personel Sıralaması (2023-2025 Toplam Ödeme ve Performans)</div>
      <div class="rapor-bolumu">
        <div class="tablo-wrapper--siralama">
        <table class="tablo tablo--hedef tablo--personel-siralama" id="personelSiralamaTablosu">
          <colgroup>
            <col><col><col><col><col><col><col><col>
          </colgroup>
          <thead>
            <tr>
              <th>Sıra</th>
              <th>Personel</th>
              <th class="sayi">Toplam Ödeme</th>
              <th class="sayi">Toplam Hedef Tutar</th>
              <th class="sayi">Toplam Hedef</th>
              <th class="sayi">Hedefe Ulaşma %</th>
              <th class="sayi">Net Performans</th>
              <th class="sayi">Kurban Adedi</th>
            </tr>
          </thead>
          <tbody id="personelSiralamaTablosuBody">
            <tr><td colspan="8">Veriler yükleniyor...</td></tr>
          </tbody>
        </table>
        </div>
      </div>

      <div class="alt-baslik" style="margin-top: 30px;">Yıllık Performans Özeti Tablosu</div>
      <div class="rapor-bolumu">
        <table class="tablo tablo--mavi" id="yillikPerformansTablosu">
          <thead>
            <tr>
              <th>Yıl</th>
              <th class="sayi">Toplam Ödeme</th>
              <th class="sayi">Toplam Teberru</th>
              <th class="sayi">Toplam Ramazan-ı Şerif</th>
              <th class="sayi">Toplam Hedef Tutar</th>
              <th class="sayi">Toplam Hedef</th>
              <th class="sayi">Hedef Ulaşma Oranı</th>
              <th class="sayi">Net Performans</th>
            </tr>
          </thead>
          <tbody id="yillikPerformansTablosuBody">
            <tr><td colspan="8">Veriler yükleniyor...</td></tr>
          </tbody>
        </table>
      </div>

      <div class="rapor-bolumu" id="odemeAnalizBolumu">
        <h3>Yıllara Göre Hedef Detayı</h3>
        <div id="yillaraGoreHedefTablosu">Veriler yükleniyor...</div>
        <div id="ucYilDegerlendirmesi" style="margin-top: 20px;"></div>
      </div>
    </div>

    <!-- 3. SAYFA: ÖDEME TİP ARTIŞLARI, PERSONEL ÖDEMELERİ VE ANALİZ -->
    <div class="sayfa-ayirici">
      <div class="baslik">
        <div class="baslik-sol">
          <h1>KARAAĞAÇ FATİH DAİMİ TEKÂMÜLALTI</h1>
          <h2>Tüm Personel Performans Özet Raporu (2023 - 2025)</h2>
        </div>
      </div>

      <div class="alt-baslik">Ödeme Tipleri (2023-2025 ve 2026 Planlanan)</div>
      <div class="rapor-bolumu">
        <div id="odemeTipArtislari">Artış analizi hazırlanıyor...</div>
      </div>

      <div class="alt-baslik" style="margin-top: 30px;">Personel Ödemeleri (2023-2025) ve Genel Analiz</div>
      <div class="rapor-bolumu" id="yorumBolumu">
        <h3>Genel Yorumlar</h3>
        <ul class="yorum-listesi" id="yorumListesi">
          <li>Yorumlar hazırlanıyor...</li>
        </ul>
      </div>

      <div class="alt-baslik rapor-bolumu-baslik">6. 2026 Gider ve Hedef Planlaması</div>
      <div class="rapor-bolumu" id="projeksiyonBolumu">
        <h3>2026 Personel Gideri ve Hedef Önerileri</h3>
        <div id="projeksiyonMetni">Projeksyon hesaplanıyor...</div>
      </div>
      <div class="rapor-bolumu">
        <h3>2026 Ödeme Toplamı vs Ramazan-ı Şerif Hedefi Karşılaştırması</h3>
        <div id="ramazanKarsilastirma">Karşılaştırma hazırlanıyor...</div>
      </div>
      <div class="rapor-bolumu">
        <h3>Toplam Bütçeye Göre Tipe Göre Yüzdelik Pay</h3>
        <div id="butcePayAnalizi">Bütçe pay analizi hazırlanıyor...</div>
      </div>
      <div class="rapor-bolumu">
        <h3>2026 Yılı Analiz Yorumları</h3>
        <div id="yil2026AnalizYorumlari">Yorumlar hazırlanıyor...</div>
      </div>
      <div class="rapor-bolumu">
        <h3>Kira Artışı ile Alakalı Analiz ve Yönlendirme Planlama</h3>
        <div id="kiraAnalizi">Kira analizi hazırlanıyor...</div>
      </div>
      <div class="rapor-bolumu">
        <h3>Personel Bazında 2026 Planlanan Ödeme ve Ramazan Hedefi</h3>
        <div id="personel2026NetPerformans">Tablo hazırlanıyor...</div>
      </div>
      <div class="alt-baslik" style="margin-top: 24px;">Personel Bazında Yıllık Performans Özeti</div>
      <div id="personelBazindaYillikPerformans">Kartlar hazırlanıyor...</div>
    </div>
  </div>

  <div class="btn-alani">
    <button onclick="pdfCiktisiAl()">PDF Çıktısı Al</button>
  </div>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="../../src/supabase.js"></script>
  <script src="../../src/supabase-auth-wrapper.js"></script>
  <script src="../../src/supabase-db-wrapper.js"></script>
  <script src="../../js/ortak.js"></script>
  
  <!-- html2pdf -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      function waitForSupabaseAndOrtak(callback) {
        // window.supabase'in bir client instance olduğunu kontrol et (from metodu olmalı)
        if (typeof window.supabase !== 'undefined' && 
            typeof window.supabase.from === 'function' && 
            typeof window.norm !== 'undefined') {
          callback();
        } else {
          setTimeout(() => waitForSupabaseAndOrtak(callback), 50);
        }
      }

      waitForSupabaseAndOrtak(() => {
        const getSupabase = () => window.supabase;
        const $ = (id) => {
          const el = document.getElementById(id);
          if (!el) {
            console.warn(`Element with id "${id}" not found`);
          }
          return el;
        };
        const fmt = n => (n==null||isNaN(n)) ? '₺0' : '₺' + Number(n).toLocaleString('tr-TR',{maximumFractionDigits:0});
        const basHarfBuyuk = (str) => {
          if (!str) return '';
          return str.split(' ').map(kelime => {
            return kelime.charAt(0).toUpperCase() + kelime.slice(1).toLowerCase();
          }).join(' ');
        };
        const normalizeIsim = (str) => str ? String(str).toLocaleLowerCase('tr-TR').trim().replace(/ı/g, 'i').replace(/ğ/g, 'g').replace(/ş/g, 's').replace(/ü/g, 'u').replace(/ö/g, 'o').replace(/ç/g, 'c') : '';

        // Rapor tarihi
        const bugun = new Date();
        const tarihStr = bugun.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric' });
        const raporTarihiEl = $('raporTarihi');
        if (raporTarihiEl) {
          raporTarihiEl.textContent = tarihStr;
        }
        const raporTarihiKapakEl = $('raporTarihiKapak');
        if (raporTarihiKapakEl) {
          raporTarihiKapakEl.textContent = tarihStr;
        }

        // 2026 Planlanan Giderler - Tip Bazında (personel-detay.md'den)
        const PLANLANAN_2026_GIDERLER_TIP = (() => {
          const map = {};
          const ekle = (ad, giderler) => {
            map[normalizeIsim(ad)] = giderler;
          };
          
          // Sigorta 2026: Mahmut Solmaz, Faruk Nafiz Özgan, İbrahim Ay için her biri 120.000₺/yıl; diğerleri 0. Bütçe planlaması sigorta toplam 978.277₺.
          // MUHSİN ÇELİK: Hediye 12x35.800=429.600, İkramiye 2x35.800=71.600, Çocuk 12x4.200=50.400, Elbise 10.700, Kira 250.000, Yakacak 18.000
          ekle('MUHSİN ÇELİK', {
            hediye: 429600, // 12 x 35.800
            ikramiye: 71600, // 2 x 35.800
            cocuk: 50400, // 12 x 4.200
            elbise: 10700,
            kira: 250000,
            yakacak: 18000,
            yol: 0,
            sigorta: 0,
            toplam: 830300
          });
          
          // SERHAN DURAK: Hediye 12x30.300=363.600, İkramiye 2x30.300=60.600, Elbise 10.700, Kira 241.000, Yakacak 18.000
          ekle('SERHAN DURAK', {
            hediye: 363600, // 12 x 30.300
            ikramiye: 60600, // 2 x 30.300
            cocuk: 0,
            elbise: 10700,
            kira: 241000,
            yakacak: 18000,
            yol: 0,
            sigorta: 120000,
            toplam: 693900
          });
          
          // FARUK NAFİZ ÖZGAN: Hediye, İkramiye, Çocuk, Elbise, Kira, Yakacak + Sigorta 120.000
          ekle('FARUK NAFİZ ÖZGAN', {
            hediye: 330000, // 12 x 27.500
            ikramiye: 55000, // 2 x 27.500
            cocuk: 16800, // 12 x 1.400
            elbise: 10700,
            kira: 241000,
            yakacak: 18000,
            yol: 0,
            sigorta: 120000,
            toplam: 791500
          });
          
          // İBRAHİM AY: Hediye, İkramiye, Çocuk, Elbise, Kira, Yakacak, Yol + Sigorta 120.000
          ekle('İBRAHİM AY', {
            hediye: 396000, // 12 x 33.000
            ikramiye: 66000, // 2 x 33.000
            cocuk: 33600, // 12 x 2.800
            elbise: 10700,
            kira: 241000,
            yakacak: 18000,
            yol: 30000,
            sigorta: 120000,
            toplam: 915300
          });
          
          // KEREM KOCAOĞLU: Hediye 12x27.500=330.000, İkramiye 2x27.500=55.000, Çocuk 12x1.400=16.800, Elbise 10.700, Kira 200.000, Yakacak 18.000
          ekle('KEREM KOCAOĞLU', {
            hediye: 330000, // 12 x 27.500
            ikramiye: 55000, // 2 x 27.500
            cocuk: 16800, // 12 x 1.400
            elbise: 10700,
            kira: 200000,
            yakacak: 18000,
            yol: 0,
            sigorta: 0,
            toplam: 630500
          });
          
          // MAHMUT SOLMAZ: Hediye, İkramiye, Çocuk, Elbise, Kira, Yakacak + Sigorta 120.000
          ekle('MAHMUT SOLMAZ', {
            hediye: 330000, // 12 x 27.500
            ikramiye: 55000, // 2 x 27.500
            cocuk: 16800, // 12 x 1.400
            elbise: 10700,
            kira: 204000,
            yakacak: 18000,
            yol: 0,
            sigorta: 120000,
            toplam: 754500
          });
          
          // SAMET ÇAKIR: Hediye 12x20.600=247.200, İkramiye 2x20.600=41.200, Elbise 10.700
          ekle('SAMET ÇAKIR', {
            hediye: 247200, // 12 x 20.600
            ikramiye: 41200, // 2 x 20.600
            cocuk: 0,
            elbise: 10700,
            kira: 0,
            yakacak: 0,
            yol: 0,
            sigorta: 0,
            toplam: 299100
          });
          
          // MEHMET TAHA KESKİN: Hediye 12x20.600=247.200, İkramiye 2x20.600=41.200, Elbise 10.700
          ekle('MEHMET TAHA KESKİN', {
            hediye: 247200, // 12 x 20.600
            ikramiye: 41200, // 2 x 20.600
            cocuk: 0,
            elbise: 10700,
            kira: 0,
            yakacak: 0,
            yol: 0,
            sigorta: 0,
            toplam: 299100
          });
          
          // AHMETALİ EMRE ŞAHİN: Hediye 12x20.600=247.200, İkramiye 2x20.600=41.200, Elbise 10.700
          ekle('AHMETALİ EMRE ŞAHİN', {
            hediye: 247200, // 12 x 20.600
            ikramiye: 41200, // 2 x 20.600
            cocuk: 0,
            elbise: 10700,
            kira: 0,
            yakacak: 0,
            yol: 0,
            sigorta: 0,
            toplam: 299100
          });
          
          return map;
        })();

        // 2026 Yeni güncel aylık kira ve artış ayı (personel-detay.md'den – /12 değil, md'de yazan aylık tutarlar)
        const KIRA_2026_AYLIK_DETAY = (() => {
          const map = {};
          const ekle = (ad, aylik, artisAyi) => {
            map[normalizeIsim(ad)] = { aylik, artisAyi };
          };
          ekle('MUHSİN ÇELİK', 25000, 'Kasım');      // Kasım-Aralık tahmini 25.000₺/ay
          ekle('SERHAN DURAK', 23000, 'Ağustos');   // Ağustos-Aralık 23.000₺/ay
          ekle('FARUK NAFİZ ÖZGAN', 23000, 'Ağustos');
          ekle('İBRAHİM AY', 23000, 'Ağustos');      // tahmini diğer personel gibi
          ekle('KEREM KOCAOĞLU', 19000, 'Ağustos'); // Ağustos-Aralık 19.000₺/ay
          ekle('MAHMUT SOLMAZ', 17000, 'Ocak');     // Ocak itibariyle artış, max 17.000₺/ay
          ekle('SAMET ÇAKIR', 0, '-');              // kira yok
          ekle('MEHMET TAHA KESKİN', 0, '-');
          ekle('AHMETALİ EMRE ŞAHİN', 0, '-');
          return map;
        })();

        // 2026 Planlanan Giderler - Toplam (geriye uyumluluk için)
        const PLANLANAN_2026_GIDERLER = (() => {
          const map = {};
          Object.keys(PLANLANAN_2026_GIDERLER_TIP).forEach(key => {
            map[key] = PLANLANAN_2026_GIDERLER_TIP[key].toplam;
          });
          return map;
        })();

        // 2026 Ramazan-ı Şerif Hedefleri (personel-detay.md'den)
        const RAMAZAN_2026_HEDEFLERI = (() => {
          const map = {};
          const ekle = (ad, hedef) => {
            map[normalizeIsim(ad)] = hedef;
          };
          ekle('MUHSİN ÇELİK', 2500000);
          ekle('SERHAN DURAK', 1800000);
          ekle('FARUK NAFİZ ÖZGAN', 700000);
          ekle('KEREM KOCAOĞLU', 800000);
          ekle('MAHMUT SOLMAZ', 800000);
          ekle('İBRAHİM AY', 650000);
          ekle('SAMET ÇAKIR', 350000);
          ekle('MEHMET TAHA KESKİN', 250000);
          ekle('AHMETALİ EMRE ŞAHİN', 250000);
          return map;
        })();

        // Personel detayları (statik tanım - personel-detay.md içeriğine göre)
        // Personel UID eşleştirmeleri (personel-detay.md'den)
        const PERSONEL_UID_MAP = {
          '98a349eb-6cf9-4de3-99f7-345d23287b08': 'MUHSİN ÇELİK',
          '5f727148-7cef-4498-a2ce-351de15301d6': 'SERHAN DURAK',
          '99217ccf-182c-4a38-beec-7b75993dcaf6': 'FARUK NAFİZ ÖZGAN',
          '898eaaad-5fa5-4fd2-894b-2ad759ca74d6': 'İBRAHİM AY',
          '1288af1c-3757-4e36-89e6-f4a72f53a342': 'KEREM KOCAOĞLU',
          '9bac0f85-6df3-41f2-9017-baec13adb145': 'MAHMUT SOLMAZ',
          'aafd0046-e722-418a-b875-6cb7469ff450': 'SAMET ÇAKIR',
          '74a07b1e-d277-4b81-98b6-96b491084975': 'MEHMET TAHA KESKİN',
          '1319cbea-a35f-4262-9f0e-d4ad37182e7c': 'AHMETALİ EMRE ŞAHİN'
        };

        const PERSONEL_DETAYLARI = (() => {
          const map = {};
          const ekle = (ad, detay) => {
            map[normalizeIsim(ad)] = { ad, ...detay };
            // UID'den de erişilebilir olması için
            const uid = Object.keys(PERSONEL_UID_MAP).find(u => PERSONEL_UID_MAP[u] === ad);
            if (uid) {
              map[uid.toLowerCase()] = { ad, ...detay };
            }
          };

          ekle('MUHSİN ÇELİK', {
            uid: '98a349eb-6cf9-4de3-99f7-345d23287b08',
            hizmetBaslangic: '2009 Temmuz',
            karaaagacBaslangic: '2021 Kasım',
            aileDurumu: 'Evli, 3 çocuğu var (2 erkek - 1 kız)',
            aktifVazifeler: 'Yurt Mesulü',
            kategori: 'Hocaefendi'
          });

          ekle('SERHAN DURAK', {
            uid: '5f727148-7cef-4498-a2ce-351de15301d6',
            hizmetBaslangic: '2011 Temmuz',
            karaaagacBaslangic: '2021 Kasım',
            aileDurumu: 'Evli',
            aktifVazifeler: 'Yardımcı Personel, Harici Hizmetler Mesulü, Yemekhane Mesulü, Kurban - Kermes - Teknik İşler Mesulü',
            kategori: 'Hocaefendi'
          });

          ekle('FARUK NAFİZ ÖZGAN', {
            uid: '99217ccf-182c-4a38-beec-7b75993dcaf6',
            hizmetBaslangic: '2016 Temmuz',
            karaaagacBaslangic: '2019 Eylül (kurs açılışından beri burada, en eski personel)',
            aileDurumu: 'Evli, 1 çocuğu var (1 erkek)',
            aktifVazifeler: 'İç Mesul, Yardımcı Personel, 1. Ders Hocası, İrşadi Hizmetler Mesulü',
            kategori: 'Hocaefendi'
          });

          ekle('İBRAHİM AY', {
            uid: '898eaaad-5fa5-4fd2-894b-2ad759ca74d6',
            hizmetBaslangic: '2007 Temmuz',
            karaaagacBaslangic: '2025 Ağustos',
            aileDurumu: 'Evli, 2 çocuğu var (2 kız)',
            aktifVazifeler: 'Yardımcı Personel, 2. Ders Hocası, Resmi-Teknik İşler Mesulü',
            kategori: 'Hocaefendi'
          });

          ekle('KEREM KOCAOĞLU', {
            uid: '1288af1c-3757-4e36-89e6-f4a72f53a342',
            hizmetBaslangic: '2019 Temmuz',
            karaaagacBaslangic: '2021 Nisan',
            aileDurumu: 'Evli, 1 çocuğu var (1 erkek)',
            aktifVazifeler: 'Yardımcı Personel, Kıraat Ders Hocası, Dernek Muhasebe Mesulü, Teknik İşler Mesulü',
            kategori: 'Hocaefendi'
          });

          ekle('MAHMUT SOLMAZ', {
            uid: '9bac0f85-6df3-41f2-9017-baec13adb145',
            hizmetBaslangic: '2019 Temmuz',
            karaaagacBaslangic: '2023 Eylül',
            aileDurumu: 'Evli, 1 çocuğu var (1 erkek)',
            aktifVazifeler: 'Yardımcı Personel, Nehari Mesulü, Harici Hizmetler Mesulü, Teknik İşler Mesulü',
            kategori: 'Hocaefendi'
          });

          ekle('SAMET ÇAKIR', {
            uid: 'aafd0046-e722-418a-b875-6cb7469ff450',
            hizmetBaslangic: '2022 Temmuz',
            karaaagacBaslangic: '2022 Temmuz',
            aileDurumu: 'Bekar personel',
            aktifVazifeler: 'Muhasebe Mesulü, Sekretarya, Yardımcı Personel',
            kategori: 'Hocaefendi'
          });

          ekle('MEHMET TAHA KESKİN', {
            uid: '74a07b1e-d277-4b81-98b6-96b491084975',
            hizmetBaslangic: '2024 Temmuz',
            karaaagacBaslangic: '2024 Temmuz (direkt Karaağaç\'ta başladı)',
            aileDurumu: 'Bekar personel',
            aktifVazifeler: 'Müzakereci',
            kategori: 'Hocaefendi'
          });

          ekle('AHMETALİ EMRE ŞAHİN', {
            uid: '1319cbea-a35f-4262-9f0e-d4ad37182e7c',
            hizmetBaslangic: '2025 Temmuz',
            karaaagacBaslangic: '2025 Temmuz (direkt Karaağaç\'ta başladı)',
            aileDurumu: 'Bekar personel',
            aktifVazifeler: 'Müzakereci, Eğitim Mesulü',
            kategori: 'Hocaefendi'
          });

          return map;
        })();

        // Tüm personel raporu – personel parametresi yok, her zaman kurum geneli
        const yillar = [2023, 2024, 2025];

        // Filtre bilgisini göster
        const filtreBilgiEl = $('filtreBilgi');
        if (filtreBilgiEl) {
          filtreBilgiEl.textContent = 'Filtreler: Tüm Personel | Yıllar: 2023, 2024, 2025';
        }

        async function yukleVeriler() {
          try {
            let toplamOdeme, toplamHedefTutar, toplamTeberru, toplamHedef, toplamRamazan, toplamKurban, tumYillar, toplamHedefOrani, toplamNetPerformans;
            const sb = getSupabase();
            if (!sb) {
              console.error('Supabase client hazır değil');
              return;
            }

            // Tüm personel: filtre yok, tüm veriler toplu
            const personelUid = '';
            const personelAdi = '';

            // 1) Kapak zaten HTML'de "Tüm Personel Özet Raporu" ve kurum geneli metin olarak ayarlandı

            // 2) 2023-2025 yılları için verileri yükle (personel filtresi yok – kurum geneli)
            const yilBazli = {};

            for (const yil of yillar) {
              const yilInt = parseInt(yil, 10);

              // Ödeme verileri (tüm kayıtlar – limit yok, filtreye göre)
              let odemeQuery = sb.from('personel_odeme_takvim').select('*').eq('yil', yilInt).range(0, 9999);
              if (personelUid) odemeQuery = odemeQuery.eq('personel_uid', personelUid);
              const { data: odemeData, error: odemeError } = await odemeQuery;
              if (odemeError) throw odemeError;

              // Teberru verileri (yıl aralığında tüm kayıtlar)
              let teberruQuery = sb.from('gecmis_teberru_kayitlari').select('*')
                .gte('vade_tarihi', `${yilInt}-01-01`)
                .lt('vade_tarihi', `${yilInt + 1}-01-01`)
                .range(0, 9999);
              const { data: teberruAllData, error: teberruError } = await teberruQuery;
              if (teberruError) throw teberruError;

              // Tüm personel: teberru filtre yok, tüm kayıtlar
              const teberruData = teberruAllData || [];

              // Ramazan-ı Şerif verileri (kategori + tip birleştirilmiş, tüm kayıtlar)
              let ramazanKategoriQuery = sb.from('arsiv_hedefler').select('*')
                .eq('kategori', 'Ramazan-ı Şerif')
                .eq('yil', yilInt)
                .range(0, 9999);
              if (personelUid) ramazanKategoriQuery = ramazanKategoriQuery.eq('uid', personelUid);
              const { data: ramazanKategoriData } = await ramazanKategoriQuery;

              let ramazanTipQuery = sb.from('arsiv_hedefler').select('*')
                .eq('tip', 'Ramazan-ı Şerif')
                .eq('yil', yilInt)
                .range(0, 9999);
              if (personelUid) ramazanTipQuery = ramazanTipQuery.eq('uid', personelUid);
              const { data: ramazanTipData } = await ramazanTipQuery;

              const ramazanKategori = ramazanKategoriData || [];
              const ramazanTip = ramazanTipData || [];
              const ramazanData = [...new Map([...ramazanKategori, ...ramazanTip].map(v => [v.id, v])).values()];

              // Kurban çalışmaları (kategori "Kurban", tüm kayıtlar)
              let kurbanQuery = sb.from('arsiv_hedefler').select('*')
                .eq('kategori', 'Kurban')
                .eq('yil', yilInt)
                .range(0, 9999);
              if (personelUid) kurbanQuery = kurbanQuery.eq('uid', personelUid);
              const { data: kurbanData } = await kurbanQuery;

              // Hedef verileri (tüm kayıtlar)
              let hedefQuery = sb.from('arsiv_hedefler').select('*').eq('yil', yilInt).range(0, 9999);
              if (personelUid) hedefQuery = hedefQuery.eq('uid', personelUid);
              const { data: hedefData, error: hedefError } = await hedefQuery;
              if (hedefError) throw hedefError;

              const odemeToplam = (odemeData || []).reduce((sum, v) => sum + parseFloat(v.tutar || 0), 0);
              const teberruToplam = (teberruData || []).reduce((sum, v) => sum + parseFloat(v.tutar || 0), 0);
              const hedefToplam = (hedefData || []).reduce((sum, v) => sum + parseFloat(v.hedef || 0), 0);
              const hedefTutarToplam = (hedefData || []).reduce((sum, v) => sum + parseFloat(v.tutar || 0), 0);
              const ramazanToplam = (ramazanData || []).reduce((sum, v) => sum + parseFloat(v.tutar || 0), 0);
              const ramazanHedefToplam = (ramazanData || []).reduce((sum, v) => sum + parseFloat(v.hedef || 0), 0);
              const kurbanToplam = (kurbanData || []).reduce((sum, v) => sum + parseFloat(v.tutar || 0), 0);

              const hedefUlasmaOrani = hedefToplam > 0 ? (hedefTutarToplam / hedefToplam) * 100 : 0;
              // Net Performans = Hedef Tutar - Ödeme (personel-detay.md'deki formüle göre)
              const netPerformans = hedefTutarToplam - odemeToplam;

              yilBazli[yil] = {
                yil,
                odemeData: odemeData || [],
                teberruData,
                hedefData: hedefData || [],
                ramazanData,
                kurbanData: kurbanData || [],
                odemeToplam,
                teberruToplam,
                hedefToplam,
                hedefTutarToplam,
                ramazanToplam,
                ramazanHedefToplam,
                kurbanToplam,
                hedefUlasmaOrani,
                netPerformans
              };
            }

            // 3) Genel KPIs (2023-2025 toplamları)
            tumYillar = Object.values(yilBazli);
            toplamOdeme = tumYillar.reduce((s, y) => s + y.odemeToplam, 0);
            toplamTeberru = tumYillar.reduce((s, y) => s + y.teberruToplam, 0);
            toplamHedef = tumYillar.reduce((s, y) => s + y.hedefToplam, 0);
            toplamHedefTutar = tumYillar.reduce((s, y) => s + y.hedefTutarToplam, 0);
            toplamRamazan = tumYillar.reduce((s, y) => s + y.ramazanToplam, 0);
            const toplamRamazanHedef = tumYillar.reduce((s, y) => s + (y.ramazanHedefToplam || 0), 0);
            const ramazanUlasmaOrani = toplamRamazanHedef > 0 ? (toplamRamazan / toplamRamazanHedef * 100) : 0;
            toplamKurban = tumYillar.reduce((s, y) => s + y.kurbanToplam, 0);

            toplamHedefOrani = toplamHedef > 0 ? (toplamHedefTutar / toplamHedef) * 100 : 0;
            // Net Performans = TOPLAM HEDEF TUTAR - TOPLAM ÖDEME (personel-detay.md'deki formüle göre)
            toplamNetPerformans = toplamHedefTutar - toplamOdeme;

            // Personel bazlı toplamlar (sıralama tablosu için)
            const personelBazli = {};
            tumYillar.forEach(y => {
              (y.odemeData || []).forEach(od => {
                const uid = (od.personel_uid || '').toString().toLowerCase();
                if (!uid) return;
                if (!personelBazli[uid]) {
                  personelBazli[uid] = { toplamOdeme: 0, toplamHedefTutar: 0, toplamHedef: 0, kurbanAdedi: 0 };
                }
                personelBazli[uid].toplamOdeme += parseFloat(od.tutar || 0);
              });
              (y.hedefData || []).forEach(h => {
                const uid = (h.uid || '').toString().toLowerCase();
                if (!uid) return;
                if (!personelBazli[uid]) {
                  personelBazli[uid] = { toplamOdeme: 0, toplamHedefTutar: 0, toplamHedef: 0, kurbanAdedi: 0 };
                }
                personelBazli[uid].toplamHedefTutar += parseFloat(h.tutar || 0);
                personelBazli[uid].toplamHedef += parseFloat(h.hedef || 0);
                var kat = ((h.kategori || '') + ' ' + (h.tip || '')).toLowerCase();
                if (kat.indexOf('kurban') >= 0) {
                  personelBazli[uid].kurbanAdedi = (personelBazli[uid].kurbanAdedi || 0) + (parseInt(h.kurban_adedi, 10) || parseInt(h.kurbanAdedi, 10) || 0);
                }
              });
            });
            Object.keys(personelBazli).forEach(uid => {
              const p = personelBazli[uid];
              p.netPerformans = p.toplamHedefTutar - p.toplamOdeme;
              p.hedefUlasmaOrani = p.toplamHedef > 0 ? (p.toplamHedefTutar / p.toplamHedef * 100) : 0;
            });

            // arsiv_hedefler: personel ismine göre kurban_adedi toplamı (tüm yıllar)
            const kurbanAdediByPersonel = {};
            const kurbanAdediByPersonelAndYear = {};
            tumYillar.forEach(y => {
              (y.hedefData || []).forEach(h => {
                const adet = parseInt(h.kurban_adedi, 10) || parseInt(h.kurbanAdedi, 10) || 0;
                const personelAd = (h.personel || '').toString().trim();
                if (!personelAd) return;
                const key = normalizeIsim(personelAd);
                kurbanAdediByPersonel[key] = (kurbanAdediByPersonel[key] || 0) + adet;
                if (!kurbanAdediByPersonelAndYear[key]) kurbanAdediByPersonelAndYear[key] = {};
                kurbanAdediByPersonelAndYear[key][y.yil] = (kurbanAdediByPersonelAndYear[key][y.yil] || 0) + adet;
              });
            });

            // gecmis_teberru_kayitlari: referans alanı personel ismi – personel + yıl bazında teberru toplamı (isim eşleştirmesi)
            const teberruByPersonelAndYear = {};
            tumYillar.forEach(y => {
              (y.teberruData || []).forEach(t => {
                const referansAd = (t.referans || '').toString().trim();
                if (!referansAd) return;
                const key = normalizeIsim(referansAd);
                if (!teberruByPersonelAndYear[key]) teberruByPersonelAndYear[key] = {};
                teberruByPersonelAndYear[key][y.yil] = (teberruByPersonelAndYear[key][y.yil] || 0) + parseFloat(t.tutar || 0);
              });
            });

            const personelSiralamaListesi = Object.keys(personelBazli)
              .map(uid => {
                const ad = PERSONEL_UID_MAP[uid] || uid;
                const kurbanAdedi = kurbanAdediByPersonel[normalizeIsim(ad)] ?? personelBazli[uid].kurbanAdedi ?? 0;
                return {
                  uid,
                  ad,
                  ...personelBazli[uid],
                  kurbanAdedi
                };
              })
              .sort((a, b) => (b.toplamOdeme || 0) - (a.toplamOdeme || 0));

            // Personel Sıralaması Tablosu
            const personelSiralamaTablosuBody = $('personelSiralamaTablosuBody');
            if (personelSiralamaTablosuBody) {
              personelSiralamaTablosuBody.innerHTML = personelSiralamaListesi.length === 0
                ? '<tr><td colspan="8">Personel bazlı veri bulunamadı.</td></tr>'
                : personelSiralamaListesi.map((p, idx) => `
                  <tr>
                    <td>${idx + 1}</td>
                    <td>${p.ad}</td>
                    <td class="sayi">${fmt(p.toplamOdeme)}</td>
                    <td class="sayi">${fmt(p.toplamHedefTutar)}</td>
                    <td class="sayi">${fmt(p.toplamHedef)}</td>
                    <td class="sayi">${p.hedefUlasmaOrani.toFixed(1)}%</td>
                    <td class="sayi ${p.netPerformans >= 0 ? 'artis-pozitif' : 'artis-negatif'}">${fmt(p.netPerformans)}</td>
                    <td class="sayi">${p.kurbanAdedi != null ? p.kurbanAdedi : '-'}</td>
                  </tr>
                `).join('');
            }

            // Yıllık Performans Özeti Tablosu
            const yillikPerformansTablosuBody = $('yillikPerformansTablosuBody');
            if (yillikPerformansTablosuBody) {
              let tabloHtml = tumYillar.map(y => {
                const yilNetPerformans = y.hedefTutarToplam - y.odemeToplam;
                return `
                  <tr>
                    <td><strong>${y.yil}</strong></td>
                    <td class="sayi">${fmt(y.odemeToplam)}</td>
                    <td class="sayi">${fmt(y.teberruToplam)}</td>
                    <td class="sayi">${fmt(y.ramazanToplam)}</td>
                    <td class="sayi">${fmt(y.hedefTutarToplam)}</td>
                    <td class="sayi">${fmt(y.hedefToplam)}</td>
                    <td class="sayi">${y.hedefUlasmaOrani.toFixed(1)}%</td>
                    <td class="sayi ${yilNetPerformans >= 0 ? 'artis-pozitif' : 'artis-negatif'}">${fmt(yilNetPerformans)}</td>
                  </tr>
                `;
              }).join('');
              
              // Genel toplam satırı ekle
              const genelHedefOrani = toplamHedef > 0 ? (toplamHedefTutar / toplamHedef) * 100 : 0;
              tabloHtml += `
                <tr style="background-color: #f0f0f0; font-weight: 600;">
                  <td><strong>2023-2025 TOPLAM</strong></td>
                  <td class="sayi"><strong>${fmt(toplamOdeme)}</strong></td>
                  <td class="sayi"><strong>${fmt(toplamTeberru)}</strong></td>
                  <td class="sayi"><strong>${fmt(toplamRamazan)}</strong></td>
                  <td class="sayi"><strong>${fmt(toplamHedefTutar)}</strong></td>
                  <td class="sayi"><strong>${fmt(toplamHedef)}</strong></td>
                  <td class="sayi"><strong>${genelHedefOrani.toFixed(1)}%</strong></td>
                  <td class="sayi ${toplamNetPerformans >= 0 ? 'artis-pozitif' : 'artis-negatif'}"><strong>${fmt(toplamNetPerformans)}</strong></td>
                </tr>
              `;
              
              yillikPerformansTablosuBody.innerHTML = tabloHtml;
            }

            // 5) Ödemeler ve genel analiz
            const ortalamaYillikOdeme = tumYillar.length > 0 ? toplamOdeme / tumYillar.length : 0;

            // Yıllara Göre Hedef Detay Tablosu: arsiv_hedefler'den yıl ve kategoriye göre (kurban_adedi dahil)
            const yillaraGoreHedefTablosuEl = $('yillaraGoreHedefTablosu');
            if (yillaraGoreHedefTablosuEl) {
              let tabloHtml = '<table class="tablo tablo--mor tablo--hedef-detay"><colgroup><col><col><col><col><col><col><col></colgroup><thead><tr><th>Yıl</th><th>Kategori</th><th class="sayi">Hedef</th><th class="sayi">Tutar</th><th class="sayi">Kayıt Sayısı</th><th class="sayi">Kurban Adedi</th><th class="sayi">Hedefe Ulaşma</th></tr></thead><tbody>';
              tumYillar.forEach(y => {
                const rows = (y.hedefData || []);
                const kategoriGruplari = {};
                rows.forEach(v => {
                  const kategoriLabel = (v.kategori || v.tip || '-').trim() || '-';
                  const sira = parseInt(v.sira, 10);
                  const siraNum = !isNaN(sira) ? sira : undefined;
                  if (!kategoriGruplari[kategoriLabel]) {
                    kategoriGruplari[kategoriLabel] = { hedef: 0, tutar: 0, adet: 0, kurbanAdedi: 0, minSira: siraNum };
                  }
                  kategoriGruplari[kategoriLabel].hedef += parseFloat(v.hedef || 0);
                  kategoriGruplari[kategoriLabel].tutar += parseFloat(v.tutar || 0);
                  kategoriGruplari[kategoriLabel].adet += 1;
                  kategoriGruplari[kategoriLabel].kurbanAdedi += (parseInt(v.kurban_adedi, 10) || 0);
                  if (siraNum !== undefined && (kategoriGruplari[kategoriLabel].minSira === undefined || siraNum < kategoriGruplari[kategoriLabel].minSira)) {
                    kategoriGruplari[kategoriLabel].minSira = siraNum;
                  }
                });
                const yilKurbanToplam = Object.values(kategoriGruplari).reduce((s, g) => s + (g.kurbanAdedi || 0), 0);
                const kategorilerSiralı = Object.keys(kategoriGruplari).sort((a, b) => {
                  const sa = kategoriGruplari[a].minSira;
                  const sb = kategoriGruplari[b].minSira;
                  if (sa != null && sb != null) return sa - sb;
                  if (sa != null) return -1;
                  if (sb != null) return 1;
                  return a.localeCompare(b);
                });
                kategorilerSiralı.forEach(kat => {
                  const g = kategoriGruplari[kat];
                  const oran = g.hedef > 0 ? (g.tutar / g.hedef * 100) : 0;
                  tabloHtml += `<tr><td>${y.yil}</td><td>${kat}</td><td class="sayi">${fmt(g.hedef)}</td><td class="sayi">${fmt(g.tutar)}</td><td class="sayi">${g.adet}</td><td class="sayi">${g.kurbanAdedi}</td><td class="sayi">${oran.toFixed(1)}%</td></tr>`;
                });
                tabloHtml += `<tr style="background-color: #e8e8e8; font-weight: 600;"><td>${y.yil}</td><td>Yıl Toplamı Değerlendirmesi</td><td class="sayi">${fmt(y.hedefToplam)}</td><td class="sayi">${fmt(y.hedefTutarToplam)}</td><td class="sayi">-</td><td class="sayi">${yilKurbanToplam}</td><td class="sayi">${y.hedefUlasmaOrani.toFixed(1)}%</td></tr>`;
              });
              tabloHtml += '</tbody></table>';
              yillaraGoreHedefTablosuEl.innerHTML = tabloHtml;
            }

            // 3 Yılın Değerlendirmesi
            const ucYilDegerlendirmesiEl = $('ucYilDegerlendirmesi');
            if (ucYilDegerlendirmesiEl) {
              const genelOran = toplamHedef > 0 ? (toplamHedefTutar / toplamHedef * 100) : 0;
              ucYilDegerlendirmesiEl.innerHTML = `
                <div class="yil-kutu" style="max-width: 100%;">
                  <h4>3 Yılın Değerlendirmesi (2023–2025)</h4>
                  <p style="margin: 8px 0 0 0; font-size: 12px;">
                    Toplam Hedef: <strong>${fmt(toplamHedef)}</strong> · Toplam Tutar: <strong>${fmt(toplamHedefTutar)}</strong> · Hedefe Ulaşma: <strong>${genelOran.toFixed(1)}%</strong><br>
                    Net Performans (Toplam Hedef Tutar − Toplam Ödeme): <strong class="${toplamNetPerformans >= 0 ? 'artis-pozitif' : 'artis-negatif'}">${fmt(toplamNetPerformans)}</strong>
                  </p>
                </div>
              `;
            }

            // 2026 Planlanan = toplam bütçeye göre tipe göre yüzdelik pay ile aynı kaynak (PLANLANAN_2026_GIDERLER_TIP toplamı)
            const planlanan2026ByTip = (() => {
              const labels = { hediye: 'Hediye', ikramiye: 'İkramiye', cocuk: 'Çocuk', elbise: 'Elbise', kira: 'Kira', yakacak: 'Yakacak Yardımı', yol: 'Yol Yardımı', sigorta: 'Sigorta' };
              const keys = Object.keys(labels);
              const t = {};
              keys.forEach(k => { t[labels[k]] = 0; });
              Object.values(PLANLANAN_2026_GIDERLER_TIP).forEach(o => {
                keys.forEach(k => { t[labels[k]] += (o[k] || 0); });
              });
              return t;
            })();
            const odemeTipArtislariEl = $('odemeTipArtislari');
            if (odemeTipArtislariEl && tumYillar.length >= 1) {
              const sabitTipler = ['Hediye', 'İkramiye', 'Çocuk', 'Elbise', 'Kira', 'Yakacak Yardımı', 'Yol Yardımı', 'Sigorta'];
              const normalizeOdemeTip = (raw) => {
                if (!raw) return null;
                const r = String(raw).toLowerCase().trim();
                if (r.includes('hediye')) return 'Hediye';
                if (r.includes('ikramiye')) return 'İkramiye';
                if (r.includes('cocuk') || r.includes('çocuk')) return 'Çocuk';
                if (r.includes('elbise')) return 'Elbise';
                if (r.includes('kira')) return 'Kira';
                if (r.includes('yakacak')) return 'Yakacak Yardımı';
                if (r.includes('yol')) return 'Yol Yardımı';
                if (r.includes('sigorta')) return 'Sigorta';
                return null;
              };
              const odemeTipleri = {};
              sabitTipler.forEach(t => { odemeTipleri[t] = {}; });
              tumYillar.forEach(y => {
                (y.odemeData || []).forEach(od => {
                  const raw = od.tip || od.odeme_tipi || '';
                  const tip = normalizeOdemeTip(raw);
                  if (!tip) return;
                  if (!odemeTipleri[tip][y.yil]) odemeTipleri[tip][y.yil] = 0;
                  odemeTipleri[tip][y.yil] += parseFloat(od.tutar || 0);
                });
              });
              const getYilToplam = (tip, yil) => (odemeTipleri[tip] && odemeTipleri[tip][yil]) || 0;
              let tipArtisHtml = '<table class="tablo tablo--kahve tablo--odeme-artis" id="odemeTipArtislariTablosu"><colgroup><col><col><col><col><col><col></colgroup><thead><tr><th>Ödeme Tipi</th><th class="sayi">2023</th><th class="sayi">2024</th><th class="sayi">2025</th><th class="sayi">2026 Planlanan</th><th class="sayi">2025-2026 Artış</th></tr></thead><tbody>';
              sabitTipler.forEach(tip => {
                const v2023 = getYilToplam(tip, 2023);
                const v2024 = getYilToplam(tip, 2024);
                const v2025 = getYilToplam(tip, 2025);
                const v2026 = planlanan2026ByTip[tip] != null ? planlanan2026ByTip[tip] : 0;
                const artis25_26 = v2025 > 0 ? ((v2026 - v2025) / v2025 * 100) : (v2026 > 0 ? 100 : 0);
                const tutarFark25_26 = v2026 - v2025;
                tipArtisHtml += `
                  <tr>
                    <td>${tip}</td>
                    <td class="sayi">${fmt(v2023)}</td>
                    <td class="sayi">${fmt(v2024)}</td>
                    <td class="sayi">${fmt(v2025)}</td>
                    <td class="sayi">${fmt(v2026)}</td>
                    <td class="sayi ${tutarFark25_26 >= 0 ? 'artis-pozitif' : 'artis-negatif'}">${artis25_26 >= 0 ? '+' : ''}${artis25_26.toFixed(1)}% (${tutarFark25_26 >= 0 ? '+' : ''}${fmt(tutarFark25_26)})</td>
                  </tr>
                `;
              });
              tipArtisHtml += '</tbody></table>';
              odemeTipArtislariEl.innerHTML = tipArtisHtml;
            }

            // 6) Yorumlar (basit kural tabanlı değerlendirme)
            const yorumlar = [];
            if (toplamHedefOrani >= 110) {
              yorumlar.push('<span class="yorum-etiket">Hedeflerin Üzerinde Performans (Kurum Geneli):</span> 3 yıllık periyotta kurum genelinde hedeflerin belirgin şekilde üzerinde bir gerçekleşme sağlanmıştır. Teberru ve kampanya çalışmalarında toplu performans güçlüdür.');
            } else if (toplamHedefOrani >= 90) {
              yorumlar.push('<span class="yorum-etiket">Hedeflere Yakın Gerçekleşme (Kurum Geneli):</span> Kurum genelinde hedeflerin büyük oranda yakalandığı, dengeli bir toplam performans görülmektedir. Hedef planlaması ile saha uyumu genel olarak başarılıdır.');
            } else if (toplamHedefOrani > 0) {
              yorumlar.push('<span class="yorum-etiket">Hedeflerin Altında Performans (Kurum Geneli):</span> Kurum genelinde toplam hedef gerçekleşme oranı beklenen seviyenin altında kalmıştır. Hedef belirleme süreci ve takip mekanizmalarının gözden geçirilmesi faydalı olacaktır.');
            } else {
              yorumlar.push('<span class="yorum-etiket">Hedef Verisi Eksik:</span> Kurum genelinde hedef verileri yeterli düzeyde olmadığı için net bir oran hesaplanamamıştır. Hedef kayıtlarının düzenli tutulması, sonraki dönem analizleri için kritik önem taşımaktadır.');
            }

            if (toplamNetPerformans >= 0) {
              yorumlar.push('<span class="yorum-etiket">Net Katkı Pozitif (Kurum Geneli):</span> 3 yıllık dönemde, tüm personele yapılan ödemeler dikkate alındığında üretilen kaynak toplamda pozitif bir katkıya işaret etmektedir.');
            } else {
              yorumlar.push('<span class="yorum-etiket">Net Katkı Negatif (Kurum Geneli):</span> Teberru ve kampanya gelirleri, yapılan personel ödemelerini tam olarak karşılayamamıştır. Hedef planlaması ve vazife dağılımlarının güçlendirilmesiyle net katkının pozitif tarafa taşınması önerilir.');
            }

            // Ramazan yorumu (kurum geneli)
            if (toplamRamazanHedef <= 0 && toplamRamazan <= 0) {
              yorumlar.push('<span class="yorum-etiket">Ramazan Verisi Zayıf:</span> Kurum genelinde Ramazan-ı Şerif hedef veya tutar verisi yok veya yetersizdir. Hedef kayıtlarının tutulması ve bu alandaki fırsatların sistematik hedeflenmesi önerilir.');
            } else if (toplamRamazanHedef > 0 && ramazanUlasmaOrani >= 110) {
              yorumlar.push('<span class="yorum-etiket">Ramazan Hedefi Geçildi (Kurum Geneli):</span> Ramazan-ı Şerif çalışmalarında toplam hedef belirgin şekilde aşılmıştır. Mevcut düzeyin korunması ve istikrarın sürdürülmesi önemlidir.');
            } else if (toplamRamazanHedef > 0 && ramazanUlasmaOrani >= 100) {
              yorumlar.push('<span class="yorum-etiket">Ramazan Hedefine Ulaşıldı (Kurum Geneli):</span> Ramazan döneminde kurum genelinde hedefe ulaşılmış, dengeli bir gerçekleşme görülmektedir.');
            } else if (toplamRamazanHedef > 0 && ramazanUlasmaOrani > 0) {
              yorumlar.push('<span class="yorum-etiket">Ramazan Hedef Altında (Kurum Geneli):</span> Ramazan-ı Şerif çalışmalarında toplam gerçekleşme hedefin altında kalmıştır. Bu alandaki hedefleme ve takibin güçlendirilmesi önerilir.');
            } else {
              yorumlar.push('<span class="yorum-etiket">Ramazan Hedefi Tanımsız:</span> Ramazan tutar kayıtları mevcut ancak hedef tanımlanmadığı için oran hesaplanamadı. Hedef kayıtlarının düzenli tutulması önerilir.');
            }

            // Kurban verisi notu
            yorumlar.push('<span class="yorum-etiket">Kurban Verisi:</span> Kurban verisi: rapora daha sonra eklenecektir.');

            const yorumListEl = $('yorumListesi');
            if (yorumListEl) {
              yorumListEl.innerHTML = yorumlar.map(y => `<li>${y}</li>`).join('');
            }

            // 7) 2026 projeksiyonu – tüm personel toplamı (planlanan gider ve Ramazan hedefi)
            const planlanan2026Gider = Object.values(PLANLANAN_2026_GIDERLER).reduce((s, v) => s + (v || 0), 0);
            const ramazan2026Hedefi = Object.values(RAMAZAN_2026_HEDEFLERI).reduce((s, v) => s + (v || 0), 0);

            // 2025 giderini hesapla (kurum geneli toplam)
            const yil2025 = tumYillar.find(y => y.yil === 2025);
            const gider2025 = yil2025 ? yil2025.odemeToplam : 0;
            
            // 2025'den 2026'ya artış hesapla
            const artisTutar = planlanan2026Gider - gider2025;
            const artisYuzde = gider2025 > 0 ? ((artisTutar / gider2025) * 100) : 0;

            const projeksiyonMetniEl = $('projeksiyonMetni');
            if (projeksiyonMetniEl) {
              projeksiyonMetniEl.innerHTML = `
                <p>
                  2026 yılı için kurum genelinde planlanan mevcut 9 personel (diğer personel hariç) gideri toplamı <strong>${fmt(planlanan2026Gider)}</strong> olarak
                  öngörülmektedir. Bu tutar; tüm personel için hediye, ikramiye, çocuk ödemesi, elbise, kira, yakacak, sigorta ve diğer yardımların
                  toplamından oluşmaktadır.
                </p>
                <table class="tablo" style="margin-top: 15px;">
                  <thead>
                    <tr><th>Metrik</th><th class="sayi">Tutar</th></tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>2023-2025 Toplam Gider (Kurum Geneli)</td>
                      <td class="sayi">${fmt(toplamOdeme)}</td>
                    </tr>
                    <tr>
                      <td>2025 Gider (Kurum Geneli)</td>
                      <td class="sayi">${fmt(gider2025)}</td>
                    </tr>
                    <tr>
                      <td>Planlanan 2026 Gideri (Tüm Personel Toplamı)</td>
                      <td class="sayi"><strong>${fmt(planlanan2026Gider)}</strong></td>
                    </tr>
                    <tr>
                      <td><strong>2025'den 2026'ya Artış</strong></td>
                      <td class="sayi ${artisTutar >= 0 ? 'artis-pozitif' : 'artis-negatif'}">
                        <strong>${artisYuzde >= 0 ? '+' : ''}${artisYuzde.toFixed(2)}% (${artisTutar >= 0 ? '+' : ''}${fmt(artisTutar)})</strong>
                      </td>
                    </tr>
                  </tbody>
                </table>
              `;
            }

            // 2026 Ödeme Toplamı vs Ramazan-ı Şerif Hedefi Karşılaştırması
            const ramazanKarsilastirmaEl = $('ramazanKarsilastirma');
            if (ramazanKarsilastirmaEl) {
              const fark = ramazan2026Hedefi - planlanan2026Gider;
              const durum = fark >= 0 ? 'Pozitif (Ramazan hedefi gideri karşılıyor veya üzerinde)' : 'Negatif (Ramazan hedefi gideri karşılamıyor)';
              ramazanKarsilastirmaEl.innerHTML = `
                <table class="tablo">
                  <thead>
                    <tr><th>Metrik</th><th class="sayi">Tutar</th></tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>2026 Planlanan Ödeme Toplamı (Tüm Personel)</td>
                      <td class="sayi">${fmt(planlanan2026Gider)}</td>
                    </tr>
                    <tr>
                      <td>2026 Toplam Ramazan-ı Şerif Hedefi</td>
                      <td class="sayi">${fmt(ramazan2026Hedefi)}</td>
                    </tr>
                    <tr>
                      <td><strong>Fark (Ramazan Hedefi - Ödeme Toplamı)</strong></td>
                      <td class="sayi ${fark >= 0 ? 'artis-pozitif' : 'artis-negatif'}"><strong>${fmt(fark)}</strong></td>
                    </tr>
                    <tr>
                      <td><strong>Durum</strong></td>
                      <td class="sayi ${fark >= 0 ? 'artis-pozitif' : 'artis-negatif'}"><strong>${durum}</strong></td>
                    </tr>
                  </tbody>
                </table>
                <p style="margin-top: 10px; font-size: 11px; color: #000;">
                  <em>Not: Ramazan-ı Şerif hedefi, planlanan gideri karşılamalı veya üzerinde olmalıdır.</em>
                </p>
              `;
            }

            // Toplam Bütçe – Tipe Göre: Ödeme Tipi | Planlanan Gider | Bütçe | Aşıyor mu?
            // Planlanan gider tutarları PLANLANAN_2026_GIDERLER_TIP'ten hesaplanır (kira analizi ile aynı kaynak)
            const butcePayAnaliziEl = $('butcePayAnalizi');
            if (butcePayAnaliziEl) {
              const toplamButceTipleri = (() => {
                const keys = ['hediye', 'ikramiye', 'cocuk', 'elbise', 'kira', 'yakacak', 'yol', 'sigorta'];
                const labels = { hediye: 'Hediye', ikramiye: 'İkramiye', cocuk: 'Çocuk', elbise: 'Elbise', kira: 'Kira', yakacak: 'Yakacak Yardımı', yol: 'Yol Yardımı', sigorta: 'Sigorta' };
                const t = {};
                keys.forEach(k => { t[labels[k]] = 0; });
                Object.values(PLANLANAN_2026_GIDERLER_TIP).forEach(o => {
                  keys.forEach(k => { t[labels[k]] += (o[k] || 0); });
                });
                return t;
              })();
              // 2026 bütçe limiti (tip bazında) – gerçek bütçe değerleriyle güncellenebilir
              const BUTCE_2026_TIP = {
                'Hediye': 4300000,
                'İkramiye': 540000,
                'Çocuk': 150000,
                'Elbise': 100000,
                'Kira': 1300000,
                'Yakacak Yardımı': 145000,
                'Yol Yardımı': 35000,
                'Sigorta': 980000
              };
              const tipler = [
                { key: 'hediye', label: 'Hediye', butceKey: 'Hediye' },
                { key: 'ikramiye', label: 'İkramiye', butceKey: 'İkramiye' },
                { key: 'cocuk', label: 'Çocuk', butceKey: 'Çocuk' },
                { key: 'elbise', label: 'Elbise', butceKey: 'Elbise' },
                { key: 'kira', label: 'Kira', butceKey: 'Kira' },
                { key: 'yakacak', label: 'Yakacak Yardımı', butceKey: 'Yakacak Yardımı' },
                { key: 'yol', label: 'Yol Yardımı', butceKey: 'Yol Yardımı' },
                { key: 'sigorta', label: 'Sigorta', butceKey: 'Sigorta' }
              ];
              let butceHtml = '<table class="tablo tablo--mor"><thead><tr><th>Ödeme Tipi</th><th class="sayi">Planlanan Gider</th><th class="sayi">Bütçe</th><th>Aşıyor mu?</th></tr></thead><tbody>';
              tipler.forEach(tip => {
                const planlanan = toplamButceTipleri[tip.butceKey] || 0;
                const butce = BUTCE_2026_TIP[tip.butceKey] != null ? BUTCE_2026_TIP[tip.butceKey] : planlanan;
                const asiyor = planlanan > butce;
                butceHtml += `<tr><td>${tip.label}</td><td class="sayi">${fmt(planlanan)}</td><td class="sayi">${fmt(butce)}</td><td class="${asiyor ? 'artis-negatif' : 'artis-pozitif'}">${asiyor ? 'Evet (Aşıyor)' : 'Hayır (Aşmıyor)'}</td></tr>`;
              });
              const toplamPlanlanan = Object.values(toplamButceTipleri).reduce((s, v) => s + v, 0);
              const toplamButce = tipler.reduce((s, t) => s + (BUTCE_2026_TIP[t.butceKey] != null ? BUTCE_2026_TIP[t.butceKey] : toplamButceTipleri[t.butceKey] || 0), 0);
              const toplamAsiyor = toplamPlanlanan > toplamButce;
              butceHtml += `<tr style="background-color: #f0f0f0;"><td><strong>TOPLAM</strong></td><td class="sayi"><strong>${fmt(toplamPlanlanan)}</strong></td><td class="sayi"><strong>${fmt(toplamButce)}</strong></td><td class="${toplamAsiyor ? 'artis-negatif' : 'artis-pozitif'}"><strong>${toplamAsiyor ? 'Evet (Aşıyor)' : 'Hayır (Aşmıyor)'}</strong></td></tr>`;
              butceHtml += '</tbody></table>';
              butceHtml += '<p style="margin-top: 10px; font-size: 11px; color: #c53030; font-weight: 600;">Planlanan gider = mevcut 9 personel içindir, diğer personel verileri yoktur.</p>';
              butcePayAnaliziEl.innerHTML = butceHtml;
            }

            // 2026 Yılı Analiz Yorumları (Kurum geneli planlanan ödeme, toplam Ramazan hedefi, pozitif/negatif karşılama)
            const yil2026AnalizYorumlariEl = $('yil2026AnalizYorumlari');
            if (yil2026AnalizYorumlariEl) {
              const fark = ramazan2026Hedefi - planlanan2026Gider;
              const pozitif = fark >= 0;
              const tahsilatCumle = 'Hedefin %60 oranında tahsilatı Ramazan-ı Şerif sonuna kadar tamamlanması, %40\'ı ise sene içerisinde tamamlanması beklenmektedir.';
              const yorumPozitif = 'Pozitif karşılama. Kurum genelinde 1 senelik planlanan gider, toplam Ramazan-ı Şerif hedefi ile karşılanabiliyor. Hedefe ulaşmak için çalışmaların (iftar-sahur vb.) ve tahsilatın sürdürülmesi önemlidir.';
              const yorumNegatif = 'Negatif karşılama. Kurum genelinde 1 senelik planlanan gider, toplam Ramazan-ı Şerif hedefi ile karşılanamıyor. Yıl içerisindeki diğer çalışmalara ağırlık verilmesi ve tahsilat planlamasının güçlendirilmesi önerilir.';
              yil2026AnalizYorumlariEl.innerHTML = `
                <div class="yil-kutu" style="max-width: 100%;">
                  <p style="margin: 0 0 10px 0; font-size: 12px; line-height: 1.6;">
                    Kurum genelinde 2026 yılı 1 senelik planlanan ödeme tutarı (tüm personel toplamı) <strong>${fmt(planlanan2026Gider)}</strong> olarak öngörülmektedir.
                  </p>
                  <p style="margin: 0 0 10px 0; font-size: 12px; line-height: 1.6;">
                    Toplam Ramazan-ı Şerif hedefi <strong>${fmt(ramazan2026Hedefi)}</strong> olarak öngörülmektedir.
                  </p>
                  <p style="margin: 0 0 8px 0; font-size: 12px; line-height: 1.6;">
                    ${pozitif ? '<strong style="color: #006400;">' + yorumPozitif + '</strong>' : '<strong style="color: #8b0000;">' + yorumNegatif + '</strong>'}
                  </p>
                  <p style="margin: 0; font-size: 12px; line-height: 1.6; color: #444;">
                    ${tahsilatCumle}
                  </p>
                </div>
              `;
            }

            // Kira Artışı ile Alakalı Analiz (Kurum Geneli Toplam)
            const kiraAnaliziEl = $('kiraAnalizi');
            if (kiraAnaliziEl) {
              const kiraYillik = {};
              tumYillar.forEach(y => {
                const kiraToplam = (y.odemeData || []).filter(od => {
                  const tip = (od.tip || od.odeme_tipi || '').toLowerCase();
                  return tip.includes('kira');
                }).reduce((sum, od) => sum + parseFloat(od.tutar || 0), 0);
                kiraYillik[y.yil] = kiraToplam;
              });
              const k2023 = kiraYillik[2023] || 0;
              const k2024 = kiraYillik[2024] || 0;
              const k2025 = kiraYillik[2025] || 0;
              const artis23_24 = k2023 > 0 ? ((k2024 - k2023) / k2023 * 100) : 0;
              const artis24_25 = k2024 > 0 ? ((k2025 - k2024) / k2024 * 100) : 0;
              // 2026 planlanan kira: tüm personel toplamı
              const kira2026Planlanan = Object.values(PLANLANAN_2026_GIDERLER_TIP).reduce((s, o) => s + (o.kira || 0), 0);
              const artis25_26 = k2025 > 0 ? ((kira2026Planlanan - k2025) / k2025 * 100) : 0;
              const KIRA_BUTCE_2026 = 1300000;
              const kiraButceAsiyor = kira2026Planlanan > KIRA_BUTCE_2026;
              const kiraUyariMetni = kiraButceAsiyor ? ' <strong style="color: #c53030;">Planlanan kira gideri bütçeyi aşmaktadır, bütçe aşma uyarısı.</strong>' : '';

              kiraAnaliziEl.innerHTML = `
                <table class="tablo tablo--kira">
                  <thead>
                    <tr><th>Yıl</th><th class="sayi">Toplam Kira Ödemesi (Kurum Geneli)</th><th class="sayi">Yıllık Artış</th></tr>
                  </thead>
                  <tbody>
                    <tr><td>2023</td><td class="sayi">${fmt(k2023)}</td><td class="sayi">-</td></tr>
                    <tr><td>2024</td><td class="sayi">${fmt(k2024)}</td><td class="sayi ${artis23_24 >= 0 ? 'artis-pozitif' : 'artis-negatif'}">${artis23_24 >= 0 ? '+' : ''}${artis23_24.toFixed(1)}% (${fmt(k2024 - k2023)})</td></tr>
                    <tr><td>2025</td><td class="sayi">${fmt(k2025)}</td><td class="sayi ${artis24_25 >= 0 ? 'artis-pozitif' : 'artis-negatif'}">${artis24_25 >= 0 ? '+' : ''}${artis24_25.toFixed(1)}% (${fmt(k2025 - k2024)})</td></tr>
                    <tr style="background-color: #f0f0f0;">
                      <td><strong>2026 Tahmini-Planlanan (Tüm Personel)</strong></td>
                      <td class="sayi"><strong>${fmt(kira2026Planlanan)}</strong></td>
                      <td class="sayi ${artis25_26 >= 0 ? 'artis-pozitif' : 'artis-negatif'}"><strong>${artis25_26 >= 0 ? '+' : ''}${artis25_26.toFixed(1)}% (${fmt(kira2026Planlanan - k2025)})</strong></td>
                    </tr>
                  </tbody>
                </table>
                <p style="margin-top: 12px; font-size: 12px; line-height: 1.6;">
                  Kurum genelinde 2026 planlanan toplam kira <strong>${fmt(kira2026Planlanan)}</strong> olarak öngörülmektedir. Kira artışları personel giderlerinin en büyük kalemlerinden biridir; bütçe kontrolünün düzenli yapılması önerilir.${kiraUyariMetni}
                </p>
              `;
            }

            // Personel bazında 2026 planlanan ödeme – Ramazan hedefi – Net performans (9 personel + diğer personel manuel)
            const personel2026NetPerformansEl = $('personel2026NetPerformans');
            if (personel2026NetPerformansEl) {
              const personelListesi = Object.values(PERSONEL_UID_MAP);
              let toplamPlanlanan = 0;
              let toplamRamazan = 0;
              let tabloHtml = '<table class="tablo tablo--hedef"><thead><tr><th>Personel İsmi</th><th class="sayi">2026 Planlanan Ödeme</th><th class="sayi">2026 Ramazan-ı Şerif Hedefi</th><th class="sayi">Net Performans</th></tr></thead><tbody>';
              personelListesi.forEach(ad => {
                const key = normalizeIsim(ad);
                const planlanan = PLANLANAN_2026_GIDERLER[key] != null ? PLANLANAN_2026_GIDERLER[key] : 0;
                const ramazan = RAMAZAN_2026_HEDEFLERI[key] != null ? RAMAZAN_2026_HEDEFLERI[key] : 0;
                const net = ramazan - planlanan;
                toplamPlanlanan += planlanan;
                toplamRamazan += ramazan;
                tabloHtml += `<tr><td>${ad}</td><td class="sayi">${fmt(planlanan)}</td><td class="sayi">${fmt(ramazan)}</td><td class="sayi ${net >= 0 ? 'artis-pozitif' : 'artis-negatif'}">${fmt(net)}</td></tr>`;
              });
              const DIGER_PERSONEL_2026_PLANLANAN = 1572600;
              toplamPlanlanan += DIGER_PERSONEL_2026_PLANLANAN;
              tabloHtml += `<tr style="background-color: #f8f8f8;"><td>DİĞER PERSONEL</td><td class="sayi">${fmt(DIGER_PERSONEL_2026_PLANLANAN)}</td><td class="sayi">Yok</td><td class="sayi artis-negatif">Hedef yok</td></tr>`;
              const toplamNet = toplamRamazan - toplamPlanlanan;
              tabloHtml += `<tr style="background-color: #e8e8e8; font-weight: 600;"><td><strong>TOPLAM</strong></td><td class="sayi"><strong>${fmt(toplamPlanlanan)}</strong></td><td class="sayi"><strong>${fmt(toplamRamazan)}</strong></td><td class="sayi ${toplamNet >= 0 ? 'artis-pozitif' : 'artis-negatif'}"><strong>${fmt(toplamNet)}</strong></td></tr>`;
              tabloHtml += '</tbody></table>';
              personel2026NetPerformansEl.innerHTML = tabloHtml;
            }

            // Personel bazında yıllık performans özeti (9 personel, sıra: Muhsin Çelik, Serhan Durak, ...)
            const PERSONEL_SIRASI = ['MUHSİN ÇELİK', 'SERHAN DURAK', 'FARUK NAFİZ ÖZGAN', 'İBRAHİM AY', 'KEREM KOCAOĞLU', 'MAHMUT SOLMAZ', 'SAMET ÇAKIR', 'MEHMET TAHA KESKİN', 'AHMETALİ EMRE ŞAHİN'];
            const personelBazindaYillikEl = $('personelBazindaYillikPerformans');
            if (personelBazindaYillikEl) {
              const getUidByName = (ad) => Object.keys(PERSONEL_UID_MAP).find(u => PERSONEL_UID_MAP[u] === ad) || '';
              const personelYillikData = {};
              PERSONEL_SIRASI.forEach(ad => {
                const uid = getUidByName(ad);
                if (!uid) return;
                personelYillikData[ad] = {};
                const adKey = normalizeIsim(ad);
                tumYillar.forEach(y => {
                  const odemeToplam = (y.odemeData || []).filter(od => od.personel_uid === uid).reduce((s, od) => s + parseFloat(od.tutar || 0), 0);
                  // gecmis_teberru_kayitlari: referans alanı personel ismi – isim eşleştirmesi ile personel + yıl bazında toplam
                  const teberruToplam = (teberruByPersonelAndYear[adKey] && teberruByPersonelAndYear[adKey][y.yil]) ? teberruByPersonelAndYear[adKey][y.yil] : 0;
                  const ramazanToplam = (y.hedefData || []).filter(h => h.uid === uid && ((h.kategori || '').indexOf('Ramazan') >= 0 || (h.tip || '').indexOf('Ramazan') >= 0)).reduce((s, h) => s + parseFloat(h.tutar || 0), 0);
                  const hedefTutarToplam = (y.hedefData || []).filter(h => h.uid === uid).reduce((s, h) => s + parseFloat(h.tutar || 0), 0);
                  const hedefToplam = (y.hedefData || []).filter(h => h.uid === uid).reduce((s, h) => s + parseFloat(h.hedef || 0), 0);
                  // arsiv_hedefler: personel + yıl ile eşleştirerek kurban_adedi (kurbanAdediByPersonelAndYear yukarıda dolduruldu)
                  const kurbanAdedi = (kurbanAdediByPersonelAndYear[adKey] && kurbanAdediByPersonelAndYear[adKey][y.yil]) ? kurbanAdediByPersonelAndYear[adKey][y.yil] : 0;
                  const netPerformans = hedefTutarToplam - odemeToplam;
                  const hedefUlasmaOrani = hedefToplam > 0 ? (hedefTutarToplam / hedefToplam * 100) : 0;
                  personelYillikData[ad][y.yil] = { odemeToplam, teberruToplam, ramazanToplam, hedefTutarToplam, hedefToplam, hedefUlasmaOrani, netPerformans, kurbanAdedi };
                });
              });
              let kartlarHtml = '';
              PERSONEL_SIRASI.forEach(ad => {
                const yillik = personelYillikData[ad];
                if (!yillik) return;
                let tabloHtml = '<table class="tablo tablo--mavi tablo--kucuk"><thead><tr><th>Yıl</th><th class="sayi">Toplam Ödeme</th><th class="sayi">Teberru</th><th class="sayi">Ramazan</th><th class="sayi">Hedef Tutar</th><th class="sayi">Hedef</th><th class="sayi">Ulaşma %</th><th class="sayi">Net Perf.</th><th class="sayi">Kurban Adedi</th></tr></thead><tbody>';
                tumYillar.forEach(y => {
                  const d = yillik[y.yil];
                  if (!d) return;
                  tabloHtml += `<tr><td>${y.yil}</td><td class="sayi">${fmt(d.odemeToplam)}</td><td class="sayi">${fmt(d.teberruToplam)}</td><td class="sayi">${fmt(d.ramazanToplam)}</td><td class="sayi">${fmt(d.hedefTutarToplam)}</td><td class="sayi">${fmt(d.hedefToplam)}</td><td class="sayi">${d.hedefUlasmaOrani.toFixed(1)}%</td><td class="sayi ${d.netPerformans >= 0 ? 'artis-pozitif' : 'artis-negatif'}">${fmt(d.netPerformans)}</td><td class="sayi">${d.kurbanAdedi}</td></tr>`;
                });
                tabloHtml += '</tbody></table>';
                kartlarHtml += `<div class="rapor-bolumu rapor-bolumu--kucuk"><h3>${ad}</h3>${tabloHtml}</div>`;
              });
              personelBazindaYillikEl.innerHTML = kartlarHtml || '<p>Veri yok.</p>';
            }

          } catch (e) {
            console.error('Veriler yüklenemedi:', e);
            const hataMesaji = '<p style="color: #000;">Hata: ' + (e.message || String(e)) + '</p>';
            
            // Sadece var olan elementlere eriş
            const yillikPerfEl = $('yillikPerformansTablosuBody');
            if (yillikPerfEl) yillikPerfEl.innerHTML = '<tr><td colspan="8">' + hataMesaji + '</td></tr>';
            
            const odemeAnalizEl = $('odemeYillikAnaliz');
            if (odemeAnalizEl) odemeAnalizEl.innerHTML = hataMesaji;
            
            const yorumListEl = $('yorumListesi');
            if (yorumListEl) yorumListEl.innerHTML = '<li>Veriler yüklenirken bir hata oluştu. Lütfen daha sonra tekrar deneyiniz.</li>';
            
            const projeksiyonEl = $('projeksiyonMetni');
            if (projeksiyonEl) projeksiyonEl.innerHTML = 'Hesaplama yapılamadı.';
          }
        }

        yukleVeriler();
      });
    });

    function pdfCiktisiAl() {
      const element = document.getElementById("pdfAlani");
      if (!element) {
        alert("PDF alanı bulunamadı!");
        return;
      }

      const opt = {
        margin: [0.5, 0.5, 0.5, 0.5],
        filename: 'tum-personel-performans-raporu.pdf',
        image: { type: 'png', quality: 0.98 },
        html2canvas: {
          scale: 2,
          useCORS: true,
          allowTaint: true,
          scrollX: 0,
          scrollY: 0,
          windowWidth: 800
        },
        jsPDF: {
          unit: 'in',
          format: 'a4',
          orientation: 'portrait'
        }
      };

      html2pdf().set(opt).from(element).save();
    }
  </script>
</body>
</html>
