<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Personel Performans Raporu</title>
  <style>
    html { overflow-x: hidden; }
    body { 
      margin: 0; 
      font-family: Calibri, Candara, 'Segoe UI', Arial, sans-serif; 
      background-color: #f1f1f1; 
      color: #000;
      overflow-x: hidden;
      word-wrap: break-word;
    }
    .sayfa {
      width: 100%;
      max-width: 800px;
      margin: 20px auto;
      background-color: white;
      padding: 30px 40px;
      box-sizing: border-box;
      border: 1px solid #ccc;
      page-break-after: auto;
      transition: opacity 0.25s ease-out, box-shadow 0.25s ease-out;
      overflow-x: hidden;
      overflow-wrap: break-word;
    }
    .kapak-sayfa {
      text-align: center;
      padding: 80px 40px;
      min-height: 600px;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      align-items: center;
    }
    .kapak-baslik {
      font-size: 54px;
      font-weight: bold;
      color: #1a472a;
      margin-bottom: 30px;
      letter-spacing: 3px;
      margin-top: 100px;
    }
    .kapak-alt-baslik {
      font-size: 22px;
      color: #2d5016;
      margin-bottom: 60px;
      font-weight: 600;
    }
    .kapak-personel-ismi {
      font-size: 30px;
      font-weight: bold;
      color: #1a472a;
      margin-bottom: 40px;
      margin-top: 20px;
    }
    .kapak-tarih {
      font-size: 12px;
      color: #555;
      margin-top: auto;
      padding-top: 40px;
    }
    .baslik { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 28px;
      padding-bottom: 18px;
      border-bottom: 2px solid #2f4f30;
    }
    .baslik-sag {
      text-align: right;
      font-size: 11px;
      color: #555;
      line-height: 1.4;
    }
    .baslik-sol h1 { 
      font-size: 20px; 
      margin: 0 0 4px 0; 
      color: #2f4f30;
    }
    .baslik-sol h2 { 
      font-size: 15px; 
      font-weight: normal; 
      margin: 0; 
      color: #666;
    }
    .filtre-bilgi {
      font-size: 12px;
      color: #666;
      margin-bottom: 15px;
      padding: 8px 10px;
      background: #f8f9fa;
      border-radius: 5px;
    }
    .kpi-container {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-bottom: 25px;
    }
    .kpi-item {
      background: #f8f9fa;
      border: 1px solid #ddd;
      padding: 12px;
      border-radius: 5px;
      text-align: center;
    }
    .kpi-item .lbl {
      font-size: 11px;
      color: #666;
      margin-bottom: 5px;
    }
    .kpi-item .val {
      font-size: 18px;
      font-weight: bold;
      color: #2f4f30;
    }
    .kpi-item .val.iyi { color: #2f4f30; }
    .kpi-item .val.kotu { color: #000; }

    .alt-baslik {
      font-size: 16px;
      font-weight: 600;
      margin: 28px 0 18px 0;
      color: #2f4f30;
      border-bottom: 1px solid #ddd;
      padding-bottom: 8px;
    }

    .personel-kimlik {
      display: grid;
      grid-template-columns: 1.3fr 1.7fr;
      gap: 15px;
      font-size: 12px;
      margin-bottom: 20px;
    }
    .personel-kimlik .etiket {
      font-weight: 600;
      color: #444;
      width: 130px;
      display: inline-block;
    }
    .personel-kimlik p {
      margin: 4px 0;
      color: #333;
    }
    .personel-not {
      font-size: 11px;
      color: #666;
      margin-top: 8px;
    }
    .rapor-bolumu {
      margin-top: 32px;
      padding: 18px 15px;
      background: #f8f9fa;
      border-radius: 5px;
      border: 1px solid #ddd;
      max-width: 100%;
      overflow-wrap: break-word;
    }
    .rapor-bolumu h3 {
      margin: 0 0 15px 0;
      font-size: 16px;
      color: #2f4f30;
      border-bottom: 1px solid #ddd;
      padding-bottom: 8px;
    }
    .rapor-bolumu p {
      margin: 8px 0;
      font-size: 12px;
      line-height: 1.6;
      color: #333;
    }
    .yil-ozetleri {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 12px;
      margin-top: 10px;
    }
    .yil-kutu {
      background: #fff;
      border-radius: 6px;
      border: 1px solid #ddd;
      padding: 10px 12px;
      font-size: 11px;
    }
    .yil-kutu h4 {
      margin: 0 0 6px 0;
      font-size: 12px;
      color: #1f2937;
    }
    .yil-kutu ul {
      margin: 0;
      padding-left: 16px;
    }
    .yil-kutu li {
      margin: 2px 0;
    }
    .yorum-listesi {
      margin: 8px 0 0 0;
      padding-left: 18px;
      font-size: 12px;
    }
    .yorum-listesi li {
      margin: 4px 0;
    }
    .yorum-etiket {
      font-weight: 600;
      color: #111827;
    }
    .tablo {
      width: 100%;
      max-width: 100%;
      border-collapse: collapse;
      margin: 15px 0;
      font-size: 12px;
      table-layout: fixed;
    }
    .tablo th, .tablo td {
      border: 1px solid #ddd;
      padding: 6px 8px;
      text-align: left;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
    .tablo th {
      background-color: #2f4f30;
      color: #fff;
      font-weight: 600;
    }
    .tablo.tablo--mavi thead th { background-color: #3d5a80; }
    .tablo.tablo--kahve thead th { background-color: #5c4a3a; }
    .tablo.tablo--mor thead th { background-color: #4a3d6a; }
    .tablo.tablo--kira thead th { background-color: #6b4a2e; }
    .tablo.tablo--hedef thead th { background-color: #2d5a4a; }
    /* Yıllara Göre Hedef Detayı tablosu – sütun genişlikleri (manuel ayarlanabilir) */
    .tablo.tablo--hedef-detay { table-layout: fixed; width: 100%; }
    .tablo.tablo--hedef-detay col:nth-child(1) { width: 50px; }   /* Yıl */
    .tablo.tablo--hedef-detay col:nth-child(2) { width: 60px; }   /* Sıralama */
    .tablo.tablo--hedef-detay col:nth-child(3) { width: 160px; }  /* Kategori */
    .tablo.tablo--hedef-detay col:nth-child(4) { width: 95px; }   /* Hedef */
    .tablo.tablo--hedef-detay col:nth-child(5) { width: 95px; }    /* Tutar */
    .tablo.tablo--hedef-detay col:nth-child(6) { width: 105px; }  /* Hedefe Ulaşma */
    .tablo tr:nth-child(even) {
      background-color: #f8f9fa;
    }
    .tablo .sayi {
      text-align: right;
      font-family: Calibri, Candara, 'Segoe UI', Arial, sans-serif;
    }
    .artis-pozitif {
      color: #006400;
      font-weight: 600;
    }
    .artis-negatif {
      color: #8b0000;
      font-weight: 600;
    }
    .artis-nor {
      color: #1e3a8a;
      font-weight: 600;
    }
    .sayfa-ayirici {
      page-break-before: always;
      margin-top: 48px;
      padding-top: 28px;
      border-top: 3px solid #2f4f30;
      transition: margin-top 0.2s ease-out, padding-top 0.2s ease-out;
    }
    .sayfa > div:not(:first-child) {
      transition: opacity 0.2s ease-out;
    }
    .btn-alani { 
      text-align: center; 
      margin-top: 30px; 
    }
    button {
      padding: 10px 20px; 
      background-color: #4a637d;
      border: none; 
      color: white; 
      font-size: 15px;
      border-radius: 5px; 
      cursor: pointer;
    }
    button:hover { 
      background-color: #3b526b; 
    }
    @media print {
      html, body { overflow-x: hidden; }
      body { 
        background-color: white; 
        font-family: Calibri, Candara, Arial, sans-serif;
      }
      .btn-alani { display: none; }
      .sayfa { 
        border: none; 
        margin: 0; 
        padding: 20px; 
        max-width: 100%;
        overflow: visible;
      }
      .sayfa-ayirici { page-break-before: always; }
      .tablo { page-break-inside: auto; }
      .tablo tr { page-break-inside: avoid; page-break-after: auto; }
      .rapor-bolumu { page-break-inside: avoid; }
    }
  </style>
</head>
<body>
  <div class="sayfa" id="pdfAlani">
    <!-- 1. SAYFA: KAPAK -->
    <div class="kapak-sayfa">
      <div class="kapak-baslik">KARAAĞAÇ FATİH</div>
      <div class="kapak-alt-baslik">PERSONEL PERFORMANS ANALİZİ (2023-2025)</div>
      <div class="kapak-personel-ismi" id="personelIsmiKapak">
        Personel bilgileri yükleniyor...
      </div>
      <div class="rapor-bolumu" id="personelKimlikKapak" style="margin-top: 30px; text-align: left; max-width: 600px;">
        <h3>Personel Kimlik Bilgileri</h3>
        <div class="personel-kimlik" id="personelKimlikKapakIcerik">
          <p>Personel bilgileri yükleniyor...</p>
        </div>
      </div>
      <div class="kapak-tarih">Rapor Tarihi: <span id="raporTarihiKapak"></span></div>
    </div>

    <!-- 2. SAYFA: GENEL BAKIŞ VE YILLIK PERFORMANS -->
    <div class="sayfa-ayirici">
      <div class="baslik">
        <div class="baslik-sol">
          <h1>KARAAĞAÇ FATİH DAİMİ TEKÂMÜLALTI</h1>
          <h2>Personel Performans Ölçüm Raporu (2023 - 2025)</h2>
        </div>
        <div class="baslik-sag">
          <div><strong>Rapor Tarihi:</strong> <span id="raporTarihi"></span></div>
        </div>
      </div>

      <div class="filtre-bilgi" id="filtreBilgi" style="display: none;">
        Filtreler yükleniyor...
      </div>

      <div class="alt-baslik">Genel Bakış Tablosu</div>
      <div class="rapor-bolumu">
        <table class="tablo tablo--genel" id="genelBakışTablosu">
          <thead>
            <tr>
              <th>Metrik</th>
              <th class="sayi">Tutar</th>
            </tr>
          </thead>
          <tbody id="genelBakışTablosuBody">
            <tr><td colspan="2">Veriler yükleniyor...</td></tr>
          </tbody>
        </table>
      </div>

      <div class="alt-baslik" style="margin-top: 30px;">Yıllık Performans Özeti Tablosu</div>
      <div class="rapor-bolumu">
        <table class="tablo tablo--mavi" id="yillikPerformansTablosu">
          <thead>
            <tr>
              <th>Yıl</th>
              <th class="sayi">Toplam Ödeme</th>
              <th class="sayi">Toplam Teberru</th>
              <th class="sayi">Toplam Ramazan-ı Şerif</th>
              <th class="sayi">Toplam Hedef Tutar</th>
              <th class="sayi">Toplam Hedef</th>
              <th class="sayi">Hedef Ulaşma Oranı</th>
              <th class="sayi">Net Performans</th>
            </tr>
          </thead>
          <tbody id="yillikPerformansTablosuBody">
            <tr><td colspan="8">Veriler yükleniyor...</td></tr>
          </tbody>
        </table>
      </div>

      <div class="rapor-bolumu" id="odemeAnalizBolumu">
        <h3>Yıllara Göre Hedef Detayı</h3>
        <div id="yillaraGoreHedefTablosu">Veriler yükleniyor...</div>
        <div id="ucYilDegerlendirmesi" style="margin-top: 20px;"></div>
      </div>
    </div>

    <!-- 3. SAYFA: ÖDEME TİP ARTIŞLARI, PERSONEL ÖDEMELERİ VE ANALİZ -->
    <div class="sayfa-ayirici">
      <div class="baslik">
        <div class="baslik-sol">
          <h1>KARAAĞAÇ FATİH DAİMİ TEKÂMÜLALTI</h1>
          <h2>Personel Performans Ölçüm Raporu (2023 - 2025)</h2>
        </div>
      </div>

      <div class="alt-baslik">Ödeme Tiplerinin Artışları (Yüzdelik ve Tutar)</div>
      <div class="rapor-bolumu">
        <div id="odemeTipArtislari">Artış analizi hazırlanıyor...</div>
      </div>

      <div class="alt-baslik" style="margin-top: 30px;">Personel Ödemeleri (2023-2025) ve Genel Analiz</div>
      <div class="rapor-bolumu" id="yorumBolumu">
        <h3>Genel Yorumlar</h3>
        <ul class="yorum-listesi" id="yorumListesi">
          <li>Yorumlar hazırlanıyor...</li>
        </ul>
      </div>

      <div class="alt-baslik">6. 2026 Gider ve Hedef Planlaması</div>
      <div class="rapor-bolumu" id="projeksiyonBolumu">
        <h3>2026 Personel Gideri ve Hedef Önerileri</h3>
        <div id="projeksiyonMetni">Projeksyon hesaplanıyor...</div>
        
        <h3 style="margin-top: 20px;">2026 Ödeme Toplamı vs Ramazan-ı Şerif Hedefi Karşılaştırması</h3>
        <div id="ramazanKarsilastirma">Karşılaştırma hazırlanıyor...</div>
        
        <h3 style="margin-top: 20px;">Toplam Bütçeye Göre Tipe Göre Yüzdelik Pay</h3>
        <div id="butcePayAnalizi">Bütçe pay analizi hazırlanıyor...</div>
        
        <h3 style="margin-top: 20px;">2026 Yılı Analiz Yorumları</h3>
        <div id="yil2026AnalizYorumlari">Yorumlar hazırlanıyor...</div>
        
        <h3 style="margin-top: 20px;">Kira Artışı ile Alakalı Analiz ve Yönlendirme Planlama</h3>
        <div id="kiraAnalizi">Kira analizi hazırlanıyor...</div>
      </div>
    </div>
  </div>

  <div class="btn-alani">
    <button onclick="pdfCiktisiAl()">PDF Çıktısı Al</button>
  </div>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="../../src/supabase.js"></script>
  <script src="../../src/supabase-auth-wrapper.js"></script>
  <script src="../../src/supabase-db-wrapper.js"></script>
  <script src="../../js/ortak.js"></script>
  
  <!-- html2pdf -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      function waitForSupabaseAndOrtak(callback) {
        // window.supabase'in bir client instance olduğunu kontrol et (from metodu olmalı)
        if (typeof window.supabase !== 'undefined' && 
            typeof window.supabase.from === 'function' && 
            typeof window.norm !== 'undefined') {
          callback();
        } else {
          setTimeout(() => waitForSupabaseAndOrtak(callback), 50);
        }
      }

      waitForSupabaseAndOrtak(() => {
        const getSupabase = () => window.supabase;
        const $ = (id) => {
          const el = document.getElementById(id);
          if (!el) {
            console.warn(`Element with id "${id}" not found`);
          }
          return el;
        };
        const fmt = n => (n==null||isNaN(n)) ? '₺0' : '₺' + Number(n).toLocaleString('tr-TR',{maximumFractionDigits:0});
        const basHarfBuyuk = (str) => {
          if (!str) return '';
          return str.split(' ').map(kelime => {
            return kelime.charAt(0).toUpperCase() + kelime.slice(1).toLowerCase();
          }).join(' ');
        };
        const normalizeIsim = (str) => str ? String(str).toLocaleLowerCase('tr-TR').trim().replace(/ı/g, 'i').replace(/ğ/g, 'g').replace(/ş/g, 's').replace(/ü/g, 'u').replace(/ö/g, 'o').replace(/ç/g, 'c') : '';

        // Rapor tarihi
        const bugun = new Date();
        const tarihStr = bugun.toLocaleDateString('tr-TR', { day: '2-digit', month: '2-digit', year: 'numeric' });
        const raporTarihiEl = $('raporTarihi');
        if (raporTarihiEl) {
          raporTarihiEl.textContent = tarihStr;
        }
        const raporTarihiKapakEl = $('raporTarihiKapak');
        if (raporTarihiKapakEl) {
          raporTarihiKapakEl.textContent = tarihStr;
        }

        // 2026 Planlanan Giderler - Tip Bazında (personel-detay.md'den)
        const PLANLANAN_2026_GIDERLER_TIP = (() => {
          const map = {};
          const ekle = (ad, giderler) => {
            map[normalizeIsim(ad)] = giderler;
          };
          
          // Sigorta 2026: Mahmut Solmaz, Faruk Nafiz Özgan, İbrahim Ay için her biri 120.000₺/yıl; diğerleri 0. Bütçe planlaması sigorta toplam 978.277₺.
          // MUHSİN ÇELİK: Hediye 12x35.800=429.600, İkramiye 2x35.800=71.600, Çocuk 12x4.200=50.400, Elbise 10.700, Kira 250.000, Yakacak 18.000
          ekle('MUHSİN ÇELİK', {
            hediye: 429600, // 12 x 35.800
            ikramiye: 71600, // 2 x 35.800
            cocuk: 50400, // 12 x 4.200
            elbise: 10700,
            kira: 250000,
            yakacak: 18000,
            yol: 0,
            sigorta: 0,
            toplam: 830300
          });
          
          // SERHAN DURAK: Hediye 12x30.300=363.600, İkramiye 2x30.300=60.600, Elbise 10.700, Kira 241.000, Yakacak 18.000
          ekle('SERHAN DURAK', {
            hediye: 363600, // 12 x 30.300
            ikramiye: 60600, // 2 x 30.300
            cocuk: 0,
            elbise: 10700,
            kira: 241000,
            yakacak: 18000,
            yol: 0,
            sigorta: 0,
            toplam: 693900
          });
          
          // FARUK NAFİZ ÖZGAN: Hediye, İkramiye, Çocuk, Elbise, Kira, Yakacak + Sigorta 120.000
          ekle('FARUK NAFİZ ÖZGAN', {
            hediye: 330000, // 12 x 27.500
            ikramiye: 55000, // 2 x 27.500
            cocuk: 16800, // 12 x 1.400
            elbise: 10700,
            kira: 241000,
            yakacak: 18000,
            yol: 0,
            sigorta: 120000,
            toplam: 791500
          });
          
          // İBRAHİM AY: Hediye, İkramiye, Çocuk, Elbise, Kira, Yakacak, Yol + Sigorta 120.000
          ekle('İBRAHİM AY', {
            hediye: 396000, // 12 x 33.000
            ikramiye: 66000, // 2 x 33.000
            cocuk: 33600, // 12 x 2.800
            elbise: 10700,
            kira: 241000,
            yakacak: 18000,
            yol: 30000,
            sigorta: 120000,
            toplam: 915300
          });
          
          // KEREM KOCAOĞLU: Hediye 12x27.500=330.000, İkramiye 2x27.500=55.000, Çocuk 12x1.400=16.800, Elbise 10.700, Kira 200.000, Yakacak 18.000
          ekle('KEREM KOCAOĞLU', {
            hediye: 330000, // 12 x 27.500
            ikramiye: 55000, // 2 x 27.500
            cocuk: 16800, // 12 x 1.400
            elbise: 10700,
            kira: 200000,
            yakacak: 18000,
            yol: 0,
            sigorta: 0,
            toplam: 630500
          });
          
          // MAHMUT SOLMAZ: Hediye, İkramiye, Çocuk, Elbise, Kira, Yakacak + Sigorta 120.000
          ekle('MAHMUT SOLMAZ', {
            hediye: 330000, // 12 x 27.500
            ikramiye: 55000, // 2 x 27.500
            cocuk: 16800, // 12 x 1.400
            elbise: 10700,
            kira: 204000,
            yakacak: 18000,
            yol: 0,
            sigorta: 120000,
            toplam: 754500
          });
          
          // SAMET ÇAKIR: Hediye 12x20.600=247.200, İkramiye 2x20.600=41.200, Elbise 10.700
          ekle('SAMET ÇAKIR', {
            hediye: 247200, // 12 x 20.600
            ikramiye: 41200, // 2 x 20.600
            cocuk: 0,
            elbise: 10700,
            kira: 0,
            yakacak: 0,
            yol: 0,
            sigorta: 0,
            toplam: 299100
          });
          
          // MEHMET TAHA KESKİN: Hediye 12x20.600=247.200, İkramiye 2x20.600=41.200, Elbise 10.700
          ekle('MEHMET TAHA KESKİN', {
            hediye: 247200, // 12 x 20.600
            ikramiye: 41200, // 2 x 20.600
            cocuk: 0,
            elbise: 10700,
            kira: 0,
            yakacak: 0,
            yol: 0,
            sigorta: 0,
            toplam: 299100
          });
          
          // AHMETALİ EMRE ŞAHİN: Hediye 12x20.600=247.200, İkramiye 2x20.600=41.200, Elbise 10.700
          ekle('AHMETALİ EMRE ŞAHİN', {
            hediye: 247200, // 12 x 20.600
            ikramiye: 41200, // 2 x 20.600
            cocuk: 0,
            elbise: 10700,
            kira: 0,
            yakacak: 0,
            yol: 0,
            sigorta: 0,
            toplam: 299100
          });
          
          return map;
        })();

        // 2026 Yeni güncel aylık kira ve artış ayı (personel-detay.md'den – /12 değil, md'de yazan aylık tutarlar)
        const KIRA_2026_AYLIK_DETAY = (() => {
          const map = {};
          const ekle = (ad, aylik, artisAyi) => {
            map[normalizeIsim(ad)] = { aylik, artisAyi };
          };
          ekle('MUHSİN ÇELİK', 25000, 'Kasım');      // Kasım-Aralık tahmini 25.000₺/ay
          ekle('SERHAN DURAK', 23000, 'Ağustos');   // Ağustos-Aralık 23.000₺/ay
          ekle('FARUK NAFİZ ÖZGAN', 23000, 'Ağustos');
          ekle('İBRAHİM AY', 23000, 'Ağustos');      // tahmini diğer personel gibi
          ekle('KEREM KOCAOĞLU', 19000, 'Ağustos'); // Ağustos-Aralık 19.000₺/ay
          ekle('MAHMUT SOLMAZ', 17000, 'Ocak');     // Ocak itibariyle artış, max 17.000₺/ay
          ekle('SAMET ÇAKIR', 0, '-');              // kira yok
          ekle('MEHMET TAHA KESKİN', 0, '-');
          ekle('AHMETALİ EMRE ŞAHİN', 0, '-');
          return map;
        })();

        // 2026 Planlanan Giderler - Toplam (geriye uyumluluk için)
        const PLANLANAN_2026_GIDERLER = (() => {
          const map = {};
          Object.keys(PLANLANAN_2026_GIDERLER_TIP).forEach(key => {
            map[key] = PLANLANAN_2026_GIDERLER_TIP[key].toplam;
          });
          return map;
        })();

        // 2026 Ramazan-ı Şerif Hedefleri (personel-detay.md'den)
        const RAMAZAN_2026_HEDEFLERI = (() => {
          const map = {};
          const ekle = (ad, hedef) => {
            map[normalizeIsim(ad)] = hedef;
          };
          ekle('MUHSİN ÇELİK', 2500000);
          ekle('SERHAN DURAK', 1800000);
          ekle('FARUK NAFİZ ÖZGAN', 700000);
          ekle('KEREM KOCAOĞLU', 800000);
          ekle('MAHMUT SOLMAZ', 800000);
          ekle('İBRAHİM AY', 650000);
          ekle('SAMET ÇAKIR', 350000);
          ekle('MEHMET TAHA KESKİN', 250000);
          ekle('AHMETALİ EMRE ŞAHİN', 250000);
          return map;
        })();

        // Personel detayları (statik tanım - personel-detay.md içeriğine göre)
        // Personel UID eşleştirmeleri (personel-detay.md'den)
        const PERSONEL_UID_MAP = {
          '98a349eb-6cf9-4de3-99f7-345d23287b08': 'MUHSİN ÇELİK',
          '5f727148-7cef-4498-a2ce-351de15301d6': 'SERHAN DURAK',
          '99217ccf-182c-4a38-beec-7b75993dcaf6': 'FARUK NAFİZ ÖZGAN',
          '898eaaad-5fa5-4fd2-894b-2ad759ca74d6': 'İBRAHİM AY',
          '1288af1c-3757-4e36-89e6-f4a72f53a342': 'KEREM KOCAOĞLU',
          '9bac0f85-6df3-41f2-9017-baec13adb145': 'MAHMUT SOLMAZ',
          'aafd0046-e722-418a-b875-6cb7469ff450': 'SAMET ÇAKIR',
          '74a07b1e-d277-4b81-98b6-96b491084975': 'MEHMET TAHA KESKİN',
          '1319cbea-a35f-4262-9f0e-d4ad37182e7c': 'AHMETALİ EMRE ŞAHİN'
        };

        const PERSONEL_DETAYLARI = (() => {
          const map = {};
          const ekle = (ad, detay) => {
            map[normalizeIsim(ad)] = { ad, ...detay };
            // UID'den de erişilebilir olması için
            const uid = Object.keys(PERSONEL_UID_MAP).find(u => PERSONEL_UID_MAP[u] === ad);
            if (uid) {
              map[uid.toLowerCase()] = { ad, ...detay };
            }
          };

          ekle('MUHSİN ÇELİK', {
            uid: '98a349eb-6cf9-4de3-99f7-345d23287b08',
            hizmetBaslangic: '2009 Temmuz',
            karaaagacBaslangic: '2021 Kasım',
            aileDurumu: 'Evli, 3 çocuğu var (2 erkek - 1 kız)',
            aktifVazifeler: 'Yurt Mesulü',
            kategori: 'Hocaefendi'
          });

          ekle('SERHAN DURAK', {
            uid: '5f727148-7cef-4498-a2ce-351de15301d6',
            hizmetBaslangic: '2011 Temmuz',
            karaaagacBaslangic: '2021 Kasım',
            aileDurumu: 'Evli',
            aktifVazifeler: 'Yardımcı Personel, Harici Hizmetler Mesulü, Yemekhane Mesulü, Kurban - Kermes - Teknik İşler Mesulü',
            kategori: 'Hocaefendi'
          });

          ekle('FARUK NAFİZ ÖZGAN', {
            uid: '99217ccf-182c-4a38-beec-7b75993dcaf6',
            hizmetBaslangic: '2016 Temmuz',
            karaaagacBaslangic: '2019 Eylül (kurs açılışından beri burada, en eski personel)',
            aileDurumu: 'Evli, 1 çocuğu var (1 erkek)',
            aktifVazifeler: 'İç Mesul, Yardımcı Personel, 1. Ders Hocası, İrşadi Hizmetler Mesulü',
            kategori: 'Hocaefendi'
          });

          ekle('İBRAHİM AY', {
            uid: '898eaaad-5fa5-4fd2-894b-2ad759ca74d6',
            hizmetBaslangic: '2007 Temmuz',
            karaaagacBaslangic: '2025 Ağustos',
            aileDurumu: 'Evli, 2 çocuğu var (2 kız)',
            aktifVazifeler: 'Yardımcı Personel, 2. Ders Hocası, Resmi-Teknik İşler Mesulü',
            kategori: 'Hocaefendi'
          });

          ekle('KEREM KOCAOĞLU', {
            uid: '1288af1c-3757-4e36-89e6-f4a72f53a342',
            hizmetBaslangic: '2019 Temmuz',
            karaaagacBaslangic: '2021 Nisan',
            aileDurumu: 'Evli, 1 çocuğu var (1 erkek)',
            aktifVazifeler: 'Yardımcı Personel, Kıraat Ders Hocası, Dernek Muhasebe Mesulü, Teknik İşler Mesulü',
            kategori: 'Hocaefendi'
          });

          ekle('MAHMUT SOLMAZ', {
            uid: '9bac0f85-6df3-41f2-9017-baec13adb145',
            hizmetBaslangic: '2019 Temmuz',
            karaaagacBaslangic: '2023 Eylül',
            aileDurumu: 'Evli, 1 çocuğu var (1 erkek)',
            aktifVazifeler: 'Yardımcı Personel, Nehari Mesulü, Harici Hizmetler Mesulü, Teknik İşler Mesulü',
            kategori: 'Hocaefendi'
          });

          ekle('SAMET ÇAKIR', {
            uid: 'aafd0046-e722-418a-b875-6cb7469ff450',
            hizmetBaslangic: '2022 Temmuz',
            karaaagacBaslangic: '2022 Temmuz',
            aileDurumu: 'Bekar personel',
            aktifVazifeler: 'Muhasebe Mesulü, Sekretarya, Yardımcı Personel',
            kategori: 'Hocaefendi'
          });

          ekle('MEHMET TAHA KESKİN', {
            uid: '74a07b1e-d277-4b81-98b6-96b491084975',
            hizmetBaslangic: '2024 Temmuz',
            karaaagacBaslangic: '2024 Temmuz (direkt Karaağaç\'ta başladı)',
            aileDurumu: 'Bekar personel',
            aktifVazifeler: 'Müzakereci',
            kategori: 'Hocaefendi'
          });

          ekle('AHMETALİ EMRE ŞAHİN', {
            uid: '1319cbea-a35f-4262-9f0e-d4ad37182e7c',
            hizmetBaslangic: '2025 Temmuz',
            karaaagacBaslangic: '2025 Temmuz (direkt Karaağaç\'ta başladı)',
            aileDurumu: 'Bekar personel',
            aktifVazifeler: 'Müzakereci, Eğitim Mesulü',
            kategori: 'Hocaefendi'
          });

          return map;
        })();

        // URL parametrelerinden filtreleri al
        const urlParams = new URLSearchParams(window.location.search);
        const personel = urlParams.get('personel') || '';
        const yillar = [2023, 2024, 2025];

        // Filtre bilgisini göster
        let filtreMetni = 'Filtreler: ';
        const filtreler = [];
        if (personel) filtreler.push(`Personel UID: ${personel}`);
        filtreler.push('Yıllar: 2023, 2024, 2025');
        filtreMetni += filtreler.join(' | ');
        const filtreBilgiEl = $('filtreBilgi');
        if (filtreBilgiEl) {
          filtreBilgiEl.textContent = filtreMetni;
        }

        async function yukleVeriler() {
          try {
            let toplamOdeme, toplamHedefTutar, toplamTeberru, toplamHedef, toplamRamazan, toplamKurban, tumYillar, toplamHedefOrani, toplamNetPerformans;
            const sb = getSupabase();
            if (!sb) {
              console.error('Supabase client hazır değil');
              return;
            }

            let personelUid = personel;
            let personelAdi = '';

            // Personel adını UID ile eşleştir: önce kullanicilar (adsoyad), sonra personel-detay.md haritası, en son personel_odeme_takvim
            if (personelUid) {
              const { data: kullaniciData } = await sb.from('kullanicilar')
                .select('adsoyad')
                .eq('id', personelUid)
                .limit(1)
                .maybeSingle();
              if (kullaniciData?.adsoyad) {
                personelAdi = kullaniciData.adsoyad;
              }
              if (!personelAdi) {
                const uidKey = personelUid.toLowerCase();
                personelAdi = PERSONEL_UID_MAP[personelUid] || PERSONEL_DETAYLARI[uidKey]?.ad;
              }
              if (!personelAdi) {
                const { data: personelData } = await sb.from('personel_odeme_takvim')
                  .select('personel_adi_soyadi')
                  .eq('personel_uid', personelUid)
                  .limit(1)
                  .maybeSingle();
                if (personelData?.personel_adi_soyadi) {
                  personelAdi = personelData.personel_adi_soyadi;
                }
              }
            }

            // 1) Personel kimlik bilgileri (statik harita üzerinden)
            const personelAdiGoster = personelAdi ? basHarfBuyuk(personelAdi) : 'Seçilmemiş';
            const personelDetayKey = normalizeIsim(personelAdi || '');
            const detay = PERSONEL_DETAYLARI[personelDetayKey];

            {
            if (detay) {
              const kimlikHtml = `
                <div>
                  <p><span class="etiket">Personel Adı:</span> ${basHarfBuyuk(detay.ad)}</p>
                  <p><span class="etiket">Hizmete Başlama:</span> ${detay.hizmetBaslangic}</p>
                  <p><span class="etiket">Karaağaç\'ta Başlama:</span> ${detay.karaaagacBaslangic}</p>
                </div>
                <div>
                  <p><span class="etiket">Medeni / Aile Durumu:</span> ${detay.aileDurumu}</p>
                  <p><span class="etiket">Aktif Vazifeler:</span> ${detay.aktifVazifeler}</p>
                  <p><span class="etiket">Kategori:</span> ${detay.kategori || 'Hocaefendi'}</p>
                </div>
              `;
              
              // Kapak sayfasına personel ismini ve kimlik bilgilerini ekle
              const personelIsmiKapakEl = $('personelIsmiKapak');
              if (personelIsmiKapakEl) {
                personelIsmiKapakEl.textContent = basHarfBuyuk(detay.ad);
              }
              
              const personelKimlikKapakIcerikEl = $('personelKimlikKapakIcerik');
              if (personelKimlikKapakIcerikEl) {
                personelKimlikKapakIcerikEl.innerHTML = kimlikHtml;
              }
            } else {
              const personelKimlikKapakIcerikEl = $('personelKimlikKapakIcerik');
              if (personelKimlikKapakIcerikEl) {
                personelKimlikKapakIcerikEl.innerHTML = `
                <p>Seçili personel için detay kaydı bulunamadı. Rapor; ödeme ve veritabanı verileri üzerinden hazırlanacaktır.</p>
                <p><span class="etiket">Personel UID:</span> ${personelUid || '-'}</p>
              `;
              const personelIsmiKapakEl = $('personelIsmiKapak');
              if (personelIsmiKapakEl) {
                personelIsmiKapakEl.textContent = personelAdiGoster;
              }
            }
            }

            // 2) 2023-2025 yılları için verileri yükle
            const yilBazli = {};

            for (const yil of yillar) {
              const yilInt = parseInt(yil, 10);

              // Ödeme verileri (tüm kayıtlar – limit yok, filtreye göre)
              let odemeQuery = sb.from('personel_odeme_takvim').select('*').eq('yil', yilInt).range(0, 9999);
              if (personelUid) odemeQuery = odemeQuery.eq('personel_uid', personelUid);
              const { data: odemeData, error: odemeError } = await odemeQuery;
              if (odemeError) throw odemeError;

              // Teberru verileri (yıl aralığında tüm kayıtlar)
              let teberruQuery = sb.from('gecmis_teberru_kayitlari').select('*')
                .gte('vade_tarihi', `${yilInt}-01-01`)
                .lt('vade_tarihi', `${yilInt + 1}-01-01`)
                .range(0, 9999);
              const { data: teberruAllData, error: teberruError } = await teberruQuery;
              if (teberruError) throw teberruError;

              let teberruData = teberruAllData || [];
              if (personelAdi) {
                const normalizedPersonelAdi = normalizeIsim(personelAdi);
                teberruData = teberruData.filter(v => {
                  const normalizedReferans = normalizeIsim(v.referans || '');
                  return normalizedReferans === normalizedPersonelAdi;
                });
              }

              // Ramazan-ı Şerif verileri (kategori + tip birleştirilmiş, tüm kayıtlar)
              let ramazanKategoriQuery = sb.from('arsiv_hedefler').select('*')
                .eq('kategori', 'Ramazan-ı Şerif')
                .eq('yil', yilInt)
                .range(0, 9999);
              if (personelUid) ramazanKategoriQuery = ramazanKategoriQuery.eq('uid', personelUid);
              const { data: ramazanKategoriData } = await ramazanKategoriQuery;

              let ramazanTipQuery = sb.from('arsiv_hedefler').select('*')
                .eq('tip', 'Ramazan-ı Şerif')
                .eq('yil', yilInt)
                .range(0, 9999);
              if (personelUid) ramazanTipQuery = ramazanTipQuery.eq('uid', personelUid);
              const { data: ramazanTipData } = await ramazanTipQuery;

              const ramazanKategori = ramazanKategoriData || [];
              const ramazanTip = ramazanTipData || [];
              const ramazanData = [...new Map([...ramazanKategori, ...ramazanTip].map(v => [v.id, v])).values()];

              // Kurban çalışmaları (kategori "Kurban", tüm kayıtlar)
              let kurbanQuery = sb.from('arsiv_hedefler').select('*')
                .eq('kategori', 'Kurban')
                .eq('yil', yilInt)
                .range(0, 9999);
              if (personelUid) kurbanQuery = kurbanQuery.eq('uid', personelUid);
              const { data: kurbanData } = await kurbanQuery;

              // Hedef verileri (tüm kayıtlar)
              let hedefQuery = sb.from('arsiv_hedefler').select('*').eq('yil', yilInt).range(0, 9999);
              if (personelUid) hedefQuery = hedefQuery.eq('uid', personelUid);
              const { data: hedefData, error: hedefError } = await hedefQuery;
              if (hedefError) throw hedefError;

              const odemeToplam = (odemeData || []).reduce((sum, v) => sum + parseFloat(v.tutar || 0), 0);
              const teberruToplam = (teberruData || []).reduce((sum, v) => sum + parseFloat(v.tutar || 0), 0);
              const hedefToplam = (hedefData || []).reduce((sum, v) => sum + parseFloat(v.hedef || 0), 0);
              const hedefTutarToplam = (hedefData || []).reduce((sum, v) => sum + parseFloat(v.tutar || 0), 0);
              const ramazanToplam = (ramazanData || []).reduce((sum, v) => sum + parseFloat(v.tutar || 0), 0);
              const ramazanHedefToplam = (ramazanData || []).reduce((sum, v) => sum + parseFloat(v.hedef || 0), 0);
              const kurbanToplam = (kurbanData || []).reduce((sum, v) => sum + parseFloat(v.tutar || 0), 0);

              const hedefUlasmaOrani = hedefToplam > 0 ? (hedefTutarToplam / hedefToplam) * 100 : 0;
              // Net Performans = Hedef Tutar - Ödeme (personel-detay.md'deki formüle göre)
              const netPerformans = hedefTutarToplam - odemeToplam;

              yilBazli[yil] = {
                yil,
                odemeData: odemeData || [],
                teberruData,
                hedefData: hedefData || [],
                ramazanData,
                kurbanData: kurbanData || [],
                odemeToplam,
                teberruToplam,
                hedefToplam,
                hedefTutarToplam,
                ramazanToplam,
                ramazanHedefToplam,
                kurbanToplam,
                hedefUlasmaOrani,
                netPerformans
              };
            }

            // 3) Genel KPIs (2023-2025 toplamları)
            tumYillar = Object.values(yilBazli);
            toplamOdeme = tumYillar.reduce((s, y) => s + y.odemeToplam, 0);
            toplamTeberru = tumYillar.reduce((s, y) => s + y.teberruToplam, 0);
            toplamHedef = tumYillar.reduce((s, y) => s + y.hedefToplam, 0);
            toplamHedefTutar = tumYillar.reduce((s, y) => s + y.hedefTutarToplam, 0);
            toplamRamazan = tumYillar.reduce((s, y) => s + y.ramazanToplam, 0);
            const toplamRamazanHedef = tumYillar.reduce((s, y) => s + (y.ramazanHedefToplam || 0), 0);
            const ramazanUlasmaOrani = toplamRamazanHedef > 0 ? (toplamRamazan / toplamRamazanHedef * 100) : 0;
            toplamKurban = tumYillar.reduce((s, y) => s + y.kurbanToplam, 0);

            toplamHedefOrani = toplamHedef > 0 ? (toplamHedefTutar / toplamHedef) * 100 : 0;
            // Net Performans = TOPLAM HEDEF TUTAR - TOPLAM ÖDEME (personel-detay.md'deki formüle göre)
            toplamNetPerformans = toplamHedefTutar - toplamOdeme;

            // Genel Bakış Tablosu
            const genelBakışTablosuBody = $('genelBakışTablosuBody');
            if (genelBakışTablosuBody) {
              genelBakışTablosuBody.innerHTML = `
                <tr>
                  <td>3 Yıllık Toplam Ödeme</td>
                  <td class="sayi">${fmt(toplamOdeme)}</td>
                </tr>
                <tr>
                  <td>3 Yıllık Toplam Teberru</td>
                  <td class="sayi">${fmt(toplamTeberru)}</td>
                </tr>
                <tr>
                  <td>3 Yıllık Toplam Ramazan-ı Şerif</td>
                  <td class="sayi">${fmt(toplamRamazan)}</td>
                </tr>
                <tr>
                  <td>3 Yıllık Toplam Hedef Tutar</td>
                  <td class="sayi">${fmt(toplamHedefTutar)}</td>
                </tr>
                <tr>
                  <td>3 Yıllık Toplam Hedef</td>
                  <td class="sayi">${fmt(toplamHedef)}</td>
                </tr>
                <tr>
                  <td>3 Yıllık Toplam Hedefe Ulaşma Oranı</td>
                  <td class="sayi">${toplamHedefOrani.toFixed(1)}%</td>
                </tr>
                <tr>
                  <td><strong>Net Performans (Toplam Hedef Tutar - Toplam Ödeme)</strong></td>
                  <td class="sayi ${toplamNetPerformans >= 0 ? 'artis-pozitif' : 'artis-negatif'}"><strong>${fmt(toplamNetPerformans)}</strong></td>
                </tr>
              `;
            }

            // Yıllık Performans Özeti Tablosu
            const yillikPerformansTablosuBody = $('yillikPerformansTablosuBody');
            if (yillikPerformansTablosuBody) {
              let tabloHtml = tumYillar.map(y => {
                const yilNetPerformans = y.hedefTutarToplam - y.odemeToplam;
                return `
                  <tr>
                    <td><strong>${y.yil}</strong></td>
                    <td class="sayi">${fmt(y.odemeToplam)}</td>
                    <td class="sayi">${fmt(y.teberruToplam)}</td>
                    <td class="sayi">${fmt(y.ramazanToplam)}</td>
                    <td class="sayi">${fmt(y.hedefTutarToplam)}</td>
                    <td class="sayi">${fmt(y.hedefToplam)}</td>
                    <td class="sayi">${y.hedefUlasmaOrani.toFixed(1)}%</td>
                    <td class="sayi ${yilNetPerformans >= 0 ? 'artis-pozitif' : 'artis-negatif'}">${fmt(yilNetPerformans)}</td>
                  </tr>
                `;
              }).join('');
              
              // Genel toplam satırı ekle
              const genelHedefOrani = toplamHedef > 0 ? (toplamHedefTutar / toplamHedef) * 100 : 0;
              tabloHtml += `
                <tr style="background-color: #f0f0f0; font-weight: 600;">
                  <td><strong>2023-2025 TOPLAM</strong></td>
                  <td class="sayi"><strong>${fmt(toplamOdeme)}</strong></td>
                  <td class="sayi"><strong>${fmt(toplamTeberru)}</strong></td>
                  <td class="sayi"><strong>${fmt(toplamRamazan)}</strong></td>
                  <td class="sayi"><strong>${fmt(toplamHedefTutar)}</strong></td>
                  <td class="sayi"><strong>${fmt(toplamHedef)}</strong></td>
                  <td class="sayi"><strong>${genelHedefOrani.toFixed(1)}%</strong></td>
                  <td class="sayi ${toplamNetPerformans >= 0 ? 'artis-pozitif' : 'artis-negatif'}"><strong>${fmt(toplamNetPerformans)}</strong></td>
                </tr>
              `;
              
              yillikPerformansTablosuBody.innerHTML = tabloHtml;
            }

            // 5) Ödemeler ve genel analiz
            const ortalamaYillikOdeme = tumYillar.length > 0 ? toplamOdeme / tumYillar.length : 0;

            // Yıllara Göre Hedef Detay Tablosu: Yıl | Sıralama | Kategori | Hedef | Tutar | Hedefe Ulaşma
            const yillaraGoreHedefTablosuEl = $('yillaraGoreHedefTablosu');
            if (yillaraGoreHedefTablosuEl) {
              let tabloHtml = '<table class="tablo tablo--mor tablo--hedef-detay"><colgroup><col><col><col><col><col><col></colgroup><thead><tr><th>Yıl</th><th>Sıralama</th><th>Kategori</th><th class="sayi">Hedef</th><th class="sayi">Tutar</th><th class="sayi">Hedefe Ulaşma</th></tr></thead><tbody>';
              tumYillar.forEach(y => {
                const rows = (y.hedefData || []);
                rows.forEach((v, idx) => {
                  const hedefVal = parseFloat(v.hedef || 0);
                  const tutarVal = parseFloat(v.tutar || 0);
                  const oran = hedefVal > 0 ? (tutarVal / hedefVal * 100) : 0;
                  const kategoriLabel = (v.kategori || v.tip || '-').trim() || '-';
                  tabloHtml += `<tr><td>${y.yil}</td><td>${idx + 1}</td><td>${kategoriLabel}</td><td class="sayi">${fmt(hedefVal)}</td><td class="sayi">${fmt(tutarVal)}</td><td class="sayi">${oran.toFixed(1)}%</td></tr>`;
                });
                // Yıl toplamı değerlendirmesi satırı
                tabloHtml += `<tr style="background-color: #e8e8e8; font-weight: 600;"><td>${y.yil}</td><td colspan="2">Yıl Toplamı Değerlendirmesi</td><td class="sayi">${fmt(y.hedefToplam)}</td><td class="sayi">${fmt(y.hedefTutarToplam)}</td><td class="sayi">${y.hedefUlasmaOrani.toFixed(1)}%</td></tr>`;
              });
              tabloHtml += '</tbody></table>';
              yillaraGoreHedefTablosuEl.innerHTML = tabloHtml;
            }

            // 3 Yılın Değerlendirmesi
            const ucYilDegerlendirmesiEl = $('ucYilDegerlendirmesi');
            if (ucYilDegerlendirmesiEl) {
              const genelOran = toplamHedef > 0 ? (toplamHedefTutar / toplamHedef * 100) : 0;
              ucYilDegerlendirmesiEl.innerHTML = `
                <div class="yil-kutu" style="max-width: 100%;">
                  <h4>3 Yılın Değerlendirmesi (2023–2025)</h4>
                  <p style="margin: 8px 0 0 0; font-size: 12px;">
                    Toplam Hedef: <strong>${fmt(toplamHedef)}</strong> · Toplam Tutar: <strong>${fmt(toplamHedefTutar)}</strong> · Hedefe Ulaşma: <strong>${genelOran.toFixed(1)}%</strong><br>
                    Net Performans (Toplam Hedef Tutar − Toplam Ödeme): <strong class="${toplamNetPerformans >= 0 ? 'artis-pozitif' : 'artis-negatif'}">${fmt(toplamNetPerformans)}</strong>
                  </p>
                </div>
              `;
            }

            // Ödeme Tiplerinin Artışları (2023-2024, 2024-2025)
            const odemeTipArtislariEl = $('odemeTipArtislari');
            if (odemeTipArtislariEl && tumYillar.length >= 2) {
              // Ödeme tiplerini analiz etmek için ödeme verilerini grupla
              const odemeTipleri = {};
              tumYillar.forEach(y => {
                (y.odemeData || []).forEach(od => {
                  const tip = od.tip || od.odeme_tipi || 'Diğer';
                  if (!odemeTipleri[tip]) {
                    odemeTipleri[tip] = {};
                  }
                  if (!odemeTipleri[tip][y.yil]) {
                    odemeTipleri[tip][y.yil] = 0;
                  }
                  odemeTipleri[tip][y.yil] += parseFloat(od.tutar || 0);
                });
              });

              let tipArtisHtml = '<table class="tablo tablo--kahve"><thead><tr><th>Ödeme Tipi</th><th class="sayi">2023</th><th class="sayi">2024</th><th class="sayi">2025</th><th class="sayi">2023-2024 Artış</th><th class="sayi">2024-2025 Artış</th></tr></thead><tbody>';
              Object.keys(odemeTipleri).forEach(tip => {
                const v2023 = odemeTipleri[tip][2023] || 0;
                const v2024 = odemeTipleri[tip][2024] || 0;
                const v2025 = odemeTipleri[tip][2025] || 0;
                const artis23_24 = v2023 > 0 ? ((v2024 - v2023) / v2023 * 100) : 0;
                const artis24_25 = v2024 > 0 ? ((v2025 - v2024) / v2024 * 100) : 0;
                tipArtisHtml += `
                  <tr>
                    <td>${tip}</td>
                    <td class="sayi">${fmt(v2023)}</td>
                    <td class="sayi">${fmt(v2024)}</td>
                    <td class="sayi">${fmt(v2025)}</td>
                    <td class="sayi ${artis23_24 >= 0 ? 'artis-pozitif' : 'artis-negatif'}">${artis23_24.toFixed(1)}% (${fmt(v2024 - v2023)})</td>
                    <td class="sayi ${artis24_25 >= 0 ? 'artis-pozitif' : 'artis-negatif'}">${artis24_25.toFixed(1)}% (${fmt(v2025 - v2024)})</td>
                  </tr>
                `;
              });
              tipArtisHtml += '</tbody></table>';
              odemeTipArtislariEl.innerHTML = tipArtisHtml;
            }

            // 6) Yorumlar (basit kural tabanlı değerlendirme)
            const yorumlar = [];
            if (toplamHedefOrani >= 110) {
              yorumlar.push('<span class="yorum-etiket">Hedeflerin Üzerinde Performans:</span> 3 yıllık periyotta hedeflerin belirgin şekilde üzerinde bir gerçekleşme sağlanmıştır. Bu; sahada güçlü bir takip, teberru ve kampanya çalışmalarında aktif bir performansa işaret etmektedir.');
            } else if (toplamHedefOrani >= 90) {
              yorumlar.push('<span class="yorum-etiket">Hedeflere Yakın Gerçekleşme:</span> Hedeflerin büyük oranda yakalandığı, yer yer küçük sapmaların olduğu dengeli bir performans görülmektedir. Hedef planlaması ile saha uyumu genel olarak başarılıdır.');
            } else if (toplamHedefOrani > 0) {
              yorumlar.push('<span class="yorum-etiket">Hedeflerin Altında Performans:</span> Toplam hedef gerçekleşme oranı beklenen seviyenin altında kalmıştır. Hedef belirleme süreci, saha planlaması ve bireysel takip mekanizmalarının gözden geçirilmesi faydalı olacaktır.');
            } else {
              yorumlar.push('<span class="yorum-etiket">Hedef Verisi Eksik:</span> İlgili personel için hedef verileri yeterli düzeyde olmadığı için net bir oran hesaplanamamıştır. Hedef kayıtlarının düzenli ve eksiksiz tutulması, sonraki dönem analizleri için kritik önem taşımaktadır.');
            }

            if (toplamNetPerformans >= 0) {
              yorumlar.push('<span class="yorum-etiket">Net Katkı Pozitif:</span> 3 yıllık dönemde, personele yapılan ödemeler dikkate alındığında dahi üretmiş olduğu kaynak toplamda pozitif bir katkıya işaret etmektedir.');
            } else {
              yorumlar.push('<span class="yorum-etiket">Net Katkı Negatif:</span> Teberru ve kampanya gelirleri, yapılan personel ödemelerini tam olarak karşılayamamıştır. Orta vadede; hedef planlaması, iş bölümü ve vazife dağılımlarının güçlendirilmesiyle net katkının pozitif tarafa taşınması önerilir.');
            }

            // Ramazan yorumu: hedefe ulaşma / hedefi geçme / hedef altında / veri zayıf
            if (toplamRamazanHedef <= 0 && toplamRamazan <= 0) {
              yorumlar.push('<span class="yorum-etiket">Ramazan Verisi Zayıf:</span> İlgili personel için Ramazan-ı Şerif hedef veya tutar verisi yok veya yetersizdir. Hedef kayıtlarının tutulması ve bu alandaki fırsatların sistematik hedeflenmesi önerilir.');
            } else if (toplamRamazanHedef > 0 && ramazanUlasmaOrani >= 110) {
              yorumlar.push('<span class="yorum-etiket">Ramazan Hedefi Geçildi:</span> Ramazan-ı Şerif çalışmalarında hedef belirgin şekilde aşılmıştır. Teberru ve bağ kurma açısından güçlü performans; mevcut düzeyin korunması ve istikrarın sürdürülmesi önemlidir.');
            } else if (toplamRamazanHedef > 0 && ramazanUlasmaOrani >= 100) {
              yorumlar.push('<span class="yorum-etiket">Ramazan Hedefine Ulaşıldı:</span> Ramazan döneminde hedefe ulaşılmış, dengeli bir gerçekleşme görülmektedir. Hedef planlaması ile saha uyumu başarılıdır.');
            } else if (toplamRamazanHedef > 0 && ramazanUlasmaOrani > 0) {
              yorumlar.push('<span class="yorum-etiket">Ramazan Hedef Altında:</span> Ramazan-ı Şerif çalışmalarında gerçekleşme hedefin altında kalmıştır. Bu alandaki hedefleme ve takibin güçlendirilmesi önerilir.');
            } else {
              yorumlar.push('<span class="yorum-etiket">Ramazan Hedefi Tanımsız:</span> Ramazan tutar kayıtları mevcut ancak hedef tanımlanmadığı için oran hesaplanamadı. Hedef kayıtlarının düzenli tutulması önerilir.');
            }

            // Kurban verisi notu
            yorumlar.push('<span class="yorum-etiket">Kurban Verisi:</span> Kurban verisi: rapora daha sonra eklenecektir.');

            const yorumListEl = $('yorumListesi');
            if (yorumListEl) {
              yorumListEl.innerHTML = yorumlar.map(y => `<li>${y}</li>`).join('');
            }

            // 7) 2026 projeksiyonu (personel-detay.md'deki planlanan giderler ve Ramazan hedefleri)
            const projeksiyonDetayKey = normalizeIsim(personelAdi || '');
            const planlanan2026Gider = PLANLANAN_2026_GIDERLER[projeksiyonDetayKey] || ortalamaYillikOdeme;
            const ramazan2026Hedefi = RAMAZAN_2026_HEDEFLERI[projeksiyonDetayKey] || 0;

            // 2025 giderini hesapla
            const yil2025 = tumYillar.find(y => y.yil === 2025);
            const gider2025 = yil2025 ? yil2025.odemeToplam : 0;
            
            // 2025'den 2026'ya artış hesapla
            const artisTutar = planlanan2026Gider - gider2025;
            const artisYuzde = gider2025 > 0 ? ((artisTutar / gider2025) * 100) : 0;

            const projeksiyonMetniEl = $('projeksiyonMetni');
            if (projeksiyonMetniEl) {
              projeksiyonMetniEl.innerHTML = `
                <p>
                  2026 yılı için planlanan personel gideri toplamı <strong>${fmt(planlanan2026Gider)}</strong> olarak
                  belirlenmiştir. Bu tutar; hediye, ikramiye, çocuk ödemesi, elbise, kira, yakacak ve diğer yardımların
                  toplamından oluşmaktadır.
                </p>
                <table class="tablo" style="margin-top: 15px;">
                  <thead>
                    <tr><th>Metrik</th><th class="sayi">Tutar</th></tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>2023-2025 Toplam Gider</td>
                      <td class="sayi">${fmt(toplamOdeme)}</td>
                    </tr>
                    <tr>
                      <td>2025 Gider</td>
                      <td class="sayi">${fmt(gider2025)}</td>
                    </tr>
                    <tr>
                      <td>Planlanan 2026 Gideri</td>
                      <td class="sayi"><strong>${fmt(planlanan2026Gider)}</strong></td>
                    </tr>
                    <tr>
                      <td><strong>2025'den 2026'ya Artış</strong></td>
                      <td class="sayi ${artisTutar >= 0 ? 'artis-pozitif' : 'artis-negatif'}">
                        <strong>${artisYuzde >= 0 ? '+' : ''}${artisYuzde.toFixed(2)}% (${artisTutar >= 0 ? '+' : ''}${fmt(artisTutar)})</strong>
                      </td>
                    </tr>
                  </tbody>
                </table>
              `;
            }

            // 2026 Ödeme Toplamı vs Ramazan-ı Şerif Hedefi Karşılaştırması
            const ramazanKarsilastirmaEl = $('ramazanKarsilastirma');
            if (ramazanKarsilastirmaEl) {
              const fark = ramazan2026Hedefi - planlanan2026Gider;
              const durum = fark >= 0 ? 'Pozitif (Ramazan hedefi gideri karşılıyor veya üzerinde)' : 'Negatif (Ramazan hedefi gideri karşılamıyor)';
              ramazanKarsilastirmaEl.innerHTML = `
                <table class="tablo">
                  <thead>
                    <tr><th>Metrik</th><th class="sayi">Tutar</th></tr>
                  </thead>
                  <tbody>
                    <tr>
                      <td>2026 Planlanan Ödeme Toplamı</td>
                      <td class="sayi">${fmt(planlanan2026Gider)}</td>
                    </tr>
                    <tr>
                      <td>2026 Ramazan-ı Şerif Hedefi</td>
                      <td class="sayi">${fmt(ramazan2026Hedefi)}</td>
                    </tr>
                    <tr>
                      <td><strong>Fark (Ramazan Hedefi - Ödeme Toplamı)</strong></td>
                      <td class="sayi ${fark >= 0 ? 'artis-pozitif' : 'artis-negatif'}"><strong>${fmt(fark)}</strong></td>
                    </tr>
                    <tr>
                      <td><strong>Durum</strong></td>
                      <td class="sayi ${fark >= 0 ? 'artis-pozitif' : 'artis-negatif'}"><strong>${durum}</strong></td>
                    </tr>
                  </tbody>
                </table>
                <p style="margin-top: 10px; font-size: 11px; color: #000;">
                  <em>Not: Ramazan-ı Şerif hedefi, planlanan gideri karşılamalı veya üzerinde olmalıdır.</em>
                </p>
              `;
            }

            // Toplam Bütçeye Göre Tipe Göre Yüzdelik Pay
            // Bu personelin her tip giderinin, toplam bütçe planlamasındaki o tipin toplamına göre payı
            const butcePayAnaliziEl = $('butcePayAnalizi');
            if (butcePayAnaliziEl) {
              // personel-detay.md'deki 2026 bütçe planlaması (toplam tüm personeller için)
              const toplamButceTipleri = {
                'Hediye': 4247398,
                'İkramiye': 531936,
                'Çocuk': 144432,
                'Elbise': 99792,
                'Kira': 1295160,
                'Yakacak Yardımı': 141120,
                'Yol Yardımı': 33120,
                'Sigorta': 978277
              };

              // Bu personelin tip bazında giderleri
              const personelGiderleri = PLANLANAN_2026_GIDERLER_TIP[projeksiyonDetayKey] || null;

              if (personelGiderleri) {
                let butceHtml = '<table class="tablo tablo--mor"><thead><tr><th>Ödeme Tipi</th><th class="sayi">Bu Personelin Gideri</th><th class="sayi">Toplam Bütçe (Tüm Personeller)</th><th class="sayi">Bütçedeki Pay (%)</th></tr></thead><tbody>';
                
                const tipler = [
                  { key: 'hediye', label: 'Hediye', butceKey: 'Hediye' },
                  { key: 'ikramiye', label: 'İkramiye', butceKey: 'İkramiye' },
                  { key: 'cocuk', label: 'Çocuk', butceKey: 'Çocuk' },
                  { key: 'elbise', label: 'Elbise', butceKey: 'Elbise' },
                  { key: 'kira', label: 'Kira', butceKey: 'Kira' },
                  { key: 'yakacak', label: 'Yakacak Yardımı', butceKey: 'Yakacak Yardımı' },
                  { key: 'yol', label: 'Yol Yardımı', butceKey: 'Yol Yardımı' },
                  { key: 'sigorta', label: 'Sigorta', butceKey: 'Sigorta' }
                ];

                tipler.forEach(tip => {
                  const personelTutari = personelGiderleri[tip.key] || 0;
                  const toplamButceTutari = toplamButceTipleri[tip.butceKey] || 0;
                  const yuzde = toplamButceTutari > 0 ? (personelTutari / toplamButceTutari * 100) : 0;
                  
                  if (personelTutari > 0 || toplamButceTutari > 0) {
                    butceHtml += `
                      <tr>
                        <td>${tip.label}</td>
                        <td class="sayi">${fmt(personelTutari)}</td>
                        <td class="sayi">${fmt(toplamButceTutari)}</td>
                        <td class="sayi ${yuzde > 0 ? 'artis-pozitif' : ''}">${yuzde.toFixed(2)}%</td>
                      </tr>
                    `;
                  }
                });

                const personelToplam = personelGiderleri.toplam || 0;
                const toplamButceToplam = Object.values(toplamButceTipleri).reduce((s, v) => s + v, 0);
                const toplamYuzde = toplamButceToplam > 0 ? (personelToplam / toplamButceToplam * 100) : 0;
                
                butceHtml += `<tr style="background-color: #f0f0f0;"><td><strong>TOPLAM</strong></td><td class="sayi"><strong>${fmt(personelToplam)}</strong></td><td class="sayi"><strong>${fmt(toplamButceToplam)}</strong></td><td class="sayi"><strong>${toplamYuzde.toFixed(2)}%</strong></td></tr>`;
                butceHtml += '</tbody></table>';
                butcePayAnaliziEl.innerHTML = butceHtml;
              } else {
                butcePayAnaliziEl.innerHTML = '<p>Bu personel için 2026 planlanan gider detayları bulunamadı.</p>';
              }
            }

            // 2026 Yılı Analiz Yorumları (planlanan ödeme, Ramazan hedefi, pozitif/negatif karşılama)
            const yil2026AnalizYorumlariEl = $('yil2026AnalizYorumlari');
            if (yil2026AnalizYorumlariEl) {
              const fark = ramazan2026Hedefi - planlanan2026Gider;
              const pozitif = fark >= 0;
              const tahsilatCumle = 'Hedefinizin %60 oranında tahsilatı Ramazan-ı Şerif sonuna kadar tamamlanması, %40\'ı ise sene içerisinde tamamlanması beklenmektedir.';
              const yorumPozitif = 'Pozitif karşılama. 1 senelik giderinizi Ramazan-ı Şerif içerisinde karşılıyorsunuz. Hedefe ulaşmak için yapmış olduğunuz çalışmalar (iftar-sahur vb.) önemlidir.';
              const yorumNegatif = 'Negatif karşılama. 1 senelik giderinizi Ramazan-ı Şerif içerisinde karşılayamıyorsunuz. Yıl içerisindeki diğer çalışmalara ağırlık verilmesi gerekmektedir.';
              yil2026AnalizYorumlariEl.innerHTML = `
                <div class="yil-kutu" style="max-width: 100%;">
                  <p style="margin: 0 0 10px 0; font-size: 12px; line-height: 1.6;">
                    Sizler için 2026 yılı 1 senelik ödeme tutarı <strong>${fmt(planlanan2026Gider)}</strong> olarak öngörülmektedir (öngörü %98 oranında doğrudur).
                  </p>
                  <p style="margin: 0 0 10px 0; font-size: 12px; line-height: 1.6;">
                    Ramazan-ı Şerif hedefiniz <strong>${fmt(ramazan2026Hedefi)}</strong>'dir.
                  </p>
                  <p style="margin: 0 0 8px 0; font-size: 12px; line-height: 1.6;">
                    ${pozitif ? '<strong style="color: #006400;">' + yorumPozitif + '</strong>' : '<strong style="color: #8b0000;">' + yorumNegatif + '</strong>'}
                  </p>
                  <p style="margin: 0; font-size: 12px; line-height: 1.6; color: #444;">
                    ${tahsilatCumle}
                  </p>
                </div>
              `;
            }

            // Kira Artışı ile Alakalı Analiz
            const kiraAnaliziEl = $('kiraAnalizi');
            if (kiraAnaliziEl) {
              // Kira ödemelerini yıllara göre analiz et
              const kiraYillik = {};
              tumYillar.forEach(y => {
                const kiraToplam = (y.odemeData || []).filter(od => {
                  const tip = (od.tip || od.odeme_tipi || '').toLowerCase();
                  return tip.includes('kira') || tip.includes('kira');
                }).reduce((sum, od) => sum + parseFloat(od.tutar || 0), 0);
                kiraYillik[y.yil] = kiraToplam;
              });

              const k2023 = kiraYillik[2023] || 0;
              const k2024 = kiraYillik[2024] || 0;
              const k2025 = kiraYillik[2025] || 0;
              const artis23_24 = k2023 > 0 ? ((k2024 - k2023) / k2023 * 100) : 0;
              const artis24_25 = k2024 > 0 ? ((k2025 - k2024) / k2024 * 100) : 0;

              // 2026 planlanan kira (personel-detay.md'den)
              const personelGiderleri = PLANLANAN_2026_GIDERLER_TIP[projeksiyonDetayKey];
              const kira2026Planlanan = personelGiderleri ? personelGiderleri.kira : 0;
              const artis25_26 = k2025 > 0 ? ((kira2026Planlanan - k2025) / k2025 * 100) : 0;

              // Yeni güncel aylık kira ve artış ayı (personel-detay.md'den – /12 değil, md'de yazan aylık tutar ve hangi ay başlıyor)
              const kiraDetay = KIRA_2026_AYLIK_DETAY[projeksiyonDetayKey];
              const kiraAylikGuncel = kiraDetay ? kiraDetay.aylik : (kira2026Planlanan > 0 ? Math.round(kira2026Planlanan / 12) : 0);
              const kiraArtisAyi = kiraDetay && kiraDetay.artisAyi ? kiraDetay.artisAyi : (personelGiderleri && personelGiderleri.kira > 0 ? 'Temmuz-Ağustos' : '-');

              // Maksimum kira artışı (bütçe planlamasına göre)
              const toplamButceKira = 1295160; // personel-detay.md'den
              const personelKiraPayi = toplamButceKira > 0 ? (kira2026Planlanan / toplamButceKira * 100) : 0;
              const maksimumKiraArtisi = kira2026Planlanan;

              kiraAnaliziEl.innerHTML = `
                <table class="tablo tablo--kira">
                  <thead>
                    <tr><th>Yıl</th><th class="sayi">Toplam Kira Ödemesi</th><th class="sayi">Yıllık Artış</th></tr>
                  </thead>
                  <tbody>
                    <tr><td>2023</td><td class="sayi">${fmt(k2023)}</td><td class="sayi">-</td></tr>
                    <tr><td>2024</td><td class="sayi">${fmt(k2024)}</td><td class="sayi ${artis23_24 >= 0 ? 'artis-pozitif' : 'artis-negatif'}">${artis23_24 >= 0 ? '+' : ''}${artis23_24.toFixed(1)}% (${artis23_24 >= 0 ? '+' : ''}${fmt(k2024 - k2023)})</td></tr>
                    <tr><td>2025</td><td class="sayi">${fmt(k2025)}</td><td class="sayi ${artis24_25 >= 0 ? 'artis-pozitif' : 'artis-negatif'}">${artis24_25 >= 0 ? '+' : ''}${artis24_25.toFixed(1)}% (${artis24_25 >= 0 ? '+' : ''}${fmt(k2025 - k2024)})</td></tr>
                    <tr style="background-color: #f0f0f0;">
                      <td><strong>2026 Tahmini-Planlanan</strong></td>
                      <td class="sayi"><strong>${fmt(kira2026Planlanan)}</strong></td>
                      <td class="sayi ${artis25_26 >= 0 ? 'artis-pozitif' : 'artis-negatif'}"><strong>${artis25_26 >= 0 ? '+' : ''}${artis25_26.toFixed(1)}% (${artis25_26 >= 0 ? '+' : ''}${fmt(kira2026Planlanan - k2025)})</strong></td>
                    </tr>
                  </tbody>
                </table>
                <p style="margin-top: 12px; font-size: 13px; font-weight: 600; color: #2f4f30;">
                  2026 Planlanan Toplam Kira: <strong>${fmt(kira2026Planlanan)}</strong> &nbsp;|&nbsp; Tahmini/Planlanan Aylık Kira: <strong>${kiraAylikGuncel > 0 ? fmt(kiraAylikGuncel) : '-'}</strong>${kiraArtisAyi !== '-' ? ' (Artış ' + kiraArtisAyi + ' ayından itibaren)' : ''}
                </p>
                <p style="margin-top: 15px; font-size: 12px; line-height: 1.7;">
                  <strong>2026 Yılı Kira Artışı Planlaması (Kurum Bütçe / Proje Planlaması):</strong><br>
                  Bu kısım, kurum bütçe planlaması ile ilgili bir proje planlamasıdır. Gösterilen tutarlar, kira artışına dair kurumca görülen <strong>maksimum tahmini bütçe</strong> çerçevesindedir.
                  ${kiraArtisAyi !== '-' ? '2026 yılında kira artışının <strong>' + kiraArtisAyi + '</strong> ayından itibaren geçerli olması öngörülmektedir. ' : ''}
                  Kurum 2026 bütçe planlamasına göre sizin için kira kaleminde öngörülen <strong>yıllık toplam tahmini bütçe</strong> <strong>${fmt(maksimumKiraArtisi)}</strong> olup, bu tutar tüm personel için ayrılan toplam kira bütçesinin yaklaşık <strong>%${personelKiraPayi.toFixed(2)}</strong> payına karşılık gelmektedir.
                </p>
                <div style="margin-top: 14px; padding: 12px 14px; background: #f8e8e0; border-left: 4px solid #8b2500; font-size: 12px; line-height: 1.6; color: #2c2c2c;">
                  <strong style="color: #8b2500;">Önemli:</strong> Kira artışları personel giderlerinin en büyük kalemlerinden biridir. Planlanan tutarın aşılmaması için aylık kira takibi ve bütçe kontrolünün düzenli yapılması önemle tavsiye edilir.
                </div>
              `;
            }

            }

          } catch (e) {
            console.error('Veriler yüklenemedi:', e);
            const hataMesaji = '<p style="color: #000;">Hata: ' + (e.message || String(e)) + '</p>';
            
            // Sadece var olan elementlere eriş
            const genelBakışEl = $('genelBakışTablosuBody');
            if (genelBakışEl) genelBakışEl.innerHTML = '<tr><td colspan="2">' + hataMesaji + '</td></tr>';
            
            const yillikPerfEl = $('yillikPerformansTablosuBody');
            if (yillikPerfEl) yillikPerfEl.innerHTML = '<tr><td colspan="8">' + hataMesaji + '</td></tr>';
            
            const odemeAnalizEl = $('odemeYillikAnaliz');
            if (odemeAnalizEl) odemeAnalizEl.innerHTML = hataMesaji;
            
            const yorumListEl = $('yorumListesi');
            if (yorumListEl) yorumListEl.innerHTML = '<li>Veriler yüklenirken bir hata oluştu. Lütfen daha sonra tekrar deneyiniz.</li>';
            
            const projeksiyonEl = $('projeksiyonMetni');
            if (projeksiyonEl) projeksiyonEl.innerHTML = 'Hesaplama yapılamadı.';
          }
        }

        yukleVeriler();
      });
    });

    function pdfCiktisiAl() {
      const element = document.getElementById("pdfAlani");
      if (!element) {
        alert("PDF alanı bulunamadı!");
        return;
      }

      const opt = {
        margin: [0.5, 0.5, 0.5, 0.5],
        filename: 'personel-performans-raporu.pdf',
        image: { type: 'png', quality: 0.98 },
        html2canvas: {
          scale: 2,
          useCORS: true,
          allowTaint: true,
          scrollX: 0,
          scrollY: 0,
          windowWidth: 800
        },
        jsPDF: {
          unit: 'in',
          format: 'a4',
          orientation: 'portrait'
        }
      };

      html2pdf().set(opt).from(element).save();
    }
  </script>
</body>
</html>
