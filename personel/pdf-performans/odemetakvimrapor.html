<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Ã–deme Takvim Raporu</title>
  <style>
    body { 
      margin: 0; 
      font-family: 'Segoe UI', sans-serif; 
      background-color: #f1f1f1; 
    }
    .sayfa {
      width: 800px; 
      margin: 20px auto; 
      background-color: white;
      padding: 30px 40px; 
      box-sizing: border-box; 
      border: 1px solid #ccc;
    }
    .baslik { 
      text-align: center;
      margin-top: 120px;
      margin-bottom: 80px;
      padding-bottom: 80px;
      border-bottom: 5px solid #2f4f30;
    }
    .baslik h1 { 
      font-size: 74px; 
      margin: 0 0 10px 0; 
      color: #2f4f30;
      font-weight: 700;
    }
    .baslik h2 { 
      font-size: 48px; 
      font-weight: 600; 
      margin: 0; 
      color: #2f4f30;
    }
    .filtre-bilgi {
      font-size: 13px;
      font-weight: 600;
      color: #2f4f30;
      margin-bottom: 20px;
      padding: 12px 15px;
      background: #e8f5e9;
      border: 2px solid #2f4f30;
      border-radius: 5px;
    }
    .odeme-aciklama {
      background: #f8f9fa;
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 10px;
      margin-bottom: 20px;
    }
    .odeme-aciklama h3 {
      margin: 0 0 10px 0;
      font-size: 12px;
      color: #2f4f30;
      border-bottom: 1px solid #ddd;
      padding-bottom: 6px;
      font-weight: 600;
    }
    .odeme-aciklama-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
    .aciklama-item {
      background: white;
      padding: 8px;
      border-radius: 5px;
      border: 1px solid #e0e0e0;
    }
    .aciklama-item strong {
      display: block;
      margin-bottom: 5px;
      font-size: 11px;
      color: #2f4f30;
    }
    .aciklama-item p {
      margin: 5px 0;
      font-size: 9px;
      line-height: 1.4;
      color: #666;
    }
    .aciklama-item .ornek {
      margin-top: 5px;
      padding: 6px;
      background: #fff;
      border-left: 2px solid #2f4f30;
      font-size: 8px;
      line-height: 1.5;
    }
    .aciklama-item .ornek strong {
      display: inline;
      font-weight: 600;
    }
    .kpi-container {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-bottom: 25px;
    }
    .kpi-item {
      background: #f8f9fa;
      border: 1px solid #ddd;
      padding: 12px;
      border-radius: 5px;
      text-align: center;
    }
    .kpi-item .lbl {
      font-size: 11px;
      color: #666;
      margin-bottom: 5px;
    }
    .kpi-item .val {
      font-size: 18px;
      font-weight: bold;
      color: #2f4f30;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
      font-size: 12px;
    }
    th {
      background-color: #2f4f30;
      color: white;
      padding: 10px;
      text-align: left;
      font-weight: 600;
    }
    td {
      padding: 8px 10px;
      border-bottom: 1px solid #ddd;
    }
    tr:nth-child(even) {
      background-color: #f8f9fa;
    }
    .durum-normal { color: #16a34a; font-weight: 600; }
    .durum-erken { color: #f59e0b; font-weight: 600; }
    .durum-gecikmeli { color: #e11d48; font-weight: 600; }
    .analiz-tablo-container {
      margin: 20px 0;
    }
    .analiz-tablo-baslik {
      font-size: 16px;
      font-weight: 700;
      color: #ea580c;
      margin-bottom: 12px;
      margin-top: 25px;
      padding: 10px 15px;
      background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%);
      border-left: 5px solid #ea580c;
      border-radius: 5px;
      box-shadow: 0 2px 4px rgba(234, 88, 12, 0.1);
    }
    .analiz-tablo {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
      font-size: 11px;
    }
    .analiz-tablo th {
      background-color: #2f4f30;
      color: white;
      padding: 8px;
      text-align: left;
      font-weight: 600;
      font-size: 11px;
    }
    .analiz-tablo td {
      padding: 4.5px 8px;
      border-bottom: 1px solid #ddd;
    }
    .analiz-tablo tr:nth-child(even) {
      background-color: #f8f9fa;
    }
    .analiz-tablo tr.personel-secili {
      background-color: #e8f5e9 !important;
      font-weight: 600;
    }
    .siralama-degisim {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 10px;
    }
    .siralama-yukselme {
      color: #16a34a;
    }
    .siralama-stabil {
      color: #f59e0b;
    }
    .siralama-dusme {
      color: #e11d48;
    }
    .btn-alani { 
      text-align: center; 
      margin-top: 30px; 
    }
    button {
      padding: 10px 20px; 
      background-color: #4a637d;
      border: none; 
      color: white; 
      font-size: 15px;
      border-radius: 5px; 
      cursor: pointer;
    }
    button:hover { 
      background-color: #3b526b; 
    }
    @media print {
      body { background-color: white; }
      .btn-alani { display: none; }
      #detayTabloToggle { display: none !important; }
      .sayfa { border: none; margin: 0; padding: 20px; }
      .durum-normal { 
        color: #16a34a !important; 
        font-weight: 600; 
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      .durum-erken { 
        color: #f59e0b !important; 
        font-weight: 600; 
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      .durum-gecikmeli { 
        color: #e11d48 !important; 
        font-weight: 600; 
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      .siralama-yukselme { 
        color: #16a34a !important; 
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      .siralama-stabil { 
        color: #f59e0b !important; 
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      .siralama-dusme { 
        color: #e11d48 !important; 
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      .analiz-tablo-baslik {
        color: #ea580c !important;
        background: linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%) !important;
        border-left: 5px solid #ea580c !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
    }
    @media (max-width: 900px) {
      .odeme-aciklama-grid {
        grid-template-columns: 1fr;
      }
    }
    @media print {
      .durum-normal { 
        color: #16a34a !important; 
        font-weight: 600; 
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      .durum-erken { 
        color: #f59e0b !important; 
        font-weight: 600; 
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
      .durum-gecikmeli { 
        color: #e11d48 !important; 
        font-weight: 600; 
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
      }
    }
  </style>
</head>
<body>
  <div class="sayfa" id="pdfAlani">
    <div class="baslik">
      <h1>KaraaÄŸaÃ§ Fatih</h1>
      <h2>Ã–deme Takvim Analiz Raporu</h2>
    </div>

    <div class="filtre-bilgi" id="filtreBilgi">
      Filtreler yÃ¼kleniyor...
    </div>

    <!-- Ã–deme ZamanlamasÄ± KurallarÄ± -->
    <section class="odeme-aciklama">
      <h3>Ã–deme ZamanlamasÄ± KurallarÄ±</h3>
      
      <div class="odeme-aciklama-grid">
        <div class="aciklama-item">
          <strong>ğŸ Hediye Ã–demesi</strong>
          <p>Ã–rnek "MayÄ±s hediyesi" iÃ§in ayÄ±n takibine (Haziran) bir sonraki ayÄ±n 1-5 arasÄ±nda Ã¶deme yapÄ±lmasÄ± normal vakittir.</p>
          <div class="ornek">
            <strong>Ã–rnek:</strong> MayÄ±s hediyesi iÃ§in <strong style="color: #16a34a;">normal Ã¶deme: Haziran 1-5 arasÄ±</strong><br>
            â€¢ MayÄ±s ayÄ±nda Ã¶deme â†’ <strong style="color: #f59e0b;">Erken Ã¶deme</strong><br>
            â€¢ Haziran 6'sÄ±ndan sonra Ã¶deme â†’ <strong style="color: #e11d48;">Gecikmeli Ã¶deme</strong>
          </div>
        </div>

        <div class="aciklama-item">
          <strong>ğŸ  Kira Ã–demesi</strong>
          <p>Ã–rnek "MayÄ±s kirasÄ±" iÃ§in aynÄ± ayÄ±n (MayÄ±s) 1-5 arasÄ±nda Ã¶deme yapÄ±lmasÄ± normal Ã¶demedir.</p>
          <div class="ornek">
            <strong>Ã–rnek:</strong> MayÄ±s kirasÄ± iÃ§in <strong style="color: #16a34a;">normal Ã¶deme: MayÄ±s 1-5 arasÄ±</strong><br>
            â€¢ Nisan ayÄ±nda Ã¶deme â†’ <strong style="color: #f59e0b;">Erken Ã¶deme</strong><br>
            â€¢ MayÄ±s 6'sÄ±ndan sonra Ã¶deme â†’ <strong style="color: #e11d48;">Gecikmeli Ã¶deme</strong>
          </div>
        </div>

        <div class="aciklama-item">
          <strong>ğŸ‘¶ Ã‡ocuk ve Yol YardÄ±mÄ±</strong>
          <p>Hediye Ã¶demesi gibidir. Ã–rnek "MayÄ±s Ã§ocuk yardÄ±mÄ±" iÃ§in Haziran 1-5 arasÄ±nda Ã¶deme yapÄ±lmasÄ± normal vakittir.</p>
          <div class="ornek">
            <strong>Ã–rnek:</strong> MayÄ±s Ã§ocuk/yol yardÄ±mÄ± iÃ§in <strong style="color: #16a34a;">normal Ã¶deme: Haziran 1-5 arasÄ±</strong><br>
            â€¢ MayÄ±s ayÄ±nda Ã¶deme â†’ <strong style="color: #f59e0b;">Erken Ã¶deme</strong><br>
            â€¢ Haziran 6'sÄ±ndan sonra Ã¶deme â†’ <strong style="color: #e11d48;">Gecikmeli Ã¶deme</strong>
          </div>
        </div>

        <div class="aciklama-item">
          <strong>ğŸ’° DiÄŸer Ã–demeler</strong>
          <p>Yakacak, Ä°kramiye, Elbise, Asker, Yeni DoÄŸan, DÃ¼ÄŸÃ¼n Ã¶demeleri iÃ§in aynÄ± ayÄ±n 16-30/31 arasÄ±nda Ã¶deme yapÄ±lmasÄ± normal Ã¶demedir. Ä°lk 15 gÃ¼n iÃ§inde Ã¶deme erken Ã¶demedir.</p>
          <div class="ornek">
            <strong>Ã–rnek:</strong> MayÄ±s yakacak/ikramiye/elbise/asker/yeni doÄŸan/dÃ¼ÄŸÃ¼n iÃ§in <strong style="color: #16a34a;">normal Ã¶deme: MayÄ±s 16-30/31 arasÄ±</strong><br>
            â€¢ MayÄ±s 1-15 arasÄ± Ã¶deme â†’ <strong style="color: #f59e0b;">Erken Ã¶deme</strong><br>
            â€¢ Haziran ayÄ±nda Ã¶deme â†’ <strong style="color: #e11d48;">Gecikmeli Ã¶deme</strong>
          </div>
        </div>
      </div>
    </section>

    <!-- Ã–deme Takvimi Veri KaynaÄŸÄ± AÃ§Ä±klamasÄ± -->
    <section class="odeme-aciklama" style="margin-bottom: 16px; padding: 10px;">
      <p style="margin: 0; font-size: 11px; line-height: 1.6; color: #333;">
        Buradaki veriler muhasebe "TekdÃ¼zen" Ã¼zerinden alÄ±nmÄ±ÅŸtÄ±r. Sisteme gÃ¶re %100 mutabÄ±k ve doÄŸrudur.
      </p>
    </section>

    <div class="kpi-container" id="kpiContainer">
      <!-- KPI'lar buraya eklenecek -->
    </div>

    <!-- Tip BazlÄ± Analiz TablolarÄ± -->
    <div id="tipAnalizTablolari">
      <!-- Genel Tip Analizi -->
      <div class="analiz-tablo-container" id="genelTipAnalizContainer">
        <div class="analiz-tablo-baslik">Tip BazlÄ± Ã–deme Analizi (TÃ¼m YÄ±llar)</div>
        <div style="font-size: 10px; color: #666; margin-bottom: 10px; padding: 8px; background-color: #f8f9fa; border-left: 3px solid #2f4f30;">
          Bu tablo, tÃ¼m yÄ±llar iÃ§in Ã¶deme tiplerine gÃ¶re toplam Ã¶demeleri, aylÄ±k ortalamalarÄ± ve kaÃ§ personelin bu tip Ã¶deme yaptÄ±ÄŸÄ±nÄ± gÃ¶sterir.
        </div>
        <table class="analiz-tablo" id="genelTipAnalizTablo">
          <thead>
            <tr>
              <th>Tip</th>
              <th style="text-align: center;">Ã–deme SayÄ±sÄ±</th>
              <th style="text-align: right;">Toplam Ã–deme</th>
              <th style="text-align: right;">AylÄ±k Ortalama</th>
              <th style="text-align: center;">Personel SayÄ±sÄ±</th>
            </tr>
          </thead>
          <tbody id="genelTipAnalizBody">
            <tr><td colspan="5" style="text-align: center; padding: 20px;">YÃ¼kleniyor...</td></tr>
          </tbody>
        </table>
      </div>

      <!-- 2023 Tip Analizi -->
      <div class="analiz-tablo-container" id="tip2023Container">
        <div class="analiz-tablo-baslik">2023 YÄ±lÄ± Tip BazlÄ± Analiz</div>
        <div style="font-size: 10px; color: #666; margin-bottom: 10px; padding: 8px; background-color: #f8f9fa; border-left: 3px solid #2f4f30;">
          2023 yÄ±lÄ± iÃ§in Ã¶deme tiplerine gÃ¶re toplam Ã¶demeleri, aylÄ±k ortalamalarÄ± ve kaÃ§ personelin bu tip Ã¶deme yaptÄ±ÄŸÄ±nÄ± gÃ¶sterir.
        </div>
        <table class="analiz-tablo" id="tip2023Tablo">
          <thead>
            <tr>
              <th>Tip</th>
              <th style="text-align: center;">Ã–deme SayÄ±sÄ±</th>
              <th style="text-align: right;">Toplam Ã–deme</th>
              <th style="text-align: right;">AylÄ±k Ortalama</th>
              <th style="text-align: center;">Personel SayÄ±sÄ±</th>
            </tr>
          </thead>
          <tbody id="tip2023Body">
            <tr><td colspan="5" style="text-align: center; padding: 20px;">YÃ¼kleniyor...</td></tr>
          </tbody>
        </table>
      </div>

      <!-- 2024 Tip Analizi -->
      <div class="analiz-tablo-container" id="tip2024Container">
        <div class="analiz-tablo-baslik">2024 YÄ±lÄ± Tip BazlÄ± Analiz</div>
        <div style="font-size: 10px; color: #666; margin-bottom: 10px; padding: 8px; background-color: #f8f9fa; border-left: 3px solid #2f4f30;">
          2024 yÄ±lÄ± iÃ§in Ã¶deme tiplerine gÃ¶re toplam Ã¶demeleri, aylÄ±k ortalamalarÄ± ve kaÃ§ personelin bu tip Ã¶deme yaptÄ±ÄŸÄ±nÄ± gÃ¶sterir.
        </div>
        <table class="analiz-tablo" id="tip2024Tablo">
          <thead>
            <tr>
              <th>Tip</th>
              <th style="text-align: center;">Ã–deme SayÄ±sÄ±</th>
              <th style="text-align: right;">Toplam Ã–deme</th>
              <th style="text-align: right;">AylÄ±k Ortalama</th>
              <th style="text-align: center;">Personel SayÄ±sÄ±</th>
            </tr>
          </thead>
          <tbody id="tip2024Body">
            <tr><td colspan="5" style="text-align: center; padding: 20px;">YÃ¼kleniyor...</td></tr>
          </tbody>
        </table>
      </div>

      <!-- 2025 Tip Analizi -->
      <div class="analiz-tablo-container" id="tip2025Container">
        <div class="analiz-tablo-baslik">2025 YÄ±lÄ± Tip BazlÄ± Analiz</div>
        <div style="font-size: 10px; color: #666; margin-bottom: 10px; padding: 8px; background-color: #f8f9fa; border-left: 3px solid #2f4f30;">
          2025 yÄ±lÄ± iÃ§in Ã¶deme tiplerine gÃ¶re toplam Ã¶demeleri, aylÄ±k ortalamalarÄ± ve kaÃ§ personelin bu tip Ã¶deme yaptÄ±ÄŸÄ±nÄ± gÃ¶sterir.
        </div>
        <table class="analiz-tablo" id="tip2025Tablo">
          <thead>
            <tr>
              <th>Tip</th>
              <th style="text-align: center;">Ã–deme SayÄ±sÄ±</th>
              <th style="text-align: right;">Toplam Ã–deme</th>
              <th style="text-align: right;">AylÄ±k Ortalama</th>
              <th style="text-align: center;">Personel SayÄ±sÄ±</th>
            </tr>
          </thead>
          <tbody id="tip2025Body">
            <tr><td colspan="5" style="text-align: center; padding: 20px;">YÃ¼kleniyor...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Analiz TablolarÄ± -->
    <div id="analizTablolari">
      <!-- Genel Analiz Tablosu -->
      <div class="analiz-tablo-container" id="genelAnalizContainer">
        <div class="analiz-tablo-baslik">Genel Analiz (TÃ¼m YÄ±llar)</div>
        <div style="font-size: 10px; color: #666; margin-bottom: 10px; padding: 8px; background-color: #f8f9fa; border-left: 3px solid #2f4f30;">
          Bu tablo, tÃ¼m yÄ±llar iÃ§in personel bazÄ±nda toplam Ã¶demeleri, aylÄ±k ortalamalarÄ±, Ã¶deme durumlarÄ±nÄ± (Normal/Erken/Gecikmeli) ve en yÃ¼ksek Ã¶deme tutarlarÄ±nÄ± gÃ¶sterir. SÄ±ralama toplam Ã¶demeye gÃ¶re yapÄ±lmÄ±ÅŸtÄ±r.
        </div>
        <table class="analiz-tablo" id="genelAnalizTablo">
          <thead>
            <tr>
              <th>Personel</th>
              <th style="text-align: center;">Ã–deme SayÄ±sÄ±</th>
              <th style="text-align: right;">Toplam Ã–deme</th>
              <th style="text-align: right;">AylÄ±k Ortalama</th>
              <th style="text-align: center;">Normal %</th>
              <th style="text-align: center;">Erken %</th>
              <th style="text-align: center;">Gecikmeli %</th>
              <th style="text-align: right;">En YÃ¼ksek</th>
              <th style="text-align: center;">Tip SayÄ±sÄ±</th>
            </tr>
          </thead>
          <tbody id="genelAnalizBody">
            <tr><td colspan="9" style="text-align: center; padding: 20px;">YÃ¼kleniyor...</td></tr>
          </tbody>
        </table>
      </div>

      <!-- 2023 YÄ±lÄ± Analiz Tablosu -->
      <div class="analiz-tablo-container" id="yil2023Container">
        <div class="analiz-tablo-baslik">2023 YÄ±lÄ± Analizi</div>
        <div style="font-size: 10px; color: #666; margin-bottom: 10px; padding: 8px; background-color: #f8f9fa; border-left: 3px solid #2f4f30;">
          2023 yÄ±lÄ± iÃ§in personel bazÄ±nda toplam Ã¶demeleri, aylÄ±k ortalamalarÄ±, Ã¶deme durumlarÄ±nÄ± (Normal/Erken/Gecikmeli) ve en yÃ¼ksek Ã¶deme tutarlarÄ±nÄ± gÃ¶sterir. SÄ±ralama toplam Ã¶demeye gÃ¶re yapÄ±lmÄ±ÅŸtÄ±r.
        </div>
        <table class="analiz-tablo" id="yil2023Tablo">
          <thead>
            <tr>
              <th>Personel</th>
              <th style="text-align: center;">Ã–deme SayÄ±sÄ±</th>
              <th style="text-align: right;">Toplam Ã–deme</th>
              <th style="text-align: right;">AylÄ±k Ortalama</th>
              <th style="text-align: center;">Normal %</th>
              <th style="text-align: center;">Erken %</th>
              <th style="text-align: center;">Gecikmeli %</th>
              <th style="text-align: right;">En YÃ¼ksek</th>
              <th style="text-align: center;">Tip SayÄ±sÄ±</th>
            </tr>
          </thead>
          <tbody id="yil2023Body">
            <tr><td colspan="9" style="text-align: center; padding: 20px;">YÃ¼kleniyor...</td></tr>
          </tbody>
        </table>
      </div>

      <!-- 2024 YÄ±lÄ± Analiz Tablosu -->
      <div class="analiz-tablo-container" id="yil2024Container">
        <div class="analiz-tablo-baslik">2024 YÄ±lÄ± Analizi</div>
        <div style="font-size: 10px; color: #666; margin-bottom: 10px; padding: 8px; background-color: #f8f9fa; border-left: 3px solid #2f4f30;">
          2024 yÄ±lÄ± iÃ§in personel bazÄ±nda toplam Ã¶demeleri, aylÄ±k ortalamalarÄ±, Ã¶deme durumlarÄ±nÄ± (Normal/Erken/Gecikmeli) ve en yÃ¼ksek Ã¶deme tutarlarÄ±nÄ± gÃ¶sterir. "2023 SÄ±ralama" sÃ¼tunu, 2023 yÄ±lÄ±ndaki sÄ±ralamayÄ± ve 2023'e gÃ¶re deÄŸiÅŸimi (â†‘ yÃ¼kselme, â”€ stabil, â†“ dÃ¼ÅŸme) gÃ¶sterir.
        </div>
        <table class="analiz-tablo" id="yil2024Tablo">
          <thead>
            <tr>
              <th>Personel</th>
              <th style="text-align: center;">Ã–deme SayÄ±sÄ±</th>
              <th style="text-align: right;">Toplam Ã–deme</th>
              <th style="text-align: right;">AylÄ±k Ortalama</th>
              <th style="text-align: center;">Normal %</th>
              <th style="text-align: center;">Erken %</th>
              <th style="text-align: center;">Gecikmeli %</th>
              <th style="text-align: right;">En YÃ¼ksek</th>
              <th style="text-align: center;">Tip SayÄ±sÄ±</th>
              <th style="text-align: center;">2023 SÄ±ralama</th>
            </tr>
          </thead>
          <tbody id="yil2024Body">
            <tr><td colspan="10" style="text-align: center; padding: 20px;">YÃ¼kleniyor...</td></tr>
          </tbody>
        </table>
      </div>

      <!-- 2025 YÄ±lÄ± Analiz Tablosu -->
      <div class="analiz-tablo-container" id="yil2025Container">
        <div class="analiz-tablo-baslik">2025 YÄ±lÄ± Analizi</div>
        <div style="font-size: 10px; color: #666; margin-bottom: 10px; padding: 8px; background-color: #f8f9fa; border-left: 3px solid #2f4f30;">
          2025 yÄ±lÄ± iÃ§in personel bazÄ±nda toplam Ã¶demeleri, aylÄ±k ortalamalarÄ±, Ã¶deme durumlarÄ±nÄ± (Normal/Erken/Gecikmeli) ve en yÃ¼ksek Ã¶deme tutarlarÄ±nÄ± gÃ¶sterir. "2024 SÄ±ralama" sÃ¼tunu, 2024 yÄ±lÄ±ndaki sÄ±ralamayÄ± ve 2024'e gÃ¶re deÄŸiÅŸimi (â†‘ yÃ¼kselme, â”€ stabil, â†“ dÃ¼ÅŸme) gÃ¶sterir.
        </div>
        <table class="analiz-tablo" id="yil2025Tablo">
          <thead>
            <tr>
              <th>Personel</th>
              <th style="text-align: center;">Ã–deme SayÄ±sÄ±</th>
              <th style="text-align: right;">Toplam Ã–deme</th>
              <th style="text-align: right;">AylÄ±k Ortalama</th>
              <th style="text-align: center;">Normal %</th>
              <th style="text-align: center;">Erken %</th>
              <th style="text-align: center;">Gecikmeli %</th>
              <th style="text-align: right;">En YÃ¼ksek</th>
              <th style="text-align: center;">Tip SayÄ±sÄ±</th>
              <th style="text-align: center;">2024 SÄ±ralama</th>
            </tr>
          </thead>
          <tbody id="yil2025Body">
            <tr><td colspan="10" style="text-align: center; padding: 20px;">YÃ¼kleniyor...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Personel Detay Analizleri -->
    <div id="personelDetayAnalizleri">
      <!-- Personel BazlÄ± Tip Analizleri -->
      <div class="analiz-tablo-container" id="personelTipAnalizContainer">
        <div class="analiz-tablo-baslik">Personel BazlÄ± Tip Ã–deme Analizleri</div>
        <div style="font-size: 10px; color: #666; margin-bottom: 10px; padding: 8px; background-color: #f8f9fa; border-left: 3px solid #2f4f30;">
          Her personel iÃ§in Ã¶deme tiplerine gÃ¶re Ã¶deme sayÄ±sÄ±, toplam tutar, ortalama tutar ve yÄ±llÄ±k bazda artÄ±ÅŸ yÃ¼zdeleri gÃ¶sterilir.
        </div>
        <div id="personelTipAnalizIcerik">
          <!-- Her personel iÃ§in dinamik olarak oluÅŸturulacak -->
        </div>
      </div>

      <!-- Kira ArtÄ±ÅŸ Analizleri -->
      <div class="analiz-tablo-container" id="kiraArtisAnalizContainer">
        <div class="analiz-tablo-baslik">Kira ArtÄ±ÅŸ Analizleri (DÃ¶nem BazlÄ±)</div>
        <div style="font-size: 10px; color: #666; margin-bottom: 10px; padding: 8px; background-color: #f8f9fa; border-left: 3px solid #2f4f30;">
          Her personel iÃ§in kira Ã¶demelerindeki deÄŸiÅŸiklikler dÃ¶nemler halinde gÃ¶sterilir. AynÄ± tutarlÄ± aylar birleÅŸtirilerek Ã¶zetlenir. ArtÄ±ÅŸ yÃ¼zdeleri yeÅŸil (artÄ±ÅŸ) veya kÄ±rmÄ±zÄ± (azalÄ±ÅŸ) renklerle gÃ¶sterilir.
        </div>
        <div id="kiraArtisAnalizIcerik">
          <!-- Her personel iÃ§in dinamik olarak oluÅŸturulacak -->
        </div>
      </div>
    </div>

    <!-- Detay Tablosu Gizle/GÃ¶ster Butonu -->
    <div style="text-align: center; margin: 20px 0;">
      <button id="detayTabloToggle" onclick="toggleDetayTablo()" style="padding: 10px 20px; background-color: #2f4f30; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 13px; font-weight: 600;">
        ğŸ“‹ Detay Tablosunu Gizle
      </button>
    </div>

    <table id="veriTablo">
      <thead>
        <tr>
          <th>Personel</th>
          <th>Tip</th>
          <th>Tarih (YÄ±l-Ay)</th>
          <th style="text-align: right;">Tutar</th>
          <th>Ã–deme Tarihi</th>
          <th style="text-align: center;">Durum</th>
        </tr>
      </thead>
      <tbody id="veriTabloBody">
        <tr>
          <td colspan="6" style="text-align: center; padding: 20px;">Veriler yÃ¼kleniyor...</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="btn-alani">
    <button onclick="pdfCiktisiAl()">PDF Ã‡Ä±ktÄ±sÄ± Al</button>
  </div>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="../../src/supabase.js"></script>
  <script src="../../src/supabase-auth-wrapper.js"></script>
  <script src="../../src/supabase-db-wrapper.js"></script>
  <script src="../../js/ortak.js"></script>
  
  <!-- html2pdf -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      function waitForSupabaseAndOrtak(callback) {
        // window.supabase'in bir client instance olduÄŸunu kontrol et (from metodu olmalÄ±)
        if (typeof window.supabase !== 'undefined' && 
            typeof window.supabase.from === 'function' && 
            typeof window.norm !== 'undefined') {
          callback();
        } else {
          setTimeout(() => waitForSupabaseAndOrtak(callback), 50);
        }
      }

      waitForSupabaseAndOrtak(() => {
        const getSupabase = () => window.supabase;
        const $ = (id) => document.getElementById(id);
        const fmt = n => (n==null||isNaN(n)) ? 'â‚º0' : 'â‚º' + Number(n).toLocaleString('tr-TR',{maximumFractionDigits:2});
        const basHarfBuyuk = (str) => {
          if (!str) return '';
          return str.split(' ').map(kelime => {
            return kelime.charAt(0).toUpperCase() + kelime.slice(1).toLowerCase();
          }).join(' ');
        };

        // URL parametrelerinden filtreleri al
        const urlParams = new URLSearchParams(window.location.search);
        const yil = urlParams.get('yil') || '';
        const ay = urlParams.get('ay') || '';
        const tip = urlParams.get('tip') || '';
        const personelUid = urlParams.get('personel') || '';

        // Personel adÄ±nÄ± al (filtre bilgisi iÃ§in)
        let personelAdi = '';
        if (personelUid) {
          // Personel adÄ±nÄ± almak iÃ§in async iÅŸlem yapacaÄŸÄ±z
          (async () => {
            try {
              const sb = getSupabase();
              const { data } = await sb.from('personel_odeme_takvim')
                .select('personel_adi_soyadi')
                .eq('personel_uid', personelUid)
                .limit(1)
                .single();
              if (data) {
                personelAdi = data.personel_adi_soyadi;
                // Filtre bilgisini gÃ¼ncelle
                guncelleFiltreBilgi();
              }
            } catch(e) {
              console.error('Personel adÄ± alÄ±namadÄ±:', e);
            }
          })();
        }

        function guncelleFiltreBilgi() {
          const filtreler = [];
          
          // Personel
          if (personelUid) {
            if (personelAdi) {
              filtreler.push(basHarfBuyuk(personelAdi));
            } else {
              filtreler.push(personelUid);
            }
          } else {
            filtreler.push('TÃ¼m Personel');
          }
          
          // YÄ±l
          if (yil) {
            filtreler.push(yil);
          } else {
            filtreler.push('TÃ¼m YÄ±llar');
          }
          
          // Ay
          if (ay) {
            const ayIsimleri = ['', 'Ocak', 'Åubat', 'Mart', 'Nisan', 'MayÄ±s', 'Haziran', 'Temmuz', 'AÄŸustos', 'EylÃ¼l', 'Ekim', 'KasÄ±m', 'AralÄ±k'];
            filtreler.push(ayIsimleri[parseInt(ay)]);
          } else {
            filtreler.push('TÃ¼m Aylar');
          }
          
          // Tip
          if (tip) {
            const tipIsimleri = {
              'hediye': 'Hediye',
              'kira': 'Kira',
              'cocuk': 'Ã‡ocuk',
              'yakacak': 'Yakacak',
              'ikramiye': 'Ä°kramiye',
              'elbise': 'Elbise',
              'asker': 'Asker',
              'yeni_dogan': 'Yeni DoÄŸan',
              'yol_yardimi': 'Yol YardÄ±mÄ±',
              'dugun': 'DÃ¼ÄŸÃ¼n'
            };
            filtreler.push(tipIsimleri[tip] || tip);
          } else {
            filtreler.push('TÃ¼m Tipler');
          }
          
          $('filtreBilgi').textContent = filtreler.join(' - ');
        }

        // Ä°lk filtre bilgisini gÃ¶ster
        guncelleFiltreBilgi();

        // Ã–deme durumu hesaplama (personel_analiz.html'deki doÄŸru versiyon)
        function hesaplaDurum(verildigiTarih, yil, ay, tip) {
          const odemeTarihi = new Date(verildigiTarih);
          const odemeYil = odemeTarihi.getFullYear();
          const odemeAy = odemeTarihi.getMonth() + 1;
          const odemeGun = odemeTarihi.getDate();

          // Hediye, Ã‡ocuk, Yol YardÄ±mÄ±: Sonraki ayÄ±n 1-5'i normal
          const hediyeTipleri = ['hediye', 'cocuk', 'yol_yardimi'];
          // Kira: AynÄ± ayÄ±n 1-5'i normal
          const kiraTipleri = ['kira'];
          // Ä°kramiye, Asker, Yeni DoÄŸan, DÃ¼ÄŸÃ¼n, Yakacak, Elbise: AynÄ± ayÄ±n 16-30/31'i normal, 1-15 erken
          const esnekTipleri = ['ikramiye', 'asker', 'yeni_dogan', 'dugun', 'yakacak', 'elbise'];

          if (hediyeTipleri.includes(tip)) {
            // Sonraki ayÄ±n 1-5'i normal
            const normalBaslangicAy = ay + 1;
            let normalBaslangicYil = yil;
            let nextAy = normalBaslangicAy;
            let nextYil = normalBaslangicYil;
            if (nextAy > 12) {
              nextAy = 1;
              nextYil++;
            }

            // Ã–deme tarihi normal aralÄ±kta mÄ±? (Sonraki ayÄ±n 1-5'i)
            if (odemeYil === nextYil && odemeAy === nextAy && odemeGun >= 1 && odemeGun <= 5) {
              return { durum: 'Normal', sinif: 'durum-normal' };
            }

            // Erken Ã¶deme kontrolÃ¼ (normal ayÄ±n Ã¶ncesi)
            if (odemeYil < nextYil || (odemeYil === nextYil && odemeAy < nextAy)) {
              return { durum: 'Erken', sinif: 'durum-erken' };
            }

            // Gecikmeli Ã¶deme (sonraki ayÄ±n 6'sÄ±ndan sonra)
            if (odemeYil > nextYil || (odemeYil === nextYil && odemeAy > nextAy) || 
                (odemeYil === nextYil && odemeAy === nextAy && odemeGun > 5)) {
              return { durum: 'Gecikmeli', sinif: 'durum-gecikmeli' };
            }
          } else if (kiraTipleri.includes(tip)) {
            // AynÄ± ayÄ±n 1-5'i normal
            if (odemeYil === yil && odemeAy === ay && odemeGun >= 1 && odemeGun <= 5) {
              return { durum: 'Normal', sinif: 'durum-normal' };
            }

            // Erken Ã¶deme kontrolÃ¼ (normal ayÄ±n Ã¶ncesi)
            if (odemeYil < yil || (odemeYil === yil && odemeAy < ay)) {
              return { durum: 'Erken', sinif: 'durum-erken' };
            }

            // Gecikmeli Ã¶deme (aynÄ± ayÄ±n 6'sÄ±ndan sonra veya sonraki ay)
            if (odemeYil > yil || (odemeYil === yil && odemeAy > ay) || 
                (odemeYil === yil && odemeAy === ay && odemeGun > 5)) {
              return { durum: 'Gecikmeli', sinif: 'durum-gecikmeli' };
            }
          } else if (esnekTipleri.includes(tip)) {
            // AynÄ± ayÄ±n 16-30/31'i normal, 1-15 erken, sonraki ay gecikmeli
            if (odemeYil === yil && odemeAy === ay) {
              // AynÄ± ay iÃ§inde
              if (odemeGun >= 16) {
                // AyÄ±n son gÃ¼nÃ¼nÃ¼ kontrol et
                const aySonGunu = new Date(yil, ay, 0).getDate();
                if (odemeGun <= aySonGunu) {
                  return { durum: 'Normal', sinif: 'durum-normal' };
                }
              } else if (odemeGun >= 1 && odemeGun <= 15) {
                return { durum: 'Erken', sinif: 'durum-erken' };
              }
            } else if (odemeYil < yil || (odemeYil === yil && odemeAy < ay)) {
              // Ã–nceki ay - erken
              return { durum: 'Erken', sinif: 'durum-erken' };
            } else {
              // Sonraki ay - gecikmeli
              return { durum: 'Gecikmeli', sinif: 'durum-gecikmeli' };
            }
          } else {
            // Bilinmeyen tip - varsayÄ±lan olarak normal
            return { durum: 'Normal', sinif: 'durum-normal' };
          }
          
          return { durum: 'Normal', sinif: 'durum-normal' };
        }

        async function yukleVeriler() {
          try {
            const sb = getSupabase();
            if (!sb) {
              console.error('Supabase client hazÄ±r deÄŸil');
              return;
            }

            // Analiz tablolarÄ± iÃ§in tÃ¼m verileri Ã§ek (sadece tip ve ay filtresi uygulanmaz, personel filtresi uygulanÄ±r)
            let analizQuery = sb.from('personel_odeme_takvim').select('*');
            if(personelUid) analizQuery = analizQuery.eq('personel_uid', personelUid);
            const { data: tumVeriler, error: analizError } = await analizQuery;
            if(analizError) throw analizError;

            // Detay tablosu iÃ§in filtrelenmiÅŸ veriler
            let query = sb.from('personel_odeme_takvim').select('*');

            if(yil) query = query.eq('yil', parseInt(yil));
            if(ay) query = query.eq('ay', parseInt(ay));
            if(tip) query = query.eq('tip', tip);
            if(personelUid) query = query.eq('personel_uid', personelUid);

            query = query.order('verildigi_tarih', { ascending: false });

            const { data, error } = await query;

            if(error) throw error;

            const veriler = data || [];
            
            // Analiz tablolarÄ±nÄ± oluÅŸtur
            olusturAnalizTablolari(tumVeriler || [], personelUid, yil);
            
            // Tip bazlÄ± analiz tablolarÄ±nÄ± oluÅŸtur
            olusturTipAnalizTablolari(tumVeriler || [], yil);
            
            // Personel detay analizlerini oluÅŸtur
            olusturPersonelDetayAnalizleri(tumVeriler || [], personelUid);
            
            // KPI'larÄ± gÃ¼ncelle
            const toplam = veriler.reduce((sum, v) => sum + parseFloat(v.tutar || 0), 0);
            const sayi = veriler.length;
            const uniquePersonel = new Set(veriler.map(v => v.personel_uid)).size;
            const tutarlar = veriler.map(v => parseFloat(v.tutar || 0)).filter(v => !isNaN(v));
            const max = tutarlar.length > 0 ? Math.max(...tutarlar) : 0;
            
            const yilAyKombinasyonlari = new Set();
            veriler.forEach(v => {
              if (v.yil && v.ay) {
                yilAyKombinasyonlari.add(`${v.yil}-${v.ay}`);
              }
            });
            const toplamAySayisi = yilAyKombinasyonlari.size;
            const ortalama = toplamAySayisi > 0 ? toplam / toplamAySayisi : 0;

            // Durum yÃ¼zdeleri
            let normalSayi = 0, erkenSayi = 0, gecikmeliSayi = 0;
            veriler.forEach(v => {
              const durum = hesaplaDurum(v.verildigi_tarih, v.yil, v.ay, v.tip);
              if (durum.durum === 'Normal') normalSayi++;
              else if (durum.durum === 'Erken') erkenSayi++;
              else if (durum.durum === 'Gecikmeli') gecikmeliSayi++;
            });

            const normalYuzde = sayi > 0 ? ((normalSayi / sayi) * 100).toFixed(1) : 0;
            const erkenYuzde = sayi > 0 ? ((erkenSayi / sayi) * 100).toFixed(1) : 0;
            const gecikmeliYuzde = sayi > 0 ? ((gecikmeliSayi / sayi) * 100).toFixed(1) : 0;

            // KPI'larÄ± gÃ¶ster
            $('kpiContainer').innerHTML = `
              <div class="kpi-item">
                <div class="lbl">Toplam Ã–deme</div>
                <div class="val">${fmt(toplam)}</div>
              </div>
              <div class="kpi-item">
                <div class="lbl">Ã–deme SayÄ±sÄ±</div>
                <div class="val">${sayi.toLocaleString('tr-TR')}</div>
              </div>
              <div class="kpi-item">
                <div class="lbl">Ortalama Ã–deme</div>
                <div class="val">${fmt(ortalama)}</div>
              </div>
              <div class="kpi-item">
                <div class="lbl">Personel SayÄ±sÄ±</div>
                <div class="val">${uniquePersonel.toLocaleString('tr-TR')}</div>
              </div>
              <div class="kpi-item">
                <div class="lbl">En YÃ¼ksek Ã–deme</div>
                <div class="val">${fmt(max)}</div>
              </div>
              <div class="kpi-item">
                <div class="lbl">Ã–deme Durumu</div>
                <div class="val" style="font-size: 12px; line-height: 1.6;">
                  <div style="color: #16a34a;">Normal: ${normalYuzde}%</div>
                  <div style="color: #f59e0b;">Erken: ${erkenYuzde}%</div>
                  <div style="color: #e11d48;">Gecikmeli: ${gecikmeliYuzde}%</div>
                </div>
              </div>
            `;

            // Tabloyu doldur
            const tbody = $('veriTabloBody');
            if (veriler.length === 0) {
              tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px;">Veri bulunamadÄ±</td></tr>';
            } else {
              tbody.innerHTML = veriler.map(v => {
                const durum = hesaplaDurum(v.verildigi_tarih, v.yil, v.ay, v.tip);
                const odemeTarihi = new Date(v.verildigi_tarih).toLocaleDateString('tr-TR');
                const tipIsim = v.tip ? v.tip.charAt(0).toUpperCase() + v.tip.slice(1).replace(/_/g, ' ') : '-';
                const personelAdiFormatli = basHarfBuyuk(v.personel_adi_soyadi || '-');
                return `
                  <tr>
                    <td>${personelAdiFormatli}</td>
                    <td>${tipIsim}</td>
                    <td>${v.yil || '-'}-${String(v.ay || '').padStart(2, '0')}</td>
                    <td style="text-align: right;">${fmt(v.tutar)}</td>
                    <td>${odemeTarihi}</td>
                    <td style="text-align: center;" class="${durum.sinif}">${durum.durum}</td>
                  </tr>
                `;
              }).join('');
            }
          } catch(e) {
            console.error('Veriler yÃ¼klenemedi:', e);
            $('veriTabloBody').innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: red;">Hata: ' + (e.message || e) + '</td></tr>';
          }
        }

        // Analiz tablolarÄ±nÄ± oluÅŸtur
        function olusturAnalizTablolari(tumVeriler, seciliPersonelUid, seciliYil) {
          // YÄ±l filtrelenmiÅŸse sadece o yÄ±lÄ±n tablosunu gÃ¶ster
          if (seciliYil) {
            document.getElementById('genelAnalizContainer').style.display = 'none';
            document.getElementById('yil2023Container').style.display = 'none';
            document.getElementById('yil2024Container').style.display = 'none';
            document.getElementById('yil2025Container').style.display = 'none';
            
            const yilInt = parseInt(seciliYil);
            if (yilInt === 2023) {
              document.getElementById('yil2023Container').style.display = 'block';
              olusturYilTablosu(tumVeriler, 2023, null, seciliPersonelUid, 'yil2023Body');
            } else if (yilInt === 2024) {
              document.getElementById('yil2024Container').style.display = 'block';
              const yil2023Veriler = tumVeriler.filter(v => v.yil === 2023);
              olusturYilTablosu(tumVeriler, 2024, yil2023Veriler, seciliPersonelUid, 'yil2024Body', 2023);
            } else if (yilInt === 2025) {
              document.getElementById('yil2025Container').style.display = 'block';
              const yil2024Veriler = tumVeriler.filter(v => v.yil === 2024);
              olusturYilTablosu(tumVeriler, 2025, yil2024Veriler, seciliPersonelUid, 'yil2025Body', 2024);
            } else {
              // DiÄŸer yÄ±llar iÃ§in genel format
              document.getElementById('genelAnalizContainer').style.display = 'block';
              olusturGenelAnalizTablosu(tumVeriler, seciliPersonelUid);
            }
            return;
          }

          // TÃ¼m tablolarÄ± gÃ¶ster
          document.getElementById('genelAnalizContainer').style.display = 'block';
          document.getElementById('yil2023Container').style.display = 'block';
          document.getElementById('yil2024Container').style.display = 'block';
          document.getElementById('yil2025Container').style.display = 'block';

          // Genel analiz tablosu
          olusturGenelAnalizTablosu(tumVeriler, seciliPersonelUid);

          // YÄ±llara gÃ¶re tablolar
          olusturYilTablosu(tumVeriler, 2023, null, seciliPersonelUid, 'yil2023Body');
          
          const yil2023Veriler = tumVeriler.filter(v => v.yil === 2023);
          olusturYilTablosu(tumVeriler, 2024, yil2023Veriler, seciliPersonelUid, 'yil2024Body', 2023);
          
          const yil2024Veriler = tumVeriler.filter(v => v.yil === 2024);
          olusturYilTablosu(tumVeriler, 2025, yil2024Veriler, seciliPersonelUid, 'yil2025Body', 2024);
        }

        function olusturGenelAnalizTablosu(tumVeriler, seciliPersonelUid) {
          // Personel bazÄ±nda grupla
          const personelMap = {};
          const yillar = new Set();
          
          tumVeriler.forEach(v => {
            const pUid = v.personel_uid || 'Bilinmeyen';
            const pAdi = v.personel_adi_soyadi || 'Bilinmeyen';
            if (!personelMap[pUid]) {
              personelMap[pUid] = {
                personelUid: pUid,
                personelAdi: pAdi,
                odemeSayisi: 0,
                toplamOdeme: 0,
                tutarlar: [],
                tipler: new Set(),
                normalSayi: 0,
                erkenSayi: 0,
                gecikmeliSayi: 0
              };
            }
            personelMap[pUid].odemeSayisi++;
            const tutar = parseFloat(v.tutar || 0);
            personelMap[pUid].toplamOdeme += tutar;
            personelMap[pUid].tutarlar.push(tutar);
            if (v.tip) personelMap[pUid].tipler.add(v.tip);
            if (v.yil) yillar.add(v.yil);
            
            // Durum hesapla
            const durum = hesaplaDurum(v.verildigi_tarih, v.yil, v.ay, v.tip);
            if (durum.durum === 'Normal') personelMap[pUid].normalSayi++;
            else if (durum.durum === 'Erken') personelMap[pUid].erkenSayi++;
            else if (durum.durum === 'Gecikmeli') personelMap[pUid].gecikmeliSayi++;
          });

          // DÃ¶nem bazlÄ± ay sayÄ±sÄ±nÄ± hesapla (verilerin kapsadÄ±ÄŸÄ± yÄ±llar x 12)
          const donemAySayisi = yillar.size * 12;

          // Toplam Ã¶demeye gÃ¶re sÄ±rala (bÃ¼yÃ¼kten kÃ¼Ã§Ã¼ÄŸe)
          const personelListesi = Object.values(personelMap).map(p => ({
            ...p,
            ortalamaOdeme: donemAySayisi > 0 ? p.toplamOdeme / donemAySayisi : 0,
            enYuksekOdeme: p.tutarlar.length > 0 ? Math.max(...p.tutarlar) : 0,
            farkliTipSayisi: p.tipler.size,
            normalYuzde: p.odemeSayisi > 0 ? (p.normalSayi / p.odemeSayisi) * 100 : 0,
            erkenYuzde: p.odemeSayisi > 0 ? (p.erkenSayi / p.odemeSayisi) * 100 : 0,
            gecikmeliYuzde: p.odemeSayisi > 0 ? (p.gecikmeliSayi / p.odemeSayisi) * 100 : 0
          })).sort((a, b) => b.toplamOdeme - a.toplamOdeme);

          const tbody = document.getElementById('genelAnalizBody');
          if (personelListesi.length === 0) {
            tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 20px;">Veri bulunamadÄ±</td></tr>';
            return;
          }

          tbody.innerHTML = personelListesi.map(p => {
            const satirSinif = seciliPersonelUid && p.personelUid === seciliPersonelUid ? 'personel-secili' : '';
            return `
              <tr class="${satirSinif}">
                <td>${basHarfBuyuk(p.personelAdi)}</td>
                <td style="text-align: center;">${p.odemeSayisi}</td>
                <td style="text-align: right;">${fmt(p.toplamOdeme)}</td>
                <td style="text-align: right;">${fmt(p.ortalamaOdeme)}</td>
                <td style="text-align: center;" class="durum-normal">${p.normalYuzde.toFixed(1)}%</td>
                <td style="text-align: center;" class="durum-erken">${p.erkenYuzde.toFixed(1)}%</td>
                <td style="text-align: center;" class="durum-gecikmeli">${p.gecikmeliYuzde.toFixed(1)}%</td>
                <td style="text-align: right;">${fmt(p.enYuksekOdeme)}</td>
                <td style="text-align: center;">${p.farkliTipSayisi}</td>
              </tr>
            `;
          }).join('');
        }

        function olusturYilTablosu(tumVeriler, yil, oncekiYilVeriler, seciliPersonelUid, tbodyId, oncekiYil = null) {
          const yilVeriler = tumVeriler.filter(v => v.yil === yil);
          
          // Personel bazÄ±nda grupla
          const personelMap = {};
          yilVeriler.forEach(v => {
            const pUid = v.personel_uid || 'Bilinmeyen';
            const pAdi = v.personel_adi_soyadi || 'Bilinmeyen';
            if (!personelMap[pUid]) {
              personelMap[pUid] = {
                personelUid: pUid,
                personelAdi: pAdi,
                odemeSayisi: 0,
                toplamOdeme: 0,
                tutarlar: [],
                tipler: new Set(),
                normalSayi: 0,
                erkenSayi: 0,
                gecikmeliSayi: 0
              };
            }
            personelMap[pUid].odemeSayisi++;
            const tutar = parseFloat(v.tutar || 0);
            personelMap[pUid].toplamOdeme += tutar;
            personelMap[pUid].tutarlar.push(tutar);
            if (v.tip) personelMap[pUid].tipler.add(v.tip);
            
            // Durum hesapla
            const durum = hesaplaDurum(v.verildigi_tarih, v.yil, v.ay, v.tip);
            if (durum.durum === 'Normal') personelMap[pUid].normalSayi++;
            else if (durum.durum === 'Erken') personelMap[pUid].erkenSayi++;
            else if (durum.durum === 'Gecikmeli') personelMap[pUid].gecikmeliSayi++;
          });

          // YÄ±l bazlÄ± ay sayÄ±sÄ±: 12 ay (2025 iÃ§in ÅŸu anki aya kadar hesaplanabilir ama basit tutmak iÃ§in 12)
          const donemAySayisi = 12;

          // Toplam Ã¶demeye gÃ¶re sÄ±rala
          const personelListesi = Object.values(personelMap).map(p => ({
            ...p,
            ortalamaOdeme: donemAySayisi > 0 ? p.toplamOdeme / donemAySayisi : 0,
            enYuksekOdeme: p.tutarlar.length > 0 ? Math.max(...p.tutarlar) : 0,
            farkliTipSayisi: p.tipler.size,
            normalYuzde: p.odemeSayisi > 0 ? (p.normalSayi / p.odemeSayisi) * 100 : 0,
            erkenYuzde: p.odemeSayisi > 0 ? (p.erkenSayi / p.odemeSayisi) * 100 : 0,
            gecikmeliYuzde: p.odemeSayisi > 0 ? (p.gecikmeliSayi / p.odemeSayisi) * 100 : 0
          })).sort((a, b) => b.toplamOdeme - a.toplamOdeme);

          // Ã–nceki yÄ±l sÄ±ralamasÄ±nÄ± hesapla (varsa)
          let oncekiYilSiralama = {};
          if (oncekiYilVeriler && oncekiYilVeriler.length > 0) {
            const oncekiYilMap = {};
            oncekiYilVeriler.forEach(v => {
              const pUid = v.personel_uid || 'Bilinmeyen';
              if (!oncekiYilMap[pUid]) {
                oncekiYilMap[pUid] = {
                  toplamOdeme: 0
                };
              }
              oncekiYilMap[pUid].toplamOdeme += parseFloat(v.tutar || 0);
            });

            const oncekiYilListesi = Object.entries(oncekiYilMap).map(([personelUid, data]) => ({
              personelUid,
              toplamOdeme: data.toplamOdeme
            })).sort((a, b) => b.toplamOdeme - a.toplamOdeme);

            oncekiYilListesi.forEach((p, index) => {
              oncekiYilSiralama[p.personelUid] = index + 1;
            });
          }

          const tbody = document.getElementById(tbodyId);
          const colspan = oncekiYil ? 10 : 9;
          if (personelListesi.length === 0) {
            tbody.innerHTML = `<tr><td colspan="${colspan}" style="text-align: center; padding: 20px;">Veri bulunamadÄ±</td></tr>`;
            return;
          }

          tbody.innerHTML = personelListesi.map((p, index) => {
            const mevcutSira = index + 1;
            const oncekiSira = oncekiYilSiralama[p.personelUid];
            
            let siralamaGosterim = '';
            if (oncekiYil && oncekiSira) {
              const fark = oncekiSira - mevcutSira;
              if (fark > 0) {
                // YÃ¼kselme
                siralamaGosterim = `<span class="siralama-degisim siralama-yukselme">${oncekiSira}. â†‘</span>`;
              } else if (fark === 0) {
                // Stabil
                siralamaGosterim = `<span class="siralama-degisim siralama-stabil">${oncekiSira}. â”€</span>`;
              } else {
                // DÃ¼ÅŸme
                siralamaGosterim = `<span class="siralama-degisim siralama-dusme">${oncekiSira}. â†“</span>`;
              }
            } else if (oncekiYil) {
              siralamaGosterim = '<span style="color: #999;">-</span>';
            }

            const satirSinif = seciliPersonelUid && p.personelUid === seciliPersonelUid ? 'personel-secili' : '';
            
            const satir = `
              <tr class="${satirSinif}">
                <td>${basHarfBuyuk(p.personelAdi)}</td>
                <td style="text-align: center;">${p.odemeSayisi}</td>
                <td style="text-align: right;">${fmt(p.toplamOdeme)}</td>
                <td style="text-align: right;">${fmt(p.ortalamaOdeme)}</td>
                <td style="text-align: center;" class="durum-normal">${p.normalYuzde.toFixed(1)}%</td>
                <td style="text-align: center;" class="durum-erken">${p.erkenYuzde.toFixed(1)}%</td>
                <td style="text-align: center;" class="durum-gecikmeli">${p.gecikmeliYuzde.toFixed(1)}%</td>
                <td style="text-align: right;">${fmt(p.enYuksekOdeme)}</td>
                <td style="text-align: center;">${p.farkliTipSayisi}</td>
                ${oncekiYil ? `<td style="text-align: center;">${siralamaGosterim}</td>` : ''}
              </tr>
            `;
            return satir;
          }).join('');
        }

        // Tip bazlÄ± analiz tablolarÄ±nÄ± oluÅŸtur
        function olusturTipAnalizTablolari(tumVeriler, seciliYil) {
          // YÄ±l filtrelenmiÅŸse sadece o yÄ±lÄ±n tablosunu gÃ¶ster
          if (seciliYil) {
            document.getElementById('genelTipAnalizContainer').style.display = 'none';
            document.getElementById('tip2023Container').style.display = 'none';
            document.getElementById('tip2024Container').style.display = 'none';
            document.getElementById('tip2025Container').style.display = 'none';
            
            const yilInt = parseInt(seciliYil);
            if (yilInt === 2023) {
              document.getElementById('tip2023Container').style.display = 'block';
              olusturTipYilTablosu(tumVeriler, 2023, 'tip2023Body');
            } else if (yilInt === 2024) {
              document.getElementById('tip2024Container').style.display = 'block';
              olusturTipYilTablosu(tumVeriler, 2024, 'tip2024Body');
            } else if (yilInt === 2025) {
              document.getElementById('tip2025Container').style.display = 'block';
              olusturTipYilTablosu(tumVeriler, 2025, 'tip2025Body');
            } else {
              document.getElementById('genelTipAnalizContainer').style.display = 'block';
              olusturGenelTipAnalizTablosu(tumVeriler);
            }
            return;
          }

          // TÃ¼m tablolarÄ± gÃ¶ster
          document.getElementById('genelTipAnalizContainer').style.display = 'block';
          document.getElementById('tip2023Container').style.display = 'block';
          document.getElementById('tip2024Container').style.display = 'block';
          document.getElementById('tip2025Container').style.display = 'block';

          olusturGenelTipAnalizTablosu(tumVeriler);
          olusturTipYilTablosu(tumVeriler, 2023, 'tip2023Body');
          olusturTipYilTablosu(tumVeriler, 2024, 'tip2024Body');
          olusturTipYilTablosu(tumVeriler, 2025, 'tip2025Body');
        }

        function olusturGenelTipAnalizTablosu(tumVeriler) {
          const tipMap = {};
          const yillar = new Set();
          
          tumVeriler.forEach(v => {
            const tip = v.tip || 'Bilinmeyen';
            if (!tipMap[tip]) {
              tipMap[tip] = {
                tip: tip,
                odemeSayisi: 0,
                toplamOdeme: 0,
                tutarlar: [],
                personeller: new Set()
              };
            }
            tipMap[tip].odemeSayisi++;
            const tutar = parseFloat(v.tutar || 0);
            tipMap[tip].toplamOdeme += tutar;
            tipMap[tip].tutarlar.push(tutar);
            if (v.personel_uid) tipMap[tip].personeller.add(v.personel_uid);
            if (v.yil) yillar.add(v.yil);
          });

          const donemAySayisi = yillar.size * 12;
          const tipListesi = Object.values(tipMap).map(t => ({
            ...t,
            aylikOrtalama: donemAySayisi > 0 ? t.toplamOdeme / donemAySayisi : 0,
            ortalamaTutar: t.odemeSayisi > 0 ? t.toplamOdeme / t.odemeSayisi : 0,
            personelSayisi: t.personeller.size
          })).sort((a, b) => b.toplamOdeme - a.toplamOdeme);

          const tbody = document.getElementById('genelTipAnalizBody');
          if (tipListesi.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">Veri bulunamadÄ±</td></tr>';
            return;
          }

          tbody.innerHTML = tipListesi.map(t => {
            const tipIsim = t.tip ? t.tip.charAt(0).toUpperCase() + t.tip.slice(1).replace(/_/g, ' ') : 'Bilinmeyen';
            return `
              <tr>
                <td>${tipIsim}</td>
                <td style="text-align: center;">${t.odemeSayisi}</td>
                <td style="text-align: right;">${fmt(t.toplamOdeme)}</td>
                <td style="text-align: right;">${fmt(t.aylikOrtalama)}</td>
                <td style="text-align: center;">${t.personelSayisi}</td>
              </tr>
            `;
          }).join('');
        }

        function olusturTipYilTablosu(tumVeriler, yil, tbodyId) {
          const yilVeriler = tumVeriler.filter(v => v.yil === yil);
          const tipMap = {};
          
          yilVeriler.forEach(v => {
            const tip = v.tip || 'Bilinmeyen';
            if (!tipMap[tip]) {
              tipMap[tip] = {
                tip: tip,
                odemeSayisi: 0,
                toplamOdeme: 0,
                tutarlar: [],
                personeller: new Set()
              };
            }
            tipMap[tip].odemeSayisi++;
            const tutar = parseFloat(v.tutar || 0);
            tipMap[tip].toplamOdeme += tutar;
            tipMap[tip].tutarlar.push(tutar);
            if (v.personel_uid) tipMap[tip].personeller.add(v.personel_uid);
          });

          const donemAySayisi = 12;
          const tipListesi = Object.values(tipMap).map(t => ({
            ...t,
            aylikOrtalama: donemAySayisi > 0 ? t.toplamOdeme / donemAySayisi : 0,
            ortalamaTutar: t.odemeSayisi > 0 ? t.toplamOdeme / t.odemeSayisi : 0,
            personelSayisi: t.personeller.size
          })).sort((a, b) => b.toplamOdeme - a.toplamOdeme);

          const tbody = document.getElementById(tbodyId);
          if (tipListesi.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 20px;">Veri bulunamadÄ±</td></tr>';
            return;
          }

          tbody.innerHTML = tipListesi.map(t => {
            const tipIsim = t.tip ? t.tip.charAt(0).toUpperCase() + t.tip.slice(1).replace(/_/g, ' ') : 'Bilinmeyen';
            return `
              <tr>
                <td>${tipIsim}</td>
                <td style="text-align: center;">${t.odemeSayisi}</td>
                <td style="text-align: right;">${fmt(t.toplamOdeme)}</td>
                <td style="text-align: right;">${fmt(t.aylikOrtalama)}</td>
                <td style="text-align: center;">${t.personelSayisi}</td>
              </tr>
            `;
          }).join('');
        }

        // Personel detay analizlerini oluÅŸtur
        function olusturPersonelDetayAnalizleri(tumVeriler, seciliPersonelUid) {
          // Personel bazÄ±nda grupla
          const personelMap = {};
          tumVeriler.forEach(v => {
            const pUid = v.personel_uid || 'Bilinmeyen';
            const pAdi = v.personel_adi_soyadi || 'Bilinmeyen';
            if (!personelMap[pUid]) {
              personelMap[pUid] = {
                personelUid: pUid,
                personelAdi: pAdi,
                odemeler: []
              };
            }
            personelMap[pUid].odemeler.push({
              tip: v.tip,
              tutar: parseFloat(v.tutar || 0),
              yil: v.yil,
              ay: v.ay,
              tarih: v.verildigi_tarih
            });
          });

          // TÃ¼m personellerin en son kira tutarlarÄ±nÄ± hesapla (sÄ±ralama iÃ§in)
          const tumPersonellerKiraHam = Object.values(personelMap).map(p => {
            const kiraOdemeler = p.odemeler
              .filter(o => o.tip === 'kira')
              .sort((a, b) => {
                if (a.yil !== b.yil) return b.yil - a.yil;
                if (a.ay !== b.ay) return b.ay - a.ay;
                return new Date(b.tarih) - new Date(a.tarih);
              });
            
            return {
              personelUid: p.personelUid,
              personelAdi: p.personelAdi,
              enSonKira: kiraOdemeler.length > 0 ? kiraOdemeler[0].tutar : 0
            };
          }).filter(p => p.enSonKira > 0)
            .sort((a, b) => b.enSonKira - a.enSonKira); // YÃ¼ksekten dÃ¼ÅŸÃ¼ÄŸe sÄ±rala
          
          // AynÄ± tutara sahip personelleri aynÄ± sÄ±rada grupla
          const tumPersonellerKira = [];
          let mevcutSira = 1;
          let oncekiTutar = null;
          
          tumPersonellerKiraHam.forEach((p, index) => {
            if (oncekiTutar === null || p.enSonKira !== oncekiTutar) {
              // Yeni bir tutar grubu baÅŸlÄ±yor
              if (index > 0) {
                mevcutSira = tumPersonellerKira.length + 1;
              }
              oncekiTutar = p.enSonKira;
            }
            // AynÄ± tutara sahip personeller aynÄ± sÄ±rada
            tumPersonellerKira.push({
              ...p,
              sira: mevcutSira
            });
          });

          // EÄŸer personel filtrelenmiÅŸse sadece o personeli gÃ¶ster
          const gosterilecekPersoneller = seciliPersonelUid 
            ? Object.values(personelMap).filter(p => p.personelUid === seciliPersonelUid)
            : Object.values(personelMap);

          // Personel tip analizleri
          const personelTipIcerik = [];
          gosterilecekPersoneller.forEach(p => {
            // Tip bazÄ±nda grupla
            const tipMap = {};
            p.odemeler.forEach(o => {
              const tip = o.tip || 'Bilinmeyen';
              if (!tipMap[tip]) {
                tipMap[tip] = {
                  tip: tip,
                  toplam: 0,
                  sayi: 0,
                  yillar: {}
                };
              }
              tipMap[tip].toplam += o.tutar;
              tipMap[tip].sayi++;
              if (!tipMap[tip].yillar[o.yil]) {
                tipMap[tip].yillar[o.yil] = { toplam: 0, sayi: 0 };
              }
              tipMap[tip].yillar[o.yil].toplam += o.tutar;
              tipMap[tip].yillar[o.yil].sayi++;
            });

            const tipListesi = Object.values(tipMap).map(t => ({
              ...t,
              ortalama: t.sayi > 0 ? t.toplam / t.sayi : 0,
              artislar: hesaplaTipArtislari(t.yillar)
            }));

            personelTipIcerik.push({
              personel: p,
              tipler: tipListesi
            });
          });

          // HTML oluÅŸtur
          const tipAnalizHTML = personelTipIcerik.map(pt => {
            const personelAdi = basHarfBuyuk(pt.personel.personelAdi);
            const seciliClass = seciliPersonelUid && pt.personel.personelUid === seciliPersonelUid ? 'personel-secili' : '';
            
            const tipSatirlar = pt.tipler.map(t => {
              const tipIsim = t.tip ? t.tip.charAt(0).toUpperCase() + t.tip.slice(1).replace(/_/g, ' ') : 'Bilinmeyen';
              const artisBilgisi = t.artislar.length > 0 
                ? t.artislar.map(a => `${a.yil}: ${a.yuzde > 0 ? '+' : ''}${a.yuzde.toFixed(1)}%`).join(', ')
                : '-';
              
              return `
                <tr>
                  <td>${tipIsim}</td>
                  <td style="text-align: center;">${t.sayi}</td>
                  <td style="text-align: right;">${fmt(t.toplam)}</td>
                  <td style="text-align: right;">${fmt(t.ortalama)}</td>
                  <td style="text-align: center; font-size: 10px;">${artisBilgisi}</td>
                </tr>
              `;
            }).join('');

            return `
              <div style="margin-bottom: 30px;">
                <div style="font-weight: 700; font-size: 13px; margin-bottom: 10px; color: #2f4f30;">
                  ${personelAdi}
                </div>
                <table class="analiz-tablo">
                  <thead>
                    <tr>
                      <th>Tip</th>
                      <th style="text-align: center;">Ã–deme SayÄ±sÄ±</th>
                      <th style="text-align: right;">Toplam</th>
                      <th style="text-align: right;">Ortalama</th>
                      <th style="text-align: center;">YÄ±llÄ±k ArtÄ±ÅŸlar</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${tipSatirlar}
                  </tbody>
                </table>
              </div>
            `;
          }).join('');

          document.getElementById('personelTipAnalizIcerik').innerHTML = tipAnalizHTML;

          // Kira artÄ±ÅŸ analizleri
          const kiraArtisHTML = gosterilecekPersoneller
            .filter(p => p.odemeler.some(o => o.tip === 'kira'))
            .map(p => {
              const personelAdi = basHarfBuyuk(p.personelAdi);
              const kiraOdemeler = p.odemeler
                .filter(o => o.tip === 'kira')
                .sort((a, b) => {
                  if (a.yil !== b.yil) return a.yil - b.yil;
                  return a.ay - b.ay;
                });
              
              // Bu personelin sÄ±ralamasÄ±nÄ± bul (en son kira tutarÄ±na gÃ¶re)
              const enSonKiraTutari = kiraOdemeler.length > 0 ? kiraOdemeler[kiraOdemeler.length - 1].tutar : 0;
              const mevcutPersonel = tumPersonellerKira.find(per => per.personelUid === p.personelUid);
              const personelSiralama = mevcutPersonel ? mevcutPersonel.sira : 0;
              const toplamPersonelSayisi = tumPersonellerKira.length;
              
              // AynÄ± sÄ±rada kaÃ§ kiÅŸi var?
              const ayniSiradaKisiSayisi = tumPersonellerKira.filter(per => per.sira === personelSiralama).length;
              
              // SÄ±ralama yÃ¼zdesi hesapla (en yÃ¼ksek sÄ±ra numarasÄ±na gÃ¶re)
              const enYuksekSira = Math.max(...tumPersonellerKira.map(per => per.sira));
              const siraYuzdesi = enYuksekSira > 0 ? (personelSiralama / enYuksekSira) * 100 : 0;

              if (kiraOdemeler.length < 2) {
                return `
                  <div style="margin-bottom: 20px;">
                    <div style="font-weight: 700; font-size: 13px; margin-bottom: 10px; color: #2f4f30;">
                      ${personelAdi}
                    </div>
                    <div style="padding: 10px; color: #666; font-size: 11px;">Yeterli veri yok (en az 2 Ã¶deme gerekli)</div>
                  </div>
                `;
              }

              // AynÄ± tutarlÄ± dÃ¶nemleri grupla
              const donemler = [];
              let baslangicYil = kiraOdemeler[0].yil;
              let baslangicAy = kiraOdemeler[0].ay;
              let mevcutTutar = kiraOdemeler[0].tutar;
              
              const ayIsimleri = ['', 'Ocak', 'Åubat', 'Mart', 'Nisan', 'MayÄ±s', 'Haziran', 'Temmuz', 'AÄŸustos', 'EylÃ¼l', 'Ekim', 'KasÄ±m', 'AralÄ±k'];
              
              for (let i = 1; i < kiraOdemeler.length; i++) {
                const simdiki = kiraOdemeler[i];
                
                if (simdiki.tutar !== mevcutTutar) {
                  // Ã–nceki dÃ¶nemi kaydet
                  const bitisYil = kiraOdemeler[i - 1].yil;
                  const bitisAy = kiraOdemeler[i - 1].ay;
                  
                  donemler.push({
                    baslangicYil,
                    baslangicAy,
                    bitisYil,
                    bitisAy,
                    tutar: mevcutTutar
                  });
                  
                  // Yeni dÃ¶nem baÅŸlat
                  baslangicYil = simdiki.yil;
                  baslangicAy = simdiki.ay;
                  mevcutTutar = simdiki.tutar;
                }
              }
              
              // Son dÃ¶nemi ekle
              const sonIndex = kiraOdemeler.length - 1;
              donemler.push({
                baslangicYil,
                baslangicAy,
                bitisYil: kiraOdemeler[sonIndex].yil,
                bitisAy: kiraOdemeler[sonIndex].ay,
                tutar: mevcutTutar
              });

              // ArtÄ±ÅŸ satÄ±rlarÄ±nÄ± oluÅŸtur
              const artisSatirlar = [];
              const artisAylari = []; // ArtÄ±ÅŸ yapÄ±lan aylarÄ± kaydet
              
              for (let i = 1; i < donemler.length; i++) {
                const oncekiDonem = donemler[i - 1];
                const simdikiDonem = donemler[i];
                const artis = simdikiDonem.tutar - oncekiDonem.tutar;
                const yuzdeArtis = oncekiDonem.tutar > 0 ? (artis / oncekiDonem.tutar) * 100 : 0;
                
                // ArtÄ±ÅŸ yapÄ±lan ayÄ± kaydet
                if (artis > 0) {
                  artisAylari.push({
                    yil: simdikiDonem.baslangicYil,
                    ay: simdikiDonem.baslangicAy,
                    ayIsim: ayIsimleri[simdikiDonem.baslangicAy],
                    yuzde: yuzdeArtis
                  });
                }
                
                // DÃ¶nem metni
                let donemMetni = '';
                if (oncekiDonem.baslangicYil === oncekiDonem.bitisYil && oncekiDonem.baslangicAy === oncekiDonem.bitisAy) {
                  donemMetni = `${oncekiDonem.baslangicYil} ${ayIsimleri[oncekiDonem.baslangicAy]}`;
                } else {
                  donemMetni = `${oncekiDonem.baslangicYil} ${ayIsimleri[oncekiDonem.baslangicAy]} - ${oncekiDonem.bitisYil} ${ayIsimleri[oncekiDonem.bitisAy]}`;
                }
                
                let yeniDonemMetni = '';
                if (simdikiDonem.baslangicYil === simdikiDonem.bitisYil && simdikiDonem.baslangicAy === simdikiDonem.bitisAy) {
                  yeniDonemMetni = `${simdikiDonem.baslangicYil} ${ayIsimleri[simdikiDonem.baslangicAy]}`;
                } else {
                  yeniDonemMetni = `${simdikiDonem.baslangicYil} ${ayIsimleri[simdikiDonem.baslangicAy]} - ${simdikiDonem.bitisYil} ${ayIsimleri[simdikiDonem.bitisAy]}`;
                }
                
                artisSatirlar.push(`
                  <tr>
                    <td>${donemMetni} = ${fmt(oncekiDonem.tutar)}</td>
                    <td>${yeniDonemMetni} = ${fmt(simdikiDonem.tutar)}</td>
                    <td style="text-align: center; ${yuzdeArtis > 0 ? 'color: #16a34a;' : yuzdeArtis < 0 ? 'color: #e11d48;' : ''}">
                      ${yuzdeArtis > 0 ? '+' : ''}${yuzdeArtis.toFixed(1)}% artÄ±ÅŸ
                    </td>
                  </tr>
                `);
              }

              // En son kira tutarÄ±
              const enSonKira = kiraOdemeler[kiraOdemeler.length - 1];
              const enSonTutar = enSonKira.tutar;
              
              // Personel arasÄ±ndaki sÄ±ralama analizi
              let siralamaAnalizi = '';
              if (personelSiralama > 0 && toplamPersonelSayisi > 0) {
                const siraMetni = ayniSiradaKisiSayisi > 1 
                  ? `${personelSiralama}. sÄ±rada (${ayniSiradaKisiSayisi} kiÅŸi ile birlikte)`
                  : `${personelSiralama}. sÄ±rada`;
                
                if (siraYuzdesi <= 30) {
                  // Ä°lk %30 iÃ§inde - yÃ¼ksek kira
                  siralamaAnalizi = `<div style="font-size: 11px; color: #ea580c; margin-top: 12px; padding: 10px; background-color: #fff7ed; border-left: 3px solid #ea580c; line-height: 1.6; font-weight: 600;">
                    âš ï¸ Personel arasÄ±nda kira miktarÄ±nÄ±z yÃ¼ksek! En son kira tutarÄ±nÄ±z (${fmt(enSonTutar)}) ${toplamPersonelSayisi} personel arasÄ±nda ${siraMetni} yer almaktadÄ±r.
                  </div>`;
                } else if (siraYuzdesi <= 70) {
                  // %30-70 arasÄ± - orta seviye
                  siralamaAnalizi = `<div style="font-size: 11px; color: #333; margin-top: 12px; padding: 10px; background-color: #f8f9fa; border-left: 3px solid #2f4f30; line-height: 1.6;">
                    â„¹ï¸ Personel arasÄ±nda kira miktarÄ±nÄ±z orta seviyede. En son kira tutarÄ±nÄ±z (${fmt(enSonTutar)}) ${toplamPersonelSayisi} personel arasÄ±nda ${siraMetni} yer almaktadÄ±r.
                  </div>`;
                } else {
                  // Son %30 iÃ§inde - ideal seviye
                  siralamaAnalizi = `<div style="font-size: 11px; color: #16a34a; margin-top: 12px; padding: 10px; background-color: #f0fdf4; border-left: 3px solid #16a34a; line-height: 1.6;">
                    âœ“ Personel arasÄ±nda kira miktarÄ±nÄ±z ideal seviyede. En son kira tutarÄ±nÄ±z (${fmt(enSonTutar)}) ${toplamPersonelSayisi} personel arasÄ±nda ${siraMetni} yer almaktadÄ±r.
                  </div>`;
                }
              }
              
              // YÄ±llara gÃ¶re artÄ±ÅŸ trendini analiz et
              const yilBazliArtislar = [];
              for (let i = 1; i < donemler.length; i++) {
                const oncekiDonem = donemler[i - 1];
                const simdikiDonem = donemler[i];
                const artis = simdikiDonem.tutar - oncekiDonem.tutar;
                const yuzdeArtis = oncekiDonem.tutar > 0 ? (artis / oncekiDonem.tutar) * 100 : 0;
                
                // ArtÄ±ÅŸ yapÄ±lan yÄ±lÄ± belirle (yeni dÃ¶nemin baÅŸlangÄ±Ã§ yÄ±lÄ±)
                const artisYili = simdikiDonem.baslangicYil;
                
                // Sadece pozitif artÄ±ÅŸlarÄ± say (artÄ±ÅŸ yapÄ±lan yÄ±llar)
                if (artis > 0) {
                  const mevcutYil = yilBazliArtislar.find(y => y.yil === artisYili);
                  if (mevcutYil) {
                    mevcutYil.artisTutar += artis;
                    mevcutYil.artisYuzde += yuzdeArtis;
                    mevcutYil.sayi++;
                  } else {
                    yilBazliArtislar.push({
                      yil: artisYili,
                      artisTutar: artis,
                      artisYuzde: yuzdeArtis,
                      sayi: 1
                    });
                  }
                }
              }
              
              // YÄ±llÄ±k ortalamalarÄ± hesapla
              yilBazliArtislar.forEach(y => {
                if (y.sayi > 0) {
                  y.artisYuzde = y.artisYuzde / y.sayi;
                }
              });
              
              // Trend analizi: 2023â†’2024, 2024â†’2025, 2023â†’2025 karÅŸÄ±laÅŸtÄ±rmalarÄ±
              let trendAnalizi = '';
              const yillarSiralanmis = yilBazliArtislar.sort((a, b) => a.yil - b.yil);
              
              // YÄ±l bazlÄ± verileri bul
              const yil2023 = yillarSiralanmis.find(y => y.yil === 2023);
              const yil2024 = yillarSiralanmis.find(y => y.yil === 2024);
              const yil2025 = yillarSiralanmis.find(y => y.yil === 2025);
              
              // KarÅŸÄ±laÅŸtÄ±rma sonuÃ§larÄ±
              const karsilastirmalar = [];
              
              // 2023 â†’ 2024 karÅŸÄ±laÅŸtÄ±rmasÄ±
              if (yil2023 && yil2024) {
                const yuzdeFark = yil2024.artisYuzde - yil2023.artisYuzde;
                const tutarFark = yil2024.artisTutar - yil2023.artisTutar;
                karsilastirmalar.push({
                  donem: '2023â†’2024',
                  yuzdeFark,
                  tutarFark,
                  yuzdeDusus: yuzdeFark < 0,
                  tutarArtis: tutarFark > 0,
                  yuzdeArtis: yuzdeFark > 0,
                  tutarDusus: tutarFark < 0
                });
              }
              
              // 2024 â†’ 2025 karÅŸÄ±laÅŸtÄ±rmasÄ± (en Ã¶nemli)
              let karsilastirma2024_2025 = null;
              if (yil2024 && yil2025) {
                const yuzdeFark = yil2025.artisYuzde - yil2024.artisYuzde;
                const tutarFark = yil2025.artisTutar - yil2024.artisTutar;
                karsilastirma2024_2025 = {
                  donem: '2024â†’2025',
                  yuzdeFark,
                  tutarFark,
                  yuzdeDusus: yuzdeFark < 0,
                  tutarArtis: tutarFark > 0,
                  yuzdeArtis: yuzdeFark > 0,
                  tutarDusus: tutarFark < 0
                };
                karsilastirmalar.push(karsilastirma2024_2025);
              }
              
              // 2023 â†’ 2025 karÅŸÄ±laÅŸtÄ±rmasÄ±
              if (yil2023 && yil2025) {
                const yuzdeFark = yil2025.artisYuzde - yil2023.artisYuzde;
                const tutarFark = yil2025.artisTutar - yil2023.artisTutar;
                karsilastirmalar.push({
                  donem: '2023â†’2025',
                  yuzdeFark,
                  tutarFark,
                  yuzdeDusus: yuzdeFark < 0,
                  tutarArtis: tutarFark > 0,
                  yuzdeArtis: yuzdeFark > 0,
                  tutarDusus: tutarFark < 0
                });
              }
              
              // YÄ±l bilgileri
              const yilBilgileri = yillarSiralanmis
                .map(y => `${y.yil}: %${y.artisYuzde.toFixed(1)} (${y.artisTutar > 0 ? '+' : ''}${fmt(y.artisTutar)})`)
                .join(', ');
              
              // Analiz metni oluÅŸtur (2024â†’2025'e Ã¶ncelik ver)
              if (karsilastirma2024_2025) {
                const k = karsilastirma2024_2025;
                
                // 2024â†’2025 analizi (Ã¶ncelikli)
                if (k.yuzdeDusus && k.tutarArtis) {
                  trendAnalizi = `YÄ±llara gÃ¶re analiz: ${yilBilgileri}. Ã–NEMLÄ°: 2024â†’2025 dÃ¶neminde yÃ¼zde artÄ±ÅŸ oranÄ± %${Math.abs(k.yuzdeFark).toFixed(1)} azalmÄ±ÅŸ ancak tutar olarak ${fmt(k.tutarFark)} artÄ±ÅŸ gÃ¶rÃ¼lmÃ¼ÅŸtÃ¼r. Bu durum gÃ¶zden kaÃ§Ä±rÄ±lmamalÄ±dÄ±r. Genel trend: 2023â†’2024 ve 2023â†’2025 karÅŸÄ±laÅŸtÄ±rmalarÄ±nda da benzer bir seyir izlenmektedir. 2026 yÄ±lÄ± iÃ§in Ã¶nceden tedbir alÄ±nmasÄ± ve kurum bÃ¼tÃ§e planlamasÄ±na mutabÄ±k ÅŸekilde hareket edilmesi gerekmektedir.`;
                } else if (k.yuzdeDusus && k.tutarDusus) {
                  trendAnalizi = `YÄ±llara gÃ¶re analiz: ${yilBilgileri}. Ã–NEMLÄ°: 2024â†’2025 dÃ¶neminde hem yÃ¼zde (%) hem de tutar (â‚º) olarak dÃ¼ÅŸÃ¼ÅŸ gÃ¶rÃ¼lmÃ¼ÅŸtÃ¼r. Bu olumlu bir geliÅŸmedir. Genel trend: 2023â†’2024 ve 2023â†’2025 karÅŸÄ±laÅŸtÄ±rmalarÄ±nda da benzer bir seyir izlenmektedir. 2026 yÄ±lÄ±nda da benzer bir trend beklenmektedir.`;
                } else if (k.yuzdeArtis && k.tutarArtis) {
                  trendAnalizi = `YÄ±llara gÃ¶re analiz: ${yilBilgileri}. Ã–NEMLÄ°: 2024â†’2025 dÃ¶neminde hem yÃ¼zde (%) hem de tutar (â‚º) olarak artÄ±ÅŸ gÃ¶rÃ¼lmÃ¼ÅŸtÃ¼r. Genel trend: 2023â†’2024 ve 2023â†’2025 karÅŸÄ±laÅŸtÄ±rmalarÄ±nda da benzer bir seyir izlenmektedir. 2026 yÄ±lÄ± iÃ§in Ã¶nceden tedbir alÄ±nmasÄ± ve kurum bÃ¼tÃ§e planlamasÄ±na mutabÄ±k ÅŸekilde hareket edilmesi gerekmektedir.`;
                } else {
                  trendAnalizi = `YÄ±llara gÃ¶re analiz: ${yilBilgileri}. Ã–NEMLÄ°: 2024â†’2025 dÃ¶neminde karÄ±ÅŸÄ±k bir trend gÃ¶rÃ¼lmektedir. Genel trend: 2023â†’2024 ve 2023â†’2025 karÅŸÄ±laÅŸtÄ±rmalarÄ±nda da iniÅŸ-Ã§Ä±kÄ±ÅŸlar mevcuttur. 2026 yÄ±lÄ± iÃ§in Ã¶nceden tedbir alÄ±nmasÄ± ve kurum bÃ¼tÃ§e planlamasÄ±na mutabÄ±k ÅŸekilde hareket edilmesi gerekmektedir.`;
                }
              } else if (karsilastirmalar.length > 0) {
                // 2024â†’2025 yoksa diÄŸer karÅŸÄ±laÅŸtÄ±rmalara bak
                const k = karsilastirmalar[0];
                if (k.yuzdeDusus && k.tutarArtis) {
                  trendAnalizi = `YÄ±llara gÃ¶re analiz: ${yilBilgileri}. YÃ¼zde artÄ±ÅŸ oranÄ± azalmÄ±ÅŸ ancak tutar olarak artÄ±ÅŸ gÃ¶rÃ¼lmÃ¼ÅŸtÃ¼r. Bunu da gÃ¶zden kaÃ§Ä±rmamalÄ±yÄ±z. 2026 yÄ±lÄ± iÃ§in Ã¶nceden tedbir alÄ±nmasÄ± ve kurum bÃ¼tÃ§e planlamasÄ±na mutabÄ±k ÅŸekilde hareket edilmesi gerekmektedir.`;
                } else if (k.yuzdeDusus && k.tutarDusus) {
                  trendAnalizi = `YÄ±llara gÃ¶re analiz: ${yilBilgileri}. Bu personel kira artÄ±ÅŸlarÄ±nÄ± hem yÃ¼zde (%) hem de tutar (â‚º) olarak dÃ¼ÅŸÃ¼rmÃ¼ÅŸtÃ¼r. Bu olumlu bir geliÅŸmedir ve 2026 yÄ±lÄ±nda da benzer bir trend beklenmektedir.`;
                } else if (k.yuzdeArtis && k.tutarArtis) {
                  trendAnalizi = `YÄ±llara gÃ¶re analiz: ${yilBilgileri}. Bu personel kira artÄ±ÅŸlarÄ±nda hem yÃ¼zde (%) hem de tutar (â‚º) olarak artÄ±ÅŸ gÃ¶stermektedir. 2026 yÄ±lÄ± iÃ§in Ã¶nceden tedbir alÄ±nmasÄ± ve kurum bÃ¼tÃ§e planlamasÄ±na mutabÄ±k ÅŸekilde hareket edilmesi gerekmektedir.`;
                } else {
                  trendAnalizi = `YÄ±llara gÃ¶re analiz: ${yilBilgileri}. Bu personel kira artÄ±ÅŸlarÄ±nda iniÅŸ-Ã§Ä±kÄ±ÅŸlar gÃ¶rÃ¼lmektedir. 2026 yÄ±lÄ± iÃ§in Ã¶nceden tedbir alÄ±nmasÄ± ve kurum bÃ¼tÃ§e planlamasÄ±na mutabÄ±k ÅŸekilde hareket edilmesi gerekmektedir.`;
                }
              } else {
                trendAnalizi = `YÄ±llara gÃ¶re analiz: ${yilBilgileri}. ArtÄ±ÅŸ trendi stabil seyretmektedir.`;
              }
              
              // 2026 iÃ§in Ã¶neri hesapla (%30 artÄ±ÅŸ, yukarÄ± yuvarlama)
              const onerilenArtis = enSonTutar * 0.30;
              const onerilenTutar = Math.ceil(enSonTutar + onerilenArtis);
              
              // ArtÄ±ÅŸ yapÄ±lan aylarÄ± analiz et
              let artisAylariMetni = '';
              if (artisAylari.length > 0) {
                const aylarGruplu = {};
                artisAylari.forEach(a => {
                  const key = `${a.yil}-${a.ay}`;
                  if (!aylarGruplu[key]) {
                    aylarGruplu[key] = [];
                  }
                  aylarGruplu[key].push(a);
                });
                
                const aylarListesi = Object.values(aylarGruplu).map(grup => {
                  const ilk = grup[0];
                  return `${ilk.yil} ${ilk.ayIsim}`;
                });
                
                if (aylarListesi.length === 1) {
                  artisAylariMetni = `Bu personel kira artÄ±ÅŸÄ± ${aylarListesi[0]} ayÄ±nda oluyor.`;
                } else if (aylarListesi.length <= 3) {
                  artisAylariMetni = `Bu personel kira artÄ±ÅŸÄ± ${aylarListesi.slice(0, -1).join(', ')} ve ${aylarListesi[aylarListesi.length - 1]} aylarÄ±nda oluyor.`;
                } else {
                  artisAylariMetni = `Bu personel kira artÄ±ÅŸÄ± ${aylarListesi.slice(0, 2).join(', ')} ve diÄŸer aylarda oluyor (toplam ${aylarListesi.length} farklÄ± dÃ¶nem).`;
                }
              } else {
                artisAylariMetni = 'Bu personel iÃ§in henÃ¼z kira artÄ±ÅŸÄ± yapÄ±lmamÄ±ÅŸ.';
              }
              
              // En son artÄ±ÅŸ ayÄ±nÄ± bul
              let sonArtisAyi = '';
              if (artisAylari.length > 0) {
                const sonArtis = artisAylari[artisAylari.length - 1];
                sonArtisAyi = `${sonArtis.yil} ${sonArtis.ayIsim}`;
              }
              
              // 2026 Ã¶neri metni
              let oneriMetni = '';
              if (sonArtisAyi) {
                // Son artÄ±ÅŸ ayÄ±ndan sonraki yÄ±lÄ±n aynÄ± ayÄ±nÄ± Ã¶ner
                const sonArtisYil = artisAylari[artisAylari.length - 1].yil;
                const sonArtisAy = artisAylari[artisAylari.length - 1].ay;
                const onerilenYil = sonArtisYil + 1;
                const onerilenAyIsim = ayIsimleri[sonArtisAy];
                
                oneriMetni = `2026 ${onerilenAyIsim} ayÄ± iÃ§in Ã¶nerilen kira tutarÄ±: ${fmt(onerilenTutar)} (mevcut tutar ${fmt(enSonTutar)} Ã¼zerinden %30 artÄ±ÅŸ, yukarÄ± yuvarlanmÄ±ÅŸtÄ±r). Bu bilgi yÃ¶neticiye rehberlik eder; yÃ¶netici personeli buna gÃ¶re yÃ¶nlendirerek kira artÄ±ÅŸÄ±nÄ± minimize edebilir.`;
              } else {
                oneriMetni = `2026 yÄ±lÄ± iÃ§in Ã¶nerilen kira tutarÄ±: ${fmt(onerilenTutar)} (mevcut tutar ${fmt(enSonTutar)} Ã¼zerinden %30 artÄ±ÅŸ, yukarÄ± yuvarlanmÄ±ÅŸtÄ±r). Bu bilgi yÃ¶neticiye rehberlik eder; yÃ¶netici personeli buna gÃ¶re yÃ¶nlendirerek kira artÄ±ÅŸÄ±nÄ± minimize edebilir.`;
              }

              return `
                <div style="margin-bottom: 30px;">
                  <div style="font-weight: 700; font-size: 13px; margin-bottom: 10px; color: #2f4f30;">
                    ${personelAdi}
                  </div>
                  <div style="font-size: 11px; color: #333; margin-bottom: 12px; padding: 10px; background-color: #f8f9fa; border-left: 3px solid #2f4f30; line-height: 1.6;">
                    ${artisAylariMetni}
                  </div>
                  <div style="font-size: 11px; color: #333; margin-bottom: 12px; padding: 10px; background-color: #e8f5e9; border-left: 3px solid #16a34a; line-height: 1.6;">
                    ${trendAnalizi}
                  </div>
                  <table class="analiz-tablo">
                    <thead>
                      <tr>
                        <th>DÃ¶nem (Eski Tutar)</th>
                        <th>DÃ¶nem (Yeni Tutar)</th>
                        <th style="text-align: center;">ArtÄ±ÅŸ</th>
                      </tr>
                    </thead>
                    <tbody>
                      ${artisSatirlar.join('')}
                    </tbody>
                  </table>
                  <div style="font-size: 11px; color: #ea580c; margin-top: 12px; padding: 10px; background-color: #fff7ed; border-left: 3px solid #ea580c; line-height: 1.6; font-weight: 600;">
                    ğŸ’¡ ${oneriMetni}
                  </div>
                  ${siralamaAnalizi}
                </div>
              `;
            }).join('');

          document.getElementById('kiraArtisAnalizIcerik').innerHTML = kiraArtisHTML || '<div style="padding: 20px; text-align: center; color: #666;">Kira Ã¶demesi bulunamadÄ±</div>';
        }

        function hesaplaTipArtislari(yillar) {
          const yilListesi = Object.keys(yillar).map(y => parseInt(y)).sort();
          const artislar = [];
          
          for (let i = 1; i < yilListesi.length; i++) {
            const oncekiYil = yilListesi[i - 1];
            const simdikiYil = yilListesi[i];
            const oncekiOrtalama = yillar[oncekiYil].sayi > 0 ? yillar[oncekiYil].toplam / yillar[oncekiYil].sayi : 0;
            const simdikiOrtalama = yillar[simdikiYil].sayi > 0 ? yillar[simdikiYil].toplam / yillar[simdikiYil].sayi : 0;
            
            if (oncekiOrtalama > 0) {
              const yuzdeArtis = ((simdikiOrtalama - oncekiOrtalama) / oncekiOrtalama) * 100;
              artislar.push({
                yil: simdikiYil,
                yuzde: yuzdeArtis
              });
            }
          }
          
          return artislar;
        }

        // Detay tablosunu gizle/gÃ¶ster fonksiyonu
        window.toggleDetayTablo = function() {
          const tablo = document.getElementById('veriTablo');
          const buton = document.getElementById('detayTabloToggle');
          
          if (tablo.style.display === 'none') {
            tablo.style.display = 'table';
            buton.textContent = 'ğŸ“‹ Detay Tablosunu Gizle';
            buton.style.backgroundColor = '#2f4f30';
          } else {
            tablo.style.display = 'none';
            buton.textContent = 'ğŸ“‹ Detay Tablosunu GÃ¶ster';
            buton.style.backgroundColor = '#16a34a';
          }
        };

        yukleVeriler();
      });
    });

    function pdfCiktisiAl() {
      const element = document.getElementById("pdfAlani");
      if (!element) {
        alert("PDF alanÄ± bulunamadÄ±!");
        return;
      }

      const opt = {
        margin: [0.5, 0.5, 0.5, 0.5],
        filename: 'odeme-takvim-raporu.pdf',
        image: { type: 'png', quality: 0.98 },
        html2canvas: {
          scale: 2,
          useCORS: true,
          allowTaint: true,
          scrollX: 0,
          scrollY: 0,
          windowWidth: 800
        },
        jsPDF: {
          unit: 'in',
          format: 'a4',
          orientation: 'portrait'
        }
      };

      html2pdf().set(opt).from(element).save();
    }
  </script>
</body>
</html>
