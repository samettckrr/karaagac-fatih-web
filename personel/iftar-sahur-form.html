<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8" />
  <title>Ramazan Takip Sistemi</title>
  <meta name="viewport"
    content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover" />

  <meta name="theme-color" content="#324960">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="icon" type="image/png" href="../img/logo.png" />

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../src/supabase.js"></script>
  <!-- supabase-auth-wrapper kaldÄ±rÄ±ldÄ± (standalone sayfa doÄŸrudan supabase.auth kullanÄ±yor) -->
  <!-- ortak.js kaldÄ±rÄ±ldÄ± - sayfa standalone Ã§alÄ±ÅŸÄ±yor -->

  <style>
    :root {
      --primary: #324960;
      --accent: #e67e22;
      --success: #27ae60;
      --danger: #c0392b;
      --warning: #f39c12;
      --bg: #f0f2f5;
      --card: #ffffff;
      --text: #2c3e50;
      --border: #e9ecef;
      --nav-height: 65px;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
      padding-bottom: 80px;
    }

    /* --- HEADER --- */
    .hero-header {
      background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
      color: white;
      padding: 15px 20px 25px 20px;
      border-radius: 0 0 25px 25px;
      position: relative;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      margin-bottom: 10px;
    }

    .top-nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }

    /* Geri DÃ¶n Butonu */
    .back-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      background: rgba(255, 255, 255, 0.2);
      padding: 6px 12px;
      border-radius: 20px;
      color: white;
      text-decoration: none;
      font-size: 13px;
      font-weight: 600;
      transition: 0.2s;
      backdrop-filter: blur(4px);
    }

    .back-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .year-selector {
      background: rgba(255, 255, 255, 0.2);
      border: 1px solid rgba(255, 255, 255, 0.3);
      color: white;
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 12px;
      font-weight: 600;
      appearance: none;
      outline: none;
      cursor: pointer;
    }

    .year-selector option {
      color: #333;
    }


    /* --- LAYOUT CONTAINER --- */
    .main-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      margin-top: 10px;
    }

    /* Mahal planlama dikkat butonu */
    .mahal-planlama-btn-wrap {
      display: flex;
      justify-content: center;
    }
    .mahal-planlama-btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      border: 2px solid #c0392b;
      background: #e74c3c;
      color: #fff;
      border-radius: 10px;
      font-size: 14px;
      font-weight: 700;
      cursor: pointer;
      box-shadow: 0 3px 10px rgba(231, 76, 60, 0.4);
      transition: transform 0.15s, box-shadow 0.15s;
    }
    .mahal-planlama-btn:hover {
      background: #c0392b;
      transform: translateY(-2px);
      box-shadow: 0 4px 14px rgba(231, 76, 60, 0.5);
    }
    .mahal-planlama-btn:active {
      transform: translateY(0);
    }
    .mahal-planlama-emoji {
      font-size: 20px;
      line-height: 1;
    }
    .mahal-planlama-text {
      text-shadow: 0 1px 2px rgba(0,0,0,0.2);
    }

    /* Mahal planlama popup */
    .mahal-planlama-modal {
      align-items: center;
      justify-content: center;
      padding: 20px;
      background: rgba(0,0,0,0.7);
    }
    .mahal-planlama-modal:not(.open) {
      display: none;
    }
    .mahal-planlama-modal.open {
      display: flex;
    }
    .mahal-planlama-sheet {
      position: relative;
      max-width: 95vw;
      max-height: 90vh;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.3);
      overflow: auto;
      padding-top: 48px;
    }
    .mahal-planlama-close {
      position: absolute;
      top: 10px;
      right: 10px;
      width: 36px;
      height: 36px;
      border: none;
      background: rgba(0,0,0,0.6);
      color: #fff;
      font-size: 24px;
      line-height: 1;
      border-radius: 50%;
      cursor: pointer;
      z-index: 2;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 0;
      transition: background 0.2s;
    }
    .mahal-planlama-close:hover {
      background: #e74c3c;
    }
    .mahal-planlama-img {
      display: block;
      max-width: 100%;
      height: auto;
      border-radius: 0 0 12px 12px;
    }

    /* BoÅŸ Kamelya/GÃ¼n Tespiti butonu */
    .bos-kamelya-btn {
      background: #27ae60 !important;
      border-color: #219a52 !important;
      box-shadow: 0 3px 10px rgba(39, 174, 96, 0.4) !important;
    }
    .bos-kamelya-btn:hover {
      background: #219a52 !important;
      box-shadow: 0 4px 14px rgba(39, 174, 96, 0.5) !important;
    }

    /* GÃ¼n Analizi butonu */
    .gun-analizi-btn {
      background: #3498db !important;
      border-color: #2980b9 !important;
      box-shadow: 0 3px 10px rgba(52, 152, 219, 0.4) !important;
    }
    .gun-analizi-btn:hover {
      background: #2980b9 !important;
      box-shadow: 0 4px 14px rgba(52, 152, 219, 0.5) !important;
    }

    /* Hata Bildirimi butonu */
    .hata-bildirimi-btn {
      background: #9b59b6 !important;
      border-color: #8e44ad !important;
      box-shadow: 0 3px 10px rgba(155, 89, 182, 0.4) !important;
    }
    .hata-bildirimi-btn:hover {
      background: #8e44ad !important;
      box-shadow: 0 4px 14px rgba(155, 89, 182, 0.5) !important;
    }

    /* Mahal GÃ¶rÃ¼nÃ¼m butonu */
    .mahal-gorunum-btn {
      background: #27ae60 !important;
      border-color: #1e8449 !important;
      box-shadow: 0 3px 10px rgba(39, 174, 96, 0.4) !important;
    }
    .mahal-gorunum-btn:hover {
      background: #1e8449 !important;
      box-shadow: 0 4px 14px rgba(39, 174, 96, 0.5) !important;
    }

    /* BoÅŸ Kamelya Modal */
    .bos-kamelya-modal-sheet {
      max-width: 700px;
      padding: 24px;
    }
    .bos-kamelya-result-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-top: 16px;
    }
    @media (max-width: 600px) {
      .bos-kamelya-result-grid { grid-template-columns: 1fr; }
    }
    .bos-kamelya-col {
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
    }
    .bos-kamelya-col-title {
      padding: 10px 12px;
      font-weight: 600;
      font-size: 14px;
    }
    .bos-kamelya-col.bos .bos-kamelya-col-title { background: #e8f5e9; color: #2e7d32; }
    .bos-kamelya-col.dolu .bos-kamelya-col-title { background: #fff3e0; color: #e65100; }
    .bos-kamelya-list {
      max-height: 280px;
      overflow-y: auto;
      padding: 8px;
    }
    .bos-kamelya-date-item {
      padding: 8px 10px;
      margin-bottom: 6px;
      border-radius: 6px;
      font-size: 13px;
    }
    .bos-kamelya-date-item.bos { background: #f1f8e9; }
    .bos-kamelya-date-item.dolu { background: #fff8e1; }
    .bos-kamelya-personel {
      font-size: 11px;
      color: #666;
      margin-top: 4px;
      padding-left: 8px;
    }

    /* --- 1. MOBÄ°L GÃ–RÃœNÃœM (Timeline) --- */
    .timeline-view {
      display: block;
    }

    /* Mobilde varsayÄ±lan */
    .calendar-view {
      display: none;
    }

    /* Mobilde gizli */

    .day-card {
      background: var(--card);
      border-radius: 16px;
      margin-bottom: 12px;
      padding: 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
      border-left: 5px solid transparent;
      transition: transform 0.1s;
      cursor: pointer;
    }

    .day-card:active {
      transform: scale(0.98);
    }

    .status-green {
      border-left-color: var(--success);
    }

    .status-orange {
      border-left-color: var(--warning);
    }

    .status-red {
      border-left-color: var(--danger);
    }

    .day-card.day-card-today {
      border: 2px solid var(--accent, #3498db);
      box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.25);
      background: linear-gradient(135deg, var(--card) 0%, rgba(52, 152, 219, 0.08) 100%);
    }

    .day-separator {
      height: 1px;
      background: linear-gradient(90deg, transparent, rgba(44, 62, 80, 0.5) 20%, rgba(44, 62, 80, 0.5) 80%, transparent);
      margin: 16px 0;
    }

    .day-card.day-card-past {
      opacity: 0.7;
      filter: grayscale(0.3);
    }

    .dc-date {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 50px;
      border-right: 1px solid #eee;
      padding-right: 10px;
      margin-right: 10px;
    }

    .dc-day-num {
      font-size: 24px;
      font-weight: 800;
      line-height: 1;
    }

    .dc-day-name {
      font-size: 10px;
      text-transform: uppercase;
      color: #7f8c8d;
      font-weight: 600;
    }

    .dc-month {
      font-size: 10px;
      color: var(--accent);
      font-weight: 600;
      text-transform: capitalize;
      margin-top: 2px;
    }

    .dc-info {
      flex: 1;
    }

    .dc-ramazan {
      font-size: 11px;
      color: var(--accent);
      font-weight: 700;
      text-transform: uppercase;
    }

    .dc-status {
      font-size: 13px;
      font-weight: 600;
      color: #34495e;
    }

    .dc-musait-kamelya {
      font-size: 10px;
      margin-top: 6px;
      line-height: 1.4;
    }
    .dc-musait-kamelya .dc-musait-label {
      font-weight: 600;
      color: #2c3e50;
    }
    .dc-musait-kamelya .dc-kamelya-chip {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      margin: 1px 2px 1px 0;
      font-size: 9px;
      font-weight: 500;
    }

    .dc-action {
      font-size: 24px;
      color: var(--primary);
      font-weight: 300;
    }

    /* Mobil iÃ§in bilgilendirme modalÄ± kÃ¼Ã§Ã¼ltme */
    @media (max-width: 767px) {
      #infoModalSheet {
        max-width: 90% !important;
        margin: 20px auto;
      }

      #infoModalIcon {
        font-size: 36px !important;
        margin-bottom: 8px !important;
      }

      #infoModalTitle {
        font-size: 16px !important;
        margin-bottom: 8px !important;
      }

      #infoContent {
        font-size: 12px !important;
        margin-bottom: 15px !important;
      }

      #infoContent ul li {
        margin-bottom: 8px !important;
        font-size: 12px !important;
      }

      #infoContent ul li span:first-child {
        font-size: 16px !important;
      }

      #infoContent p {
        font-size: 11px !important;
      }
    }

    /* --- 2. MASAÃœSTÃœ GÃ–RÃœNÃœM (Responsive Grid) --- */
    @media (min-width: 768px) {

      /* Alt menÃ¼ tÃ¼m cihazlarda gÃ¶rÃ¼nsÃ¼n */
      body {
        padding-bottom: var(--nav-height);
      }

      /* Mobil gÃ¶rÃ¼nÃ¼mÃ¼ de gÃ¶ster */
      .timeline-view {
        display: block;
      }

      /* Mobil gÃ¶rÃ¼nÃ¼mÃ¼ de gÃ¶ster */
      .calendar-view {
        display: none;
      }

      /* MasaÃ¼stÃ¼ takvimi gizle */

      /* MasaÃ¼stÃ¼ Takvim KartÄ± */
      .cal-cell {
        background: white;
        border-radius: 12px;
        padding: 10px;
        min-height: 100px;
        border: 1px solid #e0e0e0;
        cursor: pointer;
        transition: 0.2s;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
      }

      .cal-cell:hover {
        transform: translateY(-3px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        border-color: var(--primary);
      }

      .cal-cell.empty {
        background: transparent;
        border: none;
        cursor: default;
      }

      .cc-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 5px;
      }

      .cc-num {
        font-weight: 800;
        font-size: 18px;
        color: #2c3e50;
      }

      .cc-header-right {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 1px;
      }

      .cc-day {
        font-size: 12px;
        color: #95a5a6;
      }

      .cc-month {
        font-size: 10px;
        color: var(--accent);
        font-weight: 600;
        text-transform: capitalize;
      }

      .cc-badges {
        display: flex;
        flex-direction: column;
        gap: 3px;
      }

      .cc-musait-kamelya {
        font-size: 9px;
        margin-top: 5px;
        line-height: 1.3;
      }
      .cc-musait-kamelya .cc-musait-label {
        font-weight: 600;
        color: #2c3e50;
      }
      .cc-musait-kamelya .cc-kamelya-chip {
        display: inline-block;
        padding: 1px 4px;
        border-radius: 3px;
        margin: 0 1px 1px 0;
        font-size: 8px;
        font-weight: 500;
      }

      .cc-badge {
        font-size: 11px;
        padding: 3px 6px;
        border-radius: 4px;
        color: white;
        text-align: center;
      }

      .cc-iftar {
        background: var(--accent);
      }

      .cc-sahur {
        background: #3498db;
      }

      .cc-full {
        opacity: 0.5;
        text-decoration: line-through;
      }

      .cal-cell.cal-green {
        border-left: 3px solid var(--success);
      }

      .cal-cell.cal-orange {
        border-left: 3px solid var(--warning);
      }

      .cal-cell.cal-red {
        border-left: 3px solid var(--danger);
      }
    }

    /* --- MODAL & FORM --- */
    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 2000;
      display: none;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(3px);
      padding: 20px;
    }

    .modal.open {
      display: flex;
    }

    .modal-sheet {
      background: #fff;
      width: 100%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
      border-radius: 20px;
      padding: 25px 20px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      animation: zoomIn 0.2s ease-out;
      margin: 20px;
    }

    @keyframes zoomIn {
      from {
        transform: scale(0.95);
        opacity: 0;
      }

      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    @keyframes slideUp {
      from {
        transform: translateY(20px);
        opacity: 0;
      }

      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    @keyframes slideDown {
      from {
        transform: translateY(0);
        opacity: 1;
      }

      to {
        transform: translateY(20px);
        opacity: 0;
      }
    }

    .form-label {
      font-size: 12px;
      font-weight: 600;
      color: #7f8c8d;
      margin-bottom: 6px;
      display: block;
    }

    .chip-group {
      display: flex;
      gap: 10px;
      overflow-x: auto;
      padding-bottom: 5px;
    }

    .chip {
      padding: 10px 16px;
      background: #f1f2f6;
      border-radius: 10px;
      border: 2px solid transparent;
      font-size: 14px;
      font-weight: 600;
      color: #2c3e50;
      white-space: nowrap;
      cursor: pointer;
    }

    .chip.selected {
      background: #e8f4fd;
      border-color: var(--primary);
      color: var(--primary);
    }

    .chip.disabled {
      opacity: 0.5;
      cursor: not-allowed !important;
    }

    .stepper {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .step-btn {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: #f1f2f6;
      border: none;
      font-size: 20px;
      font-weight: bold;
      color: var(--primary);
      cursor: pointer;
    }

    .step-val {
      font-size: 18px;
      font-weight: bold;
      width: 30px;
      text-align: center;
    }

    .step-val-input {
      font-size: 18px;
      font-weight: bold;
      width: 50px;
      text-align: center;
      border: none;
      background: transparent;
      color: inherit;
      outline: none;
      appearance: textfield;
      -moz-appearance: textfield;
    }
    .step-val-input::-webkit-outer-spin-button,
    .step-val-input::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    .step-val-input:focus {
      background: rgba(102, 126, 234, 0.1);
      border-radius: 6px;
    }

    .full-input {
      width: 100%;
      padding: 12px;
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      font-size: 15px;
      background: #f9f9f9;
    }

    .full-btn {
      width: 100%;
      padding: 15px;
      border-radius: 12px;
      border: none;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      margin-top: 10px;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-secondary {
      background: #f1f2f6;
      color: #7f8c8d;
    }

    /* BOTTOM NAV (Mobil Ä°Ã§in) */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: var(--nav-height);
      background: var(--card);
      box-shadow: 0 -2px 20px rgba(0, 0, 0, 0.05);
      display: flex;
      justify-content: space-around;
      align-items: center;
      z-index: 100;
      padding-bottom: env(safe-area-inset-bottom);
    }

    .nav-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: #95a5a6;
      font-size: 10px;
      font-weight: 600;
      gap: 4px;
      background: none;
      border: none;
      width: 100%;
      height: 100%;
    }

    .nav-btn.active {
      color: var(--primary);
    }

    .nav-btn svg {
      width: 24px;
      height: 24px;
      fill: currentColor;
    }
    
    /* Toast Container Styles (Standalone) */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 99999 !important;
      display: flex;
      flex-direction: column;
      gap: 10px;
      pointer-events: none;
      max-width: 400px;
    }
    
    .toast {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px 16px;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      display: flex;
      align-items: flex-start;
      gap: 12px;
      pointer-events: auto;
      opacity: 0;
      transform: translateX(100%);
      transition: opacity 0.3s ease, transform 0.3s ease;
      min-width: 300px;
      max-width: 420px;
    }
    
    .toast.show {
      opacity: 1;
      transform: translateX(0);
    }
    
    @keyframes toastSlideIn {
      from {
        opacity: 0;
        transform: translateX(100%);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    @keyframes toastSlideInImportant {
      from {
        opacity: 0;
        transform: translateX(100%) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateX(0) scale(1);
      }
    }
    
    .toast-icon {
      font-size: 20px;
      flex-shrink: 0;
    }
    
    .toast-content {
      flex: 1;
      min-width: 0;
    }
    
    .toast-title {
      font-weight: 600;
      font-size: 14px;
      margin-bottom: 4px;
      color: var(--text);
    }
    
    .toast-message {
      font-size: 13px;
      color: #666;
      line-height: 1.4;
    }
    
    .toast-close {
      background: none;
      border: none;
      font-size: 20px;
      color: #999;
      cursor: pointer;
      padding: 0;
      line-height: 1;
      flex-shrink: 0;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .toast-close:hover {
      color: var(--text);
    }
    
    .toast-success {
      border-left: 4px solid var(--success);
    }
    
    .toast-error {
      border-left: 4px solid var(--danger);
    }
    
    .toast-warning {
      border-left: 4px solid var(--warning);
    }
    
    .toast-info {
      border-left: 4px solid var(--primary);
    }
    
    @media (max-width: 480px) {
      .toast-container {
        right: 10px;
        left: 10px;
        max-width: none;
      }
    }
    
    /* UI/UX: Filtreleme ButonlarÄ± Stili */
    .filter-tab {
      padding: 8px 16px;
      border: 1px solid var(--border);
      background: var(--card);
      border-radius: 8px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text);
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .filter-tab:hover {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
    
    .filter-tab.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }
  </style>
</head>

<body>

  <div class="hero-header">
    <div class="top-nav">
      <a href="../panel.html" class="back-btn">
        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path d="M19 12H5M12 19l-7-7 7-7" />
        </svg>
        Panele DÃ¶n
      </a>

      <div style="display:flex; align-items:center; gap:10px;">
        <select id="selYil" class="year-selector">
          <option value="">YÄ±l...</option>
        </select>
        <div id="userBadge" onclick="openUserSwitchModal()" style="display:none; background:rgba(255,255,255,0.25); backdrop-filter:blur(8px); border:1px solid rgba(255,255,255,0.3); border-radius:20px; padding:6px 14px; color:white; font-size:13px; font-weight:600; align-items:center; gap:8px; cursor:pointer; transition:all 0.2s;">
          <span style="font-size:16px;">ğŸ‘¤</span>
          <span id="userNameDisplay">YÃ¼kleniyor...</span>
          <span id="userSwitchIcon" style="display:none; font-size:12px; margin-left:4px;">ğŸ”„</span>
        </div>
      </div>
    </div>

    <div style="text-align:center; margin-top:10px;">
      <div style="font-size:18px; font-weight:600; opacity:0.9;">Ramazan-Ä± Åerif</div>
    </div>
  </div>

  <div class="main-container" style="display:none;">

    <div class="mahal-planlama-btn-wrap" style="margin-bottom:12px; display:flex; flex-wrap:wrap; gap:10px; align-items:center;">
      <button type="button" id="btnMahalPlanlama" class="mahal-planlama-btn" onclick="openMahalPlanlamaPopup()" title="Mahal planlama gÃ¶rseli">
        <span class="mahal-planlama-emoji">âš ï¸</span>
        <span class="mahal-planlama-text">Mahal PlanlamasÄ±</span>
      </button>
      <button type="button" class="mahal-planlama-btn" onclick="openTabloGor()" title="Personele Ã¶zel Ramazan tablosu (A4 yatay)">
        <span class="mahal-planlama-emoji">ğŸ“‹</span>
        <span class="mahal-planlama-text">Tablo GÃ¶r</span>
      </button>
      <button type="button" class="mahal-planlama-btn bos-kamelya-btn" onclick="openBosKamelyaModal()" title="SeÃ§ilen kamelya iÃ§in boÅŸ ve dolu gÃ¼nleri gÃ¶sterir">
        <span class="mahal-planlama-emoji">ğŸ›ï¸</span>
        <span class="mahal-planlama-text">BoÅŸ Kamelya Tespiti</span>
      </button>
      <button type="button" class="mahal-planlama-btn gun-analizi-btn" onclick="openGunAnaliziModal()" title="Tarih ve tipe gÃ¶re gÃ¼n analizi raporu">
        <span class="mahal-planlama-emoji">ğŸ“Š</span>
        <span class="mahal-planlama-text">GÃ¼n Analizi</span>
      </button>
      <button type="button" class="mahal-planlama-btn hata-bildirimi-btn" onclick="openHataBildirimiModal()" title="Hata veya sorun bildirimi gÃ¶nder">
        <span class="mahal-planlama-emoji">ğŸ› ï¸</span>
        <span class="mahal-planlama-text">Hata Bildir</span>
      </button>
      <button type="button" class="mahal-planlama-btn mahal-gorunum-btn" onclick="window.open('../sablonlar/mahal.html', '_blank')" title="Mahal gÃ¶rÃ¼nÃ¼mÃ¼nÃ¼ yeni sekmede aÃ§">
        <span class="mahal-planlama-emoji">ğŸ </span>
        <span class="mahal-planlama-text">Mahal GÃ¶rÃ¼nÃ¼m</span>
      </button>
    </div>

    <div id="mobileView" class="timeline-view">
      <div style="text-align:center; padding:20px; color:#999">YÃ¼kleniyor...</div>
    </div>

    <div id="desktopView" class="calendar-view">
    </div>

  </div>

  <!-- Mahal planlama gÃ¶rseli popup -->
  <div id="mahalPlanlamaModal" class="modal mahal-planlama-modal" onclick="closeMahalPlanlamaPopupOnOverlay(event)">
    <div class="mahal-planlama-sheet" onclick="event.stopPropagation()">
      <button type="button" class="mahal-planlama-close" onclick="closeMahalPlanlamaPopup()" title="Kapat">&times;</button>
      <img id="mahalPlanlamaImg" src="../img/mahalplanlama.jpeg" alt="Mahal planlama" class="mahal-planlama-img" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
      <div id="mahalPlanlamaFallback" style="display:none; padding:20px; text-align:center; color:#666;">GÃ¶rsel yÃ¼klenemedi. (img/mahalplanlama.jpeg)</div>
    </div>
  </div>

  <!-- BoÅŸ Kamelya/GÃ¼n Tespiti ModalÄ± -->
  <div id="bosKamelyaModal" class="modal" onclick="if(event.target === this) closeBosKamelyaModal()">
    <div class="modal-sheet bos-kamelya-modal-sheet" onclick="event.stopPropagation()">
      <h3 style="margin:0 0 16px 0; font-size:18px; font-weight:600;">ğŸ›ï¸ BoÅŸ Kamelya/GÃ¼n Tespiti</h3>
      <p style="margin:0 0 12px 0; font-size:13px; color:#666;">Bir kamelya (mahal) seÃ§in ve sorgulayÄ±n. Solda boÅŸ gÃ¼nler, saÄŸda dolu gÃ¼nler gÃ¶sterilir.</p>
      <label class="form-label" style="font-size:12px;">Kamelya SeÃ§in</label>
      <div class="chip-group" id="bosKamelyaMahalChips" style="flex-wrap:wrap; margin-bottom:12px;"></div>
      <input type="hidden" id="bosKamelyaSelectedMahal">
      <button type="button" class="full-btn btn-primary" onclick="sorgulaBosKamelya()" style="margin-bottom:16px;">Sorgula</button>
      <div id="bosKamelyaResult" style="display:none;">
        <div class="bos-kamelya-result-grid">
          <div class="bos-kamelya-col bos">
            <div class="bos-kamelya-col-title">ğŸ“… BoÅŸ GÃ¼nler</div>
            <div id="bosKamelyaBosList" class="bos-kamelya-list"></div>
          </div>
          <div class="bos-kamelya-col dolu">
            <div class="bos-kamelya-col-title">âœ… Dolu GÃ¼nler (Personel)</div>
            <div id="bosKamelyaDoluList" class="bos-kamelya-list"></div>
          </div>
        </div>
      </div>
      <div style="display:flex; gap:10px; margin-top:16px;">
        <button type="button" class="full-btn btn-secondary" onclick="closeBosKamelyaModal()" style="flex:1;">Kapat</button>
      </div>
    </div>
  </div>

  <!-- GÃ¼n Analizi ModalÄ± -->
  <div id="gunAnaliziModal" class="modal" onclick="if(event.target === this) closeGunAnaliziModal()">
    <div class="modal-sheet" style="max-width:800px; max-height:90vh; overflow-y:auto;" onclick="event.stopPropagation()">
      <h3 style="margin:0 0 16px 0; font-size:18px; font-weight:600;">ğŸ“Š GÃ¼n Analizi</h3>
      <p style="margin:0 0 12px 0; font-size:13px; color:#666;">Tarih ve tip seÃ§erek KPI ve detay raporu alabilirsiniz.</p>
      <div style="display:flex; flex-wrap:wrap; gap:16px; align-items:flex-end; margin-bottom:16px;">
        <div class="form-group" style="margin:0;">
          <label class="form-label" style="font-size:12px;">Tarih</label>
          <select id="gunAnaliziTarih" class="full-input" style="min-width:180px;">
            <option value="">Tarih seÃ§in</option>
          </select>
        </div>
        <div class="form-group" style="margin:0;">
          <label class="form-label" style="font-size:12px;">Tip</label>
          <div class="chip-group" id="gunAnaliziTipChips" style="flex-wrap:wrap;">
            <div class="chip selected" onclick="selectGunAnaliziTip('iftar', this)">ğŸŒ™ Ä°ftar</div>
            <div class="chip" onclick="selectGunAnaliziTip('sahur', this)">ğŸŒŸ Sahur</div>
          </div>
          <input type="hidden" id="gunAnaliziTip" value="iftar">
        </div>
        <button type="button" class="full-btn btn-primary" onclick="sorgulaGunAnalizi()">Sorgula</button>
      </div>
      <div id="gunAnaliziResult" style="display:none;">
        <div id="gunAnaliziKpi" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(140px, 1fr)); gap:12px; margin-bottom:20px;"></div>
        <div style="overflow-x:auto;">
          <table class="gun-analizi-table" style="width:100%; border-collapse:collapse; font-size:13px;">
            <thead>
              <tr style="background:#f5f5f5; border-bottom:2px solid var(--border);">
                <th style="padding:10px; text-align:left;">Kamelya</th>
                <th id="gunAnaliziSahipTh" style="padding:10px; text-align:left;">Ä°ftar Sahibi</th>
                <th style="padding:10px; text-align:center;">MÃ¼safir</th>
                <th style="padding:10px; text-align:left;">Personel</th>
                <th style="padding:10px; text-align:right;">Tutar</th>
                <th style="padding:10px; text-align:right;">Tahsilat</th>
              </tr>
            </thead>
            <tbody id="gunAnaliziTableBody"></tbody>
          </table>
        </div>
      </div>
      <div style="display:flex; gap:10px; margin-top:16px;">
        <button type="button" class="full-btn btn-secondary" onclick="closeGunAnaliziModal()" style="flex:1;">Kapat</button>
      </div>
    </div>
  </div>

  <!-- Hata Bildirimi ModalÄ± -->
  <div id="hataBildirimiModal" class="modal" onclick="if(event.target === this) closeHataBildirimiModal()">
    <div class="modal-sheet" style="max-width:500px;" onclick="event.stopPropagation()">
      <h3 style="margin:0 0 12px 0; font-size:18px; font-weight:600;">ğŸ› Hata Bildirimi</h3>
      <p style="margin:0 0 16px 0; font-size:13px; color:#666;">KarÅŸÄ±laÅŸtÄ±ÄŸÄ±nÄ±z hata veya sorunu detaylÄ± olarak aÃ§Ä±klayÄ±n.</p>
      <div class="form-group">
        <label class="form-label">AÃ§Ä±klama (detaylÄ±)</label>
        <textarea id="hataBildirimiAciklama" class="full-input" rows="5" placeholder="Hata veya sorunu mÃ¼mkÃ¼n olduÄŸunca detaylÄ± aÃ§Ä±klayÄ±n... (Ã¶r: hangi sayfada, ne yaptÄ±nÄ±z, ne oldu)"></textarea>
        <div id="hataBildirimiError" style="display:none; color:var(--danger); font-size:12px; margin-top:4px;"></div>
      </div>
      <div style="display:flex; gap:10px; margin-top:16px;">
        <button type="button" class="full-btn btn-secondary" onclick="closeHataBildirimiModal()" style="flex:1;">Ä°ptal</button>
        <button type="button" class="full-btn btn-primary" onclick="gonderHataBildirimi()" style="flex:1;">GÃ¶nder</button>
      </div>
    </div>
  </div>

  <!-- GÃ¼n KayÄ±tlarÄ± Ã–nizleme ModalÄ± -->
  <div id="dayRecordsModal" class="modal">
    <div class="modal-sheet" style="max-width:600px;">
      <h3 style="margin:0 0 15px 0; font-size:18px; font-weight:600;">GÃ¼n KayÄ±tlarÄ±</h3>
      <div id="dayRecordsContent" style="max-height:60vh; overflow-y:auto; margin-bottom:15px;"></div>
      <div style="display:flex; gap:10px;">
        <button type="button" id="btnDayRecordsAddNew" class="full-btn btn-primary" onclick="openFormModalFromDay()" style="flex:1;">+ Yeni KayÄ±t
          Ekle</button>
        <button type="button" class="full-btn btn-secondary" onclick="closeDayRecordsModal()"
          style="flex:1;">Kapat</button>
      </div>
    </div>
  </div>

  <div id="formModal" class="modal">
    <div class="modal-sheet">
      <h3 style="margin:0 0 12px 0; font-size:16px; font-weight:600;">Yeni KayÄ±t</h3>
      <form id="smartForm">
        <input type="hidden" id="fDate">

        <div id="fDateDisplay"
          style="font-size:12px; margin-bottom:10px; color:var(--primary); text-align:center; padding:6px; border-radius:6px; background:#f8f9fa;">
        </div>

        <label class="form-label" style="margin-top:0; font-size:12px;">KayÄ±t Tipi</label>
        <div class="chip-group" id="typeChips">
          <div class="chip selected" onclick="selectChip('type', 'iftar', this)">ğŸŒ™ Ä°ftar</div>
          <div class="chip" onclick="selectChip('type', 'sahur', this)">ğŸŒŸ Sahur</div>
        </div>
        <input type="hidden" id="fType" value="iftar">

        <label class="form-label" style="margin-top:10px; font-size:12px;">Tutar</label>
        <div class="chip-group" id="priceChips">
          <div class="chip">YÃ¼kleniyor...</div>
        </div>
        <input type="hidden" id="fPrice">

        <label class="form-label" style="margin-top:10px; font-size:12px;">Ä°ftar Sahibi</label>
        <input type="text" id="fName" class="full-input" placeholder="Ad Soyad" required
          style="font-size:14px; padding:10px;">

        <label class="form-label" style="margin-top:10px; font-size:12px;">Ä°ÅŸtirak</label>
        <div class="chip-group" id="istirakChips">
          <div class="chip selected" onclick="selectChip('istirak', true, this)">âœ“ Evet</div>
          <div class="chip" onclick="selectChip('istirak', false, this)">âœ— HayÄ±r</div>
        </div>
        <input type="hidden" id="fIstirak" value="true">

        <div id="istirakEvetFields">
          <label class="form-label" style="margin-top:10px; font-size:12px;">MÃ¼safir</label>
          <div class="stepper">
            <button type="button" class="step-btn" onclick="stepGuest(-1)">-</button>
            <input type="number" class="step-val-input" id="fGuestVal" value="0" min="0" max="999" 
              onchange="updateGuestFromInput(this.value)" 
              onfocus="this.select()"
              onkeydown="if(event.key==='Enter'){this.blur();}"
            >
            <button type="button" class="step-btn" onclick="stepGuest(1)">+</button>
          </div>
          <input type="hidden" id="fGuest" value="0">

          <label class="form-label" style="margin-top:10px; font-size:12px;">Mahal</label>
          <div class="chip-group" id="mahalChips" style="flex-wrap:wrap;">
            <div class="chip">YÃ¼kleniyor...</div>
          </div>
          <input type="hidden" id="fMahal">
        </div>

        <label class="form-label" style="margin-top:10px; font-size:12px;">Not</label>
        <input type="text" id="fNote" class="full-input" placeholder="Ä°steÄŸe baÄŸlÄ±"
          style="font-size:14px; padding:10px;">

        <div style="display:flex; gap:10px; margin-top:15px;">
          <button type="submit" class="full-btn btn-primary" style="flex:1;">Ã–NÄ°ZLE</button>
          <button type="button" class="full-btn btn-secondary" onclick="closeModal()" style="flex:1;">Ä°ptal</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Ã–nizleme ModalÄ± -->
  <div id="previewModal" class="modal">
    <div class="modal-sheet">
      <h3 style="margin:0 0 20px 0; font-size:20px;">KayÄ±t Ã–nizleme</h3>
      <div id="previewContent" style="background:#f9f9f9; padding:15px; border-radius:10px; margin-bottom:20px;"></div>
      <button type="button" class="full-btn btn-primary" onclick="confirmSave()">KAYDET</button>
      <button type="button" class="full-btn btn-secondary" onclick="closePreviewModal()">Geri DÃ¶n</button>
    </div>
  </div>

  <!-- DÃ¼zenleme Talep ModalÄ± -->
  <div id="editRequestModal" class="modal">
    <div class="modal-sheet" style="max-width:500px;">
      <h3 style="margin:0 0 15px 0; font-size:18px; font-weight:600;">DÃ¼zenleme Talebi</h3>
      <form id="editRequestForm">
        <input type="hidden" id="editRequestRecordId">
        <input type="hidden" id="editRequestKayitTipi">

        <div id="editRequestDateDisplay"
          style="font-size:14px; margin-bottom:12px; color:var(--primary); text-align:center; padding:8px; border-radius:6px; background:#f8f9fa;">
        </div>

        <label class="form-label" style="margin-top:0;">Talep TÃ¼rÃ¼</label>
        <div class="chip-group" style="margin-bottom:15px;">
          <div class="chip selected" onclick="selectEditRequestType('duzenle', this)">âœï¸ DÃ¼zenle</div>
          <div class="chip" onclick="selectEditRequestType('yer_degistir', this)">ğŸ”„ Yer DeÄŸiÅŸtir</div>
          <div class="chip" onclick="selectEditRequestType('mahal_degistir', this)">ğŸ›ï¸ Mahal DeÄŸiÅŸtir</div>
          <div class="chip" onclick="selectEditRequestType('musafir_degistir', this)">ğŸ‘¥ MÃ¼safir Adedi DeÄŸiÅŸtir</div>
          <div class="chip" onclick="selectEditRequestType('sil', this)">ğŸ—‘ï¸ Sil</div>
        </div>
        <input type="hidden" id="editRequestType" value="duzenle">

        <!-- Yer DeÄŸiÅŸtir iÃ§in tarih ve mahal seÃ§imi -->
        <div id="editRequestDateSelect" style="display:none; margin-bottom:15px;">
          <label class="form-label">Yeni Tarih SeÃ§iniz</label>
          <input type="date" id="editRequestNewDate" class="full-input" style="margin-bottom:10px;">

          <label class="form-label" style="margin-top:10px;">Yeni Mahal SeÃ§iniz (Opsiyonel)</label>
          <div class="chip-group" id="editRequestMahalChips" style="flex-wrap:wrap; margin-bottom:10px;">
            <div class="chip">YÃ¼kleniyor...</div>
          </div>
          <input type="hidden" id="editRequestNewMahal">

          <div id="editRequestMahalWarning"
            style="display:none; padding:10px; background:#fff3cd; border-left:3px solid #ffc107; border-radius:6px; margin-top:10px; font-size:13px;">
            <strong>âš ï¸ UyarÄ±:</strong> <span id="editRequestMahalWarningText"></span>
          </div>
        </div>

        <!-- Mahal DeÄŸiÅŸtir iÃ§in mahal seÃ§imi -->
        <div id="editRequestMahalSelect" style="display:none; margin-bottom:15px;">
          <label class="form-label">Yeni Mahal SeÃ§iniz</label>
          <div class="chip-group" id="editRequestMahalOnlyChips" style="flex-wrap:wrap; margin-bottom:10px;">
            <div class="chip">YÃ¼kleniyor...</div>
          </div>
          <input type="hidden" id="editRequestNewMahalOnly">

          <div id="editRequestMahalOnlyWarning"
            style="display:none; padding:10px; background:#fff3cd; border-left:3px solid #ffc107; border-radius:6px; margin-top:10px; font-size:13px;">
            <strong>âš ï¸ UyarÄ±:</strong> <span id="editRequestMahalOnlyWarningText"></span>
          </div>
        </div>

        <!-- MÃ¼safir Adedi DeÄŸiÅŸtir iÃ§in input -->
        <div id="editRequestMusafirSelect" style="display:none; margin-bottom:15px;">
          <label class="form-label">Yeni MÃ¼safir Adedi</label>
          <div class="stepper">
            <button type="button" class="step-btn" onclick="stepEditMusafir(-1)">-</button>
            <span class="step-val" id="editRequestMusafirVal">0</span>
            <button type="button" class="step-btn" onclick="stepEditMusafir(1)">+</button>
          </div>
          <input type="hidden" id="editRequestNewMusafir" value="0">

          <div id="editRequestMusafirMahalWrap" style="display:none; margin-top:12px;">
            <label class="form-label">Mahal SeÃ§iniz (Ä°ÅŸtirak iÃ§in zorunlu)</label>
            <div class="chip-group" id="editRequestMusafirMahalChips" style="flex-wrap:wrap; margin-bottom:8px;"></div>
            <input type="hidden" id="editRequestNewMahalForMusafir">
          </div>

          <div id="editRequestMusafirWarning"
            style="display:none; padding:10px; background:#fff3cd; border-left:3px solid #ffc107; border-radius:6px; margin-top:10px; font-size:13px;">
            <strong>âš ï¸ UyarÄ±:</strong> <span id="editRequestMusafirWarningText"></span>
          </div>
        </div>

        <label class="form-label">AÃ§Ä±klama</label>
        <textarea id="editRequestAciklama" class="full-input" rows="4"
          placeholder="Yapmak istediÄŸiniz deÄŸiÅŸiklikleri detaylÄ± olarak aÃ§Ä±klayÄ±nÄ±z..."
          style="resize:vertical; min-height:80px;"></textarea>

        <div style="display:flex; gap:10px; margin-top:15px;">
          <button type="submit" class="full-btn btn-primary" style="flex:1;">Kaydet ve Kapat</button>
          <button type="button" class="full-btn btn-secondary" onclick="closeEditRequestModal()"
            style="flex:1;">Ä°ptal</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Bilgilendirme ModalÄ± -->
  <div id="infoModal" class="modal">
    <div class="modal-sheet" style="max-width:500px;" id="infoModalSheet">
      <div style="text-align:center; margin-bottom:20px;" id="infoModalHeader">
        <div style="font-size:48px; margin-bottom:10px;" id="infoModalIcon">ğŸŒ™</div>
        <h3 style="margin:0 0 10px 0; font-size:20px; color:var(--primary);" id="infoModalTitle">Ä°ftar-Sahur Takip
          Sistemi</h3>
      </div>
      <div id="infoContent" style="line-height:1.6; color:#555; margin-bottom:20px; font-size:14px;">
        <p style="margin-bottom:15px; font-weight:600; color:var(--primary);">Bu sistemde neler yapabilirsiniz?</p>
        <div style="background:#f8f9fa; padding:15px; border-radius:10px; margin-bottom:15px;">
          <ul style="text-align:left; padding-left:20px; margin:0; list-style:none;">
            <li style="margin-bottom:10px; display:flex; align-items:start; gap:8px;">
              <span style="font-size:18px;">ğŸ“</span>
              <span><strong>Ä°ftar-Sahur kayÄ±tlarÄ±nÄ±zÄ±</strong> kolayca yapabilirsiniz</span>
            </li>
            <li style="margin-bottom:10px; display:flex; align-items:start; gap:8px;">
              <span style="font-size:18px;">ğŸ‘ï¸</span>
              <span><strong>KayÄ±tlarÄ±nÄ±zÄ± gÃ¶rÃ¼ntÃ¼leyebilir</strong> ve yÃ¶netebilirsiniz</span>
            </li>
            <li style="margin-bottom:10px; display:flex; align-items:start; gap:8px;">
              <span style="font-size:18px;">ğŸ“Š</span>
              <span><strong>MÃ¼sait, dolmak Ã¼zere ve dolu gÃ¼nleri</strong> gÃ¶rebilirsiniz</span>
            </li>
            <li style="margin-bottom:10px; display:flex; align-items:start; gap:8px;">
              <span style="font-size:18px;">ğŸ“…</span>
              <span><strong>KayÄ±tlarÄ±m</strong> bÃ¶lÃ¼mÃ¼nden kendi kayÄ±tlarÄ±nÄ±zÄ± takip edebilirsiniz</span>
            </li>
            <li style="margin-bottom:10px; display:flex; align-items:start; gap:8px;">
              <span style="font-size:18px;">âœï¸</span>
              <span>KayÄ±tlarÄ±nÄ±zÄ± <strong>dÃ¼zenleyebilir</strong> veya <strong>silebilirsiniz</strong></span>
            </li>
            <li style="margin-bottom:10px; display:flex; align-items:start; gap:8px;">
              <span style="font-size:18px;">ğŸ›ï¸</span>
              <span><strong>Mahal seÃ§imi</strong> ile mÃ¼safir sayÄ±sÄ±na uygun yer seÃ§ebilirsiniz</span>
            </li>
            <li style="margin-bottom:10px; display:flex; align-items:start; gap:8px;">
              <span style="font-size:18px;">ğŸ’°</span>
              <span><strong>Teberru, TaahhÃ¼t, Tahsilat</strong> giriÅŸi yapabilirsiniz</span>
            </li>
            <li style="margin-bottom:10px; display:flex; align-items:start; gap:8px;">
              <span style="font-size:18px;">ğŸ“Š</span>
              <span><strong>Analiz</strong> ile iftar-sahur-teberru-taahhÃ¼t-tahsilatlarÄ±nÄ±zÄ± analiz edebilirsiniz</span>
            </li>
          </ul>
        </div>
        <div style="background:#e8f4fd; padding:12px; border-radius:8px; border-left:3px solid var(--primary);">
          <p style="margin:0; font-size:13px; color:var(--primary); font-weight:600;">
            ğŸ’¡ Ä°pucu: GÃ¼nlere tÄ±klayarak o gÃ¼nÃ¼n kayÄ±tlarÄ±nÄ± gÃ¶rebilir ve yeni kayÄ±t ekleyebilirsiniz.
          </p>
        </div>
      </div>
      <div style="display:flex; gap:10px;">
        <button type="button" class="full-btn btn-primary" onclick="closeInfoModal()" style="flex:1;">AnladÄ±m</button>
      </div>
    </div>
  </div>

  <style>
    /* Mobil cihazlarda bilgilendirme modalÄ±nÄ± kÃ¼Ã§Ã¼lt */
    @media (max-width: 767px) {
      #infoModalSheet {
        max-width: 90% !important;
        padding: 15px !important;
      }

      #infoModalHeader {
        margin-bottom: 15px !important;
      }

      #infoModalIcon {
        font-size: 36px !important;
        margin-bottom: 8px !important;
      }

      #infoModalTitle {
        font-size: 16px !important;
        margin-bottom: 8px !important;
      }

      #infoContent {
        font-size: 12px !important;
        margin-bottom: 15px !important;
      }

      #infoContent p {
        font-size: 13px !important;
        margin-bottom: 10px !important;
      }

      #infoContent ul li {
        margin-bottom: 8px !important;
        font-size: 12px !important;
      }

      #infoContent ul li span:first-child {
        font-size: 16px !important;
      }

      #infoContent>div {
        padding: 12px !important;
        margin-bottom: 12px !important;
      }

      #infoContent>div:last-child {
        padding: 10px !important;
      }

      #infoContent>div:last-child p {
        font-size: 11px !important;
      }
    }
  </style>

  <!-- GÃ¼ncelleme Bildirimi ModalÄ± -->
  <div id="updateModal" class="modal" onclick="if(event.target === this) closeUpdateModal()">
    <div class="modal-sheet" style="max-width:500px;" onclick="event.stopPropagation()">
      <div style="text-align:center; margin-bottom:20px;">
        <div style="font-size:48px; margin-bottom:10px;">âš ï¸ ğŸ“‹</div>
        <h3 style="margin:0 0 10px 0; font-size:20px; color:var(--warning);">HatÄ±rlatma</h3>
      </div>
      <div id="updateModalContent" style="line-height:1.6; color:#555; margin-bottom:20px; font-size:14px;">
        <ul style="margin:0; padding-left:20px; text-align:left;">
          <li style="margin-bottom:10px;"><strong>MÃ¼safir Adetleri:</strong> Geciktirmeden (sistem kapanmadan) kontrol edip teyit edelim. <strong style="color:var(--danger);">Bir gÃ¼n Ã¶ncesi saat 17:00'dan sonra</strong> kayÄ±t eklenemez veya dÃ¼zenlenemez.</li>
          <li style="margin-bottom:10px;"><strong>Tahsilat Takibi:</strong> Ä°ftar-sahur tahsilatlarÄ±mÄ±zÄ±n takibini yapmayÄ± unutmayalÄ±m.</li>
          <li style="margin-bottom:10px;"><strong>GÃ¼nlÃ¼k Tahsilat:</strong> Her gÃ¼n tahsilat yapÄ±lmasÄ±, yapÄ±lamama durumunda takip edilmesi gerekmektedir.</li>
          <li style="margin-bottom:10px;"><strong>Hedef:</strong> Ramazan-Ä± Åerif sonuna kadar <strong style="color:var(--danger);">%50 tahsilat</strong> arzu edilmektedir.</li>
        </ul>
      </div>
      <div style="display:flex; gap:10px;">
        <button type="button" class="full-btn btn-primary" onclick="closeUpdateModal()" style="flex:1;">Tamam</button>
      </div>
    </div>
  </div>

  <!-- Bildirim ModalÄ± -->
  <div id="alertModal" class="modal">
    <div class="modal-sheet" style="max-width:400px;">
      <div id="alertContent" style="margin-bottom:20px; text-align:center;"></div>
      <button type="button" class="full-btn btn-primary" onclick="closeAlertModal()">Tamam</button>
    </div>
  </div>

  <!-- Onay ModalÄ± -->
  <div id="confirmModal" class="modal">
    <div class="modal-sheet" style="max-width:400px;">
      <div id="confirmContent" style="margin-bottom:20px; text-align:center;"></div>
      <div style="display:flex; gap:10px;">
        <button type="button" class="full-btn btn-primary" onclick="confirmYes()" style="flex:1;">Evet</button>
        <button type="button" class="full-btn btn-secondary" onclick="closeConfirmModal()"
          style="flex:1;">HayÄ±r</button>
      </div>
    </div>
  </div>

  <!-- Toast Bildirim Container -->
  <div id="toastContainer"
    style="position:fixed; bottom:80px; left:50%; transform:translateX(-50%); z-index:3000; display:flex; flex-direction:column; gap:10px; max-width:90%; pointer-events:none;">
  </div>

  <!-- MenÃ¼ GÃ¶rÃ¼nÃ¼mÃ¼ -->
  <div id="menuView" style="display:none;">
    <div class="main-container">
      <h3 style="padding:20px 20px 10px; margin:0; font-size:18px; color:var(--primary);">ğŸ½ï¸ MenÃ¼ler</h3>
      <div id="menuDaysList" style="padding:0 20px 20px;">
        <div style="text-align:center; padding:20px; color:#999">YÃ¼kleniyor...</div>
      </div>
    </div>
  </div>

  <!-- MenÃ¼ Detay ModalÄ± -->
  <div id="menuDetailModal" class="modal" onclick="if(event.target === this) closeMenuDetailModal()">
    <div class="modal-sheet" style="max-width:600px; max-height:90vh; overflow-y:auto;"
      onclick="event.stopPropagation()">
      <h3 style="margin:0 0 20px 0; font-size:20px; font-weight:600; color:var(--primary); text-align:center;"
        id="menuDetailTitle">ğŸ½ï¸ MenÃ¼</h3>
      <div id="menuDetailContent"></div>
      <div style="display:flex; gap:10px; margin-top:20px;">
        <button type="button" class="full-btn btn-primary" onclick="closeMenuDetailModal()"
          style="flex:1; padding:12px;">Kapat</button>
      </div>
    </div>
  </div>

  <!-- Teberru ModalÄ± -->
  <div id="teberruModal" class="modal">
    <div class="modal-sheet" style="max-width:500px;">
      <h3 style="margin:0 0 15px 0; font-size:16px; font-weight:600; color:var(--primary);">ğŸ’° Teberru KaydÄ±</h3>
      <form id="teberruForm">
        <div class="form-group">
          <label class="form-label">BaÄŸÄ±ÅŸÃ§Ä± AdÄ± *</label>
          <input type="text" id="teberruBagisci" class="full-input" placeholder="BaÄŸÄ±ÅŸÃ§Ä± adÄ± soyadÄ±">
          <div id="teberruBagisciError" class="error-message"
            style="display:none; color:var(--danger); font-size:12px; margin-top:4px;"></div>
        </div>
        <div class="form-group">
          <label class="form-label">Para MiktarÄ± (â‚º) *</label>
          <input type="number" id="teberruMiktar" class="full-input" min="0" step="0.01" placeholder="0.00">
          <div id="teberruMiktarError" class="error-message"
            style="display:none; color:var(--danger); font-size:12px; margin-top:4px;"></div>
        </div>
        <div class="form-group">
          <label class="form-label">Ã–deme YÃ¶ntemi *</label>
          <div class="chip-group" style="display:flex; gap:8px; flex-wrap:wrap;">
            <div class="chip" onclick="selectChip('odeme', 'nakit', this)" data-value="nakit">ğŸ’µ Nakit</div>
            <div class="chip" onclick="selectChip('odeme', 'banka', this)" data-value="banka">ğŸ¦ Banka</div>
            <div class="chip" onclick="selectChip('odeme', 'pos', this)" data-value="pos">ğŸ’³ POS</div>
            <div class="chip" onclick="selectChip('odeme', 'sanal', this)" data-value="sanal">ğŸ“± Sanal</div>
          </div>
          <input type="hidden" id="teberruOdeme">
          <div id="teberruOdemeError" class="error-message"
            style="display:none; color:var(--danger); font-size:12px; margin-top:4px;"></div>
        </div>
        <div class="form-group">
          <label class="form-label">AÃ§Ä±klama</label>
          <textarea id="teberruAciklama" class="full-input" rows="3" placeholder="AÃ§Ä±klama (opsiyonel)"></textarea>
        </div>
        <div style="display:flex; gap:10px; margin-top:15px;">
          <button type="button" class="full-btn btn-secondary" onclick="closeTeberruModal()"
            style="flex:1;">Ä°ptal</button>
          <button type="button" class="full-btn btn-primary" onclick="showTeberruPreview()"
            style="flex:1;">Ã–nizleme</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Teberru Ã–nizleme ModalÄ± -->
  <div id="teberruPreviewModal" class="modal">
    <div class="modal-sheet" style="max-width:500px;">
      <h3 style="margin:0 0 15px 0; font-size:16px; font-weight:600; color:var(--primary);">ğŸ“‹ Teberru Ã–nizleme</h3>
      <div id="teberruPreviewContent" style="background:#f9f9f9; padding:15px; border-radius:10px; margin-bottom:20px;">
      </div>
      <div style="display:flex; gap:10px;">
        <button type="button" class="full-btn btn-secondary" onclick="closeTeberruPreviewModal()"
          style="flex:1;">Geri</button>
        <button type="button" class="full-btn btn-primary" onclick="saveTeberru()" style="flex:1;">Kaydet</button>
      </div>
    </div>
  </div>

  <!-- TaahhÃ¼t ModalÄ± -->
  <div id="taahhutModal" class="modal">
    <div class="modal-sheet" style="max-width:500px;">
      <h3 style="margin:0 0 15px 0; font-size:16px; font-weight:600; color:var(--primary);">ğŸ“‹ TaahhÃ¼t KaydÄ±</h3>
      <form id="taahhutForm">
        <div class="form-group">
          <label class="form-label">BaÄŸÄ±ÅŸÃ§Ä± AdÄ± *</label>
          <input type="text" id="taahhutBagisci" class="full-input" placeholder="BaÄŸÄ±ÅŸÃ§Ä± adÄ± soyadÄ±">
          <div id="taahhutBagisciError" class="error-message"
            style="display:none; color:var(--danger); font-size:12px; margin-top:4px;"></div>
        </div>
        <div class="form-group">
          <label class="form-label">Para MiktarÄ± (â‚º) *</label>
          <input type="number" id="taahhutMiktar" class="full-input" min="0" step="0.01" placeholder="0.00">
          <div id="taahhutMiktarError" class="error-message"
            style="display:none; color:var(--danger); font-size:12px; margin-top:4px;"></div>
        </div>
        <div class="form-group">
          <label class="form-label">AÃ§Ä±klama</label>
          <textarea id="taahhutAciklama" class="full-input" rows="3" placeholder="AÃ§Ä±klama (opsiyonel)"></textarea>
        </div>
        <div style="display:flex; gap:10px; margin-top:15px;">
          <button type="button" class="full-btn btn-secondary" onclick="closeTaahhutModal()"
            style="flex:1;">Ä°ptal</button>
          <button type="button" class="full-btn btn-primary" onclick="showTaahhutPreview()"
            style="flex:1;">Ã–nizleme</button>
        </div>
      </form>
    </div>
  </div>

  <!-- TaahhÃ¼t Ã–nizleme ModalÄ± -->
  <div id="taahhutPreviewModal" class="modal">
    <div class="modal-sheet" style="max-width:500px;">
      <h3 style="margin:0 0 15px 0; font-size:16px; font-weight:600; color:var(--primary);">ğŸ“‹ TaahhÃ¼t Ã–nizleme</h3>
      <div id="taahhutPreviewContent" style="background:#f9f9f9; padding:15px; border-radius:10px; margin-bottom:20px;">
      </div>
      <div style="display:flex; gap:10px;">
        <button type="button" class="full-btn btn-secondary" onclick="closeTaahhutPreviewModal()"
          style="flex:1;">Geri</button>
        <button type="button" class="full-btn btn-primary" onclick="saveTaahhut()" style="flex:1;">Kaydet</button>
      </div>
    </div>
  </div>

  <!-- Ramazan Ã–zet ModalÄ± (Sayfa yÃ¼klendiÄŸinde gÃ¶sterilir) -->
  <div id="ramazanOzetModal" class="modal" onclick="if(event.target === this) closeRamazanOzetModal()">
    <div class="modal-sheet" style="max-width:560px;">
      <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:20px; padding-bottom:15px; border-bottom:2px solid var(--border);">
        <h3 style="margin:0; font-size:18px; font-weight:600; color:var(--primary);">ğŸ“Š Ramazan-Ä± Åerif</h3>
        <button type="button" onclick="closeRamazanOzetModal()" 
          style="background:none; border:none; font-size:24px; cursor:pointer; color:#999; padding:0; width:32px; height:32px; display:flex; align-items:center; justify-content:center; border-radius:50%; transition:all 0.2s;"
          onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='none'">Ã—</button>
      </div>
      <div id="ramazanOzetContent" style="min-height:120px;">
        <div style="text-align:center; padding:30px; color:#999;">
          <div style="font-size:24px; margin-bottom:10px;">â³</div>
          YÃ¼kleniyor...
        </div>
      </div>
      <div style="margin-top:20px; display:flex; justify-content:flex-end;">
        <button type="button" class="full-btn btn-primary" onclick="closeRamazanOzetModal()">Kapat</button>
      </div>
    </div>
  </div>

  <!-- Analiz ModalÄ± -->
  <div id="analizModal" class="modal">
    <div class="modal-sheet" style="max-width:600px;">
      <h3 style="margin:0 0 15px 0; font-size:18px; font-weight:600; color:var(--primary);">ğŸ“Š Analiz</h3>

      <div
        style="padding:15px; background:#fff3cd; border-left:4px solid #ffc107; border-radius:10px; margin-bottom:20px; box-shadow:0 2px 8px rgba(255,193,7,0.2);">
        <p style="margin:0; font-size:13px; line-height:1.7; color:#856404; font-weight:500;">
          <strong style="font-size:14px;">âš ï¸ Ã–nemli UyarÄ±:</strong><br>
          Buradaki veriler %100 doÄŸru deÄŸildir. DoÄŸru veriler muhasebe tarafÄ±ndan aÃ§Ä±klanÄ±r ve
          gÃ¼ncellenir.
        </p>
      </div>

      <div id="analizContent" style="margin-bottom:20px;">
        <div style="text-align:center; padding:20px; background:#f8f9fa; border-radius:10px; margin-bottom:15px;">
          <div style="font-size:14px; color:#7f8c8d; margin-bottom:8px;">YÃ¼kleniyor...</div>
        </div>
      </div>

      <div style="display:flex; gap:10px;">
        <button type="button" class="full-btn btn-primary" onclick="closeAnalizModal()" style="flex:1;">Kapat</button>
      </div>
    </div>
  </div>

  <!-- KullanÄ±cÄ± DeÄŸiÅŸtirme ModalÄ± (Sadece Admin iÃ§in) -->
  <div id="userSwitchModal" class="modal" onclick="if(event.target === this) closeUserSwitchModal()">
    <div class="modal-sheet" style="max-width:500px; max-height:80vh; overflow-y:auto;">
      <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:20px; padding-bottom:15px; border-bottom:2px solid var(--border);">
        <h3 style="margin:0; font-size:18px; font-weight:600; color:var(--primary);">ğŸ”„ KullanÄ±cÄ± DeÄŸiÅŸtir</h3>
        <button type="button" onclick="closeUserSwitchModal()" 
          style="background:none; border:none; font-size:24px; cursor:pointer; color:#999; padding:0; width:32px; height:32px; display:flex; align-items:center; justify-content:center; border-radius:50%; transition:all 0.2s;"
          onmouseover="this.style.background='#f5f5f5'" onmouseout="this.style.background='none'">Ã—</button>
      </div>
      
      <div style="padding:12px; background:#fff3e0; border-left:4px solid #f57c00; border-radius:8px; margin-bottom:20px;">
        <p style="margin:0; font-size:13px; color:#e65100; line-height:1.5;">
          <strong>âš ï¸ Admin Ã–zelliÄŸi:</strong> BaÅŸka bir kullanÄ±cÄ±nÄ±n verilerini gÃ¶rÃ¼ntÃ¼leyebilir ve onun adÄ±na iÅŸlem yapabilirsiniz. 
          Sayfa yenilendiÄŸinde kendi hesabÄ±nÄ±za dÃ¶nersiniz.
        </p>
      </div>

      <div id="currentUserInfo" style="padding:15px; background:#e3f2fd; border-radius:10px; margin-bottom:20px;">
        <div style="font-size:12px; color:#1565c0; font-weight:600; margin-bottom:5px;">Åu an gÃ¶rÃ¼ntÃ¼lenen:</div>
        <div style="font-size:16px; font-weight:700; color:#0d47a1;" id="currentViewingUser">-</div>
      </div>

      <div style="margin-bottom:15px;">
        <input type="text" id="userSearchInput" placeholder="KullanÄ±cÄ± ara..." 
          style="width:100%; padding:12px 15px; border:2px solid var(--border); border-radius:10px; font-size:14px; box-sizing:border-box;"
          oninput="filterUserList(this.value)">
      </div>

      <div id="userSwitchList" style="max-height:300px; overflow-y:auto;">
        <div style="text-align:center; padding:30px; color:#999;">
          <div style="font-size:24px; margin-bottom:10px;">â³</div>
          KullanÄ±cÄ±lar yÃ¼kleniyor...
        </div>
      </div>

      <div style="margin-top:20px; padding-top:15px; border-top:1px solid var(--border);">
        <button type="button" onclick="resetToOriginalUser()" class="full-btn btn-secondary" style="width:100%;">
          ğŸ”™ Kendi HesabÄ±ma DÃ¶n
        </button>
      </div>
    </div>
  </div>

  <!-- Tahsilat ModalÄ± (Read-only) -->
  <div id="tahsilatModal" class="modal" onclick="if(event.target === this) closeTahsilatModal()">
    <div class="modal-sheet" style="max-width:700px; max-height:85vh; overflow-y:auto;">
      <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:20px; padding-bottom:15px; border-bottom:2px solid var(--border);">
        <h3 style="margin:0; font-size:18px; font-weight:600; color:var(--primary);">ğŸ’³ Tahsilat Raporu</h3>
        <button type="button" onclick="closeTahsilatModal()" 
          style="background:none; border:none; font-size:24px; cursor:pointer; color:#999; padding:0; width:32px; height:32px; display:flex; align-items:center; justify-content:center; border-radius:50%; transition:all 0.2s;"
          onmouseover="this.style.background='#f0f0f0'; this.style.color='#333';"
          onmouseout="this.style.background='none'; this.style.color='#999';">Ã—</button>
      </div>

      <div style="padding:15px; background:#e3f2fd; border-left:4px solid #2196f3; border-radius:10px; margin-bottom:20px;">
        <p style="margin:0; font-size:13px; line-height:1.6; color:#1565c0;">
          <strong>â„¹ï¸ Bilgi:</strong> Bu bÃ¶lÃ¼mde sadece kendi kayÄ±tlarÄ±nÄ±za ait tahsilat bilgilerini gÃ¶rÃ¼ntÃ¼leyebilirsiniz. 
          Tahsilat ekleme ve dÃ¼zenleme iÅŸlemleri yÃ¶netim panelinden yapÄ±lÄ±r.
        </p>
      </div>

      <div id="tahsilatContent">
        <div style="text-align:center; padding:30px; color:#999;">YÃ¼kleniyor...</div>
      </div>

      <div style="display:flex; gap:10px; margin-top:20px; padding-top:15px; border-top:1px solid var(--border);">
        <button type="button" class="full-btn btn-primary" onclick="closeTahsilatModal()" style="flex:1;">Kapat</button>
      </div>
    </div>
  </div>

  <!-- KayÄ±tlarÄ±m GÃ¶rÃ¼nÃ¼mÃ¼ -->
  <div id="takvimimView" style="display:none;">
    <div class="main-container">
      <h3 style="padding:20px 20px 10px; margin:0; font-size:18px; color:var(--primary);">Benim KayÄ±tlarÄ±m</h3>
      
      <!-- UI/UX: Filtreleme ButonlarÄ± -->
      <div id="filterTabs" style="padding:0 20px 15px; display:flex; gap:8px; flex-wrap:wrap;">
        <button class="filter-tab active" data-filter="all" onclick="applyFilter('all')">TÃ¼mÃ¼</button>
        <button class="filter-tab" data-filter="iftar" onclick="applyFilter('iftar')">Sadece Ä°ftar</button>
        <button class="filter-tab" data-filter="sahur" onclick="applyFilter('sahur')">Sadece Sahur</button>
        <button class="filter-tab" data-filter="teberru" onclick="applyFilter('teberru')">Sadece Teberru</button>
        <button class="filter-tab" data-filter="taahhut" onclick="applyFilter('taahhut')">Sadece TaahhÃ¼t</button>
      </div>

      <!-- KPI KartlarÄ± -->
      <div id="myRecordsKPI" style="padding:0 20px 15px; display:grid; grid-template-columns:repeat(2, 1fr); gap:12px;">
        <div
          style="background:linear-gradient(135deg, #f39c12 0%, #e67e22 100%); border-radius:12px; padding:15px; color:white; box-shadow:0 4px 12px rgba(243,156,18,0.3);">
          <div style="font-size:13px; opacity:0.9; margin-bottom:8px; font-weight:500;">ğŸŒ™ Toplam Ä°ftar Adedi</div>
          <div style="font-size:28px; font-weight:700;" id="kpiToplamIftar">0</div>
        </div>
        <div
          style="background:linear-gradient(135deg, #3498db 0%, #2980b9 100%); border-radius:12px; padding:15px; color:white; box-shadow:0 4px 12px rgba(52,152,219,0.3);">
          <div style="font-size:13px; opacity:0.9; margin-bottom:8px; font-weight:500;">ğŸŒŸ Toplam Sahur Adedi</div>
          <div style="font-size:28px; font-weight:700;" id="kpiToplamSahur">0</div>
        </div>
      </div>

      <div id="myRecordsList" style="padding:0 20px 20px;">
        <div style="text-align:center; padding:20px; color:#999">YÃ¼kleniyor...</div>
      </div>
    </div>
  </div>

  <!-- Teberru GiriÅŸi GÃ¶rÃ¼nÃ¼mÃ¼ (Analiz) -->
  <div id="teberruView" style="display:block;">
    <div class="main-container">
      <h3 style="padding:20px; margin:0; font-size:18px; color:var(--primary);">Veri GiriÅŸi ve Analiz</h3>
      <div style="padding:20px; display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:15px;">
        <button class="full-btn btn-primary" onclick="showAlert('Bu iÅŸlem muhasebe tarafÄ±ndan yapÄ±labilir, iletiÅŸime geÃ§ebilirsiniz.', 'warning')"
          style="padding:20px; font-size:16px; font-weight:600; opacity:0.6; cursor:not-allowed;">
          ğŸ’° Teberru
        </button>
        <button class="full-btn btn-primary" onclick="openTaahhutModal()"
          style="padding:20px; font-size:16px; font-weight:600;">
          ğŸ“‹ TaahhÃ¼t
        </button>
        <button class="full-btn btn-primary" onclick="openTahsilatModal()"
          style="padding:20px; font-size:16px; font-weight:600;">
          ğŸ’³ Tahsilat
        </button>
        <button class="full-btn btn-primary" onclick="openAnalizModal()"
          style="padding:20px; font-size:16px; font-weight:600;">
          ğŸ“Š Analiz
        </button>
      </div>

      <!-- Tahsilat Detay Tablosu -->
      <div id="tahsilatDetayContainer" style="padding:0 20px 20px 20px;">
        <div style="background:white; border-radius:12px; box-shadow:0 2px 12px rgba(0,0,0,0.08); overflow:hidden;">
          <div style="background:linear-gradient(135deg, var(--primary) 0%, #667eea 100%); color:white; padding:15px 20px;">
            <h4 style="margin:0; font-size:16px; font-weight:600; display:flex; align-items:center; gap:8px;">
              ğŸ“Š Tahsilat Ã–zeti
            </h4>
          </div>
          <div style="padding:15px;">
            <div id="tahsilatDetayLoading" style="text-align:center; padding:30px; color:#999;">
              <div style="font-size:24px; margin-bottom:10px;">â³</div>
              YÃ¼kleniyor...
            </div>
            <div id="tahsilatDetayContent" style="display:none;">
              <div style="overflow-x:auto;">
                <table style="width:100%; border-collapse:collapse; font-size:14px;">
                  <thead>
                    <tr style="background:#f8f9fa; border-bottom:2px solid #e9ecef;">
                      <th style="padding:12px 10px; text-align:left; font-weight:600; color:#495057;">Tip</th>
                      <th style="padding:12px 10px; text-align:right; font-weight:600; color:#495057;">Tutar</th>
                      <th style="padding:12px 10px; text-align:right; font-weight:600; color:#495057;">Tahsilat</th>
                      <th style="padding:12px 10px; text-align:right; font-weight:600; color:#495057;">Kalan</th>
                      <th style="padding:12px 10px; text-align:right; font-weight:600; color:#495057;">YÃ¼zde</th>
                    </tr>
                  </thead>
                  <tbody id="tahsilatDetayTbody">
                  </tbody>
                  <tfoot id="tahsilatDetayTfoot" style="background:#e8f5e9; font-weight:700;">
                  </tfoot>
                </table>
              </div>

              <!-- Hedef Bilgisi -->
              <div id="tahsilatHedefContainer" style="margin-top:20px; padding:15px; background:linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%); border-radius:10px; border-left:4px solid #f57c00;">
                <div style="font-size:14px; color:#e65100; font-weight:600; margin-bottom:10px; display:flex; align-items:center; gap:6px;">
                  ğŸ¯ Ramazan-Ä± Åerif Hedefi
                </div>
                <div id="tahsilatHedefIcerik" style="font-size:13px; color:#5d4037; line-height:1.8;">
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bilgilendirme Pop-up (SaÄŸ Alt KÃ¶ÅŸe - tÄ±klanÄ±nca aÃ§Ä±lÄ±r) -->
  <div id="infoPopup"
    style="display:block; position:fixed; bottom:90px; right:20px; background:white; border-radius:12px; padding:15px; box-shadow:0 4px 20px rgba(0,0,0,0.15); max-width:300px; z-index:1000; border-left:4px solid var(--primary);">
    <div style="display:flex; align-items:start; gap:10px;">
      <div style="font-size:24px;">ğŸ’¡</div>
      <div style="flex:1;">
        <div style="font-weight:600; margin-bottom:5px; font-size:14px; color:var(--primary);">Bilgilendirme</div>
        <div style="font-size:12px; color:#666; line-height:1.4; margin-bottom:10px;">Sistem hakkÄ±nda bilgi almak iÃ§in
          tÄ±klayÄ±n.</div>
        <button onclick="showInfoModalFromPopup()"
          style="background:var(--primary); color:white; border:none; padding:6px 12px; border-radius:6px; font-size:12px; cursor:pointer; width:100%;">DetaylÄ±
          Bilgi</button>
      </div>
      <button onclick="closeInfoPopup()"
        style="background:none; border:none; font-size:18px; cursor:pointer; color:#999; padding:0; line-height:1;">Ã—</button>
    </div>
  </div>

  <nav class="bottom-nav">
    <button class="nav-btn" onclick="switchView('takvim')">
      <svg viewBox="0 0 24 24">
        <path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z" />
      </svg>
      <span>Takvim</span>
    </button>
    <button class="nav-btn" onclick="switchView('takvimim')">
      <svg viewBox="0 0 24 24">
        <path
          d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z" />
      </svg>
      <span>KayÄ±tlarÄ±m</span>
    </button>
    <button class="nav-btn active" onclick="switchView('teberru')">
      <svg viewBox="0 0 24 24">
        <path
          d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z" />
      </svg>
      <span>Analiz</span>
    </button>
    <button class="nav-btn" onclick="switchView('menu')">
      <svg viewBox="0 0 24 24">
        <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z" />
      </svg>
      <span>MenÃ¼</span>
    </button>
  </nav>


  <script>
    // ============================================
    // STANDALONE UTILITY FUNCTIONS
    // ============================================
    
    // Query selector helper
    const qs = s => document.querySelector(s);
    
    // Toast bildirim sistemi (ortak.js'den baÄŸÄ±msÄ±z)
    function showToast(type, title, message, options = {}) {
      const toastContainer = qs('#toastContainer') || createToastContainer();
      if (!toastContainer) return;
      
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      toast.setAttribute('role', 'alert');
      toast.setAttribute('aria-live', 'assertive');
      
      const icons = {
        success: 'âœ…',
        error: 'âŒ',
        warning: 'âš ï¸',
        info: 'â„¹ï¸'
      };
      
      const colors = {
        success: '#27ae60',
        error: '#c0392b',
        warning: '#f39c12',
        info: '#3498db'
      };
      
      // Ã–zel mesaj varsa (muhasebe uyarÄ±sÄ± gibi) daha bÃ¼yÃ¼k ve dikkat Ã§ekici gÃ¶ster
      const isImportant = options.important || false;
      const duration = options.duration || (isImportant ? 8000 : 5000);
      
      toast.innerHTML = `
        <div class="toast-icon" style="font-size: ${isImportant ? '24px' : '20px'};">
          ${icons[type] || icons.info}
        </div>
        <div class="toast-content" style="flex: 1;">
          <div class="toast-title" style="font-weight: ${isImportant ? '700' : '600'}; font-size: ${isImportant ? '15px' : '14px'};">
            ${escapeHtml(title)}
          </div>
          <div class="toast-message" style="font-size: ${isImportant ? '13px' : '12px'}; line-height: 1.5; margin-top: ${isImportant ? '6px' : '4px'};">
            ${escapeHtml(message)}
          </div>
        </div>
        <button class="toast-close" onclick="this.parentElement.remove()" style="font-size: 22px; padding: 0; width: 24px; height: 24px;">Ã—</button>
      `;
      
      // Ã–nemli toast'lar iÃ§in Ã¶zel stil
      if (isImportant) {
        toast.style.borderLeftWidth = '5px';
        toast.style.boxShadow = '0 6px 24px rgba(0, 0, 0, 0.2)';
        toast.style.animation = 'toastSlideInImportant 0.4s ease-out';
      }
      
      toastContainer.appendChild(toast);
      
      // Animasyon iÃ§in kÄ±sa bir gecikme (reflow iÃ§in)
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          toast.classList.add('show');
        });
      });
      
      // Otomatik kaldÄ±r
      setTimeout(() => {
        if (toast.parentElement) {
          toast.style.opacity = '0';
          toast.style.transform = 'translateX(100%)';
          setTimeout(() => toast.remove(), 300);
        }
      }, duration);
    }
    
    // Muhasebe uyarÄ±sÄ± iÃ§in Ã¶zel toast
    function showMuhasebeWarningToast(kayitTipi) {
      const tipLabels = {
        'iftar': 'Ä°ftar',
        'sahur': 'Sahur',
        'teberru': 'Teberru',
        'taahhut': 'TaahhÃ¼t'
      };
      
      const tipLabel = tipLabels[kayitTipi] || 'KayÄ±t';
      
      showToast('warning', 'âš ï¸ Ã–nemli UyarÄ±', 
        `YapmÄ±ÅŸ olduÄŸunuz ${tipLabel} iÅŸlemini muhakkak gÃ¼nlÃ¼k paylaÅŸÄ±lan muhasebe verileri ile karÅŸÄ±laÅŸtÄ±rÄ±n. YapÄ±lan kayÄ±tlar ile alakalÄ± gerekli deÄŸiÅŸiklik iÅŸlemleri muhasebe tarafÄ±ndan yapÄ±labilir.`,
        { important: true, duration: 10000 }
      );
    }
    
    // Toast container oluÅŸtur (yoksa)
    function createToastContainer() {
      const container = document.createElement('div');
      container.id = 'toastContainer';
      container.className = 'toast-container';
      container.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 99999;
        display: flex;
        flex-direction: column;
        gap: 12px;
        pointer-events: none;
        max-width: 420px;
      `;
      document.body.appendChild(container);
      return container;
    }
    
    // XSS korumasÄ± iÃ§in HTML escape
    function escapeHtml(text) {
      if (text == null) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
    
    // URL normalize (gerekirse)
    function normalizeUrl(url) {
      if (!url) return '';
      try {
        const u = new URL(url, window.location.origin);
        return u.toString();
      } catch {
        return url;
      }
    }
    
    // Global eriÅŸim iÃ§in window'a ekle
    window.showToast = showToast;
    window.showMuhasebeWarningToast = showMuhasebeWarningToast;
    window.escapeHtml = escapeHtml;
    window.normalizeUrl = normalizeUrl;
    
    // ============================================
    // SUPABASE CLIENT CHECK
    // ============================================
    if (!window.supabase) {
      console.error('Supabase client yÃ¼klenmedi! LÃ¼tfen sayfayÄ± yenileyin.');
    }

    let CURRENT_YIL = null;
    let ramazanAyari = null;
    let kayitlar = [];
    let tahsilatByKayitId = {};
    let tutarSecenekleri = [];
    let currentUser = null;
    let kapasiteAyarlari = { genel: null, gunluk: [] };
    let previewData = null;
    let mahaller = [];
    let confirmCallback = null;

    // --- BAÅLANGIÃ‡ ---
    let currentPersonelAdi = null;
    // YÃ¼kleme dÃ¶ngÃ¼lerini engellemek iÃ§in guard'lar
    let isLoadingKayitlar = false;
    let isLoadingMyRecords = false;

    // --- ADMIN IMPERSONATION (KullanÄ±cÄ± DeÄŸiÅŸtirme) ---
    let originalPersonelAdi = null; // Orijinal giriÅŸ yapan kullanÄ±cÄ± adÄ±
    let originalUser = null; // Orijinal giriÅŸ yapan kullanÄ±cÄ± objesi
    let isImpersonating = false; // BaÅŸka kullanÄ±cÄ± olarak gÃ¶rÃ¼ntÃ¼leme modu
    let impersonatedUserId = null; // Impersonation modunda seÃ§ilen kullanÄ±cÄ±nÄ±n ID'si
    let allUsers = []; // TÃ¼m kullanÄ±cÄ±lar listesi
    const ADMIN_USERS = ['Samet Ã‡akÄ±r', 'samet Ã§akÄ±r', 'SAMET Ã‡AKIR']; // Admin yetkisi olan kullanÄ±cÄ±lar

    // Standalone sayfa baÅŸlatma fonksiyonu (ortak.js'den baÄŸÄ±msÄ±z)
    async function initPage() {
      // Supabase client kontrolÃ¼
      if (!window.supabase || !window.supabase.auth) {
        showToast('error', 'Hata', 'Supabase client yÃ¼klenmedi. Sayfa yenileniyor...');
        setTimeout(() => location.reload(), 1000);
        return;
      }

      // Auth kontrolÃ¼ - getSession ile oturum kontrolÃ¼
      const { data: { session }, error: sessionError } = await window.supabase.auth.getSession();
      
      if (sessionError || !session || !session.user) {
        showToast('warning', 'Oturum BulunamadÄ±', 'GiriÅŸ yapmanÄ±z gerekiyor. YÃ¶nlendiriliyorsunuz...');
        setTimeout(() => {
          window.location.href = '../index.html';
        }, 1500);
        return;
      }

      currentUser = session.user;
      
      // KullanÄ±cÄ± profil bilgisini veritabanÄ±ndan Ã§ek
      try {
        const { data: uData, error } = await window.supabase
          .from('kullanicilar')
          .select('id, adsoyad, email')
          .eq('id', session.user.id)
          .single();
        
        if (error || !uData) {
          showToast('warning', 'UyarÄ±', 'Profil bilgisi yÃ¼klenemedi. Misafir olarak devam ediliyor.');
          currentPersonelAdi = null;
        } else if (uData.adsoyad) {
          currentPersonelAdi = uData.adsoyad;
        } else {
          currentPersonelAdi = null;
        }
      } catch (e) {
        console.error('KullanÄ±cÄ± bilgisi yÃ¼klenemedi:', e);
        currentPersonelAdi = null;
      }
      
      // Global eriÅŸim iÃ§in window'a ekle
      window.currentPersonelAdi = currentPersonelAdi;
      window.currentUser = currentUser;

      // Orijinal kullanÄ±cÄ± bilgilerini kaydet (impersonation iÃ§in)
      originalPersonelAdi = currentPersonelAdi;
      originalUser = currentUser;
      isImpersonating = false;

      // KullanÄ±cÄ± adÄ±nÄ± header'a yaz
      const updateUserNameDisplay = () => {
        const userNameDisplay = qs('#userNameDisplay');
        const userBadge = qs('#userBadge');
        const userSwitchIcon = qs('#userSwitchIcon');
        if (userNameDisplay && userBadge) {
          // Profil yoksa email'den isim tÃ¼retme (repo kuralÄ±) -> Misafir
          const displayName = currentPersonelAdi || 'Misafir';
          userNameDisplay.textContent = displayName;
          userBadge.style.display = 'flex';
          
          // Admin kullanÄ±cÄ± ise deÄŸiÅŸtirme ikonunu gÃ¶ster
          const isAdmin = ADMIN_USERS.some(admin => 
            normalizePersonelName(admin) === normalizePersonelName(originalPersonelAdi || '')
          );
          if (userSwitchIcon && isAdmin) {
            userSwitchIcon.style.display = 'inline';
            userBadge.title = 'TÄ±klayarak kullanÄ±cÄ± deÄŸiÅŸtirebilirsiniz';
          }
        } else {
          setTimeout(updateUserNameDisplay, 100);
        }
      };
      updateUserNameDisplay();

      await loadAktifRamazan();

      // Ä°ÅŸlem logu: sayfa aÃ§Ä±ldÄ± kaydÄ±
      logSayfaAcildi();

      // TÃ¼m modallarÄ± kapat (sayfa yÃ¼klendiÄŸinde)
      document.querySelectorAll('.modal').forEach(modal => {
        modal.classList.remove('open');
      });

      // KÃ¶ÅŸe bilgilendirme popup'Ä± gÃ¶ster (tÄ±klanÄ±nca modal aÃ§Ä±lÄ±r)
      showInfoCornerButton();

      // GÃ¼ncelleme bildirimi (sÃ¼rÃ¼m baÅŸÄ±na en fazla 2 kez)
      showUpdateModalIfNeeded();

      // Ramazan Ã¶zet modalÄ± (her sayfa yÃ¼klemesinde gÃ¶ster)
      setTimeout(() => showRamazanOzetModal(), 600);

      // Teberru ve TaahhÃ¼t form validasyon event listener'larÄ±
      setupTeberruValidation();
      setupTaahhutValidation();
      
      // SUPABASE REALTIME: CanlÄ± veri gÃ¼ncellemeleri iÃ§in subscription
      setupRealtimeSubscription();

      // Sayfa aÃ§Ä±ldÄ±ÄŸÄ±nda varsayÄ±lan olarak Analiz sekmesini aÃ§
      switchView('teberru');
    }
    
    // ============================================
    // SUPABASE REALTIME SUBSCRIPTION
    // ============================================
    let realtimeChannel = null;
    let realtimeDebounceTimer = null;
    const REALTIME_DEBOUNCE_MS = 400;

    function debouncedLoadKayitlar() {
      if (realtimeDebounceTimer) clearTimeout(realtimeDebounceTimer);
      realtimeDebounceTimer = setTimeout(() => {
        realtimeDebounceTimer = null;
        loadKayitlar();
      }, REALTIME_DEBOUNCE_MS);
    }
    
    function setupRealtimeSubscription() {
      if (!window.supabase || !CURRENT_YIL) {
        console.warn('Realtime subscription iÃ§in Supabase client veya yÄ±l gerekli');
        return;
      }
      
      // Ã–nceki subscription varsa kapat
      if (realtimeChannel) {
        window.supabase.removeChannel(realtimeChannel);
      }

      // Bekleyen debounce varsa iptal et
      if (realtimeDebounceTimer) {
        clearTimeout(realtimeDebounceTimer);
        realtimeDebounceTimer = null;
      }
      
      // Yeni subscription oluÅŸtur
      realtimeChannel = window.supabase
        .channel('ramazan-kayitlari-changes')
        .on(
          'postgres_changes',
          {
            event: '*', // INSERT, UPDATE, DELETE
            schema: 'public',
            table: 'ramazan_kayitlari',
            filter: `yil=eq.${CURRENT_YIL}`
          },
          (payload) => {
            console.log('Realtime gÃ¼ncelleme alÄ±ndÄ±:', payload);
            
            // Toast bildirimi gÃ¶ster
            if (payload.eventType === 'INSERT') {
              showToast('info', 'Yeni KayÄ±t', 'Takvimde yeni bir kayÄ±t eklendi.', { duration: 3000 });
            } else if (payload.eventType === 'UPDATE') {
              showToast('info', 'KayÄ±t GÃ¼ncellendi', 'Bir kayÄ±t gÃ¼ncellendi.', { duration: 3000 });
            } else if (payload.eventType === 'DELETE') {
              showToast('info', 'KayÄ±t Silindi', 'Bir kayÄ±t silindi.', { duration: 3000 });
            }
            
            // Takvimi yeniden yÃ¼kle (debounce ile: kÄ±sa sÃ¼rede gelen birden fazla event tek yÃ¼kleme yapar)
            debouncedLoadKayitlar();
          }
        )
        .subscribe((status) => {
          if (status === 'SUBSCRIBED') {
            console.log('âœ… Realtime subscription aktif');
          } else if (status === 'CHANNEL_ERROR') {
            console.error('âŒ Realtime subscription hatasÄ±');
          }
        });
    }
    
    // Sayfa kapanÄ±rken subscription'Ä± temizle
    window.addEventListener('beforeunload', () => {
      if (realtimeChannel) {
        window.supabase.removeChannel(realtimeChannel);
      }
    });
    
    // ============================================
    // UI/UX: FÄ°LTRELEME SÄ°STEMÄ°
    // ============================================
    let currentFilter = 'all';
    let currentCalendarFilter = 'all';
    
    function applyFilter(filter) {
      currentFilter = filter;
      
      // Tab butonlarÄ±nÄ± gÃ¼ncelle
      document.querySelectorAll('#filterTabs .filter-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.filter === filter) {
          tab.classList.add('active');
        }
      });
      
      // KayÄ±tlarÄ± filtrele ve yeniden render et
      loadMyRecords();
    }
    
    function applyCalendarFilter(filter) {
      currentCalendarFilter = filter;
      
      // Tab butonlarÄ±nÄ± gÃ¼ncelle
      document.querySelectorAll('#calendarFilterTabs .filter-tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.filter === filter) {
          tab.classList.add('active');
        }
      });
      
      // Takvimi yeniden render et
      renderAllViews();
    }
    
    // Global eriÅŸim
    window.applyFilter = applyFilter;
    window.applyCalendarFilter = applyCalendarFilter;
    
    // DOMContentLoaded'da otomatik baÅŸlat (ortak.js'den baÄŸÄ±msÄ±z)
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        // Supabase client'Ä±n yÃ¼klenmesini bekle
        const waitForSupabase = setInterval(() => {
          if (window.supabase && window.supabase.auth) {
            clearInterval(waitForSupabase);
            initPage();
          }
        }, 100);
        
        // Maksimum 10 saniye bekle
        setTimeout(() => {
          clearInterval(waitForSupabase);
          if (!window.supabase || !window.supabase.auth) {
            showToast('error', 'Hata', 'Supabase yÃ¼klenemedi. Sayfa yenileniyor...');
            setTimeout(() => location.reload(), 2000);
          }
        }, 10000);
      });
    } else {
      // Sayfa zaten yÃ¼klendiyse direkt baÅŸlat
      if (window.supabase && window.supabase.auth) {
        initPage();
      } else {
        const waitForSupabase = setInterval(() => {
          if (window.supabase && window.supabase.auth) {
            clearInterval(waitForSupabase);
            initPage();
          }
        }, 100);
        
        setTimeout(() => {
          clearInterval(waitForSupabase);
          if (!window.supabase || !window.supabase.auth) {
            showToast('error', 'Hata', 'Supabase yÃ¼klenemedi. Sayfa yenileniyor...');
            setTimeout(() => location.reload(), 2000);
          }
        }, 10000);
      }
    }

    function setupTeberruValidation() {
      const bagisciInput = qs('#teberruBagisci');
      const miktarInput = qs('#teberruMiktar');

      if (bagisciInput) {
        bagisciInput.addEventListener('input', () => {
          qs('#teberruBagisciError').style.display = 'none';
          bagisciInput.style.borderColor = '';
        });
      }

      if (miktarInput) {
        miktarInput.addEventListener('input', () => {
          qs('#teberruMiktarError').style.display = 'none';
          miktarInput.style.borderColor = '';
        });
      }

      // Ã–deme yÃ¶ntemi seÃ§ildiÄŸinde hatayÄ± temizle
      const chips = qs('#teberruModal')?.querySelectorAll('.chip');
      if (chips) {
        chips.forEach(chip => {
          chip.addEventListener('click', () => {
            setTimeout(() => {
              if (qs('#teberruOdeme')?.value) {
                qs('#teberruOdemeError').style.display = 'none';
              }
            }, 100);
          });
        });
      }
    }

    function setupTaahhutValidation() {
      const bagisciInput = qs('#taahhutBagisci');
      const miktarInput = qs('#taahhutMiktar');

      if (bagisciInput) {
        bagisciInput.addEventListener('input', () => {
          qs('#taahhutBagisciError').style.display = 'none';
          bagisciInput.style.borderColor = '';
        });
      }

      if (miktarInput) {
        miktarInput.addEventListener('input', () => {
          qs('#taahhutMiktarError').style.display = 'none';
          miktarInput.style.borderColor = '';
        });
      }
    }

    const UPDATE_VERSION = '2026-02-21';

    function showUpdateModalIfNeeded() {
      const key = `iftarSahurUpdateViewCount_${UPDATE_VERSION}`;
      let viewCount = parseInt(localStorage.getItem(key) || '0', 10);
      if (viewCount >= 5) return;
      viewCount += 1;
      localStorage.setItem(key, String(viewCount));
      setTimeout(() => {
        const modal = qs('#updateModal');
        if (modal) modal.classList.add('open');
      }, 800);
    }

    function closeUpdateModal() {
      const modal = qs('#updateModal');
      if (modal) modal.classList.remove('open');
    }

    function closeRamazanOzetModal() {
      const modal = qs('#ramazanOzetModal');
      if (modal) modal.classList.remove('open');
    }

    async function logSayfaAcildi() {
      if (!window.supabase) return;
      try {
        await window.supabase.from('islem_log').insert({
          islem: 'sayfa_acildi',
          uid: currentUser?.id || null,
          sayfa: 'iftar-sahur-form',
          path: 'personel/iftar-sahur-form.html',
          user_agent: typeof navigator !== 'undefined' ? navigator.userAgent : null
        });
      } catch (e) {
        console.warn('Ä°ÅŸlem logu kaydedilemedi:', e);
      }
    }

    async function showRamazanOzetModal() {
      const contentEl = qs('#ramazanOzetContent');
      const modalEl = qs('#ramazanOzetModal');
      if (!contentEl || !modalEl) return;
      contentEl.innerHTML = '<div style="text-align:center; padding:30px; color:#999;"><div style="font-size:24px; margin-bottom:10px;">â³</div>YÃ¼kleniyor...</div>';
      modalEl.classList.add('open');

      const formatPara = (val) => (val || 0).toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
      const sb = window.supabase;
      if (!sb) {
        contentEl.innerHTML = '<div style="text-align:center; padding:20px; color:#e74c3c;">Supabase baÄŸlantÄ±sÄ± yok.</div>';
        return;
      }
      const uid = currentUser?.id;
      const personelAdi = currentPersonelAdi;
      const yil2026 = CURRENT_YIL ? (typeof CURRENT_YIL === 'number' ? CURRENT_YIL : parseInt(CURRENT_YIL)) : new Date().getFullYear();

      try {
        // 1. arsiv_hedefler: 2023, 2024, 2025 Ramazan-Ä± Åerif tutarlarÄ± (uid ile)
        let tutar2023 = 0, tutar2024 = 0, tutar2025 = 0;
        const addArsivRow = (r) => {
          const t = parseFloat(r.tutar || 0);
          if (r.yil === 2023) tutar2023 += t;
          else if (r.yil === 2024) tutar2024 += t;
          else if (r.yil === 2025) tutar2025 += t;
        };
        if (uid) {
          const { data: arsivKategori } = await sb.from('arsiv_hedefler').select('id, yil, tutar')
            .eq('uid', uid).eq('kategori', 'Ramazan-Ä± Åerif').in('yil', [2023, 2024, 2025]);
          const { data: arsivTip } = await sb.from('arsiv_hedefler').select('id, yil, tutar')
            .eq('uid', uid).eq('tip', 'Ramazan-Ä± Åerif').in('yil', [2023, 2024, 2025]);
          const merged = [...new Map([...(arsivKategori || []), ...(arsivTip || [])].map(v => [v.id, v])).values()];
          merged.forEach(addArsivRow);
          if (tutar2023 === 0 && tutar2024 === 0 && tutar2025 === 0 && personelAdi) {
            const { data: arsivP1 } = await sb.from('arsiv_hedefler').select('id, yil, tutar, personel')
              .eq('kategori', 'Ramazan-Ä± Åerif').in('yil', [2023, 2024, 2025]);
            const { data: arsivP2 } = await sb.from('arsiv_hedefler').select('id, yil, tutar, personel')
              .eq('tip', 'Ramazan-Ä± Åerif').in('yil', [2023, 2024, 2025]);
            const pNorm = normalizePersonelName(personelAdi);
            const pMerged = [...new Map([...(arsivP1 || []), ...(arsivP2 || [])].map(v => [v.id, v])).values()];
            pMerged.filter(r => normalizePersonelName(r.personel || '') === pNorm).forEach(addArsivRow);
          }
        }

        // 2. 2026 anlÄ±k temin: ramazan_kayitlari (iftar+sahur) + teberru + taahhut
        let temin2026 = 0;
        const targetUid = isImpersonating ? impersonatedUserId : uid;
        const targetName = personelAdi;
        const seenIds = new Set();
        if (targetUid) {
          const { data: rkData } = await sb.from('ramazan_kayitlari').select('id, tip, tutar, personeluid, kaydedenpersoneluid')
            .eq('yil', yil2026).or(`personeluid.eq.${targetUid},kaydedenpersoneluid.eq.${targetUid}`);
          (rkData || []).forEach(k => {
            if ((k.tip === 'iftar' || k.tip === 'sahur') && !seenIds.has(k.id)) {
              seenIds.add(k.id);
              temin2026 += Number(k.tutar) || 0;
            }
          });
        }
        if (targetName) {
          const tNorm = normalizePersonelName(targetName);
          const { data: rkName } = await sb.from('ramazan_kayitlari').select('id, tip, tutar, personeladi, kaydedenpersonel')
            .eq('yil', yil2026);
          (rkName || []).forEach(k => {
            const p1 = normalizePersonelName(k.personeladi || '');
            const p2 = normalizePersonelName(k.kaydedenpersonel || '');
            if ((p1 === tNorm || p2 === tNorm) && (k.tip === 'iftar' || k.tip === 'sahur') && !seenIds.has(k.id)) {
              seenIds.add(k.id);
              temin2026 += Number(k.tutar) || 0;
            }
          });
        }
        await loadTeberruKayitlari();
        const yilNum = typeof yil2026 === 'number' ? yil2026 : parseInt(yil2026);
        if (teberruKayitlari && teberruKayitlari.length > 0) {
          teberruKayitlari.filter(t => parseInt(t.yil) === yilNum).forEach(t => {
            temin2026 += Number(t.miktar) || 0;
          });
        }
        await loadTaahhutKayitlari();
        if (taahhutKayitlari && taahhutKayitlari.length > 0) {
          taahhutKayitlari.filter(t => parseInt(t.yil) === yilNum).forEach(t => {
            temin2026 += Number(t.miktar) || 0;
          });
        }

        // 3. 2026 hedef: ramazan_hedefler
        let hedef2026 = 0;
        const { data: hedefData } = await sb.from('ramazan_hedefler').select('hedef, personeluid, personeladi').eq('yil', yil2026);
        if (hedefData && hedefData.length > 0) {
          const h = hedefData.find(x =>
            (targetUid && x.personeluid === targetUid) ||
            (targetName && normalizePersonelName(x.personeladi || '') === normalizePersonelName(targetName || ''))
          );
          if (h) hedef2026 = parseFloat(h.hedef || 0);
        }
        const ulasma2026 = hedef2026 > 0 ? ((temin2026 / hedef2026) * 100).toFixed(1) : '-';

        // YÃ¼zde artÄ±ÅŸ hesapla
        const artis2024 = tutar2023 > 0 ? (((tutar2024 - tutar2023) / tutar2023) * 100).toFixed(1) : '-';
        const artis2025 = tutar2024 > 0 ? (((tutar2025 - tutar2024) / tutar2024) * 100).toFixed(1) : '-';

        contentEl.innerHTML = `
          <div style="display:grid; gap:12px;">
            <div style="padding:12px 16px; background:linear-gradient(135deg,#f8f9fa,#e9ecef); border-radius:10px; border-left:4px solid #6c757d;">
              <div style="font-size:12px; color:#6c757d; font-weight:600; margin-bottom:4px;">2023 Ramazan-Ä± Åerif</div>
              <div style="font-size:18px; font-weight:700; color:#2c3e50;">â‚º${formatPara(tutar2023)}</div>
            </div>
            <div style="padding:12px 16px; background:linear-gradient(135deg,#e3f2fd,#bbdefb); border-radius:10px; border-left:4px solid #1976d2;">
              <div style="font-size:12px; color:#1565c0; font-weight:600; margin-bottom:4px;">2024 Ramazan-Ä± Åerif</div>
              <div style="font-size:18px; font-weight:700; color:#2c3e50;">â‚º${formatPara(tutar2024)}</div>
              ${artis2024 !== '-' ? `<div style="font-size:12px; margin-top:6px; color:${parseFloat(artis2024) >= 0 ? '#27ae60' : '#e74c3c'};">${parseFloat(artis2024) >= 0 ? 'â†‘' : 'â†“'} %${Math.abs(parseFloat(artis2024))} (2023'e gÃ¶re)</div>` : ''}
            </div>
            <div style="padding:12px 16px; background:linear-gradient(135deg,#e8f5e9,#c8e6c9); border-radius:10px; border-left:4px solid #388e3c;">
              <div style="font-size:12px; color:#2e7d32; font-weight:600; margin-bottom:4px;">2025 Ramazan-Ä± Åerif</div>
              <div style="font-size:18px; font-weight:700; color:#2c3e50;">â‚º${formatPara(tutar2025)}</div>
              ${artis2025 !== '-' ? `<div style="font-size:12px; margin-top:6px; color:${parseFloat(artis2025) >= 0 ? '#27ae60' : '#e74c3c'};">${parseFloat(artis2025) >= 0 ? 'â†‘' : 'â†“'} %${Math.abs(parseFloat(artis2025))} (2024'e gÃ¶re)</div>` : ''}
            </div>
            <div style="padding:12px 16px; background:linear-gradient(135deg,#fff3e0,#ffe0b2); border-radius:10px; border-left:4px solid #f57c00;">
              <div style="font-size:12px; color:#e65100; font-weight:600; margin-bottom:4px;">${yil2026} AnlÄ±k Durum</div>
              <div style="font-size:18px; font-weight:700; color:#2c3e50;">â‚º${formatPara(temin2026)}</div>
              ${hedef2026 > 0 ? `
                <div style="font-size:12px; margin-top:6px; color:#5d4037;">Hedef: â‚º${formatPara(hedef2026)}</div>
                <div style="font-size:13px; margin-top:6px; font-weight:700; color:${parseFloat(ulasma2026) >= 100 ? '#27ae60' : parseFloat(ulasma2026) >= 50 ? '#f57c00' : '#e74c3c'};">
                  UlaÅŸma: %${ulasma2026}
                </div>
              ` : '<div style="font-size:12px; margin-top:6px; color:#999;">Hedef tanÄ±mlanmamÄ±ÅŸ</div>'}
            </div>
          </div>
        `;
      } catch (err) {
        console.error('Ramazan Ã¶zet yÃ¼klenemedi:', err);
        contentEl.innerHTML = `<div style="text-align:center; padding:20px; color:#e74c3c;">Veriler yÃ¼klenirken hata oluÅŸtu.<br><small>${err.message || ''}</small></div>`;
      }
    }

    function showInfoCornerButton() {
      const popup = qs('#infoPopup');
      if (popup) {
        setTimeout(() => {
          popup.style.display = 'block';
        }, 500);
      }
    }

    function closeInfoModal() {
      const modal = qs('#infoModal');
      if (modal) modal.classList.remove('open');
      showInfoPopupAgain();
    }

    function showInfoModalFromPopup() {
      const popup = qs('#infoPopup');
      if (popup) popup.style.display = 'none';
      qs('#infoModal').classList.add('open');
    }

    function showInfoPopupAgain() {
      const popup = qs('#infoPopup');
      if (popup) popup.style.display = 'block';
    }

    function closeInfoPopup() {
      const popup = qs('#infoPopup');
      if (popup) popup.style.display = 'none';
    }

    async function loadAktifRamazan() {
      try {
        // YÄ±llarÄ± Ã‡ek (ramazan_yillar tablosundan)
        const { data: years, error } = await window.supabase
          .from('ramazan_yillar')
          .select('id, aktif, baslangic, bitis, createdat, hicriyil, updatedat, yil')
          .order('yil', { ascending: false });

        if (error) throw error;

        const selYil = qs('#selYil');
        if (!selYil) return;
        selYil.innerHTML = '';

        let activeDoc = null;
        if (!years || years.length === 0) {
          selYil.innerHTML = '<option value="">YÄ±l bulunamadÄ±</option>';
          showToast('warning', 'UyarÄ±', 'Ramazan yÄ±lÄ± bulunamadÄ±.');
          return;
        }

        years.forEach(d => {
          const opt = document.createElement('option');
          opt.value = d.yil;
          opt.innerText = d.yil + (d.aktif ? ' (Aktif)' : '');
          if (d.aktif) { opt.selected = true; activeDoc = d; }
          selYil.appendChild(opt);
        });

        // Aktif yoksa sonuncuyu (en gÃ¼ncel) al
        if (!activeDoc) activeDoc = years[0];
        setRamazanData(activeDoc);

        // YÄ±l DeÄŸiÅŸimi
        // addEventListener yerine onchange kullan (tekrar Ã§aÄŸrÄ±lÄ±rsa event birikmesini Ã¶nler)
        selYil.onchange = () => {
          const selectedYear = parseInt(selYil.value, 10);
          const selectedDoc = years.find(d => d.yil === selectedYear);
          if (selectedDoc) setRamazanData(selectedDoc);
        };

      } catch (e) { console.error('Ramazan ayarÄ± yÃ¼klenemedi', e); }
    }

    async function setRamazanData(data) {
      CURRENT_YIL = data.yil;
      ramazanAyari = data;
      
      // Realtime subscription'Ä± gÃ¼ncelle (yÄ±l deÄŸiÅŸtiÄŸinde)
      if (window.supabase) {
        setupRealtimeSubscription();
      }
      
      // Paralel API yÃ¼kleme: Tutar, kapasite ve mahaller birbirinden baÄŸÄ±msÄ±z
      await Promise.all([
        loadTutarSecenekleri(),
        loadKapasiteAyarlari(),
        loadMahaller()
      ]);
      // KayÄ±tlar mahaller ile render edildiÄŸi iÃ§in sÄ±ralÄ±
      await loadKayitlar();
      if (qs('#takvimimView') && qs('#takvimimView').style.display !== 'none') {
        await loadMyRecords();
      }
    }

    // Mahal yÃ¼kleme
    // Helper: Personel ismi normalize etme (TÃ¼rkÃ§e karakter ve boÅŸluk temizliÄŸi)
    function normalizePersonelName(name) {
      if (!name) return '';
      return name
        .toLocaleLowerCase('tr-TR')
        .replace(/ÄŸ/g, 'g')
        .replace(/Ã¼/g, 'u')
        .replace(/ÅŸ/g, 's')
        .replace(/Ä±/g, 'i')
        .replace(/Ã¶/g, 'o')
        .replace(/Ã§/g, 'c')
        .replace(/\s+/g, '')
        .trim();
    }

    // Mahal yÃ¼kleme
    async function loadMahaller() {
      try {
        const { data, error } = await window.supabase
          .from('ramazan_mahaller')
          .select('id, adi, maxmusafir, minmusafir')
          .order('id', { ascending: true }); // 'sira' kolonu yoksa 'id' kullan

        if (error) throw error;
        if (error) throw error;
        // Map DB columns (lowercase) to code expected properties (CamelCase)
        mahaller = (data || []).map(m => ({
          ...m,
          minMusafir: m.minMusafir || m.minmusafir || 1,
          maxMusafir: m.maxMusafir || m.maxmusafir || 9999,
          adi: m.adi || m.ad
        }));
        renderMahaller();
      } catch (e) {
        console.error('Mahaller yÃ¼klenemedi:', e);
        mahaller = [];
        renderMahaller();
      }
    }

    // ... (Existing code) ...

    let duzenlemeTalepleri = [];

    async function loadDuzenlemeTalepleri() {
      if (!currentUser || !CURRENT_YIL) {
        duzenlemeTalepleri = [];
        return;
      }
      try {
        const { data, error } = await window.supabase
          .from('duzenleme_talepleri')
          .select('id, yil, kayitid, kayittipi, taleptipi, aciklama, durum, personeladi, yenitarih, mahalid, onaylayanuid, onaylanmatarihi, rededenuid, redtarihi, redaciklama, createdat, updatedat')
          .eq('yil', CURRENT_YIL)
          // .eq('personelUid', currentUser.id) // Schema'da personelUid yok (personelAdi var), ÅŸimdilik devre dÄ±ÅŸÄ±.
          // .eq('personelAdi', currentPersonelAdi) // Alternatif olarak isimle filtreleme denenebilir ama deÄŸiÈ™kenlik gÃ¶sterebilir.
          .eq('durum', 'beklemede');

        if (error) {
          // Opsiyonel hata yÃ¶netimi
          console.warn('DÃ¼zenleme talepleri uyarÄ±sÄ±:', error);
          duzenlemeTalepleri = [];
        } else {
          // NOT: duzenleme_talepleri tablosunda personeluid kolonu yok, sadece personeladi var (sqleditor.md'ye gÃ¶re)
          duzenlemeTalepleri = (data || []).map(d => ({
            ...d,
            kayitId: d.kayitId || d.kayitid,
            kayitTipi: d.kayitTipi || d.kayittipi,
            talepTipi: d.talepTipi || d.taleptipi,
            yeniTarih: d.yeniTarih || d.yenitarih,
            mahalId: d.mahalId || d.mahalid,
            personelAdi: d.personelAdi || d.personeladi
          }));
        }
      } catch (e) {
        console.error('DÃ¼zenleme talepleri yÃ¼klenemedi:', e);
        duzenlemeTalepleri = [];
      }
    }

    // ... (Existing loadImportedVeriler) ...

    async function loadKapasiteAyarlari() {
      try {
        // Genel kapasite
        if (ramazanAyari) {
          kapasiteAyarlari.genel = {
            iftarMax: ramazanAyari.iftar_kapasite || null,
            sahurMax: ramazanAyari.sahur_kapasite || null
          };
        } else {
          kapasiteAyarlari.genel = { iftarMax: null, sahurMax: null };
        }

        // GÃ¼nlÃ¼k kapasite ayarlarÄ±
        const { data, error } = await window.supabase
          .from('ramazan_kapasite')
          .select('id, yil, tarih, iftarmax, sahurmax, created_at, updated_at')
          .eq('yil', CURRENT_YIL);

        if (error) {
          if (error.code !== 'PGRST116') console.warn('Kapasite tablosu okunamadÄ±:', error);
          kapasiteAyarlari.gunluk = [];
        } else {
          kapasiteAyarlari.gunluk = data || [];
        }
      } catch (e) {
        console.error('Kapasite ayarlarÄ± yÃ¼klenemedi:', e);
        kapasiteAyarlari.genel = { iftarMax: null, sahurMax: null };
        kapasiteAyarlari.gunluk = [];
      }
    }

    async function loadTutarSecenekleri() {
      try {
        const { data, error } = await window.supabase
          .from('ramazan_secenekler')
          .select('id, label, tutar, sira, aktif, tip')
          .eq('aktif', true)
          .order('sira', { ascending: true });

        if (error) throw error;
        tutarSecenekleri = data || [];
        renderPriceChips();
      } catch (e) {
        console.error('Tutar hatasÄ±:', e);
      }
    }

    function renderPriceChips() {
      const container = qs('#priceChips');
      if (!container) return;
      const tip = qs('#fType').value;
      const filtered = tutarSecenekleri.filter(t => t.tip === tip || t.tip === 'genel');

      container.innerHTML = '';
      if (filtered.length === 0) {
        container.innerHTML = '<div class="chip">SeÃ§enek yok</div>';
        return;
      }

      filtered.forEach(t => {
        const chip = document.createElement('div');
        chip.className = 'chip';
        chip.innerText = t.tutar + ' â‚º';
        chip.onclick = () => selectChip('price', t.tutar, chip);
        container.appendChild(chip);
      });
    }

    async function loadKayitlar(options = {}) {
      const { skipMyRecords = false } = options || {};
      if (isLoadingKayitlar) return;
      isLoadingKayitlar = true;
      if (!CURRENT_YIL) {
        console.warn('CURRENT_YIL henÃ¼z ayarlanmamÄ±ÅŸ, kayÄ±tlar yÃ¼klenemiyor');
        kayitlar = [];
        return;
      }
      try {
        const { data, error } = await window.supabase
          .from('ramazan_kayitlari')
          .select('id, yil, tip, sahip, tutar, istirak, musafiradedi, ay, mahalid, mahal, personel, personeladi, personeluid, kaydedenpersonel, kaydedenpersoneluid, notlar, createdat, updatedat, tarih')
          .eq('yil', CURRENT_YIL);

        if (error) {
          if (error.code !== 'PGRST116') console.error('KayÄ±tlar yÃ¼klenemedi:', error);
          kayitlar = [];
        } else {
          kayitlar = (data || []).map(k => {
            const createdat = k.createdat ?? k.createdAt ?? null;
            const updatedat = k.updatedat ?? k.updatedAt ?? null;
            const personeluid = k.personeluid ?? k.personelUid ?? null;
            const mahalid = k.mahalid ?? k.mahalId ?? null;
            const musafiradedi = k.musafiradedi ?? k.musafirAdedi ?? null;
            const notlar = k.notlar ?? k.not ?? null;
            return {
              ...k,
              // canonical (schema)
              createdat,
              updatedat,
              personeluid,
              mahalid,
              musafiradedi,
              notlar,
              // legacy aliases used in UI code (keep)
              createdAt: createdat,
              updatedAt: updatedat,
              personelUid: personeluid,
              mahalId: mahalid,
              musafirAdedi: musafiradedi,
              not: notlar
            };
          });
        }

        // Tahsilat Ã¶nbelleÄŸi (geÃ§miÅŸ gÃ¼n kartlarÄ± iÃ§in)
        tahsilatByKayitId = {};
        const kayitIds = (kayitlar || []).map(k => k.id).filter(Boolean);
        if (kayitIds.length > 0 && window.supabase) {
          try {
            const { data: tahsilatData } = await window.supabase
              .from('ramazan_tahsilat')
              .select('kayit_id, tutar')
              .in('kayit_id', kayitIds);
            kayitIds.forEach(id => { tahsilatByKayitId[id] = 0; });
            (tahsilatData || []).forEach(t => {
              const kid = t.kayit_id;
              tahsilatByKayitId[kid] = (tahsilatByKayitId[kid] || 0) + (Number(t.tutar) || 0);
            });
          } catch (e) { console.warn('Tahsilat Ã¶nbelleÄŸi yÃ¼klenemedi:', e); }
        }

        // renderAllViews Ã§aÄŸÄ±r (Mobil + MasaÃ¼stÃ¼)
        if (typeof renderAllViews === 'function') renderAllViews();

        // KayÄ±tlarÄ±m sekmesi aÃ§Ä±ksa, kayÄ±tlarÄ± yÃ¼kle
        if (!skipMyRecords && qs('#takvimimView') && qs('#takvimimView').style.display !== 'none') {
          await loadMyRecords();
        }
      } catch (e) {
        console.error('KayÄ±t yÃ¼kleme hatasÄ±:', e);
        kayitlar = [];
      } finally {
        isLoadingKayitlar = false;
      }
    }

    // Mahal render (mÃ¼safir adedine gÃ¶re filtrele)
    function renderMahaller() {
      const container = qs('#mahalChips');
      if (!container) return; // Element henÃ¼z DOM'da yoksa Ã§Ä±k

      const musafirAdedi = parseInt(qs('#fGuest')?.value || '0', 10) || 0;

      if (mahaller.length === 0) {
        container.innerHTML = '<div class="chip" style="opacity:0.5;">Mahal bulunamadÄ±</div>';
        return;
      }

      const tarihStr = qs('#fDate')?.value || '';
      const tip = qs('#fType')?.value || 'iftar';
      const istirak = (qs('#fIstirak')?.value || 'true') === 'true';

      container.innerHTML = '';
      mahaller.forEach(m => {
        const minMusafir = m.minMusafir || 1;
        const maxMusafir = m.maxMusafir || 9999;
        const uyumlu = musafirAdedi >= minMusafir && musafirAdedi <= maxMusafir;

        // Mahal kontrolÃ¼: Her mahale bir tarihte sadece bir kayÄ±t (iftar/sahur ayrÄ±, sadece iÅŸtirak edenler iÃ§in)
        let mahalDolu = false;
        if (uyumlu && istirak && tarihStr) {
          const mahalCheck = checkMahalAvailability(tarihStr, tip, m.id);
          mahalDolu = !mahalCheck.allowed;
        }

        const chip = document.createElement('div');
        chip.className = `chip ${uyumlu && !mahalDolu ? '' : 'disabled'}`;
        chip.style.opacity = (uyumlu && !mahalDolu) ? '1' : '0.5';
        chip.style.cursor = (uyumlu && !mahalDolu) ? 'pointer' : 'not-allowed';
        chip.style.position = 'relative';

        if (mahalDolu) {
          chip.style.background = '#ffebee';
          chip.style.borderColor = '#f44336';
          chip.title = `${tip === 'iftar' ? 'Ä°ftar' : 'Sahur'} iÃ§in ${tarihStr} tarihinde bu mahal zaten dolu!`;
        } else if (!uyumlu) {
          chip.title = `Bu mahal iÃ§in mÃ¼safir sayÄ±sÄ± ${minMusafir}-${maxMusafir} arasÄ±nda olmalÄ±dÄ±r`;
        }

        if (uyumlu && !mahalDolu) {
          chip.onclick = () => selectChip('mahal', m.id, chip);
        }

        chip.innerHTML = `
          ${m.adi}
          ${!uyumlu ? `<span style="font-size:10px; margin-left:5px; color:#999;">(${minMusafir}-${maxMusafir})</span>` : ''}
          ${mahalDolu ? `<span style="font-size:10px; margin-left:5px; color:#f44336;">(Dolu)</span>` : ''}
        `;

        container.appendChild(chip);
      });

      // Ä°lk uyumlu ve dolu olmayan mahali seÃ§
      const firstUyumlu = mahaller.find(m => {
        const minMusafir = m.minMusafir || 1;
        const maxMusafir = m.maxMusafir || 9999;
        const uyumlu = musafirAdedi >= minMusafir && musafirAdedi <= maxMusafir;
        if (!uyumlu || !istirak || !tarihStr) return uyumlu;
        const mahalCheck = checkMahalAvailability(tarihStr, tip, m.id);
        return uyumlu && mahalCheck.allowed;
      });
      if (firstUyumlu) {
        const fMahalEl = qs('#fMahal');
        if (fMahalEl) fMahalEl.value = firstUyumlu.id;
        const firstChip = container.querySelector('.chip:not(.disabled)');
        if (firstChip) firstChip.classList.add('selected');
      }
    }

    // showAlert iÃ§in modal kullan (kritik mesajlar iÃ§in)
    function showAlert(message, type = 'info') {
      // Basit mesajlar iÃ§in toast kullan
      if (message.includes('baÅŸarÄ±yla') || message.includes('silindi') || message.includes('kaydedildi') || message.includes('gÃ¼ncellendi') || message.includes('gÃ¶nderildi')) {
        showToast('success', 'BaÅŸarÄ±lÄ±', message);
        return;
      }

      const content = qs('#alertContent');
      if (!content) return;
      const icon = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'â„¹ï¸';
      const color = type === 'error' ? 'var(--danger)' : type === 'success' ? 'var(--success)' : 'var(--primary)';
      content.innerHTML = `<div style="font-size:48px; margin-bottom:15px;">${icon}</div><div style="font-size:16px; color:${color}; font-weight:600;">${message}</div>`;
      const alertModal = qs('#alertModal');
      if (alertModal) alertModal.classList.add('open');
    }

    function closeAlertModal() {
      qs('#alertModal').classList.remove('open');
    }

    // MenÃ¼ yÃ¼kleme ve gÃ¶rÃ¼ntÃ¼leme (yeni sistem: ramazan_gun_menuleri tablosundan)
    async function loadMenuler() {
      const container = qs('#menuDaysList');
      if (container && !CURRENT_YIL) {
        container.innerHTML = '<div style="text-align:center; padding:20px; color:#999">YÄ±l seÃ§imi yapÄ±lmamÄ±ÅŸ</div>';
        return;
      }

      try {
        // GÃ¼nlere atanmÄ±ÅŸ menÃ¼leri yÃ¼kle
        const { data, error } = await window.supabase
          .from('ramazan_gun_menuleri')
          .select('id, tarih, tip, menu_id, menu_ismi, menu_detay, yil')
          .eq('yil', CURRENT_YIL);

        if (error) {
          console.error('GÃ¼n menÃ¼leri yÃ¼klenemedi:', error);
          menuler = [];
        } else {
          menuler = data || [];
        }
        renderMenuDays();
      } catch (e) {
        console.error('MenÃ¼ler yÃ¼klenemedi:', e);
        menuler = [];
        if (container) {
          container.innerHTML = '<div style="text-align:center; padding:20px; color:#999">MenÃ¼ler yÃ¼klenemedi</div>';
        }
      }
    }

    function renderMenuDays() {
      const container = qs('#menuDaysList');
      if (!container) return;

      if (!ramazanAyari) {
        container.innerHTML = '<div style="text-align:center; padding:20px; color:#999">Ramazan ayarlarÄ± yÃ¼klenemedi</div>';
        return;
      }

      const basParts = ramazanAyari.baslangic.split('-');
      const bitParts = ramazanAyari.bitis.split('-');
      const start = new Date(basParts[0], basParts[1] - 1, basParts[2], 12, 0, 0);
      const end = new Date(bitParts[0], bitParts[1] - 1, bitParts[2], 12, 0, 0);

      let current = new Date(start);
      let dayCounter = 1;
      let html = '';

      while (current <= end) {
        const dateStr = current.toISOString().slice(0, 10);
        
        // Yeni sistem: ramazan_gun_menuleri tablosundan eÅŸleÅŸtirme
        const iftarMenu = menuler.find(m => {
          let mTarih = '';
          if (m.tarih) {
            if (typeof m.tarih === 'string') mTarih = m.tarih.slice(0, 10);
            else if (m.tarih.toDate) mTarih = m.tarih.toDate().toISOString().slice(0, 10);
            else if (m.tarih.seconds) mTarih = new Date(m.tarih.seconds * 1000).toISOString().slice(0, 10);
          }
          return mTarih === dateStr && m.tip === 'iftar';
        });
        const sahurMenu = menuler.find(m => {
          let mTarih = '';
          if (m.tarih) {
            if (typeof m.tarih === 'string') mTarih = m.tarih.slice(0, 10);
            else if (m.tarih.toDate) mTarih = m.tarih.toDate().toISOString().slice(0, 10);
            else if (m.tarih.seconds) mTarih = new Date(m.tarih.seconds * 1000).toISOString().slice(0, 10);
          }
          return mTarih === dateStr && m.tip === 'sahur';
        });

        const hasMenu = iftarMenu || sahurMenu;
        const tarihStr = current.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric' });
        const gunAdi = current.toLocaleDateString('tr-TR', { weekday: 'long' });

        html += `
          <div style="background:white; border-radius:12px; padding:15px; margin-bottom:12px; border:1px solid #e0e0e0; cursor:pointer; transition:0.2s;" 
               onclick="openMenuDetailModal('${dateStr}')" 
               onmouseover="this.style.borderColor='var(--primary)'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'"
               onmouseout="this.style.borderColor='#e0e0e0'; this.style.transform='none'; this.style.boxShadow='none'">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
              <div>
                <div style="font-weight:700; font-size:16px; color:#2c3e50;">${dayCounter}. GÃ¼n</div>
                <div style="font-size:13px; color:#7f8c8d; margin-top:2px;">${tarihStr} - ${gunAdi}</div>
              </div>
              <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end;">
                ${iftarMenu ? `<span style="background:var(--accent); color:white; padding:4px 10px; border-radius:6px; font-size:12px; font-weight:600;">ğŸŒ™ ${iftarMenu.menu_ismi || 'Ä°ftar'}</span>` : ''}
                ${sahurMenu ? `<span style="background:#3498db; color:white; padding:4px 10px; border-radius:6px; font-size:12px; font-weight:600;">ğŸŒŸ ${sahurMenu.menu_ismi || 'Sahur'}</span>` : ''}
                ${!hasMenu ? '<span style="background:#e0e0e0; color:#666; padding:4px 10px; border-radius:6px; font-size:12px;">MenÃ¼ yok</span>' : ''}
              </div>
            </div>
          </div>
        `;

        current.setDate(current.getDate() + 1);
        dayCounter++;
      }

      container.innerHTML = html || '<div style="text-align:center; padding:20px; color:#999">MenÃ¼ bulunamadÄ±</div>';
    }

    function openMenuDetailModal(dateStr) {
      // Modal sadece menÃ¼ gÃ¶rÃ¼nÃ¼mÃ¼ aÃ§Ä±kken aÃ§Ä±labilir
      const menuView = qs('#menuView');
      if (!menuView || menuView.style.display === 'none') {
        return; // MenÃ¼ gÃ¶rÃ¼nÃ¼mÃ¼ aÃ§Ä±k deÄŸilse modal aÃ§ma
      }

      // Yeni sistem: ramazan_gun_menuleri tablosundan eÅŸleÅŸtirme
      const iftarMenu = menuler.find(m => {
        let mTarih = '';
        if (m.tarih) {
          if (typeof m.tarih === 'string') mTarih = m.tarih.slice(0, 10);
          else if (m.tarih.toDate) mTarih = m.tarih.toDate().toISOString().slice(0, 10);
          else if (m.tarih.seconds) mTarih = new Date(m.tarih.seconds * 1000).toISOString().slice(0, 10);
        }
        return mTarih === dateStr && m.tip === 'iftar';
      });
      const sahurMenu = menuler.find(m => {
        let mTarih = '';
        if (m.tarih) {
          if (typeof m.tarih === 'string') mTarih = m.tarih.slice(0, 10);
          else if (m.tarih.toDate) mTarih = m.tarih.toDate().toISOString().slice(0, 10);
          else if (m.tarih.seconds) mTarih = new Date(m.tarih.seconds * 1000).toISOString().slice(0, 10);
        }
        return mTarih === dateStr && m.tip === 'sahur';
      });

      const tarih = new Date(dateStr);
      const tarihStr = tarih.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric' });
      qs('#menuDetailTitle').textContent = `ğŸ½ï¸ ${tarihStr} MenÃ¼sÃ¼`;

      let content = '';

      // Ä°ftar MenÃ¼sÃ¼
      content += `
        <div style="margin-bottom:25px;">
          <h4 style="margin:0 0 15px 0; font-size:18px; font-weight:600; color:var(--accent); display:flex; align-items:center; gap:8px;">
            <span>ğŸŒ™</span> <span>Ä°ftar MenÃ¼sÃ¼</span>
          </h4>
      `;

      if (iftarMenu) {
        content += `
          <div style="background:#f8f9fa; border-radius:10px; padding:15px;">
            <div style="margin-bottom:12px; font-weight:600; color:var(--accent); font-size:15px;">${iftarMenu.menu_ismi || 'Ä°ftar MenÃ¼sÃ¼'}</div>
            ${iftarMenu.menu_detay ? `<div style="color:#6c757d; line-height:1.7; font-size:14px;">${iftarMenu.menu_detay.split(' â€¢ ').map(item => `<div style="margin-bottom:6px;">â€¢ ${item}</div>`).join('')}</div>` : '<div style="color:#999; font-style:italic;">Detay girilmemiÅŸ</div>'}
          </div>
        `;
      } else {
        content += `
          <div style="background:#fff3cd; border-left:4px solid #ffc107; border-radius:10px; padding:15px; text-align:center;">
            <div style="color:#856404; font-weight:500;">Yemek menÃ¼sÃ¼ henÃ¼z daha belli deÄŸil</div>
          </div>
        `;
      }

      content += `</div>`;

      // Sahur MenÃ¼sÃ¼
      content += `
        <div>
          <h4 style="margin:0 0 15px 0; font-size:18px; font-weight:600; color:#3498db; display:flex; align-items:center; gap:8px;">
            <span>ğŸŒŸ</span> <span>Sahur MenÃ¼sÃ¼</span>
          </h4>
      `;

      if (sahurMenu) {
        content += `
          <div style="background:#f8f9fa; border-radius:10px; padding:15px;">
            <div style="margin-bottom:12px; font-weight:600; color:#3498db; font-size:15px;">${sahurMenu.menu_ismi || 'Sahur MenÃ¼sÃ¼'}</div>
            ${sahurMenu.menu_detay ? `<div style="color:#6c757d; line-height:1.7; font-size:14px;">${sahurMenu.menu_detay.split(' â€¢ ').map(item => `<div style="margin-bottom:6px;">â€¢ ${item}</div>`).join('')}</div>` : '<div style="color:#999; font-style:italic;">Detay girilmemiÅŸ</div>'}
          </div>
        `;
      } else {
        content += `
          <div style="background:#fff3cd; border-left:4px solid #ffc107; border-radius:10px; padding:15px; text-align:center;">
            <div style="color:#856404; font-weight:500;">Yemek menÃ¼sÃ¼ henÃ¼z daha belli deÄŸil</div>
          </div>
        `;
      }

      content += `</div>`;

      qs('#menuDetailContent').innerHTML = content;
      const modal = qs('#menuDetailModal');
      if (modal) {
        modal.classList.add('open');
      }
    }

    function closeMenuDetailModal() {
      const modal = qs('#menuDetailModal');
      if (modal) {
        modal.classList.remove('open');
      }
    }

    function showConfirm(message, callback) {
      confirmCallback = callback;
      const content = qs('#confirmContent');
      content.innerHTML = `<div style="font-size:48px; margin-bottom:15px;">â“</div><div style="font-size:16px; color:var(--text); font-weight:600;">${message}</div>`;
      qs('#confirmModal').classList.add('open');
    }

    function confirmYes() {
      if (confirmCallback) {
        confirmCallback();
        confirmCallback = null;
      }
      closeConfirmModal();
    }

    function closeConfirmModal() {
      qs('#confirmModal').classList.remove('open');
      confirmCallback = null;
    }

    // --- KAPASÄ°TE AYARLARI YÃœKLEME ---
    // --- KAPASÄ°TE AYARLARI YÃœKLEME ---
    async function loadKapasiteAyarlari() {
      try {
        if (!CURRENT_YIL) return;
        const yilNum = typeof CURRENT_YIL === 'number' ? CURRENT_YIL : parseInt(CURRENT_YIL);

        // Genel kapasite - ramazan_ayarlar tablosundan (id='genel')
        try {
          const { data: genelData, error: genelError } = await window.supabase
            .from('ramazan_ayarlar')
            .select('iftarmax, sahurmax')
            .eq('id', 'genel')
            .single();

          if (!genelError && genelData) {
            kapasiteAyarlari.genel = {
              iftarMax: genelData.iftarmax !== null && genelData.iftarmax !== undefined ? genelData.iftarmax : null,
              sahurMax: genelData.sahurmax !== null && genelData.sahurmax !== undefined ? genelData.sahurmax : null
            };
          } else {
            kapasiteAyarlari.genel = { iftarMax: null, sahurMax: null };
          }
        } catch (e) {
          console.warn('Genel kapasite yÃ¼klenemedi:', e);
          kapasiteAyarlari.genel = { iftarMax: null, sahurMax: null };
        }

        // GÃ¼nlÃ¼k kapasite ayarlarÄ± - ramazan_kapasite tablosu
        const { data: gunlukData, error } = await window.supabase
          .from('ramazan_kapasite')
          .select('id, yil, tarih, iftarmax, sahurmax, created_at, updated_at')
          .eq('yil', yilNum);

        if (error) {
          console.error('Kapasite ayarlarÄ± (ramazan_kapasite) yÃ¼klenemedi:', error);
          kapasiteAyarlari.gunluk = [];
        } else {
          // Tarih formatÄ±nÄ± Date objesine veya uyumlu stringe Ã§evir
          kapasiteAyarlari.gunluk = (gunlukData || []).map(d => ({
            ...d,
            tarih: d.tarih,
            // Map DB columns (lowercase) to code expected properties (CamelCase)
            iftarMax: d.iftarMax !== undefined ? d.iftarMax : d.iftarmax,
            sahurMax: d.sahurMax !== undefined ? d.sahurMax : d.sahurmax
          }));
        }

      } catch (e) {
        console.error('Kapasite ayarlarÄ± yÃ¼klenemedi:', e);
        kapasiteAyarlari.genel = { iftarMax: null, sahurMax: null };
        kapasiteAyarlari.gunluk = [];
      }
    }

    // GÃ¼n durumu belirleme (status renkleri iÃ§in)
    function getDayStatus(tarihStr, iftarCount, sahurCount) {
      // GÃ¼nlÃ¼k kapasite kontrolÃ¼
      const gunlukAyar = kapasiteAyarlari.gunluk.find(k => {
        let kTarih = '';
        if (k.tarih) {
          if (k.tarih.toDate) {
            kTarih = k.tarih.toDate().toISOString().slice(0, 10);
          } else if (typeof k.tarih === 'string') {
            kTarih = k.tarih.slice(0, 10);
          } else if (k.tarih instanceof Date) {
            kTarih = k.tarih.toISOString().slice(0, 10);
          }
        }
        return kTarih === tarihStr;
      });

      let iftarMax = null;
      let sahurMax = null;

      if (gunlukAyar) {
        iftarMax = gunlukAyar.iftarMax;
        sahurMax = gunlukAyar.sahurMax;
      } else if (kapasiteAyarlari.genel) {
        iftarMax = kapasiteAyarlari.genel.iftarMax;
        sahurMax = kapasiteAyarlari.genel.sahurMax;
      }

      // Status belirleme - Sadece iftar kapasitesine gÃ¶re kÄ±rmÄ±zÄ±/doldu
      let statusClass = 'status-green';
      let statusText = 'MÃ¼sait';

      const iftarDolu = iftarMax !== null && iftarMax !== undefined && iftarCount >= iftarMax;
      const sahurDolu = sahurMax !== null && sahurMax !== undefined && sahurCount >= sahurMax;

      // Ä°ftar kapasitesi doluysa hemen kÄ±rmÄ±zÄ± + Doldu (sahuru beklemeden)
      if (iftarDolu) {
        statusClass = 'status-red';
        statusText = 'Doldu';
      } else if (sahurDolu) {
        // Sadece sahur doluysa turuncu
        statusClass = 'status-orange';
        statusText = 'Doluyor';
      } else if (iftarMax !== null && iftarMax > 0) {
        // Ä°ftar kapasitesi dolmak Ã¼zere (80%+)
        const iftarYuzde = (iftarCount / iftarMax) * 100;
        if (iftarYuzde >= 80) {
          statusClass = 'status-orange';
          statusText = 'Doluyor';
        }
      }

      return { class: statusClass, text: statusText };
    }

    // Ä°ftar iÃ§in mÃ¼sait kamelyalarÄ± dÃ¶ndÃ¼r (o tarihte dolu olmayan mahaller)
    function getMÃ¼saitIftarKamelyalari(dateStr) {
      if (!mahaller || mahaller.length === 0) return [];
      const tarihStr = dateStr.includes('T') ? dateStr.split('T')[0] : dateStr.slice(0, 10);
      return mahaller
        .filter(m => checkMahalAvailability(tarihStr, 'iftar', m.id).allowed)
        .map(m => m.adi);
    }

    // Kapasite kontrolÃ¼ (async olmalÄ± - veritabanÄ±ndan gÃ¼ncel kayÄ±tlarÄ± Ã§ekmeli)
    async function checkKapasite(tarihStr, tip) {
      // VeritabanÄ±ndan gÃ¼ncel kayÄ±tlarÄ± Ã§ek (race condition Ã¶nleme)
      // Tarih formatÄ±nÄ± dÃ¼zelt (YYYY-MM-DD formatÄ±nda olmalÄ±)
      const tarihFormatted = tarihStr.includes('T') ? tarihStr.split('T')[0] : tarihStr.slice(0, 10);
      const tarihISO = tarihFormatted + 'T12:00:00.000Z';
      
      const { data: dayRecsData, error: recError } = await window.supabase
        .from('ramazan_kayitlari')
        .select('id, tip, istirak')
        .eq('tarih', tarihISO)
        .eq('tip', tip)
        .eq('yil', CURRENT_YIL);

      if (recError) {
        console.error('Kapasite kontrolÃ¼ iÃ§in kayÄ±tlar yÃ¼klenemedi:', recError);
        // Fallback: mevcut kayitlar array'ini kullan
        const dayRecs = kayitlar.filter(k => {
          let kStr = '';
          if (k.tarih?.toDate) kStr = k.tarih.toDate().toISOString().slice(0, 10);
          else if (typeof k.tarih === 'string') kStr = k.tarih.slice(0, 10);
          else if (k.tarih instanceof Date) kStr = k.tarih.toISOString().slice(0, 10);
          return kStr === tarihStr && k.tip === tip;
        });
        const mevcutSayi = dayRecs.filter(k => k.istirak === true).length;
        
        // Ã–nce gÃ¼nlÃ¼k kapasite kontrolÃ¼
        const gunlukAyar = kapasiteAyarlari.gunluk.find(k => {
          let kTarih = '';
          if (k.tarih) {
            if (k.tarih.toDate) {
              kTarih = k.tarih.toDate().toISOString().slice(0, 10);
            } else if (typeof k.tarih === 'string') {
              kTarih = k.tarih.slice(0, 10);
            } else if (k.tarih instanceof Date) {
              kTarih = k.tarih.toISOString().slice(0, 10);
            }
          }
          return kTarih === tarihStr;
        });

        let maxLimit = null;
        if (gunlukAyar) {
          maxLimit = tip === 'iftar' ? gunlukAyar.iftarMax : gunlukAyar.sahurMax;
        } else if (kapasiteAyarlari.genel) {
          maxLimit = tip === 'iftar' ? kapasiteAyarlari.genel.iftarMax : kapasiteAyarlari.genel.sahurMax;
        }

        if (maxLimit !== null && maxLimit !== undefined && mevcutSayi >= maxLimit) {
          return { allowed: false, message: `${tip === 'iftar' ? 'Ä°ftar' : 'Sahur'} kapasitesi dolmuÅŸ! (Max: ${maxLimit}, Mevcut: ${mevcutSayi})` };
        }

        return { allowed: true };
      }

      // Sadece iÅŸtirak edenleri say (kapasite kontrolÃ¼ iÃ§in)
      const mevcutSayi = (dayRecsData || []).filter(k => k.istirak === true).length;

      // Ã–nce gÃ¼nlÃ¼k kapasite kontrolÃ¼
      const gunlukAyar = kapasiteAyarlari.gunluk.find(k => {
        let kTarih = '';
        if (k.tarih) {
          if (k.tarih.toDate) {
            kTarih = k.tarih.toDate().toISOString().slice(0, 10);
          } else if (typeof k.tarih === 'string') {
            kTarih = k.tarih.slice(0, 10);
          } else if (k.tarih instanceof Date) {
            kTarih = k.tarih.toISOString().slice(0, 10);
          }
        }
        return kTarih === tarihStr;
      });

      let maxLimit = null;
      if (gunlukAyar) {
        maxLimit = tip === 'iftar' ? gunlukAyar.iftarMax : gunlukAyar.sahurMax;
      } else if (kapasiteAyarlari.genel) {
        maxLimit = tip === 'iftar' ? kapasiteAyarlari.genel.iftarMax : kapasiteAyarlari.genel.sahurMax;
      }

      if (maxLimit !== null && maxLimit !== undefined && mevcutSayi >= maxLimit) {
        return { allowed: false, message: `${tip === 'iftar' ? 'Ä°ftar' : 'Sahur'} kapasitesi dolmuÅŸ! (Max: ${maxLimit}, Mevcut: ${mevcutSayi})` };
      }

      return { allowed: true };
    }

    // Mahal kontrolÃ¼: Her mahale bir tarihte sadece bir kayÄ±t (iftar/sahur ayrÄ±)
    function checkMahalAvailability(tarihStr, tip, mahalId, excludeRecordId = null) {
      if (!mahalId) {
        return { allowed: true };
      }
      
      // SORUN 1 FIX: Sadece YYYY-MM-DD formatÄ±na indirge
      const targetDate = tarihStr.includes('T') ? tarihStr.split('T')[0] : tarihStr.slice(0, 10);

      // SORUN 1 FIX: Tarih karÅŸÄ±laÅŸtÄ±rmasÄ±nÄ± sadeleÅŸtir ve mahalId kontrolÃ¼nÃ¼ doÄŸru yap
      const cakisma = kayitlar.some(k => {
        // Silinen kayÄ±tlarÄ± atla
        if (k.silindi) return false;
        
        // excludeRecordId varsa o kaydÄ± atla
        if (excludeRecordId && k.id === excludeRecordId) return false;
        
        // Tarih formatÄ±nÄ± normalize et
        let kDate = '';
        if (k.tarih?.toDate) {
          kDate = k.tarih.toDate().toISOString().slice(0, 10);
        } else if (typeof k.tarih === 'string') {
          kDate = k.tarih.includes('T') ? k.tarih.split('T')[0] : k.tarih.slice(0, 10);
        } else {
          return false;
        }
        
        // Tarih, tip, mahal ve istirak kontrolÃ¼
        const tarihUyumlu = kDate === targetDate;
        const tipUyumlu = k.tip === tip;
        const mahalUyumlu = (k.mahalId ?? k.mahalid) === mahalId;
        const istirakUyumlu = k.istirak === true;
        
        return tarihUyumlu && tipUyumlu && mahalUyumlu && istirakUyumlu;
      });

      if (cakisma) {
        const mahal = mahaller.find(m => m.id === mahalId);
        const mahalAdi = mahal ? mahal.adi : 'SeÃ§ilen mahal';
        return {
          allowed: false,
          message: `${tip === 'iftar' ? 'Ä°ftar' : 'Sahur'} iÃ§in ${targetDate} tarihinde ${mahalAdi} zaten dolu! LÃ¼tfen baÅŸka bir mahal veya tarih seÃ§iniz.`
        };
      }

      return { allowed: true };
    }

    // --- TUTAR YÃœKLEME (Tip'e gÃ¶re filtreleme ile) ---


    function renderAllViews() {
      renderTimeline(); // Mobil
      renderDesktopCalendar(); // MasaÃ¼stÃ¼
    }

    // --- MOBÄ°L TIMELINE ---
    function renderTimeline() {
      const container = qs('#mobileView');
      container.innerHTML = '';

      const basParts = ramazanAyari.baslangic.split('-');
      const bitParts = ramazanAyari.bitis.split('-');
      const start = new Date(basParts[0], basParts[1] - 1, basParts[2], 12, 0, 0);
      const end = new Date(bitParts[0], bitParts[1] - 1, bitParts[2], 12, 0, 0);

      let current = new Date(start);
      let dayCounter = 1;
      const today = new Date();
      const todayStr = today.getFullYear() + '-' + String(today.getMonth() + 1).padStart(2, '0') + '-' + String(today.getDate()).padStart(2, '0');
      let prevDayWasPast = false;
      let prevDayWasToday = false;

      while (current <= end) {
        const dateStr = current.toISOString().slice(0, 10);
        const isPast = dateStr < todayStr;
        const isToday = dateStr === todayStr;
        const isFuture = dateStr > todayStr;
        if (prevDayWasPast && !isPast) {
          const sep = document.createElement('div');
          sep.className = 'day-separator';
          container.appendChild(sep);
        }
        if (prevDayWasToday && isFuture) {
          const sep = document.createElement('div');
          sep.className = 'day-separator';
          container.appendChild(sep);
        }
        prevDayWasPast = isPast;
        prevDayWasToday = isToday;
        let dayRecs = kayitlar.filter(k => {
          // Tarih parse gÃ¼venliÄŸi
          let kStr = '';
          if (k.tarih.toDate) kStr = k.tarih.toDate().toISOString().slice(0, 10);
          else if (typeof k.tarih === 'string') kStr = k.tarih.slice(0, 10);
          return kStr === dateStr;
        });
        
        // UI/UX: Takvim iÃ§in filtreleme uygula
        if (currentCalendarFilter !== 'all') {
          dayRecs = dayRecs.filter(k => {
            if (currentCalendarFilter === 'iftar') return k.tip === 'iftar';
            if (currentCalendarFilter === 'sahur') return k.tip === 'sahur';
            return true;
          });
        }

        // Ä°ÅŸtirak eden ve etmeyen kayÄ±tlarÄ± ayÄ±r
        const iftarIstirakEden = dayRecs.filter(k => k.tip === 'iftar' && k.istirak === true).length;
        const iftarIstirakEtmeyen = dayRecs.filter(k => k.tip === 'iftar' && k.istirak === false).length;
        const sahurIstirakEden = dayRecs.filter(k => k.tip === 'sahur' && k.istirak === true).length;
        const sahurIstirakEtmeyen = dayRecs.filter(k => k.tip === 'sahur' && k.istirak === false).length;

        // Kapasite kontrolÃ¼ iÃ§in sadece iÅŸtirak edenleri say
        const iftarCount = iftarIstirakEden;
        const sahurCount = sahurIstirakEden;

        // Kapasite kontrolÃ¼ ile status belirleme
        const statusInfo = getDayStatus(dateStr, iftarCount, sahurCount);
        const statusClass = statusInfo.class;
        const statusText = statusInfo.text;

        // Kapasite bilgisi
        const gunlukAyar = kapasiteAyarlari.gunluk.find(k => {
          let kTarih = '';
          if (k.tarih) {
            if (k.tarih.toDate) kTarih = k.tarih.toDate().toISOString().slice(0, 10);
            else if (typeof k.tarih === 'string') kTarih = k.tarih.slice(0, 10);
            else if (k.tarih instanceof Date) kTarih = k.tarih.toISOString().slice(0, 10);
          }
          return kTarih === dateStr;
        });
        const iftarMax = gunlukAyar ? gunlukAyar.iftarMax : (kapasiteAyarlari.genel ? kapasiteAyarlari.genel.iftarMax : null);
        const sahurMax = gunlukAyar ? gunlukAyar.sahurMax : (kapasiteAyarlari.genel ? kapasiteAyarlari.genel.sahurMax : null);

        // GÃ¶sterim formatÄ±: "3/5, 4" (iÅŸtirak eden/max, iÅŸtirak etmeyen)
        let iftarText = iftarCount.toString();
        if (iftarMax !== null && iftarMax !== undefined) {
          iftarText = `${iftarIstirakEden}/${iftarMax}`;
          if (iftarIstirakEtmeyen > 0) {
            iftarText += `, ${iftarIstirakEtmeyen}`;
          }
        } else if (iftarIstirakEtmeyen > 0) {
          iftarText += `, ${iftarIstirakEtmeyen}`;
        }

        let sahurText = sahurCount.toString();
        if (sahurMax !== null && sahurMax !== undefined) {
          sahurText = `${sahurIstirakEden}/${sahurMax}`;
          if (sahurIstirakEtmeyen > 0) {
            sahurText += `, ${sahurIstirakEtmeyen}`;
          }
        } else if (sahurIstirakEtmeyen > 0) {
          sahurText += `, ${sahurIstirakEtmeyen}`;
        }

        const mÃ¼saitKamelyalar = getMÃ¼saitIftarKamelyalari(dateStr);
        const kamelyaPalet = ['#e8f5e9', '#e3f2fd', '#fff3e0', '#fce4ec', '#f3e5f5', '#e0f7fa'];
        const mÃ¼saitKamelyaHtml = mÃ¼saitKamelyalar.length > 0
          ? mÃ¼saitKamelyalar.map((k, i) => {
              const bg = kamelyaPalet[i % kamelyaPalet.length];
              return `<span class="dc-kamelya-chip" style="background:${bg}; color:#37474f;">${escapeHtml(k)}</span>`;
            }).join('')
          : '<span style="color:#95a5a6;">Yok</span>';

        const toplamTutar = dayRecs.reduce((s, k) => s + (parseFloat(k.tutar) || 0), 0);
        const toplamTahsilat = dayRecs.reduce((s, k) => s + (tahsilatByKayitId[k.id] || 0), 0);
        const toplamKalan = toplamTutar - toplamTahsilat;

        const card = document.createElement('div');
        card.className = `day-card ${statusClass}${isToday ? ' day-card-today' : ''}${isPast ? ' day-card-past' : ''}`;
        const dStr = dateStr;
        card.onclick = () => showDayRecords(dStr);

        const ayAdi = current.toLocaleDateString('tr-TR', { month: 'long' });
        const pastDetailsHtml = isPast
          ? `<div class="dc-past-finans" style="font-size:12px; color:#7f8c8d; margin-top:6px;">
               <div>Toplam: <strong>${toplamTutar.toLocaleString('tr-TR')} â‚º</strong></div>
               <div>Tahsilat: <strong>${toplamTahsilat.toLocaleString('tr-TR')} â‚º</strong></div>
               <div>Kalan: <strong>${toplamKalan.toLocaleString('tr-TR')} â‚º</strong></div>
             </div>`
          : `<div class="dc-musait-kamelya"><span class="dc-musait-label">ğŸ›ï¸ Ä°ftar mÃ¼sait:</span> ${mÃ¼saitKamelyaHtml}</div>`;

        card.innerHTML = `
          <div class="dc-date">
            <span class="dc-day-num">${current.getDate()}</span>
            <span class="dc-day-name">${current.toLocaleDateString('tr-TR', { weekday: 'short' })}</span>
            <span class="dc-month">${ayAdi}</span>
          </div>
          <div class="dc-info">
            <div class="dc-ramazan">${dayCounter}. GÃœN</div>
            <div class="dc-status">${statusText}</div>
            <div class="dc-details">
               <span class="badge-mini" style="background:#f39c12; padding:2px 6px; border-radius:4px; color:white; font-size:10px">Ä°ftar: ${iftarText}</span>
               <span class="badge-mini" style="background:#3498db; padding:2px 6px; border-radius:4px; color:white; font-size:10px">Sahur: ${sahurText}</span>
            </div>
            ${pastDetailsHtml}
          </div>
          <div class="dc-action">+</div>
        `;
        container.appendChild(card);

        current.setDate(current.getDate() + 1);
        dayCounter++;
      }
    }

    // --- MASAÃœSTÃœ TAKVÄ°M ---
    function renderDesktopCalendar() {
      const container = qs('#desktopView');
      container.innerHTML = '';

      const basParts = ramazanAyari.baslangic.split('-');
      const start = new Date(basParts[0], basParts[1] - 1, basParts[2]);
      const monthStart = new Date(start.getFullYear(), start.getMonth(), 1);

      // BoÅŸ gÃ¼nler
      const firstDay = (monthStart.getDay() + 6) % 7; // Pzt baÅŸlasÄ±n
      for (let i = 0; i < firstDay; i++) {
        const empty = document.createElement('div'); empty.className = 'cal-cell empty'; container.appendChild(empty);
      }

      // Basit mantÄ±k: Sadece Ramazan gÃ¼nlerini doldurmuyorum, 35 gÃ¼nlÃ¼k bir Ä±zgara yapÄ±yorum demo iÃ§in
      // GerÃ§ekte ayÄ±n gÃ¼nleri dÃ¶nmeli. Buraya mobil akÄ±ÅŸ mantÄ±ÄŸÄ±nÄ± grid'e uyarlÄ±yorum:

      const bitParts = ramazanAyari.bitis.split('-');
      const end = new Date(bitParts[0], bitParts[1] - 1, bitParts[2], 12, 0, 0);
      let current = new Date(start);
      current.setHours(12, 0, 0, 0);

      while (current <= end) {
        const dateStr = current.toISOString().slice(0, 10);
        const dayRecs = kayitlar.filter(k => {
          let kStr = '';
          if (k.tarih.toDate) kStr = k.tarih.toDate().toISOString().slice(0, 10);
          else if (typeof k.tarih === 'string') kStr = k.tarih.slice(0, 10);
          return kStr === dateStr;
        });

        // Ä°ÅŸtirak eden ve etmeyen kayÄ±tlarÄ± ayÄ±r
        const iftarIstirakEden = dayRecs.filter(k => k.tip === 'iftar' && k.istirak === true).length;
        const iftarIstirakEtmeyen = dayRecs.filter(k => k.tip === 'iftar' && k.istirak === false).length;
        const sahurIstirakEden = dayRecs.filter(k => k.tip === 'sahur' && k.istirak === true).length;
        const sahurIstirakEtmeyen = dayRecs.filter(k => k.tip === 'sahur' && k.istirak === false).length;

        // Kapasite kontrolÃ¼ iÃ§in sadece iÅŸtirak edenleri say
        const iftarCount = iftarIstirakEden;
        const sahurCount = sahurIstirakEden;

        // Kapasite kontrolÃ¼ ile status belirleme
        const statusInfo = getDayStatus(dateStr, iftarCount, sahurCount);

        const cell = document.createElement('div');
        cell.className = `cal-cell ${statusInfo.class.replace('status-', 'cal-')}`;
        const dStr = dateStr;
        cell.onclick = () => showDayRecords(dStr);

        // Kapasite bilgisi
        const gunlukAyar = kapasiteAyarlari.gunluk.find(k => {
          let kTarih = '';
          if (k.tarih) {
            if (k.tarih.toDate) kTarih = k.tarih.toDate().toISOString().slice(0, 10);
            else if (typeof k.tarih === 'string') kTarih = k.tarih.slice(0, 10);
            else if (k.tarih instanceof Date) kTarih = k.tarih.toISOString().slice(0, 10);
          }
          return kTarih === dateStr;
        });
        const iftarMax = gunlukAyar ? gunlukAyar.iftarMax : (kapasiteAyarlari.genel ? kapasiteAyarlari.genel.iftarMax : null);
        const sahurMax = gunlukAyar ? gunlukAyar.sahurMax : (kapasiteAyarlari.genel ? kapasiteAyarlari.genel.sahurMax : null);

        // GÃ¶sterim formatÄ±: "3/5, 4" (iÅŸtirak eden/max, iÅŸtirak etmeyen)
        let iftarText = iftarCount.toString();
        if (iftarMax !== null && iftarMax !== undefined) {
          iftarText = `${iftarIstirakEden}/${iftarMax}`;
          if (iftarIstirakEtmeyen > 0) {
            iftarText += `, ${iftarIstirakEtmeyen}`;
          }
        } else if (iftarIstirakEtmeyen > 0) {
          iftarText += `, ${iftarIstirakEtmeyen}`;
        }

        let sahurText = sahurCount.toString();
        if (sahurMax !== null && sahurMax !== undefined) {
          sahurText = `${sahurIstirakEden}/${sahurMax}`;
          if (sahurIstirakEtmeyen > 0) {
            sahurText += `, ${sahurIstirakEtmeyen}`;
          }
        } else if (sahurIstirakEtmeyen > 0) {
          sahurText += `, ${sahurIstirakEtmeyen}`;
        }

        const mÃ¼saitKamelyalar = getMÃ¼saitIftarKamelyalari(dateStr);
        const kamelyaPalet = ['#e8f5e9', '#e3f2fd', '#fff3e0', '#fce4ec', '#f3e5f5', '#e0f7fa'];
        const mÃ¼saitKamelyaHtml = mÃ¼saitKamelyalar.length > 0
          ? mÃ¼saitKamelyalar.map((k, i) => {
              const bg = kamelyaPalet[i % kamelyaPalet.length];
              return `<span class="cc-kamelya-chip" style="background:${bg}; color:#37474f;">${escapeHtml(k)}</span>`;
            }).join('')
          : '<span style="color:#95a5a6;">Yok</span>';

        const ayAdi = current.toLocaleDateString('tr-TR', { month: 'long' });
        cell.innerHTML = `
          <div class="cc-header">
             <span class="cc-num">${current.getDate()}</span>
             <div class="cc-header-right">
               <span class="cc-day">${current.toLocaleDateString('tr-TR', { weekday: 'short' })}</span>
               <span class="cc-month">${ayAdi}</span>
             </div>
          </div>
          <div class="cc-badges">
             <div class="cc-badge cc-iftar ${iftarMax !== null && iftarCount >= iftarMax ? 'cc-full' : ''}">ğŸŒ™ Ä°ftar: ${iftarText}</div>
             <div class="cc-badge cc-sahur ${sahurMax !== null && sahurCount >= sahurMax ? 'cc-full' : ''}">ğŸŒŸ Sahur: ${sahurText}</div>
          </div>
          <div class="cc-musait-kamelya"><span class="cc-musait-label">ğŸ›ï¸ Ä°ftar mÃ¼sait:</span> ${mÃ¼saitKamelyaHtml}</div>
        `;
        container.appendChild(cell);
        current.setDate(current.getDate() + 1);
      }
    }

    // --- FORM FONKSÄ°YONLARI ---
    let selectedDateForForm = null;

    function isDatePastOrToday(dateStr) {
      if (!dateStr || typeof dateStr !== 'string') return true;
      const s = dateStr.includes('T') ? dateStr.split('T')[0] : dateStr.slice(0, 10);
      const now = new Date();
      const today = new Date(now);
      today.setHours(0, 0, 0, 0);
      const d = new Date(s + 'T12:00:00');
      d.setHours(0, 0, 0, 0);
      
      const tomorrow = new Date(today);
      tomorrow.setDate(tomorrow.getDate() + 1);
      
      if (d < today) return true;
      if (d.getTime() === today.getTime()) return true;
      if (d.getTime() === tomorrow.getTime()) {
        const cutoffHour = 17;
        const cutoffMinute = 30;
        if (now.getHours() > cutoffHour || (now.getHours() === cutoffHour && now.getMinutes() >= cutoffMinute)) {
          return true;
        }
      }
      return false;
    }

    function showDayRecords(dateStr) {
      selectedDateForForm = dateStr;
      const dayRecs = kayitlar.filter(k => {
        let kStr = '';
        if (k.tarih.toDate) kStr = k.tarih.toDate().toISOString().slice(0, 10);
        else if (typeof k.tarih === 'string') kStr = k.tarih.slice(0, 10);
        return kStr === dateStr;
      });

      // SÄ±ralama: Ä°ftar iÅŸtirak edenler > Ä°ftar iÅŸtirak etmeyenler > Sahur
      dayRecs.sort((a, b) => {
        const aIsIftar = a.tip === 'iftar';
        const bIsIftar = b.tip === 'iftar';
        const aIstirak = a.istirak === true;
        const bIstirak = b.istirak === true;
        
        // Ã–nce tip karÅŸÄ±laÅŸtÄ±rmasÄ± (iftar Ã¶nce)
        if (aIsIftar && !bIsIftar) return -1;
        if (!aIsIftar && bIsIftar) return 1;
        
        // AynÄ± tip iÃ§inde iÅŸtirak durumuna gÃ¶re (iÅŸtirak edenler Ã¶nce)
        if (aIsIftar && bIsIftar) {
          if (aIstirak && !bIstirak) return -1;
          if (!aIstirak && bIstirak) return 1;
        }
        
        // AynÄ± grup iÃ§inde createdAt'e gÃ¶re sÄ±rala
        const aTime = a.createdAt?.toDate ? a.createdAt.toDate().getTime() : (a.createdAt?.seconds || 0) * 1000;
        const bTime = b.createdAt?.toDate ? b.createdAt.toDate().getTime() : (b.createdAt?.seconds || 0) * 1000;
        return aTime - bTime;
      });

      const content = qs('#dayRecordsContent');
      const dateObj = new Date(dateStr);

      const btnAddNew = qs('#btnDayRecordsAddNew');
      if (btnAddNew) {
        const pastOrToday = isDatePastOrToday(dateStr);
        btnAddNew.disabled = pastOrToday;
        btnAddNew.title = pastOrToday ? 'Bu tarih iÃ§in kayÄ±t eklenemez (geÃ§miÅŸ/bugÃ¼n veya yarÄ±n iÃ§in saat 17:30 geÃ§ti)' : '';
        btnAddNew.style.opacity = pastOrToday ? '0.6' : '1';
        btnAddNew.style.cursor = pastOrToday ? 'not-allowed' : 'pointer';
      }

      if (dayRecs.length === 0) {
        content.innerHTML = `<div style="text-align:center; padding:30px; color:#999;">
          <div style="font-size:48px; margin-bottom:10px;">ğŸ“…</div>
          <div>Bu gÃ¼n iÃ§in henÃ¼z kayÄ±t bulunmamaktadÄ±r</div>
        </div>`;
      } else {
        content.innerHTML = `
          <div style="font-size:14px; font-weight:600; color:var(--primary); margin-bottom:15px; padding-bottom:10px; border-bottom:1px solid #eee;">
            ${dateObj.toLocaleDateString('tr-TR', { dateStyle: 'full' })}
          </div>
          <div style="display:flex; flex-direction:column; gap:10px;">
            ${dayRecs.map((k, idx) => {
          const tipLabel = k.tip === 'iftar' ? 'ğŸŒ™ Ä°ftar' : 'ğŸŒŸ Sahur';
          const mahalId = k.mahalId || k.mahalid;
          const mahalName = mahalId ? (mahaller.find(m => m.id === mahalId)?.adi || '') : '';
          const kayitPersonelAdi = k.personelAdi || k.personeladi;
          const personelName = kayitPersonelAdi || k.personel || 'Bilinmiyor';
          const musafirAdedi = k.musafirAdedi || k.musafiradedi || 0;
          return `
                <div style="background:#f8f9fa; padding:12px; border-radius:8px; border-left:3px solid ${k.tip === 'iftar' ? 'var(--accent)' : '#3498db'};">
                  <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:8px;">
                    <div style="flex:1;">
                      <div style="font-weight:600; color:var(--text); margin-bottom:4px;">${idx + 1}. ${k.sahip}</div>
                      <div style="font-size:12px; color:#7f8c8d;">
                        ${tipLabel} â€¢ ${k.tutar}â‚º
                        ${musafirAdedi > 0 ? ` â€¢ ${musafirAdedi} mÃ¼safir` : ''}
                        ${mahalName ? ` â€¢ ğŸ›ï¸ ${mahalName}` : ''}
                        ${k.istirak ? ' â€¢ âœ“ Ä°ÅŸtirak' : ''}
                      </div>
                      <div style="font-size:11px; color:#95a5a6; margin-top:4px;">
                        ğŸ‘¤ Kaydeden: ${personelName}
                      </div>
                      ${k.not ? `<div style="font-size:12px; color:#95a5a6; margin-top:6px; font-style:italic;">ğŸ“ ${k.not}</div>` : ''}
                    </div>
                  </div>
                </div>
              `;
        }).join('')}
          </div>
        `;
      }

      qs('#dayRecordsModal').classList.add('open');
    }

    function closeDayRecordsModal() {
      qs('#dayRecordsModal').classList.remove('open');
      selectedDateForForm = null;
    }

    function openMahalPlanlamaPopup() {
      const modal = qs('#mahalPlanlamaModal');
      if (modal) modal.classList.add('open');
    }

    function closeMahalPlanlamaPopup() {
      const modal = qs('#mahalPlanlamaModal');
      if (modal) modal.classList.remove('open');
    }

    function closeMahalPlanlamaPopupOnOverlay(event) {
      if (event.target.id === 'mahalPlanlamaModal') closeMahalPlanlamaPopup();
    }

    function openBosKamelyaModal() {
      const modal = qs('#bosKamelyaModal');
      qs('#bosKamelyaResult').style.display = 'none';
      qs('#bosKamelyaSelectedMahal').value = '';
      renderBosKamelyaMahaller();
      if (modal) modal.classList.add('open');
    }
    function closeBosKamelyaModal() {
      const modal = qs('#bosKamelyaModal');
      if (modal) modal.classList.remove('open');
    }
    function renderBosKamelyaMahaller() {
      const container = qs('#bosKamelyaMahalChips');
      if (!container) return;
      container.innerHTML = '';
      if (!mahaller || mahaller.length === 0) {
        container.innerHTML = '<div class="chip" style="opacity:0.5;">Mahal bulunamadÄ±</div>';
        return;
      }
      mahaller.forEach(m => {
        const chip = document.createElement('div');
        chip.className = 'chip';
        chip.textContent = m.adi;
        chip.dataset.mahalId = m.id;
        chip.onclick = function () {
          container.querySelectorAll('.chip').forEach(c => c.classList.remove('selected'));
          this.classList.add('selected');
          qs('#bosKamelyaSelectedMahal').value = m.id;
        };
        container.appendChild(chip);
      });
    }
    function sorgulaBosKamelya() {
      const mahalId = qs('#bosKamelyaSelectedMahal').value;
      if (!mahalId) {
        showAlert('LÃ¼tfen bir kamelya (mahal) seÃ§in.', 'error');
        return;
      }
      if (!ramazanAyari || !ramazanAyari.baslangic || !ramazanAyari.bitis) {
        showAlert('Ramazan tarihleri yÃ¼klenemedi.', 'error');
        return;
      }
      const basParts = ramazanAyari.baslangic.split('-');
      const bitParts = ramazanAyari.bitis.split('-');
      const start = new Date(basParts[0], basParts[1] - 1, basParts[2], 12, 0, 0);
      const end = new Date(bitParts[0], bitParts[1] - 1, bitParts[2], 12, 0, 0);
      const allDates = [];
      let current = new Date(start);
      while (current <= end) {
        allDates.push(current.toISOString().slice(0, 10));
        current.setDate(current.getDate() + 1);
      }
      const normalizeTarih = (k) => {
        let kStr = '';
        if (k.tarih?.toDate) kStr = k.tarih.toDate().toISOString().slice(0, 10);
        else if (typeof k.tarih === 'string') kStr = k.tarih.includes('T') ? k.tarih.split('T')[0] : k.tarih.slice(0, 10);
        return kStr;
      };
      const doluMap = {};
      (kayitlar || []).forEach(k => {
        if (k.silindi) return;
        const kid = k.mahalId ?? k.mahalid;
        if (kid !== mahalId) return;
        if (k.istirak !== true) return;
        const dateStr = normalizeTarih(k);
        if (!dateStr) return;
        if (!doluMap[dateStr]) doluMap[dateStr] = [];
        const name = k.personeladi || k.personelAdi || k.sahip || k.personel || '';
        if (name) doluMap[dateStr].push({ name, tip: k.tip || '' });
      });
      const bosGunler = allDates.filter(d => !doluMap[d] || doluMap[d].length === 0);
      const doluGunler = allDates.filter(d => doluMap[d] && doluMap[d].length > 0);
      const formatTarihGoster = (s) => {
        const d = new Date(s + 'T12:00:00');
        return d.toLocaleDateString('tr-TR', { day: '2-digit', month: 'short', year: 'numeric' });
      };
      const bosList = qs('#bosKamelyaBosList');
      const doluList = qs('#bosKamelyaDoluList');
      bosList.innerHTML = bosGunler.length === 0
        ? '<div class="bos-kamelya-date-item bos" style="opacity:0.7;">BoÅŸ gÃ¼n yok</div>'
        : bosGunler.map(d => `<div class="bos-kamelya-date-item bos">${formatTarihGoster(d)} (${d})</div>`).join('');
      doluList.innerHTML = doluGunler.length === 0
        ? '<div class="bos-kamelya-date-item dolu" style="opacity:0.7;">Dolu gÃ¼n yok</div>'
        : doluGunler.map(d => {
          const list = doluMap[d] || [];
          const personelHtml = list.map(p => `<div class="bos-kamelya-personel">â€¢ ${p.name} ${p.tip ? '(' + (p.tip === 'iftar' ? 'Ä°ftar' : 'Sahur') + ')' : ''}</div>`).join('');
          return `<div class="bos-kamelya-date-item dolu"><strong>${formatTarihGoster(d)}</strong>${personelHtml}</div>`;
        }).join('');
      qs('#bosKamelyaResult').style.display = 'block';
    }

    function openGunAnaliziModal() {
      const modal = qs('#gunAnaliziModal');
      qs('#gunAnaliziResult').style.display = 'none';
      renderGunAnaliziTarihSelect();
      qs('#gunAnaliziTip').value = 'iftar';
      qs('#gunAnaliziTipChips').querySelectorAll('.chip').forEach(c => c.classList.remove('selected'));
      const first = qs('#gunAnaliziTipChips .chip');
      if (first) first.classList.add('selected');
      if (modal) modal.classList.add('open');
    }
    function renderGunAnaliziTarihSelect() {
      const sel = qs('#gunAnaliziTarih');
      if (!sel) return;
      sel.innerHTML = '<option value="">Tarih seÃ§in</option>';
      if (!ramazanAyari || !ramazanAyari.baslangic || !ramazanAyari.bitis) return;
      const basParts = ramazanAyari.baslangic.split('-');
      const bitParts = ramazanAyari.bitis.split('-');
      const start = new Date(parseInt(basParts[0], 10), parseInt(basParts[1], 10) - 1, parseInt(basParts[2], 10));
      const end = new Date(parseInt(bitParts[0], 10), parseInt(bitParts[1], 10) - 1, parseInt(bitParts[2], 10));
      let current = new Date(start);
      let dayNum = 1;
      while (current <= end) {
        const yyyy = current.getFullYear();
        const mm = String(current.getMonth() + 1).padStart(2, '0');
        const dd = String(current.getDate()).padStart(2, '0');
        const dateStr = yyyy + '-' + mm + '-' + dd;
        const label = current.toLocaleDateString('tr-TR', { day: '2-digit', month: 'short', year: 'numeric' }) + ' (' + dayNum + '. GÃ¼n)';
        const opt = document.createElement('option');
        opt.value = dateStr;
        opt.textContent = label;
        sel.appendChild(opt);
        current.setDate(current.getDate() + 1);
        dayNum++;
      }
    }
    function closeGunAnaliziModal() {
      const modal = qs('#gunAnaliziModal');
      if (modal) modal.classList.remove('open');
    }

    function openHataBildirimiModal() {
      const modal = qs('#hataBildirimiModal');
      qs('#hataBildirimiAciklama').value = '';
      qs('#hataBildirimiError').style.display = 'none';
      qs('#hataBildirimiError').textContent = '';
      if (modal) modal.classList.add('open');
    }
    function closeHataBildirimiModal() {
      const modal = qs('#hataBildirimiModal');
      if (modal) modal.classList.remove('open');
    }
    async function gonderHataBildirimi() {
      const aciklama = (qs('#hataBildirimiAciklama')?.value || '').trim();
      const errEl = qs('#hataBildirimiError');
      if (!aciklama) {
        errEl.textContent = 'LÃ¼tfen aÃ§Ä±klama giriniz.';
        errEl.style.display = 'block';
        return;
      }
      if (!CURRENT_YIL) {
        showAlert('YÄ±l seÃ§imi yapÄ±lmamÄ±ÅŸ.', 'error');
        return;
      }
      try {
        const talepData = {
          yil: String(CURRENT_YIL),
          kayitid: null,
          kayittipi: 'hata_bildirimi',
          taleptipi: 'hata_bildirimi',
          aciklama: aciklama,
          durum: 'beklemede',
          personeladi: currentPersonelAdi || 'Bilinmiyor',
          createdat: new Date().toISOString(),
          updatedat: new Date().toISOString()
        };
        const { error } = await window.supabase.from('duzenleme_talepleri').insert(talepData);
        if (error) throw error;
        closeHataBildirimiModal();
        showAlert('Hata bildiriminiz alÄ±ndÄ±. DÃ¼zenleme talepleri tablosuna kaydedildi. TeÅŸekkÃ¼r ederiz.', 'success');
      } catch (e) {
        console.error('Hata bildirimi gÃ¶nderilemedi:', e);
        errEl.textContent = 'GÃ¶nderim baÅŸarÄ±sÄ±z: ' + (e.message || 'Bilinmeyen hata');
        errEl.style.display = 'block';
      }
    }
    function selectGunAnaliziTip(tip, el) {
      qs('#gunAnaliziTipChips').querySelectorAll('.chip').forEach(c => c.classList.remove('selected'));
      if (el) el.classList.add('selected');
      qs('#gunAnaliziTip').value = tip;
    }
    async function sorgulaGunAnalizi() {
      const tarihStr = (qs('#gunAnaliziTarih')?.value || '').trim();
      const tip = qs('#gunAnaliziTip')?.value || 'iftar';
      if (!tarihStr) {
        showAlert('LÃ¼tfen bir tarih seÃ§in.', 'error');
        return;
      }
      const normalizeTarih = (k) => {
        let s = '';
        if (k.tarih?.toDate) s = k.tarih.toDate().toISOString().slice(0, 10);
        else if (typeof k.tarih === 'string') s = k.tarih.includes('T') ? k.tarih.split('T')[0] : k.tarih.slice(0, 10);
        return s;
      };
      const list = (kayitlar || []).filter(k => {
        if (k.silindi) return false;
        if (k.tip !== tip) return false;
        return normalizeTarih(k) === tarihStr;
      });
      const kayitIds = list.map(k => k.id);
      let tahsilatByKayitId = {};
      kayitIds.forEach(id => { tahsilatByKayitId[id] = 0; });
      if (kayitIds.length > 0 && window.supabase) {
        try {
          const { data: tahsilatData } = await window.supabase
            .from('ramazan_tahsilat')
            .select('kayit_id, tutar')
            .in('kayit_id', kayitIds);
          (tahsilatData || []).forEach(t => {
            const kid = t.kayit_id;
            tahsilatByKayitId[kid] = (tahsilatByKayitId[kid] || 0) + (Number(t.tutar) || 0);
          });
        } catch (e) { console.warn('Tahsilat yÃ¼klenemedi:', e); }
      }
      const tipLabel = tip === 'iftar' ? 'Ä°ftar' : 'Sahur';
      const sahipTh = qs('#gunAnaliziSahipTh');
      if (sahipTh) sahipTh.textContent = tip === 'iftar' ? 'Ä°ftar Sahibi' : 'Sahur Sahibi';
      let toplamAdet = list.length;
      let toplamMusafir = list.reduce((s, k) => s + (parseInt(k.musafiradedi || k.musafirAdedi || 0, 10) || 0), 0);
      let toplamTutar = list.reduce((s, k) => s + (parseFloat(k.tutar) || 0), 0);
      let toplamTahsilat = list.reduce((s, k) => s + (tahsilatByKayitId[k.id] || 0), 0);
      const kpiHtml = `
        <div style="background:#e3f2fd; border:1px solid #2196f3; border-radius:8px; padding:12px; text-align:center;">
          <div style="font-size:11px; color:#1565c0; margin-bottom:4px;">Toplam ${tipLabel} Adedi</div>
          <div style="font-size:18px; font-weight:700; color:#1976d2;">${toplamAdet}</div>
        </div>
        <div style="background:#e8f5e9; border:1px solid #4caf50; border-radius:8px; padding:12px; text-align:center;">
          <div style="font-size:11px; color:#2e7d32; margin-bottom:4px;">Toplam MÃ¼safir Adedi</div>
          <div style="font-size:18px; font-weight:700; color:#388e3c;">${toplamMusafir}</div>
        </div>
        <div style="background:#fff3e0; border:1px solid #ff9800; border-radius:8px; padding:12px; text-align:center;">
          <div style="font-size:11px; color:#e65100; margin-bottom:4px;">Toplam Tutar</div>
          <div style="font-size:18px; font-weight:700; color:#f57c00;">${toplamTutar.toLocaleString('tr-TR')} â‚º</div>
        </div>
        <div style="background:#fce4ec; border:1px solid #e91e63; border-radius:8px; padding:12px; text-align:center;">
          <div style="font-size:11px; color:#c2185b; margin-bottom:4px;">Toplam Tahsilat</div>
          <div style="font-size:18px; font-weight:700; color:#d81b60;">${toplamTahsilat.toLocaleString('tr-TR')} â‚º</div>
        </div>
      `;
      qs('#gunAnaliziKpi').innerHTML = kpiHtml;
      const tbody = qs('#gunAnaliziTableBody');
      if (list.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="padding:20px; text-align:center; color:#999;">KayÄ±t bulunamadÄ±.</td></tr>';
      } else {
        tbody.innerHTML = list.map(k => {
          const mahalId = k.mahalId ?? k.mahalid;
          const mahalAdi = mahalId ? (mahaller.find(m => m.id === mahalId)?.adi || '-') : '-';
          const sahip = k.sahip || '-';
          const musafir = parseInt(k.musafiradedi || k.musafirAdedi || 0, 10) || 0;
          const personel = k.personeladi || k.personelAdi || k.personel || '-';
          const tutar = parseFloat(k.tutar) || 0;
          const tahsilat = tahsilatByKayitId[k.id] || 0;
          return `<tr style="border-bottom:1px solid var(--border);">
            <td style="padding:10px;">${escapeHtml(mahalAdi)}</td>
            <td style="padding:10px;">${escapeHtml(sahip)}</td>
            <td style="padding:10px; text-align:center;">${musafir}</td>
            <td style="padding:10px;">${escapeHtml(personel)}</td>
            <td style="padding:10px; text-align:right;">${tutar.toLocaleString('tr-TR')} â‚º</td>
            <td style="padding:10px; text-align:right;">${tahsilat.toLocaleString('tr-TR')} â‚º</td>
          </tr>`;
        }).join('');
      }
      qs('#gunAnaliziResult').style.display = 'block';
    }

    async function openTabloGor() {
      if (!currentUser && !currentPersonelAdi) {
        if (typeof showAlert === 'function') showAlert('Tablo gÃ¶rÃ¼ntÃ¼lemek iÃ§in giriÅŸ yapmanÄ±z gerekmektedir.', 'error');
        else alert('Tablo gÃ¶rÃ¼ntÃ¼lemek iÃ§in giriÅŸ yapmanÄ±z gerekmektedir.');
        return;
      }
      if (!CURRENT_YIL) {
        if (typeof showAlert === 'function') showAlert('YÄ±l seÃ§imi yapÄ±lmamÄ±ÅŸ.', 'error');
        else alert('YÄ±l seÃ§imi yapÄ±lmamÄ±ÅŸ.');
        return;
      }
      var newWin = null;
      try {
        newWin = window.open('about:blank', '_blank');
        if (!kayitlar || kayitlar.length === 0) {
          if (typeof loadKayitlar === 'function') await loadKayitlar({ skipMyRecords: true });
        }
        var kayitlarList = kayitlar || [];
        var myKayitlar = kayitlarList.filter(function (k) {
          if (k.silindi) return false;
          if (k.tip !== 'iftar' && k.tip !== 'sahur') return false;
          if (currentUser && currentUser.id) {
            var uid = k.personelUid || k.personeluid;
            if (uid && uid === currentUser.id) return true;
            var kaydedenUid = k.kaydedenpersoneluid || k.kaydedenPersonelUid;
            if (kaydedenUid && kaydedenUid === currentUser.id) return true;
          }
          if (currentPersonelAdi && currentPersonelAdi !== 'KullanÄ±cÄ±' && currentPersonelAdi !== 'Bilinmiyor' && !currentPersonelAdi.includes('@')) {
            var n = normalizePersonelName(currentPersonelAdi);
            if (!n) return false;
            if (n === normalizePersonelName(k.personeladi || k.personelAdi || '')) return true;
            if (n === normalizePersonelName(k.personel || '')) return true;
            if (n === normalizePersonelName(k.sahip || '')) return true;
            if (n === normalizePersonelName(k.kaydedenpersonel || k.kaydedenPersonel || '')) return true;
          }
          return false;
        });

        function tarihStr(kayit) {
          var t = kayit.tarih;
          if (!t) return null;
          var d = null;
          if (t.toDate) d = t.toDate();
          else if (t.seconds) d = new Date(t.seconds * 1000);
          else if (typeof t === 'string') d = new Date(t);
          else if (t instanceof Date) d = t;
          if (!d || isNaN(d.getTime())) return null;
          if (typeof formatDateLocal === 'function') return formatDateLocal(d);
          var y = d.getFullYear(), m = d.getMonth() + 1, day = d.getDate();
          return y + '-' + (m < 10 ? '0' : '') + m + '-' + (day < 10 ? '0' : '') + day;
        }

        function sortKey(k) {
          var c = k.createdat || k.createdAt;
          if (c && c.seconds) return c.seconds;
          if (c) return new Date(c).getTime();
          return (k.id || '').toString();
        }
        var gunlukVeriler = {};
        var byDate = {};
        myKayitlar.forEach(function(k) {
          var ds = tarihStr(k);
          if (!ds) return;
          if (!byDate[ds]) byDate[ds] = { iftar: [], sahur: [], musafir: 0, tutar: 0 };
          var b = byDate[ds];
          var sahip = (k.sahip || k.bagisci || '').toString().trim() || '';
          if (k.tip === 'iftar') b.iftar.push({ sahip: sahip, key: sortKey(k) }); else if (k.tip === 'sahur') b.sahur.push({ sahip: sahip, key: sortKey(k) });
          b.musafir += Number(k.musafirAdedi || k.musafiradedi || 0) || 0;
          b.tutar += Number(k.tutar || 0) || 0;
        });
        Object.keys(byDate).forEach(function(ds) {
          var b = byDate[ds];
          b.iftar.sort(function(a, b) { return (a.key || 0) - (b.key || 0) || 0; });
          b.sahur.sort(function(a, b) { return (a.key || 0) - (b.key || 0) || 0; });
          gunlukVeriler[ds] = {
            iftarlar: b.iftar.map(function(x) { return x.sahip; }),
            sahurlar: b.sahur.map(function(x) { return x.sahip; }),
            musafir: b.musafir,
            tutar: b.tutar,
            tahsilat: 0
          };
        });

        var kayitIds = myKayitlar.map(function(k) { return k.id; }).filter(Boolean);
        if (kayitIds.length > 0 && window.supabase) {
          var res = await window.supabase.from('ramazan_tahsilat').select('kayit_id, tutar').in('kayit_id', kayitIds);
          var tahsilatByKayitId = {};
          kayitIds.forEach(function(id) { tahsilatByKayitId[id] = 0; });
          (res.data || []).forEach(function(t) {
            var kid = t.kayit_id;
            var tutar = Number(t.tutar) || 0;
            tahsilatByKayitId[kid] = (tahsilatByKayitId[kid] || 0) + tutar;
          });
          myKayitlar.forEach(function(k) {
            var ds = tarihStr(k);
            if (ds && gunlukVeriler[ds]) gunlukVeriler[ds].tahsilat += tahsilatByKayitId[k.id] || 0;
          });
        }

        var baslangic = null;
        var bitis = null;
        if (ramazanAyari && ramazanAyari.baslangic && ramazanAyari.bitis) {
          baslangic = String(ramazanAyari.baslangic).slice(0, 10);
          bitis = String(ramazanAyari.bitis).slice(0, 10);
        } else if (window.supabase && CURRENT_YIL) {
          var yilRes = await window.supabase.from('ramazan_yillar').select('baslangic, bitis').eq('yil', CURRENT_YIL).maybeSingle();
          if (yilRes && yilRes.data && yilRes.data.baslangic && yilRes.data.bitis) {
            baslangic = String(yilRes.data.baslangic).slice(0, 10);
            bitis = String(yilRes.data.bitis).slice(0, 10);
          }
        }
        var payload = {
          personelAdi: currentPersonelAdi || 'â€”',
          yil: CURRENT_YIL,
          baslangic: baslangic,
          bitis: bitis,
          gunlukVeriler: gunlukVeriler
        };
        var key = 'ramazantablo_' + Date.now();
        try { localStorage.setItem(key, JSON.stringify(payload)); } catch (e) { key = null; }
        var tabloUrl = '';
        if (key) {
          tabloUrl = '../sablonlar/ramazantablo.html?key=' + encodeURIComponent(key) + '&yil=' + CURRENT_YIL;
        } else {
          var dataEnc = encodeURIComponent(JSON.stringify(payload));
          if (dataEnc.length > 1800) { if (typeof showAlert === 'function') showAlert('Veri Ã§ok bÃ¼yÃ¼k, tablo aÃ§Ä±lamadÄ±.', 'error'); else alert('Veri Ã§ok bÃ¼yÃ¼k, tablo aÃ§Ä±lamadÄ±.'); if (newWin) newWin.close(); return; }
          tabloUrl = '../sablonlar/ramazantablo.html?data=' + dataEnc + '&yil=' + CURRENT_YIL;
        }
        if (newWin && !newWin.closed) {
          newWin.location.href = tabloUrl;
        } else {
          window.open(tabloUrl, '_blank');
        }
      } catch (err) {
        console.error('Tablo GÃ¶r hatasÄ±:', err);
        if (newWin && !newWin.closed) newWin.close();
        if (typeof showAlert === 'function') showAlert('Tablo aÃ§Ä±lÄ±rken hata oluÅŸtu.', 'error');
        else alert('Tablo aÃ§Ä±lÄ±rken hata oluÅŸtu.');
      }
    }

    function openFormModalFromDay() {
      const dateToOpen = selectedDateForForm; // Ã–nce tarihi sakla
      if (dateToOpen && isDatePastOrToday(dateToOpen)) {
        showAlert('Bu tarih iÃ§in kayÄ±t yapÄ±lamaz. GeÃ§miÅŸ, bugÃ¼n ve yarÄ±n (saat 17:30 sonrasÄ±) iÃ§in iÅŸlem yapÄ±lamaz.', 'error');
        return;
      }
      closeDayRecordsModal();
      if (dateToOpen) {
        setTimeout(() => {
          openFormModal(dateToOpen);
        }, 100);
      }
    }

    function openFormModal(dateStr) {
      qs('#fDate').value = dateStr;
      qs('#fDateDisplay').innerText = new Date(dateStr).toLocaleDateString('tr-TR', { dateStyle: 'full' });
      qs('#fName').value = '';
      qs('#fGuest').value = 0;
      qs('#fGuestVal').value = '0';
      qs('#fNote').value = '';
      qs('#fMahal').value = '';
      qs('#fIstirak').value = 'true';
      // Ä°ÅŸtirak chip'lerini sÄ±fÄ±rla
      qs('#istirakChips').querySelectorAll('.chip').forEach((c, i) => {
        c.classList.remove('selected');
        if (i === 0) c.classList.add('selected');
      });
      // Ä°ÅŸtirak alanlarÄ±nÄ± gÃ¶ster
      qs('#istirakEvetFields').style.display = 'block';
      renderMahaller(); // Tarih deÄŸiÅŸtiÄŸinde mahalleri yeniden render et // Mahalleri yeniden render et
      qs('#formModal').classList.add('open');
    }

    function closeModal() { qs('#formModal').classList.remove('open'); }

    function selectChip(group, val, el) {
      if (!el) el = event.target;
      if (el.classList.contains('disabled')) return; // Disabled chip'leri seÃ§ilemez
      el.parentElement.querySelectorAll('.chip').forEach(c => c.classList.remove('selected'));
      el.classList.add('selected');
      if (group === 'type') {
        qs('#fType').value = val;
        // Tip deÄŸiÅŸince tutar seÃ§eneklerini yeniden yÃ¼kle
        renderPriceChips();
      }
      if (group === 'price') qs('#fPrice').value = val;
      if (group === 'mahal') qs('#fMahal').value = val;
      if (group === 'odeme') {
        qs('#teberruOdeme').value = val;
        // Ã–deme yÃ¶ntemi seÃ§ildiÄŸinde hatayÄ± temizle
        qs('#teberruOdemeError').style.display = 'none';
      }
      if (group === 'istirak') {
        qs('#fIstirak').value = val;
        // Ä°ÅŸtirak deÄŸiÅŸince alanlarÄ± gÃ¶ster/gizle
        const istirakFields = qs('#istirakEvetFields');
        if (val === true || val === 'true') {
          istirakFields.style.display = 'block';
        } else {
          istirakFields.style.display = 'none';
          qs('#fGuest').value = 0;
          qs('#fGuestVal').value = '0';
          qs('#fMahal').value = '';
        }
        renderMahaller(); // Mahalleri yeniden render et
      }
      if (group === 'type' || group === 'date') {
        renderMahaller(); // Tip veya tarih deÄŸiÅŸince mahalleri yeniden render et
      }
    }

    function stepGuest(n) {
      let v = parseInt(qs('#fGuest').value) + n;
      if (v < 0) v = 0;
      qs('#fGuest').value = v;
      qs('#fGuestVal').value = v;
      // MÃ¼safir adedi deÄŸiÅŸince mahalleri yeniden render et
      renderMahaller();
    }

    function updateGuestFromInput(val) {
      let v = parseInt(val) || 0;
      if (v < 0) v = 0;
      if (v > 999) v = 999;
      qs('#fGuest').value = v;
      qs('#fGuestVal').value = v;
      // MÃ¼safir adedi deÄŸiÅŸince mahalleri yeniden render et
      renderMahaller();
    }
    window.updateGuestFromInput = updateGuestFromInput;

    qs('#smartForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const tarihStr = qs('#fDate').value;
      const tip = qs('#fType').value;
      const tutar = parseInt(qs('#fPrice').value);
      const sahip = qs('#fName').value.trim();
      const mahalId = qs('#fMahal').value;

      if (!sahip) {
        showAlert('LÃ¼tfen iftar sahibi adÄ±nÄ± giriniz', 'error');
        return;
      }

      if (isDatePastOrToday(tarihStr)) {
        showAlert('Bu tarih iÃ§in kayÄ±t yapÄ±lamaz. GeÃ§miÅŸ, bugÃ¼n ve yarÄ±n (saat 17:30 sonrasÄ±) iÃ§in iÅŸlem yapÄ±lamaz.', 'error');
        return;
      }

      if (!tutar || tutar <= 0) {
        showAlert('LÃ¼tfen geÃ§erli bir tutar seÃ§iniz', 'error');
        return;
      }

      const musafirAdedi = parseInt(qs('#fGuest').value) || 0;
      if (mahalId) {
        const mahal = mahaller.find(m => m.id === mahalId);
        if (mahal) {
          const minMusafir = mahal.minMusafir || 1;
          const maxMusafir = mahal.maxMusafir || 9999;
          if (musafirAdedi < minMusafir || musafirAdedi > maxMusafir) {
            showAlert(`SeÃ§ilen mahal iÃ§in mÃ¼safir sayÄ±sÄ± ${minMusafir}-${maxMusafir} arasÄ±nda olmalÄ±dÄ±r`, 'error');
            return;
          }
        }
      }

      // Kapasite kontrolÃ¼ (async - sadece iÅŸtirak edecekler iÃ§in)
      if (qs('#fIstirak').value === 'true') {
        const kapasiteCheck = await checkKapasite(tarihStr, tip);
        if (!kapasiteCheck.allowed) {
          showAlert(kapasiteCheck.message, 'error');
          return;
        }
      }

      // Mahal kontrolÃ¼: Her mahale bir tarihte sadece bir kayÄ±t (iftar/sahur ayrÄ±)
      if (mahalId && qs('#fIstirak').value === 'true') {
        const mahalCheck = checkMahalAvailability(tarihStr, tip, mahalId, null);
        if (!mahalCheck.allowed) {
          showAlert(mahalCheck.message, 'error');
          return;
        }
      }

      const tParts = tarihStr.split('-');
      const dbDate = new Date(tParts[0], tParts[1] - 1, tParts[2], 12, 0, 0);

      previewData = {
        tarih: dbDate,
        tip: tip,
        tutar: tutar,
        sahip: sahip,
        musafirAdedi: musafirAdedi,
        mahalId: mahalId || null,
        mahal: mahalId ? (mahaller.find(m => m.id === mahalId)?.adi || null) : null,
        istirak: qs('#fIstirak').value === 'true',
        not: qs('#fNote').value.trim(),
        personelUid: currentUser.id,
        personel: currentUser.email,
        personelAdi: currentPersonelAdi || 'Bilinmiyor',
        yil: CURRENT_YIL
      };

      // Ã–nizleme gÃ¶ster
      showPreview();
    });

    function showPreview() {
      const content = qs('#previewContent');
      const tipLabel = previewData.tip === 'iftar' ? 'ğŸŒ™ Ä°ftar' : 'ğŸŒŸ Sahur';
      content.innerHTML = `
        <div style="margin-bottom:10px;"><strong>Tarih:</strong> ${previewData.tarih.toLocaleDateString('tr-TR', { dateStyle: 'full' })}</div>
        <div style="margin-bottom:10px;"><strong>Tip:</strong> ${tipLabel}</div>
        <div style="margin-bottom:10px;"><strong>Ä°ftar Sahibi:</strong> ${previewData.sahip}</div>
        <div style="margin-bottom:10px;"><strong>Tutar:</strong> ${previewData.tutar}â‚º</div>
        <div style="margin-bottom:10px;"><strong>MÃ¼safir SayÄ±sÄ±:</strong> ${previewData.musafirAdedi}</div>
        ${previewData.mahal ? `<div style="margin-bottom:10px;"><strong>Mahal:</strong> ${previewData.mahal}</div>` : ''}
        <div style="margin-bottom:10px;"><strong>Ä°ÅŸtirak:</strong> ${previewData.istirak ? 'âœ“ Evet' : 'âœ— HayÄ±r'}</div>
        ${previewData.not ? `<div style="margin-bottom:10px;"><strong>Not:</strong> ${previewData.not}</div>` : ''}
      `;
      qs('#previewModal').classList.add('open');
    }

    function closePreviewModal() {
      qs('#previewModal').classList.remove('open');
      previewData = null;
    }

    function generateUUID() {
      if (typeof crypto !== 'undefined' && crypto.randomUUID) {
        return crypto.randomUUID();
      }
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
        var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }
    
    // ============================================
    // TARÄ°H YÃ–NETÄ°MÄ° HELPER FONKSÄ°YONLARI
    // ============================================
    
    /**
     * TÃ¼rkiye saati (GMT+3) iÃ§in yerel tarihi 'YYYY-MM-DD' formatÄ±nda string olarak dÃ¶ndÃ¼rÃ¼r
     * Timezone kaymasÄ±nÄ± Ã¶nlemek iÃ§in saat bilgisini 12:00:00 olarak sabitler
     */
    function formatDateLocal(date) {
      if (!date) return null;
      
      let d = date;
      if (typeof date === 'string') {
        d = new Date(date);
      }
      
      // TÃ¼rkiye saati iÃ§in offset: GMT+3 = UTC+3
      const turkiyeOffset = 3 * 60; // 3 saat = 180 dakika
      const localTime = d.getTime() + (d.getTimezoneOffset() * 60000);
      const turkiyeTime = new Date(localTime + (turkiyeOffset * 60000));
      
      // Saati 12:00:00 olarak sabitle (timezone kaymasÄ±nÄ± Ã¶nlemek iÃ§in)
      turkiyeTime.setHours(12, 0, 0, 0);
      
      const year = turkiyeTime.getFullYear();
      const month = String(turkiyeTime.getMonth() + 1).padStart(2, '0');
      const day = String(turkiyeTime.getDate()).padStart(2, '0');
      
      return `${year}-${month}-${day}`;
    }
    
    /**
     * Yerel tarih string'ini (YYYY-MM-DD) ISO timestamp'e Ã§evirir
     * Saat bilgisini 12:00:00 olarak sabitler
     */
    function formatDateToISO(dateStr) {
      if (!dateStr) return null;
      
      // EÄŸer zaten ISO formatÄ±nda ise, sadece tarih kÄ±smÄ±nÄ± al
      const datePart = dateStr.includes('T') ? dateStr.split('T')[0] : dateStr.slice(0, 10);
      
      // TÃ¼rkiye saati iÃ§in timestamp oluÅŸtur
      const [year, month, day] = datePart.split('-');
      const turkiyeDate = new Date(`${year}-${month}-${day}T12:00:00+03:00`);
      
      return turkiyeDate.toISOString();
    }

    async function confirmSave() {
      if (!previewData) return;

      const btn = qs('#previewModal').querySelector('.btn-primary');
      btn.disabled = true;
      btn.innerText = 'Kaydediliyor...';

      try {
        // Tarih yÃ¶netimi: TÃ¼rkiye saati ile formatla
        const tarihLocalStr = formatDateLocal(previewData.tarih);
        const tarihISO = formatDateToISO(tarihLocalStr);
        
        // KAPASÄ°TE KONTROLÃœ: Ä°ÅŸtirak edecek kayÄ±tlar iÃ§in kapasite kontrolÃ¼
        if (previewData.istirak) {
          // Kapasite ayarlarÄ±nÄ± yeniden yÃ¼kle (gÃ¼ncel olmasÄ± iÃ§in)
          await loadKapasiteAyarlari();
          
          // Tarih string formatÄ± (YYYY-MM-DD)
          const tarihStr = tarihISO.slice(0, 10);
          
          // Kapasite kontrolÃ¼
          const kapasiteCheck = await checkKapasite(tarihStr, previewData.tip);
          if (!kapasiteCheck.allowed) {
            showToast('error', 'Kapasite HatasÄ±', kapasiteCheck.message, { important: true, duration: 8000 });
            btn.disabled = false;
            btn.innerText = 'KAYDET';
            return;
          }
        }

        // RACE CONDITION KONTROLÃœ: Ä°ÅŸlem yapmadan Ã¶nce veritabanÄ±nda kontrol et
        if (previewData.mahalId && previewData.istirak) {
          const { data: existingRecords, error: checkError } = await window.supabase
            .from('ramazan_kayitlari')
            .select('id')
            .eq('tarih', tarihISO)
            .eq('tip', previewData.tip)
            .eq('mahalid', previewData.mahalId)
            .eq('istirak', true);
          
          if (checkError) {
            console.error('Kontrol hatasÄ±:', checkError);
            throw new Error('KayÄ±t kontrolÃ¼ yapÄ±lamadÄ±. LÃ¼tfen tekrar deneyin.');
          }
          
          if (existingRecords && existingRecords.length > 0) {
            const mahalAdi = mahaller.find(m => m.id === previewData.mahalId)?.adi || 'SeÃ§ilen mahal';
            showToast('error', 'Rezervasyon HatasÄ±', 
              `Bu yer siz iÅŸlem yaparken baÅŸkasÄ± tarafÄ±ndan alÄ±ndÄ±. ${previewData.tip === 'iftar' ? 'Ä°ftar' : 'Sahur'} iÃ§in ${tarihLocalStr} tarihinde ${mahalAdi} artÄ±k dolu. LÃ¼tfen baÅŸka bir tarih veya mahal seÃ§iniz.`,
              { important: true, duration: 8000 }
            );
            btn.disabled = false;
            btn.innerText = 'KAYDET';
            return;
          }
        }

        // ay: tarihten ay numarasÄ± (1-12)
        const ay = tarihISO ? new Date(tarihISO.slice(0, 10)).getMonth() + 1 : null;
        const data = {
          id: generateUUID(), // CRITICAL: Schema requires ID
          tarih: tarihISO,
          tip: previewData.tip,
          tutar: previewData.tutar,
          sahip: previewData.sahip.trim(), // Trim added
          musafiradedi: previewData.musafirAdedi,
          mahalid: previewData.mahalId || null,
          mahal: previewData.mahal || null,
          ay,
          istirak: previewData.istirak,
          notlar: previewData.not || null,
          personeluid: previewData.personelUid,
          personel: previewData.personel,
          personeladi: previewData.personelAdi,
          kaydedenpersonel: (typeof currentPersonelAdi !== 'undefined' ? currentPersonelAdi : null) || previewData.personelAdi || null,
          kaydedenpersoneluid: (typeof currentUser !== 'undefined' && currentUser ? currentUser.id : null) || previewData.personelUid || null,
          yil: previewData.yil,
          createdat: new Date().toISOString(),
          updatedat: new Date().toISOString()
        };

        const { error } = await window.supabase.from('ramazan_kayitlari').insert(data);
        if (error) throw error;

        closePreviewModal();
        closeModal();

        // BaÅŸarÄ± mesajÄ±
        showAlert('KayÄ±t baÅŸarÄ±yla eklendi!', 'success');
        // Muhasebe uyarÄ±sÄ± toast'Ä± gÃ¶ster
        setTimeout(() => {
          showMuhasebeWarningToast(previewData.tip);
        }, 500);

        // Listeyi yenile
        loadKayitlar(); // Reload records after save
      } catch (err) {
        console.error('KayÄ±t hatasÄ±:', err);
        showAlert('Hata: ' + (err.message || 'KayÄ±t eklenirken bir sorun oluÅŸtu'), 'error');
      } finally {
        btn.disabled = false;
        btn.innerText = 'KAYDET';
      }
    }

    // Takvimim gÃ¶rÃ¼nÃ¼mÃ¼
    // Global eriÅŸim iÃ§in window'a baÄŸla
    function switchView(view) {
      const navBtns = document.querySelectorAll('.nav-btn');
      // navBtns check
      if (navBtns.length < 4) return;

      const takvimBtn = navBtns[0];
      const kayitlarimBtn = navBtns[1];
      const teberruBtn = navBtns[2];
      const menuBtn = navBtns[3];
      const mainContainer = qs('.main-container');
      const takvimimView = qs('#takvimimView');
      const teberruView = qs('#teberruView');
      const menuView = qs('#menuView');

      // TÃ¼m butonlarÄ± pasif yap
      navBtns.forEach(btn => btn.classList.remove('active'));

      if (view === 'takvim') {
        takvimBtn.classList.add('active');
        if (mainContainer) mainContainer.style.display = 'block';
        if (takvimimView) takvimimView.style.display = 'none';
        if (teberruView) teberruView.style.display = 'none';
        if (menuView) menuView.style.display = 'none';
        // MenÃ¼ modalÄ±nÄ± kapat
        closeMenuDetailModal();
      } else if (view === 'takvimim') {
        kayitlarimBtn.classList.add('active');
        if (mainContainer) mainContainer.style.display = 'none';
        if (takvimimView) takvimimView.style.display = 'block';
        if (teberruView) teberruView.style.display = 'none';
        if (menuView) menuView.style.display = 'none';
        // MenÃ¼ modalÄ±nÄ± kapat
        closeMenuDetailModal();
        loadMyRecords();
      } else if (view === 'teberru') {
        teberruBtn.classList.add('active');
        if (mainContainer) mainContainer.style.display = 'none';
        if (takvimimView) takvimimView.style.display = 'none';
        if (teberruView) teberruView.style.display = 'block';
        if (menuView) menuView.style.display = 'none';
        // MenÃ¼ modalÄ±nÄ± kapat
        closeMenuDetailModal();
        // Tahsilat detay tablosunu yÃ¼kle
        loadTahsilatDetayTablosu();
      } else if (view === 'menu') {
        menuBtn.classList.add('active');
        if (mainContainer) mainContainer.style.display = 'none';
        if (takvimimView) takvimimView.style.display = 'none';
        if (teberruView) teberruView.style.display = 'none';
        if (menuView) menuView.style.display = 'block';
        loadMenuler();
      }
    }
    window.switchView = switchView;

    let teberruKayitlari = [];
    let taahhutKayitlari = [];
    let menuler = [];

    async function loadTeberruKayitlari() {
      if (!currentUser && !currentPersonelAdi) {
        console.warn('âš ï¸ loadTeberruKayitlari: currentUser ve currentPersonelAdi yok');
        teberruKayitlari = [];
        return;
      }
      try {
        const cols = 'id, aciklama, ay, bagisci, createdat, kaydedenpersonel, kaydedenpersoneluid, miktar, not, odeme, odemeyontemi, personel, personeluid, tarih, updatedat, yil';
        const queries = [];

        // IMPERSONATION KONTROLÃœ: BaÅŸka kullanÄ±cÄ± gÃ¶rÃ¼ntÃ¼leniyorsa sadece o kullanÄ±cÄ±nÄ±n verilerini Ã§ek
        const targetUserId = isImpersonating ? impersonatedUserId : currentUser?.id;
        const targetUserName = currentPersonelAdi;

        // UID tek sorgu (or)
        if (targetUserId) {
          queries.push(
            window.supabase
              .from('teberru_kayitlari')
              .select(cols)
              .or(`personeluid.eq.${targetUserId},kaydedenpersoneluid.eq.${targetUserId}`)
          );
        }

        // Ä°sim tek sorgu (or) - Profil yoksa deneme (impersonation modunda da kullan)
        if (targetUserName && targetUserName !== 'KullanÄ±cÄ±' && targetUserName !== 'Bilinmiyor' && !targetUserName.includes('@')) {
          queries.push(
            window.supabase
              .from('teberru_kayitlari')
              .select(cols)
              .or(`personel.eq.${targetUserName},kaydedenpersonel.eq.${targetUserName}`)
          );
        }

        if (queries.length === 0) {
          console.warn('âš ï¸ loadTeberruKayitlari: HiÃ§ sorgu yok (currentUser.id veya currentPersonelAdi yok)');
          teberruKayitlari = [];
          return;
        }

        const results = await Promise.all(queries);
        const allDocs = new Map();

        results.forEach((res) => {
          if (res?.error) {
            console.warn('âš ï¸ Teberru sorgu hatasÄ±:', res.error);
            return;
          }
          (res?.data || []).forEach(d => {
            const createdat = d.createdat ?? d.createdAt ?? null;
            const updatedat = d.updatedat ?? d.updatedAt ?? null;
            const personeluid = d.personeluid ?? d.personelUid ?? null;
            const kaydedenpersoneluid = d.kaydedenpersoneluid ?? d.kaydedenPersonelUid ?? null;
            const odemeyontemi = d.odemeyontemi ?? d.odemeYontemi ?? null;
            const mapped = {
              ...d,
              createdat,
              updatedat,
              personeluid,
              kaydedenpersoneluid,
              odemeyontemi,
              // aliases
              createdAt: createdat,
              updatedAt: updatedat,
              personelUid: personeluid,
              kaydedenPersonelUid: kaydedenpersoneluid,
              odemeYontemi: odemeyontemi,
              tip: 'teberru'
            };
            allDocs.set(mapped.id, mapped);
          });
        });

        let allTeberru = Array.from(allDocs.values());
        console.log('ğŸ“Š Teberru toplam kayÄ±t (yÄ±l filtresi Ã¶ncesi):', allTeberru.length);
        if (CURRENT_YIL) {
          const yilNum = parseInt(CURRENT_YIL);
          const oncekiSayi = allTeberru.length;
          allTeberru = allTeberru.filter(t => parseInt(t.yil) === yilNum);
          console.log(`ğŸ“Š Teberru yÄ±l filtresi (${yilNum}):`, oncekiSayi, '->', allTeberru.length);
        }

        teberruKayitlari = allTeberru;
        console.log('âœ… Teberru kayÄ±tlarÄ± hazÄ±r:', teberruKayitlari.length);
        teberruKayitlari.sort((a, b) => {
          const aTime = new Date(a.createdAt).getTime();
          const bTime = new Date(b.createdAt).getTime();
          return aTime - bTime;
        });

      } catch (e) {
        console.error('Teberru kayÄ±tlarÄ± yÃ¼klenemedi:', e);
        teberruKayitlari = [];
      }
    }

    async function loadTaahhutKayitlari() {
      if (!currentUser && !currentPersonelAdi) {
        console.warn('âš ï¸ loadTaahhutKayitlari: currentUser ve currentPersonelAdi yok');
        taahhutKayitlari = [];
        return;
      }
      try {
        const cols = 'id, yil, ay, personel, personeluid, bagisci, miktar, aciklama, not, durum, tarih, silindi, kaydedenpersonel, kaydedenpersoneluid, createdat, updatedat';
        const queries = [];

        // IMPERSONATION KONTROLÃœ: BaÅŸka kullanÄ±cÄ± gÃ¶rÃ¼ntÃ¼leniyorsa sadece o kullanÄ±cÄ±nÄ±n verilerini Ã§ek
        const targetUserId = isImpersonating ? impersonatedUserId : currentUser?.id;
        const targetUserName = currentPersonelAdi;

        // UID tek sorgu (or)
        if (targetUserId) {
          queries.push(
            window.supabase
              .from('taahhut_kayitlari')
              .select(cols)
              .or(`personeluid.eq.${targetUserId},kaydedenpersoneluid.eq.${targetUserId}`)
          );
        }

        // Ä°sim tek sorgu (or) - taahhut_kayitlari tablosunda personeladi yok, sadece personel var
        if (targetUserName && targetUserName !== 'KullanÄ±cÄ±' && targetUserName !== 'Bilinmiyor' && !targetUserName.includes('@')) {
          queries.push(
            window.supabase
              .from('taahhut_kayitlari')
              .select(cols)
              .or(`personel.eq.${targetUserName},kaydedenpersonel.eq.${targetUserName}`)
          );
        }

        if (queries.length === 0) {
          console.warn('âš ï¸ loadTaahhutKayitlari: HiÃ§ sorgu yok (currentUser.id veya currentPersonelAdi yok)');
          taahhutKayitlari = [];
          return;
        }

        const results = await Promise.all(queries);
        const allDocs = new Map();

        results.forEach((res) => {
          if (res?.error) {
            console.warn('âš ï¸ TaahhÃ¼t sorgu hatasÄ±:', res.error);
            return;
          }
          (res?.data || []).forEach(d => {
            const createdat = d.createdat ?? d.createdAt ?? null;
            const updatedat = d.updatedat ?? d.updatedAt ?? null;
            const personeluid = d.personeluid ?? d.personelUid ?? null;
            const kaydedenpersoneluid = d.kaydedenpersoneluid ?? d.kaydedenPersonelUid ?? null;
            const mapped = {
              ...d,
              createdat,
              updatedat,
              personeluid,
              kaydedenpersoneluid,
              // aliases
              createdAt: createdat,
              updatedAt: updatedat,
              personelUid: personeluid,
              kaydedenPersonelUid: kaydedenpersoneluid,
              tip: 'taahhut'
            };
            allDocs.set(mapped.id, mapped);
          });
        });

        let allTaahhut = Array.from(allDocs.values());
        console.log('ğŸ“Š TaahhÃ¼t toplam kayÄ±t (yÄ±l filtresi Ã¶ncesi):', allTaahhut.length);
        if (CURRENT_YIL) {
          const yilNum = parseInt(CURRENT_YIL);
          const oncekiSayi = allTaahhut.length;
          allTaahhut = allTaahhut.filter(t => parseInt(t.yil) === yilNum);
          console.log(`ğŸ“Š TaahhÃ¼t yÄ±l filtresi (${yilNum}):`, oncekiSayi, '->', allTaahhut.length);
        }

        taahhutKayitlari = allTaahhut;
        console.log('âœ… TaahhÃ¼t kayÄ±tlarÄ± hazÄ±r:', taahhutKayitlari.length);
        taahhutKayitlari.sort((a, b) => {
          const aTime = new Date(a.createdAt).getTime();
          const bTime = new Date(b.createdAt).getTime();
          return aTime - bTime;
        });
      } catch (e) {
        console.error('TaahhÃ¼t kayÄ±tlarÄ± yÃ¼klenemedi:', e);
        taahhutKayitlari = [];
      }
    }



    let importedVeriler = [];

    async function loadImportedVeriler() {
      if (!currentUser || !CURRENT_YIL) {
        importedVeriler = [];
        return;
      }
      try {
        const yilNum = typeof CURRENT_YIL === 'number' ? CURRENT_YIL : parseInt(CURRENT_YIL);

        // IMPERSONATION KONTROLÃœ: BaÅŸka kullanÄ±cÄ± gÃ¶rÃ¼ntÃ¼leniyorsa sadece o kullanÄ±cÄ±nÄ±n verilerini Ã§ek
        const targetUserId = isImpersonating ? impersonatedUserId : currentUser?.id;
        const targetUserName = currentPersonelAdi;

        // Personel adÄ±nÄ± normalize et (karÅŸÄ±laÅŸtÄ±rma iÃ§in)
        const pName = targetUserName ? normalizePersonelName(targetUserName) : '';

        const { data, error } = await window.supabase
          .from('ramazan_veriler')
          .select('id, createdat, diger, personel, sahip, tip, tutar, yil, yukleyen, updatedat, referans')
          .eq('yil', yilNum);

        if (error) throw error;

        // Client-side filtreleme (personel veya referans eÅŸleÅŸmesi)
        // Ã‡Ã¼nkÃ¼ "referans" alanÄ± bazen personel yerine kullanÄ±lÄ±yor
        importedVeriler = (data || []).map(d => ({
          ...d,
          personelUid: d.personelUid || d.personeluid,
          createdAt: d.createdAt || d.createdat
        })).filter(d => {
          const dPersonel = d.personel ? normalizePersonelName(d.personel) : '';
          const dReferans = d.referans ? normalizePersonelName(d.referans) : '';

          // Personel adÄ± eÅŸleÅŸiyorsa veya referans eÅŸleÅŸiyorsa
          // VEYA imported verinin `personelUid` alanÄ± varsa ve hedef kullanÄ±cÄ± ID'si ile eÅŸleÅŸiyorsa
          if (targetUserId && d.personelUid === targetUserId) return true;

          // Ä°sim eÅŸleÅŸmeleri (normalize edilmiÅŸ)
          if (pName && (dPersonel === pName || dReferans === pName)) return true;

          return false;
        });

      } catch (e) {
        console.error('Imported veriler yÃ¼klenemedi:', e);
        importedVeriler = [];
      }
    }

    async function loadMyRecords() {
      if (isLoadingMyRecords) return;
      isLoadingMyRecords = true;
      try {
      const container = qs('#myRecordsList');
      if (!currentUser && !currentPersonelAdi) {
        container.innerHTML = '<div style="text-align:center; padding:20px; color:#999">GiriÅŸ yapÄ±lmamÄ±ÅŸ veya kullanÄ±cÄ± bilgisi yÃ¼klenmedi</div>';
        console.warn('âš ï¸ loadMyRecords: currentUser ve currentPersonelAdi yok');
        return;
      }

      if (!CURRENT_YIL) {
        container.innerHTML = '<div style="text-align:center; padding:20px; color:#999">YÄ±l seÃ§imi yapÄ±lmamÄ±ÅŸ</div>';
        return;
      }

      console.log('ğŸ” loadMyRecords baÅŸladÄ±:', { 
        currentUser: currentUser?.id || currentUser?.email, 
        currentPersonelAdi,
        CURRENT_YIL, 
        kayitlarLength: kayitlar?.length || 0,
        currentUserObj: currentUser
      });
      // Race-condition retry mekanizmasÄ± kaldÄ±rÄ±ldÄ±:
      // Profil yoksa (currentPersonelAdi null) UID eÅŸleÅŸmesiyle devam edilir, isim eÅŸleÅŸmesi yapÄ±lmaz.

      // Ã–nce kayÄ±tlarÄ± yÃ¼kle (eÄŸer yÃ¼klenmemiÅŸse)
      if (!kayitlar || kayitlar.length === 0) {
        console.log('ğŸ“¥ KayÄ±tlar yÃ¼kleniyor...');
        // Buradan Ã§aÄŸÄ±rÄ±nca loadKayitlar'Ä±n tekrar loadMyRecords tetiklemesini engelle
        await loadKayitlar({ skipMyRecords: true });
        console.log('âœ… KayÄ±tlar yÃ¼klendi:', kayitlar?.length || 0);
        // Ä°lk 3 kaydÄ± gÃ¶ster (debug iÃ§in)
        if (kayitlar && kayitlar.length > 0) {
          console.log('ğŸ“‹ Ä°lk 3 kayÄ±t Ã¶rneÄŸi:', kayitlar.slice(0, 3).map(k => ({
            id: k.id,
            personeluid: k.personeluid || k.personelUid,
            personeladi: k.personeladi || k.personelAdi,
            personel: k.personel,
            sahip: k.sahip
          })));
        }
      }

      // Teberru, TaahhÃ¼t, DÃ¼zenleme talepleri ve IMPORTED VERÄ°LERÄ° yÃ¼kle
      console.log('ğŸ“¥ Teberru, TaahhÃ¼t, DÃ¼zenleme talepleri ve Imported veriler yÃ¼kleniyor...');
      await Promise.all([loadTeberruKayitlari(), loadTaahhutKayitlari(), loadDuzenlemeTalepleri(), loadImportedVeriler()]);
      console.log('âœ… Veriler yÃ¼klendi:', { 
        teberru: teberruKayitlari?.length || 0, 
        taahhut: taahhutKayitlari?.length || 0,
        duzenleme: duzenlemeTalepleri?.length || 0,
        imported: importedVeriler?.length || 0
      });

      console.log('ğŸ” Filtreleme baÅŸlÄ±yor:', {
        kayitlarToplam: kayitlar?.length || 0,
        currentUser: currentUser?.id || currentUser?.email,
        currentPersonelAdi,
        currentUserEmail: currentUser?.email,
        currentUserObj: currentUser
      });

      // IMPERSONATION KONTROLÃœ: BaÅŸka kullanÄ±cÄ± gÃ¶rÃ¼ntÃ¼leniyorsa sadece o kullanÄ±cÄ±nÄ±n verilerini filtrele
      const targetUserId = isImpersonating ? impersonatedUserId : currentUser?.id;
      const targetUserName = currentPersonelAdi;

      const myKayitlar = (kayitlar || [])
        .filter(k => {
          // Silinen kayÄ±tlarÄ± gÃ¶sterme
          if (k.silindi) {
            console.log('âŒ Silinen kayÄ±t atlandÄ±:', k.id);
            return false;
          }

          // 1. Ã–nce personeluid eÅŸleÅŸmesi (hedef kullanÄ±cÄ± ID'si ile)
          if (targetUserId) {
            const kayitPersonelUid = k.personelUid || k.personeluid;
            if (kayitPersonelUid && kayitPersonelUid === targetUserId) {
              console.log('âœ… UID eÅŸleÅŸti:', k.id, { kayitPersonelUid, targetUserId });
              return true;
            }
          }

          // 2. Personel adÄ± eÅŸleÅŸmesi (hedef kullanÄ±cÄ± adÄ± ile)
          if (targetUserName && targetUserName !== 'KullanÄ±cÄ±' && targetUserName !== 'Bilinmiyor' && !targetUserName.includes('@')) {
            const kayitPersonelAdi = (k.personeladi ?? k.personelAdi ?? '') || '';
            const kayitPersonel = (k.personel ?? '') || '';
            const kayitSahip = (k.sahip ?? '') || '';
            
            // Normalize edilmiÅŸ karÅŸÄ±laÅŸtÄ±rma (hedef kullanÄ±cÄ± adÄ± ile)
            const normalizedTarget = normalizePersonelName(targetUserName);
            const normalizedKayitAdi = normalizePersonelName(kayitPersonelAdi);
            const normalizedKayitPersonel = normalizePersonelName(kayitPersonel);
            const normalizedKayitSahip = normalizePersonelName(kayitSahip);
            
            if (normalizedKayitAdi && normalizedKayitAdi === normalizedTarget) {
              console.log('âœ… Personel adÄ± eÅŸleÅŸti (personelAdi):', k.id, { 
                targetUserName, 
                kayitPersonelAdi,
                normalizedTarget,
                normalizedKayitAdi
              });
              return true;
            }
            if (normalizedKayitPersonel && normalizedKayitPersonel === normalizedTarget) {
              console.log('âœ… Personel adÄ± eÅŸleÅŸti (personel):', k.id, { 
                targetUserName, 
                kayitPersonel,
                normalizedTarget,
                normalizedKayitPersonel
              });
              return true;
            }
            if (normalizedKayitSahip && normalizedKayitSahip === normalizedTarget) {
              console.log('âœ… Personel adÄ± eÅŸleÅŸti (sahip):', k.id, { 
                targetUserName, 
                kayitSahip,
                normalizedTarget,
                normalizedKayitSahip
              });
              return true;
            }
          }

          return false;
        })
        .map(k => ({ ...k, kayitTipi: 'iftar-sahur' }));

      console.log('âœ… FiltrelenmiÅŸ kayÄ±tlar:', myKayitlar.length);
      if (myKayitlar.length === 0 && kayitlar && kayitlar.length > 0) {
        console.warn('âš ï¸ HiÃ§ kayÄ±t eÅŸleÅŸmedi! Ä°lk kayÄ±t Ã¶rneÄŸi:', {
          ilkKayit: kayitlar[0],
          currentUser: currentUser?.id,
          currentPersonelAdi
        });
      }

      // Tarih parse fonksiyonu
      const parseDate = (record) => {
        // Ä°ftar-sahur kayÄ±tlarÄ± iÃ§in tarih alanÄ±
        if (record.tarih) {
          if (record.tarih.toDate) return record.tarih.toDate();
          if (record.tarih.seconds) return new Date(record.tarih.seconds * 1000);
          if (typeof record.tarih === 'string') return new Date(record.tarih);
          if (record.tarih instanceof Date) return record.tarih;
        }
        // Teberru ve taahhÃ¼t kayÄ±tlarÄ± ve IMPORTED veriler iÃ§in createdAt
        if (record.createdAt) {
          if (record.createdAt.toDate) return record.createdAt.toDate();
          if (record.createdAt.seconds) return new Date(record.createdAt.seconds * 1000);
          if (typeof record.createdAt === 'string') return new Date(record.createdAt);
          if (record.createdAt instanceof Date) return record.createdAt;
        }
        // Fallback: Ã§ok eski bir tarih
        return new Date(0);
      };

      // TÃ¼m kayÄ±tlarÄ± birleÅŸtir ve sÄ±rala: Ä°ftar -> Sahur -> TaahhÃ¼t -> Teberru -> DiÄŸer (Imported)
      const allRecords = [
        ...myKayitlar,
        ...teberruKayitlari.map(t => ({ ...t, kayitTipi: 'teberru', tarih: t.createdAt })),
        ...taahhutKayitlari.map(t => ({ ...t, kayitTipi: 'taahhut', tarih: t.createdAt })),
        ...importedVeriler.map(v => ({
          ...v,
          kayitTipi: 'imported', // Yeni tip: yÃ¶netimden girilen veriler
          tarih: v.createdAt,
          // Imported verilerde tip alanÄ± text olarak geliyor (iftar, sahur vs), bunu koruyalÄ±m
          // veya gÃ¶sterimde kullanalÄ±m
        }))
      ];
      
      // UI/UX: Filtreleme uygula
      let filteredRecords = allRecords;
      if (currentFilter !== 'all') {
        filteredRecords = allRecords.filter(record => {
          if (currentFilter === 'iftar') {
            return (record.kayitTipi === 'iftar-sahur' && record.tip === 'iftar') || 
                   (record.kayitTipi === 'imported' && (record.tip || '').toLowerCase() === 'iftar');
          } else if (currentFilter === 'sahur') {
            return (record.kayitTipi === 'iftar-sahur' && record.tip === 'sahur') || 
                   (record.kayitTipi === 'imported' && (record.tip || '').toLowerCase() === 'sahur');
          } else if (currentFilter === 'teberru') {
            return record.kayitTipi === 'teberru' || 
                   (record.kayitTipi === 'imported' && (record.tip || '').toLowerCase() === 'teberru');
          } else if (currentFilter === 'taahhut') {
            return record.kayitTipi === 'taahhut' || 
                   (record.kayitTipi === 'imported' && ((record.tip || '').toLowerCase() === 'taahhut' || (record.tip || '').toLowerCase() === 'taahhÃ¼t'));
          }
          return true;
        });
      }
      
      const allRecordsSorted = filteredRecords.sort((a, b) => {
        // Ã–nce tip sÄ±ralamasÄ±: iftar(1) -> sahur(2) -> taahhut(3) -> teberru(4) -> imported(5)
        const getTipOrder = (k) => {
          if (k.kayitTipi === 'iftar-sahur') {
            return k.tip === 'iftar' ? 1 : 2;
          } else if (k.kayitTipi === 'taahhut') {
            return 3;
          } else if (k.kayitTipi === 'teberru') {
            return 4;
          } else if (k.kayitTipi === 'imported') {
            // Imported iÃ§indeki tipe gÃ¶re sÄ±ralama yapabiliriz
            const impTip = (k.tip || '').toLowerCase();
            if (impTip === 'iftar') return 1;
            if (impTip === 'sahur') return 2;
            if (impTip === 'taahhut' || impTip === 'taahhÃ¼t') return 3;
            if (impTip === 'teberru') return 4;
            return 5;
          }
          return 6;
        };

        const aTipOrder = getTipOrder(a);
        const bTipOrder = getTipOrder(b);

        // Ã–nce tip sÄ±ralamasÄ±na gÃ¶re
        if (aTipOrder !== bTipOrder) {
          return aTipOrder - bTipOrder;
        }

        // AynÄ± tipse tarihe gÃ¶re (yeniden eskiye)
        const aDate = parseDate(a);
        const bDate = parseDate(b);
        return bDate.getTime() - aDate.getTime();
      });

      // KPI hesaplama
      const toplamIftarAdedi = myKayitlar.filter(k => k.tip === 'iftar').length;
      const toplamSahurAdedi = myKayitlar.filter(k => k.tip === 'sahur').length;
      const toplamTeberruAdedi = teberruKayitlari.length;
      const toplamTaahhutAdedi = taahhutKayitlari.length;

      qs('#kpiToplamIftar').textContent = toplamIftarAdedi;
      qs('#kpiToplamSahur').textContent = toplamSahurAdedi;

      // Teberru ve TaahhÃ¼t sayaÃ§larÄ±nÄ± ekle (eÄŸer yer varsa)
      // Mevcut HTML yapÄ±sÄ±na uygun olarak span oluÅŸtur veya var olanÄ± gÃ¼ncelle
      const kpiContainer = qs('#myRecordsKPI');
      if (kpiContainer) {
        // Mevcut style temizliÄŸi veya ekleme
        // EÄŸer teberru/taahhÃ¼t KPI elementleri yoksa ekleyelim
        if (!qs('#kpiToplamTeberru')) {
          const teberruHtml = `
            <div style="background:#e8f8f5; border:1px solid #2ecc71; border-radius:8px; padding:10px; flex:1; display:flex; flex-direction:column; align-items:center; min-width:80px;">
              <div style="font-size:20px; margin-bottom:4px;">ğŸ’°</div>
              <div style="font-size:11px; color:#27ae60; font-weight:600; text-transform:uppercase;">Teberru</div>
              <div style="font-size:18px; font-weight:800; color:#2c3e50;" id="kpiToplamTeberru">${toplamTeberruAdedi}</div>
            </div>`;
          const taahhutHtml = `
            <div style="background:#eaf2f8; border:1px solid #3498db; border-radius:8px; padding:10px; flex:1; display:flex; flex-direction:column; align-items:center; min-width:80px;">
              <div style="font-size:20px; margin-bottom:4px;">ğŸ“‹</div>
              <div style="font-size:11px; color:#2980b9; font-weight:600; text-transform:uppercase;">TaahhÃ¼t</div>
              <div style="font-size:18px; font-weight:800; color:#2c3e50;" id="kpiToplamTaahhut">${toplamTaahhutAdedi}</div>
            </div>`;

          // Container'a ekle (append)
          // Ancak mevcutlar (iftar/sahur) da aynÄ± container iÃ§indeyse, sÄ±rayÄ± bozmamak iÃ§in insertAdjacentHTML kullanabiliriz
          // veya container'Ä±n flex yapÄ±sÄ±na gÃ¼venip sonuna ekleriz.
          // Ã–nce mevcut iÃ§eriÄŸi koruyarak ekleyelim mi yoksa yeniden mi Ã§izelim?
          // Mevcut iÃ§erik dinamik olabilir, en iyisi varsa gÃ¼ncelle, yoksa ekle.
          kpiContainer.insertAdjacentHTML('beforeend', teberruHtml + taahhutHtml);
        } else {
          qs('#kpiToplamTeberru').textContent = toplamTeberruAdedi;
          qs('#kpiToplamTaahhut').textContent = toplamTaahhutAdedi;
        }
      }

      if (allRecordsSorted.length === 0) {
        container.innerHTML = '<div style="text-align:center; padding:20px; color:#999">HenÃ¼z kayÄ±t bulunmamaktadÄ±r</div>';
        return;
      }

      container.innerHTML = '';
      allRecordsSorted.forEach(k => {
        if (k.kayitTipi === 'iftar-sahur') {
          // Mevcut iftar-sahur kayÄ±tlarÄ±
          const kDate = k.tarih.toDate ? k.tarih.toDate() : new Date(k.tarih);
          const tipLabel = k.tip === 'iftar' ? 'ğŸŒ™ Ä°ftar' : 'ğŸŒŸ Sahur';
          const card = document.createElement('div');
          card.className = 'day-card';
          card.style.marginBottom = '12px';
          card.style.flexDirection = 'column';
          card.style.alignItems = 'stretch';
          // DeÄŸiÅŸiklik kontrolÃ¼
          const hasUpdate = k.updatedAt && k.createdAt;
          let updateInfo = '';
          if (hasUpdate) {
            const createdTime = k.createdAt.toDate ? k.createdAt.toDate().getTime() : (k.createdAt.seconds || 0) * 1000;
            const updatedTime = k.updatedAt.toDate ? k.updatedAt.toDate().getTime() : (k.updatedAt.seconds || 0) * 1000;
            if (updatedTime > createdTime) {
              const updateDate = k.updatedAt.toDate ? k.updatedAt.toDate() : new Date(updatedTime);
              updateInfo = `<div style="font-size:11px; color:var(--warning); margin-top:4px; font-weight:600;">âš ï¸ DeÄŸiÅŸiklik YapÄ±ldÄ± (${updateDate.toLocaleDateString('tr-TR')} ${updateDate.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })})</div>`;
            }
          }

          const mahalId = k.mahalId || k.mahalid;
          const mahalAdi = mahalId ? (mahaller.find(m => m.id === mahalId)?.adi || 'Mahal') : null;
          const musafirAdedi = k.musafirAdedi || k.musafiradedi || 0;
          const kayitPersonelAdi = k.personelAdi || k.personeladi;

          card.innerHTML = `
          <div style="flex:1;">
            <div style="display:flex; align-items:center; gap:8px; margin-bottom:10px; padding-bottom:8px; border-bottom:2px solid #f0f0f0;">
              <div style="font-size:20px;">${k.tip === 'iftar' ? 'ğŸŒ™' : 'ğŸŒŸ'}</div>
              <div style="flex:1;">
                <div style="font-size:11px; color:#95a5a6; margin-bottom:3px; font-weight:500; text-transform:uppercase; letter-spacing:0.5px;">${kDate.toLocaleDateString('tr-TR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}</div>
                <div style="font-size:16px; font-weight:700; color:var(--primary);">${tipLabel}</div>
              </div>
            </div>
            
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px;">
              <div style="background:#f8f9fa; padding:10px; border-radius:8px;">
                <div style="font-size:11px; color:#7f8c8d; margin-bottom:4px; font-weight:500;">BaÄŸÄ±ÅŸÃ§Ä±</div>
                <div style="font-size:15px; font-weight:700; color:#2c3e50;" id="sahip-${k.id}">${k.sahip}</div>
              </div>
              <div style="background:#f8f9fa; padding:10px; border-radius:8px;">
                <div style="font-size:11px; color:#7f8c8d; margin-bottom:4px; font-weight:500;">Tutar</div>
                <div style="font-size:15px; font-weight:700; color:#27ae60;">â‚º${Number(k.tutar || 0).toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
              </div>
            </div>
            
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px;">
              <div style="background:#f8f9fa; padding:10px; border-radius:8px;">
                <div style="font-size:11px; color:#7f8c8d; margin-bottom:4px; font-weight:500;">MÃ¼safir Adedi</div>
                <div style="font-size:15px; font-weight:700; color:#3498db;" id="musafir-${k.id}">${musafirAdedi}</div>
              </div>
              ${mahalAdi ? `
              <div style="background:#f8f9fa; padding:10px; border-radius:8px;">
                <div style="font-size:11px; color:#7f8c8d; margin-bottom:4px; font-weight:500;">Mahal</div>
                <div style="font-size:15px; font-weight:700; color:#9b59b6;">ğŸ›ï¸ ${mahalAdi}</div>
              </div>
              ` : '<div></div>'}
            </div>
            
            ${k.not ? `<div style="background:#fff3cd; padding:10px; border-radius:8px; border-left:3px solid #ffc107; margin-bottom:10px;">
              <div style="font-size:11px; color:#856404; margin-bottom:4px; font-weight:600;">ğŸ“ Not</div>
              <div style="font-size:13px; color:#856404; line-height:1.5;">${k.not}</div>
            </div>` : ''}
            
            <div style="background:#e8f4f8; padding:8px; border-radius:6px; margin-bottom:10px;">
              <div style="font-size:11px; color:#17a2b8; font-weight:600;">ğŸ‘¤ Kaydeden: ${kayitPersonelAdi || k.personel || 'Bilinmiyor'}</div>
            </div>
            
            ${updateInfo}
            ${(() => {
              const talep = duzenlemeTalepleri.find(t => (t.kayitid || t.kayitId) === k.id && t.kayittipi === 'iftar-sahur');
              if (talep) {
                if (talep.durum === 'reddedildi') {
                  return `<div style="background:#f8d7da; padding:8px; border-radius:6px; border-left:3px solid #dc3545; margin-top:8px;">
                    <div style="font-size:11px; color:#721c24; font-weight:600;">âŒ DÃ¼zenleme talebi reddedildi</div>
                    ${talep.redaciklama ? `<div style="font-size:10px; color:#721c24; margin-top:4px;">Sebep: ${escapeHtml(talep.redaciklama)}</div>` : ''}
                  </div>`;
                } else if (talep.durum === 'onaylandi') {
                  return '<div style="background:#d4edda; padding:8px; border-radius:6px; border-left:3px solid #28a745; margin-top:8px;"><div style="font-size:11px; color:#155724; font-weight:600;">âœ… DÃ¼zenleme talebi onaylandÄ±</div></div>';
                } else {
                  return '<div style="background:#d1ecf1; padding:8px; border-radius:6px; border-left:3px solid #17a2b8; margin-top:8px;"><div style="font-size:11px; color:#17a2b8; font-weight:600;">ğŸ“‹ DÃ¼zenleme talep edildi (Beklemede)</div></div>';
                }
              }
              return '';
            })()}
          </div>
          <div style="display:flex; gap:8px; align-items:center; margin-top:12px; justify-content:flex-end; padding-top:12px; border-top:1px solid #f0f0f0;">
            <button onclick="editMyRecord('${k.id}')" style="background:var(--primary); color:white; border:none; padding:10px 16px; border-radius:8px; font-size:13px; cursor:pointer; font-weight:600; box-shadow:0 2px 6px rgba(0,0,0,0.1);">âœï¸ DÃ¼zenle</button>
            <button onclick="generateDavetiye('${k.sahip}', '${k.tip}', '${kDate.toISOString()}', ${musafirAdedi})" style="background:#d4af37; color:white; border:none; padding:10px 16px; border-radius:8px; font-size:13px; cursor:pointer; font-weight:600; box-shadow:0 2px 6px rgba(0,0,0,0.1);">ğŸ« Davetiye</button>
          </div>
        `;
          container.appendChild(card);
        } else if (k.kayitTipi === 'taahhut') {
          // TaahhÃ¼t kayÄ±tlarÄ±
          let kDate;
          if (k.createdAt) {
            if (k.createdAt.toDate) {
              kDate = k.createdAt.toDate();
            } else if (k.createdAt.seconds) {
              kDate = new Date(k.createdAt.seconds * 1000);
            } else {
              kDate = new Date(k.createdAt);
            }
          } else {
            kDate = new Date();
          }

          // DeÄŸiÅŸiklik kontrolÃ¼
          const hasUpdate = k.updatedAt && k.createdAt;
          let updateInfo = '';
          if (hasUpdate) {
            const createdTime = k.createdAt.toDate ? k.createdAt.toDate().getTime() : (k.createdAt.seconds || 0) * 1000;
            const updatedTime = k.updatedAt.toDate ? k.updatedAt.toDate().getTime() : (k.updatedAt.seconds || 0) * 1000;
            if (updatedTime > createdTime) {
              const updateDate = k.updatedAt.toDate ? k.updatedAt.toDate() : new Date(updatedTime);
              updateInfo = `<div style="font-size:11px; color:var(--warning); margin-top:4px; font-weight:600;">âš ï¸ DeÄŸiÅŸiklik YapÄ±ldÄ± (${updateDate.toLocaleDateString('tr-TR')} ${updateDate.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })})</div>`;
            }
          }

          const card = document.createElement('div');
          card.className = 'day-card';
          card.style.marginBottom = '12px';
          card.style.flexDirection = 'column';
          card.style.alignItems = 'stretch';
          card.style.borderLeft = '5px solid #3498db';

          card.innerHTML = `
            <div style="flex:1;">
              <div style="display:flex; align-items:center; gap:8px; margin-bottom:10px; padding-bottom:8px; border-bottom:2px solid #f0f0f0;">
                <div style="font-size:20px;">ğŸ“‹</div>
                <div style="flex:1;">
                  <div style="font-size:11px; color:#95a5a6; margin-bottom:3px; font-weight:500; text-transform:uppercase; letter-spacing:0.5px;">${kDate.toLocaleDateString('tr-TR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}</div>
                  <div style="font-size:16px; font-weight:700; color:#3498db;">ğŸ“‹ TaahhÃ¼t</div>
                </div>
              </div>
              
              <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px;">
                <div style="background:#f8f9fa; padding:10px; border-radius:8px;">
                  <div style="font-size:11px; color:#7f8c8d; margin-bottom:4px; font-weight:500;">BaÄŸÄ±ÅŸÃ§Ä±</div>
                  <div style="font-size:15px; font-weight:700; color:#2c3e50;" id="taahhut-bagisci-${k.id}">${k.bagisci || 'Bilinmiyor'}</div>
                </div>
                <div style="background:#f8f9fa; padding:10px; border-radius:8px;">
                  <div style="font-size:11px; color:#7f8c8d; margin-bottom:4px; font-weight:500;">Miktar</div>
                  <div style="font-size:15px; font-weight:700; color:#3498db;">â‚º${(k.miktar || 0).toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                </div>
              </div>
              
              ${k.aciklama ? `<div style="background:#fff3cd; padding:10px; border-radius:8px; border-left:3px solid #ffc107; margin-bottom:10px;">
                <div style="font-size:11px; color:#856404; margin-bottom:4px; font-weight:600;">ğŸ“ AÃ§Ä±klama</div>
                <div style="font-size:13px; color:#856404; line-height:1.5;">${k.aciklama}</div>
              </div>` : ''}
              
              <div style="background:#e8f4f8; padding:8px; border-radius:6px; margin-bottom:10px;">
                <div style="font-size:11px; color:#17a2b8; font-weight:600;">ğŸ‘¤ Kaydeden: ${k.personelAdi || k.personeladi || k.personel || k.kaydedenPersonel || k.kaydedenpersonel || 'Bilinmiyor'}</div>
              </div>
              
              ${updateInfo}
              ${(() => {
                const talep = duzenlemeTalepleri.find(t => (t.kayitid || t.kayitId) === k.id && t.kayittipi === 'taahhut');
                if (talep) {
                  if (talep.durum === 'reddedildi') {
                    return `<div style="background:#f8d7da; padding:8px; border-radius:6px; border-left:3px solid #dc3545; margin-top:8px;">
                      <div style="font-size:11px; color:#721c24; font-weight:600;">âŒ DÃ¼zenleme talebi reddedildi</div>
                      ${talep.redaciklama ? `<div style="font-size:10px; color:#721c24; margin-top:4px;">Sebep: ${escapeHtml(talep.redaciklama)}</div>` : ''}
                    </div>`;
                  } else if (talep.durum === 'onaylandi') {
                    return '<div style="background:#d4edda; padding:8px; border-radius:6px; border-left:3px solid #28a745; margin-top:8px;"><div style="font-size:11px; color:#155724; font-weight:600;">âœ… DÃ¼zenleme talebi onaylandÄ±</div></div>';
                  } else {
                    return '<div style="background:#d1ecf1; padding:8px; border-radius:6px; border-left:3px solid #17a2b8; margin-top:8px;"><div style="font-size:11px; color:#17a2b8; font-weight:600;">ğŸ“‹ DÃ¼zenleme talep edildi (Beklemede)</div></div>';
                  }
                }
                return '';
              })()}
            </div>
            <div style="display:flex; gap:8px; align-items:center; margin-top:12px; justify-content:flex-end; padding-top:12px; border-top:1px solid #f0f0f0;">
              <button onclick="editTaahhutRecord('${k.id}')" style="background:var(--primary); color:white; border:none; padding:10px 16px; border-radius:8px; font-size:13px; cursor:pointer; font-weight:600; box-shadow:0 2px 6px rgba(0,0,0,0.1);">âœï¸ DÃ¼zenle</button>
            </div>
          `;
          container.appendChild(card);
        } else if (k.kayitTipi === 'teberru') {
          // Teberru kayÄ±tlarÄ±
          let kDate;
          if (k.createdAt) {
            if (k.createdAt.toDate) {
              kDate = k.createdAt.toDate();
            } else if (k.createdAt.seconds) {
              kDate = new Date(k.createdAt.seconds * 1000);
            } else {
              kDate = new Date(k.createdAt);
            }
          } else {
            kDate = new Date();
          }

          // DeÄŸiÅŸiklik kontrolÃ¼
          const hasUpdate = k.updatedAt && k.createdAt;
          let updateInfo = '';
          if (hasUpdate) {
            const createdTime = k.createdAt.toDate ? k.createdAt.toDate().getTime() : (k.createdAt.seconds || 0) * 1000;
            const updatedTime = k.updatedAt.toDate ? k.updatedAt.toDate().getTime() : (k.updatedAt.seconds || 0) * 1000;
            if (updatedTime > createdTime) {
              const updateDate = k.updatedAt.toDate ? k.updatedAt.toDate() : new Date(updatedTime);
              updateInfo = `<div style="font-size:11px; color:var(--warning); margin-top:4px; font-weight:600;">âš ï¸ DeÄŸiÅŸiklik YapÄ±ldÄ± (${updateDate.toLocaleDateString('tr-TR')} ${updateDate.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })})</div>`;
            }
          }

          const odemeLabels = {
            'nakit': 'ğŸ’µ Nakit',
            'banka': 'ğŸ¦ Banka',
            'pos': 'ğŸ’³ POS',
            'sanal': 'ğŸ“± Sanal'
          };
          const card = document.createElement('div');
          card.className = 'day-card';
          card.style.marginBottom = '12px';
          card.style.flexDirection = 'column';
          card.style.alignItems = 'stretch';
          card.style.borderLeft = '5px solid #27ae60';

          card.innerHTML = `
            <div style="flex:1;">
              <div style="display:flex; align-items:center; gap:8px; margin-bottom:10px; padding-bottom:8px; border-bottom:2px solid #f0f0f0;">
                <div style="font-size:20px;">ğŸ’°</div>
                <div style="flex:1;">
                  <div style="font-size:11px; color:#95a5a6; margin-bottom:3px; font-weight:500; text-transform:uppercase; letter-spacing:0.5px;">${kDate.toLocaleDateString('tr-TR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}</div>
                  <div style="font-size:16px; font-weight:700; color:#27ae60;">ğŸ’° Teberru</div>
                </div>
              </div>
              
              <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px;">
                <div style="background:#f8f9fa; padding:10px; border-radius:8px;">
                  <div style="font-size:11px; color:#7f8c8d; margin-bottom:4px; font-weight:500;">BaÄŸÄ±ÅŸÃ§Ä±</div>
                  <div style="font-size:15px; font-weight:700; color:#2c3e50;" id="teberru-bagisci-${k.id}">${k.bagisci || 'Bilinmiyor'}</div>
                </div>
                <div style="background:#f8f9fa; padding:10px; border-radius:8px;">
                  <div style="font-size:11px; color:#7f8c8d; margin-bottom:4px; font-weight:500;">Miktar</div>
                  <div style="font-size:15px; font-weight:700; color:#27ae60;">â‚º${(k.miktar || 0).toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                </div>
              </div>
              
              <div style="background:#f8f9fa; padding:10px; border-radius:8px; margin-bottom:10px;">
                <div style="font-size:11px; color:#7f8c8d; margin-bottom:4px; font-weight:500;">Ã–deme YÃ¶ntemi</div>
                <div style="font-size:14px; font-weight:600; color:#9b59b6;">${odemeLabels[k.odemeYontemi || k.odemeyontemi] || k.odemeYontemi || k.odemeyontemi || '-'}</div>
              </div>
              
              ${k.aciklama ? `<div style="background:#fff3cd; padding:10px; border-radius:8px; border-left:3px solid #ffc107; margin-bottom:10px;">
                <div style="font-size:11px; color:#856404; margin-bottom:4px; font-weight:600;">ğŸ“ AÃ§Ä±klama</div>
                <div style="font-size:13px; color:#856404; line-height:1.5;">${k.aciklama}</div>
              </div>` : ''}
              
              <div style="background:#e8f4f8; padding:8px; border-radius:6px; margin-bottom:10px;">
                <div style="font-size:11px; color:#17a2b8; font-weight:600;">ğŸ‘¤ Kaydeden: ${k.personelAdi || k.personeladi || k.personel || k.kaydedenPersonel || k.kaydedenpersonel || 'Bilinmiyor'}</div>
              </div>
              
              ${updateInfo}
              ${(() => {
                const talep = duzenlemeTalepleri.find(t => (t.kayitid || t.kayitId) === k.id && t.kayittipi === 'teberru');
                if (talep) {
                  if (talep.durum === 'reddedildi') {
                    return `<div style="background:#f8d7da; padding:8px; border-radius:6px; border-left:3px solid #dc3545; margin-top:8px;">
                      <div style="font-size:11px; color:#721c24; font-weight:600;">âŒ DÃ¼zenleme talebi reddedildi</div>
                      ${talep.redaciklama ? `<div style="font-size:10px; color:#721c24; margin-top:4px;">Sebep: ${escapeHtml(talep.redaciklama)}</div>` : ''}
                    </div>`;
                  } else if (talep.durum === 'onaylandi') {
                    return '<div style="background:#d4edda; padding:8px; border-radius:6px; border-left:3px solid #28a745; margin-top:8px;"><div style="font-size:11px; color:#155724; font-weight:600;">âœ… DÃ¼zenleme talebi onaylandÄ±</div></div>';
                  } else {
                    return '<div style="background:#d1ecf1; padding:8px; border-radius:6px; border-left:3px solid #17a2b8; margin-top:8px;"><div style="font-size:11px; color:#17a2b8; font-weight:600;">ğŸ“‹ DÃ¼zenleme talep edildi (Beklemede)</div></div>';
                  }
                }
                return '';
              })()}${(() => {
                const talep = duzenlemeTalepleri.find(t => (t.kayitid || t.kayitId) === k.id && t.kayittipi === 'teberru');
                if (talep) {
                  if (talep.durum === 'reddedildi') {
                    return `<div style="background:#f8d7da; padding:8px; border-radius:6px; border-left:3px solid #dc3545; margin-top:8px;">
                      <div style="font-size:11px; color:#721c24; font-weight:600;">âŒ DÃ¼zenleme talebi reddedildi</div>
                      ${talep.redaciklama ? `<div style="font-size:10px; color:#721c24; margin-top:4px;">Sebep: ${escapeHtml(talep.redaciklama)}</div>` : ''}
                    </div>`;
                  } else if (talep.durum === 'onaylandi') {
                    return '<div style="background:#d4edda; padding:8px; border-radius:6px; border-left:3px solid #28a745; margin-top:8px;"><div style="font-size:11px; color:#155724; font-weight:600;">âœ… DÃ¼zenleme talebi onaylandÄ±</div></div>';
                  } else {
                    return '<div style="background:#d1ecf1; padding:8px; border-radius:6px; border-left:3px solid #17a2b8; margin-top:8px;"><div style="font-size:11px; color:#17a2b8; font-weight:600;">ğŸ“‹ DÃ¼zenleme talep edildi (Beklemede)</div></div>';
                  }
                }
                return '';
              })()}
            </div>
            <div style="display:flex; gap:8px; align-items:center; margin-top:12px; justify-content:flex-end; padding-top:12px; border-top:1px solid #f0f0f0;">
              <button onclick="editTeberruRecord('${k.id}')" style="background:var(--primary); color:white; border:none; padding:10px 16px; border-radius:8px; font-size:13px; cursor:pointer; font-weight:600; box-shadow:0 2px 6px rgba(0,0,0,0.1);">âœï¸ DÃ¼zenle</button>
            </div>
          `;
          container.appendChild(card);
        } else if (k.kayitTipi === 'imported') {
          // IMPORTED VERÄ°LER (YÃ¶netimden girilen)
          let kDate;
          if (k.tarih) {
            if (k.tarih.toDate) kDate = k.tarih.toDate();
            else if (k.tarih.seconds) kDate = new Date(k.tarih.seconds * 1000);
            else kDate = new Date(k.tarih);
          } else {
            kDate = new Date();
          }

          const tipStr = (k.tip || '').toLowerCase();
          let tipIcon = 'ğŸ“„';
          let tipTitle = 'DiÄŸer';
          let tipColor = '#95a5a6';

          if (tipStr.includes('iftar')) { tipIcon = 'ğŸŒ™'; tipTitle = 'Ä°ftar'; tipColor = 'var(--accent)'; }
          else if (tipStr.includes('sahur')) { tipIcon = 'ğŸŒŸ'; tipTitle = 'Sahur'; tipColor = '#3498db'; }
          else if (tipStr.includes('taahhut') || tipStr.includes('taahhÃ¼t')) { tipIcon = 'ğŸ“‹'; tipTitle = 'TaahhÃ¼t'; tipColor = '#3498db'; }
          else if (tipStr.includes('teberru')) { tipIcon = 'ğŸ’°'; tipTitle = 'Teberru'; tipColor = '#27ae60'; }

          const card = document.createElement('div');
          card.className = 'day-card';
          card.style.marginBottom = '12px';
          card.style.flexDirection = 'column';
          card.style.alignItems = 'stretch';
          card.style.borderLeft = `5px solid ${tipColor}`;

          card.innerHTML = `
             <div style="flex:1;">
              <div style="display:flex; align-items:center; gap:8px; margin-bottom:10px; padding-bottom:8px; border-bottom:2px solid #f0f0f0;">
                <div style="font-size:20px;">${tipIcon}</div>
                <div style="flex:1;">
                  <div style="font-size:11px; color:#95a5a6; margin-bottom:3px; font-weight:500; text-transform:uppercase; letter-spacing:0.5px;">${kDate.toLocaleDateString('tr-TR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}</div>
                  <div style="font-size:16px; font-weight:700; color:${tipColor};">${tipTitle} (YÃ¶netim)</div>
                </div>
              </div>
              
              <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px;">
                <div style="background:#f8f9fa; padding:10px; border-radius:8px;">
                  <div style="font-size:11px; color:#7f8c8d; margin-bottom:4px; font-weight:500;">Sahip</div>
                  <div style="font-size:15px; font-weight:700; color:#2c3e50;">${k.sahip || 'Bilinmiyor'}</div>
                </div>
                <div style="background:#f8f9fa; padding:10px; border-radius:8px;">
                  <div style="font-size:11px; color:#7f8c8d; margin-bottom:4px; font-weight:500;">Tutar</div>
                  <div style="font-size:15px; font-weight:700; color:#27ae60;">â‚º${(k.tutar || 0).toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
                </div>
              </div>
              
              ${k.diger ? `<div style="background:#fff3cd; padding:10px; border-radius:8px; border-left:3px solid #ffc107; margin-bottom:10px;">
                <div style="font-size:11px; color:#856404; margin-bottom:4px; font-weight:600;">ğŸ“ DiÄŸer</div>
                <div style="font-size:13px; color:#856404; line-height:1.5;">${k.diger}</div>
              </div>` : ''}
              
              <div style="background:#e8f4f8; padding:8px; border-radius:6px; margin-bottom:10px;">
                <div style="font-size:11px; color:#17a2b8; font-weight:600;">ğŸ‘¤ Kaydeden: YÃ¶netim (${k.yukleyen || 'Admin'})</div>
              </div>
              
              <div style="font-size:10px; color:#95a5a6; font-style:italic;">Bu kayÄ±t yÃ¶netim paneli Ã¼zerinden eklenmiÅŸtir. DÃ¼zenlemek iÃ§in yÃ¶netim ile iletiÅŸime geÃ§iniz.</div>
            </div>
           `;
          container.appendChild(card);
        }
      });
      } finally {
        isLoadingMyRecords = false;
      }
    }

    // DÃ¼zenleme talep fonksiyonlarÄ±
    // KayÄ±t tipine gÃ¶re dÃ¼zenleme seÃ§eneklerini gÃ¶ster/gizle
    function toggleEditRequestOptions(kayitTipi) {
      const chips = qs('#editRequestModal').querySelectorAll('.chip');
      chips.forEach(chip => {
        const text = chip.textContent;
        if (kayitTipi === 'iftar-sahur') {
          // Ä°ftar-sahur iÃ§in tÃ¼m seÃ§enekler gÃ¶rÃ¼nÃ¼r
          chip.style.display = 'flex';
        } else if (kayitTipi === 'teberru' || kayitTipi === 'taahhut') {
          // Teberru ve taahhÃ¼t iÃ§in sadece "DÃ¼zenle" gÃ¶rÃ¼nÃ¼r
          if (text.includes('DÃ¼zenle')) {
            chip.style.display = 'flex';
          } else {
            chip.style.display = 'none';
          }
        }
      });
    }

    function editMyRecord(recordId) {
      const kayit = kayitlar.find(k => k.id === recordId);
      const kayitPersonelUid = kayit.personelUid || kayit.personeluid;
      if (!kayit || kayitPersonelUid !== currentUser.id) {
        showAlert('Bu kaydÄ± dÃ¼zenleme yetkiniz yok', 'error');
        return;
      }

      const kDate = kayit.tarih.toDate ? kayit.tarih.toDate() : new Date(kayit.tarih);
      const tipLabel = kayit.tip === 'iftar' ? 'ğŸŒ™ Ä°ftar' : 'ğŸŒŸ Sahur';
      const mahalId = kayit.mahalId || kayit.mahalid;
      const mahalAdi = mahalId ? (mahaller.find(m => m.id === mahalId)?.adi || 'Mahal') : null;

      qs('#editRequestRecordId').value = recordId;
      qs('#editRequestKayitTipi').value = 'iftar-sahur';
      qs('#editRequestDateDisplay').innerHTML = `
        <strong>${tipLabel}</strong><br>
        ${kDate.toLocaleDateString('tr-TR', { dateStyle: 'full' })}<br>
        <small style="color:#7f8c8d;">${kayit.sahip} - ${kayit.musafirAdedi || kayit.musafiradedi || 0} mÃ¼safir</small>
        ${mahalAdi ? `<br><small style="color:#7f8c8d;">ğŸ›ï¸ ${mahalAdi}</small>` : ''}
      `;
      qs('#editRequestType').value = 'duzenle';
      qs('#editRequestAciklama').value = '';
      qs('#editRequestNewDate').value = '';
      qs('#editRequestNewMahal').value = '';
      qs('#editRequestNewMahalOnly').value = '';
      qs('#editRequestNewMusafir').value = '0';
      qs('#editRequestMusafirVal').innerText = '0';
      qs('#editRequestDateSelect').style.display = 'none';
      qs('#editRequestMahalSelect').style.display = 'none';
      qs('#editRequestMusafirSelect').style.display = 'none';
      qs('#editRequestMahalWarning').style.display = 'none';
      qs('#editRequestMahalOnlyWarning').style.display = 'none';
      qs('#editRequestMusafirWarning').style.display = 'none';

      // Chip seÃ§imlerini sÄ±fÄ±rla
      qs('#editRequestModal').querySelectorAll('.chip').forEach(c => c.classList.remove('selected'));
      qs('#editRequestModal').querySelector('.chip').classList.add('selected');

      // SeÃ§enekleri gÃ¶ster/gizle
      toggleEditRequestOptions('iftar-sahur');

      qs('#editRequestModal').classList.add('open');
    }

    function closeEditRequestModal() {
      qs('#editRequestModal').classList.remove('open');
      qs('#editRequestForm').reset();
      qs('#editRequestDateSelect').style.display = 'none';
      qs('#editRequestMahalSelect').style.display = 'none';
      qs('#editRequestMusafirSelect').style.display = 'none';
      qs('#editRequestMahalWarning').style.display = 'none';
      qs('#editRequestMahalOnlyWarning').style.display = 'none';
      qs('#editRequestMusafirWarning').style.display = 'none';
      qs('#editRequestNewMahal').value = '';
      qs('#editRequestNewMahalOnly').value = '';
      qs('#editRequestNewMusafir').value = '0';
      qs('#editRequestMusafirVal').innerText = '0';
    }

    function selectEditRequestType(type, element) {
      // Teberru ve taahhÃ¼t iÃ§in sadece "duzenle" seÃ§eneÄŸi geÃ§erli
      const kayitTipi = qs('#editRequestKayitTipi').value;
      if ((kayitTipi === 'teberru' || kayitTipi === 'taahhut') && type !== 'duzenle') {
        showAlert('Teberru ve taahhÃ¼t kayÄ±tlarÄ± iÃ§in sadece dÃ¼zenleme talebi gÃ¶nderilebilir', 'error');
        return;
      }

      qs('#editRequestType').value = type;
      qs('#editRequestModal').querySelectorAll('.chip').forEach(c => c.classList.remove('selected'));
      element.classList.add('selected');

      const recordId = qs('#editRequestRecordId').value;
      if (!recordId) {
        console.error('Record ID bulunamadÄ±');
        return;
      }
      
      // KayÄ±t tipine gÃ¶re doÄŸru kayÄ±t listesinden bul
      let kayit = null;
      if (kayitTipi === 'iftar-sahur') {
        kayit = kayitlar.find(k => k.id === recordId);
      } else if (kayitTipi === 'teberru') {
        kayit = teberruKayitlari.find(t => t.id === recordId);
      } else if (kayitTipi === 'taahhut') {
        kayit = taahhutKayitlari.find(t => t.id === recordId);
      }
      
      if (!kayit) {
        console.error('KayÄ±t bulunamadÄ±:', recordId, kayitTipi);
        showAlert('KayÄ±t bulunamadÄ±. LÃ¼tfen sayfayÄ± yenileyin.', 'error');
        return;
      }

      if (type === 'yer_degistir') {
        qs('#editRequestDateSelect').style.display = 'block';
        qs('#editRequestMahalSelect').style.display = 'none';
        // Mevcut tarihi varsayÄ±lan olarak ayarla
        if (kayit) {
          const kDate = kayit.tarih.toDate ? kayit.tarih.toDate() : new Date(kayit.tarih);
          qs('#editRequestNewDate').value = kDate.toISOString().slice(0, 10);
        }
        renderEditRequestMahaller('editRequestMahalChips', 'editRequestNewMahal', kayit);
        checkNewDateMahal();
      } else if (type === 'mahal_degistir') {
        qs('#editRequestDateSelect').style.display = 'none';
        qs('#editRequestMahalSelect').style.display = 'block';
        qs('#editRequestMusafirSelect').style.display = 'none';
        qs('#editRequestMahalWarning').style.display = 'none';
        renderEditRequestMahaller('editRequestMahalOnlyChips', 'editRequestNewMahalOnly', kayit);
        checkNewMahalOnly();
      } else if (type === 'musafir_degistir') {
        qs('#editRequestDateSelect').style.display = 'none';
        qs('#editRequestMahalSelect').style.display = 'none';
        qs('#editRequestMusafirSelect').style.display = 'block';
        qs('#editRequestMusafirMahalWrap').style.display = 'none';
        qs('#editRequestNewMahalForMusafir').value = '';
        qs('#editRequestMahalWarning').style.display = 'none';
        qs('#editRequestMahalOnlyWarning').style.display = 'none';
        qs('#editRequestMusafirWarning').style.display = 'none';
        // Mevcut mÃ¼safir adedini ayarla
        if (kayit) {
          const mevcutMusafir = kayit.musafirAdedi ?? kayit.musafiradedi ?? 0;
          qs('#editRequestNewMusafir').value = mevcutMusafir;
          qs('#editRequestMusafirVal').innerText = mevcutMusafir;
        }
        checkNewMusafir();
      } else {
        qs('#editRequestDateSelect').style.display = 'none';
        qs('#editRequestMahalSelect').style.display = 'none';
        qs('#editRequestMusafirSelect').style.display = 'none';
        qs('#editRequestMahalWarning').style.display = 'none';
        qs('#editRequestMahalOnlyWarning').style.display = 'none';
        qs('#editRequestMusafirWarning').style.display = 'none';
      }
    }

    // Mahal render fonksiyonu (dÃ¼zenleme iÃ§in). options: { overrideMusafir, overrideIstirak } (mÃ¼safir deÄŸiÅŸtir - iÅŸtirak noâ†’yes)
    function renderEditRequestMahaller(containerId, inputId, kayit, options) {
      const container = qs(`#${containerId}`);
      if (!container) return;
      const overrideMusafir = options?.overrideMusafir;
      const overrideIstirak = options?.overrideIstirak;
      
      // EÄŸer kayÄ±t yoksa, recordId'den bul
      if (!kayit) {
        const recordId = qs('#editRequestRecordId')?.value;
        const kayitTipi = qs('#editRequestKayitTipi')?.value;
        if (recordId && kayitTipi) {
          if (kayitTipi === 'iftar-sahur') {
            kayit = kayitlar.find(k => k.id === recordId);
          } else if (kayitTipi === 'teberru') {
            kayit = teberruKayitlari.find(t => t.id === recordId);
          } else if (kayitTipi === 'taahhut') {
            kayit = taahhutKayitlari.find(t => t.id === recordId);
          }
        }
      }
      
      if (!kayit) {
        console.error('KayÄ±t bulunamadÄ± renderEditRequestMahaller iÃ§in');
        return;
      }

      const musafirAdedi = (overrideMusafir !== undefined ? overrideMusafir : (kayit.musafirAdedi ?? kayit.musafiradedi ?? 0));
      const istirakEffective = overrideIstirak !== undefined ? overrideIstirak : (kayit.istirak === true);
      // SORUN 1 FIX: Tarih formatÄ±nÄ± YYYY-MM-DD'ye sabitle
      let tarihStr = '';
      if (containerId === 'editRequestMahalChips') {
        // Yer deÄŸiÅŸtir modu - yeni tarih varsa onu kullan, yoksa mevcut tarih
        const newDateInput = qs('#editRequestNewDate');
        if (newDateInput?.value) {
          tarihStr = newDateInput.value.includes('T') ? newDateInput.value.split('T')[0] : newDateInput.value.slice(0, 10);
        } else {
          // Mevcut tarihi normalize et
          if (kayit.tarih?.toDate) {
            tarihStr = kayit.tarih.toDate().toISOString().slice(0, 10);
          } else if (typeof kayit.tarih === 'string') {
            tarihStr = kayit.tarih.includes('T') ? kayit.tarih.split('T')[0] : kayit.tarih.slice(0, 10);
          } else {
            tarihStr = new Date(kayit.tarih).toISOString().slice(0, 10);
          }
        }
      } else {
        // Mahal deÄŸiÅŸtir veya mÃ¼safir mahal - mevcut tarih
        if (kayit.tarih?.toDate) {
          tarihStr = kayit.tarih.toDate().toISOString().slice(0, 10);
        } else if (typeof kayit.tarih === 'string') {
          tarihStr = kayit.tarih.includes('T') ? kayit.tarih.split('T')[0] : kayit.tarih.slice(0, 10);
        } else {
          tarihStr = new Date(kayit.tarih).toISOString().slice(0, 10);
        }
      }
      const tip = kayit.tip;
      const istirak = istirakEffective;

      container.innerHTML = '';

      if (mahaller.length === 0) {
        container.innerHTML = '<div class="chip" style="opacity:0.5;">Mahal bulunamadÄ±</div>';
        return;
      }

      mahaller.forEach(m => {
        const minMusafir = m.minMusafir || 1;
        const maxMusafir = m.maxMusafir || 9999;
        const uyumlu = musafirAdedi >= minMusafir && musafirAdedi <= maxMusafir;

        // Mevcut mahali seÃ§ili gÃ¶ster
        const isCurrentMahal = m.id === kayit.mahalId;

        // Mahal kontrolÃ¼
        let mahalDolu = false;
        if (uyumlu && istirak && tarihStr) {
          const mahalCheck = checkMahalAvailability(tarihStr, tip, m.id, kayit.id);
          mahalDolu = !mahalCheck.allowed;
        }

        const chip = document.createElement('div');
        chip.className = `chip ${uyumlu && !mahalDolu ? '' : 'disabled'} ${isCurrentMahal ? 'selected' : ''}`;
        chip.style.opacity = (uyumlu && !mahalDolu) ? '1' : '0.5';
        chip.style.cursor = (uyumlu && !mahalDolu) ? 'pointer' : 'not-allowed';

        if (mahalDolu) {
          chip.style.background = '#ffebee';
          chip.style.borderColor = '#f44336';
          chip.title = `${tip === 'iftar' ? 'Ä°ftar' : 'Sahur'} iÃ§in ${tarihStr} tarihinde bu mahal zaten dolu!`;
        } else if (!uyumlu) {
          chip.title = `Bu mahal iÃ§in mÃ¼safir sayÄ±sÄ± ${minMusafir}-${maxMusafir} arasÄ±nda olmalÄ±dÄ±r`;
        } else if (isCurrentMahal) {
          chip.title = 'Mevcut mahal';
        }

        // SORUN 2 FIX: Chip tÄ±klandÄ±ÄŸÄ±nda kontrol fonksiyonlarÄ±nÄ± tetikle
        if (uyumlu && !mahalDolu) {
          chip.onclick = () => {
            container.querySelectorAll('.chip').forEach(c => c.classList.remove('selected'));
            chip.classList.add('selected');
            qs(`#${inputId}`).value = m.id;
            
            // SORUN 2 FIX: DeÄŸer atandÄ±ktan hemen sonra kontrol fonksiyonlarÄ±nÄ± manuel olarak Ã§aÄŸÄ±r
            setTimeout(() => {
              if (containerId === 'editRequestMahalChips') {
                checkNewDateMahal();
              } else if (containerId === 'editRequestMahalOnlyChips') {
                checkNewMahalOnly();
              }
              // editRequestMusafirMahalChips: checkNewMusafir Ã§aÄŸÄ±rma - re-render seÃ§imi siler
            }, 10);
          };
        }

        chip.innerHTML = `
          ${m.adi}
          ${isCurrentMahal ? '<span style="font-size:10px; margin-left:5px; color:var(--primary);">(Mevcut)</span>' : ''}
          ${!uyumlu ? `<span style="font-size:10px; margin-left:5px; color:#999;">(${minMusafir}-${maxMusafir})</span>` : ''}
          ${mahalDolu ? `<span style="font-size:10px; margin-left:5px; color:#f44336;">(Dolu)</span>` : ''}
        `;

        container.appendChild(chip);
      });

      // Mevcut mahali seÃ§ili olarak ayarla
      if (kayit.mahalId) {
        qs(`#${inputId}`).value = kayit.mahalId;
      }
    }

    function checkNewDateMahal() {
      const recordId = qs('#editRequestRecordId').value;
      const kayitTipi = qs('#editRequestKayitTipi')?.value || 'iftar-sahur';
      
      // HATA 2 FIX: DoÄŸru kayÄ±t listesinden bul
      let kayit = null;
      if (kayitTipi === 'iftar-sahur') {
        kayit = kayitlar.find(k => k.id === recordId);
      } else if (kayitTipi === 'teberru') {
        kayit = teberruKayitlari.find(t => t.id === recordId);
      } else if (kayitTipi === 'taahhut') {
        kayit = taahhutKayitlari.find(t => t.id === recordId);
      }
      
      if (!kayit || kayit.istirak !== true) {
        qs('#editRequestMahalWarning').style.display = 'none';
        return;
      }

      const newDateStr = qs('#editRequestNewDate').value;
      if (!newDateStr) {
        qs('#editRequestMahalWarning').style.display = 'none';
        return;
      }

      // SORUN 1 FIX: Tarih formatÄ±nÄ± YYYY-MM-DD'ye normalize et
      const normalizedDateStr = newDateStr.includes('T') ? newDateStr.split('T')[0] : newDateStr.slice(0, 10);
      
      const kayitMahalId = kayit.mahalId ?? kayit.mahalid;
      const newMahalId = qs('#editRequestNewMahal').value || kayitMahalId;

      // SORUN 1 FIX: Normalize edilmiÅŸ tarih ile kontrol et
      
      // EÄŸer mahal deÄŸiÅŸmemiÅŸse, mevcut mahali kontrol et
      if (newMahalId === kayitMahalId) {
        const mahalCheck = checkMahalAvailability(normalizedDateStr, kayit.tip, kayitMahalId, recordId);
        if (!mahalCheck.allowed) {
          qs('#editRequestMahalWarningText').textContent = mahalCheck.message + ' Ä°sterseniz mahal deÄŸiÅŸikliÄŸi yapÄ±p bu tarihe geÃ§ebilirsiniz.';
          qs('#editRequestMahalWarning').style.display = 'block';
        } else {
          qs('#editRequestMahalWarning').style.display = 'none';
        }
      } else {
        // Yeni mahal seÃ§ilmiÅŸse kontrol et
        const mahalCheck = checkMahalAvailability(normalizedDateStr, kayit.tip, newMahalId, recordId);
        if (!mahalCheck.allowed) {
          qs('#editRequestMahalWarningText').textContent = mahalCheck.message;
          qs('#editRequestMahalWarning').style.display = 'block';
        } else {
          qs('#editRequestMahalWarning').style.display = 'none';
        }
      }
    }

    function checkNewMahalOnly() {
      const recordId = qs('#editRequestRecordId').value;
      const kayitTipi = qs('#editRequestKayitTipi')?.value || 'iftar-sahur';
      
      // HATA 2 FIX: DoÄŸru kayÄ±t listesinden bul
      let kayit = null;
      if (kayitTipi === 'iftar-sahur') {
        kayit = kayitlar.find(k => k.id === recordId);
      } else if (kayitTipi === 'teberru') {
        kayit = teberruKayitlari.find(t => t.id === recordId);
      } else if (kayitTipi === 'taahhut') {
        kayit = taahhutKayitlari.find(t => t.id === recordId);
      }
      
      if (!kayit || kayit.istirak !== true) {
        // Ä°ÅŸtirak etmeyecekse uyarÄ± gÃ¶sterme
        qs('#editRequestMahalOnlyWarning').style.display = 'none';
        return;
      }

      const newMahalId = qs('#editRequestNewMahalOnly').value;
      if (!newMahalId) {
        // Mahal seÃ§ilmemiÅŸse uyarÄ± gÃ¶sterme
        qs('#editRequestMahalOnlyWarning').style.display = 'none';
        return;
      }

      // EÄŸer mahal deÄŸiÅŸmemiÅŸse uyarÄ± gÃ¶sterme
      if (newMahalId === kayit.mahalId) {
        qs('#editRequestMahalOnlyWarning').style.display = 'none';
        return;
      }

      // Mahal kontrolÃ¼ (hem ekleme hem deÄŸiÅŸtirme iÃ§in)
      const tarihStr = kayit.tarih.toDate ? kayit.tarih.toDate().toISOString().slice(0, 10) : kayit.tarih;
      const mahalCheck = checkMahalAvailability(tarihStr, kayit.tip, newMahalId, recordId);
      if (!mahalCheck.allowed) {
        qs('#editRequestMahalOnlyWarningText').textContent = mahalCheck.message;
        qs('#editRequestMahalOnlyWarning').style.display = 'block';
      } else {
        qs('#editRequestMahalOnlyWarning').style.display = 'none';
      }
    }

    qs('#editRequestNewDate').addEventListener('change', () => {
      const recordId = qs('#editRequestRecordId').value;
      const kayitTipi = qs('#editRequestKayitTipi')?.value || 'iftar-sahur';
      
      // HATA 2 FIX: DoÄŸru kayÄ±t listesinden bul
      let kayit = null;
      if (kayitTipi === 'iftar-sahur') {
        kayit = kayitlar.find(k => k.id === recordId);
      } else if (kayitTipi === 'teberru') {
        kayit = teberruKayitlari.find(t => t.id === recordId);
      } else if (kayitTipi === 'taahhut') {
        kayit = taahhutKayitlari.find(t => t.id === recordId);
      }
      
      if (kayit) {
        renderEditRequestMahaller('editRequestMahalChips', 'editRequestNewMahal', kayit);
      }
      checkNewDateMahal();
    });

    function stepEditGuest(n) {
      let v = parseInt(qs('#editGuest').value) + n;
      if (v < 0) v = 0;
      qs('#editGuest').value = v;
      qs('#editGuestVal').innerText = v;
    }

    function stepEditMusafir(n) {
      let v = parseInt(qs('#editRequestNewMusafir').value) + n;
      if (v < 0) v = 0;
      qs('#editRequestNewMusafir').value = v;
      qs('#editRequestMusafirVal').innerText = v;
      checkNewMusafir();
    }

    function checkNewMusafir() {
      const recordId = qs('#editRequestRecordId').value;
      const kayitTipi = qs('#editRequestKayitTipi')?.value || 'iftar-sahur';
      
      // HATA 2 FIX: DoÄŸru kayÄ±t listesinden bul
      let kayit = null;
      if (kayitTipi === 'iftar-sahur') {
        kayit = kayitlar.find(k => k.id === recordId);
      } else if (kayitTipi === 'teberru') {
        kayit = teberruKayitlari.find(t => t.id === recordId);
      } else if (kayitTipi === 'taahhut') {
        kayit = taahhutKayitlari.find(t => t.id === recordId);
      }
      
      if (!kayit) {
        qs('#editRequestMusafirWarning').style.display = 'none';
        return;
      }

      const newMusafirAdedi = parseInt(qs('#editRequestNewMusafir').value) || 0;
      const eskiMusafirAdedi = kayit.musafirAdedi || 0;
      const eskiIstirak = kayit.istirak === true;
      const yeniIstirak = newMusafirAdedi > 0;
      const istirakDegisti = eskiIstirak !== yeniIstirak;

      if (newMusafirAdedi === eskiMusafirAdedi && !istirakDegisti) {
        qs('#editRequestMusafirWarning').style.display = 'none';
        return;
      }

      let warningText = '';
      let hasWarning = false;

      // Ä°ÅŸtirak durumu deÄŸiÅŸikliÄŸi uyarÄ±sÄ±
      if (istirakDegisti) {
        if (yeniIstirak && kayitTipi === 'iftar-sahur') {
          warningText = `â„¹ï¸ MÃ¼safir adedi ${newMusafirAdedi} yapÄ±ldÄ±ÄŸÄ± iÃ§in kayÄ±t otomatik olarak "Ä°ÅŸtirak edecek" olarak deÄŸiÅŸtirilecek. Mahal seÃ§meniz gerekmektedir.`;
          // Ä°ÅŸtirak noâ†’yes: mahal seÃ§imi gÃ¶ster (sadece iftar-sahur)
          qs('#editRequestMusafirMahalWrap').style.display = 'block';
          renderEditRequestMahaller('editRequestMusafirMahalChips', 'editRequestNewMahalForMusafir', kayit, {
            overrideMusafir: newMusafirAdedi,
            overrideIstirak: true
          });
        } else if (yeniIstirak && kayitTipi !== 'iftar-sahur') {
          warningText = `â„¹ï¸ MÃ¼safir adedi ${newMusafirAdedi} yapÄ±ldÄ±ÄŸÄ± iÃ§in kayÄ±t "Ä°ÅŸtirak edecek" olarak deÄŸiÅŸtirilecek.`;
          qs('#editRequestMusafirMahalWrap').style.display = 'none';
        } else {
          warningText = `â„¹ï¸ MÃ¼safir adedi 0 yapÄ±ldÄ±ÄŸÄ± iÃ§in kayÄ±t otomatik olarak "Ä°ÅŸtirak etmeyecek" olarak deÄŸiÅŸtirilecek ve mahal kaldÄ±rÄ±lacak.`;
          qs('#editRequestMusafirMahalWrap').style.display = 'none';
          qs('#editRequestNewMahalForMusafir').value = '';
        }
        hasWarning = true;
      } else {
        qs('#editRequestMusafirMahalWrap').style.display = 'none';
        qs('#editRequestNewMahalForMusafir').value = '';
      }

      // Mahal uyumluluÄŸu kontrolÃ¼ (sadece iÅŸtirak edecekse)
      if (yeniIstirak && kayit.mahalId) {
        const mahal = mahaller.find(m => m.id === kayit.mahalId);
        if (mahal) {
          const minMusafir = mahal.minMusafir || 1;
          const maxMusafir = mahal.maxMusafir || 9999;
          if (newMusafirAdedi < minMusafir || newMusafirAdedi > maxMusafir) {
            const mahalWarning = `âš ï¸ SeÃ§ilen mahal (${mahal.adi}) iÃ§in mÃ¼safir sayÄ±sÄ± ${minMusafir}-${maxMusafir} arasÄ±nda olmalÄ±dÄ±r. Mahal uyumsuz olduÄŸu iÃ§in kaldÄ±rÄ±lacak.`;
            warningText = warningText ? warningText + ' ' + mahalWarning : mahalWarning;
            hasWarning = true;
          }
        }
      }

      if (hasWarning) {
        qs('#editRequestMusafirWarningText').innerHTML = warningText;
        qs('#editRequestMusafirWarning').style.display = 'block';
      } else {
        qs('#editRequestMusafirWarning').style.display = 'none';
      }
    }

    qs('#editRequestForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const recordId = qs('#editRequestRecordId').value;
      const kayitTipi = qs('#editRequestKayitTipi').value;
      const talepTipi = qs('#editRequestType').value;
      const aciklama = qs('#editRequestAciklama').value.trim();

      if (!aciklama) {
        showAlert('LÃ¼tfen aÃ§Ä±klama giriniz', 'error');
        return;
      }

      const btn = e.target.querySelector('button[type="submit"]');
      btn.disabled = true;
      btn.innerText = 'Ä°ÅŸleniyor...';

      try {
        // HATA 1 FIX: kayit deÄŸiÅŸkenini burada tekrar buluyoruz
        let kayit = null;
        if (kayitTipi === 'iftar-sahur') {
          kayit = kayitlar.find(k => k.id === recordId);
        } else if (kayitTipi === 'teberru') {
          kayit = teberruKayitlari.find(t => t.id === recordId);
        } else if (kayitTipi === 'taahhut') {
          kayit = taahhutKayitlari.find(t => t.id === recordId);
        }
        
        if (!kayit) {
          showAlert('KayÄ±t bulunamadÄ±. LÃ¼tfen sayfayÄ± yenileyin.', 'error');
          btn.disabled = false;
          btn.innerText = 'Kaydet ve Kapat';
          return;
        }

        if (kayit.personelUid !== currentUser.id && kayit.personeluid !== currentUser.id) {
          showAlert('Bu kaydÄ± dÃ¼zenleme yetkiniz yok', 'error');
          btn.disabled = false;
          btn.innerText = 'Kaydet ve Kapat';
          return;
        }

        const yeniAciklama = qs('#editRequestAciklama').value.trim();
        const talepTipi = qs('#editRequestType').value;

        // GeÃ§miÅŸ ve bugÃ¼n iÃ§in sil, mahal deÄŸiÅŸtir, mÃ¼safir deÄŸiÅŸtir engeli (iftar-sahur)
        if (kayitTipi === 'iftar-sahur' && (talepTipi === 'sil' || talepTipi === 'mahal_degistir' || talepTipi === 'musafir_degistir')) {
          let kayitTarihStr = '';
          if (kayit.tarih) {
            let d;
            if (kayit.tarih.toDate) d = kayit.tarih.toDate();
            else if (typeof kayit.tarih === 'string') d = new Date(kayit.tarih);
            else d = new Date(kayit.tarih);
            kayitTarihStr = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
          }
          if (kayitTarihStr && isDatePastOrToday(kayitTarihStr)) {
            showAlert('Bu tarih iÃ§in kayÄ±t dÃ¼zenlenemez veya silinemez. GeÃ§miÅŸ, bugÃ¼n ve yarÄ±n (saat 17:30 sonrasÄ±) iÃ§in iÅŸlem yapÄ±lamaz.', 'error');
            btn.disabled = false;
            btn.innerText = 'Kaydet ve Kapat';
            return;
          }
        }

        // Duzenleme talebi verisi - ÅŸema: kayitid, kayittipi, taleptipi, personeladi, yenitarih, mahalid, createdat, updatedat
        // NOT: personeluid kolonu yok, sadece personeladi var (sqleditor.md'ye gÃ¶re)
        const talepData = {
          kayitid: recordId,
          kayittipi: kayitTipi,
          taleptipi: talepTipi,
          aciklama: yeniAciklama,
          personeladi: currentPersonelAdi || 'Bilinmiyor',
          durum: 'beklemede',
          yil: CURRENT_YIL,
          createdat: new Date().toISOString(),
          updatedat: new Date().toISOString()
        };

        if (talepTipi === 'sil') {
          // SORUN 3 FIX: Silme iÅŸleminden Ã¶nce arÅŸive kaydet - ÅŸemaya uygun format
          const tarihObj = kayit.tarih?.toDate ? kayit.tarih.toDate() : new Date(kayit.tarih);
          const mahalAdi = kayit.mahalId ? (mahaller.find(m => m.id === (kayit.mahalId ?? kayit.mahalid))?.adi || null) : null;
          
          // Silme bilgisini notlar alanÄ±na ekle
          const mevcutNotlar = kayit.notlar ?? kayit.not ?? '';
          const silmeNotu = `[SÄ°LÄ°NDÄ° - ${new Date().toLocaleString('tr-TR')}] Silen: ${currentPersonelAdi || 'Bilinmiyor'} (${currentUser.id}). Sebep: ${aciklama || 'Belirtilmedi'}. Orijinal ID: ${recordId}`;
          const yeniNotlar = mevcutNotlar ? `${mevcutNotlar} | ${silmeNotu}` : silmeNotu;
          
          const arsivData = {
            id: generateUUID(),
            yil: kayit.yil ?? CURRENT_YIL,
            tip: kayit.tip,
            sahip: kayit.sahip,
            tutar: kayit.tutar,
            istirak: kayit.istirak,
            musafiradedi: kayit.musafirAdedi ?? kayit.musafiradedi ?? 0,
            mahalid: kayit.mahalId ?? kayit.mahalid ?? null,
            mahal: mahalAdi,
            personel: kayit.personel,
            personeladi: kayit.personelAdi ?? kayit.personeladi,
            personeluid: kayit.personelUid ?? kayit.personeluid,
            kaydedenpersonel: kayit.personel,
            kaydedenpersoneluid: kayit.personelUid ?? kayit.personeluid,
            notlar: yeniNotlar,
            tarih: tarihObj.toISOString(),
            createdat: new Date().toISOString(),
            updatedat: new Date().toISOString(),
            arsiv_tarihi: new Date().toISOString()
          };
          
          // VERÄ° GÃœVENLÄ°ÄÄ°: Ã–nce ArÅŸivle, Sonra Sil + Rollback MekanizmasÄ±
          let arsivId = null;
          
          try {
            // 1. ArÅŸivleme iÅŸlemi
            const { data: insertData, error: insertError } = await window.supabase.from('ramazan_arsiv').insert(arsivData).select('id').single();
            if (insertError) {
              console.error('ArÅŸiv insert hatasÄ±:', insertError);
              showToast('error', 'ArÅŸivleme HatasÄ±', 
                `ArÅŸivleme hatasÄ±: ${insertError.message}. KayÄ±t silinemedi.`,
                { important: true }
              );
              btn.disabled = false;
              btn.innerText = 'Kaydet ve Kapat';
              return;
            }
            
            arsivId = insertData?.id || arsivData.id;
            
            // 2. Orijinal kaydÄ± sil
            const { error: deleteError } = await window.supabase.from('ramazan_kayitlari').delete().eq('id', recordId);
            if (deleteError) {
              console.error('Silme hatasÄ±:', deleteError);
              
              // ROLLBACK: ArÅŸivden eklenen kaydÄ± geri sil
              if (arsivId) {
                try {
                  await window.supabase.from('ramazan_arsiv').delete().eq('id', arsivId);
                  console.log('Rollback baÅŸarÄ±lÄ±: ArÅŸiv kaydÄ± geri alÄ±ndÄ±');
                } catch (rollbackError) {
                  console.error('Rollback hatasÄ±:', rollbackError);
                  showToast('error', 'Kritik Hata', 
                    'KayÄ±t silinemedi ve arÅŸiv rollback iÅŸlemi baÅŸarÄ±sÄ±z oldu. LÃ¼tfen yÃ¶neticiye bildirin.',
                    { important: true, duration: 10000 }
                  );
                }
              }
              
              throw new Error(`Silme hatasÄ±: ${deleteError.message}. ArÅŸiv kaydÄ± geri alÄ±ndÄ±.`);
            }
          } catch (arsivError) {
            console.error('ArÅŸiv/Silme hatasÄ±:', arsivError);
            showToast('error', 'Ä°ÅŸlem HatasÄ±', 
              arsivError.message || 'KayÄ±t arÅŸivlenemedi veya silinemedi. Silme iÅŸlemi iptal edildi.',
              { important: true }
            );
            btn.disabled = false;
            btn.innerText = 'Kaydet ve Kapat';
            return;
          }

          showAlert('KayÄ±t baÅŸarÄ±yla silindi ve arÅŸivlendi!', 'success');
          loadMyRecords();
          closeEditRequestModal();
          return;

        } else if (talepTipi === 'yer_degistir') {
          const newDateStr = qs('#editRequestNewDate').value;
          const newMahalId = qs('#editRequestNewMahal').value;
          if (!newDateStr || !newMahalId) {
            showAlert('LÃ¼tfen tarih ve mahal seÃ§iniz', 'error');
            btn.disabled = false;
            btn.innerText = 'Kaydet ve Kapat';
            return;
          }
          if (isDatePastOrToday(newDateStr)) {
            showAlert('Bu tarih iÃ§in kayÄ±t yapÄ±lamaz. GeÃ§miÅŸ, bugÃ¼n ve yarÄ±n (saat 17:30 sonrasÄ±) iÃ§in iÅŸlem yapÄ±lamaz.', 'error');
            btn.disabled = false;
            btn.innerText = 'Kaydet ve Kapat';
            return;
          }

          let yeniTarih;
          // Tarih parse
          if (typeof newDateStr === 'string') {
            yeniTarih = new Date(newDateStr);
          } else {
            yeniTarih = new Date();
          }

          const kapasiteCheck = await checkMahalAvailability(yeniTarih.toISOString().slice(0, 10), kayit.tip, newMahalId);

          if (!kapasiteCheck.allowed) {
            talepData.yenitarih = yeniTarih.toISOString();
            talepData.mahalid = newMahalId;

            await window.supabase.from('duzenleme_talepleri').insert(talepData);
            closeEditRequestModal();
            showAlert('Kontenjan dolu olduÄŸu iÃ§in dÃ¼zenleme talebi oluÅŸturuldu. YÃ¶netici onayÄ± bekleniyor.', 'warning');
            loadMyRecords();
            return;
          } else {
            // HATA 3 FIX: DÃ¼zenleme notlarÄ±nÄ± ekle
            let mevcutNot = kayit.notlar || kayit.not || '';
            const yeniTarihIso = yeniTarih.toISOString();
            
            const eskiTarihStr = kayit.tarih?.toDate ? kayit.tarih.toDate().toISOString().slice(0, 10) : new Date(kayit.tarih).toISOString().slice(0, 10);
            const eskiMahalAdi = kayit.mahalId ? (mahaller.find(m => m.id === kayit.mahalId)?.adi || kayit.mahalId) : 'Yok';
            const yeniMahalAdi = mahaller.find(m => m.id === newMahalId)?.adi || newMahalId;
            
            const degisiklikNotu = `[${new Date().toLocaleString('tr-TR')}] ${currentPersonelAdi || 'Bilinmiyor'}: Tarih ${eskiTarihStr} â†’ ${newDateStr}, Mahal ${eskiMahalAdi} â†’ ${yeniMahalAdi}. AÃ§Ä±klama: ${yeniAciklama}`;
            mevcutNot = mevcutNot ? `${mevcutNot} | ${degisiklikNotu}` : degisiklikNotu;

            const upData = {
              tarih: yeniTarihIso,
              mahalid: newMahalId,
              notlar: mevcutNot,
              updatedat: new Date().toISOString()
            };

            const { error: updateError } = await window.supabase.from('ramazan_kayitlari').update(upData).eq('id', recordId);
            if (updateError) {
              console.error('GÃ¼ncelleme hatasÄ±:', updateError);
              throw updateError;
            }
            
            closeEditRequestModal();
            showAlert('KayÄ±t gÃ¼ncellendi!', 'success');
            await loadKayitlar();
            return;
          }

        } else if (talepTipi === 'mahal_degistir') {
          const newMahalId = qs('#editRequestNewMahalOnly').value;
          if (!newMahalId) { showAlert('LÃ¼tfen mahal seÃ§iniz', 'error'); btn.disabled = false; btn.innerText = 'Kaydet ve Kapat'; return; }

          let kDateStr;
          if (kayit.tarih && kayit.tarih.toDate) {
            kDateStr = kayit.tarih.toDate().toISOString().slice(0, 10);
          } else {
            kDateStr = new Date(kayit.tarih).toISOString().slice(0, 10);
          }

          const check = await checkMahalAvailability(kDateStr, kayit.tip, newMahalId);
          if (!check.allowed) {
            talepData.mahalid = newMahalId;
            await window.supabase.from('duzenleme_talepleri').insert(talepData);
            closeEditRequestModal();
            showAlert('Kontenjan dolu/uygun olmadÄ±ÄŸÄ± iÃ§in talep oluÅŸturuldu.', 'warning');
            loadMyRecords();
            return;
          } else {
            // HATA 3 FIX: DÃ¼zenleme notlarÄ±nÄ± ekle
            let mevcutNot = kayit.notlar || kayit.not || '';
            const eskiMahalAdi = kayit.mahalId ? (mahaller.find(m => m.id === kayit.mahalId)?.adi || kayit.mahalId) : 'Yok';
            const yeniMahalAdi = mahaller.find(m => m.id === newMahalId)?.adi || newMahalId;
            
            const degisiklikNotu = `[${new Date().toLocaleString('tr-TR')}] ${currentPersonelAdi || 'Bilinmiyor'}: Mahal ${eskiMahalAdi} â†’ ${yeniMahalAdi}. AÃ§Ä±klama: ${yeniAciklama}`;
            mevcutNot = mevcutNot ? `${mevcutNot} | ${degisiklikNotu}` : degisiklikNotu;
            
            const { error: updateError } = await window.supabase.from('ramazan_kayitlari').update({
              mahalid: newMahalId,
              notlar: mevcutNot,
              updatedat: new Date().toISOString()
            }).eq('id', recordId);
            
            if (updateError) {
              console.error('GÃ¼ncelleme hatasÄ±:', updateError);
              throw updateError;
            }
            
            closeEditRequestModal();
            showAlert('Mahal gÃ¼ncellendi!', 'success');
            await loadKayitlar();
            return;
          }

        } else if (talepTipi === 'musafir_degistir') {
          const yeniMusafir = parseInt(qs('#editRequestNewMusafir').value) || 0;
          const eskiIstirak = kayit.istirak === true;
          const yeniIstirak = yeniMusafir > 0;
          const istirakDegisti = eskiIstirak !== yeniIstirak;

          // Ä°ÅŸtirak noâ†’yes (iftar-sahur): mahal seÃ§imi zorunlu
          if (istirakDegisti && yeniIstirak && kayitTipi === 'iftar-sahur') {
            const newMahalId = qs('#editRequestNewMahalForMusafir')?.value || '';
            if (!newMahalId) {
              showAlert('Ä°ÅŸtirak edecek ÅŸekilde deÄŸiÅŸtirmek iÃ§in lÃ¼tfen mahal seÃ§iniz.', 'error');
              btn.disabled = false;
              btn.innerText = 'Kaydet ve Kapat';
              return;
            }
          }

          const fark = yeniMusafir - (kayit.musafirAdedi ?? kayit.musafiradedi ?? 0);
          let mahalOk = true;
          let mahalToCheck = kayit.mahalId ?? kayit.mahalid;
          if (istirakDegisti && yeniIstirak) {
            mahalToCheck = qs('#editRequestNewMahalForMusafir')?.value || null;
          } else if (kayit.mahalId && fark > 0) {
            mahalToCheck = kayit.mahalId;
          }
          if (mahalToCheck && (fark > 0 || (istirakDegisti && yeniIstirak))) {
            let kDateStr;
            if (kayit.tarih && kayit.tarih.toDate) {
              kDateStr = kayit.tarih.toDate().toISOString().slice(0, 10);
            } else {
              kDateStr = new Date(kayit.tarih).toISOString().slice(0, 10);
            }
            const check = await checkMahalAvailability(kDateStr, kayit.tip, mahalToCheck, kayit.id);
            if (!check.allowed) mahalOk = false;
          }

          if (!mahalOk) {
            // MÃ¼safir adedi deÄŸiÅŸikliÄŸi iÃ§in talep oluÅŸturuluyor
            await window.supabase.from('duzenleme_talepleri').insert(talepData);
            closeEditRequestModal();
            showAlert('Kapasite yetersiz olduÄŸu iÃ§in talep oluÅŸturuldu.', 'warning');
            loadMyRecords();
            return;
          } else {
            // HATA 3 FIX: DÃ¼zenleme notlarÄ±nÄ± ekle
            let mevcutNot = kayit.notlar || kayit.not || '';
            const eskiMusafir = kayit.musafirAdedi ?? kayit.musafiradedi ?? 0;
            let mahalKaldirildi = false;
            
            const m = mahaller.find(m => m.id === kayit.mahalId);
            if (m) {
              if (yeniMusafir < (m.minMusafir || 0) || yeniMusafir > (m.maxMusafir || 9999)) {
                mahalKaldirildi = true;
                const degisiklikNotu = `[${new Date().toLocaleString('tr-TR')}] ${currentPersonelAdi || 'Bilinmiyor'}: MÃ¼safir ${eskiMusafir} â†’ ${yeniMusafir}, Mahal kaldÄ±rÄ±ldÄ± (${m.adi} - kriter dÄ±ÅŸÄ±). AÃ§Ä±klama: ${yeniAciklama}`;
                mevcutNot = mevcutNot ? `${mevcutNot} | ${degisiklikNotu}` : degisiklikNotu;
                
                const mahalNullUp = {
                  musafiradedi: yeniMusafir,
                  mahalid: null,
                  mahal: null,
                  notlar: mevcutNot,
                  updatedat: new Date().toISOString()
                };
                if (yeniMusafir === 0) mahalNullUp.istirak = false;
                const { error: updateError } = await window.supabase.from('ramazan_kayitlari').update(mahalNullUp).eq('id', recordId);
                
                if (updateError) {
                  console.error('GÃ¼ncelleme hatasÄ±:', updateError);
                  throw updateError;
                }
                
                closeEditRequestModal();
                showAlert('MÃ¼safir sayÄ±sÄ± gÃ¼ncellendi (Mahal kriterlerine uymadÄ±ÄŸÄ± iÃ§in mahalden Ã§Ä±karÄ±ldÄ±).', 'success');
                await loadKayitlar();
                return;
              }
            }

            if (!mahalKaldirildi) {
              const degisiklikNotu = `[${new Date().toLocaleString('tr-TR')}] ${currentPersonelAdi || 'Bilinmiyor'}: MÃ¼safir ${eskiMusafir} â†’ ${yeniMusafir}. AÃ§Ä±klama: ${yeniAciklama}`;
              mevcutNot = mevcutNot ? `${mevcutNot} | ${degisiklikNotu}` : degisiklikNotu;
              
              const upData = {
                musafiradedi: yeniMusafir,
                notlar: mevcutNot,
                updatedat: new Date().toISOString()
              };
              if (istirakDegisti && yeniIstirak) {
                const newMahalId = qs('#editRequestNewMahalForMusafir')?.value || null;
                const mahalAdi = newMahalId ? (mahaller.find(m => m.id === newMahalId)?.adi || null) : null;
                upData.istirak = true;
                upData.mahalid = newMahalId;
                upData.mahal = mahalAdi;
              }
              const { error: updateError } = await window.supabase.from('ramazan_kayitlari').update(upData).eq('id', recordId);
              
              if (updateError) {
                console.error('GÃ¼ncelleme hatasÄ±:', updateError);
                throw updateError;
              }
              
              closeEditRequestModal();
              showAlert('MÃ¼safir sayÄ±sÄ± gÃ¼ncellendi!', 'success');
              await loadKayitlar();
              return;
            }
          }
        } else {
          // Genel dÃ¼zenleme (duzenle) - sadece talep oluÅŸtur
          // HATA 3 FIX: DÃ¼zenleme talebi oluÅŸtur, direkt gÃ¼ncelleme yapma
          await window.supabase.from('duzenleme_talepleri').insert(talepData);
          closeEditRequestModal();
          showAlert('DÃ¼zenleme talebi gÃ¶nderildi. YÃ¶netici onayÄ± bekleniyor.', 'success');
          loadMyRecords();
        }
      } catch (err) {
        showAlert('Hata: ' + err.message, 'error');
      } finally {
        const btn = qs('#editRequestForm button[type="submit"]');
        if (btn) {
          btn.disabled = false;
          btn.innerText = 'Kaydet ve Kapat';
        }
      }
    });

    async function deleteMyRecord(recordId) {
      const kayit = kayitlar.find(k => k.id === recordId);
      const kayitPersonelUid = kayit?.personelUid ?? kayit?.personeluid;
      if (!kayit || kayitPersonelUid !== currentUser.id) {
        showAlert('Bu kaydÄ± silme yetkiniz yok', 'error');
        return;
      }
      // GeÃ§miÅŸ ve bugÃ¼n iÃ§in silme engeli
      let kayitTarihStr = '';
      if (kayit.tarih) {
        let d;
        if (kayit.tarih.toDate) d = kayit.tarih.toDate();
        else if (typeof kayit.tarih === 'string') d = new Date(kayit.tarih);
        else d = new Date(kayit.tarih);
        kayitTarihStr = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
      }
      if (kayitTarihStr && isDatePastOrToday(kayitTarihStr)) {
        showAlert('Bu tarihe ait kayÄ±tlar silinemez. GeÃ§miÅŸ, bugÃ¼n ve yarÄ±n (saat 17:30 sonrasÄ±) iÃ§in silme yapÄ±lamaz. DÃ¼zenleme talep formundan talep oluÅŸturabilirsiniz.', 'error');
        return;
      }

      showConfirm('Bu kaydÄ± silmek istediÄŸinizden emin misiniz? Bu iÅŸlem geri alÄ±namaz!', async () => {
        try {
          // SORUN 3 FIX: Silme iÅŸleminden Ã¶nce arÅŸive kaydet - ÅŸemaya uygun format
          const tarihObj = kayit.tarih?.toDate ? kayit.tarih.toDate() : new Date(kayit.tarih);
          const mahalAdi = kayit.mahalId ? (mahaller.find(m => m.id === (kayit.mahalId ?? kayit.mahalid))?.adi || null) : null;
          
          // Silme bilgisini notlar alanÄ±na ekle
          const mevcutNotlar = kayit.notlar ?? kayit.not ?? '';
          const silmeNotu = `[SÄ°LÄ°NDÄ° - ${new Date().toLocaleString('tr-TR')}] Silen: ${currentPersonelAdi || 'Bilinmiyor'} (${currentUser.id}). Sebep: KullanÄ±cÄ± tarafÄ±ndan direkt silindi. Orijinal ID: ${recordId}`;
          const yeniNotlar = mevcutNotlar ? `${mevcutNotlar} | ${silmeNotu}` : silmeNotu;
          
          const arsivData = {
            id: generateUUID(),
            yil: kayit.yil ?? CURRENT_YIL,
            tip: kayit.tip,
            sahip: kayit.sahip,
            tutar: kayit.tutar,
            istirak: kayit.istirak,
            musafiradedi: kayit.musafirAdedi ?? kayit.musafiradedi ?? 0,
            mahalid: kayit.mahalId ?? kayit.mahalid ?? null,
            mahal: mahalAdi,
            personel: kayit.personel,
            personeladi: kayit.personelAdi ?? kayit.personeladi,
            personeluid: kayit.personelUid ?? kayit.personeluid,
            kaydedenpersonel: kayit.personel,
            kaydedenpersoneluid: kayit.personelUid ?? kayit.personeluid,
            notlar: yeniNotlar,
            tarih: tarihObj.toISOString(),
            createdat: new Date().toISOString(),
            updatedat: new Date().toISOString(),
            arsiv_tarihi: new Date().toISOString(),
            silme_sebebi: 'KullanÄ±cÄ± tarafÄ±ndan direkt silindi',
            silen_kisi: currentPersonelAdi || 'Bilinmiyor',
            silenpersoneluid: currentUser.id,
            silenpersoneladi: currentPersonelAdi || 'Bilinmiyor'
          };
          
          // VERÄ° GÃœVENLÄ°ÄÄ°: Ã–nce ArÅŸivle, Sonra Sil + Rollback MekanizmasÄ±
          let arsivId = null;
          
          try {
            // 1. ArÅŸivleme iÅŸlemi
            const { data: insertData, error: insertError } = await window.supabase.from('ramazan_arsiv').insert(arsivData).select('id').single();
            if (insertError) {
              console.error('ArÅŸiv insert hatasÄ±:', insertError);
              showToast('error', 'ArÅŸivleme HatasÄ±', 
                `ArÅŸivleme hatasÄ±: ${insertError.message}. KayÄ±t silinemedi.`,
                { important: true }
              );
              return;
            }
            
            arsivId = insertData?.id || arsivData.id;
            
            // 2. Orijinal kaydÄ± sil
            const { error: deleteError } = await window.supabase.from('ramazan_kayitlari').delete().eq('id', recordId);
            if (deleteError) {
              console.error('Silme hatasÄ±:', deleteError);
              
              // ROLLBACK: ArÅŸivden eklenen kaydÄ± geri sil
              if (arsivId) {
                try {
                  await window.supabase.from('ramazan_arsiv').delete().eq('id', arsivId);
                  console.log('Rollback baÅŸarÄ±lÄ±: ArÅŸiv kaydÄ± geri alÄ±ndÄ±');
                  showToast('warning', 'Rollback YapÄ±ldÄ±', 
                    'KayÄ±t silinemedi. ArÅŸiv kaydÄ± geri alÄ±ndÄ±.',
                    { important: true }
                  );
                } catch (rollbackError) {
                  console.error('Rollback hatasÄ±:', rollbackError);
                  showToast('error', 'Kritik Hata', 
                    'KayÄ±t silinemedi ve arÅŸiv rollback iÅŸlemi baÅŸarÄ±sÄ±z oldu. LÃ¼tfen yÃ¶neticiye bildirin.',
                    { important: true, duration: 10000 }
                  );
                }
              }
              
              throw new Error(`Silme hatasÄ±: ${deleteError.message}. ArÅŸiv kaydÄ± geri alÄ±ndÄ±.`);
            }
          } catch (arsivError) {
            console.error('ArÅŸiv/Silme hatasÄ±:', arsivError);
            showToast('error', 'Ä°ÅŸlem HatasÄ±', 
              arsivError.message || 'KayÄ±t arÅŸivlenemedi veya silinemedi. Silme iÅŸlemi iptal edildi.',
              { important: true }
            );
            return;
          }

          showAlert('KayÄ±t baÅŸarÄ±yla silindi ve arÅŸivlendi!', 'success');
          loadMyRecords();
        } catch (err) {
          console.error('Silme hatasÄ±:', err);
          showAlert('Hata: ' + (err.message || 'KayÄ±t silinirken bir sorun oluÅŸtu'), 'error');
        }
      });
    }

    window.editMyRecord = editMyRecord;
    window.deleteMyRecord = deleteMyRecord;
    window.selectEditRequestType = selectEditRequestType;
    window.closeEditRequestModal = closeEditRequestModal;
    window.openFormModalFromDay = openFormModalFromDay;
    window.closeInfoModal = closeInfoModal;
    window.showInfoModalFromPopup = showInfoModalFromPopup;
    window.closeInfoPopup = closeInfoPopup;
    window.closeUpdateModal = closeUpdateModal;
    window.stepEditMusafir = stepEditMusafir;

    // Teberru fonksiyonlarÄ±
    // Global eriÅŸim iÃ§in window'a baÄŸla
    function openTeberruModal() {
      qs('#teberruForm').reset();
      qs('#teberruForm').removeAttribute('data-edit-id');
      qs('#teberruOdeme').value = '';
      qs('#teberruModal').querySelectorAll('.chip').forEach(c => c.classList.remove('selected'));
      clearTeberruErrors();
      qs('#teberruModal').classList.add('open');
    }

    function closeTeberruModal() {
      qs('#teberruModal').classList.remove('open');
    }

    function clearTeberruErrors() {
      qs('#teberruBagisciError').style.display = 'none';
      qs('#teberruMiktarError').style.display = 'none';
      qs('#teberruOdemeError').style.display = 'none';
      qs('#teberruBagisci').style.borderColor = '';
      qs('#teberruMiktar').style.borderColor = '';
    }

    function showTeberruPreview() {
      clearTeberruErrors();
      let hasError = false;

      const bagisci = qs('#teberruBagisci').value.trim();
      const miktar = parseFloat(qs('#teberruMiktar').value);
      const odeme = qs('#teberruOdeme').value;
      const aciklama = qs('#teberruAciklama').value.trim();

      if (!bagisci) {
        qs('#teberruBagisciError').textContent = 'BaÄŸÄ±ÅŸÃ§Ä± adÄ± zorunludur';
        qs('#teberruBagisciError').style.display = 'block';
        qs('#teberruBagisci').style.borderColor = 'var(--danger)';
        hasError = true;
      }

      if (!miktar || miktar <= 0) {
        qs('#teberruMiktarError').textContent = 'GeÃ§erli bir miktar giriniz';
        qs('#teberruMiktarError').style.display = 'block';
        qs('#teberruMiktar').style.borderColor = 'var(--danger)';
        hasError = true;
      }

      if (!odeme) {
        qs('#teberruOdemeError').textContent = 'Ã–deme yÃ¶ntemi seÃ§iniz';
        qs('#teberruOdemeError').style.display = 'block';
        hasError = true;
      }

      if (hasError) {
        return;
      }

      const odemeLabels = {
        'nakit': 'ğŸ’µ Nakit',
        'banka': 'ğŸ¦ Banka',
        'pos': 'ğŸ’³ POS',
        'sanal': 'ğŸ“± Sanal'
      };

      const content = qs('#teberruPreviewContent');
      content.innerHTML = `
        <div style="margin-bottom:10px;"><strong>BaÄŸÄ±ÅŸÃ§Ä±:</strong> ${bagisci}</div>
        <div style="margin-bottom:10px;"><strong>Miktar:</strong> ${miktar.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} â‚º</div>
        <div style="margin-bottom:10px;"><strong>Ã–deme YÃ¶ntemi:</strong> ${odemeLabels[odeme] || odeme}</div>
        ${aciklama ? `<div style="margin-bottom:10px;"><strong>AÃ§Ä±klama:</strong> ${aciklama}</div>` : ''}
        <div style="margin-top:15px; padding-top:15px; border-top:1px solid #eee; font-size:12px; color:#7f8c8d;">
          ${isImpersonating ? `<div><strong>Kimin adÄ±na:</strong> ${currentPersonelAdi || 'Bilinmiyor'}</div>` : ''}
          <div><strong>Kaydeden:</strong> ${originalPersonelAdi || currentPersonelAdi || 'Bilinmiyor'}</div>
          <div><strong>Tarih:</strong> ${new Date().toLocaleString('tr-TR')}</div>
        </div>
      `;
      qs('#teberruPreviewModal').classList.add('open');
      qs('#teberruModal').classList.remove('open');
    }

    function closeTeberruPreviewModal() {
      qs('#teberruPreviewModal').classList.remove('open');
      qs('#teberruModal').classList.add('open');
    }

    // Global eriÅŸim iÃ§in window'a baÄŸla
    async function saveTeberru() {
      const bagisci = qs('#teberruBagisci').value.trim();
      const miktar = parseFloat(qs('#teberruMiktar').value);
      const odeme = qs('#teberruOdeme').value;
      const aciklama = qs('#teberruAciklama').value.trim();
      const editId = qs('#teberruForm').getAttribute('data-edit-id');

      try {
        let personelAdi = currentPersonelAdi;
        if (!personelAdi || personelAdi === 'Bilinmiyor') {
          if (currentUser) {
            const userMeta = await window.supabase.from('kullanicilar').select('adsoyad').eq('id', currentUser.id).single();
            if (userMeta.data) personelAdi = userMeta.data.adsoyad || userMeta.data.adSoyad;
            else personelAdi = currentUser.email || 'Bilinmiyor';
          } else {
            personelAdi = 'Bilinmiyor';
          }
        }

        const yilNum = CURRENT_YIL ? (typeof CURRENT_YIL === 'number' ? CURRENT_YIL : parseInt(CURRENT_YIL)) : new Date().getFullYear();
        const nowISO = new Date().toISOString();
        const ayNum = new Date().getMonth() + 1;
        // IMPERSONATION: KayÄ±t kimin adÄ±na yapÄ±lÄ±yor?
        // personeluid/personel: Impersonation modunda seÃ§ilen kullanÄ±cÄ±, normal modda mevcut kullanÄ±cÄ±
        // kaydedenpersonel/kaydedenpersoneluid: Her zaman orijinal (auth) kullanÄ±cÄ±
        const targetPersonelUid = isImpersonating ? impersonatedUserId : currentUser.id;
        const targetPersonelAdi = currentPersonelAdi; // Impersonation modunda bu zaten seÃ§ilen kullanÄ±cÄ±nÄ±n adÄ±
        const kaydedenPersonelAdi = originalPersonelAdi || personelAdi;
        const kaydedenPersonelUid = currentUser.id; // Auth kullanÄ±cÄ±sÄ± her zaman

        const data = {
          id: generateUUID(),
          bagisci: bagisci,
          miktar: miktar,
          odemeyontemi: odeme,
          odeme: odeme || null,
          aciklama: aciklama || null,
          not: null,
          ay: ayNum,
          tarih: nowISO,
          personeluid: targetPersonelUid,
          personel: targetPersonelAdi,
          kaydedenpersonel: kaydedenPersonelAdi,
          kaydedenpersoneluid: kaydedenPersonelUid,
          yil: yilNum
        };

        if (editId) {
          // DÃ¼zenleme: tarih/ay deÄŸiÅŸmesin, sadece gÃ¼ncellenen alanlar
          delete data.id;
          delete data.tarih;
          delete data.ay;
          data.updatedat = new Date().toISOString();
          await window.supabase.from('teberru_kayitlari').update(data).eq('id', editId);
          showAlert('Teberru kaydÄ± baÅŸarÄ±yla gÃ¼ncellendi!', 'success');
          qs('#teberruForm').removeAttribute('data-edit-id');
        } else {
          // Yeni kayÄ±t
          data.createdat = nowISO;
          await window.supabase.from('teberru_kayitlari').insert(data);
          showAlert('Teberru kaydÄ± baÅŸarÄ±yla eklendi!', 'success');
          // Muhasebe uyarÄ±sÄ± toast'Ä± gÃ¶ster
          setTimeout(() => {
            showMuhasebeWarningToast('teberru');
          }, 500);
        }

        closeTeberruPreviewModal();
        closeTeberruModal();
        qs('#teberruForm').reset();
        loadMyRecords();
        // Tahsilat detay tablosunu yenile
        loadTahsilatDetayTablosu();
      } catch (err) {
        showAlert('Hata: ' + err.message, 'error');
      }
    }

    // Tahsilat Detay Tablosu Fonksiyonu
    async function loadTahsilatDetayTablosu() {
      const loadingEl = qs('#tahsilatDetayLoading');
      const contentEl = qs('#tahsilatDetayContent');
      const tbodyEl = qs('#tahsilatDetayTbody');
      const tfootEl = qs('#tahsilatDetayTfoot');
      const hedefIcerikEl = qs('#tahsilatHedefIcerik');

      if (!loadingEl || !contentEl || !tbodyEl || !tfootEl || !hedefIcerikEl) return;

      loadingEl.style.display = 'block';
      contentEl.style.display = 'none';

      try {
        if (!currentUser && !currentPersonelAdi) {
          throw new Error('KullanÄ±cÄ± bilgisi bulunamadÄ±');
        }

        const yilNum = typeof selectedYear !== 'undefined' ? selectedYear : new Date().getFullYear();

        // IMPERSONATION KONTROLÃœ: BaÅŸka kullanÄ±cÄ± gÃ¶rÃ¼ntÃ¼leniyorsa sadece o kullanÄ±cÄ±nÄ±n verilerini Ã§ek
        const targetUserId = isImpersonating ? impersonatedUserId : currentUser?.id;
        const targetUserName = currentPersonelAdi;

        // 1. Ä°ftar ve Sahur kayÄ±tlarÄ±nÄ± Ã§ek (hedef kullanÄ±cÄ±ya ait)
        let iftarSahurKayitlar = [];
        if (targetUserId) {
          const { data: uidData } = await window.supabase
            .from('ramazan_kayitlari')
            .select('id, tip, tutar, personeluid, kaydedenpersoneluid')
            .eq('yil', yilNum)
            .or(`personeluid.eq.${targetUserId},kaydedenpersoneluid.eq.${targetUserId}`);
          if (uidData) iftarSahurKayitlar.push(...uidData);
        }
        if (targetUserName) {
          const normalizedName = normalizePersonelName(targetUserName);
          const { data: nameData } = await window.supabase
            .from('ramazan_kayitlari')
            .select('id, tip, tutar, personeladi, kaydedenpersonel')
            .eq('yil', yilNum);
          if (nameData) {
            const filtered = nameData.filter(d => {
              const p1 = normalizePersonelName(d.personeladi || '');
              const p2 = normalizePersonelName(d.kaydedenpersonel || '');
              return (p1 === normalizedName || p2 === normalizedName) && 
                     !iftarSahurKayitlar.some(k => k.id === d.id);
            });
            iftarSahurKayitlar.push(...filtered);
          }
        }

        // Ä°ftar ve Sahur tutarlarÄ±nÄ± hesapla
        let iftarTutar = 0, sahurTutar = 0;
        const iftarKayitIds = [], sahurKayitIds = [];
        iftarSahurKayitlar.forEach(k => {
          if (k.tip === 'iftar') {
            iftarTutar += Number(k.tutar) || 0;
            iftarKayitIds.push(k.id);
          } else if (k.tip === 'sahur') {
            sahurTutar += Number(k.tutar) || 0;
            sahurKayitIds.push(k.id);
          }
        });

        // 2. TaahhÃ¼t kayÄ±tlarÄ±nÄ± Ã§ek - Ã¶nce yÃ¼kle sonra kullan
        await loadTaahhutKayitlari();
        let taahhutTutar = 0;
        const taahhutKayitIds = [];
        if (taahhutKayitlari && taahhutKayitlari.length > 0) {
          taahhutKayitlari.forEach(t => {
            taahhutTutar += Number(t.miktar) || 0;
            taahhutKayitIds.push(t.id);
          });
        }

        // 3. Tahsilat verilerini Ã§ek
        const allKayitIds = [...iftarKayitIds, ...sahurKayitIds, ...taahhutKayitIds];
        let tahsilatByKayitId = {};
        allKayitIds.forEach(id => { tahsilatByKayitId[id] = 0; });

        if (allKayitIds.length > 0 && window.supabase) {
          const { data: tahsilatData } = await window.supabase
            .from('ramazan_tahsilat')
            .select('kayit_id, tutar')
            .in('kayit_id', allKayitIds);
          (tahsilatData || []).forEach(t => {
            tahsilatByKayitId[t.kayit_id] = (tahsilatByKayitId[t.kayit_id] || 0) + (Number(t.tutar) || 0);
          });
        }

        // Tahsilat toplamlarÄ±nÄ± hesapla
        let iftarTahsilat = 0, sahurTahsilat = 0, taahhutTahsilat = 0;
        iftarKayitIds.forEach(id => { iftarTahsilat += tahsilatByKayitId[id] || 0; });
        sahurKayitIds.forEach(id => { sahurTahsilat += tahsilatByKayitId[id] || 0; });
        taahhutKayitIds.forEach(id => { taahhutTahsilat += tahsilatByKayitId[id] || 0; });

        // Hesaplamalar
        const iftarKalan = iftarTutar - iftarTahsilat;
        const sahurKalan = sahurTutar - sahurTahsilat;
        const taahhutKalan = taahhutTutar - taahhutTahsilat;

        const iftarYuzde = iftarTutar > 0 ? ((iftarTahsilat / iftarTutar) * 100).toFixed(1) : 0;
        const sahurYuzde = sahurTutar > 0 ? ((sahurTahsilat / sahurTutar) * 100).toFixed(1) : 0;
        const taahhutYuzde = taahhutTutar > 0 ? ((taahhutTahsilat / taahhutTutar) * 100).toFixed(1) : 0;

        const toplamTutar = iftarTutar + sahurTutar + taahhutTutar;
        const toplamTahsilat = iftarTahsilat + sahurTahsilat + taahhutTahsilat;
        const toplamKalan = toplamTutar - toplamTahsilat;
        const toplamYuzde = toplamTutar > 0 ? ((toplamTahsilat / toplamTutar) * 100).toFixed(1) : 0;

        // Format fonksiyonu
        const formatPara = (val) => val.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });

        // Tablo satÄ±rlarÄ±nÄ± oluÅŸtur
        const renderRow = (tip, icon, tutar, tahsilat, kalan, yuzde, color) => `
          <tr style="border-bottom:1px solid #e9ecef;">
            <td style="padding:12px 10px; font-weight:500;">
              <span style="display:inline-flex; align-items:center; gap:6px;">
                <span style="font-size:16px;">${icon}</span>
                <span style="color:${color};">${tip}</span>
              </span>
            </td>
            <td style="padding:12px 10px; text-align:right; color:#495057;">â‚º${formatPara(tutar)}</td>
            <td style="padding:12px 10px; text-align:right; color:#27ae60; font-weight:600;">â‚º${formatPara(tahsilat)}</td>
            <td style="padding:12px 10px; text-align:right; color:${kalan > 0 ? '#e74c3c' : '#27ae60'};">â‚º${formatPara(kalan)}</td>
            <td style="padding:12px 10px; text-align:right;">
              <span style="display:inline-block; padding:4px 8px; background:${parseFloat(yuzde) >= 50 ? '#e8f5e9' : '#fff3e0'}; color:${parseFloat(yuzde) >= 50 ? '#27ae60' : '#f57c00'}; border-radius:12px; font-size:12px; font-weight:600;">
                %${yuzde}
              </span>
            </td>
          </tr>
        `;

        tbodyEl.innerHTML = 
          renderRow('Ä°ftar', 'ğŸŒ™', iftarTutar, iftarTahsilat, iftarKalan, iftarYuzde, '#f39c12') +
          renderRow('Sahur', 'ğŸŒŸ', sahurTutar, sahurTahsilat, sahurKalan, sahurYuzde, '#3498db') +
          renderRow('TaahhÃ¼t', 'ğŸ“‹', taahhutTutar, taahhutTahsilat, taahhutKalan, taahhutYuzde, '#9b59b6');

        tfootEl.innerHTML = `
          <tr>
            <td style="padding:14px 10px; font-weight:700; color:#2c3e50;">
              <span style="display:inline-flex; align-items:center; gap:6px;">
                <span style="font-size:16px;">ğŸ“Š</span>
                TOPLAM
              </span>
            </td>
            <td style="padding:14px 10px; text-align:right; font-weight:700; color:#2c3e50;">â‚º${formatPara(toplamTutar)}</td>
            <td style="padding:14px 10px; text-align:right; font-weight:700; color:#27ae60;">â‚º${formatPara(toplamTahsilat)}</td>
            <td style="padding:14px 10px; text-align:right; font-weight:700; color:${toplamKalan > 0 ? '#e74c3c' : '#27ae60'};">â‚º${formatPara(toplamKalan)}</td>
            <td style="padding:14px 10px; text-align:right;">
              <span style="display:inline-block; padding:5px 12px; background:${parseFloat(toplamYuzde) >= 50 ? 'linear-gradient(135deg, #27ae60, #2ecc71)' : 'linear-gradient(135deg, #f57c00, #ff9800)'}; color:white; border-radius:15px; font-size:13px; font-weight:700;">
                %${toplamYuzde}
              </span>
            </td>
          </tr>
        `;

        // Hedef bilgisi
        const hedefYuzde50Tutar = toplamTutar * 0.5;
        const hedefKalan = hedefYuzde50Tutar - toplamTahsilat;
        const hedefDurum = toplamTahsilat >= hedefYuzde50Tutar;

        hedefIcerikEl.innerHTML = `
          <div style="margin-bottom:8px;">
            <strong>Ramazan-Ä± Åerif sonuna kadar tahsilat hedefiniz:</strong>
            <span style="color:#e65100; font-weight:700;">%50 = â‚º${formatPara(hedefYuzde50Tutar)}</span>
          </div>
          <div style="margin-bottom:8px;">
            <strong>Mevcut tahsilatÄ±nÄ±z:</strong>
            <span style="color:#27ae60; font-weight:700;">â‚º${formatPara(toplamTahsilat)}</span>
            <span style="margin-left:8px; padding:2px 8px; background:${parseFloat(toplamYuzde) >= 50 ? '#c8e6c9' : '#ffecb3'}; color:${parseFloat(toplamYuzde) >= 50 ? '#2e7d32' : '#e65100'}; border-radius:10px; font-size:12px; font-weight:600;">
              %${toplamYuzde}
            </span>
          </div>
          ${hedefDurum ? `
            <div style="padding:10px; background:#c8e6c9; border-radius:8px; color:#2e7d32; font-weight:600; margin-top:10px;">
              âœ… Tebrikler! Hedefinize ulaÅŸtÄ±nÄ±z. Hedefin Ã¼zerinde: <strong>â‚º${formatPara(toplamTahsilat - hedefYuzde50Tutar)}</strong>
            </div>
          ` : `
            <div style="padding:10px; background:#fff3e0; border-radius:8px; color:#e65100; font-weight:500; margin-top:10px;">
              â³ Hedefe ulaÅŸmanÄ±z iÃ§in kalan miktar: <strong style="color:#d84315;">â‚º${formatPara(hedefKalan)}</strong>
            </div>
          `}
        `;

        loadingEl.style.display = 'none';
        contentEl.style.display = 'block';

      } catch (err) {
        console.error('Tahsilat detay tablosu yÃ¼klenemedi:', err);
        loadingEl.innerHTML = `
          <div style="color:#e74c3c; font-size:14px;">
            <div style="font-size:24px; margin-bottom:10px;">âš ï¸</div>
            Veriler yÃ¼klenirken hata oluÅŸtu.<br>
            <small style="color:#999;">${err.message || ''}</small>
          </div>
        `;
      }
    }

    // TaahhÃ¼t fonksiyonlarÄ±
    // Global eriÅŸim iÃ§in window'a baÄŸla
    function openTaahhutModal() {
      qs('#taahhutForm').reset();
      qs('#taahhutForm').removeAttribute('data-edit-id');
      clearTaahhutErrors();
      qs('#taahhutModal').classList.add('open');
    }

    function closeTaahhutModal() {
      qs('#taahhutModal').classList.remove('open');
    }

    function clearTaahhutErrors() {
      qs('#taahhutBagisciError').style.display = 'none';
      qs('#taahhutMiktarError').style.display = 'none';
      qs('#taahhutBagisci').style.borderColor = '';
      qs('#taahhutMiktar').style.borderColor = '';
    }

    function showTaahhutPreview() {
      clearTaahhutErrors();
      let hasError = false;

      const bagisci = qs('#taahhutBagisci').value.trim();
      const miktar = parseFloat(qs('#taahhutMiktar').value);
      const aciklama = qs('#taahhutAciklama').value.trim();

      if (!bagisci) {
        qs('#taahhutBagisciError').textContent = 'BaÄŸÄ±ÅŸÃ§Ä± adÄ± zorunludur';
        qs('#taahhutBagisciError').style.display = 'block';
        qs('#taahhutBagisci').style.borderColor = 'var(--danger)';
        hasError = true;
      }

      if (!miktar || miktar <= 0) {
        qs('#taahhutMiktarError').textContent = 'GeÃ§erli bir miktar giriniz';
        qs('#taahhutMiktarError').style.display = 'block';
        qs('#taahhutMiktar').style.borderColor = 'var(--danger)';
        hasError = true;
      }

      if (hasError) {
        return;
      }

      const content = qs('#taahhutPreviewContent');
      content.innerHTML = `
        <div style="margin-bottom:10px;"><strong>BaÄŸÄ±ÅŸÃ§Ä±:</strong> ${bagisci}</div>
        <div style="margin-bottom:10px;"><strong>Miktar:</strong> ${miktar.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} â‚º</div>
        ${aciklama ? `<div style="margin-bottom:10px;"><strong>AÃ§Ä±klama:</strong> ${aciklama}</div>` : ''}
        <div style="margin-top:15px; padding-top:15px; border-top:1px solid #eee; font-size:12px; color:#7f8c8d;">
          ${isImpersonating ? `<div><strong>Kimin adÄ±na:</strong> ${currentPersonelAdi || 'Bilinmiyor'}</div>` : ''}
          <div><strong>Kaydeden:</strong> ${originalPersonelAdi || currentPersonelAdi || 'Bilinmiyor'}</div>
          <div><strong>Tarih:</strong> ${new Date().toLocaleString('tr-TR')}</div>
        </div>
      `;
      qs('#taahhutPreviewModal').classList.add('open');
      qs('#taahhutModal').classList.remove('open');
    }

    function closeTaahhutPreviewModal() {
      qs('#taahhutPreviewModal').classList.remove('open');
      qs('#taahhutModal').classList.add('open');
    }

    // Global eriÅŸim iÃ§in window'a baÄŸla
    async function saveTaahhut() {
      const bagisci = qs('#taahhutBagisci').value.trim();
      const miktar = parseFloat(qs('#taahhutMiktar').value);
      const aciklama = qs('#taahhutAciklama').value.trim();
      const editId = qs('#taahhutForm').getAttribute('data-edit-id');

      try {
        let personelAdi = currentPersonelAdi;
        if (!personelAdi || personelAdi === 'Bilinmiyor') {
          if (currentUser) {
            const userMeta = await window.supabase.from('kullanicilar').select('adsoyad').eq('id', currentUser.id).single();
            if (userMeta.data) personelAdi = userMeta.data.adsoyad || userMeta.data.adSoyad;
            else personelAdi = currentUser.email || 'Bilinmiyor';
          } else {
            personelAdi = 'Bilinmiyor';
          }
        }

        const yilNum = CURRENT_YIL ? (typeof CURRENT_YIL === 'number' ? CURRENT_YIL : parseInt(CURRENT_YIL)) : new Date().getFullYear();
        const nowISO = new Date().toISOString();
        const ayNum = new Date().getMonth() + 1;

        // IMPERSONATION: KayÄ±t kimin adÄ±na yapÄ±lÄ±yor?
        // personeluid/personel: Impersonation modunda seÃ§ilen kullanÄ±cÄ±, normal modda mevcut kullanÄ±cÄ±
        // kaydedenpersonel/kaydedenpersoneluid: Her zaman orijinal (auth) kullanÄ±cÄ±
        const targetPersonelUid = isImpersonating ? impersonatedUserId : currentUser.id;
        const targetPersonelAdi = currentPersonelAdi; // Impersonation modunda bu zaten seÃ§ilen kullanÄ±cÄ±nÄ±n adÄ±
        const kaydedenPersonelAdi = originalPersonelAdi || personelAdi;
        const kaydedenPersonelUid = currentUser.id; // Auth kullanÄ±cÄ±sÄ± her zaman

        // taahhut_kayitlari tablosunda personeladi yok, sadece personel var
        const data = {
          id: generateUUID(),
          bagisci: bagisci,
          miktar: miktar,
          aciklama: aciklama || null,
          not: null,
          ay: ayNum,
          tarih: nowISO,
          durum: null,
          silindi: false,
          personeluid: targetPersonelUid,
          personel: targetPersonelAdi,
          kaydedenpersonel: kaydedenPersonelAdi,
          kaydedenpersoneluid: kaydedenPersonelUid,
          yil: yilNum
        };

        if (editId) {
          delete data.id;
          delete data.tarih;
          delete data.ay;
          delete data.silindi;
          data.updatedat = new Date().toISOString();
          await window.supabase.from('taahhut_kayitlari').update(data).eq('id', editId);
          showAlert('TaahhÃ¼t kaydÄ± baÅŸarÄ±yla gÃ¼ncellendi!', 'success');
          qs('#taahhutForm').removeAttribute('data-edit-id');
        } else {
          data.createdat = nowISO;
          await window.supabase.from('taahhut_kayitlari').insert(data);
          showAlert('TaahhÃ¼t kaydÄ± baÅŸarÄ±yla eklendi!', 'success');
          // Muhasebe uyarÄ±sÄ± toast'Ä± gÃ¶ster
          setTimeout(() => {
            showMuhasebeWarningToast('taahhut');
          }, 500);
        }

        closeTaahhutPreviewModal();
        closeTaahhutModal();
        qs('#taahhutForm').reset();
        loadMyRecords();
        // Tahsilat detay tablosunu yenile
        loadTahsilatDetayTablosu();
      } catch (err) {
        showAlert('Hata: ' + err.message, 'error');
      }
    }

    // Teberru dÃ¼zenleme ve silme
    async function editTeberruRecord(recordId) {
      const kayit = teberruKayitlari.find(t => t.id === recordId);
      if (!kayit || (kayit.personelUid !== currentUser.id && kayit.personeluid !== currentUser.id)) {
        showAlert('Bu kaydÄ± dÃ¼zenleme yetkiniz yok', 'error');
        return;
      }

      // DÃ¼zenleme talep modalÄ±nÄ± aÃ§
      let kDate;
      if (kayit.createdAt) {
        kDate = new Date(kayit.createdAt);
      } else {
        kDate = new Date();
      }

      qs('#editRequestRecordId').value = recordId;
      qs('#editRequestKayitTipi').value = 'teberru';
      qs('#editRequestDateDisplay').innerHTML = `
        <strong>ğŸ’° Teberru</strong><br>
        ${kDate.toLocaleDateString('tr-TR', { dateStyle: 'full' })}<br>
        <small style="color:#7f8c8d;">${kayit.bagisci || 'Bilinmiyor'} - ${(kayit.miktar || 0).toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} â‚º</small>
      `;
      qs('#editRequestType').value = 'duzenle';
      qs('#editRequestAciklama').value = '';
      qs('#editRequestNewDate').value = '';
      qs('#editRequestNewMahal').value = '';
      qs('#editRequestNewMahalOnly').value = '';
      qs('#editRequestNewMusafir').value = '0';
      qs('#editRequestMusafirVal').innerText = '0';
      qs('#editRequestDateSelect').style.display = 'none';
      qs('#editRequestMahalSelect').style.display = 'none';
      qs('#editRequestMusafirSelect').style.display = 'none';
      qs('#editRequestMahalWarning').style.display = 'none';
      qs('#editRequestMahalOnlyWarning').style.display = 'none';
      qs('#editRequestMusafirWarning').style.display = 'none';

      // Chip seÃ§imlerini sÄ±fÄ±rla ve sadece "DÃ¼zenle" seÃ§eneÄŸini gÃ¶ster
      qs('#editRequestModal').querySelectorAll('.chip').forEach(c => {
        c.classList.remove('selected');
        if (c.textContent.includes('DÃ¼zenle')) {
          c.classList.add('selected');
        }
      });

      // SeÃ§enekleri gÃ¶ster/gizle (sadece DÃ¼zenle gÃ¶rÃ¼nÃ¼r)
      toggleEditRequestOptions('teberru');

      qs('#editRequestModal').classList.add('open');
    }

    async function deleteTeberruRecord(recordId) {
      const kayit = teberruKayitlari.find(t => t.id === recordId);
      if (!kayit || (kayit.personelUid !== currentUser.id && kayit.personeluid !== currentUser.id)) {
        showAlert('Bu kaydÄ± silme yetkiniz yok', 'error');
        return;
      }

      showConfirm('Bu teberru kaydÄ±nÄ± silmek istediÄŸinizden emin misiniz?', async () => {
        let arsivId = null;
        
        try {
          // VERÄ° GÃœVENLÄ°ÄÄ°: Ã–nce ArÅŸivle, Sonra Sil + Rollback MekanizmasÄ±
          const kayit = teberruKayitlari.find(t => t.id === recordId);
          if (kayit) {
            const silinenKayit = {
              id: generateUUID(),
              eskiid: recordId,
              bagisci: kayit.bagisci,
              miktar: kayit.miktar,
              odemeyontemi: kayit.odemeyontemi,
              aciklama: kayit.aciklama,
              kayittipi: 'teberru',
              personeluid: kayit.personeluid,
              personeladi: kayit.personeladi,
              yil: kayit.yil,
              silenpersoneluid: currentUser.id,
              silenpersoneladi: currentPersonelAdi || 'Bilinmiyor',
              silinmetarihi: new Date().toISOString(),
              silmeaciklama: 'Teberru kaydÄ± kullanÄ±cÄ± tarafÄ±ndan silindi',
              createdat: new Date().toISOString()
            };
            
            // 1. ArÅŸiv tablosuna kaydet
            const { data: insertData, error: insertError } = await window.supabase.from('teberru_arsiv').insert(silinenKayit).select('id').single();
            if (insertError) {
              console.error('ArÅŸiv insert hatasÄ±:', insertError);
              showToast('error', 'ArÅŸivleme HatasÄ±', 
                `ArÅŸivleme hatasÄ±: ${insertError.message}. KayÄ±t silinemedi.`,
                { important: true }
              );
              return;
            }
            
            arsivId = insertData?.id || silinenKayit.id;
          }
          
          // 2. Orijinal kaydÄ± sil
          const { error: deleteError } = await window.supabase.from('teberru_kayitlari').delete().eq('id', recordId);
          if (deleteError) {
            console.error('Silme hatasÄ±:', deleteError);
            
            // ROLLBACK: ArÅŸivden eklenen kaydÄ± geri sil
            if (arsivId) {
              try {
                await window.supabase.from('teberru_arsiv').delete().eq('id', arsivId);
                console.log('Rollback baÅŸarÄ±lÄ±: Teberru arÅŸiv kaydÄ± geri alÄ±ndÄ±');
                showToast('warning', 'Rollback YapÄ±ldÄ±', 
                  'Teberru kaydÄ± silinemedi. ArÅŸiv kaydÄ± geri alÄ±ndÄ±.',
                  { important: true }
                );
              } catch (rollbackError) {
                console.error('Rollback hatasÄ±:', rollbackError);
                showToast('error', 'Kritik Hata', 
                  'KayÄ±t silinemedi ve arÅŸiv rollback iÅŸlemi baÅŸarÄ±sÄ±z oldu. LÃ¼tfen yÃ¶neticiye bildirin.',
                  { important: true, duration: 10000 }
                );
              }
            }
            
            throw deleteError;
          }
          
          showToast('success', 'BaÅŸarÄ±lÄ±', 'Teberru kaydÄ± baÅŸarÄ±yla silindi ve arÅŸivlendi!');
          loadMyRecords();
        } catch (err) {
          console.error('Teberru silme hatasÄ±:', err);
          showToast('error', 'Ä°ÅŸlem HatasÄ±', 
            err.message || 'Teberru kaydÄ± silinirken bir hata oluÅŸtu.',
            { important: true }
          );
        }
      });
    }

    // TaahhÃ¼t dÃ¼zenleme ve silme
    async function editTaahhutRecord(recordId) {
      const kayit = taahhutKayitlari.find(t => t.id === recordId);
      if (!kayit || (kayit.personelUid !== currentUser.id && kayit.personeluid !== currentUser.id)) {
        showAlert('Bu kaydÄ± dÃ¼zenleme yetkiniz yok', 'error');
        return;
      }

      // DÃ¼zenleme talep modalÄ±nÄ± aÃ§
      let kDate;
      if (kayit.createdAt) {
        kDate = new Date(kayit.createdAt);
      } else {
        kDate = new Date();
      }

      qs('#editRequestRecordId').value = recordId;
      qs('#editRequestKayitTipi').value = 'taahhut';
      qs('#editRequestDateDisplay').innerHTML = `
        <strong>ğŸ“‹ TaahhÃ¼t</strong><br>
        ${kDate.toLocaleDateString('tr-TR', { dateStyle: 'full' })}<br>
        <small style="color:#7f8c8d;">${kayit.bagisci || 'Bilinmiyor'} - ${(kayit.miktar || 0).toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} â‚º</small>
      `;
      qs('#editRequestType').value = 'duzenle';
      qs('#editRequestAciklama').value = '';
      qs('#editRequestNewDate').value = '';
      qs('#editRequestNewMahal').value = '';
      qs('#editRequestNewMahalOnly').value = '';
      qs('#editRequestNewMusafir').value = '0';
      qs('#editRequestMusafirVal').innerText = '0';
      qs('#editRequestDateSelect').style.display = 'none';
      qs('#editRequestMahalSelect').style.display = 'none';
      qs('#editRequestMusafirSelect').style.display = 'none';
      qs('#editRequestMahalWarning').style.display = 'none';
      qs('#editRequestMahalOnlyWarning').style.display = 'none';
      qs('#editRequestMusafirWarning').style.display = 'none';

      // Chip seÃ§imlerini sÄ±fÄ±rla ve sadece "DÃ¼zenle" seÃ§eneÄŸini gÃ¶ster
      qs('#editRequestModal').querySelectorAll('.chip').forEach(c => {
        c.classList.remove('selected');
        if (c.textContent.includes('DÃ¼zenle')) {
          c.classList.add('selected');
        }
      });

      // SeÃ§enekleri gÃ¶ster/gizle (sadece DÃ¼zenle gÃ¶rÃ¼nÃ¼r)
      toggleEditRequestOptions('taahhut');

      qs('#editRequestModal').classList.add('open');
    }

    async function deleteTaahhutRecord(recordId) {
      const kayit = taahhutKayitlari.find(t => t.id === recordId);
      if (!kayit || (kayit.personelUid !== currentUser.id && kayit.personeluid !== currentUser.id)) {
        showAlert('Bu kaydÄ± silme yetkiniz yok', 'error');
        return;
      }

      showConfirm('Bu taahhÃ¼t kaydÄ±nÄ± silmek istediÄŸinizden emin misiniz?', async () => {
        let arsivId = null;
        
        try {
          // VERÄ° GÃœVENLÄ°ÄÄ°: Ã–nce ArÅŸivle, Sonra Sil + Rollback MekanizmasÄ±
          const kayit = taahhutKayitlari.find(t => t.id === recordId);
          if (kayit) {
            const silinenKayit = {
              id: generateUUID(),
              eskiid: recordId,
              bagisci: kayit.bagisci,
              miktar: kayit.miktar,
              aciklama: kayit.aciklama,
              kayittipi: 'taahhut',
              personeluid: kayit.personeluid,
              yil: kayit.yil,
              silenpersoneluid: currentUser.id,
              silenpersoneladi: currentPersonelAdi || 'Bilinmiyor',
              silinmetarihi: new Date().toISOString(),
              silmeaciklama: 'TaahhÃ¼t kaydÄ± kullanÄ±cÄ± tarafÄ±ndan silindi',
              createdat: new Date().toISOString()
            };
            
            // 1. ArÅŸiv tablosuna kaydet
            const { data: insertData, error: insertError } = await window.supabase.from('taahhut_arsiv').insert(silinenKayit).select('id').single();
            if (insertError) {
              console.error('ArÅŸiv insert hatasÄ±:', insertError);
              showToast('error', 'ArÅŸivleme HatasÄ±', 
                `ArÅŸivleme hatasÄ±: ${insertError.message}. KayÄ±t silinemedi.`,
                { important: true }
              );
              return;
            }
            
            arsivId = insertData?.id || silinenKayit.id;
          }
          
          // 2. Orijinal kaydÄ± sil
          const { error: deleteError } = await window.supabase.from('taahhut_kayitlari').delete().eq('id', recordId);
          if (deleteError) {
            console.error('Silme hatasÄ±:', deleteError);
            
            // ROLLBACK: ArÅŸivden eklenen kaydÄ± geri sil
            if (arsivId) {
              try {
                await window.supabase.from('taahhut_arsiv').delete().eq('id', arsivId);
                console.log('Rollback baÅŸarÄ±lÄ±: TaahhÃ¼t arÅŸiv kaydÄ± geri alÄ±ndÄ±');
                showToast('warning', 'Rollback YapÄ±ldÄ±', 
                  'TaahhÃ¼t kaydÄ± silinemedi. ArÅŸiv kaydÄ± geri alÄ±ndÄ±.',
                  { important: true }
                );
              } catch (rollbackError) {
                console.error('Rollback hatasÄ±:', rollbackError);
                showToast('error', 'Kritik Hata', 
                  'KayÄ±t silinemedi ve arÅŸiv rollback iÅŸlemi baÅŸarÄ±sÄ±z oldu. LÃ¼tfen yÃ¶neticiye bildirin.',
                  { important: true, duration: 10000 }
                );
              }
            }
            
            throw deleteError;
          }
          
          showToast('success', 'BaÅŸarÄ±lÄ±', 'TaahhÃ¼t kaydÄ± baÅŸarÄ±yla silindi ve arÅŸivlendi!');
          loadMyRecords();
        } catch (err) {
          console.error('TaahhÃ¼t silme hatasÄ±:', err);
          showToast('error', 'Ä°ÅŸlem HatasÄ±', 
            err.message || 'TaahhÃ¼t kaydÄ± silinirken bir hata oluÅŸtu.',
            { important: true }
          );
        }
      });
    }

    async function openTahsilatModal() {
      const modal = qs('#tahsilatModal');
      const content = qs('#tahsilatContent');
      if (!modal || !content) return;

      if (!currentUser || !currentPersonelAdi) {
        showAlert('Tahsilat gÃ¶rÃ¼ntÃ¼lemek iÃ§in giriÅŸ yapmanÄ±z gerekmektedir.', 'error');
        return;
      }

      // Modal'Ä± aÃ§
      modal.classList.add('open');

      // YÃ¼kleniyor gÃ¶ster
      content.innerHTML = '<div style="text-align:center; padding:30px; color:#999;">YÃ¼kleniyor...</div>';

      try {
        // IMPERSONATION KONTROLÃœ
        const targetUserId = isImpersonating ? impersonatedUserId : currentUser?.id;
        const targetUserName = currentPersonelAdi;
        const normalizedTargetName = normalizePersonelName(targetUserName || '');

        // TaahhÃ¼t kayÄ±tlarÄ±nÄ± yÃ¼kle (eÄŸer yÃ¼klenmemiÅŸse)
        await loadTaahhutKayitlari();

        // KullanÄ±cÄ±nÄ±n Ä°ftar/Sahur kayÄ±tlarÄ±nÄ± filtrele (tutar > 0 olanlar)
        const userIftarSahur = kayitlar.filter(k => {
          const personelMatch = (k.personelUid === targetUserId) || 
                                (k.kaydedenPersonelUid === targetUserId) ||
                                normalizePersonelName(k.personelAdi || k.personel || '') === normalizedTargetName;
          const tipMatch = k.tip === 'iftar' || k.tip === 'sahur';
          const tutarMatch = Number(k.tutar || 0) > 0;
          return personelMatch && tipMatch && tutarMatch;
        });

        // TaahhÃ¼t kayÄ±tlarÄ±nÄ± dÃ¶nÃ¼ÅŸtÃ¼r (aynÄ± yapÄ±ya)
        const userTaahhut = (taahhutKayitlari || []).filter(t => {
          return Number(t.miktar || 0) > 0;
        }).map(t => ({
          id: t.id,
          tip: 'taahhut',
          tutar: t.miktar,
          miktar: t.miktar,
          sahip: t.bagisci,
          bagisci: t.bagisci,
          tarih: t.tarih || t.createdat,
          personelUid: t.personeluid,
          personelAdi: t.personel
        }));

        // TÃ¼m kayÄ±tlarÄ± birleÅŸtir
        const userKayitlar = [...userIftarSahur, ...userTaahhut];

        if (userKayitlar.length === 0) {
          content.innerHTML = `
            <div style="text-align:center; padding:40px; background:#f8f9fa; border-radius:10px; border:1px dashed #ddd;">
              <div style="font-size:48px; margin-bottom:15px;">ğŸ“­</div>
              <div style="font-size:15px; color:#666; font-weight:500;">Tahsilat takibi yapÄ±labilecek kayÄ±t bulunamadÄ±.</div>
              <div style="font-size:13px; color:#999; margin-top:8px;">Sadece tutar iÃ§eren Ä°ftar, Sahur ve TaahhÃ¼t kayÄ±tlarÄ± iÃ§in tahsilat takibi yapÄ±lÄ±r.</div>
            </div>
          `;
          return;
        }

        // Tahsilat verilerini yÃ¼kle
        const kayitIds = userKayitlar.map(k => k.id);
        const { data: tahsilatData, error } = await window.supabase
          .from('ramazan_tahsilat')
          .select('id, kayit_id, tutar, tahsilat_tarihi, odeme_tipi, taksit_no, aciklama, createdat')
          .in('kayit_id', kayitIds)
          .order('tahsilat_tarihi', { ascending: false });

        if (error) throw error;

        // Tahsilat verilerini kayÄ±t ID'sine gÃ¶re grupla
        const tahsilatByKayitId = {};
        const tahsilatListByKayitId = {};
        kayitIds.forEach(id => {
          tahsilatByKayitId[id] = 0;
          tahsilatListByKayitId[id] = [];
        });

        if (tahsilatData) {
          tahsilatData.forEach(t => {
            const kid = t.kayit_id;
            const tutar = Number(t.tutar) || 0;
            tahsilatByKayitId[kid] = (tahsilatByKayitId[kid] || 0) + tutar;
            tahsilatListByKayitId[kid] = tahsilatListByKayitId[kid] || [];
            tahsilatListByKayitId[kid].push({
              id: t.id,
              tutar,
              tahsilat_tarihi: t.tahsilat_tarihi,
              odeme_tipi: t.odeme_tipi || 'pesin',
              taksit_no: t.taksit_no,
              aciklama: t.aciklama
            });
          });
        }

        // KayÄ±tlarÄ± render et
        let html = '<div style="display:flex; flex-direction:column; gap:15px;">';
        
        userKayitlar.forEach(k => {
          const tipLabel = k.tip === 'iftar' ? 'ğŸŒ™ Ä°ftar' : k.tip === 'sahur' ? 'âœ¨ Sahur' : 'ğŸ“‹ TaahhÃ¼t';
          const sahip = k.sahip || k.bagisci || '-';
          const kayitTutari = Number(k.tutar || k.miktar || 0);
          const toplamTahsilat = tahsilatByKayitId[k.id] || 0;
          const kalan = kayitTutari - toplamTahsilat;
          const tahsilatList = tahsilatListByKayitId[k.id] || [];
          
          let durum = '';
          let durumColor = '';
          if (toplamTahsilat >= kayitTutari) {
            durum = 'âœ“ Ã–dendi';
            durumColor = '#27ae60';
          } else if (toplamTahsilat > 0) {
            durum = 'â³ KÄ±smi';
            durumColor = '#f39c12';
          } else {
            durum = 'â¸ Beklemede';
            durumColor = '#95a5a6';
          }

          const tarihStr = k.tarih ? (typeof k.tarih === 'string' ? k.tarih.slice(0, 10) : new Date(k.tarih).toISOString().slice(0, 10)) : '-';

          html += `
            <div style="background:#fff; border:1px solid #e0e0e0; border-radius:10px; padding:15px; box-shadow:0 2px 6px rgba(0,0,0,0.05);">
              <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:12px;">
                <div style="flex:1;">
                  <div style="font-size:15px; font-weight:600; color:var(--text); margin-bottom:4px;">${sahip}</div>
                  <div style="font-size:12px; color:#999;">${tipLabel} â€¢ ${tarihStr}</div>
                </div>
                <div style="text-align:right;">
                  <div style="font-size:13px; font-weight:600; color:${durumColor};">${durum}</div>
                </div>
              </div>
              
              <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:10px; padding:12px; background:#f8f9fa; border-radius:8px; margin-bottom:10px;">
                <div>
                  <div style="font-size:11px; color:#999; margin-bottom:4px;">Toplam Tutar</div>
                  <div style="font-size:14px; font-weight:600;">â‚º${kayitTutari.toLocaleString('tr-TR', { minimumFractionDigits: 2 })}</div>
                </div>
                <div>
                  <div style="font-size:11px; color:#999; margin-bottom:4px;">Tahsil Edilen</div>
                  <div style="font-size:14px; font-weight:600; color:#27ae60;">â‚º${toplamTahsilat.toLocaleString('tr-TR', { minimumFractionDigits: 2 })}</div>
                </div>
                <div>
                  <div style="font-size:11px; color:#999; margin-bottom:4px;">Kalan</div>
                  <div style="font-size:14px; font-weight:600; color:${kalan > 0 ? '#e74c3c' : '#27ae60'};">â‚º${kalan.toLocaleString('tr-TR', { minimumFractionDigits: 2 })}</div>
                </div>
              </div>

              ${tahsilatList.length > 0 ? `
                <details style="margin-top:10px;">
                  <summary style="cursor:pointer; font-size:13px; font-weight:600; color:var(--primary); padding:8px 0;">Tahsilat DetaylarÄ± (${tahsilatList.length})</summary>
                  <div style="margin-top:10px; padding:10px; background:#f8f9fa; border-radius:8px;">
                    ${tahsilatList.map(t => {
                      const tTarih = t.tahsilat_tarihi ? (typeof t.tahsilat_tarihi === 'string' ? t.tahsilat_tarihi.slice(0, 10) : new Date(t.tahsilat_tarihi).toISOString().slice(0, 10)) : '-';
                      const tipLabel = t.odeme_tipi === 'taksit' ? `Taksit ${t.taksit_no || ''}` : 'PeÅŸin';
                      return `
                        <div style="padding:8px 0; border-bottom:1px solid #e0e0e0; display:flex; justify-content:space-between; align-items:center;">
                          <div>
                            <div style="font-size:13px; font-weight:500;">â‚º${Number(t.tutar).toLocaleString('tr-TR', { minimumFractionDigits: 2 })}</div>
                            <div style="font-size:11px; color:#999;">${tTarih} â€¢ ${tipLabel}${t.aciklama ? ' â€¢ ' + t.aciklama : ''}</div>
                          </div>
                        </div>
                      `;
                    }).join('')}
                  </div>
                </details>
              ` : '<div style="font-size:12px; color:#999; padding:10px 0;">HenÃ¼z tahsilat yapÄ±lmamÄ±ÅŸ.</div>'}
            </div>
          `;
        });

        html += '</div>';
        content.innerHTML = html;

      } catch (err) {
        console.error('Tahsilat yÃ¼kleme hatasÄ±:', err);
        content.innerHTML = `
          <div style="text-align:center; padding:30px; background:#ffebee; border-radius:10px; border:1px solid #ef9a9a;">
            <div style="font-size:16px; color:#c62828; font-weight:600; margin-bottom:8px;">âš ï¸ Hata</div>
            <div style="font-size:13px; color:#d32f2f;">Tahsilat verileri yÃ¼klenirken bir hata oluÅŸtu.</div>
          </div>
        `;
      }
    }

    function closeTahsilatModal() {
      const modal = qs('#tahsilatModal');
      if (modal) modal.classList.remove('open');
    }

    async function openAnalizModal() {
      if (!currentUser || !CURRENT_YIL) {
        showAlert('Analiz iÃ§in giriÅŸ yapmanÄ±z ve yÄ±l seÃ§meniz gerekmektedir.', 'error');
        return;
      }

      console.log('ğŸ” openAnalizModal baÅŸladÄ±:', { currentUser: currentUser?.id, CURRENT_YIL, currentPersonelAdi, isImpersonating });

      qs('#analizModal').classList.add('open');
      qs('#analizContent').innerHTML = '<div style="text-align:center; padding:20px; background:#f8f9fa; border-radius:10px;"><div style="font-size:14px; color:#7f8c8d;">YÃ¼kleniyor...</div></div>';

      try {
        const yilNum = typeof CURRENT_YIL === 'number' ? CURRENT_YIL : parseInt(CURRENT_YIL);
        console.log('ğŸ“Š Analiz iÃ§in yÄ±l:', yilNum);

        // IMPERSONATION KONTROLÃœ: BaÅŸka kullanÄ±cÄ± gÃ¶rÃ¼ntÃ¼leniyorsa sadece o kullanÄ±cÄ±nÄ±n verilerini Ã§ek
        const targetUserId = isImpersonating ? impersonatedUserId : currentUser?.id;
        const targetUserName = currentPersonelAdi;

        // Ä°ftar-Sahur kayÄ±tlarÄ± - hedef kullanÄ±cÄ±nÄ±n kayÄ±tlarÄ±nÄ± yÃ¼kle
        let iftarSahurDataUid = [];
        if (targetUserId) {
          const { data } = await window.supabase
            .from('ramazan_kayitlari')
            .select('tutar, tip, personel, personeladi')
            .eq('personeluid', targetUserId)
            .eq('yil', yilNum);
          iftarSahurDataUid = data || [];
        }

        // Personel adÄ± ile de sorgula (muhasebe kayÄ±tlarÄ± iÃ§in)
        let iftarSahurDataName = [];
        if (targetUserName && targetUserName !== 'Bilinmiyor') {
          const { data: nameData } = await window.supabase
            .from('ramazan_kayitlari')
            .select('tutar, tip, personel, personeladi, personeluid')
            .eq('yil', yilNum)
            .or(`personel.eq.${targetUserName},personeladi.eq.${targetUserName}`);
          
          if (nameData) {
            // Personeluid ile eÅŸleÅŸenleri hariÃ§ tut (zaten yukarÄ±da var)
            iftarSahurDataName = nameData.filter(d => {
              const uid = d.personeluid;
              return uid !== targetUserId;
            });
          }
        }

        // TÃ¼m kayÄ±tlarÄ± birleÅŸtir
        const allIftarSahurData = [
          ...iftarSahurDataUid,
          ...iftarSahurDataName
        ];

        let toplamIftar = 0;
        let toplamSahur = 0;
        allIftarSahurData.forEach(d => {
          // if (d.silindi) return; // silindi kolonu yok
          if (d.tip === 'iftar') toplamIftar += Number(d.tutar) || 0;
          else if (d.tip === 'sahur') toplamSahur += Number(d.tutar) || 0;
        });

        // Teberru kayÄ±tlarÄ± - kullanÄ±cÄ±nÄ±n kendi kayÄ±tlarÄ±nÄ± yÃ¼kle (personeluid, kaydedenpersoneluid veya isim ile)
        console.log('ğŸ“¥ Teberru kayÄ±tlarÄ± yÃ¼kleniyor...');
        await loadTeberruKayitlari();
        console.log('âœ… Teberru kayÄ±tlarÄ± yÃ¼klendi:', teberruKayitlari?.length || 0);
        const toplamTeberru = teberruKayitlari.reduce((s, d) => s + (Number(d.miktar) || 0), 0);
        console.log('ğŸ’° Toplam Teberru:', toplamTeberru);

        // TaahhÃ¼t kayÄ±tlarÄ± - kullanÄ±cÄ±nÄ±n kendi kayÄ±tlarÄ±nÄ± yÃ¼kle (personeluid, kaydedenpersoneluid veya isim ile)
        console.log('ğŸ“¥ TaahhÃ¼t kayÄ±tlarÄ± yÃ¼kleniyor...');
        await loadTaahhutKayitlari();
        console.log('âœ… TaahhÃ¼t kayÄ±tlarÄ± yÃ¼klendi:', taahhutKayitlari?.length || 0);
        const toplamTaahhut = taahhutKayitlari.reduce((s, d) => s + (Number(d.miktar) || 0), 0);
        console.log('ğŸ’° Toplam TaahhÃ¼t:', toplamTaahhut);

        const toplamUlasilan = toplamIftar + toplamSahur + toplamTeberru + toplamTaahhut;


        // Personel hedefini Ã§ek - ramazan_hedefler tablosundan
        // Hedef kullanÄ±cÄ±ya ait hedefi bul (personeluid, personelAdi veya personel ile eÅŸleÅŸtirme)
        let hedef = 0;
        try {
          // Ã–nce ramazan_hedefler (yeni sistem)
          const { data: hedefDataList, error: hedefError } = await window.supabase
            .from('ramazan_hedefler')
            .select('id, personeladi, hedef, yil, personeluid, updatedat, createdat')
            .eq('yil', yilNum);

          if (hedefError) {
            console.warn('Hedef verisi okunurken hata:', hedefError);
          }

          if (hedefDataList && hedefDataList.length > 0) {
            // EÅŸleÅŸtirme Ã¶nceliÄŸi: personeluid > personeladi > personel (hedef kullanÄ±cÄ± ile)
            const userTarget = hedefDataList.find(h => {
              // 1. UID eÅŸleÅŸmesi (varsa) - personeluid kontrol et
              if (h.personeluid && h.personeluid === targetUserId) {
                return true;
              }
              // 2. Ä°sim eÅŸleÅŸmesi (normalize ederek) - personeladi veya personel alanÄ± ile
              if (targetUserName) {
                const hName = normalizePersonelName(h.personeladi || h.personelAdi || h.personel || '');
                const cName = normalizePersonelName(targetUserName || '');
                if (hName && cName && hName === cName) return true;
              }
              return false;
            });

            if (userTarget) {
              hedef = parseFloat(userTarget.hedef || userTarget.tutar || userTarget.bedel || 0);
            }
          }

          // EÄŸer hedef hala 0 ise ve 'hedefler' tablosunda varsa (eski sistem fallback)
          // NOT: hedefler tablosu farklÄ± bir ÅŸemaya sahip olabilir, bu yÃ¼zden hata yakalanÄ±yor
          if (hedef === 0) {
            try {
              // Ã–nce hedefler tablosunun yapÄ±sÄ±nÄ± kontrol et
              // Muhtemelen yil kolonu farklÄ± bir isimde olabilir veya yok olabilir
              const { data: eskiHedefler, error: eskiError } = await window.supabase
                .from('hedefler')
                .select('id, hedef, kategori, personel, uid, updatedat, updatedby')
                .eq('kategori', 'Ramazan');
              
              if (eskiError) {
                // Sessizce devam et, tablo yoksa veya ÅŸema farklÄ±ysa sorun deÄŸil
                // console.warn('Eski hedef verisi okunurken hata:', eskiError);
              } else if (eskiHedefler && eskiHedefler.length > 0) {
                // Client-side'da yÄ±l filtresi yap
                const yilFiltreli = eskiHedefler.filter(h => {
                  // YÄ±l alanÄ± farklÄ± isimlerde olabilir: yil, yÄ±l, year, tarih vs.
                  const yilDeger = h.yil || h.yÄ±l || h.year || (h.tarih ? new Date(h.tarih).getFullYear() : null);
                  return yilDeger === yilNum;
                });
                
                const userTarget = yilFiltreli.find(h => {
                  // UID eÅŸleÅŸmesi (hedef kullanÄ±cÄ± ile)
                  if (h.uid === targetUserId || h.personeluid === targetUserId) return true;
                  // Ä°sim eÅŸleÅŸmesi
                  if (targetUserName) {
                    const hName = normalizePersonelName(h.personel || '');
                    const cName = normalizePersonelName(targetUserName || '');
                    return hName && cName && hName === cName;
                  }
                  return false;
                });
                if (userTarget) {
                  hedef = parseFloat(userTarget.hedef || userTarget.tutar || 0);
                }
              }
            } catch (eskiErr) {
              // Sessizce devam et, eski sistem yoksa sorun deÄŸil
              // console.warn('Eski hedef tablosu okunamadÄ±:', eskiErr);
            }
          }
        } catch (hErr) {
          console.warn('Hedef verisi okunamadÄ±:', hErr);
        }

        // Nispet ve HTML oluÅŸturma (Mevcut mantÄ±k ile aynÄ±)
        const nispet = hedef > 0 ? ((toplamUlasilan / hedef) * 100).toFixed(2) : 0;
        const formatTutar = (tutar) => {
          return new Intl.NumberFormat('tr-TR', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          }).format(tutar);
        };

        let contentHtml = '';
        if (hedef > 0) {
          contentHtml = `
            <div style="text-align:center; padding:25px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius:12px; margin-bottom:20px; color:white; box-shadow:0 4px 15px rgba(102,126,234,0.3);">
              <div style="font-size:15px; opacity:0.95; margin-bottom:10px; font-weight:500;">ğŸ¯ Toplam Hedef</div>
              <div style="font-size:38px; font-weight:700; margin-bottom:25px; letter-spacing:1px;">â‚º${formatTutar(hedef)}</div>
              
              <div style="border-top:1px solid rgba(255,255,255,0.3); padding-top:20px; margin-top:20px;">
                <div style="font-size:14px; opacity:0.9; margin-bottom:8px; font-weight:500;">UlaÅŸÄ±lan Rakam</div>
                <div style="font-size:30px; font-weight:600; margin-bottom:20px;">â‚º${formatTutar(toplamUlasilan)}</div>
              </div>
              
              <div style="border-top:1px solid rgba(255,255,255,0.3); padding-top:20px; margin-top:20px;">
                <div style="font-size:14px; opacity:0.9; margin-bottom:8px; font-weight:500;">UlaÅŸÄ±lan Nispet</div>
                <div style="font-size:42px; font-weight:700; margin-bottom:10px;">%${nispet}</div>
                ${nispet >= 100 ? '<div style="margin-top:15px; font-size:18px; font-weight:600;">ğŸ‰ Hedefe ulaÅŸÄ±ldÄ±!</div>' : ''}
              </div>
            </div>
          `;
        } else {
          contentHtml = `
            <div style="text-align:center; padding:25px; background:#f8f9fa; border-radius:12px; margin-bottom:20px; border:2px dashed #ddd;">
              <div style="font-size:15px; color:#7f8c8d; margin-bottom:10px; font-weight:500;">Hedef BelirlenmemiÅŸ</div>
              <div style="font-size:28px; font-weight:700; color:var(--primary); margin-bottom:10px;">â‚º${formatTutar(toplamUlasilan)}</div>
              <div style="font-size:13px; color:#95a5a6;">Toplam ulaÅŸÄ±lan rakam</div>
            </div>
          `;
        }

        contentHtml += `
          <div style="background:#f8f9fa; padding:18px; border-radius:12px; margin-bottom:15px;">
            <h4 style="margin:0 0 15px 0; font-size:17px; color:var(--primary); font-weight:600; display:flex; align-items:center; gap:8px;">
              <span>ğŸ“Š</span>
              <span>Detaylar</span>
            </h4>
            <div style="display:flex; flex-direction:column; gap:12px;">
              <div style="display:flex; justify-content:space-between; align-items:center; padding:12px 15px; background:white; border-radius:8px; border-left:4px solid #f39c12; box-shadow:0 2px 4px rgba(0,0,0,0.05);">
                <span style="font-size:15px; color:#7f8c8d; font-weight:500;">ğŸŒ™ Ä°ftar Bedeli</span>
                <span style="font-size:17px; font-weight:700; color:#f39c12;">â‚º${formatTutar(toplamIftar)}</span>
              </div>
              <div style="display:flex; justify-content:space-between; align-items:center; padding:12px 15px; background:white; border-radius:8px; border-left:4px solid #3498db; box-shadow:0 2px 4px rgba(0,0,0,0.05);">
                <span style="font-size:15px; color:#7f8c8d; font-weight:500;">ğŸŒŸ Sahur Bedeli</span>
                <span style="font-size:17px; font-weight:700; color:#3498db;">â‚º${formatTutar(toplamSahur)}</span>
              </div>
              <div style="display:flex; justify-content:space-between; align-items:center; padding:12px 15px; background:white; border-radius:8px; border-left:4px solid #27ae60; box-shadow:0 2px 4px rgba(0,0,0,0.05);">
                <span style="font-size:15px; color:#7f8c8d; font-weight:500;">ğŸ’° Teberru Bedeli</span>
                <span style="font-size:17px; font-weight:700; color:#27ae60;">â‚º${formatTutar(toplamTeberru)}</span>
              </div>
              <div style="display:flex; justify-content:space-between; align-items:center; padding:12px 15px; background:white; border-radius:8px; border-left:4px solid #3498db; box-shadow:0 2px 4px rgba(0,0,0,0.05);">
                <span style="font-size:15px; color:#7f8c8d; font-weight:500;">ğŸ“‹ TaahhÃ¼t Bedeli</span>
                <span style="font-size:17px; font-weight:700; color:#3498db;">â‚º${formatTutar(toplamTaahhut)}</span>
              </div>
              <div style="display:flex; justify-content:space-between; align-items:center; padding:15px; background:linear-gradient(135deg, var(--primary) 0%, #667eea 100%); border-radius:8px; margin-top:8px; box-shadow:0 4px 12px rgba(102,126,234,0.3);">
                <span style="font-size:18px; font-weight:700; color:white;">Toplam</span>
                <span style="font-size:24px; font-weight:800; color:white; letter-spacing:0.5px;">â‚º${formatTutar(toplamUlasilan)}</span>
              </div>
            </div>
          </div>
        `;

        qs('#analizContent').innerHTML = contentHtml;
      } catch (err) {
        console.error('Analiz yÃ¼klenirken hata:', err);
        qs('#analizContent').innerHTML = `
          <div style="text-align:center; padding:20px; background:#ffebee; border-radius:10px; color:#c62828;">
            <div style="font-size:14px; margin-bottom:8px;">Hata oluÅŸtu</div>
            <div style="font-size:12px; color:#7f8c8d;">${err.message}</div>
          </div>
        `;
      }
    }

    function closeAnalizModal() {
      qs('#analizModal').classList.remove('open');
    }

    // ============================================
    // ADMIN IMPERSONATION (KullanÄ±cÄ± DeÄŸiÅŸtirme) FONKSÄ°YONLARI
    // ============================================
    
    async function openUserSwitchModal() {
      // Admin kontrolÃ¼ - sadece yetkili kullanÄ±cÄ±lar aÃ§abilir
      const isAdmin = ADMIN_USERS.some(admin => 
        normalizePersonelName(admin) === normalizePersonelName(originalPersonelAdi || '')
      );
      
      if (!isAdmin) {
        // Admin deÄŸilse sessizce Ã§Ä±k (hiÃ§bir ÅŸey yapma)
        return;
      }

      const modal = qs('#userSwitchModal');
      const listContainer = qs('#userSwitchList');
      const currentViewingEl = qs('#currentViewingUser');
      const searchInput = qs('#userSearchInput');
      
      if (!modal || !listContainer) return;

      // Åu an gÃ¶rÃ¼ntÃ¼lenen kullanÄ±cÄ±yÄ± gÃ¶ster
      if (currentViewingEl) {
        const viewingName = currentPersonelAdi || 'Bilinmiyor';
        const isOwnAccount = !isImpersonating;
        currentViewingEl.innerHTML = `${viewingName} ${isOwnAccount ? '<span style="font-size:11px; color:#43a047;">(Kendi hesabÄ±nÄ±z)</span>' : '<span style="font-size:11px; color:#f57c00;">(BaÅŸka kullanÄ±cÄ±)</span>'}`;
      }

      // Arama kutusunu temizle
      if (searchInput) searchInput.value = '';

      modal.classList.add('open');

      // KullanÄ±cÄ±larÄ± yÃ¼kle
      listContainer.innerHTML = `
        <div style="text-align:center; padding:30px; color:#999;">
          <div style="font-size:24px; margin-bottom:10px;">â³</div>
          KullanÄ±cÄ±lar yÃ¼kleniyor...
        </div>
      `;

      try {
        // TÃ¼m kullanÄ±cÄ±larÄ± Ã§ek
        const { data: users, error } = await window.supabase
          .from('kullanicilar')
          .select('id, adsoyad, email')
          .order('adsoyad', { ascending: true });

        if (error) throw error;

        allUsers = users || [];

        if (allUsers.length === 0) {
          listContainer.innerHTML = `
            <div style="text-align:center; padding:30px; color:#999;">
              <div style="font-size:24px; margin-bottom:10px;">ğŸ“­</div>
              KullanÄ±cÄ± bulunamadÄ±
            </div>
          `;
          return;
        }

        renderUserList(allUsers);

      } catch (err) {
        console.error('KullanÄ±cÄ±lar yÃ¼klenemedi:', err);
        listContainer.innerHTML = `
          <div style="text-align:center; padding:30px; color:#e74c3c;">
            <div style="font-size:24px; margin-bottom:10px;">âš ï¸</div>
            KullanÄ±cÄ±lar yÃ¼klenirken hata oluÅŸtu
          </div>
        `;
      }
    }

    function renderUserList(users) {
      const listContainer = qs('#userSwitchList');
      if (!listContainer) return;

      if (users.length === 0) {
        listContainer.innerHTML = `
          <div style="text-align:center; padding:20px; color:#999;">
            EÅŸleÅŸen kullanÄ±cÄ± bulunamadÄ±
          </div>
        `;
        return;
      }

      listContainer.innerHTML = users.map(user => {
        const isCurrentUser = normalizePersonelName(user.adsoyad || '') === normalizePersonelName(currentPersonelAdi || '');
        const isOriginalUser = normalizePersonelName(user.adsoyad || '') === normalizePersonelName(originalPersonelAdi || '');
        
        return `
          <div onclick="switchToUser('${user.id}', '${escapeHtml(user.adsoyad || user.email || 'Bilinmiyor')}')" 
            style="padding:12px 15px; border:1px solid ${isCurrentUser ? 'var(--primary)' : 'var(--border)'}; border-radius:10px; margin-bottom:8px; cursor:pointer; transition:all 0.2s; background:${isCurrentUser ? '#e3f2fd' : 'white'}; display:flex; align-items:center; justify-content:space-between;"
            onmouseover="this.style.background='${isCurrentUser ? '#bbdefb' : '#f5f5f5'}'" 
            onmouseout="this.style.background='${isCurrentUser ? '#e3f2fd' : 'white'}'">
            <div>
              <div style="font-weight:600; color:#2c3e50; font-size:14px;">
                ${escapeHtml(user.adsoyad || 'Ä°simsiz')}
                ${isOriginalUser ? '<span style="font-size:10px; background:#27ae60; color:white; padding:2px 6px; border-radius:8px; margin-left:6px;">SÄ°Z</span>' : ''}
              </div>
              <div style="font-size:12px; color:#7f8c8d; margin-top:2px;">${escapeHtml(user.email || '')}</div>
            </div>
            ${isCurrentUser ? '<span style="color:var(--primary); font-size:18px;">âœ“</span>' : ''}
          </div>
        `;
      }).join('');
    }

    function filterUserList(searchTerm) {
      const term = searchTerm.toLowerCase().trim();
      if (!term) {
        renderUserList(allUsers);
        return;
      }
      
      const filtered = allUsers.filter(user => {
        const name = (user.adsoyad || '').toLowerCase();
        const email = (user.email || '').toLowerCase();
        return name.includes(term) || email.includes(term);
      });
      
      renderUserList(filtered);
    }

    async function switchToUser(userId, userName) {
      // KullanÄ±cÄ± deÄŸiÅŸtir
      currentPersonelAdi = userName;
      window.currentPersonelAdi = userName;
      
      // Impersonation durumunu gÃ¼ncelle
      isImpersonating = normalizePersonelName(userName) !== normalizePersonelName(originalPersonelAdi || '');
      
      // SeÃ§ilen kullanÄ±cÄ±nÄ±n ID'sini sakla (impersonation modunda sorgulamalar iÃ§in)
      impersonatedUserId = isImpersonating ? userId : null;

      // Header'Ä± gÃ¼ncelle
      const userNameDisplay = qs('#userNameDisplay');
      const userBadge = qs('#userBadge');
      if (userNameDisplay) {
        userNameDisplay.textContent = userName;
      }
      
      // Badge rengini deÄŸiÅŸtir (impersonation modunda farklÄ± renk)
      if (userBadge) {
        if (isImpersonating) {
          userBadge.style.background = 'rgba(255,152,0,0.4)';
          userBadge.style.borderColor = 'rgba(255,152,0,0.6)';
        } else {
          userBadge.style.background = 'rgba(255,255,255,0.25)';
          userBadge.style.borderColor = 'rgba(255,255,255,0.3)';
        }
      }

      // Åu an gÃ¶rÃ¼ntÃ¼lenen kullanÄ±cÄ±yÄ± gÃ¼ncelle
      const currentViewingEl = qs('#currentViewingUser');
      if (currentViewingEl) {
        currentViewingEl.innerHTML = `${userName} ${!isImpersonating ? '<span style="font-size:11px; color:#43a047;">(Kendi hesabÄ±nÄ±z)</span>' : '<span style="font-size:11px; color:#f57c00;">(BaÅŸka kullanÄ±cÄ±)</span>'}`;
      }

      // ModalÄ± kapat
      closeUserSwitchModal();

      // Bildirim gÃ¶ster
      if (isImpersonating) {
        showToast('info', 'KullanÄ±cÄ± DeÄŸiÅŸtirildi', `${userName} olarak gÃ¶rÃ¼ntÃ¼lÃ¼yorsunuz.`, { duration: 3000 });
      } else {
        showToast('success', 'Kendi HesabÄ±nÄ±z', 'Kendi hesabÄ±nÄ±za dÃ¶ndÃ¼nÃ¼z.', { duration: 2000 });
      }

      // Verileri yeniden yÃ¼kle
      await reloadAllDataForUser();
    }

    function resetToOriginalUser() {
      if (!originalPersonelAdi) {
        showToast('warning', 'UyarÄ±', 'Orijinal kullanÄ±cÄ± bilgisi bulunamadÄ±.');
        return;
      }
      
      switchToUser(originalUser?.id, originalPersonelAdi);
    }

    async function reloadAllDataForUser() {
      // YÃ¼kleniyor gÃ¶stergesi
      showToast('info', 'YÃ¼kleniyor', 'Veriler gÃ¼ncelleniyor...', { duration: 1500 });

      try {
        // Teberru ve TaahhÃ¼t kayÄ±tlarÄ±nÄ± yeniden yÃ¼kle
        await loadTeberruKayitlari();
        await loadTaahhutKayitlari();
        
        // KayÄ±tlarÄ± yeniden yÃ¼kle
        await loadMyRecords();
        
        // Tahsilat detay tablosunu yeniden yÃ¼kle
        await loadTahsilatDetayTablosu();
        
        console.log('âœ… KullanÄ±cÄ± verileri yeniden yÃ¼klendi:', currentPersonelAdi);
      } catch (err) {
        console.error('Veri yÃ¼kleme hatasÄ±:', err);
        showToast('error', 'Hata', 'Veriler yÃ¼klenirken bir hata oluÅŸtu.');
      }
    }

    function closeUserSwitchModal() {
      const modal = qs('#userSwitchModal');
      if (modal) modal.classList.remove('open');
    }

    // Global fonksiyonlar (HTML onclick vb. iÃ§in)
    window.openTeberruModal = openTeberruModal;
    window.openTaahhutModal = openTaahhutModal;
    window.openTahsilatModal = openTahsilatModal;
    window.closeTahsilatModal = closeTahsilatModal;
    window.openAnalizModal = openAnalizModal;
    window.closeAnalizModal = closeAnalizModal;
    window.loadTahsilatDetayTablosu = loadTahsilatDetayTablosu;
    window.openUserSwitchModal = openUserSwitchModal;
    window.closeUserSwitchModal = closeUserSwitchModal;
    window.switchToUser = switchToUser;
    window.resetToOriginalUser = resetToOriginalUser;
    window.filterUserList = filterUserList;
    window.closeTeberruModal = closeTeberruModal;
    window.closeTaahhutModal = closeTaahhutModal;
    window.showTeberruPreview = showTeberruPreview;
    window.showTaahhutPreview = showTaahhutPreview;
    window.closeTeberruPreviewModal = closeTeberruPreviewModal;
    window.closeTaahhutPreviewModal = closeTaahhutPreviewModal;
    window.saveTeberru = saveTeberru;
    window.saveTaahhut = saveTaahhut;
    window.editTeberruRecord = editTeberruRecord;
    window.deleteTeberruRecord = deleteTeberruRecord;
    window.editTaahhutRecord = editTaahhutRecord;
    window.deleteTaahhutRecord = deleteTaahhutRecord;
    window.closeInfoModal = closeInfoModal;
    window.openMenuDetailModal = openMenuDetailModal;
    window.closeMenuDetailModal = closeMenuDetailModal;
    window.switchView = switchView;
    window.editMyRecord = editMyRecord;
    window.deleteMyRecord = deleteMyRecord;
    window.toggleEditRequestOptions = toggleEditRequestOptions;
    window.closeEditRequestModal = closeEditRequestModal;

    // Davetiye oluÅŸturma fonksiyonu
    function generateDavetiye(sahip, tip, tarihISO, musafirAdedi) {
      try {
        const tarih = new Date(tarihISO);
        if (isNaN(tarih.getTime())) {
          alert('GeÃ§ersiz tarih!');
          return;
        }

        // HaftanÄ±n gÃ¼nÃ¼ (TÃ¼rkÃ§e)
        const gunler = ['Pazar', 'Pazartesi', 'SalÄ±', 'Ã‡arÅŸamba', 'PerÅŸembe', 'Cuma', 'Cumartesi'];
        const gun = gunler[tarih.getDay()];

        // Gregoryen tarih bilgileri
        const gregGun = tarih.getDate();
        const gregAy = tarih.getMonth() + 1;
        const gregYil = tarih.getFullYear();
        
        // Ay isimleri (TÃ¼rkÃ§e)
        const aylar = ['OCAK', 'ÅUBAT', 'MART', 'NÄ°SAN', 'MAYIS', 'HAZÄ°RAN', 'TEMMUZ', 'AÄUSTOS', 'EYLÃœL', 'EKÄ°M', 'KASIM', 'ARALIK'];
        const gregAyAdi = aylar[gregAy - 1];

        // Aile bilgisi - her zaman true
        const hasFamily = true;

        // URL parametreleri
        const params = new URLSearchParams({
          sahip: sahip || '',
          tip: tip || 'iftar',
          tarih: tarihISO,
          gun: gun,
          gregGun: gregGun.toString(),
          gregAy: gregAyAdi,
          gregYil: gregYil.toString(),
          hasFamily: hasFamily.toString()
        });

        // Yeni sekmede aÃ§
        const davetiyeUrl = `../sablonlar/davetiye.html?${params.toString()}`;
        window.open(davetiyeUrl, '_blank');
      } catch (error) {
        console.error('Davetiye oluÅŸturma hatasÄ±:', error);
        alert('Davetiye oluÅŸturulurken bir hata oluÅŸtu!');
      }
    }
    window.generateDavetiye = generateDavetiye;
  </script>
</body>

</html>