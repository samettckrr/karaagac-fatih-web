<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Ramazan Takip Sistemi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover"/>
  
  <meta name="theme-color" content="#324960">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="icon" type="image/png" href="../img/logo.png" />

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="../../js/firebase/firebase-init.js"></script>

  <style>
    :root {
      --primary: #324960; --accent: #e67e22;
      --success: #27ae60; --danger: #c0392b; --warning: #f39c12;
      --bg: #f0f2f5; --card: #ffffff; --text: #2c3e50; --border: #e9ecef;
      --nav-height: 65px;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { 
      margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg); color: var(--text); padding-bottom: 80px;
    }

    /* --- HEADER --- */
    .hero-header {
      background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
      color: white; padding: 15px 20px 40px 20px; border-radius: 0 0 25px 25px;
      position: relative; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .top-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    
    /* Geri DÃ¶n Butonu */
    .back-btn {
      display: flex; align-items: center; gap: 6px;
      background: rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 20px;
      color: white; text-decoration: none; font-size: 13px; font-weight: 600;
      transition: 0.2s; backdrop-filter: blur(4px);
    }
    .back-btn:hover { background: rgba(255,255,255,0.3); }

    .year-selector {
      background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);
      color: white; padding: 5px 10px; border-radius: 15px; font-size: 12px; font-weight: 600;
      appearance: none; outline: none; cursor: pointer;
    }
    .year-selector option { color: #333; }

    .countdown-box { text-align: center; margin-top: 5px; }
    .countdown-timer { font-size: 32px; font-weight: 800; letter-spacing: 1px; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    .countdown-label { font-size: 12px; opacity: 0.9; text-transform: uppercase; letter-spacing: 1px; }

    /* --- LAYOUT CONTAINER --- */
    .main-container {
      max-width: 1200px; margin: 0 auto; padding: 20px; margin-top: -30px;
    }

    /* --- 1. MOBÄ°L GÃ–RÃœNÃœM (Timeline) --- */
    .timeline-view { display: block; } /* Mobilde varsayÄ±lan */
    .calendar-view { display: none; }  /* Mobilde gizli */

    .day-card {
      background: var(--card); border-radius: 16px; margin-bottom: 12px;
      padding: 15px; display: flex; justify-content: space-between; align-items: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04); border-left: 5px solid transparent;
      transition: transform 0.1s; cursor: pointer;
    }
    .day-card:active { transform: scale(0.98); }
    
    .status-green { border-left-color: var(--success); }
    .status-orange { border-left-color: var(--warning); }
    .status-red { border-left-color: var(--danger); }

    .dc-date { display: flex; flex-direction: column; align-items: center; min-width: 50px; border-right: 1px solid #eee; padding-right: 10px; margin-right: 10px; }
    .dc-day-num { font-size: 24px; font-weight: 800; line-height: 1; }
    .dc-day-name { font-size: 10px; text-transform: uppercase; color: #7f8c8d; font-weight: 600; }
    .dc-info { flex: 1; }
    .dc-ramazan { font-size: 11px; color: var(--accent); font-weight: 700; text-transform: uppercase; }
    .dc-status { font-size: 13px; font-weight: 600; color: #34495e; }
    .dc-action { font-size: 24px; color: var(--primary); font-weight: 300; }

    /* --- 2. MASAÃœSTÃœ GÃ–RÃœNÃœM (Responsive Grid) --- */
    @media (min-width: 768px) {
      .bottom-nav { display: none !important; } /* Alt menÃ¼yÃ¼ gizle */
      body { padding-bottom: 0; }
      
      .timeline-view { display: none; } /* Mobili gizle */
      .calendar-view { display: grid; grid-template-columns: repeat(7, 1fr); gap: 10px; } /* MasaÃ¼stÃ¼nÃ¼ aÃ§ */
      
      /* MasaÃ¼stÃ¼ Takvim KartÄ± */
      .cal-cell {
        background: white; border-radius: 12px; padding: 10px; min-height: 100px;
        border: 1px solid #e0e0e0; cursor: pointer; transition: 0.2s;
        display: flex; flex-direction: column; justify-content: space-between;
      }
      .cal-cell:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-color: var(--primary); }
      .cal-cell.empty { background: transparent; border: none; cursor: default; }
      
      .cc-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
      .cc-num { font-weight: 800; font-size: 18px; color: #2c3e50; }
      .cc-day { font-size: 12px; color: #95a5a6; }
      
      .cc-badges { display: flex; flex-direction: column; gap: 3px; }
      .cc-badge { font-size: 11px; padding: 3px 6px; border-radius: 4px; color: white; text-align: center; }
      .cc-iftar { background: var(--accent); }
      .cc-sahur { background: #3498db; }
      .cc-full { opacity: 0.5; text-decoration: line-through; }
    }

    /* --- MODAL & FORM --- */
    .modal {
      position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000;
      display: none; align-items: center; justify-content: center; backdrop-filter: blur(3px);
    }
    .modal.open { display: flex; }
    .modal-sheet {
      background: #fff; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto;
      border-radius: 20px; padding: 25px 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      animation: zoomIn 0.2s ease-out;
    }
    @keyframes zoomIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    
    .form-label { font-size: 13px; font-weight: 600; color: #7f8c8d; margin-bottom: 8px; display: block; }
    .chip-group { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; }
    .chip {
      padding: 10px 16px; background: #f1f2f6; border-radius: 10px; border: 2px solid transparent;
      font-size: 14px; font-weight: 600; color: #2c3e50; white-space: nowrap; cursor: pointer;
    }
    .chip.selected { background: #e8f4fd; border-color: var(--primary); color: var(--primary); }
    
    .stepper { display: flex; align-items: center; gap: 15px; }
    .step-btn { width: 40px; height: 40px; border-radius: 10px; background: #f1f2f6; border: none; font-size: 20px; font-weight: bold; color: var(--primary); cursor: pointer; }
    .step-val { font-size: 18px; font-weight: bold; width: 30px; text-align: center; }

    .full-input { width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 10px; font-size: 15px; background: #f9f9f9; }
    .full-btn { width: 100%; padding: 15px; border-radius: 12px; border: none; font-size: 16px; font-weight: 700; cursor: pointer; margin-top: 10px; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-secondary { background: #f1f2f6; color: #7f8c8d; }

    /* BOTTOM NAV (Mobil Ä°Ã§in) */
    .bottom-nav {
      position: fixed; bottom: 0; left: 0; right: 0; height: var(--nav-height);
      background: var(--card); box-shadow: 0 -2px 20px rgba(0,0,0,0.05);
      display: flex; justify-content: space-around; align-items: center; z-index: 100;
      padding-bottom: env(safe-area-inset-bottom);
    }
    .nav-btn {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      color: #95a5a6; font-size: 10px; font-weight: 600; gap: 4px; background: none; border: none; width: 100%; height: 100%;
    }
    .nav-btn.active { color: var(--primary); }
    .nav-btn svg { width: 24px; height: 24px; fill: currentColor; }

    /* WHATSAPP */
    .wa-btn {
      position: fixed; bottom: 90px; right: 20px;
      width: 50px; height: 50px; background: #25D366; border-radius: 50%;
      box-shadow: 0 4px 10px rgba(37, 211, 102, 0.4); z-index: 90;
      display: flex; align-items: center; justify-content: center; color: white; text-decoration: none;
    }
    @media (min-width: 768px) { .wa-btn { bottom: 30px; } } /* MasaÃ¼stÃ¼nde aÅŸaÄŸÄ± al */
  </style>
</head>
<body>

  <div class="hero-header">
    <div class="top-nav">
      <a href="../panel.html" class="back-btn">
        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
        Panele DÃ¶n
      </a>
      
      <select id="selYil" class="year-selector">
        <option value="">YÄ±l...</option>
      </select>
    </div>
    
    <div class="countdown-box">
      <div class="countdown-timer" id="countdownDisplay">--:--:--</div>
      <div class="countdown-label">Ä°FTARA KALAN SÃœRE</div>
    </div>
  </div>

  <div class="main-container">
    
    <div id="mobileView" class="timeline-view">
      <div style="text-align:center; padding:20px; color:#999">YÃ¼kleniyor...</div>
    </div>

    <div id="desktopView" class="calendar-view">
      </div>

  </div>

  <div id="formModal" class="modal">
    <div class="modal-sheet">
      <h3 style="margin:0 0 20px 0; font-size:20px;">Yeni KayÄ±t</h3>
      <form id="smartForm">
        <input type="hidden" id="fDate">
        
        <div id="fDateDisplay" style="font-weight:bold; margin-bottom:15px; color:var(--primary); text-align:center; background:#f0f2f5; padding:10px; border-radius:8px;"></div>

        <label class="form-label">KayÄ±t Tipi</label>
        <div class="chip-group" id="typeChips">
          <div class="chip selected" onclick="selectChip('type', 'iftar', this)">ðŸŒ™ Ä°ftar</div>
          <div class="chip" onclick="selectChip('type', 'sahur', this)">ðŸŒŸ Sahur</div>
        </div>
        <input type="hidden" id="fType" value="iftar">

        <label class="form-label" style="margin-top:15px">Tutar SeÃ§imi</label>
        <div class="chip-group" id="priceChips">
          <div class="chip">YÃ¼kleniyor...</div>
        </div>
        <input type="hidden" id="fPrice">

        <label class="form-label" style="margin-top:15px">Ä°ftar Sahibi AdÄ± SoyadÄ±</label>
        <input type="text" id="fName" class="full-input" placeholder="Ã–rn: Ahmet YÄ±lmaz" required>

        <label class="form-label" style="margin-top:15px">MÃ¼safir SayÄ±sÄ±</label>
        <div class="stepper">
          <button type="button" class="step-btn" onclick="stepGuest(-1)">-</button>
          <span class="step-val" id="fGuestVal">0</span>
          <button type="button" class="step-btn" onclick="stepGuest(1)">+</button>
        </div>
        <input type="hidden" id="fGuest" value="0">

        <label class="form-label" style="margin-top:15px">Not</label>
        <input type="text" id="fNote" class="full-input" placeholder="Ä°steÄŸe baÄŸlÄ± not...">

        <button type="submit" class="full-btn btn-primary">KAYDET</button>
        <button type="button" class="full-btn btn-secondary" onclick="closeModal()">Ä°ptal</button>
      </form>
    </div>
  </div>

  <nav class="bottom-nav">
    <button class="nav-btn active">
      <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
      <span>Takvim</span>
    </button>
    <button class="nav-btn" onclick="alert('Profil sayfasÄ±na yÃ¶nlendiriliyor...')">
      <svg viewBox="0 0 24 24"><path d="M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"/></svg>
      <span>Profil</span>
    </button>
  </nav>

  <a href="https://wa.me/905555555555" class="wa-btn" target="_blank">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M.057 24l1.687-6.163c-1.041-1.804-1.588-3.849-1.587-5.946.003-6.556 5.338-11.891 11.893-11.891 3.181.001 6.167 1.24 8.413 3.488 2.245 2.248 3.481 5.236 3.48 8.414-.003 6.557-5.338 11.892-11.893 11.892-1.99-.001-3.951-.5-5.688-1.448l-6.305 1.654zm6.597-3.807c1.676.995 3.276 1.591 5.392 1.592 5.448 0 9.886-4.434 9.889-9.885.002-5.462-4.415-9.89-9.881-9.892-5.452 0-9.887 4.434-9.889 9.884-.001 2.225.651 3.891 1.746 5.634l-.999 3.648 3.742-.981zm11.387-5.464c-.074-.124-.272-.198-.57-.347-.297-.149-1.758-.868-2.031-.967-.272-.099-.47-.149-.669.149-.198.297-.768.967-.941 1.165-.173.198-.347.223-.644.074-.297-.149-1.255-.462-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.297-.347.446-.521.151-.172.2-.296.3-.495.099-.198.05-.372-.025-.521-.075-.148-.669-1.611-.916-2.206-.242-.579-.487-.501-.669-.51l-.57-.01c-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.095 3.2 5.076 4.487.709.306 1.263.489 1.694.626.712.226 1.36.194 1.872.118.571-.085 1.758-.719 2.006-1.413.248-.695.248-1.29.173-1.414z"/></svg>
  </a>

  <script>
    const db = window.db;
    const auth = window.auth;
    const qs = s => document.querySelector(s);
    
    let CURRENT_YIL = null;
    let ramazanAyari = null;
    let kayitlar = [];
    let tutarSecenekleri = [];
    let currentUser = null;

    // --- GERÄ° SAYIM ---
    setInterval(() => {
      const now = new Date();
      const target = new Date(); target.setHours(19,30,0);
      let diff = target - now;
      if(diff < 0) diff += 86400000;
      const h = Math.floor(diff/3600000);
      const m = Math.floor((diff%3600000)/60000);
      qs('#countdownDisplay').innerText = `${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}`;
    }, 1000);

    // --- BAÅžLANGIÃ‡ ---
    auth.onAuthStateChanged(async (user) => {
      if (!user) { window.location.href = '../../index.html'; return; }
      currentUser = user;
      await loadAktifRamazan();
    });

    async function loadAktifRamazan() {
      try {
        // YÄ±llarÄ± Ã‡ek
        const snap = await db.collection('ramazan_serif').doc('ayarlar').collection('yillar').orderBy('yil', 'desc').get();
        const selYil = qs('#selYil');
        selYil.innerHTML = '';
        
        let activeDoc = null;
        snap.docs.forEach(doc => {
          const d = doc.data();
          const opt = document.createElement('option');
          opt.value = d.yil;
          opt.innerText = d.yil + (d.aktif ? ' (Aktif)' : '');
          if(d.aktif) { opt.selected = true; activeDoc = d; }
          selYil.appendChild(opt);
        });

        // Aktif yoksa sonuncuyu al
        if(!activeDoc && snap.docs.length > 0) activeDoc = snap.docs[0].data();
        if(activeDoc) setRamazanData(activeDoc);

        // YÄ±l DeÄŸiÅŸimi
        selYil.addEventListener('change', () => {
          const selectedYear = parseInt(selYil.value);
          const selectedDoc = snap.docs.find(d => d.data().yil === selectedYear);
          if(selectedDoc) setRamazanData(selectedDoc.data());
        });

      } catch (e) { console.error('Ramazan ayarÄ± yÃ¼klenemedi', e); }
    }

    async function setRamazanData(data) {
      CURRENT_YIL = data.yil;
      ramazanAyari = data;
      await loadTutarSecenekleri();
      loadKayitlar();
    }

    // --- 3. DÃœZELTME: TUTAR YÃœKLEME (Fallback ile) ---
    async function loadTutarSecenekleri() {
      const container = qs('#priceChips');
      container.innerHTML = '<div class="chip">YÃ¼kleniyor...</div>';
      tutarSecenekleri = [];

      try {
        const snap = await db.collection('ramazan_serif').doc(String(CURRENT_YIL)).collection('tutar_secenekleri').where('aktif', '==', true).orderBy('sira').get();
        tutarSecenekleri = snap.docs.map(d => d.data());
      } catch(e) { console.error('Tutar hatasÄ±:', e); }

      // EÄŸer veritabanÄ± boÅŸsa veya hata varsa varsayÄ±lanlarÄ± gÃ¶ster (Sistem bozulmasÄ±n)
      if(tutarSecenekleri.length === 0) {
        tutarSecenekleri = [
          {tutar: 250, label: 'Standart'},
          {tutar: 500, label: 'Tam'},
          {tutar: 1000, label: 'Ã–zel'}
        ];
      }
      renderPriceChips();
    }

    function renderPriceChips() {
      const container = qs('#priceChips');
      container.innerHTML = '';
      tutarSecenekleri.forEach((t, i) => {
        const chip = document.createElement('div');
        chip.className = `chip ${i===0 ? 'selected' : ''}`;
        chip.innerText = `${t.tutar}â‚º`;
        chip.onclick = () => selectChip('price', t.tutar, chip);
        container.appendChild(chip);
      });
      // Ä°lk deÄŸeri ata
      if(tutarSecenekleri.length > 0) qs('#fPrice').value = tutarSecenekleri[0].tutar;
    }

    function loadKayitlar() {
      db.collection('ramazan_serif').doc(String(CURRENT_YIL)).collection('kayitlar')
        .onSnapshot(snap => {
          kayitlar = snap.docs.map(d => ({id: d.id, ...d.data()}));
          renderAllViews();
        });
    }

    function renderAllViews() {
      renderTimeline(); // Mobil
      renderDesktopCalendar(); // MasaÃ¼stÃ¼
    }

    // --- MOBÄ°L TIMELINE ---
    function renderTimeline() {
      const container = qs('#mobileView');
      container.innerHTML = '';

      const basParts = ramazanAyari.baslangic.split('-');
      const bitParts = ramazanAyari.bitis.split('-');
      const start = new Date(basParts[0], basParts[1]-1, basParts[2], 12, 0, 0);
      const end = new Date(bitParts[0], bitParts[1]-1, bitParts[2], 12, 0, 0);
      
      let current = new Date(start);
      let dayCounter = 1;

      while(current <= end) {
        const dateStr = current.toISOString().slice(0,10);
        const dayRecs = kayitlar.filter(k => {
           // Tarih parse gÃ¼venliÄŸi
           let kStr = '';
           if(k.tarih.toDate) kStr = k.tarih.toDate().toISOString().slice(0,10);
           else if(typeof k.tarih === 'string') kStr = k.tarih.slice(0,10);
           return kStr === dateStr;
        });

        const iftarCount = dayRecs.filter(k => k.tip === 'iftar').length;
        const sahurCount = dayRecs.filter(k => k.tip === 'sahur').length;

        let statusClass = 'status-green';
        let statusText = 'MÃ¼sait';
        if(iftarCount + sahurCount >= 5) { statusClass = 'status-orange'; statusText = 'Doluyor'; }
        
        const card = document.createElement('div');
        card.className = `day-card ${statusClass}`;
        const dStr = dateStr; 
        card.onclick = () => openFormModal(dStr);

        card.innerHTML = `
          <div class="dc-date">
            <span class="dc-day-num">${current.getDate()}</span>
            <span class="dc-day-name">${current.toLocaleDateString('tr-TR', {weekday:'short'})}</span>
          </div>
          <div class="dc-info">
            <div class="dc-ramazan">${dayCounter}. GÃœN</div>
            <div class="dc-status">${statusText}</div>
            <div class="dc-details">
               <span class="badge-mini" style="background:#f39c12; padding:2px 6px; border-radius:4px; color:white; font-size:10px">Ä°ftar: ${iftarCount}</span>
               <span class="badge-mini" style="background:#3498db; padding:2px 6px; border-radius:4px; color:white; font-size:10px">Sahur: ${sahurCount}</span>
            </div>
          </div>
          <div class="dc-action">+</div>
        `;
        container.appendChild(card);

        current.setDate(current.getDate() + 1);
        dayCounter++;
      }
    }

    // --- MASAÃœSTÃœ TAKVÄ°M ---
    function renderDesktopCalendar() {
      const container = qs('#desktopView');
      container.innerHTML = '';

      const basParts = ramazanAyari.baslangic.split('-');
      const start = new Date(basParts[0], basParts[1]-1, basParts[2]);
      const monthStart = new Date(start.getFullYear(), start.getMonth(), 1);
      
      // BoÅŸ gÃ¼nler
      const firstDay = (monthStart.getDay() + 6) % 7; // Pzt baÅŸlasÄ±n
      for(let i=0; i<firstDay; i++) {
        const empty = document.createElement('div'); empty.className='cal-cell empty'; container.appendChild(empty);
      }

      // Basit mantÄ±k: Sadece Ramazan gÃ¼nlerini doldurmuyorum, 35 gÃ¼nlÃ¼k bir Ä±zgara yapÄ±yorum demo iÃ§in
      // GerÃ§ekte ayÄ±n gÃ¼nleri dÃ¶nmeli. Buraya mobil akÄ±ÅŸ mantÄ±ÄŸÄ±nÄ± grid'e uyarlÄ±yorum:
      
      const bitParts = ramazanAyari.bitis.split('-');
      const end = new Date(bitParts[0], bitParts[1]-1, bitParts[2], 12, 0, 0);
      let current = new Date(start);
      current.setHours(12,0,0,0);

      while(current <= end) {
        const dateStr = current.toISOString().slice(0,10);
        const dayRecs = kayitlar.filter(k => {
           let kStr = '';
           if(k.tarih.toDate) kStr = k.tarih.toDate().toISOString().slice(0,10);
           else if(typeof k.tarih === 'string') kStr = k.tarih.slice(0,10);
           return kStr === dateStr;
        });
        
        const cell = document.createElement('div');
        cell.className = 'cal-cell';
        const dStr = dateStr;
        cell.onclick = () => openFormModal(dStr);

        cell.innerHTML = `
          <div class="cc-header">
             <span class="cc-num">${current.getDate()}</span>
             <span class="cc-day">${current.toLocaleDateString('tr-TR', {weekday:'long'})}</span>
          </div>
          <div class="cc-badges">
             <div class="cc-badge cc-iftar">ðŸŒ™ Ä°ftar: ${dayRecs.filter(k=>k.tip==='iftar').length}</div>
             <div class="cc-badge cc-sahur">ðŸŒŸ Sahur: ${dayRecs.filter(k=>k.tip==='sahur').length}</div>
          </div>
        `;
        container.appendChild(cell);
        current.setDate(current.getDate() + 1);
      }
    }

    // --- FORM FONKSÄ°YONLARI ---
    function openFormModal(dateStr) {
      qs('#fDate').value = dateStr;
      qs('#fDateDisplay').innerText = new Date(dateStr).toLocaleDateString('tr-TR', {dateStyle:'full'});
      qs('#fName').value = '';
      qs('#fGuest').value = 0; 
      qs('#fGuestVal').innerText = '0';
      qs('#fNote').value = '';
      qs('#formModal').classList.add('open');
    }

    function closeModal() { qs('#formModal').classList.remove('open'); }
    function closeReceipt() { qs('#receiptModal').classList.remove('open'); }

    function selectChip(group, val, el) {
      el.parentElement.querySelectorAll('.chip').forEach(c => c.classList.remove('selected'));
      el.classList.add('selected');
      if(group === 'type') qs('#fType').value = val;
      if(group === 'price') qs('#fPrice').value = val;
    }

    function stepGuest(n) {
      let v = parseInt(qs('#fGuest').value) + n;
      if(v < 0) v = 0;
      qs('#fGuest').value = v;
      qs('#fGuestVal').innerText = v;
    }

    qs('#smartForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = e.target.querySelector('button[type="submit"]');
      btn.disabled = true; btn.innerText = 'Kaydediliyor...';

      const tarihStr = qs('#fDate').value;
      const tParts = tarihStr.split('-');
      const dbDate = new Date(tParts[0], tParts[1]-1, tParts[2], 12, 0, 0);

      const data = {
        tarih: dbDate,
        tip: qs('#fType').value,
        tutar: parseInt(qs('#fPrice').value),
        sahip: qs('#fName').value,
        musafirAdedi: parseInt(qs('#fGuest').value),
        not: qs('#fNote').value,
        personelUid: currentUser.uid,
        personel: currentUser.email,
        yil: CURRENT_YIL,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      try {
        await db.collection('ramazan_serif').doc(String(CURRENT_YIL)).collection('kayitlar').add(data);
        closeModal();
        qs('#rName').innerText = data.sahip;
        qs('#rDate').innerText = dbDate.toLocaleDateString('tr-TR');
        qs('#rPrice').innerText = data.tutar + 'â‚º';
        qs('#receiptModal').classList.add('open');
      } catch(err) {
        alert('Hata: ' + err.message);
      } finally {
        btn.disabled = false; btn.innerText = 'KAYDET';
      }
    });
  </script>
</body>
</html>