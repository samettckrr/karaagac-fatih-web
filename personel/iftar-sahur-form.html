<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Ramazan Takip Sistemi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover"/>
  
  <meta name="theme-color" content="#324960">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="icon" type="image/png" href="../img/logo.png" />

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="../../js/firebase/firebase-init.js"></script>

  <style>
    :root {
      --primary: #324960; --accent: #e67e22;
      --success: #27ae60; --danger: #c0392b; --warning: #f39c12;
      --bg: #f0f2f5; --card: #ffffff; --text: #2c3e50; --border: #e9ecef;
      --nav-height: 65px;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { 
      margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg); color: var(--text); padding-bottom: 80px;
    }

    /* --- HEADER --- */
    .hero-header {
      background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
      color: white; padding: 15px 20px 25px 20px; border-radius: 0 0 25px 25px;
      position: relative; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      margin-bottom: 10px;
    }
    .top-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    
    /* Geri D√∂n Butonu */
    .back-btn {
      display: flex; align-items: center; gap: 6px;
      background: rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 20px;
      color: white; text-decoration: none; font-size: 13px; font-weight: 600;
      transition: 0.2s; backdrop-filter: blur(4px);
    }
    .back-btn:hover { background: rgba(255,255,255,0.3); }

    .year-selector {
      background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);
      color: white; padding: 5px 10px; border-radius: 15px; font-size: 12px; font-weight: 600;
      appearance: none; outline: none; cursor: pointer;
    }
    .year-selector option { color: #333; }


    /* --- LAYOUT CONTAINER --- */
    .main-container {
      max-width: 1200px; margin: 0 auto; padding: 20px; margin-top: 10px;
    }

    /* --- 1. MOBƒ∞L G√ñR√úN√úM (Timeline) --- */
    .timeline-view { display: block; } /* Mobilde varsayƒ±lan */
    .calendar-view { display: none; }  /* Mobilde gizli */

    .day-card {
      background: var(--card); border-radius: 16px; margin-bottom: 12px;
      padding: 15px; display: flex; justify-content: space-between; align-items: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04); border-left: 5px solid transparent;
      transition: transform 0.1s; cursor: pointer;
    }
    .day-card:active { transform: scale(0.98); }
    
    .status-green { border-left-color: var(--success); }
    .status-orange { border-left-color: var(--warning); }
    .status-red { border-left-color: var(--danger); }

    .dc-date { display: flex; flex-direction: column; align-items: center; min-width: 50px; border-right: 1px solid #eee; padding-right: 10px; margin-right: 10px; }
    .dc-day-num { font-size: 24px; font-weight: 800; line-height: 1; }
    .dc-day-name { font-size: 10px; text-transform: uppercase; color: #7f8c8d; font-weight: 600; }
    .dc-info { flex: 1; }
    .dc-ramazan { font-size: 11px; color: var(--accent); font-weight: 700; text-transform: uppercase; }
    .dc-status { font-size: 13px; font-weight: 600; color: #34495e; }
    .dc-action { font-size: 24px; color: var(--primary); font-weight: 300; }

    /* --- 2. MASA√úST√ú G√ñR√úN√úM (Responsive Grid) --- */
    @media (min-width: 768px) {
      /* Alt men√º t√ºm cihazlarda g√∂r√ºns√ºn */
      body { padding-bottom: var(--nav-height); }
      
      /* Mobil g√∂r√ºn√ºm√º de g√∂ster */
      .timeline-view { display: block; } /* Mobil g√∂r√ºn√ºm√º de g√∂ster */
      .calendar-view { display: none; } /* Masa√ºst√º takvimi gizle */
      
      /* Masa√ºst√º Takvim Kartƒ± */
      .cal-cell {
        background: white; border-radius: 12px; padding: 10px; min-height: 100px;
        border: 1px solid #e0e0e0; cursor: pointer; transition: 0.2s;
        display: flex; flex-direction: column; justify-content: space-between;
      }
      .cal-cell:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-color: var(--primary); }
      .cal-cell.empty { background: transparent; border: none; cursor: default; }
      
      .cc-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
      .cc-num { font-weight: 800; font-size: 18px; color: #2c3e50; }
      .cc-day { font-size: 12px; color: #95a5a6; }
      
      .cc-badges { display: flex; flex-direction: column; gap: 3px; }
      .cc-badge { font-size: 11px; padding: 3px 6px; border-radius: 4px; color: white; text-align: center; }
      .cc-iftar { background: var(--accent); }
      .cc-sahur { background: #3498db; }
      .cc-full { opacity: 0.5; text-decoration: line-through; }
      .cal-cell.cal-green { border-left: 3px solid var(--success); }
      .cal-cell.cal-orange { border-left: 3px solid var(--warning); }
      .cal-cell.cal-red { border-left: 3px solid var(--danger); }
    }

    /* --- MODAL & FORM --- */
    .modal {
      position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000;
      display: none; align-items: center; justify-content: center; backdrop-filter: blur(3px);
      padding: 20px;
    }
    .modal.open { display: flex; }
    .modal-sheet {
      background: #fff; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto;
      border-radius: 20px; padding: 25px 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      animation: zoomIn 0.2s ease-out;
      margin: 20px;
    }
    @keyframes zoomIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    
    .form-label { font-size: 13px; font-weight: 600; color: #7f8c8d; margin-bottom: 8px; display: block; }
    .chip-group { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; }
    .chip {
      padding: 10px 16px; background: #f1f2f6; border-radius: 10px; border: 2px solid transparent;
      font-size: 14px; font-weight: 600; color: #2c3e50; white-space: nowrap; cursor: pointer;
    }
    .chip.selected { background: #e8f4fd; border-color: var(--primary); color: var(--primary); }
    .chip.disabled { opacity: 0.5; cursor: not-allowed !important; }
    
    .stepper { display: flex; align-items: center; gap: 15px; }
    .step-btn { width: 40px; height: 40px; border-radius: 10px; background: #f1f2f6; border: none; font-size: 20px; font-weight: bold; color: var(--primary); cursor: pointer; }
    .step-val { font-size: 18px; font-weight: bold; width: 30px; text-align: center; }

    .full-input { width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 10px; font-size: 15px; background: #f9f9f9; }
    .full-btn { width: 100%; padding: 15px; border-radius: 12px; border: none; font-size: 16px; font-weight: 700; cursor: pointer; margin-top: 10px; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-secondary { background: #f1f2f6; color: #7f8c8d; }

    /* BOTTOM NAV (Mobil ƒ∞√ßin) */
    .bottom-nav {
      position: fixed; bottom: 0; left: 0; right: 0; height: var(--nav-height);
      background: var(--card); box-shadow: 0 -2px 20px rgba(0,0,0,0.05);
      display: flex; justify-content: space-around; align-items: center; z-index: 100;
      padding-bottom: env(safe-area-inset-bottom);
    }
    .nav-btn {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      color: #95a5a6; font-size: 10px; font-weight: 600; gap: 4px; background: none; border: none; width: 100%; height: 100%;
    }
    .nav-btn.active { color: var(--primary); }
    .nav-btn svg { width: 24px; height: 24px; fill: currentColor; }

  </style>
</head>
<body>

  <div class="hero-header">
    <div class="top-nav">
      <a href="../panel.html" class="back-btn">
        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
        Panele D√∂n
      </a>
      
      <select id="selYil" class="year-selector">
        <option value="">Yƒ±l...</option>
      </select>
    </div>
    
    <div style="text-align:center; margin-top:10px;">
      <div style="font-size:18px; font-weight:600; opacity:0.9;">Ramazan-ƒ± ≈ûerif</div>
    </div>
  </div>

  <div class="main-container">
    
    <div id="mobileView" class="timeline-view">
      <div style="text-align:center; padding:20px; color:#999">Y√ºkleniyor...</div>
    </div>

    <div id="desktopView" class="calendar-view">
      </div>

  </div>

  <!-- G√ºn Kayƒ±tlarƒ± √ñnizleme Modalƒ± -->
  <div id="dayRecordsModal" class="modal">
    <div class="modal-sheet" style="max-width:600px;">
      <h3 style="margin:0 0 15px 0; font-size:18px; font-weight:600;">G√ºn Kayƒ±tlarƒ±</h3>
      <div id="dayRecordsContent" style="max-height:60vh; overflow-y:auto; margin-bottom:15px;"></div>
      <div style="display:flex; gap:10px;">
        <button type="button" class="full-btn btn-primary" onclick="openFormModalFromDay()" style="flex:1;">+ Yeni Kayƒ±t Ekle</button>
        <button type="button" class="full-btn btn-secondary" onclick="closeDayRecordsModal()" style="flex:1;">Kapat</button>
      </div>
    </div>
  </div>

  <div id="formModal" class="modal">
    <div class="modal-sheet">
      <h3 style="margin:0 0 15px 0; font-size:18px; font-weight:600;">Yeni Kayƒ±t</h3>
      <form id="smartForm">
        <input type="hidden" id="fDate">
        
        <div id="fDateDisplay" style="font-size:14px; margin-bottom:12px; color:var(--primary); text-align:center; padding:8px; border-radius:6px; background:#f8f9fa;"></div>

        <label class="form-label" style="margin-top:0;">Kayƒ±t Tipi</label>
        <div class="chip-group" id="typeChips">
          <div class="chip selected" onclick="selectChip('type', 'iftar', this)">üåô ƒ∞ftar</div>
          <div class="chip" onclick="selectChip('type', 'sahur', this)">üåü Sahur</div>
        </div>
        <input type="hidden" id="fType" value="iftar">

        <label class="form-label" style="margin-top:12px;">Tutar</label>
        <div class="chip-group" id="priceChips">
          <div class="chip">Y√ºkleniyor...</div>
        </div>
        <input type="hidden" id="fPrice">

        <label class="form-label" style="margin-top:12px;">ƒ∞ftar Sahibi</label>
        <input type="text" id="fName" class="full-input" placeholder="Ad Soyad" required>

        <label class="form-label" style="margin-top:12px;">M√ºsafir</label>
        <div class="stepper">
          <button type="button" class="step-btn" onclick="stepGuest(-1)">-</button>
          <span class="step-val" id="fGuestVal">0</span>
          <button type="button" class="step-btn" onclick="stepGuest(1)">+</button>
        </div>
        <input type="hidden" id="fGuest" value="0">

        <label class="form-label" style="margin-top:12px;">Mahal</label>
        <div class="chip-group" id="mahalChips" style="flex-wrap:wrap;">
          <div class="chip">Y√ºkleniyor...</div>
        </div>
        <input type="hidden" id="fMahal">

        <label class="form-label" style="margin-top:12px;">ƒ∞≈ütirak</label>
        <div class="chip-group" id="istirakChips">
          <div class="chip selected" onclick="selectChip('istirak', true, this)">‚úì Evet</div>
          <div class="chip" onclick="selectChip('istirak', false, this)">‚úó Hayƒ±r</div>
        </div>
        <input type="hidden" id="fIstirak" value="true">

        <label class="form-label" style="margin-top:12px;">Not</label>
        <input type="text" id="fNote" class="full-input" placeholder="ƒ∞steƒüe baƒülƒ±">

        <div style="display:flex; gap:10px; margin-top:15px;">
          <button type="submit" class="full-btn btn-primary" style="flex:1;">√ñNƒ∞ZLE</button>
          <button type="button" class="full-btn btn-secondary" onclick="closeModal()" style="flex:1;">ƒ∞ptal</button>
        </div>
      </form>
    </div>
  </div>

  <!-- √ñnizleme Modalƒ± -->
  <div id="previewModal" class="modal">
    <div class="modal-sheet">
      <h3 style="margin:0 0 20px 0; font-size:20px;">Kayƒ±t √ñnizleme</h3>
      <div id="previewContent" style="background:#f9f9f9; padding:15px; border-radius:10px; margin-bottom:20px;"></div>
      <button type="button" class="full-btn btn-primary" onclick="confirmSave()">KAYDET</button>
      <button type="button" class="full-btn btn-secondary" onclick="closePreviewModal()">Geri D√∂n</button>
    </div>
  </div>

  <!-- D√ºzenleme Modalƒ± -->
  <div id="editModal" class="modal">
    <div class="modal-sheet">
      <h3 style="margin:0 0 15px 0; font-size:18px; font-weight:600;">Kayƒ±t D√ºzenle</h3>
      <form id="editForm">
        <input type="hidden" id="editRecordId">
        
        <div id="editDateDisplay" style="font-size:14px; margin-bottom:12px; color:var(--primary); text-align:center; padding:8px; border-radius:6px; background:#f8f9fa;"></div>

        <label class="form-label" style="margin-top:0;">ƒ∞ftar Sahibi</label>
        <input type="text" id="editSahip" class="full-input" placeholder="Ad Soyad" required>

        <label class="form-label" style="margin-top:12px;">M√ºsafir</label>
        <div class="stepper">
          <button type="button" class="step-btn" onclick="stepEditGuest(-1)">-</button>
          <span class="step-val" id="editGuestVal">0</span>
          <button type="button" class="step-btn" onclick="stepEditGuest(1)">+</button>
        </div>
        <input type="hidden" id="editGuest" value="0">

        <div style="display:flex; gap:10px; margin-top:15px;">
          <button type="submit" class="full-btn btn-primary" style="flex:1;">KAYDET</button>
          <button type="button" class="full-btn btn-secondary" onclick="closeEditModal()" style="flex:1;">ƒ∞ptal</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Bildirim Modalƒ± -->
  <div id="alertModal" class="modal">
    <div class="modal-sheet" style="max-width:400px;">
      <div id="alertContent" style="margin-bottom:20px; text-align:center;"></div>
      <button type="button" class="full-btn btn-primary" onclick="closeAlertModal()">Tamam</button>
    </div>
  </div>

  <!-- Onay Modalƒ± -->
  <div id="confirmModal" class="modal">
    <div class="modal-sheet" style="max-width:400px;">
      <div id="confirmContent" style="margin-bottom:20px; text-align:center;"></div>
      <div style="display:flex; gap:10px;">
        <button type="button" class="full-btn btn-primary" onclick="confirmYes()" style="flex:1;">Evet</button>
        <button type="button" class="full-btn btn-secondary" onclick="closeConfirmModal()" style="flex:1;">Hayƒ±r</button>
      </div>
    </div>
  </div>

  <!-- Takvimim G√∂r√ºn√ºm√º -->
  <div id="takvimimView" style="display:none;">
    <div class="main-container">
      <h3 style="padding:20px; margin:0; font-size:18px; color:var(--primary);">Benim Kayƒ±tlarƒ±m</h3>
      <div id="myRecordsList" style="padding:0 20px 20px;">
        <div style="text-align:center; padding:20px; color:#999">Y√ºkleniyor...</div>
      </div>
    </div>
  </div>

  <nav class="bottom-nav">
    <button class="nav-btn active" onclick="switchView('takvim')">
      <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
      <span>Takvim</span>
    </button>
    <button class="nav-btn" onclick="switchView('takvimim')">
      <svg viewBox="0 0 24 24"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/></svg>
      <span>Takvimim</span>
    </button>
  </nav>


  <script>
    const db = window.db;
    const auth = window.auth;
    const qs = s => document.querySelector(s);
    
    let CURRENT_YIL = null;
    let ramazanAyari = null;
    let kayitlar = [];
    let tutarSecenekleri = [];
    let currentUser = null;
    let kapasiteAyarlari = { genel: null, gunluk: [] };
    let previewData = null;
    let mahaller = [];
    let confirmCallback = null;


    // --- BA≈ûLANGI√á ---
    let currentPersonelAdi = null;
    
    auth.onAuthStateChanged(async (user) => {
      if (!user) { window.location.href = '../../index.html'; return; }
      currentUser = user;
      
      // Personel adƒ±nƒ± y√ºkle
      try {
        const uSnap = await db.collection('kullanicilar').doc(user.uid).get();
        const uData = uSnap.exists ? uSnap.data() : {};
        currentPersonelAdi = uData.adSoyad || user.displayName || user.email || 'Bilinmiyor';
      } catch(e) {
        currentPersonelAdi = user.displayName || user.email || 'Bilinmiyor';
      }
      
      await loadAktifRamazan();
    });

    async function loadAktifRamazan() {
      try {
        // Yƒ±llarƒ± √áek
        const snap = await db.collection('ramazan_serif').doc('ayarlar').collection('yillar').orderBy('yil', 'desc').get();
        const selYil = qs('#selYil');
        selYil.innerHTML = '';
        
        let activeDoc = null;
        snap.docs.forEach(doc => {
          const d = doc.data();
          const opt = document.createElement('option');
          opt.value = d.yil;
          opt.innerText = d.yil + (d.aktif ? ' (Aktif)' : '');
          if(d.aktif) { opt.selected = true; activeDoc = d; }
          selYil.appendChild(opt);
        });

        // Aktif yoksa sonuncuyu al
        if(!activeDoc && snap.docs.length > 0) activeDoc = snap.docs[0].data();
        if(activeDoc) setRamazanData(activeDoc);

        // Yƒ±l Deƒüi≈üimi
        selYil.addEventListener('change', () => {
          const selectedYear = parseInt(selYil.value);
          const selectedDoc = snap.docs.find(d => d.data().yil === selectedYear);
          if(selectedDoc) setRamazanData(selectedDoc.data());
        });

      } catch (e) { console.error('Ramazan ayarƒ± y√ºklenemedi', e); }
    }

    async function setRamazanData(data) {
      CURRENT_YIL = data.yil;
      ramazanAyari = data;
      await loadTutarSecenekleri();
      await loadKapasiteAyarlari();
      await loadMahaller();
      loadKayitlar();
    }

    // Mahal y√ºkleme
    async function loadMahaller() {
      try {
        const snap = await db.collection('ramazan_serif').doc('ayarlar').collection('mahaller').orderBy('adi', 'asc').get();
        mahaller = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderMahaller();
      } catch(e) {
        console.error('Mahaller y√ºklenemedi:', e);
        mahaller = [];
        renderMahaller();
      }
    }

    // Mahal render (m√ºsafir adedine g√∂re filtrele)
    function renderMahaller() {
      const container = qs('#mahalChips');
      if(!container) return; // Element hen√ºz DOM'da yoksa √ßƒ±k
      
      const musafirAdedi = parseInt(qs('#fGuest').value) || 0;
      
      if(mahaller.length === 0) {
        container.innerHTML = '<div class="chip" style="opacity:0.5;">Mahal bulunamadƒ±</div>';
        return;
      }

      container.innerHTML = '';
      mahaller.forEach(m => {
        const minMusafir = m.minMusafir || 1;
        const maxMusafir = m.maxMusafir || 9999;
        const uyumlu = musafirAdedi >= minMusafir && musafirAdedi <= maxMusafir;
        
        const chip = document.createElement('div');
        chip.className = `chip ${uyumlu ? '' : 'disabled'}`;
        chip.style.opacity = uyumlu ? '1' : '0.5';
        chip.style.cursor = uyumlu ? 'pointer' : 'not-allowed';
        chip.style.position = 'relative';
        
        if(uyumlu) {
          chip.onclick = () => selectChip('mahal', m.id, chip);
        }
        
        chip.innerHTML = `
          ${m.adi}
          ${!uyumlu ? `<span style="font-size:10px; margin-left:5px; color:#999;">(${minMusafir}-${maxMusafir})</span>` : ''}
        `;
        
        container.appendChild(chip);
      });
      
      // ƒ∞lk uyumlu mahali se√ß
      const firstUyumlu = mahaller.find(m => {
        const minMusafir = m.minMusafir || 1;
        const maxMusafir = m.maxMusafir || 9999;
        return musafirAdedi >= minMusafir && musafirAdedi <= maxMusafir;
      });
      if(firstUyumlu) {
        qs('#fMahal').value = firstUyumlu.id;
        const firstChip = container.querySelector('.chip:not(.disabled)');
        if(firstChip) firstChip.classList.add('selected');
      }
    }

    // Modal bildirim fonksiyonlarƒ±
    function showAlert(message, type = 'info') {
      const content = qs('#alertContent');
      const icon = type === 'error' ? '‚ùå' : type === 'success' ? '‚úÖ' : '‚ÑπÔ∏è';
      const color = type === 'error' ? 'var(--danger)' : type === 'success' ? 'var(--success)' : 'var(--primary)';
      content.innerHTML = `<div style="font-size:48px; margin-bottom:15px;">${icon}</div><div style="font-size:16px; color:${color}; font-weight:600;">${message}</div>`;
      qs('#alertModal').classList.add('open');
    }

    function closeAlertModal() {
      qs('#alertModal').classList.remove('open');
    }

    function showConfirm(message, callback) {
      confirmCallback = callback;
      const content = qs('#confirmContent');
      content.innerHTML = `<div style="font-size:48px; margin-bottom:15px;">‚ùì</div><div style="font-size:16px; color:var(--text); font-weight:600;">${message}</div>`;
      qs('#confirmModal').classList.add('open');
    }

    function confirmYes() {
      if(confirmCallback) {
        confirmCallback();
        confirmCallback = null;
      }
      closeConfirmModal();
    }

    function closeConfirmModal() {
      qs('#confirmModal').classList.remove('open');
      confirmCallback = null;
    }

    // --- KAPASƒ∞TE AYARLARI Y√úKLEME ---
    async function loadKapasiteAyarlari() {
      try {
        // Genel kapasite
        const genelDoc = await db.collection('ramazan_serif').doc(String(CURRENT_YIL)).collection('ayarlar').doc('genel').get();
        if(genelDoc.exists) {
          kapasiteAyarlari.genel = genelDoc.data();
        } else {
          kapasiteAyarlari.genel = { iftarMax: null, sahurMax: null };
        }

        // G√ºnl√ºk kapasite ayarlarƒ±
        const gunlukSnap = await db.collection('ramazan_serif').doc(String(CURRENT_YIL)).collection('kapasite_ayarlari').get();
        kapasiteAyarlari.gunluk = gunlukSnap.docs.map(d => ({ id: d.id, ...d.data() }));
      } catch(e) {
        console.error('Kapasite ayarlarƒ± y√ºklenemedi:', e);
        kapasiteAyarlari.genel = { iftarMax: null, sahurMax: null };
        kapasiteAyarlari.gunluk = [];
      }
    }

    // G√ºn durumu belirleme (status renkleri i√ßin)
    function getDayStatus(tarihStr, iftarCount, sahurCount) {
      // G√ºnl√ºk kapasite kontrol√º
      const gunlukAyar = kapasiteAyarlari.gunluk.find(k => {
        let kTarih = '';
        if(k.tarih) {
          if(k.tarih.toDate) {
            kTarih = k.tarih.toDate().toISOString().slice(0,10);
          } else if(typeof k.tarih === 'string') {
            kTarih = k.tarih.slice(0,10);
          } else if(k.tarih instanceof Date) {
            kTarih = k.tarih.toISOString().slice(0,10);
          }
        }
        return kTarih === tarihStr;
      });

      let iftarMax = null;
      let sahurMax = null;
      
      if(gunlukAyar) {
        iftarMax = gunlukAyar.iftarMax;
        sahurMax = gunlukAyar.sahurMax;
      } else if(kapasiteAyarlari.genel) {
        iftarMax = kapasiteAyarlari.genel.iftarMax;
        sahurMax = kapasiteAyarlari.genel.sahurMax;
      }

      // Status belirleme
      let statusClass = 'status-green';
      let statusText = 'M√ºsait';
      
      const iftarDolu = iftarMax !== null && iftarMax !== undefined && iftarCount >= iftarMax;
      const sahurDolu = sahurMax !== null && sahurMax !== undefined && sahurCount >= sahurMax;
      
      if(iftarDolu && sahurDolu) {
        statusClass = 'status-red';
        statusText = 'Dolu';
      } else if(iftarDolu || sahurDolu) {
        statusClass = 'status-orange';
        statusText = 'Doluyor';
      } else if(iftarMax !== null || sahurMax !== null) {
        // Kapasite limiti var ama hen√ºz dolmamƒ±≈ü
        const iftarYuzde = iftarMax ? (iftarCount / iftarMax) * 100 : 0;
        const sahurYuzde = sahurMax ? (sahurCount / sahurMax) * 100 : 0;
        const maxYuzde = Math.max(iftarYuzde, sahurYuzde);
        if(maxYuzde >= 80) {
          statusClass = 'status-orange';
          statusText = 'Doluyor';
        }
      }

      return { class: statusClass, text: statusText };
    }

    // Kapasite kontrol√º
    function checkKapasite(tarihStr, tip) {
      const dayRecs = kayitlar.filter(k => {
        let kStr = '';
        if(k.tarih.toDate) kStr = k.tarih.toDate().toISOString().slice(0,10);
        else if(typeof k.tarih === 'string') kStr = k.tarih.slice(0,10);
        return kStr === tarihStr && k.tip === tip;
      });
      const mevcutSayi = dayRecs.length;

      // √ñnce g√ºnl√ºk kapasite kontrol√º
      const gunlukAyar = kapasiteAyarlari.gunluk.find(k => {
        let kTarih = '';
        if(k.tarih) {
          if(k.tarih.toDate) {
            kTarih = k.tarih.toDate().toISOString().slice(0,10);
          } else if(typeof k.tarih === 'string') {
            kTarih = k.tarih.slice(0,10);
          } else if(k.tarih instanceof Date) {
            kTarih = k.tarih.toISOString().slice(0,10);
          }
        }
        return kTarih === tarihStr;
      });

      let maxLimit = null;
      if(gunlukAyar) {
        maxLimit = tip === 'iftar' ? gunlukAyar.iftarMax : gunlukAyar.sahurMax;
      } else if(kapasiteAyarlari.genel) {
        maxLimit = tip === 'iftar' ? kapasiteAyarlari.genel.iftarMax : kapasiteAyarlari.genel.sahurMax;
      }

      if(maxLimit !== null && maxLimit !== undefined && mevcutSayi >= maxLimit) {
        return { allowed: false, message: `${tip === 'iftar' ? 'ƒ∞ftar' : 'Sahur'} kapasitesi dolmu≈ü! (Max: ${maxLimit})` };
      }

      return { allowed: true };
    }

    // --- TUTAR Y√úKLEME (Tip'e g√∂re filtreleme ile) ---
    async function loadTutarSecenekleri() {
      const container = qs('#priceChips');
      container.innerHTML = '<div class="chip">Y√ºkleniyor...</div>';
      tutarSecenekleri = [];

      try {
        const snap = await db.collection('ramazan_serif').doc(String(CURRENT_YIL)).collection('tutar_secenekleri').where('aktif', '==', true).get();
        const allTutarlar = snap.docs.map(d => d.data());
        // Sƒ±ralama
        allTutarlar.sort((a, b) => (a.sira || 0) - (b.sira || 0));
        tutarSecenekleri = allTutarlar;
      } catch(e) { 
        console.error('Tutar hatasƒ±:', e); 
      }

      // Eƒüer veritabanƒ± bo≈üsa veya hata varsa varsayƒ±lanlarƒ± g√∂ster
      if(tutarSecenekleri.length === 0) {
        tutarSecenekleri = [
          {tutar: 250, label: 'Standart', tip: null},
          {tutar: 500, label: 'Tam', tip: null},
          {tutar: 1000, label: '√ñzel', tip: null}
        ];
      }
      renderPriceChips();
    }

    function renderPriceChips() {
      const container = qs('#priceChips');
      container.innerHTML = '';
      const selectedType = qs('#fType').value;
      
      // Tip'e g√∂re filtrele: tip null ise genel (her ikisi i√ßin), aksi halde se√ßilen tip ile e≈üle≈ümeli
      const filteredTutarlar = tutarSecenekleri.filter(t => !t.tip || t.tip === selectedType || t.tip === null);
      
      if(filteredTutarlar.length === 0) {
        container.innerHTML = '<div class="chip" style="color:#999">Bu tip i√ßin tutar se√ßeneƒüi bulunamadƒ±</div>';
        qs('#fPrice').value = '';
        return;
      }

      filteredTutarlar.forEach((t, i) => {
        const chip = document.createElement('div');
        chip.className = `chip ${i===0 ? 'selected' : ''}`;
        chip.innerText = `${t.tutar}‚Ç∫${t.label ? ' - ' + t.label : ''}`;
        chip.onclick = () => selectChip('price', t.tutar, chip);
        container.appendChild(chip);
      });
      // ƒ∞lk deƒüeri ata
      if(filteredTutarlar.length > 0) qs('#fPrice').value = filteredTutarlar[0].tutar;
    }

    function loadKayitlar() {
      db.collection('ramazan_serif').doc(String(CURRENT_YIL)).collection('kayitlar')
        .onSnapshot(snap => {
          kayitlar = snap.docs.map(d => ({id: d.id, ...d.data()}));
          renderAllViews();
          // Takvimim g√∂r√ºn√ºm√º a√ßƒ±ksa g√ºncelle
          if(qs('#takvimimView').style.display !== 'none') {
            loadMyRecords();
          }
        });
    }

    function renderAllViews() {
      renderTimeline(); // Mobil
      renderDesktopCalendar(); // Masa√ºst√º
    }

    // --- MOBƒ∞L TIMELINE ---
    function renderTimeline() {
      const container = qs('#mobileView');
      container.innerHTML = '';

      const basParts = ramazanAyari.baslangic.split('-');
      const bitParts = ramazanAyari.bitis.split('-');
      const start = new Date(basParts[0], basParts[1]-1, basParts[2], 12, 0, 0);
      const end = new Date(bitParts[0], bitParts[1]-1, bitParts[2], 12, 0, 0);
      
      let current = new Date(start);
      let dayCounter = 1;

      while(current <= end) {
        const dateStr = current.toISOString().slice(0,10);
        const dayRecs = kayitlar.filter(k => {
           // Tarih parse g√ºvenliƒüi
           let kStr = '';
           if(k.tarih.toDate) kStr = k.tarih.toDate().toISOString().slice(0,10);
           else if(typeof k.tarih === 'string') kStr = k.tarih.slice(0,10);
           return kStr === dateStr;
        });

        const iftarCount = dayRecs.filter(k => k.tip === 'iftar').length;
        const sahurCount = dayRecs.filter(k => k.tip === 'sahur').length;

        // Kapasite kontrol√º ile status belirleme
        const statusInfo = getDayStatus(dateStr, iftarCount, sahurCount);
        const statusClass = statusInfo.class;
        const statusText = statusInfo.text;
        
        // Kapasite bilgisi
        const gunlukAyar = kapasiteAyarlari.gunluk.find(k => {
          let kTarih = '';
          if(k.tarih) {
            if(k.tarih.toDate) kTarih = k.tarih.toDate().toISOString().slice(0,10);
            else if(typeof k.tarih === 'string') kTarih = k.tarih.slice(0,10);
            else if(k.tarih instanceof Date) kTarih = k.tarih.toISOString().slice(0,10);
          }
          return kTarih === dateStr;
        });
        const iftarMax = gunlukAyar ? gunlukAyar.iftarMax : (kapasiteAyarlari.genel ? kapasiteAyarlari.genel.iftarMax : null);
        const sahurMax = gunlukAyar ? gunlukAyar.sahurMax : (kapasiteAyarlari.genel ? kapasiteAyarlari.genel.sahurMax : null);
        const iftarText = iftarMax !== null && iftarMax !== undefined ? `${iftarCount}/${iftarMax}` : iftarCount;
        const sahurText = sahurMax !== null && sahurMax !== undefined ? `${sahurCount}/${sahurMax}` : sahurCount;

        const card = document.createElement('div');
        card.className = `day-card ${statusClass}`;
        const dStr = dateStr; 
        card.onclick = () => showDayRecords(dStr);

        card.innerHTML = `
          <div class="dc-date">
            <span class="dc-day-num">${current.getDate()}</span>
            <span class="dc-day-name">${current.toLocaleDateString('tr-TR', {weekday:'short'})}</span>
          </div>
          <div class="dc-info">
            <div class="dc-ramazan">${dayCounter}. G√úN</div>
            <div class="dc-status">${statusText}</div>
            <div class="dc-details">
               <span class="badge-mini" style="background:#f39c12; padding:2px 6px; border-radius:4px; color:white; font-size:10px">ƒ∞ftar: ${iftarText}</span>
               <span class="badge-mini" style="background:#3498db; padding:2px 6px; border-radius:4px; color:white; font-size:10px">Sahur: ${sahurText}</span>
            </div>
          </div>
          <div class="dc-action">+</div>
        `;
        container.appendChild(card);

        current.setDate(current.getDate() + 1);
        dayCounter++;
      }
    }

    // --- MASA√úST√ú TAKVƒ∞M ---
    function renderDesktopCalendar() {
      const container = qs('#desktopView');
      container.innerHTML = '';

      const basParts = ramazanAyari.baslangic.split('-');
      const start = new Date(basParts[0], basParts[1]-1, basParts[2]);
      const monthStart = new Date(start.getFullYear(), start.getMonth(), 1);
      
      // Bo≈ü g√ºnler
      const firstDay = (monthStart.getDay() + 6) % 7; // Pzt ba≈ülasƒ±n
      for(let i=0; i<firstDay; i++) {
        const empty = document.createElement('div'); empty.className='cal-cell empty'; container.appendChild(empty);
      }

      // Basit mantƒ±k: Sadece Ramazan g√ºnlerini doldurmuyorum, 35 g√ºnl√ºk bir ƒ±zgara yapƒ±yorum demo i√ßin
      // Ger√ßekte ayƒ±n g√ºnleri d√∂nmeli. Buraya mobil akƒ±≈ü mantƒ±ƒüƒ±nƒ± grid'e uyarlƒ±yorum:
      
      const bitParts = ramazanAyari.bitis.split('-');
      const end = new Date(bitParts[0], bitParts[1]-1, bitParts[2], 12, 0, 0);
      let current = new Date(start);
      current.setHours(12,0,0,0);

      while(current <= end) {
        const dateStr = current.toISOString().slice(0,10);
        const dayRecs = kayitlar.filter(k => {
           let kStr = '';
           if(k.tarih.toDate) kStr = k.tarih.toDate().toISOString().slice(0,10);
           else if(typeof k.tarih === 'string') kStr = k.tarih.slice(0,10);
           return kStr === dateStr;
        });
        
        const iftarCount = dayRecs.filter(k => k.tip === 'iftar').length;
        const sahurCount = dayRecs.filter(k => k.tip === 'sahur').length;
        
        // Kapasite kontrol√º ile status belirleme
        const statusInfo = getDayStatus(dateStr, iftarCount, sahurCount);
        
        const cell = document.createElement('div');
        cell.className = `cal-cell ${statusInfo.class.replace('status-', 'cal-')}`;
        const dStr = dateStr;
        cell.onclick = () => showDayRecords(dStr);

        // Kapasite bilgisi
        const gunlukAyar = kapasiteAyarlari.gunluk.find(k => {
          let kTarih = '';
          if(k.tarih) {
            if(k.tarih.toDate) kTarih = k.tarih.toDate().toISOString().slice(0,10);
            else if(typeof k.tarih === 'string') kTarih = k.tarih.slice(0,10);
            else if(k.tarih instanceof Date) kTarih = k.tarih.toISOString().slice(0,10);
          }
          return kTarih === dateStr;
        });
        const iftarMax = gunlukAyar ? gunlukAyar.iftarMax : (kapasiteAyarlari.genel ? kapasiteAyarlari.genel.iftarMax : null);
        const sahurMax = gunlukAyar ? gunlukAyar.sahurMax : (kapasiteAyarlari.genel ? kapasiteAyarlari.genel.sahurMax : null);
        
        const iftarText = iftarMax !== null && iftarMax !== undefined ? `${iftarCount}/${iftarMax}` : iftarCount;
        const sahurText = sahurMax !== null && sahurMax !== undefined ? `${sahurCount}/${sahurMax}` : sahurCount;

        cell.innerHTML = `
          <div class="cc-header">
             <span class="cc-num">${current.getDate()}</span>
             <span class="cc-day">${current.toLocaleDateString('tr-TR', {weekday:'short'})}</span>
          </div>
          <div class="cc-badges">
             <div class="cc-badge cc-iftar ${iftarMax !== null && iftarCount >= iftarMax ? 'cc-full' : ''}">üåô ƒ∞ftar: ${iftarText}</div>
             <div class="cc-badge cc-sahur ${sahurMax !== null && sahurCount >= sahurMax ? 'cc-full' : ''}">üåü Sahur: ${sahurText}</div>
          </div>
        `;
        container.appendChild(cell);
        current.setDate(current.getDate() + 1);
      }
    }

    // --- FORM FONKSƒ∞YONLARI ---
    let selectedDateForForm = null;

    function showDayRecords(dateStr) {
      selectedDateForForm = dateStr;
      const dayRecs = kayitlar.filter(k => {
        let kStr = '';
        if(k.tarih.toDate) kStr = k.tarih.toDate().toISOString().slice(0,10);
        else if(typeof k.tarih === 'string') kStr = k.tarih.slice(0,10);
        return kStr === dateStr;
      });

      // Kayƒ±t sƒ±rasƒ±na g√∂re sƒ±rala (createdAt'e g√∂re)
      dayRecs.sort((a, b) => {
        const aTime = a.createdAt?.toDate ? a.createdAt.toDate().getTime() : (a.createdAt?.seconds || 0) * 1000;
        const bTime = b.createdAt?.toDate ? b.createdAt.toDate().getTime() : (b.createdAt?.seconds || 0) * 1000;
        return aTime - bTime; // En eski en √ºstte
      });

      const content = qs('#dayRecordsContent');
      const dateObj = new Date(dateStr);
      
      if(dayRecs.length === 0) {
        content.innerHTML = `<div style="text-align:center; padding:30px; color:#999;">
          <div style="font-size:48px; margin-bottom:10px;">üìÖ</div>
          <div>Bu g√ºn i√ßin hen√ºz kayƒ±t bulunmamaktadƒ±r</div>
        </div>`;
      } else {
        content.innerHTML = `
          <div style="font-size:14px; font-weight:600; color:var(--primary); margin-bottom:15px; padding-bottom:10px; border-bottom:1px solid #eee;">
            ${dateObj.toLocaleDateString('tr-TR', {dateStyle:'full'})}
          </div>
          <div style="display:flex; flex-direction:column; gap:10px;">
            ${dayRecs.map((k, idx) => {
              const tipLabel = k.tip === 'iftar' ? 'üåô ƒ∞ftar' : 'üåü Sahur';
              const mahalName = k.mahalId ? (mahaller.find(m => m.id === k.mahalId)?.adi || '') : '';
              const personelName = k.personelAdi || k.personel || 'Bilinmiyor';
              return `
                <div style="background:#f8f9fa; padding:12px; border-radius:8px; border-left:3px solid ${k.tip === 'iftar' ? 'var(--accent)' : '#3498db'};">
                  <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:8px;">
                    <div style="flex:1;">
                      <div style="font-weight:600; color:var(--text); margin-bottom:4px;">${idx + 1}. ${k.sahip}</div>
                      <div style="font-size:12px; color:#7f8c8d;">
                        ${tipLabel} ‚Ä¢ ${k.tutar}‚Ç∫
                        ${k.musafirAdedi > 0 ? ` ‚Ä¢ ${k.musafirAdedi} m√ºsafir` : ''}
                        ${mahalName ? ` ‚Ä¢ üèõÔ∏è ${mahalName}` : ''}
                        ${k.istirak ? ' ‚Ä¢ ‚úì ƒ∞≈ütirak' : ''}
                      </div>
                      <div style="font-size:11px; color:#95a5a6; margin-top:4px;">
                        üë§ Kaydeden: ${personelName}
                      </div>
                      ${k.not ? `<div style="font-size:12px; color:#95a5a6; margin-top:6px; font-style:italic;">üìù ${k.not}</div>` : ''}
                    </div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        `;
      }
      
      qs('#dayRecordsModal').classList.add('open');
    }

    function closeDayRecordsModal() {
      qs('#dayRecordsModal').classList.remove('open');
      selectedDateForForm = null;
    }

    function openFormModalFromDay() {
      const dateToOpen = selectedDateForForm; // √ñnce tarihi sakla
      closeDayRecordsModal();
      if(dateToOpen) {
        // Kƒ±sa bir gecikme ile modal a√ß (DOM g√ºncellemesi i√ßin)
        setTimeout(() => {
          openFormModal(dateToOpen);
        }, 100);
      }
    }

    function openFormModal(dateStr) {
      qs('#fDate').value = dateStr;
      qs('#fDateDisplay').innerText = new Date(dateStr).toLocaleDateString('tr-TR', {dateStyle:'full'});
      qs('#fName').value = '';
      qs('#fGuest').value = 0; 
      qs('#fGuestVal').innerText = '0';
      qs('#fNote').value = '';
      qs('#fMahal').value = '';
      qs('#fIstirak').value = 'true';
      // ƒ∞≈ütirak chip'lerini sƒ±fƒ±rla
      qs('#istirakChips').querySelectorAll('.chip').forEach((c, i) => {
        c.classList.remove('selected');
        if(i === 0) c.classList.add('selected');
      });
      renderMahaller(); // Mahalleri yeniden render et
      qs('#formModal').classList.add('open');
    }

    function closeModal() { qs('#formModal').classList.remove('open'); }

    function selectChip(group, val, el) {
      if(el.classList.contains('disabled')) return; // Disabled chip'leri se√ßilemez
      el.parentElement.querySelectorAll('.chip').forEach(c => c.classList.remove('selected'));
      el.classList.add('selected');
      if(group === 'type') {
        qs('#fType').value = val;
        // Tip deƒüi≈üince tutar se√ßeneklerini yeniden y√ºkle
        renderPriceChips();
      }
      if(group === 'price') qs('#fPrice').value = val;
      if(group === 'mahal') qs('#fMahal').value = val;
      if(group === 'istirak') qs('#fIstirak').value = val;
    }

    function stepGuest(n) {
      let v = parseInt(qs('#fGuest').value) + n;
      if(v < 0) v = 0;
      qs('#fGuest').value = v;
      qs('#fGuestVal').innerText = v;
      // M√ºsafir adedi deƒüi≈üince mahalleri yeniden render et
      renderMahaller();
    }

    qs('#smartForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const tarihStr = qs('#fDate').value;
      const tip = qs('#fType').value;
      const tutar = parseInt(qs('#fPrice').value);
      const sahip = qs('#fName').value.trim();
      const mahalId = qs('#fMahal').value;
      
      if(!sahip) {
        showAlert('L√ºtfen iftar sahibi adƒ±nƒ± giriniz', 'error');
        return;
      }

      if(!tutar || tutar <= 0) {
        showAlert('L√ºtfen ge√ßerli bir tutar se√ßiniz', 'error');
        return;
      }

      const musafirAdedi = parseInt(qs('#fGuest').value) || 0;
      if(mahalId) {
        const mahal = mahaller.find(m => m.id === mahalId);
        if(mahal) {
          const minMusafir = mahal.minMusafir || 1;
          const maxMusafir = mahal.maxMusafir || 9999;
          if(musafirAdedi < minMusafir || musafirAdedi > maxMusafir) {
            showAlert(`Se√ßilen mahal i√ßin m√ºsafir sayƒ±sƒ± ${minMusafir}-${maxMusafir} arasƒ±nda olmalƒ±dƒ±r`, 'error');
            return;
          }
        }
      }

      // Kapasite kontrol√º
      const kapasiteCheck = checkKapasite(tarihStr, tip);
      if(!kapasiteCheck.allowed) {
        showAlert(kapasiteCheck.message, 'error');
        return;
      }

      const tParts = tarihStr.split('-');
      const dbDate = new Date(tParts[0], tParts[1]-1, tParts[2], 12, 0, 0);

      previewData = {
        tarih: dbDate,
        tip: tip,
        tutar: tutar,
        sahip: sahip,
        musafirAdedi: musafirAdedi,
        mahalId: mahalId || null,
        mahal: mahalId ? (mahaller.find(m => m.id === mahalId)?.adi || null) : null,
        istirak: qs('#fIstirak').value === 'true',
        not: qs('#fNote').value.trim(),
        personelUid: currentUser.uid,
        personel: currentUser.email,
        personelAdi: currentPersonelAdi || 'Bilinmiyor',
        yil: CURRENT_YIL
      };

      // √ñnizleme g√∂ster
      showPreview();
    });

    function showPreview() {
      const content = qs('#previewContent');
      const tipLabel = previewData.tip === 'iftar' ? 'üåô ƒ∞ftar' : 'üåü Sahur';
      content.innerHTML = `
        <div style="margin-bottom:10px;"><strong>Tarih:</strong> ${previewData.tarih.toLocaleDateString('tr-TR', {dateStyle:'full'})}</div>
        <div style="margin-bottom:10px;"><strong>Tip:</strong> ${tipLabel}</div>
        <div style="margin-bottom:10px;"><strong>ƒ∞ftar Sahibi:</strong> ${previewData.sahip}</div>
        <div style="margin-bottom:10px;"><strong>Tutar:</strong> ${previewData.tutar}‚Ç∫</div>
        <div style="margin-bottom:10px;"><strong>M√ºsafir Sayƒ±sƒ±:</strong> ${previewData.musafirAdedi}</div>
        ${previewData.mahal ? `<div style="margin-bottom:10px;"><strong>Mahal:</strong> ${previewData.mahal}</div>` : ''}
        <div style="margin-bottom:10px;"><strong>ƒ∞≈ütirak:</strong> ${previewData.istirak ? '‚úì Evet' : '‚úó Hayƒ±r'}</div>
        ${previewData.not ? `<div style="margin-bottom:10px;"><strong>Not:</strong> ${previewData.not}</div>` : ''}
      `;
      qs('#previewModal').classList.add('open');
    }

    function closePreviewModal() {
      qs('#previewModal').classList.remove('open');
      previewData = null;
    }

    async function confirmSave() {
      if(!previewData) return;
      
      const btn = qs('#previewModal').querySelector('.btn-primary');
      btn.disabled = true;
      btn.innerText = 'Kaydediliyor...';

      try {
        const data = {
          ...previewData,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        await db.collection('ramazan_serif').doc(String(CURRENT_YIL)).collection('kayitlar').add(data);
        closePreviewModal();
        closeModal();
        
        // Ba≈üarƒ± mesajƒ±
        showAlert('Kayƒ±t ba≈üarƒ±yla eklendi!', 'success');
      } catch(err) {
        showAlert('Hata: ' + err.message, 'error');
      } finally {
        btn.disabled = false;
        btn.innerText = 'KAYDET';
      }
    }

    // Takvimim g√∂r√ºn√ºm√º
    function switchView(view) {
      const takvimBtn = document.querySelectorAll('.nav-btn')[0];
      const takvimimBtn = document.querySelectorAll('.nav-btn')[1];
      const mainContainer = qs('.main-container');
      const takvimimView = qs('#takvimimView');

      if(view === 'takvim') {
        takvimBtn.classList.add('active');
        takvimimBtn.classList.remove('active');
        if(mainContainer) mainContainer.style.display = 'block';
        takvimimView.style.display = 'none';
      } else {
        takvimBtn.classList.remove('active');
        takvimimBtn.classList.add('active');
        if(mainContainer) mainContainer.style.display = 'none';
        takvimimView.style.display = 'block';
        loadMyRecords();
      }
    }

    function loadMyRecords() {
      const container = qs('#myRecordsList');
      if(!currentUser) {
        container.innerHTML = '<div style="text-align:center; padding:20px; color:#999">Giri≈ü yapƒ±lmamƒ±≈ü</div>';
        return;
      }

      const myKayitlar = kayitlar
        .filter(k => k.personelUid === currentUser.uid)
        .sort((a, b) => {
          const aDate = a.tarih.toDate ? a.tarih.toDate() : new Date(a.tarih);
          const bDate = b.tarih.toDate ? b.tarih.toDate() : new Date(b.tarih);
          return aDate - bDate; // Eskiden yeniye
        });

      if(myKayitlar.length === 0) {
        container.innerHTML = '<div style="text-align:center; padding:20px; color:#999">Hen√ºz kayƒ±t bulunmamaktadƒ±r</div>';
        return;
      }

      container.innerHTML = '';
      myKayitlar.forEach(k => {
        const kDate = k.tarih.toDate ? k.tarih.toDate() : new Date(k.tarih);
        const tipLabel = k.tip === 'iftar' ? 'üåô ƒ∞ftar' : 'üåü Sahur';
        const card = document.createElement('div');
        card.className = 'day-card';
        card.style.marginBottom = '12px';
        card.style.flexDirection = 'column';
        card.style.alignItems = 'stretch';
        card.innerHTML = `
          <div style="flex:1;">
            <div style="font-weight:bold; color:var(--primary); margin-bottom:5px;">${kDate.toLocaleDateString('tr-TR', {dateStyle:'full'})}</div>
            <div style="font-size:13px; color:#7f8c8d; margin-bottom:5px;">${tipLabel} - <span id="sahip-${k.id}">${k.sahip}</span></div>
            <div style="font-size:12px; color:#95a5a6;">
              <span style="margin-right:10px;">üí∞ ${k.tutar}‚Ç∫</span>
              <span style="margin-right:10px;">üë• <span id="musafir-${k.id}">${k.musafirAdedi || 0}</span> m√ºsafir</span>
              ${k.mahalId ? `<span style="margin-right:10px;">üèõÔ∏è ${mahaller.find(m => m.id === k.mahalId)?.adi || 'Mahal'}</span>` : ''}
            </div>
            ${k.not ? `<div style="font-size:12px; color:#7f8c8d; margin-top:5px; font-style:italic;">üìù ${k.not}</div>` : ''}
          </div>
          <div style="display:flex; gap:8px; align-items:center; margin-top:12px; justify-content:flex-end;">
            <button onclick="editMyRecord('${k.id}')" style="background:var(--primary); color:white; border:none; padding:8px 12px; border-radius:8px; font-size:12px; cursor:pointer; font-weight:600;">‚úèÔ∏è D√ºzenle</button>
            <button onclick="deleteMyRecord('${k.id}')" style="background:var(--danger); color:white; border:none; padding:8px 12px; border-radius:8px; font-size:12px; cursor:pointer; font-weight:600;">üóëÔ∏è Sil</button>
          </div>
        `;
        container.appendChild(card);
      });
    }

    // D√ºzenleme fonksiyonlarƒ±
    function editMyRecord(recordId) {
      const kayit = kayitlar.find(k => k.id === recordId);
      if(!kayit || kayit.personelUid !== currentUser.uid) {
        alert('Bu kaydƒ± d√ºzenleme yetkiniz yok');
        return;
      }

      const kDate = kayit.tarih.toDate ? kayit.tarih.toDate() : new Date(kayit.tarih);
      qs('#editRecordId').value = recordId;
      qs('#editDateDisplay').innerText = kDate.toLocaleDateString('tr-TR', {dateStyle:'full'});
      qs('#editSahip').value = kayit.sahip || '';
      qs('#editGuest').value = kayit.musafirAdedi || 0;
      qs('#editGuestVal').innerText = kayit.musafirAdedi || 0;
      qs('#editModal').classList.add('open');
    }

    function closeEditModal() {
      qs('#editModal').classList.remove('open');
      qs('#editForm').reset();
    }

    function stepEditGuest(n) {
      let v = parseInt(qs('#editGuest').value) + n;
      if(v < 0) v = 0;
      qs('#editGuest').value = v;
      qs('#editGuestVal').innerText = v;
    }

    qs('#editForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const recordId = qs('#editRecordId').value;
      if(!recordId) return;

      const kayit = kayitlar.find(k => k.id === recordId);
      if(!kayit || kayit.personelUid !== currentUser.uid) {
        showAlert('Bu kaydƒ± d√ºzenleme yetkiniz yok', 'error');
        return;
      }

      const btn = e.target.querySelector('button[type="submit"]');
      btn.disabled = true;
      btn.innerText = 'Kaydediliyor...';

      try {
        const updates = {
          sahip: qs('#editSahip').value.trim(),
          musafirAdedi: parseInt(qs('#editGuest').value) || 0,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        await db.collection('ramazan_serif').doc(String(CURRENT_YIL)).collection('kayitlar').doc(recordId).update(updates);
        closeEditModal();
        showAlert('Kayƒ±t ba≈üarƒ±yla g√ºncellendi!', 'success');
        loadMyRecords();
      } catch(err) {
        showAlert('Hata: ' + err.message, 'error');
      } finally {
        btn.disabled = false;
        btn.innerText = 'KAYDET';
      }
    });

    async function deleteMyRecord(recordId) {
      const kayit = kayitlar.find(k => k.id === recordId);
      if(!kayit || kayit.personelUid !== currentUser.uid) {
        showAlert('Bu kaydƒ± silme yetkiniz yok', 'error');
        return;
      }

      showConfirm('Bu kaydƒ± silmek istediƒüinizden emin misiniz?', async () => {
        try {
          await db.collection('ramazan_serif').doc(String(CURRENT_YIL)).collection('kayitlar').doc(recordId).delete();
          showAlert('Kayƒ±t ba≈üarƒ±yla silindi!', 'success');
          loadMyRecords();
        } catch(err) {
          showAlert('Hata: ' + err.message, 'error');
        }
      });
    }

    window.editMyRecord = editMyRecord;
    window.deleteMyRecord = deleteMyRecord;
    window.openFormModalFromDay = openFormModalFromDay;
  </script>
</body>
</html>