<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Ramazan Takip Sistemi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0, viewport-fit=cover"/>
  
  <meta name="theme-color" content="#324960">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="icon" type="image/png" href="../img/logo.png" />

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="../../js/firebase/firebase-init.js"></script>

  <style>
    :root {
      --primary: #324960; --accent: #e67e22;
      --success: #27ae60; --danger: #c0392b; --warning: #f39c12;
      --bg: #f0f2f5; --card: #ffffff; --text: #2c3e50; --border: #e9ecef;
      --nav-height: 65px;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { 
      margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
      background: var(--bg); color: var(--text); padding-bottom: 80px;
    }

    /* --- HEADER --- */
    .hero-header {
      background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%);
      color: white; padding: 15px 20px 25px 20px; border-radius: 0 0 25px 25px;
      position: relative; box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      margin-bottom: 10px;
    }
    .top-nav { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
    
    /* Geri DÃ¶n Butonu */
    .back-btn {
      display: flex; align-items: center; gap: 6px;
      background: rgba(255,255,255,0.2); padding: 6px 12px; border-radius: 20px;
      color: white; text-decoration: none; font-size: 13px; font-weight: 600;
      transition: 0.2s; backdrop-filter: blur(4px);
    }
    .back-btn:hover { background: rgba(255,255,255,0.3); }

    .year-selector {
      background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3);
      color: white; padding: 5px 10px; border-radius: 15px; font-size: 12px; font-weight: 600;
      appearance: none; outline: none; cursor: pointer;
    }
    .year-selector option { color: #333; }


    /* --- LAYOUT CONTAINER --- */
    .main-container {
      max-width: 1200px; margin: 0 auto; padding: 20px; margin-top: 10px;
    }

    /* --- 1. MOBÄ°L GÃ–RÃœNÃœM (Timeline) --- */
    .timeline-view { display: block; } /* Mobilde varsayÄ±lan */
    .calendar-view { display: none; }  /* Mobilde gizli */

    .day-card {
      background: var(--card); border-radius: 16px; margin-bottom: 12px;
      padding: 15px; display: flex; justify-content: space-between; align-items: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.04); border-left: 5px solid transparent;
      transition: transform 0.1s; cursor: pointer;
    }
    .day-card:active { transform: scale(0.98); }
    
    .status-green { border-left-color: var(--success); }
    .status-orange { border-left-color: var(--warning); }
    .status-red { border-left-color: var(--danger); }

    .dc-date { display: flex; flex-direction: column; align-items: center; min-width: 50px; border-right: 1px solid #eee; padding-right: 10px; margin-right: 10px; }
    .dc-day-num { font-size: 24px; font-weight: 800; line-height: 1; }
    .dc-day-name { font-size: 10px; text-transform: uppercase; color: #7f8c8d; font-weight: 600; }
    .dc-info { flex: 1; }
    .dc-ramazan { font-size: 11px; color: var(--accent); font-weight: 700; text-transform: uppercase; }
    .dc-status { font-size: 13px; font-weight: 600; color: #34495e; }
    .dc-action { font-size: 24px; color: var(--primary); font-weight: 300; }

    /* Mobil iÃ§in bilgilendirme modalÄ± kÃ¼Ã§Ã¼ltme */
    @media (max-width: 767px) {
      #infoModalSheet {
        max-width: 90% !important;
        margin: 20px auto;
      }
      #infoModalIcon {
        font-size: 36px !important;
        margin-bottom: 8px !important;
      }
      #infoModalTitle {
        font-size: 16px !important;
        margin-bottom: 8px !important;
      }
      #infoContent {
        font-size: 12px !important;
        margin-bottom: 15px !important;
      }
      #infoContent ul li {
        margin-bottom: 8px !important;
        font-size: 12px !important;
      }
      #infoContent ul li span:first-child {
        font-size: 16px !important;
      }
      #infoContent p {
        font-size: 11px !important;
      }
    }

    /* --- 2. MASAÃœSTÃœ GÃ–RÃœNÃœM (Responsive Grid) --- */
    @media (min-width: 768px) {
      /* Alt menÃ¼ tÃ¼m cihazlarda gÃ¶rÃ¼nsÃ¼n */
      body { padding-bottom: var(--nav-height); }
      
      /* Mobil gÃ¶rÃ¼nÃ¼mÃ¼ de gÃ¶ster */
      .timeline-view { display: block; } /* Mobil gÃ¶rÃ¼nÃ¼mÃ¼ de gÃ¶ster */
      .calendar-view { display: none; } /* MasaÃ¼stÃ¼ takvimi gizle */
      
      /* MasaÃ¼stÃ¼ Takvim KartÄ± */
      .cal-cell {
        background: white; border-radius: 12px; padding: 10px; min-height: 100px;
        border: 1px solid #e0e0e0; cursor: pointer; transition: 0.2s;
        display: flex; flex-direction: column; justify-content: space-between;
      }
      .cal-cell:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-color: var(--primary); }
      .cal-cell.empty { background: transparent; border: none; cursor: default; }
      
      .cc-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
      .cc-num { font-weight: 800; font-size: 18px; color: #2c3e50; }
      .cc-day { font-size: 12px; color: #95a5a6; }
      
      .cc-badges { display: flex; flex-direction: column; gap: 3px; }
      .cc-badge { font-size: 11px; padding: 3px 6px; border-radius: 4px; color: white; text-align: center; }
      .cc-iftar { background: var(--accent); }
      .cc-sahur { background: #3498db; }
      .cc-full { opacity: 0.5; text-decoration: line-through; }
      .cal-cell.cal-green { border-left: 3px solid var(--success); }
      .cal-cell.cal-orange { border-left: 3px solid var(--warning); }
      .cal-cell.cal-red { border-left: 3px solid var(--danger); }
    }

    /* --- MODAL & FORM --- */
    .modal {
      position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000;
      display: none; align-items: center; justify-content: center; backdrop-filter: blur(3px);
      padding: 20px;
    }
    .modal.open { display: flex; }
    .modal-sheet {
      background: #fff; width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto;
      border-radius: 20px; padding: 25px 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.2);
      animation: zoomIn 0.2s ease-out;
      margin: 20px;
    }
    @keyframes zoomIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    @keyframes slideDown { from { transform: translateY(0); opacity: 1; } to { transform: translateY(20px); opacity: 0; } }
    
    .form-label { font-size: 12px; font-weight: 600; color: #7f8c8d; margin-bottom: 6px; display: block; }
    .chip-group { display: flex; gap: 10px; overflow-x: auto; padding-bottom: 5px; }
    .chip {
      padding: 10px 16px; background: #f1f2f6; border-radius: 10px; border: 2px solid transparent;
      font-size: 14px; font-weight: 600; color: #2c3e50; white-space: nowrap; cursor: pointer;
    }
    .chip.selected { background: #e8f4fd; border-color: var(--primary); color: var(--primary); }
    .chip.disabled { opacity: 0.5; cursor: not-allowed !important; }
    
    .stepper { display: flex; align-items: center; gap: 15px; }
    .step-btn { width: 40px; height: 40px; border-radius: 10px; background: #f1f2f6; border: none; font-size: 20px; font-weight: bold; color: var(--primary); cursor: pointer; }
    .step-val { font-size: 18px; font-weight: bold; width: 30px; text-align: center; }

    .full-input { width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 10px; font-size: 15px; background: #f9f9f9; }
    .full-btn { width: 100%; padding: 15px; border-radius: 12px; border: none; font-size: 16px; font-weight: 700; cursor: pointer; margin-top: 10px; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-secondary { background: #f1f2f6; color: #7f8c8d; }

    /* BOTTOM NAV (Mobil Ä°Ã§in) */
    .bottom-nav {
      position: fixed; bottom: 0; left: 0; right: 0; height: var(--nav-height);
      background: var(--card); box-shadow: 0 -2px 20px rgba(0,0,0,0.05);
      display: flex; justify-content: space-around; align-items: center; z-index: 100;
      padding-bottom: env(safe-area-inset-bottom);
    }
    .nav-btn {
      display: flex; flex-direction: column; align-items: center; justify-content: center;
      color: #95a5a6; font-size: 10px; font-weight: 600; gap: 4px; background: none; border: none; width: 100%; height: 100%;
    }
    .nav-btn.active { color: var(--primary); }
    .nav-btn svg { width: 24px; height: 24px; fill: currentColor; }

  </style>
</head>
<body>

  <div class="hero-header">
    <div class="top-nav">
      <a href="../panel.html" class="back-btn">
        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
        Panele DÃ¶n
      </a>
      
      <select id="selYil" class="year-selector">
        <option value="">YÄ±l...</option>
      </select>
    </div>
    
    <div style="text-align:center; margin-top:10px;">
      <div style="font-size:18px; font-weight:600; opacity:0.9;">Ramazan-Ä± Åerif</div>
    </div>
  </div>

  <div class="main-container">
    
    <div id="mobileView" class="timeline-view">
      <div style="text-align:center; padding:20px; color:#999">YÃ¼kleniyor...</div>
    </div>

    <div id="desktopView" class="calendar-view">
      </div>

  </div>

  <!-- GÃ¼n KayÄ±tlarÄ± Ã–nizleme ModalÄ± -->
  <div id="dayRecordsModal" class="modal">
    <div class="modal-sheet" style="max-width:600px;">
      <h3 style="margin:0 0 15px 0; font-size:18px; font-weight:600;">GÃ¼n KayÄ±tlarÄ±</h3>
      <div id="dayRecordsContent" style="max-height:60vh; overflow-y:auto; margin-bottom:15px;"></div>
      <div style="display:flex; gap:10px;">
        <button type="button" class="full-btn btn-primary" onclick="openFormModalFromDay()" style="flex:1;">+ Yeni KayÄ±t Ekle</button>
        <button type="button" class="full-btn btn-secondary" onclick="closeDayRecordsModal()" style="flex:1;">Kapat</button>
      </div>
    </div>
  </div>

  <div id="formModal" class="modal">
    <div class="modal-sheet">
      <h3 style="margin:0 0 12px 0; font-size:16px; font-weight:600;">Yeni KayÄ±t</h3>
      <form id="smartForm">
        <input type="hidden" id="fDate">
        
        <div id="fDateDisplay" style="font-size:12px; margin-bottom:10px; color:var(--primary); text-align:center; padding:6px; border-radius:6px; background:#f8f9fa;"></div>

        <label class="form-label" style="margin-top:0; font-size:12px;">KayÄ±t Tipi</label>
        <div class="chip-group" id="typeChips">
          <div class="chip selected" onclick="selectChip('type', 'iftar', this)">ğŸŒ™ Ä°ftar</div>
          <div class="chip" onclick="selectChip('type', 'sahur', this)">ğŸŒŸ Sahur</div>
        </div>
        <input type="hidden" id="fType" value="iftar">

        <label class="form-label" style="margin-top:10px; font-size:12px;">Tutar</label>
        <div class="chip-group" id="priceChips">
          <div class="chip">YÃ¼kleniyor...</div>
        </div>
        <input type="hidden" id="fPrice">

        <label class="form-label" style="margin-top:10px; font-size:12px;">Ä°ftar Sahibi</label>
        <input type="text" id="fName" class="full-input" placeholder="Ad Soyad" required style="font-size:14px; padding:10px;">

        <label class="form-label" style="margin-top:10px; font-size:12px;">Ä°ÅŸtirak</label>
        <div class="chip-group" id="istirakChips">
          <div class="chip selected" onclick="selectChip('istirak', true, this)">âœ“ Evet</div>
          <div class="chip" onclick="selectChip('istirak', false, this)">âœ— HayÄ±r</div>
        </div>
        <input type="hidden" id="fIstirak" value="true">

        <div id="istirakEvetFields">
          <label class="form-label" style="margin-top:10px; font-size:12px;">MÃ¼safir</label>
          <div class="stepper">
            <button type="button" class="step-btn" onclick="stepGuest(-1)">-</button>
            <span class="step-val" id="fGuestVal">0</span>
            <button type="button" class="step-btn" onclick="stepGuest(1)">+</button>
          </div>
          <input type="hidden" id="fGuest" value="0">

          <label class="form-label" style="margin-top:10px; font-size:12px;">Mahal</label>
          <div class="chip-group" id="mahalChips" style="flex-wrap:wrap;">
            <div class="chip">YÃ¼kleniyor...</div>
          </div>
          <input type="hidden" id="fMahal">
        </div>

        <label class="form-label" style="margin-top:10px; font-size:12px;">Not</label>
        <input type="text" id="fNote" class="full-input" placeholder="Ä°steÄŸe baÄŸlÄ±" style="font-size:14px; padding:10px;">

        <div style="display:flex; gap:10px; margin-top:15px;">
          <button type="submit" class="full-btn btn-primary" style="flex:1;">Ã–NÄ°ZLE</button>
          <button type="button" class="full-btn btn-secondary" onclick="closeModal()" style="flex:1;">Ä°ptal</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Ã–nizleme ModalÄ± -->
  <div id="previewModal" class="modal">
    <div class="modal-sheet">
      <h3 style="margin:0 0 20px 0; font-size:20px;">KayÄ±t Ã–nizleme</h3>
      <div id="previewContent" style="background:#f9f9f9; padding:15px; border-radius:10px; margin-bottom:20px;"></div>
      <button type="button" class="full-btn btn-primary" onclick="confirmSave()">KAYDET</button>
      <button type="button" class="full-btn btn-secondary" onclick="closePreviewModal()">Geri DÃ¶n</button>
    </div>
  </div>

  <!-- DÃ¼zenleme Talep ModalÄ± -->
  <div id="editRequestModal" class="modal">
    <div class="modal-sheet" style="max-width:500px;">
      <h3 style="margin:0 0 15px 0; font-size:18px; font-weight:600;">DÃ¼zenleme Talebi</h3>
      <form id="editRequestForm">
        <input type="hidden" id="editRequestRecordId">
        <input type="hidden" id="editRequestKayitTipi">
        
        <div id="editRequestDateDisplay" style="font-size:14px; margin-bottom:12px; color:var(--primary); text-align:center; padding:8px; border-radius:6px; background:#f8f9fa;"></div>

        <label class="form-label" style="margin-top:0;">Talep TÃ¼rÃ¼</label>
        <div class="chip-group" style="margin-bottom:15px;">
          <div class="chip selected" onclick="selectEditRequestType('duzenle', this)">âœï¸ DÃ¼zenle</div>
          <div class="chip" onclick="selectEditRequestType('yer_degistir', this)">ğŸ”„ Yer DeÄŸiÅŸtir</div>
          <div class="chip" onclick="selectEditRequestType('sil', this)">ğŸ—‘ï¸ Sil</div>
        </div>
        <input type="hidden" id="editRequestType" value="duzenle">

        <!-- Yer DeÄŸiÅŸtir iÃ§in tarih seÃ§imi -->
        <div id="editRequestDateSelect" style="display:none; margin-bottom:15px;">
          <label class="form-label">Yeni Tarih SeÃ§iniz</label>
          <input type="date" id="editRequestNewDate" class="full-input" style="margin-bottom:10px;">
          <div id="editRequestMahalWarning" style="display:none; padding:10px; background:#fff3cd; border-left:3px solid #ffc107; border-radius:6px; margin-top:10px; font-size:13px;">
            <strong>âš ï¸ UyarÄ±:</strong> <span id="editRequestMahalWarningText"></span>
          </div>
        </div>

        <label class="form-label">AÃ§Ä±klama</label>
        <textarea id="editRequestAciklama" class="full-input" rows="4" placeholder="Yapmak istediÄŸiniz deÄŸiÅŸiklikleri detaylÄ± olarak aÃ§Ä±klayÄ±nÄ±z..." style="resize:vertical; min-height:80px;"></textarea>

        <div style="display:flex; gap:10px; margin-top:15px;">
          <button type="submit" class="full-btn btn-primary" style="flex:1;">Kaydet ve Kapat</button>
          <button type="button" class="full-btn btn-secondary" onclick="closeEditRequestModal()" style="flex:1;">Ä°ptal</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Bilgilendirme ModalÄ± -->
  <div id="infoModal" class="modal">
    <div class="modal-sheet" style="max-width:500px;" id="infoModalSheet">
      <div style="text-align:center; margin-bottom:20px;" id="infoModalHeader">
        <div style="font-size:48px; margin-bottom:10px;" id="infoModalIcon">ğŸŒ™</div>
        <h3 style="margin:0 0 10px 0; font-size:20px; color:var(--primary);" id="infoModalTitle">Ä°ftar-Sahur Takip Sistemi</h3>
      </div>
      <div id="infoContent" style="line-height:1.6; color:#555; margin-bottom:20px; font-size:14px;">
        <p style="margin-bottom:15px; font-weight:600; color:var(--primary);">Bu sistemde neler yapabilirsiniz?</p>
        <div style="background:#f8f9fa; padding:15px; border-radius:10px; margin-bottom:15px;">
          <ul style="text-align:left; padding-left:20px; margin:0; list-style:none;">
            <li style="margin-bottom:10px; display:flex; align-items:start; gap:8px;">
              <span style="font-size:18px;">ğŸ“</span>
              <span><strong>Ä°ftar-Sahur kayÄ±tlarÄ±nÄ±zÄ±</strong> kolayca yapabilirsiniz</span>
            </li>
            <li style="margin-bottom:10px; display:flex; align-items:start; gap:8px;">
              <span style="font-size:18px;">ğŸ‘ï¸</span>
              <span><strong>KayÄ±tlarÄ±nÄ±zÄ± gÃ¶rÃ¼ntÃ¼leyebilir</strong> ve yÃ¶netebilirsiniz</span>
            </li>
            <li style="margin-bottom:10px; display:flex; align-items:start; gap:8px;">
              <span style="font-size:18px;">ğŸ“Š</span>
              <span><strong>MÃ¼sait, dolmak Ã¼zere ve dolu gÃ¼nleri</strong> gÃ¶rebilirsiniz</span>
            </li>
            <li style="margin-bottom:10px; display:flex; align-items:start; gap:8px;">
              <span style="font-size:18px;">ğŸ“…</span>
              <span><strong>KayÄ±tlarÄ±m</strong> bÃ¶lÃ¼mÃ¼nden kendi kayÄ±tlarÄ±nÄ±zÄ± takip edebilirsiniz</span>
            </li>
            <li style="margin-bottom:10px; display:flex; align-items:start; gap:8px;">
              <span style="font-size:18px;">âœï¸</span>
              <span>KayÄ±tlarÄ±nÄ±zÄ± <strong>dÃ¼zenleyebilir</strong> veya <strong>silebilirsiniz</strong></span>
            </li>
            <li style="margin-bottom:10px; display:flex; align-items:start; gap:8px;">
              <span style="font-size:18px;">ğŸ›ï¸</span>
              <span><strong>Mahal seÃ§imi</strong> ile mÃ¼safir sayÄ±sÄ±na uygun yer seÃ§ebilirsiniz</span>
            </li>
            <li style="margin-bottom:10px; display:flex; align-items:start; gap:8px;">
              <span style="font-size:18px;">ğŸ’°</span>
              <span><strong>Teberru, TaahhÃ¼t, Tahsilat</strong> giriÅŸi yapabilirsiniz</span>
            </li>
            <li style="margin-bottom:10px; display:flex; align-items:start; gap:8px;">
              <span style="font-size:18px;">ğŸ“Š</span>
              <span><strong>Analiz</strong> ile iftar-sahur-teberru-taahhÃ¼t-tahsilatlarÄ±nÄ±zÄ± analiz edebilirsiniz</span>
            </li>
          </ul>
        </div>
        <div style="background:#e8f4fd; padding:12px; border-radius:8px; border-left:3px solid var(--primary);">
          <p style="margin:0; font-size:13px; color:var(--primary); font-weight:600;">
            ğŸ’¡ Ä°pucu: GÃ¼nlere tÄ±klayarak o gÃ¼nÃ¼n kayÄ±tlarÄ±nÄ± gÃ¶rebilir ve yeni kayÄ±t ekleyebilirsiniz.
          </p>
        </div>
      </div>
      <div style="display:flex; gap:10px;">
        <button type="button" class="full-btn btn-primary" onclick="closeInfoModal()" style="flex:1;">AnladÄ±m</button>
        <label style="flex:1; display:flex; align-items:center; justify-content:center; gap:8px; cursor:pointer; font-size:13px; color:#7f8c8d;">
          <input type="checkbox" id="dontShowAgain" style="cursor:pointer;">
          <span>Bir daha gÃ¶sterme</span>
        </label>
      </div>
    </div>
  </div>

  <style>
    /* Mobil cihazlarda bilgilendirme modalÄ±nÄ± kÃ¼Ã§Ã¼lt */
    @media (max-width: 767px) {
      #infoModalSheet {
        max-width: 90% !important;
        padding: 15px !important;
      }
      #infoModalHeader {
        margin-bottom: 15px !important;
      }
      #infoModalIcon {
        font-size: 36px !important;
        margin-bottom: 8px !important;
      }
      #infoModalTitle {
        font-size: 16px !important;
        margin-bottom: 8px !important;
      }
      #infoContent {
        font-size: 12px !important;
        margin-bottom: 15px !important;
      }
      #infoContent p {
        font-size: 13px !important;
        margin-bottom: 10px !important;
      }
      #infoContent ul li {
        margin-bottom: 8px !important;
        font-size: 12px !important;
      }
      #infoContent ul li span:first-child {
        font-size: 16px !important;
      }
      #infoContent > div {
        padding: 12px !important;
        margin-bottom: 12px !important;
      }
      #infoContent > div:last-child {
        padding: 10px !important;
      }
      #infoContent > div:last-child p {
        font-size: 11px !important;
      }
    }
  </style>

  <!-- Bilgilendirme ModalÄ± -->
  <div id="infoModal" class="modal">
    <div class="modal-sheet" style="max-width:500px;">
      <div style="text-align:center; margin-bottom:20px;">
        <div style="font-size:48px; margin-bottom:10px;">ğŸ“‹</div>
        <h3 style="margin:0 0 15px 0; font-size:18px; font-weight:600; color:var(--primary);">Ramazan Takip Sistemi</h3>
      </div>
      <div style="background:#f8f9fa; padding:15px; border-radius:10px; margin-bottom:20px; font-size:14px; line-height:1.6;">
        <p style="margin:0 0 12px 0;">Bu sistemde ÅŸunlarÄ± yapabilirsiniz:</p>
        <ul style="margin:0; padding-left:20px; text-align:left;">
          <li style="margin-bottom:8px;">âœ… <strong>Ä°ftar-Sahur kayÄ±tlarÄ±nÄ±zÄ±</strong> kolayca yapabilirsiniz</li>
          <li style="margin-bottom:8px;">ğŸ“… <strong>KayÄ±tlarÄ±nÄ±zÄ± gÃ¶rÃ¼ntÃ¼leyebilir</strong> ve yÃ¶netebilirsiniz</li>
          <li style="margin-bottom:8px;">ğŸ“Š <strong>MÃ¼sait, dolmak Ã¼zere ve dolu gÃ¼nleri</strong> gÃ¶rebilirsiniz</li>
          <li style="margin-bottom:8px;">âœï¸ <strong>KayÄ±tlarÄ±nÄ±zÄ± dÃ¼zenleyebilir</strong> veya silebilirsiniz</li>
          <li style="margin-bottom:8px;">ğŸ›ï¸ <strong>Mahal seÃ§imi</strong> yaparak uygun yerleri seÃ§ebilirsiniz</li>
          <li style="margin-bottom:8px;">ğŸ’° <strong>Teberru, TaahhÃ¼t, Tahsilat</strong> giriÅŸi yapabilirsiniz</li>
          <li style="margin-bottom:8px;">ğŸ“Š <strong>Analiz</strong> ile iftar-sahur-teberru-taahhÃ¼t-tahsilatlarÄ±nÄ±zÄ± analiz edebilirsiniz</li>
        </ul>
        <p style="margin:12px 0 0 0; font-size:12px; color:var(--muted);">Herhangi bir sorunuz olursa yÃ¶netim ekibiyle iletiÅŸime geÃ§ebilirsiniz.</p>
      </div>
      <div style="display:flex; gap:10px;">
        <button type="button" class="full-btn btn-primary" onclick="closeInfoModal()" style="flex:1;">AnladÄ±m</button>
        <label style="flex:1; display:flex; align-items:center; justify-content:center; gap:8px; cursor:pointer; padding:12px; border-radius:8px; background:#f0f2f5;">
          <input type="checkbox" id="dontShowAgain" style="cursor:pointer;">
          <span style="font-size:12px; color:var(--muted);">Tekrar gÃ¶sterme</span>
        </label>
      </div>
    </div>
  </div>

  <!-- Bildirim ModalÄ± -->
  <div id="alertModal" class="modal">
    <div class="modal-sheet" style="max-width:400px;">
      <div id="alertContent" style="margin-bottom:20px; text-align:center;"></div>
      <button type="button" class="full-btn btn-primary" onclick="closeAlertModal()">Tamam</button>
    </div>
  </div>

  <!-- Onay ModalÄ± -->
  <div id="confirmModal" class="modal">
    <div class="modal-sheet" style="max-width:400px;">
      <div id="confirmContent" style="margin-bottom:20px; text-align:center;"></div>
      <div style="display:flex; gap:10px;">
        <button type="button" class="full-btn btn-primary" onclick="confirmYes()" style="flex:1;">Evet</button>
        <button type="button" class="full-btn btn-secondary" onclick="closeConfirmModal()" style="flex:1;">HayÄ±r</button>
      </div>
    </div>
  </div>

  <!-- Toast Bildirim Container -->
  <div id="toastContainer" style="position:fixed; bottom:80px; left:50%; transform:translateX(-50%); z-index:3000; display:flex; flex-direction:column; gap:10px; max-width:90%; pointer-events:none;"></div>

  <!-- MenÃ¼ GÃ¶rÃ¼nÃ¼mÃ¼ -->
  <div id="menuView" style="display:none;">
    <div class="main-container">
      <h3 style="padding:20px 20px 10px; margin:0; font-size:18px; color:var(--primary);">ğŸ½ï¸ MenÃ¼ler</h3>
      <div id="menuDaysList" style="padding:0 20px 20px;">
        <div style="text-align:center; padding:20px; color:#999">YÃ¼kleniyor...</div>
      </div>
    </div>
  </div>

  <!-- MenÃ¼ Detay ModalÄ± -->
  <div id="menuDetailModal" class="modal" onclick="if(event.target === this) closeMenuDetailModal()">
    <div class="modal-sheet" style="max-width:600px; max-height:90vh; overflow-y:auto;" onclick="event.stopPropagation()">
      <h3 style="margin:0 0 20px 0; font-size:20px; font-weight:600; color:var(--primary); text-align:center;" id="menuDetailTitle">ğŸ½ï¸ MenÃ¼</h3>
      <div id="menuDetailContent"></div>
      <div style="display:flex; gap:10px; margin-top:20px;">
        <button type="button" class="full-btn btn-primary" onclick="closeMenuDetailModal()" style="flex:1; padding:12px;">Kapat</button>
      </div>
    </div>
  </div>

  <!-- Teberru ModalÄ± -->
  <div id="teberruModal" class="modal">
    <div class="modal-sheet" style="max-width:500px;">
      <h3 style="margin:0 0 15px 0; font-size:16px; font-weight:600; color:var(--primary);">ğŸ’° Teberru KaydÄ±</h3>
      <form id="teberruForm">
        <div class="form-group">
          <label class="form-label">BaÄŸÄ±ÅŸÃ§Ä± AdÄ± *</label>
          <input type="text" id="teberruBagisci" class="full-input" placeholder="BaÄŸÄ±ÅŸÃ§Ä± adÄ± soyadÄ±">
          <div id="teberruBagisciError" class="error-message" style="display:none; color:var(--danger); font-size:12px; margin-top:4px;"></div>
        </div>
        <div class="form-group">
          <label class="form-label">Para MiktarÄ± (â‚º) *</label>
          <input type="number" id="teberruMiktar" class="full-input" min="0" step="0.01" placeholder="0.00">
          <div id="teberruMiktarError" class="error-message" style="display:none; color:var(--danger); font-size:12px; margin-top:4px;"></div>
        </div>
        <div class="form-group">
          <label class="form-label">Ã–deme YÃ¶ntemi *</label>
          <div class="chip-group" style="display:flex; gap:8px; flex-wrap:wrap;">
            <div class="chip" onclick="selectChip('odeme', 'nakit', this)" data-value="nakit">ğŸ’µ Nakit</div>
            <div class="chip" onclick="selectChip('odeme', 'banka', this)" data-value="banka">ğŸ¦ Banka</div>
            <div class="chip" onclick="selectChip('odeme', 'pos', this)" data-value="pos">ğŸ’³ POS</div>
            <div class="chip" onclick="selectChip('odeme', 'sanal', this)" data-value="sanal">ğŸ“± Sanal</div>
          </div>
          <input type="hidden" id="teberruOdeme">
          <div id="teberruOdemeError" class="error-message" style="display:none; color:var(--danger); font-size:12px; margin-top:4px;"></div>
        </div>
        <div class="form-group">
          <label class="form-label">AÃ§Ä±klama</label>
          <textarea id="teberruAciklama" class="full-input" rows="3" placeholder="AÃ§Ä±klama (opsiyonel)"></textarea>
        </div>
        <div style="display:flex; gap:10px; margin-top:15px;">
          <button type="button" class="full-btn btn-secondary" onclick="closeTeberruModal()" style="flex:1;">Ä°ptal</button>
          <button type="button" class="full-btn btn-primary" onclick="showTeberruPreview()" style="flex:1;">Ã–nizleme</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Teberru Ã–nizleme ModalÄ± -->
  <div id="teberruPreviewModal" class="modal">
    <div class="modal-sheet" style="max-width:500px;">
      <h3 style="margin:0 0 15px 0; font-size:16px; font-weight:600; color:var(--primary);">ğŸ“‹ Teberru Ã–nizleme</h3>
      <div id="teberruPreviewContent" style="background:#f9f9f9; padding:15px; border-radius:10px; margin-bottom:20px;"></div>
      <div style="display:flex; gap:10px;">
        <button type="button" class="full-btn btn-secondary" onclick="closeTeberruPreviewModal()" style="flex:1;">Geri</button>
        <button type="button" class="full-btn btn-primary" onclick="saveTeberru()" style="flex:1;">Kaydet</button>
      </div>
    </div>
  </div>

  <!-- TaahhÃ¼t ModalÄ± -->
  <div id="taahhutModal" class="modal">
    <div class="modal-sheet" style="max-width:500px;">
      <h3 style="margin:0 0 15px 0; font-size:16px; font-weight:600; color:var(--primary);">ğŸ“‹ TaahhÃ¼t KaydÄ±</h3>
      <form id="taahhutForm">
        <div class="form-group">
          <label class="form-label">BaÄŸÄ±ÅŸÃ§Ä± AdÄ± *</label>
          <input type="text" id="taahhutBagisci" class="full-input" placeholder="BaÄŸÄ±ÅŸÃ§Ä± adÄ± soyadÄ±">
          <div id="taahhutBagisciError" class="error-message" style="display:none; color:var(--danger); font-size:12px; margin-top:4px;"></div>
        </div>
        <div class="form-group">
          <label class="form-label">Para MiktarÄ± (â‚º) *</label>
          <input type="number" id="taahhutMiktar" class="full-input" min="0" step="0.01" placeholder="0.00">
          <div id="taahhutMiktarError" class="error-message" style="display:none; color:var(--danger); font-size:12px; margin-top:4px;"></div>
        </div>
        <div class="form-group">
          <label class="form-label">AÃ§Ä±klama</label>
          <textarea id="taahhutAciklama" class="full-input" rows="3" placeholder="AÃ§Ä±klama (opsiyonel)"></textarea>
        </div>
        <div style="display:flex; gap:10px; margin-top:15px;">
          <button type="button" class="full-btn btn-secondary" onclick="closeTaahhutModal()" style="flex:1;">Ä°ptal</button>
          <button type="button" class="full-btn btn-primary" onclick="showTaahhutPreview()" style="flex:1;">Ã–nizleme</button>
        </div>
      </form>
    </div>
  </div>

  <!-- TaahhÃ¼t Ã–nizleme ModalÄ± -->
  <div id="taahhutPreviewModal" class="modal">
    <div class="modal-sheet" style="max-width:500px;">
      <h3 style="margin:0 0 15px 0; font-size:16px; font-weight:600; color:var(--primary);">ğŸ“‹ TaahhÃ¼t Ã–nizleme</h3>
      <div id="taahhutPreviewContent" style="background:#f9f9f9; padding:15px; border-radius:10px; margin-bottom:20px;"></div>
      <div style="display:flex; gap:10px;">
        <button type="button" class="full-btn btn-secondary" onclick="closeTaahhutPreviewModal()" style="flex:1;">Geri</button>
        <button type="button" class="full-btn btn-primary" onclick="saveTaahhut()" style="flex:1;">Kaydet</button>
      </div>
    </div>
  </div>

  <!-- Analiz ModalÄ± -->
  <div id="analizModal" class="modal">
    <div class="modal-sheet" style="max-width:600px;">
      <h3 style="margin:0 0 15px 0; font-size:18px; font-weight:600; color:var(--primary);">ğŸ“Š Analiz</h3>
      
      <div style="padding:15px; background:#fff3cd; border-left:4px solid #ffc107; border-radius:10px; margin-bottom:20px; box-shadow:0 2px 8px rgba(255,193,7,0.2);">
        <p style="margin:0; font-size:13px; line-height:1.7; color:#856404; font-weight:500;">
          <strong style="font-size:14px;">âš ï¸ Ã–nemli UyarÄ±:</strong><br>
          BurasÄ± analiz kÄ±smÄ±dÄ±r, veriler %100 doÄŸru deÄŸildir. DoÄŸru veriler muhasebe tarafÄ±ndan aÃ§Ä±klanÄ±r ve gÃ¼ncellenir. BurasÄ± bilgilendirme ve takip etme yeridir.
        </p>
      </div>
      
      <div id="analizContent" style="margin-bottom:20px;">
        <div style="text-align:center; padding:20px; background:#f8f9fa; border-radius:10px; margin-bottom:15px;">
          <div style="font-size:14px; color:#7f8c8d; margin-bottom:8px;">YÃ¼kleniyor...</div>
        </div>
      </div>

      <div style="display:flex; gap:10px;">
        <button type="button" class="full-btn btn-primary" onclick="closeAnalizModal()" style="flex:1;">Kapat</button>
      </div>
    </div>
  </div>

  <!-- KayÄ±tlarÄ±m GÃ¶rÃ¼nÃ¼mÃ¼ -->
  <div id="takvimimView" style="display:none;">
    <div class="main-container">
      <h3 style="padding:20px 20px 10px; margin:0; font-size:18px; color:var(--primary);">Benim KayÄ±tlarÄ±m</h3>
      
      <!-- KPI KartlarÄ± -->
      <div id="myRecordsKPI" style="padding:0 20px 15px; display:grid; grid-template-columns:repeat(2, 1fr); gap:12px;">
        <div style="background:linear-gradient(135deg, #f39c12 0%, #e67e22 100%); border-radius:12px; padding:15px; color:white; box-shadow:0 4px 12px rgba(243,156,18,0.3);">
          <div style="font-size:13px; opacity:0.9; margin-bottom:8px; font-weight:500;">ğŸŒ™ Toplam Ä°ftar Adedi</div>
          <div style="font-size:28px; font-weight:700;" id="kpiToplamIftar">0</div>
        </div>
        <div style="background:linear-gradient(135deg, #3498db 0%, #2980b9 100%); border-radius:12px; padding:15px; color:white; box-shadow:0 4px 12px rgba(52,152,219,0.3);">
          <div style="font-size:13px; opacity:0.9; margin-bottom:8px; font-weight:500;">ğŸŒŸ Toplam Sahur Adedi</div>
          <div style="font-size:28px; font-weight:700;" id="kpiToplamSahur">0</div>
        </div>
      </div>
      
      <div id="myRecordsList" style="padding:0 20px 20px;">
        <div style="text-align:center; padding:20px; color:#999">YÃ¼kleniyor...</div>
      </div>
    </div>
  </div>

  <!-- Teberru GiriÅŸi GÃ¶rÃ¼nÃ¼mÃ¼ -->
  <div id="teberruView" style="display:none;">
    <div class="main-container">
      <h3 style="padding:20px; margin:0; font-size:18px; color:var(--primary);">Teberru GiriÅŸi</h3>
      <div style="padding:20px; display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:15px;">
        <button class="full-btn btn-primary" onclick="openTeberruModal()" style="padding:20px; font-size:16px; font-weight:600;">
          ğŸ’° Teberru
        </button>
        <button class="full-btn btn-primary" onclick="openTaahhutModal()" style="padding:20px; font-size:16px; font-weight:600;">
          ğŸ“‹ TaahhÃ¼t
        </button>
        <button class="full-btn btn-primary" onclick="openTahsilatModal()" style="padding:20px; font-size:16px; font-weight:600;">
          ğŸ’³ Tahsilat
        </button>
        <button class="full-btn btn-primary" onclick="openAnalizModal()" style="padding:20px; font-size:16px; font-weight:600;">
          ğŸ“Š Analiz
        </button>
      </div>
    </div>
  </div>

  <!-- Bilgilendirme Pop-up (SaÄŸ Alt KÃ¶ÅŸe) -->
  <div id="infoPopup" style="display:none; position:fixed; bottom:90px; right:20px; background:white; border-radius:12px; padding:15px; box-shadow:0 4px 20px rgba(0,0,0,0.15); max-width:300px; z-index:1000; border-left:4px solid var(--primary);">
    <div style="display:flex; align-items:start; gap:10px;">
      <div style="font-size:24px;">ğŸ’¡</div>
      <div style="flex:1;">
        <div style="font-weight:600; margin-bottom:5px; font-size:14px; color:var(--primary);">Bilgilendirme</div>
        <div style="font-size:12px; color:#666; line-height:1.4; margin-bottom:10px;">Sistem hakkÄ±nda bilgi almak iÃ§in tÄ±klayÄ±n.</div>
        <button onclick="showInfoModalFromPopup()" style="background:var(--primary); color:white; border:none; padding:6px 12px; border-radius:6px; font-size:12px; cursor:pointer; width:100%;">DetaylÄ± Bilgi</button>
      </div>
      <button onclick="closeInfoPopup()" style="background:none; border:none; font-size:18px; cursor:pointer; color:#999; padding:0; line-height:1;">Ã—</button>
    </div>
  </div>

  <nav class="bottom-nav">
    <button class="nav-btn active" onclick="switchView('takvim')">
      <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
      <span>Takvim</span>
    </button>
    <button class="nav-btn" onclick="switchView('takvimim')">
      <svg viewBox="0 0 24 24"><path d="M19 3h-1V1h-2v2H8V1H6v2H5c-1.11 0-1.99.9-1.99 2L3 19c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 16H5V8h14v11zM7 10h5v5H7z"/></svg>
      <span>KayÄ±tlarÄ±m</span>
    </button>
    <button class="nav-btn" onclick="switchView('teberru')">
      <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>
      <span>Teberru</span>
    </button>
    <button class="nav-btn" onclick="switchView('menu')">
      <svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
      <span>MenÃ¼</span>
    </button>
  </nav>


  <script>
    const db = window.db;
    const auth = window.auth;
    const qs = s => document.querySelector(s);
    
    let CURRENT_YIL = null;
    let ramazanAyari = null;
    let kayitlar = [];
    let tutarSecenekleri = [];
    let currentUser = null;
    let kapasiteAyarlari = { genel: null, gunluk: [] };
    let previewData = null;
    let mahaller = [];
    let confirmCallback = null;


    // --- BAÅLANGIÃ‡ ---
    let currentPersonelAdi = null;
    
    auth.onAuthStateChanged(async (user) => {
      if (!user) { window.location.href = '../../index.html'; return; }
      currentUser = user;
      
      // Personel adÄ±nÄ± yÃ¼kle
      try {
        const uSnap = await db.collection('kullanicilar').doc(user.uid).get();
        const uData = uSnap.exists ? uSnap.data() : {};
        currentPersonelAdi = uData.adSoyad || user.displayName || user.email || 'Bilinmiyor';
      } catch(e) {
        currentPersonelAdi = user.displayName || user.email || 'Bilinmiyor';
      }
      
      await loadAktifRamazan();
      
      // TÃ¼m modallarÄ± kapat (sayfa yÃ¼klendiÄŸinde)
      document.querySelectorAll('.modal').forEach(modal => {
        modal.classList.remove('open');
      });
      
      // Bilgilendirme modalÄ±nÄ± gÃ¶ster (ilk aÃ§Ä±lÄ±ÅŸta veya localStorage yoksa)
      showInfoModalIfNeeded();
      
      // Teberru ve TaahhÃ¼t form validasyon event listener'larÄ±
      setupTeberruValidation();
      setupTaahhutValidation();
    });

    function setupTeberruValidation() {
      const bagisciInput = qs('#teberruBagisci');
      const miktarInput = qs('#teberruMiktar');
      
      if(bagisciInput) {
        bagisciInput.addEventListener('input', () => {
          qs('#teberruBagisciError').style.display = 'none';
          bagisciInput.style.borderColor = '';
        });
      }
      
      if(miktarInput) {
        miktarInput.addEventListener('input', () => {
          qs('#teberruMiktarError').style.display = 'none';
          miktarInput.style.borderColor = '';
        });
      }
      
      // Ã–deme yÃ¶ntemi seÃ§ildiÄŸinde hatayÄ± temizle
      const chips = qs('#teberruModal')?.querySelectorAll('.chip');
      if(chips) {
        chips.forEach(chip => {
          chip.addEventListener('click', () => {
            setTimeout(() => {
              if(qs('#teberruOdeme')?.value) {
                qs('#teberruOdemeError').style.display = 'none';
              }
            }, 100);
          });
        });
      }
    }

    function setupTaahhutValidation() {
      const bagisciInput = qs('#taahhutBagisci');
      const miktarInput = qs('#taahhutMiktar');
      
      if(bagisciInput) {
        bagisciInput.addEventListener('input', () => {
          qs('#taahhutBagisciError').style.display = 'none';
          bagisciInput.style.borderColor = '';
        });
      }
      
      if(miktarInput) {
        miktarInput.addEventListener('input', () => {
          qs('#taahhutMiktarError').style.display = 'none';
          miktarInput.style.borderColor = '';
        });
      }
    }

    function showInfoModalIfNeeded() {
      const dontShow = localStorage.getItem('iftarSahurInfoDontShow');
      if(!dontShow) {
        setTimeout(() => {
          qs('#infoModal').classList.add('open');
        }, 500); // Sayfa yÃ¼klendikten sonra gÃ¶ster
      } else {
        // "Bir daha gÃ¶sterme" seÃ§ilmiÅŸse pop-up gÃ¶ster
        setTimeout(() => {
          qs('#infoPopup').style.display = 'block';
        }, 1000);
      }
    }

    function closeInfoModal() {
      const dontShow = qs('#dontShowAgain').checked;
      if(dontShow) {
        localStorage.setItem('iftarSahurInfoDontShow', 'true');
      }
      qs('#infoModal').classList.remove('open');
      
      // EÄŸer "bir daha gÃ¶sterme" seÃ§ildiyse pop-up'Ä± gÃ¶ster
      if(dontShow) {
        setTimeout(() => {
          qs('#infoPopup').style.display = 'block';
        }, 500);
      }
    }

    function showInfoModalFromPopup() {
      qs('#infoPopup').style.display = 'none';
      qs('#infoModal').classList.add('open');
    }

    function closeInfoPopup() {
      qs('#infoPopup').style.display = 'none';
    }

    async function loadAktifRamazan() {
      try {
        // YÄ±llarÄ± Ã‡ek
        const snap = await db.collection('ramazan_serif').doc('ayarlar').collection('yillar').orderBy('yil', 'desc').get();
        const selYil = qs('#selYil');
        selYil.innerHTML = '';
        
        let activeDoc = null;
        snap.docs.forEach(doc => {
          const d = doc.data();
          const opt = document.createElement('option');
          opt.value = d.yil;
          opt.innerText = d.yil + (d.aktif ? ' (Aktif)' : '');
          if(d.aktif) { opt.selected = true; activeDoc = d; }
          selYil.appendChild(opt);
        });

        // Aktif yoksa sonuncuyu al
        if(!activeDoc && snap.docs.length > 0) activeDoc = snap.docs[0].data();
        if(activeDoc) setRamazanData(activeDoc);

        // YÄ±l DeÄŸiÅŸimi
        selYil.addEventListener('change', () => {
          const selectedYear = parseInt(selYil.value);
          const selectedDoc = snap.docs.find(d => d.data().yil === selectedYear);
          if(selectedDoc) setRamazanData(selectedDoc.data());
        });

      } catch (e) { console.error('Ramazan ayarÄ± yÃ¼klenemedi', e); }
    }

    async function setRamazanData(data) {
      CURRENT_YIL = data.yil;
      ramazanAyari = data;
      await loadTutarSecenekleri();
      await loadKapasiteAyarlari();
      await loadMahaller();
      loadKayitlar();
    }

    // Mahal yÃ¼kleme
    async function loadMahaller() {
      try {
        const snap = await db.collection('ramazan_serif').doc('ayarlar').collection('mahaller').orderBy('adi', 'asc').get();
        mahaller = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderMahaller();
      } catch(e) {
        console.error('Mahaller yÃ¼klenemedi:', e);
        mahaller = [];
        renderMahaller();
      }
    }

    // Mahal render (mÃ¼safir adedine gÃ¶re filtrele)
    function renderMahaller() {
      const container = qs('#mahalChips');
      if(!container) return; // Element henÃ¼z DOM'da yoksa Ã§Ä±k
      
      const musafirAdedi = parseInt(qs('#fGuest').value) || 0;
      
      if(mahaller.length === 0) {
        container.innerHTML = '<div class="chip" style="opacity:0.5;">Mahal bulunamadÄ±</div>';
        return;
      }

      const tarihStr = qs('#fDate').value;
      const tip = qs('#fType').value;
      const istirak = qs('#fIstirak').value === 'true';
      
      container.innerHTML = '';
      mahaller.forEach(m => {
        const minMusafir = m.minMusafir || 1;
        const maxMusafir = m.maxMusafir || 9999;
        const uyumlu = musafirAdedi >= minMusafir && musafirAdedi <= maxMusafir;
        
        // Mahal kontrolÃ¼: Her mahale bir tarihte sadece bir kayÄ±t (iftar/sahur ayrÄ±, sadece iÅŸtirak edenler iÃ§in)
        let mahalDolu = false;
        if(uyumlu && istirak && tarihStr) {
          const mahalCheck = checkMahalAvailability(tarihStr, tip, m.id);
          mahalDolu = !mahalCheck.allowed;
        }
        
        const chip = document.createElement('div');
        chip.className = `chip ${uyumlu && !mahalDolu ? '' : 'disabled'}`;
        chip.style.opacity = (uyumlu && !mahalDolu) ? '1' : '0.5';
        chip.style.cursor = (uyumlu && !mahalDolu) ? 'pointer' : 'not-allowed';
        chip.style.position = 'relative';
        
        if(mahalDolu) {
          chip.style.background = '#ffebee';
          chip.style.borderColor = '#f44336';
          chip.title = `${tip === 'iftar' ? 'Ä°ftar' : 'Sahur'} iÃ§in ${tarihStr} tarihinde bu mahal zaten dolu!`;
        } else if(!uyumlu) {
          chip.title = `Bu mahal iÃ§in mÃ¼safir sayÄ±sÄ± ${minMusafir}-${maxMusafir} arasÄ±nda olmalÄ±dÄ±r`;
        }
        
        if(uyumlu && !mahalDolu) {
          chip.onclick = () => selectChip('mahal', m.id, chip);
        }
        
        chip.innerHTML = `
          ${m.adi}
          ${!uyumlu ? `<span style="font-size:10px; margin-left:5px; color:#999;">(${minMusafir}-${maxMusafir})</span>` : ''}
          ${mahalDolu ? `<span style="font-size:10px; margin-left:5px; color:#f44336;">(Dolu)</span>` : ''}
        `;
        
        container.appendChild(chip);
      });
      
      // Ä°lk uyumlu ve dolu olmayan mahali seÃ§
      const firstUyumlu = mahaller.find(m => {
        const minMusafir = m.minMusafir || 1;
        const maxMusafir = m.maxMusafir || 9999;
        const uyumlu = musafirAdedi >= minMusafir && musafirAdedi <= maxMusafir;
        if(!uyumlu || !istirak || !tarihStr) return uyumlu;
        const mahalCheck = checkMahalAvailability(tarihStr, tip, m.id);
        return uyumlu && mahalCheck.allowed;
      });
      if(firstUyumlu) {
        qs('#fMahal').value = firstUyumlu.id;
        const firstChip = container.querySelector('.chip:not(.disabled)');
        if(firstChip) firstChip.classList.add('selected');
      }
    }

    // Toast bildirim fonksiyonu
    function showToast(message, type = 'info', duration = 3000) {
      const container = qs('#toastContainer');
      if(!container) return;
      
      const toast = document.createElement('div');
      const bgColor = type === 'error' ? '#dc3545' : type === 'success' ? '#28a745' : type === 'warning' ? '#ffc107' : '#17a2b8';
      const icon = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
      
      toast.style.cssText = `
        background: ${bgColor};
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        font-size: 14px;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 10px;
        animation: slideUp 0.3s ease-out;
        pointer-events: auto;
        max-width: 400px;
      `;
      
      toast.innerHTML = `
        <span style="font-size:18px;">${icon}</span>
        <span>${message}</span>
      `;
      
      container.appendChild(toast);
      
      setTimeout(() => {
        toast.style.animation = 'slideDown 0.3s ease-out';
        setTimeout(() => {
          if(toast.parentNode) {
            toast.parentNode.removeChild(toast);
          }
        }, 300);
      }, duration);
    }

    // Modal bildirim fonksiyonlarÄ±
    function showAlert(message, type = 'info') {
      // Basit mesajlar iÃ§in toast kullan
      if(message.includes('baÅŸarÄ±yla') || message.includes('silindi') || message.includes('kaydedildi') || message.includes('gÃ¼ncellendi') || message.includes('gÃ¶nderildi')) {
        showToast(message, 'success');
        return;
      }
      
      const content = qs('#alertContent');
      const icon = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'â„¹ï¸';
      const color = type === 'error' ? 'var(--danger)' : type === 'success' ? 'var(--success)' : 'var(--primary)';
      content.innerHTML = `<div style="font-size:48px; margin-bottom:15px;">${icon}</div><div style="font-size:16px; color:${color}; font-weight:600;">${message}</div>`;
      qs('#alertModal').classList.add('open');
    }

    function closeAlertModal() {
      qs('#alertModal').classList.remove('open');
    }
    
    // MenÃ¼ yÃ¼kleme ve gÃ¶rÃ¼ntÃ¼leme
    async function loadMenuler() {
      const container = qs('#menuDaysList');
      if(!container) return; // Container yoksa Ã§alÄ±ÅŸma
      
      if(!CURRENT_YIL || !ramazanAyari) {
        container.innerHTML = '<div style="text-align:center; padding:20px; color:#999">YÄ±l seÃ§imi yapÄ±lmamÄ±ÅŸ</div>';
        return;
      }

      try {
        const yilRef = db.collection('ramazan_serif').doc(String(CURRENT_YIL));
        const snap = await yilRef.collection('menuler').get();
        menuler = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderMenuDays();
      } catch(e) {
        console.error('MenÃ¼ler yÃ¼klenemedi:', e);
        menuler = [];
        if(container) {
          container.innerHTML = '<div style="text-align:center; padding:20px; color:#999">MenÃ¼ler yÃ¼klenemedi</div>';
        }
      }
    }

    function renderMenuDays() {
      const container = qs('#menuDaysList');
      if(!container) return;

      if(!ramazanAyari) {
        container.innerHTML = '<div style="text-align:center; padding:20px; color:#999">Ramazan ayarlarÄ± yÃ¼klenemedi</div>';
        return;
      }

      const basParts = ramazanAyari.baslangic.split('-');
      const bitParts = ramazanAyari.bitis.split('-');
      const start = new Date(basParts[0], basParts[1]-1, basParts[2], 12, 0, 0);
      const end = new Date(bitParts[0], bitParts[1]-1, bitParts[2], 12, 0, 0);
      
      let current = new Date(start);
      let dayCounter = 1;
      let html = '';

      while(current <= end) {
        const dateStr = current.toISOString().slice(0,10);
        const iftarMenu = menuler.find(m => {
          let mTarih = '';
          if(m.tarih) {
            if(m.tarih.toDate) mTarih = m.tarih.toDate().toISOString().slice(0,10);
            else if(m.tarih.seconds) mTarih = new Date(m.tarih.seconds * 1000).toISOString().slice(0,10);
            else if(typeof m.tarih === 'string') mTarih = m.tarih.slice(0,10);
          }
          return mTarih === dateStr && m.tip === 'iftar';
        });
        const sahurMenu = menuler.find(m => {
          let mTarih = '';
          if(m.tarih) {
            if(m.tarih.toDate) mTarih = m.tarih.toDate().toISOString().slice(0,10);
            else if(m.tarih.seconds) mTarih = new Date(m.tarih.seconds * 1000).toISOString().slice(0,10);
            else if(typeof m.tarih === 'string') mTarih = m.tarih.slice(0,10);
          }
          return mTarih === dateStr && m.tip === 'sahur';
        });

        const hasMenu = iftarMenu || sahurMenu;
        const tarihStr = current.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric' });
        const gunAdi = current.toLocaleDateString('tr-TR', { weekday: 'long' });

        html += `
          <div style="background:white; border-radius:12px; padding:15px; margin-bottom:12px; border:1px solid #e0e0e0; cursor:pointer; transition:0.2s;" 
               onclick="openMenuDetailModal('${dateStr}')" 
               onmouseover="this.style.borderColor='var(--primary)'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.1)'"
               onmouseout="this.style.borderColor='#e0e0e0'; this.style.transform='none'; this.style.boxShadow='none'">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
              <div>
                <div style="font-weight:700; font-size:16px; color:#2c3e50;">${dayCounter}. GÃ¼n</div>
                <div style="font-size:13px; color:#7f8c8d; margin-top:2px;">${tarihStr} - ${gunAdi}</div>
              </div>
              <div style="display:flex; gap:8px;">
                ${iftarMenu ? '<span style="background:var(--accent); color:white; padding:4px 10px; border-radius:6px; font-size:12px; font-weight:600;">ğŸŒ™ Ä°ftar</span>' : ''}
                ${sahurMenu ? '<span style="background:#3498db; color:white; padding:4px 10px; border-radius:6px; font-size:12px; font-weight:600;">ğŸŒŸ Sahur</span>' : ''}
                ${!hasMenu ? '<span style="background:#e0e0e0; color:#666; padding:4px 10px; border-radius:6px; font-size:12px;">MenÃ¼ yok</span>' : ''}
              </div>
            </div>
          </div>
        `;

        current.setDate(current.getDate() + 1);
        dayCounter++;
      }

      container.innerHTML = html || '<div style="text-align:center; padding:20px; color:#999">MenÃ¼ bulunamadÄ±</div>';
    }

    function openMenuDetailModal(dateStr) {
      // Modal sadece menÃ¼ gÃ¶rÃ¼nÃ¼mÃ¼ aÃ§Ä±kken aÃ§Ä±labilir
      const menuView = qs('#menuView');
      if(!menuView || menuView.style.display === 'none') {
        return; // MenÃ¼ gÃ¶rÃ¼nÃ¼mÃ¼ aÃ§Ä±k deÄŸilse modal aÃ§ma
      }

      const iftarMenu = menuler.find(m => {
        let mTarih = '';
        if(m.tarih) {
          if(m.tarih.toDate) mTarih = m.tarih.toDate().toISOString().slice(0,10);
          else if(m.tarih.seconds) mTarih = new Date(m.tarih.seconds * 1000).toISOString().slice(0,10);
          else if(typeof m.tarih === 'string') mTarih = m.tarih.slice(0,10);
        }
        return mTarih === dateStr && m.tip === 'iftar';
      });
      const sahurMenu = menuler.find(m => {
        let mTarih = '';
        if(m.tarih) {
          if(m.tarih.toDate) mTarih = m.tarih.toDate().toISOString().slice(0,10);
          else if(m.tarih.seconds) mTarih = new Date(m.tarih.seconds * 1000).toISOString().slice(0,10);
          else if(typeof m.tarih === 'string') mTarih = m.tarih.slice(0,10);
        }
        return mTarih === dateStr && m.tip === 'sahur';
      });

      const tarih = new Date(dateStr);
      const tarihStr = tarih.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric' });
      qs('#menuDetailTitle').textContent = `ğŸ½ï¸ ${tarihStr} MenÃ¼sÃ¼`;

      let content = '';

      // Ä°ftar MenÃ¼sÃ¼
      content += `
        <div style="margin-bottom:25px;">
          <h4 style="margin:0 0 15px 0; font-size:18px; font-weight:600; color:var(--accent); display:flex; align-items:center; gap:8px;">
            <span>ğŸŒ™</span> <span>Ä°ftar MenÃ¼sÃ¼</span>
          </h4>
      `;

      if(iftarMenu) {
        content += `
          <div style="background:#f8f9fa; border-radius:10px; padding:15px;">
            ${iftarMenu.corba ? `<div style="margin-bottom:12px;"><strong style="color:#495057;">ğŸ² Ã‡orba:</strong> <span style="color:#6c757d;">${iftarMenu.corba}</span></div>` : ''}
            ${iftarMenu.yemek ? `<div style="margin-bottom:12px;"><strong style="color:#495057;">ğŸ½ï¸ Yemek:</strong> <span style="color:#6c757d;">${iftarMenu.yemek}</span></div>` : ''}
            ${iftarMenu.soguk ? `<div style="margin-bottom:12px;"><strong style="color:#495057;">ğŸ¥— SoÄŸuk:</strong> <span style="color:#6c757d;">${iftarMenu.soguk}</span></div>` : ''}
            ${iftarMenu.icecek ? `<div style="margin-bottom:12px;"><strong style="color:#495057;">ğŸ¥¤ Ä°Ã§ecek:</strong> <span style="color:#6c757d;">${iftarMenu.icecek}</span></div>` : ''}
            ${iftarMenu.diger ? `<div style="margin-bottom:12px;"><strong style="color:#495057;">ğŸ° DiÄŸer:</strong> <span style="color:#6c757d;">${iftarMenu.diger}</span></div>` : ''}
          </div>
        `;
      } else {
        content += `
          <div style="background:#fff3cd; border-left:4px solid #ffc107; border-radius:10px; padding:15px; text-align:center;">
            <div style="color:#856404; font-weight:500;">Yemek menÃ¼sÃ¼ henÃ¼z daha belli deÄŸil</div>
          </div>
        `;
      }

      content += `</div>`;

      // Sahur MenÃ¼sÃ¼
      content += `
        <div>
          <h4 style="margin:0 0 15px 0; font-size:18px; font-weight:600; color:#3498db; display:flex; align-items:center; gap:8px;">
            <span>ğŸŒŸ</span> <span>Sahur MenÃ¼sÃ¼</span>
          </h4>
      `;

      if(sahurMenu) {
        content += `
          <div style="background:#f8f9fa; border-radius:10px; padding:15px;">
            ${sahurMenu.corba ? `<div style="margin-bottom:12px;"><strong style="color:#495057;">ğŸ² Ã‡orba:</strong> <span style="color:#6c757d;">${sahurMenu.corba}</span></div>` : ''}
            ${sahurMenu.yemek ? `<div style="margin-bottom:12px;"><strong style="color:#495057;">ğŸ½ï¸ Yemek:</strong> <span style="color:#6c757d;">${sahurMenu.yemek}</span></div>` : ''}
            ${sahurMenu.soguk ? `<div style="margin-bottom:12px;"><strong style="color:#495057;">ğŸ¥— SoÄŸuk:</strong> <span style="color:#6c757d;">${sahurMenu.soguk}</span></div>` : ''}
            ${sahurMenu.icecek ? `<div style="margin-bottom:12px;"><strong style="color:#495057;">ğŸ¥¤ Ä°Ã§ecek:</strong> <span style="color:#6c757d;">${sahurMenu.icecek}</span></div>` : ''}
            ${sahurMenu.diger ? `<div style="margin-bottom:12px;"><strong style="color:#495057;">ğŸ° DiÄŸer:</strong> <span style="color:#6c757d;">${sahurMenu.diger}</span></div>` : ''}
          </div>
        `;
      } else {
        content += `
          <div style="background:#fff3cd; border-left:4px solid #ffc107; border-radius:10px; padding:15px; text-align:center;">
            <div style="color:#856404; font-weight:500;">Yemek menÃ¼sÃ¼ henÃ¼z daha belli deÄŸil</div>
          </div>
        `;
      }

      content += `</div>`;

      qs('#menuDetailContent').innerHTML = content;
      const modal = qs('#menuDetailModal');
      if(modal) {
        modal.classList.add('open');
      }
    }

    function closeMenuDetailModal() {
      const modal = qs('#menuDetailModal');
      if(modal) {
        modal.classList.remove('open');
      }
    }

    function showConfirm(message, callback) {
      confirmCallback = callback;
      const content = qs('#confirmContent');
      content.innerHTML = `<div style="font-size:48px; margin-bottom:15px;">â“</div><div style="font-size:16px; color:var(--text); font-weight:600;">${message}</div>`;
      qs('#confirmModal').classList.add('open');
    }

    function confirmYes() {
      if(confirmCallback) {
        confirmCallback();
        confirmCallback = null;
      }
      closeConfirmModal();
    }

    function closeConfirmModal() {
      qs('#confirmModal').classList.remove('open');
      confirmCallback = null;
    }

    // --- KAPASÄ°TE AYARLARI YÃœKLEME ---
    async function loadKapasiteAyarlari() {
      try {
        // Genel kapasite
        const genelDoc = await db.collection('ramazan_serif').doc(String(CURRENT_YIL)).collection('ayarlar').doc('genel').get();
        if(genelDoc.exists) {
          kapasiteAyarlari.genel = genelDoc.data();
        } else {
          kapasiteAyarlari.genel = { iftarMax: null, sahurMax: null };
        }

        // GÃ¼nlÃ¼k kapasite ayarlarÄ±
        const gunlukSnap = await db.collection('ramazan_serif').doc(String(CURRENT_YIL)).collection('kapasite_ayarlari').get();
        kapasiteAyarlari.gunluk = gunlukSnap.docs.map(d => ({ id: d.id, ...d.data() }));
      } catch(e) {
        console.error('Kapasite ayarlarÄ± yÃ¼klenemedi:', e);
        kapasiteAyarlari.genel = { iftarMax: null, sahurMax: null };
        kapasiteAyarlari.gunluk = [];
      }
    }

    // GÃ¼n durumu belirleme (status renkleri iÃ§in)
    function getDayStatus(tarihStr, iftarCount, sahurCount) {
      // GÃ¼nlÃ¼k kapasite kontrolÃ¼
      const gunlukAyar = kapasiteAyarlari.gunluk.find(k => {
        let kTarih = '';
        if(k.tarih) {
          if(k.tarih.toDate) {
            kTarih = k.tarih.toDate().toISOString().slice(0,10);
          } else if(typeof k.tarih === 'string') {
            kTarih = k.tarih.slice(0,10);
          } else if(k.tarih instanceof Date) {
            kTarih = k.tarih.toISOString().slice(0,10);
          }
        }
        return kTarih === tarihStr;
      });

      let iftarMax = null;
      let sahurMax = null;
      
      if(gunlukAyar) {
        iftarMax = gunlukAyar.iftarMax;
        sahurMax = gunlukAyar.sahurMax;
      } else if(kapasiteAyarlari.genel) {
        iftarMax = kapasiteAyarlari.genel.iftarMax;
        sahurMax = kapasiteAyarlari.genel.sahurMax;
      }

      // Status belirleme
      let statusClass = 'status-green';
      let statusText = 'MÃ¼sait';
      
      const iftarDolu = iftarMax !== null && iftarMax !== undefined && iftarCount >= iftarMax;
      const sahurDolu = sahurMax !== null && sahurMax !== undefined && sahurCount >= sahurMax;
      
      if(iftarDolu && sahurDolu) {
        statusClass = 'status-red';
        statusText = 'Dolu';
      } else if(iftarDolu || sahurDolu) {
        statusClass = 'status-orange';
        statusText = 'Doluyor';
      } else if(iftarMax !== null || sahurMax !== null) {
        // Kapasite limiti var ama henÃ¼z dolmamÄ±ÅŸ
        const iftarYuzde = iftarMax ? (iftarCount / iftarMax) * 100 : 0;
        const sahurYuzde = sahurMax ? (sahurCount / sahurMax) * 100 : 0;
        const maxYuzde = Math.max(iftarYuzde, sahurYuzde);
        if(maxYuzde >= 80) {
          statusClass = 'status-orange';
          statusText = 'Doluyor';
        }
      }

      return { class: statusClass, text: statusText };
    }

    // Kapasite kontrolÃ¼
    function checkKapasite(tarihStr, tip) {
      const dayRecs = kayitlar.filter(k => {
        let kStr = '';
        if(k.tarih.toDate) kStr = k.tarih.toDate().toISOString().slice(0,10);
        else if(typeof k.tarih === 'string') kStr = k.tarih.slice(0,10);
        return kStr === tarihStr && k.tip === tip;
      });
      // Sadece iÅŸtirak edenleri say (kapasite kontrolÃ¼ iÃ§in)
      const mevcutSayi = dayRecs.filter(k => k.istirak === true).length;

      // Ã–nce gÃ¼nlÃ¼k kapasite kontrolÃ¼
      const gunlukAyar = kapasiteAyarlari.gunluk.find(k => {
        let kTarih = '';
        if(k.tarih) {
          if(k.tarih.toDate) {
            kTarih = k.tarih.toDate().toISOString().slice(0,10);
          } else if(typeof k.tarih === 'string') {
            kTarih = k.tarih.slice(0,10);
          } else if(k.tarih instanceof Date) {
            kTarih = k.tarih.toISOString().slice(0,10);
          }
        }
        return kTarih === tarihStr;
      });

      let maxLimit = null;
      if(gunlukAyar) {
        maxLimit = tip === 'iftar' ? gunlukAyar.iftarMax : gunlukAyar.sahurMax;
      } else if(kapasiteAyarlari.genel) {
        maxLimit = tip === 'iftar' ? kapasiteAyarlari.genel.iftarMax : kapasiteAyarlari.genel.sahurMax;
      }

      if(maxLimit !== null && maxLimit !== undefined && mevcutSayi >= maxLimit) {
        return { allowed: false, message: `${tip === 'iftar' ? 'Ä°ftar' : 'Sahur'} kapasitesi dolmuÅŸ! (Max: ${maxLimit})` };
      }

      return { allowed: true };
    }

    // Mahal kontrolÃ¼: Her mahale bir tarihte sadece bir kayÄ±t (iftar/sahur ayrÄ±)
    function checkMahalAvailability(tarihStr, tip, mahalId, excludeRecordId = null) {
      if(!mahalId) {
        return { allowed: true };
      }

      const dayRecs = kayitlar.filter(k => {
        let kStr = '';
        if(k.tarih.toDate) kStr = k.tarih.toDate().toISOString().slice(0,10);
        else if(typeof k.tarih === 'string') kStr = k.tarih.slice(0,10);
        return kStr === tarihStr && k.tip === tip && k.istirak === true;
      });

      // excludeRecordId varsa (yer deÄŸiÅŸtir durumunda), o kaydÄ± hariÃ§ tut
      const filteredRecs = excludeRecordId 
        ? dayRecs.filter(k => k.id !== excludeRecordId)
        : dayRecs;

      const mahalDolu = filteredRecs.some(k => k.mahalId === mahalId && !k.silindi);
      
      if(mahalDolu) {
        const mahal = mahaller.find(m => m.id === mahalId);
        const mahalAdi = mahal ? mahal.adi : 'SeÃ§ilen mahal';
        return { 
          allowed: false, 
          message: `${tip === 'iftar' ? 'Ä°ftar' : 'Sahur'} iÃ§in ${tarihStr} tarihinde ${mahalAdi} zaten dolu! LÃ¼tfen baÅŸka bir mahal veya tarih seÃ§iniz.` 
        };
      }

      return { allowed: true };
    }

    // --- TUTAR YÃœKLEME (Tip'e gÃ¶re filtreleme ile) ---
    async function loadTutarSecenekleri() {
      const container = qs('#priceChips');
      container.innerHTML = '<div class="chip">YÃ¼kleniyor...</div>';
      tutarSecenekleri = [];

      try {
        const snap = await db.collection('ramazan_serif').doc(String(CURRENT_YIL)).collection('tutar_secenekleri').where('aktif', '==', true).get();
        const allTutarlar = snap.docs.map(d => d.data());
        // SÄ±ralama
        allTutarlar.sort((a, b) => (a.sira || 0) - (b.sira || 0));
        tutarSecenekleri = allTutarlar;
      } catch(e) { 
        console.error('Tutar hatasÄ±:', e); 
      }

      // EÄŸer veritabanÄ± boÅŸsa veya hata varsa varsayÄ±lanlarÄ± gÃ¶ster
      if(tutarSecenekleri.length === 0) {
        tutarSecenekleri = [
          {tutar: 250, label: 'Standart', tip: null},
          {tutar: 500, label: 'Tam', tip: null},
          {tutar: 1000, label: 'Ã–zel', tip: null}
        ];
      }
      renderPriceChips();
    }

    function renderPriceChips() {
      const container = qs('#priceChips');
      container.innerHTML = '';
      const selectedType = qs('#fType').value;
      
      // Tip'e gÃ¶re filtrele: tip null ise genel (her ikisi iÃ§in), aksi halde seÃ§ilen tip ile eÅŸleÅŸmeli
      const filteredTutarlar = tutarSecenekleri.filter(t => !t.tip || t.tip === selectedType || t.tip === null);
      
      if(filteredTutarlar.length === 0) {
        container.innerHTML = '<div class="chip" style="color:#999">Bu tip iÃ§in tutar seÃ§eneÄŸi bulunamadÄ±</div>';
        qs('#fPrice').value = '';
        return;
      }

      filteredTutarlar.forEach((t, i) => {
        const chip = document.createElement('div');
        chip.className = `chip ${i===0 ? 'selected' : ''}`;
        chip.innerText = `${t.tutar}â‚º${t.label ? ' - ' + t.label : ''}`;
        chip.onclick = () => selectChip('price', t.tutar, chip);
        container.appendChild(chip);
      });
      // Ä°lk deÄŸeri ata
      if(filteredTutarlar.length > 0) qs('#fPrice').value = filteredTutarlar[0].tutar;
    }

    function loadKayitlar() {
      db.collection('ramazan_serif').doc(String(CURRENT_YIL)).collection('kayitlar')
        .onSnapshot(snap => {
          kayitlar = snap.docs.map(d => ({id: d.id, ...d.data()}));
          renderAllViews();
          // Takvimim gÃ¶rÃ¼nÃ¼mÃ¼ aÃ§Ä±ksa gÃ¼ncelle
          if(qs('#takvimimView').style.display !== 'none') {
            loadMyRecords();
          }
        });
    }

    function renderAllViews() {
      renderTimeline(); // Mobil
      renderDesktopCalendar(); // MasaÃ¼stÃ¼
    }

    // --- MOBÄ°L TIMELINE ---
    function renderTimeline() {
      const container = qs('#mobileView');
      container.innerHTML = '';

      const basParts = ramazanAyari.baslangic.split('-');
      const bitParts = ramazanAyari.bitis.split('-');
      const start = new Date(basParts[0], basParts[1]-1, basParts[2], 12, 0, 0);
      const end = new Date(bitParts[0], bitParts[1]-1, bitParts[2], 12, 0, 0);
      
      let current = new Date(start);
      let dayCounter = 1;

      while(current <= end) {
        const dateStr = current.toISOString().slice(0,10);
        const dayRecs = kayitlar.filter(k => {
           // Tarih parse gÃ¼venliÄŸi
           let kStr = '';
           if(k.tarih.toDate) kStr = k.tarih.toDate().toISOString().slice(0,10);
           else if(typeof k.tarih === 'string') kStr = k.tarih.slice(0,10);
           return kStr === dateStr;
        });

        // Ä°ÅŸtirak eden ve etmeyen kayÄ±tlarÄ± ayÄ±r
        const iftarIstirakEden = dayRecs.filter(k => k.tip === 'iftar' && k.istirak === true).length;
        const iftarIstirakEtmeyen = dayRecs.filter(k => k.tip === 'iftar' && k.istirak === false).length;
        const sahurIstirakEden = dayRecs.filter(k => k.tip === 'sahur' && k.istirak === true).length;
        const sahurIstirakEtmeyen = dayRecs.filter(k => k.tip === 'sahur' && k.istirak === false).length;
        
        // Kapasite kontrolÃ¼ iÃ§in sadece iÅŸtirak edenleri say
        const iftarCount = iftarIstirakEden;
        const sahurCount = sahurIstirakEden;

        // Kapasite kontrolÃ¼ ile status belirleme
        const statusInfo = getDayStatus(dateStr, iftarCount, sahurCount);
        const statusClass = statusInfo.class;
        const statusText = statusInfo.text;
        
        // Kapasite bilgisi
        const gunlukAyar = kapasiteAyarlari.gunluk.find(k => {
          let kTarih = '';
          if(k.tarih) {
            if(k.tarih.toDate) kTarih = k.tarih.toDate().toISOString().slice(0,10);
            else if(typeof k.tarih === 'string') kTarih = k.tarih.slice(0,10);
            else if(k.tarih instanceof Date) kTarih = k.tarih.toISOString().slice(0,10);
          }
          return kTarih === dateStr;
        });
        const iftarMax = gunlukAyar ? gunlukAyar.iftarMax : (kapasiteAyarlari.genel ? kapasiteAyarlari.genel.iftarMax : null);
        const sahurMax = gunlukAyar ? gunlukAyar.sahurMax : (kapasiteAyarlari.genel ? kapasiteAyarlari.genel.sahurMax : null);
        
        // GÃ¶sterim formatÄ±: "3/5, 4" (iÅŸtirak eden/max, iÅŸtirak etmeyen)
        let iftarText = iftarCount.toString();
        if(iftarMax !== null && iftarMax !== undefined) {
          iftarText = `${iftarIstirakEden}/${iftarMax}`;
          if(iftarIstirakEtmeyen > 0) {
            iftarText += `, ${iftarIstirakEtmeyen}`;
          }
        } else if(iftarIstirakEtmeyen > 0) {
          iftarText += `, ${iftarIstirakEtmeyen}`;
        }
        
        let sahurText = sahurCount.toString();
        if(sahurMax !== null && sahurMax !== undefined) {
          sahurText = `${sahurIstirakEden}/${sahurMax}`;
          if(sahurIstirakEtmeyen > 0) {
            sahurText += `, ${sahurIstirakEtmeyen}`;
          }
        } else if(sahurIstirakEtmeyen > 0) {
          sahurText += `, ${sahurIstirakEtmeyen}`;
        }

        const card = document.createElement('div');
        card.className = `day-card ${statusClass}`;
        const dStr = dateStr; 
        card.onclick = () => showDayRecords(dStr);

        card.innerHTML = `
          <div class="dc-date">
            <span class="dc-day-num">${current.getDate()}</span>
            <span class="dc-day-name">${current.toLocaleDateString('tr-TR', {weekday:'short'})}</span>
          </div>
          <div class="dc-info">
            <div class="dc-ramazan">${dayCounter}. GÃœN</div>
            <div class="dc-status">${statusText}</div>
            <div class="dc-details">
               <span class="badge-mini" style="background:#f39c12; padding:2px 6px; border-radius:4px; color:white; font-size:10px">Ä°ftar: ${iftarText}</span>
               <span class="badge-mini" style="background:#3498db; padding:2px 6px; border-radius:4px; color:white; font-size:10px">Sahur: ${sahurText}</span>
            </div>
          </div>
          <div class="dc-action">+</div>
        `;
        container.appendChild(card);

        current.setDate(current.getDate() + 1);
        dayCounter++;
      }
    }

    // --- MASAÃœSTÃœ TAKVÄ°M ---
    function renderDesktopCalendar() {
      const container = qs('#desktopView');
      container.innerHTML = '';

      const basParts = ramazanAyari.baslangic.split('-');
      const start = new Date(basParts[0], basParts[1]-1, basParts[2]);
      const monthStart = new Date(start.getFullYear(), start.getMonth(), 1);
      
      // BoÅŸ gÃ¼nler
      const firstDay = (monthStart.getDay() + 6) % 7; // Pzt baÅŸlasÄ±n
      for(let i=0; i<firstDay; i++) {
        const empty = document.createElement('div'); empty.className='cal-cell empty'; container.appendChild(empty);
      }

      // Basit mantÄ±k: Sadece Ramazan gÃ¼nlerini doldurmuyorum, 35 gÃ¼nlÃ¼k bir Ä±zgara yapÄ±yorum demo iÃ§in
      // GerÃ§ekte ayÄ±n gÃ¼nleri dÃ¶nmeli. Buraya mobil akÄ±ÅŸ mantÄ±ÄŸÄ±nÄ± grid'e uyarlÄ±yorum:
      
      const bitParts = ramazanAyari.bitis.split('-');
      const end = new Date(bitParts[0], bitParts[1]-1, bitParts[2], 12, 0, 0);
      let current = new Date(start);
      current.setHours(12,0,0,0);

      while(current <= end) {
        const dateStr = current.toISOString().slice(0,10);
        const dayRecs = kayitlar.filter(k => {
           let kStr = '';
           if(k.tarih.toDate) kStr = k.tarih.toDate().toISOString().slice(0,10);
           else if(typeof k.tarih === 'string') kStr = k.tarih.slice(0,10);
           return kStr === dateStr;
        });
        
        // Ä°ÅŸtirak eden ve etmeyen kayÄ±tlarÄ± ayÄ±r
        const iftarIstirakEden = dayRecs.filter(k => k.tip === 'iftar' && k.istirak === true).length;
        const iftarIstirakEtmeyen = dayRecs.filter(k => k.tip === 'iftar' && k.istirak === false).length;
        const sahurIstirakEden = dayRecs.filter(k => k.tip === 'sahur' && k.istirak === true).length;
        const sahurIstirakEtmeyen = dayRecs.filter(k => k.tip === 'sahur' && k.istirak === false).length;
        
        // Kapasite kontrolÃ¼ iÃ§in sadece iÅŸtirak edenleri say
        const iftarCount = iftarIstirakEden;
        const sahurCount = sahurIstirakEden;
        
        // Kapasite kontrolÃ¼ ile status belirleme
        const statusInfo = getDayStatus(dateStr, iftarCount, sahurCount);
        
        const cell = document.createElement('div');
        cell.className = `cal-cell ${statusInfo.class.replace('status-', 'cal-')}`;
        const dStr = dateStr;
        cell.onclick = () => showDayRecords(dStr);

        // Kapasite bilgisi
        const gunlukAyar = kapasiteAyarlari.gunluk.find(k => {
          let kTarih = '';
          if(k.tarih) {
            if(k.tarih.toDate) kTarih = k.tarih.toDate().toISOString().slice(0,10);
            else if(typeof k.tarih === 'string') kTarih = k.tarih.slice(0,10);
            else if(k.tarih instanceof Date) kTarih = k.tarih.toISOString().slice(0,10);
          }
          return kTarih === dateStr;
        });
        const iftarMax = gunlukAyar ? gunlukAyar.iftarMax : (kapasiteAyarlari.genel ? kapasiteAyarlari.genel.iftarMax : null);
        const sahurMax = gunlukAyar ? gunlukAyar.sahurMax : (kapasiteAyarlari.genel ? kapasiteAyarlari.genel.sahurMax : null);
        
        // GÃ¶sterim formatÄ±: "3/5, 4" (iÅŸtirak eden/max, iÅŸtirak etmeyen)
        let iftarText = iftarCount.toString();
        if(iftarMax !== null && iftarMax !== undefined) {
          iftarText = `${iftarIstirakEden}/${iftarMax}`;
          if(iftarIstirakEtmeyen > 0) {
            iftarText += `, ${iftarIstirakEtmeyen}`;
          }
        } else if(iftarIstirakEtmeyen > 0) {
          iftarText += `, ${iftarIstirakEtmeyen}`;
        }
        
        let sahurText = sahurCount.toString();
        if(sahurMax !== null && sahurMax !== undefined) {
          sahurText = `${sahurIstirakEden}/${sahurMax}`;
          if(sahurIstirakEtmeyen > 0) {
            sahurText += `, ${sahurIstirakEtmeyen}`;
          }
        } else if(sahurIstirakEtmeyen > 0) {
          sahurText += `, ${sahurIstirakEtmeyen}`;
        }

        cell.innerHTML = `
          <div class="cc-header">
             <span class="cc-num">${current.getDate()}</span>
             <span class="cc-day">${current.toLocaleDateString('tr-TR', {weekday:'short'})}</span>
          </div>
          <div class="cc-badges">
             <div class="cc-badge cc-iftar ${iftarMax !== null && iftarCount >= iftarMax ? 'cc-full' : ''}">ğŸŒ™ Ä°ftar: ${iftarText}</div>
             <div class="cc-badge cc-sahur ${sahurMax !== null && sahurCount >= sahurMax ? 'cc-full' : ''}">ğŸŒŸ Sahur: ${sahurText}</div>
          </div>
        `;
        container.appendChild(cell);
        current.setDate(current.getDate() + 1);
      }
    }

    // --- FORM FONKSÄ°YONLARI ---
    let selectedDateForForm = null;

    function showDayRecords(dateStr) {
      selectedDateForForm = dateStr;
      const dayRecs = kayitlar.filter(k => {
        let kStr = '';
        if(k.tarih.toDate) kStr = k.tarih.toDate().toISOString().slice(0,10);
        else if(typeof k.tarih === 'string') kStr = k.tarih.slice(0,10);
        return kStr === dateStr;
      });

      // KayÄ±t sÄ±rasÄ±na gÃ¶re sÄ±rala (createdAt'e gÃ¶re)
      dayRecs.sort((a, b) => {
        const aTime = a.createdAt?.toDate ? a.createdAt.toDate().getTime() : (a.createdAt?.seconds || 0) * 1000;
        const bTime = b.createdAt?.toDate ? b.createdAt.toDate().getTime() : (b.createdAt?.seconds || 0) * 1000;
        return aTime - bTime; // En eski en Ã¼stte
      });

      const content = qs('#dayRecordsContent');
      const dateObj = new Date(dateStr);
      
      if(dayRecs.length === 0) {
        content.innerHTML = `<div style="text-align:center; padding:30px; color:#999;">
          <div style="font-size:48px; margin-bottom:10px;">ğŸ“…</div>
          <div>Bu gÃ¼n iÃ§in henÃ¼z kayÄ±t bulunmamaktadÄ±r</div>
        </div>`;
      } else {
        content.innerHTML = `
          <div style="font-size:14px; font-weight:600; color:var(--primary); margin-bottom:15px; padding-bottom:10px; border-bottom:1px solid #eee;">
            ${dateObj.toLocaleDateString('tr-TR', {dateStyle:'full'})}
          </div>
          <div style="display:flex; flex-direction:column; gap:10px;">
            ${dayRecs.map((k, idx) => {
              const tipLabel = k.tip === 'iftar' ? 'ğŸŒ™ Ä°ftar' : 'ğŸŒŸ Sahur';
              const mahalName = k.mahalId ? (mahaller.find(m => m.id === k.mahalId)?.adi || '') : '';
              const personelName = k.personelAdi || k.personel || 'Bilinmiyor';
              return `
                <div style="background:#f8f9fa; padding:12px; border-radius:8px; border-left:3px solid ${k.tip === 'iftar' ? 'var(--accent)' : '#3498db'};">
                  <div style="display:flex; justify-content:space-between; align-items:start; margin-bottom:8px;">
                    <div style="flex:1;">
                      <div style="font-weight:600; color:var(--text); margin-bottom:4px;">${idx + 1}. ${k.sahip}</div>
                      <div style="font-size:12px; color:#7f8c8d;">
                        ${tipLabel} â€¢ ${k.tutar}â‚º
                        ${k.musafirAdedi > 0 ? ` â€¢ ${k.musafirAdedi} mÃ¼safir` : ''}
                        ${mahalName ? ` â€¢ ğŸ›ï¸ ${mahalName}` : ''}
                        ${k.istirak ? ' â€¢ âœ“ Ä°ÅŸtirak' : ''}
                      </div>
                      <div style="font-size:11px; color:#95a5a6; margin-top:4px;">
                        ğŸ‘¤ Kaydeden: ${personelName}
                      </div>
                      ${k.not ? `<div style="font-size:12px; color:#95a5a6; margin-top:6px; font-style:italic;">ğŸ“ ${k.not}</div>` : ''}
                    </div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        `;
      }
      
      qs('#dayRecordsModal').classList.add('open');
    }

    function closeDayRecordsModal() {
      qs('#dayRecordsModal').classList.remove('open');
      selectedDateForForm = null;
    }

    function openFormModalFromDay() {
      const dateToOpen = selectedDateForForm; // Ã–nce tarihi sakla
      closeDayRecordsModal();
      if(dateToOpen) {
        // KÄ±sa bir gecikme ile modal aÃ§ (DOM gÃ¼ncellemesi iÃ§in)
        setTimeout(() => {
          openFormModal(dateToOpen);
        }, 100);
      }
    }

    function openFormModal(dateStr) {
      qs('#fDate').value = dateStr;
      qs('#fDateDisplay').innerText = new Date(dateStr).toLocaleDateString('tr-TR', {dateStyle:'full'});
      qs('#fName').value = '';
      qs('#fGuest').value = 0; 
      qs('#fGuestVal').innerText = '0';
      qs('#fNote').value = '';
      qs('#fMahal').value = '';
      qs('#fIstirak').value = 'true';
      // Ä°ÅŸtirak chip'lerini sÄ±fÄ±rla
      qs('#istirakChips').querySelectorAll('.chip').forEach((c, i) => {
        c.classList.remove('selected');
        if(i === 0) c.classList.add('selected');
      });
      // Ä°ÅŸtirak alanlarÄ±nÄ± gÃ¶ster
      qs('#istirakEvetFields').style.display = 'block';
      renderMahaller(); // Tarih deÄŸiÅŸtiÄŸinde mahalleri yeniden render et // Mahalleri yeniden render et
      qs('#formModal').classList.add('open');
    }

    function closeModal() { qs('#formModal').classList.remove('open'); }

    function selectChip(group, val, el) {
      if(!el) el = event.target;
      if(el.classList.contains('disabled')) return; // Disabled chip'leri seÃ§ilemez
      el.parentElement.querySelectorAll('.chip').forEach(c => c.classList.remove('selected'));
      el.classList.add('selected');
      if(group === 'type') {
        qs('#fType').value = val;
        // Tip deÄŸiÅŸince tutar seÃ§eneklerini yeniden yÃ¼kle
        renderPriceChips();
      }
      if(group === 'price') qs('#fPrice').value = val;
      if(group === 'mahal') qs('#fMahal').value = val;
      if(group === 'odeme') {
        qs('#teberruOdeme').value = val;
        // Ã–deme yÃ¶ntemi seÃ§ildiÄŸinde hatayÄ± temizle
        qs('#teberruOdemeError').style.display = 'none';
      }
      if(group === 'istirak') {
        qs('#fIstirak').value = val;
        // Ä°ÅŸtirak deÄŸiÅŸince alanlarÄ± gÃ¶ster/gizle
        const istirakFields = qs('#istirakEvetFields');
        if(val === true || val === 'true') {
          istirakFields.style.display = 'block';
        } else {
          istirakFields.style.display = 'none';
          qs('#fGuest').value = 0;
          qs('#fGuestVal').innerText = '0';
          qs('#fMahal').value = '';
        }
        renderMahaller(); // Mahalleri yeniden render et
      }
      if(group === 'type' || group === 'date') {
        renderMahaller(); // Tip veya tarih deÄŸiÅŸince mahalleri yeniden render et
      }
    }

    function stepGuest(n) {
      let v = parseInt(qs('#fGuest').value) + n;
      if(v < 0) v = 0;
      qs('#fGuest').value = v;
      qs('#fGuestVal').innerText = v;
      // MÃ¼safir adedi deÄŸiÅŸince mahalleri yeniden render et
      renderMahaller();
    }

    qs('#smartForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const tarihStr = qs('#fDate').value;
      const tip = qs('#fType').value;
      const tutar = parseInt(qs('#fPrice').value);
      const sahip = qs('#fName').value.trim();
      const mahalId = qs('#fMahal').value;
      
      if(!sahip) {
        showAlert('LÃ¼tfen iftar sahibi adÄ±nÄ± giriniz', 'error');
        return;
      }

      if(!tutar || tutar <= 0) {
        showAlert('LÃ¼tfen geÃ§erli bir tutar seÃ§iniz', 'error');
        return;
      }

      const musafirAdedi = parseInt(qs('#fGuest').value) || 0;
      if(mahalId) {
        const mahal = mahaller.find(m => m.id === mahalId);
        if(mahal) {
          const minMusafir = mahal.minMusafir || 1;
          const maxMusafir = mahal.maxMusafir || 9999;
          if(musafirAdedi < minMusafir || musafirAdedi > maxMusafir) {
            showAlert(`SeÃ§ilen mahal iÃ§in mÃ¼safir sayÄ±sÄ± ${minMusafir}-${maxMusafir} arasÄ±nda olmalÄ±dÄ±r`, 'error');
            return;
          }
        }
      }

      // Kapasite kontrolÃ¼
      const kapasiteCheck = checkKapasite(tarihStr, tip);
      if(!kapasiteCheck.allowed) {
        showAlert(kapasiteCheck.message, 'error');
        return;
      }

      // Mahal kontrolÃ¼: Her mahale bir tarihte sadece bir kayÄ±t (iftar/sahur ayrÄ±)
      if(mahalId && qs('#fIstirak').value === 'true') {
        const mahalCheck = checkMahalAvailability(tarihStr, tip, mahalId, null);
        if(!mahalCheck.allowed) {
          showAlert(mahalCheck.message, 'error');
          return;
        }
      }

      const tParts = tarihStr.split('-');
      const dbDate = new Date(tParts[0], tParts[1]-1, tParts[2], 12, 0, 0);

      previewData = {
        tarih: dbDate,
        tip: tip,
        tutar: tutar,
        sahip: sahip,
        musafirAdedi: musafirAdedi,
        mahalId: mahalId || null,
        mahal: mahalId ? (mahaller.find(m => m.id === mahalId)?.adi || null) : null,
        istirak: qs('#fIstirak').value === 'true',
        not: qs('#fNote').value.trim(),
        personelUid: currentUser.uid,
        personel: currentUser.email,
        personelAdi: currentPersonelAdi || 'Bilinmiyor',
        yil: CURRENT_YIL
      };

      // Ã–nizleme gÃ¶ster
      showPreview();
    });

    function showPreview() {
      const content = qs('#previewContent');
      const tipLabel = previewData.tip === 'iftar' ? 'ğŸŒ™ Ä°ftar' : 'ğŸŒŸ Sahur';
      content.innerHTML = `
        <div style="margin-bottom:10px;"><strong>Tarih:</strong> ${previewData.tarih.toLocaleDateString('tr-TR', {dateStyle:'full'})}</div>
        <div style="margin-bottom:10px;"><strong>Tip:</strong> ${tipLabel}</div>
        <div style="margin-bottom:10px;"><strong>Ä°ftar Sahibi:</strong> ${previewData.sahip}</div>
        <div style="margin-bottom:10px;"><strong>Tutar:</strong> ${previewData.tutar}â‚º</div>
        <div style="margin-bottom:10px;"><strong>MÃ¼safir SayÄ±sÄ±:</strong> ${previewData.musafirAdedi}</div>
        ${previewData.mahal ? `<div style="margin-bottom:10px;"><strong>Mahal:</strong> ${previewData.mahal}</div>` : ''}
        <div style="margin-bottom:10px;"><strong>Ä°ÅŸtirak:</strong> ${previewData.istirak ? 'âœ“ Evet' : 'âœ— HayÄ±r'}</div>
        ${previewData.not ? `<div style="margin-bottom:10px;"><strong>Not:</strong> ${previewData.not}</div>` : ''}
      `;
      qs('#previewModal').classList.add('open');
    }

    function closePreviewModal() {
      qs('#previewModal').classList.remove('open');
      previewData = null;
    }

    async function confirmSave() {
      if(!previewData) return;
      
      const btn = qs('#previewModal').querySelector('.btn-primary');
      btn.disabled = true;
      btn.innerText = 'Kaydediliyor...';

      try {
        const data = {
          ...previewData,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        await db.collection('ramazan_serif').doc(String(CURRENT_YIL)).collection('kayitlar').add(data);
        closePreviewModal();
        closeModal();
        
        // BaÅŸarÄ± mesajÄ±
        showAlert('KayÄ±t baÅŸarÄ±yla eklendi!', 'success');
      } catch(err) {
        showAlert('Hata: ' + err.message, 'error');
      } finally {
        btn.disabled = false;
        btn.innerText = 'KAYDET';
      }
    }

    // Takvimim gÃ¶rÃ¼nÃ¼mÃ¼
    function switchView(view) {
      const navBtns = document.querySelectorAll('.nav-btn');
      const takvimBtn = navBtns[0];
      const kayitlarimBtn = navBtns[1];
      const teberruBtn = navBtns[2];
      const menuBtn = navBtns[3];
      const mainContainer = qs('.main-container');
      const takvimimView = qs('#takvimimView');
      const teberruView = qs('#teberruView');
      const menuView = qs('#menuView');

      // TÃ¼m butonlarÄ± pasif yap
      navBtns.forEach(btn => btn.classList.remove('active'));

      if(view === 'takvim') {
        takvimBtn.classList.add('active');
        if(mainContainer) mainContainer.style.display = 'block';
        if(takvimimView) takvimimView.style.display = 'none';
        if(teberruView) teberruView.style.display = 'none';
        if(menuView) menuView.style.display = 'none';
        // MenÃ¼ modalÄ±nÄ± kapat
        closeMenuDetailModal();
      } else if(view === 'takvimim') {
        kayitlarimBtn.classList.add('active');
        if(mainContainer) mainContainer.style.display = 'none';
        if(takvimimView) takvimimView.style.display = 'block';
        if(teberruView) teberruView.style.display = 'none';
        if(menuView) menuView.style.display = 'none';
        // MenÃ¼ modalÄ±nÄ± kapat
        closeMenuDetailModal();
        loadMyRecords();
      } else if(view === 'teberru') {
        teberruBtn.classList.add('active');
        if(mainContainer) mainContainer.style.display = 'none';
        if(takvimimView) takvimimView.style.display = 'none';
        if(teberruView) teberruView.style.display = 'block';
        if(menuView) menuView.style.display = 'none';
        // MenÃ¼ modalÄ±nÄ± kapat
        closeMenuDetailModal();
      } else if(view === 'menu') {
        menuBtn.classList.add('active');
        if(mainContainer) mainContainer.style.display = 'none';
        if(takvimimView) takvimimView.style.display = 'none';
        if(teberruView) teberruView.style.display = 'none';
        if(menuView) menuView.style.display = 'block';
        loadMenuler();
      }
    }

    let teberruKayitlari = [];
    let taahhutKayitlari = [];
    let menuler = [];

    async function loadTeberruKayitlari() {
      if(!currentUser) {
        teberruKayitlari = [];
        return;
      }
      try {
        // TÃ¼m teberru kayÄ±tlarÄ±nÄ± getir (yÄ±l filtresi client-side yapÄ±lacak)
        const snap = await db.collection('teberru_kayitlari')
          .where('personelUid', '==', currentUser.uid)
          .get();
        
        let allTeberru = snap.docs.map(d => ({ id: d.id, ...d.data(), tip: 'teberru' }));
        
        // CURRENT_YIL varsa filtrele
        if(CURRENT_YIL) {
          const yilNum = typeof CURRENT_YIL === 'number' ? CURRENT_YIL : parseInt(CURRENT_YIL);
          allTeberru = allTeberru.filter(t => {
            const tYil = typeof t.yil === 'number' ? t.yil : parseInt(t.yil);
            return tYil === yilNum;
          });
        }
        
        teberruKayitlari = allTeberru;
        // Tarihe gÃ¶re sÄ±rala (client-side)
        teberruKayitlari.sort((a, b) => {
          const aDate = a.createdAt?.toDate ? a.createdAt.toDate().getTime() : (a.createdAt?.seconds || 0) * 1000;
          const bDate = b.createdAt?.toDate ? b.createdAt.toDate().getTime() : (b.createdAt?.seconds || 0) * 1000;
          return aDate - bDate; // Eskiden yeniye
        });
      } catch(e) {
        console.error('Teberru kayÄ±tlarÄ± yÃ¼klenemedi:', e);
        teberruKayitlari = [];
      }
    }

    async function loadTaahhutKayitlari() {
      if(!currentUser) {
        taahhutKayitlari = [];
        return;
      }
      try {
        // TÃ¼m taahhÃ¼t kayÄ±tlarÄ±nÄ± getir (yÄ±l filtresi client-side yapÄ±lacak)
        const snap = await db.collection('taahhut_kayitlari')
          .where('personelUid', '==', currentUser.uid)
          .get();
        
        let allTaahhut = snap.docs.map(d => ({ id: d.id, ...d.data(), tip: 'taahhut' }));
        
        // CURRENT_YIL varsa filtrele
        if(CURRENT_YIL) {
          const yilNum = typeof CURRENT_YIL === 'number' ? CURRENT_YIL : parseInt(CURRENT_YIL);
          allTaahhut = allTaahhut.filter(t => {
            const tYil = typeof t.yil === 'number' ? t.yil : parseInt(t.yil);
            return tYil === yilNum;
          });
        }
        
        taahhutKayitlari = allTaahhut;
        // Tarihe gÃ¶re sÄ±rala (client-side)
        taahhutKayitlari.sort((a, b) => {
          const aDate = a.createdAt?.toDate ? a.createdAt.toDate().getTime() : (a.createdAt?.seconds || 0) * 1000;
          const bDate = b.createdAt?.toDate ? b.createdAt.toDate().getTime() : (b.createdAt?.seconds || 0) * 1000;
          return aDate - bDate; // Eskiden yeniye
        });
      } catch(e) {
        console.error('TaahhÃ¼t kayÄ±tlarÄ± yÃ¼klenemedi:', e);
        taahhutKayitlari = [];
      }
    }

    let duzenlemeTalepleri = [];

    async function loadDuzenlemeTalepleri() {
      if(!currentUser || !CURRENT_YIL) {
        duzenlemeTalepleri = [];
        return;
      }
      try {
        const yilNum = typeof CURRENT_YIL === 'number' ? CURRENT_YIL : parseInt(CURRENT_YIL);
        const snap = await db.collection('ramazan_serif').doc(String(CURRENT_YIL))
          .collection('duzenleme_talepleri')
          .where('personelUid', '==', currentUser.uid)
          .where('durum', '==', 'beklemede')
          .get();
        duzenlemeTalepleri = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      } catch(e) {
        console.error('DÃ¼zenleme talepleri yÃ¼klenemedi:', e);
        duzenlemeTalepleri = [];
      }
    }

    async function loadMyRecords() {
      const container = qs('#myRecordsList');
      if(!currentUser) {
        container.innerHTML = '<div style="text-align:center; padding:20px; color:#999">GiriÅŸ yapÄ±lmamÄ±ÅŸ</div>';
        return;
      }

      // Teberru, TaahhÃ¼t ve DÃ¼zenleme taleplerini yÃ¼kle
      await Promise.all([loadTeberruKayitlari(), loadTaahhutKayitlari(), loadDuzenlemeTalepleri()]);

      const myKayitlar = kayitlar
        .filter(k => k.personelUid === currentUser.uid && !k.silindi) // Silinen kayÄ±tlarÄ± gÃ¶sterme (silinen_kayitlar koleksiyonuna taÅŸÄ±nanlar)
        .map(k => ({ ...k, kayitTipi: 'iftar-sahur' }));

      // TÃ¼m kayÄ±tlarÄ± birleÅŸtir ve sÄ±rala: Ä°ftar -> Sahur -> TaahhÃ¼t -> Teberru
      const allRecords = [
        ...myKayitlar,
        ...teberruKayitlari.map(t => ({ ...t, kayitTipi: 'teberru', tarih: t.createdAt })),
        ...taahhutKayitlari.map(t => ({ ...t, kayitTipi: 'taahhut', tarih: t.createdAt }))
      ].sort((a, b) => {
        // Ã–nce tip sÄ±ralamasÄ±: iftar(1) -> sahur(2) -> taahhut(3) -> teberru(4)
        const getTipOrder = (k) => {
          if(k.kayitTipi === 'iftar-sahur') {
            return k.tip === 'iftar' ? 1 : 2;
          } else if(k.kayitTipi === 'taahhut') {
            return 3;
          } else if(k.kayitTipi === 'teberru') {
            return 4;
          }
          return 5;
        };
        
        const aTipOrder = getTipOrder(a);
        const bTipOrder = getTipOrder(b);
        
        // Ã–nce tip sÄ±ralamasÄ±na gÃ¶re
        if(aTipOrder !== bTipOrder) {
          return aTipOrder - bTipOrder;
        }
        
        // AynÄ± tipse tarihe gÃ¶re (eskiden yeniye)
        const aDate = a.tarih?.toDate ? a.tarih.toDate() : (a.createdAt?.toDate ? a.createdAt.toDate() : new Date(a.tarih || a.createdAt));
        const bDate = b.tarih?.toDate ? b.tarih.toDate() : (b.createdAt?.toDate ? b.createdAt.toDate() : new Date(b.tarih || b.createdAt));
        return aDate - bDate;
      });

      // KPI hesaplama
      const toplamIftarAdedi = myKayitlar.filter(k => k.tip === 'iftar').length;
      const toplamSahurAdedi = myKayitlar.filter(k => k.tip === 'sahur').length;
      qs('#kpiToplamIftar').textContent = toplamIftarAdedi;
      qs('#kpiToplamSahur').textContent = toplamSahurAdedi;

      if(allRecords.length === 0) {
        container.innerHTML = '<div style="text-align:center; padding:20px; color:#999">HenÃ¼z kayÄ±t bulunmamaktadÄ±r</div>';
        return;
      }

      container.innerHTML = '';
      allRecords.forEach(k => {
        if(k.kayitTipi === 'iftar-sahur') {
          // Mevcut iftar-sahur kayÄ±tlarÄ±
        const kDate = k.tarih.toDate ? k.tarih.toDate() : new Date(k.tarih);
        const tipLabel = k.tip === 'iftar' ? 'ğŸŒ™ Ä°ftar' : 'ğŸŒŸ Sahur';
        const card = document.createElement('div');
        card.className = 'day-card';
        card.style.marginBottom = '12px';
        card.style.flexDirection = 'column';
        card.style.alignItems = 'stretch';
        // DeÄŸiÅŸiklik kontrolÃ¼
        const hasUpdate = k.updatedAt && k.createdAt;
        let updateInfo = '';
        if(hasUpdate) {
          const createdTime = k.createdAt.toDate ? k.createdAt.toDate().getTime() : (k.createdAt.seconds || 0) * 1000;
          const updatedTime = k.updatedAt.toDate ? k.updatedAt.toDate().getTime() : (k.updatedAt.seconds || 0) * 1000;
          if(updatedTime > createdTime) {
            const updateDate = k.updatedAt.toDate ? k.updatedAt.toDate() : new Date(updatedTime);
            updateInfo = `<div style="font-size:11px; color:var(--warning); margin-top:4px; font-weight:600;">âš ï¸ DeÄŸiÅŸiklik YapÄ±ldÄ± (${updateDate.toLocaleDateString('tr-TR')} ${updateDate.toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'})})</div>`;
          }
        }

        const mahalAdi = k.mahalId ? (mahaller.find(m => m.id === k.mahalId)?.adi || 'Mahal') : null;
        
        card.innerHTML = `
          <div style="flex:1;">
            <div style="display:flex; align-items:center; gap:8px; margin-bottom:10px; padding-bottom:8px; border-bottom:2px solid #f0f0f0;">
              <div style="font-size:20px;">${k.tip === 'iftar' ? 'ğŸŒ™' : 'ğŸŒŸ'}</div>
              <div style="flex:1;">
                <div style="font-size:11px; color:#95a5a6; margin-bottom:3px; font-weight:500; text-transform:uppercase; letter-spacing:0.5px;">${kDate.toLocaleDateString('tr-TR', {weekday:'long', day:'numeric', month:'long', year:'numeric'})}</div>
                <div style="font-size:16px; font-weight:700; color:var(--primary);">${tipLabel}</div>
              </div>
            </div>
            
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px;">
              <div style="background:#f8f9fa; padding:10px; border-radius:8px;">
                <div style="font-size:11px; color:#7f8c8d; margin-bottom:4px; font-weight:500;">BaÄŸÄ±ÅŸÃ§Ä±</div>
                <div style="font-size:15px; font-weight:700; color:#2c3e50;" id="sahip-${k.id}">${k.sahip}</div>
              </div>
              <div style="background:#f8f9fa; padding:10px; border-radius:8px;">
                <div style="font-size:11px; color:#7f8c8d; margin-bottom:4px; font-weight:500;">Tutar</div>
                <div style="font-size:15px; font-weight:700; color:#27ae60;">â‚º${Number(k.tutar || 0).toLocaleString('tr-TR', {minimumFractionDigits:2, maximumFractionDigits:2})}</div>
              </div>
            </div>
            
            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px;">
              <div style="background:#f8f9fa; padding:10px; border-radius:8px;">
                <div style="font-size:11px; color:#7f8c8d; margin-bottom:4px; font-weight:500;">MÃ¼safir Adedi</div>
                <div style="font-size:15px; font-weight:700; color:#3498db;" id="musafir-${k.id}">${k.musafirAdedi || 0}</div>
              </div>
              ${mahalAdi ? `
              <div style="background:#f8f9fa; padding:10px; border-radius:8px;">
                <div style="font-size:11px; color:#7f8c8d; margin-bottom:4px; font-weight:500;">Mahal</div>
                <div style="font-size:15px; font-weight:700; color:#9b59b6;">ğŸ›ï¸ ${mahalAdi}</div>
              </div>
              ` : '<div></div>'}
            </div>
            
            ${k.not ? `<div style="background:#fff3cd; padding:10px; border-radius:8px; border-left:3px solid #ffc107; margin-bottom:10px;">
              <div style="font-size:11px; color:#856404; margin-bottom:4px; font-weight:600;">ğŸ“ Not</div>
              <div style="font-size:13px; color:#856404; line-height:1.5;">${k.not}</div>
            </div>` : ''}
            
            ${updateInfo}
            ${duzenlemeTalepleri.some(t => t.kayitId === k.id && t.kayitTipi === 'iftar-sahur') ? 
              '<div style="background:#d1ecf1; padding:8px; border-radius:6px; border-left:3px solid #17a2b8; margin-top:8px;"><div style="font-size:11px; color:#17a2b8; font-weight:600;">ğŸ“‹ DÃ¼zenleme talep edildi</div></div>' : ''}
          </div>
          <div style="display:flex; gap:8px; align-items:center; margin-top:12px; justify-content:flex-end; padding-top:12px; border-top:1px solid #f0f0f0;">
            <button onclick="editMyRecord('${k.id}')" style="background:var(--primary); color:white; border:none; padding:10px 16px; border-radius:8px; font-size:13px; cursor:pointer; font-weight:600; box-shadow:0 2px 6px rgba(0,0,0,0.1);">âœï¸ DÃ¼zenle</button>
          </div>
        `;
          container.appendChild(card);
        } else if(k.kayitTipi === 'taahhut') {
          // TaahhÃ¼t kayÄ±tlarÄ±
          let kDate;
          if(k.createdAt) {
            if(k.createdAt.toDate) {
              kDate = k.createdAt.toDate();
            } else if(k.createdAt.seconds) {
              kDate = new Date(k.createdAt.seconds * 1000);
            } else {
              kDate = new Date(k.createdAt);
            }
          } else {
            kDate = new Date();
          }
          
          // DeÄŸiÅŸiklik kontrolÃ¼
          const hasUpdate = k.updatedAt && k.createdAt;
          let updateInfo = '';
          if(hasUpdate) {
            const createdTime = k.createdAt.toDate ? k.createdAt.toDate().getTime() : (k.createdAt.seconds || 0) * 1000;
            const updatedTime = k.updatedAt.toDate ? k.updatedAt.toDate().getTime() : (k.updatedAt.seconds || 0) * 1000;
            if(updatedTime > createdTime) {
              const updateDate = k.updatedAt.toDate ? k.updatedAt.toDate() : new Date(updatedTime);
              updateInfo = `<div style="font-size:11px; color:var(--warning); margin-top:4px; font-weight:600;">âš ï¸ DeÄŸiÅŸiklik YapÄ±ldÄ± (${updateDate.toLocaleDateString('tr-TR')} ${updateDate.toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'})})</div>`;
            }
          }
          
          const card = document.createElement('div');
          card.className = 'day-card';
          card.style.marginBottom = '12px';
          card.style.flexDirection = 'column';
          card.style.alignItems = 'stretch';
          card.style.borderLeft = '5px solid #3498db';
          
          card.innerHTML = `
            <div style="flex:1;">
              <div style="display:flex; align-items:center; gap:8px; margin-bottom:10px; padding-bottom:8px; border-bottom:2px solid #f0f0f0;">
                <div style="font-size:20px;">ğŸ“‹</div>
                <div style="flex:1;">
                  <div style="font-size:11px; color:#95a5a6; margin-bottom:3px; font-weight:500; text-transform:uppercase; letter-spacing:0.5px;">${kDate.toLocaleDateString('tr-TR', {weekday:'long', day:'numeric', month:'long', year:'numeric'})}</div>
                  <div style="font-size:16px; font-weight:700; color:#3498db;">ğŸ“‹ TaahhÃ¼t</div>
                </div>
              </div>
              
              <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px;">
                <div style="background:#f8f9fa; padding:10px; border-radius:8px;">
                  <div style="font-size:11px; color:#7f8c8d; margin-bottom:4px; font-weight:500;">BaÄŸÄ±ÅŸÃ§Ä±</div>
                  <div style="font-size:15px; font-weight:700; color:#2c3e50;" id="taahhut-bagisci-${k.id}">${k.bagisci || 'Bilinmiyor'}</div>
                </div>
                <div style="background:#f8f9fa; padding:10px; border-radius:8px;">
                  <div style="font-size:11px; color:#7f8c8d; margin-bottom:4px; font-weight:500;">Miktar</div>
                  <div style="font-size:15px; font-weight:700; color:#3498db;">â‚º${(k.miktar || 0).toLocaleString('tr-TR', {minimumFractionDigits:2, maximumFractionDigits:2})}</div>
                </div>
              </div>
              
              ${k.aciklama ? `<div style="background:#fff3cd; padding:10px; border-radius:8px; border-left:3px solid #ffc107; margin-bottom:10px;">
                <div style="font-size:11px; color:#856404; margin-bottom:4px; font-weight:600;">ğŸ“ AÃ§Ä±klama</div>
                <div style="font-size:13px; color:#856404; line-height:1.5;">${k.aciklama}</div>
              </div>` : ''}
              
              ${updateInfo}
              ${duzenlemeTalepleri.some(t => t.kayitId === k.id && t.kayitTipi === 'taahhut') ? 
                '<div style="background:#d1ecf1; padding:8px; border-radius:6px; border-left:3px solid #17a2b8; margin-top:8px;"><div style="font-size:11px; color:#17a2b8; font-weight:600;">ğŸ“‹ DÃ¼zenleme talep edildi</div></div>' : ''}
            </div>
            <div style="display:flex; gap:8px; align-items:center; margin-top:12px; justify-content:flex-end; padding-top:12px; border-top:1px solid #f0f0f0;">
              <button onclick="editTaahhutRecord('${k.id}')" style="background:var(--primary); color:white; border:none; padding:10px 16px; border-radius:8px; font-size:13px; cursor:pointer; font-weight:600; box-shadow:0 2px 6px rgba(0,0,0,0.1);">âœï¸ DÃ¼zenle</button>
            </div>
          `;
          container.appendChild(card);
        } else if(k.kayitTipi === 'teberru') {
          // Teberru kayÄ±tlarÄ±
          let kDate;
          if(k.createdAt) {
            if(k.createdAt.toDate) {
              kDate = k.createdAt.toDate();
            } else if(k.createdAt.seconds) {
              kDate = new Date(k.createdAt.seconds * 1000);
            } else {
              kDate = new Date(k.createdAt);
            }
          } else {
            kDate = new Date();
          }
          
          // DeÄŸiÅŸiklik kontrolÃ¼
          const hasUpdate = k.updatedAt && k.createdAt;
          let updateInfo = '';
          if(hasUpdate) {
            const createdTime = k.createdAt.toDate ? k.createdAt.toDate().getTime() : (k.createdAt.seconds || 0) * 1000;
            const updatedTime = k.updatedAt.toDate ? k.updatedAt.toDate().getTime() : (k.updatedAt.seconds || 0) * 1000;
            if(updatedTime > createdTime) {
              const updateDate = k.updatedAt.toDate ? k.updatedAt.toDate() : new Date(updatedTime);
              updateInfo = `<div style="font-size:11px; color:var(--warning); margin-top:4px; font-weight:600;">âš ï¸ DeÄŸiÅŸiklik YapÄ±ldÄ± (${updateDate.toLocaleDateString('tr-TR')} ${updateDate.toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'})})</div>`;
            }
          }
          
          const odemeLabels = {
            'nakit': 'ğŸ’µ Nakit',
            'banka': 'ğŸ¦ Banka',
            'pos': 'ğŸ’³ POS',
            'sanal': 'ğŸ“± Sanal'
          };
          const card = document.createElement('div');
          card.className = 'day-card';
          card.style.marginBottom = '12px';
          card.style.flexDirection = 'column';
          card.style.alignItems = 'stretch';
          card.style.borderLeft = '5px solid #27ae60';
          
          card.innerHTML = `
            <div style="flex:1;">
              <div style="display:flex; align-items:center; gap:8px; margin-bottom:10px; padding-bottom:8px; border-bottom:2px solid #f0f0f0;">
                <div style="font-size:20px;">ğŸ’°</div>
                <div style="flex:1;">
                  <div style="font-size:11px; color:#95a5a6; margin-bottom:3px; font-weight:500; text-transform:uppercase; letter-spacing:0.5px;">${kDate.toLocaleDateString('tr-TR', {weekday:'long', day:'numeric', month:'long', year:'numeric'})}</div>
                  <div style="font-size:16px; font-weight:700; color:#27ae60;">ğŸ’° Teberru</div>
                </div>
              </div>
              
              <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:10px;">
                <div style="background:#f8f9fa; padding:10px; border-radius:8px;">
                  <div style="font-size:11px; color:#7f8c8d; margin-bottom:4px; font-weight:500;">BaÄŸÄ±ÅŸÃ§Ä±</div>
                  <div style="font-size:15px; font-weight:700; color:#2c3e50;" id="teberru-bagisci-${k.id}">${k.bagisci || 'Bilinmiyor'}</div>
                </div>
                <div style="background:#f8f9fa; padding:10px; border-radius:8px;">
                  <div style="font-size:11px; color:#7f8c8d; margin-bottom:4px; font-weight:500;">Miktar</div>
                  <div style="font-size:15px; font-weight:700; color:#27ae60;">â‚º${(k.miktar || 0).toLocaleString('tr-TR', {minimumFractionDigits:2, maximumFractionDigits:2})}</div>
                </div>
              </div>
              
              <div style="background:#f8f9fa; padding:10px; border-radius:8px; margin-bottom:10px;">
                <div style="font-size:11px; color:#7f8c8d; margin-bottom:4px; font-weight:500;">Ã–deme YÃ¶ntemi</div>
                <div style="font-size:14px; font-weight:600; color:#9b59b6;">${odemeLabels[k.odemeYontemi] || k.odemeYontemi || '-'}</div>
              </div>
              
              ${k.aciklama ? `<div style="background:#fff3cd; padding:10px; border-radius:8px; border-left:3px solid #ffc107; margin-bottom:10px;">
                <div style="font-size:11px; color:#856404; margin-bottom:4px; font-weight:600;">ğŸ“ AÃ§Ä±klama</div>
                <div style="font-size:13px; color:#856404; line-height:1.5;">${k.aciklama}</div>
              </div>` : ''}
              
              ${updateInfo}
              ${duzenlemeTalepleri.some(t => t.kayitId === k.id && t.kayitTipi === 'teberru') ? 
                '<div style="background:#d1ecf1; padding:8px; border-radius:6px; border-left:3px solid #17a2b8; margin-top:8px;"><div style="font-size:11px; color:#17a2b8; font-weight:600;">ğŸ“‹ DÃ¼zenleme talep edildi</div></div>' : ''}
            </div>
            <div style="display:flex; gap:8px; align-items:center; margin-top:12px; justify-content:flex-end; padding-top:12px; border-top:1px solid #f0f0f0;">
              <button onclick="editTeberruRecord('${k.id}')" style="background:var(--primary); color:white; border:none; padding:10px 16px; border-radius:8px; font-size:13px; cursor:pointer; font-weight:600; box-shadow:0 2px 6px rgba(0,0,0,0.1);">âœï¸ DÃ¼zenle</button>
            </div>
          `;
          container.appendChild(card);
        }
      });
    }

    // DÃ¼zenleme talep fonksiyonlarÄ±
    function editMyRecord(recordId) {
      const kayit = kayitlar.find(k => k.id === recordId);
      if(!kayit || kayit.personelUid !== currentUser.uid) {
        showAlert('Bu kaydÄ± dÃ¼zenleme yetkiniz yok', 'error');
        return;
      }

      const kDate = kayit.tarih.toDate ? kayit.tarih.toDate() : new Date(kayit.tarih);
      const tipLabel = kayit.tip === 'iftar' ? 'ğŸŒ™ Ä°ftar' : 'ğŸŒŸ Sahur';
      const mahalAdi = kayit.mahalId ? (mahaller.find(m => m.id === kayit.mahalId)?.adi || 'Mahal') : null;
      
      qs('#editRequestRecordId').value = recordId;
      qs('#editRequestKayitTipi').value = 'iftar-sahur';
      qs('#editRequestDateDisplay').innerHTML = `
        <strong>${tipLabel}</strong><br>
        ${kDate.toLocaleDateString('tr-TR', {dateStyle:'full'})}<br>
        <small style="color:#7f8c8d;">${kayit.sahip} - ${kayit.musafirAdedi || 0} mÃ¼safir</small>
        ${mahalAdi ? `<br><small style="color:#7f8c8d;">ğŸ›ï¸ ${mahalAdi}</small>` : ''}
      `;
      qs('#editRequestType').value = 'duzenle';
      qs('#editRequestAciklama').value = '';
      qs('#editRequestNewDate').value = '';
      qs('#editRequestDateSelect').style.display = 'none';
      qs('#editRequestMahalWarning').style.display = 'none';
      
      // Chip seÃ§imlerini sÄ±fÄ±rla
      qs('#editRequestModal').querySelectorAll('.chip').forEach(c => c.classList.remove('selected'));
      qs('#editRequestModal').querySelector('.chip').classList.add('selected');
      
      qs('#editRequestModal').classList.add('open');
    }

    function closeEditRequestModal() {
      qs('#editRequestModal').classList.remove('open');
      qs('#editRequestForm').reset();
    }

    function selectEditRequestType(type, element) {
      qs('#editRequestType').value = type;
      qs('#editRequestModal').querySelectorAll('.chip').forEach(c => c.classList.remove('selected'));
      element.classList.add('selected');
      
      if(type === 'yer_degistir') {
        qs('#editRequestDateSelect').style.display = 'block';
        // Mevcut tarihi varsayÄ±lan olarak ayarla
        const recordId = qs('#editRequestRecordId').value;
        const kayit = kayitlar.find(k => k.id === recordId);
        if(kayit) {
          const kDate = kayit.tarih.toDate ? kayit.tarih.toDate() : new Date(kayit.tarih);
          qs('#editRequestNewDate').value = kDate.toISOString().slice(0,10);
        }
        checkNewDateMahal();
      } else {
        qs('#editRequestDateSelect').style.display = 'none';
        qs('#editRequestMahalWarning').style.display = 'none';
      }
    }

    function checkNewDateMahal() {
      const recordId = qs('#editRequestRecordId').value;
      const kayit = kayitlar.find(k => k.id === recordId);
      if(!kayit || !kayit.mahalId || kayit.istirak !== true) {
        qs('#editRequestMahalWarning').style.display = 'none';
        return;
      }

      const newDateStr = qs('#editRequestNewDate').value;
      if(!newDateStr) {
        qs('#editRequestMahalWarning').style.display = 'none';
        return;
      }

      const mahalCheck = checkMahalAvailability(newDateStr, kayit.tip, kayit.mahalId, recordId);
      if(!mahalCheck.allowed) {
        qs('#editRequestMahalWarningText').textContent = mahalCheck.message + ' Ä°sterseniz mahal deÄŸiÅŸikliÄŸi yapÄ±p bu tarihe geÃ§ebilirsiniz.';
        qs('#editRequestMahalWarning').style.display = 'block';
      } else {
        qs('#editRequestMahalWarning').style.display = 'none';
      }
    }

    qs('#editRequestNewDate').addEventListener('change', checkNewDateMahal);

    function stepEditGuest(n) {
      let v = parseInt(qs('#editGuest').value) + n;
      if(v < 0) v = 0;
      qs('#editGuest').value = v;
      qs('#editGuestVal').innerText = v;
    }

    qs('#editRequestForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const recordId = qs('#editRequestRecordId').value;
      const kayitTipi = qs('#editRequestKayitTipi').value;
      const talepTipi = qs('#editRequestType').value;
      const aciklama = qs('#editRequestAciklama').value.trim();

      if(!aciklama) {
        showAlert('LÃ¼tfen aÃ§Ä±klama giriniz', 'error');
        return;
      }

      const btn = e.target.querySelector('button[type="submit"]');
      btn.disabled = true;
      btn.innerText = 'Ä°ÅŸleniyor...';

      try {
        if(kayitTipi === 'iftar-sahur') {
          const kayit = kayitlar.find(k => k.id === recordId);
          if(!kayit || kayit.personelUid !== currentUser.uid) {
            showAlert('Bu kaydÄ± dÃ¼zenleme yetkiniz yok', 'error');
            btn.disabled = false;
            btn.innerText = 'Kaydet ve Kapat';
            return;
          }

          if(talepTipi === 'sil') {
            // Sil iÅŸlemi - Otomatik sil
            const silinenKayit = {
              ...kayit,
              silindi: true,
              silenPersonelUid: currentUser.uid,
              silenPersonelAdi: currentPersonelAdi || 'Bilinmiyor',
              silinmeTarihi: firebase.firestore.FieldValue.serverTimestamp(),
              silmeAciklama: aciklama,
              orijinalId: recordId
            };
            
            // Silinen kayÄ±tlarÄ± ayrÄ± bir koleksiyona kaydet
            await db.collection('ramazan_serif').doc(String(CURRENT_YIL)).collection('silinen_kayitlar').add(silinenKayit);
            
            // Orijinal kaydÄ± sil
            await db.collection('ramazan_serif').doc(String(CURRENT_YIL)).collection('kayitlar').doc(recordId).delete();
            
            closeEditRequestModal();
            showAlert('KayÄ±t baÅŸarÄ±yla silindi!', 'success');
            loadMyRecords();
            return;
          }

          if(talepTipi === 'yer_degistir') {
            const newDateStr = qs('#editRequestNewDate').value;
            if(!newDateStr) {
              showAlert('LÃ¼tfen yeni tarih seÃ§iniz', 'error');
              btn.disabled = false;
              btn.innerText = 'Kaydet ve Kapat';
              return;
            }

            // Kapasite kontrolÃ¼
            const kapasiteCheck = checkKapasite(newDateStr, kayit.tip);
            if(!kapasiteCheck.allowed) {
              // Kapasite doluysa sadece talep olarak kaydet
              const talepData = {
                kayitId: recordId,
                kayitTipi: kayitTipi,
                talepTipi: talepTipi,
                aciklama: aciklama,
                personelUid: currentUser.uid,
                personelAdi: currentPersonelAdi || 'Bilinmiyor',
                durum: 'beklemede',
                yeniTarih: newDateStr,
                eskiTarih: kayit.tarih.toDate ? kayit.tarih.toDate().toISOString().slice(0,10) : kayit.tarih,
                tip: kayit.tip,
                mahalId: kayit.mahalId,
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                yil: CURRENT_YIL
              };
              await db.collection('ramazan_serif').doc(String(CURRENT_YIL)).collection('duzenleme_talepleri').add(talepData);
              closeEditRequestModal();
              showAlert('Kapasite dolu olduÄŸu iÃ§in talep olarak kaydedildi. Onay bekleniyor.', 'info');
              loadMyRecords();
              return;
            }

            // Mahal kontrolÃ¼ (yer deÄŸiÅŸtir iÃ§in)
            let mahalUygun = true;
            if(kayit.mahalId && kayit.istirak === true) {
              const mahalCheck = checkMahalAvailability(newDateStr, kayit.tip, kayit.mahalId, recordId);
              if(!mahalCheck.allowed) {
                // Mahal doluysa sadece talep olarak kaydet
                const talepData = {
                  kayitId: recordId,
                  kayitTipi: kayitTipi,
                  talepTipi: talepTipi,
                  aciklama: aciklama,
                  personelUid: currentUser.uid,
                  personelAdi: currentPersonelAdi || 'Bilinmiyor',
                  durum: 'beklemede',
                  yeniTarih: newDateStr,
                  eskiTarih: kayit.tarih.toDate ? kayit.tarih.toDate().toISOString().slice(0,10) : kayit.tarih,
                  tip: kayit.tip,
                  mahalId: kayit.mahalId,
                  createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                  yil: CURRENT_YIL
                };
                await db.collection('ramazan_serif').doc(String(CURRENT_YIL)).collection('duzenleme_talepleri').add(talepData);
                closeEditRequestModal();
                showAlert('Mahal dolu olduÄŸu iÃ§in talep olarak kaydedildi. Onay bekleniyor.', 'info');
                loadMyRecords();
                return;
              }
            }

            // Åartlar uygunsa otomatik yer deÄŸiÅŸtir
            const eskiTarih = kayit.tarih.toDate ? kayit.tarih.toDate() : new Date(kayit.tarih);
            const eskiTarihStr = eskiTarih.toISOString().slice(0,10);
            const yeniTarihParts = newDateStr.split('-');
            const yeniTarih = new Date(yeniTarihParts[0], yeniTarihParts[1]-1, yeniTarihParts[2], 12, 0, 0);
            
            // Not alanÄ±na geÃ§miÅŸ tarihleri ekle
            let tarihGecmisi = kayit.not || '';
            const formatTarih = (date) => {
              const d = new Date(date);
              const gun = String(d.getDate()).padStart(2, '0');
              const ay = String(d.getMonth() + 1).padStart(2, '0');
              const yil = d.getFullYear();
              return `${gun}.${ay}.${yil}`;
            };
            
            if(tarihGecmisi && tarihGecmisi.includes('tarihine geÃ§ti')) {
              // Zaten geÃ§miÅŸ var, ekle
              const tarihListesi = tarihGecmisi.match(/\d{2}\.\d{2}\.\d{4}/g) || [];
              const yeniTarihStr = formatTarih(yeniTarih);
              tarihGecmisi = tarihListesi.join(' > ') + ' > ' + yeniTarihStr + ' tarihine geÃ§ti';
            } else {
              // Ä°lk geÃ§iÅŸ
              const eskiTarihStr = formatTarih(eskiTarih);
              const yeniTarihStr = formatTarih(yeniTarih);
              tarihGecmisi = (tarihGecmisi ? tarihGecmisi + ' | ' : '') + 
                eskiTarihStr + ' > ' + yeniTarihStr + ' tarihine geÃ§ti';
            }

            // KaydÄ± gÃ¼ncelle
            await db.collection('ramazan_serif').doc(String(CURRENT_YIL)).collection('kayitlar').doc(recordId).update({
              tarih: firebase.firestore.Timestamp.fromDate(yeniTarih),
              not: tarihGecmisi,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });

            closeEditRequestModal();
            showAlert('Yer deÄŸiÅŸtirme iÅŸlemi baÅŸarÄ±yla tamamlandÄ±!', 'success');
            loadMyRecords();
            return;
          }

          // DÃ¼zenleme talebi (normal dÃ¼zenleme)
          const talepData = {
            kayitId: recordId,
            kayitTipi: kayitTipi,
            talepTipi: talepTipi,
            aciklama: aciklama,
            personelUid: currentUser.uid,
            personelAdi: currentPersonelAdi || 'Bilinmiyor',
            durum: 'beklemede',
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            yil: CURRENT_YIL
          };
          await db.collection('ramazan_serif').doc(String(CURRENT_YIL)).collection('duzenleme_talepleri').add(talepData);
          closeEditRequestModal();
          showAlert('DÃ¼zenleme talebiniz baÅŸarÄ±yla gÃ¶nderildi!', 'success');
          loadMyRecords();
        } else {
          // Teberru veya TaahhÃ¼t iÃ§in sadece talep kaydet
          const talepData = {
            kayitId: recordId,
            kayitTipi: kayitTipi,
            talepTipi: talepTipi,
            aciklama: aciklama,
            personelUid: currentUser.uid,
            personelAdi: currentPersonelAdi || 'Bilinmiyor',
            durum: 'beklemede',
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            yil: CURRENT_YIL
          };
          await db.collection('ramazan_serif').doc(String(CURRENT_YIL)).collection('duzenleme_talepleri').add(talepData);
          closeEditRequestModal();
          showAlert('DÃ¼zenleme talebiniz baÅŸarÄ±yla gÃ¶nderildi!', 'success');
          loadMyRecords();
        }
      } catch(err) {
        showAlert('Hata: ' + err.message, 'error');
      } finally {
        btn.disabled = false;
        btn.innerText = 'Kaydet ve Kapat';
      }
    });

    async function deleteMyRecord(recordId) {
      const kayit = kayitlar.find(k => k.id === recordId);
      if(!kayit || kayit.personelUid !== currentUser.uid) {
        showAlert('Bu kaydÄ± silme yetkiniz yok', 'error');
        return;
      }

      showConfirm('Bu kaydÄ± silmek istediÄŸinizden emin misiniz?', async () => {
        try {
          // Silinen kaydÄ± raporlama iÃ§in kaydet
          const silinenKayit = {
            ...kayit,
            silindi: true,
            silenPersonelUid: currentUser.uid,
            silenPersonelAdi: currentPersonelAdi || 'Bilinmiyor',
            silinmeTarihi: firebase.firestore.FieldValue.serverTimestamp(),
            orijinalId: recordId
          };
          
          // Silinen kayÄ±tlarÄ± ayrÄ± bir koleksiyona kaydet
          await db.collection('ramazan_serif').doc(String(CURRENT_YIL)).collection('silinen_kayitlar').add(silinenKayit);
          
          // Orijinal kaydÄ± sil
          await db.collection('ramazan_serif').doc(String(CURRENT_YIL)).collection('kayitlar').doc(recordId).delete();
          
          showAlert('KayÄ±t baÅŸarÄ±yla silindi!', 'success');
          loadMyRecords();
        } catch(err) {
          showAlert('Hata: ' + err.message, 'error');
        }
      });
    }

    window.editMyRecord = editMyRecord;
    window.deleteMyRecord = deleteMyRecord;
    window.selectEditRequestType = selectEditRequestType;
    window.closeEditRequestModal = closeEditRequestModal;
    window.openFormModalFromDay = openFormModalFromDay;
    window.closeInfoModal = closeInfoModal;
    window.showInfoModalFromPopup = showInfoModalFromPopup;
    window.closeInfoPopup = closeInfoPopup;
    
    // Teberru fonksiyonlarÄ±
    function openTeberruModal() {
      qs('#teberruForm').reset();
      qs('#teberruForm').removeAttribute('data-edit-id');
      qs('#teberruOdeme').value = '';
      qs('#teberruModal').querySelectorAll('.chip').forEach(c => c.classList.remove('selected'));
      clearTeberruErrors();
      qs('#teberruModal').classList.add('open');
    }

    function closeTeberruModal() {
      qs('#teberruModal').classList.remove('open');
    }

    function clearTeberruErrors() {
      qs('#teberruBagisciError').style.display = 'none';
      qs('#teberruMiktarError').style.display = 'none';
      qs('#teberruOdemeError').style.display = 'none';
      qs('#teberruBagisci').style.borderColor = '';
      qs('#teberruMiktar').style.borderColor = '';
    }

    function showTeberruPreview() {
      clearTeberruErrors();
      let hasError = false;

      const bagisci = qs('#teberruBagisci').value.trim();
      const miktar = parseFloat(qs('#teberruMiktar').value);
      const odeme = qs('#teberruOdeme').value;
      const aciklama = qs('#teberruAciklama').value.trim();

      if(!bagisci) {
        qs('#teberruBagisciError').textContent = 'BaÄŸÄ±ÅŸÃ§Ä± adÄ± zorunludur';
        qs('#teberruBagisciError').style.display = 'block';
        qs('#teberruBagisci').style.borderColor = 'var(--danger)';
        hasError = true;
      }

      if(!miktar || miktar <= 0) {
        qs('#teberruMiktarError').textContent = 'GeÃ§erli bir miktar giriniz';
        qs('#teberruMiktarError').style.display = 'block';
        qs('#teberruMiktar').style.borderColor = 'var(--danger)';
        hasError = true;
      }

      if(!odeme) {
        qs('#teberruOdemeError').textContent = 'Ã–deme yÃ¶ntemi seÃ§iniz';
        qs('#teberruOdemeError').style.display = 'block';
        hasError = true;
      }

      if(hasError) {
        return;
      }

      const odemeLabels = {
        'nakit': 'ğŸ’µ Nakit',
        'banka': 'ğŸ¦ Banka',
        'pos': 'ğŸ’³ POS',
        'sanal': 'ğŸ“± Sanal'
      };

      const content = qs('#teberruPreviewContent');
      content.innerHTML = `
        <div style="margin-bottom:10px;"><strong>BaÄŸÄ±ÅŸÃ§Ä±:</strong> ${bagisci}</div>
        <div style="margin-bottom:10px;"><strong>Miktar:</strong> ${miktar.toLocaleString('tr-TR', {minimumFractionDigits:2, maximumFractionDigits:2})} â‚º</div>
        <div style="margin-bottom:10px;"><strong>Ã–deme YÃ¶ntemi:</strong> ${odemeLabels[odeme] || odeme}</div>
        ${aciklama ? `<div style="margin-bottom:10px;"><strong>AÃ§Ä±klama:</strong> ${aciklama}</div>` : ''}
        <div style="margin-top:15px; padding-top:15px; border-top:1px solid #eee; font-size:12px; color:#7f8c8d;">
          <div><strong>Kaydeden:</strong> ${currentPersonelAdi || 'Bilinmiyor'}</div>
          <div><strong>Tarih:</strong> ${new Date().toLocaleString('tr-TR')}</div>
        </div>
      `;
      qs('#teberruPreviewModal').classList.add('open');
      qs('#teberruModal').classList.remove('open');
    }

    function closeTeberruPreviewModal() {
      qs('#teberruPreviewModal').classList.remove('open');
      qs('#teberruModal').classList.add('open');
    }

    async function saveTeberru() {
      const bagisci = qs('#teberruBagisci').value.trim();
      const miktar = parseFloat(qs('#teberruMiktar').value);
      const odeme = qs('#teberruOdeme').value;
      const aciklama = qs('#teberruAciklama').value.trim();
      const editId = qs('#teberruForm').getAttribute('data-edit-id');

      try {
        const yilNum = CURRENT_YIL ? (typeof CURRENT_YIL === 'number' ? CURRENT_YIL : parseInt(CURRENT_YIL)) : new Date().getFullYear();
        const data = {
          bagisci: bagisci,
          miktar: miktar,
          odemeYontemi: odeme,
          aciklama: aciklama || '',
          personelUid: currentUser.uid,
          personelAdi: currentPersonelAdi || 'Bilinmiyor',
          yil: yilNum
        };

        if(editId) {
          // DÃ¼zenleme
          data.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
          await db.collection('teberru_kayitlari').doc(editId).update(data);
          showAlert('Teberru kaydÄ± baÅŸarÄ±yla gÃ¼ncellendi!', 'success');
          qs('#teberruForm').removeAttribute('data-edit-id');
        } else {
          // Yeni kayÄ±t
          data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
          await db.collection('teberru_kayitlari').add(data);
          showAlert('Teberru kaydÄ± baÅŸarÄ±yla eklendi!', 'success');
        }

        closeTeberruPreviewModal();
        closeTeberruModal();
        qs('#teberruForm').reset();
        loadMyRecords();
      } catch(err) {
        showAlert('Hata: ' + err.message, 'error');
      }
    }

    // TaahhÃ¼t fonksiyonlarÄ±
    function openTaahhutModal() {
      qs('#taahhutForm').reset();
      qs('#taahhutForm').removeAttribute('data-edit-id');
      clearTaahhutErrors();
      qs('#taahhutModal').classList.add('open');
    }

    function closeTaahhutModal() {
      qs('#taahhutModal').classList.remove('open');
    }

    function clearTaahhutErrors() {
      qs('#taahhutBagisciError').style.display = 'none';
      qs('#taahhutMiktarError').style.display = 'none';
      qs('#taahhutBagisci').style.borderColor = '';
      qs('#taahhutMiktar').style.borderColor = '';
    }

    function showTaahhutPreview() {
      clearTaahhutErrors();
      let hasError = false;

      const bagisci = qs('#taahhutBagisci').value.trim();
      const miktar = parseFloat(qs('#taahhutMiktar').value);
      const aciklama = qs('#taahhutAciklama').value.trim();

      if(!bagisci) {
        qs('#taahhutBagisciError').textContent = 'BaÄŸÄ±ÅŸÃ§Ä± adÄ± zorunludur';
        qs('#taahhutBagisciError').style.display = 'block';
        qs('#taahhutBagisci').style.borderColor = 'var(--danger)';
        hasError = true;
      }

      if(!miktar || miktar <= 0) {
        qs('#taahhutMiktarError').textContent = 'GeÃ§erli bir miktar giriniz';
        qs('#taahhutMiktarError').style.display = 'block';
        qs('#taahhutMiktar').style.borderColor = 'var(--danger)';
        hasError = true;
      }

      if(hasError) {
        return;
      }

      const content = qs('#taahhutPreviewContent');
      content.innerHTML = `
        <div style="margin-bottom:10px;"><strong>BaÄŸÄ±ÅŸÃ§Ä±:</strong> ${bagisci}</div>
        <div style="margin-bottom:10px;"><strong>Miktar:</strong> ${miktar.toLocaleString('tr-TR', {minimumFractionDigits:2, maximumFractionDigits:2})} â‚º</div>
        ${aciklama ? `<div style="margin-bottom:10px;"><strong>AÃ§Ä±klama:</strong> ${aciklama}</div>` : ''}
        <div style="margin-top:15px; padding-top:15px; border-top:1px solid #eee; font-size:12px; color:#7f8c8d;">
          <div><strong>Kaydeden:</strong> ${currentPersonelAdi || 'Bilinmiyor'}</div>
          <div><strong>Tarih:</strong> ${new Date().toLocaleString('tr-TR')}</div>
        </div>
      `;
      qs('#taahhutPreviewModal').classList.add('open');
      qs('#taahhutModal').classList.remove('open');
    }

    function closeTaahhutPreviewModal() {
      qs('#taahhutPreviewModal').classList.remove('open');
      qs('#taahhutModal').classList.add('open');
    }

    async function saveTaahhut() {
      const bagisci = qs('#taahhutBagisci').value.trim();
      const miktar = parseFloat(qs('#taahhutMiktar').value);
      const aciklama = qs('#taahhutAciklama').value.trim();
      const editId = qs('#taahhutForm').getAttribute('data-edit-id');

      try {
        const yilNum = CURRENT_YIL ? (typeof CURRENT_YIL === 'number' ? CURRENT_YIL : parseInt(CURRENT_YIL)) : new Date().getFullYear();
        const data = {
          bagisci: bagisci,
          miktar: miktar,
          aciklama: aciklama || '',
          personelUid: currentUser.uid,
          personelAdi: currentPersonelAdi || 'Bilinmiyor',
          yil: yilNum
        };

        if(editId) {
          // DÃ¼zenleme
          data.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
          await db.collection('taahhut_kayitlari').doc(editId).update(data);
          showAlert('TaahhÃ¼t kaydÄ± baÅŸarÄ±yla gÃ¼ncellendi!', 'success');
          qs('#taahhutForm').removeAttribute('data-edit-id');
        } else {
          // Yeni kayÄ±t
          data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
          await db.collection('taahhut_kayitlari').add(data);
          showAlert('TaahhÃ¼t kaydÄ± baÅŸarÄ±yla eklendi!', 'success');
        }

        closeTaahhutPreviewModal();
        closeTaahhutModal();
        qs('#taahhutForm').reset();
        loadMyRecords();
      } catch(err) {
        showAlert('Hata: ' + err.message, 'error');
      }
    }

    // Teberru dÃ¼zenleme ve silme
    async function editTeberruRecord(recordId) {
      const kayit = teberruKayitlari.find(t => t.id === recordId);
      if(!kayit || kayit.personelUid !== currentUser.uid) {
        showAlert('Bu kaydÄ± dÃ¼zenleme yetkiniz yok', 'error');
        return;
      }

      qs('#teberruBagisci').value = kayit.bagisci || '';
      qs('#teberruMiktar').value = kayit.miktar || 0;
      qs('#teberruAciklama').value = kayit.aciklama || '';
      qs('#teberruOdeme').value = kayit.odemeYontemi || '';
      
      // Ã–deme yÃ¶ntemi chip'ini seÃ§
      qs('#teberruModal').querySelectorAll('.chip').forEach(c => {
        c.classList.remove('selected');
        if(c.getAttribute('data-value') === kayit.odemeYontemi) {
          c.classList.add('selected');
        }
      });

      // KayÄ±t ID'sini sakla
      qs('#teberruForm').setAttribute('data-edit-id', recordId);
      clearTeberruErrors();
      qs('#teberruModal').classList.add('open');
    }

    async function deleteTeberruRecord(recordId) {
      const kayit = teberruKayitlari.find(t => t.id === recordId);
      if(!kayit || kayit.personelUid !== currentUser.uid) {
        showAlert('Bu kaydÄ± silme yetkiniz yok', 'error');
        return;
      }

      showConfirm('Bu teberru kaydÄ±nÄ± silmek istediÄŸinizden emin misiniz?', async () => {
        try {
          await db.collection('teberru_kayitlari').doc(recordId).delete();
          showAlert('Teberru kaydÄ± baÅŸarÄ±yla silindi!', 'success');
          loadMyRecords();
        } catch(err) {
          showAlert('Hata: ' + err.message, 'error');
        }
      });
    }

    // TaahhÃ¼t dÃ¼zenleme ve silme
    async function editTaahhutRecord(recordId) {
      const kayit = taahhutKayitlari.find(t => t.id === recordId);
      if(!kayit || kayit.personelUid !== currentUser.uid) {
        showAlert('Bu kaydÄ± dÃ¼zenleme yetkiniz yok', 'error');
        return;
      }

      qs('#taahhutBagisci').value = kayit.bagisci || '';
      qs('#taahhutMiktar').value = kayit.miktar || 0;
      qs('#taahhutAciklama').value = kayit.aciklama || '';

      // KayÄ±t ID'sini sakla
      qs('#taahhutForm').setAttribute('data-edit-id', recordId);
      clearTaahhutErrors();
      qs('#taahhutModal').classList.add('open');
    }

    async function deleteTaahhutRecord(recordId) {
      const kayit = taahhutKayitlari.find(t => t.id === recordId);
      if(!kayit || kayit.personelUid !== currentUser.uid) {
        showAlert('Bu kaydÄ± silme yetkiniz yok', 'error');
        return;
      }

      showConfirm('Bu taahhÃ¼t kaydÄ±nÄ± silmek istediÄŸinizden emin misiniz?', async () => {
        try {
          await db.collection('taahhut_kayitlari').doc(recordId).delete();
          showAlert('TaahhÃ¼t kaydÄ± baÅŸarÄ±yla silindi!', 'success');
          loadMyRecords();
        } catch(err) {
          showAlert('Hata: ' + err.message, 'error');
        }
      });
    }

    function openTahsilatModal() {
      showAlert('Tahsilat modÃ¼lÃ¼ yakÄ±nda eklenecektir.', 'info');
    }

    async function openAnalizModal() {
      if(!currentUser || !CURRENT_YIL) {
        showAlert('Analiz iÃ§in giriÅŸ yapmanÄ±z ve yÄ±l seÃ§meniz gerekmektedir.', 'error');
        return;
      }

      qs('#analizModal').classList.add('open');
      qs('#analizContent').innerHTML = '<div style="text-align:center; padding:20px; background:#f8f9fa; border-radius:10px;"><div style="font-size:14px; color:#7f8c8d;">YÃ¼kleniyor...</div></div>';

      try {
        // KullanÄ±cÄ±ya ait toplamlarÄ± hesapla
        const yilNum = typeof CURRENT_YIL === 'number' ? CURRENT_YIL : parseInt(CURRENT_YIL);
        
        // Ä°ftar-Sahur kayÄ±tlarÄ± (silinen kayÄ±tlarÄ± hariÃ§ tut)
        const iftarSahurSnap = await db.collection('ramazan_serif').doc(String(CURRENT_YIL))
          .collection('kayitlar')
          .where('personelUid', '==', currentUser.uid)
          .where('yil', '==', yilNum)
          .get();
        
        let toplamIftar = 0;
        let toplamSahur = 0;
        iftarSahurSnap.docs.forEach(d => {
          const data = d.data();
          // Silinen kayÄ±tlarÄ± sayma
          if(data.silindi) return;
          if(data.tip === 'iftar') {
            toplamIftar += Number(data.tutar) || 0;
          } else if(data.tip === 'sahur') {
            toplamSahur += Number(data.tutar) || 0;
          }
        });

        // Teberru kayÄ±tlarÄ±
        const teberruSnap = await db.collection('teberru_kayitlari')
          .where('personelUid', '==', currentUser.uid)
          .where('yil', '==', yilNum)
          .get();
        const toplamTeberru = teberruSnap.docs.reduce((sum, d) => sum + (Number(d.data().miktar) || 0), 0);

        // TaahhÃ¼t kayÄ±tlarÄ±
        const taahhutSnap = await db.collection('taahhut_kayitlari')
          .where('personelUid', '==', currentUser.uid)
          .where('yil', '==', yilNum)
          .get();
        const toplamTaahhut = taahhutSnap.docs.reduce((sum, d) => sum + (Number(d.data().miktar) || 0), 0);

        const toplamUlasilan = toplamIftar + toplamSahur + toplamTeberru + toplamTaahhut;

        // Personel hedefini Ã§ek
        const hedefSnap = await db.collection('ramazan_serif').doc(String(CURRENT_YIL))
          .collection('personel_hedefleri')
          .where('personelUid', '==', currentUser.uid)
          .where('yil', '==', yilNum)
          .get();
        
        // parseTutar fonksiyonu (yÃ¶netim sayfasÄ±ndaki ile aynÄ±)
        const parseTutar = (str) => {
          if(!str || str === '') return 0;
          // String'i temizle: noktalarÄ± kaldÄ±r (binlik ayÄ±rÄ±cÄ±), virgÃ¼lÃ¼ noktaya Ã§evir
          const cleaned = String(str).replace(/\./g, '').replace(',', '.');
          const parsed = parseFloat(cleaned);
          return isNaN(parsed) ? 0 : parsed;
        };
        
        let hedef = 0;
        if(!hedefSnap.empty) {
          const hedefData = hedefSnap.docs[0].data();
          // Hedef string formatÄ±nda olabilir (10.000,50 gibi), parse et
          hedef = parseTutar(hedefData.hedef || hedefData.tutar || '0');
        }

        // Nispet hesapla
        const nispet = hedef > 0 ? ((toplamUlasilan / hedef) * 100).toFixed(2) : 0;

        // Format fonksiyonu
        const formatTutar = (tutar) => {
          return new Intl.NumberFormat('tr-TR', {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
          }).format(tutar);
        };

        // Modal iÃ§eriÄŸini oluÅŸtur
        let contentHtml = '';
        
        if(hedef > 0) {
          contentHtml = `
            <div style="text-align:center; padding:25px; background:linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius:12px; margin-bottom:20px; color:white; box-shadow:0 4px 15px rgba(102,126,234,0.3);">
              <div style="font-size:15px; opacity:0.95; margin-bottom:10px; font-weight:500;">ğŸ¯ Toplam Hedef</div>
              <div style="font-size:38px; font-weight:700; margin-bottom:25px; letter-spacing:1px;">â‚º${formatTutar(hedef)}</div>
              
              <div style="border-top:1px solid rgba(255,255,255,0.3); padding-top:20px; margin-top:20px;">
                <div style="font-size:14px; opacity:0.9; margin-bottom:8px; font-weight:500;">UlaÅŸÄ±lan Rakam</div>
                <div style="font-size:30px; font-weight:600; margin-bottom:20px;">â‚º${formatTutar(toplamUlasilan)}</div>
              </div>
              
              <div style="border-top:1px solid rgba(255,255,255,0.3); padding-top:20px; margin-top:20px;">
                <div style="font-size:14px; opacity:0.9; margin-bottom:8px; font-weight:500;">UlaÅŸÄ±lan Nispet</div>
                <div style="font-size:42px; font-weight:700; margin-bottom:10px;">%${nispet}</div>
                ${nispet >= 100 ? '<div style="margin-top:15px; font-size:18px; font-weight:600;">ğŸ‰ Hedefe ulaÅŸÄ±ldÄ±!</div>' : ''}
              </div>
            </div>
          `;
        } else {
          contentHtml = `
            <div style="text-align:center; padding:25px; background:#f8f9fa; border-radius:12px; margin-bottom:20px; border:2px dashed #ddd;">
              <div style="font-size:15px; color:#7f8c8d; margin-bottom:10px; font-weight:500;">Hedef BelirlenmemiÅŸ</div>
              <div style="font-size:28px; font-weight:700; color:var(--primary); margin-bottom:10px;">â‚º${formatTutar(toplamUlasilan)}</div>
              <div style="font-size:13px; color:#95a5a6;">Toplam ulaÅŸÄ±lan rakam</div>
            </div>
          `;
        }

        contentHtml += `
          <div style="background:#f8f9fa; padding:18px; border-radius:12px; margin-bottom:15px;">
            <h4 style="margin:0 0 15px 0; font-size:17px; color:var(--primary); font-weight:600; display:flex; align-items:center; gap:8px;">
              <span>ğŸ“Š</span>
              <span>Detaylar</span>
            </h4>
            <div style="display:flex; flex-direction:column; gap:12px;">
              <div style="display:flex; justify-content:space-between; align-items:center; padding:12px 15px; background:white; border-radius:8px; border-left:4px solid #f39c12; box-shadow:0 2px 4px rgba(0,0,0,0.05);">
                <span style="font-size:15px; color:#7f8c8d; font-weight:500;">ğŸŒ™ Ä°ftar Bedeli</span>
                <span style="font-size:17px; font-weight:700; color:#f39c12;">â‚º${formatTutar(toplamIftar)}</span>
              </div>
              <div style="display:flex; justify-content:space-between; align-items:center; padding:12px 15px; background:white; border-radius:8px; border-left:4px solid #3498db; box-shadow:0 2px 4px rgba(0,0,0,0.05);">
                <span style="font-size:15px; color:#7f8c8d; font-weight:500;">ğŸŒŸ Sahur Bedeli</span>
                <span style="font-size:17px; font-weight:700; color:#3498db;">â‚º${formatTutar(toplamSahur)}</span>
              </div>
              <div style="display:flex; justify-content:space-between; align-items:center; padding:12px 15px; background:white; border-radius:8px; border-left:4px solid #27ae60; box-shadow:0 2px 4px rgba(0,0,0,0.05);">
                <span style="font-size:15px; color:#7f8c8d; font-weight:500;">ğŸ’° Teberru Bedeli</span>
                <span style="font-size:17px; font-weight:700; color:#27ae60;">â‚º${formatTutar(toplamTeberru)}</span>
              </div>
              <div style="display:flex; justify-content:space-between; align-items:center; padding:12px 15px; background:white; border-radius:8px; border-left:4px solid #3498db; box-shadow:0 2px 4px rgba(0,0,0,0.05);">
                <span style="font-size:15px; color:#7f8c8d; font-weight:500;">ğŸ“‹ TaahhÃ¼t Bedeli</span>
                <span style="font-size:17px; font-weight:700; color:#3498db;">â‚º${formatTutar(toplamTaahhut)}</span>
              </div>
              <div style="display:flex; justify-content:space-between; align-items:center; padding:15px; background:linear-gradient(135deg, var(--primary) 0%, #667eea 100%); border-radius:8px; margin-top:8px; box-shadow:0 4px 12px rgba(102,126,234,0.3);">
                <span style="font-size:18px; font-weight:700; color:white;">Toplam</span>
                <span style="font-size:24px; font-weight:800; color:white; letter-spacing:0.5px;">â‚º${formatTutar(toplamUlasilan)}</span>
              </div>
            </div>
          </div>
        `;

        qs('#analizContent').innerHTML = contentHtml;
      } catch(err) {
        console.error('Analiz yÃ¼klenirken hata:', err);
        qs('#analizContent').innerHTML = `
          <div style="text-align:center; padding:20px; background:#ffebee; border-radius:10px; color:#c62828;">
            <div style="font-size:14px; margin-bottom:8px;">Hata oluÅŸtu</div>
            <div style="font-size:12px; color:#7f8c8d;">${err.message}</div>
          </div>
        `;
      }
    }

    function closeAnalizModal() {
      qs('#analizModal').classList.remove('open');
    }

    window.openTeberruModal = openTeberruModal;
    window.openTaahhutModal = openTaahhutModal;
    window.openTahsilatModal = openTahsilatModal;
    window.openAnalizModal = openAnalizModal;
    window.closeAnalizModal = closeAnalizModal;
    window.closeTeberruModal = closeTeberruModal;
    window.closeTaahhutModal = closeTaahhutModal;
    window.showTeberruPreview = showTeberruPreview;
    window.showTaahhutPreview = showTaahhutPreview;
    window.closeTeberruPreviewModal = closeTeberruPreviewModal;
    window.closeTaahhutPreviewModal = closeTaahhutPreviewModal;
    window.saveTeberru = saveTeberru;
    window.saveTaahhut = saveTaahhut;
    window.editTeberruRecord = editTeberruRecord;
    window.deleteTeberruRecord = deleteTeberruRecord;
    window.editTaahhutRecord = editTaahhutRecord;
    window.deleteTaahhutRecord = deleteTaahhutRecord;
    window.closeInfoModal = closeInfoModal;
    window.openMenuDetailModal = openMenuDetailModal;
    window.closeMenuDetailModal = closeMenuDetailModal;
    window.switchView = switchView;
  </script>
</body>
</html>