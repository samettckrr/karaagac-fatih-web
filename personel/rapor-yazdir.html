<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8" />
  <title>Ki≈üi Bazlƒ± Alacak Raporu - Yazdƒ±r</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="../../src/supabase.js"></script>
  <script src="../../src/supabase-auth-wrapper.js"></script>

  <!-- Flutter'daki _printReport HTML tasarƒ±mƒ±na birebir yakƒ±n CSS -->
  <style>
    @page {
      margin: 0.5cm;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      font-size: 11px;
      line-height: 1.5;
      color: #1f2937;
      background: #ffffff;
      padding: 15px;
    }

    .no-print {
      margin-bottom: 16px;
      text-align: center;
    }

    .no-print button {
      padding: 8px 16px;
      margin: 0 4px;
      cursor: pointer;
      background: #0ea5e9;
      color: white;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      font-size: 13px;
    }

    .no-print button.danger {
      background: #ef4444;
    }

    .header {
      text-align: center;
      margin-bottom: 20px;
      padding: 15px;
      background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
      color: #ffffff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .header h1 {
      font-size: 24px;
      font-weight: 800;
      margin-bottom: 10px;
      letter-spacing: 0.5px;
    }

    .header .info {
      font-size: 13px;
      color: #e2e8f0;
      display: flex;
      justify-content: center;
      gap: 20px;
      margin-top: 10px;
      flex-wrap: wrap;
    }

    .header .info div {
      padding: 4px 12px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
    }

    .summary {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 12px;
      margin-bottom: 20px;
    }

    .summary-item {
      text-align: center;
      padding: 12px;
      background: #f8fafc;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
    }

    .summary-item label {
      display: block;
      font-size: 11px;
      color: #64748b;
      margin-bottom: 8px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .summary-item .value {
      font-size: 18px;
      font-weight: 800;
      color: #1f2937;
    }

    .summary-item:nth-child(2) .value {
      color: #22c55e;
    }

    .summary-item:nth-child(3) .value {
      color: #f59e0b;
    }

    .summary-item:nth-child(4) .value {
      color: #3b82f6;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 15px;
      font-size: 10px;
      page-break-inside: auto;
      background: #ffffff;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      border-radius: 6px;
      overflow: hidden;
    }

    thead {
      display: table-header-group;
      background: linear-gradient(135deg, #475569 0%, #64748b 100%);
      color: #ffffff;
    }

    tbody {
      display: table-row-group;
    }

    tr {
      page-break-inside: avoid;
      page-break-after: auto;
      border-bottom: 1px solid #e2e8f0;
    }

    tr:hover {
      background-color: #f8fafc;
    }

    th,
    td {
      padding: 8px 10px;
      text-align: left;
    }

    th {
      font-weight: 700;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #ffffff;
    }

    td {
      font-size: 10px;
      color: #334155;
    }

    td.numeric {
      text-align: right;
      font-family: 'Segoe UI', Arial, sans-serif;
      font-weight: 600;
    }

    tbody tr:last-child {
      border-bottom: none;
    }

    .total-row {
      background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%) !important;
      font-weight: 800;
      border-top: 2px solid #475569;
    }

    .total-row td {
      color: #0f172a;
      font-size: 11px;
    }

    /* Personel sƒ±ralamasƒ± b√∂l√ºm√º */
    .rank-section {
      margin-bottom: 18px;
    }

    .rank-section h3 {
      margin-bottom: 8px;
      font-size: 14px;
      color: #0f172a;
    }

    .rank-section table th:nth-child(1) {
      width: 40px;
    }

    /* Faaliyet √∂zet b√∂l√ºm√º (tek personel modu) */
    .faaliyet-section {
      margin-bottom: 18px;
    }

    .faaliyet-section h3 {
      margin-bottom: 8px;
      font-size: 14px;
      color: #0f172a;
    }

    .faaliyet-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
    }

    .faaliyet-card {
      padding: 10px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
    }

    .faaliyet-title {
      font-weight: 700;
      margin-bottom: 4px;
      font-size: 12px;
    }

    .faaliyet-row {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      margin-top: 2px;
    }

    .faaliyet-kalan {
      display: inline-block;
      margin-top: 6px;
      padding: 3px 8px;
      border-radius: 999px;
      font-size: 10px;
      font-weight: 700;
    }

    .kalan-pozitif {
      background: #fff7ed;
      color: #9a3412;
      border: 1px solid #fdba74;
    }

    .kalan-non {
      background: #ecfdf5;
      color: #065f46;
      border: 1px solid #86efac;
    }

    .kalan-negatif {
      background: #eff6ff;
      color: #1d4ed8;
      border: 1px solid #93c5fd;
    }

    @media (max-width: 900px) {
      .faaliyet-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 640px) {
      .faaliyet-grid {
        grid-template-columns: 1fr;
      }
    }

    .footer {
      margin-top: 25px;
      padding: 15px;
      background: #f8fafc;
      border-top: 3px solid #0f172a;
      border-radius: 6px;
      text-align: center;
      font-size: 11px;
      color: #64748b;
    }

    .footer div:first-child {
      font-weight: 700;
      color: #1f2937;
      margin-bottom: 4px;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #6b7280;
      font-size: 16px;
    }

    .error {
      text-align: center;
      padding: 40px;
      color: #dc2626;
      font-size: 16px;
      background: #fff1f2;
      border: 1px solid #fecaca;
      border-radius: 8px;
    }

    @media print {
      body {
        padding: 10px;
      }

      .no-print {
        display: none;
      }

      .header {
        border-radius: 0;
        box-shadow: none;
      }

      .summary {
        page-break-inside: avoid;
        gap: 8px;
      }

      .summary-item {
        border-radius: 4px;
        padding: 8px;
      }

      table {
        font-size: 9px;
        box-shadow: none;
        border-radius: 0;
      }

      th,
      td {
        padding: 6px 8px;
      }

      th {
        font-size: 10px;
      }

      td {
        font-size: 9px;
      }

      .footer {
        border-radius: 0;
      }
    }
  </style>
</head>

<body>
  <div class="no-print">
    <button onclick="window.print()">üñ®Ô∏è Yazdƒ±r</button>
    <button onclick="window.close()" class="danger">‚úï Kapat</button>
  </div>

  <div id="loading" class="loading">Rapor y√ºkleniyor...</div>
  <div id="error" class="error" style="display:none"></div>

  <div id="content" style="display:none">
    <div class="header">
      <h1>üìä Ki≈üi Bazlƒ± Alacak Raporu</h1>
      <div class="info">
        <div id="infoPerson">üë§ Personel:</div>
        <div id="infoYil">üìÖ Yƒ±l:</div>
        <div id="infoTarih">üïê</div>
      </div>
    </div>

    <div class="summary">
      <div class="summary-item">
        <label>üí∞ Toplam Tahakkuk</label>
        <div class="value" id="sumTahakkuk">‚Ç∫0,00</div>
      </div>
      <div class="summary-item">
        <label>‚úÖ Toplam Tahsilat</label>
        <div class="value" id="sumTahsilat">‚Ç∫0,00</div>
      </div>
      <div class="summary-item">
        <label>‚ö†Ô∏è Kalan</label>
        <div class="value" id="sumKalan">‚Ç∫0,00</div>
      </div>
      <div class="summary-item">
        <label>üìà Tahsilat Oranƒ±</label>
        <div class="value" id="sumOran">%0,0</div>
      </div>
    </div>

    <!-- T√ºm personel modunda personel ba≈üarƒ± sƒ±ralamasƒ± -->
    <div id="rankSection" class="rank-section" style="display:none">
      <h3>Personel Ba≈üarƒ± Sƒ±ralamasƒ±</h3>
      <table>
        <thead>
          <tr>
            <th>#</th>
            <th>Personel</th>
            <th class="numeric">Toplam Tahakkuk</th>
            <th class="numeric">Toplam Tahsilat</th>
            <th class="numeric">Kalan</th>
            <th class="numeric">Tahsilat Nispeti</th>
          </tr>
        </thead>
        <tbody id="rankBody"></tbody>
      </table>
    </div>

    <!-- Tek personel modunda faaliyet bazlƒ± √∂zet -->
    <div id="faaliyetSection" class="faaliyet-section" style="display:none">
      <h3>Faaliyet Bazlƒ± √ñzet</h3>
      <div id="faaliyetGrid" class="faaliyet-grid"></div>
    </div>

    <table id="raporTable">
      <thead>
        <tr>
          <th>Yƒ±l</th>
          <th>Faaliyet</th>
          <th id="thPersonel" style="display:none">Personel</th>
          <th>Bor√ßlu</th>
          <th>√ñdeyen</th>
          <th>A√ßƒ±klama</th>
          <th class="numeric">Tahakkuk</th>
          <th class="numeric">Tahsilat</th>
          <th class="numeric">Yeni Tahsilat</th>
          <th class="numeric">Kalan</th>
        </tr>
      </thead>
      <tbody id="raporBody"></tbody>
    </table>

    <div class="footer">
      <div id="footerInfo">üìã Toplam 0 kayƒ±t</div>
      <div id="footerDate">Karaaƒüa√ß Fatih</div>
    </div>
  </div>

  <script>
    // === Sabitler & yardƒ±mcƒ±lar (rapor-personel + Flutter _printReport ile uyumlu) ===
    const MERGE_MAP = {
      'keramettin kocaoƒülu': 'Kerem Kocaoƒülu',
      'kerem kocaoƒülu': 'Kerem Kocaoƒülu'
    };
    const AYRILANLAR = ['burak serin'];

    // Supabase client helper
    const getSupabase = () => window.supabase;

    const qs = sel => document.querySelector(sel);
    const money = n =>
      new Intl.NumberFormat('tr-TR', {
        style: 'currency',
        currency: 'TRY',
        maximumFractionDigits: 2
      }).format(n || 0);
    const tidy = s => (s || '').toString().trim().replace(/\s+/g, ' ');
    const normTR = s => tidy(s).toLocaleLowerCase('tr-TR');

    function titleTR(s) {
      const lower = normTR(s);
      const SEP = /([ \t\r\n\-\u2019'_/.,;:()]+)/;
      return lower
        .split(SEP)
        .map(part => {
          if (!part || SEP.test(part)) return part;
          return part.charAt(0).toLocaleUpperCase('tr-TR') + part.slice(1);
        })
        .join('');
    }

    function resolveName(name) {
      const n = normTR(name);
      if (MERGE_MAP[n]) return MERGE_MAP[n];
      return titleTR(name);
    }

    // Tarihi g√ºvenli ≈üekilde YYYY-MM-DD'e √ßevir (Supabase i√ßin)
    function toDateKey(v) {
      if (!v) return '';
      if (typeof v === 'string') return v.slice(0, 10);
      if (v instanceof Date) return v.toISOString().slice(0, 10);
      // Supabase'den gelen timestamp string'leri i√ßin
      if (typeof v === 'object' && v.toString) {
        try {
          const d = new Date(v);
          if (!isNaN(d.getTime())) return d.toISOString().slice(0, 10);
        } catch (e) {
          return '';
        }
      }
      return '';
    }

    function parseDate(v) {
      const key = toDateKey(v);
      if (!key) return null;
      const d = new Date(key + 'T00:00:00');
      return isNaN(d.getTime()) ? null : d;
    }

    function getRelatedTahsilat(tahakkuk, list) {
      return list.filter(s => {
        if (s.tahakkukId && s.tahakkukId === tahakkuk.id) return true;
        if (
          String(s.yil) === String(tahakkuk.yil) &&
          s.faaliyet === tahakkuk.faaliyet &&
          s.personel === tahakkuk.personel &&
          s.borclu === tahakkuk.borclu
        )
          return true;
        return false;
      });
    }

    function formatTahsilatOrani(sumTah, sumTsl) {
      if (!sumTah || sumTah <= 0) return '%0,0';
      const oran = (sumTsl / sumTah) * 100;
      return '%' + oran.toFixed(1).replace('.', ',');
    }

    // URL parametreleri (personel, yil, hideZero, sortCol, sortDir, rankSortCol, rankSortDir)
    const urlParams = new URLSearchParams(window.location.search);
    const paramPerson = urlParams.get('personel') || 'ALL';
    const paramYil = urlParams.get('yil') || String(new Date().getFullYear());
    const paramHideZero = urlParams.get('hideZero') === '1';
    let paramSortCol = urlParams.get('sortCol') || null;
    const paramSortDir = urlParams.get('sortDir') || 'asc';
    const paramRankSortCol = urlParams.get('rankSortCol') || null;
    const paramRankSortDir = urlParams.get('rankSortDir') || 'desc';
    
    // Alan adƒ± d√∂n√º≈ü√ºm√º: rapor-personel.html'deki alan adlarƒ± -> rapor-yazdir.html'deki alan adlarƒ±
    const fieldNameMap = {
      'tah': 'tahakkuk',
      'tsl': 'tahsilat',
      'kal': 'kalan'
    };
    if (paramSortCol && fieldNameMap[paramSortCol]) {
      paramSortCol = fieldNameMap[paramSortCol];
    }

    let allTahakkuk = [];
    let allTahsilat = [];

    // Supabase session kontrol√º
    (async function init() {
      try {
        // Supabase client'ƒ±n y√ºklenmesini bekle (auth √∂zelliƒüi de hazƒ±r olmalƒ±)
        let supabase = getSupabase();
        let retries = 0;
        const maxRetries = 50; // 5 saniye bekle
        
        while ((!supabase || !supabase.auth || typeof supabase.auth.getSession !== 'function') && retries < maxRetries) {
          await new Promise(resolve => setTimeout(resolve, 100));
          supabase = getSupabase();
          retries++;
        }
        
        if (!supabase) {
          showError('Supabase client y√ºklenemedi. Sayfayƒ± yenileyin.');
          return;
        }
        
        if (!supabase.auth || typeof supabase.auth.getSession !== 'function') {
          showError('Supabase Auth hazƒ±r deƒüil. Sayfayƒ± yenileyin.');
          console.error('Supabase durumu:', {
            hasSupabase: !!supabase,
            hasAuth: !!supabase.auth,
            hasGetSession: supabase.auth ? typeof supabase.auth.getSession : 'N/A'
          });
          return;
        }

        // Supabase auth session kontrol√º
        const { data: sessionData, error: sessionError } = await supabase.auth.getSession();
        if (sessionError || !sessionData?.session?.user) {
          showError('Oturum a√ßmanƒ±z gerekiyor.');
          return;
        }

        await loadData();
        renderReport();
        // Flutter tarafƒ±ndaki gibi: sayfa y√ºklenince otomatik yazdƒ±r
        setTimeout(() => window.print(), 300);
      } catch (e) {
        console.error('Yazdƒ±rma sayfasƒ± hatasƒ±:', e);
        showError('Veri y√ºklenirken bir hata olu≈ütu: ' + (e.message || e));
      }
    })();

    async function loadData() {
      qs('#loading').style.display = 'block';
      qs('#error').style.display = 'none';
      qs('#content').style.display = 'none';

      const supabase = getSupabase();
      if (!supabase) {
        throw new Error('Supabase client hazƒ±r deƒüil');
      }

      // Tahakkuklar
      const { data: tahakkukData, error: tahakkukError } = await supabase
        .from('tahakkuklar')
        .select('*');
      
      if (tahakkukError) {
        throw new Error('Tahakkuklar y√ºklenemedi: ' + tahakkukError.message);
      }

      allTahakkuk = (tahakkukData || []).map(d => {
        return {
          id: d.id,
          ...d,
          personel: resolveName(d.personel),
          borclu: resolveName(d.borclu),
          faaliyet: titleTR(d.faaliyet)
        };
      });

      // Tahsilatlar
      const { data: tahsilatData, error: tahsilatError } = await supabase
        .from('tahsilatlar')
        .select('*');
      
      if (tahsilatError) {
        throw new Error('Tahsilatlar y√ºklenemedi: ' + tahsilatError.message);
      }

      allTahsilat = (tahsilatData || []).map(d => {
        return {
          id: d.id,
          ...d,
          personel: resolveName(d.personel),
          borclu: resolveName(d.borclu),
          faaliyet: titleTR(d.faaliyet)
        };
      });
    }

    function showError(msg) {
      qs('#loading').style.display = 'none';
      qs('#content').style.display = 'none';
      qs('#error').style.display = 'block';
      qs('#error').textContent = msg;
    }

    function renderReport() {
      const now = new Date();
      const sevenDaysAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);

      // Ki≈üi & yƒ±l filtresi
      const showPersonel = paramPerson === 'ALL';
      const yilFilter = paramYil === 'tum' ? null : String(paramYil);

      let tList = allTahakkuk;
      let sList = allTahsilat;

      if (yilFilter) {
        tList = tList.filter(x => String(x.yil) === yilFilter);
        sList = sList.filter(x => String(x.yil) === yilFilter);
      }

      if (!showPersonel) {
        tList = tList.filter(x => x.personel === paramPerson);
        sList = sList.filter(x => x.personel === paramPerson);
      }

      // Satƒ±rlarƒ± olu≈ütur (Flutter RaporRow yapƒ±sƒ±na paralel)
      const usedTahsilatIds = new Set();
      let rows = [];

      tList.forEach(t => {
        const related = getRelatedTahsilat(t, sList);
        related.forEach(s => usedTahsilatIds.add(s.id));

        const tahakkuk = Number(t.tahakkuk || 0);
        let tahsilat = 0;
        let yeni = 0;

        related.forEach(s => {
          const tutar = Number(s.tutar || 0);
          tahsilat += tutar;
          const d = parseDate(s.tarih);
          if (d && d >= sevenDaysAgo) {
            yeni += tutar;
          }
        });

        const kalan = tahakkuk - tahsilat;
        const odeyen = related.length > 0 ? tidy(related[related.length - 1].odeyen) || '-' : '-';

        rows.push({
          yil: t.yil,
          faaliyet: t.faaliyet,
          personel: t.personel,
          borclu: t.borclu,
          odeyen,
          aciklama: tidy(t.aciklama),
          tahakkuk,
          tahsilat,
          yeni,
          kalan
        });
      });

      // Yetim tahsilatlar
      sList.forEach(s => {
        if (usedTahsilatIds.has(s.id)) return;
        const tutar = Number(s.tutar || 0);
        const d = parseDate(s.tarih);
        const yeni = d && d >= sevenDaysAgo ? tutar : 0;
        rows.push({
          yil: s.yil,
          faaliyet: s.faaliyet,
          personel: s.personel,
          borclu: s.borclu,
          odeyen: tidy(s.odeyen) || '-',
          aciklama: tidy(s.aciklama),
          tahakkuk: 0,
          tahsilat: tutar,
          yeni,
          kalan: -tutar
        });
      });

      // Kalan sƒ±fƒ±r olanlarƒ± gizle (URL parametresinden) - √ñNCE gizle, SONRA sƒ±rala
      if (paramHideZero) {
        rows = rows.filter(r => Math.abs(r.kalan) > 0.001);
      }

      // Sƒ±ralama: URL parametrelerinden gelen sƒ±ralama ayarlarƒ±nƒ± uygula
      if (paramSortCol && paramSortCol !== '') {
        rows.sort((a, b) => {
          let va = a[paramSortCol], vb = b[paramSortCol];
          if (va === undefined || va === null) va = '';
          if (vb === undefined || vb === null) vb = '';
          if (typeof va === 'string') {
            return paramSortDir === 'asc' ? va.localeCompare(vb, 'tr') : vb.localeCompare(va, 'tr');
          }
          return paramSortDir === 'asc' ? va - vb : vb - va;
        });
      } else {
        // Varsayƒ±lan sƒ±ralama: yƒ±l, faaliyet, bor√ßlu
        rows.sort((a, b) => {
          const ya = String(a.yil || ''), yb = String(b.yil || '');
          if (ya !== yb) return ya.localeCompare(yb, 'tr');
          const fa = a.faaliyet || '', fb = b.faaliyet || '';
          if (fa !== fb) return fa.localeCompare(fb, 'tr');
          return (a.borclu || '').localeCompare(b.borclu || '', 'tr');
        });
      }

      // Toplamlar
      let sumTah = 0, sumTsl = 0, sumYeni = 0, sumKal = 0;
      rows.forEach(r => {
        sumTah += r.tahakkuk;
        sumTsl += r.tahsilat;
        sumYeni += r.yeni;
        sumKal += r.kalan;
      });

      // Header bilgileri
      const personLabel = showPersonel ? 'T√ºm Personel' : paramPerson;
      const yilLabel = paramYil === 'tum' ? 'T√ºm√º' : paramYil;

      const dateStr = now.toLocaleDateString('tr-TR') + ' ' + now.toLocaleTimeString('tr-TR', {
        hour: '2-digit',
        minute: '2-digit'
      });

      qs('#infoPerson').textContent = 'üë§ Personel: ' + personLabel;
      qs('#infoYil').textContent = 'üìÖ Yƒ±l: ' + yilLabel;
      qs('#infoTarih').textContent = 'üïê ' + dateStr;

      // KPI kartlarƒ±
      qs('#sumTahakkuk').textContent = money(sumTah);
      qs('#sumTahsilat').textContent = money(sumTsl);
      qs('#sumKalan').textContent = money(sumKal);
      qs('#sumOran').textContent = formatTahsilatOrani(sumTah, sumTsl);

      // Personel sƒ±ralamasƒ± / Faaliyet √∂zeti
      if (showPersonel) {
        renderRankSection(tList, sList);
        qs('#faaliyetSection').style.display = 'none';
      } else {
        qs('#rankSection').style.display = 'none';
        renderFaaliyetSection(rows);
      }

      // Tablo g√∂vdesi
      const tbody = qs('#raporBody');
      tbody.innerHTML = '';

      if (showPersonel) {
        qs('#thPersonel').style.display = '';
      } else {
        qs('#thPersonel').style.display = 'none';
      }

      rows.forEach(r => {
        const isZero = Math.abs(r.kalan) < 0.001;
        // Kalan sƒ±fƒ±r olanlar ye≈üil arka plan ve ye≈üil kenarlƒ±k
        const rowStyle = isZero ? 'background-color: #ecfdf5; border-left: 3px solid #22c55e;' : '';
        const tr = document.createElement('tr');
        tr.setAttribute('style', rowStyle);

        tr.innerHTML = `
          <td>${r.yil || ''}</td>
          <td>${r.faaliyet || ''}</td>
          ${showPersonel ? `<td>${r.personel || ''}</td>` : ''}
          <td>${r.borclu || ''}</td>
          <td>${r.odeyen || ''}</td>
          <td>${r.aciklama || ''}</td>
          <td class="numeric">${money(r.tahakkuk)}</td>
          <td class="numeric">${money(r.tahsilat)}</td>
          <td class="numeric">${money(r.yeni)}</td>
          <td class="numeric">${money(r.kalan)}</td>
        `;
        tbody.appendChild(tr);
      });

      // Toplam satƒ±rƒ±
      const totalTr = document.createElement('tr');
      totalTr.className = 'total-row';
      const colSpan = showPersonel ? 6 : 5;
      totalTr.innerHTML = `
        <td colspan="${colSpan}"><strong>TOPLAM</strong></td>
        <td class="numeric">${money(sumTah)}</td>
        <td class="numeric">${money(sumTsl)}</td>
        <td class="numeric">${money(sumYeni)}</td>
        <td class="numeric">${money(sumKal)}</td>
      `;
      tbody.appendChild(totalTr);

      // Footer
      qs('#footerInfo').textContent = `üìã Toplam ${rows.length} kayƒ±t`;
      qs('#footerDate').textContent = `Karaaƒüa√ß Fatih - ${now.getFullYear()}`;

      // g√∂r√ºn√ºrl√ºkler
      qs('#loading').style.display = 'none';
      qs('#error').style.display = 'none';
      qs('#content').style.display = 'block';
    }

    // T√ºm personel modunda personel ba≈üarƒ± sƒ±ralamasƒ±
    function renderRankSection(tahakkuklar, tahsilatlar) {
      const rankSection = qs('#rankSection');
      const tbody = qs('#rankBody');
      tbody.innerHTML = '';

      const stats = {};
      tahakkuklar.forEach(t => {
        const p = t.personel;
        if (!p) return;
        if (!stats[p]) stats[p] = { t: 0, s: 0 };
        stats[p].t += Number(t.tahakkuk || 0);
      });
      tahsilatlar.forEach(s => {
        const p = s.personel;
        if (!p) return;
        if (!stats[p]) stats[p] = { t: 0, s: 0 };
        stats[p].s += Number(s.tutar || 0);
      });

      let list = Object.entries(stats).map(([p, v]) => {
        const k = v.t - v.s;
        const n = v.t > 0 ? (v.s / v.t) * 100 : 0;
        return { p, t: v.t, s: v.s, k, n, isAyrilan: AYRILANLAR.includes(normTR(p)) };
      });

      const ayrilanList = list.filter(r => r.isAyrilan);
      const aktifList = list.filter(r => !r.isAyrilan);

      // Personel sƒ±ralamasƒ±: URL parametrelerinden gelen sƒ±ralama ayarlarƒ±nƒ± uygula
      if (paramRankSortCol && paramRankSortCol !== '') {
        aktifList.sort((a, b) => {
          let va = a[paramRankSortCol], vb = b[paramRankSortCol];
          if (va === undefined || va === null) va = '';
          if (vb === undefined || vb === null) vb = '';
          if (typeof va === 'string') {
            return paramRankSortDir === 'asc' ? va.localeCompare(vb, 'tr') : vb.localeCompare(va, 'tr');
          }
          return paramRankSortDir === 'asc' ? va - vb : vb - va;
        });
      } else {
        // Varsayƒ±lan sƒ±ralama: Tahsilat nispetine g√∂re azalan
        aktifList.sort((a, b) => b.n - a.n);
      }

      aktifList.forEach((r, idx) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${idx + 1}</td>
          <td>${r.p}</td>
          <td class="numeric">${money(r.t)}</td>
          <td class="numeric">${money(r.s)}</td>
          <td class="numeric">${money(r.k)}</td>
          <td class="numeric">%${r.n.toFixed(1)}</td>
        `;
        tbody.appendChild(tr);
      });

      if (ayrilanList.length > 0) {
        const sep = document.createElement('tr');
        sep.innerHTML = `<td colspan="6" style="text-align:center;font-weight:700;background:#f1f5f9;color:#6b7280">AYRILAN PERSONEL</td>`;
        tbody.appendChild(sep);

        ayrilanList.forEach(r => {
          const tr = document.createElement('tr');
          tr.style.background = '#fff1f2';
          tr.innerHTML = `
            <td>-</td>
            <td>${r.p}</td>
            <td class="numeric">${money(r.t)}</td>
            <td class="numeric">${money(r.s)}</td>
            <td class="numeric">${money(r.k)}</td>
            <td class="numeric">%${r.n.toFixed(1)}</td>
          `;
          tbody.appendChild(tr);
        });
      }

      rankSection.style.display = tbody.children.length ? 'block' : 'none';
    }

    // Tek personel modunda faaliyet bazlƒ± √∂zet
    function renderFaaliyetSection(rows) {
      const sec = qs('#faaliyetSection');
      const grid = qs('#faaliyetGrid');
      grid.innerHTML = '';

      const fMap = {};
      rows.forEach(r => {
        const key = r.faaliyet || '';
        if (!key) return;
        if (!fMap[key]) {
          fMap[key] = { tahakkuk: 0, tahsilat: 0, kalan: 0 };
        }
        fMap[key].tahakkuk += Number(r.tahakkuk || 0);
        // Flutter tarafƒ±nda tahsilat √∂zetinde yeni tahsilat da ekleniyor
        fMap[key].tahsilat += Number(r.tahsilat || 0) + Number(r.yeni || 0);
        fMap[key].kalan += Number(r.kalan || 0);
      });

      const list = Object.entries(fMap).map(([faaliyet, v]) => ({
        faaliyet,
        tahakkuk: v.tahakkuk,
        tahsilat: v.tahsilat,
        kalan: v.kalan
      }));

      if (!list.length) {
        sec.style.display = 'none';
        return;
      }

      list.sort((a, b) => b.kalan - a.kalan);

      list.forEach(item => {
        let cls = 'kalan-non';
        if (item.kalan > 0.1) cls = 'kalan-pozitif';
        if (item.kalan < -0.1) cls = 'kalan-negatif';

        const div = document.createElement('div');
        div.className = 'faaliyet-card';
        div.innerHTML = `
          <div class="faaliyet-title">${item.faaliyet}</div>
          <div class="faaliyet-row">
            <span>Tahakkuk</span>
            <span>${money(item.tahakkuk)}</span>
          </div>
          <div class="faaliyet-row">
            <span>Tahsilat</span>
            <span>${money(item.tahsilat)}</span>
          </div>
          <span class="faaliyet-kalan ${cls}">Kalan: ${money(item.kalan)}</span>
        `;
        grid.appendChild(div);
      });

      sec.style.display = 'block';
    }
  </script>
</body>

</html>
