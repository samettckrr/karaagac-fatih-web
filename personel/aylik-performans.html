<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8"/>
  <title>Aylık Performans | Analiz</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="icon" href="../img/logo.png"/>

  <style>
    /* =====================  AÇIK TEMA & MOBİL ÖNCELİK  ===================== */
    :root{
      --bg:#f7fafc; --surface:#ffffff; --text:#0f172a; --muted:#475569; --stroke:#e2e8f0;
      --brand:#0ea5e9; --brand2:#6366f1; --ok:#16a34a; --bad:#ef4444; --warn:#f59e0b;
      --radius:14px; --shadow:0 8px 24px rgba(2,6,23,.08);
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,Segoe UI,Arial}

    .appbar{position:sticky;top:0;z-index:5;height:56px;background:#ffffffd9;border-bottom:1px solid var(--stroke);
      backdrop-filter:saturate(120%) blur(6px);display:flex;align-items:center;justify-content:space-between;padding:0 12px}
    .appbar h1{margin:0;font-size:17px;font-weight:800}
    .btn{appearance:none;border:1px solid var(--stroke);background:#fff;border-radius:12px;padding:9px 12px;cursor:pointer}
    .btn:hover{background:#f8fafc}
    .btn.acc{background:linear-gradient(90deg,var(--brand),var(--brand2));border:0;color:#fff;font-weight:700}
    .switch{display:inline-flex;align-items:center;gap:8px}
    .switch input{accent-color:var(--brand)}

    .wrap{max-width:1300px;margin:16px auto;padding:0 12px;display:grid;gap:12px}
    .row{display:grid;gap:12px}
    @media(min-width:700px){.cols-2{grid-template-columns:1fr 1fr}}
    @media(min-width:980px){.cols-3{grid-template-columns:1fr 1fr 1fr}}
    @media(min-width:1180px){.cols-4{grid-template-columns:1.3fr 1fr 1fr 1fr}}

    .card{background:var(--surface);border:1px solid var(--stroke);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card .hd{padding:12px;border-bottom:1px solid var(--stroke);display:flex;align-items:center;justify-content:space-between;gap:8px}
    .card .hd strong{font-size:15px}
    .card .bd{padding:12px}

    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input,select{width:100%;padding:9px;border-radius:10px;border:1px solid var(--stroke);background:#fff;color:var(--text)}
    .muted{color:var(--muted)} .hint{font-size:12px;color:var(--muted)}
    .badge{font-size:11px;border:1px solid var(--stroke);padding:4px 6px;border-radius:8px;color:var(--muted)}
    .divider{height:1px;background:var(--stroke);margin:8px 0}
    .scroll-x{overflow:auto}

    /* KPI */
    .kpis{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
    @media(max-width:1000px){.kpis{grid-template-columns:repeat(3,1fr)}}
    @media(max-width:640px){.kpis{grid-template-columns:repeat(2,1fr)}}
    .kpi{background:#fff;border:1px solid var(--stroke);border-radius:12px;padding:12px}
    .kpi .lbl{font-size:12px;color:var(--muted)}
    .kpi .val{font-weight:800;font-size:20px}
    .kpi .diff{font-size:12px;color:var(--muted)}

    /* Çoklu yıl seçici (chip dropdown) */
    .year-select{position:relative}
    .chipbox{display:flex;flex-wrap:wrap;gap:6px;border:1px solid var(--stroke);border-radius:10px;padding:6px}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:5px 8px;border-radius:999px;background:#f1f5f9;border:1px solid var(--stroke);font-size:12px}
    .chip button{border:0;background:transparent;cursor:pointer}
    .dropdown{position:absolute;z-index:3;background:#fff;border:1px solid var(--stroke);border-radius:10px;box-shadow:var(--shadow);padding:6px;width:100%;max-height:220px;overflow:auto;display:none}
    .dropdown label{display:flex;align-items:center;gap:8px;padding:6px;border-radius:8px;cursor:pointer}
    .dropdown label:hover{background:#f8fafc}

    /* Personel kıyas matrisi */
    table.matrix{width:100%;border-collapse:collapse}
    .matrix th,.matrix td{border-bottom:1px solid var(--stroke);padding:8px;text-align:left;vertical-align:top}
    .matrix thead th{background:#f1f5f9;font-weight:700;position:sticky;top:0;z-index:1}
    .sticky-col{position:sticky;left:0;background:#fff;z-index:2;font-weight:700}
    .mini{font-size:12px;color:var(--muted)}
    .ok{color:var(--ok)} .bad{color:var(--bad)} .warn{color:var(--warn)}

    /* Ağaç liste (gider kalemleri) */
    .tree-row{cursor:pointer}
    .tree-row .caret{display:inline-block;transform:rotate(0deg);transition:transform .2s}
    .tree-row.expanded .caret{transform:rotate(90deg)}
    .lvl0{font-weight:800}
    .lvl1{padding-left:14px}
    .lvl2{padding-left:28px}

  </style>

  <!-- ApexCharts -->
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
</head>
<body>
  <header class="appbar">
    <h1>📈 Aylık Performans & Analiz</h1>
    <div style="display:flex;gap:8px">
      <button class="btn" onclick="history.back()">Geri</button>
      <button class="btn acc" id="btnLogout">Çıkış</button>
    </div>
  </header>

  <main class="wrap">
    <!-- Filtreler -->
    <section class="card">
      <div class="hd"><strong>Filtrele</strong><span class="badge" id="lblSecim">—</span></div>
      <div class="bd">
        <div class="row cols-3">
          <!-- Çoklu yıl seçici -->
          <div class="year-select">
            <label>Yıllar (birden fazla seç)</label>
            <div class="chipbox" id="yearChips">
              <!-- chips here -->
              <input id="yearInput" placeholder="Yıl ekle..." style="border:0;outline:none;flex:1;min-width:90px"/>
            </div>
            <div class="dropdown" id="yearDrop"></div>
            <div class="hint">Örn: 2023, 2024, 2025. İlk seçilen “hedef yıl” kabul edilir.</div>
          </div>

          <!-- Kategori (üst/alt) -->
          <div>
            <label>Kategori (path)</label>
            <input id="fPath" placeholder="Örn: Ramazan-ı Şerif veya Ramazan-ı Şerif>İftar" list="katList"/>
            <datalist id="katList"></datalist>
            <div class="hint">Üst kategori seçersen alt kategoriler otomatik dâhil edilir.</div>
          </div>

          <!-- Diğerleri -->
          <div>
            <label>Personel (ops.)</label>
            <input id="fPer" placeholder="ID veya ad-soyad"/>
            <div class="switch" style="margin-top:8px">
              <input type="checkbox" id="fIncludeAccrual"/><label for="fIncludeAccrual" style="margin:0">Tahakkukları dâhil et</label>
            </div>
          </div>
        </div>

        <div class="row cols-3" style="margin-top:8px">
          <div><label>Başlangıç</label><input type="date" id="fStart"/></div>
          <div><label>Bitiş</label><input type="date" id="fEnd"/></div>
          <div style="display:flex;justify-content:end;align-items:end;gap:8px">
            <button class="btn" id="btnClear">Temizle</button>
            <button class="btn acc" id="btnUygula">Uygula</button>
          </div>
        </div>
      </div>
    </section>

    <!-- KPI Kartları -->
    <section class="kpis" aria-label="KPI">
      <div class="kpi"><div class="lbl">Toplam Gelir (cash)</div><div class="val" id="kGelir">₺0</div><div class="diff" id="kGelirDiff">—</div></div>
      <div class="kpi"><div class="lbl">Toplam Gider (cash)</div><div class="val" id="kGider">₺0</div><div class="diff" id="kGiderDiff">—</div></div>
      <div class="kpi"><div class="lbl">Açık Tahakkuk</div><div class="val" id="kAccrual">₺0</div><div class="diff" id="kAccrualInfo">—</div></div>
      <div class="kpi"><div class="lbl">Bütçe Ulaşım (Gelir)</div><div class="val" id="kButceGelir">0%</div><div class="diff" id="kButceGelirNeed">—</div></div>
      <div class="kpi"><div class="lbl">Bütçe Ulaşım (Gider)</div><div class="val" id="kButceGider">0%</div><div class="diff" id="kButceGiderNeed">—</div></div>
    </section>

    <!-- Grafikler: Aylık Gelir/Gider + Bütçe İlerleme Gelir/Gider -->
    <section class="row cols-3">
      <article class="card">
        <div class="hd"><strong>Aylık Gelir vs Gider</strong><span class="badge" id="lblYil">—</span></div>
        <div class="bd"><div id="chMonthly" style="height:320px"></div></div>
      </article>
      <article class="card">
        <div class="hd"><strong>Bütçe İlerleme (Gelir)</strong><span class="badge" id="lblButceG">—</span></div>
        <div class="bd"><div id="chGaugeG" style="height:320px"></div></div>
      </article>
      <article class="card">
        <div class="hd"><strong>Bütçe İlerleme (Gider)</strong><span class="badge" id="lblButceK">—</span></div>
        <div class="bd"><div id="chGaugeK" style="height:320px"></div></div>
      </article>
    </section>

    <!-- Personel Kıyas Matris + Personel Katkı Halkası + Yorumlar -->
    <section class="row cols-2">
      <article class="card">
        <div class="hd"><strong>Personel Kıyas (Solda isimler • Üstte yıllar)</strong><span class="badge" id="lblPer">—</span></div>
        <div class="bd scroll-x">
          <table class="matrix" id="tblPersonel">
            <thead id="perHead"></thead>
            <tbody id="perBody"></tbody>
          </table>
          <div class="hint" style="margin-top:6px">Seçilen ilk yıl için her personelde “Miktar – Bütçeye Katkı % – Hedefe Ulaşım %” gösterilir.</div>
        </div>
      </article>
      <article class="card">
        <div class="hd"><strong>Personel Katkı Halkası</strong><span class="badge" id="lblDonut">—</span></div>
        <div class="bd">
          <div id="chDonut" style="height:360px"></div>
          <div class="divider"></div>
          <div id="yorum" class="hint">Analiz yorumları burada üretilecek.</div>
        </div>
      </article>
    </section>

    <!-- Gider Kalemleri (Ağaç) -->
    <section class="card">
      <div class="hd"><strong>Gider Kalemleri (Hiyerarşik)</strong><span class="badge" id="lblGiderTree">—</span></div>
      <div class="bd scroll-x">
        <table class="matrix" id="tblGider">
          <thead><tr><th>Kategori</th><th>Tutar</th></tr></thead>
          <tbody id="giderBody"></tbody>
        </table>
      </div>
    </section>

    <!-- Gelişmiş Arama -->
    <section class="card">
      <div class="hd"><strong>Gelişmiş Arama / Drilldown</strong></div>
      <div class="bd">
        <div class="row cols-3">
          <div><label>Terim</label><input id="qSearch" placeholder="Personel/ID, Bağışçı, Kategori parçası..."/></div>
          <div><label>Başlangıç</label><input type="date" id="qStart"/></div>
          <div><label>Bitiş</label><input type="date" id="qEnd"/></div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;margin-top:8px">
          <button class="btn" id="btnAra">Ara</button>
          <span class="badge" id="lblArama">—</span>
        </div>
        <div id="drill" class="hint" style="margin-top:10px">Sonuçlar burada listelenir.</div>
      </div>
    </section>
  </main>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="..//js/firebase/firebase-init.js"></script>

  <script>
    /* =====================  JS ===================== */
    const auth = firebase.auth(); const db = window.db;
    const $ = (id)=>document.getElementById(id);
    const fmt = n => (n==null||isNaN(n)) ? '₺0' : '₺' + Number(n).toLocaleString('tr-TR',{maximumFractionDigits:2});
    const toDateInput = d => new Date(d).toISOString().slice(0,10);

    // ---- Çoklu yıl seçici ----
    const yearChips = $('yearChips'), yearDrop = $('yearDrop'), yearInput = $('yearInput');
    const yearSet = new Set();
    function renderYears(){
      // chips
      [...yearChips.querySelectorAll('.chip')].forEach(c=>c.remove());
      [...yearSet].sort().forEach(y=>{
        const d=document.createElement('div'); d.className='chip'; d.innerHTML=`${y} <button aria-label="Sil" data-y="${y}">×</button>`;
        yearChips.insertBefore(d, yearInput);
      });
      // dropdown öneri
      const now=new Date().getFullYear();
      const opts=[now-2,now-1,now,now+1,now+2].filter(y=>!yearSet.has(y));
      yearDrop.innerHTML = opts.map(y=>`<label><input type="checkbox" data-y="${y}"/>${y}</label>`).join('');
    }
    yearChips.addEventListener('click', (e)=>{
      if(e.target.tagName==='BUTTON'){ yearSet.delete(Number(e.target.dataset.y)); renderYears(); }
    });
    yearInput.addEventListener('focus', ()=>{yearDrop.style.display='block'; renderYears();});
    document.addEventListener('click', (e)=>{ if(!yearChips.contains(e.target)) yearDrop.style.display='none'; });
    yearDrop.addEventListener('change', (e)=>{
      const y=Number(e.target.dataset.y); if(e.target.checked){ yearSet.add(y);} else {yearSet.delete(y);}
      renderYears();
    });
    yearInput.addEventListener('keydown',(e)=>{
      if(e.key==='Enter'){ e.preventDefault(); const v=Number(yearInput.value.trim()); if(v>1900){yearSet.add(v); renderYears(); yearInput.value='';}}
    });

    // Grafik nesneleri
    const chMonthly = new ApexCharts(document.querySelector("#chMonthly"), {
      chart:{type:'bar',height:320,toolbar:{show:false}},
      series:[{name:'Gelir',data:Array(12).fill(0)},{name:'Gider',data:Array(12).fill(0)}],
      xaxis:{categories:['Oca','Şub','Mar','Nis','May','Haz','Tem','Ağu','Eyl','Eki','Kas','Ara']},
      dataLabels:{enabled:false}, stroke:{width:2}
    }); chMonthly.render();

    const chGaugeG = new ApexCharts(document.querySelector("#chGaugeG"), {
      chart:{type:'radialBar',height:320}, series:[0],
      plotOptions:{radialBar:{hollow:{size:'58%'},dataLabels:{value:{formatter:(v)=>v.toFixed(0)+'%'}}}}
    }); chGaugeG.render();
    const chGaugeK = new ApexCharts(document.querySelector("#chGaugeK"), {
      chart:{type:'radialBar',height:320}, series:[0],
      plotOptions:{radialBar:{hollow:{size:'58%'},dataLabels:{value:{formatter:(v)=>v.toFixed(0)+'%'}}}}
    }); chGaugeK.render();

    const chDonut = new ApexCharts(document.querySelector("#chDonut"), {
      chart:{type:'donut',height:360}, series:[], labels:[], dataLabels:{enabled:true},
      legend:{position:'bottom'}
    }); chDonut.render();

    // Auth + log
    auth.onAuthStateChanged(async (u)=>{
      if(!u){ location.href='../index.html'; return; }
      await db.collection('sayfa_loglari').add({sayfa:'aylik-performans', uid:u.uid, zaman:new Date(), ua:navigator.userAgent});
      initPage();
    });
    document.getElementById('btnLogout').onclick = ()=> auth.signOut();

    $('btnUygula').onclick = applyFilters;
    $('btnClear').onclick = ()=>{
      $('fPath').value=''; $('fPer').value=''; $('fIncludeAccrual').checked=false;
      $('fStart').value=''; $('fEnd').value='';
      yearSet.clear(); renderYears(); applyFilters();
    };

    // --- Kategorileri datalist'e yükle ---
    async function loadKategoriler(){
      const dl=$('katList'); dl.innerHTML='';
      const snap=await db.collection('kategoriler').orderBy('path').get();
      snap.forEach(doc=>{const d=doc.data(); const o=document.createElement('option'); o.value=d.path; dl.appendChild(o);});
    }

    // --- Bütçe çek ---
    async function getBudget(yil, path, tip){
      const doc = await db.collection('butce_planlari').doc(String(yil)).get();
      if(!doc.exists) return null;
      const d=doc.data();
      if(Array.isArray(d.kalemler)){
        if(path){
          const list = d.kalemler.filter(k=>k.tip===tip && String(k.path).startsWith(path));
          if(!list.length) return null;
          return {hedef_tutar: list.reduce((a,b)=>a+(b.hedef_tutar||0),0), paths:list.map(k=>k.path)};
        }else{
          const toplam = d.kalemler.filter(k=>k.tip===tip).reduce((a,b)=>a+(b.hedef_tutar||0),0);
          return {path:'*', tip, hedef_tutar:toplam};
        }
      }
      return null;
    }

    // --- Veri derleme ---
    async function fetchYearData(yil, per, path, includeAcc, start, end){
      let ayGelir=Array(12).fill(0), ayGider=Array(12).fill(0);
      let sumGelir=0, sumGider=0, accrualOpen=0;
      const perSum={}; // personel toplam gelir (seçili filtre)
      const pathFilter = p => path ? String(p||'').startsWith(path) : true;
      const perFilter  = p => per  ? String(p||'').toLowerCase().includes(per.toLowerCase()) : true;
      // Sorgu: yil & opsiyonel tarih aralığı
      let ref = db.collection('islemler').where('yil','==',yil);
      if(start) ref = ref.where('gun','>=',start);
      if(end)   ref = ref.where('gun','<=',end);
      const s = await ref.get();
      s.forEach(doc=>{
        const d=doc.data(); if(!pathFilter(d.kategori_path)||!perFilter(d.personel_id)) return;
        const a=(d.ay||1)-1; const include = !d.tahakkuk || includeAcc===true;
        if(include){
          if(d.tip==='gelir'){ ayGelir[a]+=d.tutar||0; sumGelir+=d.tutar||0; perSum[d.personel_id||'—']=(perSum[d.personel_id||'—']||0)+(d.tutar||0); }
          else if(d.tip==='gider'){ ayGider[a]+=d.tutar||0; sumGider+=d.tutar||0; }
        }
        if(d.tahakkuk && d.durum==='acik'){ accrualOpen += Math.max(0,(d.kalan_tutar ?? (d.tutar||0)-(d.tahsilat_toplam||0))); }
      });
      return {ayGelir, ayGider, sumGelir, sumGider, accrualOpen, perSum};
    }

    // --- Personel hedef payı (ilgili yıl & path için) ---
    async function getPersonelTargets(yil, tip, path){
      const col = db.collection('butce_planlari').doc(String(yil)).collection('personel_pay');
      const q = await col.where('tip','==',tip).get();
      const m = {};
      q.forEach(doc=>{
        const d=doc.data();
        if(!path || String(d.path).startsWith(path)){
          m[d.personel_id] = (m[d.personel_id]||0) + (d.miktar||0);
        }
      });
      return m; // personel_id -> hedef miktar
    }

    function ratio(a,b){ if(!b || b<=0) return 0; return (a/b)*100; }

    // --- Yorum motoru (metin oluşturur) ---
    function yorumUret(params){
      const {yil, yilOnceki, sumGelir, sumGelirCmp, butceG, hedefGunluk, kalanGun, path, perRows} = params;
      const c=[];
      if(sumGelirCmp!=null){
        const diff=sumGelir - sumGelirCmp;
        c.push(`${yilOnceki}→${yil} gelir değişimi: ${diff>=0?'+':''}${fmt(diff)} (${ratio(sumGelir, (sumGelirCmp||1))*100/100|0}%* yaklaşık).`);
      }
      if(butceG && butceG.hedef_tutar>0){
        const kalan=Math.max(0,butceG.hedef_tutar - sumGelir);
        if(kalan>0 && kalanGun>0){
          c.push(`Bütçe hedefi için kalan ${fmt(kalan)}. Kalan gün: ${kalanGun}, günlük gerekli ortalama ~${fmt(hedefGunluk)}.`);
        }else if(kalan===0){
          c.push(`Tebrikler! ${yil} gelir bütçe hedefi tamamlandı.`);
        }else if(kalan<0){
          c.push(`Gelir bütçe hedefi ${fmt(-kalan)} fazla gerçekleşti.`);
        }
      }
      // Personel kısa özet
      if(perRows && perRows.length){
        const geride = perRows.filter(r=>r.hedefYuzde<80).slice(0,3).map(r=>r.ad).join(', ');
        if(geride) c.push(`Hedefte geride görünen ilk isimler: ${geride}.`);
      }
      if(path) c.push(`Kategori filtresi: “${path}”.`);
      return c.map(s=>`• ${s}`).join('<br/>');
    }

    // --- Personel adları (görsel isim için) ---
    async function mapPersonelAd(){
      const snap=await db.collection('personeller').get();
      const map={};
      snap.forEach(d=>{ const x=d.data(); if(x.personel_id) map[x.personel_id]=x.ad||x.personel_id; });
      return map;
    }

    async function applyFilters(){
      const years=[...yearSet].sort(); const hedefYil=years[0] || new Date().getFullYear();
      const cmpYillar=years.slice(1);
      const per=$('fPer').value.trim(), path=$('fPath').value.trim(), includeAcc=$('fIncludeAccrual').checked;
      const start=$('fStart').value||null, end=$('fEnd').value||null;

      $('lblYil').textContent = `${hedefYil}${path? ' • '+path:''}${start?' • '+start:''}${end?'→'+end:''}`;
      $('lblSecim').textContent = years.length? `Yıllar: ${years.join(', ')}` : 'Yıl seçilmedi';
      $('lblPer').textContent = `${hedefYil} & karşılaştırmalar`;
      $('lblDonut').textContent = path? path : 'Tüm gelir';
      $('lblGiderTree').textContent = `${hedefYil} gider kırılımı`;

      // hedef yıl verileri
      const {ayGelir, ayGider, sumGelir, sumGider, accrualOpen, perSum} =
        await fetchYearData(hedefYil, per, path, includeAcc, start, end);

      // KPI
      $('kGelir').textContent = fmt(sumGelir);
      $('kGider').textContent = fmt(sumGider);
      $('kAccrual').textContent = fmt(accrualOpen);
      $('kAccrualInfo').textContent = includeAcc ? 'Tahakkuklar dahil' : 'Sadece nakit';

      // Karşılaştırma toplamı (ilk karşı yıl)
      let sumGelirCmp=null;
      if(cmpYillar.length){
        const r = await fetchYearData(cmpYillar[0], per, path, includeAcc, start, end);
        sumGelirCmp = r.sumGelir;
        const diffG = sumGelir - r.sumGelir;
        $('kGelirDiff').textContent = `Karşı: ${cmpYillar[0]} fark ${diffG>=0?'+':''}${fmt(diffG)}`;
      } else {
        $('kGelirDiff').textContent = '—';
      }
      $('kGiderDiff').textContent = '—';

      // Bütçe ilerleme (Gelir/Gider)
      const now=new Date(); const endOfYear = end ? new Date(end) : new Date(`${hedefYil}-12-31`);
      const kalanGun = Math.max(1, Math.ceil((endOfYear - now)/86400000));
      const butceG = await getBudget(hedefYil, path||null, 'gelir');
      const butceK = await getBudget(hedefYil, path||null, 'gider');

      if(butceG && butceG.hedef_tutar>0){
        const ratioG = Math.min(100,(sumGelir/butceG.hedef_tutar)*100);
        chGaugeG.updateSeries([ratioG]);
        $('kButceGelir').textContent = `${ratioG.toFixed(0)}%`;
        const kalan = Math.max(0,butceG.hedef_tutar - sumGelir);
        const gunluk = kalanGun>0 ? kalan/kalanGun : kalan;
        $('kButceGelirNeed').textContent = `Kalan: ${fmt(kalan)} • Günlük gerek: ${fmt(gunluk)}`;
        $('lblButceG').textContent = `Hedef: ${fmt(butceG.hedef_tutar)}`;
      }else{
        chGaugeG.updateSeries([0]); $('kButceGelir').textContent = '0%'; $('kButceGelirNeed').textContent='Hedef yok'; $('lblButceG').textContent='—';
      }

      if(butceK && butceK.hedef_tutar>0){
        const ratioK = Math.min(100,(sumGider/butceK.hedef_tutar)*100);
        chGaugeK.updateSeries([ratioK]);
        $('kButceGider').textContent = `${ratioK.toFixed(0)}%`;
        const kalan = Math.max(0,butceK.hedef_tutar - sumGider);
        const gunluk = kalanGun>0 ? kalan/kalanGun : kalan;
        $('kButceGiderNeed').textContent = `Kalan: ${fmt(kalan)} • Günlük gerek: ${fmt(gunluk)}`;
        $('lblButceK').textContent = `Hedef: ${fmt(butceK.hedef_tutar)}`;
      }else{
        chGaugeK.updateSeries([0]); $('kButceGider').textContent='0%'; $('kButceGiderNeed').textContent='Hedef yok'; $('lblButceK').textContent='—';
      }

      // Aylık grafik
      chMonthly.updateSeries([{name:'Gelir',data:ayGelir},{name:'Gider',data:ayGider}]);

      // Personel matris: başlık = solda boş hücre + yıllar
      const perNameMap = await mapPersonelAd();
      const heads = ['<th class="sticky-col">Personel</th>']
        .concat([hedefYil, ...cmpYillar].map(y=>`<th>${y}</th>`));
      $('perHead').innerHTML = `<tr>${heads.join('')}</tr>`;

      // Tüm personel seti: hedef yıl + diğer yıllar
      const allKeys = new Set(Object.keys(perSum));
      const yearRows = {};
      for(const y of cmpYillar){
        const r = await fetchYearData(y, per, path, includeAcc, start, end);
        yearRows[y] = r.perSum;
        Object.keys(r.perSum).forEach(k=>allKeys.add(k));
      }

      // Personel hedefleri (hedef yıl ve kategori)
      const perTargets = await getPersonelTargets(hedefYil,'gelir',path||null);

      // Matris satırları
      const rows=[];
      [...allKeys].sort().forEach(pid=>{
        const ad = perNameMap[pid] || pid || '—';
        const me = perSum[pid]||0;
        const hedef = perTargets[pid] || 0;
        const butceToplam = butceG ? (butceG.hedef_tutar||0) : 0;
        const katkYuz = butceToplam>0 ? (me/butceToplam*100) : 0;
        const hedefYuz = hedef>0 ? (me/hedef*100) : 0;
        const trio = `<div><b>${fmt(me)}</b></div><div class="mini">Katkı: ${katkYuz.toFixed(1)}%</div><div class="mini">Hedef: <span class="${hedefYuz>=100?'ok':hedefYuz>=80?'warn':'bad'}">${hedefYuz.toFixed(1)}%</span></div>`;
        const tds=[`<td class="sticky-col">${ad}</td>`, `<td>${trio}</td>`];
        for(const y of cmpYillar){
          tds.push(`<td><b>${fmt((yearRows[y][pid]||0))}</b></td>`);
        }
        rows.push(`<tr>${tds.join('')}</tr>`);
      });
      $('perBody').innerHTML = rows.join('') || `<tr><td class="sticky-col">—</td><td>Veri yok</td></tr>`;

      // Donut: personel katkı dağılımı (hedef yıl, gelir)
      const donutLabels = [], donutSeries=[];
      let toplamKat=0;
      [...allKeys].forEach(pid=>{
        const me = perSum[pid]||0;
        if(me>0){ donutLabels.push(perNameMap[pid]||pid); donutSeries.push(me); toplamKat+=me; }
      });
      // kalan (hedef toplamına göre) boş alan gösterimi
      if(butceG && butceG.hedef_tutar>0){
        const kalan = Math.max(0,butceG.hedef_tutar - toplamKat);
        if(kalan>0){ donutLabels.push('Kalan'); donutSeries.push(kalan); }
      }
      chDonut.updateOptions({labels:donutLabels});
      chDonut.updateSeries(donutSeries);

      // Yorum oluştur
      const hedefGunluk = (butceG && butceG.hedef_tutar>0) ? Math.max(0,(butceG.hedef_tutar - sumGelir))/kalanGun : 0;
      const yorumHtml = yorumUret({
        yil:hedefYil, yilOnceki:cmpYillar[0], sumGelir, sumGelirCmp,
        butceG, hedefGunluk, kalanGun, path,
        perRows: [...allKeys].map(pid=>({ad: perNameMap[pid]||pid, hedefYuz: (perTargets[pid]||0)>0 ? ( (perSum[pid]||0)/(perTargets[pid]||1)*100 ) : 0}))
      });
      $('yorum').innerHTML = yorumHtml || '—';

      // Gider ağacı
      await renderGiderTree(hedefYil, path, includeAcc, start, end);
    }

    async function renderGiderTree(yil, basePath, includeAcc, start, end){
      const body=$('giderBody'); body.innerHTML='<tr><td colspan="2" class="muted">Yükleniyor...</td></tr>';
      // Tüm giderleri çek
      let ref = db.collection('islemler').where('yil','==',yil).where('tip','==','gider');
      if(start) ref=ref.where('gun','>=',start);
      if(end)   ref=ref.where('gun','<=',end);
      const snap = await ref.get();
      const sumByPath={};
      snap.forEach(doc=>{
        const d=doc.data(); if(basePath && !String(d.kategori_path||'').startsWith(basePath)) return;
        if(d.tahakkuk && !includeAcc) return; // nakit görünümü
        const p = String(d.kategori_path||'—');
        sumByPath[p] = (sumByPath[p]||0) + (d.tutar||0);
      });
      // Ağaç oluştur (lvl0>lvl1>lvl2)
      const tree={};
      Object.keys(sumByPath).forEach(p=>{
        const segs=p.split('>');
        segs.forEach((_,i)=>{
          const key=segs.slice(0,i+1).join('>');
          tree[key]= (tree[key]||0) + sumByPath[p];
        });
      });
      // üst düzeyleri sırala
      const keys=Object.keys(tree).sort();
      if(!keys.length){ body.innerHTML='<tr><td colspan="2" class="muted">Kayıt bulunamadı</td></tr>'; return; }

      function rowHtml(p){
        const lvl=p.split('>').length-1;
        const cls = 'lvl'+lvl;
        const caret = keys.some(k=>k.startsWith(p+'>')) ? '<span class="caret">▶</span>' : '';
        return `<tr class="tree-row ${cls}" data-path="${p}"><td>${caret} ${lvl===0?'<b>'+p+'</b>':p.split('>').pop()}</td><td><b>${fmt(tree[p])}</b></td></tr>`;
      }
      // sadece üst seviyeleri başta koy
      const roots = keys.filter(k=>k.indexOf('>')===-1);
      body.innerHTML = roots.map(rowHtml).join('');

      // tıklayınca çocukları aç/kapat
      body.addEventListener('click',(e)=>{
        const tr = e.target.closest('.tree-row'); if(!tr) return;
        const p = tr.dataset.path; const isOpen = tr.classList.contains('expanded');
        if(isOpen){
          // kapat: p ile başlayan ve daha derin olanları kaldır
          [...body.querySelectorAll(`.tree-row`)].forEach(r=>{
            if(r.dataset.path!==p && r.dataset.path.startsWith(p+'>')) r.remove();
          });
          tr.classList.remove('expanded');
        }else{
          // aç: bir üst seviye altlarını ekle
          const lvl = p.split('>').length-1;
          const children = keys.filter(k=> k.startsWith(p+'>') && k.split('>').length===lvl+2);
          let html=''; children.forEach(c=>{ html+=rowHtml(c); });
          tr.insertAdjacentHTML('afterend', html || `<tr class="tree-row lvl${lvl+1}"><td>—</td><td>—</td></tr>`);
          tr.classList.add('expanded');
        }
      }, {once:true}); // ilk kurulumda tek kez bağla
    }

    // Gelişmiş arama
    $('btnAra').onclick = async ()=>{
      const q=$('qSearch').value.trim().toLowerCase();
      const s=$('qStart').value||null, e=$('qEnd').value||null;
      let ref=db.collection('islemler').orderBy('tarih','desc').limit(800);
      if(s) ref=ref.where('gun','>=',s);
      if(e) ref=ref.where('gun','<=',e);
      const snap=await ref.get(); const out=[];
      snap.forEach(doc=>{
        const d=doc.data();
        const hay=[d.personel_id,d.bagisci_vendor_id,d.kategori_path,d.aciklama].join(' ').toLowerCase();
        if(!q || hay.includes(q)){
          out.push(`${(d.gun||'').slice(0,10)} • ${d.tip} • ${d.kategori_path} • ${fmt(d.tutar)} • P:${d.personel_id||'-'} • BV:${d.bagisci_vendor_id||'-'}`);
        }
      });
      $('lblArama').textContent = `${out.length} kayıt`;
      $('drill').innerHTML = out.length? out.map(x=>`<div>${x}</div>`).join('') : 'Kayıt bulunamadı.';
    };

    // INIT
    async function initPage(){
      // default yıllar: (geçen yıl, bu yıl)
      const now=new Date().getFullYear(); yearSet.add(now); yearSet.add(now-1); renderYears();
      // default tarih: yıl başından bugün
      $('fStart').value = `${now}-01-01`; $('fEnd').value = toDateInput(new Date());
      await loadKategoriler();
      await applyFilters();
    }
  </script>
</body>
</html>
