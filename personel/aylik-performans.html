<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8"/>
  <title>Aylık Performans | Analiz</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <link rel="icon" href="../img/logo.png"/>

  <style>
    /* =====================  AÇIK TEMA & RESPONSIVE  ===================== */
    :root{
      --bg:#f7fafc; --surface:#ffffff; --text:#0f172a; --muted:#475569; --stroke:#e2e8f0;
      --brand:#0ea5e9; --brand2:#6366f1; --radius:14px; --shadow:0 8px 24px rgba(2,6,23,.08);
      --ok:#16a34a; --bad:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Arial}
    .appbar{position:sticky;top:0;z-index:5;height:56px;background:#ffffffd9;border-bottom:1px solid var(--stroke);
      backdrop-filter:saturate(120%) blur(6px);display:flex;align-items:center;justify-content:space-between;padding:0 16px}
    .appbar h1{margin:0;font-size:18px;font-weight:700}
    .btn{appearance:none;border:1px solid var(--stroke);background:#fff;border-radius:12px;padding:9px 12px;cursor:pointer}
    .btn:hover{background:#f8fafc}
    .btn.acc{background:linear-gradient(90deg,var(--brand),var(--brand2));border:0;color:#fff;font-weight:700}
    .wrap{max-width:1240px;margin:18px auto;padding:0 16px;display:grid;gap:16px}
    .row{display:grid;gap:16px}
    @media(min-width:980px){.cols-3{grid-template-columns:1fr 1fr 1fr}.cols-2{grid-template-columns:1.2fr 1fr}}
    .card{background:var(--surface);border:1px solid var(--stroke);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card .hd{padding:14px 16px;border-bottom:1px solid var(--stroke);display:flex;align-items:center;justify-content:space-between}
    .card .bd{padding:16px}
    .kpis{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    @media(max-width:900px){.kpis{grid-template-columns:repeat(2,1fr)}}
    .kpi{background:#fff;border:1px solid var(--stroke);border-radius:12px;padding:12px}
    .kpi .lbl{font-size:12px;color:var(--muted)}
    .kpi .val{font-weight:800;font-size:20px}
    .kpi .diff{font-size:12px;color:var(--muted)}
    .badge{font-size:11px;border:1px solid var(--stroke);padding:4px 6px;border-radius:8px;color:var(--muted)}
    #charts{display:grid;gap:16px}
    @media(min-width:980px){#charts{grid-template-columns:1.2fr 1fr}}
    input,select{width:100%;padding:9px;border-radius:10px;border:1px solid var(--stroke);background:#fff;color:var(--text)}
    label{font-size:12px;color:var(--muted)}
  </style>

  <!-- ApexCharts -->
  <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
</head>
<body>
  <header class="appbar">
    <h1>📈 Aylık Performans & Analiz</h1>
    <div style="display:flex;gap:8px">
      <button class="btn" onclick="history.back()">Geri Dön</button>
      <button class="btn acc" id="btnLogout">Çıkış</button>
    </div>
  </header>

  <main class="wrap">
    <!-- Filtreler -->
    <section class="card">
      <div class="hd"><strong>Filtreler</strong></div>
      <div class="bd">
        <div class="row cols-3">
          <div><label>Yıl</label><select id="fYil"></select></div>
<div class="row cols-3" style="margin-top:8px">
  <div><label>Kategori (üst/alt)</label>
    <select id="fKatUst"></select>
    <select id="fKatAlt" style="margin-top:6px"><option value="">(Alt kategori yok)</option></select>
  </div>
  <div>
    <label>Karşılaştırma Yılları (çoklu)</label>
    <select id="fYillarCmp" multiple size="4"></select>
    <div class="badge">Ctrl/Cmd ile çoklu seç</div>
  </div>
  <div>
    <label>Zaman Çözünürlüğü</label>
    <select id="fGran"><option value="ay">Ay</option><option value="hafta">Hafta</option><option value="gun">Gün</option><option value="yil">Yıl</option></select>
  </div>
</div>
          <div><label>Personel (ops.)</label><input id="fPer" placeholder="ID veya ad-soyad"/></div>
        </div>
        <div class="row cols-3" style="margin-top:8px">
          <div><label>Kategori (path başı)</label><input id="fPath" placeholder="Örn: Kurban veya Ramazan>İftar"/></div>
          <div style="display:flex;align-items:end;gap:8px">
            <input type="checkbox" id="fIncludeAccrual"/><label for="fIncludeAccrual" style="margin:0">Tahakkukları da dahil et</label>
          </div>
          <div style="display:flex;justify-content:end;align-items:end"><button class="btn acc" id="btnUygula">Uygula</button></div>
        </div>
      </div>
    </section>

    <!-- KPI Kartları -->
    <section class="kpis" aria-label="KPI">
      <div class="kpi"><div class="lbl">Toplam Gelir (cash)</div><div class="val" id="kGelir">₺0</div><div class="diff" id="kGelirDiff">—</div></div>
      <div class="kpi"><div class="lbl">Toplam Gider (cash)</div><div class="val" id="kGider">₺0</div><div class="diff" id="kGiderDiff">—</div></div>
      <div class="kpi"><div class="lbl">Açık Tahakkuk</div><div class="val" id="kAccrual">₺0</div><div class="diff" id="kAccrualInfo">—</div></div>
      <div class="kpi"><div class="lbl">Bütçe Ulaşım (Gelir)</div><div class="val" id="kButceGelir">0%</div><div class="diff" id="kButceGelirNeed">—</div></div>
      <div class="kpi"><div class="lbl">Bütçe Ulaşım (Gider)</div><div class="val" id="kButceGider">0%</div><div class="diff" id="kButceGiderNeed">—</div></div>
    </section>

    <!-- Grafikler -->
      <section id="charts" style="display:grid;gap:16px;grid-template-columns:1fr 1fr 1fr">
      <article class="card">
        <div class="hd"><strong>Aylık Gelir vs Gider</strong><span class="badge" id="lblYil">—</span></div>
        <div class="bd"><div id="chMonthly" style="height:320px"></div></div>
      </article>
      <article class="card">
        <div class="hd"><strong>Bütçe İlerleme (Gelir)</strong><span class="badge" id="lblButce">—</span></div>
        <div class="bd"><div id="chGauge" style="height:320px"></div></div>
      </article>
        <article class="card">
    <div class="hd"><strong>Bütçe İlerleme (Gider)</strong><span class="badge" id="lblButceGider">—</span></div>
    <div class="bd"><div id="chGaugeGider" style="height:320px"></div></div>
  </article>
    </section>

    <section class="card">
      <div class="hd"><strong>Personel Kıyas (Gelir – seçilen yıllar)</strong></div>
      <div class="bd"><div id="chPersonel" style="height:360px"></div></div>
      <div class="bd">
  <div id="chPersonel" style="height:360px"></div>
  <div style="overflow:auto;margin-top:10px">
    <table id="tblPer" style="width:100%;border-collapse:collapse">
      <thead><tr><th>Personel</th><th id="thCmpYil">Önceki Yıl Miktar</th><th id="thThisYil">Seçili Yıl</th><th>Katkı % (Bütçe)</th><th>Hedef Ulaşım %</th><th>∆ vs Önceki</th><th>Yorum</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>
</div>
    </section>

<section class="card">
  <div class="hd"><strong>Personel Katkı Dağılımı (Gelir)</strong></div>
  <div class="bd">
    <div id="chDonut" style="height:340px"></div>
    <div id="donutNote" class="badge" style="margin-top:8px">Seçili kategori bütçesine göre doluluk</div>
  </div>
</section>
    
<section class="card">
  <div class="hd"><strong>Gider Kalemleri (Üst/Alt)</strong></div>
  <div class="bd">
    <div id="chGiderKat" style="height:360px"></div>
    <div id="giderDetay" class="badge" style="margin-top:10px">Bir üst kaleme tıklayın</div>
  </div>
</section>

    <section class="card">
      <div class="hd"><strong>Arama / Drilldown</strong></div>
      <div class="bd">
        <div class="row cols-3">
          <div><label>İsim/ID (Bağışçı & Tedarikçi & Personel)</label><input id="qSearch" placeholder="örn. Muhsin veya B123"/></div>
          <div style="display:flex;align-items:end"><button class="btn" id="btnAra">Ara</button></div>
        </div>
        <div id="drill" class="badge" style="display:block;margin-top:10px">Sonuçlar burada listelenir.</div>
      </div>
    </section>
  </main>

  <!-- Firebase -->
  <!-- Firebase -->
      <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
      <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
      <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
      <script src="../js/firebase/firebase-init.js"></script>
        <script>
    /* =====================  ANALİZ JS  ===================== */
    const auth = firebase.auth(); const db = window.db;
    const fmt = n => (n==null||isNaN(n)) ? '₺0' : '₺' + Number(n).toLocaleString('tr-TR',{maximumFractionDigits:2});

    // Yıl seçimlerini doldur
(function fillYearsMulti(){
  const now=new Date().getFullYear();
  const ySel=document.getElementById('fYil'), cmp=document.getElementById('fYillarCmp');
  [now-3,now-2,now-1,now,now+1].forEach(y=>{
    const o1=document.createElement('option'); o1.value=y; o1.textContent=y; ySel.appendChild(o1);
    const o2=document.createElement('option'); o2.value=y; o2.textContent=y; cmp.appendChild(o2);
  });
  ySel.value=now;
})();
async function fillKategoriler(){
  const ust=$('fKatUst'), alt=$('fKatAlt'); ust.innerHTML=''; alt.innerHTML='<option value="">(Alt kategori yok)</option>';
  const q=await db.collection('kategoriler').orderBy('path').get();
  const topSet=new Set(q.docs.map(d=> (d.data().path||'').split('>')[0]));
  [...topSet].forEach(p=>{const o=document.createElement('option'); o.value=p; o.textContent=p; $('fKatUst').appendChild(o);});
  ust.addEventListener('change', ()=>{
    const base=ust.value; alt.innerHTML='<option value="">(Alt kategori yok)</option>';
    q.forEach(doc=>{
      const p=doc.data().path||''; if(p.startsWith(base+'>')){
        const name=p.split('>')[1]; if(name){ const o=document.createElement('option'); o.value=p; o.textContent=name; alt.appendChild(o); }
      }
    });
  });
}
fillKategoriler();

    // Grafik nesneleri
    const chMonthly = new ApexCharts(document.querySelector("#chMonthly"), {
      chart:{type:'bar',height:320,toolbar:{show:false}},
      series:[{name:'Gelir',data:Array(12).fill(0)},{name:'Gider',data:Array(12).fill(0)}],
      xaxis:{categories:['Oca','Şub','Mar','Nis','May','Haz','Tem','Ağu','Eyl','Eki','Kas','Ara']},
      dataLabels:{enabled:false}, stroke:{width:2}
    }); chMonthly.render();

    const chGauge = new ApexCharts(document.querySelector("#chGauge"), {
      chart:{type:'radialBar',height:320}, series:[0],
      plotOptions:{radialBar:{hollow:{size:'58%'},dataLabels:{value:{formatter:(v)=>v.toFixed(0)+'%'}}}}
    }); chGauge.render();

    const chPersonel = new ApexCharts(document.querySelector("#chPersonel"), {
      chart:{type:'bar',height:360,toolbar:{show:false}},
      series:[{name:'Seçili Yıl',data:[]},{name:'Karş. Yıl',data:[]}],
      xaxis:{categories:[]}, dataLabels:{enabled:false}
    }); chPersonel.render();

    // Auth + log
    auth.onAuthStateChanged(async (u)=>{
      if(!u){ location.href='../index.html'; return; }
      await db.collection('sayfa_loglari').add({sayfa:'aylik-performans', uid:u.uid, zaman:new Date(), ua:navigator.userAgent});
      applyFilters();
    });
    document.getElementById('btnLogout').onclick = ()=> auth.signOut();
    document.getElementById('btnUygula').onclick = applyFilters;

async function applyFilters(){
  const yil=Number($('fYil').value);
  const cmpYears=[...$('fYillarCmp').selectedOptions].map(o=>Number(o.value));
  const per=$('fPer').value.trim();
  const gran=$('fGran').value; // 'ay'|'hafta'|'gun'|'yil'

  // kategori path: üst + (opsiyonel) alt
  const katUst=$('fKatUst').value||'';
  const katAltFull=$('fKatAlt').value||'';
  const path = katAltFull || (katUst? katUst : '');

  // Ana yıl
  const base = await fetchAggregates({yil, per, path, includeAcc: $('fIncludeAccrual').checked, gran});
  // Çoklu yıllar
  const cmpData = {};
  for(const y of cmpYears){ cmpData[y]= await fetchAggregates({yil:y, per, path, includeAcc: $('fIncludeAccrual').checked, gran}); }

  // KPI (gelir/gider)
  $('kGelir').textContent=fmt(base.sumGelir);
  $('kGider').textContent=fmt(base.sumGider);
  $('kAccrual').textContent=fmt(base.accrualOpen);
  $('kAccrualInfo').textContent = $('fIncludeAccrual').checked ? 'Dahil ediliyor' : 'Dahil edilmiyor';

  // Bütçe: GELİR
  const bGelir = await getBudget(yil, path||null, 'gelir');
  let ratioG=0, needTextG='—';
  if(bGelir && bGelir.hedef_tutar>0){
    ratioG = Math.min(100, (base.sumGelir/bGelir.hedef_tutar)*100);
    const {leftDays,kalan} = kalanGunVeTutar(bGelir.hedef_tutar, base.sumGelir, yil, path);
    needTextG = `Kalan: ${fmt(kalan)} • Günlük gerek: ${fmt(kalan/Math.max(1,leftDays))} (${leftDays}gün)`;
    $('lblButce').textContent = `Hedef: ${fmt(bGelir.hedef_tutar)}`;
  } else { $('lblButce').textContent='Hedef yok'; }
  chGauge.updateSeries([ratioG]); $('kButceGelir').textContent=`${ratioG.toFixed(0)}%`; $('kButceGelirNeed').textContent=needTextG;

  // Bütçe: GİDER
  const bGider = await getBudget(yil, path||null, 'gider');
  let ratioK=0, needTextK='—';
  if(bGider && bGider.hedef_tutar>0){
    ratioK = Math.min(100, (base.sumGider/bGider.hedef_tutar)*100);
    const {leftDays,kalan} = kalanGunVeTutar(bGider.hedef_tutar, base.sumGider, yil, path);
    needTextK = `Kalan: ${fmt(kalan)} • Günlük üst limit: ${fmt(kalan/Math.max(1,leftDays))}`;
    $('lblButceGider').textContent = `Hedef: ${fmt(bGider.hedef_tutar)}`;
  } else { $('lblButceGider').textContent='Hedef yok'; }
  chGaugeGider.updateSeries([ratioK]); $('kButceGider').textContent=`${ratioK.toFixed(0)}%`; $('kButceGiderNeed').textContent=needTextK;

  // Aylık/haftalık/günlük seri (ana yıl)
  chMonthly.updateSeries([{name:'Gelir',data:base.seriesGelir},{name:'Gider',data:base.seriesGider}]);
  $('lblYil').textContent = `${yil}${path? ' • '+path : ''}`;

  // Personel kıyas (ana yıl vs ilk karşılaştırma yılı)
  const yilCmp = cmpYears[0] ?? (yil-1);
  const pNow = base.perSum;
  const pCmp = (cmpData[yilCmp]?.perSum) || {};
  updatePersonelBlock({yil, yilCmp, pNow, pCmp, bGelirPath: bGelir});

  // Personel katkı donut (gelir)
  renderDonut(base.personelShares, bGelir?.hedef_tutar || null);

  // Gider kalemleri grafiği (üst/alt toplanmış)
  renderGiderKategoriChart(base.kategoriGiderTree);
}
function kalanGunVeTutar(hedef, gercek, yil, path){
  const now=new Date(); const end = new Date(`${yil}-12-31`);
  // İleri aşamada Ramazan özel bitişi için path’e göre tarih set edebilirsin
  const leftDays = Math.max(0, Math.floor((end - now)/86400000));
  const kalan = Math.max(0, hedef - gercek);
  return {leftDays, kalan};
}

const chDonut = new ApexCharts(document.querySelector('#chDonut'), {
  chart:{type:'donut',height:340}, series:[], labels:[]
}); chDonut.render();

function renderDonut(personelShares, hedef){
  const labels=Object.keys(personelShares);
  const vals=Object.values(personelShares);
  let toplam=vals.reduce((a,b)=>a+b,0);
  const series=[...vals];
  if(hedef && hedef>toplam){
    labels.push('Kalan'); series.push(hedef-toplam);
  }
  chDonut.updateOptions({labels});
  chDonut.updateSeries(series);
  $('donutNote').textContent = hedef ? `Toplam ${fmt(toplam)} / Hedef ${fmt(hedef)}` : `Hedef tanımlı değil`;
}

const chGiderKat = new ApexCharts(document.querySelector('#chGiderKat'), {
  chart:{type:'bar',height:360,events:{
    dataPointSelection: (e, ctx, config)=>{
      const name = config.w.config.xaxis.categories[config.dataPointIndex];
      const tree = window._lastGiderTree||{};
      const node = tree[name]||{};
      const alts = Object.keys(node).filter(k=>k!=='_sum');
      $('giderDetay').innerHTML = alts.length? alts.map(a=>`${a}: ${fmt(node[a])}`).join(' • ') : 'Alt kategori yok';
    }
  }},
  series:[{name:'Gider',data:[]}],
  xaxis:{categories:[]}, dataLabels:{enabled:false}
}); chGiderKat.render();

function renderGiderKategoriChart(tree){
  window._lastGiderTree = tree;
  const cats = Object.keys(tree);
  const vals = cats.map(k=> tree[k]._sum || 0);
  chGiderKat.updateOptions({xaxis:{categories:cats}});
  chGiderKat.updateSeries([{name:'Gider',data:vals}]);
}

async function getBudget(yil, path, tip){
  const doc = await db.collection('butce_planlari').doc(String(yil)).get();
  if(!doc.exists) return null;
  const d=doc.data();
  if(Array.isArray(d.kalemler)){
    if(path){
      return d.kalemler.find(k=>k.tip===tip && String(k.path).startsWith(path)) || null;
    }else{
      const toplam = d.kalemler.filter(k=>k.tip===tip).reduce((a,b)=>a+(b.hedef_tutar||0),0);
      return {path:'*', tip, hedef_tutar:toplam};
    }
  }
  return null;
}

async function applyFilters(){
  const yil=Number($('fYil').value);
  const cmpYears=[...$('fYillarCmp').selectedOptions].map(o=>Number(o.value));
  const per=$('fPer').value.trim();
  const gran=$('fGran').value; // 'ay'|'hafta'|'gun'|'yil'

  // kategori path: üst + (opsiyonel) alt
  const katUst=$('fKatUst').value||'';
  const katAltFull=$('fKatAlt').value||'';
  const path = katAltFull || (katUst? katUst : '');

  // Ana yıl
  const base = await fetchAggregates({yil, per, path, includeAcc: $('fIncludeAccrual').checked, gran});
  // Çoklu yıllar
  const cmpData = {};
  for(const y of cmpYears){ cmpData[y]= await fetchAggregates({yil:y, per, path, includeAcc: $('fIncludeAccrual').checked, gran}); }

  // KPI (gelir/gider)
  $('kGelir').textContent=fmt(base.sumGelir);
  $('kGider').textContent=fmt(base.sumGider);
  $('kAccrual').textContent=fmt(base.accrualOpen);
  $('kAccrualInfo').textContent = $('fIncludeAccrual').checked ? 'Dahil ediliyor' : 'Dahil edilmiyor';

  // Bütçe: GELİR
  const bGelir = await getBudget(yil, path||null, 'gelir');
  let ratioG=0, needTextG='—';
  if(bGelir && bGelir.hedef_tutar>0){
    ratioG = Math.min(100, (base.sumGelir/bGelir.hedef_tutar)*100);
    const {leftDays,kalan} = kalanGunVeTutar(bGelir.hedef_tutar, base.sumGelir, yil, path);
    needTextG = `Kalan: ${fmt(kalan)} • Günlük gerek: ${fmt(kalan/Math.max(1,leftDays))} (${leftDays}gün)`;
    $('lblButce').textContent = `Hedef: ${fmt(bGelir.hedef_tutar)}`;
  } else { $('lblButce').textContent='Hedef yok'; }
  chGauge.updateSeries([ratioG]); $('kButceGelir').textContent=`${ratioG.toFixed(0)}%`; $('kButceGelirNeed').textContent=needTextG;

  // Bütçe: GİDER
  const bGider = await getBudget(yil, path||null, 'gider');
  let ratioK=0, needTextK='—';
  if(bGider && bGider.hedef_tutar>0){
    ratioK = Math.min(100, (base.sumGider/bGider.hedef_tutar)*100);
    const {leftDays,kalan} = kalanGunVeTutar(bGider.hedef_tutar, base.sumGider, yil, path);
    needTextK = `Kalan: ${fmt(kalan)} • Günlük üst limit: ${fmt(kalan/Math.max(1,leftDays))}`;
    $('lblButceGider').textContent = `Hedef: ${fmt(bGider.hedef_tutar)}`;
  } else { $('lblButceGider').textContent='Hedef yok'; }
  chGaugeGider.updateSeries([ratioK]); $('kButceGider').textContent=`${ratioK.toFixed(0)}%`; $('kButceGiderNeed').textContent=needTextK;

  // Aylık/haftalık/günlük seri (ana yıl)
  chMonthly.updateSeries([{name:'Gelir',data:base.seriesGelir},{name:'Gider',data:base.seriesGider}]);
  $('lblYil').textContent = `${yil}${path? ' • '+path : ''}`;

  // Personel kıyas (ana yıl vs ilk karşılaştırma yılı)
  const yilCmp = cmpYears[0] ?? (yil-1);
  const pNow = base.perSum;
  const pCmp = (cmpData[yilCmp]?.perSum) || {};
  updatePersonelBlock({yil, yilCmp, pNow, pCmp, bGelirPath: bGelir});

  // Personel katkı donut (gelir)
  renderDonut(base.personelShares, bGelir?.hedef_tutar || null);

  // Gider kalemleri grafiği (üst/alt toplanmış)
  renderGiderKategoriChart(base.kategoriGiderTree);
}
function kalanGunVeTutar(hedef, gercek, yil, path){
  const now=new Date(); const end = new Date(`${yil}-12-31`);
  // İleri aşamada Ramazan özel bitişi için path’e göre tarih set edebilirsin
  const leftDays = Math.max(0, Math.floor((end - now)/86400000));
  const kalan = Math.max(0, hedef - gercek);
  return {leftDays, kalan};
}
function updatePersonelBlock({yil, yilCmp, pNow, pCmp, bGelirPath}){
  $('thCmpYil').textContent = `${yilCmp} Miktar`;
  $('thThisYil').textContent = `${yil} Miktar`;
  const tb = $('tblPer').querySelector('tbody'); tb.innerHTML='';
  const toplamNow = Object.values(pNow).reduce((a,b)=>a+b,0) || 1;

  // seçili path’in bütçesi
  const hedefPromise = getBudget(yil, ($('fKatAlt').value || $('fKatUst').value || null), 'gelir');
  Promise.resolve(hedefPromise).then(b=>{
    const hedef = b?.hedef_tutar || null;
    Object.keys(pNow).sort((a,b)=>pNow[b]-pNow[a]).forEach(k=>{
      const now = pNow[k]||0, prev=pCmp[k]||0;
      const katki = hedef? (now/hedef*100): null;
      const hedefPct = (hedef? (now/hedef*100) : null);
      const delta = now - prev;
      const yorum = buildYorum({yil, yilCmp, now, prev, hedef, personel:k});
      tb.insertAdjacentHTML('beforeend', `<tr>
        <td>${k}</td>
        <td>${fmt(prev)}</td>
        <td>${fmt(now)}</td>
        <td>${katki!=null? katki.toFixed(1)+'%':'—'}</td>
        <td>${hedefPct!=null? hedefPct.toFixed(1)+'%':'—'}</td>
        <td>${(delta>=0?'+':'')+fmt(delta)}</td>
        <td>${yorum}</td>
      </tr>`);
    });
  });
}
function buildYorum({yil,yilCmp,now,prev,hedef,personel}){
  const parts=[];
  if(now>prev) parts.push('Geçen yıla göre artış var ✅');
  else if(now<prev) parts.push('Geçen yıla göre gerileme var ⚠️');
  else parts.push('Geçen yılla aynı seviyede');

  if(hedef!=null){
    if(now>=hedef) parts.push('Bu yıl hedefinize ulaştınız 🎯');
    else {
      const {leftDays,kalan} = kalanGunVeTutar(hedef, now, yil, null);
      if(leftDays>0) parts.push(`Hedefe kalan ${fmt(kalan)}. Günlük ~${fmt(kalan/Math.max(1,leftDays))} gerekli.`);
      else parts.push('Yıl bitti, hedefe ulaşılamadı.');
    }
  }
  return parts.join(' • ');
}
    // Seçili yıl için verileri topla
    async function fetchYearData(yil, yilCmp, per, path, includeAcc){
      let ayGelir=Array(12).fill(0), ayGider=Array(12).fill(0);
      let sumGelir=0, sumGider=0, accrualOpen=0;
      const perSumThis={}, perSumCmp={};

      const pathFilter = p => path ? String(p||'').startsWith(path) : true;
      const perFilter  = p => per  ? String(p||'').toLowerCase().includes(per.toLowerCase()) : true;

      // Seçili yıl
      const s1 = await db.collection('islemler').where('yil','==',yil).get();
      s1.forEach(doc=>{
        const d=doc.data(); if(!pathFilter(d.kategori_path)||!perFilter(d.personel_id)) return;
        const a=(d.ay||1)-1; const include = !d.tahakkuk || includeAcc===true;
        if(include){
          if(d.tip==='gelir'){ ayGelir[a]+=d.tutar||0; sumGelir+=d.tutar||0; }
          else if(d.tip==='gider'){ ayGider[a]+=d.tutar||0; sumGider+=d.tutar||0; }
        }
        if(d.tahakkuk && d.durum==='acik'){ accrualOpen += d.tutar||0; }
        if(d.tip==='gelir' && include){ const key=d.personel_id||'—'; perSumThis[key]=(perSumThis[key]||0)+(d.tutar||0); }
      });

      // Karşı yıl (sadece personel kıyas)
      const s2 = await db.collection('islemler').where('yil','==',yilCmp).get();
      s2.forEach(doc=>{
        const d=doc.data(); if(!pathFilter(d.kategori_path)||!perFilter(d.personel_id)) return;
        const include = !d.tahakkuk || includeAcc===true;
        if(d.tip==='gelir' && include){ const key=d.personel_id||'—'; perSumCmp[key]=(perSumCmp[key]||0)+(d.tutar||0); }
      });

      return {ayGelir, ayGider, sumGelir, sumGider, accrualOpen, perSumThis, perSumCmp};
    }

    // Bütçe çek (butce_planlari/{yil}.kalemler[])
    async function getBudget(yil, path, tip){
      const doc = await db.collection('butce_planlari').doc(String(yil)).get();
      if(!doc.exists) return null;
      const d=doc.data();
      if(Array.isArray(d.kalemler)){
        if(path){
          return d.kalemler.find(k=>k.tip==='gelir' && String(k.path).startsWith(path)) || null;
        }else{
          const toplam = d.kalemler.filter(k=>k.tip==='gelir').reduce((a,b)=>a+(b.hedef_tutar||0),0);
          return {path:'*', tip:'gelir', hedef_tutar:toplam};
        }
      }
      return null;
    }

    // Drilldown arama
    document.getElementById('btnAra').onclick = async ()=>{
      const q = document.getElementById('qSearch').value.trim();
      if(!q){ document.getElementById('drill').textContent='Arama giriniz.'; return; }
      const res=[]; const snap=await db.collection('islemler').orderBy('tarih','desc').limit(300).get();
      snap.forEach(doc=>{
        const d=doc.data();
        if(String(d.personel_id||'').toLowerCase().includes(q.toLowerCase())
           || String(d.bagisci_vendor_id||'').toLowerCase().includes(q.toLowerCase())){
          res.push(`${(d.gun||'').slice(0,10)} • ${d.tip} • ${d.kategori_path} • ${fmt(d.tutar)} • P:${d.personel_id||'-'} • BV:${d.bagisci_vendor_id||'-'}`);
        }
      });
      document.getElementById('drill').innerHTML = res.length? res.map(x=>`<div>${x}</div>`).join('') : 'Kayıt bulunamadı.';
    };
  </script>
</body>
</html>
