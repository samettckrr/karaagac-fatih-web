<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Hedef Grafik | Karaağaç Fatih</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" type="image/png" href="../../img/logo.png" />

  <style>
    :root{
      --appbar-h:56px; --radius:14px; --shadow:0 12px 28px rgba(0,0,0,.14);
      --bg:#0f172a; --bg2:#0b1324; --grad1:#0ea5e922; --grad2:#22d3ee22;
      --card:rgba(15,23,42,.92); --stroke:rgba(148,163,184,.18);
      --text:#e5e7eb; --muted:#9aa4b2; --brand:#38bdf8; --brand2:#0ea5e9;
      --pill:#0b1220; --pill-hover:#101a2b; --link:#c7e9ff; --surface:rgba(2,6,23,.08);
      --good:#22c55e; --warn:#f59e0b; --bad:#ef4444; --great:#16a34a;
      --kpi1:#0ea5e9; --kpi2:#22c55e; --kpi3:#f59e0b;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#eef6ff; --bg2:#f7fbff; --grad1:#38bdf822; --grad2:#22d3ee22;
        --card:rgba(255,255,255,.95); --stroke:rgba(15,23,42,.12);
        --text:#0b1220; --muted:#4b5563; --brand:#0ea5e9; --brand2:#0284c7;
        --pill:#f5f8ff; --pill-hover:#e9f2ff; --link:#0b5ea8; --surface:#eef3ff;
        --kpi1:#0284c7; --kpi2:#16a34a; --kpi3:#d97706;
      }
    }
    /* Tema toggle için gerekli override’lar (önce boş kalmıştı) */
    html[data-theme="dark"]{
      --bg:#0f172a; --bg2:#0b1324; --grad1:#0ea5e922; --grad2:#22d3ee22;
      --card:rgba(15,23,42,.92); --stroke:rgba(148,163,184,.18);
      --text:#e5e7eb; --muted:#9aa4b2; --brand:#38bdf8; --brand2:#0ea5e9;
      --pill:#0b1220; --pill-hover:#101a2b; --link:#c7e9ff; --surface:rgba(2,6,23,.08);
      --good:#22c55e; --warn:#f59e0b; --bad:#ef4444; --great:#16a34a;
      --kpi1:#38bdf8; --kpi2:#22c55e; --kpi3:#f59e0b;
    }
    html[data-theme="light"]{
      --bg:#eef6ff; --bg2:#f7fbff; --grad1:#38bdf822; --grad2:#22d3ee22;
      --card:rgba(255,255,255,.95); --stroke:rgba(15,23,42,.12);
      --text:#0b1220; --muted:#4b5563; --brand:#0ea5e9; --brand2:#0284c7;
      --pill:#f5f8ff; --pill-hover:#e9f2ff; --link:#0b5ea8; --surface:#eef3ff;
      --good:#16a34a; --warn:#d97706; --bad:#dc2626; --great:#15803d;
      --kpi1:#0284c7; --kpi2:#16a34a; --kpi3:#d97706;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      font-family:ui-sans-serif,-apple-system,"Segoe UI",Roboto,Arial;
      background:
        radial-gradient(900px 680px at 12% 8%, var(--grad1), transparent 45%),
        radial-gradient(800px 640px at 88% 92%, var(--grad2), transparent 50%),
        linear-gradient(140deg, var(--bg), var(--bg2) 60%);
      overflow-x:hidden; word-wrap:break-word;
    }
    a{color:var(--link); text-decoration:none}
    a:hover{text-decoration:underline}

    /* APPBAR */
    .appbar{
      position:sticky; top:0; z-index:60; height:var(--appbar-h);
      background:var(--card); backdrop-filter:blur(10px);
      border-bottom:1px solid var(--stroke);
      display:flex; align-items:center;
      padding:0 max(12px, env(safe-area-inset-right)) 0 max(12px, env(safe-area-inset-left));
    }
    .brand{display:flex; align-items:center; gap:10px; cursor:pointer}
    .brand img{width:24px; height:24px}
    .brand span{font-weight:900; letter-spacing:.02em}
    .nav-center{margin:0 auto; height:100%}
    .nav-list{display:flex; gap:22px; align-items:center; height:100%; list-style:none; margin:0; padding:0}
    .nav-item{position:relative; height:100%}
    .nav-btn{height:100%; display:flex; align-items:center; gap:6px; font-weight:600; cursor:pointer}
    .nav-btn:hover{color:var(--brand)}
    .caret{font-size:12px; opacity:.6}
    .dropdown{position:absolute; top:100%; left:0; min-width:240px; background:var(--card); border:1px solid var(--stroke); border-radius:10px; box-shadow:var(--shadow); padding:8px; display:none}
    .dropdown a{display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:8px}
    .dropdown a:hover{background:var(--surface)}
    .nav-item.open .dropdown{display:block}
    .nav-right{display:flex; gap:8px; align-items:center}
    .btn{border:1px solid var(--stroke); background:var(--card); color:var(--text); border-radius:999px; padding:8px 12px; cursor:pointer}
    .hamb{display:none}

    /* DRAWER */
    .drawer{
      position:fixed; top:var(--appbar-h); right:0; bottom:0; left:30%;
      transform:translateX(100%); transition:transform .25s ease;
      background:var(--card); border-left:1px solid var(--stroke);
      z-index:70; overflow:auto; padding:12px;
    }
    .drawer.open{transform:translateX(0)}
    .drawer .panel-title{margin:14px 4px 6px; font-weight:800; color:var(--muted); font-size:13px}
    .drawer a{display:block; padding:10px; border-radius:10px; border:1px solid var(--stroke); margin:6px 0; background:var(--pill)}
    .drawer a:hover{background:var(--pill-hover)}

    /* CONTENT */
    .container{max-width:1200px; margin:0 auto; padding:16px}
    .hero{display:flex; justify-content:space-between; align-items:flex-start; gap:16px; background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius); padding:16px; margin:16px 0; box-shadow:var(--shadow)}
    .hero h2{margin:0 0 6px; font-size:20px}
    .hero-sub{color:var(--muted); font-size:13px; line-height:1.35; margin-bottom:10px;} /* ↑ boşluk */
    .mini{display:flex; gap:8px; flex-wrap:wrap}
    .pill{padding:6px 10px; border-radius:999px; border:1px solid var(--stroke); background:var(--pill); font-size:12px}

    .grid{display:grid; gap:14px; grid-template-columns:repeat(12, minmax(0,1fr))}
    .col-12{grid-column:span 12} .col-6{grid-column:span 6} .col-4{grid-column:span 4} .col-8{grid-column:span 8}
    .card{background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px}
    .card h3{margin:0 0 10px; font-size:16px}
    .kpi{position:relative; display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px; border-radius:12px; border:1px solid var(--stroke); background:var(--surface)}
    .kpi .val{font-size:22px; font-weight:800; position:relative; z-index:2}
    .kpi .sub{font-size:12px; color:var(--muted); position:relative; z-index:2}

    /* Sayfa özel */
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .row > *{flex:1 1 220px}
    label{display:block; font-weight:700; margin-bottom:6px; color:var(--muted)}
    select{width:100%; padding:10px; border-radius:10px; border:1px solid var(--stroke); background:var(--pill); color:var(--text)}

    /* TABLO — satır aralığı ve progres çizgisi */
    #hedefTablosu{width:100%; border-collapse:separate; border-spacing:0 8px;} /* satır aralığı ↑ */
    #hedefTablosu thead th{background:var(--surface); padding:10px 12px; border-bottom:1px solid var(--stroke); text-align:center}
    #hedefTablosu tbody td{background:var(--card); border:1px solid var(--stroke); padding:12px; text-align:center}
    #hedefTablosu tbody td:first-child{text-align:left; border-top-left-radius:10px; border-bottom-left-radius:10px}
    #hedefTablosu tbody td:last-child{border-top-right-radius:10px; border-bottom-right-radius:10px}

    .progress{position:relative; width:100%; height:28px; border-radius:999px; border:1px solid var(--stroke); background:var(--surface); overflow:hidden}
    .progress > .fill{position:absolute; inset:0 auto 0 0; width:0%; height:100%; background:linear-gradient(90deg, var(--brand2), var(--brand));}
    .progress > .label{position:relative; z-index:2; font-weight:800; line-height:28px}

    .badge{display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; font-weight:700; border:1px solid var(--stroke)}
    .b-hedef { background: #0ea5e933; }
    .b-teberru{background:#f59e0b22}

    /* ÖZET kartlarını renklendir */
    .k1{border-color:color-mix(in oklab, var(--kpi1) 40%, var(--stroke)); background:linear-gradient(180deg, color-mix(in oklab, var(--kpi1) 15%, transparent), transparent)}
    .k2{border-color:color-mix(in oklab, var(--kpi2) 40%, var(--stroke)); background:linear-gradient(180deg, color-mix(in oklab, var(--kpi2) 15%, transparent), transparent)}
    .k3{border-color:color-mix(in oklab, var(--kpi3) 40%, var(--stroke)); background:linear-gradient(180deg, color-mix(in oklab, var(--kpi3) 15%, transparent), transparent)}

    /* “Genel Ulaşma Oranı” için bar — yazıyı ezmemesi için alt dolgu */
    .kpi.has-bar{padding-bottom:28px}
    .kpi-bar{position:absolute; left:12px; right:12px; bottom:10px; height:6px; border-radius:999px; background:var(--surface); overflow:hidden; border:1px solid var(--stroke); z-index:1}
    .kpi-bar > span{display:block; height:100%; width:0%; background:linear-gradient(90deg, var(--good), var(--brand2))}

    /* Modal */
    .modal-arka{display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:120}
    .modal-icerik{
      position:relative; max-width:980px; width:95%;
      margin:40px auto; background:var(--card); border:1px solid var(--stroke);
      border-radius:12px; box-shadow:var(--shadow); padding:16px;
      max-height:92vh; overflow:auto;  /* ← mobilde tamamı sığsın ve kaydırılabilsin */
    }
    .modal-baslik{display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--stroke); padding-bottom:8px; margin-bottom:12px}
    .modal-kapat{border:1px solid var(--stroke); background:var(--pill); color:var(--text); padding:8px 12px; border-radius:999px; cursor:pointer}
    .ozet{display:grid; grid-template-columns:repeat(5,minmax(0,1fr)); gap:10px}
    .hareket-kap{overflow-x:auto; margin-top:12px} /* ← yatay scroll */
    .hareket-tablo{width:100%; min-width:720px; border-collapse:separate; border-spacing:0 6px}
    .hareket-tablo th,.hareket-tablo td{padding:8px 10px; border-bottom:1px solid var(--stroke); text-align:center; white-space:nowrap}
    .etiket{display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; font-weight:700}
    .etiket-hedef{background:#eaf7ff; color:#0b6dbf; border:1px solid #cde8ff}
    .etiket-teberru{background:#fff2e6; color:#c45a00; border:1px solid #ffd9b3}

    .toast{position:fixed; left:50%; bottom:24px; transform:translateX(-50%) translateY(20px); background:rgba(2,6,23,.95); color:#fff; border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:10px 12px; opacity:0; pointer-events:none; transition:opacity .25s, transform .25s; z-index:200}
    .toast.show{opacity:1; transform:translateX(-50%) translateY(0)}

    @media (max-width: 1024px){
      .nav-center{display:none} .hamb{display:inline-flex}
      .ozet{grid-template-columns:repeat(2,minmax(0,1fr))}
      .col-8,.col-4,.col-6,.col-12{grid-column:span 12}
      .modal-icerik{width:96%; padding:12px}
      .hareket-tablo th,.hareket-tablo td{padding:6px 8px; font-size:13px}
    }
    @media (max-width: 640px){
      .ozet{grid-template-columns:1fr}
      .modal-icerik{font-size:14px}
    }

    @media (max-width: 640px){
  .drawer{ left: 20%; } /* daha geniş drawer */
}

  </style>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="../../js/firebase/firebase-init.js"></script>
</head>
<body>
  <!-- APPBAR -->
  <div class="appbar">
    <div class="brand" onclick="location.href='../../panel.html'">
      <img src="../../img/logo.png" alt="logo"><span>KARAAĞAÇ FATİH</span>
    </div>
    <nav class="nav-center"><ul class="nav-list" id="navMain"></ul></nav>
    <div class="nav-right">
      <button class="btn hamb" id="hamburger" title="Menü">☰</button>
      <button class="btn" id="themeToggle" title="Tema: Açık/Koyu/Otomatik">🌗 <span id="themeLabel">Auto</span></button>
      <button class="btn" onclick="logout()">Çıkış Yap</button>
    </div>
  </div>

  <aside class="drawer" id="drawer"></aside>

  <main class="container">
    <section class="hero">
      <div>
        <h2>Hedef Grafik</h2>
        <div class="hero-sub">Personel hedef/temin – teberru ayrı, oran yalnızca hedef teminine göre.</div>
        <div class="mini">
          <span class="pill">🕒 Son Güncelleme: <b id="guncellemeZamani">yükleniyor…</b></span>
        </div>
      </div>
      <div class="mini"><span class="pill">Tema: <span id="themeLabel2">Auto</span></span></div>
    </section>

    <div class="grid">
      <!-- Liste -->
      <div class="card col-8">
        <h3>Liste</h3>
        <div class="row" style="margin-bottom:12px">
          <div>
            <label for="kategoriSecimi">Kategori</label>
            <select id="kategoriSecimi">
              <option value="Kitap Kampanyası">Kitap Kampanyası</option>
              <option value="Muhacir Hediye">Muhacir Hediye/İhtiyaç</option>
              <option value="Talebeye İkram">Talebeye İkram</option>
              <option value="Mevlid Kandili">Mevlid Kandili</option>
            </select>
          </div>
          <div>
            <label for="filtreSecimi">Filtre</label>
            <select id="filtreSecimi">
              <option value="oran-azalan" selected>Ulaşma Nispeti (Azalan)</option>
              <option value="oran-artan">Ulaşma Nispeti (Artan)</option>
              <option value="personel-az">Personel (A → Z)</option>
              <option value="personel-za">Personel (Z → A)</option>
              <option value="hedef-artan">Hedef (Artan)</option>
              <option value="hedef-azalan">Hedef (Azalan)</option>
              <option value="temin-artan">Temin (Artan)</option>
              <option value="temin-azalan">Temin (Azalan)</option>
              <option value="teberru-artan">Teberru (Artan)</option>
              <option value="teberru-azalan">Teberru (Azalan)</option>
            </select>
          </div>
          <div class="pill" style="align-self:flex-end">Satıra tıklayınca detay açılır.</div>
        </div>

        <div style="overflow:auto">
          <table id="hedefTablosu">
            <thead>
              <tr>
                <th>Personel</th>
                <th>Hedef (₺)</th>
                <th>Teberru (₺)</th>
                <th>Temin Edilen (₺)</th>
                <th>Ulaşma Nispeti (%)</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- Özet -->
      <div class="card col-4" id="ozetCard">
        <h3>Özet</h3>
        <div class="kpi k1" style="margin-bottom:8px">
          <div><div class="val" id="toplamHedef">₺0</div><div class="sub">Toplam Hedef</div></div><div class="badge b-hedef">🎯</div>
        </div>
        <div class="kpi k2" style="margin-bottom:8px">
          <div><div class="val" id="toplamTemin">₺0</div><div class="sub">Toplam Temin (Hedef)</div></div><div class="badge b-hedef">📈</div>
        </div>
        <div class="kpi k3" style="margin-bottom:8px">
          <div><div class="val" id="toplamTeberru">₺0</div><div class="sub">Toplam Teberru</div></div><div class="badge b-teberru">🤝</div>
        </div>
        <div class="kpi has-bar">
          <div><div class="val" id="toplamOran">%0</div><div class="sub">Genel Ulaşma Oranı</div></div><div>✅</div>
          <div class="kpi-bar"><span id="oranBar"></span></div>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal -->
  <div class="modal-arka" id="detayModal">
    <div class="modal-icerik">
      <div class="modal-baslik">
        <h3 id="modalBaslik">Detay</h3>
        <button class="modal-kapat" id="modalKapat">Kapat</button>
      </div>

      <div class="ozet">
        <div class="kpi"><div><div class="sub">Hedef Toplam</div><div class="val" id="m_hedefTop">₺0</div></div></div>
        <div class="kpi"><div><div class="sub">Hedef Temini</div><div class="val" id="m_hedefTeminTop">₺0</div></div></div>
        <div class="kpi"><div><div class="sub">Teberru</div><div class="val" id="m_teberruTop">₺0</div></div></div>
        <div class="kpi"><div><div class="sub">Genel Temin</div><div class="val" id="m_genelTeminTop">₺0</div></div></div>
        <div class="kpi"><div><div class="sub">Ulaşma Nispeti</div><div class="val" id="m_oranTop">%0</div></div></div>
      </div>

      <div class="hareket-kap">
        <table class="hareket-tablo" id="m_hareketTablo">
          <thead><tr><th>Tarih</th><th>Ad Soyad</th><th>Miktar (₺)</th><th>Tür</th><th>Açıklama</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    /* ===== Tema ===== */
    (function(){
      const root=document.documentElement, btn=document.getElementById('themeToggle');
      const lab1=document.getElementById('themeLabel'), lab2=document.getElementById('themeLabel2');
      const sysDark=()=>window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches;
      function apply(mode){
        localStorage.setItem('kf_theme',mode);
        const eff=(mode==='auto')?(sysDark()?'dark':'light'):mode;
        root.setAttribute('data-theme',eff);
        const txt=mode[0].toUpperCase()+mode.slice(1);
        if(lab1) lab1.textContent=txt; if(lab2) lab2.textContent=txt;
        const icon=mode==='dark'?'🌙':mode==='light'?'☀️':'🌗';
        btn.innerHTML=icon+' <span id="themeLabel">'+txt+'</span>';
      }
      apply(localStorage.getItem('kf_theme')||'auto');
      btn.addEventListener('click',()=>{const cur=localStorage.getItem('kf_theme')||'auto'; apply(cur==='dark'?'light':(cur==='light'?'auto':'dark'));});
      if(window.matchMedia){ const m=window.matchMedia('(prefers-color-scheme: dark)'); m.addEventListener?.('change',()=>{ if((localStorage.getItem('kf_theme')||'auto')==='auto') apply('auto'); }); }
    })();

    /* ===== Helpers & Firebase ===== */
    const db=firebase.firestore(), auth=firebase.auth();
    function showToast(msg){const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); clearTimeout(window.__to); window.__to=setTimeout(()=>t.classList.remove('show'),3000);}
    function logout(){ auth.signOut().then(()=>location.replace('../../index.html')).catch(()=>location.replace('../../index.html')); } window.logout=logout;

    /* ===== Menü (YETKİLER) ===== */
    let CURRENT_ALLOW=new Set(), CURRENT_DENY=new Set();
    const norm=(s)=>String(s||'').trim().toLowerCase();
    const PANEL_ICON={ 'Admin':'🎛️','Talebe':'📘','Personel':'👤','Muhasebe':'💰','Kermes':'🏪','Nehari':'🕌','Sistem Ayarları':'⚙️' };


  // 🔧 URL normalize: http(s) ise aynen; / ile başlıyorsa kökten; aksi halde kökten başlat.
  function normalizePath(p){
    if(!p) return '#';
    const s = String(p).trim();
    if(/^https?:\/\//i.test(s)) return s;      // tam URL
    if(s.startsWith('/')) return s;            // kök-relative zaten
    // ./, ../ gibi önekleri temizle, kökten başlat
    return '/' + s.replace(/^(\.\/)+/,'').replace(/^(\.\.\/)+/,'');
  }

  async function fetchPanels(allowSet, denySet){
    const res=[]; 
    try{
      const snap=await db.collection('sayfa_manifesti').get();
      snap.forEach(doc=>{
        const d=doc.data()||{}, id=doc.id;
        const title=d.title||id, ikon=d.icon||(PANEL_ICON[id]||'📁');

        const panelGrant = allowSet.has(norm(id)) || allowSet.has(norm(title));

        let pages = Array.isArray(d.pages)? d.pages : [];
        pages = pages
          .filter(pg=>{
            const keyNorm = norm(pg.key || pg.title || '');
            const pageGrant = allowSet.has(keyNorm);
            const denied    = denySet.has(keyNorm);
            return !denied && (panelGrant || pageGrant);
          })
          .map(pg=>({
            baslik: pg.title || pg.key || 'Sayfa',
            // ⬇️ yol manifestten nasıl gelirse gelsin normalize et
            url:    normalizePath(pg.path || pg.url || '#'),
            key:    pg.key   || pg.title || '',
            sira:   typeof pg.order==='number' ? pg.order : 9999
          }))
          .sort((a,b)=>a.sira-b.sira);

        if(pages.length) res.push({ id, baslik:title, ikon, sira: typeof d.order==='number'? d.order : 9999, pages });
      });
      res.sort((a,b)=>a.sira-b.sira);
    }catch(e){
      console.error('sayfa_manifesti okunamadı:', e);
      showToast('Menü manifesti yüklenemedi.');
    }
    return res;
  }

  function renderNav(panels){
    const ul=document.getElementById('navMain'), drawer=document.getElementById('drawer');
    ul.innerHTML=''; drawer.innerHTML='';

    if(!panels.length){
      ul.innerHTML='<li class="nav-item"><div class="nav-btn">Hiç panel yok</div></li>';
      drawer.innerHTML='<div style="color:var(--muted);padding:8px">Hiç panel bulunamadı</div>';
      return;
    }

    // Mobil menü (drawer) toggle
(function initDrawerToggle(){
  const hamb   = document.getElementById('hamburger');
  const drawer = document.getElementById('drawer');
  if (!hamb || !drawer) return;

  // Aynı dinleyiciyi iki kez eklememek için guard
  if (hamb.dataset.inited === '1') return;
  hamb.dataset.inited = '1';

  // Aç/Kapat
  hamb.addEventListener('click', (e) => {
    e.stopPropagation();
    drawer.classList.toggle('open');
  });

  // Dışarı tıklayınca kapat
  document.addEventListener('click', (e) => {
    const clickedInside = drawer.contains(e.target) || hamb.contains(e.target);
    if (!clickedInside) drawer.classList.remove('open');
  });

  // Drawer içindeki bir linke tıklanınca kapat
  drawer.addEventListener('click', (e) => {
    const a = e.target.closest('a');
    if (a) drawer.classList.remove('open');
  });

  // ESC ile kapatma (isteğe bağlı)
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') drawer.classList.remove('open');
  });
})();

    // Masaüstü dropdown
    panels.forEach(p=>{
      const li=document.createElement('li'); li.className='nav-item';
      li.innerHTML=`<div class="nav-btn">${p.baslik} <span class="caret">▾</span></div>`;
      const dd=document.createElement('div'); dd.className='dropdown';

      (p.pages||[]).forEach(pg=>{
        const a=document.createElement('a');
        a.href = normalizePath(pg.url);                 // ⬅️ burada da garanti
        a.textContent = pg.baslik;
        a.dataset.key   = pg.key || pg.baslik;
        a.dataset.panel = p.id;
        a.dataset.panelTitle = p.baslik;
        dd.appendChild(a);
      });

      li.appendChild(dd);
      li.querySelector('.nav-btn').addEventListener('click',(e)=>{
        e.stopPropagation();
        ul.querySelectorAll('.nav-item').forEach(x=>{ if(x!==li) x.classList.remove('open'); });
        li.classList.toggle('open');
      });
      ul.appendChild(li);
    });
    document.addEventListener('click',(e)=>{ if(!ul.contains(e.target)) ul.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('open')); });

    // Mobil drawer
    panels.forEach(p=>{
      const h=document.createElement('div'); h.className='panel-title'; h.textContent=p.baslik; drawer.appendChild(h);
      (p.pages||[]).forEach(pg=>{
        const a=document.createElement('a');
        a.href = normalizePath(pg.url);                 // ⬅️ burada da garanti
        a.textContent=pg.baslik;
        a.dataset.key=pg.key||pg.baslik;
        a.dataset.panel=p.id;
        a.dataset.panelTitle=p.baslik;
        drawer.appendChild(a);
      });
    });
  }

  // Link guard (yetki kontrolü) — aynı kaldı
  document.addEventListener('click', (e) => {
    const a = e.target.closest('a[data-key]');
    if (!a) return;

    const key = norm(a.dataset.key);
    const pnl = norm(a.dataset.panel || '');
    const pnlTitle = norm(a.dataset.panelTitle || '');

    if (CURRENT_DENY.has(key)) { e.preventDefault(); showToast('Bu sayfa için yetkiniz yok.'); return; }
    const allowed = CURRENT_ALLOW.has(key) || CURRENT_ALLOW.has(pnl) || CURRENT_ALLOW.has(pnlTitle);
    if (!allowed) { e.preventDefault(); showToast('Bu sayfa için yetkiniz yok.'); }
  });

    /* ===== İş mantığı ===== */
    const kategoriSecimi=document.getElementById("kategoriSecimi");
    const filtreSecimi  =document.getElementById("filtreSecimi");
    const tabloBody     =document.querySelector("#hedefTablosu tbody");
    const toplamTeberruEl=document.getElementById("toplamTeberru");
    const toplamHedefEl =document.getElementById("toplamHedef");
    const toplamTeminEl =document.getElementById("toplamTemin");
    const toplamOranEl  =document.getElementById("toplamOran");
    const oranBar       =document.getElementById("oranBar");
    const guncellemeEl  =document.getElementById("guncellemeZamani");

    let veriTablosu=[], unsubHedef=null, unsubVeri=null, cacheTeminHedef={}, cacheTeberru={}, sonHedefMap={};

    // Modal EL'leri
    const modalArka=document.getElementById('detayModal');
    const modalKapat=document.getElementById('modalKapat');
    const m_baslik=document.getElementById('modalBaslik');
    const m_hedefTop=document.getElementById('m_hedefTop');
    const m_hedefTeminTop=document.getElementById('m_hedefTeminTop');
    const m_teberruTop=document.getElementById('m_teberruTop');
    const m_genelTeminTop=document.getElementById('m_genelTeminTop');
    const m_oranTop=document.getElementById('m_oranTop');
    const m_hareketTabloBody=document.querySelector('#m_hareketTablo tbody');

    modalKapat.addEventListener('click',()=> modalArka.style.display='none');
    modalArka.addEventListener('click',(e)=>{ if(e.target===modalArka) modalArka.style.display='none'; });

    function toNum(v){
      if(typeof v==='number') return v;
      if(typeof v==='string'){ const n=Number(v.replace(/\./g,'').replace(',', '.')); return isNaN(n)?0:n; }
      return 0;
    }

    function tabloyuYenidenYaz(veriler){
      tabloBody.innerHTML="";
      veriler.forEach(p=>{
        const tr=document.createElement("tr");
        const td1=document.createElement("td"); td1.textContent=p.personel;
        const td2=document.createElement("td"); td2.textContent=`${p.hedef.toLocaleString("tr-TR")} ₺`;
        const tdT=document.createElement("td"); tdT.textContent=`${p.teberru.toLocaleString("tr-TR")} ₺`;
        const td3=document.createElement("td"); td3.textContent=`${p.teminHedef.toLocaleString("tr-TR")} ₺`;

        const td4=document.createElement("td");
        const prog=document.createElement('div'); prog.className='progress';
        const fill=document.createElement('div'); fill.className='fill'; fill.style.width=Math.max(0, Math.min(100, p.oran))+'%';
        const lab=document.createElement('div'); lab.className='label'; lab.textContent=`%${p.oran}`;
        prog.appendChild(fill); prog.appendChild(lab); td4.appendChild(prog);

        tr.append(td1, td2, tdT, td3, td4);
        tr.addEventListener('click',()=>acDetayModal(p.personel));
        tabloBody.appendChild(tr);
      });
    }

    function uygulaFiltre(){
      const f=filtreSecimi.value; let d=[...veriTablosu];
      const by=(k)=> (a,b)=>a[k]-b[k];
      switch(f){
        case "personel-az": d.sort((a,b)=>a.personel.localeCompare(b.personel)); break;
        case "personel-za": d.sort((a,b)=>b.personel.localeCompare(a.personel)); break;
        case "hedef-artan": d.sort(by('hedef')); break;
        case "hedef-azalan": d.sort((a,b)=>b.hedef-a.hedef); break;
        case "temin-artan": d.sort(by('teminHedef')); break;
        case "temin-azalan": d.sort((a,b)=>b.teminHedef-a.teminHedef); break;
        case "teberru-artan": d.sort(by('teberru')); break;
        case "teberru-azalan": d.sort((a,b)=>b.teberru-a.teberru); break;
        case "oran-artan": d.sort(by('oran')); break;
        case "oran-azalan":
        default: d.sort((a,b)=>b.oran-a.oran); break;
      }
      tabloyuYenidenYaz(d);
    }

    function toplamlariGuncelle(){
      const sumTeberru=veriTablosu.reduce((s,x)=>s+x.teberru,0);
      const sumHedef  =veriTablosu.reduce((s,x)=>s+x.hedef,0);
      const sumTeminHF=veriTablosu.reduce((s,x)=>s+x.teminHedef,0);
      const oran = sumHedef>0 ? Math.round((sumTeminHF/sumHedef)*100) : 0;

      toplamTeberruEl.textContent=`₺${sumTeberru.toLocaleString("tr-TR")}`;
      toplamHedefEl.textContent  =`₺${sumHedef.toLocaleString("tr-TR")}`;
      toplamTeminEl.textContent  =`₺${sumTeminHF.toLocaleString("tr-TR")}`;
      toplamOranEl.textContent   =`%${oran}`;
      oranBar.style.width=Math.max(0, Math.min(100, oran))+'%'; // küçük doluluk barı
    }

    function kategoriDegistiGercekZamanli(kategori){
      if(typeof unsubHedef==='function') unsubHedef();
      if(typeof unsubVeri==='function') unsubVeri();

      const hedefMap={}, teminHedefMap={}, teberruMap={}; let maxUpdateTs=0;

      unsubHedef = db.collection("hedefler").where("kategori","==", kategori).onSnapshot((snap)=>{
        Object.keys(hedefMap).forEach(k=>delete hedefMap[k]);
        snap.forEach(doc=>{
          const d=doc.data(); const p=d.personel||'-';
          hedefMap[p]=toNum(d.hedef);
          const ts=d.updatedAt?.toMillis?.()? d.updatedAt.toMillis(): (d.updatedAt||0);
          if(ts>maxUpdateTs) maxUpdateTs=ts;
        });
        sonHedefMap={...hedefMap};
        tabloyuHazirlaVeYansit();
        cacheTeminHedef={...teminHedefMap};
        cacheTeberru   ={...teberruMap};
      });

      unsubVeri = db.collection("veriler").where("kategori","==", kategori).onSnapshot((snap)=>{
        Object.keys(teminHedefMap).forEach(k=>delete teminHedefMap[k]);
        Object.keys(teberruMap).forEach(k=>delete teberruMap[k]);

        snap.forEach(doc=>{
          const d=doc.data(); const p=d.personel||'-'; const miktar=toNum(d.miktar);
          const tur=(d.tur||'hedef').toLowerCase();
          if(tur==='teberru'){ teberruMap[p]=(teberruMap[p]||0)+miktar; } else { teminHedefMap[p]=(teminHedefMap[p]||0)+miktar; }
          const ts=d.createdAt?.toMillis?.()? d.createdAt.toMillis(): (d.createdAt||0);
          if(ts>maxUpdateTs) maxUpdateTs=ts;
        });

        tabloyuHazirlaVeYansit();
      });

      function tabloyuHazirlaVeYansit(){
        const personeller=new Set([...Object.keys(hedefMap), ...Object.keys(teminHedefMap), ...Object.keys(teberruMap)]);
        const tabloDizi=[];
        personeller.forEach(personel=>{
          const hedef=toNum(hedefMap[personel]||0);
          const teminHedef=toNum(teminHedefMap[personel]||0);
          const teberru=toNum(teberruMap[personel]||0);
          const oran=hedef>0? Math.round((teminHedef/hedef)*100) : 0;
          tabloDizi.push({personel, hedef, teminHedef, teberru, oran});
        });
        veriTablosu=tabloDizi;
        uygulaFiltre();
        toplamlariGuncelle();
        const nowStr=new Date((maxUpdateTs && !isNaN(maxUpdateTs))? maxUpdateTs: Date.now()).toLocaleString("tr-TR");
        guncellemeEl.textContent=nowStr;
      }
    }

    async function acDetayModal(personel){
      const kategori=kategoriSecimi.value;
      m_baslik.textContent=`${personel} — ${kategori}`;
      modalArka.style.display='block';
      m_hareketTabloBody.innerHTML='<tr><td colspan="5">Yükleniyor...</td></tr>';

      const hedef=toNum(sonHedefMap[personel]||0);
      try{
        const baseQ=db.collection('veriler').where('kategori','==',kategori).where('personel','==',personel);
        let snap; try{ snap=await baseQ.orderBy('createdAt','desc').get(); }catch(e){ snap=await baseQ.get(); }

        let hedefTeminTop=0, teberruTop=0; const satirlar=[];
        snap.forEach(doc=>{
          const d=doc.data(); const turRaw=d.tur ?? d.sekil ?? 'hedef'; const tur=String(turRaw).toLowerCase();
          const miktar=toNum(d.miktar); const adsoyad=d.adSoyad||d.veren||d.verenAdSoyad||'-';
          const aciklama=d.aciklama||d.nereyeGeldi||'-';
          const t=d.createdAt?.toDate? d.createdAt.toDate() : (d.createdAt? new Date(d.createdAt) : null);
          const tStr=t? t.toLocaleString('tr-TR') : '-';
          if(tur==='teberru') teberruTop+=miktar; else hedefTeminTop+=miktar;
          satirlar.push({tStr, adsoyad, miktar, tur, aciklama});
        });

        if(satirlar.length===0){ hedefTeminTop=toNum(cacheTeminHedef[personel]||0); teberruTop=toNum(cacheTeberru[personel]||0); }
        const genelTeminTop=hedefTeminTop+teberruTop;
        const oran=hedef>0? Math.round((hedefTeminTop/hedef)*100) : 0;

        m_hedefTop.textContent='₺'+hedef.toLocaleString('tr-TR');
        m_hedefTeminTop.textContent='₺'+hedefTeminTop.toLocaleString('tr-TR');
        m_teberruTop.textContent='₺'+teberruTop.toLocaleString('tr-TR');
        m_genelTeminTop.textContent='₺'+genelTeminTop.toLocaleString('tr-TR');
        m_oranTop.textContent='%'+oran;

        m_hareketTabloBody.innerHTML='';
        if(satirlar.length===0){
          m_hareketTabloBody.innerHTML='<tr><td colspan="5">Hareket bulunamadı.</td></tr>';
        }else{
          satirlar.forEach(x=>{
            const tr=document.createElement('tr');
            tr.innerHTML=`<td>${x.tStr}</td><td>${x.adsoyad}</td><td>₺${x.miktar.toLocaleString('tr-TR')}</td>
              <td><span class="etiket ${x.tur==='teberru'?'etiket-teberru':'etiket-hedef'}">${x.tur==='teberru'?'Teberru':'Hedef'}</span></td>
              <td>${x.aciklama}</td>`;
            m_hareketTabloBody.appendChild(tr);
          });
        }
      }catch(err){
        console.error('[detay modal] hata:',err);
        m_hareketTabloBody.innerHTML=`<tr><td colspan="5">Kayıtlar yüklenemedi. Muhtemelen Firestore <b>endeksi</b> gerekir.</td></tr>`;
        m_hedefTeminTop.textContent='₺0'; m_teberruTop.textContent='₺0'; m_genelTeminTop.textContent='₺0'; m_oranTop.textContent='%0';
      }
    }
    window._acDetayModal=acDetayModal;

    // seçimleri hatırla
    (function(){
      const k=localStorage.getItem('hedefGrafik_kategori'); if(k) kategoriSecimi.value=k;
      const f=localStorage.getItem('hedefGrafik_filtresi'); if(f) filtreSecimi.value=f;
      kategoriSecimi.addEventListener('change',()=>{ localStorage.setItem('hedefGrafik_kategori',kategoriSecimi.value); kategoriDegistiGercekZamanli(kategoriSecimi.value); });
      filtreSecimi.addEventListener('change',()=>{ localStorage.setItem('hedefGrafik_filtresi',filtreSecimi.value); uygulaFiltre(); });
    })();

    // Auth & menü ve sayfa çalıştır
    try{ firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL); }catch(e){}
    auth.onAuthStateChanged(async (user)=>{
      if(!user){ setTimeout(()=>{ if(!auth.currentUser) location.replace('../../index.html'); },150); return; }
      try{
        const uSnap=await db.collection('kullanicilar').doc(user.uid).get();
        const data=uSnap.exists? uSnap.data(): {};
        const raw=Array.isArray(data.yetkiler)? data.yetkiler: [];
        CURRENT_ALLOW=new Set(raw.filter(s=>!String(s).trim().match(/^[-!]/)).map(norm));
        CURRENT_DENY =new Set(raw.filter(s=> String(s).trim().match(/^[-!]/)).map(s=>norm(String(s).replace(/^[-!]\s*/,''))));
        const panels=await fetchPanels(CURRENT_ALLOW, CURRENT_DENY); renderNav(panels);
        kategoriDegistiGercekZamanli(kategoriSecimi.value);
      }catch(e){ console.error(e); showToast('Veriler yüklenirken hata.'); }
    });
  </script>
</body>
</html>
