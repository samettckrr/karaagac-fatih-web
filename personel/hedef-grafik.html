<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Hedef Grafik | KaraaÄŸaÃ§ Fatih</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" type="image/png" href="../../img/logo.png" />

  <style>
    :root{
      --appbar-h:56px; --radius:14px; --shadow:0 12px 28px rgba(0,0,0,.14);
      --bg:#0f172a; --bg2:#0b1324; --grad1:#0ea5e922; --grad2:#22d3ee22;
      --card:rgba(15,23,42,.92); --stroke:rgba(148,163,184,.18);
      --text:#e5e7eb; --muted:#9aa4b2; --brand:#38bdf8; --brand2:#0ea5e9;
      --pill:#0b1220; --pill-hover:#101a2b; --link:#c7e9ff; --surface:rgba(2,6,23,.08);
      --good:#22c55e; --warn:#f59e0b; --bad:#ef4444; --great:#16a34a;
      --kpi1:#0ea5e9; --kpi2:#22c55e; --kpi3:#f59e0b;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#eef6ff; --bg2:#f7fbff; --grad1:#38bdf822; --grad2:#22d3ee22;
        --card:rgba(255,255,255,.95); --stroke:rgba(15,23,42,.12);
        --text:#0b1220; --muted:#4b5563; --brand:#0ea5e9; --brand2:#0284c7;
        --pill:#f5f8ff; --pill-hover:#e9f2ff; --link:#0b5ea8; --surface:#eef3ff;
        --kpi1:#0284c7; --kpi2:#16a34a; --kpi3:#d97706;
        --good:#16a34a; --warn:#d97706; --bad:#dc2626; --great:#15803d;
      }
    }
    html[data-theme="dark"]{
      --bg:#0f172a; --bg2:#0b1324; --grad1:#0ea5e922; --grad2:#22d3ee22;
      --card:rgba(15,23,42,.92); --stroke:rgba(148,163,184,.18);
      --text:#e5e7eb; --muted:#9aa4b2; --brand:#38bdf8; --brand2:#0ea5e9;
      --pill:#0b1220; --pill-hover:#101a2b; --link:#c7e9ff; --surface:rgba(2,6,23,.08);
      --good:#22c55e; --warn:#f59e0b; --bad:#ef4444; --great:#16a34a;
      --kpi1:#38bdf8; --kpi2:#22c55e; --kpi3:#f59e0b;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      font-family:ui-sans-serif,-apple-system,"Segoe UI",Roboto,Arial;
      background:
        radial-gradient(900px 680px at 12% 8%, var(--grad1), transparent 45%),
        radial-gradient(800px 640px at 88% 92%, var(--grad2), transparent 50%),
        linear-gradient(140deg, var(--bg), var(--bg2) 60%);
      overflow-x:hidden; word-wrap:break-word;
    }
    a{color:var(--link); text-decoration:none}
    a:hover{text-decoration:underline}

    .appbar{
      position:sticky; top:0; z-index:60; height:var(--appbar-h);
      background:var(--card); backdrop-filter:blur(10px);
      border-bottom:1px solid var(--stroke);
      display:flex; align-items:center;
      padding:0 max(12px, env(safe-area-inset-right)) 0 max(12px, env(safe-area-inset-left));
    }
    .brand{display:flex; align-items:center; gap:10px; cursor:pointer}
    .brand img{width:24px; height:24px}
    .brand span{font-weight:900; letter-spacing:.02em}
    .nav-center{margin:0 auto; height:100%}
    .nav-list{display:flex; gap:22px; align-items:center; height:100%; list-style:none; margin:0; padding:0}
    .nav-item{position:relative; height:100%}
    .nav-btn{height:100%; display:flex; align-items:center; gap:6px; font-weight:600; cursor:pointer}
    .nav-btn:hover{color:var(--brand)}
    .caret{font-size:12px; opacity:.6}
    .dropdown{position:absolute; top:100%; left:0; min-width:240px; background:var(--card); border:1px solid var(--stroke); border-radius:10px; box-shadow:var(--shadow); padding:8px; display:none}
    .dropdown a{display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:8px}
    .dropdown a:hover{background:var(--surface)}
    .nav-item.open .dropdown{display:block}
    .nav-right{display:flex; gap:8px; align-items:center}
    .btn{border:1px solid var(--stroke); background:var(--card); color:var(--text); border-radius:999px; padding:8px 12px; cursor:pointer}
    .hamb{display:none}

    .drawer{
      position:fixed; top:var(--appbar-h); right:0; bottom:0; left:30%;
      transform:translateX(100%); transition:transform .25s ease;
      background:var(--card); border-left:1px solid var(--stroke);
      z-index:70; overflow:auto; padding:12px;
    }
    .drawer.open{transform:translateX(0)}
    .drawer .panel-title{margin:14px 4px 6px; font-weight:800; color:var(--muted); font-size:13px}
    .drawer a{display:block; padding:10px; border-radius:10px; border:1px solid var(--stroke); margin:6px 0; background:var(--pill)}
    .drawer a:hover{background:var(--pill-hover)}

    .container{max-width:1750px; margin:0 auto; padding:16px}
    .hero{display:flex; justify-content:space-between; align-items:flex-start; gap:16px; background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius); padding:16px; margin:16px 0; box-shadow:var(--shadow)}
    .hero h2{margin:0 0 6px; font-size:20px}
    .hero-sub{color:var(--muted); font-size:15px; line-height:1.35; margin-bottom:10px;}
    .hero-sub1{color:var(--muted); font-size:13px; line-height:1.35; margin-bottom:10px;}
    .mini{display:flex; gap:8px; flex-wrap:wrap}
    .pill{padding:6px 10px; border-radius:999px; border:1px solid var(--stroke); background:var(--pill); font-size:12px}

    .grid{display:grid; gap:14px; grid-template-columns:repeat(12, minmax(0,1fr)); align-items:start}
    .col-12{grid-column:span 12} .col-10{grid-column:span 10} .col-9{grid-column:span 9} .col-8{grid-column:span 8} .col-6{grid-column:span 6} .col-4{grid-column:span 4} .col-3{grid-column:span 3} .col-2{grid-column:span 2}
    .card{background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px}
    .card h3{margin:0 0 10px; font-size:16px}
    .kpi{position:relative; display:flex; align-items:center; justify-content:space-between; gap:10px; padding:12px; border-radius:12px; border:1px solid var(--stroke); background:var(--surface)}
    .kpi .val{font-size:22px; font-weight:800; position:relative; z-index:2}
    .kpi .sub{font-size:12px; color:var(--muted); position:relative; z-index:2}

    .row-grid{display:grid; gap:10px; grid-template-columns:repeat(4,minmax(0,1fr)); align-items:end}
    .row-grid .cell{min-width:160px}
    .row-grid .right-note{justify-self:end; align-self:center; color:var(--muted); font-size:12px}
    @media (max-width: 820px){ .row-grid{grid-template-columns:repeat(2,minmax(0,1fr))} .row-grid .right-note{grid-column:1/-1; justify-self:start; margin-top:4px} }

    label{display:block; font-weight:700; margin-bottom:6px; color:var(--muted)}
    select{width:100%; padding:10px; border-radius:10px; border:1px solid var(--stroke); background:var(--pill); color:var(--text)}

    #tableWrap{overflow-x:visible}
    #hedefTablosu{
      width:100%; border-collapse:separate; border-spacing:0 8px; table-layout:auto;
    }
    #hedefTablosu thead th{background:var(--surface); padding:10px 12px; border-bottom:1px solid var(--stroke); text-align:center}
    #hedefTablosu tbody td{background:var(--card); border:1px solid var(--stroke); padding:12px; text-align:center}
    #hedefTablosu thead th, #hedefTablosu tbody td { white-space:nowrap; overflow:hidden; text-overflow:ellipsis }
    #hedefTablosu tbody td:first-child{text-align:left; border-top-left-radius:10px; border-bottom-left-radius:10px}
    #hedefTablosu tbody td:last-child{border-top-right-radius:10px; border-bottom-right-radius:10px}

    .c-personel{width:20%}
    .c-mid{width:12%}
    .c-kurban{width:8%}
    .c-oran{width:18%}

    #hedefTablosu tbody td.wrap{white-space:normal; word-break:normal; overflow:visible; text-overflow:clip;}

    .under-note{color:var(--muted); font-size:12px; margin-top:6px}

    /* Personel Toggle - Zarif Minimalist TasarÄ±m */
    .personel-toggle{
      display:inline-flex;
      align-items:center;
      gap:8px;
      cursor:pointer;
      user-select:none;
      padding:4px 8px;
      border-radius:20px;
      transition:background .2s ease;
    }
    .personel-toggle:hover{
      background:var(--surface);
    }
    .personel-toggle input[type="checkbox"]{
      position:absolute;
      opacity:0;
      width:0;
      height:0;
    }
    .toggle-slider{
      position:relative;
      width:36px;
      height:18px;
      background:var(--stroke);
      border-radius:9px;
      transition:background .25s ease;
      flex-shrink:0;
    }
    .toggle-slider::before{
      content:'';
      position:absolute;
      width:14px;
      height:14px;
      border-radius:50%;
      background:#fff;
      top:2px;
      left:2px;
      transition:transform .25s ease, box-shadow .25s ease;
      box-shadow:0 1px 3px rgba(0,0,0,.15);
    }
    .personel-toggle input:checked + .toggle-slider{
      background:var(--brand);
    }
    .personel-toggle input:checked + .toggle-slider::before{
      transform:translateX(18px);
      box-shadow:0 2px 4px rgba(0,0,0,.2);
    }
    .toggle-label{
      font-size:12px;
      font-weight:500;
      color:var(--text);
      opacity:.8;
      transition:opacity .2s ease;
    }
    .personel-toggle:hover .toggle-label{
      opacity:1;
    }
    @media (prefers-color-scheme: light){
      .toggle-slider{
        background:rgba(15,23,42,.15);
      }
      .personel-toggle input:checked + .toggle-slider{
        background:var(--brand2);
      }
    }

    .progress{position:relative; width:100%; height:28px; border-radius:999px; border:1px solid var(--stroke); background:var(--surface); overflow:hidden}
    .progress > .fill{position:absolute; inset:0 auto 0 0; width:0%; height:100%; background:linear-gradient(90deg, var(--brand2), var(--brand));}
    .progress > .fill.ok{background:linear-gradient(90deg, var(--good), var(--great));}
    .progress > .label{position:relative; z-index:2; font-weight:800; line-height:28px; font-size:12px; padding:0 6px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis}

    .badge{display:inline-block; padding:4px 10px; border-radius:999px; font-size:12px; font-weight:700; border:1px solid var(--stroke)}
    .b-hedef { background: #0ea5e933; }
    .b-teberru{background:#f59e0b22}
    .b-tahsilat{background:#22c55e22}

    .k1{border-color:color-mix(in oklab, var(--kpi1) 40%, var(--stroke)); background:linear-gradient(180deg, color-mix(in oklab, var(--kpi1) 15%, transparent), transparent)}
    .k2{border-color:color-mix(in oklab, var(--kpi2) 40%, var(--stroke)); background:linear-gradient(180deg, color-mix(in oklab, var(--kpi2) 15%, transparent), transparent)}
    .k3{border-color:color-mix(in oklab, var(--kpi3) 40%, var(--stroke)); background:linear-gradient(180deg, color-mix(in oklab, var(--kpi3) 15%, transparent), transparent)}
    .k-kurban{
    border:1px solid color-mix(in oklab, #f97316 40%, var(--stroke));
    background:linear-gradient(180deg, rgba(249,115,22,.09), transparent);
    }
    .k-kurban-total{
      border:1px solid color-mix(in oklab, #f97316 55%, var(--stroke));
      background:linear-gradient(180deg, rgba(249,115,22,.16), transparent);
    }
    .badge.b-kurban{
      background:rgba(249,115,22,.11);
      border:1px solid rgba(249,115,22,.28);
      color:#fff;
    }

    .kpi.has-bar{padding-bottom:28px}
    .kpi-bar{position:absolute; left:12px; right:12px; bottom:10px; height:6px; border-radius:999px; background:var(--surface); overflow:hidden; border:1px solid var(--stroke); z-index:1}
    .kpi-bar > span{display:block; height:100%; width:0%; background:linear-gradient(90deg, var(--good), var(--brand2))}

    .modal-arka{display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:120}
    .modal-icerik{
      position:relative; max-width:980px; width:95%;
      margin:40px auto; background:var(--card); border:1px solid var(--stroke);
      border-radius:12px; box-shadow:var(--shadow); padding:16px;
      max-height:92vh; overflow:auto;
    }
    .modal-baslik{display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--stroke); padding-bottom:8px; margin-bottom:12px}
    .modal-kapat{border:1px solid var(--stroke); background:var(--pill); color:var(--text); padding:8px 12px; border-radius:999px; cursor:pointer}
    .ozet{display:grid; grid-template-columns:repeat(5,minmax(0,1fr)); gap:10px}
    .hareket-kap{overflow-x:auto; margin-top:12px}
    .hareket-tablo{width:100%; min-width:720px; border-collapse:separate; border-spacing:0 6px}
    .hareket-tablo th,.hareket-tablo td{padding:8px 10px; border-bottom:1px solid var(--stroke); text-align:center; white-space:nowrap}
    .etiket{display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; font-weight:700}
    .etiket-hedef{background:#eaf7ff; color:#0b6dbf; border:1px solid #cde8ff}
    .etiket-teberru{background:#fff2e6; color:#c45a00; border:1px solid #ffd9b3}
    .etiket-tahsilat{background:#ecffe9; color:#177a2a; border:1px solid #c8f1c3}
    .etiket-kurban{background:#fffbd1; color:#b45309; border:1px solid #fde68a}

    .sort-head{display:flex; align-items:center; justify-content:center; gap:6px}
    .sort-arrows span{cursor:pointer; padding:0 2px; opacity:.55}
    .sort-arrows span.active{opacity:1; font-weight:900}
    .sort-arrows span:hover{opacity:.9}

    .toast{position:fixed; left:50%; bottom:24px; transform:translateX(-50%) translateY(20px); background:rgba(2,6,23,.95); color:#fff; border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:10px 12px; opacity:0; pointer-events:none; transition:opacity .25s, transform .25s; z-index:200}
    .toast.show{opacity:1; transform:translateX(-50%) translateY(0)}

    @media (max-width: 1024px){
      .nav-center{display:none} .hamb{display:inline-flex}
      .ozet{grid-template-columns:repeat(2,minmax(0,1fr))}
      .col-8,.col-9,.col-10,.col-4,.col-3,.col-2,.col-6,.col-12{grid-column:span 12}
      .modal-icerik{width:96%; padding:12px}
      .hareket-tablo th,.hareket-tablo td{padding:6px 8px; font-size:13px}
    }
    @media (max-width: 820px){
      #tableWrap{overflow-x:auto}
      #hedefTablosu{min-width:980px}
    }
    @media (max-width: 640px){
      .ozet{grid-template-columns:1fr}
      .modal-icerik{font-size:14px}
      .drawer{ left: 20%; }
    }
/* === SAÄ PANEL (AÃ‡IK TEMA) === */
.kf-side{
  display:flex;
  flex-direction:column;
  gap:14px;
  background:#ffffff;
  border:1px solid rgba(15,23,42,.04);
  border-radius:16px;
  box-shadow:0 10px 30px rgba(15,23,42,.04);
  min-width:0;
  overflow:hidden;
}

.kf-side-head{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:8px;
}
.kf-side-head h3{
  margin:0;
  font-size:15.5px;
  color:#0f172a;
}
.kf-side-head p{
  margin:3px 0 0;
  font-size:12px;
  color:#6b7280;
}
.kf-side-refresh{
  width:30px;
  height:30px;
  border:1px solid rgba(148,163,184,.35);
  background:#fff;
  border-radius:999px;
  color:#0f172a;
  cursor:pointer;
  display:flex;
  align-items:center;
  justify-content:center;
  transition:.12s;
}
.kf-side-refresh:hover{
  background:#f3f4f6;
}

/* ÃœST BLOK */
.kf-topline{
  display:flex;
  gap:12px;
  align-items:stretch;
  background:linear-gradient(140deg, #eef5ff 0%, #ffffff 60%);
  border:1px solid rgba(148,163,184,.12);
  border-radius:14px;
  padding:10px 10px 10px;
}
.kf-badge-oran{
  min-width:96px;
  background:#ffffff;
  border:1px solid rgba(148,163,184,.15);
  border-radius:12px;
  display:flex;
  flex-direction:column;
  justify-content:center;
  gap:2px;
  padding:5px 8px 6px;
}
.kf-badge-oran small{
  font-size:11px;
  color:#6b7280;
}
.kf-badge-oran span,
.kf-badge-oran #toplamOran{
  font-size:25px;
  font-weight:800;
  color:#0f172a;
  letter-spacing:-.04em;
}

.kf-topline-right{
  flex:1;
  display:flex;
  flex-direction:column;
  gap:6px;
}
.kf-top-row{
  display:flex;
  justify-content:space-between;
  align-items:center;
  font-size:11.5px;
  color:#6b7280;
}
.kf-top-row strong{
  font-size:16px;
  color:#0f172a;
  font-weight:700;
}
.kf-bar-wrap{
  display:flex;
  flex-direction:column;
  gap:4px;
}
.kf-bar{
  width:100%;
  height:8px;
  background:#e5e7eb;
  border-radius:999px;
  overflow:hidden;
}
.kf-bar > #oranBar{
  width:0%;
  height:100%;
  background:linear-gradient(90deg, #0ea5e9 0%, #22c55e 100%);
  border-radius:999px;
  transition:width .25s ease;
}
.kf-bar-text{
  font-size:11.5px;
  color:#94a3b8;
}

/* ORTA 3â€™LÃœ */
.kf-metrics{
  display:grid;
  grid-template-columns:repeat(3, minmax(0,1fr));
  gap:8px;
}
.kf-metric{
  background:#f8fafc;
  border:1px solid rgba(148,163,184,.12);
  border-radius:12px;
  padding:7px 8px 7px;
  display:flex;
  flex-direction:column;
  gap:3px;
  min-height:68px;
}
.kf-metric .lbl{
  font-size:11px;
  color:#6b7280;
}
.kf-metric .val{
  font-size:17px;
  font-weight:700;
  letter-spacing:-.01em;
  color:#0f172a;
}
.kf-metric .sub{
  font-size:10px;
  color:#94a3b8;
}

/* KURBAN */
.kf-kurban-box{
  background:#f3faf8;
  border:1px solid rgba(34,197,235,.16);
  border-radius:14px;
  padding:10px 10px 9px;
  display:flex;
  flex-direction:column;
  gap:8px;
}
.kf-kurban-head{
  display:flex;
  justify-content:space-between;
  align-items:flex-start;
  gap:8px;
}
.kf-kurban-head h4{
  margin:0;
  font-size:15px;
  display:flex;
  align-items:center;
  gap:4px;
  color:#0f172a;
}
.kf-kurban-head p{
  margin:2px 0 0;
  font-size:11px;
  color:#6b7280;
}
.kf-tag{
  background:#ffffff;
  border:1px solid rgba(14,165,233,.35);
  border-radius:999px;
  padding:3px 10px 4px;
  font-size:10.8px;
  color:#0f172a;
}
.kf-kurban-grid{
  display:grid;
  grid-template-columns:repeat(3, minmax(0,1fr));
  gap:6px;
}
.kf-k-item{
  background:#ffffff;
  border:1px solid rgba(148,163,184,.12);
  border-radius:10px;
  padding:6px 6px 5px;
}
.kf-k-item .lbl{
  font-size:10.5px;
  color:#6b7280;
}
.kf-k-item .val{
  font-size:13.5px;
  font-weight:700;
  color:#0f172a;
}
.kf-k-item.total{
  background:linear-gradient(135deg, #0ea5e9 0%, #22c55e 100%);
  border:none;
  color:#fff;
  box-shadow:0 6px 18px rgba(14,165,233,.35);
}
.kf-k-item.total .lbl{
  color:rgba(255,255,255,.7);
}
.kf-k-item.total .val{
  font-size:15px;
  font-weight:800;
}

@media (max-width:1024px){
  .kf-metrics{ grid-template-columns:repeat(2, minmax(0,1fr)); }
  .kf-kurban-grid{ grid-template-columns:repeat(3, minmax(0,1fr)); }
}
@media (max-width:540px){
  .kf-topline{ flex-direction:column; }
  .kf-badge-oran{ width:100%; flex-direction:row; justify-content:space-between; }
  .kf-metrics{ grid-template-columns:1fr; }
  .kf-kurban-grid{ grid-template-columns:1fr 1fr; }
}

  </style>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="../../js/firebase/firebase-init.js"></script>
</head>
<body>
  <div class="appbar">
    <div class="brand" onclick="location.href='../../panel.html'">
      <img src="../../img/logo.png" alt="logo"><span>KARAAÄAÃ‡ FATÄ°H</span>
    </div>
    <nav class="nav-center"><ul class="nav-list" id="navMain"></ul></nav>
    <div class="nav-right">
      <button class="btn hamb" id="hamburger" title="MenÃ¼">â˜°</button>
      <button class="btn" id="themeToggle" title="Tema: AÃ§Ä±k/Koyu/Otomatik">ğŸŒ— <span id="themeLabel">Auto</span></button>
      <button class="btn" onclick="logout()">Ã‡Ä±kÄ±ÅŸ Yap</button>
    </div>
  </div>

  <aside class="drawer" id="drawer"></aside>

  <main class="container">
    <section class="hero">
      <div>
        <h2><span id="kapsamUst">-</span> GrafiÄŸi</h2>
        <div class="hero-sub">Personelin seÃ§ili ayda yaptÄ±ÄŸÄ±;</div>
        <div class="hero-sub1">toplam teberru, tahsilat, kurban (kk/bb) + seÃ§ili kategorideki hedef/temin â†’ ulaÅŸma nispeti.</div>
        <div class="mini">
          <span class="pill">ğŸ•’ Son GÃ¼ncelleme: <b id="guncellemeZamani">yÃ¼kleniyorâ€¦</b></span>
          <span class="pill">ğŸ“… Kapsam: <b id="kapsamPill">-</b></span>
          <span class="pill">Versiyon: <b>1.0.0</b></span>
          <button class="pill" id="ekranButonu" style="cursor:pointer; border:1px solid var(--stroke); background:var(--pill); font-size:12px; padding:6px 10px; border-radius:999px; color:var(--text);">Ekran: <b id="ekranAdi">Hedef</b></button>
        </div>
      </div>
    </section>

    <div class="grid">
      <div class="card col-9">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px">
          <h3 style="margin:0">Tablo</h3>
          <label class="personel-toggle" title="Personel kolonunu gÃ¶ster/gizle">
            <input type="checkbox" id="personelToggle" checked>
            <span class="toggle-slider"></span>
            <span class="toggle-label">Personel</span>
          </label>
        </div>

        <div class="row-grid" style="margin-bottom:12px">
          <div class="cell">
            <label for="kategoriSecimi">Kategori</label>
            <select id="kategoriSecimi">
              <option value="TÃ¼mÃ¼">TÃ¼mÃ¼</option>
              <option value="Kitap KampanyasÄ±">Kitap KampanyasÄ±</option>
              <option value="EylÃ¼l Kermesi">EylÃ¼l Kermesi</option>
              <option value="AraÃ§">Kurs ArabasÄ±</option>
              <option value="Talebeye Ä°kram">Talebeye Ä°kram</option>
              <option value="Mevlid Kandili">Mevlid Kandili</option>
            </select>
          </div>
          <div class="cell">
            <label for="filtreSecimi">Filtre</label>
            <select id="filtreSecimi">
              <option value="oran-azalan" selected>UlaÅŸma Nispeti (Azalan)</option>
              <option value="oran-artan">UlaÅŸma Nispeti (Artan)</option>
              <option value="personel-az">Personel (A â†’ Z)</option>
              <option value="personel-za">Personel (Z â†’ A)</option>
              <option value="hedef-artan">Hedef (Artan)</option>
              <option value="hedef-azalan">Hedef (Azalan)</option>
              <option value="temin-artan">Temin (Artan)</option>
              <option value="temin-azalan">Temin (Azalan)</option>
              <option value="teberru-artan">Teberru (Artan)</option>
              <option value="teberru-azalan">Teberru (Azalan)</option>
              <option value="tahsilat-artan">Tahsilat (Artan)</option>
              <option value="tahsilat-azalan">Tahsilat (Azalan)</option>
            </select>
          </div>
          <div class="cell">
            <label for="yilSec">YÄ±l</label>
            <select id="yilSec"></select>
          </div>
          <div class="cell">
            <label for="aySec">Ay</label>
            <select id="aySec">
              <option value="">-</option>
              <option value="1">Ocak</option><option value="2">Åubat</option><option value="3">Mart</option>
              <option value="4">Nisan</option><option value="5">MayÄ±s</option><option value="6">Haziran</option>
              <option value="7">Temmuz</option><option value="8">AÄŸustos</option><option value="9">EylÃ¼l</option>
              <option value="10">Ekim</option><option value="11">KasÄ±m</option><option value="12">AralÄ±k</option>
            </select>
          </div>
          <div class="right-note">SatÄ±ra tÄ±klayÄ±nca detay aÃ§Ä±lÄ±r.</div>
        </div>

        <div id="tableWrap">
          <table id="hedefTablosu">
            <colgroup id="tabloColgroup">
              <col class="c-personel">
              <col class="c-mid">
              <col class="c-mid">
              <col class="c-kurban">
              <col class="c-kurban">
              <col class="c-mid">
              <col class="c-mid">
              <col class="c-oran">
            </colgroup>
            <thead>
              <tr id="tabloBasliklari">
                <th>Personel</th>
                <th>Teberru</th>
                <th>Tahsilat</th>
                <th>Kurban (KK)</th>
                <th>Kurban (BB)</th>
                <th>Hedef</th>
                <th>Temin Edilen</th>
                <th>UlaÅŸma Nispeti (%)</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div class="under-note" id="altNot">-</div>
        </div>
      </div>

<div class="card col-3 kf-side">
  <div class="kf-side-head">
    <div>
      <h3>Ã–zet</h3>
      <p id="ozetAltMetin">SeÃ§ili ay / kategori</p>
    </div>
    <button class="kf-side-refresh" onclick="aboneOl()" title="Yenile">âŸ³</button>
  </div>

  <!-- ÃœST: ULAÅMA ORANI + TEMÄ°N/HEDEF -->
  <div class="kf-topline">
    <div class="kf-badge-oran">
      <small>UlaÅŸma</small>
      <span id="toplamOran">%0</span>
    </div>
    <div class="kf-topline-right">
      <div class="kf-top-row">
        <span>Temin</span>
        <strong id="toplamTemin">â‚º0</strong>
      </div>
      <div class="kf-top-row">
        <span>Hedef</span>
        <strong id="toplamHedef">â‚º0</strong>
      </div>
      <div class="kf-bar-wrap">
        <div class="kf-bar">
          <div id="oranBar"></div>
        </div>
        <span class="kf-bar-text">Genel ulaÅŸma oranÄ±</span>
      </div>
    </div>
  </div>

  <!-- ORTA: METRÄ°KLER (Dinamik) -->
  <div class="kf-metrics" id="ozetMetrikler">
    <!-- Hedef modu -->
    <div class="kf-metric">
      <span class="lbl">Teberru</span>
      <span class="val" id="toplamTeberru">â‚º0</span>
      <span class="sub">Bu ay yapÄ±lan</span>
    </div>
    <div class="kf-metric">
      <span class="lbl">Tahsilat</span>
      <span class="val" id="toplamTahsilat">â‚º0</span>
      <span class="sub">TÃ¼m tahsilatlar</span>
    </div>
    <div class="kf-metric">
      <span class="lbl">Temin / Hedef</span>
      <span class="val" id="toplamTeminDisplay">â‚º0</span>
      <span class="sub">GerÃ§ekleÅŸen</span>
    </div>
    <!-- Ramazan-Ä± Åerif modu (gizli) -->
    <div class="kf-metric" id="ozetIftar" style="display:none">
      <span class="lbl">Ä°ftar</span>
      <span class="val" id="toplamIftar">â‚º0</span>
      <span class="sub">Ä°ftar toplamÄ±</span>
    </div>
    <div class="kf-metric" id="ozetSahur" style="display:none">
      <span class="lbl">Sahur</span>
      <span class="val" id="toplamSahur">â‚º0</span>
      <span class="sub">Sahur toplamÄ±</span>
    </div>
    <div class="kf-metric" id="ozetTaahhut" style="display:none">
      <span class="lbl">TaahhÃ¼t</span>
      <span class="val" id="toplamTaahhut">â‚º0</span>
      <span class="sub">TaahhÃ¼t toplamÄ±</span>
    </div>
  </div>

  <!-- ALT: KURBAN -->
  <div class="kf-kurban-box">
    <div class="kf-kurban-head">
      <div>
        <h4>ğŸ‘ Kurban</h4>
        <p>Bu kapsamda toplanan adetler</p>
      </div>
      <span class="kf-tag" id="kapsamPill2">SeÃ§ili ay</span>
    </div>
    <div class="kf-kurban-grid">
      <div class="kf-k-item">
        <span class="lbl">KÃ¼Ã§Ã¼kbaÅŸ</span>
        <span class="val" id="toplamKurbanKk">0 adet</span>
      </div>
      <div class="kf-k-item">
        <span class="lbl">BÃ¼yÃ¼kbaÅŸ</span>
        <span class="val" id="toplamKurbanBb">0 adet</span>
      </div>
      <div class="kf-k-item total">
        <span class="lbl">Toplam</span>
        <span class="val" id="toplamKurbanGenel">0 adet</span>
      </div>
    </div>
  </div>
</div>

  </main>

  <div class="modal-arka" id="detayModal">
    <div class="modal-icerik">
      <div class="modal-baslik">
        <h3 id="modalBaslik">Detay</h3>
        <button class="modal-kapat" id="modalKapat">Kapat</button>
      </div>

      <div class="mini" style="margin-bottom:10px">
        <span class="pill">ğŸ“… <b id="modalKapsamEtiketi">-</b></span>
        <span class="pill">ğŸ·ï¸ <b id="modalKategoriEtiketi">-</b></span>
      </div>

      <div class="ozet">
        <div class="kpi"><div><div class="sub">Teberru</div><div class="val" id="m_teberruTop">â‚º0</div></div></div>
        <div class="kpi"><div><div class="sub">Tahsilat</div><div class="val" id="m_tahsilatTop">â‚º0</div></div></div>
        <div class="kpi"><div><div class="sub">Hedef Toplam</div><div class="val" id="m_hedefTop">â‚º0</div></div></div>
        <div class="kpi"><div><div class="sub">Hedef Temini</div><div class="val" id="m_hedefTeminTop">â‚º0</div></div></div>
        <div class="kpi"><div><div class="sub">UlaÅŸma Nispeti</div><div class="val" id="m_oranTop">%0</div></div></div>
      </div>

      <div class="hareket-kap">
        <table class="hareket-tablo" id="m_hareketTablo">
          <thead>
            <tr>
              <th>
                <div class="sort-head">Tarih
                  <span class="sort-arrows">
                    <span data-key="t" data-dir="asc">â†‘</span>
                    <span data-key="t" data-dir="desc">â­£</span>
                  </span>
                </div>
              </th>
              <th>
                <div class="sort-head">Ad Soyad
                  <span class="sort-arrows">
                    <span data-key="ad" data-dir="asc">â†‘</span>
                    <span data-key="ad" data-dir="desc">â­£</span>
                  </span>
                </div>
              </th>
              <th>
                <div class="sort-head">Miktar (â‚º / Adet)
                  <span class="sort-arrows">
                    <span data-key="miktar" data-dir="asc">â†‘</span>
                    <span data-key="miktar" data-dir="desc">â­£</span>
                  </span>
                </div>
              </th>
              <th>
                <div class="sort-head">TÃ¼r
                  <span class="sort-arrows">
                    <span data-key="tur" data-dir="asc">â†‘</span>
                    <span data-key="tur" data-dir="desc">â­£</span>
                  </span>
                </div>
              </th>
              <th>
                <div class="sort-head">AÃ§Ä±klama
                  <span class="sort-arrows">
                    <span data-key="aciklama" data-dir="asc">â†‘</span>
                    <span data-key="aciklama" data-dir="desc">â­£</span>
                  </span>
                </div>
              </th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    (function(){
      const root=document.documentElement, btn=document.getElementById('themeToggle');
      const lab1=document.getElementById('themeLabel');
      const sysDark=()=>window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches;
      function apply(mode){
        localStorage.setItem('kf_theme',mode);
        const eff=(mode==='auto')?(sysDark()?'dark':'light'):mode;
        root.setAttribute('data-theme',eff);
        const txt=mode[0].toUpperCase()+mode.slice(1);
        if(lab1) lab1.textContent=txt;
        const icon=mode==='dark'?'ğŸŒ™':mode==='light'?'â˜€ï¸':'ğŸŒ—';
        btn.innerHTML=icon+' <span id="themeLabel">'+txt+'</span>';
      }
      apply(localStorage.getItem('kf_theme')||'auto');
      btn.addEventListener('click',()=>{const cur=localStorage.getItem('kf_theme')||'auto'; apply(cur==='dark'?'light':(cur==='light'?'auto':'dark'));});
      if(window.matchMedia){ const m=window.matchMedia('(prefers-color-scheme: dark)'); m.addEventListener?.('change',()=>{ if((localStorage.getItem('kf_theme')||'auto')==='auto') apply('auto'); }); }
    })();

    const db=firebase.firestore(), auth=firebase.auth();
    function showToast(msg){const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); clearTimeout(window.__to); window.__to=setTimeout(()=>t.classList.remove('show'),3000);}

    function logout(){ auth.signOut().then(()=>location.replace('../../index.html')).catch(()=>location.replace('../../index.html')); } window.logout=logout;

    let CURRENT_ALLOW=new Set(), CURRENT_DENY=new Set();
    const norm=(s)=>String(s||'').trim().toLowerCase();
    const PANEL_ICON={ 'Admin':'ğŸ›ï¸','Talebe':'ğŸ“˜','Personel':'ğŸ‘¤','Muhasebe':'ğŸ’°','Kermes':'ğŸª','Nehari':'ğŸ•Œ','Sistem AyarlarÄ±':'âš™ï¸' };
    function normalizePath(p){
      if(!p || p === '#') return '#';
      // HTTP/HTTPS URL'leri olduÄŸu gibi bÄ±rak
      if(/^https?:\/\//i.test(p)) return p;
      if(p.startsWith('//')) return p;
      // Zaten relative path'ler (../ veya ./ ile baÅŸlayan) olduÄŸu gibi bÄ±rak
      if(p.startsWith('../') || p.startsWith('./')) return p;
      
      // Mevcut dosyanÄ±n konumuna gÃ¶re relative hale getir
      const currentPath = location.pathname;
      const currentDir = currentPath.substring(0, currentPath.lastIndexOf('/'));
      // Mevcut dizin seviyesini hesapla (kaÃ§ seviye yukarÄ± Ã§Ä±kmalÄ±yÄ±z)
      const currentDepth = currentDir.split('/').filter(x => x).length;
      
      // Root'a dÃ¶nmek iÃ§in ../ sayÄ±sÄ±
      const upLevels = currentDepth > 0 ? '../'.repeat(currentDepth) : '';
      
      // Path'i temizle: / ile baÅŸlÄ±yorsa kaldÄ±r, yoksa olduÄŸu gibi kullan
      const targetPath = p.startsWith('/') ? p.substring(1) : p;
      
      return upLevels + targetPath;
    }

    async function fetchPanels(allowSet, denySet){
      const res=[]; 
      try{
        const snap=await db.collection('sayfa_manifesti').get();
        snap.forEach(doc=>{
          const d=doc.data()||{}, id=doc.id, title=d.title||id;
          const grant = allowSet.has(norm(id)) || allowSet.has(norm(title));
          let pages = Array.isArray(d.pages)? d.pages : [];
          pages = pages.filter(pg=>{
            const key=norm(pg.key||pg.title||''); const pageGrant=allowSet.has(key); const denied=denySet.has(key);
            return !denied && (grant || pageGrant);
          }).map(pg=>({ baslik: pg.title || pg.key || 'Sayfa', url: normalizePath(pg.path || pg.url || '#'), key: pg.key || pg.title || '', sira: typeof pg.order==='number'? pg.order:9999 }))
          .sort((a,b)=>a.sira-b.sira);
          if(pages.length) res.push({id, baslik:title, sira: typeof d.order==='number'? d.order:9999, pages});
        });
        res.sort((a,b)=>a.sira-b.sira);
      }catch(e){ console.error('sayfa_manifesti okunamadÄ±:', e); showToast('MenÃ¼ manifesti yÃ¼klenemedi.'); }
      return res;
    }
    function renderNav(panels){
      const ul=document.getElementById('navMain'), drawer=document.getElementById('drawer');
      ul.innerHTML=''; drawer.innerHTML='';
      if(!panels.length){
        ul.innerHTML='<li class="nav-item"><div class="nav-btn">HiÃ§ panel yok</div></li>';
        drawer.innerHTML='<div style="color:var(--muted);padding:8px">HiÃ§ panel bulunamadÄ±</div>';
        return;
      }
      (function initDrawerToggle(){
        const hamb=document.getElementById('hamburger'); if(!hamb||!drawer) return;
        if(hamb.dataset.inited==='1') return; hamb.dataset.inited='1';
        hamb.addEventListener('click',(e)=>{e.stopPropagation(); drawer.classList.toggle('open');});
        document.addEventListener('click',(e)=>{ const inside=drawer.contains(e.target)||hamb.contains(e.target); if(!inside) drawer.classList.remove('open'); });
        drawer.addEventListener('click',(e)=>{ const a=e.target.closest('a'); if(a) drawer.classList.remove('open'); });
        document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') drawer.classList.remove('open'); });
      })();
      panels.forEach(p=>{
        const li=document.createElement('li'); li.className='nav-item';
        li.innerHTML=`<div class="nav-btn">${p.baslik} <span class="caret">â–¾</span></div>`;
        const dd=document.createElement('div'); dd.className='dropdown';
        (p.pages||[]).forEach(pg=>{
          const a=document.createElement('a'); a.href=normalizePath(pg.url); a.textContent=pg.baslik;
          a.dataset.key=pg.key||pg.baslik; a.dataset.panel=p.id; a.dataset.panelTitle=p.baslik;
          dd.appendChild(a);
        });
        li.appendChild(dd);
        li.querySelector('.nav-btn').addEventListener('click',(e)=>{
          e.stopPropagation();
          ul.querySelectorAll('.nav-item').forEach(x=>{ if(x!==li) x.classList.remove('open'); });
          li.classList.toggle('open');
        });
        ul.appendChild(li);
      });
      document.addEventListener('click',(e)=>{ if(!ul.contains(e.target)) ul.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('open')); });

      panels.forEach(p=>{
        const h=document.createElement('div'); h.className='panel-title'; h.textContent=p.baslik; drawer.appendChild(h);
        (p.pages||[]).forEach(pg=>{
          const a=document.createElement('a'); a.href=normalizePath(pg.url); a.textContent=pg.baslik;
          a.dataset.key=pg.key||pg.baslik; a.dataset.panel=p.id; a.dataset.panelTitle=p.baslik;
          drawer.appendChild(a);
        });
      });
    }
    document.addEventListener('click',(e)=>{
      const a=e.target.closest('a[data-key]'); if(!a) return;
      const key=norm(a.dataset.key), pnl=norm(a.dataset.panel||''), pnlT=norm(a.dataset.panelTitle||'');
      if(CURRENT_DENY.has(key)){e.preventDefault(); showToast('Bu sayfa iÃ§in yetkiniz yok.'); return;}
      const allowed=CURRENT_ALLOW.has(key)||CURRENT_ALLOW.has(pnl)||CURRENT_ALLOW.has(pnlT);
      if(!allowed){e.preventDefault(); showToast('Bu sayfa iÃ§in yetkiniz yok.');}
    });

    const kategoriSecimi=document.getElementById("kategoriSecimi");
    const filtreSecimi  =document.getElementById("filtreSecimi");
    const tabloBody     =document.querySelector("#hedefTablosu tbody");

    const toplamTeberruEl=document.getElementById("toplamTeberru");
    const toplamTahsilatEl=document.getElementById("toplamTahsilat");
    const toplamHedefEl =document.getElementById("toplamHedef");
    const toplamTeminEl =document.getElementById("toplamTemin");
    const toplamOranEl  =document.getElementById("toplamOran");
    const oranBar       =document.getElementById("oranBar");
    const guncellemeEl  =document.getElementById("guncellemeZamani");
    const kapsamUst     =document.getElementById("kapsamUst");
    const kapsamPill    =document.getElementById("kapsamPill");
    const altNot        =document.getElementById("altNot");
    const ekranButonu   =document.getElementById("ekranButonu");
    const ekranAdi      =document.getElementById("ekranAdi");

    const yilSec = document.getElementById('yilSec');
    const aySec  = document.getElementById('aySec');

    // Ekran modu state (Hedef veya Ramazan-Ä± Åerif)
    let ekranModu = localStorage.getItem('hedefGrafik_ekranModu') || 'Hedef';
    if(ekranAdi) ekranAdi.textContent = ekranModu;

    // Personel kolonu gÃ¶ster/gizle
    const personelToggle = document.getElementById('personelToggle');
    let personelGoster = localStorage.getItem('hedefGrafik_personelGoster') !== 'false';
    if(personelToggle) personelToggle.checked = personelGoster;

    function personelKolonunuGuncelle(){
      const goster = personelToggle ? personelToggle.checked : true;
      const thead = document.querySelector('#hedefTablosu thead tr');
      const tbodyRows = document.querySelectorAll('#hedefTablosu tbody tr');
      const colgroup = document.querySelector('#tabloColgroup col:first-child');
      
      if(thead){
        const personelTh = thead.querySelector('th:first-child');
        if(personelTh){
          personelTh.style.display = goster ? '' : 'none';
        }
      }
      
      tbodyRows.forEach(row=>{
        const personelTd = row.querySelector('td:first-child');
        if(personelTd){
          personelTd.style.display = goster ? '' : 'none';
        }
      });
      
      if(colgroup){
        colgroup.style.display = goster ? '' : 'none';
      }
    }

    if(personelToggle){
      personelToggle.addEventListener('change',()=>{
        personelGoster = personelToggle.checked;
        localStorage.setItem('hedefGrafik_personelGoster', personelGoster);
        personelKolonunuGuncelle();
      });
      // Ä°lk yÃ¼klemede uygula
      setTimeout(()=>personelKolonunuGuncelle(), 100);
    }

    const modalArka=document.getElementById('detayModal');
    const modalKapat=document.getElementById('modalKapat');
    const m_hareketTabloBody=document.querySelector('#m_hareketTablo tbody');
    const m_baslik=document.getElementById('modalBaslik');
    const m_kapsamEtik=document.getElementById('modalKapsamEtiketi');
    const m_kategoriEtik=document.getElementById('modalKategoriEtiketi');
    const m_hedefTop=document.getElementById('m_hedefTop');
    const m_hedefTeminTop=document.getElementById('m_hedefTeminTop');
    const m_teberruTop=document.getElementById('m_teberruTop');
    const m_tahsilatTop=document.getElementById('m_tahsilatTop');
    const m_oranTop=document.getElementById('m_oranTop');

    modalKapat.addEventListener('click',()=> modalArka.style.display='none');
    modalArka.addEventListener('click',(e)=>{ if(e.target===modalArka) modalArka.style.display='none'; });

    function toNum(v){ if(typeof v==='number') return v; if(typeof v==='string'){ const n=Number(v.replace(/\./g,'').replace(',', '.')); return isNaN(n)?0:n; } return 0; }
    const tidy=s=>(s||'').toString().trim().replace(/\s+/g,' ');
    function toTitleTR(s){
      const t=tidy(s).toLocaleLowerCase('tr-TR');
      return t.replace(/(^|[\s\-_/\\.])([\p{L}\p{M}])/gu,(m,p1,p2)=>p1+p2.toLocaleUpperCase('tr-TR'));
    }
    const ALIASES = new Map([
      ['keramettin kocaoÄŸlu','Kerem KocaoÄŸlu'],
      ['kerem kocaoÄŸlu','Kerem KocaoÄŸlu'],
    ]);
    function canonName(s){
      const t = toTitleTR(s);
      const key = t.toLocaleLowerCase('tr-TR');
      return ALIASES.get(key) || t;
    }

    function ayAdi(n){const map=['','Ocak','Åubat','Mart','Nisan','MayÄ±s','Haziran','Temmuz','AÄŸustos','EylÃ¼l','Ekim','KasÄ±m','AralÄ±k']; return map[Number(n)||0]||'-';}
    function localRangeFor(year, month){ if(!year) return {start:null,end:null}; if(!month){ return { start:new Date(year,0,1,0,0,0), end:new Date(Number(year)+1,0,1,0,0,0) }; } return { start:new Date(year,month-1,1,0,0,0), end:new Date(year,month,1,0,0,0) }; }
    function kapsamMetni(year, month, kategori){ const parcaAy = month? `${ayAdi(month)} ${year}` : `${year} (tÃ¼m yÄ±l)`; const parcaKat = kategori==='TÃ¼mÃ¼' ? 'TÃ¼m Kategoriler' : kategori; return `${parcaKat} â€¢ ${parcaAy}`; }
    function kapsambaslikMetni(year, month, kategori){ const parcaAy = month? `${ayAdi(month)} ${year}` : `${year} (tÃ¼m yÄ±l)`; const parcaKat = kategori==='TÃ¼mÃ¼' ? 'TÃ¼m Kategoriler' : kategori; return `${parcaKat} â€¢ ${parcaAy}`; }

    function getWhen(d){
      if (d?.tarih?.toDate) return d.tarih.toDate();
      if (d?.tarih){ const x=new Date(d.tarih); if(!isNaN(x)) return x; }
      if (d?.createdAt?.toDate) return d.createdAt.toDate();
      if (d?.createdAt){ const x=new Date(d.createdAt); if(!isNaN(x)) return x; }
      return null;
    }

    let veriTablosu=[];
    let unsubHedef=null, unsubTemin=null, unsubTeb=null, unsubTah=null, unsubKurban=null, unsubIftar=null, unsubSahur=null, unsubTaahhut=null, unsubTeberruRamazan=null, unsubTaahhutRamazan=null, unsubRamazanHedef=null;
    let cacheTeminHedef={}, cacheTeberru={}, cacheTahsilat={}, sonHedefMap={};
    let iftarMap={}, sahurMap={}, taahhutMap={};
    let maxUpdateTs=0;

    function tabloBasliklariniGuncelle(){
      const thead = document.getElementById('tabloBasliklari');
      const colgroup = document.getElementById('tabloColgroup');
      if(!thead || !colgroup) return;

      if(ekranModu === 'Ramazan-Ä± Åerif'){
        colgroup.innerHTML = `
          <col class="c-personel">
          <col class="c-mid">
          <col class="c-mid">
          <col class="c-mid">
          <col class="c-mid">
          <col class="c-mid">
          <col class="c-mid">
          <col class="c-oran">
          <col class="c-kurban">
          <col class="c-kurban">
        `;
        thead.innerHTML = `
          <th>Personel</th>
          <th>Hedef</th>
          <th>Ä°ftar</th>
          <th>Sahur</th>
          <th>TaahhÃ¼t</th>
          <th>Teberru</th>
          <th>Toplam Temin Edilen</th>
          <th>UlaÅŸma Nispeti (%)</th>
          <th>Kurban (KK)</th>
          <th>Kurban (BB)</th>
        `;
      } else {
        colgroup.innerHTML = `
          <col class="c-personel">
          <col class="c-mid">
          <col class="c-mid">
          <col class="c-kurban">
          <col class="c-kurban">
          <col class="c-mid">
          <col class="c-mid">
          <col class="c-oran">
        `;
        thead.innerHTML = `
          <th>Personel</th>
          <th>Teberru</th>
          <th>Tahsilat</th>
          <th>Kurban (KK)</th>
          <th>Kurban (BB)</th>
          <th>Hedef</th>
          <th>Temin Edilen</th>
          <th>UlaÅŸma Nispeti (%)</th>
        `;
      }
      // Personel kolonu durumunu uygula
      setTimeout(()=>personelKolonunuGuncelle(), 50);
    }

    function ozetMetrikleriniGuncelle(){
      const teberruEl = document.getElementById('toplamTeberru');
      const tahsilatEl = document.getElementById('toplamTahsilat');
      const teminDisplayEl = document.getElementById('toplamTeminDisplay');
      const iftarEl = document.getElementById('toplamIftar');
      const sahurEl = document.getElementById('toplamSahur');
      const taahhutEl = document.getElementById('toplamTaahhut');
      const ozetIftar = document.getElementById('ozetIftar');
      const ozetSahur = document.getElementById('ozetSahur');
      const ozetTaahhut = document.getElementById('ozetTaahhut');

      if(ekranModu === 'Ramazan-Ä± Åerif'){
        // Ramazan-Ä± Åerif modunda Ä°ftar-Sahur-TaahhÃ¼t gÃ¶ster
        if(teberruEl && teberruEl.parentElement) teberruEl.parentElement.style.display = 'none';
        if(tahsilatEl && tahsilatEl.parentElement) tahsilatEl.parentElement.style.display = 'none';
        if(teminDisplayEl && teminDisplayEl.parentElement) teminDisplayEl.parentElement.style.display = 'none';
        if(ozetIftar) ozetIftar.style.display = 'flex';
        if(ozetSahur) ozetSahur.style.display = 'flex';
        if(ozetTaahhut) ozetTaahhut.style.display = 'flex';
      } else {
        // Hedef modunda Teberru-Tahsilat-Temin gÃ¶ster
        if(teberruEl && teberruEl.parentElement) teberruEl.parentElement.style.display = 'flex';
        if(tahsilatEl && tahsilatEl.parentElement) tahsilatEl.parentElement.style.display = 'flex';
        if(teminDisplayEl && teminDisplayEl.parentElement) teminDisplayEl.parentElement.style.display = 'flex';
        if(ozetIftar) ozetIftar.style.display = 'none';
        if(ozetSahur) ozetSahur.style.display = 'none';
        if(ozetTaahhut) ozetTaahhut.style.display = 'none';
      }
    }

    function tabloyuYenidenYaz(veriler){
      tabloBody.innerHTML="";
      const fmtPara = (n) => Math.round(n || 0).toLocaleString("tr-TR", {minimumFractionDigits: 0, maximumFractionDigits: 0});
      
      veriler.forEach(p=>{
        const tr=document.createElement("tr");

        const tdPersonel=document.createElement("td"); tdPersonel.className='wrap';
        tdPersonel.textContent=(p.oran>=100? 'â­ ' : '') + p.personel;

        if(ekranModu === 'Ramazan-Ä± Åerif'){
          const tdHedef=document.createElement("td"); tdHedef.textContent=`${fmtPara(p.hedef)} â‚º`;
          const tdIftar=document.createElement("td"); tdIftar.textContent=`${fmtPara(p.iftar||0)} â‚º`;
          const tdSahur=document.createElement("td"); tdSahur.textContent=`${fmtPara(p.sahur||0)} â‚º`;
          const tdTaahhut=document.createElement("td"); tdTaahhut.textContent=`${fmtPara(p.taahhut||0)} â‚º`;
          const tdTeberru=document.createElement("td"); tdTeberru.textContent=`${fmtPara(p.teberru||0)} â‚º`;
          const toplamTemin = (p.iftar||0) + (p.sahur||0) + (p.taahhut||0) + (p.teberru||0);
          const tdToplamTemin=document.createElement("td"); tdToplamTemin.textContent=`${fmtPara(toplamTemin)} â‚º`;

          const tdOran=document.createElement("td");
          const prog=document.createElement('div'); prog.className='progress';
          const fill=document.createElement('div'); fill.className='fill';
          const lab=document.createElement('div'); lab.className='label';
          const bar=Math.max(0, Math.min(100, p.oran));
          fill.style.width=bar+'%';
          if (p.oran>=100) fill.classList.add('ok');
          const oranStr = Number(p.oran).toFixed(2).replace('.', ',');
          let fullMsg=`%${oranStr}`, shortMsg=`%${oranStr}`;
          if (p.oran>=100 && p.oran<100.01){ fullMsg='Hedefinize ulaÅŸtÄ±nÄ±z'; shortMsg='Hedefinize ulaÅŸtÄ±nÄ±z'; }
          if (p.oran>100){ fullMsg='Hedefinizi geÃ§tiniz'; shortMsg='Hedefinizi geÃ§tiniz'; }
          lab.textContent=shortMsg; lab.title=fullMsg;
          prog.appendChild(fill); prog.appendChild(lab); tdOran.appendChild(prog);

          const tdKk=document.createElement("td"); tdKk.textContent=p.kurbanKk||0;
          const tdBb=document.createElement("td"); tdBb.textContent=p.kurbanBb||0;

          tr.append(tdPersonel, tdHedef, tdIftar, tdSahur, tdTaahhut, tdTeberru, tdToplamTemin, tdOran, tdKk, tdBb);
        } else {
          const tdTeberru=document.createElement("td"); tdTeberru.textContent=`${fmtPara(p.teberru)} â‚º`;
          const tdTahsilat=document.createElement("td"); tdTahsilat.textContent=`${fmtPara(p.tahsilat)} â‚º`;
          const tdKk=document.createElement("td"); tdKk.textContent=p.kurbanKk||0;
          const tdBb=document.createElement("td"); tdBb.textContent=p.kurbanBb||0;
          const tdHedef=document.createElement("td"); tdHedef.textContent=`${fmtPara(p.hedef)} â‚º`;
          const tdTemin=document.createElement("td"); tdTemin.textContent=`${fmtPara(p.teminHedef)} â‚º`;

          const tdOran=document.createElement("td");
          const prog=document.createElement('div'); prog.className='progress';
          const fill=document.createElement('div'); fill.className='fill';
          const lab=document.createElement('div'); lab.className='label';
          const bar=Math.max(0, Math.min(100, p.oran));
          fill.style.width=bar+'%';
          if (p.oran>=100) fill.classList.add('ok');
          const oranStr = Number(p.oran).toFixed(2).replace('.', ',');
          let fullMsg=`%${oranStr}`, shortMsg=`%${oranStr}`;
          if (p.oran>=100 && p.oran<100.01){ fullMsg='Hedefinize ulaÅŸtÄ±nÄ±z'; shortMsg='Hedefinize ulaÅŸtÄ±nÄ±z'; }
          if (p.oran>100){ fullMsg='Hedefinizi geÃ§tiniz'; shortMsg='Hedefinizi geÃ§tiniz'; }
          lab.textContent=shortMsg; lab.title=fullMsg;
          prog.appendChild(fill); prog.appendChild(lab); tdOran.appendChild(prog);

          tr.append(tdPersonel, tdTeberru, tdTahsilat, tdKk, tdBb, tdHedef, tdTemin, tdOran);
        }
        
        tr.addEventListener('click',()=>acDetayModal(p.personel));
        tabloBody.appendChild(tr);
      });
      // Personel kolonu durumunu uygula
      setTimeout(()=>personelKolonunuGuncelle(), 50);
    }

    function uygulaFiltre(){
      const f=filtreSecimi.value; let d=[...veriTablosu];
      const by=(k)=> (a,b)=>a[k]-b[k];
      switch(f){
        case "personel-az": d.sort((a,b)=>a.personel.localeCompare(b.personel,'tr')) ; break;
        case "personel-za": d.sort((a,b)=>b.personel.localeCompare(a.personel,'tr')) ; break;
        case "hedef-artan": d.sort(by('hedef')); break;
        case "hedef-azalan": d.sort((a,b)=>b.hedef-a.hedef); break;
        case "temin-artan": 
          if(ekranModu === 'Ramazan-Ä± Åerif'){
            d.sort((a,b)=>(a.toplamTemin||0)-(b.toplamTemin||0));
          } else {
            d.sort(by('teminHedef'));
          }
          break;
        case "temin-azalan": 
          if(ekranModu === 'Ramazan-Ä± Åerif'){
            d.sort((a,b)=>(b.toplamTemin||0)-(a.toplamTemin||0));
          } else {
            d.sort((a,b)=>b.teminHedef-a.teminHedef);
          }
          break;
        case "teberru-artan": d.sort(by('teberru')); break;
        case "teberru-azalan": d.sort((a,b)=>b.teberru-a.teberru); break;
        case "tahsilat-artan": d.sort(by('tahsilat')); break;
        case "tahsilat-azalan": d.sort((a,b)=>b.tahsilat-a.tahsilat); break;
        case "oran-artan": d.sort(by('oran')); break;
        case "oran-azalan":
        default: d.sort((a,b)=>b.oran-a.oran); break;
      }
      tabloyuYenidenYaz(d);
    }

    function toplamlariGuncelle(){
      const fmtPara = (n) => Math.round(n || 0).toLocaleString("tr-TR", {minimumFractionDigits: 0, maximumFractionDigits: 0});
      
      if(ekranModu === 'Ramazan-Ä± Åerif'){
        const sumHedef    = veriTablosu.reduce((s,x)=>s + (x.hedef     || 0), 0);
        const sumIftar    = veriTablosu.reduce((s,x)=>s + (x.iftar      || 0), 0);
        const sumSahur    = veriTablosu.reduce((s,x)=>s + (x.sahur      || 0), 0);
        const sumTaahhut  = veriTablosu.reduce((s,x)=>s + (x.taahhut    || 0), 0);
        const sumTeberru  = veriTablosu.reduce((s,x)=>s + (x.teberru   || 0), 0);
        const sumToplamTemin = sumIftar + sumSahur + sumTaahhut + sumTeberru;
        
        const sumKk       = veriTablosu.reduce((s,x)=>s + (x.kurbanKk  || 0), 0);
        const sumBb       = veriTablosu.reduce((s,x)=>s + (x.kurbanBb  || 0), 0);
        const sumKurban   = sumKk + sumBb;

        const oran = sumHedef>0 ? (sumToplamTemin/sumHedef)*100 : 0;
        const oranStr = Number(oran).toFixed(2).replace('.', ',');

        toplamHedefEl.textContent    = `â‚º${fmtPara(sumHedef)}`;
        toplamTeminEl.textContent    = `â‚º${fmtPara(sumToplamTemin)}`;
        toplamOranEl.textContent     = `%${oranStr}`;
        oranBar.style.width          = Math.max(0, Math.min(100, oran)) + '%';

        const ttd = document.getElementById('toplamTeminDisplay');
        if (ttd) ttd.textContent = `â‚º${fmtPara(sumToplamTemin)}`;

        toplamTeberruEl.textContent  = `â‚º${fmtPara(sumTeberru)}`;
        toplamTahsilatEl.textContent = `â‚º${fmtPara(sumIftar + sumSahur + sumTaahhut)}`;

        // Ä°ftar-Sahur-TaahhÃ¼t metriklerini gÃ¼ncelle
        const iftarEl = document.getElementById('toplamIftar');
        const sahurEl = document.getElementById('toplamSahur');
        const taahhutEl = document.getElementById('toplamTaahhut');
        if(iftarEl) iftarEl.textContent = `â‚º${fmtPara(sumIftar)}`;
        if(sahurEl) sahurEl.textContent = `â‚º${fmtPara(sumSahur)}`;
        if(taahhutEl) taahhutEl.textContent = `â‚º${fmtPara(sumTaahhut)}`;

        const kkEl = document.getElementById('toplamKurbanKk');
        const bbEl = document.getElementById('toplamKurbanBb');
        const gnEl = document.getElementById('toplamKurbanGenel');
        if(kkEl) kkEl.textContent = `${sumKk.toLocaleString('tr-TR')} adet`;
        if(bbEl) bbEl.textContent = `${sumBb.toLocaleString('tr-TR')} adet`;
        if(gnEl) gnEl.textContent = `${sumKurban.toLocaleString('tr-TR')} adet`;
      } else {
        const sumTeberru  = veriTablosu.reduce((s,x)=>s + (x.teberru   || 0), 0);
        const sumTahsilat = veriTablosu.reduce((s,x)=>s + (x.tahsilat  || 0), 0);
        const sumHedef    = veriTablosu.reduce((s,x)=>s + (x.hedef     || 0), 0);
        const sumTeminHF  = veriTablosu.reduce((s,x)=>s + (x.teminHedef|| 0), 0);

        const sumKk       = veriTablosu.reduce((s,x)=>s + (x.kurbanKk  || 0), 0);
        const sumBb       = veriTablosu.reduce((s,x)=>s + (x.kurbanBb  || 0), 0);
        const sumKurban   = sumKk + sumBb;

        const oran = sumHedef>0 ? (sumTeminHF/sumHedef)*100 : 0;
        const oranStr = Number(oran).toFixed(2).replace('.', ',');

        toplamTeberruEl.textContent  = `â‚º${fmtPara(sumTeberru)}`;
        toplamTahsilatEl.textContent = `â‚º${fmtPara(sumTahsilat)}`;
        toplamHedefEl.textContent    = `â‚º${fmtPara(sumHedef)}`;
        toplamTeminEl.textContent    = `â‚º${fmtPara(sumTeminHF)}`;
        toplamOranEl.textContent     = `%${oranStr}`;
        oranBar.style.width          = Math.max(0, Math.min(100, oran)) + '%';

        const ttd = document.getElementById('toplamTeminDisplay');
        if (ttd) ttd.textContent = document.getElementById('toplamTemin').textContent;

        const kkEl = document.getElementById('toplamKurbanKk');
        const bbEl = document.getElementById('toplamKurbanBb');
        const gnEl = document.getElementById('toplamKurbanGenel');
        if(kkEl) kkEl.textContent = `${sumKk.toLocaleString('tr-TR')} adet`;
        if(bbEl) bbEl.textContent = `${sumBb.toLocaleString('tr-TR')} adet`;
        if(gnEl) gnEl.textContent = `${sumKurban.toLocaleString('tr-TR')} adet`;
      }
      // Ã–zet metriklerini gÃ¼ncelle (gÃ¶ster/gizle)
      ozetMetrikleriniGuncelle();
    }

    function derleVeYansit(hedefMap, teminMap, teberruMap, tahsilatMap, kurbanKkMap, kurbanBbMap){
      const personeller=new Set([
        ...Object.keys(hedefMap),
        ...Object.keys(teminMap),
        ...Object.keys(teberruMap),
        ...Object.keys(tahsilatMap),
        ...Object.keys(kurbanKkMap),
        ...Object.keys(kurbanBbMap),
        ...Object.keys(iftarMap),
        ...Object.keys(sahurMap),
        ...Object.keys(taahhutMap)
      ]);
      const tabloDizi=[];
      personeller.forEach(key=>{
        const personel=key;
        const hedef=toNum(hedefMap[key]||0);
        const teminHedef=toNum(teminMap[key]||0);
        const teberru=toNum(teberruMap[key]||0);
        const tahsilat=toNum(tahsilatMap[key]||0);
        const kurbanKk=toNum(kurbanKkMap[key]||0);
        const kurbanBb=toNum(kurbanBbMap[key]||0);
        const iftar=toNum(iftarMap[key]||0);
        const sahur=toNum(sahurMap[key]||0);
        const taahhut=toNum(taahhutMap[key]||0);
        
        let oran;
        if(ekranModu === 'Ramazan-Ä± Åerif'){
          const toplamTemin = iftar + sahur + taahhut + teberru;
          oran = hedef>0? (toplamTemin/hedef)*100 : 0;
          tabloDizi.push({personel, hedef, iftar, sahur, taahhut, teberru, kurbanKk, kurbanBb, oran, toplamTemin});
        } else {
          oran = hedef>0? (teminHedef/hedef)*100 : 0;
          tabloDizi.push({personel, teberru, tahsilat, kurbanKk, kurbanBb, hedef, teminHedef, oran});
        }
      });
      veriTablosu=tabloDizi;
      uygulaFiltre();
      toplamlariGuncelle();

      const kat = kategoriSecimi.value;
      const yil = Number(yilSec.value);
      const ay  = aySec.value===''? null : Number(aySec.value);
      const ust = kapsambaslikMetni(yil, ay, kat);
      kapsamUst.textContent = ust;
      kapsamPill.textContent = ust;
      altNot.textContent = ust;

      const nowStr=new Date((maxUpdateTs && !isNaN(maxUpdateTs))? maxUpdateTs: Date.now()).toLocaleString("tr-TR");
      guncellemeEl.textContent=nowStr;
    }

    function detachAll(){
      [unsubHedef,unsubTemin,unsubTeb,unsubTah,unsubKurban,unsubIftar,unsubSahur,unsubTaahhut,unsubTeberruRamazan,unsubTaahhutRamazan,unsubRamazanHedef].forEach(fn=>{ try{ if(typeof fn==='function') fn(); }catch{} });
      unsubHedef=unsubTemin=unsubTeb=unsubTah=unsubKurban=unsubIftar=unsubSahur=unsubTaahhut=unsubTeberruRamazan=unsubTaahhutRamazan=unsubRamazanHedef=null;
      maxUpdateTs=0;
    }

    function aboneOl(){
      detachAll();
      const kategori = kategoriSecimi.value;
      const yil = Number(yilSec.value);
      const ay  = aySec.value===''? null : Number(aySec.value);
      const {start,end} = localRangeFor(yil || null, ay || null);

      const hedefMap={}, teminMap={}, teberruMap={}, tahsilatMap={}, kurbanKkMap={}, kurbanBbMap={};

      // Hedefler
      let hedefQ = db.collection("hedefler");
      if(kategori!=="TÃ¼mÃ¼") hedefQ = hedefQ.where("kategori","==", kategori);
      unsubHedef = hedefQ.onSnapshot((snap)=>{
        Object.keys(hedefMap).forEach(k=>delete hedefMap[k]);
        snap.forEach(doc=>{
          const d=doc.data(); const p=canonName(d.personel||'-');
          hedefMap[p]=(hedefMap[p]||0)+toNum(d.hedef);
          const ts=d.updatedAt?.toMillis?.()? d.updatedAt.toMillis(): (d.updatedAt||0);
          if(ts>maxUpdateTs) maxUpdateTs=ts;
        });
        sonHedefMap={...hedefMap};
        derleVeYansit(hedefMap, teminMap, teberruMap, tahsilatMap, kurbanKkMap, kurbanBbMap);
      });

      // Hedef teminleri
      let teminQ = db.collection("veriler");
      if(kategori==="TÃ¼mÃ¼"){
        unsubTemin = teminQ.onSnapshot((snap)=>{
          Object.keys(teminMap).forEach(k=>delete teminMap[k]);
          snap.forEach(doc=>{
            const d=doc.data()||{};
            const cat = d.kategori || '';
            if (String(d.tur).toLowerCase()==='hedef' || cat==='Kitap KampanyasÄ±'){
              const p=canonName(d.personel||'-');
              teminMap[p]=(teminMap[p]||0)+toNum(d.miktar);
            }
            const ts=d.createdAt?.toMillis?.()? d.createdAt.toMillis(): (d.createdAt||0);
            if(ts>maxUpdateTs) maxUpdateTs=ts;
          });
          cacheTeminHedef={...teminMap};
          derleVeYansit(hedefMap, teminMap, teberruMap, tahsilatMap, kurbanKkMap, kurbanBbMap);
        });
      } else if (kategori==="Kitap KampanyasÄ±"){
        unsubTemin = teminQ.where("kategori","==","Kitap KampanyasÄ±").onSnapshot((snap)=>{
          Object.keys(teminMap).forEach(k=>delete teminMap[k]);
          snap.forEach(doc=>{
            const d=doc.data()||{}; const p=canonName(d.personel||'-');
            teminMap[p]=(teminMap[p]||0)+toNum(d.miktar);
            const ts=d.createdAt?.toMillis?.()? d.createdAt.toMillis(): (d.createdAt||0);
            if(ts>maxUpdateTs) maxUpdateTs=ts;
          });
          cacheTeminHedef={...teminMap};
          derleVeYansit(hedefMap, teminMap, teberruMap, tahsilatMap, kurbanKkMap, kurbanBbMap);
        });
      } else {
        unsubTemin = teminQ.where("tur","==","hedef").where("kategori","==", kategori).onSnapshot((snap)=>{
          Object.keys(teminMap).forEach(k=>delete teminMap[k]);
          snap.forEach(doc=>{
            const d=doc.data()||{}; const p=canonName(d.personel||'-');
            teminMap[p]=(teminMap[p]||0)+toNum(d.miktar);
            const ts=d.createdAt?.toMillis?.()? d.createdAt.toMillis(): (d.createdAt||0);
            if(ts>maxUpdateTs) maxUpdateTs=ts;
          });
          cacheTeminHedef={...teminMap};
          derleVeYansit(hedefMap, teminMap, teberruMap, tahsilatMap, kurbanKkMap, kurbanBbMap);
        });
      }

      // TE B E R R U (yeni mantÄ±k: tarih Ã¼zerinden, kategoriye gÃ¶re)
      // Ramazan kategorisi seÃ§ildiÄŸinde ve Ramazan-Ä± Åerif modunda teberru_kayitlari koleksiyonundan okunacak
      // Ama sadece Ramazan kategorisi seÃ§ildiÄŸinde, yoksa normal teberru verilerini de gÃ¶ster
      const isRamazanKategoriForTeb = ekranModu === 'Ramazan-Ä± Åerif' && yil && (kategori.includes('Ramazan') || kategori.includes('ramazan'));
      
      if(!isRamazanKategoriForTeb){
        unsubTeb = db.collection('veriler').where('tur','==','teberru').onSnapshot(async (snap)=>{
        const base = {};
        snap.forEach(doc=>{
          const d=doc.data()||{};
          
          // Ã–nce ay/yÄ±l alanlarÄ±nÄ± kontrol et (muhasebe-form'dan gelen veriler iÃ§in)
          if(d.ay !== undefined && d.yil !== undefined){
            // Ay/yÄ±l bazlÄ± filtreleme
            if(yil && d.yil !== yil) return;
            if(ay && d.ay !== ay) return;
            // Tarih aralÄ±ÄŸÄ± kontrolÃ¼ (start/end varsa)
            if(start && end){
              const when = getWhen(d);
              if(!when || when < start || when >= end) return;
            }
          } else {
            // Eski format: tarih alanÄ±ndan kontrol
            const when = getWhen(d);
            if (start && end){
              if (!when || when < start || when >= end) return;
            } else if (yil){
              if (!when || when.getFullYear() !== yil) return;
            }
          }
          
          // Kategori filtresi: Teberru'lar kategori filtresinden baÄŸÄ±msÄ±z olarak her zaman gÃ¶sterilmeli
          // Ã‡Ã¼nkÃ¼ teberru genel bir kavramdÄ±r ve kategori bazlÄ± deÄŸildir
          // Kategori filtresi sadece hedef verileri iÃ§in geÃ§erli olmalÄ±
          
          const p=canonName(d.personel||'-');
          base[p]=(base[p]||0)+toNum(d.miktar);
          const ts=d.createdAt?.toMillis?.()? d.createdAt.toMillis(): (d.createdAt||0);
          if(ts>maxUpdateTs) maxUpdateTs=ts;
        });

        // 2025 temmuz / aÄŸustos legacy istersen dursun
        if (yil===2025){
          async function addLegacyFor(month){
            const cat = month===7 ? 'Kitap KampanyasÄ±' : (month===8 ? 'Mevlid Kandili' : null);
            if(!cat) return;
            const s = await db.collection('veriler').where('kategori','==',cat).get();
            s.forEach(doc=>{
              const d=doc.data()||{};
              if (String(d.tur).toLowerCase()!=='teberru') return;
              const w=getWhen(d); if(!w) return;
              const aStart = new Date(2025, month-1, 1, 0,0,0);
              const aEnd   = new Date(2025, month,   1, 0,0,0);
              if (start && end){
                if (w < start || w >= end) return;
              }else{
                if (w < aStart || w >= aEnd) return;
              }
              if (kategori !== 'TÃ¼mÃ¼'){
                const dKat=d.kategori||'';
                if (dKat !== kategori) return;
              }
              const p=canonName(d.personel||'-');
              base[p]=(base[p]||0)+toNum(d.miktar);
            });
          }
          if (ay===7) await addLegacyFor(7);
          else if (ay===8) await addLegacyFor(8);
          else if (!ay){ await addLegacyFor(7); await addLegacyFor(8); }
        }

        Object.keys(teberruMap).forEach(k=>delete teberruMap[k]);
        Object.assign(teberruMap, base);
        cacheTeberru={...teberruMap};
        derleVeYansit(hedefMap, teminMap, teberruMap, tahsilatMap, kurbanKkMap, kurbanBbMap);
      });
      } else {
        // Ramazan kategorisi seÃ§ildiÄŸinde teberru verileri teberru_kayitlari koleksiyonundan yÃ¼klenecek
        // Burada unsubTeb null olarak bÄ±rakÄ±lÄ±r
        unsubTeb = null;
      }

      // T A H S I L A T
      unsubTah = db.collection('tahsilatlar').onSnapshot((snap)=>{
        Object.keys(tahsilatMap).forEach(k=>delete tahsilatMap[k]);
        snap.forEach(doc=>{
          const d=doc.data()||{};
          const when = getWhen(d); if(!when) return;
          if (start && end){ if(when < start || when >= end) return; }
          // tahsilat genel, kategori zorunlu deÄŸil
          const p=canonName(d.personel || d.tahsilatiYapan || d.personelAd || '-');
          const tutar = Number(d.miktar ?? d.tutar ?? 0) || 0;
          tahsilatMap[p]=(tahsilatMap[p]||0)+tutar;
          const ts=d.createdAt?.toMillis?.()? d.createdAt.toMillis(): (d.createdAt||0);
          if(ts>maxUpdateTs) maxUpdateTs=ts;
        });
        cacheTahsilat={...tahsilatMap};
        derleVeYansit(hedefMap, teminMap, teberruMap, tahsilatMap, kurbanKkMap, kurbanBbMap);
      });

      // K U R B A N (yeni formu da yakala)
      // === KURBAN ===
      let kq = db.collection('veriler')
        .where('tur', 'in', ['kucukbas', 'buyukbas']);

      unsubKurban = kq.onSnapshot((snap)=>{
        Object.keys(kurbanKkMap).forEach(k=>delete kurbanKkMap[k]);
        Object.keys(kurbanBbMap).forEach(k=>delete kurbanBbMap[k]);

        snap.forEach(doc=>{
          const d = doc.data() || {};
          const p = canonName(d.personel || '-');
          const adet = toNum(d.miktar || 1);
          const w = getWhen(d); // tarih ya da createdAt

          // yÄ±l/ay filtrelemesi
          if (yil && w && w.getFullYear() !== yil) return;
          if (ay && w && w.getMonth()+1 !== ay) return;

          if (d.tur === 'kucukbas') {
            kurbanKkMap[p] = (kurbanKkMap[p] || 0) + adet;
          } else if (d.tur === 'buyukbas') {
            kurbanBbMap[p] = (kurbanBbMap[p] || 0) + adet;
          }

          const ts = d.createdAt?.toMillis?.() ? d.createdAt.toMillis() : (d.createdAt || 0);
          if (ts > maxUpdateTs) maxUpdateTs = ts;
        });

        derleVeYansit(hedefMap, teminMap, teberruMap, tahsilatMap, kurbanKkMap, kurbanBbMap);
      });

      // RAMAZAN-I ÅERIF MODU: Ä°FTAR, SAHUR, TAAHHÃœT
      if(ekranModu === 'Ramazan-Ä± Åerif'){
        // Kategori kontrolÃ¼: "Ramazan-Ä± Åerif" iÃ§eren kategoriler iÃ§in iftar-sahur-form.html verilerini kullan
        const isRamazanKategoriRamazan = kategori.includes('Ramazan') || kategori.includes('ramazan');
        
        if(isRamazanKategoriRamazan && yil){
          // iftar-sahur-form.html verilerini kullan
          const ramazanYil = String(yil);
          
          // Ä°FTAR-SAHUR kayÄ±tlarÄ± (ramazan_serif/{YIL}/kayitlar)
          unsubIftar = db.collection('ramazan_serif').doc(ramazanYil).collection('kayitlar')
            .onSnapshot((snap)=>{
              Object.keys(iftarMap).forEach(k=>delete iftarMap[k]);
              Object.keys(sahurMap).forEach(k=>delete sahurMap[k]);
              
              snap.forEach(doc=>{
                const d=doc.data()||{};
                // Silinen kayÄ±tlarÄ± atla (silindi alanÄ± true olanlarÄ±)
                if(d.silindi === true) return;
                
                // YÄ±l kontrolÃ¼
                if(d.yil && Number(d.yil) !== yil) return;
                
                const personelAdi = d.personelAdi || d.personel || '-';
                const p = canonName(personelAdi);
                const tutar = toNum(d.tutar || 0);
                
                if(d.tip === 'iftar'){
                  iftarMap[p] = (iftarMap[p] || 0) + tutar;
                } else if(d.tip === 'sahur'){
                  sahurMap[p] = (sahurMap[p] || 0) + tutar;
                }
                
                const ts = d.createdAt?.toMillis?.() ? d.createdAt.toMillis() : (d.createdAt || 0);
                if(ts > maxUpdateTs) maxUpdateTs = ts;
              });
              
              // Teberru ve TaahhÃ¼t iÃ§in ayrÄ± Ã§aÄŸrÄ±lar yapÄ±lacak
              derleVeYansit(hedefMap, teminMap, teberruMap, tahsilatMap, kurbanKkMap, kurbanBbMap);
            });
          
          // TEBERRU kayÄ±tlarÄ± (teberru_kayitlari)
          unsubTeberruRamazan = db.collection('teberru_kayitlari')
            .where('yil', '==', yil).onSnapshot((snap)=>{
              Object.keys(teberruMap).forEach(k=>delete teberruMap[k]);
              
              console.log('[Teberru] YÃ¼klenen kayÄ±t sayÄ±sÄ±:', snap.size, 'YÄ±l:', yil);
              
              snap.forEach(doc=>{
                const d=doc.data()||{};
                // YÄ±l kontrolÃ¼ (ekstra gÃ¼venlik)
                if(d.yil && Number(d.yil) !== yil) return;
                
                const personelAdi = d.personelAdi || d.personel || '-';
                const p = canonName(personelAdi);
                const miktar = toNum(d.miktar || 0);
                
                console.log('[Teberru] KayÄ±t:', {personelAdi, normalized: p, miktar, yil: d.yil});
                
                // Teberru'yu teberruMap'e ekle
                teberruMap[p] = (teberruMap[p] || 0) + miktar;
                
                const ts = d.createdAt?.toMillis?.() ? d.createdAt.toMillis() : (d.createdAt || 0);
                if(ts > maxUpdateTs) maxUpdateTs = ts;
              });
              
              console.log('[Teberru] teberruMap:', teberruMap);
              
              derleVeYansit(hedefMap, teminMap, teberruMap, tahsilatMap, kurbanKkMap, kurbanBbMap);
            }, err=>{
              console.error('[Teberru] Hata:', err);
            });
          
          // TAAHHÃœT kayÄ±tlarÄ± (taahhut_kayitlari)
          unsubTaahhutRamazan = db.collection('taahhut_kayitlari')
            .where('yil', '==', yil).onSnapshot((snap)=>{
              Object.keys(taahhutMap).forEach(k=>delete taahhutMap[k]);
              
              snap.forEach(doc=>{
                const d=doc.data()||{};
                // YÄ±l kontrolÃ¼ (ekstra gÃ¼venlik)
                if(d.yil && Number(d.yil) !== yil) return;
                
                const personelAdi = d.personelAdi || d.personel || '-';
                const p = canonName(personelAdi);
                const miktar = toNum(d.miktar || 0);
                
                taahhutMap[p] = (taahhutMap[p] || 0) + miktar;
                
                const ts = d.createdAt?.toMillis?.() ? d.createdAt.toMillis() : (d.createdAt || 0);
                if(ts > maxUpdateTs) maxUpdateTs = ts;
              });
              
              derleVeYansit(hedefMap, teminMap, teberruMap, tahsilatMap, kurbanKkMap, kurbanBbMap);
            });
          
          // Hedef verileri (ramazan_serif/{YIL}/personel_hedefleri)
          // Hedef zaten yukarÄ±da yÃ¼kleniyor ama Ramazan kategorisi iÃ§in Ã¶zel hedef koleksiyonunu da kontrol et
          // Snapshot listener kullanarak gerÃ§ek zamanlÄ± gÃ¼ncellemeleri yakala
          unsubRamazanHedef = db.collection('ramazan_serif').doc(ramazanYil).collection('personel_hedefleri')
            .onSnapshot((snap)=>{
              snap.forEach(doc=>{
                const d=doc.data()||{};
                const personelAdi = d.personelAdi || d.personel || '-';
                const p = canonName(personelAdi);
                const hedefTutar = toNum(d.hedef || d.tutar || 0);
                
                // EÄŸer hedefMap'te yoksa ekle, varsa Ã¼zerine yaz (Ramazan hedefi Ã¶ncelikli)
                if(hedefTutar > 0){
                  hedefMap[p] = hedefTutar;
                }
                
                const ts = d.updatedAt?.toMillis?.() ? d.updatedAt.toMillis() : (d.createdAt?.toMillis?.() ? d.createdAt.toMillis() : 0);
                if(ts > maxUpdateTs) maxUpdateTs = ts;
              });
              
              sonHedefMap = {...hedefMap};
              derleVeYansit(hedefMap, teminMap, teberruMap, tahsilatMap, kurbanKkMap, kurbanBbMap);
            }, err=>{
              console.warn('Ramazan personel hedefleri yÃ¼klenemedi:', err);
            });
        } else {
          // Eski sistem: veriler koleksiyonundan oku
          // Ä°FTAR
          unsubIftar = db.collection('veriler').where('tur','==','iftar').onSnapshot((snap)=>{
            Object.keys(iftarMap).forEach(k=>delete iftarMap[k]);
            snap.forEach(doc=>{
              const d=doc.data()||{};
              const when = getWhen(d);
              if(d.ay !== undefined && d.yil !== undefined){
                if(yil && d.yil !== yil) return;
                if(ay && d.ay !== ay) return;
                if(start && end && when && (when < start || when >= end)) return;
              } else {
                if (start && end){
                  if (!when || when < start || when >= end) return;
                } else if (yil){
                  if (!when || when.getFullYear() !== yil) return;
                }
              }
              const p=canonName(d.personel||'-');
              iftarMap[p]=(iftarMap[p]||0)+toNum(d.miktar);
              const ts=d.createdAt?.toMillis?.()? d.createdAt.toMillis(): (d.createdAt||0);
              if(ts>maxUpdateTs) maxUpdateTs=ts;
            });
            derleVeYansit(hedefMap, teminMap, teberruMap, tahsilatMap, kurbanKkMap, kurbanBbMap);
          });

          // SAHUR
          unsubSahur = db.collection('veriler').where('tur','==','sahur').onSnapshot((snap)=>{
            Object.keys(sahurMap).forEach(k=>delete sahurMap[k]);
            snap.forEach(doc=>{
              const d=doc.data()||{};
              const when = getWhen(d);
              if(d.ay !== undefined && d.yil !== undefined){
                if(yil && d.yil !== yil) return;
                if(ay && d.ay !== ay) return;
                if(start && end && when && (when < start || when >= end)) return;
              } else {
                if (start && end){
                  if (!when || when < start || when >= end) return;
                } else if (yil){
                  if (!when || when.getFullYear() !== yil) return;
                }
              }
              const p=canonName(d.personel||'-');
              sahurMap[p]=(sahurMap[p]||0)+toNum(d.miktar);
              const ts=d.createdAt?.toMillis?.()? d.createdAt.toMillis(): (d.createdAt||0);
              if(ts>maxUpdateTs) maxUpdateTs=ts;
            });
            derleVeYansit(hedefMap, teminMap, teberruMap, tahsilatMap, kurbanKkMap, kurbanBbMap);
          });

          // TAAHHÃœT
          unsubTaahhut = db.collection('veriler').where('tur','==','taahhut').onSnapshot((snap)=>{
            Object.keys(taahhutMap).forEach(k=>delete taahhutMap[k]);
            snap.forEach(doc=>{
              const d=doc.data()||{};
              const when = getWhen(d);
              if(d.ay !== undefined && d.yil !== undefined){
                if(yil && d.yil !== yil) return;
                if(ay && d.ay !== ay) return;
                if(start && end && when && (when < start || when >= end)) return;
              } else {
                if (start && end){
                  if (!when || when < start || when >= end) return;
                } else if (yil){
                  if (!when || when.getFullYear() !== yil) return;
                }
              }
              const p=canonName(d.personel||'-');
              taahhutMap[p]=(taahhutMap[p]||0)+toNum(d.miktar);
              const ts=d.createdAt?.toMillis?.()? d.createdAt.toMillis(): (d.createdAt||0);
              if(ts>maxUpdateTs) maxUpdateTs=ts;
            });
            derleVeYansit(hedefMap, teminMap, teberruMap, tahsilatMap, kurbanKkMap, kurbanBbMap);
          });
        }
      } else {
        // Hedef modunda iftar, sahur, taahhÃ¼t verilerini temizle
        Object.keys(iftarMap).forEach(k=>delete iftarMap[k]);
        Object.keys(sahurMap).forEach(k=>delete sahurMap[k]);
        Object.keys(taahhutMap).forEach(k=>delete taahhutMap[k]);
      }
    }

    let __modalRows = [];
    let __modalSort = { key:'t', dir:'desc' };

    function paintModalSortIndicators(){
      const head = document.querySelector('#m_hareketTablo thead');
      if(!head) return;
      head.querySelectorAll('.sort-arrows span').forEach(el=>{
        const k=el.dataset.key, d=el.dataset.dir;
        el.classList.toggle('active', k===__modalSort.key && d===__modalSort.dir);
      });
    }

    function renderModalRows(){
      const tbody = m_hareketTabloBody;
      const rows = __modalRows.slice();
      const k = __modalSort.key, dir = __modalSort.dir;
      const sign = dir==='asc' ? 1 : -1;

      rows.sort((a,b)=>{
        function val(x){
          if(k==='t') return x.t?.getTime?.() || 0;
          if(k==='miktar') return Number(x.miktar)||0;
          if(k==='ad') return (x.ad||'').toLocaleLowerCase('tr-TR');
          if(k==='tur') return (x.tur||'').toLocaleLowerCase('tr-TR');
          if(k==='aciklama') return (x.aciklama||'').toLocaleLowerCase('tr-TR');
          return 0;
        }
        const va = val(a), vb = val(b);
        if(typeof va==='number' && typeof vb==='number') return sign*(va - vb);
        return sign*String(va).localeCompare(String(vb), 'tr');
      });

      tbody.innerHTML='';
      if(!rows.length){
        tbody.innerHTML='<tr><td colspan="5">Hareket bulunamadÄ±.</td></tr>';
      }else{
        rows.forEach(x=>{
          let turEt = 'etiket-hedef', turAd='Hedef';
          if(x.tur==='teberru'){ turEt='etiket-teberru'; turAd='Teberru'; }
          else if(x.tur==='tahsilat'){ turEt='etiket-tahsilat'; turAd='Tahsilat'; }
          else if(x.tur==='kurban'){ turEt='etiket-kurban'; turAd = x.kurbanTipi ? ('Kurban - '+x.kurbanTipi) : 'Kurban'; }
          else if(x.tur==='iftar'){ turEt='etiket-teberru'; turAd='Ä°ftar'; }
          else if(x.tur==='sahur'){ turEt='etiket-teberru'; turAd='Sahur'; }
          else if(x.tur==='taahhut'){ turEt='etiket-hedef'; turAd='TaahhÃ¼t'; }

          tbody.innerHTML += `<tr>
            <td>${x.tStr}</td>
            <td>${x.ad||'-'}</td>
            <td>${x.miktarTip==='adet' ? x.miktar : 'â‚º'+Math.round(x.miktar || 0).toLocaleString('tr-TR', {minimumFractionDigits: 0, maximumFractionDigits: 0})}</td>
            <td><span class="etiket ${turEt}">${turAd}</span></td>
            <td>${x.aciklama||'-'}</td>
          </tr>`;
        });
      }
      paintModalSortIndicators();
    }

    (function initModalSort(){
      const head = document.querySelector('#m_hareketTablo thead');
      if(!head) return;
      head.addEventListener('click', (e)=>{
        const btn = e.target.closest('.sort-arrows span');
        if(!btn) return;
        __modalSort = { key: btn.dataset.key, dir: btn.dataset.dir };
        renderModalRows();
      });
      paintModalSortIndicators();
    })();

    async function acDetayModal(personel){
      const kategori=kategoriSecimi.value;
      const yil = Number(yilSec.value);
      const ay  = aySec.value===''? null : Number(aySec.value);
      const {start,end} = localRangeFor(yil || null, ay || null);

      const kapsam = kapsamMetni(yil, ay, kategori);
      m_baslik.textContent=`${personel}`;
      m_kapsamEtik.textContent = kapsam;
      m_kategoriEtik.textContent = kategori;
      modalArka.style.display='block';
      m_hareketTabloBody.innerHTML='<tr><td colspan="5">YÃ¼kleniyor...</td></tr>';

      const hedef=toNum(sonHedefMap[personel]||0);
      let hedefTeminTop=0, teberruTop=0, tahsilatTop=0, iftarTop=0, sahurTop=0, taahhutTop=0;
      const satirlar=[];

      try{
        // Ramazan-Ä± Åerif modunda ve Ramazan kategorisi seÃ§ildiÄŸinde Ã¶zel iÅŸlem
        const isRamazanModal = ekranModu === 'Ramazan-Ä± Åerif' && yil && (kategori.includes('Ramazan') || kategori.includes('ramazan'));
        
        if(isRamazanModal){
          // Ramazan verilerini yÃ¼kle
          const ramazanYil = String(yil);
          
          // Ä°FTAR-SAHUR kayÄ±tlarÄ±
          const iftarSahurSnap = await db.collection('ramazan_serif').doc(ramazanYil).collection('kayitlar').get();
          
          iftarSahurSnap.forEach(doc=>{
            const d=doc.data()||{};
            // Silinen kayÄ±tlarÄ± atla (silindi alanÄ± true olanlarÄ±)
            if(d.silindi === true) return;
            if(d.yil && Number(d.yil) !== yil) return;
            
            const personelAdi = d.personelAdi || d.personel || '-';
            const p = canonName(personelAdi);
            if(p !== personel) return;
            
            const tutar = toNum(d.tutar || 0);
            const t = d.tarih?.toDate ? d.tarih.toDate() : (d.createdAt?.toDate ? d.createdAt.toDate() : new Date());
            const tStr = t ? t.toLocaleString('tr-TR') : '-';
            
            if(d.tip === 'iftar'){
              iftarTop += tutar;
              satirlar.push({t, tStr, ad:(d.sahip||d.adSoyad||d.veren||'-'), miktar:tutar, tur:'iftar', aciklama:(d.not||d.aciklama||'-'), miktarTip:'â‚º'});
            } else if(d.tip === 'sahur'){
              sahurTop += tutar;
              satirlar.push({t, tStr, ad:(d.sahip||d.adSoyad||d.veren||'-'), miktar:tutar, tur:'sahur', aciklama:(d.not||d.aciklama||'-'), miktarTip:'â‚º'});
            }
          });
          
          // TEBERRU kayÄ±tlarÄ±
          const teberruSnap = await db.collection('teberru_kayitlari')
            .where('yil', '==', yil).get();
          
          teberruSnap.forEach(doc=>{
            const d=doc.data()||{};
            if(d.yil && Number(d.yil) !== yil) return;
            
            const personelAdi = d.personelAdi || d.personel || '-';
            const p = canonName(personelAdi);
            if(p !== personel) return;
            
            const miktar = toNum(d.miktar || 0);
            teberruTop += miktar;
            const t = d.tarih?.toDate ? d.tarih.toDate() : (d.createdAt?.toDate ? d.createdAt.toDate() : new Date());
            const tStr = t ? t.toLocaleString('tr-TR') : '-';
            satirlar.push({t, tStr, ad:(d.bagisci||d.adSoyad||d.veren||'-'), miktar, tur:'teberru', aciklama:(d.aciklama||'-'), miktarTip:'â‚º'});
          });
          
          // TAAHHÃœT kayÄ±tlarÄ±
          const taahhutSnap = await db.collection('taahhut_kayitlari')
            .where('yil', '==', yil).get();
          
          taahhutSnap.forEach(doc=>{
            const d=doc.data()||{};
            if(d.yil && Number(d.yil) !== yil) return;
            
            const personelAdi = d.personelAdi || d.personel || '-';
            const p = canonName(personelAdi);
            if(p !== personel) return;
            
            const miktar = toNum(d.miktar || 0);
            taahhutTop += miktar;
            const t = d.tarih?.toDate ? d.tarih.toDate() : (d.createdAt?.toDate ? d.createdAt.toDate() : new Date());
            const tStr = t ? t.toLocaleString('tr-TR') : '-';
            satirlar.push({t, tStr, ad:(d.bagisci||d.adSoyad||d.veren||'-'), miktar, tur:'taahhut', aciklama:(d.aciklama||'-'), miktarTip:'â‚º'});
          });
          
          // Ramazan hedefleri
          const ramazanHedefSnap = await db.collection('ramazan_serif').doc(ramazanYil).collection('personel_hedefleri').get();
          ramazanHedefSnap.forEach(doc=>{
            const d=doc.data()||{};
            const personelAdi = d.personelAdi || d.personel || '-';
            const p = canonName(personelAdi);
            if(p !== personel) return;
            
            const hedefTutar = toNum(d.hedef || d.tutar || 0);
            if(hedefTutar > 0){
              hedefTeminTop += hedefTutar;
            }
          });
        } else {
          // Normal mod: Hedef temini
          let hSnap;
          if(kategori==='TÃ¼mÃ¼'){
            hSnap = await db.collection('veriler').get();
          }else if(kategori==='Kitap KampanyasÄ±'){
            hSnap = await db.collection('veriler').where('kategori','==','Kitap KampanyasÄ±').get();
          }else{
            hSnap = await db.collection('veriler').where('tur','==','hedef').where('kategori','==',kategori).get();
          }
          hSnap.forEach(doc=>{
            const d=doc.data()||{}; const p=canonName(d.personel||'-'); if(p!==personel) return;
            hedefTeminTop += toNum(d.miktar);
            const t=getWhen(d), tStr=t? t.toLocaleString('tr-TR'):'-';
            satirlar.push({t, tStr, ad:(d.adSoyad||d.veren||'-'), miktar:toNum(d.miktar), tur:'hedef', aciklama:(d.aciklama||d.nereyeGeldi||'-'), miktarTip:'â‚º'});
          });
        }

        // Teberru (yeni tarihli) - Sadece Ramazan modunda deÄŸilse yÃ¼kle
        if(!isRamazanModal){
          const s = await db.collection('veriler').where('tur','==','teberru').get();
          s.forEach(doc=>{
            const d=doc.data()||{}; const p=canonName(d.personel||'-'); if(p!==personel) return;
            
            // Ay/yÄ±l bazlÄ± filtreleme (muhasebe-form'dan gelen veriler iÃ§in)
            if(d.ay !== undefined && d.yil !== undefined){
              if(yil && d.yil !== yil) return;
              if(ay && d.ay !== ay) return;
              if(start && end){
                const when = getWhen(d);
                if(!when || when < start || when >= end) return;
              }
            } else {
              // Eski format: tarih alanÄ±ndan kontrol
              const when=getWhen(d);
              if (start && end){
                if (!when || when < start || when >= end) return;
              } else if (yil){
                if (!when || when.getFullYear() !== yil) return;
              }
            }
            
            // Kategori filtresi teberru'lar iÃ§in geÃ§erli deÄŸil (teberru genel bir kavramdÄ±r)
            
            teberruTop += toNum(d.miktar);
            const t = d.ay !== undefined && d.yil !== undefined ? 
              new Date(d.yil, d.ay - 1, 1) : getWhen(d);
            const tStr = t ? t.toLocaleString('tr-TR') : '-';
            satirlar.push({t, tStr, ad:(d.adSoyad||d.veren||'-'), miktar:toNum(d.miktar), tur:'teberru', aciklama:(d.aciklama||d.nereyeGeldi||'-'), miktarTip:'â‚º'});
          });
        }

        // Kurban (iki ÅŸemeyi de oku)
        const sk = await db.collection('veriler').get();
        sk.forEach(doc=>{
          const d = doc.data() || {};
          const p = canonName(d.personel || '-');
          if (p !== personel) return;
          const w = getWhen(d);
          if (start && end){
            if (!w || w < start || w >= end) return;
          } else if (yil){
            if (!w || w.getFullYear() !== yil) return;
          }
          let tip = d.tur || d.kategori || '';
          tip = tip.toString().toLowerCase();
          if (tip!=='kucukbas' && tip!=='buyukbas' && tip!=='kÃ¼Ã§Ã¼kbaÅŸ' && tip!=='bÃ¼yÃ¼kbaÅŸ') return;

          const t = w, tStr = t ? t.toLocaleString('tr-TR') : '-';
          const adet = toNum(d.miktar || 1);
          const turLabel = (tip==='kucukbas' || tip==='kÃ¼Ã§Ã¼kbaÅŸ') ? 'KÃ¼Ã§Ã¼kbaÅŸ' : 'BÃ¼yÃ¼kbaÅŸ';

          satirlar.push({
            t,
            tStr,
            ad: (d.adSoyad || d.kurbanSahibi || d.sahip || '-'),
            miktar: adet,
            tur: 'kurban',
            aciklama: (d.aciklama || d.kesimYeri || '-'),
            miktarTip: 'adet',
            kurbanTipi: turLabel
          });
        });

        // Tahsilatlar
        const th = await db.collection('tahsilatlar').get();
        th.forEach(doc=>{
          const d=doc.data()||{}; const w=getWhen(d); if(!w) return;
          if (start && end){ if(w < start || w >= end) return; }
          const p=canonName(d.personel || d.tahsilatiYapan || d.personelAd || '-'); if(p!==personel) return;
          const tutar=Number(d.miktar ?? d.tutar ?? 0) || 0; tahsilatTop += tutar;
          const t=w, tStr=t? t.toLocaleString('tr-TR'):'-';
          const ad = d.borclu || d.adSoyad || d.alici || '-';
          satirlar.push({t, tStr, ad, miktar:tutar, tur:'tahsilat', aciklama:(d.aciklama||'-'), miktarTip:'â‚º'});
        });

        const fmtPara = (n) => Math.round(n || 0).toLocaleString("tr-TR", {minimumFractionDigits: 0, maximumFractionDigits: 0});
        let oran;
        if(isRamazanModal){
          const toplamTemin = iftarTop + sahurTop + taahhutTop + teberruTop;
          oran = hedef>0? (toplamTemin/hedef)*100 : 0;
          m_hedefTeminTop.textContent='â‚º'+fmtPara(toplamTemin);
        } else {
          oran = hedef>0? (hedefTeminTop/hedef)*100 : 0;
          m_hedefTeminTop.textContent='â‚º'+fmtPara(hedefTeminTop);
        }
        const oranStr = Number(oran).toFixed(2).replace('.', ',');
        m_hedefTop.textContent='â‚º'+fmtPara(hedef);
        m_teberruTop.textContent='â‚º'+fmtPara(teberruTop);
        m_tahsilatTop.textContent='â‚º'+fmtPara(tahsilatTop);
        m_oranTop.textContent='%'+oranStr;

        __modalRows = satirlar;
        __modalSort = { key:'t', dir:'desc' };
        renderModalRows();

      }catch(err){
        console.error('[detay modal] hata:',err);
        m_hareketTabloBody.innerHTML=`<tr><td colspan="5">KayÄ±tlar yÃ¼klenemedi.</td></tr>`;
        const fmtPara = (n) => Math.round(n || 0).toLocaleString("tr-TR", {minimumFractionDigits: 0, maximumFractionDigits: 0});
        m_hedefTeminTop.textContent='â‚º0'; m_teberruTop.textContent='â‚º0'; m_tahsilatTop.textContent='â‚º0'; m_oranTop.textContent='%0,00';
      }
    }
    window._acDetayModal=acDetayModal;

    (function initSelectors(){
      const now=new Date(); const curY=now.getFullYear();
      const years=[]; for(let y=2023; y<=curY+1; y++) years.push(y);
      yilSec.innerHTML = years.map(y=>`<option value="${y}">${y}</option>`).join('');
      const savedY=localStorage.getItem('hedefGrafik_yil');
      const savedM=localStorage.getItem('hedefGrafik_ay');
      yilSec.value = savedY || String(curY);
      aySec.value  = (savedM===null) ? String(now.getMonth()+1) : savedM;
      yilSec.addEventListener('change',()=>{ localStorage.setItem('hedefGrafik_yil',yilSec.value); aboneOl(); });
      aySec.addEventListener('change', ()=>{ localStorage.setItem('hedefGrafik_ay', aySec.value);  aboneOl(); });
      const k=localStorage.getItem('hedefGrafik_kategori'); if(k) kategoriSecimi.value=k;
      const f=localStorage.getItem('hedefGrafik_filtresi'); if(f) filtreSecimi.value=f;
      kategoriSecimi.addEventListener('change',()=>{ localStorage.setItem('hedefGrafik_kategori',kategoriSecimi.value); aboneOl(); });
      filtreSecimi.addEventListener('change',()=>{ localStorage.setItem('hedefGrafik_filtresi',filtreSecimi.value); uygulaFiltre(); });
      
      // Ekran modu butonu
      if(ekranButonu){
        ekranButonu.addEventListener('click',()=>{
          ekranModu = ekranModu === 'Hedef' ? 'Ramazan-Ä± Åerif' : 'Hedef';
          localStorage.setItem('hedefGrafik_ekranModu', ekranModu);
          if(ekranAdi) ekranAdi.textContent = ekranModu;
          tabloBasliklariniGuncelle();
          ozetMetrikleriniGuncelle();
          aboneOl();
        });
      }
      
      // Ä°lk yÃ¼klemede tablo baÅŸlÄ±klarÄ±nÄ± ve Ã¶zet metriklerini gÃ¼ncelle
      tabloBasliklariniGuncelle();
      ozetMetrikleriniGuncelle();
    })();

    async function loadKategoriler(){
      const sel = document.getElementById('kategoriSecimi');
      try{
        const snap = await db.collection('kategoriler').orderBy('ad').get();
        if(!snap.empty){
          const saved=localStorage.getItem('hedefGrafik_kategori') || 'TÃ¼mÃ¼';
          sel.innerHTML='';
          sel.appendChild(new Option('TÃ¼mÃ¼','TÃ¼mÃ¼'));
          snap.forEach(doc=>{
            const d=doc.data()||{};
            const ad = d.ad || d.isim || doc.id;
            sel.appendChild(new Option(ad, ad));
          });
          sel.value = saved;
        }
      }catch(err){
        console.warn('kategoriler okunamadÄ±, fallback kullanÄ±lÄ±yor', err);
      }
    }

    try{ firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL); }catch(e){}

    auth.onAuthStateChanged(async (user)=>{
      if(!user){ setTimeout(()=>{ if(!auth.currentUser) location.replace('../../index.html'); },150); return; }
      try{
        const uSnap=await db.collection('kullanicilar').doc(user.uid).get();
        const data=uSnap.exists? uSnap.data(): {};
        const raw=Array.isArray(data.yetkiler)? data.yetkiler: [];
        CURRENT_ALLOW=new Set(raw.filter(s=>!String(s).trim().match(/^[-!]/)).map(norm));
        CURRENT_DENY =new Set(raw.filter(s=> String(s).trim().match(/^[-!]/)).map(s=>norm(String(s).replace(/^[-!]\s*/,''))));
        const panels=await fetchPanels(CURRENT_ALLOW, CURRENT_DENY);
        renderNav(panels);
        await loadKategoriler();
        aboneOl();
      }catch(e){ console.error(e); showToast('Veriler yÃ¼klenirken hata.'); }
    });
  </script>
</body>
</html>
