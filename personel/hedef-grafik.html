<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8" />
  <title>Hedef Grafik | KaraaÄŸaÃ§ Fatih</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="icon" type="image/png" href="../img/logo.png" />

  <link rel="stylesheet" href="../css/app-shell.css" />

  <style>
    /* app-shell.css Ã¼st bar/arka plan/toast/yetki yapÄ±sÄ±nÄ± kullanÄ±r.
       Burada sadece sayfa-Ã¶zel kÃ¼Ã§Ã¼k dÃ¼zenlemeler var. */
    body {
      padding-top: var(--appbar-h) !important;
      overflow-x: hidden;
      overflow-y: auto;
    }

    .wrap {
      max-width: 1750px;
      margin: 0 auto;
      padding: 16px
    }

    .hero {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: 14px;
      padding: 16px;
      margin: 16px 0;
    }

    .hero h2 {
      margin: 0 0 6px;
      font-size: 20px
    }

    .hero-sub {
      color: var(--muted);
      font-size: 15px;
      line-height: 1.35;
      margin-bottom: 10px;
    }

    .hero-sub1 {
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
      margin-bottom: 10px;
    }

    .mini {
      display: flex;
      gap: 8px;
      flex-wrap: wrap
    }

    .pill {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: var(--pill);
      font-size: 12px
    }

    .grid {
      display: grid;
      gap: 14px;
      grid-template-columns: repeat(12, minmax(0, 1fr));
      align-items: start
    }

    .col-12 {
      grid-column: span 12
    }

    .col-10 {
      grid-column: span 10
    }

    .col-9 {
      grid-column: span 9
    }

    .col-8 {
      grid-column: span 8
    }

    .col-6 {
      grid-column: span 6
    }

    .col-4 {
      grid-column: span 4
    }

    .col-3 {
      grid-column: span 3
    }

    .col-2 {
      grid-column: span 2
    }

    .card {
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: 14px;
      padding: 14px
    }

    .card h3 {
      margin: 0 0 10px;
      font-size: 16px
    }

    .kpi {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 10px;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--stroke);
      background: var(--surface)
    }

    .kpi .val {
      font-size: 22px;
      font-weight: 800;
      position: relative;
      z-index: 2
    }

    .kpi .sub {
      font-size: 12px;
      color: var(--muted);
      position: relative;
      z-index: 2
    }

    .row-grid {
      display: grid;
      gap: 10px;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      align-items: end
    }

    .row-grid .cell {
      min-width: 160px
    }

    .row-grid .right-note {
      justify-self: end;
      align-self: center;
      color: var(--muted);
      font-size: 12px
    }

    @media (max-width: 820px) {
      .row-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr))
      }

      .row-grid .right-note {
        grid-column: 1/-1;
        justify-self: start;
        margin-top: 4px
      }
    }

    label {
      display: block;
      font-weight: 700;
      margin-bottom: 6px;
      color: var(--muted)
    }

    select {
      width: 100%;
      padding: 10px;
      border-radius: 10px;
      border: 1px solid var(--stroke);
      background: var(--pill);
      color: var(--text)
    }

    #tableWrap {
      overflow-x: visible
    }

    #hedefTablosu {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0 8px;
      table-layout: auto;
    }

    #hedefTablosu thead th {
      background: var(--surface);
      padding: 10px 12px;
      border-bottom: 1px solid var(--stroke);
      text-align: center
    }

    #hedefTablosu tbody td {
      background: var(--card);
      border: 1px solid var(--stroke);
      padding: 12px;
      text-align: center
    }

    #hedefTablosu tbody td.col-hedef,
    #hedefTablosu tbody td.col-temin {
      font-weight: 700;
    }

    #hedefTablosu thead th,
    #hedefTablosu tbody td {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis
    }

    #hedefTablosu tbody td:first-child {
      text-align: left;
      border-top-left-radius: 10px;
      border-bottom-left-radius: 10px
    }

    #hedefTablosu tbody td:last-child {
      border-top-right-radius: 10px;
      border-bottom-right-radius: 10px
    }

    .c-personel {
      width: 20%
    }

    .c-mid {
      width: 12%
    }

    .c-kurban {
      width: 8%
    }

    #hedefTablosu.mod-ramazan .c-personel {
      width: 36%;
    }

    #hedefTablosu.mod-ramazan .c-kurban {
      width: 2%;
    }

    .c-oran {
      width: 18%
    }

    #hedefTablosu tbody td.wrap {
      white-space: normal;
      word-break: normal;
      overflow: visible;
      text-overflow: clip;
    }

    .under-note {
      color: var(--muted);
      font-size: 12px;
      margin-top: 6px
    }

    /* Personel Toggle - Zarif Minimalist TasarÄ±m */
    .personel-toggle {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      cursor: pointer;
      user-select: none;
      padding: 4px 8px;
      border-radius: 20px;
      transition: background .2s ease;
    }

    .personel-toggle:hover {
      background: var(--surface);
    }

    .personel-toggle input[type="checkbox"] {
      position: absolute;
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: relative;
      width: 36px;
      height: 18px;
      background: var(--stroke);
      border-radius: 9px;
      transition: background .25s ease;
      flex-shrink: 0;
    }

    .toggle-slider::before {
      content: '';
      position: absolute;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: #fff;
      top: 2px;
      left: 2px;
      transition: transform .25s ease, box-shadow .25s ease;
      box-shadow: 0 1px 3px rgba(0, 0, 0, .15);
    }

    .personel-toggle input:checked+.toggle-slider {
      background: var(--brand);
    }

    .personel-toggle input:checked+.toggle-slider::before {
      transform: translateX(18px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, .2);
    }

    .toggle-label {
      font-size: 12px;
      font-weight: 500;
      color: var(--text);
      opacity: .8;
      transition: opacity .2s ease;
    }

    .personel-toggle:hover .toggle-label {
      opacity: 1;
    }

    @media (prefers-color-scheme: light) {
      .toggle-slider {
        background: rgba(15, 23, 42, .15);
      }

      .personel-toggle input:checked+.toggle-slider {
        background: var(--brand2);
      }
    }

    .progress {
      position: relative;
      width: 100%;
      height: 28px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: var(--surface);
      overflow: hidden
    }

    .progress>.fill {
      position: absolute;
      inset: 0 auto 0 0;
      width: 0%;
      height: 100%;
      background: linear-gradient(90deg, var(--brand2), var(--brand));
    }

    .progress>.fill.danger {
      background: linear-gradient(90deg, #dc2626, #ef4444);
    }

    .progress>.fill.warn {
      background: linear-gradient(90deg, #ea580c, #f97316);
    }

    .progress>.fill.good {
      background: linear-gradient(90deg, #16a34a, #22c55e);
    }

    .progress>.fill.ok {
      --great: #059669;
      background: linear-gradient(90deg, var(--good), var(--great));
    }

    .progress>.label {
      position: relative;
      z-index: 2;
      font-weight: 800;
      line-height: 28px;
      font-size: 12px;
      padding: 0 6px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: #fff;
      text-shadow: 0 1px 2px rgba(0,0,0,.4), 0 0 1px rgba(0,0,0,.5);
    }

    .progress>.label.danger {
      color: #dc2626;
      text-shadow: none;
    }

    .progress>.label.warn {
      color: var(--ink);
      text-shadow: none;
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700;
      border: 1px solid var(--stroke)
    }

    .b-hedef {
      background: #0ea5e933;
    }

    .b-teberru {
      background: #f59e0b22
    }

    .b-tahsilat {
      background: #22c55e22
    }

    .k1 {
      border-color: color-mix(in oklab, var(--kpi1) 40%, var(--stroke));
      background: linear-gradient(180deg, color-mix(in oklab, var(--kpi1) 15%, transparent), transparent)
    }

    .k2 {
      border-color: color-mix(in oklab, var(--kpi2) 40%, var(--stroke));
      background: linear-gradient(180deg, color-mix(in oklab, var(--kpi2) 15%, transparent), transparent)
    }

    .k3 {
      border-color: color-mix(in oklab, var(--kpi3) 40%, var(--stroke));
      background: linear-gradient(180deg, color-mix(in oklab, var(--kpi3) 15%, transparent), transparent)
    }

    .k-kurban {
      border: 1px solid color-mix(in oklab, #f97316 40%, var(--stroke));
      background: linear-gradient(180deg, rgba(249, 115, 22, .09), transparent);
    }

    .k-kurban-total {
      border: 1px solid color-mix(in oklab, #f97316 55%, var(--stroke));
      background: linear-gradient(180deg, rgba(249, 115, 22, .16), transparent);
    }

    .badge.b-kurban {
      background: rgba(249, 115, 22, .11);
      border: 1px solid rgba(249, 115, 22, .28);
      color: #fff;
    }

    .kpi.has-bar {
      padding-bottom: 28px
    }

    .kpi-bar {
      position: absolute;
      left: 12px;
      right: 12px;
      bottom: 10px;
      height: 6px;
      border-radius: 999px;
      background: var(--surface);
      overflow: hidden;
      border: 1px solid var(--stroke);
      z-index: 1
    }

    .kpi-bar>span {
      display: block;
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, var(--good), var(--brand2))
    }

    .modal-arka {
      display: none;
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .45);
      z-index: 120
    }

    .modal-icerik {
      position: relative;
      max-width: 980px;
      width: 95%;
      margin: 40px auto;
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: 12px;
      box-shadow: var(--shadow);
      padding: 16px;
      max-height: 92vh;
      overflow: auto;
    }

    .modal-baslik {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid var(--stroke);
      padding-bottom: 8px;
      margin-bottom: 12px
    }

    .modal-kapat {
      border: 1px solid var(--stroke);
      background: var(--pill);
      color: var(--text);
      padding: 8px 12px;
      border-radius: 999px;
      cursor: pointer
    }

    .ozet {
      display: grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 10px
    }

    .hareket-kap {
      overflow-x: auto;
      margin-top: 12px
    }

    .hareket-tablo {
      width: 100%;
      min-width: 720px;
      border-collapse: separate;
      border-spacing: 0 6px
    }

    .hareket-tablo th,
    .hareket-tablo td {
      padding: 8px 10px;
      border-bottom: 1px solid var(--stroke);
      text-align: center;
      white-space: nowrap
    }

    .etiket {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 700
    }

    .etiket-hedef {
      background: #eaf7ff;
      color: #0b6dbf;
      border: 1px solid #cde8ff
    }

    .etiket-teberru {
      background: #fff2e6;
      color: #c45a00;
      border: 1px solid #ffd9b3
    }

    .etiket-tahsilat {
      background: #ecffe9;
      color: #177a2a;
      border: 1px solid #c8f1c3
    }

    .etiket-kurban {
      background: #fffbd1;
      color: #b45309;
      border: 1px solid #fde68a
    }

    .sort-head {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px
    }

    .sort-arrows span {
      cursor: pointer;
      padding: 0 2px;
      opacity: .55
    }

    .sort-arrows span.active {
      opacity: 1;
      font-weight: 900
    }

    .sort-arrows span:hover {
      opacity: .9
    }

    @media (max-width: 1024px) {
      .ozet {
        grid-template-columns: repeat(2, minmax(0, 1fr))
      }

      .col-8,
      .col-9,
      .col-10,
      .col-4,
      .col-3,
      .col-2,
      .col-6,
      .col-12 {
        grid-column: span 12
      }

      .modal-icerik {
        width: 96%;
        padding: 12px
      }

      .hareket-tablo th,
      .hareket-tablo td {
        padding: 6px 8px;
        font-size: 13px
      }
    }

    @media (max-width: 820px) {
      #tableWrap {
        overflow-x: auto
      }

      #hedefTablosu {
        min-width: 980px
      }
    }

    @media (max-width: 640px) {
      .ozet {
        grid-template-columns: 1fr
      }

      .modal-icerik {
        font-size: 14px
      }
    }

    /* === SAÄ PANEL (AÃ‡IK TEMA) === */
    .kf-side {
      display: flex;
      flex-direction: column;
      gap: 14px;
      background: #ffffff;
      border: 1px solid rgba(15, 23, 42, .04);
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(15, 23, 42, .04);
      min-width: 0;
      overflow: hidden;
    }

    .kf-side-head {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
    }

    .kf-side-head h3 {
      margin: 0;
      font-size: 15.5px;
      color: #0f172a;
    }

    .kf-side-head p {
      margin: 3px 0 0;
      font-size: 12px;
      color: #6b7280;
    }

    .kf-side-refresh {
      width: 30px;
      height: 30px;
      border: 1px solid rgba(148, 163, 184, .35);
      background: #fff;
      border-radius: 999px;
      color: #0f172a;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: .12s;
    }

    .kf-side-refresh:hover {
      background: #f3f4f6;
    }

    /* ÃœST BLOK */
    .kf-topline {
      display: flex;
      gap: 12px;
      align-items: stretch;
      background: linear-gradient(140deg, #eef5ff 0%, #ffffff 60%);
      border: 1px solid rgba(148, 163, 184, .12);
      border-radius: 14px;
      padding: 10px 10px 10px;
    }

    .kf-badge-oran {
      min-width: 96px;
      background: #ffffff;
      border: 1px solid rgba(148, 163, 184, .15);
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      gap: 2px;
      padding: 5px 8px 6px;
    }

    .kf-badge-oran small {
      font-size: 11px;
      color: #6b7280;
    }

    .kf-badge-oran span,
    .kf-badge-oran #toplamOran {
      font-size: 25px;
      font-weight: 800;
      color: #0f172a;
      letter-spacing: -.04em;
    }

    .kf-topline-right {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .kf-top-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11.5px;
      color: #6b7280;
    }

    .kf-top-row strong {
      font-size: 16px;
      color: #0f172a;
      font-weight: 700;
    }

    .kf-bar-wrap {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .kf-bar {
      width: 100%;
      height: 8px;
      background: #e5e7eb;
      border-radius: 999px;
      overflow: hidden;
    }

    .kf-bar>#oranBar {
      width: 0%;
      height: 100%;
      background: linear-gradient(90deg, #0ea5e9 0%, #22c55e 100%);
      border-radius: 999px;
      transition: width .25s ease;
    }

    .kf-bar-text {
      font-size: 11.5px;
      color: #94a3b8;
    }

    /* ORTA 3â€™LÃœ */
    .kf-metrics {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 8px;
    }

    .kf-metric {
      background: #f8fafc;
      border: 1px solid rgba(148, 163, 184, .12);
      border-radius: 12px;
      padding: 7px 8px 7px;
      display: flex;
      flex-direction: column;
      gap: 3px;
      min-height: 68px;
    }

    .kf-metric .lbl {
      font-size: 11px;
      color: #6b7280;
    }

    .kf-metric .val {
      font-size: 17px;
      font-weight: 700;
      letter-spacing: -.01em;
      color: #0f172a;
    }

    .kf-metric .sub {
      font-size: 10px;
      color: #94a3b8;
    }

    /* KURBAN */
    .kf-kurban-box {
      background: #f3faf8;
      border: 1px solid rgba(34, 197, 235, .16);
      border-radius: 14px;
      padding: 10px 10px 9px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .kf-kurban-head {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 8px;
    }

    .kf-kurban-head h4 {
      margin: 0;
      font-size: 15px;
      display: flex;
      align-items: center;
      gap: 4px;
      color: #0f172a;
    }

    .kf-kurban-head p {
      margin: 2px 0 0;
      font-size: 11px;
      color: #6b7280;
    }

    .kf-tag {
      background: #ffffff;
      border: 1px solid rgba(14, 165, 233, .35);
      border-radius: 999px;
      padding: 3px 10px 4px;
      font-size: 10.8px;
      color: #0f172a;
    }

    .kf-kurban-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 6px;
    }

    .kf-k-item {
      background: #ffffff;
      border: 1px solid rgba(148, 163, 184, .12);
      border-radius: 10px;
      padding: 6px 6px 5px;
    }

    .kf-k-item .lbl {
      font-size: 10.5px;
      color: #6b7280;
    }

    .kf-k-item .val {
      font-size: 13.5px;
      font-weight: 700;
      color: #0f172a;
    }

    .kf-k-item.total {
      background: linear-gradient(135deg, #0ea5e9 0%, #22c55e 100%);
      border: none;
      color: #fff;
      box-shadow: 0 6px 18px rgba(14, 165, 233, .35);
    }

    .kf-k-item.total .lbl {
      color: rgba(255, 255, 255, .7);
    }

    .kf-k-item.total .val {
      font-size: 15px;
      font-weight: 800;
    }

    @media (max-width:1024px) {
      .kf-metrics {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }

      .kf-kurban-grid {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }

    @media (max-width:540px) {
      .kf-topline {
        flex-direction: column;
      }

      .kf-badge-oran {
        width: 100%;
        flex-direction: row;
        justify-content: space-between;
      }

      .kf-metrics {
        grid-template-columns: 1fr;
      }

      .kf-kurban-grid {
        grid-template-columns: 1fr 1fr;
      }
    }
  </style>

  <!-- Supabase (Auth + Database iÃ§in) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="../src/supabase.js"></script>
  <script src="../src/supabase-auth-wrapper.js"></script>
  <script src="../src/supabase-db-wrapper.js"></script>
  
  <script>
    // window.auth'u Supabase Auth Wrapper ile initialize et (ortak.js iÃ§in gerekli)
    (function() {
      function initAuth() {
        if (typeof window.getSupabaseAuth === 'function') {
          window.auth = window.getSupabaseAuth();
          // ortak.js'deki initWhenReady() iÃ§in window.auth'u hazÄ±rla
          // EÄŸer ortak.js'deki initWhenReady() Firebase kontrolÃ¼ yapÄ±yorsa, Supabase iÃ§in de Ã§alÄ±ÅŸmasÄ± iÃ§in window.auth'u hazÄ±r tutuyoruz
          return true;
        }
        return false;
      }
      
      function waitAndTriggerInit() {
        if (typeof window.auth !== 'undefined' && window.auth && typeof window.initAppShellAuth === 'function') {
          // window.auth hazÄ±r, initAppShellAuth'u manuel Ã§aÄŸÄ±r (ortak.js'deki initWhenReady Firebase kontrolÃ¼ yapÄ±yor)
          console.log('âœ… Supabase Auth hazÄ±r, initAppShellAuth manuel Ã§aÄŸrÄ±lÄ±yor');
          try {
            window.initAppShellAuth();
          } catch (e) {
            console.error('initAppShellAuth hatasÄ±:', e);
          }
        } else if (typeof window.initAppShellAuth === 'function') {
          // Biraz daha bekle
          setTimeout(waitAndTriggerInit, 100);
        }
      }
      
      if (!initAuth()) {
        let retries = 0;
        const maxRetries = 50;
        const retryInterval = setInterval(function() {
          retries++;
          if (initAuth() || retries >= maxRetries) {
            clearInterval(retryInterval);
            if (window.auth) {
              console.log('âœ… Supabase Auth Wrapper hazÄ±r');
              // initAppShellAuth'u tetikle
              setTimeout(waitAndTriggerInit, 200);
            }
          }
        }, 100);
      } else {
        console.log('âœ… Supabase Auth Wrapper hazÄ±r');
        // initAppShellAuth'u tetikle
        setTimeout(waitAndTriggerInit, 200);
      }
    })();
  </script>

  <!-- Ortak JS (navigation, toast, vs) -->
  <script src="../js/ortak.js"></script>
</head>

<body>
  <!-- ÃœST APPBAR (rapor-personel.html ile aynÄ± yapÄ±) -->
  <div class="appbar">
    <div class="brand" onclick="location.href='../panel.html'">
      <img src="../img/logo.png" alt="logo"><span>KARAAÄAÃ‡ FATÄ°H</span>
    </div>
    <nav class="nav-center">
      <ul class="nav-list" id="navMain"></ul>
    </nav>
    <div class="nav-right">
      <button class="btn hamb" id="hamburger" title="MenÃ¼">â˜°</button>

      <!-- Bildirim -->
      <div class="nav-item">
        <button class="iconbtn" id="btnNotif" title="Bildirimler">ğŸ””
          <span class="badge" id="notifBadge" style="display:none">0</span>
        </button>
        <div class="dropdown drop-right" id="notifDropdown" aria-label="Bildirim listesi">
          <div class="muted" style="padding:6px 8px">Son bildirimler</div>
          <div id="notifList" class="list" style="max-height:300px;overflow:auto"></div>
        </div>
      </div>

      <!-- Profil -->
      <div class="nav-item">
        <button class="iconbtn" id="btnProfile" title="Profil">
          <span class="avatar"></span> <span id="profName" class="muted">Profil</span>
        </button>
        <div class="dropdown drop-right" id="profDropdown" aria-label="Profil menÃ¼sÃ¼">
          <a href="../diger/kullanici-yonetimi.html">ğŸ‘¤ Profil</a>
          <a href="../diger/sistem-ayarlari.html">âš™ï¸ Sistem AyarlarÄ±</a>
          <a href="#" id="btnLogout">ğŸšª Ã‡Ä±kÄ±ÅŸ Yap</a>
        </div>
      </div>
    </div>
  </div>
  <aside class="drawer" id="drawer"></aside>
  <div class="toast-container" id="toastContainer"></div>

  <main class="wrap">
    <section class="hero">
      <div>
        <h2><span id="kapsamUst">-</span> GrafiÄŸi</h2>
        <div class="hero-sub">Personelin seÃ§ili ayda yaptÄ±ÄŸÄ±;</div>
        <div class="hero-sub1">toplam teberru, tahsilat, kurban (kk/bb) + seÃ§ili kategorideki hedef/temin â†’ ulaÅŸma
          nispeti.</div>
        <div class="mini">
          <span class="pill">ğŸ•’ Son GÃ¼ncelleme: <b id="guncellemeZamani">yÃ¼kleniyorâ€¦</b></span>
          <span class="pill">ğŸ“… Kapsam: <b id="kapsamPill">-</b></span>
          <span class="pill">Versiyon: <b>2.0.0</b></span>
          <button class="pill" id="ekranButonu"
            style="cursor:pointer; border:1px solid var(--stroke); background:var(--pill); font-size:12px; padding:6px 10px; border-radius:999px; color:var(--text);">Ekran:
            <b id="ekranAdi">Hedef</b></button>
        </div>
      </div>
    </section>

    <div class="grid">
      <div class="card col-9">
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px">
          <h3 style="margin:0">Tablo</h3>
          <label class="personel-toggle" title="Personel kolonunu gÃ¶ster/gizle">
            <input type="checkbox" id="personelToggle" checked>
            <span class="toggle-slider"></span>
            <span class="toggle-label">Personel</span>
          </label>
        </div>

        <div class="row-grid" style="margin-bottom:12px">
          <div class="cell">
            <label for="kategoriSecimi">Kategori</label>
            <select id="kategoriSecimi">
              <option value="TÃ¼mÃ¼">TÃ¼mÃ¼</option>
              <option value="Kitap KampanyasÄ±">Kitap KampanyasÄ±</option>
              <option value="EylÃ¼l Kermesi">EylÃ¼l Kermesi</option>
              <option value="AraÃ§">Kurs ArabasÄ±</option>
              <option value="Talebeye Ä°kram">Talebeye Ä°kram</option>
              <option value="Mevlid Kandili">Mevlid Kandili</option>
            </select>
          </div>
          <div class="cell">
            <label for="filtreSecimi">Filtre</label>
            <select id="filtreSecimi">
              <option value="oran-azalan" selected>UlaÅŸma Nispeti (Azalan)</option>
              <option value="oran-artan">UlaÅŸma Nispeti (Artan)</option>
              <option value="personel-az">Personel (A â†’ Z)</option>
              <option value="personel-za">Personel (Z â†’ A)</option>
              <option value="hedef-artan">Hedef (Artan)</option>
              <option value="hedef-azalan">Hedef (Azalan)</option>
              <option value="temin-artan">Temin (Artan)</option>
              <option value="temin-azalan">Temin (Azalan)</option>
              <option value="teberru-artan">Teberru (Artan)</option>
              <option value="teberru-azalan">Teberru (Azalan)</option>
              <option value="tahsilat-artan">Tahsilat (Artan)</option>
              <option value="tahsilat-azalan">Tahsilat (Azalan)</option>
            </select>
          </div>
          <div class="cell">
            <label for="yilSec">YÄ±l</label>
            <select id="yilSec"></select>
          </div>
          <div class="cell">
            <label for="aySec">Ay</label>
            <select id="aySec">
              <option value="">-</option>
              <option value="1">Ocak</option>
              <option value="2">Åubat</option>
              <option value="3">Mart</option>
              <option value="4">Nisan</option>
              <option value="5">MayÄ±s</option>
              <option value="6">Haziran</option>
              <option value="7">Temmuz</option>
              <option value="8">AÄŸustos</option>
              <option value="9">EylÃ¼l</option>
              <option value="10">Ekim</option>
              <option value="11">KasÄ±m</option>
              <option value="12">AralÄ±k</option>
            </select>
          </div>
          <div class="right-note">SatÄ±ra tÄ±klayÄ±nca detay aÃ§Ä±lÄ±r.</div>
        </div>

        <div id="tableWrap">
          <table id="hedefTablosu">
            <colgroup id="tabloColgroup">
              <col class="c-personel">
              <col class="c-mid">
              <col class="c-mid">
              <col class="c-kurban">
              <col class="c-kurban">
              <col class="c-mid">
              <col class="c-mid">
              <col class="c-oran">
            </colgroup>
            <thead>
              <tr id="tabloBasliklari">
                <th>Personel</th>
                <th>Teberru</th>
                <th>Tahsilat</th>
                <th>Kurban (K)</th>
                <th>Kurban (B)</th>
                <th>Hedef</th>
                <th>Temin Edilen</th>
                <th>UlaÅŸma Nispeti (%)</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
          <div class="under-note" id="altNot">-</div>
        </div>
      </div>

      <div class="card col-3 kf-side">
        <div class="kf-side-head">
          <div>
            <h3>Ã–zet</h3>
            <p id="ozetAltMetin">SeÃ§ili ay / kategori</p>
          </div>
          <button class="kf-side-refresh" onclick="aboneOl()" title="Yenile">âŸ³</button>
        </div>

        <!-- ÃœST: ULAÅMA ORANI + TEMÄ°N/HEDEF -->
        <div class="kf-topline">
          <div class="kf-badge-oran">
            <small>UlaÅŸma</small>
            <span id="toplamOran">%0</span>
          </div>
          <div class="kf-topline-right">
            <div class="kf-top-row">
              <span>Temin</span>
              <strong id="toplamTemin">â‚º0</strong>
            </div>
            <div class="kf-top-row">
              <span>Hedef</span>
              <strong id="toplamHedef">â‚º0</strong>
            </div>
            <div class="kf-bar-wrap">
              <div class="kf-bar">
                <div id="oranBar"></div>
              </div>
              <span class="kf-bar-text">Genel ulaÅŸma oranÄ±</span>
            </div>
          </div>
        </div>

        <!-- ORTA: METRÄ°KLER (Dinamik) -->
        <div class="kf-metrics" id="ozetMetrikler">
          <!-- Hedef modu -->
          <div class="kf-metric">
            <span class="lbl">Teberru</span>
            <span class="val" id="toplamTeberru">â‚º0</span>
            <span class="sub">Bu ay yapÄ±lan</span>
          </div>
          <div class="kf-metric">
            <span class="lbl">Tahsilat</span>
            <span class="val" id="toplamTahsilat">â‚º0</span>
            <span class="sub">TÃ¼m tahsilatlar</span>
          </div>
          <div class="kf-metric">
            <span class="lbl">Temin / Hedef</span>
            <span class="val" id="toplamTeminDisplay">â‚º0</span>
            <span class="sub">GerÃ§ekleÅŸen</span>
          </div>
          <!-- Ramazan-Ä± Åerif modu (gizli) -->
          <div class="kf-metric" id="ozetIftar" style="display:none">
            <span class="lbl">Ä°ftar</span>
            <span class="val" id="toplamIftar">â‚º0</span>
            <span class="sub">Ä°ftar toplamÄ±</span>
          </div>
          <div class="kf-metric" id="ozetSahur" style="display:none">
            <span class="lbl">Sahur</span>
            <span class="val" id="toplamSahur">â‚º0</span>
            <span class="sub">Sahur toplamÄ±</span>
          </div>
          <div class="kf-metric" id="ozetTaahhut" style="display:none">
            <span class="lbl">TaahhÃ¼t</span>
            <span class="val" id="toplamTaahhut">â‚º0</span>
            <span class="sub">TaahhÃ¼t toplamÄ±</span>
          </div>
        </div>

        <!-- ALT: KURBAN -->
        <div class="kf-kurban-box">
          <div class="kf-kurban-head">
            <div>
              <h4>ğŸ‘ Kurban</h4>
              <p>Bu kapsamda toplanan adetler</p>
            </div>
            <span class="kf-tag" id="kapsamPill2">SeÃ§ili ay</span>
          </div>
          <div class="kf-kurban-grid">
            <div class="kf-k-item">
              <span class="lbl">KÃ¼Ã§Ã¼kbaÅŸ</span>
              <span class="val" id="toplamKurbanKk">0 adet</span>
            </div>
            <div class="kf-k-item">
              <span class="lbl">BÃ¼yÃ¼kbaÅŸ</span>
              <span class="val" id="toplamKurbanBb">0 adet</span>
            </div>
            <div class="kf-k-item total">
              <span class="lbl">Toplam</span>
              <span class="val" id="toplamKurbanGenel">0 adet</span>
            </div>
          </div>
        </div>
      </div>

  </main>

  <div class="modal-arka" id="detayModal">
    <div class="modal-icerik">
      <div class="modal-baslik">
        <h3 id="modalBaslik">Detay</h3>
        <button class="modal-kapat" id="modalKapat">Kapat</button>
      </div>

      <div class="mini" style="margin-bottom:10px">
        <span class="pill">ğŸ“… <b id="modalKapsamEtiketi">-</b></span>
        <span class="pill">ğŸ·ï¸ <b id="modalKategoriEtiketi">-</b></span>
      </div>

      <div class="ozet">
        <div class="kpi">
          <div>
            <div class="sub">Teberru</div>
            <div class="val" id="m_teberruTop">â‚º0</div>
          </div>
        </div>
        <div class="kpi">
          <div>
            <div class="sub">Tahsilat</div>
            <div class="val" id="m_tahsilatTop">â‚º0</div>
          </div>
        </div>
        <div class="kpi">
          <div>
            <div class="sub">Hedef Toplam</div>
            <div class="val" id="m_hedefTop">â‚º0</div>
          </div>
        </div>
        <div class="kpi">
          <div>
            <div class="sub">Hedef Temini</div>
            <div class="val" id="m_hedefTeminTop">â‚º0</div>
          </div>
        </div>
        <div class="kpi">
          <div>
            <div class="sub">UlaÅŸma Nispeti</div>
            <div class="val" id="m_oranTop">%0</div>
          </div>
        </div>
      </div>

      <div class="hareket-kap">
        <table class="hareket-tablo" id="m_hareketTablo">
          <thead>
            <tr>
              <th>
                <div class="sort-head">Tarih
                  <span class="sort-arrows">
                    <span data-key="t" data-dir="asc">â†‘</span>
                    <span data-key="t" data-dir="desc">â­£</span>
                  </span>
                </div>
              </th>
              <th>
                <div class="sort-head">Ad Soyad
                  <span class="sort-arrows">
                    <span data-key="ad" data-dir="asc">â†‘</span>
                    <span data-key="ad" data-dir="desc">â­£</span>
                  </span>
                </div>
              </th>
              <th>
                <div class="sort-head">Miktar (â‚º / Adet)
                  <span class="sort-arrows">
                    <span data-key="miktar" data-dir="asc">â†‘</span>
                    <span data-key="miktar" data-dir="desc">â­£</span>
                  </span>
                </div>
              </th>
              <th>
                <div class="sort-head">TÃ¼r
                  <span class="sort-arrows">
                    <span data-key="tur" data-dir="asc">â†‘</span>
                    <span data-key="tur" data-dir="desc">â­£</span>
                  </span>
                </div>
              </th>
              <th>
                <div class="sort-head">AÃ§Ä±klama
                  <span class="sort-arrows">
                    <span data-key="aciklama" data-dir="asc">â†‘</span>
                    <span data-key="aciklama" data-dir="desc">â­£</span>
                  </span>
                </div>
              </th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Toast alanÄ± ortak.js tarafÄ±ndan yÃ¶netilir -->

  <script>
    // DOMContentLoaded'da Ã§alÄ±ÅŸtÄ±r - ortak.js yÃ¼klenene kadar bekle
    document.addEventListener('DOMContentLoaded', function () {
      // Supabase ve ortak.js yÃ¼klenene kadar bekle
      function waitForSupabaseAndOrtak(callback) {
        if (typeof window.supabase !== 'undefined' && typeof window.norm !== 'undefined' && typeof window.showToast !== 'undefined') {
          callback();
        } else {
          setTimeout(() => waitForSupabaseAndOrtak(callback), 50);
        }
      }

      waitForSupabaseAndOrtak(() => {
        console.log('âœ… waitForSupabaseAndOrtak callback Ã§alÄ±ÅŸtÄ±');
        // ortak.js yÃ¼klendikten ve auth tamamlandÄ±ktan sonra Ã§aÄŸrÄ±lÄ±r
        window.initPage = async function () {
          console.log('ğŸš€ window.initPage Ã§aÄŸrÄ±ldÄ±');
          // Supabase client ve auth helper'larÄ±
          const getSupabase = () => window.supabase;
          const getAuth = () => window.getSupabaseAuth ? window.getSupabaseAuth() : null;
          const showToast = window.showToast;

          const kategoriSecimi = document.getElementById("kategoriSecimi");
          const filtreSecimi = document.getElementById("filtreSecimi");
          const tabloBody = document.querySelector("#hedefTablosu tbody");

          const toplamTeberruEl = document.getElementById("toplamTeberru");
          const toplamTahsilatEl = document.getElementById("toplamTahsilat");
          const toplamHedefEl = document.getElementById("toplamHedef");
          const toplamTeminEl = document.getElementById("toplamTemin");
          const toplamOranEl = document.getElementById("toplamOran");
          const oranBar = document.getElementById("oranBar");
          const guncellemeEl = document.getElementById("guncellemeZamani");
          const kapsamUst = document.getElementById("kapsamUst");
          const kapsamPill = document.getElementById("kapsamPill");
          const altNot = document.getElementById("altNot");
          const ekranButonu = document.getElementById("ekranButonu");
          const ekranAdi = document.getElementById("ekranAdi");

          const yilSec = document.getElementById('yilSec');
          const aySec = document.getElementById('aySec');

          // Ekran modu state (Hedef veya Ramazan-Ä± Åerif)
          let ekranModu = localStorage.getItem('hedefGrafik_ekranModu') || 'Hedef';
          if (ekranAdi) ekranAdi.textContent = ekranModu;

          // Personel kolonu gÃ¶ster/gizle
          const personelToggle = document.getElementById('personelToggle');
          let personelGoster = localStorage.getItem('hedefGrafik_personelGoster') !== 'false';
          if (personelToggle) personelToggle.checked = personelGoster;

          function personelKolonunuGuncelle() {
            const goster = personelToggle ? personelToggle.checked : true;
            const thead = document.querySelector('#hedefTablosu thead tr');
            const tbodyRows = document.querySelectorAll('#hedefTablosu tbody tr');
            const colgroup = document.querySelector('#tabloColgroup col:first-child');

            if (thead) {
              const personelTh = thead.querySelector('th:first-child');
              if (personelTh) {
                personelTh.style.display = goster ? '' : 'none';
              }
            }

            tbodyRows.forEach(row => {
              const personelTd = row.querySelector('td:first-child');
              if (personelTd) {
                personelTd.style.display = goster ? '' : 'none';
              }
            });

            if (colgroup) {
              colgroup.style.display = goster ? '' : 'none';
            }
          }

          if (personelToggle) {
            personelToggle.addEventListener('change', () => {
              personelGoster = personelToggle.checked;
              localStorage.setItem('hedefGrafik_personelGoster', personelGoster);
              personelKolonunuGuncelle();
            });
            // Ä°lk yÃ¼klemede uygula
            setTimeout(() => personelKolonunuGuncelle(), 100);
          }

          const modalArka = document.getElementById('detayModal');
          const modalKapat = document.getElementById('modalKapat');
          const m_hareketTabloBody = document.querySelector('#m_hareketTablo tbody');
          const m_baslik = document.getElementById('modalBaslik');
          const m_kapsamEtik = document.getElementById('modalKapsamEtiketi');
          const m_kategoriEtik = document.getElementById('modalKategoriEtiketi');
          const m_hedefTop = document.getElementById('m_hedefTop');
          const m_hedefTeminTop = document.getElementById('m_hedefTeminTop');
          const m_teberruTop = document.getElementById('m_teberruTop');
          const m_tahsilatTop = document.getElementById('m_tahsilatTop');
          const m_oranTop = document.getElementById('m_oranTop');

          modalKapat.addEventListener('click', () => modalArka.style.display = 'none');
          modalArka.addEventListener('click', (e) => { if (e.target === modalArka) modalArka.style.display = 'none'; });

          function toNum(v) { if (typeof v === 'number') return v; if (typeof v === 'string') { const n = Number(v.replace(/\./g, '').replace(',', '.')); return isNaN(n) ? 0 : n; } return 0; }
          const tidy = s => (s || '').toString().trim().replace(/\s+/g, ' ');
          function toTitleTR(s) {
            const t = tidy(s).toLocaleLowerCase('tr-TR');
            return t.replace(/(^|[\s\-_/\\.])([\p{L}\p{M}])/gu, (m, p1, p2) => p1 + p2.toLocaleUpperCase('tr-TR'));
          }
          const ALIASES = new Map([
            ['keramettin kocaoÄŸlu', 'Kerem KocaoÄŸlu'],
            ['kerem kocaoÄŸlu', 'Kerem KocaoÄŸlu'],
          ]);
          function canonName(s) {
            const t = toTitleTR(s);
            const key = t.toLocaleLowerCase('tr-TR');
            return ALIASES.get(key) || t;
          }

          function ayAdi(n) { const map = ['', 'Ocak', 'Åubat', 'Mart', 'Nisan', 'MayÄ±s', 'Haziran', 'Temmuz', 'AÄŸustos', 'EylÃ¼l', 'Ekim', 'KasÄ±m', 'AralÄ±k']; return map[Number(n) || 0] || '-'; }
          function localRangeFor(year, month) { if (!year) return { start: null, end: null }; if (!month) { return { start: new Date(year, 0, 1, 0, 0, 0), end: new Date(Number(year) + 1, 0, 1, 0, 0, 0) }; } return { start: new Date(year, month - 1, 1, 0, 0, 0), end: new Date(year, month, 1, 0, 0, 0) }; }
          function kapsamMetni(year, month, kategori) { const parcaAy = month ? `${ayAdi(month)} ${year}` : `${year} (tÃ¼m yÄ±l)`; const parcaKat = kategori === 'TÃ¼mÃ¼' ? 'TÃ¼m Kategoriler' : kategori; return `${parcaKat} â€¢ ${parcaAy}`; }
          function kapsambaslikMetni(year, month, kategori) { const parcaAy = month ? `${ayAdi(month)} ${year}` : `${year} (tÃ¼m yÄ±l)`; const parcaKat = kategori === 'TÃ¼mÃ¼' ? 'TÃ¼m Kategoriler' : kategori; return `${parcaKat} â€¢ ${parcaAy}`; }

          function getWhen(d) {
            // Ä°ÅŸlem tarihi: Ã¶nce updatedat (kÃ¼Ã§Ã¼k harf - Supabase ÅŸemasÄ±), sonra createdat (kÃ¼Ã§Ã¼k harf)
            // tarih alanÄ± kullanÄ±lmaz (kayÄ±t aÅŸamasÄ±nda seÃ§ilen tarih, iÅŸlem tarihi deÄŸil)
            if (d?.updatedat) {
              if (typeof d.updatedat === 'string') {
                const x = new Date(d.updatedat);
                if (!isNaN(x.getTime())) return x;
              } else if (d.updatedat instanceof Date) {
                return d.updatedat;
              }
            }
            // Fallback: camelCase (eski veriler iÃ§in)
            if (d?.updatedAt) {
              if (typeof d.updatedAt === 'string') {
                const x = new Date(d.updatedAt);
                if (!isNaN(x.getTime())) return x;
              } else if (d.updatedAt instanceof Date) {
                return d.updatedAt;
              }
            }
            // Ã–nce kÃ¼Ã§Ã¼k harf (Supabase ÅŸemasÄ±)
            if (d?.createdat) {
              if (typeof d.createdat === 'string') {
                const x = new Date(d.createdat);
                if (!isNaN(x.getTime())) return x;
              } else if (d.createdat instanceof Date) {
                return d.createdat;
              }
            }
            // Fallback: camelCase (eski veriler iÃ§in)
            if (d?.createdAt) {
              if (typeof d.createdAt === 'string') {
                const x = new Date(d.createdAt);
                if (!isNaN(x.getTime())) return x;
              } else if (d.createdAt instanceof Date) {
                return d.createdAt;
              }
            }
            return null;
          }

          let veriTablosu = [];
          // Supabase iÃ§in subscription'larÄ± tutmak yerine polling veya realtime kullanacaÄŸÄ±z
          let refreshInterval = null;
          let cacheTeminHedef = {}, cacheTeberru = {}, cacheTahsilat = {}, sonHedefMap = {};
          let iftarMap = {}, sahurMap = {}, taahhutMap = {};
          let maxUpdateTs = 0;

          // Supabase helper: timestamp'i number'a Ã§evir
          function getTimestampNumber(d, field = 'createdat') {
            if (!d || !d[field]) return 0;
            const val = d[field];
            if (typeof val === 'string') {
              const d = new Date(val);
              return isNaN(d.getTime()) ? 0 : d.getTime();
            }
            if (val instanceof Date) return val.getTime();
            return Number(val) || 0;
          }

          function tabloBasliklariniGuncelle() {
            const thead = document.getElementById('tabloBasliklari');
            const colgroup = document.getElementById('tabloColgroup');
            const tablo = document.getElementById('hedefTablosu');
            if (!thead || !colgroup) return;

            if (ekranModu === 'Ramazan-Ä± Åerif') {
              if (tablo) tablo.classList.add('mod-ramazan');
              colgroup.innerHTML = `
          <col class="c-personel">
          <col class="c-mid">
          <col class="c-mid">
          <col class="c-mid">
          <col class="c-mid">
          <col class="c-mid">
          <col class="c-mid">
          <col class="c-oran">
          <col class="c-kurban">
          <col class="c-kurban">
        `;
              thead.innerHTML = `
          <th>Personel</th>
          <th>Hedef</th>
          <th>Ä°ftar</th>
          <th>Sahur</th>
          <th>TaahhÃ¼t</th>
          <th>Teberru</th>
          <th>Toplam Temin Edilen</th>
          <th>UlaÅŸma Nispeti (%)</th>
          <th>Kurban (K)</th>
          <th>Kurban (B)</th>
        `;
            } else {
              if (tablo) tablo.classList.remove('mod-ramazan');
              colgroup.innerHTML = `
          <col class="c-personel">
          <col class="c-mid">
          <col class="c-mid">
          <col class="c-kurban">
          <col class="c-kurban">
          <col class="c-mid">
          <col class="c-mid">
          <col class="c-oran">
        `;
              thead.innerHTML = `
          <th>Personel</th>
          <th>Teberru</th>
          <th>Tahsilat</th>
          <th>Kurban (K)</th>
          <th>Kurban (B)</th>
          <th>Hedef</th>
          <th>Temin Edilen</th>
          <th>UlaÅŸma Nispeti (%)</th>
        `;
            }
            // Personel kolonu durumunu uygula
            setTimeout(() => personelKolonunuGuncelle(), 50);
          }

          function ozetMetrikleriniGuncelle() {
            const teberruEl = document.getElementById('toplamTeberru');
            const tahsilatEl = document.getElementById('toplamTahsilat');
            const teminDisplayEl = document.getElementById('toplamTeminDisplay');
            const iftarEl = document.getElementById('toplamIftar');
            const sahurEl = document.getElementById('toplamSahur');
            const taahhutEl = document.getElementById('toplamTaahhut');
            const ozetIftar = document.getElementById('ozetIftar');
            const ozetSahur = document.getElementById('ozetSahur');
            const ozetTaahhut = document.getElementById('ozetTaahhut');

            if (ekranModu === 'Ramazan-Ä± Åerif') {
              // Ramazan-Ä± Åerif modunda Ä°ftar-Sahur-TaahhÃ¼t gÃ¶ster
              if (teberruEl && teberruEl.parentElement) teberruEl.parentElement.style.display = 'none';
              if (tahsilatEl && tahsilatEl.parentElement) tahsilatEl.parentElement.style.display = 'none';
              if (teminDisplayEl && teminDisplayEl.parentElement) teminDisplayEl.parentElement.style.display = 'none';
              if (ozetIftar) ozetIftar.style.display = 'flex';
              if (ozetSahur) ozetSahur.style.display = 'flex';
              if (ozetTaahhut) ozetTaahhut.style.display = 'flex';
            } else {
              // Hedef modunda Teberru-Tahsilat-Temin gÃ¶ster
              if (teberruEl && teberruEl.parentElement) teberruEl.parentElement.style.display = 'flex';
              if (tahsilatEl && tahsilatEl.parentElement) tahsilatEl.parentElement.style.display = 'flex';
              if (teminDisplayEl && teminDisplayEl.parentElement) teminDisplayEl.parentElement.style.display = 'flex';
              if (ozetIftar) ozetIftar.style.display = 'none';
              if (ozetSahur) ozetSahur.style.display = 'none';
              if (ozetTaahhut) ozetTaahhut.style.display = 'none';
            }
          }

          function tabloyuYenidenYaz(veriler) {
            tabloBody.innerHTML = "";
            const fmtPara = (n) => Math.round(n || 0).toLocaleString("tr-TR", { minimumFractionDigits: 0, maximumFractionDigits: 0 });

            veriler.forEach(p => {
              const tr = document.createElement("tr");

              const tdPersonel = document.createElement("td"); tdPersonel.className = 'wrap';
              tdPersonel.textContent = (p.oran >= 100 ? 'â­ ' : '') + p.personel;

              if (ekranModu === 'Ramazan-Ä± Åerif') {
                const tdHedef = document.createElement("td"); tdHedef.className = "col-hedef"; tdHedef.textContent = `${fmtPara(p.hedef)} â‚º`;
                const tdIftar = document.createElement("td"); tdIftar.textContent = `${fmtPara(p.iftar || 0)} â‚º`;
                const tdSahur = document.createElement("td"); tdSahur.textContent = `${fmtPara(p.sahur || 0)} â‚º`;
                const tdTaahhut = document.createElement("td"); tdTaahhut.textContent = `${fmtPara(p.taahhut || 0)} â‚º`;
                const tdTeberru = document.createElement("td"); tdTeberru.textContent = `${fmtPara(p.teberru || 0)} â‚º`;
                const toplamTemin = (p.iftar || 0) + (p.sahur || 0) + (p.taahhut || 0) + (p.teberru || 0);
                const tdToplamTemin = document.createElement("td"); tdToplamTemin.className = "col-temin"; tdToplamTemin.textContent = `${fmtPara(toplamTemin)} â‚º`;

                const tdOran = document.createElement("td");
                const prog = document.createElement('div'); prog.className = 'progress';
                const fill = document.createElement('div'); fill.className = 'fill';
                const lab = document.createElement('div'); lab.className = 'label';
                const bar = Math.max(0, Math.min(100, p.oran));
                fill.style.width = bar + '%';
                if (p.oran < 30) { fill.classList.add('danger'); lab.classList.add('danger'); }
                else if (p.oran < 50) { fill.classList.add('warn'); lab.classList.add('warn'); }
                else if (p.oran < 75) { /* fill: mavi (default), lab: beyaz (default) */ }
                else if (p.oran < 100) { fill.classList.add('good'); }
                else { fill.classList.add('ok'); }
                const oranStr = Number(p.oran).toFixed(2).replace('.', ',');
                let fullMsg = `%${oranStr}`, shortMsg = `%${oranStr}`;
                if (p.oran >= 100 && p.oran < 100.01) { fullMsg = 'Hedefinize ulaÅŸtÄ±nÄ±z'; shortMsg = 'Hedefinize ulaÅŸtÄ±nÄ±z'; }
                if (p.oran > 100) { fullMsg = 'Hedefinizi geÃ§tiniz'; shortMsg = 'Hedefinizi geÃ§tiniz'; }
                lab.textContent = shortMsg; lab.title = fullMsg;
                prog.appendChild(fill); prog.appendChild(lab); tdOran.appendChild(prog);

                const tdKk = document.createElement("td"); tdKk.textContent = p.kurbanKk || 0;
                const tdBb = document.createElement("td"); tdBb.textContent = p.kurbanBb || 0;

                tr.append(tdPersonel, tdHedef, tdIftar, tdSahur, tdTaahhut, tdTeberru, tdToplamTemin, tdOran, tdKk, tdBb);
              } else {
                const tdTeberru = document.createElement("td"); tdTeberru.textContent = `${fmtPara(p.teberru)} â‚º`;
                const tdTahsilat = document.createElement("td"); tdTahsilat.textContent = `${fmtPara(p.tahsilat)} â‚º`;
                const tdKk = document.createElement("td"); tdKk.textContent = p.kurbanKk || 0;
                const tdBb = document.createElement("td"); tdBb.textContent = p.kurbanBb || 0;
                const tdHedef = document.createElement("td"); tdHedef.className = "col-hedef"; tdHedef.textContent = `${fmtPara(p.hedef)} â‚º`;
                const tdTemin = document.createElement("td"); tdTemin.className = "col-temin"; tdTemin.textContent = `${fmtPara(p.teminHedef)} â‚º`;

                const tdOran = document.createElement("td");
                const prog = document.createElement('div'); prog.className = 'progress';
                const fill = document.createElement('div'); fill.className = 'fill';
                const lab = document.createElement('div'); lab.className = 'label';
                const bar = Math.max(0, Math.min(100, p.oran));
                fill.style.width = bar + '%';
                if (p.oran < 30) { fill.classList.add('danger'); lab.classList.add('danger'); }
                else if (p.oran < 50) { fill.classList.add('warn'); lab.classList.add('warn'); }
                else if (p.oran < 75) { /* fill: mavi (default), lab: beyaz (default) */ }
                else if (p.oran < 100) { fill.classList.add('good'); }
                else { fill.classList.add('ok'); }
                const oranStr = Number(p.oran).toFixed(2).replace('.', ',');
                let fullMsg = `%${oranStr}`, shortMsg = `%${oranStr}`;
                if (p.oran >= 100 && p.oran < 100.01) { fullMsg = 'Hedefinize ulaÅŸtÄ±nÄ±z'; shortMsg = 'Hedefinize ulaÅŸtÄ±nÄ±z'; }
                if (p.oran > 100) { fullMsg = 'Hedefinizi geÃ§tiniz'; shortMsg = 'Hedefinizi geÃ§tiniz'; }
                lab.textContent = shortMsg; lab.title = fullMsg;
                prog.appendChild(fill); prog.appendChild(lab); tdOran.appendChild(prog);

                tr.append(tdPersonel, tdTeberru, tdTahsilat, tdKk, tdBb, tdHedef, tdTemin, tdOran);
              }

              tr.addEventListener('click', () => acDetayModal(p.personel));
              tabloBody.appendChild(tr);
            });
            // Personel kolonu durumunu uygula
            setTimeout(() => personelKolonunuGuncelle(), 50);
          }

          function uygulaFiltre() {
            const f = filtreSecimi.value; let d = [...veriTablosu];
            const by = (k) => (a, b) => a[k] - b[k];
            switch (f) {
              case "personel-az": d.sort((a, b) => a.personel.localeCompare(b.personel, 'tr')); break;
              case "personel-za": d.sort((a, b) => b.personel.localeCompare(a.personel, 'tr')); break;
              case "hedef-artan": d.sort(by('hedef')); break;
              case "hedef-azalan": d.sort((a, b) => b.hedef - a.hedef); break;
              case "temin-artan":
                if (ekranModu === 'Ramazan-Ä± Åerif') {
                  d.sort((a, b) => (a.toplamTemin || 0) - (b.toplamTemin || 0));
                } else {
                  d.sort(by('teminHedef'));
                }
                break;
              case "temin-azalan":
                if (ekranModu === 'Ramazan-Ä± Åerif') {
                  d.sort((a, b) => (b.toplamTemin || 0) - (a.toplamTemin || 0));
                } else {
                  d.sort((a, b) => b.teminHedef - a.teminHedef);
                }
                break;
              case "teberru-artan": d.sort(by('teberru')); break;
              case "teberru-azalan": d.sort((a, b) => b.teberru - a.teberru); break;
              case "tahsilat-artan": d.sort(by('tahsilat')); break;
              case "tahsilat-azalan": d.sort((a, b) => b.tahsilat - a.tahsilat); break;
              case "oran-artan": d.sort(by('oran')); break;
              case "oran-azalan":
              default: d.sort((a, b) => b.oran - a.oran); break;
            }
            tabloyuYenidenYaz(d);
          }

          function toplamlariGuncelle() {
            const fmtPara = (n) => Math.round(n || 0).toLocaleString("tr-TR", { minimumFractionDigits: 0, maximumFractionDigits: 0 });

            if (ekranModu === 'Ramazan-Ä± Åerif') {
              const sumHedef = veriTablosu.reduce((s, x) => s + (x.hedef || 0), 0);
              const sumIftar = veriTablosu.reduce((s, x) => s + (x.iftar || 0), 0);
              const sumSahur = veriTablosu.reduce((s, x) => s + (x.sahur || 0), 0);
              const sumTaahhut = veriTablosu.reduce((s, x) => s + (x.taahhut || 0), 0);
              const sumTeberru = veriTablosu.reduce((s, x) => s + (x.teberru || 0), 0);
              const sumToplamTemin = sumIftar + sumSahur + sumTaahhut + sumTeberru;

              const sumKk = veriTablosu.reduce((s, x) => s + (x.kurbanKk || 0), 0);
              const sumBb = veriTablosu.reduce((s, x) => s + (x.kurbanBb || 0), 0);
              const sumKurban = sumKk + sumBb;

              const oran = sumHedef > 0 ? (sumToplamTemin / sumHedef) * 100 : 0;
              const oranStr = Number(oran).toFixed(2).replace('.', ',');

              toplamHedefEl.textContent = `â‚º${fmtPara(sumHedef)}`;
              toplamTeminEl.textContent = `â‚º${fmtPara(sumToplamTemin)}`;
              toplamOranEl.textContent = `%${oranStr}`;
              oranBar.style.width = Math.max(0, Math.min(100, oran)) + '%';

              const ttd = document.getElementById('toplamTeminDisplay');
              if (ttd) ttd.textContent = `â‚º${fmtPara(sumToplamTemin)}`;

              toplamTeberruEl.textContent = `â‚º${fmtPara(sumTeberru)}`;
              toplamTahsilatEl.textContent = `â‚º${fmtPara(sumIftar + sumSahur + sumTaahhut)}`;

              // Ä°ftar-Sahur-TaahhÃ¼t metriklerini gÃ¼ncelle
              const iftarEl = document.getElementById('toplamIftar');
              const sahurEl = document.getElementById('toplamSahur');
              const taahhutEl = document.getElementById('toplamTaahhut');
              if (iftarEl) iftarEl.textContent = `â‚º${fmtPara(sumIftar)}`;
              if (sahurEl) sahurEl.textContent = `â‚º${fmtPara(sumSahur)}`;
              if (taahhutEl) taahhutEl.textContent = `â‚º${fmtPara(sumTaahhut)}`;

              const kkEl = document.getElementById('toplamKurbanKk');
              const bbEl = document.getElementById('toplamKurbanBb');
              const gnEl = document.getElementById('toplamKurbanGenel');
              if (kkEl) kkEl.textContent = `${sumKk.toLocaleString('tr-TR')} adet`;
              if (bbEl) bbEl.textContent = `${sumBb.toLocaleString('tr-TR')} adet`;
              if (gnEl) gnEl.textContent = `${sumKurban.toLocaleString('tr-TR')} adet`;
            } else {
              const sumTeberru = veriTablosu.reduce((s, x) => s + (x.teberru || 0), 0);
              const sumTahsilat = veriTablosu.reduce((s, x) => s + (x.tahsilat || 0), 0);
              const sumHedef = veriTablosu.reduce((s, x) => s + (x.hedef || 0), 0);
              const sumTeminHF = veriTablosu.reduce((s, x) => s + (x.teminHedef || 0), 0);

              const sumKk = veriTablosu.reduce((s, x) => s + (x.kurbanKk || 0), 0);
              const sumBb = veriTablosu.reduce((s, x) => s + (x.kurbanBb || 0), 0);
              const sumKurban = sumKk + sumBb;

              const oran = sumHedef > 0 ? (sumTeminHF / sumHedef) * 100 : 0;
              const oranStr = Number(oran).toFixed(2).replace('.', ',');

              toplamTeberruEl.textContent = `â‚º${fmtPara(sumTeberru)}`;
              toplamTahsilatEl.textContent = `â‚º${fmtPara(sumTahsilat)}`;
              toplamHedefEl.textContent = `â‚º${fmtPara(sumHedef)}`;
              toplamTeminEl.textContent = `â‚º${fmtPara(sumTeminHF)}`;
              toplamOranEl.textContent = `%${oranStr}`;
              oranBar.style.width = Math.max(0, Math.min(100, oran)) + '%';

              const ttd = document.getElementById('toplamTeminDisplay');
              if (ttd) ttd.textContent = document.getElementById('toplamTemin').textContent;

              const kkEl = document.getElementById('toplamKurbanKk');
              const bbEl = document.getElementById('toplamKurbanBb');
              const gnEl = document.getElementById('toplamKurbanGenel');
              if (kkEl) kkEl.textContent = `${sumKk.toLocaleString('tr-TR')} adet`;
              if (bbEl) bbEl.textContent = `${sumBb.toLocaleString('tr-TR')} adet`;
              if (gnEl) gnEl.textContent = `${sumKurban.toLocaleString('tr-TR')} adet`;
            }
            // Ã–zet metriklerini gÃ¼ncelle (gÃ¶ster/gizle)
            ozetMetrikleriniGuncelle();
          }

          function derleVeYansit(hedefMap, teminMap, teberruMap, tahsilatMap, kurbanKkMap, kurbanBbMap) {
            const personeller = new Set([
              ...Object.keys(hedefMap),
              ...Object.keys(teminMap),
              ...Object.keys(teberruMap),
              ...Object.keys(tahsilatMap),
              ...Object.keys(kurbanKkMap),
              ...Object.keys(kurbanBbMap),
              ...Object.keys(iftarMap),
              ...Object.keys(sahurMap),
              ...Object.keys(taahhutMap)
            ]);
            const tabloDizi = [];
            personeller.forEach(key => {
              // BoÅŸ veya geÃ§ersiz personel adlarÄ±nÄ± filtrele
              if (!key || key === '-' || key.trim() === '') return;
              
              const personel = key;
              const hedef = toNum(hedefMap[key] || 0);
              const teminHedef = toNum(teminMap[key] || 0);
              const teberru = toNum(teberruMap[key] || 0);
              const tahsilat = toNum(tahsilatMap[key] || 0);
              const kurbanKk = toNum(kurbanKkMap[key] || 0);
              const kurbanBb = toNum(kurbanBbMap[key] || 0);
              const iftar = toNum(iftarMap[key] || 0);
              const sahur = toNum(sahurMap[key] || 0);
              const taahhut = toNum(taahhutMap[key] || 0);

              let oran;
              if (ekranModu === 'Ramazan-Ä± Åerif') {
                const toplamTemin = iftar + sahur + taahhut + teberru;
                oran = hedef > 0 ? (toplamTemin / hedef) * 100 : 0;
                tabloDizi.push({ personel, hedef, iftar, sahur, taahhut, teberru, kurbanKk, kurbanBb, oran, toplamTemin });
              } else {
                oran = hedef > 0 ? (teminHedef / hedef) * 100 : 0;
                tabloDizi.push({ personel, teberru, tahsilat, kurbanKk, kurbanBb, hedef, teminHedef, oran });
              }
            });
            veriTablosu = tabloDizi;
            uygulaFiltre();
            toplamlariGuncelle();

            const kat = kategoriSecimi.value;
            const yil = Number(yilSec.value);
            const ay = aySec.value === '' ? null : Number(aySec.value);
            const ust = kapsambaslikMetni(yil, ay, kat);
            kapsamUst.textContent = ust;
            kapsamPill.textContent = ust;
            altNot.textContent = ust;

            const nowStr = new Date((maxUpdateTs && !isNaN(maxUpdateTs)) ? maxUpdateTs : Date.now()).toLocaleString("tr-TR");
            guncellemeEl.textContent = nowStr;
          }

          function detachAll() {
            // Polling interval'Ä± temizle
            if (refreshInterval) {
              clearInterval(refreshInterval);
              refreshInterval = null;
            }
            // maxUpdateTs'i sÄ±fÄ±rlama - son gÃ¼ncelleme zamanÄ±nÄ± koru
          }

          async function aboneOl() {
            detachAll();
            const supabase = getSupabase();
            if (!supabase) {
              console.error('Supabase client hazÄ±r deÄŸil');
              if (showToast) showToast('error', 'Hata', 'VeritabanÄ± baÄŸlantÄ±sÄ± kurulamadÄ±.');
              return;
            }

            const kategori = kategoriSecimi.value;
            const yil = Number(yilSec.value);
            const ay = aySec.value === '' ? null : Number(aySec.value);
            const { start, end } = localRangeFor(yil || null, ay || null);

            const hedefMap = {}, teminMap = {}, teberruMap = {}, tahsilatMap = {}, kurbanKkMap = {}, kurbanBbMap = {};

            // Verileri yÃ¼kle fonksiyonu
            async function loadData() {
              // Her yÃ¼klemede maxUpdateTs'i sÄ±fÄ±rla (sadece bu yÃ¼klemedeki veriler iÃ§in hesapla)
              let currentMaxTs = 0;
              try {
                // 1. Hedefler
                let hedefQuery = supabase.from('hedefler').select('personel,hedef,kategori,updatedat');
                if (kategori !== "TÃ¼mÃ¼") {
                  hedefQuery = hedefQuery.eq('kategori', kategori);
                }
                const { data: hedefData, error: hedefError } = await hedefQuery;

                if (hedefError) {
                  console.error('Hedefler yÃ¼klenirken hata:', hedefError);
                  if (showToast) showToast('error', 'Hata', `Hedefler yÃ¼klenemedi: ${hedefError.message}`);
                }

                if (!hedefError && hedefData) {
                  Object.keys(hedefMap).forEach(k => delete hedefMap[k]);
                  hedefData.forEach(d => {
                    const personelAdi = d.personel;
                    // Personel adÄ± boÅŸ veya geÃ§ersiz ise atla
                    if (!personelAdi || personelAdi.trim() === '' || personelAdi === '-') return;
                    
                    const p = canonName(personelAdi);
                    // canonName '-' dÃ¶ndÃ¼rÃ¼rse de atla
                    if (!p || p === '-' || p.trim() === '') return;
                    
                    hedefMap[p] = (hedefMap[p] || 0) + toNum(d.hedef);
                  });

                  if (hedefData.length > 0) {
                    const maxTs = Math.max(...hedefData.map(d => getTimestampNumber(d, 'updatedat')));
                    if (maxTs > currentMaxTs) currentMaxTs = maxTs;
                  }
                  sonHedefMap = { ...hedefMap };
                }

                // 2. Hedef Teminleri (veriler tablosu)
                let teminQuery = supabase.from('veriler').select('personel,miktar,tur,kategori,createdat');
                if (kategori === "TÃ¼mÃ¼") {
                  // TÃ¼m veriler - filter client-side
                } else if (kategori === "Kitap KampanyasÄ±") {
                  teminQuery = teminQuery.eq('kategori', 'Kitap KampanyasÄ±');
                } else {
                  teminQuery = teminQuery.eq('tur', 'hedef').eq('kategori', kategori);
                }
                const { data: teminData, error: teminError } = await teminQuery;

                if (teminError) {
                  console.error('Hedef teminleri yÃ¼klenirken hata:', teminError);
                }

                if (!teminError && teminData) {
                  Object.keys(teminMap).forEach(k => delete teminMap[k]);
                  teminData.forEach(d => {
                    if (kategori === "TÃ¼mÃ¼") {
                      const cat = d.kategori || '';
                      if (String(d.tur).toLowerCase() !== 'hedef' && cat !== 'Kitap KampanyasÄ±') return;
                    }
                    const personelAdi = d.personel;
                    // Personel adÄ± boÅŸ veya geÃ§ersiz ise atla
                    if (!personelAdi || personelAdi.trim() === '' || personelAdi === '-') return;
                    
                    const p = canonName(personelAdi);
                    // canonName '-' dÃ¶ndÃ¼rÃ¼rse de atla
                    if (!p || p === '-' || p.trim() === '') return;
                    
                    teminMap[p] = (teminMap[p] || 0) + toNum(d.miktar);
                    const ts = getTimestampNumber(d, 'createdat');
                    if (ts > currentMaxTs) currentMaxTs = ts;
                  });
                  cacheTeminHedef = { ...teminMap };
                }

                // 3. Teberru (Ramazan modu kontrolÃ¼)
                const isRamazanKategoriForTeb = ekranModu === 'Ramazan-Ä± Åerif' && yil && (kategori.includes('Ramazan') || kategori.includes('ramazan'));

                if (!isRamazanKategoriForTeb) {
                  // Teberru sorgusu - tarih filtresi ekle (server-side)
                  let teberruQuery = supabase
                    .from('veriler')
                    .select('personel,miktar,yil,ay,createdat')
                    .eq('tur', 'teberru');
                  
                  // YÄ±l filtresi
                  if (yil) {
                    teberruQuery = teberruQuery.eq('yil', yil);
                  }
                  
                  // Ay filtresi
                  if (ay) {
                    teberruQuery = teberruQuery.eq('ay', ay);
                  }
                  
                  const { data: teberruData, error: teberruError } = await teberruQuery;

                  if (teberruError) {
                    console.error('Teberru yÃ¼klenirken hata:', teberruError);
                  }

                  if (!teberruError && teberruData) {
                    const base = {};
                    teberruData.forEach(d => {
                      // Tarih kontrolÃ¼ (eÄŸer tarih alanÄ± varsa)
                      if (start && end) {
                        const when = getWhen(d);
                        if (when && (when < start || when >= end)) return;
                      }
                      const personelAdi = d.personel;
                      // Personel adÄ± boÅŸ veya geÃ§ersiz ise atla
                      if (!personelAdi || personelAdi.trim() === '' || personelAdi === '-') return;
                      
                      const p = canonName(personelAdi);
                      // canonName '-' dÃ¶ndÃ¼rÃ¼rse de atla
                      if (!p || p === '-' || p.trim() === '') return;
                      
                      base[p] = (base[p] || 0) + toNum(d.miktar);
                      const ts = getTimestampNumber(d, 'createdat');
                      if (ts > currentMaxTs) currentMaxTs = ts;
                    });

                    // 2025 legacy iÃ§in ek kontrol
                    if (yil === 2025) {
                      async function addLegacyFor(month) {
                        const cat = month === 7 ? 'Kitap KampanyasÄ±' : (month === 8 ? 'Mevlid Kandili' : null);
                        if (!cat) return;
                        const { data: legacyData } = await supabase
                          .from('veriler')
                          .select('personel,miktar,tur,kategori,createdat,updatedat')
                          .eq('kategori', cat);

                        if (legacyData) {
                          legacyData.forEach(d => {
                            if (String(d.tur).toLowerCase() !== 'teberru') return;
                            const w = getWhen(d); if (!w) return;
                            const aStart = new Date(2025, month - 1, 1, 0, 0, 0);
                            const aEnd = new Date(2025, month, 1, 0, 0, 0);
                            if (start && end) {
                              if (w < start || w >= end) return;
                            } else {
                              if (w < aStart || w >= aEnd) return;
                            }
                            if (kategori !== 'TÃ¼mÃ¼') {
                              const dKat = d.kategori || '';
                              if (dKat !== kategori) return;
                            }
                            const personelAdi = d.personel;
                            // Personel adÄ± boÅŸ veya geÃ§ersiz ise atla
                            if (!personelAdi || personelAdi.trim() === '' || personelAdi === '-') return;
                            
                            const p = canonName(personelAdi);
                            // canonName '-' dÃ¶ndÃ¼rÃ¼rse de atla
                            if (!p || p === '-' || p.trim() === '') return;
                            
                            base[p] = (base[p] || 0) + toNum(d.miktar);
                          });
                        }
                      }
                      if (ay === 7) await addLegacyFor(7);
                      else if (ay === 8) await addLegacyFor(8);
                      else if (!ay) { await addLegacyFor(7); await addLegacyFor(8); }
                    }

                    Object.keys(teberruMap).forEach(k => delete teberruMap[k]);
                    Object.assign(teberruMap, base);
                    cacheTeberru = { ...teberruMap };
                  }
                }

                // 4. Tahsilatlar - yÄ±l filtresi (server-side), tarih filtresi client-side
                let tahsilatQuery = supabase
                  .from('tahsilatlar')
                  .select('personel,tutar,yil,tarih,createdat');
                
                // YÄ±l filtresi
                if (yil) {
                  tahsilatQuery = tahsilatQuery.eq('yil', yil);
                }
                
                // Not: tarih alanÄ± null olabilir, bu yÃ¼zden tarih filtresini client-side yapÄ±yoruz
                
                const { data: tahsilatData, error: tahsilatError } = await tahsilatQuery;

                if (tahsilatError) {
                  console.error('Tahsilatlar yÃ¼klenirken hata:', tahsilatError);
                }

                if (!tahsilatError && tahsilatData) {
                  Object.keys(tahsilatMap).forEach(k => delete tahsilatMap[k]);
                  tahsilatData.forEach(d => {
                    // Tarih kontrolÃ¼ (client-side)
                    let w = null;
                    if (d.tarih) {
                      w = new Date(d.tarih);
                      if (isNaN(w.getTime())) w = null;
                    }
                    if (!w && d.createdat) {
                      w = new Date(d.createdat);
                      if (isNaN(w.getTime())) w = null;
                    }
                    
                    // Tarih filtresi
                    if (start && end) {
                      if (!w || w < start || w >= end) return;
                    } else if (yil && w) {
                      if (w.getFullYear() !== yil) return;
                    }
                    
                    const personelAdi = d.personel;
                    // Personel adÄ± boÅŸ veya geÃ§ersiz ise atla
                    if (!personelAdi || personelAdi.trim() === '' || personelAdi === '-') return;
                    
                    const p = canonName(personelAdi);
                    // canonName '-' dÃ¶ndÃ¼rÃ¼rse de atla
                    if (!p || p === '-' || p.trim() === '') return;
                    
                    const tutar = Number(d.tutar ?? 0) || 0;
                    tahsilatMap[p] = (tahsilatMap[p] || 0) + tutar;
                    const ts = getTimestampNumber(d, 'createdat');
                    if (ts > currentMaxTs) currentMaxTs = ts;
                  });
                  cacheTahsilat = { ...tahsilatMap };
                }

                // 5. Kurban (kucukbas, buyukbas) - yÄ±l/ay filtresi ekle (server-side)
                let kurbanQuery = supabase
                  .from('veriler')
                  .select('personel,miktar,tur,yil,ay,createdat')
                  .in('tur', ['kucukbas', 'buyukbas']);
                
                // YÄ±l filtresi
                if (yil) {
                  kurbanQuery = kurbanQuery.eq('yil', yil);
                }
                
                // Ay filtresi
                if (ay) {
                  kurbanQuery = kurbanQuery.eq('ay', ay);
                }
                
                const { data: kurbanData, error: kurbanError } = await kurbanQuery;

                if (!kurbanError && kurbanData) {
                  Object.keys(kurbanKkMap).forEach(k => delete kurbanKkMap[k]);
                  Object.keys(kurbanBbMap).forEach(k => delete kurbanBbMap[k]);

                  kurbanData.forEach(d => {
                    const personelAdi = d.personel;
                    // Personel adÄ± boÅŸ veya geÃ§ersiz ise atla
                    if (!personelAdi || personelAdi.trim() === '' || personelAdi === '-') return;
                    
                    const p = canonName(personelAdi);
                    // canonName '-' dÃ¶ndÃ¼rÃ¼rse de atla
                    if (!p || p === '-' || p.trim() === '') return;
                    
                    const adet = toNum(d.miktar || 1);

                    if (d.tur === 'kucukbas') {
                      kurbanKkMap[p] = (kurbanKkMap[p] || 0) + adet;
                    } else if (d.tur === 'buyukbas') {
                      kurbanBbMap[p] = (kurbanBbMap[p] || 0) + adet;
                    }

                    const ts = getTimestampNumber(d, 'createdat');
                    if (ts > currentMaxTs) currentMaxTs = ts;
                  });
                }

                // 6. RAMAZAN-I ÅERIF MODU: Ä°FTAR, SAHUR, TAAHHÃœT
                if (ekranModu === 'Ramazan-Ä± Åerif') {
                  const isRamazanKategoriRamazan = kategori.includes('Ramazan') || kategori.includes('ramazan');

                  if (isRamazanKategoriRamazan && yil) {
                    // Ä°FTAR-SAHUR kayÄ±tlarÄ± (ramazan_kayitlari tablosu)
                    let iftarSahurData = null;
                    try {
                      const { data, error } = await supabase
                        .from('ramazan_kayitlari')
                        .select('personeladi,personel,yil,tip,tutar,sahip,notlar,createdat,updatedat')
                        .eq('yil', yil);
                      if (error && error.code !== 'PGRST116' && error.code !== 'PGRST205') { // PGRST116/PGRST205 = table not found
                        console.warn('ramazan_kayitlari yÃ¼klenemedi:', error);
                      } else if (!error) {
                        iftarSahurData = data;
                      }
                    } catch (err) {
                      console.warn('ramazan_kayitlari tablosu henÃ¼z oluÅŸturulmamÄ±ÅŸ:', err);
                    }

                    if (iftarSahurData) {
                      Object.keys(iftarMap).forEach(k => delete iftarMap[k]);
                      Object.keys(sahurMap).forEach(k => delete sahurMap[k]);

                      iftarSahurData.forEach(d => {
                        if (d.yil && Number(d.yil) !== yil) return;

                        const personelAdi = d.personeladi;
                        // Personel adÄ± boÅŸ veya geÃ§ersiz ise atla
                        if (!personelAdi || personelAdi.trim() === '' || personelAdi === '-') return;
                        
                        const p = canonName(personelAdi);
                        // canonName '-' dÃ¶ndÃ¼rÃ¼rse de atla
                        if (!p || p === '-' || p.trim() === '') return;
                        
                        const tutar = toNum(d.tutar || 0);

                        if (d.tip === 'iftar') {
                          iftarMap[p] = (iftarMap[p] || 0) + tutar;
                        } else if (d.tip === 'sahur') {
                          sahurMap[p] = (sahurMap[p] || 0) + tutar;
                        }

                        const ts = getTimestampNumber(d, 'createdat');
                        if (ts > currentMaxTs) currentMaxTs = ts;
                      });
                    }

                    // TEBERRU kayÄ±tlarÄ± (teberru_kayitlari)
                    let teberruRamazanQuery = supabase
                      .from('teberru_kayitlari')
                      .select('personel,personeluid,yil,ay,miktar,bagisci,aciklama,createdat,updatedat')
                      .eq('yil', yil);
                    
                    // Ay filtresi (eÄŸer seÃ§iliyse)
                    if (ay) {
                      teberruRamazanQuery = teberruRamazanQuery.eq('ay', ay);
                    }
                    
                    const { data: teberruRamazanData, error: teberruRamazanError } = await teberruRamazanQuery;

                    if (teberruRamazanError) {
                      console.error('Teberru kayÄ±tlarÄ± (Ramazan) yÃ¼klenirken hata:', teberruRamazanError);
                    }

                    if (!teberruRamazanError && teberruRamazanData) {
                      Object.keys(teberruMap).forEach(k => delete teberruMap[k]);
                      teberruRamazanData.forEach(d => {
                        if (d.yil && Number(d.yil) !== yil) return;
                        // Ay filtresi (eÄŸer seÃ§iliyse)
                        if (ay && d.ay && Number(d.ay) !== ay) return;
                        const personelAdi = d.personel;
                        // Personel adÄ± boÅŸ veya geÃ§ersiz ise atla
                        if (!personelAdi || personelAdi.trim() === '' || personelAdi === '-') return;
                        
                        const p = canonName(personelAdi);
                        // canonName '-' dÃ¶ndÃ¼rÃ¼rse de atla
                        if (!p || p === '-' || p.trim() === '') return;
                        
                        const miktar = toNum(d.miktar || 0);
                        teberruMap[p] = (teberruMap[p] || 0) + miktar;
                        const ts = getTimestampNumber(d, 'createdat');
                        if (ts > currentMaxTs) currentMaxTs = ts;
                      });
                    }

                    // TAAHHÃœT kayÄ±tlarÄ± - taahhut_kayitlari
                    let taahhutRamazanData = null;
                    try {
                      const { data, error } = await supabase
                        .from('taahhut_kayitlari')
                        .select('personel,kaydedenpersonel,yil,miktar,bagisci,aciklama,createdat,updatedat')
                        .eq('yil', yil);
                      if (error && error.code !== 'PGRST116' && error.code !== 'PGRST205') {
                        console.warn('taahhut_kayitlari yÃ¼klenemedi:', error);
                      } else if (!error) {
                        taahhutRamazanData = data;
                      }
                    } catch (err) {
                      console.warn('taahhut_kayitlari tablosu henÃ¼z yok:', err);
                    }

                    if (taahhutRamazanData) {
                      Object.keys(taahhutMap).forEach(k => delete taahhutMap[k]);
                      taahhutRamazanData.forEach(d => {
                        if (d.yil && Number(d.yil) !== yil) return;
                        const personelAdi = d.personeladi || d.personel || d.kaydedenpersonel;
                        // Personel adÄ± boÅŸ veya geÃ§ersiz ise atla
                        if (!personelAdi || personelAdi.trim() === '' || personelAdi === '-') return;
                        
                        const p = canonName(personelAdi);
                        // canonName '-' dÃ¶ndÃ¼rÃ¼rse de atla
                        if (!p || p === '-' || p.trim() === '') return;
                        
                        const miktar = toNum(d.miktar || 0);
                        taahhutMap[p] = (taahhutMap[p] || 0) + miktar;

                        // Lowercase check
                        const ts = getTimestampNumber(d, 'createdat');
                        if (ts > currentMaxTs) currentMaxTs = ts;
                      });
                    }

                    // RAMAZAN HEDEFLERI (ramazan_hedefler tablosu)
                    let ramazanHedefData = null;
                    try {
                      const { data, error } = await supabase
                        .from('ramazan_hedefler')
                        .select('personeladi,personeluid,yil,hedef,createdat,updatedat')
                        .eq('yil', yil);
                      if (error && error.code !== 'PGRST116' && error.code !== 'PGRST205') { // PGRST116/PGRST205 = table not found
                        console.warn('ramazan_hedefler yÃ¼klenemedi:', error);
                      } else if (!error) {
                        ramazanHedefData = data;
                      }
                    } catch (err) {
                      console.warn('ramazan_hedefler tablosu henÃ¼z oluÅŸturulmamÄ±ÅŸ:', err);
                    }

                    if (ramazanHedefData) {
                      ramazanHedefData.forEach(d => {
                        const personelAdi = d.personeladi;
                        // Personel adÄ± boÅŸ veya geÃ§ersiz ise atla
                        if (!personelAdi || personelAdi.trim() === '' || personelAdi === '-') return;
                        
                        const p = canonName(personelAdi);
                        // canonName '-' dÃ¶ndÃ¼rÃ¼rse de atla
                        if (!p || p === '-' || p.trim() === '') return;
                        
                        const hedefTutar = toNum(d.hedef || d.tutar || 0);
                        if (hedefTutar > 0) {
                          hedefMap[p] = hedefTutar;
                        }
                        const ts = getTimestampNumber(d, 'updatedat') || getTimestampNumber(d, 'createdat');
                        if (ts > currentMaxTs) currentMaxTs = ts;
                      });
                      sonHedefMap = { ...hedefMap };
                    }
                  } else {
                    // Eski sistem: veriler tablosundan
                    // Ä°FTAR
                    const { data: iftarData } = await supabase
                      .from('veriler')
                      .select('personel,miktar,tur,yil,ay,createdat,updatedat')
                      .eq('tur', 'iftar');

                    if (iftarData) {
                      Object.keys(iftarMap).forEach(k => delete iftarMap[k]);
                      iftarData.forEach(d => {
                        const when = getWhen(d);
                        if (d.ay !== undefined && d.yil !== undefined) {
                          if (yil && d.yil !== yil) return;
                          if (ay && d.ay !== ay) return;
                          if (start && end && when && (when < start || when >= end)) return;
                        } else {
                          if (start && end) {
                            if (!when || when < start || when >= end) return;
                          } else if (yil) {
                            if (!when || when.getFullYear() !== yil) return;
                          }
                        }
                        const personelAdi = d.personel;
                        // Personel adÄ± boÅŸ veya geÃ§ersiz ise atla
                        if (!personelAdi || personelAdi.trim() === '' || personelAdi === '-') return;
                        
                        const p = canonName(personelAdi);
                        // canonName '-' dÃ¶ndÃ¼rÃ¼rse de atla
                        if (!p || p === '-' || p.trim() === '') return;
                        
                        iftarMap[p] = (iftarMap[p] || 0) + toNum(d.miktar);
                        const ts = getTimestampNumber(d, 'createdat');
                        if (ts > currentMaxTs) currentMaxTs = ts;
                      });
                    }

                    // SAHUR
                    const { data: sahurData } = await supabase
                      .from('veriler')
                      .select('personel,miktar,tur,yil,ay,createdat,updatedat')
                      .eq('tur', 'sahur');

                    if (sahurData) {
                      Object.keys(sahurMap).forEach(k => delete sahurMap[k]);
                      sahurData.forEach(d => {
                        const when = getWhen(d);
                        if (d.ay !== undefined && d.yil !== undefined) {
                          if (yil && d.yil !== yil) return;
                          if (ay && d.ay !== ay) return;
                          if (start && end && when && (when < start || when >= end)) return;
                        } else {
                          if (start && end) {
                            if (!when || when < start || when >= end) return;
                          } else if (yil) {
                            if (!when || when.getFullYear() !== yil) return;
                          }
                        }
                        const personelAdi = d.personel;
                        // Personel adÄ± boÅŸ veya geÃ§ersiz ise atla
                        if (!personelAdi || personelAdi.trim() === '' || personelAdi === '-') return;
                        
                        const p = canonName(personelAdi);
                        // canonName '-' dÃ¶ndÃ¼rÃ¼rse de atla
                        if (!p || p === '-' || p.trim() === '') return;
                        
                        sahurMap[p] = (sahurMap[p] || 0) + toNum(d.miktar);
                        const ts = getTimestampNumber(d, 'createdat');
                        if (ts > currentMaxTs) currentMaxTs = ts;
                      });
                    }

                    // TAAHHÃœT
                    const { data: taahhutData } = await supabase
                      .from('taahhut_kayitlari')
                      .select('personel,yil,ay,miktar,createdat,updatedat');

                    if (taahhutData) {
                      Object.keys(taahhutMap).forEach(k => delete taahhutMap[k]);
                      taahhutData.forEach(d => {
                        const when = getWhen(d);
                        if (d.ay !== undefined && d.yil !== undefined) {
                          if (yil && d.yil !== yil) return;
                          if (ay && d.ay !== ay) return;
                          if (start && end && when && (when < start || when >= end)) return;
                        } else {
                          if (start && end) {
                            if (!when || when < start || when >= end) return;
                          } else if (yil) {
                            if (!when || when.getFullYear() !== yil) return;
                          }
                        }
                        const personelAdi = d.personel;
                        // Personel adÄ± boÅŸ veya geÃ§ersiz ise atla
                        if (!personelAdi || personelAdi.trim() === '' || personelAdi === '-') return;
                        
                        const p = canonName(personelAdi);
                        // canonName '-' dÃ¶ndÃ¼rÃ¼rse de atla
                        if (!p || p === '-' || p.trim() === '') return;
                        
                        taahhutMap[p] = (taahhutMap[p] || 0) + toNum(d.miktar);
                        const ts = getTimestampNumber(d, 'createdat');
                        if (ts > currentMaxTs) currentMaxTs = ts;
                      });
                    }
                  }
                } else {
                  // Hedef modunda iftar, sahur, taahhÃ¼t temizle
                  Object.keys(iftarMap).forEach(k => delete iftarMap[k]);
                  Object.keys(sahurMap).forEach(k => delete sahurMap[k]);
                  Object.keys(taahhutMap).forEach(k => delete taahhutMap[k]);
                }

                // TÃ¼m veriler yÃ¼klendi, maxUpdateTs'i gÃ¼ncelle
                if (currentMaxTs > maxUpdateTs) {
                  maxUpdateTs = currentMaxTs;
                }
                
                // TÃ¼m veriler yÃ¼klendi, derleVeYansit'i Ã§aÄŸÄ±r
                derleVeYansit(hedefMap, teminMap, teberruMap, tahsilatMap, kurbanKkMap, kurbanBbMap);

              } catch (error) {
                console.error('Veri yÃ¼kleme hatasÄ±:', error);
                if (showToast) {
                  showToast('error', 'Hata', 'Veriler yÃ¼klenirken bir hata oluÅŸtu.');
                }
              }
            }

            // Ä°lk yÃ¼kleme
            await loadData();

            // Polling: Her 30 saniyede bir verileri yeniden yÃ¼kle (trafik optimizasyonu)
            refreshInterval = setInterval(async () => {
              await loadData();
            }, 30000);
          }
          // Inline onclick kullanan yerler iÃ§in global eriÅŸim
          window.aboneOl = aboneOl;

          let __modalRows = [];
          let __modalSort = { key: 't', dir: 'desc' };

          function paintModalSortIndicators() {
            const head = document.querySelector('#m_hareketTablo thead');
            if (!head) return;
            head.querySelectorAll('.sort-arrows span').forEach(el => {
              const k = el.dataset.key, d = el.dataset.dir;
              el.classList.toggle('active', k === __modalSort.key && d === __modalSort.dir);
            });
          }

          function renderModalRows() {
            const tbody = m_hareketTabloBody;
            const rows = __modalRows.slice();
            const k = __modalSort.key, dir = __modalSort.dir;
            const sign = dir === 'asc' ? 1 : -1;

            rows.sort((a, b) => {
              function val(x) {
                if (k === 't') {
                  // t Date objesi olmalÄ±, eÄŸer deÄŸilse tStr'den parse et
                  if (x.t instanceof Date && !isNaN(x.t.getTime())) {
                    return x.t.getTime();
                  }
                  // tStr'den parse et
                  if (x.tStr && x.tStr !== '-') {
                    const parsed = new Date(x.tStr);
                    if (!isNaN(parsed.getTime())) {
                      return parsed.getTime();
                    }
                  }
                  return 0;
                }
                if (k === 'miktar') return Number(x.miktar) || 0;
                if (k === 'ad') return (x.ad || '').toLocaleLowerCase('tr-TR');
                if (k === 'tur') return (x.tur || '').toLocaleLowerCase('tr-TR');
                if (k === 'aciklama') return (x.aciklama || '').toLocaleLowerCase('tr-TR');
                return 0;
              }
              const va = val(a), vb = val(b);
              if (typeof va === 'number' && typeof vb === 'number') return sign * (va - vb);
              return sign * String(va).localeCompare(String(vb), 'tr');
            });

            tbody.innerHTML = '';
            if (!rows.length) {
              tbody.innerHTML = '<tr><td colspan="5">Hareket bulunamadÄ±.</td></tr>';
            } else {
              rows.forEach(x => {
                let turEt = 'etiket-hedef', turAd = 'Hedef';
                if (x.tur === 'teberru') { turEt = 'etiket-teberru'; turAd = 'Teberru'; }
                else if (x.tur === 'tahsilat') { turEt = 'etiket-tahsilat'; turAd = 'Tahsilat'; }
                else if (x.tur === 'kurban') { turEt = 'etiket-kurban'; turAd = x.kurbanTipi ? ('Kurban - ' + x.kurbanTipi) : 'Kurban'; }
                else if (x.tur === 'iftar') { turEt = 'etiket-teberru'; turAd = 'Ä°ftar'; }
                else if (x.tur === 'sahur') { turEt = 'etiket-teberru'; turAd = 'Sahur'; }
                else if (x.tur === 'taahhut') { turEt = 'etiket-hedef'; turAd = 'TaahhÃ¼t'; }

                tbody.innerHTML += `<tr>
            <td>${x.tStr}</td>
            <td>${x.ad || '-'}</td>
            <td>${x.miktarTip === 'adet' ? x.miktar : 'â‚º' + Math.round(x.miktar || 0).toLocaleString('tr-TR', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}</td>
            <td><span class="etiket ${turEt}">${turAd}</span></td>
            <td>${x.aciklama || '-'}</td>
          </tr>`;
              });
            }
            paintModalSortIndicators();
          }

          (function initModalSort() {
            const head = document.querySelector('#m_hareketTablo thead');
            if (!head) return;
            head.addEventListener('click', (e) => {
              const btn = e.target.closest('.sort-arrows span');
              if (!btn) return;
              __modalSort = { key: btn.dataset.key, dir: btn.dataset.dir };
              renderModalRows();
            });
            paintModalSortIndicators();
          })();

          async function acDetayModal(personel) {
            const kategori = kategoriSecimi.value;
            const yil = Number(yilSec.value);
            const ay = aySec.value === '' ? null : Number(aySec.value);
            const { start, end } = localRangeFor(yil || null, ay || null);

            const kapsam = kapsamMetni(yil, ay, kategori);
            m_baslik.textContent = `${personel}`;
            m_kapsamEtik.textContent = kapsam;
            m_kategoriEtik.textContent = kategori;
            modalArka.style.display = 'block';
            m_hareketTabloBody.innerHTML = '<tr><td colspan="5">YÃ¼kleniyor...</td></tr>';

            const hedef = toNum(sonHedefMap[personel] || 0);
            let hedefTeminTop = 0, teberruTop = 0, tahsilatTop = 0, iftarTop = 0, sahurTop = 0, taahhutTop = 0;
            const satirlar = [];

            try {
              // Ramazan-Ä± Åerif modunda ve Ramazan kategorisi seÃ§ildiÄŸinde Ã¶zel iÅŸlem
              const isRamazanModal = ekranModu === 'Ramazan-Ä± Åerif' && yil && (kategori.includes('Ramazan') || kategori.includes('ramazan'));

              const supabase = getSupabase();
              if (!supabase) {
                throw new Error('Supabase client hazÄ±r deÄŸil');
              }

              // HEDEF TEMÄ°NÄ° (Normal mod ve Ramazan modu iÃ§in)
              if (isRamazanModal) {
                // Ramazan hedefleri
                let ramazanHedefData = null;
                try {
                  const { data, error } = await supabase
                    .from('ramazan_hedefler')
                    .select('personeladi,personeluid,yil,hedef,createdat,updatedat')
                    .eq('yil', yil);
                  if (error && error.code !== 'PGRST116' && error.code !== 'PGRST205') {
                    console.warn('ramazan_hedefler yÃ¼klenemedi:', error);
                  } else if (!error) {
                    ramazanHedefData = data;
                  }
                } catch (err) {
                  console.warn('ramazan_hedefler tablosu henÃ¼z oluÅŸturulmamÄ±ÅŸ:', err);
                }

                if (ramazanHedefData) {
                  ramazanHedefData.forEach(d => {
                    const personelAdi = d.personeladi || '-';
                    const p = canonName(personelAdi);
                    if (p !== personel) return;

                    const hedefTutar = toNum(d.hedef || d.tutar || 0);
                    if (hedefTutar > 0) {
                      hedefTeminTop += hedefTutar;
                      const t = d.updatedat ? new Date(d.updatedat) : (d.updatedAt ? new Date(d.updatedAt) : (d.createdat ? new Date(d.createdat) : (d.createdAt ? new Date(d.createdAt) : new Date())));
                      const tStr = t && !isNaN(t.getTime()) ? t.toLocaleString('tr-TR') : '-';
                      satirlar.push({ t, tStr, ad: '-', miktar: hedefTutar, tur: 'hedef', aciklama: 'Ramazan Hedefi', miktarTip: 'â‚º' });
                    }
                  });
                }
              } else {
                // Normal mod: Hedef temini
                let hedefQuery = supabase.from('veriler').select('personel,miktar,tur,kategori,adsoyad,veren,aciklama,nereyegeldi,createdat,yil,ay');
                if (kategori === 'TÃ¼mÃ¼') {
                  hedefQuery = hedefQuery.eq('tur', 'hedef');
                } else if (kategori === 'Kitap KampanyasÄ±') {
                  hedefQuery = hedefQuery.eq('kategori', 'Kitap KampanyasÄ±');
                } else {
                  hedefQuery = hedefQuery.eq('tur', 'hedef').eq('kategori', kategori);
                }
                
                // YÄ±l filtresi
                if (yil) {
                  hedefQuery = hedefQuery.eq('yil', yil);
                }
                
                // Ay filtresi
                if (ay) {
                  hedefQuery = hedefQuery.eq('ay', ay);
                }
                
                const { data: hedefData } = await hedefQuery;

                if (hedefData) {
                  hedefData.forEach(d => {
                    const p = canonName(d.personel || '-');
                    if (p !== personel) return;
                    
                    // Tarih kontrolÃ¼
                    const when = getWhen(d);
                    if (start && end) {
                      if (!when || when < start || when >= end) return;
                    } else if (yil && when) {
                      if (when.getFullYear() !== yil) return;
                    }
                    
                    hedefTeminTop += toNum(d.miktar);
                    const t = when || new Date();
                    const tStr = t && !isNaN(t.getTime()) ? t.toLocaleString('tr-TR') : '-';
                    satirlar.push({ t, tStr, ad: (d.adsoyad || d.veren || '-'), miktar: toNum(d.miktar), tur: 'hedef', aciklama: (d.aciklama || d.nereyegeldi || '-'), miktarTip: 'â‚º' });
                  });
                }
              }

              // Ä°FTAR-SAHUR (Sadece Ramazan modunda)
              if (isRamazanModal) {
                let iftarSahurData = null;
                try {
                  const { data, error } = await supabase
                    .from('ramazan_kayitlari')
                    .select('personeladi,personel,yil,tip,tutar,sahip,notlar,createdat,updatedat')
                    .eq('yil', yil);
                  if (error && error.code !== 'PGRST116' && error.code !== 'PGRST205') {
                    console.warn('ramazan_kayitlari yÃ¼klenemedi:', error);
                  } else if (!error) {
                    iftarSahurData = data;
                  }
                } catch (err) {
                  console.warn('ramazan_kayitlari tablosu henÃ¼z oluÅŸturulmamÄ±ÅŸ:', err);
                }

                if (iftarSahurData) {
                  iftarSahurData.forEach(d => {
                    if (d.yil && Number(d.yil) !== yil) return;

                    const personelAdi = d.personeladi || d.personel || '-';
                    const p = canonName(personelAdi);
                    if (p !== personel) return;

                    const tutar = toNum(d.tutar || 0);
                    const t = d.updatedat ? new Date(d.updatedat) : (d.updatedAt ? new Date(d.updatedAt) : (d.createdat ? new Date(d.createdat) : (d.createdAt ? new Date(d.createdAt) : new Date())));
                    const tStr = t && !isNaN(t.getTime()) ? t.toLocaleString('tr-TR') : '-';

                    if (d.tip === 'iftar') {
                      iftarTop += tutar;
                      satirlar.push({ t, tStr, ad: (d.sahip || '-'), miktar: tutar, tur: 'iftar', aciklama: (d.notlar || '-'), miktarTip: 'â‚º' });
                    } else if (d.tip === 'sahur') {
                      sahurTop += tutar;
                      satirlar.push({ t, tStr, ad: (d.sahip || '-'), miktar: tutar, tur: 'sahur', aciklama: (d.notlar || '-'), miktarTip: 'â‚º' });
                    }
                  });
                }
              }

              // TAAHHÃœT (Sadece Ramazan modunda)
              if (isRamazanModal) {
                let taahhutData = null;
                try {
                  const { data, error } = await supabase
                    .from('taahhut_kayitlari')
                    .select('personel,kaydedenpersonel,yil,miktar,bagisci,aciklama,createdat,updatedat')
                    .eq('yil', yil);
                  if (error && error.code !== 'PGRST116' && error.code !== 'PGRST205') {
                    console.warn('taahhut_kayitlari yÃ¼klenemedi:', error);
                  } else if (!error) {
                    taahhutData = data;
                  }
                } catch (err) {
                  console.warn('taahhut_kayitlari tablosu henÃ¼z yok:', err);
                }

                if (taahhutData) {
                  taahhutData.forEach(d => {
                    if (d.yil && Number(d.yil) !== yil) return;

                    const personelAdi = d.personeladi || d.personel || d.kaydedenpersonel || '-';
                    const p = canonName(personelAdi);
                    if (p !== personel) return;

                    const miktar = toNum(d.miktar || 0);
                    taahhutTop += miktar;

                    const t = d.updatedat ? new Date(d.updatedat) : (d.updatedAt ? new Date(d.updatedAt) : (d.createdat ? new Date(d.createdat) : (d.createdAt ? new Date(d.createdAt) : new Date())));
                    const tStr = t && !isNaN(t.getTime()) ? t.toLocaleString('tr-TR') : '-';
                    satirlar.push({ t, tStr, ad: (d.bagisci || '-'), miktar, tur: 'taahhut', aciklama: (d.aciklama || '-'), miktarTip: 'â‚º' });
                  });
                }
              }

              // TEBERRU (TÃ¼m modlar iÃ§in - seÃ§ili kapsama gÃ¶re)
              if (isRamazanModal) {
                // Ramazan modunda: teberru_kayitlari tablosundan
                let teberruModalQuery = supabase
                  .from('teberru_kayitlari')
                  .select('personel,personeluid,yil,ay,miktar,bagisci,aciklama,createdat,updatedat')
                  .eq('yil', yil);
                
                if (ay) {
                  teberruModalQuery = teberruModalQuery.eq('ay', ay);
                }
                
                const { data: teberruData, error: teberruModalError } = await teberruModalQuery;

                if (teberruModalError) {
                  console.error('Teberru kayÄ±tlarÄ± (Modal) yÃ¼klenirken hata:', teberruModalError);
                }

                if (!teberruModalError && teberruData) {
                  teberruData.forEach(d => {
                    if (d.yil && Number(d.yil) !== yil) return;
                    if (ay && d.ay && Number(d.ay) !== ay) return;

                    const personelAdi = d.personel || '-';
                    const p = canonName(personelAdi);
                    if (p !== personel) return;

                    const miktar = toNum(d.miktar || 0);
                    teberruTop += miktar;
                    const t = d.updatedat ? new Date(d.updatedat) : (d.updatedAt ? new Date(d.updatedAt) : (d.createdat ? new Date(d.createdat) : (d.createdAt ? new Date(d.createdAt) : new Date())));
                    const tStr = t && !isNaN(t.getTime()) ? t.toLocaleString('tr-TR') : '-';
                    satirlar.push({ t, tStr, ad: (d.bagisci || '-'), miktar, tur: 'teberru', aciklama: (d.aciklama || '-'), miktarTip: 'â‚º' });
                  });
                }
              } else {
                // Normal mod: veriler tablosundan teberru
                let teberruQuery = supabase
                  .from('veriler')
                  .select('personel,miktar,tur,kategori,yil,ay,adsoyad,veren,aciklama,nereyegeldi,createdat,updatedat')
                  .eq('tur', 'teberru');
                
                // YÄ±l filtresi
                if (yil) {
                  teberruQuery = teberruQuery.eq('yil', yil);
                }
                
                // Ay filtresi
                if (ay) {
                  teberruQuery = teberruQuery.eq('ay', ay);
                }
                
                // Kategori filtresi (TÃ¼mÃ¼ deÄŸilse)
                if (kategori !== 'TÃ¼mÃ¼') {
                  // Teberru iÃ§in kategori filtresi genelde uygulanmaz, ama Kitap KampanyasÄ± gibi Ã¶zel durumlar iÃ§in
                  if (kategori === 'Kitap KampanyasÄ±') {
                    teberruQuery = teberruQuery.eq('kategori', 'Kitap KampanyasÄ±');
                  }
                }

                const { data: teberruData } = await teberruQuery;

                if (teberruData) {
                  teberruData.forEach(d => {
                    const p = canonName(d.personel || '-');
                    if (p !== personel) return;

                    // Tarih kontrolÃ¼
                    const when = getWhen(d);
                    if (start && end) {
                      if (!when || when < start || when >= end) return;
                    } else if (yil && when) {
                      if (when.getFullYear() !== yil) return;
                    }

                    teberruTop += toNum(d.miktar);
                    const t = d.ay !== undefined && d.yil !== undefined ?
                      new Date(d.yil, d.ay - 1, 1) : (when || new Date());
                    const tStr = t && !isNaN(t.getTime()) ? t.toLocaleString('tr-TR') : '-';
                    satirlar.push({ t, tStr, ad: (d.adsoyad || d.veren || '-'), miktar: toNum(d.miktar), tur: 'teberru', aciklama: (d.aciklama || d.nereyegeldi || '-'), miktarTip: 'â‚º' });
                  });
                }
              }

              // KURBAN (TÃ¼m modlar iÃ§in - seÃ§ili kapsama gÃ¶re)
              let kurbanQuery = supabase
                .from('veriler')
                .select('personel,miktar,tur,kategori,adsoyad,veren,aciklama,createdat,updatedat,yil,ay')
                .in('tur', ['kucukbas', 'buyukbas']);
              
              // YÄ±l filtresi
              if (yil) {
                kurbanQuery = kurbanQuery.eq('yil', yil);
              }
              
              // Ay filtresi
              if (ay) {
                kurbanQuery = kurbanQuery.eq('ay', ay);
              }
              
              // Kategori filtresi (TÃ¼mÃ¼ deÄŸilse)
              if (kategori !== 'TÃ¼mÃ¼') {
                // Kurban iÃ§in kategori genelde uygulanmaz, ama Ã¶zel durumlar iÃ§in
                if (kategori === 'Kitap KampanyasÄ±') {
                  kurbanQuery = kurbanQuery.eq('kategori', 'Kitap KampanyasÄ±');
                }
              }

              const { data: kurbanData } = await kurbanQuery;

              if (kurbanData) {
                kurbanData.forEach(d => {
                  const p = canonName(d.personel || '-');
                  if (p !== personel) return;
                  
                  // Tarih kontrolÃ¼
                  const w = getWhen(d);
                  if (start && end) {
                    if (!w || w < start || w >= end) return;
                  } else if (yil && w) {
                    if (w.getFullYear() !== yil) return;
                  }
                  
                  let tip = d.tur || d.kategori || '';
                  tip = tip.toString().toLowerCase();
                  if (tip !== 'kucukbas' && tip !== 'buyukbas' && tip !== 'kÃ¼Ã§Ã¼kbaÅŸ' && tip !== 'bÃ¼yÃ¼kbaÅŸ') return;

                  const t = w || new Date();
                  const tStr = t && !isNaN(t.getTime()) ? t.toLocaleString('tr-TR') : '-';
                  const adet = toNum(d.miktar || 1);
                  const turLabel = (tip === 'kucukbas' || tip === 'kÃ¼Ã§Ã¼kbaÅŸ') ? 'KÃ¼Ã§Ã¼kbaÅŸ' : 'BÃ¼yÃ¼kbaÅŸ';

                  satirlar.push({
                    t,
                    tStr,
                    ad: (d.adsoyad || d.veren || '-'),
                    miktar: adet,
                    tur: 'kurban',
                    aciklama: (d.aciklama || d.nereyegeldi || '-'),
                    miktarTip: 'adet',
                    kurbanTipi: turLabel
                  });
                });
              }

              // TAHSÄ°LATLAR (TÃ¼m modlar iÃ§in - seÃ§ili kapsama gÃ¶re)
              let tahsilatQuery = supabase
                .from('tahsilatlar')
                .select('personel,tutar,borclu,odeyen,aciklama,yil,tarih,createdat');
              
              // YÄ±l filtresi
              if (yil) {
                tahsilatQuery = tahsilatQuery.eq('yil', yil);
              }
              
              // Tarih aralÄ±ÄŸÄ± filtresi (tarih alanÄ± null olabilir, bu yÃ¼zden sadece yil filtresi kullanÄ±yoruz)
              // EÄŸer tarih alanÄ± varsa ve null deÄŸilse, tarih filtresi ekle
              // Not: tarih alanÄ± timestamp with time zone, bu yÃ¼zden ISO string formatÄ± kullanÄ±lmalÄ±
              // Ancak tarih null olabilir, bu yÃ¼zden client-side filtreleme yapÄ±yoruz

              const { data: tahsilatData, error: tahsilatError } = await tahsilatQuery;

              if (tahsilatError) {
                console.error('Tahsilatlar yÃ¼klenirken hata:', tahsilatError);
              }

              if (!tahsilatError && tahsilatData) {
                tahsilatData.forEach(d => {
                  // Tarih kontrolÃ¼: Ã¶nce tarih alanÄ±, sonra createdat
                  let w = null;
                  if (d.tarih) {
                    w = new Date(d.tarih);
                    if (isNaN(w.getTime())) w = null;
                  }
                  if (!w && d.createdat) {
                    w = new Date(d.createdat);
                    if (isNaN(w.getTime())) w = null;
                  }
                  
                  // Tarih filtresi (client-side)
                  if (start && end) {
                    if (!w || w < start || w >= end) return;
                  } else if (yil && w) {
                    if (w.getFullYear() !== yil) return;
                  }
                  
                  const p = canonName(d.personel || '-');
                  if (p !== personel) return;
                  
                  const tutar = Number(d.tutar ?? 0) || 0;
                  tahsilatTop += tutar;
                  const t = w || new Date();
                  const tStr = t && !isNaN(t.getTime()) ? t.toLocaleString('tr-TR') : '-';
                  const ad = d.borclu || d.odeyen || '-';
                  satirlar.push({ t, tStr, ad, miktar: tutar, tur: 'tahsilat', aciklama: (d.aciklama || '-'), miktarTip: 'â‚º' });
                });
              }

              const fmtPara = (n) => Math.round(n || 0).toLocaleString("tr-TR", { minimumFractionDigits: 0, maximumFractionDigits: 0 });
              let oran;
              if (isRamazanModal) {
                const toplamTemin = iftarTop + sahurTop + taahhutTop + teberruTop;
                oran = hedef > 0 ? (toplamTemin / hedef) * 100 : 0;
                m_hedefTeminTop.textContent = 'â‚º' + fmtPara(toplamTemin);
              } else {
                oran = hedef > 0 ? (hedefTeminTop / hedef) * 100 : 0;
                m_hedefTeminTop.textContent = 'â‚º' + fmtPara(hedefTeminTop);
              }
              const oranStr = Number(oran).toFixed(2).replace('.', ',');
              m_hedefTop.textContent = 'â‚º' + fmtPara(hedef);
              m_teberruTop.textContent = 'â‚º' + fmtPara(teberruTop);
              m_tahsilatTop.textContent = 'â‚º' + fmtPara(tahsilatTop);
              m_oranTop.textContent = '%' + oranStr;

              __modalRows = satirlar;
              __modalSort = { key: 't', dir: 'desc' };
              renderModalRows();

            } catch (err) {
              console.error('[detay modal] hata:', err);
              m_hareketTabloBody.innerHTML = `<tr><td colspan="5">KayÄ±tlar yÃ¼klenemedi.</td></tr>`;
              const fmtPara = (n) => Math.round(n || 0).toLocaleString("tr-TR", { minimumFractionDigits: 0, maximumFractionDigits: 0 });
              m_hedefTeminTop.textContent = 'â‚º0'; m_teberruTop.textContent = 'â‚º0'; m_tahsilatTop.textContent = 'â‚º0'; m_oranTop.textContent = '%0,00';
            }
          }
          window._acDetayModal = acDetayModal;

          (function initSelectors() {
            const now = new Date(); const curY = now.getFullYear();
            const years = []; for (let y = 2023; y <= curY + 1; y++) years.push(y);
            yilSec.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');
            const savedY = localStorage.getItem('hedefGrafik_yil');
            const savedM = localStorage.getItem('hedefGrafik_ay');
            yilSec.value = savedY || String(curY);
            aySec.value = (savedM === null) ? String(now.getMonth() + 1) : savedM;
            yilSec.addEventListener('change', () => { localStorage.setItem('hedefGrafik_yil', yilSec.value); aboneOl(); });
            aySec.addEventListener('change', () => { localStorage.setItem('hedefGrafik_ay', aySec.value); aboneOl(); });
            const k = localStorage.getItem('hedefGrafik_kategori'); if (k) kategoriSecimi.value = k;
            const f = localStorage.getItem('hedefGrafik_filtresi'); if (f) filtreSecimi.value = f;
            kategoriSecimi.addEventListener('change', () => { localStorage.setItem('hedefGrafik_kategori', kategoriSecimi.value); aboneOl(); });
            filtreSecimi.addEventListener('change', () => { localStorage.setItem('hedefGrafik_filtresi', filtreSecimi.value); uygulaFiltre(); });

            // Ekran modu butonu
            if (ekranButonu) {
              ekranButonu.addEventListener('click', () => {
                ekranModu = ekranModu === 'Hedef' ? 'Ramazan-Ä± Åerif' : 'Hedef';
                localStorage.setItem('hedefGrafik_ekranModu', ekranModu);
                if (ekranAdi) ekranAdi.textContent = ekranModu;
                tabloBasliklariniGuncelle();
                ozetMetrikleriniGuncelle();
                aboneOl();
              });
            }

            // Ä°lk yÃ¼klemede tablo baÅŸlÄ±klarÄ±nÄ± ve Ã¶zet metriklerini gÃ¼ncelle
            tabloBasliklariniGuncelle();
            ozetMetrikleriniGuncelle();
          })();

          async function loadKategoriler() {
            const sel = document.getElementById('kategoriSecimi');
            const supabase = getSupabase();
            if (!supabase) {
              console.warn('Supabase client hazÄ±r deÄŸil, kategoriler yÃ¼klenemedi');
              return;
            }

            try {
              const { data: kategoriData, error: kategoriError } = await supabase
                .from('kategoriler')
                .select('ad,aktif')
                .eq('aktif', true)
                .order('ad');

              if (kategoriError) {
                console.error('Kategoriler yÃ¼klenirken hata:', kategoriError);
                if (showToast) showToast('error', 'Hata', 'Kategoriler yÃ¼klenemedi.');
              }

              if (!kategoriError && kategoriData && kategoriData.length > 0) {
                const saved = localStorage.getItem('hedefGrafik_kategori') || 'TÃ¼mÃ¼';
                sel.innerHTML = '';
                sel.appendChild(new Option('TÃ¼mÃ¼', 'TÃ¼mÃ¼'));
                kategoriData.forEach(d => {
                  const ad = d.ad || '';
                  if (ad && ad.trim() !== '') {
                    sel.appendChild(new Option(ad, ad));
                  }
                });
                // EÄŸer kaydedilmiÅŸ kategori hala listede varsa seÃ§, yoksa 'TÃ¼mÃ¼' seÃ§
                const optionExists = Array.from(sel.options).some(opt => opt.value === saved);
                sel.value = optionExists ? saved : 'TÃ¼mÃ¼';
              } else {
                console.warn('Kategoriler bulunamadÄ± veya aktif kategori yok');
              }
            } catch (err) {
              console.error('Kategoriler okunamadÄ±:', err);
              if (showToast) showToast('error', 'Hata', 'Kategoriler yÃ¼klenirken bir hata oluÅŸtu.');
            }
          }

          // Kategori + ilk abonelik
          try {
            console.log('ğŸ“Š Kategoriler ve veriler yÃ¼kleniyor...');
            await loadKategoriler();
            console.log('ğŸ“Š aboneOl() Ã§aÄŸrÄ±lÄ±yor...');
            aboneOl();
          } catch (e) {
            console.error(e);
            if (showToast) {
              showToast('error', 'Hata', 'Veriler yÃ¼klenirken hata.');
            } else {
              console.error('Veriler yÃ¼klenirken hata.');
            }
          }
        }; // window.initPage kapanÄ±ÅŸÄ±

        // ortak.js'deki initAppShellAuth otomatik olarak window.initPage'i Ã§aÄŸÄ±racak
        // EÄŸer initAppShellAuth Ã§alÄ±ÅŸmadÄ±ysa (Ã¶rn: auth yÃ¼klenmediyse), manuel Ã§aÄŸÄ±r
        setTimeout(async () => {
          if (typeof window.initPage === 'function' && typeof window.CURRENT_ALLOW === 'undefined') {
            // initAppShellAuth Ã§alÄ±ÅŸmadÄ±ysa, manuel Ã§aÄŸÄ±r
            console.warn('initAppShellAuth Ã§alÄ±ÅŸmadÄ±, manuel initPage Ã§aÄŸrÄ±lÄ±yor');
            try {
              await window.initPage();
            } catch (e) {
              console.error('initPage hatasÄ±:', e);
            }
          }
        }, 1000);

      }); // waitForSupabaseAndOrtak callback kapanÄ±ÅŸÄ±
    }); // DOMContentLoaded event listener kapanÄ±ÅŸÄ±
  </script>
</body>

</html>