<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>1. Kat Temizlik Formu</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="../temizlik.css">
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="../../../js/firebase/firebase-init.js"></script>
</head>
<body>
  <header>
    <h2>🧽 1. Kat Temizlik Kontrol Formu</h2>
  </header>

  <form id="temizlikForm">
    <div class="bilgi-kutu">
      <label><strong>Tarih:</strong> <span id="tarih"></span></label><br>
      <label><strong>Saat:</strong> <span id="saat"></span></label><br>
      <label><strong>Sorumlu:</strong> <span id="kullaniciEmail"></span></label>
    </div>

    <div class="mahal-listesi" id="mahalListesi"></div>

    <div class="puan-ozet" id="puanOzet">Puan hesaplanıyor...</div>

    <button type="submit">Kaydet</button>
  </form>

  <div id="bildirim" class="toast">Kayıt başarılı!</div>

  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f4f6f9; margin: 0; padding: 0; }
    header { background: #2c3e50; color: white; padding: 15px 20px; }
    form { padding: 20px; }
    .bilgi-kutu, .puan-ozet {
      background: #eef2f7; padding: 15px; border-radius: 8px; margin-bottom: 20px;
    }
    .mahal-kutu {
      background: white; border-left: 5px solid #2c3e50;
      padding: 15px; margin-bottom: 15px; border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .mahal-kutu h4 { margin-bottom: 5px; }
    label { display: block; margin: 6px 0; }
    input, select { width: 100%; padding: 8px; box-sizing: border-box; }
    button {
      background: #2c3e50; color: white; padding: 12px 20px;
      border: none; border-radius: 6px; font-size: 16px; cursor: pointer;
    }
    button:hover { background: #34495e; }
    .toast {
      display: none; position: fixed; bottom: 20px; left: 50%;
      transform: translateX(-50%); background: #27ae60; color: white;
      padding: 12px 20px; border-radius: 6px;
    }
    .puan-yildiz { display: flex; gap: 4px; font-size: 24px; margin-top: 6px; color: #ccc; }
    .yildiz { cursor: pointer; transition: 0.2s; }
    .yildiz.secilmis { color: #f1c40f; }
  </style>

  <script>
    const mahaller = [
    "Kütüphane","Depo","Ders Personeli-1","Etüt","Müzakere",
    "Ders Personeli-2","Çayhane","Lavabo","Hol,","Asansör"
    ];

    const tarihEl = document.getElementById("tarih");
    const saatEl = document.getElementById("saat");
    const kullaniciEl = document.getElementById("kullaniciEmail");
    const mahalContainer = document.getElementById("mahalListesi");
    const puanOzetEl = document.getElementById("puanOzet");

    const now = new Date();
    tarihEl.innerText = now.toLocaleDateString("tr-TR");
    saatEl.innerText = now.toLocaleTimeString("tr-TR");

    let talebeListesi = {};

    firebase.auth().onAuthStateChanged(async user => {
      if (!user) return window.location.href = "../index.html";
      kullaniciEl.innerText = user.email;

      const snapshot = await firebase.firestore()
        .collection("temizlik_listesi").doc("1.kat").get();
      talebeListesi = snapshot.exists ? snapshot.data() : {};

      mahaller.forEach(mahal => {
        const talebeAdi = talebeListesi[mahal] || "Tanımsız";
        const el = document.createElement("div");
        el.className = "mahal-kutu";
        el.innerHTML = `
          <h4>${mahal} <span style="font-weight: normal; color: #555;">– ${talebeAdi}</span></h4>
          <label>Temiz mi?
            <select name="${mahal}_temiz">
              <option value="Hayır">Hayır</option>
              <option value="Evet">Evet</option>
            </select>
          </label>
          <label>Puan:
            <div class="puan-yildiz" data-mahal="${mahal}">
              ${[1,2,3,4,5].map(n => `<span class="yildiz" data-deger="${n}">&#9733;</span>`).join('')}
              <input type="hidden" name="${mahal}_puan" value="0" />
            </div>
          </label>
          <label>Açıklama:
            <input type="text" name="${mahal}_aciklama" />
          </label>
        `;
        mahalContainer.appendChild(el);
      });

      hesaplaPuan();
    });

    // ⭐ Yıldız tıklama
    document.addEventListener("click", e => {
      if (!e.target.classList.contains("yildiz")) return;
      const container = e.target.parentElement;
      const stars = container.querySelectorAll(".yildiz");
      const val = parseInt(e.target.dataset.deger);
      const hidden = container.querySelector("input[type='hidden']");
      hidden.value = val;
      stars.forEach(s => {
        const starVal = parseInt(s.dataset.deger);
        s.classList.toggle("secilmis", starVal <= val);
      });
      hesaplaPuan();
    });

    // Temizlik seçimi değişince davranış
    document.addEventListener("change", e => {
      if (e.target.tagName === "SELECT" && e.target.name.includes("_temiz")) {
        const mahal = e.target.name.split("_")[0];
        const temizMi = e.target.value;
        const starWrap = document.querySelector(`[data-mahal="${mahal}"]`);
        const stars = starWrap.querySelectorAll(".yildiz");
        const input = starWrap.querySelector("input");

        if (temizMi === "Hayır") {
          input.value = 0;
          stars.forEach(s => s.classList.remove("secilmis"));
        }
        hesaplaPuan();
      }
    });

    function hesaplaPuan() {
      let toplam = 0, aktif = 0;
      mahaller.forEach(mahal => {
        const temiz = document.querySelector(`[name="${mahal}_temiz"]`).value;
        const puan = parseInt(document.querySelector(`[name="${mahal}_puan"]`).value);
        if (temiz === "Evet") {
          toplam += puan;
          aktif++;
        }
      });
      const ort = aktif > 0 ? Math.round((toplam / (aktif * 5)) * 100) : 0;
      puanOzetEl.innerText = `Temizlenen Mahaller: ${aktif} / ${mahaller.length} | Ortalama Puan: ${ort} / 100`;
    }

    // Form kayıt
    document.getElementById("temizlikForm").addEventListener("submit", async e => {
      e.preventDefault();
      const user = firebase.auth().currentUser;
      if (!user) return;

      const tarih = new Date().toLocaleDateString("tr-TR");
      const saat = new Date().toLocaleTimeString("tr-TR");

      const batch = firebase.firestore().batch();
      const katRef = firebase.firestore().collection("temizlik_kontrol").doc("1.kat");
      const tarihRef = katRef.collection(tarih);

      mahaller.forEach(mahal => {
        const temiz = document.querySelector(`[name="${mahal}_temiz"]`).value;
        const puan = temiz === "Hayır" ? 0 : parseInt(document.querySelector(`[name="${mahal}_puan"]`).value);
        const aciklama = document.querySelector(`[name="${mahal}_aciklama"]`).value || "-";
        const talebe = talebeListesi[mahal] || "Tanımsız";

        const ref = tarihRef.doc(mahal);
        batch.set(ref, {
          mahal, talebe, temiz, puan, aciklama, saat, sorumlu: user.email
        });
      });

      try {
        await batch.commit();
        const bildirim = document.getElementById("bildirim");
        bildirim.style.display = "block";
        setTimeout(() => bildirim.style.display = "none", 3000);
      } catch (err) {
        alert("Hata: " + err.message);
      }
    });
  </script>
</body>
</html>
