<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Ä°ftar-Sahur RaporlarÄ± | Ramazan-Ä± Åerif</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <link rel="icon" type="image/png" href="../img/logo.png" />

  <!-- CSS -->
  <link rel="stylesheet" href="../css/app-shell.css" />
  
  <!-- Supabase (Auth + Database iÃ§in) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="../src/supabase.js"></script>
  <script src="../src/supabase-auth-wrapper.js"></script>
  <script src="../src/supabase-db-wrapper.js"></script>
  <script src="../js/ortak.js"></script>

  <!-- html2pdf -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" defer></script>

  <style>
    /* app-shell.css Ã¼st bar/arka plan/toast/yetki yapÄ±sÄ±nÄ± kullanÄ±r.
       Burada sadece sayfa-Ã¶zel kÃ¼Ã§Ã¼k dÃ¼zenlemeler var. */
    body {
      padding-top: var(--appbar-h) !important;
      overflow-x: hidden;
      overflow-y: auto;
    }

    /* Drawer masaÃ¼stÃ¼nde kapalÄ± kalmalÄ± */
    @media (min-width: 1025px) {
      .drawer {
        transform: translateX(100%) !important;
      }

      .drawer.open {
        transform: translateX(0) !important;
      }
    }
    
    .wrap {
      max-width: 1750px;
      margin: 0 auto;
      padding: 16px
    }
    
    .toolbar {
      display: flex;
      gap: 10px;
      flex-wrap: nowrap;
      align-items: center;
      overflow: auto;
      padding-bottom: 6px
    }
    /* Toolbar Ã¶ÄŸeleri manuel geniÅŸlik (istediÄŸiniz px deÄŸerini yazÄ±n) */
    #filtreYil { width: auto; min-width: 140px }
    #filtreTip { width: auto; min-width: 100px }
    #ara { width: auto; min-width: 140px }
    #filtreMod { width: auto; min-width: 130px }
    #btnExport { width: auto; min-width: 130px }
    #btnDetayliRapor { width: auto; min-width: 280px }
    #btnTumPersonelRapor { width: auto; min-width: 280px }

    .toolbar::-webkit-scrollbar {
      height: 6px
    }

    .toolbar::-webkit-scrollbar-thumb {
      background: #d7dde6;
      border-radius: 999px
    }

    select,
    input,
    button {
      height: 38px;
      border: 1px solid var(--border);
      background: #fff;
      border-radius: 10px;
      padding: 0 12px;
      font: inherit;
      color: var(--ink)
    }

    button {
      background: var(--accent);
      color: #fff;
      border: none;
      cursor: pointer;
      font-weight: 500
    }

    button.secondary {
      background: #fff;
      color: var(--ink);
      border: 1px solid var(--border)
    }

    button:hover {
      opacity: 0.9
    }

    button.danger {
      background: var(--bad);
      color: #fff
    }
    
    .chip{padding:8px 10px;border-radius:999px;border:1px solid var(--border);background:#fff;color:var(--muted);font-size:12px;white-space:nowrap}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:20px;margin:16px 0;box-shadow:0 1px 3px rgba(0,0,0,.05)}
    .kpi-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin:16px 0}
    .kpi{display:flex;flex-direction:column;gap:4px;padding:12px;background:#fff;border:1px solid var(--border);border-radius:12px}
    .kpi .label{color:var(--muted);font-size:12px;font-weight:500}
    .kpi .value{font-size:24px;font-weight:700;color:var(--ink)}
    .kpi.good .value{color:var(--good)}
    .kpi.warn .value{color:var(--warn)}
    
    .line{height:1px;background:var(--border);margin:8px 0}
    .muted{color:var(--muted)}
    
    .table-wrap{overflow:auto;border:1px solid var(--border);border-radius:12px}
    table{width:100%;border-collapse:collapse;background:#fff;min-width:900px}
    thead th{
      position:sticky;top:0;background:#fafbfc;border-bottom:2px solid var(--border);
      font-weight:600;text-align:left;font-size:13px;color:var(--muted);padding:12px;z-index:1
    }
    tbody td{border-bottom:1px solid var(--border);padding:12px;font-size:14px}
    tbody tr:hover{background:#f8f9fa}
    .right{text-align:right}
    tbody td:last-child{min-width:200px;max-width:300px;line-height:1.4}
    /* TaÅŸan metin: alt satÄ±ra geÃ§sin (kelime/cÃ¼mle wrap) */
    .td-scroll-text {
      max-width: 200px;
      word-wrap: break-word;
      overflow-wrap: break-word;
      white-space: normal;
      line-height: 1.35;
    }
    .td-scroll-text.td-scroll-narrow { max-width: 140px; }
    
    .card-list{display:none!important;gap:10px;margin-top:12px}
    .mini-card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:6px}
    .mini-line{display:flex;justify-content:space-between;gap:8px;font-size:14px}
    .mini-hl{font-weight:600}
    .chip-badge{padding:4px 8px;border-radius:4px;background:#f0f0f0;color:var(--ink);font-size:11px;display:inline-block}
    .chip-badge.iftar{background:#fff3cd;color:#856404}
    .chip-badge.sahur{background:#d1ecf1;color:#0c5460}
    
    .switcher{display:flex;gap:6px;align-items:center;white-space:nowrap;margin-left:8px}
    
    /* DetaylÄ± Ä°statistikler: sayÄ±lar kalÄ±n, adet/tutar siyah, tahsilat yeÅŸil, kalan kÄ±rmÄ±zÄ± */
    #detayliIstatistikler .stat-adet,
    #detayliIstatistikler .stat-tutar { font-weight: 700; color: #111; }
    #detayliIstatistikler .stat-tahsilat { font-weight: 700; color: var(--good); }
    #detayliIstatistikler .stat-kalan { font-weight: 700; color: var(--bad); }
    
    .avoid-break{page-break-inside:avoid;break-inside:avoid}
    
    /* DetaylÄ± Rapor Stilleri */
    #detayliRaporSection .card {
      page-break-inside: avoid;
      break-inside: avoid;
    }
    
    @media print{
      .toolbar{display:none!important}
      .wrap{max-width:100%;padding:0}
      .card{border:none;padding:0}
      .table-wrap{border:none}
      #detayliRaporSection .card {
        page-break-after: auto;
        margin-bottom: 20px;
      }
    }

    @media (max-width:768px){
      body{font-size:14px}
      .wrap{padding:10px}
      .card{padding:12px;margin:12px 0}
      .kpi .label{font-size:11px}
      .kpi .value{font-size:18px}
      .kpi{padding:8px 10px}
      /* KPI mobil: 3-3 (Ä°ftar|Ä°ÅŸtirak|Sahur / Tutar|MÃ¼safir|Toplam KayÄ±t) */
      #kpiRow{
        display:grid;
        grid-template-columns:repeat(3,1fr);
        gap:10px
      }
      #kpiRow .kpi:nth-child(1){order:1}
      #kpiRow .kpi:nth-child(5){order:2}
      #kpiRow .kpi:nth-child(2){order:3}
      #kpiRow .kpi:nth-child(3){order:4}
      #kpiRow .kpi:nth-child(4){order:5}
      #kpiRow .kpi:nth-child(6){order:6}
      thead th{font-size:11px;padding:8px 10px}
      tbody td{font-size:12px;padding:8px 10px}
      .chip-badge{font-size:10px;padding:3px 6px}
      .mini-line{font-size:12px}
      select,input,button{font-size:13px;height:34px;padding:0 10px}
      /* Toolbar mobil: 2 sÃ¼tun grid, filtreler 2â€™ÅŸer, butonlar tam geniÅŸlik */
      .toolbar{
        display:grid;
        grid-template-columns:repeat(2,1fr);
        gap:8px;
        flex-wrap:unset;
        padding-bottom:8px
      }
      .toolbar > div[style*="flex:1"]{display:none}
      .toolbar select,.toolbar input{min-width:0;width:100%;box-sizing:border-box}
      .toolbar button{grid-column:1/-1;width:100%;min-width:0}
    }
    @media (max-width:540px){
      body{font-size:13px}
      .table-wrap{display:block;overflow-x:auto;-webkit-overflow-scrolling:touch}
      .table-wrap table{min-width:800px}
      input{min-width:160px}
      thead th{font-size:10px;padding:6px 8px}
      tbody td{font-size:11px;padding:6px 8px}
      .kpi .value{font-size:16px}
    }
  </style>
</head>
<body>

  <!-- ÃœST APPBAR (hedef-grafik.html ile aynÄ± yapÄ±) -->
  <div class="appbar">
    <div class="brand" onclick="location.href='../panel.html'">
      <img src="../img/logo.png" alt="logo"><span>KARAAÄAÃ‡ FATÄ°H</span>
    </div>
    <nav class="nav-center">
      <ul class="nav-list" id="navMain"></ul>
    </nav>
    <div class="nav-right">
      <button class="btn hamb" id="hamburger" title="MenÃ¼">â˜°</button>

      <!-- Bildirim -->
      <div class="nav-item">
        <button class="iconbtn" id="btnNotif" title="Bildirimler">ğŸ””
          <span class="badge" id="notifBadge" style="display:none">0</span>
        </button>
        <div class="dropdown drop-right" id="notifDropdown" aria-label="Bildirim listesi">
          <div class="muted" style="padding:6px 8px">Son bildirimler</div>
          <div id="notifList" class="list" style="max-height:300px;overflow:auto"></div>
        </div>
      </div>

      <!-- Profil -->
      <div class="nav-item">
        <button class="iconbtn" id="btnProfile" title="Profil">
          <span class="avatar"></span> <span id="profName" class="muted">Profil</span>
        </button>
        <div class="dropdown drop-right" id="profDropdown" aria-label="Profil menÃ¼sÃ¼">
          <a href="../diger/kullanici-yonetimi.html">ğŸ‘¤ Profil</a>
          <a href="../diger/sistem-ayarlari.html">âš™ï¸ Sistem AyarlarÄ±</a>
          <a href="#" id="btnLogout">ğŸšª Ã‡Ä±kÄ±ÅŸ Yap</a>
        </div>
      </div>
    </div>
  </div>
<aside class="drawer" id="drawer"></aside>
<div class="toast-container" id="toastContainer"></div>

<!-- Progress Bar -->
<div class="progress-container" id="progressContainer">
  <div class="progress-bar-fill" id="progressBar"></div>
</div>

<main class="wrap" id="pdf-root">
  <h2 style="margin:12px 0 8px 0;font-size:24px;font-weight:800">Ramazan-Ä± Åerif</h2>
  <div class="muted" style="margin-bottom:12px">2026 Ramazan-Ä± Åerif</div>
  <div class="toolbar">
    <select id="filtreYil">
      <option value="">YÄ±l seÃ§iniz...</option>
    </select>
    <select id="filtreTip">
      <option value="">TÃ¼m Tipler</option>
      <option value="iftar">Ä°ftar</option>
      <option value="sahur">Sahur</option>
    </select>
    <input id="ara" placeholder="Sahip / Personel ara..." />
    <select id="filtreMod">
      <option value="tum">TÃ¼m KayÄ±tlar</option>
      <option value="kendim">Sadece Kendim</option>
    </select>
    <div style="flex:1"></div>
    <button id="btnExport" class="secondary">CSV Ä°ndir</button>
    <button id="btnDetayliRapor" class="good" style="background:var(--good)">ğŸ“Š DetaylÄ± Personel Raporu (2023-2025)</button>
    <button id="btnTumPersonelRapor" class="good" style="background:var(--accent)">ğŸ“‹ TÃ¼m Personel Raporu</button>
  </div>
    <!-- KPI KartlarÄ± -->
    <div class="kpi-row" id="kpiRow">
      <div class="kpi">
        <span class="label">Toplam Ä°ftar</span>
        <span class="value" id="kpiIftar">0</span>
      </div>
      <div class="kpi">
        <span class="label">Toplam Sahur</span>
        <span class="value" id="kpiSahur">0</span>
      </div>
      <div class="kpi">
        <span class="label">Toplam Tutar (â‚º)</span>
        <span class="value" id="kpiTutar">â‚º0</span>
      </div>
      <div class="kpi">
        <span class="label">Toplam MÃ¼safir</span>
        <span class="value" id="kpiMusafir">0</span>
      </div>
      <div class="kpi good">
        <span class="label">Ä°ÅŸtirak Edilen</span>
        <span class="value" id="kpiIstirak">0</span>
      </div>
      <div class="kpi">
        <span class="label">Toplam KayÄ±t</span>
        <span class="value" id="kpiToplam">0</span>
      </div>
    </div>

    <!-- DetaylÄ± Ä°statistikler -->
    <div class="card" style="margin-top:16px;padding:16px;background:#f9fafb">
      <div id="detayliIstatistikler" style="display:flex;flex-direction:column;gap:8px;font-size:14px;line-height:1.6">
        <div><strong>Teberru toplam:</strong> <span id="statTeberruToplam" class="stat-tutar">â‚º0</span> 
          (<span id="statTeberruNakit" class="stat-tutar">nakit: â‚º0</span>, 
          <span id="statTeberruBanka" class="stat-tutar">banka: â‚º0</span>, 
          <span id="statTeberruPos" class="stat-tutar">pos: â‚º0</span>, 
          <span id="statTeberruSanal" class="stat-tutar">sanal: â‚º0</span>)
        </div>
        <div><strong>TaahhÃ¼t:</strong> adet <span id="statTaahhutAdet" class="stat-adet">0</span> Â· toplam tutar <span id="statTaahhutToplam" class="stat-tutar">â‚º0</span> Â· tahsilat <span id="statTaahhutTahsilat" class="stat-tahsilat">â‚º0</span> Â· kalan <span id="statTaahhutKalan" class="stat-kalan">â‚º0</span></div>
        <div><strong>Ä°ftar:</strong> adet <span id="statIftarAdet" class="stat-adet">0</span> Â· toplam tutar <span id="statIftarToplam" class="stat-tutar">â‚º0</span> Â· tahsilat <span id="statIftarTahsilat" class="stat-tahsilat">â‚º0</span> Â· kalan <span id="statIftarKalan" class="stat-kalan">â‚º0</span></div>
        <div><strong>Sahur:</strong> adet <span id="statSahurAdet" class="stat-adet">0</span> Â· toplam tutar <span id="statSahurToplam" class="stat-tutar">â‚º0</span> Â· tahsilat <span id="statSahurTahsilat" class="stat-tahsilat">â‚º0</span> Â· kalan <span id="statSahurKalan" class="stat-kalan">â‚º0</span></div>
      </div>
    </div>

    <!-- Liste -->
    <div class="card">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;flex-wrap:wrap">
        <h3 style="margin:0">DetaylÄ± Liste | SeÃ§ime GÃ¶re</h3>
      </div>

      <div class="table-wrap" id="tableWrap">
        <table id="tbl">
          <thead>
            <tr>
              <th>Tarih</th>
              <th>Tip</th>
              <th>Sahip</th>
              <th class="right">Tutar (â‚º)</th>
              <th>Tahsilat / Kalan</th>
              <th>Ä°ÅŸtirak</th>
              <th>MÃ¼safir</th>
              <th>Mahal</th>
              <th>Personel</th>
              <th>Not</th>
              <th>Durum</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
          <tfoot>
            <tr>
              <td colspan="3" class="right"><strong>TOPLAM</strong></td>
              <td class="right" id="sumTutar"><strong>â‚º0</strong></td>
              <td></td>
              <td colspan="5"></td>
              <td class="right" id="sumMusafir"><strong>0</strong></td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="card-list" id="cardList"></div>
    </div>

    <!-- DetaylÄ± Personel BazlÄ± Raporlama -->
    <div class="card" id="detayliRaporSection" style="display:none">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;flex-wrap:wrap">
        <h3 style="margin:0">ğŸ“Š Personel BazlÄ± DetaylÄ± Analiz Raporu (2023-2024-2025)</h3>
        <div style="flex:1"></div>
        <select id="personelSecimi" style="min-width:200px">
          <option value="">Personel SeÃ§iniz...</option>
        </select>
        <button id="btnRaporYazdir" class="good" style="background:var(--good)">ğŸ–¨ï¸ YazdÄ±r</button>
        <button id="btnRaporPDF" class="good" style="background:var(--good)">PDF'ye Aktar</button>
        <button id="btnRaporExcel" class="secondary">Excel'e Aktar</button>
      </div>
      
      <!-- Personel Analiz BÃ¶lÃ¼mÃ¼ -->
      <div id="personelAnalizContainer" style="display:none">
        <!-- Personel BaÅŸlÄ±k -->
        <div class="card" style="margin-bottom:16px;background:var(--surface2)">
          <h4 id="personelBaslik" style="margin:0;font-size:20px;color:var(--accent)"></h4>
          <div class="muted" id="personelAktifYillar" style="margin-top:4px"></div>
        </div>

        <!-- YÄ±l BazlÄ± Ã–zet -->
        <div class="card" style="margin-bottom:16px">
          <h5 style="margin:0 0 12px 0;font-size:16px">ğŸ“Š YÄ±l BazlÄ± Ã–zet</h5>
          <div id="yilBazliOzet"></div>
        </div>

        <!-- DetaylÄ± KayÄ±tlar -->
        <div class="card" style="margin-bottom:16px">
          <h5 style="margin:0 0 12px 0;font-size:16px">ğŸ“‹ DetaylÄ± KayÄ±tlar</h5>
          <div id="detayliKayitlar"></div>
        </div>

        <!-- BaÄŸÄ±ÅŸÃ§Ä± Analizi -->
        <div class="card" style="margin-bottom:16px;background:var(--surface2)">
          <h5 style="margin:0 0 12px 0;font-size:16px">ğŸ‘¥ BaÄŸÄ±ÅŸÃ§Ä± Analizi</h5>
          <div class="kpi-row" id="bagisciAnalizKPIs">
            <div class="kpi good">
              <span class="label">Daimi BaÄŸÄ±ÅŸÃ§Ä±</span>
              <span class="value" id="daimiBagisciSayisi">0</span>
              <small class="muted">3 yÄ±lda da baÄŸÄ±ÅŸ yapan</small>
            </div>
            <div class="kpi" style="background:#fff3cd">
              <span class="label">Yeni BaÄŸÄ±ÅŸÃ§Ä±</span>
              <span class="value" id="yeniBagisciSayisi">0</span>
              <small class="muted">Sadece 2025'te baÄŸÄ±ÅŸ yapan</small>
            </div>
            <div class="kpi" style="background:#f8d7da">
              <span class="label">Pasif BaÄŸÄ±ÅŸÃ§Ä±</span>
              <span class="value" id="pasifBagisciSayisi">0</span>
              <small class="muted">Ã–nceki yÄ±llarda var, 2025'te yok</small>
            </div>
          </div>
        </div>

        <!-- BaÄŸÄ±ÅŸÃ§Ä± DetaylarÄ± -->
        <div class="card" style="margin-bottom:16px">
          <h5 style="margin:0 0 12px 0;font-size:16px">ğŸ“‹ BaÄŸÄ±ÅŸÃ§Ä± DetaylarÄ± (YÄ±l YÄ±l, Tip Tip)</h5>
          <div id="bagisciDetaylari"></div>
        </div>

        <!-- BaÄŸÄ±ÅŸÃ§Ä± Ä°sim Listesi ve Kategorileri -->
        <div class="card" style="margin-bottom:16px">
          <h5 style="margin:0 0 12px 0;font-size:16px">ğŸ‘¤ BaÄŸÄ±ÅŸÃ§Ä±lar (Ä°sim BazlÄ± DetaylÄ± Analiz)</h5>
          <div id="bagisciIsimListesi"></div>
        </div>
      </div>

      <!-- Personel seÃ§ilmediÄŸinde mesaj -->
      <div id="personelSecilmediMesaj" style="text-align:center;padding:40px;color:var(--muted)">
        <p>LÃ¼tfen yukarÄ±dan bir personel seÃ§iniz.</p>
      </div>
    </div>
  </main>

  <script>
    // ===== SUPABASE (Tam Entegrasyon) =====
    // supabase-auth-wrapper.js ve supabase-db-wrapper.js window.supabase'i oluÅŸturuyor
    // Burada direkt window.supabase'i kullanÄ±yoruz (const/let tanÄ±mlamÄ±yoruz, Ã§akÄ±ÅŸma Ã¶nlemek iÃ§in)
    
    // Supabase client'Ä±n hazÄ±r olmasÄ±nÄ± bekle
    async function waitForSupabase() {
      if (window.supabase && window.supabase.auth) {
        return window.supabase;
      }
      
      // Maksimum 5 saniye bekle
      return new Promise((resolve) => {
        let attempts = 0;
        const maxAttempts = 50; // 5 saniye (50 * 100ms)
        
        const checkInterval = setInterval(() => {
          attempts++;
          if (window.supabase && window.supabase.auth) {
            clearInterval(checkInterval);
            resolve(window.supabase);
          } else if (attempts >= maxAttempts) {
            clearInterval(checkInterval);
            console.warn('âš ï¸ Supabase client hazÄ±r olana kadar beklenemedi');
            resolve(null);
          }
        }, 100);
      });
    }
    
    const qs = s => document.querySelector(s);
    
    let kayitlar = [];
    let teberruKayitlari = [];
    let taahhutKayitlari = [];
    let duzenlemeTalepleri = [];
    let mahallerList = []; // ramazan_mahaller: mahalid -> adi eÅŸleÅŸtirmesi iÃ§in
    let tahsilatByKayitId = {}; // kayit_id -> toplam tahsilat (iftar/sahur/taahhut iÃ§in)
    let currentUser = null;
    let currentUserUid = null;

    const ayIsimleri = ['Ocak','Åubat','Mart','Nisan','MayÄ±s','Haziran','Temmuz','AÄŸustos','EylÃ¼l','Ekim','KasÄ±m','AralÄ±k'];

/* ===== Navigation Bar ===== */
    // ortak.js zaten CURRENT_ALLOW ve CURRENT_DENY'yi window Ã¼zerinde tanÄ±mlÄ±yor
    // let ifadesini kaldÄ±rarak doÄŸrudan global deÄŸiÅŸkenleri kullanÄ±yoruz veya yoksa oluÅŸturuyoruz
    if (!window.CURRENT_ALLOW) window.CURRENT_ALLOW = new Set();
    if (!window.CURRENT_DENY) window.CURRENT_DENY = new Set();
    
// Kodun geri kalanÄ±nda kolay kullanÄ±m iÃ§in referanslarÄ± gÃ¼ncelleyelim (tekrar let tanÄ±mlamadan)
window.CURRENT_ALLOW = window.CURRENT_ALLOW;
    window.CURRENT_DENY = window.CURRENT_DENY;
    
    // norm fonksiyonu ortak.js'den geliyor, burada tekrar tanÄ±mlamaya gerek yok.
    
    function normalizeUrl(u){
      if(!u || u === '#') return '#';
      // HTTP/HTTPS URL'leri olduÄŸu gibi bÄ±rak
      if(/^https?:\/\//i.test(u)) return u;
      if(u.startsWith('//')) return u;
      // Zaten relative path'ler (../ veya ./ ile baÅŸlayan) olduÄŸu gibi bÄ±rak
      if(u.startsWith('../') || u.startsWith('./')) return u;
      
      // Mevcut dosyanÄ±n konumuna gÃ¶re relative hale getir
      const currentPath = location.pathname;
      const currentDir = currentPath.substring(0, currentPath.lastIndexOf('/'));
      // Mevcut dizin seviyesini hesapla (kaÃ§ seviye yukarÄ± Ã§Ä±kmalÄ±yÄ±z)
      const currentDepth = currentDir.split('/').filter(x => x).length;
      
      // Root'a dÃ¶nmek iÃ§in ../ sayÄ±sÄ±
      const upLevels = currentDepth > 0 ? '../'.repeat(currentDepth) : '';
      
      // Path'i temizle: / ile baÅŸlÄ±yorsa kaldÄ±r, yoksa olduÄŸu gibi kullan
      const targetPath = u.startsWith('/') ? u.substring(1) : u;
      
      return upLevels + targetPath;
    }

    async function fetchPanels(allowSet, denySet){
      const res=[]; 
      if (!window.supabase) return res;
      
      try{
        const { data, error } = await window.supabase
          .from('sayfa_manifesti')
          .select('id, title, order, pages');
        
        if (error || !data) return res;
        
        data.forEach(doc=>{
          const d=doc||{}, id=d.id||'', panelTitle=d.title||id;
          const panelGrant = allowSet.has(norm(id)) || allowSet.has(norm(panelTitle));
          let pages = Array.isArray(d.pages)? d.pages : [];
          pages = pages.filter(pg=>{
            const keyNorm=norm(pg.key||pg.title||'');
            const pageGrant=allowSet.has(keyNorm), denied=denySet.has(keyNorm);
            return !denied && (panelGrant || pageGrant);
          }).map(pg=>({ baslik: pg.title||pg.key||'Sayfa', url: normalizeUrl(pg.path||'#'), key: pg.key||pg.title||'', sira: typeof pg.order==='number'? pg.order:9999 }))
            .sort((a,b)=>a.sira-b.sira);
          if(pages.length) res.push({ id, baslik:panelTitle, sira: typeof d.order==='number'? d.order:9999, pages });
        });
        res.sort((a,b)=>a.sira-b.sira);
      }catch(e){ console.error(e); }
      return res;
    }

    function renderNav(panels){
      const ul=document.getElementById('navMain'), drawer=document.getElementById('drawer');
      ul.innerHTML=''; drawer.innerHTML='';
      if(!panels.length){
        ul.innerHTML='<li class="nav-item"><div class="nav-btn">Panel yok</div></li>';
        drawer.innerHTML='<div class="muted" style="padding:8px">MenÃ¼ bulunamadÄ±</div>'; return;
      }
      panels.forEach(p=>{
        const li=document.createElement('li'); li.className='nav-item';
        li.innerHTML=`<div class="nav-btn">${p.baslik} <span class="caret">â–¾</span></div>`;
        const dd=document.createElement('div'); dd.className='dropdown';
        (p.pages||[]).forEach(pg=>{
          const a=document.createElement('a');
          a.href=normalizeUrl(pg.url || pg.path || '#'); a.textContent=pg.baslik;
          a.dataset.key=pg.key||pg.baslik; a.dataset.panel=p.id; a.dataset.panelTitle=p.baslik;
          dd.appendChild(a);
        });
        li.appendChild(dd);
        li.querySelector('.nav-btn').addEventListener('click',(e)=>{
          e.stopPropagation();
          ul.querySelectorAll('.nav-item').forEach(x=>{ if(x!==li) x.classList.remove('open'); });
          li.classList.toggle('open');
        });
        ul.appendChild(li);

        const h=document.createElement('div'); h.className='panel-title'; h.textContent=p.baslik; drawer.appendChild(h);
        (p.pages||[]).forEach(pg=>{
          const a=document.createElement('a');
          a.href=normalizeUrl(pg.url || pg.path || '#'); a.textContent=pg.baslik;
          a.dataset.key=pg.key||pg.baslik; a.dataset.panel=p.id; a.dataset.panelTitle=p.baslik;
          drawer.appendChild(a);
        });
      });
      document.addEventListener('click',(e)=>{ if(!ul.contains(e.target)) ul.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('open')); });
    }

    (function(){ 
      const hamb=document.getElementById('hamburger'), drawer=document.getElementById('drawer'); 
      if(!hamb || !drawer) return; 
      
      // MasaÃ¼stÃ¼nde drawer'Ä± kapat
      function closeDrawerOnDesktop() {
        if(window.innerWidth >= 1025) {
          drawer.classList.remove('open');
        }
      }
      
      // Sayfa yÃ¼klendiÄŸinde ve resize'da kontrol et
      closeDrawerOnDesktop();
      window.addEventListener('resize', closeDrawerOnDesktop);
      
      function toggleDrawer(e) {
        if (e) { e.preventDefault(); e.stopPropagation(); }
        drawer.classList.toggle('open');
      }
      // Hem dokunma hem tÄ±klama: pointerup (mobil + masaÃ¼stÃ¼) ve click yedek; touchend'de preventDefault ile Ã§ift tetikleme Ã¶nlenir
      var drawerJustToggledByTouch = false;
      hamb.addEventListener('touchend', function(e) {
        e.preventDefault();
        drawerJustToggledByTouch = true;
        drawer.classList.toggle('open');
        setTimeout(function() { drawerJustToggledByTouch = false; }, 350);
      }, { passive: false });
      hamb.addEventListener('click', function(e) {
        if (drawerJustToggledByTouch) return;
        e.preventDefault();
        e.stopPropagation();
        drawer.classList.toggle('open');
      });
      document.addEventListener('click', function(e) { 
        if(!drawer.contains(e.target) && !hamb.contains(e.target)) drawer.classList.remove('open'); 
      });
      document.addEventListener('touchend', function(e) {
        if(!drawer.contains(e.target) && !hamb.contains(e.target)) drawer.classList.remove('open');
      }, { passive: true });
    })();

    document.addEventListener('click',(e)=>{
      const a=e.target.closest('a[data-key]'); if(!a) return;
      const key=norm(a.dataset.key), pnl=norm(a.dataset.panel||''), pnlTitle=norm(a.dataset.panelTitle||'');
      if(CURRENT_DENY.has(key)){ e.preventDefault(); return; }
      const allowed = CURRENT_ALLOW.has(key) || CURRENT_ALLOW.has(pnl) || CURRENT_ALLOW.has(pnlTitle);
      if(!allowed){ e.preventDefault(); }
    });

    (function(){
      const profBtn=document.getElementById('btnProfile'), profDD=document.getElementById('profDropdown');
      function closeAll(e){
        if(!profDD.contains(e.target)  && e.target!==profBtn)  profDD.parentElement.classList.remove('open');
      }
      document.addEventListener('click', closeAll);
      profBtn?.addEventListener('click',(e)=>{ e.stopPropagation(); profDD.parentElement.classList.toggle('open'); });
      document.getElementById('btnLogout')?.addEventListener('click', async (e) => {
        e.preventDefault();
        try { 
          if (window.supabase) {
            await window.supabase.auth.signOut();
          }
          location.assign('../../index.html'); 
        }
        catch(err){ console.error(err); }
      });
    })();

    // ===== SUPABASE AUTH KONTROLÃœ (CanlÄ± Veri iÃ§in) =====
    async function initSupabaseAuth() {
      // window.supabase'in hazÄ±r olmasÄ±nÄ± bekle
      const supabaseClient = await waitForSupabase();
      if (!supabaseClient) {
        console.warn('âš ï¸ Supabase client hazÄ±r deÄŸil, auth init edilemedi');
        // Test modu iÃ§in sayfanÄ±n Ã§alÄ±ÅŸmasÄ±na izin ver
        try {
          await loadRamazanYillari();
          loadKayitlar();
        } catch (e) {
          console.warn('Veri yÃ¼kleme hatasÄ± (test modu, Supabase yok):', e);
        }
        return;
      }
      // window.supabase'i kullan
      setupSupabaseAuth(supabaseClient);
    }

    async function setupSupabaseAuth(supabaseClient = null) {
      // Supabase client'Ä± al (parametre olarak verilmediyse window'dan al)
      const supabase = supabaseClient || window.supabase;
      
      // Supabase client kontrolÃ¼ - test modu iÃ§in
      if (!supabase || !supabase.auth) {
        console.warn('âš ï¸ Supabase client hazÄ±r deÄŸil, test modu aktif');
        // Session olmasa bile sayfanÄ±n Ã§alÄ±ÅŸmasÄ± iÃ§in veri yÃ¼kleme iÅŸlemlerini deneyelim
        try {
          await loadRamazanYillari();
          loadKayitlar();
        } catch (e) {
          console.warn('Veri yÃ¼kleme hatasÄ± (test modu, Supabase yok):', e);
        }
        return;
      }
      
      // Mevcut session'Ä± kontrol et
      window.supabase.auth.getSession().then(async ({ data: { session }, error }) => {
        if (error || !session) {
          // TEST MODU: YÃ¶nlendirme devre dÄ±ÅŸÄ±
          // window.location.href = '../../index.html';
          console.warn('âš ï¸ Supabase oturumu yok, test modu aktif, yÃ¶nlendirme durduruldu');
          // SayfanÄ±n Ã§alÄ±ÅŸmaya devam etmesi iÃ§in session olmasa bile devam et
          // return; // <-- Bu satÄ±rÄ± da yoruma aldÄ±k
        } else {
          // Session varsa kullanÄ±cÄ± bilgilerini ayarla
          currentUser = session.user; // Supabase user objesi
          currentUserUid = session.user.id;
        }
        
        // Session varsa kullanÄ±cÄ± bilgilerini ayarla
        if (session && session.user) {
          currentUser = session.user; // Supabase user objesi
          currentUserUid = session.user.id;
          
          // KullanÄ±cÄ± bilgilerini Supabase'den al
          try {
            const { data: kullanici, error: kullaniciError } = await window.supabase
              .from('kullanicilar')
              .select('adsoyad, yetkiler')
              .eq('id', currentUserUid)
              .single();
            
            if (!kullaniciError && kullanici) {
              // Profil adÄ±nÄ± gÃ¼ncelle
              const profNameEl = document.getElementById('profName');
              if (profNameEl) profNameEl.textContent = kullanici.adsoyad || currentUser.email?.split('@')[0] || 'Profil';
              
              // Yetkileri yÃ¼kle (ortak.js'deki window.CURRENT_ALLOW ve CURRENT_DENY'yi gÃ¼ncelle)
              const rawPerms = Array.isArray(kullanici.yetkiler) ? kullanici.yetkiler : [];
              window.CURRENT_ALLOW = new Set(rawPerms.filter(s=>!String(s).trim().startsWith('-') && !String(s).trim().startsWith('!')).map(norm));
              window.CURRENT_DENY = new Set(rawPerms.filter(s=>String(s).trim().startsWith('-') || String(s).trim().startsWith('!')).map(s=>norm(String(s).replace(/^[-!]\s*/,''))));
              // Local referanslarÄ± da gÃ¼ncelle (window ile senkronize et)
              CURRENT_ALLOW = window.CURRENT_ALLOW;
              CURRENT_DENY = window.CURRENT_DENY;
              
              // Navigation render (Supabase'den manifest Ã§ek)
              if (window.supabase) {
                try {
                  const { data: manifestData, error: manifestError } = await window.supabase
                    .from('sayfa_manifesti')
                    .select('id, title, order, pages');
                  
                  if (!manifestError && manifestData) {
                    const panels = [];
                    manifestData.forEach(doc => {
                      const d = doc || {}, id = d.id || '', panelTitle = d.title || id;
                      const panelGrant = CURRENT_ALLOW.has(norm(id)) || CURRENT_ALLOW.has(norm(panelTitle));
                      let pages = Array.isArray(d.pages) ? d.pages : [];
                      pages = pages.filter(pg => {
                        const keyNorm = norm(pg.key || pg.title || '');
                        const pageGrant = CURRENT_ALLOW.has(keyNorm), denied = CURRENT_DENY.has(keyNorm);
                        return !denied && (panelGrant || pageGrant);
                      }).map(pg => ({
                        baslik: pg.title || pg.key || 'Sayfa',
                        url: normalizeUrl(pg.path || '#'),
                        key: pg.key || pg.title || '',
                        sira: typeof pg.order === 'number' ? pg.order : 9999
                      })).sort((a, b) => a.sira - b.sira);
                      if (pages.length) panels.push({ id, baslik: panelTitle, sira: typeof d.order === 'number' ? d.order : 9999, pages });
                    });
                    panels.sort((a, b) => a.sira - b.sira);
                    renderNav(panels);
                  }
                } catch (e) {
                  console.error('Navigation yÃ¼klenemedi:', e);
                }
              }
            }
          } catch (e) {
            console.error('KullanÄ±cÄ± bilgisi alÄ±namadÄ±:', e);
          }
        }
        
        // Ramazan yÄ±llarÄ±nÄ± yÃ¼kle ve yÄ±l seÃ§eneklerini gÃ¼ncelle (session olmasa bile test iÃ§in)
        try {
          await loadRamazanYillari();
          
          // YÄ±l seÃ§ildikten sonra verileri yÃ¼kle (yÄ±l dropdown'u dolu olmalÄ±)
          // loadKayitlar() yÄ±l deÄŸiÅŸikliÄŸi event listener'Ä±nda Ã§aÄŸrÄ±lacak veya ilk seÃ§ilen yÄ±ldan sonra Ã§aÄŸrÄ±lacak
          const yilSelect = qs('#filtreYil');
          if (yilSelect && yilSelect.value) {
            loadKayitlar();
          }
        } catch (e) {
          console.warn('Veri yÃ¼kleme hatasÄ± (test modu):', e);
        }
      });

      // Auth state deÄŸiÅŸikliklerini dinle (sadece Supabase hazÄ±rsa)
      if (!window.supabase || !window.supabase.auth) {
        console.warn('âš ï¸ Supabase auth dinleyicisi kurulamadÄ± (test modu)');
        return;
      }
      
      window.supabase.auth.onAuthStateChange(async (event, session) => {
        if (event === 'SIGNED_OUT' || !session) {
          // TEST MODU: YÃ¶nlendirme devre dÄ±ÅŸÄ±
          // window.location.href = '../../index.html';
          console.warn('âš ï¸ Supabase oturumu yok, test modu aktif, yÃ¶nlendirme durduruldu');
          // return; // <-- Bu satÄ±rÄ± da yoruma aldÄ±k
        }
        
        if (session && session.user) {
          currentUser = session.user;
          currentUserUid = session.user.id;
          
          // Profil bilgisini gÃ¼ncelle
          const profNameEl = document.getElementById('profName');
          if (profNameEl) {
            try {
              const { data: kullanici } = await window.supabase
                .from('kullanicilar')
                .select('adsoyad')
                .eq('id', currentUserUid)
                .single();
              
              if (kullanici && kullanici.adsoyad) {
                profNameEl.textContent = kullanici.adsoyad;
              }
            } catch (e) {
              console.error('Profil gÃ¼ncelleme hatasÄ±:', e);
            }
          }
        }
      });
    }

    // Supabase auth'u baÅŸlat
    initSupabaseAuth();

    let silinenKayitlar = [];
    let supabaseChannels = []; // Realtime channel'larÄ± saklamak iÃ§in

    // ===== SUPABASE: KayÄ±tlarÄ± yÃ¼kle (Realtime) =====
    async function loadKayitlar() {
      const yil = parseInt(qs('#filtreYil').value);
      if (!yil) {
        console.warn('YÄ±l seÃ§ilmemiÅŸ, veri yÃ¼klenemiyor');
        return;
      }
      if (!window.supabase) {
        console.warn('Supabase client hazÄ±r deÄŸil (test modu)');
        return;
      }
      
      try {
        // Mahal listesini yÃ¼kle (mahalid -> adi eÅŸleÅŸtirmesi iÃ§in)
        try {
          const { data: mahalData } = await window.supabase.from('ramazan_mahaller').select('id, adi').order('adi', { ascending: true });
          mahallerList = (mahalData || []).map(m => ({ id: m.id, adi: m.adi }));
        } catch (_) { mahallerList = []; }

        // Ã–nce mevcut verileri yÃ¼kle
        const { data, error } = await window.supabase
          .from('ramazan_kayitlari')
          .select('id, yil, tip, sahip, tutar, istirak, musafiradedi, ay, mahalid, mahal, personel, personeladi, personeluid, kaydedenpersonel, kaydedenpersoneluid, notlar, createdat, updatedat, tarih')
          .eq('yil', yil)
          .order('tarih', { ascending: false });
        
        if (error) throw error;
        
        kayitlar = (data || []).map(r => {
          const mahalAdi = r.mahal || (r.mahalid && mahallerList.find(m => m.id === r.mahalid)?.adi) || '';
          return {
            ...r,
            mahal: mahalAdi,
            musafirAdedi: r.musafiradedi, // compatibility
            personelUid: r.personeluid, // compatibility
            personelAdi: r.personeladi || r.personelAdi || '' // ramazan_kayitlari: sadece personeladi (mail gelmesin)
          };
        });
        
        // Realtime subscription (Supabase Realtime)
        const channel = window.supabase
          .channel(`ramazan_kayitlari_${yil}`)
          .on('postgres_changes', {
            event: '*',
            schema: 'public',
            table: 'ramazan_kayitlari',
            filter: `yil=eq.${yil}`
          }, async (payload) => {
            console.log('Realtime update:', payload);
            // Veriyi yeniden yÃ¼kle
            const { data: newData } = await window.supabase
              .from('ramazan_kayitlari')
              .select('id, yil, tip, sahip, tutar, istirak, musafiradedi, ay, mahalid, mahal, personel, personeladi, personeluid, kaydedenpersonel, kaydedenpersoneluid, notlar, createdat, updatedat, tarih')
              .eq('yil', yil)
              .order('tarih', { ascending: false });
            
            if (newData) {
              kayitlar = newData.map(r => {
                const mahalAdi = r.mahal || (r.mahalid && mahallerList.find(m => m.id === r.mahalid)?.adi) || '';
                return {
                  ...r,
                  mahal: mahalAdi,
                  musafirAdedi: r.musafiradedi,
                  personelUid: r.personeluid,
                  personelAdi: r.personeladi || r.personelAdi || ''
                };
              });
              loadSilinenKayitlar();
              loadTeberruKayitlari();
              loadTaahhutKayitlari();
              loadDuzenlemeTalepleri();
            }
          })
          .subscribe();
        
        supabaseChannels.push(channel);
        
        // DiÄŸer verileri de yÃ¼kle
        loadSilinenKayitlar();
        loadTeberruKayitlari();
        loadTaahhutKayitlari();
        loadDuzenlemeTalepleri();
        loadTahsilat();
      } catch (e) {
        console.error('KayÄ±tlar yÃ¼klenemedi:', e);
        kayitlar = [];
      }
    }

    // ===== SUPABASE: Teberru kayÄ±tlarÄ±nÄ± yÃ¼kle (Realtime) =====
    async function loadTeberruKayitlari() {
      const yil = parseInt(qs('#filtreYil').value);
      if (!yil || !window.supabase) {
        teberruKayitlari = [];
        render();
        return;
      }
      
      try {
        // Ã–nce mevcut verileri yÃ¼kle
        const { data, error } = await window.supabase
          .from('teberru_kayitlari')
          .select('id, aciklama, ay, bagisci, createdat, kaydedenpersonel, kaydedenpersoneluid, miktar, "not", odeme, odemeyontemi, personel, personeluid, tarih, updatedat, yil')
          .eq('yil', yil)
          .order('createdat', { ascending: false });
        
        if (error) throw error;
        
        teberruKayitlari = (data || []).map(r => ({
          ...r,
          kayitTipi: 'teberru',
          personelUid: r.personeluid, // compatibility
          odemeYontemi: r.odemeyontemi || r.odeme
        }));
        
        // Realtime subscription
        const channel = window.supabase
          .channel(`teberru_kayitlari_${yil}`)
          .on('postgres_changes', {
            event: '*',
            schema: 'public',
            table: 'teberru_kayitlari',
            filter: `yil=eq.${yil}`
          }, async (payload) => {
            const { data: newData } = await window.supabase
              .from('teberru_kayitlari')
              .select('id, aciklama, ay, bagisci, createdat, kaydedenpersonel, kaydedenpersoneluid, miktar, "not", odeme, odemeyontemi, personel, personeluid, tarih, updatedat, yil')
              .eq('yil', yil)
              .order('createdat', { ascending: false });
            
            if (newData) {
              teberruKayitlari = newData.map(r => ({
                ...r,
                kayitTipi: 'teberru',
                personelUid: r.personeluid,
                odemeYontemi: r.odemeyontemi || r.odeme
              }));
              render();
            }
          })
          .subscribe();
        
        supabaseChannels.push(channel);
        render();
      } catch (e) {
        console.error('Teberru kayÄ±tlarÄ± yÃ¼klenemedi:', e);
        teberruKayitlari = [];
        render();
      }
    }

    // ===== SUPABASE: TaahhÃ¼t kayÄ±tlarÄ±nÄ± yÃ¼kle (Realtime) =====
    async function loadTaahhutKayitlari() {
      const yil = parseInt(qs('#filtreYil').value);
      if (!yil || !window.supabase) {
        taahhutKayitlari = [];
        render();
        return;
      }
      
      try {
        // Ã–nce mevcut verileri yÃ¼kle
        const { data, error } = await window.supabase
          .from('taahhut_kayitlari')
          .select('id, yil, ay, personel, personeluid, bagisci, miktar, aciklama, "not", durum, tarih, silindi, kaydedenpersonel, kaydedenpersoneluid, createdat, updatedat')
          .eq('yil', yil)
          .or('silindi.eq.false,silindi.is.null')
          .order('createdat', { ascending: false });
        
        if (error) throw error;
        
        taahhutKayitlari = (data || []).map(r => ({
          ...r,
          kayitTipi: 'taahhut',
          personelUid: r.personeluid // compatibility
        }));
        
        // Realtime subscription
        const channel = window.supabase
          .channel(`taahhut_kayitlari_${yil}`)
          .on('postgres_changes', {
            event: '*',
            schema: 'public',
            table: 'taahhut_kayitlari',
            filter: `yil=eq.${yil}`
          }, async (payload) => {
            const { data: newData } = await window.supabase
              .from('taahhut_kayitlari')
              .select('id, yil, ay, personel, personeluid, bagisci, miktar, aciklama, "not", durum, tarih, silindi, kaydedenpersonel, kaydedenpersoneluid, createdat, updatedat')
              .eq('yil', yil)
              .or('silindi.eq.false,silindi.is.null')
              .order('createdat', { ascending: false });
            
            if (newData) {
              taahhutKayitlari = newData.map(r => ({
                ...r,
                kayitTipi: 'taahhut',
                personelUid: r.personeluid
              }));
              render();
            }
          })
          .subscribe();
        
        supabaseChannels.push(channel);
        loadTahsilat();
      } catch (e) {
        console.error('TaahhÃ¼t kayÄ±tlarÄ± yÃ¼klenemedi:', e);
        taahhutKayitlari = [];
        render();
      }
    }

    // ===== Tahsilat verilerini yÃ¼kle (iftar/sahur/taahhÃ¼t iÃ§in) =====
    async function loadTahsilatForKayitIds(kayitIds) {
      if (!window.supabase || !kayitIds || kayitIds.length === 0) {
        return { byId: {}, listById: {} };
      }
      const { data, error } = await window.supabase
        .from('ramazan_tahsilat')
        .select('id, kayit_id, tutar, tahsilat_tarihi, odeme_tipi, taksit_no, aciklama, createdat')
        .in('kayit_id', kayitIds)
        .order('tahsilat_tarihi', { ascending: true });

      const byId = {};
      const listById = {};
      kayitIds.forEach(id => { byId[id] = 0; listById[id] = []; });
      if (error) throw error;
      if (data) {
        data.forEach(row => {
          const kid = row.kayit_id;
          const tutar = Number(row.tutar) || 0;
          byId[kid] = (byId[kid] || 0) + tutar;
          listById[kid] = listById[kid] || [];
          listById[kid].push({ id: row.id, tutar, tahsilat_tarihi: row.tahsilat_tarihi, odeme_tipi: row.odeme_tipi || 'pesin', taksit_no: row.taksit_no, aciklama: row.aciklama });
        });
      }
      return { byId, listById };
    }

    async function loadTahsilat() {
      const ids = [...(kayitlar || []).map(k => k.id), ...(taahhutKayitlari || []).map(k => k.id)];
      if (ids.length === 0) {
        tahsilatByKayitId = {};
        render();
        return;
      }
      try {
        const { byId } = await loadTahsilatForKayitIds(ids);
        tahsilatByKayitId = byId;
      } catch (e) {
        console.warn('Tahsilat yÃ¼klenemedi:', e);
        tahsilatByKayitId = {};
      }
      render();
    }

    // ===== SUPABASE: Silinen kayÄ±tlarÄ± yÃ¼kle =====
    async function loadSilinenKayitlar() {
      const yil = parseInt(qs('#filtreYil').value);
      if (!yil || !window.supabase) {
        silinenKayitlar = [];
        render();
        return;
      }
      
      try {
        // ramazan_arsiv tablosundan silinen kayÄ±tlarÄ± Ã§ek
        const { data, error } = await window.supabase
          .from('ramazan_arsiv')
          .select('id, yil, tip, sahip, tutar, istirak, musafiradedi, ay, mahalid, mahal, personel, personeladi, personeluid, kaydedenpersonel, kaydedenpersoneluid, notlar, createdat, updatedat, tarih, arsiv_tarihi, silme_sebebi, silen_kisi, silenpersoneluid, silenpersoneladi, orijinalid')
          .eq('yil', yil)
          .order('arsiv_tarihi', { ascending: false });
        
        if (error) throw error;
        
        silinenKayitlar = (data || []).map(r => {
          const mahalAdi = r.mahal || (r.mahalid && mahallerList.find(m => m.id === r.mahalid)?.adi) || '';
          return {
            ...r,
            mahal: mahalAdi,
            silindi: true,
            silinmeTarihi: r.arsiv_tarihi,
            musafirAdedi: r.musafiradedi, // compatibility
            personelUid: r.personeluid // compatibility
          };
        });
        
        render();
      } catch (e) {
        console.error('Silinen kayÄ±tlar yÃ¼klenemedi:', e);
        silinenKayitlar = [];
        render();
      }
    }

    // ===== SUPABASE: DÃ¼zenleme taleplerini yÃ¼kle (Realtime) =====
    async function loadDuzenlemeTalepleri() {
      const yil = parseInt(qs('#filtreYil').value);
      if (!yil || !window.supabase) {
        duzenlemeTalepleri = [];
        render();
        return;
      }
      
      try {
        // Ã–nce mevcut verileri yÃ¼kle
        const { data, error } = await window.supabase
          .from('duzenleme_talepleri')
          .select('id, yil, kayitid, kayittipi, taleptipi, aciklama, durum, personeladi, yenitarih, mahalid, onaylayanuid, onaylanmatarihi, rededenuid, redtarihi, redaciklama, createdat, updatedat')
          .eq('yil', String(yil))
          .order('createdat', { ascending: false });
        
        if (error) throw error;
        
        duzenlemeTalepleri = data || [];
        
        // Realtime subscription
        const channel = window.supabase
          .channel(`duzenleme_talepleri_${yil}`)
          .on('postgres_changes', {
            event: '*',
            schema: 'public',
            table: 'duzenleme_talepleri',
            filter: `yil=eq.${yil}`
          }, async (payload) => {
            const { data: newData } = await window.supabase
              .from('duzenleme_talepleri')
              .select('id, yil, kayitid, kayittipi, taleptipi, aciklama, durum, personeladi, yenitarih, mahalid, onaylayanuid, onaylanmatarihi, rededenuid, redtarihi, redaciklama, createdat, updatedat')
              .eq('yil', String(yil))
              .order('createdat', { ascending: false });
            
            if (newData) {
              duzenlemeTalepleri = newData;
              render();
            }
          })
          .subscribe();
        
        supabaseChannels.push(channel);
        render();
      } catch (e) {
        console.error('DÃ¼zenleme talepleri yÃ¼klenemedi:', e);
        duzenlemeTalepleri = [];
        render();
      }
    }

    // Render
    function render() {
      const yil = parseInt(qs('#filtreYil').value);
      const tip = qs('#filtreTip').value;
      const ara = qs('#ara').value.toLowerCase().trim();
      const mod = qs('#filtreMod').value;

      // Aktif ve silinen kayÄ±tlarÄ± birleÅŸtir + Teberru ve TaahhÃ¼t
      let allKayitlar = [...kayitlar, ...silinenKayitlar, ...teberruKayitlari, ...taahhutKayitlari];
      let filtered = [...allKayitlar];

      // YÄ±l filtresi (DB'de yil bazen string gelir; sayÄ±/string uyumlu kontrol)
      filtered = filtered.filter(k => Number(k.yil) === yil || k.yil == yil);

      // Tip filtresi (iftar/sahur iÃ§in, teberru/taahhut iÃ§in ayrÄ± kontrol)
      if (tip) {
        if(tip === 'teberru') {
          filtered = filtered.filter(k => k.kayitTipi === 'teberru');
        } else if(tip === 'taahhut') {
          filtered = filtered.filter(k => k.kayitTipi === 'taahhut');
        } else {
          filtered = filtered.filter(k => k.tip === tip && !k.kayitTipi);
        }
      }

      // KullanÄ±cÄ± bazlÄ± filtre
      if (mod === 'kendim' && currentUserUid) {
        filtered = filtered.filter(k => k.personelUid === currentUserUid);
      }

      // Arama filtresi
      if (ara) {
        filtered = filtered.filter(k =>
          (k.sahip || '').toLowerCase().includes(ara) ||
          (k.bagisci || '').toLowerCase().includes(ara) ||
          (k.personel || '').toLowerCase().includes(ara) ||
          (k.personelAdi || '').toLowerCase().includes(ara)
        );
      }

      // KPI gÃ¼ncelle (sadece aktif kayÄ±tlar - iftar-sahur, teberru, taahhÃ¼t dahil)
      const aktifKayitlar = filtered.filter(k => !k.silindi);
      const iftarSayisi = aktifKayitlar.filter(k => k.tip === 'iftar' && !k.kayitTipi).length;
      const sahurSayisi = aktifKayitlar.filter(k => k.tip === 'sahur' && !k.kayitTipi).length;
      const toplamTutar = aktifKayitlar.reduce((sum, k) => {
        if(k.kayitTipi === 'teberru' || k.kayitTipi === 'taahhut') {
          return sum + (Number(k.miktar) || 0);
        }
        return sum + (Number(k.tutar) || 0);
      }, 0);
      const toplamMusafir = aktifKayitlar.filter(k => !k.kayitTipi).reduce((sum, k) => sum + (Number(k.musafirAdedi) || 0), 0);
      const istirakSayisi = aktifKayitlar.filter(k => k.istirak && !k.kayitTipi).length;

      qs('#kpiIftar').textContent = iftarSayisi;
      qs('#kpiSahur').textContent = sahurSayisi;
      qs('#kpiTutar').textContent = 'â‚º' + toplamTutar.toLocaleString('tr-TR', { minimumFractionDigits: 2 });
      qs('#kpiMusafir').textContent = toplamMusafir;
      qs('#kpiIstirak').textContent = istirakSayisi;
      qs('#kpiToplam').textContent = aktifKayitlar.length;

      // DetaylÄ± Ä°statistikler
      const filteredTeberruKayitlari = aktifKayitlar.filter(k => k.kayitTipi === 'teberru');
      const filteredTaahhutKayitlari = aktifKayitlar.filter(k => k.kayitTipi === 'taahhut');
      
      // Teberru toplam ve Ã¶deme yÃ¶ntemlerine gÃ¶re daÄŸÄ±lÄ±m
      const teberruToplam = filteredTeberruKayitlari.reduce((sum, k) => sum + (Number(k.miktar) || 0), 0);
      const teberruNakit = filteredTeberruKayitlari
        .filter(k => (k.odemeYontemi || k.odeme || '').toLowerCase() === 'nakit')
        .reduce((sum, k) => sum + (Number(k.miktar) || 0), 0);
      const teberruBanka = filteredTeberruKayitlari
        .filter(k => (k.odemeYontemi || k.odeme || '').toLowerCase() === 'banka')
        .reduce((sum, k) => sum + (Number(k.miktar) || 0), 0);
      const teberruPos = filteredTeberruKayitlari
        .filter(k => (k.odemeYontemi || k.odeme || '').toLowerCase() === 'pos')
        .reduce((sum, k) => sum + (Number(k.miktar) || 0), 0);
      const teberruSanal = filteredTeberruKayitlari
        .filter(k => (k.odemeYontemi || k.odeme || '').toLowerCase() === 'sanal')
        .reduce((sum, k) => sum + (Number(k.miktar) || 0), 0);
      
      // TaahhÃ¼t: adet, toplam tutar, tahsilat, kalan
      const taahhutAdet = filteredTaahhutKayitlari.length;
      const taahhutToplam = filteredTaahhutKayitlari.reduce((sum, k) => sum + (Number(k.miktar) || 0), 0);
      const taahhutTahsilat = filteredTaahhutKayitlari.reduce((sum, k) => sum + (tahsilatByKayitId[k.id] || 0), 0);
      const taahhutKalan = taahhutToplam - taahhutTahsilat;
      // Ä°ftar: adet, toplam tutar, tahsilat, kalan (sadece iftar kayÄ±tlarÄ±, teberru/taahhut deÄŸil)
      const iftarKayitlari = aktifKayitlar.filter(k => k.tip === 'iftar' && !k.kayitTipi);
      const iftarAdet = iftarKayitlari.length;
      const iftarToplam = iftarKayitlari.reduce((sum, k) => sum + (Number(k.tutar) || 0), 0);
      const iftarTahsilat = iftarKayitlari.reduce((sum, k) => sum + (tahsilatByKayitId[k.id] || 0), 0);
      const iftarKalan = iftarToplam - iftarTahsilat;
      // Sahur: adet, toplam tutar, tahsilat, kalan
      const sahurKayitlari = aktifKayitlar.filter(k => k.tip === 'sahur' && !k.kayitTipi);
      const sahurAdet = sahurKayitlari.length;
      const sahurToplam = sahurKayitlari.reduce((sum, k) => sum + (Number(k.tutar) || 0), 0);
      const sahurTahsilat = sahurKayitlari.reduce((sum, k) => sum + (tahsilatByKayitId[k.id] || 0), 0);
      const sahurKalan = sahurToplam - sahurTahsilat;

      // Ä°statistikleri gÃ¶ster
      qs('#statTeberruToplam').textContent = 'â‚º' + teberruToplam.toLocaleString('tr-TR', { minimumFractionDigits: 2 });
      qs('#statTeberruNakit').textContent = 'nakit: â‚º' + teberruNakit.toLocaleString('tr-TR', { minimumFractionDigits: 2 });
      qs('#statTeberruBanka').textContent = 'banka: â‚º' + teberruBanka.toLocaleString('tr-TR', { minimumFractionDigits: 2 });
      qs('#statTeberruPos').textContent = 'pos: â‚º' + teberruPos.toLocaleString('tr-TR', { minimumFractionDigits: 2 });
      qs('#statTeberruSanal').textContent = 'sanal: â‚º' + teberruSanal.toLocaleString('tr-TR', { minimumFractionDigits: 2 });
      qs('#statTaahhutAdet').textContent = taahhutAdet;
      qs('#statTaahhutToplam').textContent = 'â‚º' + taahhutToplam.toLocaleString('tr-TR', { minimumFractionDigits: 2 });
      qs('#statTaahhutTahsilat').textContent = 'â‚º' + taahhutTahsilat.toLocaleString('tr-TR', { minimumFractionDigits: 2 });
      qs('#statTaahhutKalan').textContent = 'â‚º' + taahhutKalan.toLocaleString('tr-TR', { minimumFractionDigits: 2 });
      qs('#statIftarAdet').textContent = iftarAdet;
      qs('#statIftarToplam').textContent = 'â‚º' + iftarToplam.toLocaleString('tr-TR', { minimumFractionDigits: 2 });
      qs('#statIftarTahsilat').textContent = 'â‚º' + iftarTahsilat.toLocaleString('tr-TR', { minimumFractionDigits: 2 });
      qs('#statIftarKalan').textContent = 'â‚º' + iftarKalan.toLocaleString('tr-TR', { minimumFractionDigits: 2 });
      qs('#statSahurAdet').textContent = sahurAdet;
      qs('#statSahurToplam').textContent = 'â‚º' + sahurToplam.toLocaleString('tr-TR', { minimumFractionDigits: 2 });
      qs('#statSahurTahsilat').textContent = 'â‚º' + sahurTahsilat.toLocaleString('tr-TR', { minimumFractionDigits: 2 });
      qs('#statSahurKalan').textContent = 'â‚º' + sahurKalan.toLocaleString('tr-TR', { minimumFractionDigits: 2 });

      // Tablo render (kart gÃ¶rÃ¼nÃ¼mÃ¼ kaldÄ±rÄ±ldÄ±)
      const tbody = qs('#tbody');
      tbody.innerHTML = '';

      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="11" style="text-align:center;color:var(--muted);padding:20px">KayÄ±t bulunamadÄ±</td></tr>';
        qs('#sumTutar').textContent = 'â‚º0';
        qs('#sumMusafir').textContent = '0';
        return;
      }

        filtered.forEach(k => {
          const tr = document.createElement('tr');
          
          // Teberru veya TaahhÃ¼t kaydÄ± mÄ± kontrol et
          if(k.kayitTipi === 'teberru' || k.kayitTipi === 'taahhut') {
            // Teberru/TaahhÃ¼t kayÄ±tlarÄ± iÃ§in Ã¶zel render
            // Supabase timestamp kontrolÃ¼
            let tarihStr = '';
            if(k.tarih) {
              if(k.tarih instanceof Date) {
                tarihStr = k.tarih.toISOString().slice(0, 10);
              } else if(typeof k.tarih === 'string') {
                tarihStr = k.tarih.slice(0, 10);
              }
            } else if(k.createdat) {
              // Supabase createdat field
              if(typeof k.createdat === 'string') {
                tarihStr = k.createdat.slice(0, 10);
              } else if(k.createdat instanceof Date) {
                tarihStr = k.createdat.toISOString().slice(0, 10);
              }
            } else if(k.createdAt) {
              // Firestore Timestamp (eski veriler iÃ§in)
              if(k.createdAt.toDate) {
                tarihStr = k.createdAt.toDate().toISOString().slice(0, 10);
              } else if(k.createdAt.seconds) {
                tarihStr = new Date(k.createdAt.seconds * 1000).toISOString().slice(0, 10);
              }
            }
            const tarih = tarihStr ? new Date(tarihStr) : new Date();
            const odemeLabels = {
              'nakit': 'ğŸ’µ Nakit',
              'banka': 'ğŸ¦ Banka',
              'pos': 'ğŸ’³ POS',
              'sanal': 'ğŸ“± Sanal'
            };

            // Durum kontrolÃ¼ - ZenginleÅŸtirilmiÅŸ
            let durumHtml = '';
            let durumParts = [];
            
            durumParts.push(`<span style="color:var(--good); font-weight:600;">âœ“ Aktif</span>`);
            
            // DÃ¼zenleme talebi kontrolÃ¼
            const talep = duzenlemeTalepleri.find(t => String(t.kayitid) === String(k.id) && (t.kayittipi === 'teberru' || t.kayittipi === 'taahhut'));
            if(talep) {
              // Supabase timestamp
              let talepTarih = null;
              if(talep.createdat) {
                talepTarih = typeof talep.createdat === 'string' ? new Date(talep.createdat) : (talep.createdat instanceof Date ? talep.createdat : null);
              } else if(talep.createdAt) {
                // Firestore Timestamp (eski veriler iÃ§in)
                talepTarih = talep.createdAt.toDate ? talep.createdAt.toDate() : new Date(talep.createdAt.seconds * 1000);
              }
              const talepTarihStr = talepTarih ? talepTarih.toLocaleDateString('tr-TR') + ' ' + talepTarih.toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'}) : '';
              
              let talepIcon = 'ğŸ“‹';
              let talepRenk = '#17a2b8';
              let talepText = 'DÃ¼zenleme Talebi';
              
              if(talep.talepTipi === 'duzenle') {
                talepIcon = 'âœï¸';
                talepText = 'DÃ¼zenleme Talebi';
              }
              
              if(talep.durum === 'onaylandi') {
                talepRenk = '#28a745';
                talepText = 'âœ… ' + talepText.replace('Talebi', 'OnaylandÄ±');
              } else if(talep.durum === 'reddedildi') {
                talepRenk = '#dc3545';
                talepText = 'âŒ ' + talepText.replace('Talebi', 'Reddedildi');
              }
              
              durumParts.push(`<div style="margin-top:4px; padding:4px 6px; background:${talepRenk}15; border-left:3px solid ${talepRenk}; border-radius:4px; font-size:10px; color:${talepRenk}; font-weight:600;">${talepIcon} ${talepText}</div>`);
              if(talepTarihStr) {
                durumParts.push(`<small style="color:var(--muted); font-size:8px; display:block; margin-top:2px;">${talepTarihStr}</small>`);
              }
              if(talep.aciklama) {
                durumParts.push(`<small style="color:var(--muted); font-size:8px; display:block; margin-top:2px; font-style:italic; max-width:150px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${talep.aciklama}">"${talep.aciklama}"</small>`);
              }
            }
            
              // GÃ¼ncelleme kontrolÃ¼ (Supabase)
              if(k.updatedat && k.createdat) {
                const createdTime = k.createdat instanceof Date ? k.createdat.getTime() : (typeof k.createdat === 'string' ? new Date(k.createdat).getTime() : 0);
                const updatedTime = k.updatedat instanceof Date ? k.updatedat.getTime() : (typeof k.updatedat === 'string' ? new Date(k.updatedat).getTime() : 0);
                if(updatedTime > createdTime + 1000) { // 1 saniye tolerans
                  const updateDate = k.updatedat instanceof Date ? k.updatedat : new Date(k.updatedat);
                  const updateDateStr = updateDate.toLocaleDateString('tr-TR') + ' ' + updateDate.toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'});
                  durumParts.push(`<div style="margin-top:4px; padding:4px 6px; background:#fff3cd20; border-left:3px solid var(--warn); border-radius:4px; font-size:10px; color:var(--warn); font-weight:600;">âš ï¸ DeÄŸiÅŸtirildi</div>`);
                  durumParts.push(`<small style="color:var(--muted); font-size:8px; display:block; margin-top:2px;">${updateDateStr}</small>`);
                }
              } else if(k.updatedAt && k.createdAt) {
                // Firestore Timestamp (eski veriler iÃ§in)
                const createdTime = k.createdAt.toDate ? k.createdAt.toDate().getTime() : (k.createdAt.seconds || 0) * 1000;
                const updatedTime = k.updatedAt.toDate ? k.updatedAt.toDate().getTime() : (k.updatedAt.seconds || 0) * 1000;
                if(updatedTime > createdTime + 1000) {
                  const updateDate = k.updatedAt.toDate ? k.updatedAt.toDate() : new Date(updatedTime);
                  const updateDateStr = updateDate.toLocaleDateString('tr-TR') + ' ' + updateDate.toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'});
                  durumParts.push(`<div style="margin-top:4px; padding:4px 6px; background:#fff3cd20; border-left:3px solid var(--warn); border-radius:4px; font-size:10px; color:var(--warn); font-weight:600;">âš ï¸ DeÄŸiÅŸtirildi</div>`);
                  durumParts.push(`<small style="color:var(--muted); font-size:8px; display:block; margin-top:2px;">${updateDateStr}</small>`);
                }
              }
              
              // OluÅŸturulma tarihi (Supabase)
              if(k.createdat) {
                const createdDate = k.createdat instanceof Date ? k.createdat : new Date(k.createdat);
                const createdDateStr = createdDate.toLocaleDateString('tr-TR') + ' ' + createdDate.toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'});
                durumParts.push(`<small style="color:var(--muted); font-size:8px; display:block; margin-top:4px; border-top:1px solid var(--border); padding-top:4px;">OluÅŸturulma: ${createdDateStr}</small>`);
              } else if(k.createdAt) {
                // Firestore Timestamp (eski veriler iÃ§in)
                const createdDate = k.createdAt.toDate ? k.createdAt.toDate() : new Date(k.createdAt.seconds * 1000);
                const createdDateStr = createdDate.toLocaleDateString('tr-TR') + ' ' + createdDate.toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'});
                durumParts.push(`<small style="color:var(--muted); font-size:8px; display:block; margin-top:4px; border-top:1px solid var(--border); padding-top:4px;">OluÅŸturulma: ${createdDateStr}</small>`);
              }
            
            durumHtml = durumParts.join('');
            
            // Tahsilat Ã¶zeti (sadece taahhÃ¼t iÃ§in; teberru iÃ§in "-")
            const hasTahsilatTaahhut = (k.kayitTipi === 'taahhut') && Number(k.miktar || 0) > 0;
            const toplamTahsilatT = hasTahsilatTaahhut ? (tahsilatByKayitId[k.id] || 0) : 0;
            const kayitTutariT = Number(k.miktar || 0);
            const kalanT = kayitTutariT - toplamTahsilatT;
            let tahsilatDurumT = '-';
            if (hasTahsilatTaahhut) {
              if (toplamTahsilatT >= kayitTutariT) tahsilatDurumT = 'Ã–dendi';
              else if (toplamTahsilatT > 0) tahsilatDurumT = `â‚º${toplamTahsilatT.toLocaleString('tr-TR', { minimumFractionDigits: 2 })} / â‚º${kalanT.toLocaleString('tr-TR', { minimumFractionDigits: 2 })} kalan`;
              else tahsilatDurumT = 'Beklemede';
            }
            tr.innerHTML = `
              <td>${tarih.getDate()}.${tarih.getMonth() + 1}.${tarih.getFullYear()}</td>
              <td><span class="chip-badge" style="background:${k.kayitTipi === 'teberru' ? '#27ae60' : '#3498db'}; color:white; padding:4px 8px; border-radius:4px; font-size:11px;">${k.kayitTipi === 'teberru' ? 'ğŸ’° Teberru' : 'ğŸ“‹ TaahhÃ¼t'}</span></td>
              <td class="td-scroll-text" title="${(k.bagisci || '-').replace(/"/g, '&quot;')}"><strong>${k.bagisci || '-'}</strong></td>
              <td class="right"><strong>â‚º${Number(k.miktar || 0).toLocaleString('tr-TR',{minimumFractionDigits:2})}</strong></td>
              <td style="font-size:12px">${tahsilatDurumT}</td>
              <td>-</td>
              <td>-</td>
              <td>${k.kayitTipi === 'teberru' ? (odemeLabels[k.odemeYontemi] || k.odemeYontemi || '-') : '-'}</td>
              <td class="td-scroll-text" title="${(k.personelAdi || k.kaydedenpersonel || k.personel || '-').replace(/"/g, '&quot;')}">${k.personelAdi || k.kaydedenpersonel || k.kaydedenPersonel || k.personel || '-'}</td>
              <td class="td-scroll-text" title="${(k.aciklama || k.not || '').replace(/"/g, '&quot;')}">${k.aciklama || k.not || '-'}</td>
              <td>${durumHtml}</td>
            `;
            tbody.appendChild(tr);
          } else {
            // Ä°ftar-Sahur kayÄ±tlarÄ± iÃ§in mevcut render
            // Supabase timestamp kontrolÃ¼ (string veya Date)
            let tarihStr = '';
            if(k.tarih) {
              if(k.tarih instanceof Date) {
                tarihStr = k.tarih.toISOString().slice(0, 10);
              } else if(typeof k.tarih === 'string') {
                tarihStr = k.tarih.slice(0, 10);
              } else if(k.tarih.toDate) {
                // Firestore Timestamp (eski veriler iÃ§in)
                tarihStr = k.tarih.toDate().toISOString().slice(0, 10);
              } else if(k.tarih.seconds) {
                // Firestore Timestamp objesi (eski veriler iÃ§in)
                tarihStr = new Date(k.tarih.seconds * 1000).toISOString().slice(0, 10);
              }
            }
            const tarih = tarihStr ? new Date(tarihStr) : new Date();

            // Durum kontrolÃ¼ - ZenginleÅŸtirilmiÅŸ
            let durumHtml = '';
            let durumParts = [];
            
            if(k.silindi) {
              let silTarihStr = '';
              if(k.silinmeTarihi) {
                // Supabase timestamp veya Firestore Timestamp
                let silTarih = null;
                if(k.silinmeTarihi instanceof Date) {
                  silTarih = k.silinmeTarihi;
                } else if(typeof k.silinmeTarihi === 'string') {
                  silTarih = new Date(k.silinmeTarihi);
                } else if(k.silinmeTarihi.toDate) {
                  silTarih = k.silinmeTarihi.toDate();
                } else if(k.silinmeTarihi.seconds) {
                  silTarih = new Date(k.silinmeTarihi.seconds * 1000);
                }
                if(silTarih) {
                  silTarihStr = silTarih.toLocaleDateString('tr-TR') + ' ' + silTarih.toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'});
                }
              }
              durumParts.push(`<span style="color:var(--bad); font-weight:700; font-size:13px;">âŒ Silindi</span>`);
              durumParts.push(`<small style="color:var(--muted); font-size:10px; display:block; margin-top:2px;">Silen: ${k.silenpersoneladi || k.silenPersonelAdi || 'Bilinmiyor'}</small>`);
              if(silTarihStr) {
                durumParts.push(`<small style="color:var(--muted); font-size:9px; display:block;">${silTarihStr}</small>`);
              }
              if(k.silmeaciklama || k.silmeAciklama) {
                durumParts.push(`<small style="color:var(--muted); font-size:9px; display:block; margin-top:2px; font-style:italic;">"${k.silmeaciklama || k.silmeAciklama}"</small>`);
              }
            } else {
              // Aktif kayÄ±t - detaylÄ± durum bilgisi
              durumParts.push(`<span style="color:var(--good); font-weight:600;">âœ“ Aktif</span>`);
              
              // DÃ¼zenleme talebi kontrolÃ¼
              const talep = duzenlemeTalepleri.find(t => String(t.kayitid) === String(k.id) && (t.kayittipi === 'iftar-sahur' || t.kayittipi === 'ramazan'));
              if(talep) {
                // Supabase timestamp (string veya Date)
                let talepTarih = null;
                if(talep.createdat) {
                  if(typeof talep.createdat === 'string') {
                    talepTarih = new Date(talep.createdat);
                  } else if(talep.createdat instanceof Date) {
                    talepTarih = talep.createdat;
                  }
                } else if(talep.createdAt) {
                  // Firestore Timestamp (eski veriler iÃ§in)
                  talepTarih = talep.createdAt.toDate ? talep.createdAt.toDate() : new Date(talep.createdAt.seconds * 1000);
                }
                const talepTarihStr = talepTarih ? talepTarih.toLocaleDateString('tr-TR') + ' ' + talepTarih.toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'}) : '';
                
                let talepIcon = 'ğŸ“‹';
                let talepRenk = '#17a2b8';
                let talepText = 'DÃ¼zenleme Talebi';
                
                if(talep.talepTipi === 'yer_degistir') {
                  talepIcon = 'ğŸ”„';
                  talepText = 'Yer DeÄŸiÅŸtirme Talebi';
                  if(talep.yeniTarih && talep.eskiTarih) {
                    const eskiTarih = new Date(talep.eskiTarih);
                    const yeniTarih = new Date(talep.yeniTarih);
                    talepText += `<br><small style="font-size:9px;">${eskiTarih.getDate()}.${eskiTarih.getMonth()+1} â†’ ${yeniTarih.getDate()}.${yeniTarih.getMonth()+1}</small>`;
                  }
                } else if(talep.talepTipi === 'duzenle') {
                  talepIcon = 'âœï¸';
                  talepText = 'DÃ¼zenleme Talebi';
                }
                
                if(talep.durum === 'onaylandi') {
                  talepRenk = '#28a745';
                  talepText = 'âœ… ' + talepText.replace('Talebi', 'OnaylandÄ±');
                } else if(talep.durum === 'reddedildi') {
                  talepRenk = '#dc3545';
                  talepText = 'âŒ ' + talepText.replace('Talebi', 'Reddedildi');
                }
                
                durumParts.push(`<div style="margin-top:4px; padding:4px 6px; background:${talepRenk}15; border-left:3px solid ${talepRenk}; border-radius:4px; font-size:10px; color:${talepRenk}; font-weight:600;">${talepIcon} ${talepText}</div>`);
                if(talepTarihStr) {
                  durumParts.push(`<small style="color:var(--muted); font-size:8px; display:block; margin-top:2px;">${talepTarihStr}</small>`);
                }
                if(talep.aciklama) {
                  durumParts.push(`<small style="color:var(--muted); font-size:8px; display:block; margin-top:2px; font-style:italic; max-width:150px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${talep.aciklama}">"${talep.aciklama}"</small>`);
                }
              }
              
              // GÃ¼ncelleme kontrolÃ¼ (Supabase veya Firestore)
              if(k.updatedat && k.createdat) {
                const createdTime = k.createdat instanceof Date ? k.createdat.getTime() : (typeof k.createdat === 'string' ? new Date(k.createdat).getTime() : 0);
                const updatedTime = k.updatedat instanceof Date ? k.updatedat.getTime() : (typeof k.updatedat === 'string' ? new Date(k.updatedat).getTime() : 0);
                if(updatedTime > createdTime + 1000) {
                  const updateDate = k.updatedat instanceof Date ? k.updatedat : new Date(k.updatedat);
                  const updateDateStr = updateDate.toLocaleDateString('tr-TR') + ' ' + updateDate.toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'});
                  durumParts.push(`<div style="margin-top:4px; padding:4px 6px; background:#fff3cd20; border-left:3px solid var(--warn); border-radius:4px; font-size:10px; color:var(--warn); font-weight:600;">âš ï¸ DeÄŸiÅŸtirildi</div>`);
                  durumParts.push(`<small style="color:var(--muted); font-size:8px; display:block; margin-top:2px;">${updateDateStr}</small>`);
                }
              } else if(k.updatedAt && k.createdAt) {
                const createdTime = k.createdAt.toDate ? k.createdAt.toDate().getTime() : (k.createdAt.seconds || 0) * 1000;
                const updatedTime = k.updatedAt.toDate ? k.updatedAt.toDate().getTime() : (k.updatedAt.seconds || 0) * 1000;
                if(updatedTime > createdTime) {
                  const updateDate = k.updatedAt.toDate ? k.updatedAt.toDate() : new Date(updatedTime);
                  const updateDateStr = updateDate.toLocaleDateString('tr-TR') + ' ' + updateDate.toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'});
                  durumParts.push(`<div style="margin-top:4px; padding:4px 6px; background:#fff3cd20; border-left:3px solid var(--warn); border-radius:4px; font-size:10px; color:var(--warn); font-weight:600;">âš ï¸ DeÄŸiÅŸtirildi</div>`);
                  durumParts.push(`<small style="color:var(--muted); font-size:8px; display:block; margin-top:2px;">${updateDateStr}</small>`);
                  
                  if(k.degisiklikGecmisi && Array.isArray(k.degisiklikGecmisi) && k.degisiklikGecmisi.length > 0) {
                    const sonDegisiklik = k.degisiklikGecmisi[k.degisiklikGecmisi.length - 1];
                    if(sonDegisiklik.degisenAlanlar && sonDegisiklik.degisenAlanlar.length > 0) {
                      durumParts.push(`<small style="color:var(--muted); font-size:8px; display:block; margin-top:2px;">DeÄŸiÅŸen: ${sonDegisiklik.degisenAlanlar.join(', ')}</small>`);
                    }
                  }
                }
              }
              
              // OluÅŸturulma tarihi (Supabase createdat veya Firestore createdAt - teberru gibi)
              if(k.createdat) {
                const createdDate = k.createdat instanceof Date ? k.createdat : new Date(k.createdat);
                const createdDateStr = createdDate.toLocaleDateString('tr-TR') + ' ' + createdDate.toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'});
                durumParts.push(`<small style="color:var(--muted); font-size:8px; display:block; margin-top:4px; border-top:1px solid var(--border); padding-top:4px;">OluÅŸturulma: ${createdDateStr}</small>`);
              } else if(k.createdAt) {
                const createdDate = k.createdAt.toDate ? k.createdAt.toDate() : new Date(k.createdAt.seconds * 1000);
                const createdDateStr = createdDate.toLocaleDateString('tr-TR') + ' ' + createdDate.toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'});
                durumParts.push(`<small style="color:var(--muted); font-size:8px; display:block; margin-top:4px; border-top:1px solid var(--border); padding-top:4px;">OluÅŸturulma: ${createdDateStr}</small>`);
              }
            }
            
            durumHtml = durumParts.join('');
            
            // Tahsilat Ã¶zeti (iftar/sahur iÃ§in)
            const hasTahsilatIftar = (k.tip === 'iftar' || k.tip === 'sahur') && Number(k.tutar || 0) > 0;
            const toplamTahsilatI = hasTahsilatIftar ? (tahsilatByKayitId[k.id] || 0) : 0;
            const kayitTutariI = Number(k.tutar || 0);
            const kalanI = kayitTutariI - toplamTahsilatI;
            let tahsilatDurumI = '-';
            if (hasTahsilatIftar) {
              if (toplamTahsilatI >= kayitTutariI) tahsilatDurumI = 'Ã–dendi';
              else if (toplamTahsilatI > 0) tahsilatDurumI = `â‚º${toplamTahsilatI.toLocaleString('tr-TR', { minimumFractionDigits: 2 })} / â‚º${kalanI.toLocaleString('tr-TR', { minimumFractionDigits: 2 })} kalan`;
              else tahsilatDurumI = 'Beklemede';
            }
            tr.innerHTML = `
              <td>${tarih.getDate()}.${tarih.getMonth() + 1}.${tarih.getFullYear()}</td>
              <td><span class="chip-badge ${k.tip}">${k.tip === 'iftar' ? 'ğŸŒ™ Ä°ftar' : 'ğŸŒŸ Sahur'}</span></td>
              <td class="td-scroll-text" title="${(k.sahip || '-').replace(/"/g, '&quot;')}"><strong>${k.sahip || '-'}</strong></td>
              <td class="right"><strong>â‚º${Number(k.tutar || 0).toLocaleString('tr-TR',{minimumFractionDigits:2})}</strong></td>
              <td style="font-size:12px">${tahsilatDurumI}</td>
              <td>${k.istirak ? 'âœ“ Evet' : 'âœ— HayÄ±r'}</td>
              <td>${k.musafirAdedi || 0}</td>
              <td class="td-scroll-text td-scroll-narrow" title="${(k.mahal || '-').replace(/"/g, '&quot;')}">${k.mahal || '-'}</td>
              <td class="td-scroll-text" title="${(k.personelAdi || k.personeladi || k.kaydedenpersonel || '-').replace(/"/g, '&quot;')}">${k.personelAdi || k.personeladi || k.kaydedenpersonel || k.kaydedenPersonel || '-'}</td>
              <td class="td-scroll-text" title="${(k.notlar || k.not || '').replace(/"/g, '&quot;')}">${k.notlar || k.not || '-'}</td>
              <td>${durumHtml}</td>
            `;
            tbody.appendChild(tr);
          }
        });

        // Toplam hesaplama (sadece aktif kayÄ±tlar - iftar-sahur, teberru, taahhÃ¼t dahil)
        const aktifToplamTutar = filtered.filter(k => !k.silindi).reduce((sum, k) => {
          if(k.kayitTipi === 'teberru' || k.kayitTipi === 'taahhut') {
            return sum + (Number(k.miktar) || 0);
          }
          return sum + (Number(k.tutar) || 0);
        }, 0);
        const aktifToplamMusafir = filtered.filter(k => !k.silindi && !k.kayitTipi).reduce((sum, k) => sum + (Number(k.musafirAdedi) || 0), 0);
        qs('#sumTutar').innerHTML = '<strong>â‚º' + aktifToplamTutar.toLocaleString('tr-TR',{minimumFractionDigits:2}) + '</strong>';
        qs('#sumMusafir').innerHTML = '<strong>' + aktifToplamMusafir + '</strong>';
    }

    // Sadece tablo gÃ¶rÃ¼nÃ¼mÃ¼ - kart gÃ¶rÃ¼nÃ¼mÃ¼ kaldÄ±rÄ±ldÄ±
    function toggleView() {
      qs('#tableWrap').style.display = 'block';
      qs('#cardList').style.display = 'none';
      render();
    }

    // Filtre deÄŸiÅŸiklikleri
    // Ramazan yÄ±llarÄ±nÄ± yÃ¼kle ve yÄ±l seÃ§eneklerini gÃ¼ncelle
    // ===== SUPABASE: Ramazan yÄ±llarÄ±nÄ± yÃ¼kle =====
    async function loadRamazanYillari() {
      if (!window.supabase) {
        console.warn('Supabase client hazÄ±r deÄŸil, ramazan yÄ±llarÄ± yÃ¼klenemiyor');
        return;
      }
      
      try {
        const { data, error } = await window.supabase
          .from('ramazan_yillar')
          .select('id, yil, aktif, baslangic, bitis, createdat, hicriyil, updatedat')
          .order('yil', { ascending: false });
        
        if (error) throw error;
        
        // Filtre yÄ±l seÃ§eneklerini gÃ¼ncelle
        const select = qs('#filtreYil');
        if (select) {
          const currentValue = select.value;
          select.innerHTML = '';
          
          (data || []).forEach(d => {
            const opt = document.createElement('option');
            opt.value = d.yil;
            opt.textContent = `${d.yil} Ramazan-Ä± Åerif${d.aktif ? ' (Aktif)' : ''}`;
            select.appendChild(opt);
            
            // Aktif yÄ±l varsa onu seÃ§
            if (d.aktif) {
              select.value = d.yil;
            }
          });
          
          // EÄŸer aktif yÄ±l seÃ§ilmediyse, mevcut deÄŸeri koru veya ilk yÄ±lÄ± seÃ§
          if (!select.value && currentValue && data.some(d => d.yil === parseInt(currentValue))) {
            select.value = currentValue;
          } else if (!select.value && data.length > 0) {
            select.value = data[0].yil;
          }
          
          // YÄ±l seÃ§ildikten sonra ilk verileri yÃ¼kle
          if (select.value) {
            loadKayitlar();
          }
        }
      } catch (e) {
        console.error('Ramazan yÄ±llarÄ± yÃ¼klenemedi:', e);
      }
    }

    // YÄ±l deÄŸiÅŸtiÄŸinde Ã¶nceki channel'larÄ± temizle ve yeni verileri yÃ¼kle
    qs('#filtreYil').addEventListener('change', () => {
      // Ã–nceki Supabase channel'larÄ± unsubscribe et
      supabaseChannels.forEach(ch => {
        window.supabase.removeChannel(ch);
      });
      supabaseChannels = [];
      
      // Yeni verileri yÃ¼kle
      loadKayitlar();
    });
    
    ['#filtreTip', '#filtreMod'].forEach(sel => {
      qs(sel).addEventListener('change', () => {
        render();
      });
    });

    qs('#ara').addEventListener('input', render);

    // CSV Export
    qs('#btnExport').addEventListener('click', () => {
      const yil = qs('#filtreYil').value;
      const tip = qs('#filtreTip').value;
      const ara = qs('#ara').value.toLowerCase().trim();
      const mod = qs('#filtreMod').value;

      let filtered = [...kayitlar];
      filtered = filtered.filter(k => k.yil === parseInt(yil));
      if (tip) filtered = filtered.filter(k => k.tip === tip);
      if (mod === 'kendim' && currentUserUid) filtered = filtered.filter(k => k.personelUid === currentUserUid);
      if (ara) {
        filtered = filtered.filter(k =>
          (k.sahip || '').toLowerCase().includes(ara) ||
          (k.personel || '').toLowerCase().includes(ara)
        );
      }

      const rows = [['Tarih', 'Tip', 'Sahip', 'Tutar', 'Ä°ÅŸtirak', 'MÃ¼safirAdedi', 'Personel']];

      filtered.forEach(k => {
        const tarihStr = k.tarih instanceof Date ? k.tarih.toISOString().slice(0, 10) : k.tarih;
        rows.push([
          tarihStr,
          k.tip || '',
          k.sahip || '',
          k.tutar || 0,
          k.istirak ? 'Evet' : 'HayÄ±r',
          k.musafirAdedi || 0,
          k.personel || ''
        ]);
      });

      const csv = rows.map(r => r.map(cell => {
        const str = String(cell);
        return str.includes(',') || str.includes('"') || str.includes('\n')
          ? `"${str.replace(/"/g, '""')}"`
          : str;
      }).join(',')).join('\n');

      const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `iftar-sahur-rapor-${yil}-ramazan-serif.csv`;
      link.click();
    });

    // TÃ¼m Personel Raporu butonu (popup engelini Ã¶nlemek iÃ§in pencere tÄ±klama anÄ±nda aÃ§Ä±lÄ±r)
    qs('#btnTumPersonelRapor').addEventListener('click', async () => {
      const reportWindow = window.open('', '_blank');
      if (!reportWindow) {
        alert('Pencere aÃ§Ä±lamadÄ±. LÃ¼tfen aÃ§Ä±lÄ±r pencerelere izin verin ve tekrar deneyin.');
        return;
      }
      try {
        // Ã–nce detaylÄ± rapor bÃ¶lÃ¼mÃ¼nÃ¼ aÃ§
        const section = qs('#detayliRaporSection');
        if (section.style.display === 'none') {
          section.style.display = 'block';
          section.scrollIntoView({ behavior: 'smooth' });
        }
        
        // Verileri yÃ¼kle
        await loadAllYearsData();
        
        // Analiz yap
        if (!analizData) {
          analizData = analizPersonelVerileri();
        }
        
        // Veri kontrolÃ¼: yoksa pencereyi rapor sayfasÄ±na yÃ¶nlendir (about:blank kalmasÄ±n)
        if (!analizData || !analizData.personeller || Object.keys(analizData.personeller).length === 0) {
          const errMsg = 'Personel verisi bulunamadÄ±. ramazan_veriler tablosunda veri yok veya personel alanÄ± boÅŸ.';
          reportWindow.location.href = `ramazan-tum-personel-yazdir.html?error=${encodeURIComponent(errMsg)}`;
          alert(errMsg);
          return;
        }
        
        // TÃ¼m personeller iÃ§in rapor verisi hazÄ±rla
        const tumPersonelRaporData = {
          personeller: {},
          toplamlar: {
            2023: 0,
            2024: 0,
            2025: 0
          },
          genelBagisciAnaliz: {
            daimi: [],
            yeni: [],
            pasif: []
          }
        };
        
        // Her personel iÃ§in veri hazÄ±rla
        Object.keys(analizData.personeller).forEach(personelAdi => {
          const personel = analizData.personeller[personelAdi];
          const bagisciAnaliz = analizBagisciPersonel(analizData.bagiscilar, personelAdi);
          
          // Personel verilerini hazÄ±rla
          tumPersonelRaporData.personeller[personelAdi] = {
            adi: personel.adi,
            yillar: Array.from(personel.yillar).sort(),
            veriler: {},
            bagisciAnaliz: {
              daimi: bagisciAnaliz.daimi || [],
              yeni: bagisciAnaliz.yeni || [],
              pasif: bagisciAnaliz.pasif || []
            }
          };
          
          // Veriler objesini serialize edilebilir hale getir
          Object.keys(personel.veriler).forEach(yilStr => {
            const yil = parseInt(yilStr);
            tumPersonelRaporData.personeller[personelAdi].veriler[yil] = {
              iftar: (personel.veriler[yil].iftar || []).map(v => ({
                sahip: v.sahip || '',
                tutar: Number(v.tutar) || 0,
                tarih: v.tarih || null,
                referans: v.referans || '',
                diger: v.diger || ''
              })),
              sahur: (personel.veriler[yil].sahur || []).map(v => ({
                sahip: v.sahip || '',
                tutar: Number(v.tutar) || 0,
                tarih: v.tarih || null,
                referans: v.referans || '',
                diger: v.diger || ''
              })),
              taahhut: (personel.veriler[yil].taahhut || []).map(v => ({
                sahip: v.sahip || '',
                tutar: Number(v.tutar) || 0,
                tarih: v.tarih || null,
                referans: v.referans || '',
                diger: v.diger || ''
              })),
              teberru: (personel.veriler[yil].teberru || []).map(v => ({
                sahip: v.sahip || '',
                tutar: Number(v.tutar) || 0,
                tarih: v.tarih || null,
                referans: v.referans || '',
                diger: v.diger || ''
              }))
            };
            
            // ToplamlarÄ± hesapla
            ['iftar', 'sahur', 'taahhut', 'teberru'].forEach(tip => {
              const veriler = tumPersonelRaporData.personeller[personelAdi].veriler[yil][tip] || [];
              tumPersonelRaporData.toplamlar[yil] += veriler.reduce((sum, v) => sum + (v.tutar || 0), 0);
            });
          });
        });
        
        // Genel baÄŸÄ±ÅŸÃ§Ä± analizi (tÃ¼m personeller iÃ§in)
        Object.keys(analizData.bagiscilar).forEach(sahip => {
          const bagisci = analizData.bagiscilar[sahip];
          const yillar = Array.from(bagisci.yillar).sort();
          
          if (yillar.length === 3 && yillar.includes(2023) && yillar.includes(2024) && yillar.includes(2025)) {
            if (!tumPersonelRaporData.genelBagisciAnaliz.daimi.includes(sahip)) {
              tumPersonelRaporData.genelBagisciAnaliz.daimi.push(sahip);
            }
          } else if (yillar.length === 1 && yillar.includes(2025)) {
            if (!tumPersonelRaporData.genelBagisciAnaliz.yeni.includes(sahip)) {
              tumPersonelRaporData.genelBagisciAnaliz.yeni.push(sahip);
            }
          } else if (!yillar.includes(2025) && (yillar.includes(2023) || yillar.includes(2024))) {
            if (!tumPersonelRaporData.genelBagisciAnaliz.pasif.includes(sahip)) {
              tumPersonelRaporData.genelBagisciAnaliz.pasif.push(sahip);
            }
          }
        });
        
        // SÄ±ralama
        tumPersonelRaporData.genelBagisciAnaliz.daimi.sort((a, b) => a.localeCompare(b, 'tr-TR'));
        tumPersonelRaporData.genelBagisciAnaliz.yeni.sort((a, b) => a.localeCompare(b, 'tr-TR'));
        tumPersonelRaporData.genelBagisciAnaliz.pasif.sort((a, b) => a.localeCompare(b, 'tr-TR'));
        
        // Verileri localStorage'a kaydet
        const storageKey = 'tumPersonelRaporData_' + Date.now();
        localStorage.setItem(storageKey, JSON.stringify(tumPersonelRaporData));
        
        // AÃ§Ä±lmÄ±ÅŸ pencereyi rapor sayfasÄ±na yÃ¶nlendir (ASCII dosya adÄ± = 404/beyaz sayfa riski azalÄ±r)
        const printUrl = `ramazan-tum-personel-yazdir.html?key=${encodeURIComponent(storageKey)}`;
        reportWindow.location.href = printUrl;
      } catch (e) {
        console.error('TÃ¼m personel raporu oluÅŸturulurken hata:', e);
        const errMsg = (e && e.message) ? e.message : 'Rapor oluÅŸturulurken bir hata oluÅŸtu.';
        if (reportWindow && !reportWindow.closed) {
          reportWindow.location.href = `ramazan-tum-personel-yazdir.html?error=${encodeURIComponent(errMsg)}`;
        }
        alert('Rapor oluÅŸturulurken bir hata oluÅŸtu: ' + errMsg);
      }
    });

    /* ===== DetaylÄ± Personel BazlÄ± Raporlama (2023-2024-2025) ===== */
    
    // YardÄ±mcÄ± fonksiyonlar
    function normalizePersonelName(name) {
      if (!name) return '';
      const trimmed = String(name).trim();
      if (!trimmed) return '';
      
      // Belirli personelleri "diÄŸer" olarak gruplandÄ±r
      const digerPersoneller = [
        'burak serin',
        'muzaffer tunahan arÄ±kan',
        'muharrem morcalÄ±',
        'muharrem kÃ¼Ã§Ã¼kkaya'
      ];
      
      const normalizedName = trimmed.toLocaleLowerCase('tr-TR').trim();
      
      // Her bir "diÄŸer" personeli iÃ§in kontrol et
      for (const digerPersonel of digerPersoneller) {
        const digerPersonelNormalized = digerPersonel.toLocaleLowerCase('tr-TR').trim();
        // Tam eÅŸleÅŸme veya iÃ§erme kontrolÃ¼
        if (normalizedName === digerPersonelNormalized || 
            normalizedName.includes(digerPersonelNormalized) || 
            digerPersonelNormalized.includes(normalizedName)) {
          return 'DÄ°ÄER';
        }
      }
      
      // TÃ¼rkÃ§e karakter desteÄŸi ile bÃ¼yÃ¼k harf
      return trimmed.toLocaleUpperCase('tr-TR');
    }
    
    function normalizeTurkish(str) {
      if (!str) return '';
      return String(str).toLocaleLowerCase('tr-TR').trim();
    }

    let allYearsData = {}; // 2023, 2024, 2025 verileri (sadece raporlar: DetaylÄ± / TÃ¼m Personel)
    
    // ===== RAPORLAR: DetaylÄ± ve TÃ¼m Personel verileri sadece ramazan_veriler tablosundan =====
    async function loadAllYearsData() {
      if (!window.supabase) {
        console.warn('Supabase client hazÄ±r deÄŸil, analiz verileri yÃ¼klenemiyor');
        allYearsData = {};
        return;
      }
      
      allYearsData = {};
      const yillar = [2023, 2024, 2025];
      
      for (const yil of yillar) {
        try {
          const veriler = [];
          const { data: ramazanVerilerData, error: ramazanVerilerError } = await window.supabase
            .from('ramazan_veriler')
            .select('id, createdat, diger, personel, sahip, tip, tutar, yil, yukleyen, updatedat, referans')
            .eq('yil', yil);
          
          if (ramazanVerilerError) {
            console.error(`${yil} yÄ±lÄ± ramazan_veriler yÃ¼klenirken hata:`, ramazanVerilerError);
          } else if (ramazanVerilerData) {
            ramazanVerilerData.forEach(r => {
              veriler.push({
                id: r.id || '',
                yil: r.yil || yil,
                tip: (r.tip || '').toLowerCase(),
                sahip: r.sahip || '',
                tutar: Number(r.tutar) || 0,
                personel: r.personel || '',
                personeluid: '',
                tarih: r.createdat || null,
                referans: r.referans || '',
                diger: r.diger || '',
                yukleyen: r.yukleyen || ''
              });
            });
          }
          
          allYearsData[yil] = veriler;
          console.log(`${yil} yÄ±lÄ± rapor verisi (ramazan_veriler): ${veriler.length} kayÄ±t`);
        } catch (e) {
          console.error(`${yil} yÄ±lÄ± verileri yÃ¼klenemedi:`, e);
          allYearsData[yil] = [];
        }
      }
    }

    // Personel bazlÄ± verileri analiz et (genel/hususi ayrÄ±mÄ± yok)
    function analizPersonelVerileri() {
      const personeller = {};
      const bagiscilar = {}; // TÃ¼m baÄŸÄ±ÅŸÃ§Ä±lar (sahip)
      let personelAdiYokSayisi = 0;
      let toplamIslenen = 0;
      
      // Her yÄ±l iÃ§in veri iÅŸle
      Object.keys(allYearsData).forEach(yilStr => {
        const yil = parseInt(yilStr);
        const veriler = allYearsData[yil] || [];
        
        veriler.forEach(v => {
          toplamIslenen++;
          
          // BaÄŸÄ±ÅŸÃ§Ä± takibi (sahip)
          const sahip = (v.sahip || '').trim();
          if (sahip) {
            if (!bagiscilar[sahip]) {
              bagiscilar[sahip] = { yillar: new Set(), personeller: new Set() };
            }
            bagiscilar[sahip].yillar.add(yil);
          }
          
          // Personel belirleme
          let rawPersonel = v.personel || '';
          const personelAdi = normalizePersonelName(rawPersonel);
          
          if (!personelAdi) {
            personelAdiYokSayisi++;
            return;
          }
          
          // BaÄŸÄ±ÅŸÃ§Ä±ya personel ekle
          if (sahip) {
            bagiscilar[sahip].personeller.add(personelAdi);
          }
          
          // Personel yapÄ±sÄ±nÄ± oluÅŸtur (genel/hususi ayrÄ±mÄ± yok)
          if (!personeller[personelAdi]) {
            personeller[personelAdi] = {
              adi: personelAdi,
              veriler: {}, // { 2023: { iftar: [], sahur: [], taahhut: [], teberru: [] }, ... }
              yillar: new Set(),
              bagiscilar: new Set() // Bu personele ait baÄŸÄ±ÅŸÃ§Ä±lar
            };
          }
          
          personeller[personelAdi].yillar.add(yil);
          
          if (!personeller[personelAdi].veriler[yil]) {
            personeller[personelAdi].veriler[yil] = {
              iftar: [],
              sahur: [],
              taahhut: [],
              teberru: []
            };
          }
          
          const tip = (v.tip || '').toLowerCase();
          if (['iftar', 'sahur', 'taahhut', 'teberru'].includes(tip)) {
            personeller[personelAdi].veriler[yil][tip].push({
              sahip: v.sahip || '',
              tutar: Number(v.tutar) || 0,
              tarih: v.tarih,
              referans: v.referans || '',
              diger: v.diger || ''
            });
            
            if (sahip) {
              personeller[personelAdi].bagiscilar.add(sahip);
            }
          }
        });
      });
      
      console.log('Analiz sonuÃ§larÄ±:', {
        toplamIslenen: toplamIslenen,
        personelAdiYokSayisi: personelAdiYokSayisi,
        personelSayisi: Object.keys(personeller).length,
        bagisciSayisi: Object.keys(bagiscilar).length,
        personelListesi: Object.keys(personeller),
        personelListesiDetay: Object.keys(personeller).slice(0, 10)
      });
      
      // Debug: EÄŸer personel bulunamadÄ±ysa, verilerdeki personel alanlarÄ±nÄ± kontrol et
      if (Object.keys(personeller).length === 0 && toplamIslenen > 0) {
        console.warn('âš ï¸ Personel bulunamadÄ± ama veri var! Ä°lk 10 kayÄ±t personel alanlarÄ±:', 
          Object.values(allYearsData).flat().slice(0, 10).map(v => ({ 
            tip: v.tip, 
            personel: v.personel, 
            personelVar: !!v.personel,
            personelLength: String(v.personel || '').length
          }))
        );
      }
      
      return { personeller, bagiscilar };
    }

    // BaÄŸÄ±ÅŸÃ§Ä± analizi (belirli bir personel iÃ§in)
    function analizBagisciPersonel(bagiscilar, personelAdi) {
      const daimi = [];
      const yeni = [];
      const pasif = [];
      
      Object.keys(bagiscilar).forEach(sahip => {
        const bagisci = bagiscilar[sahip];
        // Sadece bu personele ait baÄŸÄ±ÅŸÃ§Ä±larÄ± kontrol et
        if (!bagisci.personeller.has(personelAdi)) return;
        
        const yillar = Array.from(bagisci.yillar).sort();
        
        if (yillar.length === 3 && yillar.includes(2023) && yillar.includes(2024) && yillar.includes(2025)) {
          daimi.push(sahip);
        } else if (yillar.length === 1 && yillar.includes(2025)) {
          yeni.push(sahip);
        } else if (!yillar.includes(2025) && (yillar.includes(2023) || yillar.includes(2024))) {
          pasif.push(sahip);
        }
      });
      
      return { daimi, yeni, pasif };
    }

    let analizData = null; // Global analiz verisi
    
    // Personel seÃ§im listesini doldur
    function doldurPersonelListesi(personeller) {
      const select = qs('#personelSecimi');
      select.innerHTML = '<option value="">Personel SeÃ§iniz...</option>';
      
      const personelListesi = Object.values(personeller).sort((a, b) => 
        a.adi.localeCompare(b.adi, 'tr-TR')
      );
      
      personelListesi.forEach(personel => {
        const option = document.createElement('option');
        option.value = personel.adi;
        option.textContent = personel.adi;
        select.appendChild(option);
      });
    }
    
    // SeÃ§ilen personelin raporunu render et
    function renderPersonelRaporu(personelAdi, { personeller, bagiscilar }) {
      const personel = personeller[personelAdi];
      if (!personel) {
        qs('#personelAnalizContainer').style.display = 'none';
        qs('#personelSecilmediMesaj').style.display = 'block';
        return;
      }
      
      qs('#personelSecilmediMesaj').style.display = 'none';
      qs('#personelAnalizContainer').style.display = 'block';
      
      // Personel baÅŸlÄ±k
      qs('#personelBaslik').textContent = personel.adi;
      qs('#personelAktifYillar').textContent = `Aktif YÄ±llar: ${Array.from(personel.yillar).sort().join(', ')}`;
      
      // YÄ±l bazlÄ± Ã¶zet
      renderYilBazliOzet(personel);
      
      // DetaylÄ± kayÄ±tlar
      renderDetayliKayitlar(personel);
      
      // BaÄŸÄ±ÅŸÃ§Ä± analizi
      const bagisciAnaliz = analizBagisciPersonel(bagiscilar, personelAdi);
      qs('#daimiBagisciSayisi').textContent = bagisciAnaliz.daimi.length;
      qs('#yeniBagisciSayisi').textContent = bagisciAnaliz.yeni.length;
      qs('#pasifBagisciSayisi').textContent = bagisciAnaliz.pasif.length;
      
      // BaÄŸÄ±ÅŸÃ§Ä± detaylarÄ±
      renderBagisciDetaylari(personel, bagiscilar, personelAdi);
      
      // BaÄŸÄ±ÅŸÃ§Ä± isim listesi ve kategorileri
      renderBagisciIsimListesi(personel, bagiscilar, personelAdi, bagisciAnaliz);
    }
    
    // BaÄŸÄ±ÅŸÃ§Ä± detaylarÄ± render (yÄ±l yÄ±l, tip tip)
    function renderBagisciDetaylari(personel, bagiscilar, personelAdi) {
      const container = qs('#bagisciDetaylari');
      const yillar = [2023, 2024, 2025];
      const tipler = [
        { key: 'iftar', label: 'Ä°ftar', icon: 'ğŸŒ™' },
        { key: 'sahur', label: 'Sahur', icon: 'ğŸŒŸ' },
        { key: 'taahhut', label: 'TaahhÃ¼t', icon: 'ğŸ“‹' },
        { key: 'teberru', label: 'Teberru', icon: 'ğŸ’' }
      ];
      
      let html = '';
      
      yillar.forEach(yil => {
        const yilData = personel.veriler[yil] || {};
        
        html += `
          <div style="margin-bottom:24px;padding:16px;background:var(--surface2);border-radius:8px;border-left:4px solid var(--accent)">
            <h6 style="margin:0 0 16px 0;font-size:18px;color:var(--accent);font-weight:700">${yil} YÄ±lÄ±</h6>
        `;
        
        tipler.forEach(tip => {
          const veriler = yilData[tip.key] || [];
          if (veriler.length === 0) return;
          
          // BaÄŸÄ±ÅŸÃ§Ä±lara gÃ¶re grupla
          const bagisciMap = {};
          veriler.forEach(v => {
            const sahip = (v.sahip || '').trim();
            if (!sahip) return;
            
            if (!bagisciMap[sahip]) {
              bagisciMap[sahip] = {
                isim: sahip,
                toplamTutar: 0,
                kayitSayisi: 0
              };
            }
            
            bagisciMap[sahip].toplamTutar += Number(v.tutar) || 0;
            bagisciMap[sahip].kayitSayisi++;
          });
          
          // BaÄŸÄ±ÅŸÃ§Ä±larÄ± tutara gÃ¶re sÄ±rala
          const bagisciListesi = Object.values(bagisciMap).sort((a, b) => b.toplamTutar - a.toplamTutar);
          
          if (bagisciListesi.length === 0) return;
          
          const tipToplam = bagisciListesi.reduce((sum, b) => sum + b.toplamTutar, 0);
          
          html += `
            <div style="margin-bottom:16px;padding:12px;background:#fff;border-radius:8px">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding-bottom:8px;border-bottom:2px solid var(--border)">
                <div style="display:flex;align-items:center;gap:8px">
                  <span style="font-size:20px">${tip.icon}</span>
                  <span style="font-weight:700;font-size:16px;color:var(--accent)">${tip.label}</span>
                </div>
                <div style="text-align:right">
                  <div style="font-weight:700;font-size:16px;color:var(--accent)">â‚º${tipToplam.toLocaleString('tr-TR', {minimumFractionDigits:2})}</div>
                  <div style="font-size:12px;color:var(--muted)">${bagisciListesi.length} baÄŸÄ±ÅŸÃ§Ä± | ${veriler.length} kayÄ±t</div>
                </div>
              </div>
              <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:8px">
          `;
          
          bagisciListesi.forEach(bagisci => {
            html += `
              <div style="padding:10px;background:var(--surface2);border-radius:6px;border:1px solid var(--border)">
                <div style="font-weight:600;font-size:14px;margin-bottom:4px;color:var(--ink)">${bagisci.isim}</div>
                <div style="font-weight:700;font-size:15px;color:var(--accent)">â‚º${bagisci.toplamTutar.toLocaleString('tr-TR', {minimumFractionDigits:2})}</div>
                <div style="font-size:11px;color:var(--muted);margin-top:2px">${bagisci.kayitSayisi} kayÄ±t</div>
              </div>
            `;
          });
          
          html += `
              </div>
            </div>
          `;
        });
        
        html += '</div>';
      });
      
      container.innerHTML = html || '<div class="muted" style="text-align:center;padding:20px">BaÄŸÄ±ÅŸÃ§Ä± detayÄ± bulunamadÄ±</div>';
    }
    
    // BaÄŸÄ±ÅŸÃ§Ä± isim listesi ve kategorileri render
    function renderBagisciIsimListesi(personel, bagiscilar, personelAdi, bagisciAnaliz) {
      const container = qs('#bagisciIsimListesi');
      const yillar = [2023, 2024, 2025];
      const tipler = [
        { key: 'iftar', label: 'Ä°ftar', icon: 'ğŸŒ™' },
        { key: 'sahur', label: 'Sahur', icon: 'ğŸŒŸ' },
        { key: 'taahhut', label: 'TaahhÃ¼t', icon: 'ğŸ“‹' },
        { key: 'teberru', label: 'Teberru', icon: 'ğŸ’' }
      ];
      
      // TÃ¼m baÄŸÄ±ÅŸÃ§Ä±larÄ± birleÅŸtir (daimi, yeni, pasif)
      // Ã–nce kategoriye gÃ¶re sÄ±rala (daimi: 0, yeni: 1, pasif: 2), sonra isme gÃ¶re alfabetik
      const kategoriSira = { 'daimi': 0, 'yeni': 1, 'pasif': 2 };
      const tumBagiscilar = [
        ...bagisciAnaliz.daimi.map(isim => ({ isim, kategori: 'daimi', label: 'Daimi BaÄŸÄ±ÅŸÃ§Ä±', renk: '#2d6a4f' })),
        ...bagisciAnaliz.yeni.map(isim => ({ isim, kategori: 'yeni', label: 'Yeni BaÄŸÄ±ÅŸÃ§Ä±', renk: '#fff3cd' })),
        ...bagisciAnaliz.pasif.map(isim => ({ isim, kategori: 'pasif', label: 'Pasif BaÄŸÄ±ÅŸÃ§Ä±', renk: '#f8d7da' }))
      ].sort((a, b) => {
        // Ã–nce kategoriye gÃ¶re sÄ±rala
        const kategoriFarki = kategoriSira[a.kategori] - kategoriSira[b.kategori];
        if (kategoriFarki !== 0) return kategoriFarki;
        // AynÄ± kategorideyse isme gÃ¶re alfabetik sÄ±rala
        return a.isim.localeCompare(b.isim, 'tr-TR');
      });
      
      if (tumBagiscilar.length === 0) {
        container.innerHTML = '<div class="muted" style="text-align:center;padding:20px">BaÄŸÄ±ÅŸÃ§Ä± bulunamadÄ±</div>';
        return;
      }
      
      let html = '';
      
      tumBagiscilar.forEach(({ isim, kategori, label, renk }) => {
        // Bu baÄŸÄ±ÅŸÃ§Ä±nÄ±n yÄ±l yÄ±l, tip tip verilerini topla
        const bagisciVerileri = {};
        let toplamGenelTutar = 0;
        let toplamGenelKayit = 0;
        
        yillar.forEach(yil => {
          bagisciVerileri[yil] = { iftar: { tutar: 0, kayit: 0 }, sahur: { tutar: 0, kayit: 0 }, taahhut: { tutar: 0, kayit: 0 }, teberru: { tutar: 0, kayit: 0 } };
          
          tipler.forEach(tip => {
            const veriler = (personel.veriler[yil] || {})[tip.key] || [];
            const bagisciKayitlari = veriler.filter(v => (v.sahip || '').trim() === isim);
            
            if (bagisciKayitlari.length > 0) {
              const toplamTutar = bagisciKayitlari.reduce((sum, v) => sum + (v.tutar || 0), 0);
              bagisciVerileri[yil][tip.key] = {
                tutar: toplamTutar,
                kayit: bagisciKayitlari.length
              };
              toplamGenelTutar += toplamTutar;
              toplamGenelKayit += bagisciKayitlari.length;
            }
          });
        });
        
        html += `
          <div style="margin-bottom:24px;padding:16px;background:var(--surface2);border-radius:8px;border-left:4px solid ${renk}">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px">
              <div>
                <h6 style="margin:0;font-size:18px;color:var(--accent);font-weight:700">${isim}</h6>
                <div style="margin-top:4px;padding:4px 10px;border-radius:6px;background:${renk};display:inline-block;font-size:12px;font-weight:600;color:${kategori === 'daimi' ? '#fff' : '#856404'}">${label}</div>
              </div>
              <div style="text-align:right">
                <div style="font-weight:700;font-size:16px;color:var(--accent)">â‚º${toplamGenelTutar.toLocaleString('tr-TR', {minimumFractionDigits:2})}</div>
                <div style="font-size:12px;color:var(--muted)">${toplamGenelKayit} kayÄ±t</div>
              </div>
            </div>
            
            <div style="margin-top:16px">
        `;
        
        yillar.forEach(yil => {
          const yilVerileri = bagisciVerileri[yil];
          const yilToplam = tipler.reduce((sum, tip) => sum + (yilVerileri[tip.key].tutar || 0), 0);
          const yilKayit = tipler.reduce((sum, tip) => sum + (yilVerileri[tip.key].kayit || 0), 0);
          
          if (yilToplam === 0 && yilKayit === 0) return;
          
          html += `
            <div style="margin-bottom:16px;padding:12px;background:#fff;border-radius:8px;border:1px solid var(--border)">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding-bottom:8px;border-bottom:2px solid var(--border)">
                <div style="font-weight:700;font-size:16px;color:var(--accent)">${yil} YÄ±lÄ±</div>
                <div style="text-align:right">
                  <div style="font-weight:700;font-size:15px;color:var(--accent)">â‚º${yilToplam.toLocaleString('tr-TR', {minimumFractionDigits:2})}</div>
                  <div style="font-size:12px;color:var(--muted)">${yilKayit} kayÄ±t</div>
                </div>
              </div>
              
              <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:8px">
          `;
          
          tipler.forEach(tip => {
            const tipData = yilVerileri[tip.key];
            if (tipData.tutar === 0 && tipData.kayit === 0) return;
            
            html += `
              <div style="padding:10px;background:var(--surface2);border-radius:6px;border:1px solid var(--border)">
                <div style="display:flex;align-items:center;gap:6px;margin-bottom:6px">
                  <span style="font-size:18px">${tip.icon}</span>
                  <span style="font-weight:600;font-size:14px;color:var(--ink)">${tip.label}</span>
                </div>
                <div style="font-weight:700;font-size:15px;color:var(--accent)">â‚º${tipData.tutar.toLocaleString('tr-TR', {minimumFractionDigits:2})}</div>
                <div style="font-size:11px;color:var(--muted);margin-top:2px">${tipData.kayit} kayÄ±t</div>
              </div>
            `;
          });
          
          html += `
              </div>
            </div>
          `;
        });
        
        html += `
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }
    
    // YÄ±l bazlÄ± Ã¶zet render
    function renderYilBazliOzet(personel) {
      const container = qs('#yilBazliOzet');
      const yillar = [2023, 2024, 2025];
      const tipler = [
        { key: 'iftar', label: 'Ä°ftar', icon: 'ğŸŒ™' },
        { key: 'sahur', label: 'Sahur', icon: 'ğŸŒŸ' },
        { key: 'taahhut', label: 'TaahhÃ¼t', icon: 'ğŸ“‹' },
        { key: 'teberru', label: 'Teberru', icon: 'ğŸ’' }
      ];
      
      let html = '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px">';
      
      yillar.forEach(yil => {
        const yilData = personel.veriler[yil] || {};
        let yilToplamTutar = 0;
        let yilToplamKayit = 0;
        
        tipler.forEach(tip => {
          const veriler = yilData[tip.key] || [];
          yilToplamTutar += veriler.reduce((sum, v) => sum + (v.tutar || 0), 0);
          yilToplamKayit += veriler.length;
        });
        
        html += `
          <div style="padding:12px;background:var(--surface2);border-radius:8px;text-align:center">
            <div style="font-size:13px;color:var(--muted);margin-bottom:6px;font-weight:600">${yil}</div>
            <div style="font-weight:700;font-size:18px;color:var(--accent);margin-bottom:4px">
              â‚º${yilToplamTutar.toLocaleString('tr-TR', {minimumFractionDigits:2})}
            </div>
            <div style="font-size:11px;color:var(--muted)">${yilToplamKayit} kayÄ±t</div>
          </div>
        `;
      });
      
      html += '</div>';
      container.innerHTML = html;
    }
    
    // DetaylÄ± kayÄ±tlar render
    function renderDetayliKayitlar(personel) {
      const container = qs('#detayliKayitlar');
      const yillar = [2023, 2024, 2025];
      const tipler = [
        { key: 'iftar', label: 'Ä°ftar', icon: 'ğŸŒ™' },
        { key: 'sahur', label: 'Sahur', icon: 'ğŸŒŸ' },
        { key: 'taahhut', label: 'TaahhÃ¼t', icon: 'ğŸ“‹' },
        { key: 'teberru', label: 'Teberru', icon: 'ğŸ’' }
      ];
      
      let html = '';
      
      yillar.forEach(yil => {
        const yilData = personel.veriler[yil] || {};
        let yilToplamTutar = 0;
        let yilToplamKayit = 0;
        
        html += `
          <div style="margin-bottom:20px;padding:12px;background:var(--surface2);border-radius:8px">
            <h6 style="margin:0 0 12px 0;font-size:16px;color:var(--accent)">${yil} YÄ±lÄ±</h6>
        `;
        
        tipler.forEach(tip => {
          const veriler = yilData[tip.key] || [];
          if (veriler.length === 0) return;
          
          const toplamTutar = veriler.reduce((sum, v) => sum + (v.tutar || 0), 0);
          const kisiSayisi = new Set(veriler.map(v => (v.sahip || '').trim()).filter(s => s)).size;
          
          yilToplamTutar += toplamTutar;
          yilToplamKayit += veriler.length;
          
          html += `
            <div style="margin-bottom:10px;padding:10px;background:#fff;border-radius:6px;border-left:4px solid var(--accent)">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
                <span style="font-weight:600">${tip.icon} ${tip.label}</span>
                <span style="font-weight:700;color:var(--accent)">â‚º${toplamTutar.toLocaleString('tr-TR', {minimumFractionDigits:2})}</span>
              </div>
              <div style="font-size:12px;color:var(--muted)">
                ${veriler.length} kayÄ±t | ${kisiSayisi} farklÄ± baÄŸÄ±ÅŸÃ§Ä±
              </div>
            </div>
          `;
        });
        
        if (yilToplamKayit > 0) {
          html += `
            <div style="margin-top:12px;padding:10px;background:var(--accent);color:#fff;border-radius:6px;text-align:center">
              <div style="font-size:12px;opacity:0.9;margin-bottom:4px">${yil} Toplam</div>
              <div style="font-weight:700;font-size:16px">â‚º${yilToplamTutar.toLocaleString('tr-TR', {minimumFractionDigits:2})}</div>
              <div style="font-size:11px;opacity:0.9;margin-top:4px">${yilToplamKayit} kayÄ±t</div>
            </div>
          `;
        }
        
        html += '</div>';
      });
      
      container.innerHTML = html || '<div class="muted" style="text-align:center;padding:20px">KayÄ±t bulunamadÄ±</div>';
    }

    // Personel kategori detayÄ± (Genel/Hususi)
    function renderPersonelKategoriDetay(personel, kategori, containerId) {
      const container = qs(`#${containerId}`);
      const kategoriData = personel[kategori] || {};
      const yillar = [2023, 2024, 2025];
      const tipler = [
        { key: 'iftar', label: 'Ä°ftar', icon: 'ğŸŒ™' },
        { key: 'sahur', label: 'Sahur', icon: 'ğŸŒŸ' },
        { key: 'taahhut', label: 'TaahhÃ¼t', icon: 'ğŸ“‹' },
        { key: 'teberru', label: 'Teberru', icon: 'ğŸ’' }
      ];
      
      let html = '<div style="font-size:13px">';
      let toplamTutarKategori = 0;
      let toplamKayitKategori = 0;
      
      yillar.forEach(yil => {
        if (!kategoriData[yil]) return;
        
        let yilToplamTutar = 0;
        let yilToplamKayit = 0;
        
        html += `<div style="margin-bottom:12px;padding:10px;background:var(--surface2);border-radius:8px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <strong style="color:var(--accent);font-size:14px">${yil}</strong>
            <span id="${containerId}-${yil}-toplam" style="font-weight:700;color:var(--accent);font-size:13px"></span>
          </div>`;
        
        tipler.forEach(tip => {
          const veriler = kategoriData[yil][tip.key] || [];
          if (veriler.length === 0) return;
          
          const toplamTutar = veriler.reduce((sum, v) => sum + (v.tutar || 0), 0);
          const kisiSayisi = new Set(veriler.map(v => (v.sahip || '').trim()).filter(s => s)).size;
          
          yilToplamTutar += toplamTutar;
          yilToplamKayit += veriler.length;
          toplamTutarKategori += toplamTutar;
          toplamKayitKategori += veriler.length;
          
          html += `
            <div style="margin-top:6px;padding:8px;background:#fff;border-radius:6px;border-left:3px solid var(--accent)">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span>${tip.icon} <strong>${tip.label}</strong></span>
                <span style="font-weight:700;color:var(--accent)">â‚º${toplamTutar.toLocaleString('tr-TR', {minimumFractionDigits:2})}</span>
              </div>
              <div class="muted" style="font-size:11px">${veriler.length} kayÄ±t | ${kisiSayisi} farklÄ± baÄŸÄ±ÅŸÃ§Ä±</div>
            </div>
          `;
        });
        
        if (yilToplamTutar > 0) {
          // YÄ±l toplamÄ±nÄ± gÃ¶ster
          setTimeout(() => {
            const toplamEl = qs(`#${containerId}-${yil}-toplam`);
            if (toplamEl) {
              toplamEl.textContent = `Toplam: â‚º${yilToplamTutar.toLocaleString('tr-TR', {minimumFractionDigits:2})}`;
            }
          }, 0);
        }
        
        html += '</div>';
      });
      
      // Kategori toplamÄ±
      if (toplamTutarKategori > 0) {
        html += `
          <div style="margin-top:12px;padding:10px;background:var(--accent);color:#fff;border-radius:8px;text-align:center">
            <div style="font-size:11px;opacity:0.9;margin-bottom:4px">Kategori ToplamÄ±</div>
            <div style="font-weight:700;font-size:16px">â‚º${toplamTutarKategori.toLocaleString('tr-TR', {minimumFractionDigits:2})}</div>
            <div style="font-size:11px;opacity:0.9;margin-top:4px">${toplamKayitKategori} kayÄ±t</div>
          </div>
        `;
      }
      
      html += '</div>';
      container.innerHTML = html || '<div class="muted" style="font-size:13px;padding:20px;text-align:center">Bu kategori iÃ§in veri bulunamadÄ±</div>';
    }

    // Personel Ã¶zet
    function renderPersonelOzet(personel, containerId) {
      const container = qs(`#${containerId}`);
      const yillar = [2023, 2024, 2025];
      
      let html = `
        <div style="border-top:2px solid var(--border);padding-top:16px">
          <h5 style="margin:0 0 12px 0">ğŸ“Š Genel Ã–zet</h5>
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:12px">
      `;
      
      let genelToplamTutar = 0;
      let hususiToplamTutar = 0;
      
      yillar.forEach(yil => {
        const genelData = personel.genel[yil] || {};
        const hususiData = personel.hususi[yil] || {};
        
        const genelTutar = ['iftar', 'sahur', 'taahhut', 'teberru'].reduce((sum, tip) => {
          const veriler = genelData[tip] || [];
          return sum + veriler.reduce((s, v) => s + (v.tutar || 0), 0);
        }, 0);
        
        const hususiTutar = ['iftar', 'sahur', 'taahhut', 'teberru'].reduce((sum, tip) => {
          const veriler = hususiData[tip] || [];
          return sum + veriler.reduce((s, v) => s + (v.tutar || 0), 0);
        }, 0);
        
        genelToplamTutar += genelTutar;
        hususiToplamTutar += hususiTutar;
        
        html += `
          <div style="padding:8px;background:var(--surface2);border-radius:8px;text-align:center">
            <div style="font-size:11px;color:var(--muted);margin-bottom:4px">${yil}</div>
            <div style="font-weight:700;font-size:14px">â‚º${(genelTutar + hususiTutar).toLocaleString('tr-TR', {minimumFractionDigits:2})}</div>
            <div style="font-size:10px;color:var(--muted);margin-top:2px">
              Genel: â‚º${genelTutar.toLocaleString('tr-TR', {minimumFractionDigits:2})} | 
              Hususi: â‚º${hususiTutar.toLocaleString('tr-TR', {minimumFractionDigits:2})}
            </div>
          </div>
        `;
      });
      
      html += `
          </div>
          <div style="padding:12px;background:var(--surface);border-radius:8px;text-align:center">
            <div style="font-size:12px;color:var(--muted);margin-bottom:4px">3 YÄ±llÄ±k Toplam</div>
            <div style="font-weight:700;font-size:20px;color:var(--accent)">
              â‚º${(genelToplamTutar + hususiToplamTutar).toLocaleString('tr-TR', {minimumFractionDigits:2})}
            </div>
            <div style="font-size:11px;color:var(--muted);margin-top:4px">
              Genel: â‚º${genelToplamTutar.toLocaleString('tr-TR', {minimumFractionDigits:2})} | 
              Hususi: â‚º${hususiToplamTutar.toLocaleString('tr-TR', {minimumFractionDigits:2})}
            </div>
          </div>
        </div>
      `;
      
      container.innerHTML = html;
    }

    // DetaylÄ± rapor butonu
    qs('#btnDetayliRapor').addEventListener('click', async () => {
      const section = qs('#detayliRaporSection');
      if (section.style.display === 'none') {
        section.style.display = 'block';
        section.scrollIntoView({ behavior: 'smooth' });
        
        // Verileri yÃ¼kle ve analiz et
        qs('#personelAnalizContainer').style.display = 'none';
        qs('#personelSecilmediMesaj').style.display = 'block';
        qs('#personelSecimi').innerHTML = '<option value="">YÃ¼kleniyor...</option>';
        
        try {
          await loadAllYearsData();
          
          // YÃ¼klenen veri kontrolÃ¼
          const toplamKayit = Object.values(allYearsData).reduce((sum, arr) => sum + arr.length, 0);
          console.log('Toplam yÃ¼klenen kayÄ±t:', toplamKayit);
          
          if (toplamKayit === 0) {
            qs('#personelSecimi').innerHTML = '<option value="">Personel SeÃ§iniz...</option>';
            qs('#personelSecilmediMesaj').innerHTML = `
              <div style="text-align:center;padding:40px">
                <h4 style="color:var(--warn);margin-bottom:12px">âš ï¸ Veri BulunamadÄ±</h4>
                <p class="muted">2023, 2024 veya 2025 yÄ±llarÄ±na ait veri bulunamadÄ±.</p>
              </div>
            `;
            return;
          }
          
          analizData = analizPersonelVerileri();
          const personelSayisi = Object.keys(analizData.personeller).length;
          
          if (personelSayisi === 0) {
            qs('#personelSecimi').innerHTML = '<option value="">Personel SeÃ§iniz...</option>';
            qs('#personelSecilmediMesaj').innerHTML = `
              <div style="text-align:center;padding:40px">
                <h4 style="color:var(--warn);margin-bottom:12px">âš ï¸ Personel Verisi BulunamadÄ±</h4>
                <p class="muted">KayÄ±tlarda personel/referans bilgisi bulunamadÄ±.</p>
              </div>
            `;
            return;
          }
          
          // Personel listesini doldur
          doldurPersonelListesi(analizData.personeller);
        } catch (e) {
          console.error('Rapor yÃ¼klenirken hata:', e);
          qs('#personelSecimi').innerHTML = '<option value="">Personel SeÃ§iniz...</option>';
          qs('#personelSecilmediMesaj').innerHTML = `
            <div style="text-align:center;padding:40px">
              <h4 style="color:var(--bad);margin-bottom:12px">âŒ Hata OluÅŸtu</h4>
              <p class="muted">Veriler yÃ¼klenirken bir hata oluÅŸtu: ${(e && e.message) ? e.message : ''}</p>
            </div>
          `;
        }
      } else {
        section.style.display = 'none';
      }
    });
    
    // Personel seÃ§imi deÄŸiÅŸtiÄŸinde
    qs('#personelSecimi').addEventListener('change', (e) => {
      const personelAdi = e.target.value;
      if (!personelAdi || !analizData) return;
      
      renderPersonelRaporu(personelAdi, analizData);
    });

    // YazdÄ±r butonu
    qs('#btnRaporYazdir').addEventListener('click', () => {
      const personelAdi = qs('#personelSecimi').value;
      if (!personelAdi) {
        alert('LÃ¼tfen Ã¶nce bir personel seÃ§iniz.');
        return;
      }
      
      const personel = analizData.personeller[personelAdi];
      if (!personel) return;
      
      // BaÄŸÄ±ÅŸÃ§Ä± analizi
      const bagisciAnaliz = analizBagisciPersonel(analizData.bagiscilar, personelAdi);
      
      // Rapor verilerini hazÄ±rla (Set'leri Array'e dÃ¶nÃ¼ÅŸtÃ¼r)
      const raporData = {
        personel: {
          adi: personel.adi,
          yillar: Array.from(personel.yillar).sort(),
          veriler: {}
        },
        bagisciAnaliz: {
          daimi: bagisciAnaliz.daimi || [],
          yeni: bagisciAnaliz.yeni || [],
          pasif: bagisciAnaliz.pasif || []
        }
      };
      
      // Veriler objesini serialize edilebilir hale getir
      Object.keys(personel.veriler).forEach(yilStr => {
        const yil = parseInt(yilStr);
        raporData.personel.veriler[yil] = {
          iftar: (personel.veriler[yil].iftar || []).map(v => ({
            sahip: v.sahip || '',
            tutar: Number(v.tutar) || 0,
            tarih: v.tarih || null,
            referans: v.referans || '',
            diger: v.diger || ''
          })),
          sahur: (personel.veriler[yil].sahur || []).map(v => ({
            sahip: v.sahip || '',
            tutar: Number(v.tutar) || 0,
            tarih: v.tarih || null,
            referans: v.referans || '',
            diger: v.diger || ''
          })),
          taahhut: (personel.veriler[yil].taahhut || []).map(v => ({
            sahip: v.sahip || '',
            tutar: Number(v.tutar) || 0,
            tarih: v.tarih || null,
            referans: v.referans || '',
            diger: v.diger || ''
          })),
          teberru: (personel.veriler[yil].teberru || []).map(v => ({
            sahip: v.sahip || '',
            tutar: Number(v.tutar) || 0,
            tarih: v.tarih || null,
            referans: v.referans || '',
            diger: v.diger || ''
          }))
        };
      });
      
      // Verileri localStorage'a kaydet (URL uzunluÄŸu sÄ±nÄ±rÄ± nedeniyle)
      const storageKey = 'personelRaporData_' + Date.now();
      try {
        localStorage.setItem(storageKey, JSON.stringify(raporData));
        console.log('Veri localStorage\'a kaydedildi:', storageKey);
        
        // URL parametresi olarak sadece storage key'i gÃ¶nder
        const printUrl = `ramazanÄ±serifraporyazdÄ±r.html?personel=${encodeURIComponent(personelAdi)}&key=${storageKey}`;
        console.log('YazdÄ±rma URL oluÅŸturuldu:', printUrl);
        
        // Yeni pencerede aÃ§
        const newWindow = window.open(printUrl, '_blank');
        if (!newWindow) {
          alert('Pop-up engellendi. LÃ¼tfen pop-up izni verin ve tekrar deneyin.');
        } else {
          // 5 saniye sonra localStorage'dan temizle (opsiyonel)
          setTimeout(() => {
            try {
              localStorage.removeItem(storageKey);
              console.log('GeÃ§ici veri temizlendi:', storageKey);
            } catch (e) {
              console.warn('LocalStorage temizleme hatasÄ±:', e);
            }
          }, 30000); // 30 saniye sonra temizle
        }
      } catch (e) {
        console.error('LocalStorage hatasÄ±:', e);
        // Fallback: EÄŸer localStorage Ã§alÄ±ÅŸmazsa URL parametresi olarak dene (kÃ¼Ã§Ã¼k veriler iÃ§in)
        const jsonString = JSON.stringify(raporData);
        if (jsonString.length < 2000) { // 2KB'dan kÃ¼Ã§Ã¼kse URL kullan
          const dataParam = encodeURIComponent(jsonString);
          const printUrl = `ramazanÄ±serifraporyazdÄ±r.html?personel=${encodeURIComponent(personelAdi)}&data=${dataParam}`;
          window.open(printUrl, '_blank');
        } else {
          alert('Veri Ã§ok bÃ¼yÃ¼k. LÃ¼tfen daha az veri seÃ§in veya tarayÄ±cÄ± ayarlarÄ±nÄ±zÄ± kontrol edin.');
        }
      }
    });
    
    // PDF ve Excel export
    qs('#btnRaporPDF').addEventListener('click', () => {
      const personelAdi = qs('#personelSecimi').value;
      if (!personelAdi) {
        alert('LÃ¼tfen Ã¶nce bir personel seÃ§iniz.');
        return;
      }
      
      const el = qs('#personelAnalizContainer');
      const opt = {
        margin: [10, 10, 10, 10],
        filename: `personel-rapor-${personelAdi}-2023-2024-2025.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true, scrollY: -window.scrollY },
        pagebreak: { mode: ['css', 'legacy', 'avoid-all'] },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
      };
      html2pdf().set(opt).from(el).save();
    });

    qs('#btnRaporExcel').addEventListener('click', () => {
      const personelAdi = qs('#personelSecimi').value;
      if (!personelAdi || !analizData) {
        alert('LÃ¼tfen Ã¶nce bir personel seÃ§iniz.');
        return;
      }
      
      const personel = analizData.personeller[personelAdi];
      if (!personel) return;
      
      // Excel export iÃ§in CSV formatÄ±nda dÄ±ÅŸa aktar
      const rows = [['YÄ±l', 'Tip', 'BaÄŸÄ±ÅŸÃ§Ä±', 'Tutar', 'Referans', 'Tarih']];
      
      [2023, 2024, 2025].forEach(yil => {
        const yilData = personel.veriler[yil] || {};
        ['iftar', 'sahur', 'taahhut', 'teberru'].forEach(tip => {
          const veriler = yilData[tip] || [];
          veriler.forEach(v => {
            const tarihStr = v.tarih ? (v.tarih instanceof Date ? v.tarih.toISOString().slice(0, 10) : v.tarih) : '';
            rows.push([
              yil,
              tip,
              v.sahip || '',
              v.tutar || 0,
              v.referans || '',
              tarihStr
            ]);
          });
        });
      });
      
      const csv = rows.map(r => r.map(cell => {
        const str = String(cell);
        return str.includes(',') || str.includes('"') || str.includes('\n')
          ? `"${str.replace(/"/g, '""')}"`
          : str;
      }).join(',')).join('\n');
      
      const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `personel-rapor-${personelAdi}-2023-2024-2025.csv`;
      link.click();
    });
  </script>
</body>
</html>

