<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Ä°ftar-Sahur RaporlarÄ± | Ramazan-Ä± Åerif</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <link rel="icon" type="image/png" href="../img/logo.png" />

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="../../js/firebase/firebase-init.js"></script>

  <!-- html2pdf -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" defer></script>

  <style>
    :root{
      --appbar-h:56px;
      --bg:#f4f6f9; --card:#ffffff; --ink:#2c3e50; --muted:#6c7a89;
      --accent:#324960; --good:#2d6a4f; --warn:#d35400; --bad:#c0392b;
      --border:#e6ebf2; --stroke:rgba(15,23,42,.12); --text:#0b1220;
      --surface:#f1f5ff; --surface2:#f6f8ff; --shadow:0 12px 28px rgba(0,0,0,.12);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Segoe UI',system-ui,-apple-system,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    img{max-width:100%;height:auto;display:block}
    
    /* APPBAR */
    .appbar{
      position:sticky; top:0; z-index:60; height:var(--appbar-h);
      background:var(--card); backdrop-filter:blur(10px);
      border-bottom:1px solid var(--stroke);
      display:flex; align-items:center; gap:10px; padding:0 12px;
    }
    .brand{display:flex; align-items:center; gap:10px; cursor:pointer}
    .brand img{width:24px; height:24px}
    .brand span{font-weight:900; letter-spacing:.02em; color:var(--text)}
    .nav-center{margin:0 auto; height:100%}
    .nav-list{display:flex; gap:22px; align-items:center; height:100%; list-style:none; margin:0; padding:0}
    .nav-item{position:relative; height:100%}
    .nav-btn{height:100%; display:flex; align-items:center; gap:6px; font-weight:800; cursor:pointer; color:var(--text)}
    .nav-btn:hover{color:var(--accent)}
    .caret{font-size:12px; opacity:.6}
    .dropdown{position:absolute; top:100%; left:0; min-width:240px; background:var(--card); border:1px solid var(--stroke); border-radius:12px; box-shadow:var(--shadow); padding:8px; display:none}
    .dropdown a{display:flex; align-items:center; gap:8px; padding:10px 12px; border-radius:10px; color:var(--text); text-decoration:none}
    .dropdown a:hover{background:var(--surface2)}
    .nav-item.open .dropdown{display:block}
    .nav-right{display:flex; gap:8px; align-items:center}
    .btn{border:1px solid var(--stroke); background:var(--surface2); color:var(--text); border-radius:999px; padding:8px 14px; cursor:pointer; white-space:nowrap; font-weight:700}
    .hamb{display:none}
    .iconbtn{position:relative; border:1px solid var(--stroke); background:var(--card); color:var(--text); border-radius:999px; padding:8px 12px; cursor:pointer; display:flex; align-items:center; gap:8px}
    .drop-right{left:auto; right:0}
    .avatar{width:22px;height:22px;border-radius:999px;background:linear-gradient(180deg,#94a3b8,#64748b)}
    .muted{color:var(--muted)}
    @media (max-width: 960px){ .nav-center{display:none} .hamb{display:inline-flex} }

    /* DRAWER */
    .drawer{position:fixed; top:var(--appbar-h); right:0; bottom:0; left:34%; transform:translateX(100%); transition:.25s; background:var(--card); border-left:1px solid var(--stroke); z-index:70; overflow:auto; padding:16px}
    .drawer.open{transform:translateX(0)}
    .drawer .panel-title{margin:14px 4px 6px; font-weight:800; color:var(--muted); font-size:13px}
    .drawer a{display:block; padding:12px; border-radius:12px; border:1px solid var(--stroke); margin:8px 0; color:var(--text); background:var(--surface2); text-decoration:none}
    .drawer a:hover{background:var(--surface)}
    
    header{position:sticky;top:var(--appbar-h);z-index:5;background:var(--card);border-bottom:1px solid var(--border);box-shadow:0 2px 4px rgba(0,0,0,.05)}
    .wrap{max-width:1400px;margin:0 auto;padding:12px 16px}
    
    .toolbar{display:flex;gap:10px;flex-wrap:nowrap;align-items:center;overflow:auto;padding-bottom:6px}
    .toolbar::-webkit-scrollbar{height:6px}
    .toolbar::-webkit-scrollbar-thumb{background:#d7dde6;border-radius:999px}
    select,input,button{
      height:38px;border:1px solid var(--border);background:#fff;border-radius:10px;padding:0 12px;font:inherit;color:var(--ink);white-space:nowrap
    }
    button{background:var(--accent);color:#fff;border:none;cursor:pointer;font-weight:500}
    button.secondary{background:#fff;color:var(--ink);border:1px solid var(--border)}
    button:hover{opacity:0.9}
    
    .chip{padding:8px 10px;border-radius:999px;border:1px solid var(--border);background:#fff;color:var(--muted);font-size:12px;white-space:nowrap}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin:12px 0}
    .kpi-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin:16px 0}
    .kpi{display:flex;flex-direction:column;gap:4px;padding:12px;background:#fff;border:1px solid var(--border);border-radius:12px}
    .kpi .label{color:var(--muted);font-size:12px;font-weight:500}
    .kpi .value{font-size:24px;font-weight:700;color:var(--ink)}
    .kpi.good .value{color:var(--good)}
    .kpi.warn .value{color:var(--warn)}
    
    .line{height:1px;background:var(--border);margin:8px 0}
    .muted{color:var(--muted)}
    
    .table-wrap{overflow:auto;border:1px solid var(--border);border-radius:12px}
    table{width:100%;border-collapse:collapse;background:#fff;min-width:900px}
    thead th{
      position:sticky;top:0;background:#fafbfc;border-bottom:2px solid var(--border);
      font-weight:600;text-align:left;font-size:13px;color:var(--muted);padding:12px;z-index:1
    }
    tbody td{border-bottom:1px solid var(--border);padding:12px;font-size:14px}
    tbody tr:hover{background:#f8f9fa}
    .right{text-align:right}
    
    .card-list{display:none;gap:10px;margin-top:12px}
    .mini-card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:6px}
    .mini-line{display:flex;justify-content:space-between;gap:8px;font-size:14px}
    .mini-hl{font-weight:600}
    .chip-badge{padding:4px 8px;border-radius:4px;background:#f0f0f0;color:var(--ink);font-size:11px;display:inline-block}
    .chip-badge.iftar{background:#fff3cd;color:#856404}
    .chip-badge.sahur{background:#d1ecf1;color:#0c5460}
    
    .switcher{display:flex;gap:6px;align-items:center;white-space:nowrap;margin-left:8px}
    
    .avoid-break{page-break-inside:avoid;break-inside:avoid}
    
    /* DetaylÄ± Rapor Stilleri */
    #detayliRaporSection .card {
      page-break-inside: avoid;
      break-inside: avoid;
    }
    
    @media print{
      header{position:static;border:none}
      .toolbar{display:none!important}
      .wrap{max-width:100%;padding:0}
      .card{border:none;padding:0}
      .table-wrap{border:none}
      #detayliRaporSection .card {
        page-break-after: auto;
        margin-bottom: 20px;
      }
    }

    @media (max-width:540px){
      .table-wrap{display:none}
      .card-list{display:grid}
      input{min-width:160px}
    }
    
    header strong{font-size:clamp(16px,3.8vw,18px);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:40vw}
  </style>
</head>
<body>

<!-- APPBAR -->
<div class="appbar">
  <div class="brand" onclick="location.href='../panel.html'">
    <img src="../img/logo.png" alt="logo"><span>KARAAÄAÃ‡ FATÄ°H</span>
  </div>
  <nav class="nav-center"><ul class="nav-list" id="navMain"></ul></nav>
  <div class="nav-right">
    <button class="btn hamb" id="hamburger" title="MenÃ¼">â˜°</button>
    <div class="nav-item">
      <button class="iconbtn" id="btnProfile" title="Profil">
        <span class="avatar"></span> <span id="profName" class="muted">Profil</span>
      </button>
      <div class="dropdown drop-right" id="profDropdown">
        <a href="../diger/kullanici-yonetimi.html">ğŸ‘¤ Profil</a>
        <a href="../diger/sistem-ayarlari.html">âš™ï¸ Ayarlar</a>
        <a href="#" id="btnLogout">ğŸšª Ã‡Ä±kÄ±ÅŸ Yap</a>
      </div>
    </div>
  </div>
</div>
<aside class="drawer" id="drawer"></aside>

<header>
  <div class="wrap">
    <h2 style="margin:12px 0 8px 0;font-size:24px;font-weight:800">Ramazan-Ä± Åerif</h2>
    <div class="muted" style="margin-bottom:12px">Ä°ftar-Sahur RaporlarÄ±</div>
    <div class="toolbar">
      <select id="filtreYil">
        <option value="">YÄ±l seÃ§iniz...</option>
      </select>
      <select id="filtreTip">
        <option value="">TÃ¼m Tipler</option>
        <option value="iftar">Ä°ftar</option>
        <option value="sahur">Sahur</option>
      </select>
      <input id="ara" placeholder="Sahip / Personel ara..." />
      <select id="filtreMod">
        <option value="tum">TÃ¼m KayÄ±tlar</option>
        <option value="kendim">Sadece Kendim</option>
      </select>
      <div style="flex:1"></div>
      <label class="switcher" title="Mobilde kart gÃ¶rÃ¼nÃ¼m otomatik aÃ§Ä±lÄ±r">
        <input id="toggleKart" type="checkbox" style="accent-color:#324960" />
        <span class="muted">Kart GÃ¶rÃ¼nÃ¼m</span>
      </label>
      <button id="btnExport" class="secondary">CSV DÄ±ÅŸa Aktar</button>
      <button id="btnDetayliRapor" class="good" style="background:var(--good)">ğŸ“Š DetaylÄ± Personel Raporu (2023-2024-2025)</button>
      <button id="btnTumPersonelRapor" class="good" style="background:var(--accent)">ğŸ“‹ TÃ¼m Personel Raporu (Yurt MesulÃ¼)</button>
    </div>
  </div>
</header>

<main class="wrap" id="pdf-root">
    <!-- KPI KartlarÄ± -->
    <div class="kpi-row" id="kpiRow">
      <div class="kpi">
        <span class="label">Toplam Ä°ftar</span>
        <span class="value" id="kpiIftar">0</span>
      </div>
      <div class="kpi">
        <span class="label">Toplam Sahur</span>
        <span class="value" id="kpiSahur">0</span>
      </div>
      <div class="kpi">
        <span class="label">Toplam Tutar (â‚º)</span>
        <span class="value" id="kpiTutar">â‚º0</span>
      </div>
      <div class="kpi">
        <span class="label">Toplam MÃ¼safir</span>
        <span class="value" id="kpiMusafir">0</span>
      </div>
      <div class="kpi good">
        <span class="label">Ä°ÅŸtirak Edilen</span>
        <span class="value" id="kpiIstirak">0</span>
      </div>
      <div class="kpi">
        <span class="label">Toplam KayÄ±t</span>
        <span class="value" id="kpiToplam">0</span>
      </div>
    </div>

    <!-- Liste -->
    <div class="card">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;flex-wrap:wrap">
        <h3 style="margin:0">DetaylÄ± Liste | SeÃ§ime GÃ¶re</h3>
        <span class="muted">Veri Firestore'dan gelir; Realtime gÃ¼ncelleme aktif.</span>
      </div>

      <div class="table-wrap" id="tableWrap">
        <table id="tbl">
          <thead>
            <tr>
              <th>Tarih</th>
              <th>Tip</th>
              <th>Sahip</th>
              <th class="right">Tutar (â‚º)</th>
              <th>Ä°ÅŸtirak</th>
              <th>MÃ¼safir</th>
              <th>Mahal</th>
              <th>Personel</th>
              <th>Not</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
          <tfoot>
            <tr>
              <td colspan="3" class="right"><strong>TOPLAM</strong></td>
              <td class="right" id="sumTutar"><strong>â‚º0</strong></td>
              <td colspan="4"></td>
              <td class="right" id="sumMusafir"><strong>0</strong></td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="card-list" id="cardList"></div>
    </div>

    <!-- DetaylÄ± Personel BazlÄ± Raporlama -->
    <div class="card" id="detayliRaporSection" style="display:none">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:16px;flex-wrap:wrap">
        <h3 style="margin:0">ğŸ“Š Personel BazlÄ± DetaylÄ± Analiz Raporu (2023-2024-2025)</h3>
        <div style="flex:1"></div>
        <select id="personelSecimi" style="min-width:200px">
          <option value="">Personel SeÃ§iniz...</option>
        </select>
        <button id="btnRaporYazdir" class="good" style="background:var(--good)">ğŸ–¨ï¸ YazdÄ±r</button>
        <button id="btnRaporPDF" class="good" style="background:var(--good)">PDF'ye Aktar</button>
        <button id="btnRaporExcel" class="secondary">Excel'e Aktar</button>
      </div>
      
      <!-- Personel Analiz BÃ¶lÃ¼mÃ¼ -->
      <div id="personelAnalizContainer" style="display:none">
        <!-- Personel BaÅŸlÄ±k -->
        <div class="card" style="margin-bottom:16px;background:var(--surface2)">
          <h4 id="personelBaslik" style="margin:0;font-size:20px;color:var(--accent)"></h4>
          <div class="muted" id="personelAktifYillar" style="margin-top:4px"></div>
        </div>

        <!-- YÄ±l BazlÄ± Ã–zet -->
        <div class="card" style="margin-bottom:16px">
          <h5 style="margin:0 0 12px 0;font-size:16px">ğŸ“Š YÄ±l BazlÄ± Ã–zet</h5>
          <div id="yilBazliOzet"></div>
        </div>

        <!-- DetaylÄ± KayÄ±tlar -->
        <div class="card" style="margin-bottom:16px">
          <h5 style="margin:0 0 12px 0;font-size:16px">ğŸ“‹ DetaylÄ± KayÄ±tlar</h5>
          <div id="detayliKayitlar"></div>
        </div>

        <!-- BaÄŸÄ±ÅŸÃ§Ä± Analizi -->
        <div class="card" style="margin-bottom:16px;background:var(--surface2)">
          <h5 style="margin:0 0 12px 0;font-size:16px">ğŸ‘¥ BaÄŸÄ±ÅŸÃ§Ä± Analizi</h5>
          <div class="kpi-row" id="bagisciAnalizKPIs">
            <div class="kpi good">
              <span class="label">Daimi BaÄŸÄ±ÅŸÃ§Ä±</span>
              <span class="value" id="daimiBagisciSayisi">0</span>
              <small class="muted">3 yÄ±lda da baÄŸÄ±ÅŸ yapan</small>
            </div>
            <div class="kpi" style="background:#fff3cd">
              <span class="label">Yeni BaÄŸÄ±ÅŸÃ§Ä±</span>
              <span class="value" id="yeniBagisciSayisi">0</span>
              <small class="muted">Sadece 2025'te baÄŸÄ±ÅŸ yapan</small>
            </div>
            <div class="kpi" style="background:#f8d7da">
              <span class="label">Pasif BaÄŸÄ±ÅŸÃ§Ä±</span>
              <span class="value" id="pasifBagisciSayisi">0</span>
              <small class="muted">Ã–nceki yÄ±llarda var, 2025'te yok</small>
            </div>
          </div>
        </div>

        <!-- BaÄŸÄ±ÅŸÃ§Ä± DetaylarÄ± -->
        <div class="card" style="margin-bottom:16px">
          <h5 style="margin:0 0 12px 0;font-size:16px">ğŸ“‹ BaÄŸÄ±ÅŸÃ§Ä± DetaylarÄ± (YÄ±l YÄ±l, Tip Tip)</h5>
          <div id="bagisciDetaylari"></div>
        </div>

        <!-- BaÄŸÄ±ÅŸÃ§Ä± Ä°sim Listesi ve Kategorileri -->
        <div class="card" style="margin-bottom:16px">
          <h5 style="margin:0 0 12px 0;font-size:16px">ğŸ‘¤ BaÄŸÄ±ÅŸÃ§Ä±lar (Ä°sim BazlÄ± DetaylÄ± Analiz)</h5>
          <div id="bagisciIsimListesi"></div>
        </div>
      </div>

      <!-- Personel seÃ§ilmediÄŸinde mesaj -->
      <div id="personelSecilmediMesaj" style="text-align:center;padding:40px;color:var(--muted)">
        <p>LÃ¼tfen yukarÄ±dan bir personel seÃ§iniz.</p>
      </div>
    </div>
  </main>

  <script>
    const db = window.db;
    const auth = window.auth;
    const qs = s => document.querySelector(s);
    
    let kayitlar = [];
    let currentUser = null;
    let currentUserUid = null;

    const ayIsimleri = ['Ocak','Åubat','Mart','Nisan','MayÄ±s','Haziran','Temmuz','AÄŸustos','EylÃ¼l','Ekim','KasÄ±m','AralÄ±k'];

    /* ===== Navigation Bar ===== */
    let CURRENT_ALLOW=new Set(), CURRENT_DENY=new Set();
    const norm=(s)=> String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
    function normalizeUrl(u){ if(!u) return '#'; if(/^https?:\/\//i.test(u)) return u; if(u.startsWith('/')) return u; return '/'+u.replace(/^\.?\//,''); }

    async function fetchPanels(allowSet, denySet){
      const res=[]; try{
        const snap=await db.collection('sayfa_manifesti').get();
        snap.forEach(doc=>{
          const d=doc.data()||{}, id=doc.id, panelTitle=d.title||id;
          const panelGrant = allowSet.has(norm(id)) || allowSet.has(norm(panelTitle));
          let pages = Array.isArray(d.pages)? d.pages : [];
          pages = pages.filter(pg=>{
            const keyNorm=norm(pg.key||pg.title||'');
            const pageGrant=allowSet.has(keyNorm), denied=denySet.has(keyNorm);
            return !denied && (panelGrant || pageGrant);
          }).map(pg=>({ baslik: pg.title||pg.key||'Sayfa', url: pg.path||'#', key: pg.key||pg.title||'', sira: typeof pg.order==='number'? pg.order:9999 }))
            .sort((a,b)=>a.sira-b.sira);
          if(pages.length) res.push({ id, baslik:panelTitle, sira: typeof d.order==='number'? d.order:9999, pages });
        });
        res.sort((a,b)=>a.sira-b.sira);
      }catch(e){ console.error(e); }
      return res;
    }

    function renderNav(panels){
      const ul=document.getElementById('navMain'), drawer=document.getElementById('drawer');
      ul.innerHTML=''; drawer.innerHTML='';
      if(!panels.length){
        ul.innerHTML='<li class="nav-item"><div class="nav-btn">Panel yok</div></li>';
        drawer.innerHTML='<div class="muted" style="padding:8px">MenÃ¼ bulunamadÄ±</div>'; return;
      }
      panels.forEach(p=>{
        const li=document.createElement('li'); li.className='nav-item';
        li.innerHTML=`<div class="nav-btn">${p.baslik} <span class="caret">â–¾</span></div>`;
        const dd=document.createElement('div'); dd.className='dropdown';
        (p.pages||[]).forEach(pg=>{
          const a=document.createElement('a');
          a.href=normalizeUrl(pg.url || pg.path || '#'); a.textContent=pg.baslik;
          a.dataset.key=pg.key||pg.baslik; a.dataset.panel=p.id; a.dataset.panelTitle=p.baslik;
          dd.appendChild(a);
        });
        li.appendChild(dd);
        li.querySelector('.nav-btn').addEventListener('click',(e)=>{
          e.stopPropagation();
          ul.querySelectorAll('.nav-item').forEach(x=>{ if(x!==li) x.classList.remove('open'); });
          li.classList.toggle('open');
        });
        ul.appendChild(li);

        const h=document.createElement('div'); h.className='panel-title'; h.textContent=p.baslik; drawer.appendChild(h);
        (p.pages||[]).forEach(pg=>{
          const a=document.createElement('a');
          a.href=normalizeUrl(pg.url || pg.path || '#'); a.textContent=pg.baslik;
          a.dataset.key=pg.key||pg.baslik; a.dataset.panel=p.id; a.dataset.panelTitle=p.baslik;
          drawer.appendChild(a);
        });
      });
      document.addEventListener('click',(e)=>{ if(!ul.contains(e.target)) ul.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('open')); });
    }

    (function(){ const hamb=document.getElementById('hamburger'), drawer=document.getElementById('drawer'); if(!hamb) return; hamb.addEventListener('click',()=>drawer.classList.toggle('open')); document.addEventListener('click',(e)=>{ if(!drawer.contains(e.target) && !hamb.contains(e.target)) drawer.classList.remove('open'); }); })();

    document.addEventListener('click',(e)=>{
      const a=e.target.closest('a[data-key]'); if(!a) return;
      const key=norm(a.dataset.key), pnl=norm(a.dataset.panel||''), pnlTitle=norm(a.dataset.panelTitle||'');
      if(CURRENT_DENY.has(key)){ e.preventDefault(); return; }
      const allowed = CURRENT_ALLOW.has(key) || CURRENT_ALLOW.has(pnl) || CURRENT_ALLOW.has(pnlTitle);
      if(!allowed){ e.preventDefault(); }
    });

    (function(){
      const profBtn=document.getElementById('btnProfile'), profDD=document.getElementById('profDropdown');
      function closeAll(e){
        if(!profDD.contains(e.target)  && e.target!==profBtn)  profDD.parentElement.classList.remove('open');
      }
      document.addEventListener('click', closeAll);
      profBtn?.addEventListener('click',(e)=>{ e.stopPropagation(); profDD.parentElement.classList.toggle('open'); });
      document.getElementById('btnLogout')?.addEventListener('click', async (e) => {
        e.preventDefault();
        try { await auth.signOut(); location.assign('../../index.html'); }
        catch(err){ console.error(err); }
      });
    })();

    // Firebase Auth kontrolÃ¼
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = '../../index.html';
        return;
      }
      currentUser = user;
      currentUserUid = user.uid;
      
      // KullanÄ±cÄ± bilgilerini al
      try {
        const userDoc = await db.collection('kullanicilar').doc(user.uid).get();
        if (userDoc.exists) {
          const data = userDoc.data();
          
          // Profil adÄ±nÄ± gÃ¼ncelle
          const profNameEl = document.getElementById('profName');
          if (profNameEl) profNameEl.textContent = data.adSoyad || user.email?.split('@')[0] || 'Profil';
          
          // Yetkileri yÃ¼kle
          const rawPerms = Array.isArray(data.yetkiler) ? data.yetkiler : [];
          CURRENT_ALLOW = new Set(rawPerms.filter(s=>!String(s).trim().startsWith('-') && !String(s).trim().startsWith('!')).map(norm));
          CURRENT_DENY = new Set(rawPerms.filter(s=>String(s).trim().startsWith('-') || String(s).trim().startsWith('!')).map(s=>norm(String(s).replace(/^[-!]\s*/,''))));
          
          // Navigation render
          const panels = await fetchPanels(CURRENT_ALLOW, CURRENT_DENY);
          renderNav(panels);
        }
      } catch (e) {
        console.error('KullanÄ±cÄ± bilgisi alÄ±namadÄ±:', e);
      }
      
      // Ramazan yÄ±llarÄ±nÄ± yÃ¼kle ve yÄ±l seÃ§eneklerini gÃ¼ncelle
      await loadRamazanYillari();
      
      // Ä°lk yÃ¼kleme
      loadKayitlar();
    });

    // KayÄ±tlarÄ± yÃ¼kle (realtime listener)
    function loadKayitlar() {
      const yil = qs('#filtreYil').value;
      
      const yilRef = db.collection('ramazan_serif').doc(String(yil));
      
      // Realtime listener - anlÄ±k gÃ¼ncelleme iÃ§in
      yilRef.collection('kayitlar')
        .orderBy('tarih', 'desc')
        .onSnapshot((snap) => {
          kayitlar = snap.docs.map(d => ({ id: d.id, ...d.data() }));
          render();
        }, (err) => {
          console.error('KayÄ±tlar dinlenemedi:', err);
        });
    }

    // Render
    function render() {
      const yil = parseInt(qs('#filtreYil').value);
      const tip = qs('#filtreTip').value;
      const ara = qs('#ara').value.toLowerCase().trim();
      const mod = qs('#filtreMod').value;
      const useCards = qs('#cardList').style.display === 'grid';

      let filtered = [...kayitlar];

      // YÄ±l filtresi (zaten yÄ±l bazlÄ± yÃ¼kleniyor ama yine de kontrol)
      filtered = filtered.filter(k => k.yil === yil);

      // Tip filtresi
      if (tip) {
        filtered = filtered.filter(k => k.tip === tip);
      }

      // KullanÄ±cÄ± bazlÄ± filtre
      if (mod === 'kendim') {
        filtered = filtered.filter(k => k.personelUid === currentUserUid);
      }

      // Arama filtresi
      if (ara) {
        filtered = filtered.filter(k =>
          (k.sahip || '').toLowerCase().includes(ara) ||
          (k.personel || '').toLowerCase().includes(ara)
        );
      }

      // KPI gÃ¼ncelle
      const iftarSayisi = filtered.filter(k => k.tip === 'iftar').length;
      const sahurSayisi = filtered.filter(k => k.tip === 'sahur').length;
      const toplamTutar = filtered.reduce((sum, k) => sum + (Number(k.tutar) || 0), 0);
      const toplamMusafir = filtered.reduce((sum, k) => sum + (Number(k.musafirAdedi) || 0), 0);
      const istirakSayisi = filtered.filter(k => k.istirak).length;

      qs('#kpiIftar').textContent = iftarSayisi;
      qs('#kpiSahur').textContent = sahurSayisi;
      qs('#kpiTutar').textContent = 'â‚º' + toplamTutar.toLocaleString('tr-TR', { minimumFractionDigits: 2 });
      qs('#kpiMusafir').textContent = toplamMusafir;
      qs('#kpiIstirak').textContent = istirakSayisi;
      qs('#kpiToplam').textContent = filtered.length;

      // Tablo/Kart render
      if (!useCards) {
        const tbody = qs('#tbody');
        tbody.innerHTML = '';

        if (filtered.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;color:var(--muted);padding:20px">KayÄ±t bulunamadÄ±</td></tr>';
          qs('#sumTutar').textContent = 'â‚º0';
          qs('#sumMusafir').textContent = '0';
          return;
        }

        filtered.forEach(k => {
          const tr = document.createElement('tr');
          // Firestore Timestamp kontrolÃ¼
          let tarihStr = '';
          if(k.tarih) {
            if(k.tarih.toDate) {
              tarihStr = k.tarih.toDate().toISOString().slice(0, 10);
            } else if(k.tarih instanceof Date) {
              tarihStr = k.tarih.toISOString().slice(0, 10);
            } else if(typeof k.tarih === 'string') {
              tarihStr = k.tarih.slice(0, 10);
            } else if(k.tarih.seconds) {
              // Timestamp objesi (seconds property var)
              tarihStr = new Date(k.tarih.seconds * 1000).toISOString().slice(0, 10);
            }
          }
          const tarih = tarihStr ? new Date(tarihStr) : new Date();

          tr.innerHTML = `
            <td>${tarih.getDate()}.${tarih.getMonth() + 1}.${tarih.getFullYear()}</td>
            <td><span class="chip-badge ${k.tip}">${k.tip === 'iftar' ? 'ğŸŒ™ Ä°ftar' : 'ğŸŒŸ Sahur'}</span></td>
            <td><strong>${k.sahip || '-'}</strong></td>
            <td class="right"><strong>â‚º${Number(k.tutar || 0).toLocaleString('tr-TR',{minimumFractionDigits:2})}</strong></td>
            <td>${k.istirak ? 'âœ“ Evet' : 'âœ— HayÄ±r'}</td>
            <td>${k.musafirAdedi || 0}</td>
            <td>${k.mahal || '-'}</td>
            <td>${k.personelAdi || k.personel || '-'}</td>
            <td style="max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${k.not || ''}">${k.not || '-'}</td>
          `;
          tbody.appendChild(tr);
        });

        qs('#sumTutar').innerHTML = '<strong>â‚º' + toplamTutar.toLocaleString('tr-TR',{minimumFractionDigits:2}) + '</strong>';
        qs('#sumMusafir').innerHTML = '<strong>' + toplamMusafir + '</strong>';
      } else {
        // Kart gÃ¶rÃ¼nÃ¼mÃ¼
        const list = qs('#cardList');
        list.innerHTML = '';

        if (filtered.length === 0) {
          list.innerHTML = '<div style="text-align:center;color:var(--muted);padding:20px">KayÄ±t bulunamadÄ±</div>';
          return;
        }

        filtered.forEach(k => {
          // Firestore Timestamp kontrolÃ¼
          let tarihStr = '';
          if(k.tarih) {
            if(k.tarih.toDate) {
              tarihStr = k.tarih.toDate().toISOString().slice(0, 10);
            } else if(k.tarih instanceof Date) {
              tarihStr = k.tarih.toISOString().slice(0, 10);
            } else if(typeof k.tarih === 'string') {
              tarihStr = k.tarih.slice(0, 10);
            } else if(k.tarih.seconds) {
              tarihStr = new Date(k.tarih.seconds * 1000).toISOString().slice(0, 10);
            }
          }
          const tarih = tarihStr ? new Date(tarihStr) : new Date();
          const div = document.createElement('div');
          div.className = 'mini-card';
          div.innerHTML = `
            <div class="mini-line">
              <span class="mini-hl">${tarih.getDate()}.${tarih.getMonth() + 1}.${tarih.getFullYear()}</span>
              <span class="chip-badge ${k.tip}">${k.tip === 'iftar' ? 'ğŸŒ™ Ä°ftar' : 'ğŸŒŸ Sahur'}</span>
            </div>
            <div class="mini-line">
              <span>Sahip</span>
              <span class="mini-hl">${k.sahip || '-'}</span>
            </div>
            <div class="mini-line">
              <span>Tutar</span>
              <span class="mini-hl">â‚º${Number(k.tutar || 0).toLocaleString('tr-TR',{minimumFractionDigits:2})}</span>
            </div>
            <div class="mini-line">
              <span>Ä°ÅŸtirak</span>
              <span>${k.istirak ? 'âœ“ Evet' : 'âœ— HayÄ±r'}</span>
            </div>
            <div class="mini-line">
              <span>MÃ¼safir</span>
              <span>${k.musafirAdedi || 0}</span>
            </div>
            ${k.mahal ? `<div class="mini-line">
              <span>Mahal</span>
              <span>${k.mahal}</span>
            </div>` : ''}
            <div class="mini-line">
              <span>Personel</span>
              <span>${k.personelAdi || k.personel || '-'}</span>
            </div>
            ${k.not ? `<div class="mini-line">
              <span>Not</span>
              <span style="font-size:11px; color:var(--muted);">${k.not}</span>
            </div>` : ''}
          `;
          list.appendChild(div);
        });
      }
    }

    // Kart gÃ¶rÃ¼nÃ¼m toggle
    function toggleView() {
      const useCards = qs('#toggleKart').checked || window.innerWidth <= 540;
      qs('#tableWrap').style.display = useCards ? 'none' : 'block';
      qs('#cardList').style.display = useCards ? 'grid' : 'none';
      render();
    }

    qs('#toggleKart').addEventListener('change', toggleView);
    window.addEventListener('resize', () => {
      if (window.innerWidth <= 540) {
        qs('#toggleKart').checked = true;
        toggleView();
      }
    });

    // Ä°lk yÃ¼kleme
    if (window.innerWidth <= 540) {
      qs('#toggleKart').checked = true;
    }

    // Filtre deÄŸiÅŸiklikleri
    // Ramazan yÄ±llarÄ±nÄ± yÃ¼kle ve yÄ±l seÃ§eneklerini gÃ¼ncelle
    async function loadRamazanYillari() {
      try {
        const snap = await db.collection('ramazan_serif').doc('ayarlar').collection('yillar').orderBy('yil', 'desc').get();
        const yillar = snap.docs.map(d => d.data().yil);
        
        // Filtre yÄ±l seÃ§eneklerini gÃ¼ncelle
        const select = qs('#filtreYil');
        if (select) {
          const currentValue = select.value;
          select.innerHTML = '';
          
          yillar.forEach(yil => {
            const opt = document.createElement('option');
            opt.value = yil;
            opt.textContent = `${yil} Ramazan-Ä± Åerif`;
            select.appendChild(opt);
          });
          
          // Aktif yÄ±l varsa onu seÃ§
          const aktifSnap = await db.collection('ramazan_serif').doc('ayarlar').collection('yillar').where('aktif', '==', true).limit(1).get();
          if (!aktifSnap.empty) {
            const aktifYil = aktifSnap.docs[0].data().yil;
            select.value = aktifYil;
          } else if (currentValue && yillar.includes(parseInt(currentValue))) {
            select.value = currentValue;
          } else if (yillar.length > 0) {
            select.value = yillar[0];
          }
        }
      } catch (e) {
        console.error('Ramazan yÄ±llarÄ± yÃ¼klenemedi:', e);
      }
    }

    ['#filtreYil', '#filtreTip', '#filtreMod'].forEach(sel => {
      qs(sel).addEventListener('change', () => {
        if (sel === '#filtreYil') {
          loadKayitlar();
        } else {
          render();
        }
      });
    });

    qs('#ara').addEventListener('input', render);

    // CSV Export
    qs('#btnExport').addEventListener('click', () => {
      const yil = qs('#filtreYil').value;
      const tip = qs('#filtreTip').value;
      const ara = qs('#ara').value.toLowerCase().trim();
      const mod = qs('#filtreMod').value;

      let filtered = [...kayitlar];
      filtered = filtered.filter(k => k.yil === parseInt(yil));
      if (tip) filtered = filtered.filter(k => k.tip === tip);
      if (mod === 'kendim') filtered = filtered.filter(k => k.personelUid === currentUserUid);
      if (ara) {
        filtered = filtered.filter(k =>
          (k.sahip || '').toLowerCase().includes(ara) ||
          (k.personel || '').toLowerCase().includes(ara)
        );
      }

      const rows = [['Tarih', 'Tip', 'Sahip', 'Tutar', 'Ä°ÅŸtirak', 'MÃ¼safirAdedi', 'Personel']];

      filtered.forEach(k => {
        const tarihStr = k.tarih instanceof Date ? k.tarih.toISOString().slice(0, 10) : k.tarih;
        rows.push([
          tarihStr,
          k.tip || '',
          k.sahip || '',
          k.tutar || 0,
          k.istirak ? 'Evet' : 'HayÄ±r',
          k.musafirAdedi || 0,
          k.personel || ''
        ]);
      });

      const csv = rows.map(r => r.map(cell => {
        const str = String(cell);
        return str.includes(',') || str.includes('"') || str.includes('\n')
          ? `"${str.replace(/"/g, '""')}"`
          : str;
      }).join(',')).join('\n');

      const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `iftar-sahur-rapor-${yil}-ramazan-serif.csv`;
      link.click();
    });

    // TÃ¼m Personel Raporu butonu
    qs('#btnTumPersonelRapor').addEventListener('click', async () => {
      try {
        // Ã–nce detaylÄ± rapor bÃ¶lÃ¼mÃ¼nÃ¼ aÃ§
        const section = qs('#detayliRaporSection');
        if (section.style.display === 'none') {
          section.style.display = 'block';
          section.scrollIntoView({ behavior: 'smooth' });
        }
        
        // Verileri yÃ¼kle
        await loadAllYearsData();
        
        // Analiz yap
        if (!analizData) {
          analizData = analizPersonelVerileri();
        }
        
        // Veri kontrolÃ¼
        if (!analizData || !analizData.personeller || Object.keys(analizData.personeller).length === 0) {
          alert('Personel verisi bulunamadÄ±. LÃ¼tfen Ã¶nce verilerin yÃ¼klendiÄŸinden emin olun.');
          return;
        }
        
        // TÃ¼m personeller iÃ§in rapor verisi hazÄ±rla
        const tumPersonelRaporData = {
          personeller: {},
          toplamlar: {
            2023: 0,
            2024: 0,
            2025: 0
          },
          genelBagisciAnaliz: {
            daimi: [],
            yeni: [],
            pasif: []
          }
        };
        
        // Her personel iÃ§in veri hazÄ±rla
        Object.keys(analizData.personeller).forEach(personelAdi => {
          const personel = analizData.personeller[personelAdi];
          const bagisciAnaliz = analizBagisciPersonel(analizData.bagiscilar, personelAdi);
          
          // Personel verilerini hazÄ±rla
          tumPersonelRaporData.personeller[personelAdi] = {
            adi: personel.adi,
            yillar: Array.from(personel.yillar).sort(),
            veriler: {},
            bagisciAnaliz: {
              daimi: bagisciAnaliz.daimi || [],
              yeni: bagisciAnaliz.yeni || [],
              pasif: bagisciAnaliz.pasif || []
            }
          };
          
          // Veriler objesini serialize edilebilir hale getir
          Object.keys(personel.veriler).forEach(yilStr => {
            const yil = parseInt(yilStr);
            tumPersonelRaporData.personeller[personelAdi].veriler[yil] = {
              iftar: (personel.veriler[yil].iftar || []).map(v => ({
                sahip: v.sahip || '',
                tutar: Number(v.tutar) || 0,
                tarih: v.tarih || null,
                referans: v.referans || '',
                diger: v.diger || ''
              })),
              sahur: (personel.veriler[yil].sahur || []).map(v => ({
                sahip: v.sahip || '',
                tutar: Number(v.tutar) || 0,
                tarih: v.tarih || null,
                referans: v.referans || '',
                diger: v.diger || ''
              })),
              taahhut: (personel.veriler[yil].taahhut || []).map(v => ({
                sahip: v.sahip || '',
                tutar: Number(v.tutar) || 0,
                tarih: v.tarih || null,
                referans: v.referans || '',
                diger: v.diger || ''
              })),
              teberru: (personel.veriler[yil].teberru || []).map(v => ({
                sahip: v.sahip || '',
                tutar: Number(v.tutar) || 0,
                tarih: v.tarih || null,
                referans: v.referans || '',
                diger: v.diger || ''
              }))
            };
            
            // ToplamlarÄ± hesapla
            ['iftar', 'sahur', 'taahhut', 'teberru'].forEach(tip => {
              const veriler = tumPersonelRaporData.personeller[personelAdi].veriler[yil][tip] || [];
              tumPersonelRaporData.toplamlar[yil] += veriler.reduce((sum, v) => sum + (v.tutar || 0), 0);
            });
          });
        });
        
        // Genel baÄŸÄ±ÅŸÃ§Ä± analizi (tÃ¼m personeller iÃ§in)
        Object.keys(analizData.bagiscilar).forEach(sahip => {
          const bagisci = analizData.bagiscilar[sahip];
          const yillar = Array.from(bagisci.yillar).sort();
          
          if (yillar.length === 3 && yillar.includes(2023) && yillar.includes(2024) && yillar.includes(2025)) {
            if (!tumPersonelRaporData.genelBagisciAnaliz.daimi.includes(sahip)) {
              tumPersonelRaporData.genelBagisciAnaliz.daimi.push(sahip);
            }
          } else if (yillar.length === 1 && yillar.includes(2025)) {
            if (!tumPersonelRaporData.genelBagisciAnaliz.yeni.includes(sahip)) {
              tumPersonelRaporData.genelBagisciAnaliz.yeni.push(sahip);
            }
          } else if (!yillar.includes(2025) && (yillar.includes(2023) || yillar.includes(2024))) {
            if (!tumPersonelRaporData.genelBagisciAnaliz.pasif.includes(sahip)) {
              tumPersonelRaporData.genelBagisciAnaliz.pasif.push(sahip);
            }
          }
        });
        
        // SÄ±ralama
        tumPersonelRaporData.genelBagisciAnaliz.daimi.sort((a, b) => a.localeCompare(b, 'tr-TR'));
        tumPersonelRaporData.genelBagisciAnaliz.yeni.sort((a, b) => a.localeCompare(b, 'tr-TR'));
        tumPersonelRaporData.genelBagisciAnaliz.pasif.sort((a, b) => a.localeCompare(b, 'tr-TR'));
        
        // Verileri localStorage'a kaydet
        const storageKey = 'tumPersonelRaporData_' + Date.now();
        localStorage.setItem(storageKey, JSON.stringify(tumPersonelRaporData));
        
        // Yeni pencerede aÃ§
        const printUrl = `ramazanÄ±seriftÃ¼mraporyazdÄ±r.html?key=${storageKey}`;
        window.open(printUrl, '_blank');
      } catch (e) {
        console.error('TÃ¼m personel raporu oluÅŸturulurken hata:', e);
        alert('Rapor oluÅŸturulurken bir hata oluÅŸtu: ' + e.message);
      }
    });

    /* ===== DetaylÄ± Personel BazlÄ± Raporlama (2023-2024-2025) ===== */
    
    // YardÄ±mcÄ± fonksiyonlar
    function normalizePersonelName(name) {
      if (!name) return '';
      const trimmed = String(name).trim();
      if (!trimmed) return '';
      // TÃ¼rkÃ§e karakter desteÄŸi ile bÃ¼yÃ¼k harf
      return trimmed.toLocaleUpperCase('tr-TR');
    }
    
    function normalizeTurkish(str) {
      if (!str) return '';
      return String(str).toLocaleLowerCase('tr-TR').trim();
    }

    let allYearsData = {}; // 2023, 2024, 2025 verileri
    
    // TÃ¼m yÄ±llarÄ±n verilerini yÃ¼kle (analiz collection'Ä±ndan)
    async function loadAllYearsData() {
      allYearsData = {};
      const yillar = [2023, 2024, 2025];
      
      for (const yil of yillar) {
        try {
          // Ã–nce analiz collection'Ä±ndan dene (personel/referans bilgileri burada)
          const analizSnap = await db.collection('ramazan_serif').doc('analiz').collection('veriler')
            .where('yil', '==', yil)
            .get();
          
          let veriler = [];
          
          if (!analizSnap.empty) {
            // Analiz collection'Ä±ndan veri var
            veriler = analizSnap.docs.map(d => {
              const data = d.data();
              return {
                id: d.id,
                yil: data.yil || yil,
                tip: data.tip || '',
                sahip: data.sahip || '',
                tutar: Number(data.tutar) || 0,
                referans: data.referans || '',
                personel: data.personel || data.referans || '',
                diger: data.diger || '',
                tarih: data.tarih || null
              };
            });
          } else {
            // Analiz collection'Ä±nda yoksa kayitlar collection'Ä±ndan dene
            console.log(`${yil} iÃ§in analiz verisi yok, kayitlar collection'Ä±ndan yÃ¼kleniyor...`);
            const kayitlarSnap = await db.collection('ramazan_serif').doc(String(yil)).collection('kayitlar').get();
            
            veriler = kayitlarSnap.docs.map(d => {
              const data = d.data();
              return {
                id: d.id,
                yil: data.yil || yil,
                tip: data.tip || '',
                sahip: data.sahip || '',
                tutar: Number(data.tutar) || 0,
                referans: data.referans || '',
                personel: data.personel || data.referans || '',
                diger: data.diger || '',
                tarih: data.tarih || null
              };
            });
          }
          
          allYearsData[yil] = veriler;
          console.log(`${yil} yÄ±lÄ± iÃ§in ${veriler.length} kayÄ±t yÃ¼klendi`);
        } catch (e) {
          console.error(`${yil} yÄ±lÄ± verileri yÃ¼klenemedi:`, e);
          allYearsData[yil] = [];
        }
      }
    }

    // Personel bazlÄ± verileri analiz et (genel/hususi ayrÄ±mÄ± yok)
    function analizPersonelVerileri() {
      const personeller = {};
      const bagiscilar = {}; // TÃ¼m baÄŸÄ±ÅŸÃ§Ä±lar (sahip)
      let personelAdiYokSayisi = 0;
      let toplamIslenen = 0;
      
      // Her yÄ±l iÃ§in veri iÅŸle
      Object.keys(allYearsData).forEach(yilStr => {
        const yil = parseInt(yilStr);
        const veriler = allYearsData[yil] || [];
        
        veriler.forEach(v => {
          toplamIslenen++;
          
          // BaÄŸÄ±ÅŸÃ§Ä± takibi (sahip)
          const sahip = (v.sahip || '').trim();
          if (sahip) {
            if (!bagiscilar[sahip]) {
              bagiscilar[sahip] = { yillar: new Set(), personeller: new Set() };
            }
            bagiscilar[sahip].yillar.add(yil);
          }
          
          // Personel belirleme
          let rawPersonel = v.personel || v.referans || '';
          if (v.referans && normalizeTurkish(v.referans) === 'diÄŸer') {
            rawPersonel = 'DÄ°ÄER';
          }
          const personelAdi = normalizePersonelName(rawPersonel);
          
          if (!personelAdi) {
            personelAdiYokSayisi++;
            return;
          }
          
          // BaÄŸÄ±ÅŸÃ§Ä±ya personel ekle
          if (sahip) {
            bagiscilar[sahip].personeller.add(personelAdi);
          }
          
          // Personel yapÄ±sÄ±nÄ± oluÅŸtur (genel/hususi ayrÄ±mÄ± yok)
          if (!personeller[personelAdi]) {
            personeller[personelAdi] = {
              adi: personelAdi,
              veriler: {}, // { 2023: { iftar: [], sahur: [], taahhut: [], teberru: [] }, ... }
              yillar: new Set(),
              bagiscilar: new Set() // Bu personele ait baÄŸÄ±ÅŸÃ§Ä±lar
            };
          }
          
          personeller[personelAdi].yillar.add(yil);
          
          if (!personeller[personelAdi].veriler[yil]) {
            personeller[personelAdi].veriler[yil] = {
              iftar: [],
              sahur: [],
              taahhut: [],
              teberru: []
            };
          }
          
          const tip = (v.tip || '').toLowerCase();
          if (['iftar', 'sahur', 'taahhut', 'teberru'].includes(tip)) {
            personeller[personelAdi].veriler[yil][tip].push({
              sahip: v.sahip || '',
              tutar: Number(v.tutar) || 0,
              tarih: v.tarih,
              referans: v.referans || '',
              diger: v.diger || ''
            });
            
            if (sahip) {
              personeller[personelAdi].bagiscilar.add(sahip);
            }
          }
        });
      });
      
      console.log('Analiz sonuÃ§larÄ±:', {
        toplamIslenen: toplamIslenen,
        personelAdiYokSayisi: personelAdiYokSayisi,
        personelSayisi: Object.keys(personeller).length,
        bagisciSayisi: Object.keys(bagiscilar).length,
        personelListesi: Object.keys(personeller)
      });
      
      return { personeller, bagiscilar };
    }

    // BaÄŸÄ±ÅŸÃ§Ä± analizi (belirli bir personel iÃ§in)
    function analizBagisciPersonel(bagiscilar, personelAdi) {
      const daimi = [];
      const yeni = [];
      const pasif = [];
      
      Object.keys(bagiscilar).forEach(sahip => {
        const bagisci = bagiscilar[sahip];
        // Sadece bu personele ait baÄŸÄ±ÅŸÃ§Ä±larÄ± kontrol et
        if (!bagisci.personeller.has(personelAdi)) return;
        
        const yillar = Array.from(bagisci.yillar).sort();
        
        if (yillar.length === 3 && yillar.includes(2023) && yillar.includes(2024) && yillar.includes(2025)) {
          daimi.push(sahip);
        } else if (yillar.length === 1 && yillar.includes(2025)) {
          yeni.push(sahip);
        } else if (!yillar.includes(2025) && (yillar.includes(2023) || yillar.includes(2024))) {
          pasif.push(sahip);
        }
      });
      
      return { daimi, yeni, pasif };
    }

    let analizData = null; // Global analiz verisi
    
    // Personel seÃ§im listesini doldur
    function doldurPersonelListesi(personeller) {
      const select = qs('#personelSecimi');
      select.innerHTML = '<option value="">Personel SeÃ§iniz...</option>';
      
      const personelListesi = Object.values(personeller).sort((a, b) => 
        a.adi.localeCompare(b.adi, 'tr-TR')
      );
      
      personelListesi.forEach(personel => {
        const option = document.createElement('option');
        option.value = personel.adi;
        option.textContent = personel.adi;
        select.appendChild(option);
      });
    }
    
    // SeÃ§ilen personelin raporunu render et
    function renderPersonelRaporu(personelAdi, { personeller, bagiscilar }) {
      const personel = personeller[personelAdi];
      if (!personel) {
        qs('#personelAnalizContainer').style.display = 'none';
        qs('#personelSecilmediMesaj').style.display = 'block';
        return;
      }
      
      qs('#personelSecilmediMesaj').style.display = 'none';
      qs('#personelAnalizContainer').style.display = 'block';
      
      // Personel baÅŸlÄ±k
      qs('#personelBaslik').textContent = personel.adi;
      qs('#personelAktifYillar').textContent = `Aktif YÄ±llar: ${Array.from(personel.yillar).sort().join(', ')}`;
      
      // YÄ±l bazlÄ± Ã¶zet
      renderYilBazliOzet(personel);
      
      // DetaylÄ± kayÄ±tlar
      renderDetayliKayitlar(personel);
      
      // BaÄŸÄ±ÅŸÃ§Ä± analizi
      const bagisciAnaliz = analizBagisciPersonel(bagiscilar, personelAdi);
      qs('#daimiBagisciSayisi').textContent = bagisciAnaliz.daimi.length;
      qs('#yeniBagisciSayisi').textContent = bagisciAnaliz.yeni.length;
      qs('#pasifBagisciSayisi').textContent = bagisciAnaliz.pasif.length;
      
      // BaÄŸÄ±ÅŸÃ§Ä± detaylarÄ±
      renderBagisciDetaylari(personel, bagiscilar, personelAdi);
      
      // BaÄŸÄ±ÅŸÃ§Ä± isim listesi ve kategorileri
      renderBagisciIsimListesi(personel, bagiscilar, personelAdi, bagisciAnaliz);
      
      // BaÄŸÄ±ÅŸÃ§Ä± isim listesi ve kategorileri
      renderBagisciIsimListesi(personel, bagiscilar, personelAdi, bagisciAnaliz);
    }
    
    // BaÄŸÄ±ÅŸÃ§Ä± detaylarÄ± render (yÄ±l yÄ±l, tip tip)
    function renderBagisciDetaylari(personel, bagiscilar, personelAdi) {
      const container = qs('#bagisciDetaylari');
      const yillar = [2023, 2024, 2025];
      const tipler = [
        { key: 'iftar', label: 'Ä°ftar', icon: 'ğŸŒ™' },
        { key: 'sahur', label: 'Sahur', icon: 'ğŸŒŸ' },
        { key: 'taahhut', label: 'TaahhÃ¼t', icon: 'ğŸ“‹' },
        { key: 'teberru', label: 'Teberru', icon: 'ğŸ’' }
      ];
      
      let html = '';
      
      yillar.forEach(yil => {
        const yilData = personel.veriler[yil] || {};
        
        html += `
          <div style="margin-bottom:24px;padding:16px;background:var(--surface2);border-radius:8px;border-left:4px solid var(--accent)">
            <h6 style="margin:0 0 16px 0;font-size:18px;color:var(--accent);font-weight:700">${yil} YÄ±lÄ±</h6>
        `;
        
        tipler.forEach(tip => {
          const veriler = yilData[tip.key] || [];
          if (veriler.length === 0) return;
          
          // BaÄŸÄ±ÅŸÃ§Ä±lara gÃ¶re grupla
          const bagisciMap = {};
          veriler.forEach(v => {
            const sahip = (v.sahip || '').trim();
            if (!sahip) return;
            
            if (!bagisciMap[sahip]) {
              bagisciMap[sahip] = {
                isim: sahip,
                toplamTutar: 0,
                kayitSayisi: 0
              };
            }
            
            bagisciMap[sahip].toplamTutar += Number(v.tutar) || 0;
            bagisciMap[sahip].kayitSayisi++;
          });
          
          // BaÄŸÄ±ÅŸÃ§Ä±larÄ± tutara gÃ¶re sÄ±rala
          const bagisciListesi = Object.values(bagisciMap).sort((a, b) => b.toplamTutar - a.toplamTutar);
          
          if (bagisciListesi.length === 0) return;
          
          const tipToplam = bagisciListesi.reduce((sum, b) => sum + b.toplamTutar, 0);
          
          html += `
            <div style="margin-bottom:16px;padding:12px;background:#fff;border-radius:8px">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding-bottom:8px;border-bottom:2px solid var(--border)">
                <div style="display:flex;align-items:center;gap:8px">
                  <span style="font-size:20px">${tip.icon}</span>
                  <span style="font-weight:700;font-size:16px;color:var(--accent)">${tip.label}</span>
                </div>
                <div style="text-align:right">
                  <div style="font-weight:700;font-size:16px;color:var(--accent)">â‚º${tipToplam.toLocaleString('tr-TR', {minimumFractionDigits:2})}</div>
                  <div style="font-size:12px;color:var(--muted)">${bagisciListesi.length} baÄŸÄ±ÅŸÃ§Ä± | ${veriler.length} kayÄ±t</div>
                </div>
              </div>
              <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(250px,1fr));gap:8px">
          `;
          
          bagisciListesi.forEach(bagisci => {
            html += `
              <div style="padding:10px;background:var(--surface2);border-radius:6px;border:1px solid var(--border)">
                <div style="font-weight:600;font-size:14px;margin-bottom:4px;color:var(--ink)">${bagisci.isim}</div>
                <div style="font-weight:700;font-size:15px;color:var(--accent)">â‚º${bagisci.toplamTutar.toLocaleString('tr-TR', {minimumFractionDigits:2})}</div>
                <div style="font-size:11px;color:var(--muted);margin-top:2px">${bagisci.kayitSayisi} kayÄ±t</div>
              </div>
            `;
          });
          
          html += `
              </div>
            </div>
          `;
        });
        
        html += '</div>';
      });
      
      container.innerHTML = html || '<div class="muted" style="text-align:center;padding:20px">BaÄŸÄ±ÅŸÃ§Ä± detayÄ± bulunamadÄ±</div>';
    }
    
    // BaÄŸÄ±ÅŸÃ§Ä± isim listesi ve kategorileri render
    function renderBagisciIsimListesi(personel, bagiscilar, personelAdi, bagisciAnaliz) {
      const container = qs('#bagisciIsimListesi');
      const yillar = [2023, 2024, 2025];
      const tipler = [
        { key: 'iftar', label: 'Ä°ftar', icon: 'ğŸŒ™' },
        { key: 'sahur', label: 'Sahur', icon: 'ğŸŒŸ' },
        { key: 'taahhut', label: 'TaahhÃ¼t', icon: 'ğŸ“‹' },
        { key: 'teberru', label: 'Teberru', icon: 'ğŸ’' }
      ];
      
      // TÃ¼m baÄŸÄ±ÅŸÃ§Ä±larÄ± birleÅŸtir (daimi, yeni, pasif)
      // Ã–nce kategoriye gÃ¶re sÄ±rala (daimi: 0, yeni: 1, pasif: 2), sonra isme gÃ¶re alfabetik
      const kategoriSira = { 'daimi': 0, 'yeni': 1, 'pasif': 2 };
      const tumBagiscilar = [
        ...bagisciAnaliz.daimi.map(isim => ({ isim, kategori: 'daimi', label: 'Daimi BaÄŸÄ±ÅŸÃ§Ä±', renk: '#2d6a4f' })),
        ...bagisciAnaliz.yeni.map(isim => ({ isim, kategori: 'yeni', label: 'Yeni BaÄŸÄ±ÅŸÃ§Ä±', renk: '#fff3cd' })),
        ...bagisciAnaliz.pasif.map(isim => ({ isim, kategori: 'pasif', label: 'Pasif BaÄŸÄ±ÅŸÃ§Ä±', renk: '#f8d7da' }))
      ].sort((a, b) => {
        // Ã–nce kategoriye gÃ¶re sÄ±rala
        const kategoriFarki = kategoriSira[a.kategori] - kategoriSira[b.kategori];
        if (kategoriFarki !== 0) return kategoriFarki;
        // AynÄ± kategorideyse isme gÃ¶re alfabetik sÄ±rala
        return a.isim.localeCompare(b.isim, 'tr-TR');
      });
      
      if (tumBagiscilar.length === 0) {
        container.innerHTML = '<div class="muted" style="text-align:center;padding:20px">BaÄŸÄ±ÅŸÃ§Ä± bulunamadÄ±</div>';
        return;
      }
      
      let html = '';
      
      tumBagiscilar.forEach(({ isim, kategori, label, renk }) => {
        // Bu baÄŸÄ±ÅŸÃ§Ä±nÄ±n yÄ±l yÄ±l, tip tip verilerini topla
        const bagisciVerileri = {};
        let toplamGenelTutar = 0;
        let toplamGenelKayit = 0;
        
        yillar.forEach(yil => {
          bagisciVerileri[yil] = { iftar: { tutar: 0, kayit: 0 }, sahur: { tutar: 0, kayit: 0 }, taahhut: { tutar: 0, kayit: 0 }, teberru: { tutar: 0, kayit: 0 } };
          
          tipler.forEach(tip => {
            const veriler = (personel.veriler[yil] || {})[tip.key] || [];
            const bagisciKayitlari = veriler.filter(v => (v.sahip || '').trim() === isim);
            
            if (bagisciKayitlari.length > 0) {
              const toplamTutar = bagisciKayitlari.reduce((sum, v) => sum + (v.tutar || 0), 0);
              bagisciVerileri[yil][tip.key] = {
                tutar: toplamTutar,
                kayit: bagisciKayitlari.length
              };
              toplamGenelTutar += toplamTutar;
              toplamGenelKayit += bagisciKayitlari.length;
            }
          });
        });
        
        html += `
          <div style="margin-bottom:24px;padding:16px;background:var(--surface2);border-radius:8px;border-left:4px solid ${renk}">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;flex-wrap:wrap;gap:8px">
              <div>
                <h6 style="margin:0;font-size:18px;color:var(--accent);font-weight:700">${isim}</h6>
                <div style="margin-top:4px;padding:4px 10px;border-radius:6px;background:${renk};display:inline-block;font-size:12px;font-weight:600;color:${kategori === 'daimi' ? '#fff' : '#856404'}">${label}</div>
              </div>
              <div style="text-align:right">
                <div style="font-weight:700;font-size:16px;color:var(--accent)">â‚º${toplamGenelTutar.toLocaleString('tr-TR', {minimumFractionDigits:2})}</div>
                <div style="font-size:12px;color:var(--muted)">${toplamGenelKayit} kayÄ±t</div>
              </div>
            </div>
            
            <div style="margin-top:16px">
        `;
        
        yillar.forEach(yil => {
          const yilVerileri = bagisciVerileri[yil];
          const yilToplam = tipler.reduce((sum, tip) => sum + (yilVerileri[tip.key].tutar || 0), 0);
          const yilKayit = tipler.reduce((sum, tip) => sum + (yilVerileri[tip.key].kayit || 0), 0);
          
          if (yilToplam === 0 && yilKayit === 0) return;
          
          html += `
            <div style="margin-bottom:16px;padding:12px;background:#fff;border-radius:8px;border:1px solid var(--border)">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding-bottom:8px;border-bottom:2px solid var(--border)">
                <div style="font-weight:700;font-size:16px;color:var(--accent)">${yil} YÄ±lÄ±</div>
                <div style="text-align:right">
                  <div style="font-weight:700;font-size:15px;color:var(--accent)">â‚º${yilToplam.toLocaleString('tr-TR', {minimumFractionDigits:2})}</div>
                  <div style="font-size:12px;color:var(--muted)">${yilKayit} kayÄ±t</div>
                </div>
              </div>
              
              <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:8px">
          `;
          
          tipler.forEach(tip => {
            const tipData = yilVerileri[tip.key];
            if (tipData.tutar === 0 && tipData.kayit === 0) return;
            
            html += `
              <div style="padding:10px;background:var(--surface2);border-radius:6px;border:1px solid var(--border)">
                <div style="display:flex;align-items:center;gap:6px;margin-bottom:6px">
                  <span style="font-size:18px">${tip.icon}</span>
                  <span style="font-weight:600;font-size:14px;color:var(--ink)">${tip.label}</span>
                </div>
                <div style="font-weight:700;font-size:15px;color:var(--accent)">â‚º${tipData.tutar.toLocaleString('tr-TR', {minimumFractionDigits:2})}</div>
                <div style="font-size:11px;color:var(--muted);margin-top:2px">${tipData.kayit} kayÄ±t</div>
              </div>
            `;
          });
          
          html += `
              </div>
            </div>
          `;
        });
        
        html += `
            </div>
          </div>
        `;
      });
      
      container.innerHTML = html;
    }
    
    // YÄ±l bazlÄ± Ã¶zet render
    function renderYilBazliOzet(personel) {
      const container = qs('#yilBazliOzet');
      const yillar = [2023, 2024, 2025];
      const tipler = [
        { key: 'iftar', label: 'Ä°ftar', icon: 'ğŸŒ™' },
        { key: 'sahur', label: 'Sahur', icon: 'ğŸŒŸ' },
        { key: 'taahhut', label: 'TaahhÃ¼t', icon: 'ğŸ“‹' },
        { key: 'teberru', label: 'Teberru', icon: 'ğŸ’' }
      ];
      
      let html = '<div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px">';
      
      yillar.forEach(yil => {
        const yilData = personel.veriler[yil] || {};
        let yilToplamTutar = 0;
        let yilToplamKayit = 0;
        
        tipler.forEach(tip => {
          const veriler = yilData[tip.key] || [];
          yilToplamTutar += veriler.reduce((sum, v) => sum + (v.tutar || 0), 0);
          yilToplamKayit += veriler.length;
        });
        
        html += `
          <div style="padding:12px;background:var(--surface2);border-radius:8px;text-align:center">
            <div style="font-size:13px;color:var(--muted);margin-bottom:6px;font-weight:600">${yil}</div>
            <div style="font-weight:700;font-size:18px;color:var(--accent);margin-bottom:4px">
              â‚º${yilToplamTutar.toLocaleString('tr-TR', {minimumFractionDigits:2})}
            </div>
            <div style="font-size:11px;color:var(--muted)">${yilToplamKayit} kayÄ±t</div>
          </div>
        `;
      });
      
      html += '</div>';
      container.innerHTML = html;
    }
    
    // DetaylÄ± kayÄ±tlar render
    function renderDetayliKayitlar(personel) {
      const container = qs('#detayliKayitlar');
      const yillar = [2023, 2024, 2025];
      const tipler = [
        { key: 'iftar', label: 'Ä°ftar', icon: 'ğŸŒ™' },
        { key: 'sahur', label: 'Sahur', icon: 'ğŸŒŸ' },
        { key: 'taahhut', label: 'TaahhÃ¼t', icon: 'ğŸ“‹' },
        { key: 'teberru', label: 'Teberru', icon: 'ğŸ’' }
      ];
      
      let html = '';
      
      yillar.forEach(yil => {
        const yilData = personel.veriler[yil] || {};
        let yilToplamTutar = 0;
        let yilToplamKayit = 0;
        
        html += `
          <div style="margin-bottom:20px;padding:12px;background:var(--surface2);border-radius:8px">
            <h6 style="margin:0 0 12px 0;font-size:16px;color:var(--accent)">${yil} YÄ±lÄ±</h6>
        `;
        
        tipler.forEach(tip => {
          const veriler = yilData[tip.key] || [];
          if (veriler.length === 0) return;
          
          const toplamTutar = veriler.reduce((sum, v) => sum + (v.tutar || 0), 0);
          const kisiSayisi = new Set(veriler.map(v => (v.sahip || '').trim()).filter(s => s)).size;
          
          yilToplamTutar += toplamTutar;
          yilToplamKayit += veriler.length;
          
          html += `
            <div style="margin-bottom:10px;padding:10px;background:#fff;border-radius:6px;border-left:4px solid var(--accent)">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
                <span style="font-weight:600">${tip.icon} ${tip.label}</span>
                <span style="font-weight:700;color:var(--accent)">â‚º${toplamTutar.toLocaleString('tr-TR', {minimumFractionDigits:2})}</span>
              </div>
              <div style="font-size:12px;color:var(--muted)">
                ${veriler.length} kayÄ±t | ${kisiSayisi} farklÄ± baÄŸÄ±ÅŸÃ§Ä±
              </div>
            </div>
          `;
        });
        
        if (yilToplamKayit > 0) {
          html += `
            <div style="margin-top:12px;padding:10px;background:var(--accent);color:#fff;border-radius:6px;text-align:center">
              <div style="font-size:12px;opacity:0.9;margin-bottom:4px">${yil} Toplam</div>
              <div style="font-weight:700;font-size:16px">â‚º${yilToplamTutar.toLocaleString('tr-TR', {minimumFractionDigits:2})}</div>
              <div style="font-size:11px;opacity:0.9;margin-top:4px">${yilToplamKayit} kayÄ±t</div>
            </div>
          `;
        }
        
        html += '</div>';
      });
      
      container.innerHTML = html || '<div class="muted" style="text-align:center;padding:20px">KayÄ±t bulunamadÄ±</div>';
    }

    // Personel kategori detayÄ± (Genel/Hususi)
    function renderPersonelKategoriDetay(personel, kategori, containerId) {
      const container = qs(`#${containerId}`);
      const kategoriData = personel[kategori] || {};
      const yillar = [2023, 2024, 2025];
      const tipler = [
        { key: 'iftar', label: 'Ä°ftar', icon: 'ğŸŒ™' },
        { key: 'sahur', label: 'Sahur', icon: 'ğŸŒŸ' },
        { key: 'taahhut', label: 'TaahhÃ¼t', icon: 'ğŸ“‹' },
        { key: 'teberru', label: 'Teberru', icon: 'ğŸ’' }
      ];
      
      let html = '<div style="font-size:13px">';
      let toplamTutarKategori = 0;
      let toplamKayitKategori = 0;
      
      yillar.forEach(yil => {
        if (!kategoriData[yil]) return;
        
        let yilToplamTutar = 0;
        let yilToplamKayit = 0;
        
        html += `<div style="margin-bottom:12px;padding:10px;background:var(--surface2);border-radius:8px">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <strong style="color:var(--accent);font-size:14px">${yil}</strong>
            <span id="${containerId}-${yil}-toplam" style="font-weight:700;color:var(--accent);font-size:13px"></span>
          </div>`;
        
        tipler.forEach(tip => {
          const veriler = kategoriData[yil][tip.key] || [];
          if (veriler.length === 0) return;
          
          const toplamTutar = veriler.reduce((sum, v) => sum + (v.tutar || 0), 0);
          const kisiSayisi = new Set(veriler.map(v => (v.sahip || '').trim()).filter(s => s)).size;
          
          yilToplamTutar += toplamTutar;
          yilToplamKayit += veriler.length;
          toplamTutarKategori += toplamTutar;
          toplamKayitKategori += veriler.length;
          
          html += `
            <div style="margin-top:6px;padding:8px;background:#fff;border-radius:6px;border-left:3px solid var(--accent)">
              <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px">
                <span>${tip.icon} <strong>${tip.label}</strong></span>
                <span style="font-weight:700;color:var(--accent)">â‚º${toplamTutar.toLocaleString('tr-TR', {minimumFractionDigits:2})}</span>
              </div>
              <div class="muted" style="font-size:11px">${veriler.length} kayÄ±t | ${kisiSayisi} farklÄ± baÄŸÄ±ÅŸÃ§Ä±</div>
            </div>
          `;
        });
        
        if (yilToplamTutar > 0) {
          // YÄ±l toplamÄ±nÄ± gÃ¶ster
          setTimeout(() => {
            const toplamEl = qs(`#${containerId}-${yil}-toplam`);
            if (toplamEl) {
              toplamEl.textContent = `Toplam: â‚º${yilToplamTutar.toLocaleString('tr-TR', {minimumFractionDigits:2})}`;
            }
          }, 0);
        }
        
        html += '</div>';
      });
      
      // Kategori toplamÄ±
      if (toplamTutarKategori > 0) {
        html += `
          <div style="margin-top:12px;padding:10px;background:var(--accent);color:#fff;border-radius:8px;text-align:center">
            <div style="font-size:11px;opacity:0.9;margin-bottom:4px">Kategori ToplamÄ±</div>
            <div style="font-weight:700;font-size:16px">â‚º${toplamTutarKategori.toLocaleString('tr-TR', {minimumFractionDigits:2})}</div>
            <div style="font-size:11px;opacity:0.9;margin-top:4px">${toplamKayitKategori} kayÄ±t</div>
          </div>
        `;
      }
      
      html += '</div>';
      container.innerHTML = html || '<div class="muted" style="font-size:13px;padding:20px;text-align:center">Bu kategori iÃ§in veri bulunamadÄ±</div>';
    }

    // Personel Ã¶zet
    function renderPersonelOzet(personel, containerId) {
      const container = qs(`#${containerId}`);
      const yillar = [2023, 2024, 2025];
      
      let html = `
        <div style="border-top:2px solid var(--border);padding-top:16px">
          <h5 style="margin:0 0 12px 0">ğŸ“Š Genel Ã–zet</h5>
          <div style="display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:12px">
      `;
      
      let genelToplamTutar = 0;
      let hususiToplamTutar = 0;
      
      yillar.forEach(yil => {
        const genelData = personel.genel[yil] || {};
        const hususiData = personel.hususi[yil] || {};
        
        const genelTutar = ['iftar', 'sahur', 'taahhut', 'teberru'].reduce((sum, tip) => {
          const veriler = genelData[tip] || [];
          return sum + veriler.reduce((s, v) => s + (v.tutar || 0), 0);
        }, 0);
        
        const hususiTutar = ['iftar', 'sahur', 'taahhut', 'teberru'].reduce((sum, tip) => {
          const veriler = hususiData[tip] || [];
          return sum + veriler.reduce((s, v) => s + (v.tutar || 0), 0);
        }, 0);
        
        genelToplamTutar += genelTutar;
        hususiToplamTutar += hususiTutar;
        
        html += `
          <div style="padding:8px;background:var(--surface2);border-radius:8px;text-align:center">
            <div style="font-size:11px;color:var(--muted);margin-bottom:4px">${yil}</div>
            <div style="font-weight:700;font-size:14px">â‚º${(genelTutar + hususiTutar).toLocaleString('tr-TR', {minimumFractionDigits:2})}</div>
            <div style="font-size:10px;color:var(--muted);margin-top:2px">
              Genel: â‚º${genelTutar.toLocaleString('tr-TR', {minimumFractionDigits:2})} | 
              Hususi: â‚º${hususiTutar.toLocaleString('tr-TR', {minimumFractionDigits:2})}
            </div>
          </div>
        `;
      });
      
      html += `
          </div>
          <div style="padding:12px;background:var(--surface);border-radius:8px;text-align:center">
            <div style="font-size:12px;color:var(--muted);margin-bottom:4px">3 YÄ±llÄ±k Toplam</div>
            <div style="font-weight:700;font-size:20px;color:var(--accent)">
              â‚º${(genelToplamTutar + hususiToplamTutar).toLocaleString('tr-TR', {minimumFractionDigits:2})}
            </div>
            <div style="font-size:11px;color:var(--muted);margin-top:4px">
              Genel: â‚º${genelToplamTutar.toLocaleString('tr-TR', {minimumFractionDigits:2})} | 
              Hususi: â‚º${hususiToplamTutar.toLocaleString('tr-TR', {minimumFractionDigits:2})}
            </div>
          </div>
        </div>
      `;
      
      container.innerHTML = html;
    }

    // DetaylÄ± rapor butonu
    qs('#btnDetayliRapor').addEventListener('click', async () => {
      const section = qs('#detayliRaporSection');
      if (section.style.display === 'none') {
        section.style.display = 'block';
        section.scrollIntoView({ behavior: 'smooth' });
        
        // Verileri yÃ¼kle ve analiz et
        qs('#personelAnalizContainer').style.display = 'none';
        qs('#personelSecilmediMesaj').style.display = 'block';
        qs('#personelSecimi').innerHTML = '<option value="">YÃ¼kleniyor...</option>';
        
        try {
          await loadAllYearsData();
          
          // YÃ¼klenen veri kontrolÃ¼
          const toplamKayit = Object.values(allYearsData).reduce((sum, arr) => sum + arr.length, 0);
          console.log('Toplam yÃ¼klenen kayÄ±t:', toplamKayit);
          
          if (toplamKayit === 0) {
            qs('#personelSecilmediMesaj').innerHTML = `
              <div style="text-align:center;padding:40px">
                <h4 style="color:var(--warn);margin-bottom:12px">âš ï¸ Veri BulunamadÄ±</h4>
                <p class="muted">2023, 2024 veya 2025 yÄ±llarÄ±na ait veri bulunamadÄ±.</p>
              </div>
            `;
            return;
          }
          
          analizData = analizPersonelVerileri();
          const personelSayisi = Object.keys(analizData.personeller).length;
          
          if (personelSayisi === 0) {
            qs('#personelSecilmediMesaj').innerHTML = `
              <div style="text-align:center;padding:40px">
                <h4 style="color:var(--warn);margin-bottom:12px">âš ï¸ Personel Verisi BulunamadÄ±</h4>
                <p class="muted">KayÄ±tlarda personel/referans bilgisi bulunamadÄ±.</p>
              </div>
            `;
            return;
          }
          
          // Personel listesini doldur
          doldurPersonelListesi(analizData.personeller);
        } catch (e) {
          console.error('Rapor yÃ¼klenirken hata:', e);
          qs('#personelSecilmediMesaj').innerHTML = `
            <div style="text-align:center;padding:40px">
              <h4 style="color:var(--bad);margin-bottom:12px">âŒ Hata OluÅŸtu</h4>
              <p class="muted">Veriler yÃ¼klenirken bir hata oluÅŸtu.</p>
            </div>
          `;
        }
      } else {
        section.style.display = 'none';
      }
    });
    
    // Personel seÃ§imi deÄŸiÅŸtiÄŸinde
    qs('#personelSecimi').addEventListener('change', (e) => {
      const personelAdi = e.target.value;
      if (!personelAdi || !analizData) return;
      
      renderPersonelRaporu(personelAdi, analizData);
    });

    // YazdÄ±r butonu
    qs('#btnRaporYazdir').addEventListener('click', () => {
      const personelAdi = qs('#personelSecimi').value;
      if (!personelAdi) {
        alert('LÃ¼tfen Ã¶nce bir personel seÃ§iniz.');
        return;
      }
      
      const personel = analizData.personeller[personelAdi];
      if (!personel) return;
      
      // BaÄŸÄ±ÅŸÃ§Ä± analizi
      const bagisciAnaliz = analizBagisciPersonel(analizData.bagiscilar, personelAdi);
      
      // Rapor verilerini hazÄ±rla (Set'leri Array'e dÃ¶nÃ¼ÅŸtÃ¼r)
      const raporData = {
        personel: {
          adi: personel.adi,
          yillar: Array.from(personel.yillar).sort(),
          veriler: {}
        },
        bagisciAnaliz: {
          daimi: bagisciAnaliz.daimi || [],
          yeni: bagisciAnaliz.yeni || [],
          pasif: bagisciAnaliz.pasif || []
        }
      };
      
      // Veriler objesini serialize edilebilir hale getir
      Object.keys(personel.veriler).forEach(yilStr => {
        const yil = parseInt(yilStr);
        raporData.personel.veriler[yil] = {
          iftar: (personel.veriler[yil].iftar || []).map(v => ({
            sahip: v.sahip || '',
            tutar: Number(v.tutar) || 0,
            tarih: v.tarih || null,
            referans: v.referans || '',
            diger: v.diger || ''
          })),
          sahur: (personel.veriler[yil].sahur || []).map(v => ({
            sahip: v.sahip || '',
            tutar: Number(v.tutar) || 0,
            tarih: v.tarih || null,
            referans: v.referans || '',
            diger: v.diger || ''
          })),
          taahhut: (personel.veriler[yil].taahhut || []).map(v => ({
            sahip: v.sahip || '',
            tutar: Number(v.tutar) || 0,
            tarih: v.tarih || null,
            referans: v.referans || '',
            diger: v.diger || ''
          })),
          teberru: (personel.veriler[yil].teberru || []).map(v => ({
            sahip: v.sahip || '',
            tutar: Number(v.tutar) || 0,
            tarih: v.tarih || null,
            referans: v.referans || '',
            diger: v.diger || ''
          }))
        };
      });
      
      // Verileri localStorage'a kaydet (URL uzunluÄŸu sÄ±nÄ±rÄ± nedeniyle)
      const storageKey = 'personelRaporData_' + Date.now();
      try {
        localStorage.setItem(storageKey, JSON.stringify(raporData));
        console.log('Veri localStorage\'a kaydedildi:', storageKey);
        
        // URL parametresi olarak sadece storage key'i gÃ¶nder
        const printUrl = `ramazanÄ±serifraporyazdÄ±r.html?personel=${encodeURIComponent(personelAdi)}&key=${storageKey}`;
        console.log('YazdÄ±rma URL oluÅŸturuldu:', printUrl);
        
        // Yeni pencerede aÃ§
        const newWindow = window.open(printUrl, '_blank');
        if (!newWindow) {
          alert('Pop-up engellendi. LÃ¼tfen pop-up izni verin ve tekrar deneyin.');
        } else {
          // 5 saniye sonra localStorage'dan temizle (opsiyonel)
          setTimeout(() => {
            try {
              localStorage.removeItem(storageKey);
              console.log('GeÃ§ici veri temizlendi:', storageKey);
            } catch (e) {
              console.warn('LocalStorage temizleme hatasÄ±:', e);
            }
          }, 30000); // 30 saniye sonra temizle
        }
      } catch (e) {
        console.error('LocalStorage hatasÄ±:', e);
        // Fallback: EÄŸer localStorage Ã§alÄ±ÅŸmazsa URL parametresi olarak dene (kÃ¼Ã§Ã¼k veriler iÃ§in)
        const jsonString = JSON.stringify(raporData);
        if (jsonString.length < 2000) { // 2KB'dan kÃ¼Ã§Ã¼kse URL kullan
          const dataParam = encodeURIComponent(jsonString);
          const printUrl = `ramazanÄ±serifraporyazdÄ±r.html?personel=${encodeURIComponent(personelAdi)}&data=${dataParam}`;
          window.open(printUrl, '_blank');
        } else {
          alert('Veri Ã§ok bÃ¼yÃ¼k. LÃ¼tfen daha az veri seÃ§in veya tarayÄ±cÄ± ayarlarÄ±nÄ±zÄ± kontrol edin.');
        }
      }
    });
    
    // PDF ve Excel export
    qs('#btnRaporPDF').addEventListener('click', () => {
      const personelAdi = qs('#personelSecimi').value;
      if (!personelAdi) {
        alert('LÃ¼tfen Ã¶nce bir personel seÃ§iniz.');
        return;
      }
      
      const el = qs('#personelAnalizContainer');
      const opt = {
        margin: [10, 10, 10, 10],
        filename: `personel-rapor-${personelAdi}-2023-2024-2025.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true, scrollY: -window.scrollY },
        pagebreak: { mode: ['css', 'legacy', 'avoid-all'] },
        jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
      };
      html2pdf().set(opt).from(el).save();
    });

    qs('#btnRaporExcel').addEventListener('click', () => {
      const personelAdi = qs('#personelSecimi').value;
      if (!personelAdi || !analizData) {
        alert('LÃ¼tfen Ã¶nce bir personel seÃ§iniz.');
        return;
      }
      
      const personel = analizData.personeller[personelAdi];
      if (!personel) return;
      
      // Excel export iÃ§in CSV formatÄ±nda dÄ±ÅŸa aktar
      const rows = [['YÄ±l', 'Tip', 'BaÄŸÄ±ÅŸÃ§Ä±', 'Tutar', 'Referans', 'Tarih']];
      
      [2023, 2024, 2025].forEach(yil => {
        const yilData = personel.veriler[yil] || {};
        ['iftar', 'sahur', 'taahhut', 'teberru'].forEach(tip => {
          const veriler = yilData[tip] || [];
          veriler.forEach(v => {
            const tarihStr = v.tarih ? (v.tarih instanceof Date ? v.tarih.toISOString().slice(0, 10) : v.tarih) : '';
            rows.push([
              yil,
              tip,
              v.sahip || '',
              v.tutar || 0,
              v.referans || '',
              tarihStr
            ]);
          });
        });
      });
      
      const csv = rows.map(r => r.map(cell => {
        const str = String(cell);
        return str.includes(',') || str.includes('"') || str.includes('\n')
          ? `"${str.replace(/"/g, '""')}"`
          : str;
      }).join(',')).join('\n');
      
      const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `personel-rapor-${personelAdi}-2023-2024-2025.csv`;
      link.click();
    });
  </script>
</body>
</html>


