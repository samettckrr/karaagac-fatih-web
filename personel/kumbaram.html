<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>KaraaÄŸaÃ§ Fatih | Kumbaram</title>
<link rel="icon" type="image/png" href="../img/logo.png" />
<link rel="stylesheet" href="../css/app-shell.css" />

<style>
  /* ========== Tema ========== */
  :root{
    --appbar-h:56px;
    --radius:14px; --shadow:0 12px 28px rgba(0,0,0,.12);
    --bg:#f3f6fc; --card:#ffffff; --stroke:rgba(15,23,42,.12);
    --text:#0b1220; --muted:#4b5563; --surface:#f1f5ff; --surface2:#f6f8ff;
    --brand:#0ea5e9; --brand2:#0284c7;
    --danger:#ef4444; --success:#22c55e; --warning:#f59e0b;
    --gap-lg:20px; --gap:14px; --gap-sm:10px;
  }
  /* ========== Sayfa-Ã¶zel stiller (app-shell.css'den sonra) ========== */
  /* Appbar, drawer, navigation - app-shell.css'den geliyor */
  html,body{height:100%}
  body{
    padding-top:var(--appbar-h) !important;
    overflow-x:hidden;
    overflow-y:auto;
  }

  /* ========== Layout ========== */
  .container{max-width:1120px; margin:0 auto; padding:18px; display:grid; gap:var(--gap-lg)}
  .card{background:var(--card); border:1px solid var(--stroke); border-radius:16px; box-shadow:var(--shadow); padding:16px}
  .stack-lg{display:grid; gap:var(--gap-lg)}
  .stack   {display:grid; gap:var(--gap)}
  .row{display:grid; grid-template-columns:repeat(12,minmax(0,1fr)); gap:var(--gap)}
  .col-3{grid-column:span 3} .col-4{grid-column:span 4} .col-6{grid-column:span 6} .col-12{grid-column:span 12}

  @media (max-width: 960px){
    .container{padding:14px}
    .row{grid-template-columns:repeat(6,minmax(0,1fr))}
    .col-3{grid-column:span 3} .col-4{grid-column:span 6} .col-6{grid-column:span 6} .col-12{grid-column:span 6}
  }
  @media (max-width: 640px){
    .row{grid-template-columns:repeat(4,minmax(0,1fr))}
    .col-3,.col-4,.col-6,.col-12{grid-column:span 4}
    .container{padding:12px}
    .card{padding:12px}
  }

  .muted{color:var(--muted)}

  /* ========== KPI Cards ========== */
  .kpi-grid{display:grid; grid-template-columns:repeat(3,1fr); gap:var(--gap)}
  .kpi-card{
    background:linear-gradient(135deg, var(--brand), var(--brand2));
    color:#fff; padding:20px; border-radius:16px; text-align:center;
  }
  .kpi-card.warning{background:linear-gradient(135deg, var(--warning), #f97316)}
  .kpi-card.success{background:linear-gradient(135deg, var(--success), #16a34a)}
  .kpi-label{font-size:13px; opacity:.9; margin-bottom:6px}
  .kpi-value{font-size:32px; font-weight:900; margin-bottom:4px}
  .kpi-hint{font-size:12px; opacity:.8}

  @media (max-width: 640px){
    .kpi-grid{grid-template-columns:1fr}
  }

  /* ========== Kumbara Cards ========== */
  .kumbara-grid{
    display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr));
    gap:var(--gap);
  }
  @media (max-width: 640px){
    .kumbara-grid{grid-template-columns:1fr}
  }
  .kumbara-card{
    background:var(--card); border:1px solid var(--stroke);
    border-radius:16px; padding:16px; transition:transform .15s, box-shadow .15s;
    min-width:0; overflow:hidden;
  }
  .kumbara-card:hover{
    transform:translateY(-2px); box-shadow:var(--shadow);
  }
  @media (max-width: 640px){
    .kumbara-card:hover{transform:none}
  }
  .kumbara-card.dagitildi{
    border-color:var(--success); background:rgba(34,197,94,.05);
  }
  .kumbara-card.toplandi{
    border-color:var(--warning); background:rgba(245,158,11,.05);
  }
  .kumbara-header{
    display:flex; justify-content:space-between; align-items:center;
    margin-bottom:12px;
  }
  .kumbara-tur{
    font-size:12px; padding:4px 10px; border-radius:999px;
    background:var(--surface2); border:1px solid var(--stroke);
    font-weight:700;
  }
  .kumbara-tur.kumbara{background:rgba(14,165,233,.15); color:var(--brand)}
  .kumbara-tur.sadaka{background:rgba(34,197,94,.15); color:var(--success)}
  .kumbara-numara{
    font-size:24px; font-weight:900; color:var(--brand);
  }
  @media (max-width: 640px){
    .kumbara-numara{font-size:20px}
    .kumbara-header{flex-wrap:wrap; gap:8px}
  }
  .kumbara-personel{
    font-size:13px; color:var(--muted); margin-bottom:8px;
  }
  .kumbara-durum{
    display:flex; gap:6px; flex-wrap:wrap; margin-top:12px;
  }
  .durum-badge{
    font-size:11px; padding:4px 8px; border-radius:6px;
    background:var(--surface2); border:1px solid var(--stroke);
  }
  .durum-badge.dagitildi{background:rgba(34,197,94,.15); color:var(--success); border-color:rgba(34,197,94,.3)}
  .durum-badge.toplandi{background:rgba(245,158,11,.15); color:var(--warning); border-color:rgba(245,158,11,.3)}
  .kumbara-verilen{
    margin-top:12px; padding-top:12px; border-top:1px solid var(--stroke);
  }
  .kumbara-verilen-label{font-size:12px; color:var(--muted); margin-bottom:4px}
  .kumbara-verilen-ad{font-weight:700; font-size:14px}
  .kumbara-verilen-adres{font-size:12px; color:var(--muted); margin-top:4px}
  .kumbara-actions{
    display:flex; gap:8px; margin-top:12px; flex-wrap:wrap;
  }
  @media (max-width: 640px){
    .kumbara-actions{flex-direction:column}
    .kumbara-actions .btn{width:100%}
  }
  .btn{border:1px solid var(--stroke); background:var(--surface2); border-radius:999px; padding:8px 14px; cursor:pointer; font-size:13px; font-weight:700}
  .btn-primary{background:linear-gradient(180deg,var(--brand),var(--brand2)); color:#fff; border:none}
  .btn-success{background:var(--success); color:#fff; border:none}
  .btn:disabled{opacity:.5; cursor:not-allowed}

  /* ========== Modal ========== */
  .modal{
    display:none;
    position:fixed;
    inset:0;
    background:rgba(2,6,23,.6);
    z-index:99;
    align-items:center;
    justify-content:center;
    padding:18px;
    opacity:0;
    transition:opacity .2s ease;
    pointer-events:none;
  }
  .modal.show{
    display:flex;
    opacity:1;
    pointer-events:auto;
  }
  .modal-icerik{
    background:var(--card);
    border:1px solid var(--stroke);
    width:96%;
    max-width:500px;
    border-radius:16px;
    box-shadow:var(--shadow);
    padding:18px;
    position:relative;
    display:grid;
    gap:var(--gap);
    transform:scale(0.95);
    transition:transform .2s ease;
  }
  .modal.show .modal-icerik{
    transform:scale(1);
  }
  .modal-kapat{
    position:absolute;
    right:12px;
    top:10px;
    font-size:22px;
    cursor:pointer;
    color:var(--danger);
    background:none;
    border:none;
    padding:4px 8px;
    line-height:1;
    transition:opacity .2s ease, transform .1s ease;
  }
  .modal-kapat:hover{
    opacity:.8;
    transform:scale(1.1);
  }
  .modal-title{margin:0; font-size:18px; font-weight:800}
  label{display:block; margin-bottom:6px; font-size:13px; color:var(--muted)}
  .field{display:flex; flex-direction:column; gap:6px}
  select{
    width:100%; padding:10px 12px; border:1px solid var(--stroke);
    border-radius:12px; background:var(--surface2); color:var(--text); outline:none;
  }
  select:focus{ box-shadow:0 0 0 3px rgba(14,165,233,.25); border-color:#0ea5e9; background:var(--surface) }
  input,textarea{
    width:100%; padding:10px 12px; border:1px solid var(--stroke);
    border-radius:12px; background:var(--surface2); color:var(--text); outline:none;
  }
  textarea{height:auto; min-height:80px; resize:vertical}
  input:focus,textarea:focus{ box-shadow:0 0 0 3px rgba(14,165,233,.25); border-color:#0ea5e9; background:var(--surface) }

  /* ========== Toast ========== */
  .toast{position:fixed; left:50%; bottom:24px; transform:translateX(-50%) translateY(20px); background:rgba(2,6,23,.95); color:#fff; border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:10px 12px; opacity:0; pointer-events:none; transition:opacity .25s, transform .25s; z-index:200}
  .toast.show{opacity:1; transform:translateX(-50%) translateY(0)}

  .empty{text-align:center; padding:40px; color:var(--muted)}

  /* ========== Progress Bar ========== */
  .progress-bar-container{
    width:100%; height:24px; background:var(--surface); border-radius:12px; overflow:hidden;
    border:1px solid var(--stroke); position:relative;
  }
  .progress-bar-fill{
    height:100%; border-radius:12px; transition:width .3s ease, background-color .3s ease;
    display:flex; align-items:center; justify-content:center; font-size:11px; font-weight:700;
    color:#fff; text-shadow:0 1px 2px rgba(0,0,0,.2); padding:0 6px;
  }
  .progress-bar-text{
    position:absolute; left:50%; top:50%; transform:translate(-50%, -50%);
    font-size:11px; font-weight:700; color:var(--text); pointer-events:none;
    z-index:1;
  }

  /* ========== Custom Checkbox ========== */
  .col-toggle{
    width:14px; height:14px; cursor:pointer; margin:0;
    accent-color:var(--brand); flex-shrink:0;
  }

  /* ========== Tables ========== */
  .table-wrap{border:1px solid var(--stroke); border-radius:14px; overflow:auto; background:var(--card); margin-top:12px}
  table{width:100%; border-collapse:collapse; min-width:600px}
  th,td{padding:12px 14px; text-align:left; border-bottom:1px solid var(--stroke); font-size:14px}
  thead th{position:sticky; top:0; background:var(--surface); font-weight:800}
</style>

<!-- Supabase (Auth + Database iÃ§in) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="../src/supabase.js"></script>
<script src="../src/supabase-auth-wrapper.js"></script>
<script defer src="../js/ortak.js"></script>
</head>
<body>

<!-- ÃœST APPBAR (ortak.js + app-shell.css ile aynÄ± yapÄ±) -->
<div class="appbar">
  <div class="brand" onclick="location.href='../panel.html'">
    <img src="../img/logo.png" alt="logo"><span>KARAAÄAÃ‡ FATÄ°H</span>
  </div>
  <nav class="nav-center">
    <ul class="nav-list" id="navMain"></ul>
  </nav>
  <div class="nav-right">
    <button class="btn hamb" id="hamburger" title="MenÃ¼">â˜°</button>

    <!-- Bildirim -->
    <div class="nav-item">
      <button class="iconbtn" id="btnNotif" title="Bildirimler">ğŸ””
        <span class="badge" id="notifBadge" style="display:none">0</span>
      </button>
      <div class="dropdown drop-right" id="notifDropdown" aria-label="Bildirim listesi">
        <div class="muted" style="padding:6px 8px">Son bildirimler</div>
        <div id="notifList" class="list" style="max-height:300px;overflow:auto"></div>
      </div>
    </div>

    <!-- Profil -->
    <div class="nav-item">
      <button class="iconbtn" id="btnProfile" title="Profil">
        <span class="avatar"></span> <span id="profName" class="muted">Profil</span>
      </button>
      <div class="dropdown drop-right" id="profDropdown" aria-label="Profil menÃ¼sÃ¼">
        <a href="../diger/kullanici-yonetimi.html">ğŸ‘¤ Profil</a>
        <a href="../diger/sistem-ayarlari.html">âš™ï¸ Sistem AyarlarÄ±</a>
        <a href="#" id="btnLogout">ğŸšª Ã‡Ä±kÄ±ÅŸ Yap</a>
      </div>
    </div>
  </div>
</div>
<aside class="drawer" id="drawer"></aside>
<div class="toast-container" id="toastContainer"></div>

<!-- CONTENT -->
<main class="container stack-lg">
  <!-- BaÅŸlÄ±k -->
  <section class="card stack">
    <h2 style="margin:0">Kumbaram</h2>
    <div class="muted">Zimmetlenen kumbara ve sadaka kutularÄ±nÄ± yÃ¶netin</div>
  </section>

  <!-- YÃ¶netici SeÃ§im Paneli -->
  <section class="card stack" id="yoneticiPanel" style="display:none">
    <h3 style="margin:0">YÃ¶netici Paneli</h3>
    <div class="row">
      <div class="col-6 field">
        <label>Personel SeÃ§</label>
        <select id="secPersonel">
          <option value="">TÃ¼m Personeller</option>
        </select>
      </div>
      <div class="col-6 field" style="align-self:flex-end">
        <button class="btn btn-primary" onclick="yoneticiFiltrele()">Filtrele</button>
        <button class="btn" onclick="yoneticiFiltreTemizle()">Temizle</button>
        <button class="btn btn-success" onclick="yoneticiRaporGoster()">Rapor GÃ¶rÃ¼ntÃ¼le</button>
      </div>
    </div>
  </section>

  <!-- YÃ¶netici Rapor EkranÄ± -->
  <section class="card stack" id="yoneticiRapor" style="display:none">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:16px">
      <h3 style="margin:0">Rapor</h3>
      <button class="btn" onclick="yoneticiRaporKapat()">Kapat</button>
    </div>
    <div id="raporIcerik">
      <div class="empty">Rapor yÃ¼kleniyor...</div>
    </div>
  </section>

  <!-- KPI Cards -->
  <section class="row">
    <div class="col-4">
      <div class="kpi-card">
        <div class="kpi-label">Toplam Zimmetlenen</div>
        <div class="kpi-value" id="kpiZimmetlenen">0</div>
        <div class="kpi-hint">Size zimmetlenen</div>
      </div>
    </div>
    <div class="col-4">
      <div class="kpi-card success">
        <div class="kpi-label">DaÄŸÄ±tÄ±lan</div>
        <div class="kpi-value" id="kpiDagitildi">0</div>
        <div class="kpi-hint">DaÄŸÄ±tÄ±m yapÄ±lan</div>
      </div>
    </div>
    <div class="col-4">
      <div class="kpi-card warning">
        <div class="kpi-label">Toplanan</div>
        <div class="kpi-value" id="kpiToplandi">0</div>
        <div class="kpi-hint">Geri toplanan</div>
      </div>
    </div>
  </section>

  <!-- Dashboard/Rapor -->
  <section class="card stack">
    <!-- SÃ¼tun Gizleme/GÃ¶sterme (Ãœstte) -->
    <details style="margin-bottom:16px">
      <summary style="cursor:pointer; padding:6px 10px; background:var(--surface2); border:1px solid var(--stroke); border-radius:6px; font-size:12px; font-weight:600; color:var(--muted); user-select:none; display:inline-block">
        âš™ï¸ SÃ¼tun Gizle/GÃ¶ster
      </summary>
      <div style="margin-top:8px; padding:10px; background:var(--surface2); border:1px solid var(--stroke); border-radius:8px; display:grid; grid-template-columns:repeat(auto-fit, minmax(130px, 1fr)); gap:6px">
        <label style="display:flex; align-items:center; gap:4px; cursor:pointer; font-size:11px; padding:2px 0">
          <input type="checkbox" class="col-toggle" data-col="personel" checked />
          <span>Personel</span>
        </label>
        <label style="display:flex; align-items:center; gap:4px; cursor:pointer; font-size:11px; padding:2px 0">
          <input type="checkbox" class="col-toggle" data-col="zimmetlenen" checked />
          <span>Zimmetlenen</span>
        </label>
        <label style="display:flex; align-items:center; gap:4px; cursor:pointer; font-size:11px; padding:2px 0">
          <input type="checkbox" class="col-toggle" data-col="dagitilan" checked />
          <span>DaÄŸÄ±tÄ±lan</span>
        </label>
        <label style="display:flex; align-items:center; gap:4px; cursor:pointer; font-size:11px; padding:2px 0">
          <input type="checkbox" class="col-toggle" data-col="dagitmaNispeti" checked />
          <span>DaÄŸÄ±tma Nispeti</span>
        </label>
        <label style="display:flex; align-items:center; gap:4px; cursor:pointer; font-size:11px; padding:2px 0">
          <input type="checkbox" class="col-toggle" data-col="toplanan" checked />
          <span>Toplanan</span>
        </label>
        <label style="display:flex; align-items:center; gap:4px; cursor:pointer; font-size:11px; padding:2px 0">
          <input type="checkbox" class="col-toggle" data-col="kalan" checked />
          <span>Kalan</span>
        </label>
        <label style="display:flex; align-items:center; gap:4px; cursor:pointer; font-size:11px; padding:2px 0">
          <input type="checkbox" class="col-toggle" data-col="toplamaNispeti" checked />
          <span>Toplama Nispeti</span>
        </label>
        <label style="display:flex; align-items:center; gap:4px; cursor:pointer; font-size:11px; padding:2px 0">
          <input type="checkbox" class="col-toggle" data-col="miktar" checked />
          <span>Miktar</span>
        </label>
      </div>
    </details>
    
    <!-- Filtreler ve Butonlar -->
    <div class="row" style="margin-bottom:16px">
      <div class="col-4 field">
        <label>Kumbara TÃ¼rÃ¼</label>
        <select id="dashboardTur">
          <option value="">TÃ¼mÃ¼</option>
          <option value="kumbara">Kumbara</option>
          <option value="sadaka">Sadaka</option>
        </select>
      </div>
      <div class="col-4 field" style="align-self:flex-end">
        <button class="btn btn-primary" id="btnDashboardYukle">Raporu YÃ¼kle</button>
      </div>
      <div class="col-4 field" style="align-self:flex-end">
        <button class="btn btn-primary" id="btnDashboardYenile">ğŸ”„ Yenile</button>
      </div>
    </div>
    
    <!-- BaÅŸlÄ±k -->
    <div style="margin-bottom:25px">
      <h3 style="margin:0">ğŸ“Š Sadaka Kutusu & Kumbara Ä°statistikleri</h3>
      <div class="muted" style="margin-top:4px">Personel bazlÄ± kumbara istatistikleri</div>
    </div>
    
    <!-- Ã–zet Kartlar -->
    <div class="row" id="dashboardOzet" style="margin-bottom:20px">
      <!-- JavaScript ile doldurulacak -->
    </div>
    
    <!-- Rapor Tablosu -->
    <div id="dashboardRapor" class="table-wrap">
      <div class="muted" style="padding:12px">Filtre seÃ§ip raporu yÃ¼kleyiniz...</div>
    </div>
  </section>

  <!-- Kumbara Listesi -->
  <section class="card stack">
    <h3 style="margin:0">Zimmetlenen Kumbaralar</h3>
    <div id="kumbaraListesi" class="kumbara-grid">
      <div class="empty">YÃ¼kleniyor...</div>
    </div>
  </section>

  <div style="height:40px"></div>
</main>

<!-- DaÄŸÄ±tÄ±m Modal -->
<div class="modal" id="dagitimModal">
  <div class="modal-icerik" onclick="event.stopPropagation()">
    <button class="modal-kapat" onclick="dagitimModalKapat()" type="button" aria-label="Kapat">âœ–</button>
    <h3 class="modal-title">DaÄŸÄ±tÄ±m KaydÄ±</h3>
    <input type="hidden" id="dagitimKumbaraId" />
    <div class="field">
      <label>Kumbara/Sadaka Bilgisi</label>
      <div id="dagitimKumbaraBilgi" class="muted"></div>
    </div>
    <div class="field">
      <label>Verilen KiÅŸi AdÄ± SoyadÄ± *</label>
      <input type="text" id="dagitimAdSoyad" placeholder="Ã–rn: Mehmet YÄ±lmaz" />
    </div>
    <div class="field">
      <label>Adres / Bilgi</label>
      <textarea id="dagitimAdres" placeholder="Adres veya ek bilgi giriniz..."></textarea>
    </div>
    <div class="actions" style="display:flex; gap:10px; justify-content:flex-end; margin-top:10px">
      <button class="btn" onclick="dagitimModalKapat()">Ä°ptal</button>
      <button class="btn btn-primary" onclick="dagitimKaydet()">Kaydet</button>
    </div>
  </div>
</div>

<script>
/* ===== Helpers ===== */
const userAgent = navigator.userAgent || '';
const cihazTipi = ()=> (window.innerWidth<700?'mobile':(window.innerWidth<960?'tablet':'desktop'));
const tsISO = ()=> new Date().toISOString();

// XSS korumasÄ± - HTML escape
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

/* ===== Yetki KontrolÃ¼ ===== */
const YONETICILER = ['Samet Ã‡akÄ±r', 'Muhsin Ã‡elik'];
let currentUser = null;
let currentUserName = '';
let isYonetici = false;
let seciliPersonel = ''; // YÃ¶netici iÃ§in seÃ§ili personel filtresi

/* ===== Navigation Bar - ortak.js'den geliyor ===== */
// Navigation iÅŸlemleri ortak.js'deki initAppShellAuth tarafÄ±ndan yapÄ±lÄ±yor

/* ===== YÃ¶netici Paneli ===== */
const personeller = [
  "Muhsin Ã‡elik","Faruk Nafiz Ã–zgan","Ä°brahim Ay","Samet Ã‡akÄ±r",
  "Kerem KocaoÄŸlu","Serhan Durak","Mahmut Solmaz","Mehmet Taha Keskin","Ahmetali Emre Åahin"
];

async function yuklePersonelListesi(){
  const select = document.getElementById('secPersonel');
  const supabase = window.supabase;
  if(!select || !supabase) return;
  
  // TÃ¼m zimmetlenen personelleri bul
  try{
    const { data, error } = await supabase
      .from('kumbaralar')
      .select('zimmetlipersonel')
      .eq('zimmetli', true);
    
    if(error) throw error;
    
    const personelSet = new Set();
    (data || []).forEach(row=>{
      const personel = row.zimmetlipersonel;
      if(personel) personelSet.add(personel);
    });
    
    const personelList = Array.from(personelSet).sort();
    
    select.innerHTML = '<option value="">TÃ¼m Personeller</option>';
    personelList.forEach(p=>{
      const option = document.createElement('option');
      option.value = p;
      option.textContent = p;
      select.appendChild(option);
    });
  }catch(e){
    console.error(e);
    // Fallback: Sabit liste
    select.innerHTML = '<option value="">TÃ¼m Personeller</option>';
    personeller.forEach(p=>{
      const option = document.createElement('option');
      option.value = p;
      option.textContent = p;
      select.appendChild(option);
    });
  }
}

function yoneticiFiltrele(){
  seciliPersonel = document.getElementById('secPersonel').value;
  yukleKumbaralar();
  guncelleKPI();
}

function yoneticiFiltreTemizle(){
  document.getElementById('secPersonel').value = '';
  seciliPersonel = '';
  yukleKumbaralar();
  guncelleKPI();
}

async function yoneticiRaporGoster(){
  const supabase = window.supabase;
  if(!isYonetici || !supabase) return;
  
  const raporSection = document.getElementById('yoneticiRapor');
  const raporIcerik = document.getElementById('raporIcerik');
  raporSection.style.display = 'grid';
  raporIcerik.innerHTML = '<div class="empty">Rapor yÃ¼kleniyor...</div>';
  
  try{
    let query = supabase
      .from('kumbaralar')
      .select('*, toplandi, toplamatarihi, sayimasamasinda, tamamlandi, icindencikanmiktar')
      .eq('zimmetli', true);
    
    if(seciliPersonel){
      query = query.eq('zimmetlipersonel', seciliPersonel);
    }
    
    const { data: snap, error } = await query;
    
    if(error) throw error;
    
    if(!snap || snap.length === 0){
      raporIcerik.innerHTML = '<div class="empty">Rapor iÃ§in veri bulunamadÄ±.</div>';
      return;
    }
    
    // Personel bazÄ±nda grupla
    const personelMap = new Map();
    snap.forEach(row=>{
      const data = row;
      const personel = data.zimmetlipersonel || 'Bilinmeyen';
      
      if(!personelMap.has(personel)){
        personelMap.set(personel, {
          personel: personel,
          toplam: 0,
          dagitildi: 0,
          toplandi: 0,
          bekleyen: 0,
          kumbaralar: []
        });
      }
      
      const stats = personelMap.get(personel);
      stats.toplam++;
      if(data.dagitildi) stats.dagitildi++;
      if(data.toplandi === true) stats.toplandi++;
      if(!data.dagitildi) stats.bekleyen++;
      
      stats.kumbaralar.push({
        tur: data.tur || 'kumbara',
        numara: data.numara || '-',
        dagitildi: data.dagitildi || false,
        toplandi: data.toplandi || false,
        verilenKisi: data.verilenkisiadsoyad || '-',
        dagitimTarihi: data.dagitimtarihi || null,
        toplamaTarihi: data.toplamatarihi || null
      });
    });
    
    // HTML oluÅŸtur
    let html = '<div class="stack">';
    
    Array.from(personelMap.values()).sort((a,b)=>a.personel.localeCompare(b.personel)).forEach(stats=>{
      html += `
        <div class="card" style="margin-bottom:16px">
          <h4 style="margin:0 0 12px 0">${stats.personel}</h4>
          <div class="row" style="margin-bottom:16px">
            <div class="col-3">
              <div class="kpi-card" style="padding:12px">
                <div class="kpi-label">Toplam</div>
                <div class="kpi-value" style="font-size:24px">${stats.toplam}</div>
              </div>
            </div>
            <div class="col-3">
              <div class="kpi-card success" style="padding:12px">
                <div class="kpi-label">DaÄŸÄ±tÄ±lan</div>
                <div class="kpi-value" style="font-size:24px">${stats.dagitildi}</div>
              </div>
            </div>
            <div class="col-3">
              <div class="kpi-card warning" style="padding:12px">
                <div class="kpi-label">Toplanan</div>
                <div class="kpi-value" style="font-size:24px">${stats.toplandi}</div>
              </div>
            </div>
            <div class="col-3">
              <div class="kpi-card" style="padding:12px; background:linear-gradient(135deg, #6366f1, #8b5cf6)">
                <div class="kpi-label">Bekleyen</div>
                <div class="kpi-value" style="font-size:24px">${stats.bekleyen}</div>
              </div>
            </div>
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>TÃ¼r</th><th>Numara</th><th>Durum</th><th>Verilen KiÅŸi</th><th>DaÄŸÄ±tÄ±m Tarihi</th><th>Toplama Tarihi</th>
                </tr>
              </thead>
              <tbody>
      `;
      
      stats.kumbaralar.sort((a,b)=>a.numara - b.numara).forEach(k=>{
        const turLabel = k.tur === 'kumbara' ? 'Kumbara' : 'Sadaka';
        let durum = '';
        if(k.toplandi === true) durum = '<span class="durum-badge toplandi">ToplandÄ±</span>';
        else if(k.dagitildi) durum = '<span class="durum-badge dagitildi">DaÄŸÄ±tÄ±ldÄ±</span>';
        else durum = '<span class="durum-badge">Bekliyor</span>';
        
        const dagitimTarihi = k.dagitimTarihi ? new Date(k.dagitimTarihi).toLocaleString('tr-TR') : '-';
        const toplamaTarihi = k.toplamatarihi ? new Date(k.toplamatarihi).toLocaleString('tr-TR') : '-';
        
        html += `
          <tr>
            <td>${turLabel}</td>
            <td>#${k.numara}</td>
            <td>${durum}</td>
            <td>${k.verilenKisi}</td>
            <td>${dagitimTarihi}</td>
            <td>${toplamaTarihi}</td>
          </tr>
        `;
      });
      
      html += `
              </tbody>
            </table>
          </div>
        </div>
      `;
    });
    
    html += '</div>';
    raporIcerik.innerHTML = html;
  }catch(e){
    console.error(e);
    raporIcerik.innerHTML = '<div class="empty">Rapor yÃ¼klenirken hata oluÅŸtu: ' + (e.message || e) + '</div>';
    if(typeof window.showToast === 'function') window.showToast('error', 'Hata', 'Rapor yÃ¼klenirken hata oluÅŸtu.');
  }
}

function yoneticiRaporKapat(){
  document.getElementById('yoneticiRapor').style.display = 'none';
}

/* ===== Auth & Yetki KontrolÃ¼ ===== */
// Sayfa Ã¶zel init fonksiyonu - ortak.js'deki initAppShellAuth tarafÄ±ndan Ã§aÄŸrÄ±lacak
window.initPage = async function() {
  const supabase = window.supabase;
  if(!supabase) {
    console.error('Supabase client yÃ¼klenmedi');
    if(typeof showToast === 'function') showToast('error', 'Hata', 'Supabase baÄŸlantÄ±sÄ± kurulamadÄ±.');
    return;
  }
  
  const toast = (msg, type = 'info') => {
    if(typeof window.showToast === 'function') {
      window.showToast(type, 'Bilgi', msg);
    } else {
      console.log(msg);
    }
  };
  
  try{
    // Mevcut kullanÄ±cÄ± bilgisini al
    const { data: { user }, error: userError } = await supabase.auth.getUser();
    if(userError || !user) {
      console.error('KullanÄ±cÄ± oturumu bulunamadÄ±:', userError);
      location.replace('../index.html');
      return;
    }
    
    currentUser = user;
    
    // KullanÄ±cÄ± bilgilerini al
    const { data: userData, error: userDataError } = await supabase
      .from('kullanicilar')
      .select('id, adsoyad, email, yetkiler, rol')
      .eq('id', user.id)
      .single();
    
    if(userDataError) {
      console.error('KullanÄ±cÄ± bilgisi alÄ±namadÄ±:', userDataError);
      toast('KullanÄ±cÄ± bilgisi yÃ¼klenemedi.', 'error');
      return;
    }
    
    if(!userData) {
      console.error('KullanÄ±cÄ± kaydÄ± bulunamadÄ±');
      toast('KullanÄ±cÄ± kaydÄ± bulunamadÄ±.', 'error');
      return;
    }
    
    const data = userData;
    currentUserName = (data.adsoyad || '').trim();
    
    if(!currentUserName && user.email){
      const namePart = user.email.split('@')[0];
      currentUserName = namePart.charAt(0).toUpperCase() + namePart.slice(1);
    }
    
    // YÃ¶netici kontrolÃ¼
    isYonetici = YONETICILER.some(y=>{
      const normY = y.toLowerCase().trim();
      const normU = currentUserName.toLowerCase().trim();
      return normU === normY || normU.includes(normY) || normY.includes(normU);
    });
    
    // Profil adÄ±nÄ± gÃ¼ncelle (ortak.js zaten gÃ¼ncelliyor ama yÃ¶netici bilgisini ekle)
    const profNameEl = document.getElementById('profName');
    if(profNameEl) {
      const nameDisplay = currentUserName || 'Profil';
      profNameEl.textContent = (nameDisplay.split(' ')[0] || 'Profil') + (isYonetici ? ' (YÃ¶netici)' : '');
    }
    
    // YÃ¶netici paneli gÃ¶ster
    if(isYonetici){
      const yoneticiPanel = document.getElementById('yoneticiPanel');
      if(yoneticiPanel) {
        yoneticiPanel.style.display = 'grid';
        await yuklePersonelListesi();
      }
    }
    
    // Verileri yÃ¼kle
    await yukleKumbaralar();
    await guncelleKPI();
  }catch(e){
    console.error('initPage hatasÄ±:', e);
    toast('Sayfa yÃ¼klenirken hata oluÅŸtu.', 'error');
  }
};

/* ===== Kumbara YÃ¼kleme ===== */
async function yukleKumbaralar(){
  const container = document.getElementById('kumbaraListesi');
  const supabase = window.supabase;
  if(!container || !supabase) return;
  
  container.innerHTML = '<div class="empty">YÃ¼kleniyor...</div>';
  
  try{
    let query = supabase
      .from('kumbaralar')
      .select('*')
      .eq('zimmetli', true);
    
    // YÃ¶netici deÄŸilse sadece kendisine zimmetlenenleri gÃ¶ster
    if(!isYonetici){
      query = query.eq('zimmetlipersonel', currentUserName);
    } else if(seciliPersonel){
      // YÃ¶netici ve personel seÃ§ilmiÅŸse filtrele
      query = query.eq('zimmetlipersonel', seciliPersonel);
    }
    
    const { data: snap, error } = await query;
    
    if(error) throw error;
    
    if(!snap || snap.length === 0){
      container.innerHTML = '<div class="empty">Zimmetlenen kumbara/sadaka bulunamadÄ±.</div>';
      return;
    }
    
    const kumbaralar = snap
      .map(row=>({id: row.id, ...row}))
      .sort((a,b)=>{
        const numA = a.numara || 0;
        const numB = b.numara || 0;
        return numA - numB;
      });
    
    if(kumbaralar.length === 0){
      container.innerHTML = '<div class="empty">Zimmetlenen kumbara/sadaka bulunamadÄ±.</div>';
      return;
    }
    
    container.innerHTML = kumbaralar.map(k=>{
      const turLabel = k.tur === 'kumbara' ? 'Kumbara' : 'Sadaka';
      const turClass = k.tur === 'kumbara' ? 'kumbara' : 'sadaka';
      const cardClass = (k.toplandi === true) ? 'toplandi' : (k.dagitildi ? 'dagitildi' : '');
      const verilenKisiAdSoyad = escapeHtml(k.verilenkisiadsoyad || '-');
      const verilenKisiAdres = escapeHtml(k.verilenkisiadres || '');
      const zimmetliPersonel = escapeHtml(k.zimmetlipersonel || '-');
      
      return `
        <div class="kumbara-card ${cardClass}" data-id="${k.id}">
          <div class="kumbara-header">
            <span class="kumbara-tur ${turClass}">${turLabel}</span>
            <span class="kumbara-numara">#${k.numara || '-'}</span>
          </div>
          <div class="kumbara-personel">Personel: ${zimmetliPersonel}</div>
          <div class="kumbara-durum">
            ${k.dagitildi ? '<span class="durum-badge dagitildi">âœ“ DaÄŸÄ±tÄ±ldÄ±</span>' : ''}
            ${(k.toplandi === true) ? '<span class="durum-badge toplandi">â†» ToplandÄ±</span>' : ''}
            ${k.sayimasamasinda === true ? '<span class="durum-badge" style="background:rgba(59,130,246,.15); color:var(--brand); border-color:rgba(59,130,246,.3)">ğŸ” SayÄ±m</span>' : ''}
            ${k.tamamlandi === true ? '<span class="durum-badge" style="background:rgba(59,130,246,.15); color:var(--brand); border-color:rgba(59,130,246,.3)">âœ“ TamamlandÄ±</span>' : ''}
          </div>
          ${k.dagitildi ? `
            <div class="kumbara-verilen">
              <div class="kumbara-verilen-label">Verilen KiÅŸi:</div>
              <div class="kumbara-verilen-ad">${verilenKisiAdSoyad}</div>
              ${verilenKisiAdres ? `<div class="kumbara-verilen-adres">${verilenKisiAdres}</div>` : ''}
            </div>
          ` : ''}
          <div class="kumbara-actions">
            ${!k.dagitildi ? `<button class="btn btn-primary" onclick="dagitimAc('${k.id}')">DaÄŸÄ±t</button>` : ''}
            ${k.dagitildi && !(k.toplandi === true) ? `<div class="hint" style="margin-top:8px; padding:8px; background:var(--surface2); border-radius:8px; font-size:12px">â„¹ï¸ Bu kumbara daÄŸÄ±tÄ±ldÄ±. Toplama iÅŸlemi yÃ¶netim panelinden yapÄ±lacaktÄ±r.</div>` : ''}
            ${(k.toplandi === true && !k.sayimasamasinda && !k.tamamlandi) ? `<div class="hint" style="margin-top:8px; padding:8px; background:rgba(245,158,11,.1); border-radius:8px; font-size:12px; color:var(--warning)">âœ“ ToplandÄ± - SayÄ±m aÅŸamasÄ±nda</div>` : ''}
            ${k.sayimasamasinda === true ? `<div class="hint" style="margin-top:8px; padding:8px; background:rgba(59,130,246,.1); border-radius:8px; font-size:12px; color:var(--brand)">ğŸ” SayÄ±m AÅŸamasÄ±nda</div>` : ''}
            ${k.tamamlandi === true && k.icindencikanmiktar && k.icindencikanmiktar > 0 ? `<div class="hint" style="margin-top:8px; padding:8px; background:rgba(34,197,94,.1); border-radius:8px; font-size:12px; color:var(--success)">ğŸ’° Ä°Ã§inden Ã‡Ä±kan: ${k.icindencikanmiktar.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2})} â‚º</div>` : ''}
          </div>
        </div>
      `;
    }).join('');
  }catch(e){
    console.error(e);
    container.innerHTML = '<div class="empty">Hata: ' + (e.message || e) + '</div>';
    if(typeof window.showToast === 'function') window.showToast('error', 'Hata', 'Kumbaralar yÃ¼klenirken hata oluÅŸtu.');
  }
}

/* ===== KPI GÃ¼ncelleme ===== */
async function guncelleKPI(){
  const supabase = window.supabase;
  if(!supabase) return;
  
  try{
    let query = supabase
      .from('kumbaralar')
      .select('*, toplandi, toplamatarihi, sayimasamasinda, tamamlandi, icindencikanmiktar')
      .eq('zimmetli', true);
    
    if(!isYonetici){
      query = query.eq('zimmetlipersonel', currentUserName);
    } else if(seciliPersonel){
      // YÃ¶netici ve personel seÃ§ilmiÅŸse filtrele
      query = query.eq('zimmetlipersonel', seciliPersonel);
    }
    
    const { data: snap, error } = await query;
    
    if(error) throw error;
    
    let toplamZimmetlenen = 0;
    let dagitildi = 0;
    let toplandi = 0;
    
    (snap || []).forEach(row=>{
      toplamZimmetlenen++;
      if(row.dagitildi) dagitildi++;
      if(row.toplandi === true) toplandi++;
    });
    
    document.getElementById('kpiZimmetlenen').textContent = toplamZimmetlenen;
    document.getElementById('kpiDagitildi').textContent = dagitildi;
    document.getElementById('kpiToplandi').textContent = toplandi;
  }catch(e){
    console.error(e);
  }
}

/* ===== DaÄŸÄ±tÄ±m Modal ===== */
// Global event handler'lar (bir kez tanÄ±mlanÄ±r)
let modalEscHandler = null;
let modalClickHandler = null;

async function dagitimAc(kumbaraId){
  const supabase = window.supabase;
  if(!supabase) return;
  
  const modal = document.getElementById('dagitimModal');
  if(!modal) return;
  
  document.getElementById('dagitimKumbaraId').value = kumbaraId;
  
  // Kumbara bilgilerini yÃ¼kle
  try {
    const { data, error } = await supabase
      .from('kumbaralar')
      .select('*')
      .eq('id', kumbaraId)
      .single();
    
    if(error) throw error;
    
    if(data){
      const turLabel = data.tur === 'kumbara' ? 'Kumbara' : 'Sadaka';
      document.getElementById('dagitimKumbaraBilgi').textContent = `${turLabel} #${data.numara || '-'} - ${data.zimmetlipersonel || '-'}`;
    }
  } catch(e) {
    console.error(e);
  }
  
  // Formu temizle
  document.getElementById('dagitimAdSoyad').value = '';
  document.getElementById('dagitimAdres').value = '';
  
  // Modal'Ä± aÃ§
  modal.classList.add('show');
  document.body.style.overflow = 'hidden';
  
  // ESC tuÅŸu ile kapatma (sadece bir kez ekle)
  if(!modalEscHandler) {
    modalEscHandler = (e) => {
      if(e.key === 'Escape') {
        dagitimModalKapat();
      }
    };
    document.addEventListener('keydown', modalEscHandler);
  }
  
  // Modal dÄ±ÅŸÄ±na tÄ±klanÄ±nca kapatma (sadece bir kez ekle)
  if(!modalClickHandler) {
    modalClickHandler = (e) => {
      if(e.target === modal) {
        dagitimModalKapat();
      }
    };
    modal.addEventListener('click', modalClickHandler);
  }
}

function dagitimModalKapat(){
  const modal = document.getElementById('dagitimModal');
  if(!modal) return;
  
  modal.classList.remove('show');
  document.body.style.overflow = '';
  
  // Formu temizle
  document.getElementById('dagitimAdSoyad').value = '';
  document.getElementById('dagitimAdres').value = '';
}

async function dagitimKaydet(){
  const supabase = window.supabase;
  if(!supabase) return;
  
  const kumbaraId = document.getElementById('dagitimKumbaraId').value;
  const adSoyad = document.getElementById('dagitimAdSoyad').value.trim();
  const adres = document.getElementById('dagitimAdres').value.trim();
  
  if(!adSoyad){
    if(typeof window.showToast === 'function') window.showToast('warning', 'UyarÄ±', 'Verilen kiÅŸi adÄ± soyadÄ± zorunludur.');
    return;
  }
  
  try{
    const { error } = await supabase
      .from('kumbaralar')
      .update({
        dagitildi: true,
        dagitimtarihi: tsISO(),
        verilenkisiadsoyad: adSoyad,
        verilenkisiadres: adres || '',
        updatedat: tsISO(),
        updatedby: currentUser?.email || null
      })
      .eq('id', kumbaraId);
    
    if(error) throw error;
    
    if(typeof window.showToast === 'function') window.showToast('success', 'BaÅŸarÄ±lÄ±', 'DaÄŸÄ±tÄ±m kaydedildi.');
    dagitimModalKapat();
    await yukleKumbaralar();
    await guncelleKPI();
  }catch(e){
    console.error(e);
    if(typeof window.showToast === 'function') window.showToast('error', 'Hata', 'DaÄŸÄ±tÄ±m kaydedilemedi.');
  }
}

/* ===== Dashboard/Rapor ===== */
let dashboardPersonelList = [];
let dashboardSortState = { key: null, dir: 'asc' };

// Nispet iÃ§in renk hesaplama (kÄ±rmÄ±zÄ±dan yeÅŸile)
function getProgressColor(percent){
  percent = Math.max(0, Math.min(100, percent));
  if(percent <= 50){
    // 0-50: kÄ±rmÄ±zÄ±dan sarÄ±ya
    const ratio = percent / 50;
    const r = Math.round(239 + (245 - 239) * ratio); // 239 -> 245
    const g = Math.round(68 + (158 - 68) * ratio);   // 68 -> 158
    const b = Math.round(68 + (11 - 68) * ratio);     // 68 -> 11
    return `rgb(${r}, ${g}, ${b})`;
  } else {
    // 50-100: sarÄ±dan yeÅŸile
    const ratio = (percent - 50) / 50;
    const r = Math.round(245 + (34 - 245) * ratio);  // 245 -> 34
    const g = Math.round(158 + (197 - 158) * ratio);  // 158 -> 197
    const b = Math.round(11 + (94 - 11) * ratio);      // 11 -> 94
    return `rgb(${r}, ${g}, ${b})`;
  }
}

async function yukleDashboardRapor(){
  const supabase = window.supabase;
  if(!supabase) return;
  
  const tur = document.getElementById('dashboardTur').value;
  const container = document.getElementById('dashboardRapor');
  const ozetContainer = document.getElementById('dashboardOzet');
  
  container.innerHTML = '<div class="muted" style="padding:12px">YÃ¼kleniyor...</div>';
  ozetContainer.innerHTML = '';
  
  try{
    let query = supabase
      .from('kumbaralar')
      .select('*, toplandi, toplamatarihi, sayimasamasinda, tamamlandi, icindencikanmiktar');
    
    if(tur) query = query.eq('tur', tur);
    
    const { data: snap, error } = await query;
    
    if(error) throw error;
    
    if(!snap || snap.length === 0){
      container.innerHTML = '<div class="muted" style="padding:12px">KayÄ±t bulunamadÄ±.</div>';
      return;
    }
    
    // Personel bazÄ±nda grupla
    const personelMap = new Map();
    
    snap.forEach(row=>{
      const data = row;
      const personel = data.zimmetlipersonel || 'ZimmetlenmemiÅŸ';
      
      if(!personelMap.has(personel)){
        personelMap.set(personel, {
          personel: personel,
          zimmetlenen: 0,
          dagitilan: 0,
          toplanan: 0,
          toplamMiktar: 0
        });
      }
      
      const stats = personelMap.get(personel);
      
      // Zimmetlenen
      if(data.zimmetli === true){
        stats.zimmetlenen++;
      }
      
      // DaÄŸÄ±tÄ±lan
      if(data.dagitildi === true){
        stats.dagitilan++;
      }
      
      // Toplanan
      if(data.toplandi === true){
        stats.toplanan++;
      }
      
      // Toplam Miktar (sadece tamamlananlar iÃ§in)
      if(data.tamamlandi === true && data.icindencikanmiktar){
        stats.toplamMiktar += Number(data.icindencikanmiktar) || 0;
      }
    });
    
    // Hesaplamalar ekle
    const personelList = Array.from(personelMap.values()).map(p=>{
      const kalan = p.zimmetlenen - p.toplanan;
      const dagitmaNispeti = p.zimmetlenen > 0 ? Math.round((p.dagitilan / p.zimmetlenen) * 100) : 0;
      const toplamaNispeti = p.zimmetlenen > 0 ? Math.round((p.toplanan / p.zimmetlenen) * 100) : 0;
      return {
        ...p,
        kalan: kalan,
        dagitmaNispeti: dagitmaNispeti,
        toplamaNispeti: toplamaNispeti
      };
    });
    
    // Personel listesini sÄ±rala (zimmetlenmemiÅŸ en sonda)
    dashboardPersonelList = personelList.sort((a,b)=>{
      if(a.personel === 'ZimmetlenmemiÅŸ') return 1;
      if(b.personel === 'ZimmetlenmemiÅŸ') return -1;
      return a.personel.localeCompare(b.personel, 'tr-TR');
    });
    
    // Ã–zet kartlarÄ±
    const toplamZimmetlenen = dashboardPersonelList.reduce((sum, p)=>sum + p.zimmetlenen, 0);
    const toplamDagitilan = dashboardPersonelList.reduce((sum, p)=>sum + p.dagitilan, 0);
    const toplamToplanan = dashboardPersonelList.reduce((sum, p)=>sum + p.toplanan, 0);
    const toplamMiktar = dashboardPersonelList.reduce((sum, p)=>sum + p.toplamMiktar, 0);
    
    ozetContainer.innerHTML = `
      <div class="col-3">
        <div style="background:var(--surface2); border:1px solid var(--stroke); border-radius:12px; padding:16px; text-align:center">
          <div style="font-size:24px; font-weight:800; color:var(--brand); margin-bottom:4px">${toplamZimmetlenen}</div>
          <div style="font-size:13px; color:var(--muted)">Toplam Zimmetlenen</div>
        </div>
      </div>
      <div class="col-3">
        <div style="background:var(--surface2); border:1px solid var(--stroke); border-radius:12px; padding:16px; text-align:center">
          <div style="font-size:24px; font-weight:800; color:var(--success); margin-bottom:4px">${toplamDagitilan}</div>
          <div style="font-size:13px; color:var(--muted)">Toplam DaÄŸÄ±tÄ±lan</div>
        </div>
      </div>
      <div class="col-3">
        <div style="background:var(--surface2); border:1px solid var(--stroke); border-radius:12px; padding:16px; text-align:center">
          <div style="font-size:24px; font-weight:800; color:rgba(245,158,11,1); margin-bottom:4px">${toplamToplanan}</div>
          <div style="font-size:13px; color:var(--muted)">Toplam Toplanan</div>
        </div>
      </div>
      <div class="col-3">
        <div style="background:var(--surface2); border:1px solid var(--stroke); border-radius:12px; padding:16px; text-align:center">
          <div style="font-size:24px; font-weight:800; color:var(--brand2); margin-bottom:4px">${toplamMiktar.toLocaleString('tr-TR', {minimumFractionDigits: 0, maximumFractionDigits: 0})} â‚º</div>
          <div style="font-size:13px; color:var(--muted)">Toplam Miktar</div>
        </div>
      </div>
    `;
    
    renderDashboardTable();
    
  }catch(e){
    console.error(e);
    container.innerHTML = '<div class="muted" style="padding:12px">Hata: ' + (e.message || e) + '</div>';
    if(typeof window.showToast === 'function') window.showToast('error', 'Hata', 'Rapor yÃ¼klenirken hata oluÅŸtu.');
  }
}

function renderDashboardTable(){
  const container = document.getElementById('dashboardRapor');
  
  // SÄ±ralama
  if(dashboardSortState.key){
    dashboardPersonelList.sort((a,b)=>{
      let valA = a[dashboardSortState.key];
      let valB = b[dashboardSortState.key];
      
      if(typeof valA === 'string') valA = valA.toLowerCase();
      if(typeof valB === 'string') valB = valB.toLowerCase();
      
      if(dashboardSortState.dir === 'asc'){
        return valA > valB ? 1 : (valA < valB ? -1 : 0);
      } else {
        return valA < valB ? 1 : (valA > valB ? -1 : 0);
      }
    });
  }
  
  // SÃ¼tun gÃ¶rÃ¼nÃ¼rlÃ¼ÄŸÃ¼ kontrolÃ¼
  const colVisibility = {
    personel: document.querySelector('.col-toggle[data-col="personel"]')?.checked ?? true,
    zimmetlenen: document.querySelector('.col-toggle[data-col="zimmetlenen"]')?.checked ?? true,
    dagitilan: document.querySelector('.col-toggle[data-col="dagitilan"]')?.checked ?? true,
    dagitmaNispeti: document.querySelector('.col-toggle[data-col="dagitmaNispeti"]')?.checked ?? true,
    toplanan: document.querySelector('.col-toggle[data-col="toplanan"]')?.checked ?? true,
    kalan: document.querySelector('.col-toggle[data-col="kalan"]')?.checked ?? true,
    toplamaNispeti: document.querySelector('.col-toggle[data-col="toplamaNispeti"]')?.checked ?? true,
    miktar: document.querySelector('.col-toggle[data-col="miktar"]')?.checked ?? true
  };
  
  // Tablo oluÅŸtur
  let html = `
    <table id="dashboardTable">
      <thead>
        <tr>
          ${colVisibility.personel ? `<th class="sortable" data-key="personel" style="text-align:left; cursor:pointer">Personel AdÄ± SoyadÄ±</th>` : ''}
          ${colVisibility.zimmetlenen ? `<th class="sortable" data-key="zimmetlenen" style="text-align:center; cursor:pointer">Zimmetlenen</th>` : ''}
          ${colVisibility.dagitilan ? `<th class="sortable" data-key="dagitilan" style="text-align:center; cursor:pointer">DaÄŸÄ±tÄ±lan</th>` : ''}
          ${colVisibility.dagitmaNispeti ? `<th class="sortable" data-key="dagitmaNispeti" style="text-align:center; cursor:pointer">DaÄŸÄ±tma Nispeti (%)</th>` : ''}
          ${colVisibility.toplanan ? `<th class="sortable" data-key="toplanan" style="text-align:center; cursor:pointer">Toplanan</th>` : ''}
          ${colVisibility.kalan ? `<th class="sortable" data-key="kalan" style="text-align:center; cursor:pointer">Kalan</th>` : ''}
          ${colVisibility.toplamaNispeti ? `<th class="sortable" data-key="toplamaNispeti" style="text-align:center; cursor:pointer">Toplama Nispeti (%)</th>` : ''}
          ${colVisibility.miktar ? `<th class="sortable" data-key="toplamMiktar" style="text-align:right; cursor:pointer">Miktar (â‚º)</th>` : ''}
        </tr>
      </thead>
      <tbody>
  `;
  
  dashboardPersonelList.forEach(p=>{
    const personelAd = p.personel === 'ZimmetlenmemiÅŸ' ? '<span class="muted">ZimmetlenmemiÅŸ</span>' : p.personel;
    const miktarFormat = p.toplamMiktar > 0 ? 
      p.toplamMiktar.toLocaleString('tr-TR', {minimumFractionDigits: 0, maximumFractionDigits: 0}) + ' â‚º' : 
      '<span class="muted">-</span>';
    
    // DaÄŸÄ±tma Nispeti iÃ§in ilerleme Ã§ubuÄŸu
    const dagitmaNispetiColor = getProgressColor(p.dagitmaNispeti);
    const dagitmaNispetiBar = colVisibility.dagitmaNispeti ? `
      <td style="text-align:center; padding:8px 12px">
        <div class="progress-bar-container" style="max-width:180px; margin:0 auto">
          <div class="progress-bar-fill" style="width:${p.dagitmaNispeti}%; background-color:${dagitmaNispetiColor}">
            ${p.dagitmaNispeti > 15 ? `%${p.dagitmaNispeti}` : ''}
          </div>
          <div class="progress-bar-text" style="${p.dagitmaNispeti > 15 ? 'display:none' : ''}">%${p.dagitmaNispeti}</div>
        </div>
      </td>
    ` : '';
    
    // Toplama Nispeti iÃ§in ilerleme Ã§ubuÄŸu
    const toplamaNispetiColor = getProgressColor(p.toplamaNispeti);
    const toplamaNispetiBar = colVisibility.toplamaNispeti ? `
      <td style="text-align:center; padding:8px 12px">
        <div class="progress-bar-container" style="max-width:180px; margin:0 auto">
          <div class="progress-bar-fill" style="width:${p.toplamaNispeti}%; background-color:${toplamaNispetiColor}">
            ${p.toplamaNispeti > 15 ? `%${p.toplamaNispeti}` : ''}
          </div>
          <div class="progress-bar-text" style="${p.toplamaNispeti > 15 ? 'display:none' : ''}">%${p.toplamaNispeti}</div>
        </div>
      </td>
    ` : '';
    
    html += '<tr>';
    if(colVisibility.personel) html += `<td style="font-weight:700">${personelAd}</td>`;
    if(colVisibility.zimmetlenen) html += `<td style="text-align:center; font-weight:700; color:var(--brand)">${p.zimmetlenen}</td>`;
    if(colVisibility.dagitilan) html += `<td style="text-align:center; font-weight:700; color:var(--success)">${p.dagitilan}</td>`;
    if(colVisibility.dagitmaNispeti) html += dagitmaNispetiBar;
    if(colVisibility.toplanan) html += `<td style="text-align:center; font-weight:700; color:rgba(245,158,11,1)">${p.toplanan}</td>`;
    if(colVisibility.kalan) html += `<td style="text-align:center; font-weight:700; color:var(--danger)">${p.kalan}</td>`;
    if(colVisibility.toplamaNispeti) html += toplamaNispetiBar;
    if(colVisibility.miktar) html += `<td style="text-align:right; font-weight:700; color:var(--brand2)">${miktarFormat}</td>`;
    html += '</tr>';
  });
  
  html += '</tbody></table>';
  container.innerHTML = html;
  
  // SÄ±ralama event listener'larÄ±
  container.querySelectorAll('.sortable').forEach(th=>{
    th.addEventListener('click', ()=>{
      const key = th.dataset.key;
      if(dashboardSortState.key === key){
        dashboardSortState.dir = dashboardSortState.dir === 'asc' ? 'desc' : 'asc';
      } else {
        dashboardSortState.key = key;
        dashboardSortState.dir = 'asc';
      }
      renderDashboardTable();
    });
  });
}

// SÃ¼tun gizleme/gÃ¶sterme
document.addEventListener('change', (e)=>{
  if(e.target.classList.contains('col-toggle')){
    renderDashboardTable();
  }
});

document.getElementById('btnDashboardYukle').addEventListener('click', yukleDashboardRapor);
document.getElementById('btnDashboardYenile').addEventListener('click', yukleDashboardRapor);

</script>
</body>
</html>

