<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Ä°ftar-Sahur YÃ¶netim Paneli | Ramazan-Ä± Åerif</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <link rel="icon" type="image/png" href="../img/logo.png" />

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="../../js/firebase/firebase-init.js"></script>

  <style>
    :root{
      --appbar-h:56px;
      --bg:#f4f6f9; --card:#ffffff; --ink:#2c3e50; --muted:#6c7a89;
      --accent:#324960; --good:#2d6a4f; --warn:#d35400; --bad:#c0392b;
      --border:#e6ebf2; --stroke:rgba(15,23,42,.12); --text:#0b1220;
      --surface:#f1f5ff; --surface2:#f6f8ff; --shadow:0 12px 28px rgba(0,0,0,.12);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Segoe UI',system-ui,-apple-system,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    img{max-width:100%;height:auto;display:block}
    
    /* APPBAR */
    .appbar{
      position:sticky; top:0; z-index:60; height:var(--appbar-h);
      background:var(--card); backdrop-filter:blur(10px);
      border-bottom:1px solid var(--stroke);
      display:flex; align-items:center; gap:10px; padding:0 12px;
    }
    .brand{display:flex; align-items:center; gap:10px; cursor:pointer}
    .brand img{width:24px; height:24px}
    .brand span{font-weight:900; letter-spacing:.02em; color:var(--text)}
    .nav-center{margin:0 auto; height:100%}
    .nav-list{display:flex; gap:22px; align-items:center; height:100%; list-style:none; margin:0; padding:0}
    .nav-item{position:relative; height:100%}
    .nav-btn{height:100%; display:flex; align-items:center; gap:6px; font-weight:800; cursor:pointer; color:var(--text)}
    .nav-btn:hover{color:var(--accent)}
    .caret{font-size:12px; opacity:.6}
    .dropdown{position:absolute; top:100%; left:0; min-width:240px; background:var(--card); border:1px solid var(--stroke); border-radius:12px; box-shadow:var(--shadow); padding:8px; display:none}
    .dropdown a{display:flex; align-items:center; gap:8px; padding:10px 12px; border-radius:10px; color:var(--text); text-decoration:none}
    .dropdown a:hover{background:var(--surface2)}
    .nav-item.open .dropdown{display:block}
    .nav-right{display:flex; gap:8px; align-items:center}
    .btn{border:1px solid var(--stroke); background:var(--surface2); color:var(--text); border-radius:999px; padding:8px 14px; cursor:pointer; white-space:nowrap; font-weight:700}
    .hamb{display:none}
    .iconbtn{position:relative; border:1px solid var(--stroke); background:var(--card); color:var(--text); border-radius:999px; padding:8px 12px; cursor:pointer; display:flex; align-items:center; gap:8px}
    .drop-right{left:auto; right:0}
    .avatar{width:22px;height:22px;border-radius:999px;background:linear-gradient(180deg,#94a3b8,#64748b)}
    .muted{color:var(--muted)}
    @media (max-width: 960px){ .nav-center{display:none} .hamb{display:inline-flex} }

    /* DRAWER */
    .drawer{position:fixed; top:var(--appbar-h); right:0; bottom:0; left:34%; transform:translateX(100%); transition:.25s; background:var(--card); border-left:1px solid var(--stroke); z-index:70; overflow:auto; padding:16px}
    .drawer.open{transform:translateX(0)}
    .drawer .panel-title{margin:14px 4px 6px; font-weight:800; color:var(--muted); font-size:13px}
    .drawer a{display:block; padding:12px; border-radius:12px; border:1px solid var(--stroke); margin:8px 0; color:var(--text); background:var(--surface2); text-decoration:none}
    .drawer a:hover{background:var(--surface)}
    
    header{position:sticky;top:var(--appbar-h);z-index:5;background:var(--card);border-bottom:1px solid var(--border);box-shadow:0 2px 4px rgba(0,0,0,.05)}
    .wrap{max-width:1400px;margin:0 auto;padding:12px 16px}
    
    .toolbar{display:flex;gap:10px;flex-wrap:nowrap;align-items:center;overflow:auto;padding-bottom:6px}
    .toolbar::-webkit-scrollbar{height:6px}
    .toolbar::-webkit-scrollbar-thumb{background:#d7dde6;border-radius:999px}
    .line{height:1px;background:var(--border);margin:8px 0}
    header strong{font-size:clamp(16px,3.8vw,18px);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:40vw}
    .chip{padding:8px 10px;border-radius:999px;border:1px solid var(--border);background:#fff;color:var(--muted);font-size:12px;white-space:nowrap}
    select,input,button{
      height:38px;border:1px solid var(--border);background:#fff;border-radius:10px;padding:0 12px;font:inherit;color:var(--ink)
    }
    button{background:var(--accent);color:#fff;border:none;cursor:pointer;font-weight:500}
    button.secondary{background:#fff;color:var(--ink);border:1px solid var(--border)}
    button:hover{opacity:0.9}
    button.danger{background:var(--bad);color:#fff}
    
    /* Tabs */
    .tabs{display:flex;gap:4px;border-bottom:2px solid var(--border);margin:16px 0;overflow-x:auto}
    .tab{
      padding:12px 20px;border:none;background:transparent;color:var(--muted);cursor:pointer;
      border-bottom:3px solid transparent;white-space:nowrap;font-weight:500;transition:all 0.2s
    }
    .tab:hover{color:var(--ink);background:#f8f9fa}
    .tab.active{color:var(--accent);border-bottom-color:var(--accent);background:#fff}
    
    .tab-content{display:none}
    .tab-content.active{display:block}
    
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;margin:12px 0}
    
    /* Tablo */
    .table-wrap{overflow:auto;border:1px solid var(--border);border-radius:12px}
    table{width:100%;border-collapse:collapse;background:#fff;min-width:900px}
    thead th{
      position:sticky;top:0;background:#fafbfc;border-bottom:2px solid var(--border);
      font-weight:600;text-align:left;font-size:13px;color:var(--muted);padding:12px;z-index:1
    }
    tbody td{border-bottom:1px solid var(--border);padding:12px;font-size:14px}
    tbody tr:hover{background:#f8f9fa}
    .right{text-align:right}
    
    /* Modal */
    body.modal-open{overflow:hidden}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center;padding:16px;z-index:9999;backdrop-filter:blur(4px)}
    .modal.show{display:flex}
    .sheet{max-width:700px;width:100%;max-height:90vh;overflow-y:auto;background:#fff;border-radius:16px;padding:20px;border:1px solid var(--border);box-shadow:0 20px 40px rgba(0,0,0,.2)}
    .sheet h3{margin:0 0 16px 0;font-size:20px;color:var(--ink)}
    .form-grid{display:grid;gap:14px}
    .form-group{display:flex;flex-direction:column;gap:6px}
    .form-group label{font-size:13px;font-weight:600;color:var(--muted)}
    .form-group input,.form-group select{
      width:100%;height:42px;border:1px solid var(--border);border-radius:10px;padding:0 12px;font:inherit;font-size:14px
    }
    .actions{display:flex;justify-content:flex-end;gap:10px;margin-top:20px;padding-top:16px;border-top:1px solid var(--border)}
    
    /* Ä°statistikler */
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin:16px 0}
    .stat-card{
      background:#fff;border:1px solid var(--border);border-radius:12px;padding:16px;
      display:flex;flex-direction:column;gap:8px
    }
    .stat-label{color:var(--muted);font-size:12px;font-weight:600}
    .stat-value{font-size:24px;font-weight:700;color:var(--ink)}
    
    /* Analiz Grafikleri */
    .chart-container{position:relative;height:300px;margin:16px 0}
    .progress-bar{height:24px;background:#f0f0f0;border-radius:12px;overflow:hidden;position:relative}
    .progress-fill{height:100%;background:linear-gradient(90deg,var(--good),var(--accent));transition:width 0.3s}
    .trend-up{color:var(--good);font-weight:600}
    .trend-down{color:var(--bad);font-weight:600}
    .trend-same{color:var(--muted);font-weight:600}
    .badge-daimi{background:#e8f5e9;color:var(--good);padding:4px 8px;border-radius:4px;font-size:11px;font-weight:600}
    .badge-yeni{background:#e3f2fd;color:#1976d2;padding:4px 8px;border-radius:4px;font-size:11px;font-weight:600}
    .badge-pasif{background:#fef3c7;color:#d97706;padding:4px 8px;border-radius:4px;font-size:11px;font-weight:600}
    
    /* Toasts (modern & minimalist) */
    .toast-container{
      position:fixed;
      top:72px;
      right:16px;
      z-index:12000;
      display:flex;
      flex-direction:column;
      gap:8px;
      pointer-events:none;
    }
    .toast{
      min-width:260px;
      max-width:360px;
      background:rgba(15,23,42,.96);
      color:#f9fafb;
      border-radius:12px;
      padding:10px 12px;
      display:flex;
      align-items:flex-start;
      gap:8px;
      box-shadow:0 18px 40px rgba(15,23,42,.35);
      transform:translateY(-8px) translateX(8px);
      opacity:0;
      transition:all .25s ease;
      pointer-events:auto;
      border:1px solid rgba(148,163,184,.35);
      backdrop-filter:blur(14px);
      -webkit-backdrop-filter:blur(14px);
      font-size:13px;
    }
    .toast.show{
      opacity:1;
      transform:translateY(0) translateX(0);
    }
    .toast-icon{
      font-size:18px;
      margin-top:2px;
    }
    .toast-content{
      flex:1;
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .toast-title{
      font-weight:600;
      letter-spacing:.01em;
    }
    .toast-message{
      font-size:12px;
      color:#e5e7eb;
    }
    .toast-close{
      background:transparent;
      border:none;
      color:#94a3b8;
      font-size:16px;
      cursor:pointer;
      padding:0 0 0 4px;
      line-height:1;
    }
    .toast-close:hover{
      color:#e5e7eb;
    }
    .toast.success{
      border-left:3px solid #22c55e;
    }
    .toast.error{
      border-left:3px solid #ef4444;
    }
    .toast.warning{
      border-left:3px solid #f59e0b;
    }
    .toast.info{
      border-left:3px solid #3b82f6;
    }
    @media (max-width:640px){
      .toast-container{
        left:12px;
        right:12px;
      }
      .toast{
        width:100%;
        max-width:none;
      }
    }

    /* Takvim Tab */
    .cal-wrapper{display:flex;flex-direction:column;gap:8px;margin-top:12px}
    .cal-dow-row{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
    .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
    .cal-dow{text-align:center;font-size:12px;font-weight:600;color:var(--muted);padding:8px}
    .cal-day{
      aspect-ratio:1;border:1px solid var(--border);border-radius:8px;padding:6px;
      background:#fff;cursor:pointer;min-height:60px;display:flex;flex-direction:column;justify-content:space-between;font-size:12px
    }
    .cal-day.has-data{background:#e8f5e9;border-color:var(--good)}
    .cal-day.today{border-color:var(--accent);border-width:2px}
    .cal-day.selected{
      box-shadow:0 0 0 2px rgba(37,99,235,.3);
      border-color:var(--accent);
    }
    .cal-day.outside-ramazan{
      background:#f9fafb;
      color:var(--muted);
      cursor:default;
    }
    
    .badge-chip{padding:4px 8px;border-radius:4px;background:#f0f0f0;color:var(--ink);font-size:11px;display:inline-block;margin:2px}
    .badge-chip.iftar{background:#fff3cd;color:#856404}
    .badge-chip.sahur{background:#d1ecf1;color:#0c5460}
    
    @media (max-width:768px){
      .tabs{overflow-x:auto;-webkit-overflow-scrolling:touch}
      .table-wrap{font-size:12px}
    }
  </style>
</head>
<body>

<!-- APPBAR -->
<div class="appbar">
  <div class="brand" onclick="location.href='../panel.html'">
    <img src="../img/logo.png" alt="logo"><span>KARAAÄAÃ‡ FATÄ°H</span>
  </div>
  <nav class="nav-center"><ul class="nav-list" id="navMain"></ul></nav>
  <div class="nav-right">
    <button class="btn hamb" id="hamburger" title="MenÃ¼">â˜°</button>
    <div class="nav-item">
      <button class="iconbtn" id="btnProfile" title="Profil">
        <span class="avatar"></span> <span id="profName" class="muted">Profil</span>
      </button>
      <div class="dropdown drop-right" id="profDropdown">
        <a href="../diger/kullanici-yonetimi.html">ğŸ‘¤ Profil</a>
        <a href="../diger/sistem-ayarlari.html">âš™ï¸ Ayarlar</a>
        <a href="#" id="btnLogout">ğŸšª Ã‡Ä±kÄ±ÅŸ Yap</a>
      </div>
    </div>
  </div>
</div>
<aside class="drawer" id="drawer"></aside>

<!-- Toast Container -->
<div class="toast-container" id="toastContainer"></div>

<!-- Progress Bar -->
<div class="progress-container" id="progressContainer">
  <div class="progress-bar-fill" id="progressBar"></div>
</div>

<header>
  <div class="wrap">
    <h2 style="margin:12px 0 8px 0;font-size:24px;font-weight:800">Ramazan-Ä± Åerif</h2>
    <div class="muted" style="margin-bottom:12px">Ä°ftar-Sahur YÃ¶netim Paneli</div>
  </div>
</header>

<main class="wrap">
    <div class="tabs">
      <button class="tab active" data-tab="kayitlar">ğŸ“‹ KayÄ±tlar</button>
      <button class="tab" data-tab="talepler">ğŸ“ Talepler</button>
      <button class="tab" data-tab="menu">ğŸ½ï¸ MenÃ¼</button>
      <button class="tab" data-tab="takvim">ğŸ“… Takvim GÃ¶rÃ¼nÃ¼mÃ¼</button>
      <button class="tab" data-tab="ayarlar">âš™ï¸ Ayarlar</button>
      <button class="tab" data-tab="hedef">ğŸ¯ Hedef YÃ¶netimi</button>
      <button class="tab" data-tab="veri-duzenleme">âœï¸ Veri DÃ¼zenleme</button>
      <button class="tab" data-tab="istatistik">ğŸ“Š Ä°statistikler</button>
      <button class="tab" data-tab="export">ğŸ“¤ Ä°Ã§e/DÄ±ÅŸa Aktar</button>
    </div>

    <!-- Tab: KayÄ±tlar -->
    <div class="tab-content active" id="tab-kayitlar">
      <div class="card">
        <div class="toolbar">
          <select id="filtreYil">
            <option value="2024">2024</option>
            <option value="2025" selected>2025</option>
            <option value="2026">2026</option>
          </select>
          <select id="filtreAy">
            <option value="">TÃ¼m Aylar</option>
          </select>
          <select id="filtreTip">
            <option value="">TÃ¼m Tipler</option>
            <option value="iftar">Ä°ftar</option>
            <option value="sahur">Sahur</option>
            <option value="teberru">Teberru</option>
            <option value="taahhut">TaahhÃ¼t</option>
          </select>
          <select id="filtreTarih" style="display:none;">
            <option value="">TÃ¼m Tarihler</option>
          </select>
          <input type="text" id="araInput" placeholder="Sahip, Personel ara..." style="flex:1;min-width:200px" />
          <button onclick="filterKayitlar()">Filtrele</button>
          <button class="good" onclick="openEditModal()">+ Yeni KayÄ±t</button>
        </div>

        <div class="table-wrap">
          <table id="tblKayitlar">
            <thead>
              <tr>
                <th>Tarih</th>
                <th>Tip</th>
                <th>Sahip</th>
                <th>Tutar (â‚º)</th>
                <th>Ä°ÅŸtirak</th>
                <th>MÃ¼safir</th>
                <th>Mahal</th>
                <th>Personel</th>
                <th>Not</th>
                <th style="width:120px">Ä°ÅŸlemler</th>
              </tr>
            </thead>
            <tbody id="tbodyKayitlar"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Tab: Talepler -->
    <div class="tab-content" id="tab-talepler">
      <div class="card">
        <div class="toolbar">
          <select id="taleplerFiltreYil">
            <option value="2024">2024</option>
            <option value="2025" selected>2025</option>
            <option value="2026">2026</option>
          </select>
          <select id="taleplerFiltreDurum">
            <option value="">TÃ¼m Durumlar</option>
            <option value="beklemede" selected>Beklemede</option>
            <option value="onaylandi">OnaylandÄ±</option>
            <option value="reddedildi">Reddedildi</option>
          </select>
          <select id="taleplerFiltreTip">
            <option value="">TÃ¼m Tipler</option>
            <option value="duzenle">DÃ¼zenle</option>
            <option value="yer_degistir">Yer DeÄŸiÅŸtir</option>
            <option value="sil">Sil</option>
          </select>
          <input type="text" id="taleplerAraInput" placeholder="Personel, Sahip ara..." style="flex:1;min-width:200px" />
          <button onclick="filterTalepler()">Filtrele</button>
          <button onclick="loadTalepler()">ğŸ”„ Yenile</button>
        </div>

        <div class="table-wrap">
          <table id="tblTalepler">
            <thead>
              <tr>
                <th>Talep Tarihi</th>
                <th>Tip</th>
                <th>Talep Tipi</th>
                <th>KayÄ±t Tipi</th>
                <th>Sahip</th>
                <th>Mevcut Tarih</th>
                <th>MÃ¼safir</th>
                <th>Tutar</th>
                <th>Ä°ÅŸtirak</th>
                <th>Mahal</th>
                <th>Personel</th>
                <th>AÃ§Ä±klama</th>
                <th>Yeni Tarih</th>
                <th>Durum</th>
                <th style="width:180px">Ä°ÅŸlemler</th>
              </tr>
            </thead>
            <tbody id="tbodyTalepler"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Tab: MenÃ¼ -->
    <div class="tab-content" id="tab-menu">
      <div class="card">
        <div class="toolbar">
          <select id="menuFiltreYil">
            <option value="2024">2024</option>
            <option value="2025" selected>2025</option>
            <option value="2026">2026</option>
          </select>
          <select id="menuFiltreTip">
            <option value="">TÃ¼m Tipler</option>
            <option value="iftar">Ä°ftar</option>
            <option value="sahur">Sahur</option>
          </select>
          <input type="date" id="menuFiltreTarih" style="margin-right:8px" />
          <button onclick="filterMenuler()">Filtrele</button>
          <button onclick="loadMenuler()">ğŸ”„ Yenile</button>
          <button class="good" onclick="openMenuModal()">+ Yeni MenÃ¼ Ekle</button>
        </div>

        <div class="table-wrap" style="margin-top:16px">
          <table id="tblMenuler">
            <thead>
              <tr>
                <th>Tarih</th>
                <th>Tip</th>
                <th>Ã‡orba</th>
                <th>Yemek</th>
                <th>SoÄŸuk</th>
                <th>Ä°Ã§ecek</th>
                <th>DiÄŸer</th>
                <th style="width:120px">Ä°ÅŸlemler</th>
              </tr>
            </thead>
            <tbody id="tbodyMenuler"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Tab: Takvim GÃ¶rÃ¼nÃ¼mÃ¼ -->
    <div class="tab-content" id="tab-takvim">
      <div class="card">
        <div class="toolbar">
          <select id="calYil">
            <option value="2024">2024</option>
            <option value="2025" selected>2025</option>
            <option value="2026">2026</option>
          </select>
          <button onclick="renderCalView()">Takvimi YÃ¼kle</button>
        </div>

        <div class="cal-wrapper">
          <div class="cal-dow-row">
            <div class="cal-dow">Pzt</div>
            <div class="cal-dow">Sal</div>
            <div class="cal-dow">Ã‡ar</div>
            <div class="cal-dow">Per</div>
            <div class="cal-dow">Cum</div>
            <div class="cal-dow">Cmt</div>
            <div class="cal-dow">Paz</div>
          </div>
          <div class="cal-grid" id="calViewGrid"></div>
        </div>
      </div>
    </div>

    <!-- Tab: Ä°statistikler -->
    <div class="tab-content" id="tab-istatistik">
      <div class="card">
        <div class="toolbar">
          <select id="statYil">
            <option value="2024">2024</option>
            <option value="2025" selected>2025</option>
            <option value="2026">2026</option>
          </select>
          <button onclick="loadStatistics()">YÃ¼kle</button>
        </div>

        <div class="stats-grid" id="statsGrid"></div>

        <div class="card" style="margin-top:16px">
          <h3 style="margin:0 0 12px 0">AylÄ±k DaÄŸÄ±lÄ±m</h3>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Ay</th>
                  <th>Ä°ftar</th>
                  <th>Sahur</th>
                  <th>Toplam Tutar (â‚º)</th>
                  <th>Toplam MÃ¼safir</th>
                </tr>
              </thead>
              <tbody id="tbodyAylik"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Tab: Ayarlar -->
    <div class="tab-content" id="tab-ayarlar">
      <!-- Ramazan-Ä± Åerif YÄ±llarÄ± -->
      <div class="card">
        <div class="toolbar">
          <h3 style="margin:0">Ramazan-Ä± Åerif YÄ±llarÄ±</h3>
          <div style="flex:1"></div>
          <button class="good" onclick="openRamazanModal()">+ Yeni Ramazan YÄ±lÄ±</button>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>YÄ±l</th>
                <th>BaÅŸlangÄ±Ã§ Tarihi</th>
                <th>BitiÅŸ Tarihi</th>
                <th>Hicri YÄ±l</th>
                <th>Durum</th>
                <th style="width:120px">Ä°ÅŸlemler</th>
              </tr>
            </thead>
            <tbody id="tbodyRamazan"></tbody>
          </table>
        </div>
      </div>

      <!-- Mahal AyarlarÄ± -->
      <div class="card" style="margin-top:16px">
        <div class="toolbar">
          <h3 style="margin:0">Mahal AyarlarÄ±</h3>
          <div style="flex:1"></div>
          <button class="good" onclick="openMahalModal()">+ Yeni Mahal Ekle</button>
        </div>

        <div id="mahalList" style="margin-top:16px"></div>
      </div>

      <!-- Tutar AyarlarÄ± -->
      <div class="card" style="margin-top:16px">
        <div class="toolbar">
          <h3 style="margin:0">Tutar AyarlarÄ±</h3>
          <div style="flex:1"></div>
          <select id="tutarYil" style="margin-right:8px">
            <option value="2024">2024</option>
            <option value="2025" selected>2025</option>
            <option value="2026">2026</option>
          </select>
          <button class="good" onclick="openTutarModal()">+ Yeni Tutar SeÃ§eneÄŸi</button>
        </div>

        <div class="table-wrap" style="margin-top:16px">
          <table>
            <thead>
              <tr>
                <th>SÄ±ra</th>
                <th>Tutar (â‚º)</th>
                <th>Etiket</th>
                <th>Tip</th>
                <th>Durum</th>
                <th style="width:120px">Ä°ÅŸlemler</th>
              </tr>
            </thead>
            <tbody id="tbodyTutar"></tbody>
          </table>
        </div>
      </div>

      <!-- Kapasite AyarlarÄ± -->
      <div class="card" style="margin-top:16px">
        <div class="toolbar">
          <h3 style="margin:0">Kapasite AyarlarÄ±</h3>
          <div style="flex:1"></div>
          <select id="kapasiteYil" style="margin-right:8px">
            <option value="">YÄ±l seÃ§iniz...</option>
          </select>
          <button class="good" onclick="openGenelKapasiteModal()">âš™ï¸ Genel Kapasite</button>
          <button class="good" onclick="openKapasiteModal()">+ GÃ¼nlÃ¼k Kapasite</button>
        </div>

        <div class="card" style="margin-top:16px">
          <h4 style="margin:0 0 12px 0">Genel Kapasite AyarlarÄ±</h4>
          <div id="genelKapasiteInfo" style="padding:12px;background:#f8f9fa;border-radius:8px;margin-bottom:12px">
            <p style="margin:0;color:var(--muted);font-size:13px">Genel kapasite tÃ¼m gÃ¼nler iÃ§in geÃ§erlidir. GÃ¼nlÃ¼k Ã¶zel kapasite varsa o gÃ¼n iÃ§in Ã¶zel kapasite kullanÄ±lÄ±r.</p>
            <div id="genelKapasiteDisplay" style="margin-top:8px"></div>
          </div>
        </div>

        <div class="card" style="margin-top:16px">
          <h4 style="margin:0 0 12px 0">GÃ¼nlÃ¼k Kapasite AyarlarÄ±</h4>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Tarih</th>
                  <th>Ä°ftar Max</th>
                  <th>Sahur Max</th>
                  <th style="width:120px">Ä°ÅŸlemler</th>
                </tr>
              </thead>
              <tbody id="tbodyKapasite"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Hedef YÃ¶netimi -->
      <div class="card" style="margin-top:16px">
        <div class="toolbar">
          <h3 style="margin:0">ğŸ¯ Personel Hedef YÃ¶netimi</h3>
          <div style="flex:1"></div>
          <select id="hedefYonetimYil" style="margin-right:8px">
            <option value="2024">2024</option>
            <option value="2025" selected>2025</option>
            <option value="2026">2026</option>
          </select>
          <button class="good" onclick="loadPersonelHedefleri()">ğŸ”„ Yenile</button>
          <button class="good" onclick="openPersonelHedefModal()">+ Hedef Ekle</button>
        </div>

        <div style="padding:12px;background:#f0f7ff;border-left:4px solid var(--accent);border-radius:8px;margin-top:12px">
          <p style="margin:0;color:var(--muted);font-size:13px;line-height:1.6">
            <strong>ğŸ’¡ Bilgi:</strong> Personellere yÄ±llÄ±k hedef belirleyebilir ve dÃ¼zenleyebilirsiniz.
          </p>
        </div>

        <div class="table-wrap" style="margin-top:16px">
          <table>
            <thead>
              <tr>
                <th>Personel</th>
                <th>YÄ±l</th>
                <th>Hedef (â‚º)</th>
                <th style="width:120px">Ä°ÅŸlemler</th>
              </tr>
            </thead>
            <tbody id="tbodyPersonelHedefleri"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Tab: Hedef YÃ¶netimi -->
    <div class="tab-content" id="tab-hedef">
      <!-- Veri YÃ¼kleme -->
      <div class="card">
        <div class="toolbar">
          <h3 style="margin:0">ğŸ“¥ Veri YÃ¼kleme</h3>
          <div style="flex:1"></div>
              <button class="good" onclick="openVeriYukleModal()">+ Veri YÃ¼kle</button>
              <button class="warning" onclick="openVeriTemizleModal()" style="background:#fff3cd;color:#856404;border-color:#ffc107">ğŸ—‘ï¸ Veri Temizle</button>
              <button class="secondary" onclick="downloadVeriSablon()">ğŸ“„ Åablon Ä°ndir</button>
        </div>
        <div style="padding:12px;background:#f8f9fa;border-radius:8px;margin-top:12px">
          <p style="margin:0;color:var(--muted);font-size:13px;line-height:1.6">
            <strong>ğŸ“‹ Format:</strong> CSV dosyasÄ± yÄ±llÄ±k veriler iÃ§ermelidir.<br>
            <strong>Kolonlar:</strong> YÄ±l, Tip (iftar/sahur/taahhÃ¼t/teberru), Sahip (kiÅŸi adÄ±), DiÄŸer (aÃ§Ä±klama/ara kiÅŸi), Tutar (virgÃ¼l destekli, Ã¶rn: 10.000,50), Referans<br>
            <strong>Ã–rnek:</strong> 2023,iftar,Ali GÃ¶vercin,Mehmet Kara,10000.50,Muhsin Ã‡elik
          </p>
          <p style="margin:8px 0 0 0;color:var(--muted);font-size:12px;line-height:1.5">
            <strong>ğŸ’¡ Not:</strong> "DiÄŸer" kÄ±smÄ± ara kiÅŸi bilgisi iÃ§in kullanÄ±lÄ±r. Ã–rn: Ä°ftar sahibi Ali GÃ¶vercin, DiÄŸer Mehmet Kara, Referans Muhsin Ã‡elik = Muhsin Ã‡elik, Mehmet Kara vasÄ±tasÄ±yla Ali GÃ¶vercin'den iftar almÄ±ÅŸ.
          </p>
        </div>
      </div>

      <!-- Genel Ã–zet Dashboard -->
      <div class="card" style="margin-top:16px">
        <h3 style="margin:0 0 16px 0">ğŸ“Š 3 YÄ±llÄ±k Genel Ã–zet</h3>
        <div class="toolbar">
          <select id="analizYil">
            <option value="2023">2023</option>
            <option value="2024">2024</option>
            <option value="2025" selected>2025</option>
            <option value="tumu">TÃ¼m YÄ±llar</option>
          </select>
          <button onclick="loadAnalizDashboard()">Yenile</button>
        </div>
        <div id="analizDashboard" style="margin-top:16px"></div>
      </div>

      <!-- Personel/Referans BazlÄ± DetaylÄ± Analiz -->
      <div class="card" style="margin-top:16px">
        <h3 style="margin:0 0 16px 0">ğŸ‘¥ Personel/Referans BazlÄ± DetaylÄ± Analiz</h3>
        <div class="toolbar">
          <input type="text" id="personelAra" placeholder="Personel/Referans adÄ± ara..." style="flex:1;min-width:200px" />
          <select id="personelFiltreYil">
            <option value="">TÃ¼m YÄ±llar</option>
            <option value="2023">2023</option>
            <option value="2024">2024</option>
            <option value="2025">2025</option>
          </select>
          <select id="personelFiltreTip">
            <option value="">TÃ¼m Tipler</option>
            <option value="iftar">Ä°ftar</option>
            <option value="sahur">Sahur</option>
            <option value="taahhut">TaahhÃ¼t</option>
            <option value="teberru">Teberru</option>
          </select>
          <button onclick="loadPersonelAnalizi()">Ara</button>
        </div>
        <div id="personelAnalizList" style="margin-top:16px"></div>
      </div>

      <!-- KiÅŸi BazlÄ± Analiz -->
      <div class="card" style="margin-top:16px">
        <h3 style="margin:0 0 16px 0">ğŸ‘¤ KiÅŸi BazlÄ± DetaylÄ± Analiz</h3>
        <div class="toolbar">
          <input type="text" id="kisiAra" placeholder="KiÅŸi adÄ± ara..." style="flex:1;min-width:200px" />
          <select id="kisiFiltreTip">
            <option value="">TÃ¼m Tipler</option>
            <option value="iftar">Ä°ftar</option>
            <option value="sahur">Sahur</option>
            <option value="taahhut">TaahhÃ¼t</option>
            <option value="teberru">Teberru</option>
          </select>
          <button onclick="loadKisiAnalizi()">Ara</button>
        </div>
        <div id="kisiAnalizList" style="margin-top:16px"></div>
      </div>

      <!-- Trend Analizi -->
      <div class="card" style="margin-top:16px">
        <h3 style="margin:0 0 16px 0">ğŸ“ˆ Trend Analizi</h3>
        <div id="trendAnaliz" style="margin-top:16px"></div>
      </div>

      <!-- Kategori Analizi -->
      <div class="card" style="margin-top:16px">
        <h3 style="margin:0 0 16px 0">ğŸ·ï¸ BaÄŸÄ±ÅŸÃ§Ä± Kategorileri</h3>
        <div id="kategoriAnaliz" style="margin-top:16px"></div>
      </div>

      <!-- Hedef TanÄ±mlama -->
      <div class="card" style="margin-top:16px">
        <div class="toolbar">
          <h3 style="margin:0">ğŸ“Š 2026 Hedef TanÄ±mlama</h3>
          <div style="flex:1"></div>
          <button class="good" onclick="loadHedefTanÄ±mlama()">ğŸ”„ Yenile</button>
          <button class="good" onclick="kaydetHedefler()" id="btnKaydetHedefler">ğŸ’¾ 2026 Hedefleri Kaydet</button>
          <div id="hedefUyariMesaji" style="display:none;padding:12px;margin-top:12px;border-radius:8px;background:#fff3cd;border-left:4px solid #ffc107"></div>
        </div>
        
        <!-- Genel Kurumsal Hedef -->
        <div style="margin-top:20px;padding:16px;background:#f0f7ff;border-left:4px solid var(--accent);border-radius:8px">
          <h4 style="margin:0 0 12px 0;font-size:18px">ğŸ¢ Kurumsal Genel Hedef</h4>
          
          <!-- 2025 GerÃ§ekleÅŸen Toplam -->
          <div style="margin-bottom:16px;padding:12px;background:#fff;border-radius:8px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <strong style="font-size:14px">2025 GerÃ§ekleÅŸen Toplam:</strong>
              <span id="hedef2025Toplam" style="font-size:20px;font-weight:700;color:var(--good)">â‚º0,00</span>
            </div>
            <div id="hedef2025Detay" style="font-size:12px;color:var(--muted);margin-top:4px"></div>
          </div>
          
          <!-- 2026 Genel Hedef GiriÅŸi -->
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">
            <div>
              <label style="display:block;margin-bottom:6px;font-size:13px;font-weight:600">2026 Genel Hedef (â‚º) *</label>
              <input type="text" id="hedef2026Genel" placeholder="100.000,50" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;font-size:16px;font-weight:600" />
              <small style="color:var(--muted);font-size:11px;margin-top:4px;display:block">VirgÃ¼l destekli format: 100.000,50</small>
            </div>
            <div>
              <label style="display:block;margin-bottom:6px;font-size:13px;font-weight:600">Otomatik ArtÄ±ÅŸ YÃ¼zdesi</label>
              <input type="text" id="hedef2026ArtisYuzde" readonly style="width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;font-size:16px;font-weight:600;background:#f8f9fa;color:var(--accent)" />
            </div>
          </div>
          
          <!-- Tip BazlÄ± Hedefler ve ArtÄ±ÅŸlar -->
          <div style="margin-top:16px">
            <h5 style="margin:0 0 12px 0;font-size:14px">Tip BazlÄ± Hedefler ve ArtÄ±ÅŸ Ã–nerileri</h5>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Tip</th>
                    <th>2025 GerÃ§ekleÅŸen</th>
                    <th>2026 Hedef (â‚º)</th>
                    <th>ArtÄ±ÅŸ YÃ¼zdesi</th>
                    <th>ArtÄ±ÅŸ TutarÄ± (â‚º)</th>
                  </tr>
                </thead>
                <tbody id="hedefTipBazlÄ±Body"></tbody>
              </table>
            </div>
          </div>
        </div>
        
        <!-- Personel BazlÄ± Hedefler -->
        <div style="margin-top:24px;padding:16px;background:#fff8f0;border-left:4px solid #ff9800;border-radius:8px">
          <h4 style="margin:0 0 12px 0;font-size:18px">ğŸ‘¥ Personel BazlÄ± Hedefler</h4>
          <p style="margin:0 0 16px 0;font-size:12px;color:var(--muted);line-height:1.5">
            Her personel iÃ§in Ã¶nceki yÄ±llarÄ±n verilerine gÃ¶re otomatik artÄ±ÅŸ hesaplanÄ±r. Hedefleri manuel olarak dÃ¼zenleyebilirsiniz.
          </p>
          
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Personel</th>
                  <th>2023</th>
                  <th>2024</th>
                  <th>2025</th>
                  <th>2026 Hedef (Toplam)</th>
                  <th>Ä°ftar Hedefi</th>
                  <th>Sahur Hedefi</th>
                  <th>TaahhÃ¼t Hedefi</th>
                  <th>Teberru Hedefi</th>
                  <th>ArtÄ±ÅŸ YÃ¼zdesi</th>
                </tr>
              </thead>
              <tbody id="hedefPersonelBody"></tbody>
              <tfoot id="hedefPersonelToplam" style="display:none">
                <tr style="background:#f8f9fa;font-weight:700">
                  <td><strong>TOPLAM</strong></td>
                  <td id="toplam2023">-</td>
                  <td id="toplam2024">-</td>
                  <td id="toplam2025">-</td>
                  <td id="toplam2026Hedef">-</td>
                  <td id="toplamIftar">-</td>
                  <td id="toplamSahur">-</td>
                  <td id="toplamTaahhut">-</td>
                  <td id="toplamTeberru">-</td>
                  <td id="toplamArtis">-</td>
                </tr>
                <tr style="background:#fff3cd;font-weight:600;border-top:2px solid #ffc107">
                  <td colspan="9" style="text-align:right;padding:8px">
                    <strong>Genel Hedef (2026):</strong>
                  </td>
                  <td id="genelHedefToplam" style="font-weight:700;color:var(--accent)">-</td>
                </tr>
                <tr style="background:#f0f7ff;font-weight:600;border-top:2px solid var(--accent)">
                  <td colspan="9" style="text-align:right;padding:8px">
                    <strong>Fark (Personel Toplam - Genel Hedef):</strong>
                  </td>
                  <td id="hedefFark" style="font-weight:700">-</td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Tab: Veri DÃ¼zenleme -->
    <div class="tab-content" id="tab-veri-duzenleme">
      <div class="card">
        <h3 style="margin:0 0 16px 0">âœï¸ Veri DÃ¼zenleme</h3>
        <div class="toolbar">
          <select id="duzenleYil" style="min-width:150px">
            <option value="2023">2023</option>
            <option value="2024">2024</option>
            <option value="2025" selected>2025</option>
          </select>
          <select id="duzenleTip" style="min-width:150px">
            <option value="">TÃ¼m Tipler</option>
            <option value="iftar">Ä°ftar</option>
            <option value="sahur">Sahur</option>
            <option value="taahhut">TaahhÃ¼t</option>
            <option value="teberru">Teberru</option>
          </select>
          <input type="text" id="duzenleAra" placeholder="Sahip, Personel, Referans ara..." style="flex:1;min-width:200px" />
          <button onclick="loadVeriDuzenleme()">Yenile</button>
        </div>
        <div id="veriDuzenlemeList" style="margin-top:16px"></div>
      </div>
    </div>

    <!-- Tab: Ä°Ã§e/DÄ±ÅŸa Aktar -->
    <div class="tab-content" id="tab-export">
      <div class="card">
        <h3 style="margin:0 0 16px 0">DÄ±ÅŸa Aktar (CSV)</h3>
        <div class="toolbar">
          <select id="exportYil">
            <option value="2024">2024</option>
            <option value="2025" selected>2025</option>
            <option value="2026">2026</option>
          </select>
          <button class="good" onclick="exportCSV()">CSV Olarak Ä°ndir</button>
        </div>

        <div class="card" style="margin-top:16px">
          <h3 style="margin:0 0 16px 0">Ä°Ã§e Aktar (CSV)</h3>
          <div class="form-group">
            <label>CSV DosyasÄ± SeÃ§in</label>
            <input type="file" id="importFile" accept=".csv" />
            <small style="color:var(--muted);margin-top:4px">
              Format: Tarih,Tip,Sahip,Tutar,Ä°ÅŸtirak,MÃ¼safirAdedi,Personel
            </small>
          </div>
          <button onclick="importCSV()">Ä°Ã§e Aktar</button>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal: KayÄ±t DÃ¼zenle -->
  <div class="modal" id="modalEdit">
    <div class="sheet">
      <h3 id="editTitle">Yeni KayÄ±t</h3>
      <form id="formEdit" class="form-grid">
        <input type="hidden" id="editId" />
        <div class="form-group" id="editGroupTarih">
          <label>Tarih *</label>
          <input type="date" id="editTarih" required />
        </div>
        <div class="form-group" id="editGroupTarihSelect" style="display:none;">
          <label>Tarih *</label>
          <select id="editTarihSelect" required>
            <option value="">Tarih SeÃ§iniz</option>
          </select>
        </div>
        <div class="form-group">
          <label>Tip *</label>
          <select id="editTip" required>
            <option value="">SeÃ§iniz</option>
            <option value="iftar">Ä°ftar</option>
            <option value="sahur">Sahur</option>
            <option value="teberru">Teberru</option>
            <option value="taahhut">TaahhÃ¼t</option>
          </select>
        </div>
        <div class="form-group">
          <label>Personel</label>
          <select id="editPersonel">
            <option value="">Personel SeÃ§iniz</option>
          </select>
        </div>
        
        <!-- Ä°ftar/Sahur AlanlarÄ± -->
        <div class="form-group" id="editGroupSahip" style="display:none;">
          <label>Sahip *</label>
          <input type="text" id="editSahip" />
        </div>
        <div class="form-group" id="editGroupTutar" style="display:none;">
          <label>Tutar (â‚º) *</label>
          <input type="number" id="editTutar" min="0" step="0.01" />
        </div>
        <div class="form-group" id="editGroupIstirak" style="display:none;">
          <label>Ä°ÅŸtirak</label>
          <select id="editIstirak">
            <option value="true">Evet</option>
            <option value="false">HayÄ±r</option>
          </select>
        </div>
        <div class="form-group" id="editGroupMusafir" style="display:none;">
          <label>MÃ¼safir Adedi *</label>
          <input type="number" id="editMusafir" min="0" />
        </div>
        <div class="form-group" id="editGroupMahal" style="display:none;">
          <label>Mahal</label>
          <select id="editMahal">
            <option value="">Mahal SeÃ§iniz</option>
          </select>
        </div>
        
        <!-- Teberru/TaahhÃ¼t AlanlarÄ± -->
        <div class="form-group" id="editGroupBagisci" style="display:none;">
          <label>BaÄŸÄ±ÅŸÃ§Ä± AdÄ± *</label>
          <input type="text" id="editBagisci" />
        </div>
        <div class="form-group" id="editGroupMiktar" style="display:none;">
          <label>Para MiktarÄ± (â‚º) *</label>
          <input type="number" id="editMiktar" min="0" step="0.01" />
        </div>
        <div class="form-group" id="editGroupOdeme" style="display:none;">
          <label>Ã–deme YÃ¶ntemi *</label>
          <select id="editOdeme">
            <option value="">SeÃ§iniz</option>
            <option value="nakit">ğŸ’µ Nakit</option>
            <option value="banka">ğŸ¦ Banka</option>
            <option value="pos">ğŸ’³ POS</option>
            <option value="sanal">ğŸ“± Sanal</option>
          </select>
        </div>
        <div class="form-group" id="editGroupAciklama" style="display:none;">
          <label>AÃ§Ä±klama</label>
          <textarea id="editAciklama" rows="3" placeholder="AÃ§Ä±klama (opsiyonel)"></textarea>
        </div>
        
        <div class="actions">
          <button type="button" class="secondary" onclick="closeEditModal()">Ä°ptal</button>
          <button type="submit" class="good">Kaydet</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Tutar SeÃ§eneÄŸi -->
  <div class="modal" id="modalTutar">
    <div class="sheet">
      <h3 id="tutarTitle">Yeni Tutar SeÃ§eneÄŸi</h3>
      <form id="formTutar" class="form-grid">
        <input type="hidden" id="tutarId" />
        <div class="form-group">
          <label>Tutar (â‚º) *</label>
          <input type="number" id="tutarTutar" min="0" step="0.01" required />
        </div>
        <div class="form-group">
          <label>Etiket *</label>
          <input type="text" id="tutarLabel" placeholder="Ã–rn: 50 kiÅŸilik iftar" required />
        </div>
        <div class="form-group">
          <label>Tip *</label>
          <select id="tutarTip" required>
            <option value="">SeÃ§iniz</option>
            <option value="iftar">Ä°ftar</option>
            <option value="sahur">Sahur</option>
            <option value="">Her Ä°kisi (Genel)</option>
          </select>
          <small style="color:var(--muted);margin-top:4px">Bu tutar seÃ§eneÄŸinin hangi tip iÃ§in geÃ§erli olduÄŸunu belirtin</small>
        </div>
        <div class="form-group">
          <label>SÄ±ra *</label>
          <input type="number" id="tutarSira" min="1" value="1" required />
        </div>
        <div class="form-group">
          <label>Durum</label>
          <select id="tutarAktif">
            <option value="true">Aktif</option>
            <option value="false">Pasif</option>
          </select>
        </div>
        <div class="actions">
          <button type="button" class="secondary" onclick="closeTutarModal()">Ä°ptal</button>
          <button type="submit" class="good">Kaydet</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Ramazan AyarlarÄ± -->
  <div class="modal" id="modalRamazan">
    <div class="sheet">
      <h3 id="ramazanTitle">Yeni Ramazan-Ä± Åerif YÄ±lÄ±</h3>
      <form id="formRamazan" class="form-grid">
        <input type="hidden" id="ramazanId" />
        <div class="form-group">
          <label>YÄ±l *</label>
          <input type="number" id="ramazanYil" min="2024" max="2050" required />
        </div>
        <div class="form-group">
          <label>BaÅŸlangÄ±Ã§ Tarihi *</label>
          <input type="date" id="ramazanBaslangic" required />
        </div>
        <div class="form-group">
          <label>BitiÅŸ Tarihi *</label>
          <input type="date" id="ramazanBitis" required />
        </div>
        <div class="form-group">
          <label>Hicri YÄ±l *</label>
          <input type="number" id="ramazanHicri" min="1400" max="1500" required />
        </div>
        <div class="form-group">
          <label>Durum *</label>
          <select id="ramazanAktif" required>
            <option value="true">Aktif</option>
            <option value="false">Pasif</option>
          </select>
        </div>
        <div class="actions">
          <button type="button" class="secondary" onclick="closeRamazanModal()">Ä°ptal</button>
          <button type="submit" class="good">Kaydet</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Genel Kapasite AyarlarÄ± -->
  <div class="modal" id="modalGenelKapasite">
    <div class="sheet">
      <h3 id="genelKapasiteTitle">Genel Kapasite AyarlarÄ±</h3>
      <form id="formGenelKapasite" class="form-grid">
        <div class="form-group">
          <label>Ä°ftar Max Kapasite</label>
          <input type="number" id="genelKapasiteIftar" min="0" placeholder="SÄ±nÄ±rsÄ±z iÃ§in boÅŸ bÄ±rakÄ±n" />
          <small style="color:var(--muted);margin-top:4px">Ä°ÅŸtirak edecekler iÃ§in kapasite. Ä°ÅŸtirak etmeyecekler iÃ§in sÄ±nÄ±rsÄ±z.</small>
        </div>
        <div class="form-group">
          <label>Sahur Max Kapasite</label>
          <input type="number" id="genelKapasiteSahur" min="0" placeholder="SÄ±nÄ±rsÄ±z iÃ§in boÅŸ bÄ±rakÄ±n" />
          <small style="color:var(--muted);margin-top:4px">Ä°ÅŸtirak edecekler iÃ§in kapasite. Ä°ÅŸtirak etmeyecekler iÃ§in sÄ±nÄ±rsÄ±z.</small>
        </div>
        <div class="actions">
          <button type="button" class="secondary" onclick="closeGenelKapasiteModal()">Ä°ptal</button>
          <button type="submit" class="good">Kaydet</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: GÃ¼nlÃ¼k Kapasite AyarlarÄ± -->
  <div class="modal" id="modalKapasite">
    <div class="sheet">
      <h3 id="kapasiteTitle">Yeni GÃ¼nlÃ¼k Kapasite</h3>
      <form id="formKapasite" class="form-grid">
        <input type="hidden" id="kapasiteId" />
        <div class="form-group">
          <label>Tarih *</label>
          <input type="date" id="kapasiteTarih" required />
        </div>
        <div class="form-group">
          <label>Ä°ftar Max Kapasite</label>
          <input type="number" id="kapasiteIftar" min="0" placeholder="SÄ±nÄ±rsÄ±z iÃ§in boÅŸ bÄ±rakÄ±n" />
          <small style="color:var(--muted);margin-top:4px">Bu gÃ¼n iÃ§in Ã¶zel kapasite. Genel kapasiteyi geÃ§ersiz kÄ±lar.</small>
        </div>
        <div class="form-group">
          <label>Sahur Max Kapasite</label>
          <input type="number" id="kapasiteSahur" min="0" placeholder="SÄ±nÄ±rsÄ±z iÃ§in boÅŸ bÄ±rakÄ±n" />
          <small style="color:var(--muted);margin-top:4px">Bu gÃ¼n iÃ§in Ã¶zel kapasite. Genel kapasiteyi geÃ§ersiz kÄ±lar.</small>
        </div>
        <div class="actions">
          <button type="button" class="secondary" onclick="closeKapasiteModal()">Ä°ptal</button>
          <button type="submit" class="good">Kaydet</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Onay -->
  <div class="modal" id="modalConfirm">
    <div class="sheet" style="max-width:500px">
      <h3 id="confirmTitle">Onay</h3>
      <p id="confirmMessage" style="margin:16px 0;color:var(--ink)"></p>
      <div class="actions">
        <button type="button" class="secondary" onclick="closeConfirmModal(false)">Ä°ptal</button>
        <button type="button" class="good" id="confirmOkBtn" onclick="closeConfirmModal(true)">Onayla</button>
      </div>
    </div>
  </div>

  <!-- Modal: UyarÄ±/Bilgi -->
  <div class="modal" id="modalAlert">
    <div class="sheet" style="max-width:500px">
      <h3 id="alertTitle">Bilgi</h3>
      <p id="alertMessage" style="margin:16px 0;color:var(--ink)"></p>
      <div class="actions">
        <button type="button" class="good" onclick="closeAlertModal()">Tamam</button>
      </div>
    </div>
  </div>

  <!-- Modal: Prompt (Input) -->
  <div class="modal" id="modalPrompt">
    <div class="sheet" style="max-width:500px">
      <h3 id="promptTitle">Bilgi GiriÅŸi</h3>
      <p id="promptMessage" style="margin:16px 0;color:var(--ink)"></p>
      <div class="form-group">
        <input type="text" id="promptInput" class="full-input" placeholder="LÃ¼tfen giriniz..." style="margin-top:8px" />
      </div>
      <div class="actions">
        <button type="button" class="secondary" onclick="closePromptModal(null)">Ä°ptal</button>
        <button type="button" class="good" id="promptOkBtn" onclick="closePromptModal(true)">Tamam</button>
      </div>
    </div>
  </div>

  <!-- Modal: MenÃ¼ -->
  <div class="modal" id="modalMenu">
    <div class="sheet" style="max-width:600px">
      <h3 id="menuTitle">Yeni MenÃ¼</h3>
      <form id="formMenu" class="form-grid">
        <input type="hidden" id="menuId" />
        <div class="form-group">
          <label>Tarih *</label>
          <input type="date" id="menuTarih" required />
        </div>
        <div class="form-group">
          <label>Tip *</label>
          <select id="menuTip" required>
            <option value="">SeÃ§iniz</option>
            <option value="iftar">ğŸŒ™ Ä°ftar</option>
            <option value="sahur">ğŸŒŸ Sahur</option>
          </select>
        </div>
        <div class="form-group">
          <label>Ã‡orba</label>
          <input type="text" id="menuCorba" placeholder="Ã–rn: Mercimek Ã§orbasÄ±" />
        </div>
        <div class="form-group">
          <label>Yemek</label>
          <input type="text" id="menuYemek" placeholder="Ã–rn: Tavuk kÄ±zartma, Pilav" />
        </div>
        <div class="form-group">
          <label>SoÄŸuk</label>
          <input type="text" id="menuSoguk" placeholder="Ã–rn: Salata, Meze" />
        </div>
        <div class="form-group">
          <label>Ä°Ã§ecek</label>
          <input type="text" id="menuIcecek" placeholder="Ã–rn: Ayran, Åerbet" />
        </div>
        <div class="form-group">
          <label>DiÄŸer</label>
          <textarea id="menuDiger" rows="3" placeholder="TatlÄ±, ekmek, zeytin vb." style="width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;font:inherit;resize:vertical"></textarea>
        </div>
        <div class="actions">
          <button type="button" class="secondary" onclick="closeMenuModal()">Ä°ptal</button>
          <button type="submit" class="good">Kaydet</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Personel Hedef -->
  <div class="modal" id="modalPersonelHedef">
    <div class="sheet" style="max-width:500px">
      <h3 id="personelHedefTitle">Yeni Personel Hedefi</h3>
      <form id="formPersonelHedef" class="form-grid">
        <input type="hidden" id="personelHedefId" />
        <div class="form-group">
          <label>YÄ±l *</label>
          <select id="personelHedefYil" required>
            <option value="2024">2024</option>
            <option value="2025" selected>2025</option>
            <option value="2026">2026</option>
          </select>
        </div>
        <div class="form-group">
          <label>Personel *</label>
          <select id="personelHedefPersonel" required>
            <option value="">Personel SeÃ§iniz</option>
          </select>
        </div>
        <div class="form-group">
          <label>Hedef (â‚º) *</label>
          <input type="text" id="personelHedefTutar" placeholder="0,00" required />
          <small style="color:var(--muted);margin-top:4px">VirgÃ¼l destekli format: 10.000,50</small>
        </div>
        <div class="actions">
          <button type="button" class="secondary" onclick="closePersonelHedefModal()">Ä°ptal</button>
          <button type="submit" class="good">Kaydet</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Veri Temizleme -->
  <div class="modal" id="modalVeriTemizle">
    <div class="sheet" style="max-width:600px">
      <h3>ğŸ—‘ï¸ Veri Temizleme</h3>
      <div style="padding:12px;background:#fff3cd;border-left:4px solid #ffc107;border-radius:8px;margin-bottom:20px">
        <p style="margin:0;font-size:13px;line-height:1.6">
          <strong>âš ï¸ UyarÄ±:</strong> SeÃ§ili yÄ±l/yÄ±llar iÃ§in TÃœM veriler silinecektir. Bu iÅŸlem geri alÄ±namaz!<br>
          <strong>ğŸ’¡ Ã–neri:</strong> Silmeden Ã¶nce verilerinizi yedekleyin veya CSV dosyanÄ±zÄ± hazÄ±r tutun.
        </p>
      </div>
      <form id="formVeriTemizle" class="form-grid">
        <div class="form-group">
          <label>Silinecek YÄ±llar *</label>
          <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
              <input type="checkbox" id="temizle2023" value="2023" />
              <span>2023</span>
            </label>
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
              <input type="checkbox" id="temizle2024" value="2024" checked />
              <span>2024</span>
            </label>
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
              <input type="checkbox" id="temizle2025" value="2025" checked />
              <span>2025</span>
            </label>
          </div>
          <small style="color:var(--muted);margin-top:8px">
            Temizlemek istediÄŸiniz yÄ±llarÄ± seÃ§in (Ã¶r: Ã§ift kopya olan veriler iÃ§in)
          </small>
        </div>
        <div class="actions">
          <button type="button" class="secondary" onclick="closeVeriTemizleModal()">Ä°ptal</button>
          <button type="submit" class="bad">Sil ve Temizle</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Veri YÃ¼kleme -->
  <div class="modal" id="modalVeriYukle">
    <div class="sheet" style="max-width:800px">
      <h3>ğŸ“¥ Finansal Veri YÃ¼kleme</h3>
      <div style="padding:12px;background:#f0f7ff;border-left:4px solid var(--accent);border-radius:8px;margin-bottom:20px">
        <p style="margin:0;font-size:13px;line-height:1.6">
          <strong>ğŸ“‹ Format:</strong> CSV dosyasÄ± yÄ±llÄ±k veriler iÃ§ermelidir.<br>
          <strong>Kolonlar:</strong> YÄ±l, Tip (iftar/sahur/taahhÃ¼t/teberru), Sahip (kiÅŸi adÄ±), DiÄŸer (aÃ§Ä±klama/ara kiÅŸi), Tutar (virgÃ¼l destekli, Ã¶rn: 10.000,50), Referans<br>
          <strong>Ã–rnek:</strong> 2023,iftar,Ali GÃ¶vercin,Mehmet Kara,10000.50,Muhsin Ã‡elik
        </p>
        <p style="margin:8px 0 0 0;font-size:12px;line-height:1.5;color:var(--muted)">
          <strong>ğŸ’¡ Not:</strong> "DiÄŸer" kÄ±smÄ± ara kiÅŸi bilgisi iÃ§in kullanÄ±lÄ±r. Tutar kÄ±smÄ±nda virgÃ¼l veya nokta kullanabilirsiniz (10.000,50 veya 10000.50).
        </p>
      </div>
      <form id="formVeriYukle" class="form-grid">
        <div class="form-group">
          <label>CSV DosyasÄ± *</label>
          <input type="file" id="veriYukleFile" accept=".csv" required />
          <small style="color:var(--muted);margin-top:4px">
            Muhasebe sisteminden indirdiÄŸiniz CSV dosyasÄ±nÄ± seÃ§in
          </small>
        </div>
        <div class="form-group">
          <label>YÄ±l *</label>
          <select id="veriYukleYil" required>
            <option value="">SeÃ§iniz</option>
            <option value="2023">2023</option>
            <option value="2024">2024</option>
            <option value="2025">2025</option>
          </select>
          <small style="color:var(--muted);margin-top:4px">
            YÃ¼klediÄŸiniz verinin ait olduÄŸu yÄ±l
          </small>
        </div>
        <div id="veriYuklePreview" style="display:none;margin-top:16px">
          <h4 style="margin:0 0 12px 0;font-size:16px">Ã–nizleme (Ä°lk 10 KayÄ±t)</h4>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Tip</th>
                  <th>Sahip</th>
                  <th>DiÄŸer</th>
                  <th>Tutar (â‚º)</th>
                  <th>Referans</th>
                </tr>
              </thead>
              <tbody id="veriYuklePreviewBody"></tbody>
            </table>
          </div>
        </div>
        <div class="actions">
          <button type="button" class="secondary" onclick="closeVeriYukleModal()">Ä°ptal</button>
          <button type="submit" class="good">YÃ¼kle</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: KiÅŸi Detay Analizi -->
  <div class="modal" id="modalKisiDetay">
    <div class="sheet" style="max-width:900px;max-height:90vh">
      <h3 id="kisiDetayTitle">ğŸ‘¤ KiÅŸi Detay Analizi</h3>
      <div id="kisiDetayContent"></div>
      <div class="actions">
        <button type="button" class="secondary" onclick="closeKisiDetayModal()">Kapat</button>
      </div>
    </div>
  </div>

  <!-- Modal: GÃ¼n Detay (Takvim) -->
  <div class="modal" id="modalCalDay">
    <div class="sheet" style="max-width:900px;max-height:90vh;overflow-y:auto">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;padding-bottom:10px;border-bottom:1px solid var(--border)">
        <div>
          <h3 id="calDayModalTitle" style="margin:0;font-size:18px;color:var(--text)">ğŸ“… GÃ¼n DetayÄ±</h3>
          <div id="calDayModalSummary" style="margin-top:4px;font-size:12px;color:var(--muted)"></div>
        </div>
        <button type="button" onclick="closeCalDayModal()" style="background:none;border:none;font-size:22px;cursor:pointer;color:var(--muted);padding:0;width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all 0.2s" onmouseover="this.style.background='var(--hover)';this.style.color='var(--text)'" onmouseout="this.style.background='none';this.style.color='var(--muted)'">Ã—</button>
      </div>

      <div style="display:flex;flex-direction:column;gap:16px">
        <div>
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
            <h4 style="margin:0;font-size:14px;color:var(--text)">ğŸŒ™ Ä°ftar KayÄ±tlarÄ±</h4>
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Personel</th>
                  <th>Sahip / BaÄŸÄ±ÅŸÃ§Ä±</th>
                  <th>Mahal</th>
                  <th>MÃ¼safir</th>
                  <th class="right">Tutar (â‚º)</th>
                </tr>
              </thead>
              <tbody id="tbodyCalIftar"></tbody>
            </table>
          </div>
        </div>

        <div>
          <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:8px">
            <h4 style="margin:0;font-size:14px;color:var(--text)">âœ¨ Sahur KayÄ±tlarÄ±</h4>
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Personel</th>
                  <th>Sahip / BaÄŸÄ±ÅŸÃ§Ä±</th>
                  <th>Mahal</th>
                  <th>MÃ¼safir</th>
                  <th class="right">Tutar (â‚º)</th>
                </tr>
              </thead>
              <tbody id="tbodyCalSahur"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Personel/Referans Detay Analizi -->
  <div class="modal" id="modalPersonelDetay">
    <div class="sheet" style="max-width:1000px;max-height:90vh;overflow-y:auto">
      <h3 id="personelDetayTitle">ğŸ‘¥ Personel/Referans Detay Analizi</h3>
      <div id="personelDetayContent"></div>
      <div class="actions">
        <button type="button" class="secondary" onclick="closePersonelDetay()">Kapat</button>
      </div>
    </div>
  </div>

  <!-- Modal: Veri DÃ¼zenleme -->
  <div class="modal" id="modalVeriDuzenleme">
    <div class="sheet" style="max-width:750px;max-height:90vh;overflow-y:auto">
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;padding-bottom:16px;border-bottom:2px solid var(--border)">
        <h3 id="veriDuzenlemeTitle" style="margin:0;font-size:20px;color:var(--text)">âœï¸ Veri DÃ¼zenleme</h3>
        <button type="button" onclick="closeVeriDuzenlemeModal()" style="background:none;border:none;font-size:24px;cursor:pointer;color:var(--muted);padding:0;width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all 0.2s" onmouseover="this.style.background='var(--hover)';this.style.color='var(--text)'" onmouseout="this.style.background='none';this.style.color='var(--muted)'">Ã—</button>
      </div>
      <form id="formVeriDuzenleme" style="display:grid;gap:16px">
        <input type="hidden" id="duzenleId" />
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
          <div class="field">
            <label style="display:block;margin-bottom:8px;font-weight:600;color:var(--text);font-size:14px">YÄ±l *</label>
            <select id="duzenleYilInput" required style="width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;font-size:14px;background:var(--bg);color:var(--text)">
              <option value="2023">2023</option>
              <option value="2024">2024</option>
              <option value="2025">2025</option>
            </select>
          </div>
          <div class="field">
            <label style="display:block;margin-bottom:8px;font-weight:600;color:var(--text);font-size:14px">Tip *</label>
            <select id="duzenleTipInput" required style="width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;font-size:14px;background:var(--bg);color:var(--text)">
              <option value="iftar">ğŸŒ™ Ä°ftar</option>
              <option value="sahur">ğŸŒŸ Sahur</option>
              <option value="taahhut">ğŸ“‹ TaahhÃ¼t</option>
              <option value="teberru">ğŸ’ Teberru</option>
            </select>
          </div>
        </div>
        <div class="field">
          <label style="display:block;margin-bottom:8px;font-weight:600;color:var(--text);font-size:14px">Sahip (BaÄŸÄ±ÅŸ Yapan) *</label>
          <input type="text" id="duzenleSahip" required style="width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;font-size:14px;background:var(--bg);color:var(--text)" />
        </div>
        <div class="field">
          <label style="display:block;margin-bottom:8px;font-weight:600;color:var(--text);font-size:14px">DiÄŸer (Ara KiÅŸi)</label>
          <input type="text" id="duzenleDiger" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;font-size:14px;background:var(--bg);color:var(--text)" />
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
          <div class="field">
            <label style="display:block;margin-bottom:8px;font-weight:600;color:var(--text);font-size:14px">Tutar (â‚º) *</label>
            <input type="text" id="duzenleTutar" placeholder="10000.50 veya 10.000,50" required style="width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;font-size:14px;background:var(--bg);color:var(--text)" />
          </div>
          <div class="field">
            <label style="display:block;margin-bottom:8px;font-weight:600;color:var(--text);font-size:14px">Referans (Personel)</label>
            <input type="text" id="duzenleReferans" style="width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;font-size:14px;background:var(--bg);color:var(--text)" />
          </div>
        </div>
        <div class="actions" style="display:flex;gap:12px;justify-content:flex-end;margin-top:8px;padding-top:20px;border-top:1px solid var(--border)">
          <button type="button" class="secondary" onclick="closeVeriDuzenlemeModal()" style="padding:10px 20px;font-size:14px">Ä°ptal</button>
          <button type="button" class="danger" onclick="deleteVeriKayit()" id="btnDeleteVeri" style="display:none;padding:10px 20px;font-size:14px">ğŸ—‘ï¸ Sil</button>
          <button type="submit" class="good" style="padding:10px 24px;font-size:14px;font-weight:600">ğŸ’¾ Kaydet</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Mahal AyarlarÄ± -->
  <div class="modal" id="modalMahal">
    <div class="sheet">
      <h3 id="mahalTitle">Yeni Mahal Ekle</h3>
      <form id="formMahal" class="form-grid">
        <input type="hidden" id="mahalId" />
        <div class="form-group">
          <label>Mahal AdÄ± *</label>
          <input type="text" id="mahalAdi" placeholder="Ã–rn: Ana Salon, BahÃ§e, Konferans Salonu" required />
        </div>
        <div class="form-group">
          <label>Min MÃ¼safir Adedi *</label>
          <input type="number" id="mahalMin" min="1" value="1" required />
        </div>
        <div class="form-group">
          <label>Max MÃ¼safir Adedi *</label>
          <input type="number" id="mahalMax" min="1" required />
        </div>
        <div class="actions">
          <button type="button" class="secondary" onclick="closeMahalModal()">Ä°ptal</button>
          <button type="submit" class="good">Kaydet</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    const db = window.db;
    const auth = window.auth;
    const qs = s => document.querySelector(s);
    
    let kayitlar = [];
    let tutarSecenekleri = [];
    let currentYil = new Date().getFullYear();
    
    function showToast(title, message = '', type = 'success', duration = 4000) {
      const container = qs('#toastContainer');
      if (!container) return;
      
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      
      const icons = {
        success: 'âœ…',
        error: 'âŒ',
        warning: 'âš ï¸',
        info: 'â„¹ï¸'
      };
      
      toast.innerHTML = `
        <span class="toast-icon">${icons[type] || icons.info}</span>
        <div class="toast-content">
          <div class="toast-title">${title}</div>
          ${message ? `<div class="toast-message">${message}</div>` : ''}
        </div>
        <button class="toast-close" type="button">Ã—</button>
      `;
      
      container.appendChild(toast);
      
      const hideToast = () => {
        toast.classList.remove('show');
        setTimeout(() => {
          if (toast.parentElement) toast.remove();
        }, 220);
      };

      const closeBtn = toast.querySelector('.toast-close');
      if (closeBtn) {
        closeBtn.addEventListener('click', hideToast);
      }

      // Animasyon iÃ§in
      setTimeout(() => toast.classList.add('show'), 10);
      
      // Otomatik kapanma
      const timeoutId = setTimeout(hideToast, duration);

      // Ãœzerine gelince duraklat, Ã§ekilince devam et
      toast.addEventListener('mouseenter', () => clearTimeout(timeoutId));
      toast.addEventListener('mouseleave', () => {
        setTimeout(hideToast, duration / 2);
      });
    }
    
    window.showToast = showToast;
    
    // Modal fonksiyonlarÄ±
    let confirmCallback = null;
    
    function showConfirmModal(title, message, okText = 'Onayla', okClass = 'good') {
      return new Promise((resolve) => {
        confirmCallback = resolve;
        qs('#confirmTitle').textContent = title;
        qs('#confirmMessage').textContent = message;
        const okBtn = qs('#confirmOkBtn');
        okBtn.textContent = okText;
        okBtn.className = okClass;
        qs('#modalConfirm').classList.add('show');
        document.body.classList.add('modal-open');
      });
    }
    
    function closeConfirmModal(result) {
      qs('#modalConfirm').classList.remove('show');
      document.body.classList.remove('modal-open');
      if (confirmCallback) {
        confirmCallback(result);
        confirmCallback = null;
      }
    }
    
    function showAlertModal(title, message) {
      qs('#alertTitle').textContent = title;
      qs('#alertMessage').textContent = message;
      qs('#modalAlert').classList.add('show');
      document.body.classList.add('modal-open');
    }
    
    function closeAlertModal() {
      qs('#modalAlert').classList.remove('show');
      document.body.classList.remove('modal-open');
    }
    
    let promptCallback = null;
    
    function showPromptModal(title, message, okText = 'Tamam', okClass = 'good') {
      return new Promise((resolve) => {
        promptCallback = resolve;
        qs('#promptTitle').textContent = title;
        qs('#promptMessage').textContent = message;
        const okBtn = qs('#promptOkBtn');
        okBtn.textContent = okText;
        okBtn.className = okClass;
        qs('#promptInput').value = '';
        qs('#modalPrompt').classList.add('show');
        document.body.classList.add('modal-open');
        
        // Input'a odaklan
        setTimeout(() => {
          qs('#promptInput').focus();
          // Enter tuÅŸu ile onaylama
          qs('#promptInput').addEventListener('keypress', function onEnter(e) {
            if (e.key === 'Enter') {
              qs('#promptInput').removeEventListener('keypress', onEnter);
              closePromptModal(true);
            }
          });
        }, 100);
      });
    }
    
    function closePromptModal(result) {
      qs('#modalPrompt').classList.remove('show');
      document.body.classList.remove('modal-open');
      if (promptCallback) {
        if (result === true) {
          promptCallback(qs('#promptInput').value);
        } else {
          promptCallback(null);
        }
        promptCallback = null;
      }
    }
    
    window.showConfirmModal = showConfirmModal;
    window.closeConfirmModal = closeConfirmModal;
    window.showAlertModal = showAlertModal;
    window.closeAlertModal = closeAlertModal;
    window.showPromptModal = showPromptModal;
    window.closePromptModal = closePromptModal;
    
    // Progress Bar
    function showProgress(percent) {
      const container = qs('#progressContainer');
      const bar = qs('#progressBar');
      if (container && bar) {
        if (percent > 0) {
          container.classList.add('active');
          bar.style.width = percent + '%';
        } else {
          container.classList.remove('active');
          bar.style.width = '0%';
        }
      }
    }
    
    window.showProgress = showProgress;

    const ayIsimleri = ['Ocak','Åubat','Mart','Nisan','MayÄ±s','Haziran','Temmuz','AÄŸustos','EylÃ¼l','Ekim','KasÄ±m','AralÄ±k'];

    // Mahal AyarlarÄ± - Global scope (onclick iÃ§in eriÅŸilebilir olmalÄ±)
    let mahalList = [];
    
    // Mahal fonksiyonlarÄ±nÄ± Ã¶nce tanÄ±mla (auth kontrolÃ¼nden Ã¶nce)
    async function loadMahallar() {
      try {
        const snap = await db.collection('ramazan_serif').doc('ayarlar').collection('mahaller').orderBy('adi', 'asc').get();
        mahalList = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderMahallar();
      } catch (e) {
        console.error('Mahaller yÃ¼klenemedi:', e);
        mahalList = [];
        renderMahallar();
      }
    }

    function renderMahallar() {
      const container = qs('#mahalList');
      if (!container) return;
      
      container.innerHTML = '';

      if (mahalList.length === 0) {
        container.innerHTML = '<div style="text-align:center;color:var(--muted);padding:20px">Mahal bulunamadÄ±. Yeni mahal ekleyin.</div>';
        return;
      }

      mahalList.forEach(m => {
        const card = document.createElement('div');
        card.style.cssText = 'border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:12px;background:#fff';
        card.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:start">
            <div>
              <h4 style="margin:0 0 8px 0;font-size:16px;color:var(--ink)">${m.adi || '-'}</h4>
              <div style="display:flex;gap:16px;font-size:13px;color:var(--muted)">
                <span><strong>Min:</strong> ${m.minMusafir || 0} kiÅŸi</span>
                <span><strong>Max:</strong> ${m.maxMusafir || 0} kiÅŸi</span>
              </div>
            </div>
            <div style="display:flex;gap:8px">
              <button onclick="editMahal('${m.id}')" style="padding:6px 12px;font-size:12px">DÃ¼zenle</button>
              <button onclick="deleteMahal('${m.id}')" class="danger" style="padding:6px 12px;font-size:12px">Sil</button>
            </div>
          </div>
        `;
        container.appendChild(card);
      });
    }

    function openMahalModal(id = null) {
      qs('#mahalId').value = id || '';
      qs('#mahalTitle').textContent = id ? 'Mahal DÃ¼zenle' : 'Yeni Mahal Ekle';
      
      if (id) {
        const m = mahalList.find(m => m.id === id);
        if (m) {
          qs('#mahalAdi').value = m.adi || '';
          qs('#mahalMin').value = m.minMusafir || 1;
          qs('#mahalMax').value = m.maxMusafir || '';
        }
      } else {
        qs('#formMahal').reset();
        qs('#mahalMin').value = 1;
      }
      
      qs('#modalMahal').classList.add('show');
      document.body.classList.add('modal-open');
    }

    function closeMahalModal() {
      qs('#modalMahal').classList.remove('show');
      document.body.classList.remove('modal-open');
    }

    async function deleteMahal(id) {
      if (!confirm('Bu mahali silmek istediÄŸinizden emin misiniz?')) return;
      
      try {
        await db.collection('ramazan_serif').doc('ayarlar').collection('mahaller').doc(id).delete();
        alert('Mahal silindi!');
        await loadMahallar();
      } catch (e) {
        console.error('Mahal silinemedi:', e);
        alert('Hata: ' + e.message);
      }
    }

    function editMahal(id) {
      openMahalModal(id);
    }

    // Global olarak eriÅŸilebilir yap (onclick iÃ§in)
    window.openMahalModal = openMahalModal;
    window.editMahal = editMahal;
    window.deleteMahal = deleteMahal;
    window.closeMahalModal = closeMahalModal;
    window.loadMahallar = loadMahallar;

    /* ===== Navigation Bar ===== */
    let CURRENT_ALLOW=new Set(), CURRENT_DENY=new Set();
    const norm=(s)=> String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
    function normalizeUrl(u){
      if(!u || u === '#') return '#';
      // HTTP/HTTPS URL'leri olduÄŸu gibi bÄ±rak
      if(/^https?:\/\//i.test(u)) return u;
      if(u.startsWith('//')) return u;
      // Zaten relative path'ler (../ veya ./ ile baÅŸlayan) olduÄŸu gibi bÄ±rak
      if(u.startsWith('../') || u.startsWith('./')) return u;
      
      // Mevcut dosyanÄ±n konumuna gÃ¶re relative hale getir
      const currentPath = location.pathname;
      const currentDir = currentPath.substring(0, currentPath.lastIndexOf('/'));
      // Mevcut dizin seviyesini hesapla (kaÃ§ seviye yukarÄ± Ã§Ä±kmalÄ±yÄ±z)
      const currentDepth = currentDir.split('/').filter(x => x).length;
      
      // Root'a dÃ¶nmek iÃ§in ../ sayÄ±sÄ±
      const upLevels = currentDepth > 0 ? '../'.repeat(currentDepth) : '';
      
      // Path'i temizle: / ile baÅŸlÄ±yorsa kaldÄ±r, yoksa olduÄŸu gibi kullan
      const targetPath = u.startsWith('/') ? u.substring(1) : u;
      
      return upLevels + targetPath;
    }

    async function fetchPanels(allowSet, denySet){
      const res=[]; try{
        const snap=await db.collection('sayfa_manifesti').get();
        snap.forEach(doc=>{
          const d=doc.data()||{}, id=doc.id, panelTitle=d.title||id;
          const panelGrant = allowSet.has(norm(id)) || allowSet.has(norm(panelTitle));
          let pages = Array.isArray(d.pages)? d.pages : [];
          pages = pages.filter(pg=>{
            const keyNorm=norm(pg.key||pg.title||'');
            const pageGrant=allowSet.has(keyNorm), denied=denySet.has(keyNorm);
            return !denied && (panelGrant || pageGrant);
          }).map(pg=>({ baslik: pg.title||pg.key||'Sayfa', url: normalizeUrl(pg.path||'#'), key: pg.key||pg.title||'', sira: typeof pg.order==='number'? pg.order:9999 }))
            .sort((a,b)=>a.sira-b.sira);
          if(pages.length) res.push({ id, baslik:panelTitle, sira: typeof d.order==='number'? d.order:9999, pages });
        });
        res.sort((a,b)=>a.sira-b.sira);
      }catch(e){ console.error(e); }
      return res;
    }

    function renderNav(panels){
      const ul=document.getElementById('navMain'), drawer=document.getElementById('drawer');
      ul.innerHTML=''; drawer.innerHTML='';
      if(!panels.length){
        ul.innerHTML='<li class="nav-item"><div class="nav-btn">Panel yok</div></li>';
        drawer.innerHTML='<div class="muted" style="padding:8px">MenÃ¼ bulunamadÄ±</div>'; return;
      }
      panels.forEach(p=>{
        const li=document.createElement('li'); li.className='nav-item';
        li.innerHTML=`<div class="nav-btn">${p.baslik} <span class="caret">â–¾</span></div>`;
        const dd=document.createElement('div'); dd.className='dropdown';
        (p.pages||[]).forEach(pg=>{
          const a=document.createElement('a');
          a.href=normalizeUrl(pg.url || pg.path || '#'); a.textContent=pg.baslik;
          a.dataset.key=pg.key||pg.baslik; a.dataset.panel=p.id; a.dataset.panelTitle=p.baslik;
          dd.appendChild(a);
        });
        li.appendChild(dd);
        li.querySelector('.nav-btn').addEventListener('click',(e)=>{
          e.stopPropagation();
          ul.querySelectorAll('.nav-item').forEach(x=>{ if(x!==li) x.classList.remove('open'); });
          li.classList.toggle('open');
        });
        ul.appendChild(li);

        const h=document.createElement('div'); h.className='panel-title'; h.textContent=p.baslik; drawer.appendChild(h);
        (p.pages||[]).forEach(pg=>{
          const a=document.createElement('a');
          a.href=normalizeUrl(pg.url || pg.path || '#'); a.textContent=pg.baslik;
          a.dataset.key=pg.key||pg.baslik; a.dataset.panel=p.id; a.dataset.panelTitle=p.baslik;
          drawer.appendChild(a);
        });
      });
      document.addEventListener('click',(e)=>{ if(!ul.contains(e.target)) ul.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('open')); });
    }

    (function(){ const hamb=document.getElementById('hamburger'), drawer=document.getElementById('drawer'); if(!hamb) return; hamb.addEventListener('click',()=>drawer.classList.toggle('open')); document.addEventListener('click',(e)=>{ if(!drawer.contains(e.target) && !hamb.contains(e.target)) drawer.classList.remove('open'); }); })();

    document.addEventListener('click',(e)=>{
      const a=e.target.closest('a[data-key]'); if(!a) return;
      const key=norm(a.dataset.key), pnl=norm(a.dataset.panel||''), pnlTitle=norm(a.dataset.panelTitle||'');
      if(CURRENT_DENY.has(key)){ e.preventDefault(); return; }
      const allowed = CURRENT_ALLOW.has(key) || CURRENT_ALLOW.has(pnl) || CURRENT_ALLOW.has(pnlTitle);
      if(!allowed){ e.preventDefault(); }
    });

    (function(){
      const profBtn=document.getElementById('btnProfile'), profDD=document.getElementById('profDropdown');
      function closeAll(e){
        if(!profDD.contains(e.target)  && e.target!==profBtn)  profDD.parentElement.classList.remove('open');
      }
      document.addEventListener('click', closeAll);
      profBtn?.addEventListener('click',(e)=>{ e.stopPropagation(); profDD.parentElement.classList.toggle('open'); });
      document.getElementById('btnLogout')?.addEventListener('click', async (e) => {
        e.preventDefault();
        try { await auth.signOut(); location.assign('../../index.html'); }
        catch(err){ console.error(err); }
      });
    })();

    // Auth kontrolÃ¼
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = '../../index.html';
        return;
      }
      
      // KullanÄ±cÄ± bilgilerini al
      try {
        const userDoc = await db.collection('kullanicilar').doc(user.uid).get();
        if (userDoc.exists) {
          const data = userDoc.data();
          
          // Profil adÄ±nÄ± gÃ¼ncelle
          const profNameEl = document.getElementById('profName');
          if (profNameEl) profNameEl.textContent = data.adSoyad || user.email?.split('@')[0] || 'Profil';
          
          // Yetkileri yÃ¼kle
          const rawPerms = Array.isArray(data.yetkiler) ? data.yetkiler : [];
          CURRENT_ALLOW = new Set(rawPerms.filter(s=>!String(s).trim().startsWith('-') && !String(s).trim().startsWith('!')).map(norm));
          CURRENT_DENY = new Set(rawPerms.filter(s=>String(s).trim().startsWith('-') || String(s).trim().startsWith('!')).map(s=>norm(String(s).replace(/^[-!]\s*/,''))));
          
          // Navigation render
          const panels = await fetchPanels(CURRENT_ALLOW, CURRENT_DENY);
          renderNav(panels);
        }
      } catch (e) {
        console.error('KullanÄ±cÄ± bilgisi alÄ±namadÄ±:', e);
      }
      
      // Ay seÃ§eneklerini doldur (kayÄ±t filtreleri iÃ§in)
      fillAyOptions();
      
      // Ramazan yÄ±llarÄ±nÄ± ve aktif yÄ±lÄ± yÃ¼kle
      await loadRamazanYillari();
      await loadAktifRamazanAyar();
      
      // Ä°lk yÃ¼kleme
      await loadKayitlar();
      await loadTutarSecenekleri();
      await loadMahallar();
    });
    
    // Tab deÄŸiÅŸtirme - Event delegation kullanarak (tek listener)
    let tabInitialized = false;
    function initTabs() {
      if (tabInitialized) return;
      tabInitialized = true;
      
      document.addEventListener('click', (e) => {
        const tab = e.target.closest('.tab');
        if (!tab || !tab.dataset.tab) return;
        
        e.preventDefault();
        e.stopPropagation();
        
        // TÃ¼m tab'larÄ± pasif yap
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        // TÄ±klanan tab'Ä± aktif yap
        tab.classList.add('active');
        const tabId = tab.dataset.tab;
        const tabContent = qs(`#tab-${tabId}`);
        if (tabContent) {
          tabContent.classList.add('active');
          
          // Tab'a gÃ¶re iÃ§erik yÃ¼kle
          if (tabId === 'takvim') {
            if (typeof renderCalView === 'function') renderCalView();
          }
          if (tabId === 'istatistik') {
            if (typeof loadStatistics === 'function') loadStatistics();
          }
          if (tabId === 'ayarlar') {
            if (typeof loadRamazanAyarlari === 'function') loadRamazanAyarlari();
            if (typeof loadMahallar === 'function') loadMahallar();
            if (typeof loadTutarSecenekleri === 'function') loadTutarSecenekleri();
            if (typeof loadKapasiteAyarlari === 'function') loadKapasiteAyarlari();
            if (typeof loadPersonelHedefleri === 'function') loadPersonelHedefleri();
          }
          if (tabId === 'hedef') {
            // Analiz verilerini yÃ¼kle ve gÃ¶ster
            if (typeof loadAnalizVerileri === 'function') {
              loadAnalizVerileri().then(() => {
                if (typeof loadAnalizDashboard === 'function') loadAnalizDashboard();
                if (typeof loadTrendAnaliz === 'function') loadTrendAnaliz();
                if (typeof loadKategoriAnaliz === 'function') loadKategoriAnaliz();
                if (typeof loadKisiAnalizi === 'function') loadKisiAnalizi();
                if (typeof loadPersonelAnalizi === 'function') loadPersonelAnalizi();
                // Hedef tanÄ±mlamayÄ± yÃ¼kle
                if (typeof loadHedefTanÄ±mlama === 'function') loadHedefTanÄ±mlama();
              });
            } else {
              // Analiz verileri yoksa direkt hedef tanÄ±mlamayÄ± yÃ¼kle
              if (typeof loadHedefTanÄ±mlama === 'function') loadHedefTanÄ±mlama();
            }
          }
          if (tabId === 'veri-duzenleme') {
            // Veri dÃ¼zenleme sekmesi aÃ§Ä±ldÄ±ÄŸÄ±nda verileri yÃ¼kle
            if (typeof loadAnalizVerileri === 'function') {
              loadAnalizVerileri().then(() => {
                if (typeof loadVeriDuzenleme === 'function') loadVeriDuzenleme();
              });
            } else {
              if (typeof loadVeriDuzenleme === 'function') loadVeriDuzenleme();
            }
          }
          if (tabId === 'talepler') {
            // Talepler sekmesi aÃ§Ä±ldÄ±ÄŸÄ±nda talepleri yÃ¼kle
            if (typeof loadTalepler === 'function') loadTalepler();
          }
          if (tabId === 'menu') {
            // MenÃ¼ sekmesi aÃ§Ä±ldÄ±ÄŸÄ±nda menÃ¼leri yÃ¼kle
            if (typeof loadMenuler === 'function') loadMenuler();
          }
        }
      });
    }
    
    // DOM yÃ¼klendiÄŸinde tab'larÄ± baÅŸlat
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initTabs);
    } else {
      initTabs();
    }

    // Ramazan AyarlarÄ±
    let ramazanAyarlari = [];

    async function loadRamazanAyarlari() {
      try {
        const snap = await db.collection('ramazan_serif').doc('ayarlar').collection('yillar').orderBy('yil', 'desc').get();
        ramazanAyarlari = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderRamazanAyarlari();
      } catch (e) {
        console.error('Ramazan ayarlarÄ± yÃ¼klenemedi:', e);
        ramazanAyarlari = [];
        renderRamazanAyarlari();
      }
    }

    function renderRamazanAyarlari() {
      const tbody = qs('#tbodyRamazan');
      tbody.innerHTML = '';

      if (ramazanAyarlari.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--muted);padding:20px">KayÄ±t bulunamadÄ±</td></tr>';
        return;
      }

      ramazanAyarlari.forEach(r => {
        const tr = document.createElement('tr');
        const baslangic = new Date(r.baslangic);
        const bitis = new Date(r.bitis);
        
        tr.innerHTML = `
          <td><strong>${r.yil}</strong></td>
          <td>${baslangic.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric', weekday: 'long', timeZone: 'Europe/Istanbul' })}</td>
          <td>${bitis.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric', weekday: 'long', timeZone: 'Europe/Istanbul' })}</td>
          <td>${r.hicriYil || '-'}</td>
          <td>${r.aktif ? '<span style="color:var(--good);font-weight:600">Aktif</span>' : '<span style="color:var(--muted)">Pasif</span>'}</td>
          <td>
            <button onclick="editRamazan('${r.id}')" style="padding:4px 8px;font-size:12px">DÃ¼zenle</button>
            <button onclick="deleteRamazan('${r.id}')" class="danger" style="padding:4px 8px;font-size:12px">Sil</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function openRamazanModal(id = null) {
      qs('#ramazanId').value = id || '';
      qs('#ramazanTitle').textContent = id ? 'Ramazan-Ä± Åerif YÄ±lÄ± DÃ¼zenle' : 'Yeni Ramazan-Ä± Åerif YÄ±lÄ±';
      
      if (id) {
        const r = ramazanAyarlari.find(r => r.id === id);
        if (r) {
          const baslangic = new Date(r.baslangic);
          const bitis = new Date(r.bitis);
          qs('#ramazanYil').value = r.yil || '';
          qs('#ramazanBaslangic').value = baslangic.toISOString().slice(0, 10);
          qs('#ramazanBitis').value = bitis.toISOString().slice(0, 10);
          qs('#ramazanHicri').value = r.hicriYil || '';
          qs('#ramazanAktif').value = r.aktif ? 'true' : 'false';
        }
      } else {
        qs('#formRamazan').reset();
        qs('#ramazanYil').value = new Date().getFullYear();
        qs('#ramazanAktif').value = 'false';
      }
      
      qs('#modalRamazan').classList.add('show');
      document.body.classList.add('modal-open');
    }

    function closeRamazanModal() {
      qs('#modalRamazan').classList.remove('show');
      document.body.classList.remove('modal-open');
    }

    qs('#formRamazan').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const id = qs('#ramazanId').value;
      const yil = parseInt(qs('#ramazanYil').value);
      const baslangic = qs('#ramazanBaslangic').value;
      const bitis = qs('#ramazanBitis').value;
      const hicriYil = parseInt(qs('#ramazanHicri').value);
      const aktif = qs('#ramazanAktif').value === 'true';
      
      if (!yil || !baslangic || !bitis || !hicriYil) {
        alert('LÃ¼tfen tÃ¼m alanlarÄ± doldurun.');
        return;
      }
      
      // Aktif olan varsa diÄŸerlerini pasif yap
      if (aktif) {
        try {
          const snap = await db.collection('ramazan_serif').doc('ayarlar').collection('yillar').where('aktif', '==', true).get();
          const batch = db.batch();
          snap.docs.forEach(doc => {
            if (doc.id !== id) {
              batch.update(doc.ref, { aktif: false });
            }
          });
          await batch.commit();
        } catch (e) {
          console.error('Aktif yÄ±l gÃ¼ncellenemedi:', e);
        }
      }
      
      try {
        const ayarlarRef = db.collection('ramazan_serif').doc('ayarlar').collection('yillar');
        const data = {
          yil: yil,
          baslangic: baslangic,
          bitis: bitis,
          hicriYil: hicriYil,
          aktif: aktif,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        if (id) {
          await ayarlarRef.doc(id).update(data);
        } else {
          await ayarlarRef.add({
            ...data,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        }
        
        alert('Ramazan ayarÄ± baÅŸarÄ±yla kaydedildi!');
        closeRamazanModal();
        await loadRamazanAyarlari();
      } catch (e) {
        console.error('Ramazan ayarÄ± kaydedilemedi:', e);
        alert('Hata: ' + e.message);
      }
    });

    async function deleteRamazan(id) {
      if (!confirm('Bu Ramazan-Ä± Åerif yÄ±lÄ±nÄ± silmek istediÄŸinizden emin misiniz?')) return;
      
      try {
        await db.collection('ramazan_serif').doc('ayarlar').collection('yillar').doc(id).delete();
        alert('Ramazan ayarÄ± silindi!');
        await loadRamazanAyarlari();
      } catch (e) {
        console.error('Ramazan ayarÄ± silinemedi:', e);
        alert('Hata: ' + e.message);
      }
    }

    window.editRamazan = editRamazan;
    window.deleteRamazan = deleteRamazan;

    function editRamazan(id) {
      openRamazanModal(id);
    }

    window.openRamazanModal = openRamazanModal;

    // Mahal form submit listener - DOM yÃ¼klendikten sonra ekle
    setTimeout(() => {
      const formMahal = qs('#formMahal');
      if (formMahal) {
        // Ã–nceki listener'Ä± kaldÄ±r (varsa)
        const newForm = formMahal.cloneNode(true);
        formMahal.parentNode.replaceChild(newForm, formMahal);
        
        newForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const id = qs('#mahalId').value;
          const adi = qs('#mahalAdi').value.trim();
          const minMusafir = parseInt(qs('#mahalMin').value) || 1;
          const maxMusafir = parseInt(qs('#mahalMax').value) || 1;
          
          if (!adi || !maxMusafir || maxMusafir < minMusafir) {
            alert('LÃ¼tfen tÃ¼m alanlarÄ± doÄŸru ÅŸekilde doldurun. Max mÃ¼safir adedi min\'den kÃ¼Ã§Ã¼k olamaz.');
            return;
          }
          
          try {
            const ayarlarRef = db.collection('ramazan_serif').doc('ayarlar').collection('mahaller');
            const data = {
              adi: adi,
              minMusafir: minMusafir,
              maxMusafir: maxMusafir,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            if (id) {
              await ayarlarRef.doc(id).update(data);
            } else {
              await ayarlarRef.add({
                ...data,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
              });
            }
            
            alert('Mahal baÅŸarÄ±yla kaydedildi!');
            closeMahalModal();
            await loadMahallar();
          } catch (e) {
            console.error('Mahal kaydedilemedi:', e);
            alert('Hata: ' + e.message);
          }
        });
      }
    }, 100);

    // Kapasite AyarlarÄ±
    let kapasiteAyarlariList = [];

    async function loadKapasiteAyarlari() {
      const yil = qs('#kapasiteYil').value;
      if (!yil) {
        qs('#tbodyKapasite').innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--muted);padding:20px">LÃ¼tfen bir yÄ±l seÃ§iniz</td></tr>';
        qs('#genelKapasiteDisplay').innerHTML = '';
        return;
      }

      try {
        const yilRef = db.collection('ramazan_serif').doc(String(yil));
        
        // GÃ¼nlÃ¼k kapasite ayarlarÄ±nÄ± yÃ¼kle
        const snap = await yilRef.collection('kapasite_ayarlari').orderBy('tarih', 'desc').get();
        kapasiteAyarlariList = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderKapasiteAyarlari();

        // Genel kapasite ayarlarÄ±nÄ± yÃ¼kle
        const genelSnap = await yilRef.collection('ayarlar').doc('genel').get();
        if (genelSnap.exists) {
          const genelData = genelSnap.data();
          qs('#genelKapasiteDisplay').innerHTML = `
            <div style="display:flex;gap:16px;flex-wrap:wrap">
              <div><strong>Ä°ftar Max:</strong> ${genelData.iftarMax !== null && genelData.iftarMax !== undefined ? genelData.iftarMax : 'âˆ (SÄ±nÄ±rsÄ±z)'}</div>
              <div><strong>Sahur Max:</strong> ${genelData.sahurMax !== null && genelData.sahurMax !== undefined ? genelData.sahurMax : 'âˆ (SÄ±nÄ±rsÄ±z)'}</div>
            </div>
          `;
        } else {
          qs('#genelKapasiteDisplay').innerHTML = '<div style="color:var(--muted);font-size:13px">Genel kapasite ayarÄ± tanÄ±mlanmamÄ±ÅŸ</div>';
        }
      } catch (e) {
        console.error('Kapasite ayarlarÄ± yÃ¼klenemedi:', e);
        kapasiteAyarlariList = [];
        renderKapasiteAyarlari();
      }
    }

    function renderKapasiteAyarlari() {
      const tbody = qs('#tbodyKapasite');
      tbody.innerHTML = '';

      if (kapasiteAyarlariList.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--muted);padding:20px">KayÄ±t bulunamadÄ±</td></tr>';
        return;
      }

      kapasiteAyarlariList.forEach(k => {
        const tr = document.createElement('tr');
        // Firestore Timestamp kontrolÃ¼
        let tarih = new Date();
        if(k.tarih) {
          if(k.tarih.toDate) {
            tarih = k.tarih.toDate();
          } else if(k.tarih instanceof Date) {
            tarih = k.tarih;
          } else if(typeof k.tarih === 'string') {
            tarih = new Date(k.tarih);
          } else if(k.tarih.seconds) {
            tarih = new Date(k.tarih.seconds * 1000);
          }
        }
        
        tr.innerHTML = `
          <td>${tarih.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric', timeZone: 'Europe/Istanbul' })}</td>
          <td>${k.iftarMax !== null && k.iftarMax !== undefined ? k.iftarMax : 'âˆ (SÄ±nÄ±rsÄ±z)'}</td>
          <td>${k.sahurMax !== null && k.sahurMax !== undefined ? k.sahurMax : 'âˆ (SÄ±nÄ±rsÄ±z)'}</td>
          <td>
            <button onclick="editKapasite('${k.id}')" style="padding:4px 8px;font-size:12px">DÃ¼zenle</button>
            <button onclick="deleteKapasite('${k.id}')" class="danger" style="padding:4px 8px;font-size:12px">Sil</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function openGenelKapasiteModal() {
      const yil = qs('#kapasiteYil').value;
      if (!yil) {
        alert('LÃ¼tfen Ã¶nce bir yÄ±l seÃ§iniz');
        return;
      }

      // Mevcut genel kapasiteyi yÃ¼kle
      const yilRef = db.collection('ramazan_serif').doc(String(yil));
      yilRef.collection('ayarlar').doc('genel').get().then(doc => {
        if (doc.exists) {
          const data = doc.data();
          qs('#genelKapasiteIftar').value = data.iftarMax !== null && data.iftarMax !== undefined ? data.iftarMax : '';
          qs('#genelKapasiteSahur').value = data.sahurMax !== null && data.sahurMax !== undefined ? data.sahurMax : '';
        } else {
          qs('#genelKapasiteIftar').value = '';
          qs('#genelKapasiteSahur').value = '';
        }
      });

      qs('#modalGenelKapasite').classList.add('show');
      document.body.classList.add('modal-open');
    }

    function closeGenelKapasiteModal() {
      qs('#modalGenelKapasite').classList.remove('show');
      document.body.classList.remove('modal-open');
    }

    qs('#formGenelKapasite').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const yil = qs('#kapasiteYil').value;
      if (!yil) {
        alert('LÃ¼tfen bir yÄ±l seÃ§iniz');
        return;
      }

      const iftarMax = qs('#genelKapasiteIftar').value ? parseInt(qs('#genelKapasiteIftar').value) : null;
      const sahurMax = qs('#genelKapasiteSahur').value ? parseInt(qs('#genelKapasiteSahur').value) : null;

      try {
        const yilRef = db.collection('ramazan_serif').doc(String(yil));
        await yilRef.collection('ayarlar').doc('genel').set({
          iftarMax: iftarMax,
          sahurMax: sahurMax,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
        
        alert('Genel kapasite ayarÄ± kaydedildi!');
        closeGenelKapasiteModal();
        await loadKapasiteAyarlari();
      } catch (e) {
        console.error('Genel kapasite kaydedilemedi:', e);
        alert('Hata: ' + e.message);
      }
    });

    function openKapasiteModal(id = null) {
      const yil = qs('#kapasiteYil').value;
      if (!yil) {
        alert('LÃ¼tfen Ã¶nce bir yÄ±l seÃ§iniz');
        return;
      }

      qs('#kapasiteId').value = id || '';
      qs('#kapasiteTitle').textContent = id ? 'GÃ¼nlÃ¼k Kapasite DÃ¼zenle' : 'Yeni GÃ¼nlÃ¼k Kapasite';
      
      if (id) {
        const k = kapasiteAyarlariList.find(k => k.id === id);
        if (k) {
          // Firestore Timestamp kontrolÃ¼
          let tarih = new Date();
          if(k.tarih) {
            if(k.tarih.toDate) {
              tarih = k.tarih.toDate();
            } else if(k.tarih instanceof Date) {
              tarih = k.tarih;
            } else if(typeof k.tarih === 'string') {
              tarih = new Date(k.tarih);
            } else if(k.tarih.seconds) {
              tarih = new Date(k.tarih.seconds * 1000);
            }
          }
          qs('#kapasiteTarih').value = tarih.toISOString().slice(0, 10);
          qs('#kapasiteIftar').value = k.iftarMax !== null && k.iftarMax !== undefined ? k.iftarMax : '';
          qs('#kapasiteSahur').value = k.sahurMax !== null && k.sahurMax !== undefined ? k.sahurMax : '';
        }
      } else {
        qs('#formKapasite').reset();
      }
      
      qs('#modalKapasite').classList.add('show');
      document.body.classList.add('modal-open');
    }

    function closeKapasiteModal() {
      qs('#modalKapasite').classList.remove('show');
      document.body.classList.remove('modal-open');
    }

    qs('#formKapasite').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const yil = qs('#kapasiteYil').value;
      if (!yil) {
        alert('LÃ¼tfen bir yÄ±l seÃ§iniz');
        return;
      }

      const id = qs('#kapasiteId').value;
      const tarih = qs('#kapasiteTarih').value;
      const iftarMax = qs('#kapasiteIftar').value ? parseInt(qs('#kapasiteIftar').value) : null;
      const sahurMax = qs('#kapasiteSahur').value ? parseInt(qs('#kapasiteSahur').value) : null;
      
      if (!tarih) {
        alert('LÃ¼tfen bir tarih seÃ§iniz');
        return;
      }

      try {
        const yilRef = db.collection('ramazan_serif').doc(String(yil));
        const ayarlarRef = yilRef.collection('kapasite_ayarlari');
        
        const data = {
          tarih: tarih,
          iftarMax: iftarMax,
          sahurMax: sahurMax,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        if (id) {
          await ayarlarRef.doc(id).update(data);
        } else {
          await ayarlarRef.add({
            ...data,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        }
        
        alert('Kapasite ayarÄ± kaydedildi!');
        closeKapasiteModal();
        await loadKapasiteAyarlari();
      } catch (e) {
        console.error('Kapasite kaydedilemedi:', e);
        alert('Hata: ' + e.message);
      }
    });

    async function deleteKapasite(id) {
      const yil = qs('#kapasiteYil').value;
      if (!yil) return;
      
      if (!confirm('Bu kapasite ayarÄ±nÄ± silmek istediÄŸinizden emin misiniz?')) return;
      
      try {
        await db.collection('ramazan_serif').doc(String(yil)).collection('kapasite_ayarlari').doc(id).delete();
        alert('Kapasite ayarÄ± silindi!');
        await loadKapasiteAyarlari();
      } catch (e) {
        console.error('Kapasite silinemedi:', e);
        alert('Hata: ' + e.message);
      }
    }

    window.editKapasite = editKapasite;
    window.deleteKapasite = deleteKapasite;
    window.openKapasiteModal = openKapasiteModal;
    window.openGenelKapasiteModal = openGenelKapasiteModal;

    function editKapasite(id) {
      openKapasiteModal(id);
    }

    // Kapasite yÄ±l seÃ§imi deÄŸiÅŸimi
    if (qs('#kapasiteYil')) {
      qs('#kapasiteYil').addEventListener('change', () => {
        loadKapasiteAyarlari();
      });
    }

    // Takvim sekmesi iÃ§in seÃ§ili yÄ±la gÃ¶re ay listesini Ramazan takvimine gÃ¶re doldur
    async function updateCalAyOptionsForYear(yil) {
      const calSel = qs('#calAy');
      if (!calSel) return;

      calSel.innerHTML = '';

      // Ä°lgili yÄ±lÄ±n Ramazan ayarÄ±nÄ± yÃ¼kle
      await loadYilRamazanAyar(yil);

      let aylarSet = new Set();
      if (yilRamazanAyar && yilRamazanAyar.baslangic && yilRamazanAyar.bitis) {
        const bas = new Date(yilRamazanAyar.baslangic);
        const bit = new Date(yilRamazanAyar.bitis);
        const d = new Date(bas);
        while (d <= bit) {
          aylarSet.add(d.getMonth() + 1); // 1-12
          d.setDate(d.getDate() + 1);
        }
      }

      // EÄŸer Ramazan ayarÄ± yoksa tÃ¼m aylarÄ± gÃ¶ster (eski davranÄ±ÅŸ)
      let aylar = Array.from(aylarSet).sort((a, b) => a - b);
      if (aylar.length === 0) {
        aylar = Array.from({ length: 12 }, (_, i) => i + 1);
      }

      const today = new Date();
      let defaultAy = aylar[0];
      if (parseInt(yil) === today.getFullYear() && aylar.includes(today.getMonth() + 1)) {
        defaultAy = today.getMonth() + 1;
      }

      aylar.forEach(m => {
        const opt = document.createElement('option');
        opt.value = m;
        opt.textContent = ayIsimleri[m - 1];
        if (m === defaultAy) opt.selected = true;
        calSel.appendChild(opt);
      });
    }

    // Ramazan yÄ±llarÄ±nÄ± yÃ¼kle ve yÄ±l seÃ§eneklerini gÃ¼ncelle
    async function loadRamazanYillari() {
      try {
        const snap = await db.collection('ramazan_serif').doc('ayarlar').collection('yillar').orderBy('yil', 'desc').get();
        const yillar = snap.docs.map(d => d.data().yil);
        
        // Filtre yÄ±l seÃ§eneklerini gÃ¼ncelle
        updateYilSelect('filtreYil', yillar);
        updateYilSelect('exportYil', yillar);
        updateYilSelect('kapasiteYil', yillar);
        updateYilSelect('tutarYil', yillar);
        updateYilSelect('calYil', yillar);
        
        // Aktif yÄ±l varsa onu seÃ§
        const aktifSnap = await db.collection('ramazan_serif').doc('ayarlar').collection('yillar').where('aktif', '==', true).limit(1).get();
        if (!aktifSnap.empty) {
          const aktifYil = aktifSnap.docs[0].data().yil;
          qs('#filtreYil').value = aktifYil;
          qs('#exportYil').value = aktifYil;
          if (qs('#kapasiteYil')) qs('#kapasiteYil').value = aktifYil;
          if (qs('#tutarYil')) qs('#tutarYil').value = aktifYil;
          if (qs('#calYil')) qs('#calYil').value = aktifYil;
          currentYil = aktifYil;

          // Takvim gÃ¶rÃ¼nÃ¼mÃ¼ndeki ay listesini Ramazan takvimine gÃ¶re gÃ¼ncelle
          await updateCalAyOptionsForYear(aktifYil);
        } else if (yillar.length > 0) {
          // Aktif yÄ±l yoksa en yeni yÄ±lÄ± kullan
          const varsayilanYil = yillar[0];
          if (qs('#calYil')) qs('#calYil').value = varsayilanYil;
          await updateCalAyOptionsForYear(varsayilanYil);
        }
      } catch (e) {
        console.error('Ramazan yÄ±llarÄ± yÃ¼klenemedi:', e);
      }
    }

    function updateYilSelect(selectId, yillar) {
      const select = qs('#' + selectId);
      if (!select) return;
      
      const currentValue = select.value;
      select.innerHTML = '';
      
      yillar.forEach(yil => {
        const opt = document.createElement('option');
        opt.value = yil;
        opt.textContent = `${yil} Ramazan-Ä± Åerif`;
        select.appendChild(opt);
      });
      
      if (currentValue && yillar.includes(parseInt(currentValue))) {
        select.value = currentValue;
      } else if (yillar.length > 0) {
        select.value = yillar[0];
      }
    }

    // Takvim sekmesi: yÄ±l deÄŸiÅŸtiÄŸinde ay listesini Ramazan takvimine gÃ¶re gÃ¼ncelle
    const calYilSelect = qs('#calYil');
    if (calYilSelect) {
      calYilSelect.addEventListener('change', (e) => {
        const yil = e.target.value;
        if (yil) {
          updateCalAyOptionsForYear(yil);
        }
      });
    }

    function fillAyOptions() {
      const sel = qs('#filtreAy');
      sel.innerHTML = '<option value="">TÃ¼m Aylar</option>';
      ayIsimleri.forEach((ay, idx) => {
        const opt = document.createElement('option');
        opt.value = idx + 1;
        opt.textContent = ay;
        sel.appendChild(opt);
      });

      // Takvim gÃ¶rÃ¼nÃ¼mÃ¼ ay seÃ§enekleri Ramazan takvimine gÃ¶re ayrÄ± fonksiyonda gÃ¼ncelleniyor
    }

    // KayÄ±tlarÄ± yÃ¼kle
    async function loadKayitlar() {
      const yil = qs('#filtreYil').value;
      currentYil = parseInt(yil);
      
      try {
        const yilRef = db.collection('ramazan_serif').doc(String(yil));
        
        // Ä°ftar-sahur kayÄ±tlarÄ±nÄ± yÃ¼kle
        const snap = await yilRef.collection('kayitlar').orderBy('tarih', 'desc').get();
        const iftarSahurKayitlar = snap.docs.map(d => ({ 
          id: d.id, 
          ...d.data(), 
          kayitTipi: 'iftar-sahur',
          kayitKoleksiyon: 'kayitlar'
        }));
        
        // Teberru kayÄ±tlarÄ±nÄ± yÃ¼kle
        let teberruKayitlar = [];
        try {
          // Index sorunlarÄ±nÄ± Ã¶nlemek iÃ§in direkt tÃ¼m kayÄ±tlarÄ± yÃ¼kle ve client-side'da filtrele
          let teberruSnap = null;
          try {
            // Ã–nce orderBy ile deneyelim (index varsa)
            teberruSnap = await db.collection('teberru_kayitlari')
              .where('yil', '==', parseInt(yil))
              .orderBy('createdAt', 'desc')
              .get();
          } catch (e) {
            // Index yoksa tÃ¼m kayÄ±tlarÄ± yÃ¼kle ve client-side'da filtrele
            console.log('Teberru index hatasÄ±, tÃ¼m kayÄ±tlar yÃ¼kleniyor ve client-side\'da filtreleniyor:', e.message);
            try {
              // Sadece where ile deneyelim
              teberruSnap = await db.collection('teberru_kayitlari')
                .where('yil', '==', parseInt(yil))
                .get();
            } catch (e2) {
              // where de baÅŸarÄ±sÄ±z olursa tÃ¼m kayÄ±tlarÄ± yÃ¼kle
              console.log('Teberru where sorgusu da baÅŸarÄ±sÄ±z, tÃ¼m kayÄ±tlar yÃ¼kleniyor:', e2.message);
              teberruSnap = await db.collection('teberru_kayitlari').get();
            }
          }
          
          teberruKayitlar = teberruSnap.docs.map(d => {
            const data = d.data();
            // Tarih bilgisini dÃ¼zenle
            let tarih = data.createdAt;
            if (tarih && tarih.toDate) {
              tarih = tarih.toDate();
            } else if (tarih && tarih.seconds) {
              tarih = new Date(tarih.seconds * 1000);
            } else if (!tarih) {
              // createdAt yoksa tarih alanÄ±nÄ± kullan
              tarih = data.tarih;
              if (tarih && tarih.toDate) {
                tarih = tarih.toDate();
              } else if (tarih && tarih.seconds) {
                tarih = new Date(tarih.seconds * 1000);
              } else {
                tarih = new Date();
              }
            }
            
            // YÄ±l bilgisini belirle
            let kayitYil = data.yil;
            if (!kayitYil && tarih) {
              kayitYil = tarih.getFullYear();
            } else if (!kayitYil) {
              kayitYil = parseInt(yil);
            }
            
            return {
              id: d.id,
              ...data,
              tip: 'teberru',
              sahip: data.bagisci || '',
              tutar: data.miktar || 0,
              tarih: tarih,
              yil: kayitYil,
              ay: tarih ? tarih.getMonth() + 1 : new Date().getMonth() + 1,
              kayitTipi: 'teberru',
              kayitKoleksiyon: 'teberru_kayitlari',
              personel: data.personel || data.kaydedenPersonel || '',
              personelUid: data.personelUid || data.kaydedenPersonelUid || null
            };
          });
          
          // YÄ±l filtresini client-side'da uygula (her zaman)
          const yilNum = parseInt(yil);
          teberruKayitlar = teberruKayitlar.filter(t => {
            let tYil = t.yil;
            if (typeof tYil !== 'number') {
              tYil = parseInt(tYil) || (t.tarih ? new Date(t.tarih).getFullYear() : yilNum);
            }
            return tYil === yilNum;
          });
          console.log(`Teberru kayÄ±tlarÄ± yÃ¼klendi: ${teberruKayitlar.length} kayÄ±t (${yilNum} yÄ±lÄ± iÃ§in)`);
          
          // Client-side'da sÄ±rala (eÄŸer orderBy baÅŸarÄ±sÄ±z olduysa)
          teberruKayitlar.sort((a, b) => {
            const aDate = a.tarih?.getTime ? a.tarih.getTime() : (a.tarih ? new Date(a.tarih).getTime() : 0);
            const bDate = b.tarih?.getTime ? b.tarih.getTime() : (b.tarih ? new Date(b.tarih).getTime() : 0);
            return bDate - aDate; // En yeni Ã¶nce
          });
        } catch (e) {
          console.error('Teberru kayÄ±tlarÄ± yÃ¼klenemedi:', e);
        }
        
        // TaahhÃ¼t kayÄ±tlarÄ±nÄ± yÃ¼kle
        let taahhutKayitlar = [];
        try {
          // Index sorunlarÄ±nÄ± Ã¶nlemek iÃ§in direkt tÃ¼m kayÄ±tlarÄ± yÃ¼kle ve client-side'da filtrele
          let taahhutSnap = null;
          try {
            // Ã–nce orderBy ile deneyelim (index varsa)
            taahhutSnap = await db.collection('taahhut_kayitlari')
              .where('yil', '==', parseInt(yil))
              .orderBy('createdAt', 'desc')
              .get();
          } catch (e) {
            // Index yoksa tÃ¼m kayÄ±tlarÄ± yÃ¼kle ve client-side'da filtrele
            console.log('TaahhÃ¼t index hatasÄ±, tÃ¼m kayÄ±tlar yÃ¼kleniyor ve client-side\'da filtreleniyor:', e.message);
            try {
              // Sadece where ile deneyelim
              taahhutSnap = await db.collection('taahhut_kayitlari')
                .where('yil', '==', parseInt(yil))
                .get();
            } catch (e2) {
              // where de baÅŸarÄ±sÄ±z olursa tÃ¼m kayÄ±tlarÄ± yÃ¼kle
              console.log('TaahhÃ¼t where sorgusu da baÅŸarÄ±sÄ±z, tÃ¼m kayÄ±tlar yÃ¼kleniyor:', e2.message);
              taahhutSnap = await db.collection('taahhut_kayitlari').get();
            }
          }
          
          taahhutKayitlar = taahhutSnap.docs.map(d => {
            const data = d.data();
            // Tarih bilgisini dÃ¼zenle
            let tarih = data.createdAt;
            if (tarih && tarih.toDate) {
              tarih = tarih.toDate();
            } else if (tarih && tarih.seconds) {
              tarih = new Date(tarih.seconds * 1000);
            } else if (!tarih) {
              // createdAt yoksa tarih alanÄ±nÄ± kullan
              tarih = data.tarih;
              if (tarih && tarih.toDate) {
                tarih = tarih.toDate();
              } else if (tarih && tarih.seconds) {
                tarih = new Date(tarih.seconds * 1000);
              } else {
                tarih = new Date();
              }
            }
            
            // YÄ±l bilgisini belirle
            let kayitYil = data.yil;
            if (!kayitYil && tarih) {
              kayitYil = tarih.getFullYear();
            } else if (!kayitYil) {
              kayitYil = parseInt(yil);
            }
            
            return {
              id: d.id,
              ...data,
              tip: 'taahhut',
              sahip: data.bagisci || '',
              tutar: data.miktar || 0,
              tarih: tarih,
              yil: kayitYil,
              ay: tarih ? tarih.getMonth() + 1 : new Date().getMonth() + 1,
              kayitTipi: 'taahhut',
              kayitKoleksiyon: 'taahhut_kayitlari',
              personel: data.personel || data.kaydedenPersonel || '',
              personelUid: data.personelUid || data.kaydedenPersonelUid || null
            };
          });
          
          // YÄ±l filtresini client-side'da uygula (her zaman)
          const yilNum = parseInt(yil);
          taahhutKayitlar = taahhutKayitlar.filter(t => {
            let tYil = t.yil;
            if (typeof tYil !== 'number') {
              tYil = parseInt(tYil) || (t.tarih ? new Date(t.tarih).getFullYear() : yilNum);
            }
            return tYil === yilNum;
          });
          console.log(`TaahhÃ¼t kayÄ±tlarÄ± yÃ¼klendi: ${taahhutKayitlar.length} kayÄ±t (${yilNum} yÄ±lÄ± iÃ§in)`);
          
          // Client-side'da sÄ±rala (eÄŸer orderBy baÅŸarÄ±sÄ±z olduysa)
          taahhutKayitlar.sort((a, b) => {
            const aDate = a.tarih?.getTime ? a.tarih.getTime() : (a.tarih ? new Date(a.tarih).getTime() : 0);
            const bDate = b.tarih?.getTime ? b.tarih.getTime() : (b.tarih ? new Date(b.tarih).getTime() : 0);
            return bDate - aDate; // En yeni Ã¶nce
          });
        } catch (e) {
          console.error('TaahhÃ¼t kayÄ±tlarÄ± yÃ¼klenemedi:', e);
        }
        
        // TÃ¼m kayÄ±tlarÄ± birleÅŸtir
        kayitlar = [...iftarSahurKayitlar, ...teberruKayitlar, ...taahhutKayitlar];
        
        console.log(`Toplam kayÄ±t sayÄ±sÄ±: ${kayitlar.length} (Ä°ftar-Sahur: ${iftarSahurKayitlar.length}, Teberru: ${teberruKayitlar.length}, TaahhÃ¼t: ${taahhutKayitlar.length})`);
        
        // Tarihe gÃ¶re sÄ±rala (en yeni Ã¶nce)
        kayitlar.sort((a, b) => {
          const tarihA = a.tarih?.toDate ? a.tarih.toDate() : (a.tarih?.seconds ? new Date(a.tarih.seconds * 1000) : (a.tarih instanceof Date ? a.tarih : new Date(a.tarih || 0)));
          const tarihB = b.tarih?.toDate ? b.tarih.toDate() : (b.tarih?.seconds ? new Date(b.tarih.seconds * 1000) : (b.tarih instanceof Date ? b.tarih : new Date(b.tarih || 0)));
          return tarihB - tarihA;
        });
        
        renderKayitlar();
      } catch (e) {
        console.error('KayÄ±tlar yÃ¼klenemedi:', e);
        kayitlar = [];
        renderKayitlar();
      }
    }

    // Filtre tip deÄŸiÅŸtiÄŸinde tarih seÃ§imini gÃ¶ster/gizle
    qs('#filtreTip').addEventListener('change', async function() {
      const tip = this.value;
      const tarihSelect = qs('#filtreTarih');
      
      if (tip) {
        // SeÃ§ilen yÄ±la gÃ¶re ramazan tarih aralÄ±ÄŸÄ±ndan seÃ§im
        tarihSelect.style.display = 'block';
        
        // SeÃ§ilen yÄ±la gÃ¶re ramazan ayarÄ±nÄ± yÃ¼kle
        const yil = qs('#filtreYil')?.value || currentYil || new Date().getFullYear();
        await loadYilRamazanAyar(yil);
        const tarihler = getRamazanTarihListesi(yilRamazanAyar);
        tarihSelect.innerHTML = '<option value="">TÃ¼m Tarihler</option>';
        tarihler.forEach(t => {
          const option = document.createElement('option');
          option.value = t.value;
          option.textContent = t.label;
          tarihSelect.appendChild(option);
        });
      } else {
        tarihSelect.style.display = 'none';
      }
    });
    
    function filterKayitlar() {
      renderKayitlar();
    }

    function renderKayitlar() {
      const tbody = qs('#tbodyKayitlar');
      tbody.innerHTML = '';
      
      let filtered = [...kayitlar];
      
      const ay = qs('#filtreAy').value;
      if (ay) filtered = filtered.filter(k => k.ay === parseInt(ay));
      
      const tip = qs('#filtreTip').value;
      if (tip) filtered = filtered.filter(k => k.tip === tip);
      
      const tarih = qs('#filtreTarih').value;
      if (tarih) {
        filtered = filtered.filter(k => {
          let kTarih = '';
          if (k.tarih) {
            if (k.tarih.toDate) {
              kTarih = k.tarih.toDate().toISOString().slice(0, 10);
            } else if (k.tarih instanceof Date) {
              kTarih = k.tarih.toISOString().slice(0, 10);
            } else if (typeof k.tarih === 'string') {
              kTarih = k.tarih.slice(0, 10);
            } else if (k.tarih.seconds) {
              kTarih = new Date(k.tarih.seconds * 1000).toISOString().slice(0, 10);
            }
          } else if (k.createdAt) {
            if (k.createdAt.toDate) {
              kTarih = k.createdAt.toDate().toISOString().slice(0, 10);
            } else if (k.createdAt.seconds) {
              kTarih = new Date(k.createdAt.seconds * 1000).toISOString().slice(0, 10);
            }
          }
          return kTarih === tarih;
        });
      }
      
      const ara = qs('#araInput').value.trim();
      if (ara) {
        filtered = filtered.filter(k => 
          turkishIncludes(k.sahip || '', ara) ||
          turkishIncludes(k.personel || '', ara)
        );
      }
      
      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;color:var(--muted);padding:20px">KayÄ±t bulunamadÄ±</td></tr>';
        return;
      }
      
      filtered.forEach(k => {
        const tr = document.createElement('tr');
        // Firestore Timestamp kontrolÃ¼
        let tarihStr = '';
        if(k.tarih) {
          if(k.tarih.toDate) {
            tarihStr = k.tarih.toDate().toISOString().slice(0, 10);
          } else if(k.tarih instanceof Date) {
            tarihStr = k.tarih.toISOString().slice(0, 10);
          } else if(typeof k.tarih === 'string') {
            tarihStr = k.tarih.slice(0, 10);
          } else if(k.tarih.seconds) {
            // Timestamp objesi (seconds property var)
            tarihStr = new Date(k.tarih.seconds * 1000).toISOString().slice(0, 10);
          }
        }
        const tarih = tarihStr ? new Date(tarihStr) : new Date();
        
        // Tip etiketi
        let tipLabel = '';
        if (k.tip === 'iftar') {
          tipLabel = 'ğŸŒ™ Ä°ftar';
        } else if (k.tip === 'sahur') {
          tipLabel = 'ğŸŒŸ Sahur';
        } else if (k.tip === 'teberru') {
          tipLabel = 'ğŸ’ Teberru';
        } else if (k.tip === 'taahhut') {
          tipLabel = 'ğŸ“‹ TaahhÃ¼t';
        }
        
        // Sahip/BaÄŸÄ±ÅŸÃ§Ä± bilgisi
        const sahipBilgisi = k.sahip || k.bagisci || '-';
        // Tutar/Miktar bilgisi
        const tutarBilgisi = k.tutar || k.miktar || 0;
        
        tr.innerHTML = `
          <td>${tarih.getDate()}.${tarih.getMonth() + 1}.${tarih.getFullYear()}</td>
          <td><span class="badge-chip ${k.tip}">${tipLabel}</span></td>
          <td><strong>${sahipBilgisi}</strong></td>
          <td class="right"><strong>â‚º${Number(tutarBilgisi).toLocaleString('tr-TR',{minimumFractionDigits:2})}</strong></td>
          <td>${k.istirak !== undefined ? (k.istirak ? 'âœ“ Evet' : 'âœ— HayÄ±r') : '-'}</td>
          <td>${k.musafirAdedi || 0}</td>
          <td>${k.mahal || '-'}</td>
          <td>${k.personelAdi || k.personel || k.kaydedenPersonel || '-'}</td>
          <td style="max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${k.not || k.aciklama || ''}">${k.not || k.aciklama || '-'}</td>
          <td>
            <button onclick="editKayit('${k.id}', '${k.kayitTipi || 'iftar-sahur'}')" style="padding:4px 8px;font-size:12px">DÃ¼zenle</button>
            <button onclick="deleteKayit('${k.id}', '${k.kayitTipi || 'iftar-sahur'}')" class="danger" style="padding:4px 8px;font-size:12px">Sil</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    async function openEditModal(id = null, kayitTipi = 'iftar-sahur') {
      qs('#editId').value = id || '';
      qs('#editTitle').textContent = id ? 'KayÄ±t DÃ¼zenle' : 'Yeni KayÄ±t';
      
      // MahallarÄ± ve personelleri yÃ¼kle
      await Promise.all([loadMahallarForEdit(), loadPersonellerForEdit()]);
      
      if (id) {
        const k = kayitlar.find(k => k.id === id);
        if (k) {
          // Firestore Timestamp kontrolÃ¼
          let tarihStr = '';
          if(k.tarih) {
            if(k.tarih.toDate) {
              tarihStr = k.tarih.toDate().toISOString().slice(0, 10);
            } else if(k.tarih instanceof Date) {
              tarihStr = k.tarih.toISOString().slice(0, 10);
            } else if(typeof k.tarih === 'string') {
              tarihStr = k.tarih.slice(0, 10);
            } else if(k.tarih.seconds) {
              tarihStr = new Date(k.tarih.seconds * 1000).toISOString().slice(0, 10);
            }
          } else if(k.createdAt) {
            if(k.createdAt.toDate) {
              tarihStr = k.createdAt.toDate().toISOString().slice(0, 10);
            } else if(k.createdAt.seconds) {
              tarihStr = new Date(k.createdAt.seconds * 1000).toISOString().slice(0, 10);
            }
          }
          qs('#editTarih').value = tarihStr;
          qs('#editTip').value = k.tip;
          
          // Ä°ftar/sahur ise tarih select'i de gÃ¼ncelle
          if (k.tip === 'iftar' || k.tip === 'sahur') {
            if (qs('#editTarihSelect')) {
              qs('#editTarihSelect').value = tarihStr;
            }
          }
          
          // Tip'e gÃ¶re alanlarÄ± doldur
          if (k.tip === 'iftar' || k.tip === 'sahur') {
            qs('#editSahip').value = k.sahip || '';
            qs('#editTutar').value = k.tutar || 0;
            qs('#editIstirak').value = k.istirak !== undefined ? (k.istirak ? 'true' : 'false') : 'false';
            qs('#editMusafir').value = k.musafirAdedi || 0;
            
            // Mahal seÃ§imi
            if (k.mahalId) {
              qs('#editMahal').value = k.mahalId;
            } else if (k.mahal) {
              // Mahal adÄ±ndan ID bul
              const mahal = mahalList.find(m => m.adi === k.mahal);
              if (mahal) {
                qs('#editMahal').value = mahal.id;
              }
            }
          } else if (k.tip === 'teberru' || k.tip === 'taahhut') {
            qs('#editBagisci').value = k.bagisci || k.sahip || '';
            qs('#editMiktar').value = k.miktar || k.tutar || 0;
            qs('#editAciklama').value = k.aciklama || k.not || '';
            if (k.tip === 'teberru') {
              qs('#editOdeme').value = k.odemeYontemi || k.odeme || '';
            }
          }
          
          // Personel seÃ§imi
          if (k.personelUid) {
            qs('#editPersonel').value = k.personelUid;
          } else if (k.personel || k.personelAdi || k.kaydedenPersonel) {
            // Personel adÄ±ndan UID bul
            const personel = kullanicilarList.find(p => 
              p.adSoyad === k.personel || p.adSoyad === k.personelAdi || p.adSoyad === k.kaydedenPersonel
            );
            if (personel) {
              qs('#editPersonel').value = personel.id;
            }
          }
          
          // KayÄ±t tipini sakla (gÃ¼ncelleme iÃ§in)
          qs('#editId').setAttribute('data-kayit-tipi', k.kayitTipi || (k.tip === 'teberru' || k.tip === 'taahhut' ? k.tip : 'iftar-sahur'));
          qs('#editId').setAttribute('data-kayit-koleksiyon', k.kayitKoleksiyon || 
            (k.tip === 'teberru' ? 'teberru_kayitlari' : k.tip === 'taahhut' ? 'taahhut_kayitlari' : 'kayitlar'));
        }
      } else {
        qs('#formEdit').reset();
        qs('#editTarih').value = '';
        qs('#editTarihSelect').value = '';
        qs('#editMahal').value = '';
        qs('#editPersonel').value = '';
        qs('#editTip').value = '';
        qs('#editId').removeAttribute('data-kayit-tipi');
        qs('#editId').removeAttribute('data-kayit-koleksiyon');
      }
      
      // Tip'e gÃ¶re alanlarÄ± gÃ¶ster/gizle
      await updateEditFormFields();
      
      qs('#modalEdit').classList.add('show');
      document.body.classList.add('modal-open');
    }
    
    async function loadMahallarForEdit() {
      try {
        const snap = await db.collection('ramazan_serif').doc('ayarlar').collection('mahaller').orderBy('adi', 'asc').get();
        const mahallar = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        
        const select = qs('#editMahal');
        if (!select) return;
        
        // Mevcut seÃ§ili deÄŸeri sakla
        const currentValue = select.value;
        
        // Select'i temizle ve mahallarÄ± ekle
        select.innerHTML = '<option value="">Mahal SeÃ§iniz</option>';
        mahallar.forEach(m => {
          const option = document.createElement('option');
          option.value = m.id;
          option.textContent = m.adi || '-';
          select.appendChild(option);
        });
        
        // Ã–nceki deÄŸeri geri yÃ¼kle
        if (currentValue) {
          select.value = currentValue;
        }
      } catch (e) {
        console.error('Mahaller yÃ¼klenemedi:', e);
      }
    }
    
    async function loadPersonellerForEdit() {
      try {
        // KullanÄ±cÄ±lar listesi yoksa yÃ¼kle
        if (!kullanicilarList || kullanicilarList.length === 0) {
          await loadKullanicilar();
        }
        
        const select = qs('#editPersonel');
        if (!select) return;
        
        // Mevcut seÃ§ili deÄŸeri sakla
        const currentValue = select.value;
        
        // Select'i temizle ve personelleri ekle
        select.innerHTML = '<option value="">Personel SeÃ§iniz</option>';
        kullanicilarList.forEach(p => {
          const option = document.createElement('option');
          option.value = p.id;
          option.textContent = p.adSoyad || p.email || '-';
          select.appendChild(option);
        });
        
        // Ã–nceki deÄŸeri geri yÃ¼kle
        if (currentValue) {
          select.value = currentValue;
        }
      } catch (e) {
        console.error('Personeller yÃ¼klenemedi:', e);
      }
    }

    function closeEditModal() {
      qs('#modalEdit').classList.remove('show');
      document.body.classList.remove('modal-open');
    }
    
    // Aktif ramazan ayarÄ±nÄ± yÃ¼kle
    let aktifRamazanAyar = null;
    async function loadAktifRamazanAyar() {
      try {
        const snap = await db.collection('ramazan_serif').doc('ayarlar').collection('yillar')
          .where('aktif', '==', true)
          .limit(1)
          .get();
        if (!snap.empty) {
          aktifRamazanAyar = snap.docs[0].data();
        }
      } catch (e) {
        console.error('Aktif ramazan ayarÄ± yÃ¼klenemedi:', e);
      }
    }
    
    // Belirli bir yÄ±l iÃ§in ramazan ayarÄ±nÄ± yÃ¼kle
    let yilRamazanAyar = null;
    async function loadYilRamazanAyar(yil) {
      try {
        const snap = await db.collection('ramazan_serif').doc('ayarlar').collection('yillar')
          .where('yil', '==', parseInt(yil))
          .limit(1)
          .get();
        if (!snap.empty) {
          yilRamazanAyar = snap.docs[0].data();
        } else {
          yilRamazanAyar = null;
        }
      } catch (e) {
        console.error(`${yil} yÄ±lÄ± ramazan ayarÄ± yÃ¼klenemedi:`, e);
        yilRamazanAyar = null;
      }
    }
    
    // Ramazan tarih aralÄ±ÄŸÄ±ndan tarih listesi oluÅŸtur (aktif veya belirli yÄ±l)
    function getRamazanTarihListesi(ramazanAyar = null) {
      const ayar = ramazanAyar || aktifRamazanAyar || yilRamazanAyar;
      if (!ayar || !ayar.baslangic || !ayar.bitis) {
        return [];
      }
      const baslangic = new Date(ayar.baslangic);
      const bitis = new Date(ayar.bitis);
      const tarihler = [];
      const currentDate = new Date(baslangic);
      while (currentDate <= bitis) {
        tarihler.push({
          value: currentDate.toISOString().slice(0, 10),
          label: currentDate.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric', weekday: 'long' })
        });
        currentDate.setDate(currentDate.getDate() + 1);
      }
      return tarihler;
    }
    
    // Tip deÄŸiÅŸtiÄŸinde alanlarÄ± gÃ¶ster/gizle
    async function updateEditFormFields() {
      const tip = qs('#editTip').value;
      
      // TÃ¼m gruplarÄ± gizle
      qs('#editGroupSahip').style.display = 'none';
      qs('#editGroupTutar').style.display = 'none';
      qs('#editGroupIstirak').style.display = 'none';
      qs('#editGroupMusafir').style.display = 'none';
      qs('#editGroupMahal').style.display = 'none';
      qs('#editGroupBagisci').style.display = 'none';
      qs('#editGroupMiktar').style.display = 'none';
      qs('#editGroupOdeme').style.display = 'none';
      qs('#editGroupAciklama').style.display = 'none';
      
      // Tarih alanlarÄ±nÄ± gizle
      qs('#editGroupTarih').style.display = 'none';
      qs('#editGroupTarihSelect').style.display = 'none';
      qs('#editTarih').removeAttribute('required');
      qs('#editTarihSelect').removeAttribute('required');
      
      // Required attribute'larÄ± kaldÄ±r
      qs('#editSahip').removeAttribute('required');
      qs('#editTutar').removeAttribute('required');
      qs('#editMusafir').removeAttribute('required');
      qs('#editBagisci').removeAttribute('required');
      qs('#editMiktar').removeAttribute('required');
      qs('#editOdeme').removeAttribute('required');
      
      if (tip === 'iftar' || tip === 'sahur') {
        // Ä°ftar/Sahur alanlarÄ± - SeÃ§ilen yÄ±la gÃ¶re ramazan tarih aralÄ±ÄŸÄ±ndan seÃ§im
        qs('#editGroupTarihSelect').style.display = 'block';
        qs('#editTarihSelect').setAttribute('required', 'required');
        
        // SeÃ§ilen yÄ±la gÃ¶re ramazan ayarÄ±nÄ± yÃ¼kle
        const yil = qs('#filtreYil')?.value || currentYil || new Date().getFullYear();
        await loadYilRamazanAyar(yil);
        const tarihler = getRamazanTarihListesi(yilRamazanAyar);
        const select = qs('#editTarihSelect');
        select.innerHTML = '<option value="">Tarih SeÃ§iniz</option>';
        tarihler.forEach(t => {
          const option = document.createElement('option');
          option.value = t.value;
          option.textContent = t.label;
          select.appendChild(option);
        });
        
        // Tarih select deÄŸiÅŸtiÄŸinde date input'u da gÃ¼ncelle (sadece bir kez ekle)
        const existingListener = select.getAttribute('data-listener-added');
        if (!existingListener) {
          select.setAttribute('data-listener-added', 'true');
          select.addEventListener('change', function() {
            if (this.value) {
              qs('#editTarih').value = this.value;
            }
          });
        }
        
        qs('#editGroupSahip').style.display = 'block';
        qs('#editGroupTutar').style.display = 'block';
        qs('#editGroupIstirak').style.display = 'block';
        qs('#editGroupMusafir').style.display = 'block';
        qs('#editGroupMahal').style.display = 'block';
        qs('#editSahip').setAttribute('required', 'required');
        qs('#editTutar').setAttribute('required', 'required');
        qs('#editMusafir').setAttribute('required', 'required');
      } else if (tip === 'teberru' || tip === 'taahhut') {
        // Teberru/TaahhÃ¼t alanlarÄ± - SeÃ§ilen yÄ±la gÃ¶re ramazan tarih aralÄ±ÄŸÄ±ndan seÃ§im
        qs('#editGroupTarihSelect').style.display = 'block';
        qs('#editTarihSelect').setAttribute('required', 'required');
        
        // SeÃ§ilen yÄ±la gÃ¶re ramazan ayarÄ±nÄ± yÃ¼kle
        const yil = qs('#filtreYil')?.value || currentYil || new Date().getFullYear();
        await loadYilRamazanAyar(yil);
        const tarihler = getRamazanTarihListesi(yilRamazanAyar);
        const select = qs('#editTarihSelect');
        select.innerHTML = '<option value="">Tarih SeÃ§iniz</option>';
        tarihler.forEach(t => {
          const option = document.createElement('option');
          option.value = t.value;
          option.textContent = t.label;
          select.appendChild(option);
        });
        
        // Tarih select deÄŸiÅŸtiÄŸinde date input'u da gÃ¼ncelle (sadece bir kez ekle)
        const existingListener = select.getAttribute('data-listener-added');
        if (!existingListener) {
          select.setAttribute('data-listener-added', 'true');
          select.addEventListener('change', function() {
            if (this.value) {
              qs('#editTarih').value = this.value;
            }
          });
        }
        
        // Date input'u da gÃ¶ster ama gizli tut (form submit iÃ§in gerekli)
        qs('#editGroupTarih').style.display = 'none';
        qs('#editTarih').removeAttribute('required');
        
        if (tip === 'teberru') {
          qs('#editGroupBagisci').style.display = 'block';
          qs('#editGroupMiktar').style.display = 'block';
          qs('#editGroupOdeme').style.display = 'block';
          qs('#editGroupAciklama').style.display = 'block';
          qs('#editBagisci').setAttribute('required', 'required');
          qs('#editMiktar').setAttribute('required', 'required');
          qs('#editOdeme').setAttribute('required', 'required');
        } else if (tip === 'taahhut') {
          qs('#editGroupBagisci').style.display = 'block';
          qs('#editGroupMiktar').style.display = 'block';
          qs('#editGroupAciklama').style.display = 'block';
          qs('#editBagisci').setAttribute('required', 'required');
          qs('#editMiktar').setAttribute('required', 'required');
        }
      }
    }
    
    // Tip deÄŸiÅŸtiÄŸinde event listener
    qs('#editTip').addEventListener('change', updateEditFormFields);

    qs('#formEdit').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const id = qs('#editId').value;
      // Tarih seÃ§imi: iftar/sahur iÃ§in select, teberru/taahhut iÃ§in date input
      let tarih = '';
      if (qs('#editTarihSelect') && qs('#editTarihSelect').style.display !== 'none') {
        tarih = qs('#editTarihSelect').value || qs('#editTarih').value;
      } else {
        tarih = qs('#editTarih').value;
      }
      const tip = qs('#editTip').value;
      const personelUid = qs('#editPersonel').value || null;
      
      // Tip'e gÃ¶re alanlarÄ± al
      let sahip = '';
      let tutar = 0;
      let istirak = false;
      let musafirAdedi = 0;
      let mahalId = null;
      let bagisci = '';
      let miktar = 0;
      let odemeYontemi = '';
      let aciklama = '';
      
      if (tip === 'iftar' || tip === 'sahur') {
        sahip = qs('#editSahip').value.trim();
        tutar = parseFloat(qs('#editTutar').value) || 0;
        istirak = qs('#editIstirak').value === 'true';
        musafirAdedi = parseInt(qs('#editMusafir').value) || 0;
        mahalId = qs('#editMahal').value || null;
        
        if (!sahip) {
          showToast('Hata', 'LÃ¼tfen sahip adÄ±nÄ± giriniz', 'error');
          return;
        }
        if (!tutar || tutar <= 0) {
          showToast('Hata', 'LÃ¼tfen geÃ§erli bir tutar giriniz', 'error');
          return;
        }
      } else if (tip === 'teberru') {
        bagisci = qs('#editBagisci').value.trim();
        miktar = parseFloat(qs('#editMiktar').value) || 0;
        odemeYontemi = qs('#editOdeme').value || '';
        aciklama = qs('#editAciklama').value.trim();
        
        if (!bagisci) {
          showToast('Hata', 'LÃ¼tfen baÄŸÄ±ÅŸÃ§Ä± adÄ±nÄ± giriniz', 'error');
          return;
        }
        if (!miktar || miktar <= 0) {
          showToast('Hata', 'LÃ¼tfen geÃ§erli bir miktar giriniz', 'error');
          return;
        }
        if (!odemeYontemi) {
          showToast('Hata', 'LÃ¼tfen Ã¶deme yÃ¶ntemi seÃ§iniz', 'error');
          return;
        }
      } else if (tip === 'taahhut') {
        bagisci = qs('#editBagisci').value.trim();
        miktar = parseFloat(qs('#editMiktar').value) || 0;
        aciklama = qs('#editAciklama').value.trim();
        
        if (!bagisci) {
          showToast('Hata', 'LÃ¼tfen baÄŸÄ±ÅŸÃ§Ä± adÄ±nÄ± giriniz', 'error');
          return;
        }
        if (!miktar || miktar <= 0) {
          showToast('Hata', 'LÃ¼tfen geÃ§erli bir miktar giriniz', 'error');
          return;
        }
      }
      
      // KayÄ±t tipi ve koleksiyon bilgisini al
      const kayitTipi = qs('#editId').getAttribute('data-kayit-tipi') || (tip === 'teberru' || tip === 'taahhut' ? tip : 'iftar-sahur');
      const kayitKoleksiyon = qs('#editId').getAttribute('data-kayit-koleksiyon') || 
        (tip === 'teberru' ? 'teberru_kayitlari' : tip === 'taahhut' ? 'taahhut_kayitlari' : 'kayitlar');
      
      const date = new Date(tarih);
      const yil = date.getFullYear();
      const ay = date.getMonth() + 1;
      
      // Personel bilgisini al
      let personelAd = null;
      let personelUidFinal = personelUid;
      if (personelUid) {
        const personel = kullanicilarList.find(p => p.id === personelUid);
        if (personel) {
          personelAd = personel.adSoyad || personel.email;
        }
      }
      
      // Mahal bilgisini al
      let mahalAdi = null;
      if (mahalId) {
        const mahal = mahalList.find(m => m.id === mahalId);
        if (mahal) {
          mahalAdi = mahal.adi;
        } else {
          // EÄŸer mahalList'te yoksa tekrar yÃ¼kle
          try {
            const mahalDoc = await db.collection('ramazan_serif').doc('ayarlar').collection('mahaller').doc(mahalId).get();
            if (mahalDoc.exists) {
              mahalAdi = mahalDoc.data().adi;
            }
          } catch (e) {
            console.error('Mahal bilgisi alÄ±namadÄ±:', e);
          }
        }
      }
      
      try {
        // Muhasebe notu
        const muhasebeNotu = 'KayÄ±t yapan/gÃ¼ncelleyen: Muhasebe';
        
        if (kayitTipi === 'teberru' || kayitTipi === 'taahhut') {
          // Teberru veya TaahhÃ¼t kaydÄ±
          const data = {
            bagisci: bagisci,
            miktar: miktar,
            tarih: tarih,
            yil: yil,
            ay: ay,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          };
          
          // Teberru iÃ§in Ã¶deme yÃ¶ntemi ekle
          if (tip === 'teberru') {
            data.odemeYontemi = odemeYontemi;
            data.odeme = odemeYontemi;
          }
          
          // Personel bilgisini ekle
          // Not ve aÃ§Ä±klama ekle (muhasebe notu + kullanÄ±cÄ± aÃ§Ä±klamasÄ±)
          let finalAciklama = '';
          if (id) {
            // GÃ¼ncelleme - mevcut kaydÄ± al ve eski personel bilgilerini temizle
            const existingDoc = await db.collection(kayitKoleksiyon).doc(id).get();
            if (existingDoc.exists) {
              const existingData = existingDoc.data();
              
              // Eski personel bilgilerini temizle (yeni personel seÃ§ilmiÅŸse veya personel kaldÄ±rÄ±lmÄ±ÅŸsa)
              if (personelAd && personelUidFinal) {
                // Yeni personel bilgisi var - eski alanlarÄ± temizle ve yeni bilgileri ekle
                data.personel = personelAd;
                data.kaydedenPersonel = personelAd;
                data.personelUid = personelUidFinal;
                data.kaydedenPersonelUid = personelUidFinal;
                // Eski personel alanlarÄ±nÄ± sil (eÄŸer varsa ve farklÄ±ysa)
                if (existingData.personelAdi) {
                  data.personelAdi = firebase.firestore.FieldValue.delete();
                }
              } else if (!personelAd && !personelUidFinal) {
                // Personel kaldÄ±rÄ±lmÄ±ÅŸ - tÃ¼m personel alanlarÄ±nÄ± temizle
                data.personel = firebase.firestore.FieldValue.delete();
                data.kaydedenPersonel = firebase.firestore.FieldValue.delete();
                data.personelUid = firebase.firestore.FieldValue.delete();
                data.kaydedenPersonelUid = firebase.firestore.FieldValue.delete();
                if (existingData.personelAdi) {
                  data.personelAdi = firebase.firestore.FieldValue.delete();
                }
              } else {
                // Sadece ad veya uid var - mevcut durumu koru ama eksik olanÄ± ekle
                if (personelAd) {
                  data.personel = personelAd;
                  data.kaydedenPersonel = personelAd;
                }
                if (personelUidFinal) {
                  data.personelUid = personelUidFinal;
                  data.kaydedenPersonelUid = personelUidFinal;
                }
              }
              
              let existingNot = existingData.not || existingData.aciklama || '';
              // KullanÄ±cÄ± aÃ§Ä±klamasÄ± varsa ekle
              if (aciklama) {
                finalAciklama = aciklama;
              } else if (existingNot && !existingNot.includes('Muhasebe')) {
                // EÄŸer muhasebe notu yoksa mevcut aÃ§Ä±klamayÄ± kullan
                finalAciklama = existingNot;
              }
              // Muhasebe notunu ekle
              if (!finalAciklama.includes('Muhasebe')) {
                finalAciklama = finalAciklama ? finalAciklama + ' | ' + muhasebeNotu : muhasebeNotu;
              } else {
                // Zaten varsa, gÃ¼ncelleme notunu ekle
                finalAciklama = finalAciklama.replace(/KayÄ±t yapan\/gÃ¼ncelleyen: Muhasebe/g, muhasebeNotu);
              }
            } else {
              // Yeni kayÄ±t gibi davran
              if (personelAd) {
                data.personel = personelAd;
                data.kaydedenPersonel = personelAd;
              }
              if (personelUidFinal) {
                data.personelUid = personelUidFinal;
                data.kaydedenPersonelUid = personelUidFinal;
              }
              finalAciklama = aciklama ? aciklama + ' | ' + muhasebeNotu : muhasebeNotu;
            }
          } else {
            // Yeni kayÄ±t
            if (personelAd) {
              data.personel = personelAd;
              data.kaydedenPersonel = personelAd;
            }
            if (personelUidFinal) {
              data.personelUid = personelUidFinal;
              data.kaydedenPersonelUid = personelUidFinal;
            }
            finalAciklama = aciklama ? aciklama + ' | ' + muhasebeNotu : muhasebeNotu;
            data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
          }
          data.not = finalAciklama;
          data.aciklama = finalAciklama;
          
          if (id) {
            await db.collection(kayitKoleksiyon).doc(id).update(data);
          } else {
            const docRef = await db.collection(kayitKoleksiyon).add(data);
            // Yeni kayÄ±t ID'sini logla (debug iÃ§in)
            console.log('Yeni kayÄ±t oluÅŸturuldu:', docRef.id, 'Koleksiyon:', kayitKoleksiyon, 'YÄ±l:', yil);
          }
        } else {
          // Ä°ftar-Sahur kaydÄ±
          const yilRef = db.collection('ramazan_serif').doc(String(yil));
          const data = {
            tarih: tarih,
            tip: tip,
            sahip: sahip,
            tutar: tutar,
            istirak: istirak,
            musafirAdedi: musafirAdedi,
            yil: yil,
            ay: ay,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          };
          
          // Personel bilgisini ekle
          if (id) {
            // GÃ¼ncelleme - mevcut kaydÄ± al ve eski personel bilgilerini temizle
            const existingDoc = await yilRef.collection('kayitlar').doc(id).get();
            if (existingDoc.exists) {
              const existingData = existingDoc.data();
              
              // Eski personel bilgilerini temizle (yeni personel seÃ§ilmiÅŸse veya personel kaldÄ±rÄ±lmÄ±ÅŸsa)
              if (personelAd && personelUidFinal) {
                // Yeni personel bilgisi var - eski alanlarÄ± temizle
                data.personel = personelAd;
                data.personelAdi = personelAd;
                data.personelUid = personelUidFinal;
                // Eski personel alanlarÄ±nÄ± sil (eÄŸer varsa)
                if (existingData.kaydedenPersonel) {
                  data.kaydedenPersonel = firebase.firestore.FieldValue.delete();
                }
                if (existingData.kaydedenPersonelUid) {
                  data.kaydedenPersonelUid = firebase.firestore.FieldValue.delete();
                }
              } else if (!personelAd && !personelUidFinal) {
                // Personel kaldÄ±rÄ±lmÄ±ÅŸ - tÃ¼m personel alanlarÄ±nÄ± temizle
                data.personel = firebase.firestore.FieldValue.delete();
                data.personelAdi = firebase.firestore.FieldValue.delete();
                data.personelUid = firebase.firestore.FieldValue.delete();
                if (existingData.kaydedenPersonel) {
                  data.kaydedenPersonel = firebase.firestore.FieldValue.delete();
                }
                if (existingData.kaydedenPersonelUid) {
                  data.kaydedenPersonelUid = firebase.firestore.FieldValue.delete();
                }
              } else {
                // Sadece ad veya uid var - mevcut durumu koru ama eksik olanÄ± ekle
                if (personelAd) {
                  data.personel = personelAd;
                  data.personelAdi = personelAd;
                }
                if (personelUidFinal) {
                  data.personelUid = personelUidFinal;
                }
              }
              
              let existingNot = existingData.not || '';
              // EÄŸer muhasebe notu yoksa ekle, varsa gÃ¼ncelle
              if (!existingNot.includes('Muhasebe')) {
                existingNot = existingNot ? existingNot + ' | ' + muhasebeNotu : muhasebeNotu;
              } else {
                // Zaten varsa, gÃ¼ncelleme notunu ekle
                existingNot = existingNot.replace(/KayÄ±t yapan\/gÃ¼ncelleyen: Muhasebe/g, muhasebeNotu);
              }
              data.not = existingNot;
            } else {
              // DokÃ¼man yoksa yeni kayÄ±t gibi davran
              if (personelAd) {
                data.personel = personelAd;
                data.personelAdi = personelAd;
              }
              if (personelUidFinal) {
                data.personelUid = personelUidFinal;
              }
              data.not = muhasebeNotu;
            }
          } else {
            // Yeni kayÄ±t
            if (personelAd) {
              data.personel = personelAd;
              data.personelAdi = personelAd;
            }
            if (personelUidFinal) {
              data.personelUid = personelUidFinal;
            }
            data.not = muhasebeNotu;
            data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
          }
          
          // Mahal bilgisini ekle
          if (mahalId) {
            data.mahalId = mahalId;
          }
          if (mahalAdi) {
            data.mahal = mahalAdi;
          }
          
          if (id) {
            await yilRef.collection('kayitlar').doc(id).update(data);
          } else {
            const docRef = await yilRef.collection('kayitlar').add(data);
            // Yeni kayÄ±t ID'sini logla (debug iÃ§in)
            console.log('Yeni iftar-sahur kaydÄ± oluÅŸturuldu:', docRef.id, 'YÄ±l:', yil);
          }
        }
        
        showToast('BaÅŸarÄ±lÄ±', 'KayÄ±t kaydedildi', 'success');
        closeEditModal();
        // Firestore cache sorununu Ã¶nlemek iÃ§in daha uzun gecikme
        await new Promise(resolve => setTimeout(resolve, 1000));
        await loadKayitlar();
      } catch (e) {
        console.error('KayÄ±t kaydedilemedi:', e);
        showToast('Hata', 'KayÄ±t kaydedilemedi', 'error');
      }
    });

    async function deleteKayit(id, kayitTipi = 'iftar-sahur') {
      const confirmed = await showConfirmModal(
        'KayÄ±t Silme',
        'Bu kaydÄ± silmek istediÄŸinizden emin misiniz?',
        'Sil',
        'danger'
      );
      
      if (!confirmed) return;
      
      try {
        const k = kayitlar.find(k => k.id === id);
        if (k) {
          const tip = kayitTipi || k.kayitTipi || 'iftar-sahur';
          const koleksiyon = k.kayitKoleksiyon || 
            (tip === 'teberru' ? 'teberru_kayitlari' : tip === 'taahhut' ? 'taahhut_kayitlari' : 'kayitlar');
          
          if (tip === 'teberru' || tip === 'taahhut') {
            await db.collection(koleksiyon).doc(id).delete();
          } else {
            const yilRef = db.collection('ramazan_serif').doc(String(k.yil));
            await yilRef.collection('kayitlar').doc(id).delete();
          }
          showToast('BaÅŸarÄ±lÄ±', 'KayÄ±t silindi', 'success');
          await loadKayitlar();
        }
      } catch (e) {
        console.error('KayÄ±t silinemedi:', e);
        showAlertModal('Hata', 'KayÄ±t silinemedi: ' + e.message);
      }
    }

    window.editKayit = editKayit;
    window.deleteKayit = deleteKayit;

    function editKayit(id, kayitTipi = 'iftar-sahur') {
      openEditModal(id, kayitTipi);
    }

    // Takvim gÃ¶rÃ¼nÃ¼mÃ¼ (Ramazan takvimine gÃ¶re tek sayfa)
    async function renderCalView() {
      const yil = parseInt(qs('#calYil').value);
      
      try {
        // SeÃ§ili yÄ±lÄ±n Ramazan takvimini yÃ¼kle
        await loadYilRamazanAyar(yil);

        const grid = qs('#calViewGrid');
        const detailBox = qs('#calDayDetail');
        const tbodyDetail = qs('#tbodyCalDay');
        if (!grid) return;

        // Ã–nce alanlarÄ± temizle
        grid.innerHTML = '';
        if (detailBox && tbodyDetail) {
          detailBox.style.display = 'none';
          tbodyDetail.innerHTML = '';
        }

        if (!yilRamazanAyar || !yilRamazanAyar.baslangic || !yilRamazanAyar.bitis) {
          // Ramazan takvimi tanÄ±mlÄ± deÄŸilse bilgilendir
          const info = document.createElement('div');
          info.style.gridColumn = 'span 7';
          info.style.padding = '16px';
          info.style.textAlign = 'center';
          info.style.color = 'var(--muted)';
          info.style.fontSize = '13px';
          info.textContent = 'Bu yÄ±l iÃ§in Ramazan takvimi tanÄ±mlÄ± deÄŸil. LÃ¼tfen Ayarlar > Ramazan AyarlarÄ± bÃ¶lÃ¼mÃ¼nden ekleyin.';
          grid.appendChild(info);
          return;
        }

        const bas = new Date(yilRamazanAyar.baslangic);
        const bit = new Date(yilRamazanAyar.bitis);

        const yilRef = db.collection('ramazan_serif').doc(String(yil));
        // TÃ¼m yÄ±l kayÄ±tlarÄ±nÄ± Ã§ek, Ramazan aralÄ±ÄŸÄ±nÄ± client-side filtrele
        const snap = await yilRef.collection('kayitlar').get();
        
        const tumKayitlar = snap.docs.map(d => d.data());
        const byDate = new Map();
        
        tumKayitlar.forEach(k => {
          if (!k.tarih) return;
          const tarihDate = k.tarih.toDate ? k.tarih.toDate() :
                            (k.tarih instanceof Date ? k.tarih : new Date(k.tarih));
          if (tarihDate < bas || tarihDate > bit) return;
          const tarihStr = tarihDate.toISOString().slice(0, 10);
          if (!byDate.has(tarihStr)) byDate.set(tarihStr, []);
          byDate.get(tarihStr).push(k);
        });
        
        const startDay = (bas.getDay() + 6) % 7; // Pazartesi 0
        
        for (let i = 0; i < startDay; i++) {
          const div = document.createElement('div');
          div.className = 'cal-day';
          grid.appendChild(div);
        }
        
        const today = new Date();
        let selectedCell = null;
        
        const current = new Date(bas);
        while (current <= bit) {
          const dateStr = current.toISOString().slice(0, 10);
          const gunKayitlar = byDate.get(dateStr) || [];
          
          const div = document.createElement('div');
          div.className = 'cal-day';
          if (dateStr === today.toISOString().slice(0, 10)) div.classList.add('today');
          if (gunKayitlar.length > 0) div.classList.add('has-data');
          
          const gun = current.getDate();
          const ayIndex = current.getMonth(); // 0-11
          
          const iftarCount = gunKayitlar.filter(k => k.tip === 'iftar').length;
          const sahurCount = gunKayitlar.filter(k => k.tip === 'sahur').length;

          div.innerHTML = `
            <div style="font-weight:600">${gun}</div>
            <div style="margin-top:4px;font-size:11px">
              ${iftarCount ? `<span class="badge-chip iftar">Ä° ${iftarCount}</span>` : ''}
              ${sahurCount ? `<span class="badge-chip sahur">S ${sahurCount}</span>` : ''}
            </div>
          `;
          
          if (gunKayitlar.length > 0) {
            div.onclick = () => {
              if (selectedCell) selectedCell.classList.remove('selected');
              selectedCell = div;
              div.classList.add('selected');
              openCalDayModal(dateStr, gunKayitlar);
            };
          }
          
          grid.appendChild(div);
          current.setDate(current.getDate() + 1);
        }
      } catch (e) {
        console.error('Takvim yÃ¼klenemedi:', e);
      }
    }

    // Takvim gÃ¼n detay modali
    function openCalDayModal(dateStr, gunKayitlar) {
      const modal = qs('#modalCalDay');
      const titleEl = qs('#calDayModalTitle');
      const summaryEl = qs('#calDayModalSummary');
      const tbodyIftar = qs('#tbodyCalIftar');
      const tbodySahur = qs('#tbodyCalSahur');
      if (!modal || !titleEl || !summaryEl || !tbodyIftar || !tbodySahur) return;

      const date = new Date(dateStr);
      titleEl.textContent = date.toLocaleDateString('tr-TR', {
        day: 'numeric',
        month: 'long',
        year: 'numeric',
        weekday: 'long'
      });

      const iftarList = gunKayitlar.filter(k => k.tip === 'iftar');
      const sahurList = gunKayitlar.filter(k => k.tip === 'sahur');

      const iftarCount = iftarList.length;
      const sahurCount = sahurList.length;
      const toplamTutar = gunKayitlar.reduce((sum, k) => {
        const t = k.tutar || k.miktar || 0;
        return sum + (typeof t === 'number' ? t : parseFloat(t) || 0);
      }, 0);

      summaryEl.textContent = `Toplam ${iftarCount} iftar, ${sahurCount} sahur kaydÄ± â€¢ Toplam Tutar: ${toplamTutar.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} â‚º`;

      const renderRows = (list, tbody) => {
        tbody.innerHTML = '';
        if (!list || list.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--muted);padding:10px">KayÄ±t bulunamadÄ±.</td></tr>';
          return;
        }
        list.forEach(k => {
          const tr = document.createElement('tr');
          const personel = k.personelAdi || k.personel || k.kaydedenPersonel || '-';
          const sahip = k.sahip || k.bagisci || '-';
          const mahal = k.mahal || '-';
          const musafir = k.musafirAdedi != null ? k.musafirAdedi : '-';
          const tutar = k.tutar || k.miktar || 0;
          tr.innerHTML = `
            <td>${personel}</td>
            <td>${sahip}</td>
            <td>${mahal}</td>
            <td>${musafir}</td>
            <td class="right">${tutar ? tutar.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '-'}</td>
          `;
          tbody.appendChild(tr);
        });
      };

      renderRows(iftarList, tbodyIftar);
      renderRows(sahurList, tbodySahur);

      modal.classList.add('show');
      document.body.classList.add('modal-open');
    }

    function closeCalDayModal() {
      const modal = qs('#modalCalDay');
      if (!modal) return;
      modal.classList.remove('show');
      document.body.classList.remove('modal-open');
    }

    // Tutar seÃ§enekleri
    async function loadTutarSecenekleri() {
      const yil = qs('#tutarYil').value;
      try {
        const yilRef = db.collection('ramazan_serif').doc(String(yil));
        // Ä°ndex gerektirmemek iÃ§in client-side'da sÄ±rala
        const snap = await yilRef.collection('tutar_secenekleri').get();
        tutarSecenekleri = snap.docs.map(d => ({ id: d.id, ...d.data() }))
          .sort((a, b) => (a.sira || 0) - (b.sira || 0));
        renderTutarSecenekleri();
      } catch (e) {
        console.error('Tutar seÃ§enekleri yÃ¼klenemedi:', e);
        tutarSecenekleri = [];
        renderTutarSecenekleri();
      }
    }

    function renderTutarSecenekleri() {
      const tbody = qs('#tbodyTutar');
      tbody.innerHTML = '';
      
      if (tutarSecenekleri.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--muted);padding:20px">KayÄ±t bulunamadÄ±</td></tr>';
        return;
      }
      
      tutarSecenekleri.forEach(t => {
        const tr = document.createElement('tr');
        const tipLabel = t.tip === 'iftar' ? 'ğŸŒ™ Ä°ftar' : (t.tip === 'sahur' ? 'ğŸŒŸ Sahur' : 'ğŸ”¹ Genel');
        tr.innerHTML = `
          <td>${t.sira || 0}</td>
          <td><strong>â‚º${Number(t.tutar || 0).toLocaleString('tr-TR',{minimumFractionDigits:2})}</strong></td>
          <td>${t.label || '-'}</td>
          <td>${tipLabel}</td>
          <td>${t.aktif ? '<span style="color:var(--good)">Aktif</span>' : '<span style="color:var(--muted)">Pasif</span>'}</td>
          <td>
            <button onclick="editTutar('${t.id}')" style="padding:4px 8px;font-size:12px">DÃ¼zenle</button>
            <button onclick="deleteTutar('${t.id}')" class="danger" style="padding:4px 8px;font-size:12px">Sil</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

    function openTutarModal(id = null) {
      qs('#tutarId').value = id || '';
      qs('#tutarTitle').textContent = id ? 'Tutar SeÃ§eneÄŸi DÃ¼zenle' : 'Yeni Tutar SeÃ§eneÄŸi';
      
      if (id) {
        const t = tutarSecenekleri.find(t => t.id === id);
        if (t) {
          qs('#tutarTutar').value = t.tutar || 0;
          qs('#tutarLabel').value = t.label || '';
          qs('#tutarSira').value = t.sira || 1;
          qs('#tutarAktif').value = t.aktif ? 'true' : 'false';
          qs('#tutarTip').value = t.tip || '';
        }
      } else {
        qs('#formTutar').reset();
        qs('#tutarSira').value = tutarSecenekleri.length + 1;
        qs('#tutarTip').value = '';
      }
      
      qs('#modalTutar').classList.add('show');
      document.body.classList.add('modal-open');
    }

    function closeTutarModal() {
      qs('#modalTutar').classList.remove('show');
      document.body.classList.remove('modal-open');
    }

    qs('#formTutar').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const id = qs('#tutarId').value;
      const yil = qs('#tutarYil').value;
      const tutar = parseFloat(qs('#tutarTutar').value) || 0;
      const label = qs('#tutarLabel').value.trim();
      const sira = parseInt(qs('#tutarSira').value) || 1;
      const aktif = qs('#tutarAktif').value === 'true';
      const tip = qs('#tutarTip').value || null; // null = genel (her ikisi iÃ§in)
      
      try {
        const yilRef = db.collection('ramazan_serif').doc(String(yil));
        const data = {
          tutar: tutar,
          label: label,
          sira: sira,
          aktif: aktif,
          tip: tip || null // null = genel, 'iftar' veya 'sahur'
        };
        
        if (id) {
          await yilRef.collection('tutar_secenekleri').doc(id).update(data);
        } else {
          await yilRef.collection('tutar_secenekleri').add(data);
        }
        
        alert('Tutar seÃ§eneÄŸi kaydedildi!');
        closeTutarModal();
        await loadTutarSecenekleri();
      } catch (e) {
        console.error('Tutar seÃ§eneÄŸi kaydedilemedi:', e);
        alert('Hata: ' + e.message);
      }
    });

    async function deleteTutar(id) {
      if (!confirm('Bu tutar seÃ§eneÄŸini silmek istediÄŸinizden emin misiniz?')) return;
      
      try {
        const yil = qs('#tutarYil').value;
        const yilRef = db.collection('ramazan_serif').doc(String(yil));
        await yilRef.collection('tutar_secenekleri').doc(id).delete();
        alert('Tutar seÃ§eneÄŸi silindi!');
        await loadTutarSecenekleri();
      } catch (e) {
        console.error('Tutar seÃ§eneÄŸi silinemedi:', e);
        alert('Hata: ' + e.message);
      }
    }

    window.editTutar = editTutar;
    window.deleteTutar = deleteTutar;

    function editTutar(id) {
      openTutarModal(id);
    }

    qs('#tutarYil').addEventListener('change', loadTutarSecenekleri);

    // Ä°statistikler
    async function loadStatistics() {
      const yil = parseInt(qs('#statYil').value);
      
      try {
        const yilRef = db.collection('ramazan_serif').doc(String(yil));
        const snap = await yilRef.collection('kayitlar')
          .where('yil', '==', yil)
          .get();
        
        const allKayitlar = snap.docs.map(d => d.data());
        
        const iftarSayisi = allKayitlar.filter(k => k.tip === 'iftar').length;
        const sahurSayisi = allKayitlar.filter(k => k.tip === 'sahur').length;
        const toplamTutar = allKayitlar.reduce((sum, k) => sum + (Number(k.tutar) || 0), 0);
        const toplamMusafir = allKayitlar.reduce((sum, k) => sum + (Number(k.musafirAdedi) || 0), 0);
        const istirakSayisi = allKayitlar.filter(k => k.istirak).length;
        
        qs('#statsGrid').innerHTML = `
          <div class="stat-card">
            <div class="stat-label">Toplam Ä°ftar</div>
            <div class="stat-value">${iftarSayisi}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Toplam Sahur</div>
            <div class="stat-value">${sahurSayisi}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Toplam Tutar</div>
            <div class="stat-value">â‚º${toplamTutar.toLocaleString('tr-TR',{minimumFractionDigits:2})}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Toplam MÃ¼safir</div>
            <div class="stat-value">${toplamMusafir}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Ä°ÅŸtirak Edilen</div>
            <div class="stat-value">${istirakSayisi}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Toplam KayÄ±t</div>
            <div class="stat-value">${allKayitlar.length}</div>
          </div>
        `;
        
        // AylÄ±k daÄŸÄ±lÄ±m
        const aylik = {};
        for (let i = 1; i <= 12; i++) {
          aylik[i] = { iftar: 0, sahur: 0, tutar: 0, musafir: 0 };
        }
        
        allKayitlar.forEach(k => {
          const ay = k.ay || 1;
          if (k.tip === 'iftar') aylik[ay].iftar++;
          if (k.tip === 'sahur') aylik[ay].sahur++;
          aylik[ay].tutar += Number(k.tutar) || 0;
          aylik[ay].musafir += Number(k.musafirAdedi) || 0;
        });
        
        const tbodyAylik = qs('#tbodyAylik');
        tbodyAylik.innerHTML = '';
        Object.entries(aylik).forEach(([ay, data]) => {
          if (data.iftar === 0 && data.sahur === 0) return;
          
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td><strong>${ayIsimleri[parseInt(ay) - 1]}</strong></td>
            <td>${data.iftar}</td>
            <td>${data.sahur}</td>
            <td class="right"><strong>â‚º${data.tutar.toLocaleString('tr-TR',{minimumFractionDigits:2})}</strong></td>
            <td class="right">${data.musafir}</td>
          `;
          tbodyAylik.appendChild(tr);
        });
        
        if (tbodyAylik.innerHTML === '') {
          tbodyAylik.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--muted);padding:20px">KayÄ±t bulunamadÄ±</td></tr>';
        }
      } catch (e) {
        console.error('Ä°statistikler yÃ¼klenemedi:', e);
      }
    }

    // CSV Export
    async function exportCSV() {
      const yil = qs('#exportYil').value;
      
      try {
        const yilRef = db.collection('ramazan_serif').doc(String(yil));
        const snap = await yilRef.collection('kayitlar').orderBy('tarih', 'asc').get();
        
        const rows = [['Tarih', 'Tip', 'Sahip', 'Tutar', 'Ä°ÅŸtirak', 'MÃ¼safirAdedi', 'Personel']];
        
        snap.docs.forEach(d => {
          const k = d.data();
          const tarihStr = k.tarih instanceof Date ? k.tarih.toISOString().slice(0, 10) : k.tarih;
          rows.push([
            tarihStr,
            k.tip || '',
            k.sahip || '',
            k.tutar || 0,
            k.istirak ? 'Evet' : 'HayÄ±r',
            k.musafirAdedi || 0,
            k.personel || ''
          ]);
        });
        
        const csv = rows.map(r => r.map(cell => {
          const str = String(cell);
          return str.includes(',') || str.includes('"') || str.includes('\n') 
            ? `"${str.replace(/"/g, '""')}"` 
            : str;
        }).join(',')).join('\n');
        
        const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `ramazan-serif-${yil}.csv`;
        link.click();
      } catch (e) {
        console.error('CSV export hatasÄ±:', e);
        alert('CSV dÄ±ÅŸa aktarÄ±lÄ±rken hata oluÅŸtu: ' + e.message);
      }
    }

    // CSV Import
    async function importCSV() {
      const file = qs('#importFile').files[0];
      if (!file) {
        alert('LÃ¼tfen bir CSV dosyasÄ± seÃ§in.');
        return;
      }
      
      // UTF-8 encoding ile dosyayÄ± oku (TÃ¼rkÃ§e karakter desteÄŸi iÃ§in)
      const text = await new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = (e) => resolve(e.target.result);
        reader.onerror = reject;
        reader.readAsText(file, 'UTF-8');
      });
      
      const lines = text.split(/\r?\n/).filter(l => l.trim());
      if (lines.length < 2) {
        alert('CSV dosyasÄ± boÅŸ veya geÃ§ersiz.');
        return;
      }
      
      const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
      const rows = lines.slice(1).map(line => {
        const values = [];
        let current = '';
        let inQuotes = false;
        
        for (let i = 0; i < line.length; i++) {
          const char = line[i];
          if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === ',' && !inQuotes) {
            values.push(current.trim());
            current = '';
          } else {
            current += char;
          }
        }
        values.push(current.trim());
        return values;
      });
      
      try {
        const user = auth.currentUser;
        let personelAd = 'Bilinmeyen';
        if (user) {
          try {
            const userDoc = await db.collection('kullanicilar').doc(user.uid).get();
            if (userDoc.exists) {
              personelAd = userDoc.data().adSoyad || user.email || 'Bilinmeyen';
            }
          } catch (e) {}
        }
        
        const yilRef = db.collection('ramazan_serif').doc(String(currentYil));
        let imported = 0;
        
        for (const row of rows) {
          if (row.length < headers.length) continue;
          
          const tarih = row[0] || '';
          const tip = row[1] || '';
          const sahip = row[2] || '';
          const tutar = parseFloat(row[3]) || 0;
          const istirak = (row[4] || '').toLowerCase().includes('evet');
          const musafirAdedi = parseInt(row[5]) || 0;
          const personel = row[6] || personelAd;
          
          if (!tarih || !tip || !sahip) continue;
          
          const date = new Date(tarih);
          const yil = date.getFullYear();
          const ay = date.getMonth() + 1;
          
          await yilRef.collection('kayitlar').add({
            tarih: tarih,
            tip: tip.toLowerCase(),
            sahip: sahip,
            tutar: tutar,
            tutarSecenek: String(tutar),
            istirak: istirak,
            musafirAdedi: musafirAdedi,
            personel: personel,
            personelUid: user?.uid || null,
            yil: yil,
            ay: ay,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
          
          imported++;
        }
        
        alert(`${imported} kayÄ±t baÅŸarÄ±yla iÃ§e aktarÄ±ldÄ±!`);
        qs('#importFile').value = '';
        await loadKayitlar();
      } catch (e) {
        console.error('CSV import hatasÄ±:', e);
        alert('CSV iÃ§e aktarÄ±lÄ±rken hata oluÅŸtu: ' + e.message);
      }
    }

    // YÄ±l deÄŸiÅŸtiÄŸinde hem kayÄ±tlarÄ± yÃ¼kle hem de tarih seÃ§imini gÃ¼ncelle
    qs('#filtreYil').addEventListener('change', async function() {
      // Tarih seÃ§imini gÃ¼ncelle
      const tip = qs('#filtreTip')?.value;
      const tarihSelect = qs('#filtreTarih');
      
      if (tip && tarihSelect && tarihSelect.style.display !== 'none') {
        const yil = this.value || currentYil || new Date().getFullYear();
        await loadYilRamazanAyar(yil);
        const tarihler = getRamazanTarihListesi(yilRamazanAyar);
        tarihSelect.innerHTML = '<option value="">TÃ¼m Tarihler</option>';
        tarihler.forEach(t => {
          const option = document.createElement('option');
          option.value = t.value;
          option.textContent = t.label;
          tarihSelect.appendChild(option);
        });
      }
      
      // KayÄ±tlarÄ± yÃ¼kle
      await loadKayitlar();
    });

    // ESC tuÅŸu
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        closeEditModal();
        closeTutarModal();
      }
    });

    document.addEventListener('click', (e) => {
      if (e.target.classList.contains('modal')) {
        closeEditModal();
        closeTutarModal();
        closeVeriYukleModal();
        closeKisiDetayModal();
      }
    });

    // ===== HEDEF YÃ–NETÄ°MÄ° - Finansal Analiz Sistemi =====
    
    // Veri yÃ¼kleme deÄŸiÅŸkenleri
    let analizVerileri = {}; // { yil: { tip: { sahip: [...veriler] } } }
    let analizVerileriYukleniyor = false; // YÃ¼kleme durumu kontrolÃ¼
    
    // Veri yÃ¼kleme modal
    function openVeriYukleModal() {
      qs('#veriYukleFile').value = '';
      qs('#veriYukleYil').value = '';
      qs('#veriYuklePreview').style.display = 'none';
      qs('#modalVeriYukle').classList.add('show');
      document.body.classList.add('modal-open');
    }
    
    function closeVeriYukleModal() {
      qs('#modalVeriYukle').classList.remove('show');
      document.body.classList.remove('modal-open');
    }
    
    window.openVeriYukleModal = openVeriYukleModal;
    window.closeVeriYukleModal = closeVeriYukleModal;
    
    // CSV ÅŸablon indir
    function downloadVeriSablon() {
      const csv = 'YÄ±l,Tip,Sahip,DiÄŸer,Tutar,Referans\n' +
                  '2023,iftar,Ali GÃ¶vercin,Mehmet Kara,10000.50,Muhsin Ã‡elik\n' +
                  '2023,sahur,Mehmet YÄ±lmaz,,5000.00,REF002\n' +
                  '2023,taahhut,Fatma Demir,AyÅŸe YÄ±lmaz,15000.75,REF003\n' +
                  '2023,teberru,AyÅŸe Kaya,,20000.00,REF004\n' +
                  '2024,iftar,Ali GÃ¶vercin,Mehmet Kara,12000.25,REF101\n' +
                  '2024,sahur,Mehmet YÄ±lmaz,,6000.50,REF102';
      
      const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'finansal-analiz-sablon.csv';
      link.click();
    }
    
    window.downloadVeriSablon = downloadVeriSablon;
    
    // Veri Temizleme Modal
    function openVeriTemizleModal() {
      const modal = qs('#modalVeriTemizle');
      if (modal) {
        modal.classList.add('show');
        document.body.classList.add('modal-open');
      }
    }
    
    function closeVeriTemizleModal() {
      const modal = qs('#modalVeriTemizle');
      if (modal) {
        modal.classList.remove('show');
        document.body.classList.remove('modal-open');
      }
    }
    
    window.openVeriTemizleModal = openVeriTemizleModal;
    window.closeVeriTemizleModal = closeVeriTemizleModal;
    
    // CSV dosyasÄ± parse ve Ã¶nizleme - DOM yÃ¼klendikten sonra
    setTimeout(() => {
      const veriYukleFile = qs('#veriYukleFile');
      if (veriYukleFile) {
        veriYukleFile.addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      try {
        // UTF-8 encoding ile dosyayÄ± oku (TÃ¼rkÃ§e karakter desteÄŸi iÃ§in)
        const text = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => resolve(e.target.result);
          reader.onerror = reject;
          reader.readAsText(file, 'UTF-8');
        });
        
        const lines = text.split(/\r?\n/).filter(l => l.trim());
        if (lines.length < 2) {
          alert('CSV dosyasÄ± boÅŸ veya geÃ§ersiz!');
          return;
        }
        
        // Header'Ä± parse et
        const headers = lines[0].split(',').map(h => h.trim().toLowerCase());
        
        // Veri satÄ±rlarÄ±nÄ± parse et (ilk 10)
        const previewData = [];
        for (let i = 1; i < Math.min(11, lines.length); i++) {
          const values = parseCSVLine(lines[i]);
          if (values.length < 5) continue; // En az 5 kolon olmalÄ± (yil, tip, sahip, diger, tutar)
          
          const yil = values[0]?.trim() || '';
          const tipRaw = values[1]?.trim() || '';
          const tip = normalizeTurkish(tipRaw); // TÃ¼rkÃ§e karakter uyumu (I->Ä±, Ä°->i)
          const sahip = values[2]?.trim() || '';
          const diger = values[3]?.trim() || '';
          const tutar = parseTutar(values[4]?.trim() || '0');
          const referans = values[5]?.trim() || '';
          
          if (!yil || !tip || !sahip || !tutar || tutar <= 0) continue;
          
          previewData.push({ yil, tip, sahip, diger, tutar, referans });
        }
        
        // Ã–nizleme gÃ¶ster
        if (previewData.length > 0) {
          const tbody = qs('#veriYuklePreviewBody');
          tbody.innerHTML = '';
          previewData.forEach(row => {
            const tr = document.createElement('tr');
            
            // HTML escape fonksiyonu (TÃ¼rkÃ§e karakterler iÃ§in)
            const escapeHtml = (str) => {
              if (!str) return '';
              const div = document.createElement('div');
              div.textContent = str;
              return div.innerHTML;
            };
            
            const tipCell = document.createElement('td');
            tipCell.textContent = row.tip;
            
            const sahipCell = document.createElement('td');
            sahipCell.textContent = row.sahip;
            
            const digerCell = document.createElement('td');
            digerCell.textContent = row.diger || '-';
            
            const tutarCell = document.createElement('td');
            tutarCell.textContent = 'â‚º' + Number(row.tutar).toLocaleString('tr-TR', {minimumFractionDigits:2});
            
            const referansCell = document.createElement('td');
            referansCell.textContent = row.referans || '-';
            
            tr.appendChild(tipCell);
            tr.appendChild(sahipCell);
            tr.appendChild(digerCell);
            tr.appendChild(tutarCell);
            tr.appendChild(referansCell);
            
            tbody.appendChild(tr);
          });
          qs('#veriYuklePreview').style.display = 'block';
        }
      } catch (e) {
        console.error('Dosya okuma hatasÄ±:', e);
        showToast('Hata', 'Dosya okunamadÄ±: ' + e.message, 'error');
        }
      });
    }
    }, 200);
    
    // TÃ¼rkÃ§e karakter normalizasyonu (Ä±-Ä° uyumu iÃ§in)
    function normalizeTurkish(str) {
      if (!str) return '';
      return String(str)
        .replace(/I/g, 'Ä±')  // BÃ¼yÃ¼k I -> kÃ¼Ã§Ã¼k Ä±
        .replace(/Ä°/g, 'i')  // BÃ¼yÃ¼k Ä° -> kÃ¼Ã§Ã¼k i
        .replace(/Ä±/g, 'Ä±')  // KÃ¼Ã§Ã¼k Ä± -> kÃ¼Ã§Ã¼k Ä± (aynÄ± kalÄ±r)
        .replace(/i/g, 'i')  // KÃ¼Ã§Ã¼k i -> kÃ¼Ã§Ã¼k i (aynÄ± kalÄ±r)
        .toLowerCase()
        .trim();
    }
    
    // TÃ¼rkÃ§e karakter uyumlu arama (Ä±-Ä° uyumu)
    function turkishIncludes(str, search) {
      if (!str || !search) return false;
      const normalizedStr = normalizeTurkish(str);
      const normalizedSearch = normalizeTurkish(search);
      return normalizedStr.includes(normalizedSearch);
    }
    
    // Personel/referans isimlerini standart formata Ã§evir (TÃœMÃœ BÃœYÃœK HARF - TÃ¼rkÃ§e)
    function normalizePersonelName(name) {
      if (!name) return '';
      // Ã–nce trim yap
      name = String(name).trim();
      // BoÅŸsa dÃ¶ndÃ¼r
      if (!name) return '';
      // "DiÄŸer" Ã¶zel durumu - bÃ¼yÃ¼k harfle
      if (normalizeTurkish(name) === 'diÄŸer') return 'DÄ°ÄER';
      // TÃ¼m harfleri bÃ¼yÃ¼k yap (TÃ¼rkÃ§e karakter desteÄŸi ile)
      return name.toLocaleUpperCase('tr-TR');
    }
    
    // CSV satÄ±rÄ±nÄ± parse et (virgÃ¼l ve tÄ±rnak iÅŸareti desteÄŸi)
    function parseCSVLine(line) {
      const values = [];
      let current = '';
      let inQuotes = false;
      
      for (let i = 0; i < line.length; i++) {
        const char = line[i];
        if (char === '"') {
          inQuotes = !inQuotes;
        } else if (char === ',' && !inQuotes) {
          values.push(current.trim());
          current = '';
        } else {
          current += char;
        }
      }
      values.push(current.trim());
      return values;
    }
    
    // Tutar parse et (virgÃ¼l destekli, binlik ayÄ±rÄ±cÄ± destekli)
    function parseTutar(str) {
      if (!str || str === '') return 0;
      // VirgÃ¼lÃ¼ noktaya Ã§evir (TÃ¼rkÃ§e format: 10.000,50)
      // EÄŸer son karakter virgÃ¼lse (kÃ¼sÃ¼rat varsa), virgÃ¼lÃ¼ nokta yap
      let cleaned = String(str).trim().replace(/\./g, ''); // Binlik ayÄ±rÄ±cÄ±yÄ± kaldÄ±r
      cleaned = cleaned.replace(/,/g, '.'); // VirgÃ¼lÃ¼ noktaya Ã§evir (kÃ¼sÃ¼rat iÃ§in)
      const parsed = parseFloat(cleaned);
      return isNaN(parsed) ? 0 : parsed;
    }
    
    // Veri yÃ¼kleme form submit - DOM yÃ¼klendikten sonra
    setTimeout(() => {
      const formVeriYukle = qs('#formVeriYukle');
      if (formVeriYukle) {
        formVeriYukle.addEventListener('submit', async (e) => {
          e.preventDefault();
          
          const file = qs('#veriYukleFile').files[0];
          const yil = qs('#veriYukleYil').value;
          
          if (!file || !yil) {
            showToast('Hata', 'LÃ¼tfen dosya ve yÄ±l seÃ§iniz!', 'error');
            return;
          }
          
          // Submit butonunu devre dÄ±ÅŸÄ± bÄ±rak
          const submitBtn = formVeriYukle.querySelector('button[type="submit"]');
          const originalBtnText = submitBtn.textContent;
          submitBtn.disabled = true;
          submitBtn.textContent = 'YÃ¼kleniyor...';
          
          try {
        // UTF-8 encoding ile dosyayÄ± oku (TÃ¼rkÃ§e karakter desteÄŸi iÃ§in)
        const text = await new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => resolve(e.target.result);
          reader.onerror = reject;
          reader.readAsText(file, 'UTF-8');
        });
        
        const lines = text.split(/\r?\n/).filter(l => l.trim());
        if (lines.length < 2) {
          alert('CSV dosyasÄ± boÅŸ veya geÃ§ersiz!');
          return;
        }
        
        const user = auth.currentUser;
        // YÃ¶netici bilgisi (CSV'yi yÃ¼kleyen kiÅŸi - sadece "DiÄŸer" referanslarÄ± iÃ§in kullanÄ±lacak)
        let yoneticiAd = 'Bilinmeyen';
        let yoneticiUid = null;
        if (user) {
          yoneticiUid = user.uid;
          try {
            const userDoc = await db.collection('kullanicilar').doc(user.uid).get();
            if (userDoc.exists) {
              yoneticiAd = userDoc.data().adSoyad || user.email || 'Bilinmeyen';
            }
          } catch (e) {}
        }
        
        let batch = db.batch();
        let imported = 0;
        let skipped = 0;
        let batchCount = 0;
        const totalLines = lines.length - 1; // Header hariÃ§
        const hatalar = []; // Hata detaylarÄ±
        let kolonHatasi = 0;
        let validasyonHatasi = 0;
        let tipHatasi = 0;
        let digerHatalar = 0;
        
        showProgress(15);
        
        // Ä°lk satÄ±rÄ± atla (header)
        for (let i = 1; i < lines.length; i++) {
          const satirNo = i + 1; // Excel satÄ±r numarasÄ± (header dahil)
          const progress = 15 + Math.floor((i / totalLines) * 75); // 15-90 arasÄ±
          showProgress(progress);
          
          try {
            const values = parseCSVLine(lines[i]);
            if (values.length < 5) { // En az 5 kolon olmalÄ± (yil, tip, sahip, diger, tutar)
              skipped++;
              kolonHatasi++;
              hatalar.push({ satir: satirNo, hata: 'Yetersiz kolon sayÄ±sÄ±', veri: lines[i].substring(0, 50) });
              continue;
            }
            
                const csvYil = values[0]?.trim() || yil;
                const tip = normalizeTurkish(values[1]?.trim() || ''); // TÃ¼rkÃ§e karakter uyumu
                const sahip = values[2]?.trim() || ''; // Sahip adÄ±nÄ± olduÄŸu gibi sakla
                const diger = values[3]?.trim() || ''; // DiÄŸer boÅŸ olabilir, sorun deÄŸil
                const tutar = parseTutar(values[4]?.trim() || '0');
                const referans = values[5]?.trim() || ''; // Referans = hangi personele ait olduÄŸu
                
                // Personel bilgisini belirle:
                // - EÄŸer referans = "DiÄŸer" ise, yÃ¶netici bilgisini kullan (CSV'yi yÃ¼kleyen kiÅŸi)
                // - DeÄŸilse, referans deÄŸerini personel adÄ± olarak kullan
                let personelAd = '';
                let personelUid = null;
                
                if (!referans || normalizeTurkish(referans) === 'diÄŸer') {
                  // "DiÄŸer" referansÄ± iÃ§in yÃ¶netici bilgisini kullan
                  personelAd = normalizePersonelName(yoneticiAd);
                  personelUid = yoneticiUid;
                } else {
                  // Referans deÄŸerini personel adÄ± olarak kullan (normalize et)
                  personelAd = normalizePersonelName(referans);
                  personelUid = null; // Sistemde kayÄ±tlÄ± deÄŸil, sadece isim olarak sakla
                }
            
            // Validasyon - Sahip ve DiÄŸer aynÄ± olabilir, sorun deÄŸil
            // DiÄŸer boÅŸ olabilir, sorun deÄŸil
            if (!tip || !sahip || !tutar || tutar <= 0) {
              skipped++;
              validasyonHatasi++;
              hatalar.push({ 
                satir: satirNo, 
                hata: 'Validasyon hatasÄ± (tip, sahip veya tutar eksik/geÃ§ersiz)', 
                veri: `Tip: ${tip || 'boÅŸ'}, Sahip: ${sahip || 'boÅŸ'}, Tutar: ${tutar || '0'}` 
              });
              continue;
            }
            
            // Sahip ve DiÄŸer aynÄ±ysa veya DiÄŸer boÅŸsa - normal durum, devam et
            // Tip kontrolÃ¼ (TÃ¼rkÃ§e karakter uyumlu: I->Ä±, Ä°->i)
            if (!['iftar', 'sahur', 'taahhut', 'teberru'].includes(tip)) {
              skipped++;
              tipHatasi++;
              hatalar.push({ 
                satir: satirNo, 
                hata: `GeÃ§ersiz tip: "${tip}" (iftar, sahur, taahhut, teberru olmalÄ±)`, 
                veri: `Tip: ${tip}` 
              });
              continue;
            }
            
            // Firestore'a kaydet - Her kayÄ±t benzersiz doc() ID ile kaydedilir
            // AynÄ± veri kombinasyonu birden fazla kez kaydedilebilir (Ã¶r: 10 x 5000â‚º = 50.000â‚º)
            const analizRef = db.collection('ramazan_serif').doc('analiz').collection('veriler');
            const data = {
              yil: parseInt(csvYil) || parseInt(yil),
              tip: tip, // Normalize edilmiÅŸ tip (Ä±-Ä° uyumlu)
              sahip: sahip.trim(), // Trim edilmiÅŸ sahip adÄ±
              diger: (diger || '').trim(), // Trim edilmiÅŸ diÄŸer alanÄ± (ara kiÅŸi)
              tutar: tutar,
              referans: (referans || '').trim(), // Trim edilmiÅŸ referans = baÄŸÄ±ÅŸÄ± alan kiÅŸi (bilgi amaÃ§lÄ±)
              personel: personelAd, // Normalize edilmiÅŸ personel adÄ± (referans = "DiÄŸer" ise yÃ¶netici, deÄŸilse referans deÄŸeri)
              personelUid: personelUid, // Personel UID (sadece "DiÄŸer" referanslarÄ± iÃ§in yÃ¶netici UID'si)
              yukleyen: normalizePersonelName(yoneticiAd), // Normalize edilmiÅŸ yÃ¼kleyen adÄ±
              yukleyenUid: yoneticiUid, // CSV'yi yÃ¼kleyen kiÅŸinin UID'si
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // Her kayÄ±t benzersiz doc() ID ile kaydedilir
            // AynÄ± veri kombinasyonu birden fazla kez kaydedilebilir
            // Ã–rnek: "2024-Ä°ftar-Ahmet Åen-Mehmet Ak-5000-Muhsin Ã‡elik" 10 kez varsa
            // 10 ayrÄ± kayÄ±t olarak kaydedilir ve toplam 50.000â‚º olarak hesaplanÄ±r
            
            batch.set(analizRef.doc(), data); // Benzersiz document ID ile kaydet
            imported++;
            batchCount++;
            
            // Batch limit kontrolÃ¼ (Firestore limit 500) - her 400 kayÄ±tta bir commit
            if (batchCount >= 400) {
              try {
                await batch.commit();
                batch = db.batch(); // Yeni batch oluÅŸtur
                batchCount = 0;
                showToast('Bilgi', `${imported} kayÄ±t iÅŸlendi, kaydediliyor...`, 'info', 1500);
              } catch (batchError) {
                digerHatalar++;
                hatalar.push({ 
                  satir: `Batch ${Math.floor(i / 400) + 1}`, 
                  hata: 'Batch commit hatasÄ±', 
                  veri: batchError.message 
                });
                console.error('Batch commit hatasÄ±:', batchError);
              }
            }
          } catch (rowError) {
            skipped++;
            digerHatalar++;
            hatalar.push({ 
              satir: satirNo, 
              hata: 'SatÄ±r iÅŸleme hatasÄ±', 
              veri: rowError.message 
            });
            console.error(`SatÄ±r ${satirNo} hatasÄ±:`, rowError);
          }
        }
        
        showProgress(95);
        showToast('Bilgi', 'Son kayÄ±tlar kaydediliyor...', 'info', 1500);
        
        // Kalan kayÄ±tlarÄ± kaydet
        if (batchCount > 0) {
          try {
            await batch.commit();
          } catch (finalBatchError) {
            digerHatalar++;
            hatalar.push({ 
              satir: 'Final batch', 
              hata: 'Final batch commit hatasÄ±', 
              veri: finalBatchError.message 
            });
            console.error('Final batch commit hatasÄ±:', finalBatchError);
          }
        }
        
        showProgress(100);
        
        // SonuÃ§ bildirimi
        setTimeout(() => {
          showProgress(0);
          
          if (imported > 0) {
            let hataMesaji = '';
            if (skipped > 0) {
              hataMesaji = `\n\nâš ï¸ ${skipped} kayÄ±t atlandÄ±:\n`;
                  if (kolonHatasi > 0) hataMesaji += `â€¢ ${kolonHatasi} kolon hatasÄ±\n`;
                  if (validasyonHatasi > 0) hataMesaji += `â€¢ ${validasyonHatasi} validasyon hatasÄ±\n`;
                  if (tipHatasi > 0) hataMesaji += `â€¢ ${tipHatasi} tip hatasÄ±\n`;
                  if (digerHatalar > 0) hataMesaji += `â€¢ ${digerHatalar} diÄŸer hata\n`;
              
              if (hatalar.length > 0 && hatalar.length <= 10) {
                hataMesaji += '\nğŸ“‹ Ä°lk 10 hata detayÄ±:\n';
                hatalar.slice(0, 10).forEach((h, idx) => {
                  hataMesaji += `${idx + 1}. SatÄ±r ${h.satir}: ${h.hata}\n`;
                });
              } else if (hatalar.length > 10) {
                hataMesaji += `\nğŸ“‹ Toplam ${hatalar.length} hata var (ilk 10 gÃ¶steriliyor)\n`;
                hatalar.slice(0, 10).forEach((h, idx) => {
                  hataMesaji += `${idx + 1}. SatÄ±r ${h.satir}: ${h.hata}\n`;
                });
              }
            }
            
            showToast(
              'BaÅŸarÄ±lÄ±! âœ…', 
              `${imported} kayÄ±t baÅŸarÄ±yla yÃ¼klendi!${hataMesaji}`,
              'success',
              8000
            );
          } else {
            showToast(
              'UyarÄ± âš ï¸',
              `HiÃ§bir kayÄ±t yÃ¼klenemedi! ${skipped} kayÄ±t atlandÄ±. Hata detaylarÄ±nÄ± kontrol edin.`,
              'warning',
              6000
            );
          }
          
          submitBtn.disabled = false;
          submitBtn.textContent = originalBtnText;
          
          // HatalarÄ± konsola yazdÄ±r (geliÅŸtirici iÃ§in)
          if (hatalar.length > 0) {
            console.group('ğŸ“‹ CSV YÃ¼kleme Hata DetaylarÄ±');
            hatalar.forEach(h => {
              console.warn(`SatÄ±r ${h.satir}:`, h.hata, h.veri);
            });
            console.groupEnd();
          }
          
          closeVeriYukleModal();
          
          // Analiz verilerini yeniden yÃ¼kle
          loadAnalizVerileri().then(() => {
            loadAnalizDashboard();
          });
        }, 500);
        
      } catch (e) {
        showProgress(0);
        console.error('Veri yÃ¼kleme hatasÄ±:', e);
        showToast(
          'Kritik Hata âŒ',
          `Veri yÃ¼klenirken hata oluÅŸtu: ${e.message}\n\nLÃ¼tfen dosya formatÄ±nÄ± kontrol edin.`,
          'error',
          8000
        );
        submitBtn.disabled = false;
        submitBtn.textContent = originalBtnText;
      }
        });
      }
    }, 200);
    
    // Analiz verilerini yÃ¼kle (3 yÄ±l)
    async function loadAnalizVerileri() {
      // EÄŸer zaten yÃ¼kleniyorsa, mevcut yÃ¼kleme tamamlanana kadar bekle
      if (analizVerileriYukleniyor) {
        console.log('Analiz verileri zaten yÃ¼kleniyor, bekleniyor...');
        // Mevcut yÃ¼kleme tamamlanana kadar bekle (max 10 saniye)
        let beklemeSayaci = 0;
        while (analizVerileriYukleniyor && beklemeSayaci < 100) {
          await new Promise(resolve => setTimeout(resolve, 100));
          beklemeSayaci++;
        }
        if (beklemeSayaci >= 100) {
          console.warn('Analiz verileri yÃ¼kleme timeout!');
        }
        return; // Mevcut yÃ¼kleme tamamlandÄ±, tekrar yÃ¼kleme
      }
      
      // YÃ¼kleme baÅŸladÄ±
      analizVerileriYukleniyor = true;
      
      try {
        const yillar = [2023, 2024, 2025];
        // Ã–nce mevcut verileri tamamen temizle
        analizVerileri = {};
        
        for (const yil of yillar) {
          try {
            const snap = await db.collection('ramazan_serif').doc('analiz').collection('veriler')
              .where('yil', '==', yil)
              .get();
            
            if (!analizVerileri[yil]) analizVerileri[yil] = {};
            
            // Document ID bazlÄ± duplicate kontrolÃ¼ (aynÄ± document birden fazla kez eklenmesin)
            const loadedDocIds = new Set();
            
            // TÃœM kayÄ±tlarÄ± yÃ¼kle - duplicate filtreleme YOK (iÃ§erik bazlÄ±)
            // AynÄ± veri kombinasyonu birden fazla kez kaydedilebilir
            // Her kayÄ±t ayrÄ± ayrÄ± sayÄ±lÄ±r ve toplanÄ±r
            snap.docs.forEach(doc => {
              try {
                // AynÄ± document ID'yi birden fazla kez yÃ¼kleme
                if (loadedDocIds.has(doc.id)) {
                  console.warn(`DokÃ¼man ${doc.id} zaten yÃ¼klendi, atlanÄ±yor.`);
                  return;
                }
                loadedDocIds.add(doc.id);
                
                const data = doc.data();
                if (!data) {
                  console.warn(`DokÃ¼man ${doc.id} verisi boÅŸ, atlanÄ±yor.`);
                  return;
                }
                
                const tip = data.tip || 'diÄŸer';
                const sahip = data.sahip || 'Bilinmeyen';
                
                if (!analizVerileri[yil][tip]) analizVerileri[yil][tip] = {};
                if (!analizVerileri[yil][tip][sahip]) {
                  analizVerileri[yil][tip][sahip] = [];
                }
                
                // AynÄ± document ID'yi bu sahip iÃ§in de kontrol et (ek gÃ¼venlik)
                const mevcutKayit = analizVerileri[yil][tip][sahip].find(v => v.id === doc.id);
                if (mevcutKayit) {
                  console.warn(`DokÃ¼man ${doc.id} zaten ${sahip} iÃ§in yÃ¼klÃ¼, atlanÄ±yor.`);
                  return;
                }
                
                // Her kayÄ±t ayrÄ± ayrÄ± eklenir (duplicate kontrolÃ¼ yok - iÃ§erik bazlÄ±)
                // Personel bilgisini normalize et (eÅŸleÅŸtirme iÃ§in)
                const rawPersonel = data.personel || data.referans || '';
                const normalizedPersonel = normalizePersonelName(rawPersonel);
                
                // TutarÄ± sayÄ±ya Ã§evir (gÃ¼venlik iÃ§in)
                const tutar = Number(data.tutar) || 0;
                
                analizVerileri[yil][tip][sahip].push({
                  id: doc.id, // Benzersiz document ID
                  diger: data.diger || '',
                  tutar: tutar, // SayÄ± olarak sakla
                  referans: data.referans || '',
                  personel: normalizedPersonel, // Normalize edilmiÅŸ personel bilgisi
                  createdAt: data.createdAt
                });
              } catch (docError) {
                // Tek bir dokÃ¼manda hata varsa atla, diÄŸerlerini yÃ¼kle
                console.warn(`YÄ±l ${yil} - DokÃ¼man ${doc.id} yÃ¼klenemedi:`, docError);
              }
            });
          } catch (yilError) {
            // Bir yÄ±lÄ±n verileri yÃ¼klenemezse diÄŸer yÄ±llarÄ± yÃ¼klemeye devam et
            console.warn(`YÄ±l ${yil} verileri yÃ¼klenemedi:`, yilError);
            if (!analizVerileri[yil]) analizVerileri[yil] = {};
          }
        }
      } catch (e) {
        console.error('Analiz verileri yÃ¼klenirken genel hata:', e);
        // Hata olsa bile boÅŸ veri yapÄ±sÄ± dÃ¶ndÃ¼r
        if (!analizVerileri || Object.keys(analizVerileri).length === 0) {
          analizVerileri = { 2023: {}, 2024: {}, 2025: {} };
        }
      } finally {
        // YÃ¼kleme tamamlandÄ±
        analizVerileriYukleniyor = false;
      }
    }
    
    // Genel Ã¶zet dashboard yÃ¼kle
    function loadAnalizDashboard() {
      const secilenYil = qs('#analizYil').value;
      const container = qs('#analizDashboard');
      if (!container) return;
      
      // TÃ¼m yÄ±llar iÃ§in Ã¶zet hesapla
      const yillar = [2023, 2024, 2025];
      const tipler = ['iftar', 'sahur', 'taahhut', 'teberru'];
      
      let summary = {};
      
      // Ã–nce tÃ¼m yÄ±llar iÃ§in summary objelerini baÅŸlat
      yillar.forEach(yil => {
        if (!analizVerileri[yil]) analizVerileri[yil] = {};
        summary[yil] = { toplamTutar: 0, toplamKayit: 0, kisiSayisi: 0 };
      });
      
      // Her yÄ±l iÃ§in verileri hesapla
      yillar.forEach(yil => {
        if (!analizVerileri[yil]) return;
        if (!summary[yil]) summary[yil] = { toplamTutar: 0, toplamKayit: 0, kisiSayisi: 0 };
        
        const uniqueKisiler = new Set(); // Benzersiz kiÅŸiler iÃ§in
        
        tipler.forEach(tip => {
          if (!analizVerileri[yil][tip]) analizVerileri[yil][tip] = {};
          const kisiler = Object.keys(analizVerileri[yil][tip]);
          let tipTutar = 0;
          let tipKayit = 0;
          
          kisiler.forEach(kisi => {
            const veriler = analizVerileri[yil][tip][kisi];
            if (!veriler || !Array.isArray(veriler)) return; // GÃ¼venlik kontrolÃ¼
            veriler.forEach(v => {
              const tutar = Number(v.tutar) || 0;
              tipTutar += tutar;
              tipKayit++;
            });
            // Benzersiz kiÅŸileri topla
            uniqueKisiler.add(kisi);
          });
          
          if (!summary[yil][tip]) summary[yil][tip] = {};
          summary[yil][tip] = { tutar: tipTutar, kayit: tipKayit, kisi: kisiler.length };
          summary[yil].toplamTutar += tipTutar;
          summary[yil].toplamKayit += tipKayit;
        });
        
        // KiÅŸi sayÄ±sÄ±nÄ± doÄŸru hesapla (tÃ¼m tiplerdeki benzersiz kiÅŸiler)
        summary[yil].kisiSayisi = uniqueKisiler.size;
      });
      
      // HTML oluÅŸtur
      let html = `
        <div class="stats-grid">
          ${yillar.map(yil => `
            <div class="stat-card">
              <div class="stat-label">${yil} Toplam</div>
              <div class="stat-value">â‚º${summary[yil].toplamTutar.toLocaleString('tr-TR', {minimumFractionDigits:2})}</div>
              <div style="font-size:12px;color:var(--muted)">${summary[yil].toplamKayit} kayÄ±t, ${summary[yil].kisiSayisi} kiÅŸi</div>
            </div>
          `).join('')}
        </div>
        
        <div class="card" style="margin-top:16px">
          <h4 style="margin:0 0 12px 0">YÄ±llÄ±k KarÅŸÄ±laÅŸtÄ±rma</h4>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>YÄ±l</th>
                  <th>Ä°ftar</th>
                  <th>Sahur</th>
                  <th>TaahhÃ¼t</th>
                  <th>Teberru</th>
                  <th>Toplam</th>
                  <th>KiÅŸi SayÄ±sÄ±</th>
                </tr>
              </thead>
              <tbody>
                ${yillar.map(yil => {
                  const trend = yil > 2023 ? calculateTrend(summary[yil - 1].toplamTutar, summary[yil].toplamTutar) : '';
                  return `
                    <tr>
                      <td><strong>${yil}</strong></td>
                      <td>â‚º${summary[yil].iftar?.tutar.toLocaleString('tr-TR', {minimumFractionDigits:2}) || '0,00'}</td>
                      <td>â‚º${summary[yil].sahur?.tutar.toLocaleString('tr-TR', {minimumFractionDigits:2}) || '0,00'}</td>
                      <td>â‚º${summary[yil].taahhut?.tutar.toLocaleString('tr-TR', {minimumFractionDigits:2}) || '0,00'}</td>
                      <td>â‚º${summary[yil].teberru?.tutar.toLocaleString('tr-TR', {minimumFractionDigits:2}) || '0,00'}</td>
                      <td><strong>â‚º${summary[yil].toplamTutar.toLocaleString('tr-TR', {minimumFractionDigits:2})}</strong> ${trend}</td>
                      <td>${summary[yil].kisiSayisi}</td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
      
      container.innerHTML = html;
    }
    
    // Trend hesapla
    function calculateTrend(onceki, simdi) {
      if (!onceki || onceki === 0) return '';
      const degisim = ((simdi - onceki) / onceki) * 100;
      if (degisim > 0) return `<span class="trend-up">â†‘ ${degisim.toFixed(1)}%</span>`;
      if (degisim < 0) return `<span class="trend-down">â†“ ${Math.abs(degisim).toFixed(1)}%</span>`;
      return '<span class="trend-same">â†’ 0%</span>';
    }
    
    window.loadAnalizDashboard = loadAnalizDashboard;
    
    // KiÅŸi bazlÄ± analiz yÃ¼kle
    function loadKisiAnalizi() {
      const arama = qs('#kisiAra').value.trim();
      const tipFiltre = qs('#kisiFiltreTip').value;
      const container = qs('#kisiAnalizList');
      if (!container) return;
      
      // TÃ¼m kiÅŸileri topla
      let kisiler = {};
      const yillar = [2023, 2024, 2025];
      const tipler = ['iftar', 'sahur', 'taahhut', 'teberru'];
      
      yillar.forEach(yil => {
        if (!analizVerileri[yil]) return;
        tipler.forEach(tip => {
          if (tipFiltre && tip !== tipFiltre) return;
          if (!analizVerileri[yil][tip]) return;
          
          Object.keys(analizVerileri[yil][tip]).forEach(kisiAdi => {
            // TÃ¼rkÃ§e karakter uyumlu arama
            if (arama && !turkishIncludes(kisiAdi, arama)) return;
            
            if (!kisiler[kisiAdi]) {
              kisiler[kisiAdi] = { toplamTutar: 0, veriler: {}, kategori: '' };
            }
            
            const veriler = analizVerileri[yil][tip][kisiAdi];
            let tipTutar = 0;
            veriler.forEach(v => {
              tipTutar += v.tutar || 0;
            });
            
            if (!kisiler[kisiAdi].veriler[yil]) kisiler[kisiAdi].veriler[yil] = {};
            kisiler[kisiAdi].veriler[yil][tip] = { tutar: tipTutar, kayit: veriler.length };
            kisiler[kisiAdi].toplamTutar += tipTutar;
          });
        });
      });
      
      // KiÅŸileri kategorize et
      const kisilerList = Object.keys(kisiler).map(kisiAdi => {
        const kisi = kisiler[kisiAdi];
        const yillarList = Object.keys(kisi.veriler);
        let kategori = 'yeni';
        
        if (yillarList.length === 3) {
          // 3 yÄ±lda da var
          const sonYil = Math.max(...yillarList.map(Number));
          if (kisi.veriler[sonYil]) {
            kategori = 'daimi';
          }
        } else if (yillarList.length === 1) {
          kategori = 'yeni';
        } else if (yillarList.length === 2) {
          const enSonYil = Math.max(...yillarList.map(Number));
          if (kisi.veriler[enSonYil]) {
            kategori = 'daimi';
          } else {
            kategori = 'pasif';
          }
        }
        
        return { ...kisi, adi: kisiAdi, kategori };
      });
      
      // Toplam tutara gÃ¶re sÄ±rala
      kisilerList.sort((a, b) => b.toplamTutar - a.toplamTutar);
      
      // HTML oluÅŸtur
      if (kisilerList.length === 0) {
        container.innerHTML = '<p style="text-align:center;color:var(--muted);padding:20px">KayÄ±t bulunamadÄ±.</p>';
        return;
      }
      
      let html = `
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>KiÅŸi</th>
                <th>2023</th>
                <th>2024</th>
                <th>2025</th>
                <th>Toplam</th>
                <th>Kategori</th>
                <th style="width:120px">Ä°ÅŸlemler</th>
              </tr>
            </thead>
            <tbody>
              ${kisilerList.slice(0, 50).map(kisi => {
                const yil2023 = kisi.veriler['2023'] ? 
                  Object.values(kisi.veriler['2023']).reduce((sum, v) => sum + v.tutar, 0) : 0;
                const yil2024 = kisi.veriler['2024'] ? 
                  Object.values(kisi.veriler['2024']).reduce((sum, v) => sum + v.tutar, 0) : 0;
                const yil2025 = kisi.veriler['2025'] ? 
                  Object.values(kisi.veriler['2025']).reduce((sum, v) => sum + v.tutar, 0) : 0;
                
                const kategoriBadge = kisi.kategori === 'daimi' ? 
                  '<span class="badge-daimi">Daimi BaÄŸÄ±ÅŸÃ§Ä±</span>' :
                  kisi.kategori === 'yeni' ?
                  '<span class="badge-yeni">Yeni BaÄŸÄ±ÅŸÃ§Ä±</span>' :
                  '<span class="badge-pasif">Pasif OlmuÅŸ</span>';
                
                return `
                  <tr>
                    <td><strong>${kisi.adi}</strong></td>
                    <td>${yil2023 > 0 ? 'â‚º' + yil2023.toLocaleString('tr-TR', {minimumFractionDigits:2}) : '-'}</td>
                    <td>${yil2024 > 0 ? 'â‚º' + yil2024.toLocaleString('tr-TR', {minimumFractionDigits:2}) : '-'}</td>
                    <td>${yil2025 > 0 ? 'â‚º' + yil2025.toLocaleString('tr-TR', {minimumFractionDigits:2}) : '-'}</td>
                    <td><strong>â‚º${kisi.toplamTutar.toLocaleString('tr-TR', {minimumFractionDigits:2})}</strong></td>
                    <td>${kategoriBadge}</td>
                    <td><button onclick="openKisiDetay('${kisi.adi.replace(/'/g, "\\'")}')" style="padding:4px 8px;font-size:12px">Detay</button></td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      `;
      
      container.innerHTML = html;
    }
    
    window.loadKisiAnalizi = loadKisiAnalizi;
    
    // Personel/Referans BazlÄ± DetaylÄ± Analiz
    function loadPersonelAnalizi() {
      const arama = normalizeTurkish(qs('#personelAra')?.value || '');
      const filtreYil = qs('#personelFiltreYil')?.value || '';
      const filtreTip = normalizeTurkish(qs('#personelFiltreTip')?.value || '');
      const container = qs('#personelAnalizList');
      
      if (!container) return;
      
      container.innerHTML = '<p style="text-align:center;color:var(--muted);padding:20px">YÃ¼kleniyor...</p>';
      
      // Personel/Referans bazlÄ± verileri topla
      const personeller = {}; // { personelAdi: { yillar: { 2023: {...}, 2024: {...}, 2025: {...} } } }
      const yillar = [2023, 2024, 2025];
      const tipler = ['iftar', 'sahur', 'taahhut', 'teberru'];
      
      yillar.forEach(yil => {
        if (filtreYil && String(yil) !== filtreYil) return; // YÄ±l filtresi
        if (!analizVerileri[yil]) return;
        
        tipler.forEach(tip => {
          if (filtreTip && tip !== filtreTip) return; // Tip filtresi
          if (!analizVerileri[yil][tip]) return;
          
          // Her sahip (baÄŸÄ±ÅŸ yapan kiÅŸi) iÃ§in personel/referans bilgisini al
          Object.keys(analizVerileri[yil][tip]).forEach(sahip => {
            const veriler = analizVerileri[yil][tip][sahip];
              veriler.forEach(v => {
              // Personel adÄ±nÄ± normalize et (eÅŸleÅŸtirme iÃ§in)
              // EÄŸer referans "DÄ°ÄER" ise, personel adÄ± olarak "DÄ°ÄER" gÃ¶ster
              let rawPersonelAdi = v.personel || v.referans || 'Bilinmeyen';
              // Referans "DÄ°ÄER" ise ve personel adÄ± yÃ¶netici adÄ± ise, "DÄ°ÄER" olarak gÃ¶ster
              if (v.referans && normalizeTurkish(v.referans) === 'diÄŸer') {
                rawPersonelAdi = 'DÄ°ÄER';
              }
              const personelAdi = normalizePersonelName(rawPersonelAdi);
              
              // Arama filtresi (normalize edilmiÅŸ deÄŸerlerle)
              if (arama && !turkishIncludes(normalizeTurkish(personelAdi), arama)) return;
              
              // Normalize edilmiÅŸ personel adÄ±nÄ± key olarak kullan
              if (!personeller[personelAdi]) {
                personeller[personelAdi] = {
                  veriler: {},
                  toplamTutar: 0,
                  toplamKayit: 0
                };
              }
              
              if (!personeller[personelAdi].veriler[yil]) {
                personeller[personelAdi].veriler[yil] = {};
              }
              
              if (!personeller[personelAdi].veriler[yil][tip]) {
                personeller[personelAdi].veriler[yil][tip] = [];
              }
              
              const tutar = Number(v.tutar) || 0;
              personeller[personelAdi].veriler[yil][tip].push({
                sahip: sahip,
                diger: v.diger || '',
                tutar: tutar,
                referans: v.referans || ''
              });
              
              personeller[personelAdi].toplamTutar += tutar;
              personeller[personelAdi].toplamKayit++;
            });
          });
        });
      });
      
      // Personelleri kategorize et ve sÄ±rala
      const personellerList = Object.keys(personeller).map(personelAdi => {
        const personel = personeller[personelAdi];
        const yillarList = Object.keys(personel.veriler).map(Number);
        
        // KiÅŸi kategorisi (baÄŸÄ±ÅŸ yapan kiÅŸiler iÃ§in deÄŸil, personel iÃ§in)
        // Burada personel'in kaÃ§ yÄ±ldÄ±r Ã§alÄ±ÅŸtÄ±ÄŸÄ±na bakÄ±yoruz
        let kategori = 'yeni';
        if (yillarList.length === 3) {
          kategori = 'daimi'; // 3 yÄ±ldÄ±r var
        } else if (yillarList.length === 1 && yillarList[0] === 2025) {
          kategori = 'yeni'; // Sadece 2025'te
        } else if (yillarList.length > 0 && Math.max(...yillarList) < 2025) {
          kategori = 'pasif'; // 2025'te yok
        } else if (yillarList.length === 2) {
          kategori = 'daimi'; // 2 yÄ±ldÄ±r var
        }
        
        return { ...personel, adi: personelAdi, kategori };
      });
      
      // Toplam tutara gÃ¶re sÄ±rala
      personellerList.sort((a, b) => b.toplamTutar - a.toplamTutar);
      
      // HTML oluÅŸtur
      if (personellerList.length === 0) {
        container.innerHTML = '<p style="text-align:center;color:var(--muted);padding:20px">KayÄ±t bulunamadÄ±.</p>';
        return;
      }
      
      let html = `
        <div style="margin-bottom:16px;padding:12px;background:#f0f7ff;border-left:4px solid var(--accent);border-radius:8px">
          <p style="margin:0;font-size:13px;line-height:1.6">
            <strong>ğŸ“Š Toplam:</strong> ${personellerList.length} personel/referans, 
            ${personellerList.reduce((sum, p) => sum + p.toplamKayit, 0)} kayÄ±t, 
            â‚º${personellerList.reduce((sum, p) => sum + p.toplamTutar, 0).toLocaleString('tr-TR', {minimumFractionDigits:2})}
          </p>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Personel/Referans</th>
                <th>2023</th>
                <th>2024</th>
                <th>2025</th>
                <th>Toplam</th>
                <th>KayÄ±t</th>
                <th>Kategori</th>
                <th style="width:120px">Ä°ÅŸlemler</th>
              </tr>
            </thead>
            <tbody>
              ${personellerList.map(personel => {
                const yil2023 = personel.veriler['2023'] ? 
                  Object.values(personel.veriler['2023']).flat().reduce((sum, v) => sum + (v.tutar || 0), 0) : 0;
                const yil2024 = personel.veriler['2024'] ? 
                  Object.values(personel.veriler['2024']).flat().reduce((sum, v) => sum + (v.tutar || 0), 0) : 0;
                const yil2025 = personel.veriler['2025'] ? 
                  Object.values(personel.veriler['2025']).flat().reduce((sum, v) => sum + (v.tutar || 0), 0) : 0;
                
                const kategoriBadge = personel.kategori === 'daimi' ? 
                  '<span class="badge-daimi">Daimi Personel</span>' :
                  personel.kategori === 'yeni' ?
                  '<span class="badge-yeni">Yeni Personel</span>' :
                  '<span class="badge-pasif">Pasif Personel</span>';
                
                return `
                  <tr>
                    <td><strong>${personel.adi}</strong></td>
                    <td>${yil2023 > 0 ? 'â‚º' + yil2023.toLocaleString('tr-TR', {minimumFractionDigits:2}) : '-'}</td>
                    <td>${yil2024 > 0 ? 'â‚º' + yil2024.toLocaleString('tr-TR', {minimumFractionDigits:2}) : '-'}</td>
                    <td>${yil2025 > 0 ? 'â‚º' + yil2025.toLocaleString('tr-TR', {minimumFractionDigits:2}) : '-'}</td>
                    <td><strong>â‚º${personel.toplamTutar.toLocaleString('tr-TR', {minimumFractionDigits:2})}</strong></td>
                    <td>${personel.toplamKayit}</td>
                    <td>${kategoriBadge}</td>
                    <td><button onclick="openPersonelDetay('${personel.adi.replace(/'/g, "\\'")}')" style="padding:4px 8px;font-size:12px">Detay</button></td>
                  </tr>
                `;
              }).join('')}
            </tbody>
          </table>
        </div>
      `;
      
      container.innerHTML = html;
    }
    
    window.loadPersonelAnalizi = loadPersonelAnalizi;
    
    // Personel/Referans Detay Modal
    function openPersonelDetay(personelAdi) {
      qs('#personelDetayTitle').textContent = `ğŸ‘¥ ${personelAdi} - DetaylÄ± Analiz`;
      
      // Personelin tÃ¼m verilerini topla
      let personelVerileri = [];
      const yillar = [2023, 2024, 2025];
      const tipler = ['iftar', 'sahur', 'taahhut', 'teberru'];
      const tipLabels = { iftar: 'ğŸŒ™ Ä°ftar', sahur: 'ğŸŒŸ Sahur', taahhut: 'ğŸ“‹ TaahhÃ¼t', teberru: 'ğŸ’ Teberru' };
      
      yillar.forEach(yil => {
        if (!analizVerileri[yil]) return;
        tipler.forEach(tip => {
          if (!analizVerileri[yil][tip]) return;
          
          // Her sahip iÃ§in personel/referans kontrolÃ¼
          Object.keys(analizVerileri[yil][tip]).forEach(sahip => {
            const veriler = analizVerileri[yil][tip][sahip];
            veriler.forEach(v => {
              // Personel adÄ±nÄ± normalize et ve karÅŸÄ±laÅŸtÄ±r
              // EÄŸer referans "DÄ°ÄER" ise, personel adÄ± olarak "DÄ°ÄER" gÃ¶ster
              let rawVPersonel = v.personel || v.referans || 'Bilinmeyen';
              if (v.referans && normalizeTurkish(v.referans) === 'diÄŸer') {
                rawVPersonel = 'DÄ°ÄER';
              }
              const vPersonel = normalizePersonelName(rawVPersonel);
              const normalizedPersonelAdi = normalizePersonelName(personelAdi);
              
              // Normalize edilmiÅŸ deÄŸerlerle karÅŸÄ±laÅŸtÄ±r
              if (vPersonel === normalizedPersonelAdi) {
                personelVerileri.push({
                  yil,
                  tip,
                  tipLabel: tipLabels[tip] || tip,
                  sahip: sahip,
                  diger: v.diger || '',
                  tutar: v.tutar || 0,
                  referans: v.referans || ''
                });
              }
            });
          });
        });
      });
      
      // YÄ±llara ve tiplere gÃ¶re grupla
      let yilTipOzeti = {};
      personelVerileri.forEach(v => {
        const key = `${v.yil}_${v.tip}`;
        if (!yilTipOzeti[key]) {
          yilTipOzeti[key] = {
            yil: v.yil,
            tip: v.tip,
            tipLabel: v.tipLabel,
            toplam: 0,
            kayitSayisi: 0,
            kisiler: []
          };
        }
        yilTipOzeti[key].toplam += v.tutar;
        yilTipOzeti[key].kayitSayisi++;
        if (!yilTipOzeti[key].kisiler.includes(v.sahip)) {
          yilTipOzeti[key].kisiler.push(v.sahip);
        }
      });
      
      const container = qs('#personelDetayContent');
      let html = `
        <div class="stats-grid">
          ${yillar.map(yil => {
            const yilVerileri = personelVerileri.filter(v => v.yil === yil);
            const yilToplam = yilVerileri.reduce((sum, v) => sum + v.tutar, 0);
            const trend = yil > 2023 ? 
              calculateTrend(
                personelVerileri.filter(v => v.yil === yil - 1).reduce((sum, v) => sum + v.tutar, 0),
                yilToplam
              ) : '';
            return `
              <div class="stat-card">
                <div class="stat-label">${yil} Toplam</div>
                <div class="stat-value">â‚º${yilToplam.toLocaleString('tr-TR', {minimumFractionDigits:2})}</div>
                <div style="font-size:12px">${yilVerileri.length} kayÄ±t</div>
                <div style="font-size:12px">${trend || ''}</div>
              </div>
            `;
          }).join('')}
          <div class="stat-card">
            <div class="stat-label">Genel Toplam</div>
            <div class="stat-value">â‚º${personelVerileri.reduce((sum, v) => sum + v.tutar, 0).toLocaleString('tr-TR', {minimumFractionDigits:2})}</div>
            <div style="font-size:12px">${personelVerileri.length} kayÄ±t</div>
          </div>
        </div>
        
        <div class="card" style="margin-top:16px">
          <h4 style="margin:0 0 12px 0">YÄ±l ve Tip BazlÄ± Detay</h4>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>YÄ±l</th>
                  <th>Tip</th>
                  <th>Toplam Tutar (â‚º)</th>
                  <th>KayÄ±t SayÄ±sÄ±</th>
                  <th>BaÄŸÄ±ÅŸÃ§Ä± SayÄ±sÄ±</th>
                </tr>
              </thead>
              <tbody>
                ${Object.values(yilTipOzeti).sort((a, b) => {
                  if (a.yil !== b.yil) return b.yil - a.yil;
                  return a.tip.localeCompare(b.tip);
                }).map(ozet => `
                  <tr>
                    <td><strong>${ozet.yil}</strong></td>
                    <td>${ozet.tipLabel}</td>
                    <td><strong>â‚º${ozet.toplam.toLocaleString('tr-TR', {minimumFractionDigits:2})}</strong></td>
                    <td>${ozet.kayitSayisi}</td>
                    <td>${ozet.kisiler.length}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
        
        <div class="card" style="margin-top:16px">
          <h4 style="margin:0 0 12px 0">TÃ¼m KayÄ±tlar (DetaylÄ±)</h4>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>YÄ±l</th>
                  <th>Tip</th>
                  <th>Sahip (BaÄŸÄ±ÅŸ Yapan)</th>
                  <th>DiÄŸer</th>
                  <th>Tutar (â‚º)</th>
                  <th>Referans</th>
                </tr>
              </thead>
              <tbody>
                ${personelVerileri.sort((a, b) => {
                  if (a.yil !== b.yil) return b.yil - a.yil;
                  if (a.tip !== b.tip) return a.tip.localeCompare(b.tip);
                  return b.tutar - a.tutar;
                }).map(v => `
                  <tr>
                    <td>${v.yil}</td>
                    <td>${v.tipLabel}</td>
                    <td>${v.sahip}</td>
                    <td>${v.diger || '-'}</td>
                    <td>â‚º${v.tutar.toLocaleString('tr-TR', {minimumFractionDigits:2})}</td>
                    <td>${v.referans || '-'}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
      
      container.innerHTML = html;
      qs('#modalPersonelDetay').classList.add('show');
      document.body.classList.add('modal-open');
    }
    
    window.openPersonelDetay = openPersonelDetay;
    
    function closePersonelDetay() {
      qs('#modalPersonelDetay').classList.remove('show');
      document.body.classList.remove('modal-open');
    }
    
    window.closePersonelDetay = closePersonelDetay;
    
    // KiÅŸi detay modal
    function openKisiDetay(kisiAdi) {
      qs('#kisiDetayTitle').textContent = `ğŸ‘¤ ${kisiAdi} - DetaylÄ± Analiz`;
      
      // KiÅŸinin tÃ¼m verilerini topla
      let kisiVerileri = [];
      const yillar = [2023, 2024, 2025];
      const tipler = ['iftar', 'sahur', 'taahhut', 'teberru'];
      const tipLabels = { iftar: 'ğŸŒ™ Ä°ftar', sahur: 'ğŸŒŸ Sahur', taahhut: 'ğŸ“‹ TaahhÃ¼t', teberru: 'ğŸ’ Teberru' };
      
      yillar.forEach(yil => {
        if (!analizVerileri[yil]) return;
        tipler.forEach(tip => {
          if (!analizVerileri[yil][tip] || !analizVerileri[yil][tip][kisiAdi]) return;
          
          const veriler = analizVerileri[yil][tip][kisiAdi];
          veriler.forEach(v => {
            kisiVerileri.push({
              yil,
              tip,
              tipLabel: tipLabels[tip] || tip,
              diger: v.diger || '',
              tutar: v.tutar || 0,
              referans: v.referans || ''
            });
          });
        });
      });
      
      // YÄ±llara gÃ¶re grupla
      let yilOzeti = {};
      kisiVerileri.forEach(v => {
        if (!yilOzeti[v.yil]) yilOzeti[v.yil] = { toplam: 0, tipler: {} };
        yilOzeti[v.yil].toplam += v.tutar;
        if (!yilOzeti[v.yil].tipler[v.tip]) yilOzeti[v.yil].tipler[v.tip] = 0;
        yilOzeti[v.yil].tipler[v.tip] += v.tutar;
      });
      
      const container = qs('#kisiDetayContent');
      let html = `
        <div class="stats-grid">
          ${yillar.map(yil => {
            const ozet = yilOzeti[yil] || { toplam: 0, tipler: {} };
            const trend = yil > 2023 && yilOzeti[yil - 1] ? 
              calculateTrend(yilOzeti[yil - 1].toplam, ozet.toplam) : '';
            return `
              <div class="stat-card">
                <div class="stat-label">${yil} Toplam</div>
                <div class="stat-value">â‚º${ozet.toplam.toLocaleString('tr-TR', {minimumFractionDigits:2})}</div>
                <div style="font-size:12px">${trend || ''}</div>
              </div>
            `;
          }).join('')}
        </div>
        
        <div class="card" style="margin-top:16px">
          <h4 style="margin:0 0 12px 0">YÄ±llÄ±k Detay</h4>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>YÄ±l</th>
                  <th>Tip</th>
                  <th>DiÄŸer</th>
                  <th>Tutar (â‚º)</th>
                  <th>Referans</th>
                </tr>
              </thead>
              <tbody>
                ${kisiVerileri.sort((a, b) => {
                  if (a.yil !== b.yil) return b.yil - a.yil;
                  return b.tutar - a.tutar;
                }).map(v => `
                  <tr>
                    <td><strong>${v.yil}</strong></td>
                    <td>${v.tipLabel}</td>
                    <td>${v.diger || '-'}</td>
                    <td><strong>â‚º${v.tutar.toLocaleString('tr-TR', {minimumFractionDigits:2})}</strong></td>
                    <td>${v.referans || '-'}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
      
      container.innerHTML = html;
      qs('#modalKisiDetay').classList.add('show');
      document.body.classList.add('modal-open');
    }
    
    function closeKisiDetayModal() {
      qs('#modalKisiDetay').classList.remove('show');
      document.body.classList.remove('modal-open');
    }
    
    window.openKisiDetay = openKisiDetay;
    window.closeKisiDetayModal = closeKisiDetayModal;
    
    // Trend analizi yÃ¼kle
    function loadTrendAnaliz() {
      const container = qs('#trendAnaliz');
      if (!container) return;
      
      const yillar = [2023, 2024, 2025];
      const tipler = ['iftar', 'sahur', 'taahhut', 'teberru'];
      const tipLabels = { iftar: 'ğŸŒ™ Ä°ftar', sahur: 'ğŸŒŸ Sahur', taahhut: 'ğŸ“‹ TaahhÃ¼t', teberru: 'ğŸ’ Teberru' };
      
      let html = '<div class="card"><h4 style="margin:0 0 12px 0">Tip BazlÄ± Trend Analizi</h4>';
      
      tipler.forEach(tip => {
        let tipVeriler = [];
        yillar.forEach(yil => {
          if (!analizVerileri[yil] || !analizVerileri[yil][tip]) {
            tipVeriler.push({ yil, tutar: 0, kayit: 0, kisi: 0 });
            return;
          }
          
          const kisiler = Object.keys(analizVerileri[yil][tip]);
          let tutar = 0;
          let kayit = 0;
          
          kisiler.forEach(kisi => {
            const veriler = analizVerileri[yil][tip][kisi];
            veriler.forEach(v => {
              tutar += v.tutar || 0;
              kayit++;
            });
          });
          
          tipVeriler.push({ yil, tutar, kayit, kisi: kisiler.length });
        });
        
        const maxTutar = Math.max(...tipVeriler.map(v => v.tutar));
        
        html += `
          <div style="margin-bottom:20px;padding:12px;background:#f8f9fa;border-radius:8px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <strong>${tipLabels[tip] || tip}</strong>
              <span style="font-size:12px;color:var(--muted)">
                Toplam: â‚º${tipVeriler.reduce((sum, v) => sum + v.tutar, 0).toLocaleString('tr-TR', {minimumFractionDigits:2})}
              </span>
            </div>
            ${yillar.map(yil => {
              const veri = tipVeriler.find(v => v.yil === yil);
              const trend = yil > 2023 ? calculateTrend(
                tipVeriler.find(v => v.yil === yil - 1)?.tutar || 0,
                veri.tutar
              ) : '';
              const yuzde = maxTutar > 0 ? (veri.tutar / maxTutar) * 100 : 0;
              
              return `
                <div style="margin-bottom:8px">
                  <div style="display:flex;justify-content:space-between;margin-bottom:4px">
                    <span style="font-size:13px"><strong>${yil}:</strong> â‚º${veri.tutar.toLocaleString('tr-TR', {minimumFractionDigits:2})}</span>
                    <span style="font-size:12px">${veri.kayit} kayÄ±t, ${veri.kisi} kiÅŸi ${trend}</span>
                  </div>
                  <div class="progress-bar">
                    <div class="progress-fill" style="width:${yuzde}%"></div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        `;
      });
      
      html += '</div>';
      container.innerHTML = html;
    }
    
    window.loadTrendAnaliz = loadTrendAnaliz;
    
    // Kategori analizi yÃ¼kle
    function loadKategoriAnaliz() {
      const container = qs('#kategoriAnaliz');
      if (!container) return;
      
      // TÃ¼m kiÅŸileri kategorize et
      let kisiler = {};
      const yillar = [2023, 2024, 2025];
      const tipler = ['iftar', 'sahur', 'taahhut', 'teberru'];
      
      yillar.forEach(yil => {
        if (!analizVerileri[yil]) return;
        tipler.forEach(tip => {
          if (!analizVerileri[yil][tip]) return;
          Object.keys(analizVerileri[yil][tip]).forEach(kisiAdi => {
            if (!kisiler[kisiAdi]) {
              kisiler[kisiAdi] = { veriler: {} };
            }
            if (!kisiler[kisiAdi].veriler[yil]) {
              kisiler[kisiAdi].veriler[yil] = [];
            }
            kisiler[kisiAdi].veriler[yil].push(...analizVerileri[yil][tip][kisiAdi]);
          });
        });
      });
      
      let daimi = [];
      let yeni = [];
      let pasif = [];
      
      Object.keys(kisiler).forEach(kisiAdi => {
        const kisi = kisiler[kisiAdi];
        const yillarList = Object.keys(kisi.veriler).map(Number);
        const toplamTutar = Object.values(kisi.veriler).flat().reduce((sum, v) => sum + (v.tutar || 0), 0);
        
        if (yillarList.length === 3) {
          // 3 yÄ±lda da var - daimi
          daimi.push({ adi: kisiAdi, toplamTutar, yillar: yillarList });
        } else if (yillarList.length === 1 && yillarList[0] === 2025) {
          // Sadece 2025'te var - yeni
          yeni.push({ adi: kisiAdi, toplamTutar, yillar: yillarList });
        } else if (yillarList.length > 0 && Math.max(...yillarList) < 2025) {
          // 2025'te yok - pasif
          pasif.push({ adi: kisiAdi, toplamTutar, yillar: yillarList });
        } else {
          yeni.push({ adi: kisiAdi, toplamTutar, yillar: yillarList });
        }
      });
      
      // Toplam tutara gÃ¶re sÄ±rala
      daimi.sort((a, b) => b.toplamTutar - a.toplamTutar);
      yeni.sort((a, b) => b.toplamTutar - a.toplamTutar);
      pasif.sort((a, b) => b.toplamTutar - a.toplamTutar);
      
      let html = `
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Daimi BaÄŸÄ±ÅŸÃ§Ä±</div>
            <div class="stat-value">${daimi.length}</div>
            <div style="font-size:12px;color:var(--muted)">
              â‚º${daimi.reduce((sum, k) => sum + k.toplamTutar, 0).toLocaleString('tr-TR', {minimumFractionDigits:2})}
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Yeni BaÄŸÄ±ÅŸÃ§Ä±</div>
            <div class="stat-value">${yeni.length}</div>
            <div style="font-size:12px;color:var(--muted)">
              â‚º${yeni.reduce((sum, k) => sum + k.toplamTutar, 0).toLocaleString('tr-TR', {minimumFractionDigits:2})}
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Pasif OlmuÅŸ</div>
            <div class="stat-value">${pasif.length}</div>
            <div style="font-size:12px;color:var(--muted)">
              â‚º${pasif.reduce((sum, k) => sum + k.toplamTutar, 0).toLocaleString('tr-TR', {minimumFractionDigits:2})}
            </div>
          </div>
        </div>
        
        <div class="card" style="margin-top:16px">
          <h4 style="margin:0 0 12px 0">Daimi BaÄŸÄ±ÅŸÃ§Ä±lar (Top ${daimi.length})</h4>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>KiÅŸi</th>
                  <th>2023</th>
                  <th>2024</th>
                  <th>2025</th>
                  <th>Toplam</th>
                  <th style="width:120px">Ä°ÅŸlemler</th>
                </tr>
              </thead>
              <tbody>
                ${daimi.slice(0, 20).map(k => {
                  const yil2023 = k.yillar.includes(2023) ? 'âœ“' : '-';
                  const yil2024 = k.yillar.includes(2024) ? 'âœ“' : '-';
                  const yil2025 = k.yillar.includes(2025) ? 'âœ“' : '-';
                  return `
                    <tr>
                      <td><strong>${k.adi}</strong></td>
                      <td>${yil2023}</td>
                      <td>${yil2024}</td>
                      <td>${yil2025}</td>
                      <td><strong>â‚º${k.toplamTutar.toLocaleString('tr-TR', {minimumFractionDigits:2})}</strong></td>
                      <td><button onclick="openKisiDetay('${k.adi.replace(/'/g, "\\'")}')" style="padding:4px 8px;font-size:12px">Detay</button></td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        </div>
        
        <div class="card" style="margin-top:16px">
          <h4 style="margin:0 0 12px 0">Yeni BaÄŸÄ±ÅŸÃ§Ä±lar (Top ${yeni.length})</h4>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>KiÅŸi</th>
                  <th>Ä°lk YÄ±l</th>
                  <th>Toplam</th>
                  <th style="width:120px">Ä°ÅŸlemler</th>
                </tr>
              </thead>
              <tbody>
                ${yeni.slice(0, 20).map(k => {
                  const ilkYil = Math.min(...k.yillar);
                  return `
                    <tr>
                      <td><strong>${k.adi}</strong></td>
                      <td>${ilkYil}</td>
                      <td><strong>â‚º${k.toplamTutar.toLocaleString('tr-TR', {minimumFractionDigits:2})}</strong></td>
                      <td><button onclick="openKisiDetay('${k.adi.replace(/'/g, "\\'")}')" style="padding:4px 8px;font-size:12px">Detay</button></td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        </div>
        
        <div class="card" style="margin-top:16px">
          <h4 style="margin:0 0 12px 0">Pasif OlmuÅŸ BaÄŸÄ±ÅŸÃ§Ä±lar (Top ${pasif.length})</h4>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>KiÅŸi</th>
                  <th>Son YÄ±l</th>
                  <th>Toplam</th>
                  <th style="width:120px">Ä°ÅŸlemler</th>
                </tr>
              </thead>
              <tbody>
                ${pasif.slice(0, 20).map(k => {
                  const sonYil = Math.max(...k.yillar);
                  return `
                    <tr>
                      <td><strong>${k.adi}</strong></td>
                      <td>${sonYil}</td>
                      <td><strong>â‚º${k.toplamTutar.toLocaleString('tr-TR', {minimumFractionDigits:2})}</strong></td>
                      <td><button onclick="openKisiDetay('${k.adi.replace(/'/g, "\\'")}')" style="padding:4px 8px;font-size:12px">Detay</button></td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;
      
      container.innerHTML = html;
    }
    
    window.loadKategoriAnaliz = loadKategoriAnaliz;
    
    // Veri DÃ¼zenleme FonksiyonlarÄ± - SÄ±ralama durumu
    let veriDuzenlemeSiralama = {
      column: 'createdAt',
      direction: 'desc'
    };
    
    function loadVeriDuzenleme() {
      const yil = qs('#duzenleYil')?.value || '2025';
      const tip = normalizeTurkish(qs('#duzenleTip')?.value || '');
      const arama = qs('#duzenleAra')?.value?.trim() || '';
      const container = qs('#veriDuzenlemeList');
      
      if (!container) return;
      
      container.innerHTML = '<p style="text-align:center;color:var(--muted);padding:20px">YÃ¼kleniyor...</p>';
      
      // Firestore'dan verileri Ã§ek (index gerektirmemek iÃ§in orderBy'i kaldÄ±rdÄ±k, client-side sÄ±ralama yapacaÄŸÄ±z)
      const analizRef = db.collection('ramazan_serif').doc('analiz').collection('veriler');
      let query = analizRef.where('yil', '==', parseInt(yil));
      
      query.get().then(snapshot => {
        let veriler = [];
        
        snapshot.forEach(doc => {
          const data = doc.data();
          const docTip = normalizeTurkish(data.tip || '');
          
          // Tip filtresi
          if (tip && docTip !== tip) return;
          
          // Arama filtresi (sahip, personel, referans)
          if (arama) {
            const searchText = normalizeTurkish(arama);
            const sahipText = normalizeTurkish(data.sahip || '');
            const personelText = normalizeTurkish(data.personel || '');
            const referansText = normalizeTurkish(data.referans || '');
            
            if (!sahipText.includes(searchText) && 
                !personelText.includes(searchText) && 
                !referansText.includes(searchText)) {
              return;
            }
          }
          
          veriler.push({
            id: doc.id,
            yil: data.yil || 2025,
            tip: data.tip || '',
            sahip: data.sahip || '',
            diger: data.diger || '',
            tutar: data.tutar || 0,
            referans: data.referans || '',
            personel: data.personel || '',
            createdAt: data.createdAt ? (data.createdAt.toDate ? data.createdAt.toDate() : new Date(data.createdAt)) : new Date()
          });
        });
        
        // Client-side sÄ±ralama (sÄ±ralama durumuna gÃ¶re)
        veriler.sort((a, b) => {
          let aVal, bVal;
          
          switch (veriDuzenlemeSiralama.column) {
            case 'tip':
              aVal = (a.tip || '').toLowerCase();
              bVal = (b.tip || '').toLowerCase();
              break;
            case 'sahip':
              aVal = (a.sahip || '').toLowerCase();
              bVal = (b.sahip || '').toLowerCase();
              break;
            case 'diger':
              aVal = (a.diger || '').toLowerCase();
              bVal = (b.diger || '').toLowerCase();
              break;
            case 'tutar':
              aVal = a.tutar || 0;
              bVal = b.tutar || 0;
              break;
            case 'personel':
              aVal = (a.personel || a.referans || '').toLowerCase();
              bVal = (b.personel || b.referans || '').toLowerCase();
              break;
            case 'createdAt':
            default:
              aVal = a.createdAt instanceof Date ? a.createdAt.getTime() : (a.createdAt ? new Date(a.createdAt).getTime() : 0);
              bVal = b.createdAt instanceof Date ? b.createdAt.getTime() : (b.createdAt ? new Date(b.createdAt).getTime() : 0);
              break;
          }
          
          if (typeof aVal === 'string') {
            return veriDuzenlemeSiralama.direction === 'asc' 
              ? aVal.localeCompare(bVal, 'tr')
              : bVal.localeCompare(aVal, 'tr');
          } else {
            return veriDuzenlemeSiralama.direction === 'asc' 
              ? aVal - bVal
              : bVal - aVal;
          }
        });
        
        // HTML oluÅŸtur
        if (veriler.length === 0) {
          container.innerHTML = '<p style="text-align:center;color:var(--muted);padding:20px">KayÄ±t bulunamadÄ±.</p>';
          return;
        }
        
        const tipLabels = { 
          iftar: 'ğŸŒ™ Ä°ftar', 
          sahur: 'ğŸŒŸ Sahur', 
          taahhut: 'ğŸ“‹ TaahhÃ¼t', 
          teberru: 'ğŸ’ Teberru' 
        };
        
        let html = `
          <div style="margin-bottom:16px;padding:12px;background:#f0f7ff;border-left:4px solid var(--accent);border-radius:8px">
            <p style="margin:0;font-size:13px;line-height:1.6">
              <strong>ğŸ“Š Toplam:</strong> ${veriler.length} kayÄ±t
            </p>
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th style="width:80px">ID</th>
                  <th class="sortable" data-column="tip" style="cursor:pointer;user-select:none">
                    Tip ${veriDuzenlemeSiralama.column === 'tip' ? (veriDuzenlemeSiralama.direction === 'asc' ? 'â†‘' : 'â†“') : ''}
                  </th>
                  <th class="sortable" data-column="sahip" style="cursor:pointer;user-select:none">
                    Sahip ${veriDuzenlemeSiralama.column === 'sahip' ? (veriDuzenlemeSiralama.direction === 'asc' ? 'â†‘' : 'â†“') : ''}
                  </th>
                  <th class="sortable" data-column="diger" style="cursor:pointer;user-select:none">
                    DiÄŸer ${veriDuzenlemeSiralama.column === 'diger' ? (veriDuzenlemeSiralama.direction === 'asc' ? 'â†‘' : 'â†“') : ''}
                  </th>
                  <th class="sortable" data-column="tutar" style="cursor:pointer;user-select:none">
                    Tutar (â‚º) ${veriDuzenlemeSiralama.column === 'tutar' ? (veriDuzenlemeSiralama.direction === 'asc' ? 'â†‘' : 'â†“') : ''}
                  </th>
                  <th class="sortable" data-column="personel" style="cursor:pointer;user-select:none">
                    Personel/Referans ${veriDuzenlemeSiralama.column === 'personel' ? (veriDuzenlemeSiralama.direction === 'asc' ? 'â†‘' : 'â†“') : ''}
                  </th>
                  <th style="width:120px">Ä°ÅŸlemler</th>
                </tr>
              </thead>
              <tbody>
                ${veriler.map(v => {
                  const tipLabel = tipLabels[v.tip] || v.tip;
                  const shortId = v.id.substring(0, 8);
                  return `
                    <tr>
                      <td style="font-size:11px;color:var(--muted)">${shortId}...</td>
                      <td>${tipLabel}</td>
                      <td><strong>${v.sahip}</strong></td>
                      <td>${v.diger || '-'}</td>
                      <td>â‚º${v.tutar.toLocaleString('tr-TR', {minimumFractionDigits:2})}</td>
                      <td>${(v.referans && normalizeTurkish(v.referans) === 'diÄŸer') ? 'DÄ°ÄER' : (v.personel || v.referans || '-')}</td>
                      <td>
                        <button onclick="openVeriDuzenlemeModal('${v.id}')" style="padding:4px 8px;font-size:12px">DÃ¼zenle</button>
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
        `;
        
        container.innerHTML = html;
      }).catch(error => {
        console.error('Veri dÃ¼zenleme yÃ¼kleme hatasÄ±:', error);
        container.innerHTML = '<p style="text-align:center;color:var(--danger);padding:20px">Veri yÃ¼klenirken hata oluÅŸtu.</p>';
      });
    }
    
    window.loadVeriDuzenleme = loadVeriDuzenleme;
    
    // Veri dÃ¼zenleme modalÄ±nÄ± aÃ§
    function openVeriDuzenlemeModal(docId) {
      if (!docId) {
        // Yeni kayÄ±t
        qs('#veriDuzenlemeTitle').textContent = 'âœï¸ Yeni Veri Ekle';
        qs('#formVeriDuzenleme').reset();
        qs('#duzenleId').value = '';
        qs('#btnDeleteVeri').style.display = 'none';
        qs('#duzenleYilInput').value = qs('#duzenleYil')?.value || '2025';
        qs('#modalVeriDuzenleme').classList.add('show');
        document.body.classList.add('modal-open');
        return;
      }
      
      // Mevcut kaydÄ± yÃ¼kle
      const analizRef = db.collection('ramazan_serif').doc('analiz').collection('veriler');
      analizRef.doc(docId).get().then(doc => {
        if (!doc.exists) {
          showToast('KayÄ±t bulunamadÄ±.', '', 'error');
          return;
        }
        
        const data = doc.data();
        qs('#veriDuzenlemeTitle').textContent = 'âœï¸ Veri DÃ¼zenleme';
        qs('#duzenleId').value = docId;
        qs('#duzenleYilInput').value = String(data.yil || 2025);
        qs('#duzenleTipInput').value = data.tip || 'iftar';
        qs('#duzenleSahip').value = data.sahip || '';
        qs('#duzenleDiger').value = data.diger || '';
        // TutarÄ± TÃ¼rkÃ§e formatÄ±nda gÃ¶ster (nokta yerine virgÃ¼l, binlik ayÄ±rÄ±cÄ±)
        const tutar = data.tutar || 0;
        qs('#duzenleTutar').value = tutar.toLocaleString('tr-TR', {minimumFractionDigits:2, maximumFractionDigits:2}).replace(/\./g, '|TEMP|').replace(/,/g, '.').replace(/\|TEMP\|/g, ',');
        qs('#duzenleReferans').value = data.referans || '';
        qs('#btnDeleteVeri').style.display = 'inline-block';
        qs('#btnDeleteVeri').setAttribute('data-doc-id', docId);
        
        qs('#modalVeriDuzenleme').classList.add('show');
        document.body.classList.add('modal-open');
      }).catch(error => {
        console.error('Veri yÃ¼kleme hatasÄ±:', error);
        showToast('Veri yÃ¼klenirken hata oluÅŸtu.', '', 'error');
      });
    }
    
    window.openVeriDuzenlemeModal = openVeriDuzenlemeModal;
    
    // Veri dÃ¼zenleme modalÄ±nÄ± kapat
    function closeVeriDuzenlemeModal() {
      qs('#modalVeriDuzenleme').classList.remove('show');
      document.body.classList.remove('modal-open');
      qs('#formVeriDuzenleme').reset();
      qs('#duzenleId').value = '';
      qs('#btnDeleteVeri').style.display = 'none';
    }
    
    window.closeVeriDuzenlemeModal = closeVeriDuzenlemeModal;
    
    // Veri kaydet (gÃ¼ncelle veya ekle)
    const formVeriDuzenleme = qs('#formVeriDuzenleme');
    if (formVeriDuzenleme) {
      formVeriDuzenleme.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const docId = qs('#duzenleId').value;
        const yil = parseInt(qs('#duzenleYilInput').value);
        const tip = qs('#duzenleTipInput').value;
        const sahip = qs('#duzenleSahip').value.trim();
        const diger = qs('#duzenleDiger').value.trim();
        const tutar = parseTutar(qs('#duzenleTutar').value || '0');
        const referans = qs('#duzenleReferans').value.trim();
        
        // Validasyon
        if (!sahip || !tip || !tutar || tutar <= 0) {
          showToast('LÃ¼tfen tÃ¼m zorunlu alanlarÄ± doldurun.', '', 'error');
          return;
        }
        
        // YÃ¶netici bilgisi
        const user = auth.currentUser;
        if (!user) {
          showToast('Oturum aÃ§Ä±k deÄŸil.', '', 'error');
          return;
        }
        
        const yoneticiDoc = await db.collection('kullanicilar').doc(user.uid).get();
        const yoneticiData = yoneticiDoc.exists ? yoneticiDoc.data() : {};
        const yoneticiAd = yoneticiData.ad || yoneticiData.isim || user.email || 'Bilinmeyen';
        const yoneticiUid = user.uid;
        
        // Personel bilgisini belirle
        let personelAd = '';
        let personelUid = null;
        
        if (!referans || normalizeTurkish(referans) === 'diÄŸer') {
          personelAd = normalizePersonelName(yoneticiAd);
          personelUid = yoneticiUid;
        } else {
          personelAd = normalizePersonelName(referans);
          personelUid = null;
        }
        
        const analizRef = db.collection('ramazan_serif').doc('analiz').collection('veriler');
        const data = {
          yil: yil,
          tip: tip,
          sahip: sahip,
          diger: diger || '',
          tutar: tutar,
          referans: referans || '',
          personel: personelAd,
          personelUid: personelUid,
          yukleyen: normalizePersonelName(yoneticiAd),
          yukleyenUid: yoneticiUid,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        if (docId) {
          // GÃ¼ncelle
          data.createdAt = (await analizRef.doc(docId).get()).data()?.createdAt || firebase.firestore.FieldValue.serverTimestamp();
          await analizRef.doc(docId).update(data);
          showToast('Veri gÃ¼ncellendi.', '', 'success');
        } else {
          // Yeni kayÄ±t
          data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
          await analizRef.add(data);
          showToast('Veri eklendi.', '', 'success');
        }
        
        // Analiz verilerini yenile ve listeyi gÃ¼ncelle (sayfa yenilenmeden)
        try {
          if (typeof loadAnalizVerileri === 'function') {
            await loadAnalizVerileri();
          }
          // Dashboard ve analizleri yenile
          if (typeof loadAnalizDashboard === 'function') loadAnalizDashboard();
          if (typeof loadTrendAnaliz === 'function') loadTrendAnaliz();
          if (typeof loadKategoriAnaliz === 'function') loadKategoriAnaliz();
          if (typeof loadKisiAnalizi === 'function') loadKisiAnalizi();
          if (typeof loadPersonelAnalizi === 'function') loadPersonelAnalizi();
          // Veri dÃ¼zenleme listesini yenile
          loadVeriDuzenleme();
          closeVeriDuzenlemeModal();
        } catch (error) {
          console.error('Veri yenileme hatasÄ±:', error);
          showToast('Veri gÃ¼ncellendi ancak listeler yenilenirken hata oluÅŸtu.', '', 'warning');
          closeVeriDuzenlemeModal();
          loadVeriDuzenleme();
        }
      });
    }
    
    // Veri sil
    async function deleteVeriKayit() {
      const docId = qs('#duzenleId').value || qs('#btnDeleteVeri')?.getAttribute('data-doc-id');
      
      if (!docId) {
        showToast('Silinecek kayÄ±t bulunamadÄ±.', '', 'error');
        return;
      }
      
      if (!confirm('Bu kaydÄ± silmek istediÄŸinizden emin misiniz?')) {
        return;
      }
      
      try {
        const analizRef = db.collection('ramazan_serif').doc('analiz').collection('veriler');
        await analizRef.doc(docId).delete();
        showToast('Veri silindi.', '', 'success');
        
        // Analiz verilerini yenile ve listeyi gÃ¼ncelle (sayfa yenilenmeden)
        if (typeof loadAnalizVerileri === 'function') {
          await loadAnalizVerileri();
        }
        // Dashboard ve analizleri yenile
        if (typeof loadAnalizDashboard === 'function') loadAnalizDashboard();
        if (typeof loadTrendAnaliz === 'function') loadTrendAnaliz();
        if (typeof loadKategoriAnaliz === 'function') loadKategoriAnaliz();
        if (typeof loadKisiAnalizi === 'function') loadKisiAnalizi();
        if (typeof loadPersonelAnalizi === 'function') loadPersonelAnalizi();
        // Veri dÃ¼zenleme listesini yenile
        loadVeriDuzenleme();
        closeVeriDuzenlemeModal();
      } catch (error) {
        console.error('Silme hatasÄ±:', error);
        showToast('Veri silinirken hata oluÅŸtu.', '', 'error');
      }
    }
    
    window.deleteVeriKayit = deleteVeriKayit;
    
    // Event listeners - Veri dÃ¼zenleme
    setTimeout(() => {
      const duzenleYil = qs('#duzenleYil');
      const duzenleTip = qs('#duzenleTip');
      const duzenleAra = qs('#duzenleAra');
      
      if (duzenleYil) {
        duzenleYil.addEventListener('change', () => {
          if (typeof loadVeriDuzenleme === 'function') loadVeriDuzenleme();
        });
      }
      if (duzenleTip) {
        duzenleTip.addEventListener('change', () => {
          if (typeof loadVeriDuzenleme === 'function') loadVeriDuzenleme();
        });
      }
      if (duzenleAra) {
        let searchTimeout;
        duzenleAra.addEventListener('input', () => {
          clearTimeout(searchTimeout);
          searchTimeout = setTimeout(() => {
            if (typeof loadVeriDuzenleme === 'function') loadVeriDuzenleme();
          }, 500);
        });
      }
    }, 500);
    
    // Tab deÄŸiÅŸtiÄŸinde analiz verilerini yÃ¼kle
    if (qs('#analizYil')) {
      qs('#analizYil').addEventListener('change', () => {
        loadAnalizDashboard();
      });
    }
    
    // Event listeners - Personel analizi
    setTimeout(() => {
      const personelAra = qs('#personelAra');
      const personelFiltreYil = qs('#personelFiltreYil');
      const personelFiltreTip = qs('#personelFiltreTip');
      if (personelAra) {
        personelAra.addEventListener('input', () => {
          if (typeof loadPersonelAnalizi === 'function') loadPersonelAnalizi();
        });
      }
      if (personelFiltreYil) {
        personelFiltreYil.addEventListener('change', () => {
          if (typeof loadPersonelAnalizi === 'function') loadPersonelAnalizi();
        });
      }
      if (personelFiltreTip) {
        personelFiltreTip.addEventListener('change', () => {
          if (typeof loadPersonelAnalizi === 'function') loadPersonelAnalizi();
        });
      }
      
      // KiÅŸi analizi event listeners
      const kisiAra = qs('#kisiAra');
      const kisiFiltreTip = qs('#kisiFiltreTip');
      if (kisiAra) {
        kisiAra.addEventListener('input', () => {
          if (typeof loadKisiAnalizi === 'function') loadKisiAnalizi();
        });
      }
      if (kisiFiltreTip) {
        kisiFiltreTip.addEventListener('change', () => {
          if (typeof loadKisiAnalizi === 'function') loadKisiAnalizi();
        });
      }
    }, 500);
    
    // Ä°lk yÃ¼kleme - analiz verilerini yÃ¼kle
    setTimeout(async () => {
      await loadAnalizVerileri();
      loadAnalizDashboard();
      loadTrendAnaliz();
      loadKategoriAnaliz();
      if (typeof loadPersonelAnalizi === 'function') loadPersonelAnalizi();
    }, 500);
    
    // ===== HEDEF TANIMLAMA SÄ°STEMÄ° =====
    
    // Hedef verilerini yÃ¼kle ve gÃ¶ster
    async function loadHedefTanÄ±mlama() {
      // Ã–nce analiz verilerinin yÃ¼klendiÄŸinden emin ol
      if (!analizVerileri || Object.keys(analizVerileri).length === 0) {
        await loadAnalizVerileri();
      }
      
      // 2025 gerÃ§ekleÅŸen toplamlarÄ± hesapla
      const yil2025 = analizVerileri[2025] || {};
      const tipler = ['iftar', 'sahur', 'taahhut', 'teberru'];
      const tipLabels = { iftar: 'ğŸŒ™ Ä°ftar', sahur: 'ğŸŒŸ Sahur', taahhut: 'ğŸ“‹ TaahhÃ¼t', teberru: 'ğŸ’ Teberru' };
      
      let toplam2025 = 0;
      let tipBazlÄ±2025 = {};
      
      tipler.forEach(tip => {
        if (!yil2025[tip]) yil2025[tip] = {};
        const kisiler = Object.keys(yil2025[tip]);
        let tipToplam = 0;
        
        kisiler.forEach(kisi => {
          const veriler = yil2025[tip][kisi];
          if (!veriler || !Array.isArray(veriler)) return;
          veriler.forEach(v => {
            tipToplam += Number(v.tutar) || 0;
          });
        });
        
        tipBazlÄ±2025[tip] = tipToplam;
        toplam2025 += tipToplam;
      });
      
      // 2025 gerÃ§ekleÅŸen toplamÄ± gÃ¶ster
      qs('#hedef2025Toplam').textContent = `â‚º${toplam2025.toLocaleString('tr-TR', {minimumFractionDigits:2})}`;
      
      // 2025 detayÄ±nÄ± gÃ¶ster
      const detayHtml = tipler.map(tip => {
        const tutar = tipBazlÄ±2025[tip] || 0;
        return `${tipLabels[tip]}: â‚º${tutar.toLocaleString('tr-TR', {minimumFractionDigits:2})}`;
      }).join(' | ');
      qs('#hedef2025Detay').textContent = detayHtml;
      
      // Firestore'dan mevcut hedefleri yÃ¼kle
      try {
        const hedefDoc = await db.collection('ramazan_serif').doc('ayarlar').collection('hedefler').doc('2026').get();
        if (hedefDoc.exists) {
          const hedefData = hedefDoc.data();
          
          // Genel hedef
          if (hedefData.genelHedef) {
            qs('#hedef2026Genel').value = hedefData.genelHedef.toLocaleString('tr-TR', {minimumFractionDigits:2, maximumFractionDigits:2}).replace(/\./g, '|TEMP|').replace(/,/g, '.').replace(/\|TEMP\|/g, ',');
            // ArtÄ±ÅŸ yÃ¼zdesini hesapla
            if (toplam2025 > 0) {
              const artisYuzde = ((hedefData.genelHedef - toplam2025) / toplam2025) * 100;
              qs('#hedef2026ArtisYuzde').value = `%${artisYuzde.toFixed(2)}`;
            }
          }
        }
      } catch (e) {
        console.error('Hedef verileri yÃ¼klenemedi:', e);
      }
      
      // Genel hedef input'u deÄŸiÅŸtiÄŸinde otomatik artÄ±ÅŸ hesapla ve formatla
      const hedef2026GenelInput = qs('#hedef2026Genel');
      if (hedef2026GenelInput) {
        // Ã–nceki listener'larÄ± kaldÄ±r
        const newInput = hedef2026GenelInput.cloneNode(true);
        hedef2026GenelInput.parentNode.replaceChild(newInput, hedef2026GenelInput);
        
        // Format desteÄŸi: Input'ta sadece temizle, formatlamayÄ± blur'da yap
        newInput.addEventListener('input', (e) => {
          let value = e.target.value;
          // Sadece rakam, nokta ve virgÃ¼l bÄ±rak
          value = value.replace(/[^\d.,]/g, '');
          e.target.value = value;
          
          // ArtÄ±ÅŸ hesapla (parse ederek)
          hesaplaGenelArtis();
        });
        
        // Blur'da format kontrolÃ¼ (gÃ¶rsel olarak)
        newInput.addEventListener('blur', (e) => {
          const parsed = parseTutar(e.target.value || '0');
          if (parsed > 0) {
            // TÃ¼rkÃ§e format: binlik ayÄ±rÄ±cÄ± nokta, kÃ¼sÃ¼rat virgÃ¼l
            const formatted = parsed.toLocaleString('tr-TR', {minimumFractionDigits:2, maximumFractionDigits:2});
            e.target.value = formatted;
          } else if (e.target.value && e.target.value.trim() !== '' && e.target.value !== '0') {
            // GeÃ§ersiz format, temizle
            e.target.value = '';
            showToast('UyarÄ±', 'GeÃ§ersiz tutar formatÄ±! LÃ¼tfen 100.000,50 formatÄ±nda girin.', 'warning', 3000);
          }
        });
      }
      
      // Tip bazlÄ± hedefleri gÃ¶ster
      renderTipBazlÄ±Hedefler(tipBazlÄ±2025, toplam2025);
      
      // Personel bazlÄ± hedefleri gÃ¶ster
      await renderPersonelBazlÄ±Hedefler();
    }
    
    // Genel hedef deÄŸiÅŸtiÄŸinde artÄ±ÅŸ yÃ¼zdesini hesapla ve personel hedeflerini gÃ¼ncelle
    function hesaplaGenelArtis() {
      const hedef2026GenelInput = qs('#hedef2026Genel');
      if (!hedef2026GenelInput) return;
      
      const hedef2025ToplamText = qs('#hedef2025Toplam').textContent;
      const toplam2025 = parseTutar(hedef2025ToplamText.replace(/â‚º/g, '').trim());
      const hedef2026Genel = parseTutar(hedef2026GenelInput.value || '0');
      
      if (toplam2025 > 0 && hedef2026Genel > 0) {
        const artisYuzde = ((hedef2026Genel - toplam2025) / toplam2025) * 100;
        qs('#hedef2026ArtisYuzde').value = `%${artisYuzde.toFixed(2)}`;
        
        // Tip bazlÄ± hedefleri gÃ¼ncelle
        const tipBazlÄ±2025 = {};
        const tipler = ['iftar', 'sahur', 'taahhut', 'teberru'];
        const yil2025 = analizVerileri[2025] || {};
        
        tipler.forEach(tip => {
          if (!yil2025[tip]) yil2025[tip] = {};
          const kisiler = Object.keys(yil2025[tip]);
          let tipToplam = 0;
          
          kisiler.forEach(kisi => {
            const veriler = yil2025[tip][kisi];
            if (!veriler || !Array.isArray(veriler)) return;
            veriler.forEach(v => {
              tipToplam += Number(v.tutar) || 0;
            });
          });
          
          tipBazlÄ±2025[tip] = tipToplam;
        });
        
        renderTipBazlÄ±Hedefler(tipBazlÄ±2025, toplam2025);
        
        // Personel bazlÄ± hedefleri otomatik gÃ¼ncelle
        guncellePersonelHedefleri(hedef2026Genel, toplam2025);
      } else {
        qs('#hedef2026ArtisYuzde').value = '%0,00';
      }
      
      // Toplam satÄ±rÄ±nÄ± gÃ¼ncelle
      setTimeout(() => guncelleHedefToplamlari(), 100);
    }
    
    // Personel bazlÄ± hedefleri genel hedefe gÃ¶re otomatik gÃ¼ncelle
    function guncellePersonelHedefleri(hedef2026Genel, toplam2025) {
      if (!hedef2026Genel || !toplam2025 || toplam2025 <= 0) return;
      
      const tbody = qs('#hedefPersonelBody');
      if (!tbody) return;
      
      const rows = tbody.querySelectorAll('tr');
      const tipler = ['iftar', 'sahur', 'taahhut', 'teberru'];
      
      // Genel artÄ±ÅŸ oranÄ±nÄ± hesapla
      const genelArtisOrani = hedef2026Genel / toplam2025;
      
      rows.forEach(row => {
        const personelAdi = row.querySelector('.hedef-personel-toplam')?.getAttribute('data-personel');
        if (!personelAdi) return;
        
        // 2025 verilerini al (analiz verilerinden)
        const yil2025 = analizVerileri[2025] || {};
        let yil2025Toplam = 0;
        const tip2025 = {};
        
        tipler.forEach(tip => {
          if (!yil2025[tip]) yil2025[tip] = {};
          let tipToplam = 0;
          
          Object.keys(yil2025[tip]).forEach(sahip => {
            const veriler = yil2025[tip][sahip];
            if (!veriler || !Array.isArray(veriler)) return; // GÃ¼venlik kontrolÃ¼
            veriler.forEach(v => {
              let rawPersonelAdi = v.personel || v.referans || 'Bilinmeyen';
              if (v.referans && normalizeTurkish(v.referans) === 'diÄŸer') {
                rawPersonelAdi = 'DÄ°ÄER';
              }
              const vPersonelAdi = normalizePersonelName(rawPersonelAdi);
              
              if (vPersonelAdi === personelAdi) {
                const tutar = Number(v.tutar) || 0;
                tipToplam += tutar;
                yil2025Toplam += tutar;
              }
            });
          });
          
          tip2025[tip] = tipToplam;
        });
        
        if (yil2025Toplam <= 0) return; // 2025'te veri yoksa gÃ¼ncelleme
        
        // Yeni toplam hedefi hesapla
        const yeniToplamHedef = yil2025Toplam * genelArtisOrani;
        
        // Toplam input'unu gÃ¼ncelle
        const toplamInput = row.querySelector('.hedef-personel-toplam');
        if (toplamInput) {
          toplamInput.value = yeniToplamHedef.toLocaleString('tr-TR', {minimumFractionDigits:2, maximumFractionDigits:2});
        }
        
        // Tip bazlÄ± hedefleri gÃ¼ncelle
        tipler.forEach(tip => {
          const tip2025Tutar = tip2025[tip] || 0;
          const yeniTipHedef = tip2025Tutar * genelArtisOrani;
          
          // Tip input'unu gÃ¼ncelle
          const tipInput = row.querySelector(`.hedef-personel-tip[data-tip="${tip}"]`);
          if (tipInput) {
            tipInput.value = yeniTipHedef.toLocaleString('tr-TR', {minimumFractionDigits:2, maximumFractionDigits:2});
          }
        });
        
        // ArtÄ±ÅŸ yÃ¼zdesini gÃ¼ncelle
        const artisYuzde = yil2025Toplam > 0 ? ((yeniToplamHedef - yil2025Toplam) / yil2025Toplam) * 100 : 0;
        const artisCell = row.cells[9];
        if (artisCell) {
          artisCell.innerHTML = `<span class="${artisYuzde >= 0 ? 'trend-up' : 'trend-down'}">%${artisYuzde.toFixed(2)}</span>`;
        }
      });
      
      // Toplam satÄ±rÄ±nÄ± gÃ¼ncelle
      setTimeout(() => guncelleHedefToplamlari(), 100);
    }
    
    // Tip bazlÄ± hedefleri render et
    function renderTipBazlÄ±Hedefler(tipBazlÄ±2025, toplam2025) {
      const tbody = qs('#hedefTipBazlÄ±Body');
      if (!tbody) return;
      
      const tipler = ['iftar', 'sahur', 'taahhut', 'teberru'];
      const tipLabels = { iftar: 'ğŸŒ™ Ä°ftar', sahur: 'ğŸŒŸ Sahur', taahhut: 'ğŸ“‹ TaahhÃ¼t', teberru: 'ğŸ’ Teberru' };
      const hedef2026GenelInput = qs('#hedef2026Genel');
      const hedef2026Genel = parseTutar(hedef2026GenelInput ? hedef2026GenelInput.value || '0' : '0');
      
      tbody.innerHTML = '';
      
      tipler.forEach(tip => {
        const gerceklesen2025 = tipBazlÄ±2025[tip] || 0;
        let hedef2026 = 0;
        let artisYuzde = 0;
        let artisTutar = 0;
        
        if (toplam2025 > 0 && hedef2026Genel > 0) {
          // AynÄ± oranda artÄ±ÅŸ
          const oran = gerceklesen2025 / toplam2025;
          hedef2026 = hedef2026Genel * oran;
          artisTutar = hedef2026 - gerceklesen2025;
          artisYuzde = gerceklesen2025 > 0 ? ((hedef2026 - gerceklesen2025) / gerceklesen2025) * 100 : 0;
        }
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><strong>${tipLabels[tip]}</strong></td>
          <td>â‚º${gerceklesen2025.toLocaleString('tr-TR', {minimumFractionDigits:2})}</td>
          <td><strong style="color:var(--accent)">â‚º${hedef2026.toLocaleString('tr-TR', {minimumFractionDigits:2})}</strong></td>
          <td><span class="${artisYuzde >= 0 ? 'trend-up' : 'trend-down'}">%${artisYuzde.toFixed(2)}</span></td>
          <td><span class="${artisTutar >= 0 ? 'trend-up' : 'trend-down'}">â‚º${artisTutar.toLocaleString('tr-TR', {minimumFractionDigits:2})}</span></td>
        `;
        tbody.appendChild(tr);
      });
    }
    
    // Personel bazlÄ± hedefleri render et
    async function renderPersonelBazlÄ±Hedefler() {
      const tbody = qs('#hedefPersonelBody');
      if (!tbody) return;
      
      tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;padding:20px">YÃ¼kleniyor...</td></tr>';
      
      // Sabit personel listesi (2026 iÃ§in)
      const sabitPersonelListesi = [
        'MUHSÄ°N Ã‡ELÄ°K',
        'SERHAN DURAK',
        'FARUK NAFÄ°Z Ã–ZGAN',
        'KEREM KOCAOÄLU',
        'MAHMUT SOLMAZ',
        'SAMET Ã‡AKIR',
        'MEHMET TAHA KESKÄ°N',
        'Ä°BRAHÄ°M AY',
        'AHMETALÄ° EMRE ÅAHÄ°N'
      ];
      
      // TÃ¼m personelleri topla (DÄ°ÄER dahil - toplam hesaplamalarÄ± iÃ§in)
      const personeller = {};
      const yillar = [2023, 2024, 2025];
      const tipler = ['iftar', 'sahur', 'taahhut', 'teberru'];
      
      yillar.forEach(yil => {
        if (!analizVerileri[yil]) return;
        
        tipler.forEach(tip => {
          if (!analizVerileri[yil][tip]) return;
          
          Object.keys(analizVerileri[yil][tip]).forEach(sahip => {
            const veriler = analizVerileri[yil][tip][sahip];
            if (!veriler || !Array.isArray(veriler)) return; // GÃ¼venlik kontrolÃ¼
            veriler.forEach(v => {
              let rawPersonelAdi = v.personel || v.referans || 'Bilinmeyen';
              if (v.referans && normalizeTurkish(v.referans) === 'diÄŸer') {
                rawPersonelAdi = 'DÄ°ÄER';
              }
              const personelAdi = normalizePersonelName(rawPersonelAdi);
              
              if (!personeller[personelAdi]) {
                personeller[personelAdi] = {
                  veriler: {},
                  toplamTutar: 0
                };
              }
              
              if (!personeller[personelAdi].veriler[yil]) {
                personeller[personelAdi].veriler[yil] = {};
              }
              
              if (!personeller[personelAdi].veriler[yil][tip]) {
                personeller[personelAdi].veriler[yil][tip] = [];
              }
              
              const tutar = Number(v.tutar) || 0;
              personeller[personelAdi].veriler[yil][tip].push({
                sahip: sahip,
                tutar: tutar
              });
              
              personeller[personelAdi].toplamTutar += tutar;
            });
          });
        });
      });
      
      // Firestore'dan mevcut hedefleri yÃ¼kle
      let mevcutHedefler = {};
      try {
        const hedefDoc = await db.collection('ramazan_serif').doc('ayarlar').collection('hedefler').doc('2026').get();
        if (hedefDoc.exists) {
          mevcutHedefler = hedefDoc.data().personelHedefleri || {};
        }
      } catch (e) {
        console.error('Hedef verileri yÃ¼klenemedi:', e);
      }
      
      // Genel hedef ve toplam 2025'i al
      const hedef2026GenelInput = qs('#hedef2026Genel');
      const hedef2026Genel = parseTutar(hedef2026GenelInput ? hedef2026GenelInput.value || '0' : '0');
      const hedef2025ToplamText = qs('#hedef2025Toplam').textContent;
      const toplam2025 = parseTutar(hedef2025ToplamText.replace(/â‚º/g, '').trim());
      const genelArtisOrani = toplam2025 > 0 && hedef2026Genel > 0 ? hedef2026Genel / toplam2025 : 1.2; // VarsayÄ±lan %20 artÄ±ÅŸ
      
      tbody.innerHTML = '';
      
      // Sabit personel listesini kullan (DÄ°ÄER hariÃ§)
      sabitPersonelListesi.forEach(personelAdi => {
        const personel = personeller[personelAdi] || { veriler: {}, toplamTutar: 0 };
        const adi = personel.adi;
        
        // 2023-2024-2025 verilerini hesapla
        const yil2023 = personel.veriler[2023] ? 
          Object.values(personel.veriler[2023]).flat().reduce((sum, v) => sum + (v.tutar || 0), 0) : 0;
        const yil2024 = personel.veriler[2024] ? 
          Object.values(personel.veriler[2024]).flat().reduce((sum, v) => sum + (v.tutar || 0), 0) : 0;
        const yil2025 = personel.veriler[2025] ? 
          Object.values(personel.veriler[2025]).flat().reduce((sum, v) => sum + (v.tutar || 0), 0) : 0;
        
        // Tip bazlÄ± 2025 verileri
        const tip2025 = {};
        tipler.forEach(tip => {
          if (personel.veriler[2025] && personel.veriler[2025][tip]) {
            tip2025[tip] = personel.veriler[2025][tip].reduce((sum, v) => sum + (v.tutar || 0), 0);
          } else {
            tip2025[tip] = 0;
          }
        });
        
        // Mevcut hedef veya otomatik hesaplanan hedef
        const mevcutHedef = mevcutHedefler[personelAdi] || {};
        let hedef2026Toplam = mevcutHedef.toplam || 0;
        
        // Otomatik hesaplama: Genel hedefe gÃ¶re orantÄ±lÄ± artÄ±ÅŸ
        if (!mevcutHedef.toplam && yil2025 > 0 && toplam2025 > 0) {
          hedef2026Toplam = yil2025 * genelArtisOrani;
        } else if (!mevcutHedef.toplam && yil2025 > 0) {
          // Genel hedef yoksa varsayÄ±lan %20 artÄ±ÅŸ
          hedef2026Toplam = yil2025 * 1.2;
        }
        
        // Tip bazlÄ± hedefler
        const hedefTip = {};
        tipler.forEach(tip => {
          hedefTip[tip] = mevcutHedef[tip] || 0;
          if (!mevcutHedef[tip] && tip2025[tip] > 0) {
            if (toplam2025 > 0 && hedef2026Genel > 0) {
              // Genel hedefe gÃ¶re orantÄ±lÄ± artÄ±ÅŸ
              hedefTip[tip] = tip2025[tip] * genelArtisOrani;
            } else {
              // Genel hedef yoksa varsayÄ±lan %20 artÄ±ÅŸ
              hedefTip[tip] = tip2025[tip] * 1.2;
            }
          }
        });
        
        // ArtÄ±ÅŸ yÃ¼zdesi
        const artisYuzde = yil2025 > 0 ? ((hedef2026Toplam - yil2025) / yil2025) * 100 : 0;
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><strong>${personelAdi}</strong></td>
          <td>${yil2023 > 0 ? 'â‚º' + yil2023.toLocaleString('tr-TR', {minimumFractionDigits:2}) : '-'}</td>
          <td>${yil2024 > 0 ? 'â‚º' + yil2024.toLocaleString('tr-TR', {minimumFractionDigits:2}) : '-'}</td>
          <td>${yil2025 > 0 ? 'â‚º' + yil2025.toLocaleString('tr-TR', {minimumFractionDigits:2}) : '-'}</td>
          <td>
            <input type="text" 
              class="hedef-personel-toplam" 
              data-personel="${personelAdi}" 
              data-original="${hedef2026Toplam}"
              value="${hedef2026Toplam.toLocaleString('tr-TR', {minimumFractionDigits:2, maximumFractionDigits:2})}" 
              style="width:100%;padding:6px;border:1px solid var(--border);border-radius:6px;text-align:right;font-weight:600" 
            />
            <div class="hedef-personel-uyari" data-personel="${personelAdi}" style="display:none;font-size:10px;color:var(--bad);margin-top:2px"></div>
          </td>
          <td>
            <input type="text" 
              class="hedef-personel-tip" 
              data-personel="${personelAdi}" 
              data-tip="iftar"
              data-original="${hedefTip.iftar}"
              value="${hedefTip.iftar.toLocaleString('tr-TR', {minimumFractionDigits:2, maximumFractionDigits:2})}" 
              style="width:100%;padding:6px;border:1px solid var(--border);border-radius:6px;text-align:right" 
            />
          </td>
          <td>
            <input type="text" 
              class="hedef-personel-tip" 
              data-personel="${personelAdi}" 
              data-tip="sahur"
              data-original="${hedefTip.sahur}"
              value="${hedefTip.sahur.toLocaleString('tr-TR', {minimumFractionDigits:2, maximumFractionDigits:2})}" 
              style="width:100%;padding:6px;border:1px solid var(--border);border-radius:6px;text-align:right" 
            />
          </td>
          <td>
            <input type="text" 
              class="hedef-personel-tip" 
              data-personel="${personelAdi}" 
              data-tip="taahhut"
              data-original="${hedefTip.taahhut}"
              value="${hedefTip.taahhut.toLocaleString('tr-TR', {minimumFractionDigits:2, maximumFractionDigits:2})}" 
              style="width:100%;padding:6px;border:1px solid var(--border);border-radius:6px;text-align:right" 
            />
          </td>
          <td>
            <input type="text" 
              class="hedef-personel-tip" 
              data-personel="${personelAdi}" 
              data-tip="teberru"
              data-original="${hedefTip.teberru}"
              value="${hedefTip.teberru.toLocaleString('tr-TR', {minimumFractionDigits:2, maximumFractionDigits:2})}" 
              style="width:100%;padding:6px;border:1px solid var(--border);border-radius:6px;text-align:right" 
            />
          </td>
          <td><span class="${artisYuzde >= 0 ? 'trend-up' : 'trend-down'}">%${artisYuzde.toFixed(2)}</span></td>
        `;
        tbody.appendChild(tr);
        
        // Personel hedef input'larÄ±na event listener ekle
        const row = tbody.lastElementChild;
        const toplamInput = row.querySelector('.hedef-personel-toplam');
        const tipInputs = row.querySelectorAll('.hedef-personel-tip');
        
        // Toplam deÄŸiÅŸtiÄŸinde kontrol et ve formatla
        if (toplamInput) {
          // Input event: sadece geÃ§ersiz karakterleri temizle, formatlamayÄ± blur'da yap
          toplamInput.addEventListener('input', (e) => {
            let value = e.target.value;
            // Sadece rakam, nokta ve virgÃ¼l bÄ±rak
            value = value.replace(/[^\d.,]/g, '');
            e.target.value = value;
            
            // Toplam satÄ±rÄ±nÄ± gÃ¼ncelle (parse ederek)
            setTimeout(() => {
              kontrolPersonelHedefleri(personelAdi, yil2025);
              guncelleHedefToplamlari();
            }, 100);
          });
          
          toplamInput.addEventListener('blur', (e) => {
            const parsed = parseTutar(e.target.value || '0');
            if (parsed > 0) {
              // TÃ¼rkÃ§e format: binlik ayÄ±rÄ±cÄ± nokta, kÃ¼sÃ¼rat virgÃ¼l
              const formatted = parsed.toLocaleString('tr-TR', {minimumFractionDigits:2, maximumFractionDigits:2});
              e.target.value = formatted;
            } else if (e.target.value && e.target.value.trim() !== '' && e.target.value !== '0') {
              e.target.value = '';
            }
            kontrolPersonelHedefleri(personelAdi, yil2025);
            setTimeout(() => guncelleHedefToplamlari(), 100);
          });
        }
        
        // Tip hedefleri deÄŸiÅŸtiÄŸinde kontrol et ve formatla
        tipInputs.forEach(tipInput => {
          // Input event: sadece geÃ§ersiz karakterleri temizle, formatlamayÄ± blur'da yap
          tipInput.addEventListener('input', (e) => {
            let value = e.target.value;
            // Sadece rakam, nokta ve virgÃ¼l bÄ±rak
            value = value.replace(/[^\d.,]/g, '');
            e.target.value = value;
            
            // Toplam satÄ±rÄ±nÄ± gÃ¼ncelle (parse ederek)
            setTimeout(() => {
              kontrolPersonelHedefleri(personelAdi, yil2025);
              guncelleHedefToplamlari();
            }, 100);
          });
          
          tipInput.addEventListener('blur', (e) => {
            const parsed = parseTutar(e.target.value || '0');
            if (parsed > 0) {
              // TÃ¼rkÃ§e format: binlik ayÄ±rÄ±cÄ± nokta, kÃ¼sÃ¼rat virgÃ¼l
              const formatted = parsed.toLocaleString('tr-TR', {minimumFractionDigits:2, maximumFractionDigits:2});
              e.target.value = formatted;
            } else if (e.target.value && e.target.value.trim() !== '' && e.target.value !== '0') {
              e.target.value = '';
            }
            kontrolPersonelHedefleri(personelAdi, yil2025);
            setTimeout(() => guncelleHedefToplamlari(), 100);
          });
        });
      });
      
      // Toplam satÄ±rÄ±nÄ± gÃ¶ster ve hesapla
      setTimeout(() => {
        guncelleHedefToplamlari();
      }, 100);
    }
    
    // Hedef toplamlarÄ±nÄ± gÃ¼ncelle
    function guncelleHedefToplamlari() {
      const tbody = qs('#hedefPersonelBody');
      const tfoot = qs('#hedefPersonelToplam');
      
      if (!tbody || !tfoot) return;
      
      const rows = tbody.querySelectorAll('tr');
      if (rows.length === 0) {
        tfoot.style.display = 'none';
        return;
      }
      
      tfoot.style.display = 'table-footer-group';
      
      const tipler = ['iftar', 'sahur', 'taahhut', 'teberru'];
      const tipIds = {
        'iftar': 'toplamIftar',
        'sahur': 'toplamSahur',
        'taahhut': 'toplamTaahhut',
        'teberru': 'toplamTeberru'
      };
      
      let toplam2023 = 0;
      let toplam2024 = 0;
      let toplam2025 = 0;
      let toplam2026Hedef = 0;
      const toplamTip = { iftar: 0, sahur: 0, taahhut: 0, teberru: 0 };
      
      rows.forEach(row => {
        // 2023, 2024, 2025 toplamlarÄ± (cell'lerden)
        const cell2023 = row.cells[1]?.textContent;
        const cell2024 = row.cells[2]?.textContent;
        const cell2025 = row.cells[3]?.textContent;
        
        if (cell2023 && cell2023 !== '-') {
          toplam2023 += parseTutar(cell2023.replace(/â‚º/g, '').trim());
        }
        if (cell2024 && cell2024 !== '-') {
          toplam2024 += parseTutar(cell2024.replace(/â‚º/g, '').trim());
        }
        if (cell2025 && cell2025 !== '-') {
          toplam2025 += parseTutar(cell2025.replace(/â‚º/g, '').trim());
        }
        
        // 2026 hedef toplamÄ±
        const toplamInput = row.querySelector('.hedef-personel-toplam');
        if (toplamInput) {
          toplam2026Hedef += parseTutar(toplamInput.value || '0');
        }
        
        // Tip bazlÄ± hedefler
        tipler.forEach(tip => {
          const tipInput = row.querySelector(`.hedef-personel-tip[data-tip="${tip}"]`);
          if (tipInput) {
            toplamTip[tip] += parseTutar(tipInput.value || '0');
          }
        });
      });
      
      // Toplam satÄ±rÄ±nÄ± gÃ¼ncelle
      qs('#toplam2023').textContent = toplam2023 > 0 ? 'â‚º' + toplam2023.toLocaleString('tr-TR', {minimumFractionDigits:2}) : '-';
      qs('#toplam2024').textContent = toplam2024 > 0 ? 'â‚º' + toplam2024.toLocaleString('tr-TR', {minimumFractionDigits:2}) : '-';
      qs('#toplam2025').textContent = toplam2025 > 0 ? 'â‚º' + toplam2025.toLocaleString('tr-TR', {minimumFractionDigits:2}) : '-';
      qs('#toplam2026Hedef').textContent = toplam2026Hedef > 0 ? 'â‚º' + toplam2026Hedef.toLocaleString('tr-TR', {minimumFractionDigits:2}) : '-';
      
      tipler.forEach(tip => {
        const tipId = tipIds[tip];
        qs('#' + tipId).textContent = toplamTip[tip] > 0 ? 'â‚º' + toplamTip[tip].toLocaleString('tr-TR', {minimumFractionDigits:2}) : '-';
      });
      
      // ArtÄ±ÅŸ yÃ¼zdesi toplamÄ± (ortalama)
      const ortalamaArtis = toplam2025 > 0 ? ((toplam2026Hedef - toplam2025) / toplam2025) * 100 : 0;
      qs('#toplamArtis').innerHTML = ortalamaArtis !== 0 ? 
        `<span class="${ortalamaArtis >= 0 ? 'trend-up' : 'trend-down'}">%${ortalamaArtis.toFixed(2)}</span>` : '-';
      
      // Genel hedef
      const hedef2026GenelInput = qs('#hedef2026Genel');
      const hedef2026Genel = parseTutar(hedef2026GenelInput ? hedef2026GenelInput.value || '0' : '0');
      qs('#genelHedefToplam').textContent = hedef2026Genel > 0 ? 
        'â‚º' + hedef2026Genel.toLocaleString('tr-TR', {minimumFractionDigits:2}) : '-';
      
      // Fark hesapla
      const fark = toplam2026Hedef - hedef2026Genel;
      const farkCell = qs('#hedefFark');
      
      if (hedef2026Genel > 0) {
        if (Math.abs(fark) < 0.01) {
          farkCell.innerHTML = '<span style="color:var(--good);font-weight:700">âœ“ EÅŸit</span>';
        } else if (fark > 0) {
          farkCell.innerHTML = `<span style="color:var(--bad);font-weight:700">+â‚º${fark.toLocaleString('tr-TR', {minimumFractionDigits:2})} (Fazla)</span>`;
        } else {
          farkCell.innerHTML = `<span style="color:var(--warn);font-weight:700">â‚º${Math.abs(fark).toLocaleString('tr-TR', {minimumFractionDigits:2})} (Eksik)</span>`;
        }
      } else {
        farkCell.textContent = '-';
      }
    }
    
    // Hedefleri kaydet
    async function kaydetHedefler() {
      const hedef2026Genel = parseTutar(qs('#hedef2026Genel').value || '0');
      
      if (hedef2026Genel <= 0) {
        showToast('Hata', 'LÃ¼tfen 2026 genel hedefini giriniz!', 'error');
        return;
      }
      
      // Personel bazlÄ± hedefleri topla
      const personelHedefleri = {};
      const toplamInputs = qs('#hedefPersonelBody').querySelectorAll('.hedef-personel-toplam');
      
      toplamInputs.forEach(input => {
        const personelAdi = input.getAttribute('data-personel');
        const toplam = parseTutar(input.value || '0');
        
        if (!personelHedefleri[personelAdi]) {
          personelHedefleri[personelAdi] = {};
        }
        
        personelHedefleri[personelAdi].toplam = toplam;
      });
      
      const tipInputs = qs('#hedefPersonelBody').querySelectorAll('.hedef-personel-tip');
      tipInputs.forEach(input => {
        const personelAdi = input.getAttribute('data-personel');
        const tip = input.getAttribute('data-tip');
        const tutar = parseTutar(input.value || '0');
        
        if (!personelHedefleri[personelAdi]) {
          personelHedefleri[personelAdi] = {};
        }
        
        personelHedefleri[personelAdi][tip] = tutar;
      });
      
      // Firestore'a kaydet
      try {
        const hedefRef = db.collection('ramazan_serif').doc('ayarlar').collection('hedefler').doc('2026');
        await hedefRef.set({
          genelHedef: hedef2026Genel,
          personelHedefleri: personelHedefleri,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        }, { merge: true });
        
        showToast('BaÅŸarÄ±lÄ±! âœ…', 'Hedefler baÅŸarÄ±yla kaydedildi!', 'success');
      } catch (e) {
        console.error('Hedef kaydetme hatasÄ±:', e);
        showToast('Hata âŒ', 'Hedefler kaydedilirken hata oluÅŸtu: ' + e.message, 'error');
      }
    }
    
    // Personel hedeflerini kontrol et (manuel deÄŸiÅŸiklik sonrasÄ±)
    function kontrolPersonelHedefleri(personelAdi, yil2025) {
      const tbody = qs('#hedefPersonelBody');
      if (!tbody) return;
      
      // Bu personelin satÄ±rÄ±nÄ± bul
      const row = Array.from(tbody.querySelectorAll('tr')).find(r => {
        const input = r.querySelector('.hedef-personel-toplam');
        return input && input.getAttribute('data-personel') === personelAdi;
      });
      
      if (!row) return;
      
      const toplamInput = row.querySelector('.hedef-personel-toplam');
      const tipInputs = row.querySelectorAll('.hedef-personel-tip');
      const uyariDiv = row.querySelector('.hedef-personel-uyari');
      
      if (!toplamInput || !uyariDiv) return;
      
      // Toplam hedefi al
      const toplamHedef = parseTutar(toplamInput.value || '0');
      
      // Tip bazlÄ± hedeflerin toplamÄ±nÄ± hesapla
      let tipToplam = 0;
      tipInputs.forEach(input => {
        const tutar = parseTutar(input.value || '0');
        tipToplam += tutar;
      });
      
      // Genel hedefi al
      const hedef2026GenelInput = qs('#hedef2026Genel');
      const hedef2026Genel = parseTutar(hedef2026GenelInput ? hedef2026GenelInput.value || '0' : '0');
      const hedef2025ToplamText = qs('#hedef2025Toplam').textContent;
      const toplam2025 = parseTutar(hedef2025ToplamText.replace(/â‚º/g, '').trim());
      const genelArtisOrani = toplam2025 > 0 && hedef2026Genel > 0 ? hedef2026Genel / toplam2025 : 1.2;
      
      // Otomatik hesaplanan hedef
      const otomatikHedef = yil2025 > 0 ? yil2025 * genelArtisOrani : 0;
      
      // UyarÄ± mesajlarÄ±
      const uyarilar = [];
      
      // Toplam ile tip toplamlarÄ± eÅŸleÅŸmeli
      const fark = Math.abs(toplamHedef - tipToplam);
      if (fark > 0.01) { // 0.01 TL tolerans
        if (toplamHedef > tipToplam) {
          uyarilar.push(`âš ï¸ Toplam hedef (â‚º${toplamHedef.toLocaleString('tr-TR', {minimumFractionDigits:2})}) tip bazlÄ± hedeflerden â‚º${fark.toLocaleString('tr-TR', {minimumFractionDigits:2})} fazla!`);
        } else {
          uyarilar.push(`âš ï¸ Toplam hedef (â‚º${toplamHedef.toLocaleString('tr-TR', {minimumFractionDigits:2})}) tip bazlÄ± hedeflerden â‚º${fark.toLocaleString('tr-TR', {minimumFractionDigits:2})} az!`);
        }
      }
      
      // Genel hedefe gÃ¶re sapma kontrolÃ¼
      if (otomatikHedef > 0 && toplamHedef > 0) {
        const sapma = ((toplamHedef - otomatikHedef) / otomatikHedef) * 100;
        const sapmaTutar = toplamHedef - otomatikHedef;
        
        if (Math.abs(sapma) > 5) { // %5'ten fazla sapma
          if (sapma > 0) {
            uyarilar.push(`ğŸ“Š Genel hedefe gÃ¶re otomatik hesaplanandan â‚º${sapmaTutar.toLocaleString('tr-TR', {minimumFractionDigits:2})} (%${sapma.toFixed(1)}) fazla!`);
          } else {
            uyarilar.push(`ğŸ“Š Genel hedefe gÃ¶re otomatik hesaplanandan â‚º${Math.abs(sapmaTutar).toLocaleString('tr-TR', {minimumFractionDigits:2})} (%${Math.abs(sapma).toFixed(1)}) az!`);
          }
        }
      }
      
      // UyarÄ± gÃ¶ster/gizle
      if (uyarilar.length > 0) {
        uyariDiv.style.display = 'block';
        uyariDiv.innerHTML = uyarilar.join('<br>');
        uyariDiv.style.color = 'var(--bad)';
        uyariDiv.style.fontSize = '10px';
        uyariDiv.style.marginTop = '4px';
      } else {
        uyariDiv.style.display = 'none';
      }
      
      // Genel uyarÄ± mesajÄ±nÄ± gÃ¼ncelle
      guncelleGenelUyariMesaji();
      
      // Toplam satÄ±rÄ±nÄ± gÃ¼ncelle
      setTimeout(() => guncelleHedefToplamlari(), 100);
    }
    
    // Genel uyarÄ± mesajÄ±nÄ± gÃ¼ncelle
    function guncelleGenelUyariMesaji() {
      const uyariMesaji = qs('#hedefUyariMesaji');
      if (!uyariMesaji) return;
      
      const tbody = qs('#hedefPersonelBody');
      if (!tbody) return;
      
      const rows = tbody.querySelectorAll('tr');
      const uyarilar = [];
      
      rows.forEach(row => {
        const uyariDiv = row.querySelector('.hedef-personel-uyari');
        if (uyariDiv && uyariDiv.style.display !== 'none' && uyariDiv.textContent.trim()) {
          const personelAdi = row.querySelector('.hedef-personel-toplam')?.getAttribute('data-personel');
          if (personelAdi) {
            uyarilar.push(`<strong>${personelAdi}:</strong> ${uyariDiv.textContent.trim()}`);
          }
        }
      });
      
      if (uyarilar.length > 0) {
        uyariMesaji.style.display = 'block';
        uyariMesaji.innerHTML = `
          <strong>âš ï¸ UyarÄ±lar:</strong><br>
          ${uyarilar.join('<br>')}
        `;
      } else {
        uyariMesaji.style.display = 'none';
      }
    }
    
    window.loadHedefTanÄ±mlama = loadHedefTanÄ±mlama;
    window.kaydetHedefler = kaydetHedefler;

    // ===== TALEPLER YÃ–NETÄ°MÄ° =====
    
    let talepler = [];
    
    // AÃ§Ä±klamadan bilgileri parse et
    function parseAciklama(aciklama) {
      const result = {
        musafirAdedi: null,
        tutar: null,
        sahip: null,
        mahalId: null,
        mahalAdi: null
      };
      
      if (!aciklama) return result;
      
      const lower = aciklama.toLowerCase();
      
      // KiÅŸi artÄ±ÅŸÄ±: "kiÅŸi", "mÃ¼safir", "artÄ±r", "Ã§Ä±kar", "ekle" gibi kelimeler
      const kisiMatch = aciklama.match(/(?:kiÅŸi|mÃ¼safir|misafir).*?(\d+)/i);
      if (kisiMatch) {
        result.musafirAdedi = parseInt(kisiMatch[1]);
      }
      
      // Tutar: "tutar", "Ã¼cret", "fiyat" gibi kelimeler
      const tutarMatch = aciklama.match(/(?:tutar|Ã¼cret|fiyat).*?(\d+(?:[.,]\d+)?)/i);
      if (tutarMatch) {
        result.tutar = parseFloat(tutarMatch[1].replace(',', '.'));
      }
      
      // Mahal: "mahal", "yer" gibi kelimeler
      const mahalMatch = aciklama.match(/(?:mahal|yer).*?[:]\s*([^,|]+)/i);
      if (mahalMatch) {
        result.mahalAdi = mahalMatch[1].trim();
      }
      
      // Sahip deÄŸiÅŸikliÄŸi: "sahip", "isim" gibi kelimeler
      const sahipMatch = aciklama.match(/(?:sahip|isim).*?[:]\s*([^,|]+)/i);
      if (sahipMatch) {
        result.sahip = sahipMatch[1].trim();
      }
      
      return result;
    }
    
    async function loadTalepler() {
      const yil = qs('#taleplerFiltreYil')?.value || qs('#filtreYil')?.value || '2025';
      try {
        const yilRef = db.collection('ramazan_serif').doc(String(yil));
        const snap = await yilRef.collection('duzenleme_talepleri')
          .orderBy('createdAt', 'desc')
          .get();
        talepler = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderTalepler();
      } catch (e) {
        console.error('Talepler yÃ¼klenemedi:', e);
        talepler = [];
        renderTalepler();
      }
    }
    
    function filterTalepler() {
      renderTalepler();
    }
    
    function renderTalepler() {
      const tbody = qs('#tbodyTalepler');
      if (!tbody) return;
      tbody.innerHTML = '';
      
      let filtered = [...talepler];
      
      const durum = qs('#taleplerFiltreDurum')?.value || '';
      if (durum) filtered = filtered.filter(t => t.durum === durum);
      
      const tip = qs('#taleplerFiltreTip')?.value || '';
      if (tip) filtered = filtered.filter(t => t.talepTipi === tip);
      
      const ara = qs('#taleplerAraInput')?.value.trim() || '';
      if (ara) {
        filtered = filtered.filter(t => 
          turkishIncludes(t.personelAdi || '', ara) ||
          turkishIncludes(t.aciklama || '', ara)
        );
      }
      
      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="15" style="text-align:center;color:var(--muted);padding:20px">Talep bulunamadÄ±</td></tr>';
        return;
      }
      
      filtered.forEach(t => {
        const tr = document.createElement('tr');
        
        // Tarih formatla
        let tarihStr = '-';
        if (t.createdAt) {
          if (t.createdAt.toDate) {
            const date = t.createdAt.toDate();
            tarihStr = `${date.getDate()}.${date.getMonth() + 1}.${date.getFullYear()}`;
          } else if (t.createdAt.seconds) {
            const date = new Date(t.createdAt.seconds * 1000);
            tarihStr = `${date.getDate()}.${date.getMonth() + 1}.${date.getFullYear()}`;
          }
        }
        
        // Talep tipi label
        const talepTipiLabel = {
          'duzenle': 'âœï¸ DÃ¼zenle',
          'yer_degistir': 'ğŸ”„ Yer DeÄŸiÅŸtir',
          'sil': 'ğŸ—‘ï¸ Sil'
        }[t.talepTipi] || t.talepTipi;
        
        // KayÄ±t tipi label
        const kayitTipiLabel = {
          'iftar-sahur': 'ğŸŒ™ Ä°ftar/Sahur',
          'taahhut': 'ğŸ“ TaahhÃ¼t',
          'teberru': 'ğŸ’° Teberru'
        }[t.kayitTipi] || t.kayitTipi;
        
        // Durum badge
        const durumBadge = {
          'beklemede': '<span style="background:#fff3cd;color:#856404;padding:4px 8px;border-radius:4px;font-size:11px;font-weight:600">â³ Beklemede</span>',
          'onaylandi': '<span style="background:#d4edda;color:#155724;padding:4px 8px;border-radius:4px;font-size:11px;font-weight:600">âœ“ OnaylandÄ±</span>',
          'reddedildi': '<span style="background:#f8d7da;color:#721c24;padding:4px 8px;border-radius:4px;font-size:11px;font-weight:600">âœ— Reddedildi</span>'
        }[t.durum] || t.durum;
        
        // Yeni tarih
        let yeniTarihStr = '-';
        if (t.yeniTarih) {
          const date = new Date(t.yeniTarih);
          yeniTarihStr = `${date.getDate()}.${date.getMonth() + 1}.${date.getFullYear()}`;
        }
        
        // KayÄ±t bilgilerini al
        let sahipBilgisi = '-';
        let mevcutTarihStr = '-';
        let musafirAdedi = '-';
        let mahalAdi = '-';
        let kayitTip = '-';
        let tutarBilgisi = '-';
        let istirakBilgisi = '-';
        
        if (t.kayitId) {
          if (t.kayitTipi === 'iftar-sahur') {
            const kayit = kayitlar.find(k => k.id === t.kayitId);
            if (kayit) {
              sahipBilgisi = kayit.sahip || '-';
              musafirAdedi = kayit.musafirAdedi || 0;
              mahalAdi = kayit.mahal || '-';
              tutarBilgisi = kayit.tutar ? `â‚º${Number(kayit.tutar).toLocaleString('tr-TR', {minimumFractionDigits:2})}` : '-';
              istirakBilgisi = kayit.istirak ? 'âœ“ Evet' : 'âœ— HayÄ±r';
              kayitTip = kayit.tip === 'iftar' ? 'ğŸŒ™ Ä°ftar' : 'ğŸŒŸ Sahur';
              
              // Mevcut tarih
              if (kayit.tarih) {
                let tarih;
                if (kayit.tarih.toDate) {
                  tarih = kayit.tarih.toDate();
                } else if (kayit.tarih.seconds) {
                  tarih = new Date(kayit.tarih.seconds * 1000);
                } else if (typeof kayit.tarih === 'string') {
                  tarih = new Date(kayit.tarih);
                } else {
                  tarih = new Date(kayit.tarih);
                }
                mevcutTarihStr = `${tarih.getDate()}.${tarih.getMonth() + 1}.${tarih.getFullYear()}`;
              }
            }
          }
        }
        
        tr.innerHTML = `
          <td>${tarihStr}</td>
          <td>${t.tip ? (t.tip === 'iftar' ? 'ğŸŒ™ Ä°ftar' : 'ğŸŒŸ Sahur') : kayitTip}</td>
          <td>${talepTipiLabel}</td>
          <td>${kayitTipiLabel}</td>
          <td><strong>${sahipBilgisi}</strong></td>
          <td>${mevcutTarihStr}</td>
          <td>${musafirAdedi}</td>
          <td>${tutarBilgisi}</td>
          <td>${istirakBilgisi}</td>
          <td>${mahalAdi}</td>
          <td>${t.personelAdi || '-'}</td>
          <td style="max-width:250px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${t.aciklama || ''}">${t.aciklama || '-'}</td>
          <td>${yeniTarihStr}</td>
          <td>${durumBadge}</td>
          <td>
            ${t.durum === 'beklemede' ? `
              <button onclick="onaylaTalep('${t.id}')" style="padding:4px 8px;font-size:12px;background:var(--good);color:white;border:none;border-radius:4px;cursor:pointer;margin-right:4px">âœ“ Onayla</button>
              <button onclick="reddetTalep('${t.id}')" class="danger" style="padding:4px 8px;font-size:12px;background:var(--bad);color:white;border:none;border-radius:4px;cursor:pointer">âœ— Reddet</button>
            ` : '-'}
          </td>
        `;
        tbody.appendChild(tr);
      });
    }
    
    async function onaylaTalep(talepId) {
      const talep = talepler.find(t => t.id === talepId);
      if (!talep) {
        showAlertModal('Hata', 'Talep bulunamadÄ±!');
        return;
      }
      
      const talepTipiLabel = {
        'duzenle': 'DÃ¼zenle',
        'yer_degistir': 'Yer DeÄŸiÅŸtir',
        'sil': 'Sil'
      }[talep.talepTipi] || talep.talepTipi;
      
      // KayÄ±t bilgilerini hazÄ±rla
      let kayitBilgileri = '';
      if (talep.kayitTipi === 'iftar-sahur') {
        const kayit = kayitlar.find(k => k.id === talep.kayitId);
        if (kayit) {
          let tarihStr = '-';
          if (kayit.tarih) {
            let tarih;
            if (kayit.tarih.toDate) {
              tarih = kayit.tarih.toDate();
            } else if (kayit.tarih.seconds) {
              tarih = new Date(kayit.tarih.seconds * 1000);
            } else {
              tarih = new Date(kayit.tarih);
            }
            tarihStr = `${tarih.getDate()}.${tarih.getMonth() + 1}.${tarih.getFullYear()}`;
          }
          
          kayitBilgileri = `
Mevcut KayÄ±t Bilgileri:
â€¢ Tarih: ${tarihStr}
â€¢ Tip: ${kayit.tip === 'iftar' ? 'ğŸŒ™ Ä°ftar' : 'ğŸŒŸ Sahur'}
â€¢ Sahip: ${kayit.sahip || '-'}
â€¢ MÃ¼safir: ${kayit.musafirAdedi || 0}
â€¢ Tutar: ${kayit.tutar ? `â‚º${Number(kayit.tutar).toLocaleString('tr-TR', {minimumFractionDigits:2})}` : '-'}
â€¢ Ä°ÅŸtirak: ${kayit.istirak ? 'Evet' : 'HayÄ±r'}
â€¢ Mahal: ${kayit.mahal || '-'}
`;
          
          if (talep.yeniTarih) {
            const yeniTarih = new Date(talep.yeniTarih);
            kayitBilgileri += `â€¢ Yeni Tarih: ${yeniTarih.getDate()}.${yeniTarih.getMonth() + 1}.${yeniTarih.getFullYear()}\n`;
          }
        }
      }
      
      const confirmed = await showConfirmModal(
        'Talep OnayÄ±',
        `Bu talebi onaylamak istediÄŸinizden emin misiniz?\n\nTalep Tipi: ${talepTipiLabel}\n${kayitBilgileri}\nAÃ§Ä±klama: ${talep.aciklama || '-'}`,
        'Onayla',
        'good'
      );
      
      if (!confirmed) {
        return;
      }
      
      try {
        const yil = qs('#taleplerFiltreYil')?.value || qs('#filtreYil')?.value || '2025';
        const yilRef = db.collection('ramazan_serif').doc(String(yil));
        const talepRef = yilRef.collection('duzenleme_talepleri').doc(talepId);
        
        if (talep.kayitTipi === 'iftar-sahur') {
          const kayit = kayitlar.find(k => k.id === talep.kayitId);
          if (!kayit) {
            showAlertModal('Hata', 'KayÄ±t bulunamadÄ±!');
            return;
          }
          
          if (talep.talepTipi === 'yer_degistir' && talep.yeniTarih) {
            // Yer deÄŸiÅŸtirme - Tarih gÃ¼ncelle
            const yeniTarihParts = talep.yeniTarih.split('-');
            const yeniTarih = new Date(yeniTarihParts[0], yeniTarihParts[1]-1, yeniTarihParts[2], 12, 0, 0);
            const yil = yeniTarih.getFullYear();
            const ay = yeniTarih.getMonth() + 1;
            
            // Not alanÄ±na geÃ§miÅŸ tarihleri ekle
            let tarihGecmisi = kayit.not || '';
            const formatTarih = (date) => {
              const d = new Date(date);
              const gun = String(d.getDate()).padStart(2, '0');
              const ay = String(d.getMonth() + 1).padStart(2, '0');
              const yil = d.getFullYear();
              return `${gun}.${ay}.${yil}`;
            };
            
            let eskiTarih;
            if (kayit.tarih) {
              if (kayit.tarih.toDate) {
                eskiTarih = kayit.tarih.toDate();
              } else if (kayit.tarih.seconds) {
                eskiTarih = new Date(kayit.tarih.seconds * 1000);
              } else {
                eskiTarih = new Date(kayit.tarih);
              }
            } else {
              eskiTarih = new Date();
            }
            
            if (tarihGecmisi && tarihGecmisi.includes('tarihine geÃ§ti')) {
              const tarihListesi = tarihGecmisi.match(/\d{2}\.\d{2}\.\d{4}/g) || [];
              const yeniTarihStr = formatTarih(yeniTarih);
              tarihGecmisi = tarihListesi.join(' > ') + ' > ' + yeniTarihStr + ' tarihine geÃ§ti';
            } else {
              const eskiTarihStr = formatTarih(eskiTarih);
              const yeniTarihStr = formatTarih(yeniTarih);
              tarihGecmisi = (tarihGecmisi ? tarihGecmisi + ' | ' : '') + 
                eskiTarihStr + ' > ' + yeniTarihStr + ' tarihine geÃ§ti';
            }
            
            // Mahal deÄŸiÅŸikliÄŸi kontrolÃ¼
            let mahalGuncellemesi = {};
            if (talep.mahalId && kayit.mahalId !== talep.mahalId) {
              // Mahal deÄŸiÅŸikliÄŸi yap
              const mahallar = await yilRef.collection('mahallar').get();
              const yeniMahal = mahallar.docs.find(d => d.id === talep.mahalId);
              if (yeniMahal) {
                mahalGuncellemesi = {
                  mahalId: talep.mahalId,
                  mahal: yeniMahal.data().ad || kayit.mahal
                };
              }
            }
            
            // KaydÄ± gÃ¼ncelle
            await yilRef.collection('kayitlar').doc(talep.kayitId).update({
              tarih: firebase.firestore.Timestamp.fromDate(yeniTarih),
              not: tarihGecmisi,
              yil: yil,
              ay: ay,
              ...mahalGuncellemesi,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            
          } else if (talep.talepTipi === 'duzenle') {
            // Normal dÃ¼zenleme - AÃ§Ä±klamadan bilgileri parse et
            const guncelleme = parseAciklama(talep.aciklama || '');
            let not = kayit.not || '';
            
            // AÃ§Ä±klamayÄ± not alanÄ±na ekle
            if (talep.aciklama) {
              not = (not ? not + ' | ' : '') + `DÃ¼zenleme: ${talep.aciklama}`;
            }
            
            // GÃ¼ncelleme objesi oluÅŸtur
            const updateData = {
              not: not,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // KiÅŸi artÄ±ÅŸÄ± varsa
            if (guncelleme.musafirAdedi !== null) {
              updateData.musafirAdedi = guncelleme.musafirAdedi;
            }
            
            // Tutar deÄŸiÅŸikliÄŸi varsa
            if (guncelleme.tutar !== null) {
              updateData.tutar = guncelleme.tutar;
            }
            
            // Sahip deÄŸiÅŸikliÄŸi varsa
            if (guncelleme.sahip) {
              updateData.sahip = guncelleme.sahip;
            }
            
            // Mahal deÄŸiÅŸikliÄŸi varsa
            if (guncelleme.mahalId) {
              const mahallar = await yilRef.collection('mahallar').get();
              const yeniMahal = mahallar.docs.find(d => d.id === guncelleme.mahalId || d.data().ad === guncelleme.mahalAdi);
              if (yeniMahal) {
                updateData.mahalId = yeniMahal.id;
                updateData.mahal = yeniMahal.data().ad || kayit.mahal;
              }
            }
            
            await yilRef.collection('kayitlar').doc(talep.kayitId).update(updateData);
          } else if (talep.talepTipi === 'sil') {
            // Silme iÅŸlemi
            await yilRef.collection('kayitlar').doc(talep.kayitId).delete();
          }
        } else {
          // TaahhÃ¼t veya Teberru iÃ§in sadece durum gÃ¼ncelle
          // Bu kayÄ±tlar farklÄ± koleksiyonlarda olabilir
          // Åimdilik sadece talep durumunu gÃ¼ncelliyoruz
        }
        
        // Talep durumunu gÃ¼ncelle
        await talepRef.update({
          durum: 'onaylandi',
          onaylayanUid: auth.currentUser?.uid || null,
          onaylanmaTarihi: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        showToast('BaÅŸarÄ±lÄ±', 'Talep baÅŸarÄ±yla onaylandÄ±!', 'success');
        await loadTalepler();
        await loadKayitlar(); // KayÄ±tlarÄ± yeniden yÃ¼kle
      } catch (e) {
        console.error('Talep onaylanamadÄ±:', e);
        showAlertModal('Hata', 'Talep onaylanamadÄ±: ' + e.message);
      }
    }
    
    async function reddetTalep(talepId) {
      const talep = talepler.find(t => t.id === talepId);
      if (!talep) {
        showAlertModal('Hata', 'Talep bulunamadÄ±!');
        return;
      }
      
      // Red modal'Ä± iÃ§in input alanÄ± oluÅŸtur
      const redAciklama = await showPromptModal(
        'Talep Reddetme',
        'Red sebebini giriniz (opsiyonel):',
        'Reddet',
        'danger'
      );
      
      if (redAciklama === null) return; // KullanÄ±cÄ± iptal etti
      
      try {
        const yil = qs('#taleplerFiltreYil')?.value || qs('#filtreYil')?.value || '2025';
        const yilRef = db.collection('ramazan_serif').doc(String(yil));
        const talepRef = yilRef.collection('duzenleme_talepleri').doc(talepId);
        
        await talepRef.update({
          durum: 'reddedildi',
          redEdenUid: auth.currentUser?.uid || null,
          redTarihi: firebase.firestore.FieldValue.serverTimestamp(),
          redAciklama: redAciklama || ''
        });
        
        showToast('BaÅŸarÄ±lÄ±', 'Talep reddedildi!', 'success');
        await loadTalepler();
      } catch (e) {
        console.error('Talep reddedilemedi:', e);
        showAlertModal('Hata', 'Talep reddedilemedi: ' + e.message);
      }
    }
    
    window.loadTalepler = loadTalepler;
    window.filterTalepler = filterTalepler;
    window.onaylaTalep = onaylaTalep;
    window.reddetTalep = reddetTalep;
    
    // YÄ±l deÄŸiÅŸtiÄŸinde talepleri yeniden yÃ¼kle
    if (qs('#taleplerFiltreYil')) {
      qs('#taleplerFiltreYil').addEventListener('change', loadTalepler);
    }

    // ===== PERSONEL HEDEF YÃ–NETÄ°MÄ° =====
    
    let personelHedefleri = [];
    let kullanicilarList = [];
    
    // Tutar parse fonksiyonu
    function parseTutar(str) {
      if (!str || str.trim() === '') return 0;
      return parseFloat(str.replace(/\./g, '').replace(',', '.')) || 0;
    }
    
    // Tutar format fonksiyonu
    function formatTutar(tutar) {
      return tutar.toLocaleString('tr-TR', {minimumFractionDigits:2, maximumFractionDigits:2});
    }
    
    async function loadKullanicilar() {
      try {
        const snap = await db.collection('kullanicilar').orderBy('adSoyad', 'asc').get();
        kullanicilarList = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      } catch (e) {
        console.error('KullanÄ±cÄ±lar yÃ¼klenemedi:', e);
        kullanicilarList = [];
      }
    }
    
    async function loadPersonelHedefleri() {
      const yil = qs('#hedefYonetimYil')?.value || '2025';
      try {
        const yilRef = db.collection('ramazan_serif').doc(String(yil));
        const snap = await yilRef.collection('personel_hedefleri').orderBy('personelAdi', 'asc').get();
        personelHedefleri = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        
        // KullanÄ±cÄ±larÄ± da yÃ¼kle
        await loadKullanicilar();
        renderPersonelHedefleri();
      } catch (e) {
        console.error('Personel hedefleri yÃ¼klenemedi:', e);
        personelHedefleri = [];
        await loadKullanicilar();
        renderPersonelHedefleri();
      }
    }
    
    function renderPersonelHedefleri() {
      const tbody = qs('#tbodyPersonelHedefleri');
      if (!tbody) return;
      tbody.innerHTML = '';
      
      if (personelHedefleri.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--muted);padding:20px">Hedef bulunamadÄ±</td></tr>';
        return;
      }
      
      personelHedefleri.forEach(h => {
        const tr = document.createElement('tr');
        const hedef = h.hedef || h.iftarHedefi || h.sahurHedefi || h.taahhutHedefi || h.teberruHedefi || '0';
        
        tr.innerHTML = `
          <td><strong>${h.personelAdi || '-'}</strong></td>
          <td>${h.yil || '-'}</td>
          <td class="right"><strong>${hedef ? `â‚º${formatTutar(parseTutar(hedef))}` : '-'}</strong></td>
          <td>
            <button onclick="editPersonelHedef('${h.id}')" style="padding:4px 8px;font-size:12px;margin-right:4px">DÃ¼zenle</button>
            <button onclick="deletePersonelHedef('${h.id}')" class="danger" style="padding:4px 8px;font-size:12px">Sil</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }
    
    async function openPersonelHedefModal(id = null) {
      await loadKullanicilar();
      
      qs('#personelHedefId').value = id || '';
      qs('#personelHedefTitle').textContent = id ? 'Personel Hedefi DÃ¼zenle' : 'Yeni Personel Hedefi';
      
      // Personel dropdown'unu doldur
      const personelSelect = qs('#personelHedefPersonel');
      personelSelect.innerHTML = '<option value="">Personel SeÃ§iniz</option>';
      kullanicilarList.forEach(k => {
        const option = document.createElement('option');
        option.value = k.id;
        option.textContent = k.adSoyad || k.email || k.id;
        personelSelect.appendChild(option);
      });
      
      if (id) {
        const hedef = personelHedefleri.find(h => h.id === id);
        if (hedef) {
          qs('#personelHedefPersonel').value = hedef.personelUid || '';
          qs('#personelHedefYil').value = hedef.yil || '2025';
          qs('#personelHedefTutar').value = hedef.hedef || hedef.iftarHedefi || hedef.sahurHedefi || hedef.taahhutHedefi || hedef.teberruHedefi || '';
        }
      } else {
        qs('#formPersonelHedef').reset();
        qs('#personelHedefYil').value = qs('#hedefYonetimYil')?.value || '2025';
      }
      
      qs('#modalPersonelHedef').classList.add('show');
      document.body.classList.add('modal-open');
    }
    
    function closePersonelHedefModal() {
      qs('#modalPersonelHedef').classList.remove('show');
      document.body.classList.remove('modal-open');
      qs('#formPersonelHedef').reset();
    }
    
    async function editPersonelHedef(id) {
      await openPersonelHedefModal(id);
    }
    
    async function deletePersonelHedef(id) {
      const hedef = personelHedefleri.find(h => h.id === id);
      if (!hedef) {
        showAlertModal('Hata', 'Hedef bulunamadÄ±!');
        return;
      }
      
      const confirmed = await showConfirmModal(
        'Hedef Silme',
        `${hedef.personelAdi || 'Bu personel'} iÃ§in ${hedef.yil || ''} yÄ±lÄ± hedefini silmek istediÄŸinizden emin misiniz?`,
        'Sil',
        'danger'
      );
      
      if (!confirmed) return;
      
      try {
        const yil = hedef.yil || qs('#hedefYonetimYil')?.value || '2025';
        const yilRef = db.collection('ramazan_serif').doc(String(yil));
        await yilRef.collection('personel_hedefleri').doc(id).delete();
        showToast('BaÅŸarÄ±lÄ±', 'Hedef silindi!', 'success');
        await loadPersonelHedefleri();
      } catch (e) {
        console.error('Hedef silinemedi:', e);
        showAlertModal('Hata', 'Hedef silinemedi: ' + e.message);
      }
    }
    
    qs('#formPersonelHedef').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const id = qs('#personelHedefId').value;
      const personelUid = qs('#personelHedefPersonel').value;
      const yil = qs('#personelHedefYil').value;
      const hedefTutar = qs('#personelHedefTutar').value.trim();
      
      if (!personelUid) {
        showAlertModal('Hata', 'LÃ¼tfen bir personel seÃ§iniz!');
        return;
      }
      
      if (!hedefTutar) {
        showAlertModal('Hata', 'LÃ¼tfen hedef tutarÄ± giriniz!');
        return;
      }
      
      const personel = kullanicilarList.find(k => k.id === personelUid);
      const personelAdi = personel?.adSoyad || personel?.email || 'Bilinmeyen';
      
      try {
        const yilRef = db.collection('ramazan_serif').doc(String(yil));
        const data = {
          personelUid: personelUid,
          personelAdi: personelAdi,
          yil: parseInt(yil),
          hedef: hedefTutar,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        if (id) {
          await yilRef.collection('personel_hedefleri').doc(id).update(data);
        } else {
          // Mevcut hedef var mÄ± kontrol et
          const mevcutHedefSnap = await yilRef.collection('personel_hedefleri')
            .where('personelUid', '==', personelUid)
            .where('yil', '==', parseInt(yil))
            .get();
          
          if (mevcutHedefSnap.empty) {
            data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
            await yilRef.collection('personel_hedefleri').add(data);
          } else {
            // Mevcut hedefi gÃ¼ncelle
            await mevcutHedefSnap.docs[0].ref.update(data);
          }
        }
        
        showToast('BaÅŸarÄ±lÄ±', 'Hedef baÅŸarÄ±yla kaydedildi!', 'success');
        closePersonelHedefModal();
        await loadPersonelHedefleri();
      } catch (e) {
        console.error('Hedef kaydedilemedi:', e);
        showAlertModal('Hata', 'Hedef kaydedilemedi: ' + e.message);
      }
    });
    
    window.loadPersonelHedefleri = loadPersonelHedefleri;
    window.openPersonelHedefModal = openPersonelHedefModal;
    window.closePersonelHedefModal = closePersonelHedefModal;
    window.editPersonelHedef = editPersonelHedef;
    window.deletePersonelHedef = deletePersonelHedef;
    
    // YÄ±l deÄŸiÅŸtiÄŸinde hedefleri yeniden yÃ¼kle
    if (qs('#hedefYonetimYil')) {
      qs('#hedefYonetimYil').addEventListener('change', loadPersonelHedefleri);
    }

    // ===== MENÃœ YÃ–NETÄ°MÄ° =====
    
    let menuler = [];
    
    async function loadMenuler() {
      const yil = qs('#menuFiltreYil')?.value || '2025';
      try {
        const yilRef = db.collection('ramazan_serif').doc(String(yil));
        const snap = await yilRef.collection('menuler').orderBy('tarih', 'desc').get();
        menuler = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        renderMenuler();
      } catch (e) {
        console.error('MenÃ¼ler yÃ¼klenemedi:', e);
        menuler = [];
        renderMenuler();
      }
    }
    
    function filterMenuler() {
      renderMenuler();
    }
    
    function renderMenuler() {
      const tbody = qs('#tbodyMenuler');
      if (!tbody) return;
      tbody.innerHTML = '';
      
      let filtered = [...menuler];
      
      const tip = qs('#menuFiltreTip')?.value || '';
      if (tip) filtered = filtered.filter(m => m.tip === tip);
      
      const tarih = qs('#menuFiltreTarih')?.value || '';
      if (tarih) {
        filtered = filtered.filter(m => {
          let menuTarih = '';
          if (m.tarih) {
            if (m.tarih.toDate) {
              menuTarih = m.tarih.toDate().toISOString().slice(0, 10);
            } else if (m.tarih.seconds) {
              menuTarih = new Date(m.tarih.seconds * 1000).toISOString().slice(0, 10);
            } else if (typeof m.tarih === 'string') {
              menuTarih = m.tarih.slice(0, 10);
            }
          }
          return menuTarih === tarih;
        });
      }
      
      if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--muted);padding:20px">MenÃ¼ bulunamadÄ±</td></tr>';
        return;
      }
      
      filtered.forEach(m => {
        const tr = document.createElement('tr');
        
        // Tarih formatla
        let tarihStr = '-';
        if (m.tarih) {
          let tarih;
          if (m.tarih.toDate) {
            tarih = m.tarih.toDate();
          } else if (m.tarih.seconds) {
            tarih = new Date(m.tarih.seconds * 1000);
          } else if (typeof m.tarih === 'string') {
            tarih = new Date(m.tarih);
          } else {
            tarih = new Date(m.tarih);
          }
          tarihStr = `${tarih.getDate()}.${tarih.getMonth() + 1}.${tarih.getFullYear()}`;
        }
        
        const tipLabel = m.tip === 'iftar' ? 'ğŸŒ™ Ä°ftar' : 'ğŸŒŸ Sahur';
        
        tr.innerHTML = `
          <td><strong>${tarihStr}</strong></td>
          <td>${tipLabel}</td>
          <td>${m.corba || '-'}</td>
          <td>${m.yemek || '-'}</td>
          <td>${m.soguk || '-'}</td>
          <td>${m.icecek || '-'}</td>
          <td style="max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${m.diger || ''}">${m.diger || '-'}</td>
          <td>
            <button onclick="editMenu('${m.id}')" style="padding:4px 8px;font-size:12px;margin-right:4px">DÃ¼zenle</button>
            <button onclick="deleteMenu('${m.id}')" class="danger" style="padding:4px 8px;font-size:12px">Sil</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }
    
    async function openMenuModal(id = null) {
      qs('#menuId').value = id || '';
      qs('#menuTitle').textContent = id ? 'MenÃ¼ DÃ¼zenle' : 'Yeni MenÃ¼';
      
      if (id) {
        const menu = menuler.find(m => m.id === id);
        if (menu) {
          let tarihStr = '';
          if (menu.tarih) {
            if (menu.tarih.toDate) {
              tarihStr = menu.tarih.toDate().toISOString().slice(0, 10);
            } else if (menu.tarih.seconds) {
              tarihStr = new Date(menu.tarih.seconds * 1000).toISOString().slice(0, 10);
            } else if (typeof menu.tarih === 'string') {
              tarihStr = menu.tarih.slice(0, 10);
            }
          }
          qs('#menuTarih').value = tarihStr;
          qs('#menuTip').value = menu.tip || '';
          qs('#menuCorba').value = menu.corba || '';
          qs('#menuYemek').value = menu.yemek || '';
          qs('#menuSoguk').value = menu.soguk || '';
          qs('#menuIcecek').value = menu.icecek || '';
          qs('#menuDiger').value = menu.diger || '';
        }
      } else {
        qs('#formMenu').reset();
        qs('#menuTarih').value = new Date().toISOString().slice(0, 10);
      }
      
      qs('#modalMenu').classList.add('show');
      document.body.classList.add('modal-open');
    }
    
    function closeMenuModal() {
      qs('#modalMenu').classList.remove('show');
      document.body.classList.remove('modal-open');
      qs('#formMenu').reset();
    }
    
    async function editMenu(id) {
      await openMenuModal(id);
    }
    
    async function deleteMenu(id) {
      const menu = menuler.find(m => m.id === id);
      if (!menu) {
        showAlertModal('Hata', 'MenÃ¼ bulunamadÄ±!');
        return;
      }
      
      let tarihStr = '-';
      if (menu.tarih) {
        if (menu.tarih.toDate) {
          const tarih = menu.tarih.toDate();
          tarihStr = `${tarih.getDate()}.${tarih.getMonth() + 1}.${tarih.getFullYear()}`;
        }
      }
      
      const confirmed = await showConfirmModal(
        'MenÃ¼ Silme',
        `${tarihStr} tarihli ${menu.tip === 'iftar' ? 'Ä°ftar' : 'Sahur'} menÃ¼sÃ¼nÃ¼ silmek istediÄŸinizden emin misiniz?`,
        'Sil',
        'danger'
      );
      
      if (!confirmed) return;
      
      try {
        const yil = qs('#menuFiltreYil')?.value || '2025';
        const yilRef = db.collection('ramazan_serif').doc(String(yil));
        await yilRef.collection('menuler').doc(id).delete();
        showToast('BaÅŸarÄ±lÄ±', 'MenÃ¼ silindi!', 'success');
        await loadMenuler();
      } catch (e) {
        console.error('MenÃ¼ silinemedi:', e);
        showAlertModal('Hata', 'MenÃ¼ silinemedi: ' + e.message);
      }
    }
    
    qs('#formMenu').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const id = qs('#menuId').value;
      const tarih = qs('#menuTarih').value;
      const tip = qs('#menuTip').value;
      const corba = qs('#menuCorba').value.trim();
      const yemek = qs('#menuYemek').value.trim();
      const soguk = qs('#menuSoguk').value.trim();
      const icecek = qs('#menuIcecek').value.trim();
      const diger = qs('#menuDiger').value.trim();
      
      if (!tarih || !tip) {
        showAlertModal('Hata', 'LÃ¼tfen tarih ve tip seÃ§iniz!');
        return;
      }
      
      const date = new Date(tarih);
      const yil = date.getFullYear();
      
      try {
        const yilRef = db.collection('ramazan_serif').doc(String(yil));
        const tarihTimestamp = firebase.firestore.Timestamp.fromDate(date);
        
        const data = {
          tarih: tarihTimestamp,
          tip: tip,
          corba: corba || null,
          yemek: yemek || null,
          soguk: soguk || null,
          icecek: icecek || null,
          diger: diger || null,
          yil: yil,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };
        
        if (id) {
          await yilRef.collection('menuler').doc(id).update(data);
        } else {
          // AynÄ± tarih ve tip iÃ§in menÃ¼ var mÄ± kontrol et
          const mevcutMenuSnap = await yilRef.collection('menuler')
            .where('tarih', '==', tarihTimestamp)
            .where('tip', '==', tip)
            .get();
          
          if (!mevcutMenuSnap.empty) {
            // Mevcut menÃ¼yÃ¼ gÃ¼ncelle
            await mevcutMenuSnap.docs[0].ref.update(data);
          } else {
            // Yeni menÃ¼ oluÅŸtur
            data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
            await yilRef.collection('menuler').add(data);
          }
        }
        
        showToast('BaÅŸarÄ±lÄ±', 'MenÃ¼ baÅŸarÄ±yla kaydedildi!', 'success');
        closeMenuModal();
        await loadMenuler();
      } catch (e) {
        console.error('MenÃ¼ kaydedilemedi:', e);
        showAlertModal('Hata', 'MenÃ¼ kaydedilemedi: ' + e.message);
      }
    });
    
    window.loadMenuler = loadMenuler;
    window.filterMenuler = filterMenuler;
    window.openMenuModal = openMenuModal;
    window.closeMenuModal = closeMenuModal;
    window.editMenu = editMenu;
    window.deleteMenu = deleteMenu;
    
    // YÄ±l deÄŸiÅŸtiÄŸinde menÃ¼leri yeniden yÃ¼kle
    if (qs('#menuFiltreYil')) {
      qs('#menuFiltreYil').addEventListener('change', loadMenuler);
    }
  </script>
</body>
</html>

