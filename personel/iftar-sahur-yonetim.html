<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8" />
  <title>Ä°ftar-Sahur YÃ¶netim Paneli | Ramazan-Ä± Åerif</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <link rel="icon" type="image/png" href="../img/logo.png" />

  <link rel="stylesheet" href="../css/app-shell.css" />

  <style>
    /* app-shell.css Ã¼st bar/arka plan/toast/yetki yapÄ±sÄ±nÄ± kullanÄ±r.
       Burada sadece sayfa-Ã¶zel kÃ¼Ã§Ã¼k dÃ¼zenlemeler var. */
    body {
      padding-top: var(--appbar-h) !important;
      overflow-x: hidden;
      overflow-y: auto;
    }

    /* Drawer masaÃ¼stÃ¼nde kapalÄ± kalmalÄ± */
    @media (min-width: 1025px) {
      .drawer {
        transform: translateX(100%) !important;
      }

      .drawer.open {
        transform: translateX(0) !important;
      }
    }

    .wrap {
      max-width: 1950px;
      margin: 0 auto;
      padding: 16px
    }

    .toolbar {
      display: flex;
      gap: 10px;
      flex-wrap: nowrap;
      align-items: center;
      overflow: auto;
      padding-bottom: 6px
    }

    /* KayÄ±tlar sekmesi filtre satÄ±rÄ± daha dar */
    #tab-kayitlar .toolbar.kayitlar-filtre {
      max-width: 1750px;
    }
    #tab-kayitlar .toolbar.kayitlar-filtre button {
      min-width: 150px;
    }
    /* KayÄ±tlar tablosu: sabit sÃ¼tun geniÅŸlikleri (tarayÄ±cÄ± otomatik ayarlamasÄ±n) */
    #tblKayitlar {
      table-layout: fixed;
    }
    #tblKayitlar th:nth-child(1) { width: 50px; }   /* Ä°ÅŸlem Tarihi */
    #tblKayitlar th:nth-child(2) { width: 55px; }   /* Tarih */
    #tblKayitlar th:nth-child(3) { width: 70px; }   /* Tip */
    #tblKayitlar th:nth-child(4) { width: 130px; }  /* Sahip */
    #tblKayitlar th:nth-child(5) { width: 90px; }   /* Tutar */
    #tblKayitlar th:nth-child(6) { width: 145px; }   /* Tahsilat / Kalan */
    #tblKayitlar th:nth-child(7) { width: 65px; }    /* Ä°ÅŸtirak */
    #tblKayitlar th:nth-child(8) { width: 60px; }    /* MÃ¼safir */
    #tblKayitlar th:nth-child(9) { width: 95px; }    /* Mahal */
    #tblKayitlar th:nth-child(10) { width: 100px; }  /* Personel */
    #tblKayitlar th:nth-child(11) { width: 175px; }  /* Not */
    #tblKayitlar th:nth-child(12) { width: 180px; }  /* Ä°ÅŸlemler */
    #tblKayitlar td:nth-child(11) {
      white-space: normal;
      word-wrap: break-word;
      max-width: 160px;
    }

    /* SÃ¼tun baÅŸlÄ±ÄŸÄ±na tÄ±klanÄ±nca sÄ±ralama - tÄ±klanabilir gÃ¶rÃ¼nÃ¼m */
    thead th.th-sortable {
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
    }
    thead th.th-sortable:hover {
      color: var(--accent);
    }
    thead th.th-sortable.sort-asc::after {
      content: ' â†‘';
      font-size: 0.85em;
      opacity: 0.8;
    }
    thead th.th-sortable.sort-desc::after {
      content: ' â†“';
      font-size: 0.85em;
      opacity: 0.8;
    }

    .toolbar::-webkit-scrollbar {
      height: 6px
    }

    .toolbar::-webkit-scrollbar-thumb {
      background: #d7dde6;
      border-radius: 999px
    }

    .line {
      height: 1px;
      background: var(--border);
      margin: 8px 0
    }

    header strong {
      font-size: clamp(16px, 3.8vw, 18px);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 40vw
    }

    .chip {
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: #fff;
      color: var(--muted);
      font-size: 12px;
      white-space: nowrap
    }

    select,
    input,
    button {
      height: 38px;
      border: 1px solid var(--border);
      background: #fff;
      border-radius: 10px;
      padding: 0 12px;
      font: inherit;
      color: var(--ink)
    }

    button {
      background: var(--accent);
      color: #fff;
      border: none;
      cursor: pointer;
      font-weight: 500
    }

    button.secondary {
      background: #fff;
      color: var(--ink);
      border: 1px solid var(--border)
    }

    button:hover {
      opacity: 0.9
    }

    button.danger {
      background: var(--bad);
      color: #fff
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 8px;
      border-bottom: 2px solid var(--border);
      margin: 16px 0;
      overflow-x: auto
    }

    .tab {
      padding: 12px 20px;
      border: none;
      background: transparent;
      color: var(--muted);
      cursor: pointer;
      border-bottom: 3px solid transparent;
      white-space: nowrap;
      font-weight: 500;
      transition: all 0.2s
    }

    .tab:hover {
      color: var(--ink);
      background: #f8f9fa
    }

    .tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
      background: #fff
    }

    .tab-content {
      display: none
    }

    .tab-content.active {
      display: block
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 16px;
      margin: 12px 0
    }

    /* Tablo */
    .table-wrap {
      overflow: auto;
      border: 1px solid var(--border);
      border-radius: 12px
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      min-width: 900px
    }

    thead th {
      position: sticky;
      top: 0;
      background: #fafbfc;
      border-bottom: 2px solid var(--border);
      font-weight: 600;
      text-align: left;
      font-size: 13px;
      color: var(--muted);
      padding: 12px;
      z-index: 1
    }

    tbody td {
      border-bottom: 1px solid var(--border);
      padding: 12px;
      font-size: 14px
    }

    tbody tr:hover {
      background: #f8f9fa
    }

    .right {
      text-align: right
    }

    /* Modal */
    body.modal-open {
      overflow: hidden
    }

    .modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, .4);
      display: none;
      align-items: center;
      justify-content: center;
      padding: 16px;
      z-index: 9999;
      backdrop-filter: blur(4px);
      pointer-events: none
    }

    .modal.show {
      display: flex !important;
      pointer-events: auto !important
    }

    .modal.show .sheet {
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
      position: relative !important;
      z-index: 10001 !important;
      pointer-events: auto !important;
      animation: modalSheetIn 0.25s ease-out;
    }

    .modal.show {
      animation: modalBackdropIn 0.2s ease-out;
    }

    @keyframes modalBackdropIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes modalSheetIn {
      from {
        opacity: 0;
        transform: scale(0.95) translateY(-10px);
      }
      to {
        opacity: 1;
        transform: scale(1) translateY(0);
      }
    }

    .sheet {
      max-width: 700px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      background: #fff;
      border-radius: 16px;
      padding: 20px;
      border: 1px solid var(--border);
      box-shadow: 0 20px 40px rgba(0, 0, 0, .2);
      pointer-events: auto
    }

    .sheet-visible {
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
      position: relative !important;
      z-index: 10001 !important;
      pointer-events: auto !important
    }

    .sheet button,
    .sheet input,
    .sheet select,
    .sheet textarea,
    .sheet form {
      pointer-events: auto !important;
      z-index: 10002 !important;
      position: relative
    }

    .sheet h3 {
      margin: 0 0 16px 0;
      font-size: 20px;
      color: var(--ink)
    }

    /* Talep Onay modal: Eski / Yeni karÅŸÄ±laÅŸtÄ±rma */
    .talep-onay-sheet {
      max-width: 720px;
    }
    .talep-onay-ust {
      margin: 0 0 16px 0;
      color: var(--muted);
      font-size: 14px;
    }
    .talep-onay-karsilastirma {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-bottom: 16px;
    }
    .talep-onay-kolon {
      border-radius: 12px;
      padding: 12px;
      border: 1px solid var(--border);
    }
    .talep-onay-eski {
      background: #f8f9fa;
      border-color: #dee2e6;
    }
    .talep-onay-yeni {
      background: #e8f5e9;
      border-color: #a5d6a7;
    }
    .talep-onay-kolon h4 {
      margin: 0 0 10px 0;
      font-size: 13px;
      font-weight: 600;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.02em;
    }
    .talep-onay-icerik {
      font-size: 13px;
      line-height: 1.5;
    }
    .talep-onay-satir {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      padding: 4px 0;
      border-bottom: 1px solid rgba(0,0,0,.06);
    }
    .talep-onay-satir:last-child {
      border-bottom: none;
    }
    .talep-onay-satir .label {
      color: var(--muted);
      flex-shrink: 0;
    }
    .talep-onay-satir .value {
      text-align: right;
      word-break: break-word;
    }
    .talep-onay-aciklama-wrap {
      margin-bottom: 16px;
      padding: 10px 12px;
      background: #fffde7;
      border: 1px solid #f9a825;
      border-radius: 8px;
      font-size: 13px;
    }
    .talep-onay-aciklama-wrap strong {
      display: block;
      margin-bottom: 4px;
      color: var(--ink);
    }
    .talep-onay-aciklama {
      white-space: pre-wrap;
      word-wrap: break-word;
      max-height: 80px;
      overflow-y: auto;
    }
    @media (max-width: 600px) {
      .talep-onay-karsilastirma {
        grid-template-columns: 1fr;
      }
    }

    .form-grid {
      display: grid;
      gap: 14px
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 6px
    }

    .form-group label {
      font-size: 13px;
      font-weight: 600;
      color: var(--muted)
    }

    .form-group input,
    .form-group select {
      width: 100%;
      height: 42px;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 0 12px;
      font: inherit;
      font-size: 14px
    }

    .actions {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
      padding-top: 16px;
      border-top: 1px solid var(--border)
    }

    /* Ä°statistikler */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 12px;
      margin: 16px 0
    }

    .stat-card {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 8px
    }

    .stat-label {
      color: var(--muted);
      font-size: 12px;
      font-weight: 600
    }

    .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--ink)
    }

    /* Analiz Grafikleri */
    .chart-container {
      position: relative;
      height: 300px;
      margin: 16px 0
    }

    .progress-bar {
      height: 24px;
      background: #f0f0f0;
      border-radius: 12px;
      overflow: hidden;
      position: relative
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--good), var(--accent));
      transition: width 0.3s
    }

    .trend-up {
      color: var(--good);
      font-weight: 600
    }

    .trend-down {
      color: var(--bad);
      font-weight: 600
    }

    .trend-same {
      color: var(--muted);
      font-weight: 600
    }

    .badge-daimi {
      background: #e8f5e9;
      color: var(--good);
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600
    }

    .badge-yeni {
      background: #e3f2fd;
      color: #1976d2;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600
    }

    .badge-pasif {
      background: #fef3c7;
      color: #d97706;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600
    }


    /* Takvim Tab */
    .cal-wrapper {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 16px;
    }

    .cal-summary {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 20px;
      margin-top: 12px;
      padding: 16px;
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    .cal-summary-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      gap: 6px;
    }

    .cal-summary-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
    }

    .cal-summary-label::after {
      content: '';
      display: block;
      width: 24px;
      height: 1px;
      background: var(--border);
      margin: 6px auto 0;
    }

    .cal-summary-value {
      font-size: 18px;
      font-weight: 700;
      color: var(--text);
    }

    .cal-header {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border-radius: 12px;
      border: 1px solid var(--border);
    }

    .cal-header-title {
      font-size: 15px;
      font-weight: 600;
      color: var(--text);
    }

    .cal-header-legend {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-left: auto;
      font-size: 16px;
      color: var(--muted);
    }

    .cal-legend-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .cal-legend-dot {
      width: 10px;
      height: 10px;
      border-radius: 3px;
    }

    .cal-legend-dot { border-width: 3px; border-style: solid; }
    .cal-legend-dot.empty { background: #f5f5f5; border-color: #9e9e9e; }
    .cal-legend-dot.ready { background: #e8f5e9; border-color: #2e7d32; }
    .cal-legend-dot.warn { background: #fff8e1; border-color: #f57c00; }
    .cal-legend-dot.full { background: #ffebee; border-color: #c62828; }

    .cal-dow-row {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 6px;
    }

    .cal-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      grid-auto-rows: minmax(96px, auto);
      gap: 6px;
    }

    .cal-dow {
      text-align: center;
      font-size: 12px;
      font-weight: 700;
      color: var(--muted);
      padding: 10px 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .cal-day {
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px;
      background: #fff;
      cursor: pointer;
      min-height: 115px;
      display: flex;
      flex-direction: column;
      gap: 5px;
      font-size: 11px;
      transition: all 0.2s ease;
      box-shadow: 0 1px 2px rgba(0,0,0,0.04);
    }

    .cal-day:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border-color: var(--accent);
      z-index: 1;
    }

    /* Renk kodlamasÄ±: KalÄ±n sol border ile net ayrÄ±m */
    .cal-day.no-data {
      background: #fafafa;
      border: 1px solid #e0e0e0;
      border-left: 5px solid #9e9e9e;
    }

    .cal-day.no-data:hover {
      background: #f5f5f5;
    }

    .cal-day.has-data {
      background: #e8f5e9;
      border: 1px solid #a5d6a7;
      border-left: 5px solid #2e7d32;
    }

    .cal-day.capacity-warning {
      background: #fff8e1;
      border: 1px solid #ffe082;
      border-left: 5px solid #f57c00;
    }

    .cal-day.capacity-full {
      background: #ffebee;
      border: 1px solid #ef9a9a;
      border-left: 5px solid #c62828;
    }

    .cal-day.today {
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.4);
    }

    .cal-day.selected {
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.5);
      transform: translateY(-1px);
    }

    .cal-day.outside-ramazan {
      background: #f9fafb;
      color: var(--muted);
    }

    .cal-day-header {
      display: flex;
      align-items: baseline;
      gap: 5px;
      font-weight: 600;
      line-height: 1.1;
    }

    .cal-day-header .cal-day-num {
      font-size: 16px;
    }

    .cal-day-header .cal-day-ay {
      font-size: 13px;
      color: var(--text);
      font-weight: 600;
    }

    .cal-capacity-info {
      display: flex;
      flex-direction: column;
      gap: 3px;
    }

    .cal-capacity-item {
      display: flex;
      flex-direction: column;
      gap: 1px;
    }

    .cal-capacity-item .cal-capacity-label {
      font-size: 11px;
      font-weight: 600;
      color: var(--muted);
    }

    .cal-capacity-item .cal-capacity-text {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 0;
    }

    .cal-capacity-bar {
      width: 100%;
      height: 5px;
      background: rgba(0, 0, 0, 0.12);
      border-radius: 2px;
      overflow: hidden;
    }

    .cal-capacity-fill {
      height: 100%;
      background: var(--good);
      transition: width 0.3s;
    }

    .cal-capacity-fill.yakÄ±n {
      background: #ff9800;
    }

    .cal-capacity-fill.dolu {
      background: #f44336;
      cursor: default;
    }

    .badge-chip {
      padding: 4px 8px;
      border-radius: 4px;
      background: #f0f0f0;
      color: var(--ink);
      font-size: 11px;
      display: inline-block;
      margin: 2px
    }

    .badge-chip.iftar {
      background: #fff3cd;
      color: #856404
    }

    .badge-chip.sahur {
      background: #d1ecf1;
      color: #0c5460
    }

    /* GÃ¼n Detay Modal - Takvim */
    #modalCalDay .sheet {
      max-width: 960px;
    }

    #modalCalDay .cal-day-modal-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 16px;
      margin-bottom: 20px;
      padding-bottom: 16px;
      border-bottom: 2px solid var(--border);
      flex-wrap: wrap;
    }

    #modalCalDay .cal-day-modal-title-wrap {
      flex: 1;
      min-width: 200px;
    }

    #modalCalDay .cal-day-modal-title {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
      color: var(--text);
    }

    #modalCalDay .cal-day-modal-summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }

    #modalCalDay .cal-day-summary-card {
      padding: 14px 16px;
      border-radius: 10px;
      border-left: 4px solid;
      transition: transform 0.15s ease;
    }

    #modalCalDay .cal-day-summary-card:hover {
      transform: translateY(-1px);
    }

    #modalCalDay .cal-day-summary-card.iftar {
      background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
      border-left-color: #1976d2;
    }

    #modalCalDay .cal-day-summary-card.sahur {
      background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
      border-left-color: #f57c00;
    }

    #modalCalDay .cal-day-summary-card.tutar {
      background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
      border-left-color: #388e3c;
    }

    #modalCalDay .cal-day-summary-card.musafir {
      background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
      border-left-color: #7b1fa2;
    }

    #modalCalDay .cal-day-summary-label {
      font-size: 11px;
      color: var(--muted);
      margin-bottom: 4px;
      font-weight: 600;
    }

    #modalCalDay .cal-day-summary-value {
      font-size: 18px;
      font-weight: 700;
      color: var(--text);
    }

    #modalCalDay .cal-day-summary-sub {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }

    #modalCalDay .cal-day-section {
      margin-bottom: 24px;
    }

    #modalCalDay .cal-day-section h4 {
      margin: 0 0 12px 0;
      font-size: 14px;
      font-weight: 600;
      color: var(--text);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    #modalCalDay .cal-day-empty-msg {
      padding: 24px;
      text-align: center;
      color: var(--muted);
      background: #f8f9fa;
      border-radius: 10px;
      border: 1px dashed var(--border);
    }

    #modalCalDay .cal-day-modal-close {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: var(--muted);
      padding: 4px;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.2s;
      flex-shrink: 0;
    }

    #modalCalDay .cal-day-modal-close:hover {
      background: var(--hover);
      color: var(--text);
    }

    @media (max-width:768px) {
      .tabs {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch
      }

      .table-wrap {
        font-size: 12px
      }

      .cal-wrapper {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        padding-bottom: 8px;
      }

      .cal-wrapper::-webkit-scrollbar {
        height: 6px;
      }

      .cal-dow-row {
        min-width: 480px;
        gap: 6px;
      }

      .cal-grid {
        min-width: 480px;
        grid-auto-rows: minmax(88px, auto);
      }

      .cal-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .cal-header-legend {
        margin-left: 0;
      }

      .cal-day {
        min-height: 88px;
        padding: 6px;
        font-size: 10px;
        flex-shrink: 0;
      }

      .cal-day-header {
        flex-wrap: nowrap;
      }

      .cal-day-header .cal-day-num {
        font-size: 14px;
      }

      .cal-day-header .cal-day-ay {
        font-size: 11px;
        white-space: nowrap;
      }

      .cal-capacity-item .cal-capacity-label,
      .cal-capacity-item .cal-capacity-text {
        font-size: 8px;
      }

      .cal-capacity-bar {
        height: 3px;
      }

      #modalCalDay .cal-day-modal-summary-grid {
        grid-template-columns: 1fr 1fr;
      }

      #modalCalDay .cal-day-summary-value {
        font-size: 15px;
      }
    }
  </style>

  <!-- Supabase (Auth + Database iÃ§in) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="../src/supabase.js"></script>
  <script src="../src/supabase-auth-wrapper.js"></script>
  <script src="../src/supabase-db-wrapper.js"></script>

  <!-- Ortak JS (navigation, toast, vs) -->
  <script>
    // Supabase client initialization
    (function () {
      const SUPABASE_URL = 'https://lmwfibippjvqctccxiwb.supabase.co';
      const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxtd2ZpYmlwcGp2cWN0Y2N4aXdiIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NjE2NzA1NCwiZXhwIjoyMDgxNzQzMDU0fQ.lzoudrJx_V4RdCCxPRfgLA1riWNKZ3HyFzeqRynYHeQ';

      function initSupabaseClient() {
        if (typeof supabase !== 'undefined' && typeof supabase.createClient === 'function') {
          window.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
          console.log('âœ… Supabase client oluÅŸturuldu');
          return true;
        }
        return false;
      }

      if (!initSupabaseClient()) {
        // Script yÃ¼klenene kadar bekle
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
        script.onload = () => {
          if (initSupabaseClient()) {
            // Supabase hazÄ±r olduÄŸunda ortak.js'i yÃ¼kle
            loadOrtakJs();
          }
        };
        document.head.appendChild(script);
      } else {
        // Supabase zaten hazÄ±r, ortak.js'i yÃ¼kle
        loadOrtakJs();
      }

      function loadOrtakJs() {
        if (document.querySelector('script[src*="ortak.js"]')) return; // Zaten yÃ¼klenmiÅŸ
        const script = document.createElement('script');
        script.src = '../js/ortak.js';
        script.defer = true;
        if (document.body) {
          document.body.appendChild(script);
        } else {
          document.addEventListener('DOMContentLoaded', () => {
            document.body.appendChild(script);
          });
        }
      }
    })();
  </script>
</head>

<body>

  <!-- ÃœST APPBAR (hedef-grafik.html ile aynÄ± yapÄ±) -->
  <div class="appbar">
    <div class="brand" onclick="location.href='../panel.html'">
      <img src="../img/logo.png" alt="logo"><span>KARAAÄAÃ‡ FATÄ°H</span>
    </div>
    <nav class="nav-center">
      <ul class="nav-list" id="navMain"></ul>
    </nav>
    <div class="nav-right">
      <button class="btn hamb" id="hamburger" title="MenÃ¼">â˜°</button>

      <!-- Bildirim -->
      <div class="nav-item">
        <button class="iconbtn" id="btnNotif" title="Bildirimler">ğŸ””
          <span class="badge" id="notifBadge" style="display:none">0</span>
        </button>
        <div class="dropdown drop-right" id="notifDropdown" aria-label="Bildirim listesi">
          <div class="muted" style="padding:6px 8px">Son bildirimler</div>
          <div id="notifList" class="list" style="max-height:300px;overflow:auto"></div>
        </div>
      </div>

      <!-- Profil -->
      <div class="nav-item">
        <button class="iconbtn" id="btnProfile" title="Profil">
          <span class="avatar"></span> <span id="profName" class="muted">Profil</span>
        </button>
        <div class="dropdown drop-right" id="profDropdown" aria-label="Profil menÃ¼sÃ¼">
          <a href="../diger/kullanici-yonetimi.html">ğŸ‘¤ Profil</a>
          <a href="../diger/sistem-ayarlari.html">âš™ï¸ Sistem AyarlarÄ±</a>
          <a href="#" id="btnLogout">ğŸšª Ã‡Ä±kÄ±ÅŸ Yap</a>
        </div>
      </div>
    </div>
  </div>
  <aside class="drawer" id="drawer"></aside>
  <div class="toast-container" id="toastContainer"></div>

  <!-- Progress Bar -->
  <div class="progress-container" id="progressContainer">
    <div class="progress-bar-fill" id="progressBar"></div>
  </div>

  <main class="wrap">
    <div class="tabs">
      <button class="tab active" data-tab="kayitlar">ğŸ“‹ KayÄ±tlar</button>
      <button class="tab" data-tab="talepler">ğŸ“ Talepler</button>
      <button class="tab" data-tab="menu">ğŸ½ï¸ MenÃ¼</button>
      <button class="tab" data-tab="takvim">ğŸ“… Takvim GÃ¶rÃ¼nÃ¼mÃ¼</button>
      <button class="tab" data-tab="ayarlar">âš™ï¸ Ayarlar</button>
      <button class="tab" data-tab="hedef">ğŸ¯ Hedef YÃ¶netimi</button>
      <button class="tab" data-tab="veri-duzenleme">âœï¸ Veri DÃ¼zenleme</button>
      <button class="tab" data-tab="istatistik">ğŸ“Š Ä°statistikler</button>
      <button class="tab" data-tab="export">ğŸ“¤ Ä°Ã§e/DÄ±ÅŸa Aktar</button>
    </div>

    <!-- Tab: KayÄ±tlar -->
    <div class="tab-content active" id="tab-kayitlar">
      <div class="card">
        <div class="toolbar kayitlar-filtre">
          <select id="filtreYil">
            <option value="2024">2024</option>
            <option value="2025" selected>2025</option>
            <option value="2026">2026</option>
          </select>
          <select id="filtreAy">
            <option value="">TÃ¼m Aylar</option>
          </select>
          <select id="filtreTip">
            <option value="">TÃ¼m Tipler</option>
            <option value="iftar">Ä°ftar</option>
            <option value="sahur">Sahur</option>
            <option value="teberru">Teberru</option>
            <option value="taahhut">TaahhÃ¼t</option>
          </select>
          <select id="filtreTarih" style="display:none;">
            <option value="">TÃ¼m Tarihler</option>
          </select>
          <input type="text" id="araInput" placeholder="Sahip, Personel ara..." style="flex:1;min-width:460px" />
          <button onclick="filterKayitlar()">Filtrele</button>
          <button class="good" onclick="openEditModal()">+ Yeni KayÄ±t</button>
        </div>

        <div class="table-wrap">
          <table id="tblKayitlar">
            <thead>
              <tr>
                <th class="th-sortable" data-sort="islemTarihi" data-label="Ä°ÅŸlem Tarihi">Ä°ÅŸlem Tarihi</th>
                <th class="th-sortable" data-sort="tarih" data-label="Tarih">Tarih</th>
                <th class="th-sortable" data-sort="tip" data-label="Tip">Tip</th>
                <th class="th-sortable" data-sort="sahip" data-label="Sahip">Sahip</th>
                <th class="th-sortable" data-sort="tutar" data-label="Tutar (â‚º)">Tutar (â‚º)</th>
                <th data-label="Tahsilat">Tahsilat / Kalan</th>
                <th class="th-sortable" data-sort="istirak" data-label="Ä°ÅŸtirak">Ä°ÅŸtirak</th>
                <th class="th-sortable" data-sort="musafirAdedi" data-label="MÃ¼safir">MÃ¼safir</th>
                <th class="th-sortable" data-sort="mahal" data-label="Mahal">Mahal</th>
                <th class="th-sortable" data-sort="personel" data-label="Personel">Personel</th>
                <th class="th-sortable" data-sort="notlar" data-label="Not">Not</th>
                <th data-label="Ä°ÅŸlemler">Ä°ÅŸlemler</th>
              </tr>
            </thead>
            <tbody id="tbodyKayitlar"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Tab: Talepler -->
    <div class="tab-content" id="tab-talepler">
      <div class="card">
        <div class="toolbar">
          <select id="taleplerFiltreYil">
            <option value="2024">2024</option>
            <option value="2025" selected>2025</option>
            <option value="2026">2026</option>
          </select>
          <select id="taleplerFiltreDurum">
            <option value="" selected>Otomatik &gt; TÃ¼m Durumlar</option>
            <option value="beklemede">Beklemede</option>
            <option value="onaylandi">OnaylandÄ±</option>
            <option value="reddedildi">Reddedildi</option>
          </select>
          <select id="taleplerFiltreTip">
            <option value="">TÃ¼m Tipler</option>
            <option value="duzenle">DÃ¼zenle</option>
            <option value="yer_degistir">Yer DeÄŸiÅŸtir</option>
            <option value="sil">Sil</option>
          </select>
          <input type="text" id="taleplerAraInput" placeholder="Personel, Sahip ara..."
            style="flex:1;min-width:200px" />
          <button onclick="filterTalepler()">Filtrele</button>
          <button onclick="loadTalepler()">ğŸ”„ Yenile</button>
        </div>

        <div class="table-wrap">
          <table id="tblTalepler">
            <thead>
              <tr>
                <th>Talep Tarihi</th>
                <th>Tip</th>
                <th>Talep Tipi</th>
                <th>KayÄ±t Tipi</th>
                <th>Sahip</th>
                <th>Mevcut Tarih</th>
                <th>MÃ¼safir</th>
                <th>Tutar</th>
                <th>Ä°ÅŸtirak</th>
                <th>Mahal</th>
                <th>Personel</th>
                <th>AÃ§Ä±klama</th>
                <th>Yeni Tarih</th>
                <th>Durum</th>
                <th style="width:180px">Ä°ÅŸlemler</th>
              </tr>
            </thead>
            <tbody id="tbodyTalepler"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Tab: MenÃ¼ -->
    <div class="tab-content" id="tab-menu">
      <div class="card">
        <div class="toolbar">
          <select id="menuFiltreYil">
            <option value="2024">2024</option>
            <option value="2025" selected>2025</option>
            <option value="2026">2026</option>
          </select>
          <select id="menuFiltreTip">
            <option value="">TÃ¼m Tipler</option>
            <option value="iftar">Ä°ftar</option>
            <option value="sahur">Sahur</option>
          </select>
          <input type="date" id="menuFiltreTarih" style="margin-right:8px" />
          <button onclick="filterMenuler()">Filtrele</button>
          <button onclick="loadMenuler()">ğŸ”„ Yenile</button>
          <button class="good" onclick="openMenuModal()">+ Yeni MenÃ¼ Ekle</button>
        </div>

        <div class="table-wrap" style="margin-top:16px">
          <table id="tblMenuler">
            <thead>
              <tr>
                <th>Tarih</th>
                <th>Tip</th>
                <th>Ã‡orba</th>
                <th>Yemek</th>
                <th>SoÄŸuk</th>
                <th>Ä°Ã§ecek</th>
                <th>DiÄŸer</th>
                <th style="width:120px">Ä°ÅŸlemler</th>
              </tr>
            </thead>
            <tbody id="tbodyMenuler"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Tab: Takvim GÃ¶rÃ¼nÃ¼mÃ¼ -->
    <div class="tab-content" id="tab-takvim">
      <div class="card">
        <div class="toolbar" style="flex-wrap:wrap;gap:12px">
          <div style="display:flex;align-items:center;gap:8px">
            <label for="calYil" style="font-size:13px;font-weight:600;color:var(--muted)">YÄ±l:</label>
            <select id="calYil" style="min-width:100px">
              <option value="2024">2024</option>
              <option value="2025" selected>2025</option>
              <option value="2026">2026</option>
            </select>
          </div>
          <button onclick="renderCalView()" class="good">ğŸ“… Takvimi YÃ¼kle</button>
        </div>

        <div class="cal-wrapper">
          <div class="cal-header" id="calHeader" style="display:none">
            <span class="cal-header-title" id="calHeaderTitle">Ramazan-Ä± Åerif 2025</span>
            <div class="cal-header-legend">
              <span class="cal-legend-item"><span class="cal-legend-dot empty"></span> BoÅŸ</span>
              <span class="cal-legend-item"><span class="cal-legend-dot ready"></span> KayÄ±t Var</span>
              <span class="cal-legend-item"><span class="cal-legend-dot warn"></span> Kapasite YakÄ±n</span>
              <span class="cal-legend-item"><span class="cal-legend-dot full"></span> Kapasite Dolu</span>
            </div>
          </div>
          <div class="cal-summary" id="calSummary" style="display:none">
            <div class="cal-summary-item">
              <span class="cal-summary-label">Toplam Ä°ftar</span>
              <span class="cal-summary-value" id="calSummaryIftar">0</span>
            </div>
            <div class="cal-summary-item">
              <span class="cal-summary-label">Toplam Sahur</span>
              <span class="cal-summary-value" id="calSummarySahur">0</span>
            </div>
            <div class="cal-summary-item">
              <span class="cal-summary-label">Ä°ftar MÃ¼safir Adedi</span>
              <span class="cal-summary-value" id="calSummaryIftarMusafir">0</span>
            </div>
          </div>
          <div class="cal-dow-row">
            <div class="cal-dow">Pzt</div>
            <div class="cal-dow">Sal</div>
            <div class="cal-dow">Ã‡ar</div>
            <div class="cal-dow">Per</div>
            <div class="cal-dow">Cum</div>
            <div class="cal-dow">Cmt</div>
            <div class="cal-dow">Paz</div>
          </div>
          <div class="cal-grid" id="calViewGrid"></div>
        </div>
      </div>
    </div>

    <!-- Tab: Ä°statistikler -->
    <div class="tab-content" id="tab-istatistik">
      <div class="card">
        <div class="toolbar">
          <select id="statYil">
            <option value="2024">2024</option>
            <option value="2025" selected>2025</option>
            <option value="2026">2026</option>
          </select>
          <button onclick="loadStatistics()">YÃ¼kle</button>
        </div>

        <div class="stats-grid" id="statsGrid"></div>

        <div class="card" style="margin-top:16px">
          <h3 style="margin:0 0 12px 0">AylÄ±k DaÄŸÄ±lÄ±m</h3>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Ay</th>
                  <th>Ä°ftar</th>
                  <th>Sahur</th>
                  <th>Toplam Tutar (â‚º)</th>
                  <th>Toplam MÃ¼safir</th>
                </tr>
              </thead>
              <tbody id="tbodyAylik"></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Tab: Ayarlar -->
    <div class="tab-content" id="tab-ayarlar">
      <!-- Ramazan-Ä± Åerif YÄ±llarÄ± -->
      <div class="card">
        <div class="toolbar">
          <h3 style="margin:0">Ramazan-Ä± Åerif YÄ±llarÄ±</h3>
          <div style="flex:1"></div>
          <button class="good" onclick="openRamazanModal()">+ Yeni Ramazan YÄ±lÄ±</button>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>YÄ±l</th>
                <th>BaÅŸlangÄ±Ã§ Tarihi</th>
                <th>BitiÅŸ Tarihi</th>
                <th>Hicri YÄ±l</th>
                <th>Durum</th>
                <th style="width:120px">Ä°ÅŸlemler</th>
              </tr>
            </thead>
            <tbody id="tbodyRamazan"></tbody>
          </table>
        </div>
      </div>

      <!-- Mahal AyarlarÄ± -->
      <div class="card" style="margin-top:16px">
        <div class="toolbar">
          <h3 style="margin:0">Mahal AyarlarÄ±</h3>
          <div style="flex:1"></div>
          <button class="good" onclick="openMahalModal()">+ Yeni Mahal Ekle</button>
        </div>

        <div id="mahalList" style="margin-top:16px"></div>
      </div>

      <!-- Tutar AyarlarÄ± -->
      <div class="card" style="margin-top:16px">
        <div class="toolbar">
          <h3 style="margin:0">Tutar AyarlarÄ±</h3>
          <div style="flex:1"></div>
          <select id="tutarYil" style="margin-right:8px">
            <option value="2024">2024</option>
            <option value="2025" selected>2025</option>
            <option value="2026">2026</option>
          </select>
          <button class="good" onclick="openTutarModal()">+ Yeni Tutar SeÃ§eneÄŸi</button>
        </div>

        <div class="table-wrap" style="margin-top:16px">
          <table>
            <thead>
              <tr>
                <th>SÄ±ra</th>
                <th>Tutar (â‚º)</th>
                <th>Etiket</th>
                <th>Tip</th>
                <th>Durum</th>
                <th style="width:120px">Ä°ÅŸlemler</th>
              </tr>
            </thead>
            <tbody id="tbodyTutar"></tbody>
          </table>
        </div>
      </div>

      <!-- Kapasite AyarlarÄ± -->
      <div class="card" style="margin-top:16px">
        <div class="toolbar">
          <h3 style="margin:0">Kapasite AyarlarÄ±</h3>
          <div style="flex:1"></div>
          <select id="kapasiteYil" style="margin-right:8px">
            <option value="">YÄ±l seÃ§iniz...</option>
          </select>
          <button class="good" onclick="openGenelKapasiteModal()">âš™ï¸ Genel Kapasite</button>
          <button class="good" onclick="openKapasiteModal()">+ GÃ¼nlÃ¼k Kapasite</button>
        </div>

        <div class="card" style="margin-top:16px">
          <h4 style="margin:0 0 12px 0">Genel Kapasite AyarlarÄ±</h4>
          <div id="genelKapasiteInfo" style="padding:12px;background:#f8f9fa;border-radius:8px;margin-bottom:12px">
            <p style="margin:0;color:var(--muted);font-size:13px">Genel kapasite tÃ¼m gÃ¼nler iÃ§in geÃ§erlidir. GÃ¼nlÃ¼k Ã¶zel
              kapasite varsa o gÃ¼n iÃ§in Ã¶zel kapasite kullanÄ±lÄ±r.</p>
            <div id="genelKapasiteDisplay" style="margin-top:8px"></div>
          </div>
        </div>

        <div class="card" style="margin-top:16px">
          <h4 style="margin:0 0 12px 0">GÃ¼nlÃ¼k Kapasite AyarlarÄ±</h4>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Tarih</th>
                  <th>Ä°ftar Max</th>
                  <th>Sahur Max</th>
                  <th style="width:120px">Ä°ÅŸlemler</th>
                </tr>
              </thead>
              <tbody id="tbodyKapasite"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Hedef YÃ¶netimi -->
      <div class="card" style="margin-top:16px">
        <div class="toolbar">
          <h3 style="margin:0">ğŸ¯ Personel Hedef YÃ¶netimi</h3>
          <div style="flex:1"></div>
          <select id="hedefYonetimYil" style="margin-right:8px">
            <option value="2024">2024</option>
            <option value="2025" selected>2025</option>
            <option value="2026">2026</option>
          </select>
          <button class="good" onclick="loadPersonelHedefleri()">ğŸ”„ Yenile</button>
          <button class="good" onclick="openPersonelHedefModal()">+ Hedef Ekle</button>
        </div>

        <div
          style="padding:12px;background:#f0f7ff;border-left:4px solid var(--accent);border-radius:8px;margin-top:12px">
          <p style="margin:0;color:var(--muted);font-size:13px;line-height:1.6">
            <strong>ğŸ’¡ Bilgi:</strong> Personellere yÄ±llÄ±k hedef belirleyebilir ve dÃ¼zenleyebilirsiniz.
          </p>
        </div>

        <div class="table-wrap" style="margin-top:16px">
          <table>
            <thead>
              <tr>
                <th>Personel</th>
                <th>YÄ±l</th>
                <th>Hedef (â‚º)</th>
                <th style="width:120px">Ä°ÅŸlemler</th>
              </tr>
            </thead>
            <tbody id="tbodyPersonelHedefleri"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Tab: Hedef YÃ¶netimi -->
    <div class="tab-content" id="tab-hedef">
      <!-- Veri YÃ¼kleme -->
      <div class="card">
        <div class="toolbar">
          <h3 style="margin:0">ğŸ“¥ Veri YÃ¼kleme</h3>
          <div style="flex:1"></div>
          <button class="good" onclick="openVeriYukleModal()">+ Veri YÃ¼kle</button>
          <button class="warning" onclick="openVeriTemizleModal()"
            style="background:#fff3cd;color:#856404;border-color:#ffc107">ğŸ—‘ï¸ Veri Temizle</button>
          <button class="secondary" onclick="downloadVeriSablon()">ğŸ“„ Åablon Ä°ndir</button>
        </div>
        <div style="padding:12px;background:#f8f9fa;border-radius:8px;margin-top:12px">
          <p style="margin:0;color:var(--muted);font-size:13px;line-height:1.6">
            <strong>ğŸ“‹ Format:</strong> CSV dosyasÄ± yÄ±llÄ±k veriler iÃ§ermelidir.<br>
            <strong>Kolonlar:</strong> YÄ±l, Tip (iftar/sahur/taahhÃ¼t/teberru), Sahip (kiÅŸi adÄ±), DiÄŸer (aÃ§Ä±klama/ara
            kiÅŸi), Tutar (virgÃ¼l destekli, Ã¶rn: 10.000,50), Referans<br>
            <strong>Ã–rnek:</strong> 2023,iftar,Ali GÃ¶vercin,Mehmet Kara,10000.50,Muhsin Ã‡elik
          </p>
          <p style="margin:8px 0 0 0;color:var(--muted);font-size:12px;line-height:1.5">
            <strong>ğŸ’¡ Not:</strong> "DiÄŸer" kÄ±smÄ± ara kiÅŸi bilgisi iÃ§in kullanÄ±lÄ±r. Ã–rn: Ä°ftar sahibi Ali GÃ¶vercin,
            DiÄŸer Mehmet Kara, Referans Muhsin Ã‡elik = Muhsin Ã‡elik, Mehmet Kara vasÄ±tasÄ±yla Ali GÃ¶vercin'den iftar
            almÄ±ÅŸ.
          </p>
        </div>
      </div>

      <!-- Genel Ã–zet Dashboard -->
      <div class="card" style="margin-top:16px">
        <h3 style="margin:0 0 16px 0">ğŸ“Š 3 YÄ±llÄ±k Genel Ã–zet</h3>
        <div class="toolbar">
          <select id="analizYil">
            <option value="2023">2023</option>
            <option value="2024">2024</option>
            <option value="2025" selected>2025</option>
            <option value="tumu">TÃ¼m YÄ±llar</option>
          </select>
          <button onclick="loadAnalizDashboard()">Yenile</button>
        </div>
        <div id="analizDashboard" style="margin-top:16px"></div>
      </div>

      <!-- Personel/Referans BazlÄ± DetaylÄ± Analiz -->
      <div class="card" style="margin-top:16px">
        <h3 style="margin:0 0 16px 0">ğŸ‘¥ Personel/Referans BazlÄ± DetaylÄ± Analiz</h3>
        <div class="toolbar">
          <input type="text" id="personelAra" placeholder="Personel/Referans adÄ± ara..."
            style="flex:1;min-width:200px" />
          <select id="personelFiltreYil">
            <option value="">TÃ¼m YÄ±llar</option>
            <option value="2023">2023</option>
            <option value="2024">2024</option>
            <option value="2025">2025</option>
          </select>
          <select id="personelFiltreTip">
            <option value="">TÃ¼m Tipler</option>
            <option value="iftar">Ä°ftar</option>
            <option value="sahur">Sahur</option>
            <option value="taahhut">TaahhÃ¼t</option>
            <option value="teberru">Teberru</option>
          </select>
          <button onclick="loadPersonelAnalizi()">Ara</button>
        </div>
        <div id="personelAnalizList" style="margin-top:16px"></div>
      </div>

      <!-- KiÅŸi BazlÄ± Analiz -->
      <div class="card" style="margin-top:16px">
        <h3 style="margin:0 0 16px 0">ğŸ‘¤ KiÅŸi BazlÄ± DetaylÄ± Analiz</h3>
        <div class="toolbar">
          <input type="text" id="kisiAra" placeholder="KiÅŸi adÄ± ara..." style="flex:1;min-width:200px" />
          <select id="kisiFiltreTip">
            <option value="">TÃ¼m Tipler</option>
            <option value="iftar">Ä°ftar</option>
            <option value="sahur">Sahur</option>
            <option value="taahhut">TaahhÃ¼t</option>
            <option value="teberru">Teberru</option>
          </select>
          <button onclick="loadKisiAnalizi()">Ara</button>
        </div>
        <div id="kisiAnalizList" style="margin-top:16px"></div>
      </div>

      <!-- Trend Analizi -->
      <div class="card" style="margin-top:16px">
        <h3 style="margin:0 0 16px 0">ğŸ“ˆ Trend Analizi</h3>
        <div id="trendAnaliz" style="margin-top:16px"></div>
      </div>

      <!-- Kategori Analizi -->
      <div class="card" style="margin-top:16px">
        <h3 style="margin:0 0 16px 0">ğŸ·ï¸ BaÄŸÄ±ÅŸÃ§Ä± Kategorileri</h3>
        <div id="kategoriAnaliz" style="margin-top:16px"></div>
      </div>

      <!-- Hedef TanÄ±mlama -->
      <div class="card" style="margin-top:16px">
        <div class="toolbar">
          <h3 style="margin:0">ğŸ“Š 2026 Hedef TanÄ±mlama</h3>
          <div style="flex:1"></div>
          <button class="good" onclick="loadHedefTanÄ±mlama()">ğŸ”„ Yenile</button>
          <button class="good" onclick="kaydetHedefler()" id="btnKaydetHedefler">ğŸ’¾ 2026 Hedefleri Kaydet</button>
          <div id="hedefUyariMesaji"
            style="display:none;padding:12px;margin-top:12px;border-radius:8px;background:#fff3cd;border-left:4px solid #ffc107">
          </div>
        </div>

        <!-- Genel Kurumsal Hedef -->
        <div
          style="margin-top:20px;padding:16px;background:#f0f7ff;border-left:4px solid var(--accent);border-radius:8px">
          <h4 style="margin:0 0 12px 0;font-size:18px">ğŸ¢ Kurumsal Genel Hedef</h4>

          <!-- 2025 GerÃ§ekleÅŸen Toplam -->
          <div style="margin-bottom:16px;padding:12px;background:#fff;border-radius:8px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <strong style="font-size:14px">2025 GerÃ§ekleÅŸen Toplam:</strong>
              <span id="hedef2025Toplam" style="font-size:20px;font-weight:700;color:var(--good)">â‚º0,00</span>
            </div>
            <div id="hedef2025Detay" style="font-size:12px;color:var(--muted);margin-top:4px"></div>
          </div>

          <!-- 2026 Genel Hedef GiriÅŸi -->
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px">
            <div>
              <label style="display:block;margin-bottom:6px;font-size:13px;font-weight:600">2026 Genel Hedef (â‚º)
                *</label>
              <input type="text" id="hedef2026Genel" placeholder="100.000,50"
                style="width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;font-size:16px;font-weight:600" />
              <small style="color:var(--muted);font-size:11px;margin-top:4px;display:block">VirgÃ¼l destekli format:
                100.000,50</small>
            </div>
            <div>
              <label style="display:block;margin-bottom:6px;font-size:13px;font-weight:600">Otomatik ArtÄ±ÅŸ
                YÃ¼zdesi</label>
              <input type="text" id="hedef2026ArtisYuzde" readonly
                style="width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;font-size:16px;font-weight:600;background:#f8f9fa;color:var(--accent)" />
            </div>
          </div>

          <!-- Tip BazlÄ± Hedefler ve ArtÄ±ÅŸlar -->
          <div style="margin-top:16px">
            <h5 style="margin:0 0 12px 0;font-size:14px">Tip BazlÄ± Hedefler ve ArtÄ±ÅŸ Ã–nerileri</h5>
            <div class="table-wrap">
              <table>
                <thead>
                  <tr>
                    <th>Tip</th>
                    <th>2025 GerÃ§ekleÅŸen</th>
                    <th>2026 Hedef (â‚º)</th>
                    <th>ArtÄ±ÅŸ YÃ¼zdesi</th>
                    <th>ArtÄ±ÅŸ TutarÄ± (â‚º)</th>
                  </tr>
                </thead>
                <tbody id="hedefTipBazlÄ±Body"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Personel BazlÄ± Hedefler -->
        <div style="margin-top:24px;padding:16px;background:#fff8f0;border-left:4px solid #ff9800;border-radius:8px">
          <h4 style="margin:0 0 12px 0;font-size:18px">ğŸ‘¥ Personel BazlÄ± Hedefler</h4>
          <p style="margin:0 0 16px 0;font-size:12px;color:var(--muted);line-height:1.5">
            Her personel iÃ§in Ã¶nceki yÄ±llarÄ±n verilerine gÃ¶re otomatik artÄ±ÅŸ hesaplanÄ±r. Hedefleri manuel olarak
            dÃ¼zenleyebilirsiniz.
          </p>

          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Personel</th>
                  <th>2023</th>
                  <th>2024</th>
                  <th>2025</th>
                  <th>2026 Hedef (Toplam)</th>
                  <th>Ä°ftar Hedefi</th>
                  <th>Sahur Hedefi</th>
                  <th>TaahhÃ¼t Hedefi</th>
                  <th>Teberru Hedefi</th>
                  <th>ArtÄ±ÅŸ YÃ¼zdesi</th>
                </tr>
              </thead>
              <tbody id="hedefPersonelBody"></tbody>
              <tfoot id="hedefPersonelToplam" style="display:none">
                <tr style="background:#f8f9fa;font-weight:700">
                  <td><strong>TOPLAM</strong></td>
                  <td id="toplam2023">-</td>
                  <td id="toplam2024">-</td>
                  <td id="toplam2025">-</td>
                  <td id="toplam2026Hedef">-</td>
                  <td id="toplamIftar">-</td>
                  <td id="toplamSahur">-</td>
                  <td id="toplamTaahhut">-</td>
                  <td id="toplamTeberru">-</td>
                  <td id="toplamArtis">-</td>
                </tr>
                <tr style="background:#fff3cd;font-weight:600;border-top:2px solid #ffc107">
                  <td colspan="9" style="text-align:right;padding:8px">
                    <strong>Genel Hedef (2026):</strong>
                  </td>
                  <td id="genelHedefToplam" style="font-weight:700;color:var(--accent)">-</td>
                </tr>
                <tr style="background:#f0f7ff;font-weight:600;border-top:2px solid var(--accent)">
                  <td colspan="9" style="text-align:right;padding:8px">
                    <strong>Fark (Personel Toplam - Genel Hedef):</strong>
                  </td>
                  <td id="hedefFark" style="font-weight:700">-</td>
                </tr>
              </tfoot>
            </table>
          </div>
        </div>
      </div>
    </div>

    <!-- Tab: Veri DÃ¼zenleme -->
    <div class="tab-content" id="tab-veri-duzenleme">
      <div class="card">
        <h3 style="margin:0 0 16px 0">âœï¸ Veri DÃ¼zenleme</h3>
        <div class="toolbar">
          <select id="duzenleYil" style="min-width:150px">
            <option value="2023" selected>2023</option>
            <option value="2024">2024</option>
            <option value="2025">2025</option>
          </select>
          <select id="duzenleTip" style="min-width:150px">
            <option value="">TÃ¼m Tipler</option>
            <option value="iftar">Ä°ftar</option>
            <option value="sahur">Sahur</option>
            <option value="taahhut">TaahhÃ¼t</option>
            <option value="teberru">Teberru</option>
          </select>
          <input type="text" id="duzenleAra" placeholder="Sahip, Personel, Referans ara..."
            style="flex:1;min-width:200px" />
          <button onclick="loadVeriDuzenleme()">Yenile</button>
        </div>
        <div id="veriDuzenlemeList" style="margin-top:16px"></div>
      </div>
    </div>

    <!-- Tab: Ä°Ã§e/DÄ±ÅŸa Aktar -->
    <div class="tab-content" id="tab-export">
      <div class="card">
        <h3 style="margin:0 0 16px 0">DÄ±ÅŸa Aktar (CSV)</h3>
        <div class="toolbar">
          <select id="exportYil">
            <option value="2024">2024</option>
            <option value="2025" selected>2025</option>
            <option value="2026">2026</option>
          </select>
          <button class="good" onclick="exportCSV()">CSV Olarak Ä°ndir</button>
        </div>

        <div class="card" style="margin-top:16px">
          <h3 style="margin:0 0 16px 0">Ä°Ã§e Aktar (CSV)</h3>
          <div class="form-group">
            <label>CSV DosyasÄ± SeÃ§in</label>
            <input type="file" id="importFile" accept=".csv" />
            <small style="color:var(--muted);margin-top:4px">
              Format: Tarih,Tip,Sahip,Tutar,Ä°ÅŸtirak,MÃ¼safirAdedi,Personel
            </small>
          </div>
          <button onclick="importCSV()">Ä°Ã§e Aktar</button>
        </div>
      </div>
    </div>
  </main>

  <!-- Modal: KayÄ±t DÃ¼zenle -->
  <div class="modal" id="modalEdit">
    <div class="sheet">
      <h3 id="editTitle">Yeni KayÄ±t</h3>
      <form id="formEdit" class="form-grid">
        <input type="hidden" id="editId" />
        <div class="form-group" id="editGroupTarih">
          <label>Tarih *</label>
          <input type="date" id="editTarih" required />
        </div>
        <div class="form-group" id="editGroupTarihSelect" style="display:none;">
          <label>Tarih *</label>
          <select id="editTarihSelect" required>
            <option value="">Tarih SeÃ§iniz</option>
          </select>
        </div>
        <div class="form-group">
          <label>Tip *</label>
          <select id="editTip" required>
            <option value="">SeÃ§iniz</option>
            <option value="iftar">Ä°ftar</option>
            <option value="sahur">Sahur</option>
            <option value="teberru">Teberru</option>
            <option value="taahhut">TaahhÃ¼t</option>
          </select>
        </div>
        <div class="form-group">
          <label>Personel</label>
          <select id="editPersonel">
            <option value="">Personel SeÃ§iniz</option>
          </select>
        </div>

        <!-- Ä°ftar/Sahur AlanlarÄ± -->
        <div class="form-group" id="editGroupSahip" style="display:none;">
          <label>Sahip *</label>
          <input type="text" id="editSahip" />
        </div>
        <div class="form-group" id="editGroupTutar" style="display:none;">
          <label>Tutar (â‚º) *</label>
          <input type="number" id="editTutar" min="0" step="0.01" />
        </div>
        <div class="form-group" id="editGroupIstirak" style="display:none;">
          <label>Ä°ÅŸtirak</label>
          <select id="editIstirak">
            <option value="true">Evet</option>
            <option value="false">HayÄ±r</option>
          </select>
        </div>
        <div class="form-group" id="editGroupMusafir" style="display:none;">
          <label>MÃ¼safir Adedi *</label>
          <input type="number" id="editMusafir" min="0" />
        </div>
        <div class="form-group" id="editGroupMahal" style="display:none;">
          <label>Mahal</label>
          <select id="editMahal">
            <option value="">Mahal SeÃ§iniz</option>
          </select>
        </div>

        <!-- Teberru/TaahhÃ¼t AlanlarÄ± -->
        <div class="form-group" id="editGroupBagisci" style="display:none;">
          <label>BaÄŸÄ±ÅŸÃ§Ä± AdÄ± *</label>
          <input type="text" id="editBagisci" />
        </div>
        <div class="form-group" id="editGroupMiktar" style="display:none;">
          <label>Para MiktarÄ± (â‚º) *</label>
          <input type="number" id="editMiktar" min="0" step="0.01" />
        </div>
        <div class="form-group" id="editGroupOdeme" style="display:none;">
          <label>Ã–deme YÃ¶ntemi *</label>
          <select id="editOdeme">
            <option value="">SeÃ§iniz</option>
            <option value="nakit">ğŸ’µ Nakit</option>
            <option value="banka">ğŸ¦ Banka</option>
            <option value="pos">ğŸ’³ POS</option>
            <option value="sanal">ğŸ“± Sanal</option>
          </select>
        </div>
        <div class="form-group" id="editGroupAciklama" style="display:none;">
          <label>AÃ§Ä±klama</label>
          <textarea id="editAciklama" rows="3" placeholder="AÃ§Ä±klama (opsiyonel)"></textarea>
        </div>

        <!-- Not alanÄ± - tÃ¼m kayÄ±t tipleri iÃ§in -->
        <div class="form-group" id="editGroupNotlar">
          <label>Not</label>
          <textarea id="editNotlar" rows="3" placeholder="Not (opsiyonel)"></textarea>
        </div>

        <!-- Muhasebe yazÄ±sÄ± seÃ§imi - oto/manuel -->
        <div class="form-group" id="editGroupMuhasebe" style="margin-top:12px;padding-top:12px;border-top:1px solid var(--border);">
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer;">
            <input type="checkbox" id="editMuhasebeNotu" checked />
            <span>KayÄ±t yapan/gÃ¼ncelleyen: Muhasebe yazÄ±sÄ± eklensin</span>
          </label>
        </div>

        <div class="actions">
          <button type="button" class="secondary" onclick="closeEditModal()">Ä°ptal</button>
          <button type="submit" class="good">Kaydet</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Tahsilat -->
  <div class="modal" id="modalTahsilat">
    <div class="sheet">
      <h3 id="tahsilatTitle">Tahsilat</h3>
      <input type="hidden" id="tahsilatKayitId" />
      <div id="tahsilatKayitBilgi" style="margin-bottom:16px;padding:12px;background:var(--bg-soft);border-radius:8px;font-size:14px;"></div>
      <div id="tahsilatListeWrap" style="margin-bottom:16px;">
        <strong>Mevcut tahsilatlar</strong>
        <ul id="tahsilatListe" style="list-style:none;padding:0;margin:8px 0 0 0;max-height:180px;overflow-y:auto;"></ul>
      </div>
      <form id="formTahsilat" class="form-grid">
        <div class="form-group">
          <label>Tutar (â‚º) *</label>
          <input type="number" id="tahsilatTutar" min="0" step="0.01" required />
        </div>
        <div class="form-group">
          <label>Tahsilat Tarihi *</label>
          <input type="date" id="tahsilatTarih" required />
        </div>
        <div class="form-group">
          <label>Ã–deme Tipi *</label>
          <select id="tahsilatOdemeTipi" required>
            <option value="pesin">PeÅŸin</option>
            <option value="taksit">Taksit</option>
          </select>
        </div>
        <div class="form-group" id="tahsilatGroupTaksitNo" style="display:none;">
          <label>Taksit No</label>
          <input type="number" id="tahsilatTaksitNo" min="1" placeholder="1, 2, 3..." />
        </div>
        <div class="form-group">
          <label>AÃ§Ä±klama</label>
          <input type="text" id="tahsilatAciklama" placeholder="Opsiyonel" />
        </div>
        <div class="actions">
          <button type="button" class="secondary" onclick="closeTahsilatModal()">Ä°ptal</button>
          <button type="submit" class="good">Tahsilat Ekle</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Tutar SeÃ§eneÄŸi -->
  <div class="modal" id="modalTutar">
    <div class="sheet">
      <h3 id="tutarTitle">Yeni Tutar SeÃ§eneÄŸi</h3>
      <form id="formTutar" class="form-grid">
        <input type="hidden" id="tutarId" />
        <div class="form-group">
          <label>Tutar (â‚º) *</label>
          <input type="number" id="tutarTutar" min="0" step="0.01" required />
        </div>
        <div class="form-group">
          <label>Etiket *</label>
          <input type="text" id="tutarLabel" placeholder="Ã–rn: 50 kiÅŸilik iftar" required />
        </div>
        <div class="form-group">
          <label>Tip *</label>
          <select id="tutarTip" required>
            <option value="">SeÃ§iniz</option>
            <option value="iftar">Ä°ftar</option>
            <option value="sahur">Sahur</option>
            <option value="">Her Ä°kisi (Genel)</option>
          </select>
          <small style="color:var(--muted);margin-top:4px">Bu tutar seÃ§eneÄŸinin hangi tip iÃ§in geÃ§erli olduÄŸunu
            belirtin</small>
        </div>
        <div class="form-group">
          <label>SÄ±ra *</label>
          <input type="number" id="tutarSira" min="1" value="1" required />
        </div>
        <div class="form-group">
          <label>Durum</label>
          <select id="tutarAktif">
            <option value="true">Aktif</option>
            <option value="false">Pasif</option>
          </select>
        </div>
        <div class="actions">
          <button type="button" class="secondary" onclick="closeTutarModal()">Ä°ptal</button>
          <button type="submit" class="good">Kaydet</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Ramazan AyarlarÄ± -->
  <div class="modal" id="modalRamazan">
    <div class="sheet">
      <h3 id="ramazanTitle">Yeni Ramazan-Ä± Åerif YÄ±lÄ±</h3>
      <form id="formRamazan" class="form-grid">
        <input type="hidden" id="ramazanId" />
        <div class="form-group">
          <label>YÄ±l *</label>
          <input type="number" id="ramazanYil" min="2024" max="2050" required />
        </div>
        <div class="form-group">
          <label>BaÅŸlangÄ±Ã§ Tarihi *</label>
          <input type="date" id="ramazanBaslangic" required />
        </div>
        <div class="form-group">
          <label>BitiÅŸ Tarihi *</label>
          <input type="date" id="ramazanBitis" required />
        </div>
        <div class="form-group">
          <label>Hicri YÄ±l *</label>
          <input type="number" id="ramazanHicri" min="1400" max="1500" required />
        </div>
        <div class="form-group">
          <label>Durum *</label>
          <select id="ramazanAktif" required>
            <option value="true">Aktif</option>
            <option value="false">Pasif</option>
          </select>
        </div>
        <div class="actions">
          <button type="button" class="secondary" onclick="closeRamazanModal()">Ä°ptal</button>
          <button type="submit" class="good">Kaydet</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Genel Kapasite AyarlarÄ± -->
  <div class="modal" id="modalGenelKapasite">
    <div class="sheet">
      <h3 id="genelKapasiteTitle">Genel Kapasite AyarlarÄ±</h3>
      <form id="formGenelKapasite" class="form-grid">
        <div class="form-group">
          <label>Ä°ftar Max Kapasite</label>
          <input type="number" id="genelKapasiteIftar" min="0" placeholder="SÄ±nÄ±rsÄ±z iÃ§in boÅŸ bÄ±rakÄ±n" />
          <small style="color:var(--muted);margin-top:4px">Ä°ÅŸtirak edecekler iÃ§in kapasite. Ä°ÅŸtirak etmeyecekler iÃ§in
            sÄ±nÄ±rsÄ±z.</small>
        </div>
        <div class="form-group">
          <label>Sahur Max Kapasite</label>
          <input type="number" id="genelKapasiteSahur" min="0" placeholder="SÄ±nÄ±rsÄ±z iÃ§in boÅŸ bÄ±rakÄ±n" />
          <small style="color:var(--muted);margin-top:4px">Ä°ÅŸtirak edecekler iÃ§in kapasite. Ä°ÅŸtirak etmeyecekler iÃ§in
            sÄ±nÄ±rsÄ±z.</small>
        </div>
        <div class="actions">
          <button type="button" class="secondary" onclick="closeGenelKapasiteModal()">Ä°ptal</button>
          <button type="submit" class="good">Kaydet</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: GÃ¼nlÃ¼k Kapasite AyarlarÄ± -->
  <div class="modal" id="modalKapasite">
    <div class="sheet">
      <h3 id="kapasiteTitle">Yeni GÃ¼nlÃ¼k Kapasite</h3>
      <form id="formKapasite" class="form-grid">
        <input type="hidden" id="kapasiteId" />
        <div class="form-group">
          <label>Tarih *</label>
          <input type="date" id="kapasiteTarih" required />
        </div>
        <div class="form-group">
          <label>Ä°ftar Max Kapasite</label>
          <input type="number" id="kapasiteIftar" min="0" placeholder="SÄ±nÄ±rsÄ±z iÃ§in boÅŸ bÄ±rakÄ±n" />
          <small style="color:var(--muted);margin-top:4px">Bu gÃ¼n iÃ§in Ã¶zel kapasite. Genel kapasiteyi geÃ§ersiz
            kÄ±lar.</small>
        </div>
        <div class="form-group">
          <label>Sahur Max Kapasite</label>
          <input type="number" id="kapasiteSahur" min="0" placeholder="SÄ±nÄ±rsÄ±z iÃ§in boÅŸ bÄ±rakÄ±n" />
          <small style="color:var(--muted);margin-top:4px">Bu gÃ¼n iÃ§in Ã¶zel kapasite. Genel kapasiteyi geÃ§ersiz
            kÄ±lar.</small>
        </div>
        <div class="actions">
          <button type="button" class="secondary" onclick="closeKapasiteModal()">Ä°ptal</button>
          <button type="submit" class="good">Kaydet</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Onay -->
  <div class="modal" id="modalConfirm">
    <div class="sheet" style="max-width:500px">
      <h3 id="confirmTitle">Onay</h3>
      <p id="confirmMessage" style="margin:16px 0;color:var(--ink)"></p>
      <div class="actions">
        <button type="button" class="secondary" onclick="closeConfirmModal(false)">Ä°ptal</button>
        <button type="button" class="good" id="confirmOkBtn" onclick="closeConfirmModal(true)">Onayla</button>
      </div>
    </div>
  </div>

  <!-- Modal: Talep OnayÄ± (Eski / Yeni karÅŸÄ±laÅŸtÄ±rmalÄ±) -->
  <div class="modal" id="modalTalepOnay">
    <div class="sheet talep-onay-sheet">
      <h3>Talep OnayÄ±</h3>
      <p class="talep-onay-ust">Bu talebi onaylamak istediÄŸinizden emin misiniz?</p>
      <div class="talep-onay-karsilastirma">
        <div class="talep-onay-kolon talep-onay-eski">
          <h4>Mevcut veri</h4>
          <div id="talepOnayEskiContent" class="talep-onay-icerik"></div>
        </div>
        <div class="talep-onay-kolon talep-onay-yeni">
          <h4>Yeni veri</h4>
          <div id="talepOnayYeniContent" class="talep-onay-icerik"></div>
        </div>
      </div>
      <div class="talep-onay-aciklama-wrap">
        <strong>AÃ§Ä±klama:</strong>
        <div id="talepOnayAciklama" class="talep-onay-aciklama"></div>
      </div>
      <div class="actions">
        <button type="button" class="secondary" onclick="closeTalepOnayModal(false)">Ä°ptal</button>
        <button type="button" class="good" onclick="closeTalepOnayModal(true)">Onayla</button>
      </div>
    </div>
  </div>

  <!-- Modal: UyarÄ±/Bilgi -->
  <div class="modal" id="modalAlert">
    <div class="sheet" style="max-width:500px">
      <h3 id="alertTitle">Bilgi</h3>
      <p id="alertMessage" style="margin:16px 0;color:var(--ink)"></p>
      <div class="actions">
        <button type="button" class="good" onclick="closeAlertModal()">Tamam</button>
      </div>
    </div>
  </div>

  <!-- Modal: Prompt (Input) -->
  <div class="modal" id="modalPrompt">
    <div class="sheet" style="max-width:500px">
      <h3 id="promptTitle">Bilgi GiriÅŸi</h3>
      <p id="promptMessage" style="margin:16px 0;color:var(--ink)"></p>
      <div class="form-group">
        <input type="text" id="promptInput" class="full-input" placeholder="LÃ¼tfen giriniz..." style="margin-top:8px" />
      </div>
      <div class="actions">
        <button type="button" class="secondary" onclick="closePromptModal(null)">Ä°ptal</button>
        <button type="button" class="good" id="promptOkBtn" onclick="closePromptModal(true)">Tamam</button>
      </div>
    </div>
  </div>

  <!-- Modal: MenÃ¼ -->
  <div class="modal" id="modalMenu">
    <div class="sheet" style="max-width:600px">
      <h3 id="menuTitle">Yeni MenÃ¼</h3>
      <form id="formMenu" class="form-grid">
        <input type="hidden" id="menuId" />
        <div class="form-group">
          <label>Tarih *</label>
          <input type="date" id="menuTarih" required />
        </div>
        <div class="form-group">
          <label>Tip *</label>
          <select id="menuTip" required>
            <option value="">SeÃ§iniz</option>
            <option value="iftar">ğŸŒ™ Ä°ftar</option>
            <option value="sahur">ğŸŒŸ Sahur</option>
          </select>
        </div>
        <div class="form-group">
          <label>Ã‡orba</label>
          <input type="text" id="menuCorba" placeholder="Ã–rn: Mercimek Ã§orbasÄ±" />
        </div>
        <div class="form-group">
          <label>Yemek</label>
          <input type="text" id="menuYemek" placeholder="Ã–rn: Tavuk kÄ±zartma, Pilav" />
        </div>
        <div class="form-group">
          <label>SoÄŸuk</label>
          <input type="text" id="menuSoguk" placeholder="Ã–rn: Salata, Meze" />
        </div>
        <div class="form-group">
          <label>Ä°Ã§ecek</label>
          <input type="text" id="menuIcecek" placeholder="Ã–rn: Ayran, Åerbet" />
        </div>
        <div class="form-group">
          <label>DiÄŸer</label>
          <textarea id="menuDiger" rows="3" placeholder="TatlÄ±, ekmek, zeytin vb."
            style="width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;font:inherit;resize:vertical"></textarea>
        </div>
        <div class="actions">
          <button type="button" class="secondary" onclick="closeMenuModal()">Ä°ptal</button>
          <button type="submit" class="good">Kaydet</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Personel Hedef -->
  <div class="modal" id="modalPersonelHedef">
    <div class="sheet" style="max-width:500px">
      <h3 id="personelHedefTitle">Yeni Personel Hedefi</h3>
      <form id="formPersonelHedef" class="form-grid">
        <input type="hidden" id="personelHedefId" />
        <div class="form-group">
          <label>YÄ±l *</label>
          <select id="personelHedefYil" required>
            <option value="2024">2024</option>
            <option value="2025" selected>2025</option>
            <option value="2026">2026</option>
          </select>
        </div>
        <div class="form-group">
          <label>Personel *</label>
          <select id="personelHedefPersonel" required>
            <option value="">Personel SeÃ§iniz</option>
          </select>
        </div>
        <div class="form-group">
          <label>Hedef (â‚º) *</label>
          <input type="text" id="personelHedefTutar" placeholder="0,00" required />
          <small style="color:var(--muted);margin-top:4px">VirgÃ¼l destekli format: 10.000,50</small>
        </div>
        <div class="actions">
          <button type="button" class="secondary" onclick="closePersonelHedefModal()">Ä°ptal</button>
          <button type="submit" class="good">Kaydet</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Veri Temizleme -->
  <div class="modal" id="modalVeriTemizle">
    <div class="sheet" style="max-width:600px">
      <h3>ğŸ—‘ï¸ Veri Temizleme</h3>
      <div style="padding:12px;background:#fff3cd;border-left:4px solid #ffc107;border-radius:8px;margin-bottom:20px">
        <p style="margin:0;font-size:13px;line-height:1.6">
          <strong>âš ï¸ UyarÄ±:</strong> SeÃ§ili yÄ±l/yÄ±llar iÃ§in TÃœM veriler silinecektir. Bu iÅŸlem geri alÄ±namaz!<br>
          <strong>ğŸ’¡ Ã–neri:</strong> Silmeden Ã¶nce verilerinizi yedekleyin veya CSV dosyanÄ±zÄ± hazÄ±r tutun.
        </p>
      </div>
      <form id="formVeriTemizle" class="form-grid">
        <div class="form-group">
          <label>Silinecek YÄ±llar *</label>
          <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
              <input type="checkbox" id="temizle2023" value="2023" />
              <span>2023</span>
            </label>
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
              <input type="checkbox" id="temizle2024" value="2024" checked />
              <span>2024</span>
            </label>
            <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
              <input type="checkbox" id="temizle2025" value="2025" checked />
              <span>2025</span>
            </label>
          </div>
          <small style="color:var(--muted);margin-top:8px">
            Temizlemek istediÄŸiniz yÄ±llarÄ± seÃ§in (Ã¶r: Ã§ift kopya olan veriler iÃ§in)
          </small>
        </div>
        <div class="actions">
          <button type="button" class="secondary" onclick="closeVeriTemizleModal()">Ä°ptal</button>
          <button type="submit" class="bad">Sil ve Temizle</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Veri YÃ¼kleme -->
  <div class="modal" id="modalVeriYukle">
    <div class="sheet" style="max-width:800px">
      <h3>ğŸ“¥ Finansal Veri YÃ¼kleme</h3>
      <div
        style="padding:12px;background:#f0f7ff;border-left:4px solid var(--accent);border-radius:8px;margin-bottom:20px">
        <p style="margin:0;font-size:13px;line-height:1.6">
          <strong>ğŸ“‹ Format:</strong> CSV dosyasÄ± yÄ±llÄ±k veriler iÃ§ermelidir.<br>
          <strong>Kolonlar:</strong> YÄ±l, Tip (iftar/sahur/taahhÃ¼t/teberru), Sahip (kiÅŸi adÄ±), DiÄŸer (aÃ§Ä±klama/ara
          kiÅŸi), Tutar (virgÃ¼l destekli, Ã¶rn: 10.000,50), Referans<br>
          <strong>Ã–rnek:</strong> 2023,iftar,Ali GÃ¶vercin,Mehmet Kara,10000.50,Muhsin Ã‡elik
        </p>
        <p style="margin:8px 0 0 0;font-size:12px;line-height:1.5;color:var(--muted)">
          <strong>ğŸ’¡ Not:</strong> "DiÄŸer" kÄ±smÄ± ara kiÅŸi bilgisi iÃ§in kullanÄ±lÄ±r. Tutar kÄ±smÄ±nda virgÃ¼l veya nokta
          kullanabilirsiniz (10.000,50 veya 10000.50).
        </p>
      </div>
      <form id="formVeriYukle" class="form-grid">
        <div class="form-group">
          <label>CSV DosyasÄ± *</label>
          <input type="file" id="veriYukleFile" accept=".csv" required />
          <small style="color:var(--muted);margin-top:4px">
            Muhasebe sisteminden indirdiÄŸiniz CSV dosyasÄ±nÄ± seÃ§in
          </small>
        </div>
        <div class="form-group">
          <label>YÄ±l *</label>
          <select id="veriYukleYil" required>
            <option value="">SeÃ§iniz</option>
            <option value="2023">2023</option>
            <option value="2024">2024</option>
            <option value="2025">2025</option>
          </select>
          <small style="color:var(--muted);margin-top:4px">
            YÃ¼klediÄŸiniz verinin ait olduÄŸu yÄ±l
          </small>
        </div>
        <div id="veriYuklePreview" style="display:none;margin-top:16px">
          <h4 style="margin:0 0 12px 0;font-size:16px">Ã–nizleme (Ä°lk 10 KayÄ±t)</h4>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>Tip</th>
                  <th>Sahip</th>
                  <th>DiÄŸer</th>
                  <th>Tutar (â‚º)</th>
                  <th>Referans</th>
                </tr>
              </thead>
              <tbody id="veriYuklePreviewBody"></tbody>
            </table>
          </div>
        </div>
        <div class="actions">
          <button type="button" class="secondary" onclick="closeVeriYukleModal()">Ä°ptal</button>
          <button type="submit" class="good">YÃ¼kle</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: KiÅŸi Detay Analizi -->
  <div class="modal" id="modalKisiDetay">
    <div class="sheet" style="max-width:900px;max-height:90vh">
      <h3 id="kisiDetayTitle">ğŸ‘¤ KiÅŸi Detay Analizi</h3>
      <div id="kisiDetayContent"></div>
      <div class="actions">
        <button type="button" class="secondary" onclick="closeKisiDetayModal()">Kapat</button>
      </div>
    </div>
  </div>

  <!-- Modal: GÃ¼n Detay (Takvim) -->
  <div class="modal" id="modalCalDay" onclick="if(event.target===this)closeCalDayModal()">
    <div class="sheet" style="max-height:90vh;overflow-y:auto">
      <div class="cal-day-modal-header">
        <div class="cal-day-modal-title-wrap">
          <h3 id="calDayModalTitle" class="cal-day-modal-title">ğŸ“… GÃ¼n DetayÄ±</h3>
          <div id="calDayModalSummary" class="cal-day-modal-summary-grid"></div>
        </div>
        <button type="button" class="cal-day-modal-close" onclick="closeCalDayModal()" title="Kapat">Ã—</button>
      </div>

      <div class="cal-day-section">
        <h4>Ä°ftar KayÄ±tlarÄ±</h4>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Personel</th>
                <th>Sahip / BaÄŸÄ±ÅŸÃ§Ä±</th>
                <th>Mahal</th>
                <th style="text-align:center">MÃ¼safir</th>
                <th style="text-align:center">Ä°ÅŸtirak</th>
                <th class="right">Tutar (â‚º)</th>
                <th>Notlar</th>
              </tr>
            </thead>
            <tbody id="tbodyCalIftar"></tbody>
          </table>
        </div>
      </div>

      <div class="cal-day-section">
        <h4>Sahur KayÄ±tlarÄ±</h4>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Personel</th>
                <th>Sahip / BaÄŸÄ±ÅŸÃ§Ä±</th>
                <th>Mahal</th>
                <th style="text-align:center">MÃ¼safir</th>
                <th style="text-align:center">Ä°ÅŸtirak</th>
                <th class="right">Tutar (â‚º)</th>
                <th>Notlar</th>
              </tr>
            </thead>
            <tbody id="tbodyCalSahur"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal: Personel/Referans Detay Analizi -->
  <div class="modal" id="modalPersonelDetay">
    <div class="sheet" style="max-width:1000px;max-height:90vh;overflow-y:auto">
      <h3 id="personelDetayTitle">ğŸ‘¥ Personel/Referans Detay Analizi</h3>
      <div id="personelDetayContent"></div>
      <div class="actions">
        <button type="button" class="secondary" onclick="closePersonelDetay()">Kapat</button>
      </div>
    </div>
  </div>

  <!-- Modal: Toplu Personel DÃ¼zenleme -->
  <div class="modal" id="modalTopluPersonel">
    <div class="sheet" style="max-width:600px">
      <div
        style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;padding-bottom:16px;border-bottom:2px solid var(--border)">
        <h3 style="margin:0;font-size:20px;color:var(--text)">âœï¸ Toplu Personel DÃ¼zenleme</h3>
        <button type="button" onclick="closeTopluPersonelModal()"
          style="background:none;border:none;font-size:24px;cursor:pointer;color:var(--muted);padding:0;width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all 0.2s"
          onmouseover="this.style.background='var(--hover)';this.style.color='var(--text)'"
          onmouseout="this.style.background='none';this.style.color='var(--muted)'">Ã—</button>
      </div>
      <div style="margin-bottom:16px;padding:12px;background:#fff3cd;border-left:4px solid #ffc107;border-radius:8px">
        <p style="margin:0;font-size:13px;line-height:1.6">
          <strong>âš ï¸ Dikkat:</strong> <span id="topluPersonelKayitSayisi">0</span> kayÄ±t iÃ§in personel bilgisi deÄŸiÅŸtirilecek.
        </p>
      </div>
      <form id="formTopluPersonel" style="display:grid;gap:16px">
        <div class="field">
          <label style="display:block;margin-bottom:8px;font-weight:600;color:var(--text);font-size:14px">Mevcut Personel</label>
          <input type="text" id="topluPersonelEski" readonly
            style="width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;font-size:14px;background:var(--bg-secondary);color:var(--text)" />
        </div>
        <div class="field">
          <label style="display:block;margin-bottom:8px;font-weight:600;color:var(--text);font-size:14px">Yeni Personel</label>
          <select id="topluPersonelYeni" required
            style="width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;font-size:14px;background:var(--bg);color:var(--text)">
            <option value="">Personel SeÃ§iniz</option>
            <option value="__MANUEL__">Manuel GiriÅŸ</option>
          </select>
        </div>
        <div class="field" id="topluPersonelManuelWrapper" style="display:none">
          <label style="display:block;margin-bottom:8px;font-weight:600;color:var(--text);font-size:14px">Manuel Personel AdÄ±</label>
          <input type="text" id="topluPersonelManuel"
            style="width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;font-size:14px;background:var(--bg);color:var(--text)" />
        </div>
        <div class="actions"
          style="display:flex;gap:12px;justify-content:flex-end;margin-top:8px;padding-top:20px;border-top:1px solid var(--border)">
          <button type="button" class="secondary" onclick="closeTopluPersonelModal()"
            style="padding:10px 20px;font-size:14px">Ä°ptal</button>
          <button type="submit" class="good" style="padding:10px 24px;font-size:14px;font-weight:600">ğŸ’¾ DeÄŸiÅŸtir</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Veri DÃ¼zenleme -->
  <div class="modal" id="modalVeriDuzenleme">
    <div class="sheet" style="max-width:750px;max-height:90vh;overflow-y:auto">
      <div
        style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;padding-bottom:16px;border-bottom:2px solid var(--border)">
        <h3 id="veriDuzenlemeTitle" style="margin:0;font-size:20px;color:var(--text)">âœï¸ Veri DÃ¼zenleme</h3>
        <button type="button" onclick="closeVeriDuzenlemeModal()"
          style="background:none;border:none;font-size:24px;cursor:pointer;color:var(--muted);padding:0;width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:50%;transition:all 0.2s"
          onmouseover="this.style.background='var(--hover)';this.style.color='var(--text)'"
          onmouseout="this.style.background='none';this.style.color='var(--muted)'">Ã—</button>
      </div>
      <form id="formVeriDuzenleme" style="display:grid;gap:16px">
        <input type="hidden" id="duzenleId" />
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
          <div class="field">
            <label style="display:block;margin-bottom:8px;font-weight:600;color:var(--text);font-size:14px">YÄ±l
              *</label>
            <select id="duzenleYilInput" required
              style="width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;font-size:14px;background:var(--bg);color:var(--text)">
              <option value="2023" selected>2023</option>
              <option value="2024">2024</option>
              <option value="2025">2025</option>
            </select>
          </div>
          <div class="field">
            <label style="display:block;margin-bottom:8px;font-weight:600;color:var(--text);font-size:14px">Tip
              *</label>
            <select id="duzenleTipInput" required
              style="width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;font-size:14px;background:var(--bg);color:var(--text)">
              <option value="iftar">ğŸŒ™ Ä°ftar</option>
              <option value="sahur">ğŸŒŸ Sahur</option>
              <option value="taahhut">ğŸ“‹ TaahhÃ¼t</option>
              <option value="teberru">ğŸ’ Teberru</option>
            </select>
          </div>
        </div>
        <div class="field">
          <label style="display:block;margin-bottom:8px;font-weight:600;color:var(--text);font-size:14px">Sahip (BaÄŸÄ±ÅŸ
            Yapan) *</label>
          <input type="text" id="duzenleSahip" required
            style="width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;font-size:14px;background:var(--bg);color:var(--text)" />
        </div>
        <div class="field">
          <label style="display:block;margin-bottom:8px;font-weight:600;color:var(--text);font-size:14px">DiÄŸer (Ara
            KiÅŸi)</label>
          <input type="text" id="duzenleDiger"
            style="width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;font-size:14px;background:var(--bg);color:var(--text)" />
        </div>
        <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
          <div class="field">
            <label style="display:block;margin-bottom:8px;font-weight:600;color:var(--text);font-size:14px">Tutar (â‚º)
              *</label>
            <input type="text" id="duzenleTutar" placeholder="10000.50 veya 10.000,50" required
              style="width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;font-size:14px;background:var(--bg);color:var(--text)" />
          </div>
          <div class="field">
            <label style="display:block;margin-bottom:8px;font-weight:600;color:var(--text);font-size:14px">Personel</label>
            <select id="duzenlePersonel"
              style="width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;font-size:14px;background:var(--bg);color:var(--text)">
              <option value="">Personel SeÃ§iniz</option>
              <option value="__MANUEL__">Manuel GiriÅŸ</option>
            </select>
          </div>
          <div class="field" id="duzenleReferansWrapper" style="display:none">
            <label style="display:block;margin-bottom:8px;font-weight:600;color:var(--text);font-size:14px">Referans
              (Manuel)</label>
            <input type="text" id="duzenleReferans"
              style="width:100%;padding:10px;border:1px solid var(--border);border-radius:8px;font-size:14px;background:var(--bg);color:var(--text)" />
          </div>
        </div>
        <div class="actions"
          style="display:flex;gap:12px;justify-content:flex-end;margin-top:8px;padding-top:20px;border-top:1px solid var(--border)">
          <button type="button" class="secondary" onclick="closeVeriDuzenlemeModal()"
            style="padding:10px 20px;font-size:14px">Ä°ptal</button>
          <button type="button" class="danger" onclick="deleteVeriKayit()" id="btnDeleteVeri"
            style="display:none;padding:10px 20px;font-size:14px">ğŸ—‘ï¸ Sil</button>
          <button type="submit" class="good" style="padding:10px 24px;font-size:14px;font-weight:600">ğŸ’¾ Kaydet</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Modal: Mahal AyarlarÄ± -->
  <div class="modal" id="modalMahal">
    <div class="sheet">
      <h3 id="mahalTitle">Yeni Mahal Ekle</h3>
      <form id="formMahal" class="form-grid">
        <input type="hidden" id="mahalId" />
        <div class="form-group">
          <label>Mahal AdÄ± *</label>
          <input type="text" id="mahalAdi" placeholder="Ã–rn: Ana Salon, BahÃ§e, Konferans Salonu" required />
        </div>
        <div class="form-group">
          <label>Min MÃ¼safir Adedi *</label>
          <input type="number" id="mahalMin" min="1" value="1" required />
        </div>
        <div class="form-group">
          <label>Max MÃ¼safir Adedi *</label>
          <input type="number" id="mahalMax" min="1" required />
        </div>
        <div class="actions">
          <button type="button" class="secondary" onclick="closeMahalModal()">Ä°ptal</button>
          <button type="submit" class="good">Kaydet</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // DOMContentLoaded'da Ã§alÄ±ÅŸtÄ±r - ortak.js yÃ¼klenene kadar bekle
    document.addEventListener('DOMContentLoaded', function () {
      // Supabase ve ortak.js yÃ¼klenene kadar bekle
      function waitForSupabaseAndOrtak(callback) {
        if (typeof window.supabase !== 'undefined' && typeof window.norm !== 'undefined' && typeof window.showToast !== 'undefined') {
          callback();
        } else {
          setTimeout(() => waitForSupabaseAndOrtak(callback), 50);
        }
      }

      waitForSupabaseAndOrtak(() => {
        const getSupabase = () => window.supabase;
        const getAuth = () => window.getSupabaseAuth ? window.getSupabaseAuth() : null;
        const showToast = window.showToast; // Ortak.js'den gelen showToast
        const qs = s => document.querySelector(s);

        let kayitlar = [];
        let tutarSecenekleri = [];
        let currentYil = new Date().getFullYear();
        let kayitlarSortKey = 'islemTarihi';
        let kayitlarSortDir = -1; // 1: artan, -1: azalan (varsayÄ±lan: iÅŸlem tarihine gÃ¶re yeni > eski)
        let tahsilatByKayitId = {};   // kayit_id -> toplam tahsilat tutarÄ±
        let tahsilatListByKayitId = {}; // kayit_id -> tahsilat satÄ±rlarÄ± (tarih, tutar, odeme_tipi, taksit_no)

        // showToast ortak.js'den geliyor, window.showToast kullanÄ±yoruz

        // Modal fonksiyonlarÄ±
        let confirmCallback = null;

        function showConfirmModal(title, message, okText = 'Onayla', okClass = 'good') {
          return new Promise((resolve) => {
            confirmCallback = resolve;
            qs('#confirmTitle').textContent = title;
            qs('#confirmMessage').textContent = message;
            const okBtn = qs('#confirmOkBtn');
            okBtn.textContent = okText;
            okBtn.className = okClass;
            qs('#modalConfirm').classList.add('show');
            document.body.classList.add('modal-open');
          });
        }

        function closeConfirmModal(result) {
          qs('#modalConfirm').classList.remove('show');
          document.body.classList.remove('modal-open');
          if (confirmCallback) {
            confirmCallback(result);
            confirmCallback = null;
          }
        }

        function showAlertModal(title, message) {
          qs('#alertTitle').textContent = title;
          qs('#alertMessage').textContent = message;
          qs('#modalAlert').classList.add('show');
          document.body.classList.add('modal-open');
        }

        function closeAlertModal() {
          qs('#modalAlert').classList.remove('show');
          document.body.classList.remove('modal-open');
        }

        let promptCallback = null;

        function showPromptModal(title, message, okText = 'Tamam', okClass = 'good') {
          return new Promise((resolve) => {
            promptCallback = resolve;
            qs('#promptTitle').textContent = title;
            qs('#promptMessage').textContent = message;
            const okBtn = qs('#promptOkBtn');
            okBtn.textContent = okText;
            okBtn.className = okClass;
            qs('#promptInput').value = '';
            qs('#modalPrompt').classList.add('show');
            document.body.classList.add('modal-open');

            // Input'a odaklan
            setTimeout(() => {
              qs('#promptInput').focus();
              // Enter tuÅŸu ile onaylama
              qs('#promptInput').addEventListener('keypress', function onEnter(e) {
                if (e.key === 'Enter') {
                  qs('#promptInput').removeEventListener('keypress', onEnter);
                  closePromptModal(true);
                }
              });
            }, 100);
          });
        }

        function closePromptModal(result) {
          qs('#modalPrompt').classList.remove('show');
          document.body.classList.remove('modal-open');
          if (promptCallback) {
            if (result === true) {
              promptCallback(qs('#promptInput').value);
            } else {
              promptCallback(null);
            }
            promptCallback = null;
          }
        }

        window.showConfirmModal = showConfirmModal;
        window.closeConfirmModal = closeConfirmModal;
        window.showAlertModal = showAlertModal;
        window.closeAlertModal = closeAlertModal;
        window.showPromptModal = showPromptModal;
        window.closePromptModal = closePromptModal;

        let talepOnayCallback = null;
        function showTalepOnayModal(eskiHtml, yeniHtml, aciklama) {
          return new Promise((resolve) => {
            talepOnayCallback = resolve;
            qs('#talepOnayEskiContent').innerHTML = eskiHtml;
            qs('#talepOnayYeniContent').innerHTML = yeniHtml;
            const aciklamaEl = qs('#talepOnayAciklama');
            aciklamaEl.textContent = aciklama || '-';
            qs('#modalTalepOnay').classList.add('show');
            document.body.classList.add('modal-open');
          });
        }
        function closeTalepOnayModal(result) {
          qs('#modalTalepOnay').classList.remove('show');
          document.body.classList.remove('modal-open');
          if (talepOnayCallback) {
            talepOnayCallback(result);
            talepOnayCallback = null;
          }
        }
        window.closeTalepOnayModal = closeTalepOnayModal;

        // Progress Bar
        function showProgress(percent) {
          const container = qs('#progressContainer');
          const bar = qs('#progressBar');
          if (container && bar) {
            if (percent > 0) {
              container.classList.add('active');
              bar.style.width = percent + '%';
            } else {
              container.classList.remove('active');
              bar.style.width = '0%';
            }
          }
        }

        window.showProgress = showProgress;

        const ayIsimleri = ['Ocak', 'Åubat', 'Mart', 'Nisan', 'MayÄ±s', 'Haziran', 'Temmuz', 'AÄŸustos', 'EylÃ¼l', 'Ekim', 'KasÄ±m', 'AralÄ±k'];

        // Mahal AyarlarÄ± - Global scope (onclick iÃ§in eriÅŸilebilir olmalÄ±)
        let mahalList = [];

        // Mahal fonksiyonlarÄ±nÄ± Ã¶nce tanÄ±mla
        async function loadMahallar() {
          try {
            const supabase = getSupabase();
            if (!supabase) {
              console.error('Supabase client hazÄ±r deÄŸil');
              return;
            }
            const { data, error } = await supabase
              .from('ramazan_mahaller')
              .select('*')
              .order('adi', { ascending: true });
            if (error) {
              console.error('Mahaller yÃ¼klenemedi:', error);
              mahalList = [];
            } else {
              // Åemadan gelen verileri mapping yap (minmusafir -> minMusafir, maxmusafir -> maxMusafir)
              mahalList = (data || []).map(d => ({
                id: d.id,
                ...d,
                minMusafir: d.minmusafir || d.minMusafir || 0,
                maxMusafir: d.maxmusafir || d.maxMusafir || 0
              }));
            }
            renderMahallar();
          } catch (e) {
            console.error('Mahaller yÃ¼klenemedi:', e);
            mahalList = [];
            renderMahallar();
          }
        }

        function renderMahallar() {
          const container = qs('#mahalList');
          if (!container) return;

          container.innerHTML = '';

          if (mahalList.length === 0) {
            container.innerHTML = '<div style="text-align:center;color:var(--muted);padding:20px">Mahal bulunamadÄ±. Yeni mahal ekleyin.</div>';
            return;
          }

          mahalList.forEach(m => {
            const card = document.createElement('div');
            card.style.cssText = 'border:1px solid var(--border);border-radius:12px;padding:16px;margin-bottom:12px;background:#fff';
            card.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:start">
            <div>
              <h4 style="margin:0 0 8px 0;font-size:16px;color:var(--ink)">${m.adi || '-'}</h4>
              <div style="display:flex;gap:16px;font-size:13px;color:var(--muted)">
                <span><strong>Min:</strong> ${m.minmusafir || m.minMusafir || 0} kiÅŸi</span>
                <span><strong>Max:</strong> ${m.maxmusafir || m.maxMusafir || 0} kiÅŸi</span>
              </div>
            </div>
            <div style="display:flex;gap:8px">
              <button onclick="editMahal('${m.id}')" style="padding:6px 12px;font-size:12px">DÃ¼zenle</button>
              <button onclick="deleteMahal('${m.id}')" class="danger" style="padding:6px 12px;font-size:12px">Sil</button>
            </div>
          </div>
        `;
            container.appendChild(card);
          });
        }

        function openMahalModal(id = null) {
          qs('#mahalId').value = id || '';
          qs('#mahalTitle').textContent = id ? 'Mahal DÃ¼zenle' : 'Yeni Mahal Ekle';

          if (id) {
            const m = mahalList.find(m => m.id === id);
            if (m) {
              qs('#mahalAdi').value = m.adi || '';
              qs('#mahalMin').value = m.minmusafir || m.minMusafir || 1;
              qs('#mahalMax').value = m.maxmusafir || m.maxMusafir || '';
            }
          } else {
            qs('#formMahal').reset();
            qs('#mahalMin').value = 1;
          }

          qs('#modalMahal').classList.add('show');
          document.body.classList.add('modal-open');
        }

        function closeMahalModal() {
          qs('#modalMahal').classList.remove('show');
          document.body.classList.remove('modal-open');
        }

        async function deleteMahal(id) {
          if (!confirm('Bu mahali silmek istediÄŸinizden emin misiniz?')) return;

          try {
            const supabase = getSupabase();
            if (!supabase) {
              showToast('error', 'Hata', 'Supabase client hazÄ±r deÄŸil');
              return;
            }
            const { error } = await supabase
              .from('ramazan_mahaller')
              .delete()
              .eq('id', id);
            if (error) {
              throw error;
            }
            showToast('success', 'BaÅŸarÄ±lÄ±', 'Mahal silindi!');
            await loadMahallar();
          } catch (e) {
            console.error('Mahal silinemedi:', e);
            showToast('error', 'Hata', 'Mahal silinemedi: ' + (e.message || e));
          }
        }

        function editMahal(id) {
          openMahalModal(id);
        }

        // Global olarak eriÅŸilebilir yap (onclick iÃ§in)
        window.openMahalModal = openMahalModal;
        window.editMahal = editMahal;
        window.deleteMahal = deleteMahal;
        window.closeMahalModal = closeMahalModal;
        window.loadMahallar = loadMahallar;

        // Navigation ve Auth kontrolÃ¼ ortak.js'de yapÄ±lÄ±yor, burada kaldÄ±rÄ±ldÄ±

        // window.initPage fonksiyonu - ortak.js tarafÄ±ndan Ã§aÄŸrÄ±lacak
        window.initPage = async function () {
          // Ay seÃ§eneklerini doldur (kayÄ±t filtreleri iÃ§in)
          fillAyOptions();

          // Ramazan yÄ±llarÄ±nÄ± ve aktif yÄ±lÄ± yÃ¼kle
          await loadRamazanYillari();
          await loadAktifRamazanAyar();

          // Ä°lk yÃ¼kleme
          await loadKayitlar();
          await loadTutarSecenekleri();
          await loadMahallar();
        };

        // Tab deÄŸiÅŸtirme - Event delegation kullanarak (tek listener)
        let tabInitialized = false;
        function initTabs() {
          if (tabInitialized) return;
          tabInitialized = true;

          document.addEventListener('click', (e) => {
            const tab = e.target.closest('.tab');
            if (!tab || !tab.dataset.tab) return;

            e.preventDefault();
            e.stopPropagation();

            // TÃ¼m tab'larÄ± pasif yap
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));

            // TÄ±klanan tab'Ä± aktif yap
            tab.classList.add('active');
            const tabId = tab.dataset.tab;
            const tabContent = qs(`#tab-${tabId}`);
            if (tabContent) {
              tabContent.classList.add('active');

              // Tab'a gÃ¶re iÃ§erik yÃ¼kle
              if (tabId === 'takvim') {
                if (typeof renderCalView === 'function') renderCalView();
              }
              if (tabId === 'istatistik') {
                if (typeof loadStatistics === 'function') loadStatistics();
              }
              if (tabId === 'ayarlar') {
                if (typeof loadRamazanAyarlari === 'function') loadRamazanAyarlari();
                if (typeof loadMahallar === 'function') loadMahallar();
                if (typeof loadTutarSecenekleri === 'function') loadTutarSecenekleri();
                if (typeof loadKapasiteAyarlari === 'function') loadKapasiteAyarlari();
                if (typeof loadPersonelHedefleri === 'function') loadPersonelHedefleri();
              }
              if (tabId === 'hedef') {
                // Analiz verilerini yÃ¼kle ve gÃ¶ster
                if (typeof loadAnalizVerileri === 'function') {
                  loadAnalizVerileri().then(() => {
                    if (typeof loadAnalizDashboard === 'function') loadAnalizDashboard();
                    if (typeof loadTrendAnaliz === 'function') loadTrendAnaliz();
                    if (typeof loadKategoriAnaliz === 'function') loadKategoriAnaliz();
                    if (typeof loadKisiAnalizi === 'function') loadKisiAnalizi();
                    if (typeof loadPersonelAnalizi === 'function') loadPersonelAnalizi();
                    // Hedef tanÄ±mlamayÄ± yÃ¼kle
                    if (typeof loadHedefTanÄ±mlama === 'function') loadHedefTanÄ±mlama();
                  });
                } else {
                  // Analiz verileri yoksa direkt hedef tanÄ±mlamayÄ± yÃ¼kle
                  if (typeof loadHedefTanÄ±mlama === 'function') loadHedefTanÄ±mlama();
                }
              }
              if (tabId === 'veri-duzenleme') {
                // Veri dÃ¼zenleme sekmesi aÃ§Ä±ldÄ±ÄŸÄ±nda verileri yÃ¼kle
                if (typeof loadAnalizVerileri === 'function') {
                  loadAnalizVerileri().then(() => {
                    if (typeof loadVeriDuzenleme === 'function') loadVeriDuzenleme();
                  });
                } else {
                  if (typeof loadVeriDuzenleme === 'function') loadVeriDuzenleme();
                }
              }
              if (tabId === 'talepler') {
                // Talepler sekmesi aÃ§Ä±ldÄ±ÄŸÄ±nda talepleri yÃ¼kle
                if (typeof loadTalepler === 'function') loadTalepler();
              }
              if (tabId === 'menu') {
                // MenÃ¼ sekmesi aÃ§Ä±ldÄ±ÄŸÄ±nda menÃ¼leri yÃ¼kle
                if (typeof loadMenuler === 'function') loadMenuler();
              }
            }
          });
        }

        // Tab'larÄ± baÅŸlat
        initTabs();

        // Ramazan AyarlarÄ±
        let ramazanAyarlari = [];

        async function loadRamazanAyarlari() {
          try {
            const supabase = getSupabase();
            if (!supabase) {
              console.error('Supabase client hazÄ±r deÄŸil');
              return;
            }
            const { data, error } = await supabase
              .from('ramazan_yillar')
              .select('*')
              .order('yil', { ascending: false });
            if (error) {
              console.error('Ramazan ayarlarÄ± yÃ¼klenemedi:', error);
              ramazanAyarlari = [];
            } else {
              ramazanAyarlari = (data || []).map(d => ({ id: d.id, ...d }));
            }
            renderRamazanAyarlari();
          } catch (e) {
            console.error('Ramazan ayarlarÄ± yÃ¼klenemedi:', e);
            ramazanAyarlari = [];
            renderRamazanAyarlari();
          }
        }

        function renderRamazanAyarlari() {
          const tbody = qs('#tbodyRamazan');
          tbody.innerHTML = '';

          if (ramazanAyarlari.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--muted);padding:20px">KayÄ±t bulunamadÄ±</td></tr>';
            return;
          }

          ramazanAyarlari.forEach(r => {
            const tr = document.createElement('tr');
            const baslangic = new Date(r.baslangic);
            const bitis = new Date(r.bitis);

            tr.innerHTML = `
          <td><strong>${r.yil}</strong></td>
          <td>${baslangic.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric', weekday: 'long', timeZone: 'Europe/Istanbul' })}</td>
          <td>${bitis.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric', weekday: 'long', timeZone: 'Europe/Istanbul' })}</td>
          <td>${r.hicriyil || r.hicriYil || '-'}</td>
          <td>${r.aktif ? '<span style="color:var(--good);font-weight:600">Aktif</span>' : '<span style="color:var(--muted)">Pasif</span>'}</td>
          <td>
            <button onclick="editRamazan('${r.id}')" style="padding:4px 8px;font-size:12px">DÃ¼zenle</button>
            <button onclick="deleteRamazan('${r.id}')" class="danger" style="padding:4px 8px;font-size:12px">Sil</button>
          </td>
        `;
            tbody.appendChild(tr);
          });
        }

        function openRamazanModal(id = null) {
          qs('#ramazanId').value = id || '';
          qs('#ramazanTitle').textContent = id ? 'Ramazan-Ä± Åerif YÄ±lÄ± DÃ¼zenle' : 'Yeni Ramazan-Ä± Åerif YÄ±lÄ±';

          if (id) {
            const r = ramazanAyarlari.find(r => r.id === id);
            if (r) {
              const baslangic = new Date(r.baslangic);
              const bitis = new Date(r.bitis);
              qs('#ramazanYil').value = r.yil || '';
              qs('#ramazanBaslangic').value = baslangic.toISOString().slice(0, 10);
              qs('#ramazanBitis').value = bitis.toISOString().slice(0, 10);
              qs('#ramazanHicri').value = r.hicriyil || r.hicriYil || '';
              qs('#ramazanAktif').value = r.aktif ? 'true' : 'false';
            }
          } else {
            qs('#formRamazan').reset();
            qs('#ramazanYil').value = new Date().getFullYear();
            qs('#ramazanAktif').value = 'false';
          }

          qs('#modalRamazan').classList.add('show');
          document.body.classList.add('modal-open');
        }

        function closeRamazanModal() {
          qs('#modalRamazan').classList.remove('show');
          document.body.classList.remove('modal-open');
        }

        // Global olarak eriÅŸilebilir yap (onclick iÃ§in)
        window.closeRamazanModal = closeRamazanModal;

        qs('#formRamazan').addEventListener('submit', async (e) => {
          e.preventDefault();

          const id = qs('#ramazanId').value;
          const yil = parseInt(qs('#ramazanYil').value);
          const baslangic = qs('#ramazanBaslangic').value;
          const bitis = qs('#ramazanBitis').value;
          const hicriYil = parseInt(qs('#ramazanHicri').value);
          const aktif = qs('#ramazanAktif').value === 'true';

          if (!yil || !baslangic || !bitis || !hicriYil) {
            alert('LÃ¼tfen tÃ¼m alanlarÄ± doldurun.');
            return;
          }

          // Aktif olan varsa diÄŸerlerini pasif yap
          if (aktif) {
            try {
              const supabase = getSupabase();
              if (supabase) {
                const { data: aktifYillar, error } = await supabase
                  .from('ramazan_yillar')
                  .select('id')
                  .eq('aktif', true);

                if (!error && aktifYillar) {
                  // DiÄŸer aktif yÄ±llarÄ± pasif yap
                  const updates = aktifYillar
                    .filter(r => r.id !== id)
                    .map(r => supabase.from('ramazan_yillar').update({ aktif: false }).eq('id', r.id));
                  await Promise.all(updates);
                }
              }
            } catch (e) {
              console.error('Aktif yÄ±l gÃ¼ncellenemedi:', e);
            }
          }

          try {
            const supabase = getSupabase();
            if (!supabase) {
              showToast('error', 'Hata', 'Supabase client hazÄ±r deÄŸil');
              return;
            }
            // Åemaya gÃ¶re: updatedat, createdat (kÃ¼Ã§Ã¼k harf)
            const data = {
              yil: yil,
              baslangic: baslangic,
              bitis: bitis,
              hicriyil: hicriYil, // Åemada hicriyil (kÃ¼Ã§Ã¼k harf)
              aktif: aktif,
              updatedat: new Date().toISOString()
            };

            if (id) {
              const { error } = await supabase
                .from('ramazan_yillar')
                .update(data)
                .eq('id', id);
              if (error) throw error;
            } else {
              data.createdat = new Date().toISOString();
              const { error } = await supabase
                .from('ramazan_yillar')
                .insert(data);
              if (error) throw error;
            }

            showToast('success', 'BaÅŸarÄ±lÄ±', 'Ramazan ayarÄ± baÅŸarÄ±yla kaydedildi!');
            closeRamazanModal();
            await loadRamazanAyarlari();
          } catch (e) {
            console.error('Ramazan ayarÄ± kaydedilemedi:', e);
            showToast('error', 'Hata', 'Ramazan ayarÄ± kaydedilemedi: ' + (e.message || e));
          }
        });

        async function deleteRamazan(id) {
          if (!confirm('Bu Ramazan-Ä± Åerif yÄ±lÄ±nÄ± silmek istediÄŸinizden emin misiniz?')) return;

          try {
            const supabase = getSupabase();
            if (!supabase) {
              showToast('error', 'Hata', 'Supabase client hazÄ±r deÄŸil');
              return;
            }
            const { error } = await supabase
              .from('ramazan_yillar')
              .delete()
              .eq('id', id);
            if (error) {
              throw error;
            }
            showToast('success', 'BaÅŸarÄ±lÄ±', 'Ramazan ayarÄ± silindi!');
            await loadRamazanAyarlari();
          } catch (e) {
            console.error('Ramazan ayarÄ± silinemedi:', e);
            showToast('error', 'Hata', 'Ramazan ayarÄ± silinemedi: ' + (e.message || e));
          }
        }

        function editRamazan(id) {
          openRamazanModal(id);
        }

        window.editRamazan = editRamazan;
        window.deleteRamazan = deleteRamazan;
        window.openRamazanModal = openRamazanModal;

        // Mahal form submit listener - DOM yÃ¼klendikten sonra ekle
        setTimeout(() => {
          const formMahal = qs('#formMahal');
          if (formMahal) {
            // Ã–nceki listener'Ä± kaldÄ±r (varsa)
            const newForm = formMahal.cloneNode(true);
            formMahal.parentNode.replaceChild(newForm, formMahal);

            newForm.addEventListener('submit', async (e) => {
              e.preventDefault();

              const id = qs('#mahalId').value;
              const adi = qs('#mahalAdi').value.trim();
              const minMusafir = parseInt(qs('#mahalMin').value) || 1;
              const maxMusafir = parseInt(qs('#mahalMax').value) || 1;

              if (!adi || !maxMusafir || maxMusafir < minMusafir) {
                alert('LÃ¼tfen tÃ¼m alanlarÄ± doÄŸru ÅŸekilde doldurun. Max mÃ¼safir adedi min\'den kÃ¼Ã§Ã¼k olamaz.');
                return;
              }

              try {
                const supabase = getSupabase();
                if (!supabase) {
                  showToast('error', 'Hata', 'Supabase client hazÄ±r deÄŸil');
                  return;
                }
                // Åemaya gÃ¶re: id (NOT NULL), minmusafir, maxmusafir (kÃ¼Ã§Ã¼k harf)
                const data = {
                  adi: adi,
                  minmusafir: minMusafir,
                  maxmusafir: maxMusafir
                };

                if (id) {
                  const { error } = await supabase
                    .from('ramazan_mahaller')
                    .update(data)
                    .eq('id', id);
                  if (error) throw error;
                } else {
                  // Yeni kayÄ±t - id zorunlu (ramazan_mahaller.id NOT NULL)
                  const newId = typeof crypto !== 'undefined' && crypto.randomUUID
                    ? crypto.randomUUID()
                    : 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                        const r = Math.random() * 16 | 0;
                        const v = c === 'x' ? r : (r & 0x3 | 0x8);
                        return v.toString(16);
                      });
                  const { error } = await supabase
                    .from('ramazan_mahaller')
                    .insert({ id: newId, ...data });
                  if (error) throw error;
                }

                showToast('success', 'BaÅŸarÄ±lÄ±', 'Mahal baÅŸarÄ±yla kaydedildi!');
                closeMahalModal();
                await loadMahallar();
              } catch (e) {
                console.error('Mahal kaydedilemedi:', e);
                showToast('error', 'Hata', 'Mahal kaydedilemedi: ' + (e.message || e));
              }
            });
          }
        }, 100);

        // Kapasite AyarlarÄ±
        let kapasiteAyarlariList = [];

        async function loadKapasiteAyarlari() {
          const yil = qs('#kapasiteYil').value;
          if (!yil) {
            qs('#tbodyKapasite').innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--muted);padding:20px">LÃ¼tfen bir yÄ±l seÃ§iniz</td></tr>';
            qs('#genelKapasiteDisplay').innerHTML = '';
            return;
          }

          try {
            const supabase = getSupabase();
            if (!supabase) {
              console.error('Supabase client hazÄ±r deÄŸil');
              return;
            }
            // GÃ¼nlÃ¼k kapasite ayarlarÄ±nÄ± yÃ¼kle (ramazan_kapasite tablosu)
            const { data: gunlukData, error: gunlukError } = await supabase
              .from('ramazan_kapasite')
              .select('*')
              .eq('yil', parseInt(yil))
              .order('tarih', { ascending: true });

            if (!gunlukError && gunlukData) {
              // Åemadan gelen verileri mapping yap (iftarmax -> iftarMax, sahurmax -> sahurMax)
              kapasiteAyarlariList = gunlukData.map(d => ({
                ...d,
                id: d.id,
                iftarMax: d.iftarmax || d.iftarMax || null,
                sahurMax: d.sahurmax || d.sahurMax || null
              }));
            } else {
              if (gunlukError) console.error('GÃ¼nlÃ¼k kapasite hatasÄ±:', gunlukError);
              kapasiteAyarlariList = [];
            }

            renderKapasiteAyarlari();

            // Genel kapasite ayarlarÄ±nÄ± yÃ¼kle (ramazan_ayarlar tablosundan)
            // id='genel' satÄ±rÄ±nÄ± kullanÄ±yoruz
            const { data: ayarlarData, error } = await supabase
              .from('ramazan_ayarlar')
              .select('*')
              .eq('id', 'genel')
              .single();

            if (!error && ayarlarData) {
              // Åemadan gelen veriler: iftarmax, sahurmax (kÃ¼Ã§Ã¼k harf)
              const iftarMax = ayarlarData.iftarmax !== null && ayarlarData.iftarmax !== undefined ? ayarlarData.iftarmax : (ayarlarData.iftarMax !== null && ayarlarData.iftarMax !== undefined ? ayarlarData.iftarMax : null);
              const sahurMax = ayarlarData.sahurmax !== null && ayarlarData.sahurmax !== undefined ? ayarlarData.sahurmax : (ayarlarData.sahurMax !== null && ayarlarData.sahurMax !== undefined ? ayarlarData.sahurMax : null);
              qs('#genelKapasiteDisplay').innerHTML = `
                <div style="display:flex;gap:16px;flex-wrap:wrap">
                  <div><strong>Ä°ftar Max:</strong> ${iftarMax !== null && iftarMax !== undefined ? iftarMax : 'âˆ (SÄ±nÄ±rsÄ±z)'}</div>
                  <div><strong>Sahur Max:</strong> ${sahurMax !== null && sahurMax !== undefined ? sahurMax : 'âˆ (SÄ±nÄ±rsÄ±z)'}</div>
                </div>
              `;
            } else {
              qs('#genelKapasiteDisplay').innerHTML = '<div style="color:var(--muted);font-size:13px">Genel kapasite ayarÄ± tanÄ±mlanmamÄ±ÅŸ</div>';
            }
          } catch (e) {
            console.error('Kapasite ayarlarÄ± yÃ¼klenemedi:', e);
            kapasiteAyarlariList = [];
            renderKapasiteAyarlari();
          }
        }

        function renderKapasiteAyarlari() {
          const tbody = qs('#tbodyKapasite');
          tbody.innerHTML = '';

          if (kapasiteAyarlariList.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--muted);padding:20px">KayÄ±t bulunamadÄ±</td></tr>';
            return;
          }

          kapasiteAyarlariList.forEach(k => {
            const tr = document.createElement('tr');
            // Tarih kontrolÃ¼
            let tarih = new Date();
            if (k.tarih) {
              if (typeof k.tarih === 'string') {
                tarih = new Date(k.tarih);
              } else if (k.tarih instanceof Date) {
                tarih = k.tarih;
              }
            }

            tr.innerHTML = `
          <td>${tarih.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric', timeZone: 'Europe/Istanbul' })}</td>
          <td>${k.iftarMax !== null && k.iftarMax !== undefined ? k.iftarMax : 'âˆ (SÄ±nÄ±rsÄ±z)'}</td>
          <td>${k.sahurMax !== null && k.sahurMax !== undefined ? k.sahurMax : 'âˆ (SÄ±nÄ±rsÄ±z)'}</td>
          <td>
            <button onclick="editKapasite('${k.id}')" style="padding:4px 8px;font-size:12px">DÃ¼zenle</button>
            <button onclick="deleteKapasite('${k.id}')" class="danger" style="padding:4px 8px;font-size:12px">Sil</button>
          </td>
        `;
            tbody.appendChild(tr);
          });
        }

        async function openGenelKapasiteModal() {
          const yil = qs('#kapasiteYil').value;
          if (!yil) {
            alert('LÃ¼tfen Ã¶nce bir yÄ±l seÃ§iniz');
            return;
          }

          // Mevcut genel kapasiteyi yÃ¼kle
          try {
            const supabase = getSupabase();
            if (!supabase) return;

            const { data, error } = await supabase
              .from('ramazan_ayarlar')
              .select('*')
              .eq('id', 'genel')
              .single();

            if (!error && data) {
              // Åemadan gelen veriler: iftarmax, sahurmax (kÃ¼Ã§Ã¼k harf)
              const iftarMax = data.iftarmax !== null && data.iftarmax !== undefined ? data.iftarmax : (data.iftarMax !== null && data.iftarMax !== undefined ? data.iftarMax : '');
              const sahurMax = data.sahurmax !== null && data.sahurmax !== undefined ? data.sahurmax : (data.sahurMax !== null && data.sahurMax !== undefined ? data.sahurMax : '');
              qs('#genelKapasiteIftar').value = iftarMax;
              qs('#genelKapasiteSahur').value = sahurMax;
            } else {
              qs('#genelKapasiteIftar').value = '';
              qs('#genelKapasiteSahur').value = '';
            }
          } catch (e) {
            console.error('Genel kapasite yÃ¼klenemedi:', e);
          }

          qs('#modalGenelKapasite').classList.add('show');
          document.body.classList.add('modal-open');
        }

        function closeGenelKapasiteModal() {
          qs('#modalGenelKapasite').classList.remove('show');
          document.body.classList.remove('modal-open');
        }

        // Global olarak eriÅŸilebilir yap (onclick iÃ§in)
        window.closeGenelKapasiteModal = closeGenelKapasiteModal;

        qs('#formGenelKapasite').addEventListener('submit', async (e) => {
          e.preventDefault();

          const yil = qs('#kapasiteYil').value; // KullanÄ±lmayabilir ama context iÃ§in burada
          const iftarMax = qs('#genelKapasiteIftar').value ? parseInt(qs('#genelKapasiteIftar').value) : null;
          const sahurMax = qs('#genelKapasiteSahur').value ? parseInt(qs('#genelKapasiteSahur').value) : null;

          try {
            const supabase = getSupabase();
            if (!supabase) {
              showToast('error', 'Hata', 'Supabase client hazÄ±r deÄŸil');
              return;
            }

            // Genel olduÄŸu iÃ§in id='genel' kullanÄ±yoruz. EÄŸer yoksa oluÅŸturur (upsert)
            // Åemaya gÃ¶re: iftarmax, sahurmax (kÃ¼Ã§Ã¼k harf)
            const { error } = await supabase
              .from('ramazan_ayarlar')
              .upsert({
                id: 'genel',
                iftarmax: iftarMax,
                sahurmax: sahurMax
              });

            if (error) throw error;

            alert('Genel kapasite ayarÄ± kaydedildi!');
            closeGenelKapasiteModal();
            await loadKapasiteAyarlari();
          } catch (e) {
            console.error('Genel kapasite kaydedilemedi:', e);
            alert('Hata: ' + e.message);
          }
        });

        function openKapasiteModal(id = null) {
          const yil = qs('#kapasiteYil').value;
          if (!yil) {
            alert('LÃ¼tfen Ã¶nce bir yÄ±l seÃ§iniz');
            return;
          }

          qs('#kapasiteId').value = id || '';
          qs('#kapasiteTitle').textContent = id ? 'GÃ¼nlÃ¼k Kapasite DÃ¼zenle' : 'Yeni GÃ¼nlÃ¼k Kapasite';

          if (id) {
            const k = kapasiteAyarlariList.find(k => k.id === id);
            if (k) {
              // Tarih kontrolÃ¼
              let tarih = new Date();
              if (k.tarih) {
                if (typeof k.tarih === 'string') {
                  tarih = new Date(k.tarih);
                } else if (k.tarih instanceof Date) {
                  tarih = k.tarih;
                }
              }
              qs('#kapasiteTarih').value = tarih.toISOString().slice(0, 10);
              // Åemadan gelen veriler: iftarmax, sahurmax (kÃ¼Ã§Ã¼k harf)
              const iftarMaxVal = k.iftarmax !== null && k.iftarmax !== undefined ? k.iftarmax : (k.iftarMax !== null && k.iftarMax !== undefined ? k.iftarMax : '');
              const sahurMaxVal = k.sahurmax !== null && k.sahurmax !== undefined ? k.sahurmax : (k.sahurMax !== null && k.sahurMax !== undefined ? k.sahurMax : '');
              qs('#kapasiteIftar').value = iftarMaxVal;
              qs('#kapasiteSahur').value = sahurMaxVal;
            }
          } else {
            qs('#formKapasite').reset();
          }

          qs('#modalKapasite').classList.add('show');
          document.body.classList.add('modal-open');
        }

        function closeKapasiteModal() {
          qs('#modalKapasite').classList.remove('show');
          document.body.classList.remove('modal-open');
        }

        // Global olarak eriÅŸilebilir yap (onclick iÃ§in)
        window.closeKapasiteModal = closeKapasiteModal;

        qs('#formKapasite').addEventListener('submit', async (e) => {
          e.preventDefault();

          const yil = qs('#kapasiteYil').value;
          if (!yil) {
            alert('LÃ¼tfen bir yÄ±l seÃ§iniz');
            return;
          }

          const id = qs('#kapasiteId').value;
          const tarih = qs('#kapasiteTarih').value;
          const iftarMax = qs('#kapasiteIftar').value ? parseInt(qs('#kapasiteIftar').value) : null;
          const sahurMax = qs('#kapasiteSahur').value ? parseInt(qs('#kapasiteSahur').value) : null;

          if (!tarih) {
            alert('LÃ¼tfen bir tarih seÃ§iniz');
            return;
          }

          try {
            const supabase = getSupabase();
            if (!supabase) {
              showToast('error', 'Hata', 'Supabase client hazÄ±r deÄŸil');
              return;
            }

            // Åemaya gÃ¶re: iftarmax, sahurmax (kÃ¼Ã§Ã¼k harf)
            const data = {
              yil: parseInt(yil),
              tarih: new Date(tarih).toISOString(),
              iftarmax: iftarMax,
              sahurmax: sahurMax,
              updated_at: new Date().toISOString()
            };

            if (id) {
              const { error } = await supabase
                .from('ramazan_kapasite')
                .update(data)
                .eq('id', id);
              if (error) throw error;
            } else {
              // Yeni kayÄ±t
              let newId;
              if (typeof crypto !== 'undefined' && crypto.randomUUID) {
                newId = crypto.randomUUID();
              } else {
                // Fallback UUID v4
                newId = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                  const r = Math.random() * 16 | 0;
                  const v = c === 'x' ? r : (r & 0x3 | 0x8);
                  return v.toString(16);
                });
              }
              data.id = newId;
              data.created_at = new Date().toISOString();

              const { error } = await supabase
                .from('ramazan_kapasite')
                .insert(data);
              if (error) throw error;
            }

            alert('Kapasite ayarÄ± kaydedildi!');
            closeKapasiteModal();
            await loadKapasiteAyarlari();
          } catch (e) {
            console.error('Kapasite kaydedilemedi:', e);
            alert('Hata: ' + e.message);
          }
        });

        async function deleteKapasite(id) {
          if (!confirm('Bu kapasite ayarÄ±nÄ± silmek istediÄŸinizden emin misiniz?')) return;

          try {
            const supabase = getSupabase();
            if (!supabase) {
              showToast('error', 'Hata', 'Supabase client hazÄ±r deÄŸil');
              return;
            }

            const { error } = await supabase
              .from('ramazan_kapasite')
              .delete()
              .eq('id', id);

            if (error) throw error;

            alert('Kapasite ayarÄ± silindi!');
            await loadKapasiteAyarlari();
          } catch (e) {
            console.error('Kapasite silinemedi:', e);
            alert('Hata: ' + e.message);
          }
        }

        window.editKapasite = editKapasite;
        window.deleteKapasite = deleteKapasite;
        window.openKapasiteModal = openKapasiteModal;
        window.openGenelKapasiteModal = openGenelKapasiteModal;

        function editKapasite(id) {
          openKapasiteModal(id);
        }

        // Kapasite yÄ±l seÃ§imi deÄŸiÅŸimi
        if (qs('#kapasiteYil')) {
          qs('#kapasiteYil').addEventListener('change', () => {
            loadKapasiteAyarlari();
          });
        }

        // Takvim sekmesi iÃ§in seÃ§ili yÄ±la gÃ¶re ay listesini Ramazan takvimine gÃ¶re doldur
        async function updateCalAyOptionsForYear(yil) {
          const calSel = qs('#calAy');
          if (!calSel) return;

          calSel.innerHTML = '';

          // Ä°lgili yÄ±lÄ±n Ramazan ayarÄ±nÄ± yÃ¼kle
          await loadYilRamazanAyar(yil);

          let aylarSet = new Set();
          if (yilRamazanAyar && yilRamazanAyar.baslangic && yilRamazanAyar.bitis) {
            const bas = new Date(yilRamazanAyar.baslangic);
            const bit = new Date(yilRamazanAyar.bitis);
            const d = new Date(bas);
            while (d <= bit) {
              aylarSet.add(d.getMonth() + 1); // 1-12
              d.setDate(d.getDate() + 1);
            }
          }

          // EÄŸer Ramazan ayarÄ± yoksa tÃ¼m aylarÄ± gÃ¶ster (eski davranÄ±ÅŸ)
          let aylar = Array.from(aylarSet).sort((a, b) => a - b);
          if (aylar.length === 0) {
            aylar = Array.from({ length: 12 }, (_, i) => i + 1);
          }

          const today = new Date();
          let defaultAy = aylar[0];
          if (parseInt(yil) === today.getFullYear() && aylar.includes(today.getMonth() + 1)) {
            defaultAy = today.getMonth() + 1;
          }

          aylar.forEach(m => {
            const opt = document.createElement('option');
            opt.value = m;
            opt.textContent = ayIsimleri[m - 1];
            if (m === defaultAy) opt.selected = true;
            calSel.appendChild(opt);
          });
        }

        // Ramazan yÄ±llarÄ±nÄ± yÃ¼kle ve yÄ±l seÃ§eneklerini gÃ¼ncelle
        async function loadRamazanYillari() {
          try {
            const supabase = getSupabase();
            if (!supabase) {
              console.error('Supabase client hazÄ±r deÄŸil');
              return;
            }
            const { data, error } = await supabase
              .from('ramazan_yillar')
              .select('yil')
              .order('yil', { ascending: false });

            if (error) {
              console.error('Ramazan yÄ±llarÄ± yÃ¼klenemedi:', error);
              return;
            }

            const yillar = (data || []).map(d => d.yil).filter(y => y);

            // Filtre yÄ±l seÃ§eneklerini gÃ¼ncelle
            updateYilSelect('filtreYil', yillar);
            updateYilSelect('exportYil', yillar);
            updateYilSelect('kapasiteYil', yillar);
            updateYilSelect('tutarYil', yillar);
            updateYilSelect('calYil', yillar);
            updateYilSelect('statYil', yillar);
            updateYilSelect('taleplerFiltreYil', yillar);
            updateYilSelect('menuFiltreYil', yillar);
            updateYilSelect('hedefYonetimYil', yillar);
            
            // Analiz ve dÃ¼zenleme yÄ±llarÄ± iÃ§in Ã¶zel iÅŸlem (tÃ¼m yÄ±llar seÃ§eneÄŸi var)
            updateYilSelectWithAllOption('analizYil', yillar);
            updateYilSelectWithAllOption('personelFiltreYil', yillar);
            updateYilSelectWithAllOption('duzenleYil', yillar);

            // Aktif yÄ±l varsa onu seÃ§
            const { data: aktifData, error: aktifError } = await supabase
              .from('ramazan_yillar')
              .select('yil')
              .eq('aktif', true)
              .limit(1)
              .single();

            // Mevcut yÄ±lÄ± al (2026)
            const mevcutYil = new Date().getFullYear();
            
            // Ã–nce aktif yÄ±lÄ± kontrol et, yoksa mevcut yÄ±lÄ± kullan
            let secilecekYil = mevcutYil;
            
            if (!aktifError && aktifData && aktifData.yil) {
              secilecekYil = aktifData.yil;
            } else if (yillar.length > 0) {
              // Aktif yÄ±l yoksa, mevcut yÄ±l listede varsa onu seÃ§, yoksa en yeni yÄ±lÄ± kullan
              if (yillar.includes(mevcutYil)) {
                secilecekYil = mevcutYil;
              } else {
                secilecekYil = yillar[0]; // En yeni yÄ±l
              }
            }
            
            // TÃ¼m yÄ±l seÃ§imlerini otomatik olarak seÃ§ilen yÄ±la ayarla
            const yilSelectIds = [
              'filtreYil', 'exportYil', 'kapasiteYil', 'tutarYil', 'calYil',
              'statYil', 'analizYil', 'personelFiltreYil', 'duzenleYil',
              'hedefYonetimYil', 'taleplerFiltreYil', 'menuFiltreYil'
            ];
            
            yilSelectIds.forEach(selectId => {
              const select = qs('#' + selectId);
              if (select) {
                // EÄŸer seÃ§enekler arasÄ±nda seÃ§ilecek yÄ±l varsa onu seÃ§
                if (yillar.includes(secilecekYil)) {
                  select.value = secilecekYil;
                } else if (yillar.length > 0) {
                  select.value = yillar[0]; // En yeni yÄ±l
                }
              }
            });
            
            currentYil = secilecekYil;

            // Takvim gÃ¶rÃ¼nÃ¼mÃ¼ndeki ay listesini Ramazan takvimine gÃ¶re gÃ¼ncelle
            if (typeof updateCalAyOptionsForYear === 'function') {
              await updateCalAyOptionsForYear(secilecekYil);
            }
          } catch (e) {
            console.error('Ramazan yÄ±llarÄ± yÃ¼klenemedi:', e);
          }
        }

        function updateYilSelect(selectId, yillar) {
          const select = qs('#' + selectId);
          if (!select) return;

          const currentValue = select.value;
          const mevcutYil = new Date().getFullYear();
          select.innerHTML = '';

          yillar.forEach(yil => {
            const opt = document.createElement('option');
            opt.value = yil;
            opt.textContent = `${yil} Ramazan-Ä± Åerif`;
            select.appendChild(opt);
          });

          // Ã–ncelik sÄ±rasÄ±: 1) Mevcut yÄ±l (2026), 2) KullanÄ±cÄ±nÄ±n seÃ§tiÄŸi deÄŸer, 3) En yeni yÄ±l
          if (yillar.includes(mevcutYil)) {
            select.value = mevcutYil;
          } else if (currentValue && yillar.includes(parseInt(currentValue))) {
            select.value = currentValue;
          } else if (yillar.length > 0) {
            select.value = yillar[0];
          }
        }

        // "TÃ¼m YÄ±llar" seÃ§eneÄŸi olan yÄ±l seÃ§imleri iÃ§in
        function updateYilSelectWithAllOption(selectId, yillar) {
          const select = qs('#' + selectId);
          if (!select) return;

          const currentValue = select.value;
          const mevcutYil = new Date().getFullYear();
          
          // Mevcut Ã¶zel seÃ§enekleri sakla (tumu, boÅŸ deÄŸer vb.)
          const specialOptions = [];
          Array.from(select.options).forEach(opt => {
            const val = opt.value;
            if (val === 'tumu' || val === '' || val === 'TÃ¼m YÄ±llar' || val === 'SeÃ§iniz') {
              specialOptions.push({ value: val, text: opt.textContent });
            }
          });
          
          // TÃ¼m seÃ§enekleri temizle
          select.innerHTML = '';
          
          // Ã–zel seÃ§enekleri Ã¶nce ekle (eÄŸer varsa)
          specialOptions.forEach(opt => {
            const option = document.createElement('option');
            option.value = opt.value;
            option.textContent = opt.text;
            select.appendChild(option);
          });
          
          // duzenleYil iÃ§in Ã¶zel iÅŸlem: En azÄ±ndan 2023-2026 arasÄ± yÄ±llarÄ± garantile
          if (selectId === 'duzenleYil') {
            const minimumYillar = [2023, 2024, 2025, 2026];
            const tumYillar = new Set([...minimumYillar, ...yillar]);
            const sortedYillar = Array.from(tumYillar).sort((a, b) => a - b);
            
            sortedYillar.forEach(yil => {
              const opt = document.createElement('option');
              opt.value = yil;
              opt.textContent = `${yil}`;
              select.appendChild(opt);
            });
          } else {
            // DiÄŸer select'ler iÃ§in normal iÅŸlem
            yillar.forEach(yil => {
              const opt = document.createElement('option');
              opt.value = yil;
              opt.textContent = `${yil}`;
              select.appendChild(opt);
            });
          }

          // Ã–ncelik sÄ±rasÄ±: 1) KullanÄ±cÄ±nÄ±n seÃ§tiÄŸi deÄŸer (2023), 2) Mevcut yÄ±l (2026), 3) En yeni yÄ±l
          if (selectId === 'duzenleYil') {
            // duzenleYil iÃ§in 2023'Ã¼ varsayÄ±lan seÃ§
            if (currentValue && (parseInt(currentValue) >= 2023 && parseInt(currentValue) <= 2026)) {
              select.value = currentValue;
            } else {
              select.value = '2023';
            }
          } else {
            // DiÄŸer select'ler iÃ§in normal mantÄ±k
            if (yillar.includes(mevcutYil)) {
              select.value = mevcutYil;
            } else if (currentValue && (yillar.includes(parseInt(currentValue)) || specialOptions.some(o => o.value === currentValue))) {
              select.value = currentValue;
            } else if (yillar.length > 0) {
              select.value = yillar[0];
            }
          }
        }

        // Takvim sekmesi: yÄ±l deÄŸiÅŸtiÄŸinde ay listesini Ramazan takvimine gÃ¶re gÃ¼ncelle
        const calYilSelect = qs('#calYil');
        if (calYilSelect) {
          calYilSelect.addEventListener('change', (e) => {
            const yil = e.target.value;
            if (yil && typeof updateCalAyOptionsForYear === 'function') {
              updateCalAyOptionsForYear(yil);
            }
          });
        }

        function fillAyOptions() {
          const sel = qs('#filtreAy');
          sel.innerHTML = '<option value="">TÃ¼m Aylar</option>';
          ayIsimleri.forEach((ay, idx) => {
            const opt = document.createElement('option');
            opt.value = idx + 1;
            opt.textContent = ay;
            sel.appendChild(opt);
          });

          // Takvim gÃ¶rÃ¼nÃ¼mÃ¼ ay seÃ§enekleri Ramazan takvimine gÃ¶re ayrÄ± fonksiyonda gÃ¼ncelleniyor
        }

        // Tahsilat verilerini kayit_id listesi iÃ§in yÃ¼kler; byId (toplam) ve listById (satÄ±r listesi) dÃ¶ner
        async function loadTahsilatForKayitIds(kayitIds) {
          const supabase = getSupabase();
          if (!supabase || !kayitIds || kayitIds.length === 0) {
            return { byId: {}, listById: {} };
          }
          const { data, error } = await supabase
            .from('ramazan_tahsilat')
            .select('id, kayit_id, tutar, tahsilat_tarihi, odeme_tipi, taksit_no, aciklama, createdat')
            .in('kayit_id', kayitIds)
            .order('tahsilat_tarihi', { ascending: true });

          const byId = {};
          const listById = {};
          kayitIds.forEach(id => {
            byId[id] = 0;
            listById[id] = [];
          });

          if (error) throw error;
          if (data) {
            data.forEach(row => {
              const kid = row.kayit_id;
              const tutar = Number(row.tutar) || 0;
              byId[kid] = (byId[kid] || 0) + tutar;
              listById[kid] = listById[kid] || [];
              listById[kid].push({
                id: row.id,
                tutar,
                tahsilat_tarihi: row.tahsilat_tarihi,
                odeme_tipi: row.odeme_tipi || 'pesin',
                taksit_no: row.taksit_no,
                aciklama: row.aciklama
              });
            });
          }
          return { byId, listById };
        }

        // KayÄ±tlarÄ± yÃ¼kle
        async function loadKayitlar() {
          const yil = qs('#filtreYil').value;
          currentYil = parseInt(yil);

          try {
            const supabase = getSupabase();
            if (!supabase) {
              console.error('Supabase client hazÄ±r deÄŸil');
              return;
            }

            // Mahal listesini yÃ¼kle (kayÄ±t listesinde mahal adÄ±nÄ± gÃ¶stermek iÃ§in; mahalList boÅŸsa veya gÃ¼ncel olsun diye)
            let mahallerForKayitlar = [...mahalList];
            if (mahallerForKayitlar.length === 0) {
              try {
                const { data: mahalData } = await supabase.from('ramazan_mahaller').select('id, adi').order('adi', { ascending: true });
                mahallerForKayitlar = (mahalData || []).map(m => ({ id: m.id, adi: m.adi }));
              } catch (_) {}
            } else {
              mahallerForKayitlar = mahalList.map(m => ({ id: m.id, adi: m.adi }));
            }

            // Ä°ftar-sahur kayÄ±tlarÄ±nÄ± yÃ¼kle (ramazan_kayitlari tablosu)
            let iftarSahurKayitlar = [];
            try {
              const { data: ramazanKayitData, error: ramazanError } = await supabase
                .from('ramazan_kayitlari')
                .select('*')
                .eq('yil', parseInt(yil));

              // Tarih sÄ±ralamasÄ± iÃ§in client-side sorting (tarih alanÄ± yoksa createdAt kullan)
              if (!ramazanError && ramazanKayitData) {
                ramazanKayitData.sort((a, b) => {
                  const getD = (item) => {
                    const ca = item.createdAt || item.createdat;
                    return item.tarih ? new Date(item.tarih) : (ca ? new Date(ca) : new Date(0));
                  };
                  return getD(b).getTime() - getD(a).getTime(); // En yeni Ã¶nce
                });
              }

              if (!ramazanError && ramazanKayitData) {
                iftarSahurKayitlar = ramazanKayitData.map(d => {
                  // Tarih bilgisini dÃ¼zenle
                  // Ã–ncelik: tarih (kayÄ±t aÅŸamasÄ±nda seÃ§ilen tarih) > createdat (fallback)
                  // Supabase'den gelen veriler kÃ¼Ã§Ã¼k harf olabilir (createdat vs createdAt)
                  const created_at = d.createdAt || d.createdat;

                  let tarih = null;
                  // Ã–nce tarih alanÄ±nÄ± kontrol et (kayÄ±t aÅŸamasÄ±nda seÃ§ilen tarih)
                  if (d.tarih) {
                    tarih = typeof d.tarih === 'string' ? new Date(d.tarih) : new Date(d.tarih);
                  } else if (created_at) {
                    // Fallback: createdat kullan
                    tarih = typeof created_at === 'string' ? new Date(created_at) : new Date(created_at);
                  } else {
                    tarih = new Date();
                  }

                  const personelVal = d.personel || d.personelAdi || d.personeladi || '';
                  const personelUidVal = d.personelUid || d.personeluid || null;
                  // Mahal: ÅŸemada mahal (text) ve mahalid (text). mahal boÅŸsa mahalid Ã¼zerinden ramazan_mahaller'dan ad Ã§Ã¶zÃ¼mle
                  const mahalidVal = d.mahalid || d.mahalId || null;
                  const mahalAdiFromDb = d.mahal || null;
                  const mahalAdiResolved = mahalAdiFromDb || (mahalidVal && mahallerForKayitlar.find(m => m.id === mahalidVal)?.adi) || null;

                  return {
                    id: d.id,
                    ...d,
                    tarih: tarih,
                    kayitTipi: 'iftar-sahur',
                    kayitKoleksiyon: 'ramazan_kayitlari',
                    personel: personelVal,
                    personelAdi: d.personeladi || d.personelAdi || personelVal, // Åemadan gelen personeladi -> personelAdi
                    personelUid: personelUidVal,
                    musafirAdedi: d.musafiradedi || d.musafirAdedi || 0, // Åemadan gelen musafiradedi -> musafirAdedi
                    kaydedenPersonel: d.kaydedenpersonel || d.kaydedenPersonel || '',
                    kaydedenPersonelUid: d.kaydedenpersoneluid || d.kaydedenPersonelUid || null,
                    mahal: mahalAdiResolved,
                    mahalid: mahalidVal,
                    createdAt: created_at, // Standardize to camelCase for internal use
                    updatedAt: d.updatedat || d.updatedAt
                  };
                });
              }
            } catch (e) {
              console.error('Ä°ftar-sahur kayÄ±tlarÄ± yÃ¼klenemedi:', e);
            }

            // Teberru kayÄ±tlarÄ±nÄ± yÃ¼kle (teberru_kayitlari tablosu)
            let teberruKayitlar = [];
            try {
              const { data: teberruData, error: teberruError } = await supabase
                .from('teberru_kayitlari')
                .select('*')
                .eq('yil', parseInt(yil))
                .order('createdat', { ascending: false });

              if (!teberruError && teberruData) {
                teberruKayitlar = teberruData.map(d => {
                  // Tarih bilgisini dÃ¼zenle
                  // Ã–ncelik: tarih (kayÄ±t aÅŸamasÄ±nda seÃ§ilen tarih) > createdat (fallback)
                  // Supabase'den gelen veriler kÃ¼Ã§Ã¼k harf olabilir (createdat vs createdAt)
                  const created_at = d.createdAt || d.createdat;

                  let tarih = null;
                  // Ã–nce tarih alanÄ±nÄ± kontrol et (kayÄ±t aÅŸamasÄ±nda seÃ§ilen tarih)
                  if (d.tarih) {
                    tarih = typeof d.tarih === 'string' ? new Date(d.tarih) : new Date(d.tarih);
                  } else if (created_at) {
                    // Fallback: createdat kullan
                    tarih = typeof created_at === 'string' ? new Date(created_at) : new Date(created_at);
                  } else {
                    tarih = new Date();
                  }

                  const personelVal = d.personel || d.kaydedenPersonel || d.kaydedenpersonel || '';
                  const personelUidVal = d.personelUid || d.personeluid || d.kaydedenPersonelUid || d.kaydedenpersoneluid || null;

                  return {
                    id: d.id,
                    ...d,
                    tip: 'teberru',
                    sahip: d.bagisci || '',
                    tutar: d.miktar || 0,
                    tarih: tarih,
                    yil: d.yil || (tarih ? tarih.getFullYear() : parseInt(yil)),
                    ay: d.ay || (tarih ? tarih.getMonth() + 1 : new Date().getMonth() + 1),
                    kayitTipi: 'teberru',
                    kayitKoleksiyon: 'teberru_kayitlari',
                    personel: personelVal,
                    personelUid: personelUidVal,
                    createdAt: created_at, // Standardize to camelCase for internal use
                    updatedAt: d.updatedAt || d.updatedat
                  };
                });
              }
            } catch (e) {
              console.error('Teberru kayÄ±tlarÄ± yÃ¼klenemedi:', e);
            }

            // TaahhÃ¼t kayÄ±tlarÄ±nÄ± yÃ¼kle (veriler tablosundan taahhut tipi)
            let taahhutKayitlar = [];
            try {
              const { data: taahhutData, error: taahhutError } = await supabase
                .from('taahhut_kayitlari')
                .select('*')
                .eq('yil', parseInt(yil))
                .order('createdat', { ascending: false });

              if (!taahhutError && taahhutData) {
                taahhutKayitlar = taahhutData.map(d => {
                  // Tarih bilgisini dÃ¼zenle
                  // Ã–ncelik: tarih (kayÄ±t aÅŸamasÄ±nda seÃ§ilen tarih) > createdat (fallback)
                  // Supabase'den gelen veriler kÃ¼Ã§Ã¼k harf olabilir (createdat vs createdAt)
                  const created_at = d.createdAt || d.createdat;

                  let tarih = null;
                  // Ã–nce tarih alanÄ±nÄ± kontrol et (kayÄ±t aÅŸamasÄ±nda seÃ§ilen tarih)
                  if (d.tarih) {
                    tarih = typeof d.tarih === 'string' ? new Date(d.tarih) : new Date(d.tarih);
                  } else if (created_at) {
                    // Fallback: createdat kullan
                    tarih = typeof created_at === 'string' ? new Date(created_at) : new Date(created_at);
                  } else {
                    tarih = new Date();
                  }

                  const personelVal = d.personel || d.kaydedenPersonel || d.kaydedenpersonel || '';
                  const personelUidVal = d.personelUid || d.personeluid || d.kaydedenPersonelUid || d.kaydedenpersoneluid || null;

                  return {
                    id: d.id,
                    ...d,
                    tip: 'taahhut',
                    sahip: d.bagisci || '',
                    tutar: d.miktar || 0,
                    tarih: tarih,
                    yil: d.yil || (tarih ? tarih.getFullYear() : parseInt(yil)),
                    ay: d.ay || (tarih ? tarih.getMonth() + 1 : new Date().getMonth() + 1),
                    kayitTipi: 'taahhut',
                    kayitKoleksiyon: 'taahhut_kayitlari',
                    personel: personelVal,
                    personelUid: personelUidVal,
                    createdAt: created_at, // Standardize to camelCase for internal use
                    updatedAt: d.updatedAt || d.updatedat
                  };
                });
              }
            } catch (e) {
              console.error('TaahhÃ¼t kayÄ±tlarÄ± yÃ¼klenemedi:', e);
            }

            // TÃ¼m kayÄ±tlarÄ± birleÅŸtir
            kayitlar = [...iftarSahurKayitlar, ...teberruKayitlar, ...taahhutKayitlar];

            console.log(`Toplam kayÄ±t sayÄ±sÄ±: ${kayitlar.length} (Ä°ftar-Sahur: ${iftarSahurKayitlar.length}, Teberru: ${teberruKayitlar.length}, TaahhÃ¼t: ${taahhutKayitlar.length})`);

            // Tarihe gÃ¶re sÄ±rala (en yeni Ã¶nce)
            kayitlar.sort((a, b) => {
              const getTarih = (k) => {
                if (k.tarih) {
                  if (typeof k.tarih === 'string') return new Date(k.tarih);
                  if (k.tarih instanceof Date) return k.tarih;
                  return new Date(k.tarih);
                }
                if (k.createdAt) {
                  if (typeof k.createdAt === 'string') return new Date(k.createdAt);
                  if (k.createdAt instanceof Date) return k.createdAt;
                  return new Date(k.createdAt);
                }
                return new Date(0);
              };
              const tarihA = getTarih(a);
              const tarihB = getTarih(b);
              return tarihB.getTime() - tarihA.getTime();
            });

            // Ä°ftar / sahur / taahhÃ¼t kayÄ±tlarÄ± iÃ§in tahsilat toplamlarÄ±nÄ± yÃ¼kle
            const tahsilatKayitIds = kayitlar.filter(k => k.tip === 'iftar' || k.tip === 'sahur' || k.tip === 'taahhut').map(k => k.id);
            if (tahsilatKayitIds.length > 0) {
              try {
                const { byId, listById } = await loadTahsilatForKayitIds(tahsilatKayitIds);
                tahsilatByKayitId = byId;
                tahsilatListByKayitId = listById;
              } catch (err) {
                console.warn('Tahsilat yÃ¼klenemedi:', err);
                tahsilatByKayitId = {};
                tahsilatListByKayitId = {};
              }
            } else {
              tahsilatByKayitId = {};
              tahsilatListByKayitId = {};
            }

            renderKayitlar();
          } catch (e) {
            console.error('KayÄ±tlar yÃ¼klenemedi:', e);
            kayitlar = [];
            renderKayitlar();
          }
        }

        // Filtre tip deÄŸiÅŸtiÄŸinde tarih seÃ§imini gÃ¶ster/gizle
        qs('#filtreTip').addEventListener('change', async function () {
          const tip = this.value;
          const tarihSelect = qs('#filtreTarih');

          if (tip) {
            // SeÃ§ilen yÄ±la gÃ¶re ramazan tarih aralÄ±ÄŸÄ±ndan seÃ§im
            tarihSelect.style.display = 'block';

            // SeÃ§ilen yÄ±la gÃ¶re ramazan ayarÄ±nÄ± yÃ¼kle
            const yil = qs('#filtreYil')?.value || currentYil || new Date().getFullYear();
            await loadYilRamazanAyar(yil);
            const tarihler = getRamazanTarihListesi(yilRamazanAyar);
            tarihSelect.innerHTML = '<option value="">TÃ¼m Tarihler</option>';
            tarihler.forEach(t => {
              const option = document.createElement('option');
              option.value = t.value;
              option.textContent = t.label;
              tarihSelect.appendChild(option);
            });
          } else {
            tarihSelect.style.display = 'none';
          }
        });

        function filterKayitlar() {
          renderKayitlar();
        }

        // Global olarak eriÅŸilebilir yap (onclick iÃ§in)
        window.filterKayitlar = filterKayitlar;

        function updateKayitlarSortHeaders() {
          const tbl = qs('#tblKayitlar');
          if (!tbl || !tbl.thead) return;
          const headers = tbl.thead.querySelectorAll('th.th-sortable');
          headers.forEach(th => {
            const key = th.getAttribute('data-sort');
            const label = th.getAttribute('data-label') || th.textContent.replace(/ [â†‘â†“]$/, '');
            th.classList.remove('sort-asc', 'sort-desc');
            if (key === kayitlarSortKey) {
              th.classList.add(kayitlarSortDir === 1 ? 'sort-asc' : 'sort-desc');
            }
            th.textContent = label;
          });
        }

        function renderKayitlar() {
          const tbody = qs('#tbodyKayitlar');
          tbody.innerHTML = '';

          let filtered = [...kayitlar];

          const ay = qs('#filtreAy').value;
          if (ay) filtered = filtered.filter(k => k.ay === parseInt(ay));

          const tip = qs('#filtreTip').value;
          if (tip) filtered = filtered.filter(k => k.tip === tip);

          const tarih = qs('#filtreTarih').value;
          if (tarih) {
            filtered = filtered.filter(k => {
              let kTarih = '';
              if (k.tarih) {
                if (typeof k.tarih === 'string') {
                  kTarih = k.tarih.slice(0, 10);
                } else if (k.tarih instanceof Date) {
                  kTarih = k.tarih.toISOString().slice(0, 10);
                } else {
                  const d = new Date(k.tarih);
                  if (!isNaN(d.getTime())) {
                    kTarih = d.toISOString().slice(0, 10);
                  }
                }
              } else if (k.createdAt) {
                if (typeof k.createdAt === 'string') {
                  kTarih = k.createdAt.slice(0, 10);
                } else if (k.createdAt instanceof Date) {
                  kTarih = k.createdAt.toISOString().slice(0, 10);
                } else {
                  const d = new Date(k.createdAt);
                  if (!isNaN(d.getTime())) {
                    kTarih = d.toISOString().slice(0, 10);
                  }
                }
              }
              return kTarih === tarih;
            });
          }

          const ara = qs('#araInput').value.trim();
          if (ara) {
            filtered = filtered.filter(k =>
              turkishIncludes(k.sahip || '', ara) ||
              turkishIncludes(k.personel || '', ara)
            );
          }

          if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="12" style="text-align:center;color:var(--muted);padding:20px">KayÄ±t bulunamadÄ±</td></tr>';
            updateKayitlarSortHeaders();
            return;
          }

          // SÃ¼tun baÅŸlÄ±ÄŸÄ±na gÃ¶re sÄ±rala
          if (kayitlarSortKey) {
            filtered.sort((a, b) => {
              const getVal = (k, key) => {
                if (key === 'islemTarihi') {
                  const u = k.updatedat || k.updatedAt || k.createdat || k.createdAt;
                  return u ? new Date(u).getTime() : 0;
                }
                if (key === 'tarih') {
                  const t = k.tarih;
                  return t ? (t instanceof Date ? t.getTime() : new Date(t).getTime()) : 0;
                }
                if (key === 'tip') return (k.tip || '').toString();
                if (key === 'sahip') return (k.sahip || k.bagisci || '').toString();
                if (key === 'tutar') return Number(k.tutar || k.miktar || 0);
                if (key === 'istirak') return k.istirak ? 1 : 0;
                if (key === 'musafirAdedi') return Number(k.musafirAdedi || k.musafiradedi || 0);
                if (key === 'mahal') return (k.mahal || '').toString();
                if (key === 'personel') return (k.personelAdi || k.personeladi || k.personel || '').toString();
                if (key === 'notlar') return (k.notlar || k.not || k.aciklama || '').toString();
                return '';
              };
              const va = getVal(a, kayitlarSortKey);
              const vb = getVal(b, kayitlarSortKey);
              let cmp = 0;
              if (typeof va === 'number' && typeof vb === 'number') cmp = va - vb;
              else cmp = String(va).localeCompare(String(vb), 'tr');
              return cmp * kayitlarSortDir;
            });
          }

          updateKayitlarSortHeaders();

          filtered.forEach(k => {
            const tr = document.createElement('tr');
            
            // Ä°ÅŸlem Tarihi (kaydÄ±n yapÄ±ldÄ±ÄŸÄ±/gÃ¼ncellendiÄŸi tarih)
            // Ã–ncelik: updatedat > createdat (gÃ¼ncelleme varsa onu gÃ¶ster)
            let islemTarihi = null;
            if (k.updatedat) {
              if (typeof k.updatedat === 'string') {
                islemTarihi = new Date(k.updatedat);
              } else if (k.updatedat instanceof Date) {
                islemTarihi = k.updatedat;
              } else {
                islemTarihi = new Date(k.updatedat);
              }
            } else if (k.updatedAt) {
              if (typeof k.updatedAt === 'string') {
                islemTarihi = new Date(k.updatedAt);
              } else if (k.updatedAt instanceof Date) {
                islemTarihi = k.updatedAt;
              } else {
                islemTarihi = new Date(k.updatedAt);
              }
            } else if (k.createdat) {
              if (typeof k.createdat === 'string') {
                islemTarihi = new Date(k.createdat);
              } else if (k.createdat instanceof Date) {
                islemTarihi = k.createdat;
              } else {
                islemTarihi = new Date(k.createdat);
              }
            } else if (k.createdAt) {
              if (typeof k.createdAt === 'string') {
                islemTarihi = new Date(k.createdAt);
              } else if (k.createdAt instanceof Date) {
                islemTarihi = k.createdAt;
              } else {
                islemTarihi = new Date(k.createdAt);
              }
            }
            if (!islemTarihi || isNaN(islemTarihi.getTime())) {
              islemTarihi = new Date();
            }

            // Tarih (kayÄ±t aÅŸamasÄ±nda seÃ§ilen tarih - iftar/sahur/teberru/taahhut tarihi)
            // Ã–ncelik: tarih > iÅŸlem tarihi (kayÄ±t aÅŸamasÄ±nda seÃ§ilen tarih Ã¶ncelikli)
            let tarih = null;
            if (k.tarih) {
              if (typeof k.tarih === 'string') {
                tarih = new Date(k.tarih);
              } else if (k.tarih instanceof Date) {
                tarih = k.tarih;
              } else {
                tarih = new Date(k.tarih);
              }
            }
            if (!tarih || isNaN(tarih.getTime())) {
              tarih = islemTarihi; // Fallback olarak iÅŸlem tarihini kullan
            }

            // Tip etiketi
            let tipLabel = '';
            if (k.tip === 'iftar') {
              tipLabel = 'ğŸŒ™ Ä°ftar';
            } else if (k.tip === 'sahur') {
              tipLabel = 'ğŸŒŸ Sahur';
            } else if (k.tip === 'teberru') {
              tipLabel = 'ğŸ’ Teberru';
            } else if (k.tip === 'taahhut') {
              tipLabel = 'ğŸ“‹ TaahhÃ¼t';
            }

            // Sahip/BaÄŸÄ±ÅŸÃ§Ä± bilgisi
            const sahipBilgisi = k.sahip || k.bagisci || '-';
            // Tutar/Miktar bilgisi
            const tutarBilgisi = k.tutar || k.miktar || 0;

            // Tahsilat Ã¶zeti (sadece iftar/sahur ve tutar > 0)
            const hasTahsilat = (k.tip === 'iftar' || k.tip === 'sahur' || k.tip === 'taahhut') && Number(k.tutar || k.miktar || 0) > 0;
            const toplamTahsilat = hasTahsilat ? (tahsilatByKayitId[k.id] || 0) : 0;
            const kayitTutari = Number(k.tutar || k.miktar || 0);
            const kalan = kayitTutari - toplamTahsilat;
            let tahsilatDurum = '-';
            if (hasTahsilat) {
              if (toplamTahsilat >= kayitTutari) tahsilatDurum = 'Ã–dendi';
              else if (toplamTahsilat > 0) tahsilatDurum = `â‚º${toplamTahsilat.toLocaleString('tr-TR', { minimumFractionDigits: 2 })} / â‚º${kalan.toLocaleString('tr-TR', { minimumFractionDigits: 2 })} kalan`;
              else tahsilatDurum = 'Beklemede';
            }

            tr.innerHTML = `
          <td>${islemTarihi.getDate()}.${islemTarihi.getMonth() + 1}.${islemTarihi.getFullYear()}</td>
          <td>${tarih.getDate()}.${tarih.getMonth() + 1}.${tarih.getFullYear()}</td>
          <td><span class="badge-chip ${k.tip}">${tipLabel}</span></td>
          <td><strong>${sahipBilgisi}</strong></td>
          <td class="right"><strong>â‚º${Number(tutarBilgisi).toLocaleString('tr-TR', { minimumFractionDigits: 2 })}</strong></td>
          <td style="font-size:12px">${tahsilatDurum}</td>
          <td>${k.istirak !== undefined ? (k.istirak ? 'âœ“ Evet' : 'âœ— HayÄ±r') : '-'}</td>
          <td>${k.musafirAdedi || k.musafiradedi || 0}</td>
          <td>${k.mahal || '-'}</td>
          <td>${k.personelAdi || k.personeladi || k.personel || k.kaydedenPersonel || k.kaydedenpersonel || '-'}</td>
          <td class="not-hucre" title="${k.notlar || k.not || k.aciklama || ''}">${k.notlar || k.not || k.aciklama || '-'}</td>
          <td>
            <button onclick="editKayit('${k.id}', '${k.kayitTipi || 'iftar-sahur'}')" style="padding:4px 8px;font-size:12px">DÃ¼zenle</button>
            ${(k.tip === 'iftar' || k.tip === 'sahur') ? `<button onclick="generateDavetiye('${(k.sahip || k.bagisci || '').toString().replace(/'/g, "\\'")}', '${k.tip || 'iftar'}', '${tarih.toISOString()}', ${Number(k.musafirAdedi || k.musafiradedi || 0)})" style="padding:4px 8px;font-size:12px;background:#d4af37;color:white;border:none;border-radius:6px;cursor:pointer;">ğŸ« Davetiye</button>` : ''}
            ${hasTahsilat ? `<button onclick="openTahsilatModal('${k.id}')" style="padding:4px 8px;font-size:12px;background:#28a745;color:white;border:none;border-radius:6px;cursor:pointer;">Tahsilat</button>` : ''}
            <button onclick="deleteKayit('${k.id}', '${k.kayitTipi || 'iftar-sahur'}')" class="danger" style="padding:4px 8px;font-size:12px">Sil</button>
          </td>
        `;
            tbody.appendChild(tr);
          });
        }

        function stripMuhasebeNotu(text) {
          if (!text || typeof text !== 'string') return '';
          return text.replace(/\s*\|\s*KayÄ±t yapan\/gÃ¼ncelleyen: Muhasebe/g, '').replace(/^KayÄ±t yapan\/gÃ¼ncelleyen: Muhasebe\s*\|\s*/i, '').trim();
        }

        async function openEditModal(id = null, kayitTipi = 'iftar-sahur') {
          try {
            qs('#editId').value = id || '';
            qs('#editTitle').textContent = id ? 'KayÄ±t DÃ¼zenle' : 'Yeni KayÄ±t';

            // MahallarÄ± ve personelleri yÃ¼kle (hata olsa bile modal aÃ§Ä±lmalÄ±)
            try {
              await Promise.all([loadMahallarForEdit(), loadPersonellerForEdit()]);
            } catch (loadError) {
              console.warn('Mahal/Personel yÃ¼kleme hatasÄ± (modal aÃ§Ä±lmaya devam ediyor):', loadError);
            }

            if (id) {
              const k = kayitlar.find(k => k.id === id);
              if (k) {
                // Firestore Timestamp kontrolÃ¼
                let tarihStr = '';
                if (k.tarih) {
                  if (k.tarih.toDate) {
                    tarihStr = k.tarih.toDate().toISOString().slice(0, 10);
                  } else if (k.tarih instanceof Date) {
                    tarihStr = k.tarih.toISOString().slice(0, 10);
                  } else if (typeof k.tarih === 'string') {
                    tarihStr = k.tarih.slice(0, 10);
                  } else if (k.tarih.seconds) {
                    tarihStr = new Date(k.tarih.seconds * 1000).toISOString().slice(0, 10);
                  }
                } else if (k.createdAt) {
                  if (k.createdAt.toDate) {
                    tarihStr = k.createdAt.toDate().toISOString().slice(0, 10);
                  } else if (k.createdAt.seconds) {
                    tarihStr = new Date(k.createdAt.seconds * 1000).toISOString().slice(0, 10);
                  }
                }
                qs('#editTarih').value = tarihStr;
                qs('#editTip').value = k.tip;

                // Ä°ftar/sahur ise tarih select'i de gÃ¼ncelle
                if (k.tip === 'iftar' || k.tip === 'sahur') {
                  if (qs('#editTarihSelect')) {
                    qs('#editTarihSelect').value = tarihStr;
                  }
                }

                // Tip'e gÃ¶re alanlarÄ± doldur
                if (k.tip === 'iftar' || k.tip === 'sahur') {
                  qs('#editSahip').value = k.sahip || '';
                  qs('#editTutar').value = k.tutar || 0;
                  qs('#editIstirak').value = k.istirak !== undefined ? (k.istirak ? 'true' : 'false') : 'false';
                  qs('#editMusafir').value = k.musafirAdedi || k.musafiradedi || 0;

                  // Mahal seÃ§imi - mapping'den gelen verileri kullan
                  const mahalIdVal = k.mahalId || k.mahalid;
                  if (mahalIdVal) {
                    qs('#editMahal').value = mahalIdVal;
                  } else if (k.mahal) {
                    // Mahal adÄ±ndan ID bul
                    const mahal = mahalList.find(m => m.adi === k.mahal);
                    if (mahal) {
                      qs('#editMahal').value = mahal.id;
                    }
                  }
                } else if (k.tip === 'teberru' || k.tip === 'taahhut') {
                  qs('#editBagisci').value = k.bagisci || k.sahip || '';
                  qs('#editMiktar').value = k.miktar || k.tutar || 0;
                  qs('#editAciklama').value = k.aciklama || k.notlar || k.not || '';
                  if (k.tip === 'teberru') {
                    qs('#editOdeme').value = k.odemeYontemi || k.odeme || '';
                  }
                }

                // Personel seÃ§imi - mapping'den gelen verileri kullan
                const personelUidVal = k.personelUid || k.personeluid;
                if (personelUidVal) {
                  qs('#editPersonel').value = personelUidVal;
                } else {
                  // Personel adÄ±ndan UID bul
                  const personelAdiVal = k.personelAdi || k.personeladi || k.personel || k.kaydedenPersonel || k.kaydedenpersonel;
                  if (personelAdiVal) {
                    const personel = kullanicilarList.find(p =>
                      p.adsoyad === personelAdiVal || p.adsoyad === k.personel || p.adsoyad === k.personelAdi
                    );
                    if (personel) {
                      qs('#editPersonel').value = personel.id;
                    }
                  }
                }

                // Not ve muhasebe checkbox (tÃ¼m tipler iÃ§in)
                qs('#editNotlar').value = stripMuhasebeNotu(k.notlar || k.not || k.aciklama || '');
                qs('#editMuhasebeNotu').checked = (k.notlar || k.not || k.aciklama || '').includes('Muhasebe');

                // KayÄ±t tipini sakla (gÃ¼ncelleme iÃ§in)
                qs('#editId').setAttribute('data-kayit-tipi', k.kayitTipi || (k.tip === 'teberru' || k.tip === 'taahhut' ? k.tip : 'iftar-sahur'));
                qs('#editId').setAttribute('data-kayit-koleksiyon', k.kayitKoleksiyon ||
                  (k.tip === 'teberru' ? 'teberru_kayitlari' : k.tip === 'taahhut' ? 'taahhut_kayitlari' : 'kayitlar'));
              }
            } else {
              qs('#formEdit').reset();
              qs('#editTarih').value = '';
              qs('#editTarihSelect').value = '';
              qs('#editMahal').value = '';
              qs('#editPersonel').value = '';
              qs('#editTip').value = '';
              qs('#editNotlar').value = '';
              qs('#editMuhasebeNotu').checked = true;
              qs('#editId').removeAttribute('data-kayit-tipi');
              qs('#editId').removeAttribute('data-kayit-koleksiyon');
            }

            // Tip'e gÃ¶re alanlarÄ± gÃ¶ster/gizle
            try {
              await updateEditFormFields();
            } catch (updateError) {
              console.warn('Form alanlarÄ± gÃ¼ncelleme hatasÄ± (modal aÃ§Ä±lmaya devam ediyor):', updateError);
            }

            // Modal elementini kontrol et ve aÃ§
            const modalElement = qs('#modalEdit');
            if (!modalElement) {
              console.error('Modal elementi bulunamadÄ±: #modalEdit');
              showToast('Modal elementi bulunamadÄ±. LÃ¼tfen sayfayÄ± yenileyin.', '', 'error');
              return;
            }

            // Debug: Modal durumunu kontrol et
            console.log('Modal aÃ§Ä±lÄ±yor...', {
              modalElement: !!modalElement,
              sheetElement: !!qs('#modalEdit .sheet'),
              currentClasses: modalElement.className
            });

            // Modal aÃ§Ä±lma zamanÄ±nÄ± kaydet
            lastModalOpenTime = Date.now();

            // ButonlarÄ±n Ã§alÄ±ÅŸtÄ±ÄŸÄ±ndan emin ol
            const iptalBtn = modalElement.querySelector('button[type="button"].secondary');
            const kaydetBtn = modalElement.querySelector('button[type="submit"]');
            const formEdit = modalElement.querySelector('#formEdit');

            if (iptalBtn) {
              // Ä°ptal butonunu gÃ¼venli hale getir
              iptalBtn.style.pointerEvents = 'auto';
              iptalBtn.style.cursor = 'pointer';
              iptalBtn.style.zIndex = '10002';
              iptalBtn.style.position = 'relative';
              // onclick zaten var, ama ekstra gÃ¼venlik iÃ§in event listener ekle
              iptalBtn.addEventListener('click', function (e) {
                e.preventDefault();
                e.stopImmediatePropagation();
                closeEditModal();
              }, true);
            }

            if (kaydetBtn) {
              // Kaydet butonunu gÃ¼venli hale getir
              kaydetBtn.style.pointerEvents = 'auto';
              kaydetBtn.style.cursor = 'pointer';
              kaydetBtn.style.zIndex = '10002';
              kaydetBtn.style.position = 'relative';
            }

            if (formEdit) {
              // Form'un submit event'ini kontrol et
              formEdit.style.pointerEvents = 'auto';
              // Form submit event listener'Ä±nÄ±n Ã§alÄ±ÅŸtÄ±ÄŸÄ±ndan emin ol
              console.log('Form submit listener kontrol ediliyor...');
            }

            // Modal'Ä± aÃ§
            modalElement.classList.add('show');
            document.body.classList.add('modal-open');

            // Force reflow - CSS'in dÃ¼zgÃ¼n uygulanmasÄ± iÃ§in
            void modalElement.offsetHeight;

            // Sheet elementinin gÃ¶rÃ¼nÃ¼r olduÄŸundan emin ol
            const sheetElement = modalElement.querySelector('.sheet');
            if (!sheetElement) {
              console.error('âŒ Sheet elementi bulunamadÄ±!');
              showToast('Modal iÃ§eriÄŸi bulunamadÄ±. LÃ¼tfen sayfayÄ± yenileyin.', '', 'error');
              return;
            }

            // Sheet'i kesinlikle gÃ¶rÃ¼nÃ¼r yap - inline style ile override et
            // Ã–nce mevcut style'Ä± al, sonra ekle
            const existingStyle = sheetElement.getAttribute('style') || '';
            sheetElement.setAttribute('style', existingStyle +
              'display: block; ' +
              'visibility: visible; ' +
              'opacity: 1; ' +
              'position: relative; ' +
              'z-index: 10001; ' +
              'background: #fff; ' +
              'max-width: 700px; ' +
              'width: 100%; ' +
              'max-height: 90vh; ' +
              'overflow-y: auto; ' +
              'border-radius: 16px; ' +
              'padding: 20px; ' +
              'border: 1px solid var(--border); ' +
              'box-shadow: 0 20px 40px rgba(0,0,0,.2);'
            );

            // CSS class ekle (eÄŸer varsa)
            sheetElement.classList.add('sheet-visible');

            // editTip change listener'Ä±nÄ± tekrar kur (form clone edildiÄŸinde kaybolmuÅŸ olabilir)
            const editTipSelect = qs('#editTip');
            if (editTipSelect) {
              // Ã–nce mevcut listener'larÄ± temizle
              const newSelect = editTipSelect.cloneNode(true);
              const currentValue = editTipSelect.value;
              editTipSelect.parentNode.replaceChild(newSelect, editTipSelect);
              qs('#editTip').value = currentValue;

              // Yeni listener ekle
              qs('#editTip').addEventListener('change', async function () {
                console.log('âœ… Tip deÄŸiÅŸti:', this.value);
                try {
                  await updateEditFormFields();
                } catch (error) {
                  console.error('updateEditFormFields hatasÄ±:', error);
                }
              });
              console.log('âœ… editTip change listener modal aÃ§Ä±ldÄ±ÄŸÄ±nda kuruldu');
            }

            // Debug: Modal aÃ§Ä±ldÄ±ktan sonra durumu kontrol et ve sheet'i gÃ¶rÃ¼nÃ¼r tut
            let checkInterval = setInterval(() => {
              if (!modalElement.classList.contains('show')) {
                clearInterval(checkInterval);
                return;
              }

              const computedStyle = window.getComputedStyle(modalElement);
              const sheetComputed = window.getComputedStyle(sheetElement);

              // Sheet gÃ¶rÃ¼nmÃ¼yorsa zorla gÃ¶rÃ¼nÃ¼r yap
              if (sheetComputed.display === 'none' || sheetComputed.visibility === 'hidden' || parseFloat(sheetComputed.opacity) < 0.1) {
                console.warn('âš ï¸ Sheet gÃ¶rÃ¼nmÃ¼yor, zorla gÃ¶rÃ¼nÃ¼r yapÄ±lÄ±yor...');
                sheetElement.classList.add('sheet-visible');
                sheetElement.style.display = 'block';
                sheetElement.style.visibility = 'visible';
                sheetElement.style.opacity = '1';
              }
            }, 50);

            // 5 saniye sonra interval'i temizle
            setTimeout(() => clearInterval(checkInterval), 5000);

            // Ä°lk kontrol
            setTimeout(() => {
              const computedStyle = window.getComputedStyle(modalElement);
              const sheetComputed = window.getComputedStyle(sheetElement);
              const debugInfo = {
                modalDisplay: computedStyle.display,
                modalVisibility: computedStyle.visibility,
                modalOpacity: computedStyle.opacity,
                modalZIndex: computedStyle.zIndex,
                hasShowClass: modalElement.classList.contains('show'),
                sheetDisplay: sheetComputed.display,
                sheetVisibility: sheetComputed.visibility,
                sheetOpacity: sheetComputed.opacity,
                sheetZIndex: sheetComputed.zIndex,
                sheetWidth: sheetComputed.width,
                sheetHeight: sheetComputed.height,
                sheetPosition: sheetComputed.position
              };
              console.log('âœ… Modal aÃ§Ä±ldÄ±, durum:', debugInfo);
            }, 100);
          } catch (error) {
            console.error('Modal aÃ§ma hatasÄ±:', error);
            // Hata olsa bile modalÄ± aÃ§mayÄ± dene
            try {
              const modalElement = qs('#modalEdit');
              if (modalElement) {
                modalElement.classList.add('show');
                document.body.classList.add('modal-open');
              } else {
                console.error('Modal elementi bulunamadÄ±: #modalEdit');
                showToast('Modal aÃ§Ä±lÄ±rken bir hata oluÅŸtu. LÃ¼tfen sayfayÄ± yenileyin.', '', 'error');
              }
            } catch (e) {
              console.error('Modal aÃ§Ä±lamadÄ±:', e);
              showToast('Modal aÃ§Ä±lÄ±rken bir hata oluÅŸtu. LÃ¼tfen sayfayÄ± yenileyin.', '', 'error');
            }
          }
        }

        async function loadMahallarForEdit() {
          try {
            const supabase = getSupabase();
            if (!supabase) {
              console.error('Supabase client hazÄ±r deÄŸil');
              return;
            }
            const { data, error } = await supabase
              .from('ramazan_mahaller')
              .select('*')
              .order('adi', { ascending: true });

            if (error) {
              console.error('Mahaller yÃ¼klenemedi:', error);
              return;
            }

            const mahallar = (data || []).map(d => ({ id: d.id, ...d }));

            const select = qs('#editMahal');
            if (!select) return;

            // Mevcut seÃ§ili deÄŸeri sakla
            const currentValue = select.value;

            // Select'i temizle ve mahallarÄ± ekle
            select.innerHTML = '<option value="">Mahal SeÃ§iniz</option>';
            mahallar.forEach(m => {
              const option = document.createElement('option');
              option.value = m.id;
              option.textContent = m.adi || '-';
              select.appendChild(option);
            });

            // Ã–nceki deÄŸeri geri yÃ¼kle
            if (currentValue) {
              select.value = currentValue;
            }
          } catch (e) {
            console.error('Mahaller yÃ¼klenemedi:', e);
          }
        }

        async function loadPersonellerForEdit() {
          try {
            // KullanÄ±cÄ±lar listesi yoksa yÃ¼kle
            if (!kullanicilarList || kullanicilarList.length === 0) {
              await loadKullanicilar();
            }

            const select = qs('#editPersonel');
            if (!select) return;

            // Mevcut seÃ§ili deÄŸeri sakla
            const currentValue = select.value;

            // Select'i temizle ve personelleri ekle
            select.innerHTML = '<option value="">Personel SeÃ§iniz</option>';
            kullanicilarList.forEach(p => {
              const option = document.createElement('option');
              option.value = p.id;
              option.textContent = p.adsoyad || p.email || '-';
              select.appendChild(option);
            });

            // Ã–nceki deÄŸeri geri yÃ¼kle
            if (currentValue) {
              select.value = currentValue;
            }
          } catch (e) {
            console.error('Personeller yÃ¼klenemedi:', e);
          }
        }

        function closeEditModal() {
          const modalElement = qs('#modalEdit');
          if (modalElement) {
            modalElement.classList.remove('show');
            document.body.classList.remove('modal-open');

            // Form'u temizle
            const formEdit = qs('#formEdit');
            if (formEdit) {
              formEdit.reset();
            }

            // TÃ¼m input'larÄ± temizle
            modalElement.querySelectorAll('input, select, textarea').forEach(el => {
              if (el.type !== 'hidden') {
                el.value = '';
              }
            });

            console.log('âœ… Modal kapatÄ±ldÄ±');
          }
        }

        // Window'a expose et (onclick iÃ§in)
        window.closeEditModal = closeEditModal;

        function closeTahsilatModal() {
          const modalElement = qs('#modalTahsilat');
          if (modalElement) {
            modalElement.classList.remove('show');
            document.body.classList.remove('modal-open');
            const formTahsilat = qs('#formTahsilat');
            if (formTahsilat) formTahsilat.reset();
          }
        }
        window.closeTahsilatModal = closeTahsilatModal;

        async function openTahsilatModal(kayitId) {
          const k = kayitlar.find(x => x.id === kayitId);
          if (!k || (k.tip !== 'iftar' && k.tip !== 'sahur' && k.tip !== 'taahhut') || Number(k.tutar || k.miktar || 0) <= 0) return;
          const tipLabel = k.tip === 'iftar' ? 'Ä°ftar' : k.tip === 'sahur' ? 'Sahur' : 'TaahhÃ¼t';
          const toplamTutar = tahsilatByKayitId[kayitId] || 0;
          const kayitTutari = Number(k.tutar || k.miktar || 0);
          const kalan = kayitTutari - toplamTutar;
          qs('#tahsilatKayitId').value = kayitId;
          qs('#tahsilatTitle').textContent = `Tahsilat - ${k.sahip || k.bagisci || '-'} (${tipLabel})`;
          qs('#tahsilatKayitBilgi').innerHTML = `
            <strong>Toplam tutar:</strong> â‚º${kayitTutari.toLocaleString('tr-TR', { minimumFractionDigits: 2 })} &nbsp;
            <strong>Tahsil edilen:</strong> â‚º${toplamTutar.toLocaleString('tr-TR', { minimumFractionDigits: 2 })} &nbsp;
            <strong>Kalan:</strong> â‚º${kalan.toLocaleString('tr-TR', { minimumFractionDigits: 2 })}
          `;
          const list = tahsilatListByKayitId[kayitId] || [];
          const ul = qs('#tahsilatListe');
          ul.innerHTML = '';
          if (list.length === 0) {
            ul.innerHTML = '<li style="color:var(--muted);padding:8px 0;">HenÃ¼z tahsilat yok</li>';
          } else {
            list.forEach((t, i) => {
              const tarihStr = t.tahsilat_tarihi ? (typeof t.tahsilat_tarihi === 'string' ? t.tahsilat_tarihi.slice(0, 10) : new Date(t.tahsilat_tarihi).toISOString().slice(0, 10)) : '-';
              const tipLabel = t.odeme_tipi === 'taksit' ? `Taksit ${t.taksit_no != null ? t.taksit_no : ''}` : 'PeÅŸin';
              const li = document.createElement('li');
              li.style.padding = '6px 0';
              li.style.borderBottom = '1px solid var(--border)';
              li.textContent = `${tarihStr} â€” â‚º${Number(t.tutar).toLocaleString('tr-TR', { minimumFractionDigits: 2 })} (${tipLabel})`;
              ul.appendChild(li);
            });
          }
          qs('#tahsilatTarih').value = new Date().toISOString().slice(0, 10);
          qs('#tahsilatTutar').value = '';
          qs('#tahsilatOdemeTipi').value = 'pesin';
          qs('#tahsilatGroupTaksitNo').style.display = 'none';
          qs('#tahsilatTaksitNo').value = '';
          qs('#tahsilatAciklama').value = '';
          qs('#modalTahsilat').classList.add('show');
          document.body.classList.add('modal-open');
        }
        window.openTahsilatModal = openTahsilatModal;

        // ESC tuÅŸu ile modal kapatma
        document.addEventListener('keydown', (e) => {
          if (e.key === 'Escape') {
            const modalCalDay = qs('#modalCalDay');
            if (modalCalDay && modalCalDay.classList.contains('show')) {
              closeCalDayModal();
              return;
            }
            const modalEdit = qs('#modalEdit');
            if (modalEdit && modalEdit.classList.contains('show')) {
              closeEditModal();
            }
            const modalTahsilat = qs('#modalTahsilat');
            if (modalTahsilat && modalTahsilat.classList.contains('show')) {
              closeTahsilatModal();
            }
            // DiÄŸer modallarÄ± da kapat
            const modalTutar = qs('#modalTutar');
            if (modalTutar && modalTutar.classList.contains('show')) {
              qs('#modalTutar').classList.remove('show');
              document.body.classList.remove('modal-open');
            }
          }
        });

        // Aktif ramazan ayarÄ±nÄ± yÃ¼kle
        let aktifRamazanAyar = null;
        async function loadAktifRamazanAyar() {
          try {
            const supabase = getSupabase();
            if (!supabase) {
              console.error('Supabase client hazÄ±r deÄŸil');
              return;
            }
            const { data, error } = await supabase
              .from('ramazan_yillar')
              .select('*')
              .eq('aktif', true)
              .limit(1)
              .single();
            if (!error && data) {
              aktifRamazanAyar = data;
            }
          } catch (e) {
            console.error('Aktif ramazan ayarÄ± yÃ¼klenemedi:', e);
          }
        }

        // Belirli bir yÄ±l iÃ§in ramazan ayarÄ±nÄ± yÃ¼kle
        let yilRamazanAyar = null;
        async function loadYilRamazanAyar(yil) {
          try {
            const supabase = getSupabase();
            if (!supabase) {
              console.error('Supabase client hazÄ±r deÄŸil');
              return;
            }
            const { data, error } = await supabase
              .from('ramazan_yillar')
              .select('*')
              .eq('yil', parseInt(yil))
              .limit(1)
              .single();
            if (!error && data) {
              yilRamazanAyar = data;
            } else {
              yilRamazanAyar = null;
            }
          } catch (e) {
            console.error(`${yil} yÄ±lÄ± ramazan ayarÄ± yÃ¼klenemedi:`, e);
            yilRamazanAyar = null;
          }
        }

        // Ramazan tarih aralÄ±ÄŸÄ±ndan tarih listesi oluÅŸtur (aktif veya belirli yÄ±l)
        function getRamazanTarihListesi(ramazanAyar = null) {
          const ayar = ramazanAyar || aktifRamazanAyar || yilRamazanAyar;
          if (!ayar || !ayar.baslangic || !ayar.bitis) {
            return [];
          }
          const baslangic = new Date(ayar.baslangic);
          const bitis = new Date(ayar.bitis);
          const tarihler = [];
          const currentDate = new Date(baslangic);
          while (currentDate <= bitis) {
            tarihler.push({
              value: currentDate.toISOString().slice(0, 10),
              label: currentDate.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric', weekday: 'long' })
            });
            currentDate.setDate(currentDate.getDate() + 1);
          }
          return tarihler;
        }

        // Tip deÄŸiÅŸtiÄŸinde alanlarÄ± gÃ¶ster/gizle
        async function updateEditFormFields() {
          console.log('ğŸ”„ updateEditFormFields Ã§aÄŸrÄ±ldÄ±');
          const tip = qs('#editTip').value;
          console.log('ğŸ“ SeÃ§ilen tip:', tip);

          if (!tip) {
            console.warn('âš ï¸ Tip seÃ§ilmemiÅŸ, tÃ¼m alanlar gizleniyor');
          }

          // Mevcut tarih deÄŸerini sakla (sÄ±fÄ±rlanmamasÄ± iÃ§in)
          const mevcutTarih = qs('#editTarih').value;
          const mevcutTarihSelect = qs('#editTarihSelect').value;

          // TÃ¼m gruplarÄ± gizle
          qs('#editGroupSahip').style.display = 'none';
          qs('#editGroupTutar').style.display = 'none';
          qs('#editGroupIstirak').style.display = 'none';
          qs('#editGroupMusafir').style.display = 'none';
          qs('#editGroupMahal').style.display = 'none';
          qs('#editGroupBagisci').style.display = 'none';
          qs('#editGroupMiktar').style.display = 'none';
          qs('#editGroupOdeme').style.display = 'none';
          qs('#editGroupAciklama').style.display = 'none';

          // Tarih alanlarÄ±nÄ± gizle
          qs('#editGroupTarih').style.display = 'none';
          qs('#editGroupTarihSelect').style.display = 'none';
          qs('#editTarih').removeAttribute('required');
          qs('#editTarihSelect').removeAttribute('required');

          // Required attribute'larÄ± kaldÄ±r
          qs('#editSahip').removeAttribute('required');
          qs('#editTutar').removeAttribute('required');
          qs('#editMusafir').removeAttribute('required');
          qs('#editBagisci').removeAttribute('required');
          qs('#editMiktar').removeAttribute('required');
          qs('#editOdeme').removeAttribute('required');

          if (tip === 'iftar' || tip === 'sahur') {
            // Ä°ftar/Sahur alanlarÄ± - SeÃ§ilen yÄ±la gÃ¶re ramazan tarih aralÄ±ÄŸÄ±ndan seÃ§im
            qs('#editGroupTarihSelect').style.display = 'block';
            qs('#editTarihSelect').setAttribute('required', 'required');

            // SeÃ§ilen yÄ±la gÃ¶re ramazan ayarÄ±nÄ± yÃ¼kle
            const yil = qs('#filtreYil')?.value || currentYil || new Date().getFullYear();
            await loadYilRamazanAyar(yil);
            const tarihler = getRamazanTarihListesi(yilRamazanAyar);
            const select = qs('#editTarihSelect');
            select.innerHTML = '<option value="">Tarih SeÃ§iniz</option>';
            tarihler.forEach(t => {
              const option = document.createElement('option');
              option.value = t.value;
              option.textContent = t.label;
              select.appendChild(option);
            });

            // Mevcut tarih deÄŸerini geri yÃ¼kle (eÄŸer varsa)
            if (mevcutTarih) {
              qs('#editTarih').value = mevcutTarih;
              if (mevcutTarihSelect) {
                qs('#editTarihSelect').value = mevcutTarihSelect;
              } else {
                // Tarih input deÄŸerine gÃ¶re select'i bul
                const tarihOption = Array.from(select.options).find(opt => opt.value === mevcutTarih);
                if (tarihOption) {
                  select.value = mevcutTarih;
                }
              }
            }

            // Tarih select deÄŸiÅŸtiÄŸinde date input'u da gÃ¼ncelle (sadece bir kez ekle)
            const existingListener = select.getAttribute('data-listener-added');
            if (!existingListener) {
              select.setAttribute('data-listener-added', 'true');
              select.addEventListener('change', function () {
                if (this.value) {
                  qs('#editTarih').value = this.value;
                }
              });
            }

            qs('#editGroupSahip').style.display = 'block';
            qs('#editGroupTutar').style.display = 'block';
            qs('#editGroupIstirak').style.display = 'block';
            qs('#editGroupMusafir').style.display = 'block';
            qs('#editGroupMahal').style.display = 'block';
            qs('#editSahip').setAttribute('required', 'required');
            qs('#editTutar').setAttribute('required', 'required');
            qs('#editMusafir').setAttribute('required', 'required');
          } else if (tip === 'teberru' || tip === 'taahhut') {
            // Teberru/TaahhÃ¼t alanlarÄ± - SeÃ§ilen yÄ±la gÃ¶re ramazan tarih aralÄ±ÄŸÄ±ndan seÃ§im
            qs('#editGroupTarihSelect').style.display = 'block';
            qs('#editTarihSelect').setAttribute('required', 'required');

            // SeÃ§ilen yÄ±la gÃ¶re ramazan ayarÄ±nÄ± yÃ¼kle
            const yil = qs('#filtreYil')?.value || currentYil || new Date().getFullYear();
            await loadYilRamazanAyar(yil);
            const tarihler = getRamazanTarihListesi(yilRamazanAyar);
            const select = qs('#editTarihSelect');
            select.innerHTML = '<option value="">Tarih SeÃ§iniz</option>';
            tarihler.forEach(t => {
              const option = document.createElement('option');
              option.value = t.value;
              option.textContent = t.label;
              select.appendChild(option);
            });

            // Mevcut tarih deÄŸerini geri yÃ¼kle (eÄŸer varsa)
            if (mevcutTarih) {
              qs('#editTarih').value = mevcutTarih;
              if (mevcutTarihSelect) {
                qs('#editTarihSelect').value = mevcutTarihSelect;
              } else {
                // Tarih input deÄŸerine gÃ¶re select'i bul
                const tarihOption = Array.from(select.options).find(opt => opt.value === mevcutTarih);
                if (tarihOption) {
                  select.value = mevcutTarih;
                }
              }
            }

            // Tarih select deÄŸiÅŸtiÄŸinde date input'u da gÃ¼ncelle (sadece bir kez ekle)
            const existingListener = select.getAttribute('data-listener-added');
            if (!existingListener) {
              select.setAttribute('data-listener-added', 'true');
              select.addEventListener('change', function () {
                if (this.value) {
                  qs('#editTarih').value = this.value;
                }
              });
            }

            // Date input'u da gÃ¶ster ama gizli tut (form submit iÃ§in gerekli)
            qs('#editGroupTarih').style.display = 'none';
            qs('#editTarih').removeAttribute('required');

            console.log('âœ… Teberru/TaahhÃ¼t tarih alanlarÄ± hazÄ±rlandÄ±');

            if (tip === 'teberru') {
              console.log('âœ… Teberru alanlarÄ± gÃ¶steriliyor');
              qs('#editGroupBagisci').style.display = 'block';
              qs('#editGroupMiktar').style.display = 'block';
              qs('#editGroupOdeme').style.display = 'block';
              qs('#editGroupAciklama').style.display = 'block';
              qs('#editBagisci').setAttribute('required', 'required');
              qs('#editMiktar').setAttribute('required', 'required');
              qs('#editOdeme').setAttribute('required', 'required');
            } else if (tip === 'taahhut') {
              console.log('âœ… TaahhÃ¼t alanlarÄ± gÃ¶steriliyor');
              qs('#editGroupBagisci').style.display = 'block';
              qs('#editGroupMiktar').style.display = 'block';
              qs('#editGroupAciklama').style.display = 'block';
              qs('#editBagisci').setAttribute('required', 'required');
              qs('#editMiktar').setAttribute('required', 'required');
            }
          }
        }

        // Tip deÄŸiÅŸtiÄŸinde event listener
        // Tip deÄŸiÅŸtiÄŸinde event listener fonksiyonu
        function setupEditTipChangeListener() {
          const editTipSelect = qs('#editTip');
          if (editTipSelect) {
            // Ã–nce mevcut listener'larÄ± temizle (varsa)
            const newSelect = editTipSelect.cloneNode(true);
            const currentValue = editTipSelect.value;
            editTipSelect.parentNode.replaceChild(newSelect, editTipSelect);
            qs('#editTip').value = currentValue;

            // Yeni listener ekle
            qs('#editTip').addEventListener('change', async function () {
              console.log('âœ… Tip deÄŸiÅŸti:', this.value);
              try {
                await updateEditFormFields();
              } catch (error) {
                console.error('updateEditFormFields hatasÄ±:', error);
              }
            });
            console.log('âœ… editTip change listener kuruldu');
          }
        }

        // Ä°lk kurulum
        setupEditTipChangeListener();

        // Window'a expose et (modal aÃ§Ä±ldÄ±ÄŸÄ±nda kullanÄ±labilir)
        window.setupEditTipChangeListener = setupEditTipChangeListener;

        // Form submit event listener - gÃ¼venli hale getir
        const formEditElement = qs('#formEdit');
        if (formEditElement) {
          // Ã–nce mevcut listener'larÄ± temizle (varsa)
          const newForm = formEditElement.cloneNode(true);
          formEditElement.parentNode.replaceChild(newForm, formEditElement);

          // Form clone edildikten sonra editTip event listener'Ä±nÄ± tekrar ekle
          setupEditTipChangeListener();

          // Yeni listener ekle
          qs('#formEdit').addEventListener('submit', async (e) => {
            e.preventDefault();
            e.stopPropagation();
            e.stopImmediatePropagation();

            console.log('âœ… Form submit tetiklendi');

            const id = qs('#editId').value;
            // Tarih seÃ§imi: iftar/sahur iÃ§in select, teberru/taahhut iÃ§in date input
            let tarih = '';
            if (qs('#editTarihSelect') && qs('#editTarihSelect').style.display !== 'none') {
              tarih = qs('#editTarihSelect').value || qs('#editTarih').value;
            } else {
              tarih = qs('#editTarih').value;
            }
            const tip = qs('#editTip').value;
            const personelUid = qs('#editPersonel').value || null;

            // Tip'e gÃ¶re alanlarÄ± al
            let sahip = '';
            let tutar = 0;
            let istirak = false;
            let musafirAdedi = 0;
            let mahalId = null;
            let bagisci = '';
            let miktar = 0;
            let odemeYontemi = '';
            let aciklama = '';

            if (tip === 'iftar' || tip === 'sahur') {
              sahip = qs('#editSahip').value.trim();
              tutar = parseFloat(qs('#editTutar').value) || 0;
              istirak = qs('#editIstirak').value === 'true';
              musafirAdedi = parseInt(qs('#editMusafir').value) || 0;
              mahalId = qs('#editMahal').value || null;

              if (!sahip) {
                showToast('error', 'Hata', 'LÃ¼tfen sahip adÄ±nÄ± giriniz');
                return;
              }
              if (!tutar || tutar <= 0) {
                showToast('error', 'Hata', 'LÃ¼tfen geÃ§erli bir tutar giriniz');
                return;
              }
            } else if (tip === 'teberru') {
              bagisci = qs('#editBagisci').value.trim();
              miktar = parseFloat(qs('#editMiktar').value) || 0;
              odemeYontemi = qs('#editOdeme').value || '';
              aciklama = qs('#editAciklama').value.trim();

              if (!bagisci) {
                showToast('error', 'Hata', 'LÃ¼tfen baÄŸÄ±ÅŸÃ§Ä± adÄ±nÄ± giriniz');
                return;
              }
              if (!miktar || miktar <= 0) {
                showToast('error', 'Hata', 'LÃ¼tfen geÃ§erli bir miktar giriniz');
                return;
              }
              if (!odemeYontemi) {
                showToast('error', 'Hata', 'LÃ¼tfen Ã¶deme yÃ¶ntemi seÃ§iniz');
                return;
              }
            } else if (tip === 'taahhut') {
              bagisci = qs('#editBagisci').value.trim();
              miktar = parseFloat(qs('#editMiktar').value) || 0;
              aciklama = qs('#editAciklama').value.trim();

              if (!bagisci) {
                showToast('error', 'Hata', 'LÃ¼tfen baÄŸÄ±ÅŸÃ§Ä± adÄ±nÄ± giriniz');
                return;
              }
              if (!miktar || miktar <= 0) {
                showToast('error', 'Hata', 'LÃ¼tfen geÃ§erli bir miktar giriniz');
                return;
              }
            }

            // Not iÃ§eriÄŸi ve muhasebe seÃ§imi (tÃ¼m tipler iÃ§in)
            const notIcerik = (qs('#editNotlar')?.value || '').trim();
            const muhasebeEkle = qs('#editMuhasebeNotu')?.checked ?? true;

            // KayÄ±t tipi ve koleksiyon bilgisini al
            const kayitTipi = qs('#editId').getAttribute('data-kayit-tipi') || (tip === 'teberru' || tip === 'taahhut' ? tip : 'iftar-sahur');
            const kayitKoleksiyon = qs('#editId').getAttribute('data-kayit-koleksiyon') ||
              (tip === 'teberru' ? 'teberru_kayitlari' : tip === 'taahhut' ? 'taahhut_kayitlari' : 'kayitlar');

            const date = new Date(tarih);
            const yil = date.getFullYear();
            const ay = date.getMonth() + 1;

            // Personel bilgisini al
            let personelAd = null;
            let personelUidFinal = personelUid;
            if (personelUid) {
              const personel = kullanicilarList.find(p => p.id === personelUid);
              if (personel) {
                personelAd = personel.adsoyad || personel.email;
              }
            }

            // Mahal bilgisini al
            let mahalAdi = null;
            if (mahalId) {
              const mahal = mahalList.find(m => m.id === mahalId);
              if (mahal) {
                mahalAdi = mahal.adi;
              } else {
                // EÄŸer mahalList'te yoksa tekrar yÃ¼kle
                try {
                  const supabase = getSupabase();
                  if (supabase) {
                    const { data: mahalData, error } = await supabase
                      .from('ramazan_mahaller')
                      .select('adi')
                      .eq('id', mahalId)
                      .single();
                    if (!error && mahalData) {
                      mahalAdi = mahalData.adi;
                    }
                  }
                } catch (e) {
                  console.error('Mahal bilgisi alÄ±namadÄ±:', e);
                }
              }
            }

            try {
              // Muhasebe notu
              const muhasebeNotu = 'KayÄ±t yapan/gÃ¼ncelleyen: Muhasebe';

              const supabase = getSupabase();
              if (!supabase) {
                showToast('error', 'Hata', 'Supabase client hazÄ±r deÄŸil');
                return;
              }

              if (kayitTipi === 'teberru' || kayitTipi === 'taahhut') {
                // Teberru veya TaahhÃ¼t kaydÄ±
                const data = {
                  bagisci: bagisci,
                  miktar: miktar,
                  tarih: tarih ? new Date(tarih).toISOString() : new Date().toISOString(),
                  yil: yil,
                  ay: ay,
                  updatedAt: new Date().toISOString()
                };

                // Yeni kayÄ±t iÃ§in id ekleme (Supabase otomatik oluÅŸturur)
                // GÃ¼ncelleme iÃ§in id zaten var, data'ya ekleme

                // Teberru iÃ§in Ã¶deme yÃ¶ntemi ekle
                if (tip === 'teberru') {
                  data.odemeyontemi = odemeYontemi; // Åemada odemeyontemi (kÃ¼Ã§Ã¼k harf)
                  data.odeme = odemeYontemi;
                }

                // Personel bilgisini ekle
                // Teberru tablosu: personel, kaydedenPersonel, personelUid, kaydedenPersonelUid (personelAdi ve kaydedenPersonelAdi YOK)
                if (personelAd) {
                  data.personel = personelAd;
                  data.kaydedenPersonel = personelAd;
                  // personelAdi ve kaydedenPersonelAdi kolonlarÄ± teberru_kayitlari tablosunda yok, ekleme
                }
                if (personelUidFinal) {
                  data.personelUid = personelUidFinal;
                  data.kaydedenPersonelUid = personelUidFinal;
                }

                // Not ve aÃ§Ä±klama (editNotlar + muhasebe seÃ§imine gÃ¶re)
                const userNot = notIcerik || aciklama;
                const finalAciklama = userNot + (muhasebeEkle ? (userNot ? ' | ' : '') + muhasebeNotu : '');
                data.not = finalAciklama;
                data.aciklama = finalAciklama;
                if (!id) data.createdAt = new Date().toISOString();

                // Yeni kayÄ±t iÃ§in id alanÄ±nÄ± kesinlikle ekleme
                // id deÄŸiÅŸkeni varsa bile data objesine ekleme
                if (!id) {
                  // Yeni kayÄ±t - id alanÄ±nÄ± kesinlikle ekleme
                  delete data.id;
                }

                if (tip === 'teberru') {
                  // Teberru iÃ§in LOWERCASE zorunluluÄŸu var (sqleditor.md'ye gÃ¶re)
                  // CamelCase -> Lowercase dÃ¶nÃ¼ÅŸÃ¼mÃ¼
                  if (data.createdAt) { data.createdat = data.createdAt; delete data.createdAt; }
                  if (data.updatedAt) { data.updatedat = data.updatedAt; delete data.updatedAt; }
                  if (data.personelUid) { data.personeluid = data.personelUid; delete data.personelUid; }
                  if (data.kaydedenPersonel) { data.kaydedenpersonel = data.kaydedenPersonel; delete data.kaydedenPersonel; }
                  if (data.kaydedenPersonelUid) { data.kaydedenpersoneluid = data.kaydedenPersonelUid; delete data.kaydedenPersonelUid; }
                  if (data.odemeYontemi) { data.odemeyontemi = data.odemeYontemi; delete data.odemeYontemi; }
                  // odeme zaten kÃ¼Ã§Ã¼k harf, deÄŸiÅŸtirmeye gerek yok
                  // odeme zaten kÃ¼Ã§Ã¼k harf, deÄŸiÅŸtirmeye gerek yok

                  if (id) {
                    const { error } = await supabase
                      .from('teberru_kayitlari')
                      .update(data)
                      .eq('id', id);
                    if (error) throw error;
                  } else {
                    // Yeni kayÄ±t - UUID oluÅŸtur (Supabase id alanÄ± iÃ§in gerekli)
                    let newId;
                    if (typeof crypto !== 'undefined' && crypto.randomUUID) {
                      newId = crypto.randomUUID();
                    } else {
                      // Fallback: basit UUID v4 oluÅŸtur
                      newId = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                        const r = Math.random() * 16 | 0;
                        const v = c === 'x' ? r : (r & 0x3 | 0x8);
                        return v.toString(16);
                      });
                    }

                    // data objesinden id'yi kaldÄ±r ve sadece gerekli alanlarÄ± al
                    const insertData = { ...data, id: newId };

                    // Supabase insert
                    const { data: newData, error } = await supabase
                      .from('teberru_kayitlari')
                      .insert(insertData)
                      .select()
                      .single();

                    if (error) {
                      console.error('âŒ Teberru kayÄ±t ekleme hatasÄ±:', error);
                      console.error('âŒ GÃ¶nderilen data:', insertData);
                      throw error;
                    }
                    console.log('âœ… Yeni teberru kaydÄ± oluÅŸturuldu:', newData.id, 'YÄ±l:', yil);
                  }
                } else if (tip === 'taahhut') {
                  // TaahhÃ¼t iÃ§in LOWERCASE zorunluluÄŸu var (sqleditor.md'ye gÃ¶re)
                  // CamelCase -> Lowercase dÃ¶nÃ¼ÅŸÃ¼mÃ¼
                  if (data.createdAt) { data.createdat = data.createdAt; delete data.createdAt; }
                  if (data.updatedAt) { data.updatedat = data.updatedAt; delete data.updatedAt; }
                  if (data.personelUid) { data.personeluid = data.personelUid; delete data.personelUid; }
                  if (data.personelAdi) { data.personeladi = data.personelAdi; delete data.personelAdi; }
                  if (data.kaydedenPersonel) { data.kaydedenpersonel = data.kaydedenPersonel; delete data.kaydedenPersonel; }
                  if (data.kaydedenPersonelAdi) { data.kaydedenpersoneladi = data.kaydedenPersonelAdi; delete data.kaydedenPersonelAdi; }
                  if (data.kaydedenPersonelUid) { data.kaydedenpersoneluid = data.kaydedenPersonelUid; delete data.kaydedenPersonelUid; }
                  delete data.tur;

                  if (id) {
                    // GÃ¼ncelleme
                    const { error } = await supabase
                      .from('taahhut_kayitlari')
                      .update(data)
                      .eq('id', id);
                    if (error) throw error;
                    console.log('âœ… Taahhut kaydÄ± gÃ¼ncellendi:', id);
                  } else {
                    // Yeni kayÄ±t - UUID oluÅŸtur
                    let newId;
                    if (typeof crypto !== 'undefined' && crypto.randomUUID) {
                      newId = crypto.randomUUID();
                    } else {
                      newId = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                        const r = Math.random() * 16 | 0;
                        const v = c === 'x' ? r : (r & 0x3 | 0x8);
                        return v.toString(16);
                      });
                    }

                    const insertData = { ...data, id: newId };

                    // Lowercase dÃ¶nÃ¼ÅŸÃ¼m garantisi (yeni insert iÃ§in)
                    if (insertData.createdAt) { insertData.createdat = insertData.createdAt; delete insertData.createdAt; }
                    if (insertData.updatedAt) { insertData.updatedat = insertData.updatedAt; delete insertData.updatedAt; }
                    if (insertData.personelUid) { insertData.personeluid = insertData.personelUid; delete insertData.personelUid; }
                    if (insertData.personelAdi) { insertData.personeladi = insertData.personelAdi; delete insertData.personelAdi; }
                    if (insertData.kaydedenPersonelAdi) { insertData.kaydedenpersoneladi = insertData.kaydedenPersonelAdi; delete insertData.kaydedenPersonelAdi; }
                    delete insertData.tur;

                    const { data: newData, error } = await supabase
                      .from('taahhut_kayitlari')
                      .insert(insertData)
                      .select()
                      .single();
                    if (error) {
                      console.error('âŒ Taahhut kayÄ±t ekleme hatasÄ±:', error);
                      console.error('âŒ GÃ¶nderilen data:', insertData);
                      throw error;
                    }
                    console.log('âœ… Yeni taahhut kaydÄ± oluÅŸturuldu:', newData.id, 'YÄ±l:', yil);
                  }
                }
              } else {
                // Ä°ftar-Sahur kaydÄ±
                const data = {
                  tarih: tarih ? new Date(tarih).toISOString() : new Date().toISOString(),
                  tip: tip,
                  sahip: sahip,
                  tutar: tutar,
                  istirak: istirak,
                  musafirAdedi: musafirAdedi,
                  yil: yil,
                  ay: ay,
                  updatedAt: new Date().toISOString()
                };

                // Personel bilgisini ekle
                if (personelAd) {
                  data.personelAdi = personelAd;
                  data.personel = personelAd;
                }
                if (personelUidFinal) {
                  data.personelUid = personelUidFinal;
                }

                // Mahal bilgisini ekle
                if (mahalId) {
                  data.mahalId = mahalId;
                }
                if (mahalAdi) {
                  data.mahal = mahalAdi;
                }

                // Ä°ftar-Sahur (ramazan_kayitlari) iÃ§in LOWERCASE zorunluluÄŸu var (sqleditor.md'ye gÃ¶re)
                if (data.createdAt) { data.createdat = data.createdAt; delete data.createdAt; }
                if (data.updatedAt) { data.updatedat = data.updatedAt; delete data.updatedAt; }
                if (data.personelUid) { data.personeluid = data.personelUid; delete data.personelUid; }
                // personelAdi -> personeladi
                if (data.personelAdi) { data.personeladi = data.personelAdi; delete data.personelAdi; }
                // mahalId -> mahalid
                if (data.mahalId) { data.mahalid = data.mahalId; delete data.mahalId; }
                // musafirAdedi -> musafiradedi (0 dahil gÃ¶nderilmeli - if (data.musafirAdedi) 0 iÃ§in false dÃ¶ner)
                if ('musafirAdedi' in data) {
                  data.musafiradedi = data.musafirAdedi;
                  delete data.musafirAdedi;
                }

                // Not (editNotlar + muhasebe seÃ§imine gÃ¶re)
                data.notlar = notIcerik + (muhasebeEkle ? (notIcerik ? ' | ' : '') + muhasebeNotu : '');

                if (id) {
                  const { error } = await supabase
                    .from('ramazan_kayitlari')
                    .update(data)
                    .eq('id', id);
                  if (error) throw error;
                } else {
                  // Yeni kayÄ±t (data.notlar zaten yukarÄ±da ayarlandÄ±)
                  data.createdat = new Date().toISOString();

                  // Yeni kayÄ±t - UUID oluÅŸtur
                  let newId;
                  if (typeof crypto !== 'undefined' && crypto.randomUUID) {
                    newId = crypto.randomUUID();
                  } else {
                    newId = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                      const r = Math.random() * 16 | 0;
                      const v = c === 'x' ? r : (r & 0x3 | 0x8);
                      return v.toString(16);
                    });
                  }

                  const insertData = { ...data, id: newId };

                  const { data: newData, error } = await supabase
                    .from('ramazan_kayitlari')
                    .insert(insertData)
                    .select()
                    .single();
                  if (error) {
                    console.error('âŒ Ä°ftar-Sahur kayÄ±t ekleme hatasÄ±:', error);
                    console.error('âŒ GÃ¶nderilen data:', insertData);
                    throw error;
                  }
                  console.log('âœ… Yeni iftar-sahur kaydÄ± oluÅŸturuldu:', newData.id, 'YÄ±l:', yil);
                }
              }

              showToast('success', 'BaÅŸarÄ±lÄ±', 'KayÄ±t kaydedildi');
              closeEditModal();
              // Firestore cache sorununu Ã¶nlemek iÃ§in daha uzun gecikme
              await new Promise(resolve => setTimeout(resolve, 1000));
              await loadKayitlar();
            } catch (e) {
              console.error('KayÄ±t kaydedilemedi:', e);
              showToast('error', 'Hata', 'KayÄ±t kaydedilemedi: ' + (e.message || e));
            }
          });
        } else {
          console.error('âŒ FormEdit elementi bulunamadÄ±!');
        }

        async function deleteKayit(id, kayitTipi = 'iftar-sahur') {
          const confirmed = await showConfirmModal(
            'KayÄ±t Silme',
            'Bu kaydÄ± silmek istediÄŸinizden emin misiniz?',
            'Sil',
            'danger'
          );

          if (!confirmed) return;

          try {
            const k = kayitlar.find(k => k.id === id);
            if (k) {
              const tip = kayitTipi || k.kayitTipi || 'iftar-sahur';
              const supabase = getSupabase();
              if (!supabase) {
                showToast('error', 'Hata', 'Supabase client hazÄ±r deÄŸil');
                return;
              }

              const koleksiyon = k.kayitKoleksiyon ||
                (tip === 'teberru' ? 'teberru_kayitlari' : tip === 'taahhut' ? 'taahhut_kayitlari' : 'ramazan_kayitlari');

              if (tip === 'teberru') {
                const { error } = await supabase
                  .from('teberru_kayitlari')
                  .delete()
                  .eq('id', id);
                if (error) throw error;
              } else if (tip === 'taahhut') {
                const { error } = await supabase
                  .from('taahhut_kayitlari')
                  .delete()
                  .eq('id', id);
                if (error) throw error;
              } else {
                // Ä°ftar-Sahur kaydÄ±
                const { error } = await supabase
                  .from('ramazan_kayitlari')
                  .delete()
                  .eq('id', id);
                if (error) throw error;
              }
              showToast('success', 'BaÅŸarÄ±lÄ±', 'KayÄ±t silindi');
              await loadKayitlar();
            }
          } catch (e) {
            console.error('KayÄ±t silinemedi:', e);
            showAlertModal('Hata', 'KayÄ±t silinemedi: ' + e.message);
          }
        }

        window.editKayit = editKayit;
        window.openEditModal = openEditModal;
        window.deleteKayit = deleteKayit;

        function editKayit(id, kayitTipi = 'iftar-sahur') {
          openEditModal(id, kayitTipi);
        }

        // Davetiye oluÅŸturma fonksiyonu (iftar-sahur-form.html ile aynÄ± mantÄ±k)
        function generateDavetiye(sahip, tip, tarihISO, musafirAdedi) {
          try {
            const tarih = new Date(tarihISO);
            if (isNaN(tarih.getTime())) {
              alert('GeÃ§ersiz tarih!');
              return;
            }

            const gunler = ['Pazar', 'Pazartesi', 'SalÄ±', 'Ã‡arÅŸamba', 'PerÅŸembe', 'Cuma', 'Cumartesi'];
            const gun = gunler[tarih.getDay()];

            const gregGun = tarih.getDate();
            const gregAy = tarih.getMonth() + 1;
            const gregYil = tarih.getFullYear();

            const aylar = ['OCAK', 'ÅUBAT', 'MART', 'NÄ°SAN', 'MAYIS', 'HAZÄ°RAN', 'TEMMUZ', 'AÄUSTOS', 'EYLÃœL', 'EKÄ°M', 'KASIM', 'ARALIK'];
            const gregAyAdi = aylar[gregAy - 1];

            const hasFamily = true;

            const params = new URLSearchParams({
              sahip: sahip || '',
              tip: tip || 'iftar',
              tarih: tarihISO,
              gun: gun,
              gregGun: gregGun.toString(),
              gregAy: gregAyAdi,
              gregYil: gregYil.toString(),
              hasFamily: hasFamily.toString()
            });

            const davetiyeUrl = `../sablonlar/davetiye.html?${params.toString()}`;
            window.open(davetiyeUrl, '_blank');
          } catch (error) {
            console.error('Davetiye oluÅŸturma hatasÄ±:', error);
            alert('Davetiye oluÅŸturulurken bir hata oluÅŸtu!');
          }
        }
        window.generateDavetiye = generateDavetiye;

        // Takvim gÃ¶rÃ¼nÃ¼mÃ¼ (Ramazan takvimine gÃ¶re tek sayfa)
        async function renderCalView() {
          const yil = parseInt(qs('#calYil').value);

          try {
            // SeÃ§ili yÄ±lÄ±n Ramazan takvimini yÃ¼kle
            await loadYilRamazanAyar(yil);

            const grid = qs('#calViewGrid');
            const detailBox = qs('#calDayDetail');
            const tbodyDetail = qs('#tbodyCalDay');
            if (!grid) return;

            // Ã–nce alanlarÄ± temizle
            grid.innerHTML = '';
            let summaryEl = qs('#calSummary');
            if (summaryEl) summaryEl.style.display = 'none';
            if (detailBox && tbodyDetail) {
              detailBox.style.display = 'none';
              tbodyDetail.innerHTML = '';
            }

            if (!yilRamazanAyar || !yilRamazanAyar.baslangic || !yilRamazanAyar.bitis) {
              const headerEl = qs('#calHeader');
              if (headerEl) headerEl.style.display = 'none';
              const summaryEl = qs('#calSummary');
              if (summaryEl) summaryEl.style.display = 'none';
              const info = document.createElement('div');
              info.style.gridColumn = 'span 7';
              info.style.padding = '24px';
              info.style.textAlign = 'center';
              info.style.color = 'var(--muted)';
              info.style.fontSize = '14px';
              info.style.background = '#f8f9fa';
              info.style.borderRadius = '12px';
              info.style.border = '1px dashed var(--border)';
              info.textContent = 'Bu yÄ±l iÃ§in Ramazan takvimi tanÄ±mlÄ± deÄŸil. LÃ¼tfen Ayarlar > Ramazan AyarlarÄ± bÃ¶lÃ¼mÃ¼nden ekleyin.';
              grid.appendChild(info);
              return;
            }

            const bas = new Date(yilRamazanAyar.baslangic);
            const bit = new Date(yilRamazanAyar.bitis);

            const headerEl = qs('#calHeader');
            const headerTitleEl = qs('#calHeaderTitle');
            if (headerEl && headerTitleEl) {
              headerEl.style.display = 'flex';
              headerTitleEl.textContent = 'Ramazan-Ä± Åerif ' + yil + ' â€¢ ' +
                bas.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long' }) + ' - ' +
                bit.toLocaleDateString('tr-TR', { day: 'numeric', month: 'long', year: 'numeric' });
            }

            const supabase = getSupabase();
            if (!supabase) {
              console.error('Supabase client hazÄ±r deÄŸil');
              return;
            }

            // Kapasite verilerini yÃ¼kle
            let genelKapasite = { iftarMax: null, sahurMax: null };
            const gunlukKapasiteMap = new Map();

            try {
              // Genel kapasiteyi yÃ¼kle
              const { data: genelData } = await supabase
                .from('ramazan_ayarlar')
                .select('iftarmax, sahurmax')
                .eq('id', 'genel')
                .single();

              if (genelData) {
                genelKapasite = {
                  iftarMax: genelData.iftarmax !== null && genelData.iftarmax !== undefined ? genelData.iftarmax : null,
                  sahurMax: genelData.sahurmax !== null && genelData.sahurmax !== undefined ? genelData.sahurmax : null
                };
              }

              // GÃ¼nlÃ¼k kapasiteleri yÃ¼kle (Ramazan dÃ¶nemi iÃ§in)
              const { data: gunlukData } = await supabase
                .from('ramazan_kapasite')
                .select('tarih, iftarmax, sahurmax')
                .eq('yil', yil)
                .gte('tarih', bas.toISOString())
                .lte('tarih', bit.toISOString());

              if (gunlukData) {
                gunlukData.forEach(k => {
                  const tarihStr = new Date(k.tarih).toISOString().slice(0, 10);
                  gunlukKapasiteMap.set(tarihStr, {
                    iftarMax: k.iftarmax !== null && k.iftarmax !== undefined ? k.iftarmax : null,
                    sahurMax: k.sahurmax !== null && k.sahurmax !== undefined ? k.sahurmax : null
                  });
                });
              }
            } catch (kapasiteError) {
              console.warn('Kapasite verileri yÃ¼klenemedi, devam ediliyor:', kapasiteError);
            }

            // TÃ¼m yÄ±l kayÄ±tlarÄ±nÄ± Ã§ek, Ramazan aralÄ±ÄŸÄ±nÄ± client-side filtrele
            const { data: tumKayitlarData, error } = await supabase
              .from('ramazan_kayitlari')
              .select('*')
              .eq('yil', yil);

            if (error) {
              console.error('Takvim kayÄ±tlarÄ± yÃ¼klenemedi:', error);
              return;
            }

            const tumKayitlar = (tumKayitlarData || []).map(d => ({ id: d.id, ...d }));
            const byDate = new Map();

            tumKayitlar.forEach(k => {
              if (!k.tarih) return;
              const tarihDate = typeof k.tarih === 'string' ? new Date(k.tarih) :
                (k.tarih instanceof Date ? k.tarih : new Date(k.tarih));
              if (isNaN(tarihDate.getTime())) return;
              if (tarihDate < bas || tarihDate > bit) return;
              const tarihStr = tarihDate.toISOString().slice(0, 10);
              if (!byDate.has(tarihStr)) byDate.set(tarihStr, []);
              byDate.get(tarihStr).push(k);
            });

            const startDay = (bas.getDay() + 6) % 7; // Pazartesi 0

            for (let i = 0; i < startDay; i++) {
              const div = document.createElement('div');
              div.className = 'cal-day';
              grid.appendChild(div);
            }

            const today = new Date();
            let selectedCell = null;

            const current = new Date(bas);
            while (current <= bit) {
              const dateStr = current.toISOString().slice(0, 10);
              const gunKayitlar = byDate.get(dateStr) || [];

              const div = document.createElement('div');
              div.className = 'cal-day';
              if (dateStr === today.toISOString().slice(0, 10)) div.classList.add('today');
              
              // Renk kodlamasÄ±: KayÄ±t durumuna gÃ¶re
              if (gunKayitlar.length === 0) {
                div.classList.add('no-data');
              } else {
                div.classList.add('has-data');
              }

              const gun = current.getDate();
              const ayIndex = current.getMonth(); // 0-11
              const ayAdi = current.toLocaleDateString('tr-TR', { month: 'long' });

              const iftarCount = gunKayitlar.filter(k => k.tip === 'iftar').length;
              const sahurCount = gunKayitlar.filter(k => k.tip === 'sahur').length;

              // Kapasite hesaplama
              const gunlukKapasite = gunlukKapasiteMap.get(dateStr);
              const iftarMax = gunlukKapasite?.iftarMax ?? genelKapasite.iftarMax;
              const sahurMax = gunlukKapasite?.sahurMax ?? genelKapasite.sahurMax;

              // Ä°ÅŸtirak edecek kayÄ±tlarÄ± say (sadece iÅŸtirak=true olanlar kapasiteye dahil)
              const istirakIftar = gunKayitlar.filter(k => k.tip === 'iftar' && k.istirak === true).length;
              const istirakSahur = gunKayitlar.filter(k => k.tip === 'sahur' && k.istirak === true).length;

              // Kalan kapasite
              const kalanIftar = iftarMax !== null ? iftarMax - istirakIftar : null;
              const kalanSahur = sahurMax !== null ? sahurMax - istirakSahur : null;

              // Durum belirleme
              const iftarDurum = iftarMax !== null
                ? (istirakIftar >= iftarMax ? 'dolu' : 
                   (istirakIftar >= iftarMax * 0.8 ? 'yakÄ±n' : 'bos'))
                : 'sinirsiz';

              const sahurDurum = sahurMax !== null
                ? (istirakSahur >= sahurMax ? 'dolu' : 
                   (istirakSahur >= sahurMax * 0.8 ? 'yakÄ±n' : 'bos'))
                : 'sinirsiz';

              // Kapasite durumu class'larÄ± ekle ve genel renk kodlamasÄ±
              let genelDurum = 'has-data'; // VarsayÄ±lan: mavi (kayÄ±t var)
              
              if (gunKayitlar.length === 0) {
                genelDurum = 'no-data'; // Beyaz (kayÄ±t yok)
              } else {
                // Ä°ftar veya Sahur'dan biri dolu ise kÄ±rmÄ±zÄ±
                if ((iftarMax !== null && iftarDurum === 'dolu') || (sahurMax !== null && sahurDurum === 'dolu')) {
                  genelDurum = 'capacity-full'; // KÄ±rmÄ±zÄ± (dolu)
                } 
                // Ä°ftar veya Sahur'dan biri yakÄ±n ise turuncu
                else if ((iftarMax !== null && iftarDurum === 'yakÄ±n') || (sahurMax !== null && sahurDurum === 'yakÄ±n')) {
                  genelDurum = 'capacity-warning'; // Turuncu (yakÄ±n)
                }
              }

              // Eski class'larÄ± kaldÄ±r, yeni genel durumu ekle
              div.classList.remove('no-data', 'has-data', 'capacity-warning', 'capacity-full');
              div.classList.add(genelDurum);

              // DetaylÄ± kapasite class'larÄ± (border-left iÃ§in)
              if (iftarMax !== null) {
                div.classList.add(`capacity-iftar-${iftarDurum}`);
              } else {
                div.classList.add('capacity-iftar-sinirsiz');
              }

              if (sahurMax !== null) {
                div.classList.add(`capacity-sahur-${sahurDurum}`);
              } else {
                div.classList.add('capacity-sahur-sinirsiz');
              }

              // Progress bar yÃ¼zdesi
              const iftarYuzde = iftarMax !== null ? Math.min((istirakIftar / iftarMax) * 100, 100) : 0;
              const sahurYuzde = sahurMax !== null ? Math.min((istirakSahur / sahurMax) * 100, 100) : 0;

              // Tooltip oluÅŸtur
              let tooltipText = `${gun} ${current.toLocaleDateString('tr-TR', { month: 'long', year: 'numeric' })}`;
              if (iftarCount > 0 || sahurCount > 0) {
                tooltipText += `\n\nÄ°ftar: ${iftarCount} kayÄ±t`;
                if (iftarMax !== null) {
                  tooltipText += `\nÄ°ÅŸtirak: ${istirakIftar}/${iftarMax}${kalanIftar > 0 ? ` (${kalanIftar} boÅŸ)` : ' (DOLU)'}`;
                } else {
                  tooltipText += '\nSÄ±nÄ±rsÄ±z';
                }
                tooltipText += `\n\nSahur: ${sahurCount} kayÄ±t`;
                if (sahurMax !== null) {
                  tooltipText += `\nÄ°ÅŸtirak: ${istirakSahur}/${sahurMax}${kalanSahur > 0 ? ` (${kalanSahur} boÅŸ)` : ' (DOLU)'}`;
                } else {
                  tooltipText += '\nSÄ±nÄ±rsÄ±z';
                }
              }
              div.setAttribute('title', tooltipText);

              div.innerHTML = `
            <div class="cal-day-header">
              <span class="cal-day-num">${gun}</span>
              <span class="cal-day-ay">${ayAdi}</span>
            </div>
            <div class="cal-capacity-info">
              ${iftarCount > 0 || iftarMax !== null ? `
                <div class="cal-capacity-item">
                  <span class="cal-capacity-label">Ä°ftar ${iftarCount} kayÄ±t</span>
                  ${iftarMax !== null ? `
                    <div class="cal-capacity-bar">
                      <div class="cal-capacity-fill ${iftarDurum}" style="width: ${iftarYuzde}%"></div>
                    </div>
                    <span class="cal-capacity-text">${istirakIftar}/${iftarMax}${kalanIftar > 0 ? ` (${kalanIftar} boÅŸ)` : ' (DOLU)'}</span>
                  ` : '<span class="cal-capacity-text">SÄ±nÄ±rsÄ±z</span>'}
                </div>
              ` : ''}
              ${sahurCount > 0 || sahurMax !== null ? `
                <div class="cal-capacity-item">
                  <span class="cal-capacity-label">Sahur ${sahurCount} kayÄ±t</span>
                  ${sahurMax !== null ? `
                    <div class="cal-capacity-bar">
                      <div class="cal-capacity-fill ${sahurDurum}" style="width: ${sahurYuzde}%"></div>
                    </div>
                    <span class="cal-capacity-text">${istirakSahur}/${sahurMax}${kalanSahur > 0 ? ` (${kalanSahur} boÅŸ)` : ' (DOLU)'}</span>
                  ` : '<span class="cal-capacity-text">SÄ±nÄ±rsÄ±z</span>'}
                </div>
              ` : ''}
            </div>
          `;

              div.onclick = () => {
                if (selectedCell) selectedCell.classList.remove('selected');
                selectedCell = div;
                div.classList.add('selected');
                openCalDayModal(dateStr, gunKayitlar);
              };

              grid.appendChild(div);
              current.setDate(current.getDate() + 1);
            }

            // Ã–zet bilgileri hesapla ve gÃ¶ster
            const ramazanKayitlar = [];
            byDate.forEach(arr => ramazanKayitlar.push(...arr));
            const toplamIftar = ramazanKayitlar.filter(k => k.tip === 'iftar').length;
            const toplamSahur = ramazanKayitlar.filter(k => k.tip === 'sahur').length;
            const iftarMusafirAdedi = ramazanKayitlar
              .filter(k => k.tip === 'iftar')
              .reduce((s, k) => s + (parseInt(k.musafiradedi || k.musafirAdedi) || 0), 0);

            if (summaryEl) {
              summaryEl.style.display = 'flex';
              const vIftar = qs('#calSummaryIftar');
              const vSahur = qs('#calSummarySahur');
              const vMusafir = qs('#calSummaryIftarMusafir');
              if (vIftar) vIftar.textContent = toplamIftar.toLocaleString('tr-TR');
              if (vSahur) vSahur.textContent = toplamSahur.toLocaleString('tr-TR');
              if (vMusafir) vMusafir.textContent = iftarMusafirAdedi.toLocaleString('tr-TR');
            }
          } catch (e) {
            console.error('Takvim yÃ¼klenemedi:', e);
          }
        }

        // Takvim gÃ¼n detay modali
        function openCalDayModal(dateStr, gunKayitlar) {
          const modal = qs('#modalCalDay');
          const titleEl = qs('#calDayModalTitle');
          const summaryEl = qs('#calDayModalSummary');
          const tbodyIftar = qs('#tbodyCalIftar');
          const tbodySahur = qs('#tbodyCalSahur');
          if (!modal || !titleEl || !summaryEl || !tbodyIftar || !tbodySahur) return;

          const date = new Date(dateStr);
          titleEl.textContent = date.toLocaleDateString('tr-TR', {
            day: 'numeric',
            month: 'long',
            year: 'numeric',
            weekday: 'long'
          });

          const iftarList = gunKayitlar.filter(k => k.tip === 'iftar');
          const sahurList = gunKayitlar.filter(k => k.tip === 'sahur');

          const iftarCount = iftarList.length;
          const sahurCount = sahurList.length;
          
          // Ä°ÅŸtirak durumlarÄ±
          const iftarIstirak = iftarList.filter(k => k.istirak === true).length;
          const sahurIstirak = sahurList.filter(k => k.istirak === true).length;
          
          // Toplam tutar
          const toplamTutar = gunKayitlar.reduce((sum, k) => {
            const t = k.tutar || k.miktar || 0;
            return sum + (typeof t === 'number' ? t : parseFloat(t) || 0);
          }, 0);
          
          // Toplam mÃ¼safir
          const toplamMusafir = gunKayitlar.reduce((sum, k) => {
            const m = k.musafiradedi || k.musafirAdedi || 0;
            return sum + (typeof m === 'number' ? m : parseInt(m) || 0);
          }, 0);

          // Ã–zet bilgileri gÃ¼ncelle (yeni kart yapÄ±sÄ±)
          summaryEl.innerHTML = `
            <div class="cal-day-summary-card iftar">
              <div class="cal-day-summary-label">Ä°ftar</div>
              <div class="cal-day-summary-value">${iftarCount} kayÄ±t</div>
              <div class="cal-day-summary-sub">${iftarIstirak} iÅŸtirak edecek</div>
            </div>
            <div class="cal-day-summary-card sahur">
              <div class="cal-day-summary-label">Sahur</div>
              <div class="cal-day-summary-value">${sahurCount} kayÄ±t</div>
              <div class="cal-day-summary-sub">${sahurIstirak} iÅŸtirak edecek</div>
            </div>
            <div class="cal-day-summary-card tutar">
              <div class="cal-day-summary-label">ğŸ’° Toplam Tutar</div>
              <div class="cal-day-summary-value">â‚º${toplamTutar.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</div>
            </div>
            <div class="cal-day-summary-card musafir">
              <div class="cal-day-summary-label">ğŸ‘¥ Toplam MÃ¼safir</div>
              <div class="cal-day-summary-value">${toplamMusafir} kiÅŸi</div>
            </div>
          `;

          const renderRows = (list, tbody) => {
            tbody.innerHTML = '';
            if (!list || list.length === 0) {
              tbody.innerHTML = '<tr><td colspan="7"><div class="cal-day-empty-msg">Bu gÃ¼n iÃ§in kayÄ±t bulunamÄ±yor.</div></td></tr>';
              return;
            }
            list.forEach(k => {
              const tr = document.createElement('tr');
              const personel = k.personelAdi || k.personeladi || k.personel || k.kaydedenPersonel || k.kaydedenpersonel || '-';
              const sahip = k.sahip || k.bagisci || '-';
              const mahal = k.mahal || '-';
              const musafir = k.musafiradedi || k.musafirAdedi || 0;
              const tutar = k.tutar || k.miktar || 0;
              const istirak = k.istirak !== undefined ? (k.istirak ? 'âœ“ Evet' : 'âœ— HayÄ±r') : '-';
              const notlar = k.notlar || k.not || k.aciklama || '-';
              
              tr.innerHTML = `
            <td><strong>${personel}</strong></td>
            <td>${sahip}</td>
            <td>${mahal}</td>
            <td style="text-align:center">${musafir}</td>
            <td style="text-align:center">${istirak}</td>
            <td class="right"><strong>${tutar ? 'â‚º' + tutar.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }) : '-'}</strong></td>
            <td style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="${notlar}">${notlar !== '-' ? notlar : ''}</td>
          `;
              tbody.appendChild(tr);
            });
          };

          renderRows(iftarList, tbodyIftar);
          renderRows(sahurList, tbodySahur);

          modal.classList.add('show');
          document.body.classList.add('modal-open');
        }

        function closeCalDayModal() {
          const modal = qs('#modalCalDay');
          if (!modal) return;
          modal.classList.remove('show');
          document.body.classList.remove('modal-open');
        }

        // Global olarak eriÅŸilebilir yap (onclick iÃ§in)
        window.closeCalDayModal = closeCalDayModal;
        window.openCalDayModal = openCalDayModal;

        // Tutar seÃ§enekleri
        async function loadTutarSecenekleri() {
          const yil = qs('#tutarYil').value;
          try {
            const supabase = getSupabase();
            if (!supabase) {
              console.error('Supabase client hazÄ±r deÄŸil');
              return;
            }
            const { data, error } = await supabase
              .from('ramazan_secenekler')
              .select('*')
              .eq('aktif', true)
              .order('sira', { ascending: true });

            if (error) {
              console.error('Tutar seÃ§enekleri yÃ¼klenemedi:', error);
              tutarSecenekleri = [];
            } else {
              tutarSecenekleri = (data || []).map(d => ({ id: d.id, ...d }));
            }
            renderTutarSecenekleri();
          } catch (e) {
            console.error('Tutar seÃ§enekleri yÃ¼klenemedi:', e);
            tutarSecenekleri = [];
            renderTutarSecenekleri();
          }
        }

        function renderTutarSecenekleri() {
          const tbody = qs('#tbodyTutar');
          tbody.innerHTML = '';

          if (tutarSecenekleri.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;color:var(--muted);padding:20px">KayÄ±t bulunamadÄ±</td></tr>';
            return;
          }

          tutarSecenekleri.forEach(t => {
            const tr = document.createElement('tr');
            const tipLabel = t.tip === 'iftar' ? 'ğŸŒ™ Ä°ftar' : (t.tip === 'sahur' ? 'ğŸŒŸ Sahur' : 'ğŸ”¹ Genel');
            tr.innerHTML = `
          <td>${t.sira || 0}</td>
          <td><strong>â‚º${Number(t.tutar || 0).toLocaleString('tr-TR', { minimumFractionDigits: 2 })}</strong></td>
          <td>${t.label || '-'}</td>
          <td>${tipLabel}</td>
          <td>${t.aktif ? '<span style="color:var(--good)">Aktif</span>' : '<span style="color:var(--muted)">Pasif</span>'}</td>
          <td>
            <button onclick="editTutar('${t.id}')" style="padding:4px 8px;font-size:12px">DÃ¼zenle</button>
            <button onclick="deleteTutar('${t.id}')" class="danger" style="padding:4px 8px;font-size:12px">Sil</button>
          </td>
        `;
            tbody.appendChild(tr);
          });
        }

        function openTutarModal(id = null) {
          qs('#tutarId').value = id || '';
          qs('#tutarTitle').textContent = id ? 'Tutar SeÃ§eneÄŸi DÃ¼zenle' : 'Yeni Tutar SeÃ§eneÄŸi';

          if (id) {
            const t = tutarSecenekleri.find(t => t.id === id);
            if (t) {
              qs('#tutarTutar').value = t.tutar || 0;
              qs('#tutarLabel').value = t.label || '';
              qs('#tutarSira').value = t.sira || 1;
              qs('#tutarAktif').value = t.aktif ? 'true' : 'false';
              qs('#tutarTip').value = t.tip || '';
            }
          } else {
            qs('#formTutar').reset();
            qs('#tutarSira').value = tutarSecenekleri.length + 1;
            qs('#tutarTip').value = '';
          }

          qs('#modalTutar').classList.add('show');
          document.body.classList.add('modal-open');
        }

        function closeTutarModal() {
          qs('#modalTutar').classList.remove('show');
          document.body.classList.remove('modal-open');
        }

        // Global olarak eriÅŸilebilir yap (onclick iÃ§in)
        window.closeTutarModal = closeTutarModal;

        qs('#formTutar').addEventListener('submit', async (e) => {
          e.preventDefault();

          const id = qs('#tutarId').value;
          const yil = qs('#tutarYil').value; // Supabase tablosunda yÄ±l sÃ¼tunu yoksa ramazan_secenekler tablosunu kontrol etmeliyiz. 
          // ramazan_secenekler tablosu genellikle geneldir veya yÄ±la baÄŸlÄ±dÄ±r. 
          // Mevcut supabase yapÄ±sÄ±nda ramazan_secenekler tablosu var mÄ±? Evet loadTutarSecenekleri kullanÄ±yor.
          // loadTutarSecenekleri: supabase.from('ramazan_secenekler').select('*')

          const tutar = parseFloat(qs('#tutarTutar').value) || 0;
          const label = qs('#tutarLabel').value.trim();
          const sira = parseInt(qs('#tutarSira').value) || 1;
          const aktif = qs('#tutarAktif').value === 'true';
          const tip = qs('#tutarTip').value || null;

          try {
            const supabase = getSupabase();
            if (!supabase) {
              showToast('error', 'Hata', 'Supabase client hazÄ±r deÄŸil');
              return;
            }

            const data = {
              tutar: tutar,
              label: label,
              sira: sira,
              aktif: aktif,
              tip: tip // 'iftar' veya 'sahur' veya null
            };

            if (id) {
              // ramazan_secenekler ÅŸemasÄ±nda updatedAt/createdAt alanlarÄ± yok
              const { error } = await supabase
                .from('ramazan_secenekler')
                .update(data)
                .eq('id', id);
              if (error) throw error;
            } else {
              // Yeni kayÄ±t - ramazan_secenekler ÅŸemasÄ±nda createdAt alanÄ± yok
              // UUID oluÅŸturma
              if (typeof crypto !== 'undefined' && crypto.randomUUID) {
                data.id = crypto.randomUUID();
              }
              const { error } = await supabase
                .from('ramazan_secenekler')
                .insert(data);
              if (error) throw error;
            }

            showToast('success', 'BaÅŸarÄ±lÄ±', 'Tutar seÃ§eneÄŸi kaydedildi!');
            closeTutarModal();
            await loadTutarSecenekleri();
          } catch (e) {
            console.error('Tutar seÃ§eneÄŸi kaydedilemedi:', e);
            showToast('error', 'Hata', 'Tutar seÃ§eneÄŸi kaydedilemedi: ' + (e.message || e));
          }
        });

        // Tahsilat modal: Ã¶deme tipi deÄŸiÅŸince taksit no alanÄ±nÄ± gÃ¶ster/gizle
        const tahsilatOdemeEl = qs('#tahsilatOdemeTipi');
        const tahsilatGroupTaksitNo = qs('#tahsilatGroupTaksitNo');
        if (tahsilatOdemeEl && tahsilatGroupTaksitNo) {
          tahsilatOdemeEl.addEventListener('change', function () {
            tahsilatGroupTaksitNo.style.display = this.value === 'taksit' ? 'block' : 'none';
          });
        }

        qs('#formTahsilat') && qs('#formTahsilat').addEventListener('submit', async (e) => {
          e.preventDefault();
          const kayitId = qs('#tahsilatKayitId').value;
          const tutar = parseFloat(qs('#tahsilatTutar').value) || 0;
          const tahsilatTarih = qs('#tahsilatTarih').value;
          const odemeTipi = qs('#tahsilatOdemeTipi').value || 'pesin';
          const taksitNo = qs('#tahsilatTaksitNo').value ? parseInt(qs('#tahsilatTaksitNo').value, 10) : null;
          const aciklama = qs('#tahsilatAciklama').value.trim() || null;

          const k = kayitlar.find(x => x.id === kayitId);
          if (!k) {
            showToast('error', 'Hata', 'KayÄ±t bulunamadÄ±');
            return;
          }
          const kayitTutari = Number(k.tutar || k.miktar || 0);
          const toplamTahsilat = tahsilatByKayitId[kayitId] || 0;
          const kalan = kayitTutari - toplamTahsilat;

          if (!tutar || tutar <= 0) {
            showToast('error', 'Hata', 'GeÃ§erli bir tutar giriniz');
            return;
          }
          if (!tahsilatTarih) {
            showToast('error', 'Hata', 'Tahsilat tarihi giriniz');
            return;
          }
          if (tutar > kalan) {
            showToast('error', 'Hata', `Kalan tutar â‚º${kalan.toLocaleString('tr-TR', { minimumFractionDigits: 2 })}. Bu tutarÄ± aÅŸamazsÄ±nÄ±z.`);
            return;
          }

          try {
            const supabase = getSupabase();
            if (!supabase) {
              showToast('error', 'Hata', 'Supabase client hazÄ±r deÄŸil');
              return;
            }
            const insertData = {
              kayit_id: kayitId,
              kayit_tipi: k.tip === 'taahhut' ? 'taahhut' : 'iftar-sahur',
              tutar: tutar,
              tahsilat_tarihi: tahsilatTarih,
              odeme_tipi: odemeTipi,
              taksit_no: odemeTipi === 'taksit' ? (taksitNo || 1) : null,
              aciklama: aciklama
            };
            const { error } = await supabase.from('ramazan_tahsilat').insert(insertData);
            if (error) throw error;

            showToast('success', 'BaÅŸarÄ±lÄ±', 'Tahsilat kaydedildi');
            const { byId, listById } = await loadTahsilatForKayitIds([kayitId]);
            tahsilatByKayitId[kayitId] = byId[kayitId] || 0;
            tahsilatListByKayitId[kayitId] = listById[kayitId] || [];
            renderKayitlar();
            closeTahsilatModal();
            openTahsilatModal(kayitId);
          } catch (err) {
            console.error('Tahsilat kaydedilemedi:', err);
            showToast('error', 'Hata', 'Tahsilat kaydedilemedi: ' + (err.message || err));
          }
        });

        async function deleteTutar(id) {
          if (!confirm('Bu tutar seÃ§eneÄŸini silmek istediÄŸinizden emin misiniz?')) return;

          try {
            const supabase = getSupabase();
            if (!supabase) {
              showToast('error', 'Hata', 'Supabase client hazÄ±r deÄŸil');
              return;
            }

            const { error } = await supabase
              .from('ramazan_secenekler')
              .delete()
              .eq('id', id);

            if (error) throw error;

            showToast('success', 'BaÅŸarÄ±lÄ±', 'Tutar seÃ§eneÄŸi silindi!');
            await loadTutarSecenekleri();
          } catch (e) {
            console.error('Tutar seÃ§eneÄŸi silinemedi:', e);
            showToast('error', 'Hata', 'Tutar seÃ§eneÄŸi silinemedi: ' + (e.message || e));
          }
        }

        window.editTutar = editTutar;
        window.deleteTutar = deleteTutar;
        window.openTutarModal = openTutarModal;

        function editTutar(id) {
          openTutarModal(id);
        }

        qs('#tutarYil').addEventListener('change', loadTutarSecenekleri);

        // Ä°statistikler
        async function loadStatistics() {
          const yil = parseInt(qs('#statYil').value);

          try {
            const supabase = getSupabase();
            if (!supabase) {
              console.error('Supabase client hazÄ±r deÄŸil');
              return;
            }

            // 1. Ä°ftar-Sahur KayÄ±tlarÄ±
            let ramazanData = [];
            const rRes = await supabase
              .from('ramazan_kayitlari')
              .select('*')
              .eq('yil', yil);
            if (!rRes.error) ramazanData = rRes.data || [];

            // 2. Teberru KayÄ±tlarÄ±
            let teberruData = [];
            const tRes = await supabase
              .from('teberru_kayitlari')
              .select('*')
              .eq('yil', yil);
            if (!tRes.error) teberruData = tRes.data || [];

            // 3. TaahhÃ¼t KayÄ±tlarÄ±
            let taahhutData = [];
            const taRes = await supabase
              .from('taahhut_kayitlari')
              .select('*')
              .eq('yil', yil);
            if (!taRes.error) taahhutData = taRes.data || [];

            // Supabase verilerini birleÅŸtir ve normalize et
            const allKayitlar = [
              ...ramazanData.map(d => ({ ...d, tip: d.tip })),
              ...teberruData.map(d => ({ ...d, tip: 'teberru', tutar: d.miktar })),
              ...taahhutData.map(d => ({ ...d, tip: 'taahhut', tutar: d.miktar }))
            ];

            const iftarSayisi = allKayitlar.filter(k => k.tip === 'iftar').length;
            const sahurSayisi = allKayitlar.filter(k => k.tip === 'sahur').length;
            const toplamTutar = allKayitlar.reduce((sum, k) => sum + (Number(k.tutar) || 0), 0);
            const toplamMusafir = allKayitlar.reduce((sum, k) => sum + (Number(k.musafirAdedi || k.musafiradedi) || 0), 0);
            const istirakSayisi = allKayitlar.filter(k => k.istirak).length;

            qs('#statsGrid').innerHTML = `
          <div class="stat-card">
            <div class="stat-label">Toplam Ä°ftar</div>
            <div class="stat-value">${iftarSayisi}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Toplam Sahur</div>
            <div class="stat-value">${sahurSayisi}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Toplam Tutar</div>
            <div class="stat-value">â‚º${toplamTutar.toLocaleString('tr-TR', { minimumFractionDigits: 2 })}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Toplam MÃ¼safir</div>
            <div class="stat-value">${toplamMusafir}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Ä°ÅŸtirak Edilen</div>
            <div class="stat-value">${istirakSayisi}</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Toplam KayÄ±t</div>
            <div class="stat-value">${allKayitlar.length}</div>
          </div>
        `;

            // AylÄ±k daÄŸÄ±lÄ±m
            const aylik = {};
            for (let i = 1; i <= 12; i++) {
              aylik[i] = { iftar: 0, sahur: 0, tutar: 0, musafir: 0 };
            }

            allKayitlar.forEach(k => {
              // Tarih parsing
              let dateObj = null;
              const dateVal = k.tarih || k.createdAt || k.createdat;
              if (dateVal) {
                dateObj = new Date(dateVal);
              }
              const ay = dateObj ? dateObj.getMonth() + 1 : (k.ay || 1);

              if (!aylik[ay]) aylik[ay] = { iftar: 0, sahur: 0, tutar: 0, musafir: 0 };

              if (k.tip === 'iftar') aylik[ay].iftar++;
              if (k.tip === 'sahur') aylik[ay].sahur++;
              aylik[ay].tutar += Number(k.tutar) || 0;
              aylik[ay].musafir += Number(k.musafirAdedi || k.musafiradedi) || 0;
            });

            const tbodyAylik = qs('#tbodyAylik');
            tbodyAylik.innerHTML = '';
            Object.entries(aylik).forEach(([ay, data]) => {
              if (data.iftar === 0 && data.sahur === 0 && data.tutar === 0) return;

              const tr = document.createElement('tr');
              tr.innerHTML = `
            <td><strong>${ayIsimleri[parseInt(ay) - 1] || ay}</strong></td>
            <td>${data.iftar}</td>
            <td>${data.sahur}</td>
            <td class="right"><strong>â‚º${data.tutar.toLocaleString('tr-TR', { minimumFractionDigits: 2 })}</strong></td>
            <td class="right">${data.musafir}</td>
          `;
              tbodyAylik.appendChild(tr);
            });

            if (tbodyAylik.innerHTML === '') {
              tbodyAylik.innerHTML = '<tr><td colspan="5" style="text-align:center;color:var(--muted);padding:20px">KayÄ±t bulunamadÄ±</td></tr>';
            }
          } catch (e) {
            console.error('Ä°statistikler yÃ¼klenemedi:', e);
          }
        }

        // CSV Export
        async function exportCSV() {
          const yil = qs('#exportYil').value;

          try {
            const supabase = getSupabase();
            if (!supabase) {
              showToast('error', 'Hata', "Supabase baÄŸlantÄ±sÄ± yok");
              return;
            }

            // 1. Ä°ftar-Sahur KayÄ±tlarÄ±
            let ramazanData = [];
            const rRes = await supabase
              .from('ramazan_kayitlari')
              .select('*')
              .eq('yil', yil);
            if (!rRes.error) ramazanData = rRes.data || [];

            // 2. Teberru KayÄ±tlarÄ±
            let teberruData = [];
            const tRes = await supabase
              .from('teberru_kayitlari')
              .select('*')
              .eq('yil', yil);
            if (!tRes.error) teberruData = tRes.data || [];

            // 3. TaahhÃ¼t KayÄ±tlarÄ±
            let taahhutData = [];
            const taRes = await supabase
              .from('taahhut_kayitlari')
              .select('*')
              .eq('yil', yil);
            if (!taRes.error) taahhutData = taRes.data || [];

            // Merge
            const allKayitlar = [
              ...ramazanData.map(d => ({ ...d, tip: d.tip })),
              ...teberruData.map(d => ({ ...d, tip: 'teberru', tutar: d.miktar, sahip: d.bagisci })),
              ...taahhutData.map(d => ({ ...d, tip: 'taahhut', tutar: d.miktar, sahip: d.bagisci }))
            ];

            // Tarihe gÃ¶re sÄ±rala
            allKayitlar.sort((a, b) => {
              const dA = a.tarih ? new Date(a.tarih) : (a.createdAt ? new Date(a.createdAt) : new Date(0));
              const dB = b.tarih ? new Date(b.tarih) : (b.createdAt ? new Date(b.createdAt) : new Date(0));
              return dA - dB;
            });

            const rows = [['Tarih', 'Tip', 'Sahip', 'Tutar', 'Ä°ÅŸtirak', 'MÃ¼safirAdedi', 'Personel']];

            allKayitlar.forEach(k => {
              let tarihStr = '';
              const dateVal = k.tarih || k.createdAt;
              if (dateVal) {
                const d = new Date(dateVal);
                tarihStr = d.toISOString().slice(0, 10);
              }

              // Mapping'den gelen verileri kullan
              const personel = k.personelAdi || k.personeladi || k.personel || k.kaydedenPersonel || k.kaydedenpersonel || '';

              rows.push([
                tarihStr,
                k.tip || '',
                k.sahip || '',
                k.tutar || 0,
                k.istirak ? 'Evet' : 'HayÄ±r',
                k.musafirAdedi || k.musafiradedi || 0,
                k.personel || ''
              ]);
            });

            const csv = rows.map(r => r.map(cell => {
              const str = String(cell);
              return str.includes(',') || str.includes('"') || str.includes('\n')
                ? `"${str.replace(/"/g, '""')}"`
                : str;
            }).join(',')).join('\n');

            const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `ramazan-serif-${yil}.csv`;
            link.click();
          } catch (e) {
            console.error('CSV export hatasÄ±:', e);
            alert('CSV dÄ±ÅŸa aktarÄ±lÄ±rken hata oluÅŸtu: ' + e.message);
          }
        }

        // CSV Import
        async function importCSV() {
          const file = qs('#importFile').files[0];
          if (!file) {
            alert('LÃ¼tfen bir CSV dosyasÄ± seÃ§in.');
            return;
          }

          // UTF-8 encoding ile dosyayÄ± oku (TÃ¼rkÃ§e karakter desteÄŸi iÃ§in)
          const text = await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = (e) => resolve(e.target.result);
            reader.onerror = reject;
            reader.readAsText(file, 'UTF-8');
          });

          const lines = text.split(/\r?\n/).filter(l => l.trim());
          if (lines.length < 2) {
            alert('CSV dosyasÄ± boÅŸ veya geÃ§ersiz.');
            return;
          }

          const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
          const rows = lines.slice(1).map(line => {
            const values = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
              const char = line[i];
              if (char === '"') {
                inQuotes = !inQuotes;
              } else if (char === ',' && !inQuotes) {
                values.push(current.trim());
                current = '';
              } else {
                current += char;
              }
            }
            values.push(current.trim());
            return values;
          });

          try {
            const auth = getAuth();
            const user = auth?.currentUser;
            let personelAd = 'Bilinmeyen';
            if (user) {
              try {
                const supabase = getSupabase();
                if (supabase) {
                  const { data: userData } = await supabase
                    .from('kullanicilar')
                    .select('adsoyad, email')
                    .eq('id', user.uid)
                    .single();
                  if (userData) {
                    personelAd = userData.adsoyad || userData.email || 'Bilinmeyen';
                  }
                }
              } catch (e) { 
                console.warn('KullanÄ±cÄ± bilgisi alÄ±namadÄ±:', e);
              }
            }

            const supabase = getSupabase();
            if (!supabase) {
              throw new Error('Supabase client hazÄ±r deÄŸil');
            }

            let imported = 0;
            const batchSize = 50; // Batch insert iÃ§in
            let batchData = [];

            for (const row of rows) {
              if (row.length < headers.length) continue;

              const tarih = row[0] || '';
              const tip = row[1] || '';
              const sahip = row[2] || '';
              const tutar = parseFloat(row[3]) || 0;
              const istirak = (row[4] || '').toLowerCase().includes('evet');
              const musafirAdedi = parseInt(row[5]) || 0;
              const personel = row[6] || personelAd;

              if (!tarih || !tip || !sahip) continue;

              const date = new Date(tarih);
              const yil = date.getFullYear();
              const ay = date.getMonth() + 1;

              // UUID oluÅŸtur
              let newId;
              if (typeof crypto !== 'undefined' && crypto.randomUUID) {
                newId = crypto.randomUUID();
              } else {
                newId = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                  const r = Math.random() * 16 | 0;
                  const v = c === 'x' ? r : (r & 0x3 | 0x8);
                  return v.toString(16);
                });
              }

              const kayitData = {
                id: newId,
                tarih: new Date(tarih).toISOString(),
                tip: tip.toLowerCase(),
                sahip: sahip,
                tutar: tutar,
                istirak: istirak,
                musafiradedi: musafirAdedi,
                personel: personel,
                personeladi: personel,
                personeluid: user?.uid || null,
                yil: yil,
                ay: ay,
                createdat: new Date().toISOString(),
                updatedat: new Date().toISOString()
              };

              batchData.push(kayitData);

              // Batch insert
              if (batchData.length >= batchSize) {
                try {
                  const { error } = await supabase
                    .from('ramazan_kayitlari')
                    .insert(batchData);
                  if (error) throw error;
                  imported += batchData.length;
                  batchData = [];
                } catch (err) {
                  console.error('Batch insert hatasÄ±:', err);
                  throw err;
                }
              }
            }

            // Kalan verileri gÃ¶nder
            if (batchData.length > 0) {
              try {
                const { error } = await supabase
                  .from('ramazan_kayitlari')
                  .insert(batchData);
                if (error) throw error;
                imported += batchData.length;
              } catch (err) {
                console.error('Final batch insert hatasÄ±:', err);
                throw err;
              }
            }

            alert(`${imported} kayÄ±t baÅŸarÄ±yla iÃ§e aktarÄ±ldÄ±!`);
            qs('#importFile').value = '';
            await loadKayitlar();
          } catch (e) {
            console.error('CSV import hatasÄ±:', e);
            alert('CSV iÃ§e aktarÄ±lÄ±rken hata oluÅŸtu: ' + e.message);
          }
        }

        // YÄ±l deÄŸiÅŸtiÄŸinde hem kayÄ±tlarÄ± yÃ¼kle hem de tarih seÃ§imini gÃ¼ncelle
        qs('#filtreYil').addEventListener('change', async function () {
          // Tarih seÃ§imini gÃ¼ncelle
          const tip = qs('#filtreTip')?.value;
          const tarihSelect = qs('#filtreTarih');

          if (tip && tarihSelect && tarihSelect.style.display !== 'none') {
            const yil = this.value || currentYil || new Date().getFullYear();
            await loadYilRamazanAyar(yil);
            const tarihler = getRamazanTarihListesi(yilRamazanAyar);
            tarihSelect.innerHTML = '<option value="">TÃ¼m Tarihler</option>';
            tarihler.forEach(t => {
              const option = document.createElement('option');
              option.value = t.value;
              option.textContent = t.label;
              tarihSelect.appendChild(option);
            });
          }

          // KayÄ±tlarÄ± yÃ¼kle
          await loadKayitlar();
        });

        // KayÄ±tlar tablosu sÃ¼tun baÅŸlÄ±ÄŸÄ±na tÄ±klanÄ±nca sÄ±rala
        (function () {
          const tbl = qs('#tblKayitlar');
          if (!tbl) return;
          tbl.addEventListener('click', function (e) {
            const th = e.target.closest('th.th-sortable');
            if (!th) return;
            const key = th.getAttribute('data-sort');
            if (!key) return;
            if (kayitlarSortKey === key) {
              kayitlarSortDir = kayitlarSortDir === 1 ? -1 : 1;
            } else {
              kayitlarSortKey = key;
              kayitlarSortDir = 1;
            }
            renderKayitlar();
          });
        })();

        // ESC tuÅŸu event listener'Ä± yukarÄ±da tanÄ±mlandÄ±, burada tekrar tanÄ±mlamaya gerek yok

        // Modal aÃ§Ä±lma zamanÄ±nÄ± takip et (hemen kapanmasÄ±nÄ± Ã¶nlemek iÃ§in)
        let lastModalOpenTime = 0;

        // Modal overlay'ine tÄ±klandÄ±ÄŸÄ±nda modalÄ± kapat
        document.addEventListener('click', (e) => {
          // Modal aÃ§Ä±ldÄ±ktan sonra en az 100ms bekle (hemen kapanmasÄ±nÄ± Ã¶nle)
          const timeSinceOpen = Date.now() - lastModalOpenTime;
          if (timeSinceOpen < 100) {
            return;
          }

          // Sadece modal overlay'ine (modal elementinin kendisine) tÄ±klandÄ±ÄŸÄ±nda kapat
          // .sheet iÃ§ine tÄ±klandÄ±ÄŸÄ±nda kapanmamalÄ±
          if (e.target.classList.contains('modal') && !e.target.closest('.sheet')) {
            closeEditModal();
            closeTahsilatModal();
            closeTutarModal();
            closeVeriYukleModal();
            closeKisiDetayModal();
          }
        });

        // Sheet iÃ§ine tÄ±klandÄ±ÄŸÄ±nda event propagation'Ä± durdur (modal kapanmasÄ±n)
        // Ama butonlara, inputlara, formlara tÄ±klanÄ±nca durdurma (bunlar Ã§alÄ±ÅŸsÄ±n)
        document.addEventListener('click', (e) => {
          // EÄŸer sheet iÃ§indeyse ve interaktif bir element deÄŸilse propagation'Ä± durdur
          const sheet = e.target.closest('.sheet');
          if (sheet && e.target === sheet) {
            // Sadece sheet'in kendisine (boÅŸ alan) tÄ±klandÄ±ÄŸÄ±nda propagation'Ä± durdur
            e.stopPropagation();
          }
          // Buton, input, select, textarea, form gibi interaktif elementlere tÄ±klandÄ±ÄŸÄ±nda
          // propagation'Ä± durdurma - bunlar normal Ã§alÄ±ÅŸsÄ±n
        }, true);

        // ===== HEDEF YÃ–NETÄ°MÄ° - Finansal Analiz Sistemi =====

        // Veri yÃ¼kleme deÄŸiÅŸkenleri
        let analizVerileri = {}; // { yil: { tip: { sahip: [...veriler] } } }
        let analizVerileriYukleniyor = false; // YÃ¼kleme durumu kontrolÃ¼

        // Veri yÃ¼kleme modal
        function openVeriYukleModal() {
          qs('#veriYukleFile').value = '';
          qs('#veriYukleYil').value = '';
          qs('#veriYuklePreview').style.display = 'none';
          qs('#modalVeriYukle').classList.add('show');
          document.body.classList.add('modal-open');
        }

        function closeVeriYukleModal() {
          qs('#modalVeriYukle').classList.remove('show');
          document.body.classList.remove('modal-open');
        }

        window.openVeriYukleModal = openVeriYukleModal;
        window.closeVeriYukleModal = closeVeriYukleModal;

        // CSV ÅŸablon indir
        function downloadVeriSablon() {
          const csv = 'YÄ±l,Tip,Sahip,DiÄŸer,Tutar,Referans\n' +
            '2023,iftar,Ali GÃ¶vercin,Mehmet Kara,10000.50,Muhsin Ã‡elik\n' +
            '2023,sahur,Mehmet YÄ±lmaz,,5000.00,REF002\n' +
            '2023,taahhut,Fatma Demir,AyÅŸe YÄ±lmaz,15000.75,REF003\n' +
            '2023,teberru,AyÅŸe Kaya,,20000.00,REF004\n' +
            '2024,iftar,Ali GÃ¶vercin,Mehmet Kara,12000.25,REF101\n' +
            '2024,sahur,Mehmet YÄ±lmaz,,6000.50,REF102';

          const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
          const link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.download = 'finansal-analiz-sablon.csv';
          link.click();
        }

        window.downloadVeriSablon = downloadVeriSablon;

        // Veri Temizleme Modal
        function openVeriTemizleModal() {
          const modal = qs('#modalVeriTemizle');
          if (modal) {
            modal.classList.add('show');
            document.body.classList.add('modal-open');
          }
        }

        function closeVeriTemizleModal() {
          const modal = qs('#modalVeriTemizle');
          if (modal) {
            modal.classList.remove('show');
            document.body.classList.remove('modal-open');
          }
        }

        window.openVeriTemizleModal = openVeriTemizleModal;
        window.closeVeriTemizleModal = closeVeriTemizleModal;

        // CSV dosyasÄ± parse ve Ã¶nizleme - DOM yÃ¼klendikten sonra
        setTimeout(() => {
          const veriYukleFile = qs('#veriYukleFile');
          if (veriYukleFile) {
            veriYukleFile.addEventListener('change', async (e) => {
              const file = e.target.files[0];
              if (!file) return;

              try {
                // UTF-8 encoding ile dosyayÄ± oku (TÃ¼rkÃ§e karakter desteÄŸi iÃ§in)
                const text = await new Promise((resolve, reject) => {
                  const reader = new FileReader();
                  reader.onload = (e) => resolve(e.target.result);
                  reader.onerror = reject;
                  reader.readAsText(file, 'UTF-8');
                });

                const lines = text.split(/\r?\n/).filter(l => l.trim());
                if (lines.length < 2) {
                  alert('CSV dosyasÄ± boÅŸ veya geÃ§ersiz!');
                  return;
                }

                // Header'Ä± parse et
                const headers = lines[0].split(',').map(h => h.trim().toLowerCase());

                // Veri satÄ±rlarÄ±nÄ± parse et (ilk 10)
                const previewData = [];
                for (let i = 1; i < Math.min(11, lines.length); i++) {
                  const values = parseCSVLine(lines[i]);
                  if (values.length < 5) continue; // En az 5 kolon olmalÄ± (yil, tip, sahip, diger, tutar)

                  const yil = values[0]?.trim() || '';
                  const tipRaw = values[1]?.trim() || '';
                  const tip = normalizeTurkish(tipRaw); // TÃ¼rkÃ§e karakter uyumu (I->Ä±, Ä°->i)
                  const sahip = values[2]?.trim() || '';
                  const diger = values[3]?.trim() || '';
                  const tutar = parseTutar(values[4]?.trim() || '0');
                  const referans = values[5]?.trim() || '';

                  if (!yil || !tip || !sahip || !tutar || tutar <= 0) continue;

                  previewData.push({ yil, tip, sahip, diger, tutar, referans });
                }

                // Ã–nizleme gÃ¶ster
                if (previewData.length > 0) {
                  const tbody = qs('#veriYuklePreviewBody');
                  tbody.innerHTML = '';
                  previewData.forEach(row => {
                    const tr = document.createElement('tr');

                    // HTML escape fonksiyonu (TÃ¼rkÃ§e karakterler iÃ§in)
                    const escapeHtml = (str) => {
                      if (!str) return '';
                      const div = document.createElement('div');
                      div.textContent = str;
                      return div.innerHTML;
                    };

                    const tipCell = document.createElement('td');
                    tipCell.textContent = row.tip;

                    const sahipCell = document.createElement('td');
                    sahipCell.textContent = row.sahip;

                    const digerCell = document.createElement('td');
                    digerCell.textContent = row.diger || '-';

                    const tutarCell = document.createElement('td');
                    tutarCell.textContent = 'â‚º' + Number(row.tutar).toLocaleString('tr-TR', { minimumFractionDigits: 2 });

                    const referansCell = document.createElement('td');
                    referansCell.textContent = row.referans || '-';

                    tr.appendChild(tipCell);
                    tr.appendChild(sahipCell);
                    tr.appendChild(digerCell);
                    tr.appendChild(tutarCell);
                    tr.appendChild(referansCell);

                    tbody.appendChild(tr);
                  });
                  qs('#veriYuklePreview').style.display = 'block';
                }
              } catch (e) {
                console.error('Dosya okuma hatasÄ±:', e);
                showToast('error', 'Hata', 'Dosya okunamadÄ±: ' + e.message);
              }
            });
          }
        }, 200);

        // TÃ¼rkÃ§e karakter normalizasyonu (Ä±-Ä° uyumu iÃ§in)
        function normalizeTurkish(str) {
          if (!str) return '';
          return String(str)
            .replace(/I/g, 'Ä±')  // BÃ¼yÃ¼k I -> kÃ¼Ã§Ã¼k Ä±
            .replace(/Ä°/g, 'i')  // BÃ¼yÃ¼k Ä° -> kÃ¼Ã§Ã¼k i
            .replace(/Ä±/g, 'Ä±')  // KÃ¼Ã§Ã¼k Ä± -> kÃ¼Ã§Ã¼k Ä± (aynÄ± kalÄ±r)
            .replace(/i/g, 'i')  // KÃ¼Ã§Ã¼k i -> kÃ¼Ã§Ã¼k i (aynÄ± kalÄ±r)
            .toLowerCase()
            .trim();
        }

        // TÃ¼rkÃ§e karakter uyumlu arama (Ä±-Ä° uyumu)
        function turkishIncludes(str, search) {
          if (!str || !search) return false;
          const normalizedStr = normalizeTurkish(str);
          const normalizedSearch = normalizeTurkish(search);
          return normalizedStr.includes(normalizedSearch);
        }

        // Personel/referans isimlerini standart formata Ã§evir (TÃœMÃœ BÃœYÃœK HARF - TÃ¼rkÃ§e)
        function normalizePersonelName(name) {
          if (!name) return '';
          // Ã–nce trim yap
          name = String(name).trim();
          // BoÅŸsa dÃ¶ndÃ¼r
          if (!name) return '';
          // "DiÄŸer" Ã¶zel durumu - bÃ¼yÃ¼k harfle
          if (normalizeTurkish(name) === 'diÄŸer') return 'DÄ°ÄER';
          // TÃ¼m harfleri bÃ¼yÃ¼k yap (TÃ¼rkÃ§e karakter desteÄŸi ile)
          return name.toLocaleUpperCase('tr-TR');
        }

        // CSV satÄ±rÄ±nÄ± parse et (virgÃ¼l ve tÄ±rnak iÅŸareti desteÄŸi)
        function parseCSVLine(line) {
          const values = [];
          let current = '';
          let inQuotes = false;

          for (let i = 0; i < line.length; i++) {
            const char = line[i];
            if (char === '"') {
              inQuotes = !inQuotes;
            } else if (char === ',' && !inQuotes) {
              values.push(current.trim());
              current = '';
            } else {
              current += char;
            }
          }
          values.push(current.trim());
          return values;
        }

        // Tutar parse et (virgÃ¼l destekli, binlik ayÄ±rÄ±cÄ± destekli)
        function parseTutar(str) {
          // str bir string deÄŸilse string'e Ã§evir
          if (str === null || str === undefined) return 0;
          const strValue = String(str);
          if (!strValue || strValue.trim() === '') return 0;
          // VirgÃ¼lÃ¼ noktaya Ã§evir (TÃ¼rkÃ§e format: 10.000,50)
          // EÄŸer son karakter virgÃ¼lse (kÃ¼sÃ¼rat varsa), virgÃ¼lÃ¼ nokta yap
          let cleaned = strValue.trim().replace(/\./g, ''); // Binlik ayÄ±rÄ±cÄ±yÄ± kaldÄ±r
          cleaned = cleaned.replace(/,/g, '.'); // VirgÃ¼lÃ¼ noktaya Ã§evir (kÃ¼sÃ¼rat iÃ§in)
          const parsed = parseFloat(cleaned);
          return isNaN(parsed) ? 0 : parsed;
        }

        // Veri yÃ¼kleme form submit - DOM yÃ¼klendikten sonra
        setTimeout(() => {
          const formVeriYukle = qs('#formVeriYukle');
          if (formVeriYukle) {
            formVeriYukle.addEventListener('submit', async (e) => {
              e.preventDefault();

              const file = qs('#veriYukleFile').files[0];
              const yil = qs('#veriYukleYil').value;

              if (!file || !yil) {
                showToast('error', 'Hata', 'LÃ¼tfen dosya ve yÄ±l seÃ§iniz!');
                return;
              }

              // Submit butonunu devre dÄ±ÅŸÄ± bÄ±rak
              const submitBtn = formVeriYukle.querySelector('button[type="submit"]');
              const originalBtnText = submitBtn.textContent;
              submitBtn.disabled = true;
              submitBtn.textContent = 'YÃ¼kleniyor...';

              try {
                // UTF-8 encoding ile dosyayÄ± oku (TÃ¼rkÃ§e karakter desteÄŸi iÃ§in)
                const text = await new Promise((resolve, reject) => {
                  const reader = new FileReader();
                  reader.onload = (e) => resolve(e.target.result);
                  reader.onerror = reject;
                  reader.readAsText(file, 'UTF-8');
                });

                const lines = text.split(/\r?\n/).filter(l => l.trim());
                if (lines.length < 2) {
                  alert('CSV dosyasÄ± boÅŸ veya geÃ§ersiz!');
                  return;
                }

                // Supabase client al
                const supabase = getSupabase();
                if (!supabase) {
                  throw new Error('Supabase client hazÄ±r deÄŸil');
                }

                const user = (await supabase.auth.getUser()).data.user;
                // YÃ¶netici bilgisi (CSV'yi yÃ¼kleyen kiÅŸi)
                let yoneticiAd = 'Bilinmeyen';
                let yoneticiUid = null;

                if (user) {
                  yoneticiUid = user.id;
                  try {
                    const { data: userData } = await supabase
                      .from('kullanicilar')
                      .select('adsoyad, email')
                      .eq('id', user.id)
                      .single();
                    if (userData) {
                      yoneticiAd = userData.adsoyad || userData.email || 'Bilinmeyen';
                    } else if (user.email) {
                      yoneticiAd = user.email;
                    }
                  } catch (e) {
                    console.warn('KullanÄ±cÄ± detaylarÄ± alÄ±namadÄ±:', e);
                  }
                }

                // Supabase iÃ§in batch iÅŸlemleri - dizide toplayÄ±p insert edeceÄŸiz
                let batchData = [];
                let imported = 0;
                let skipped = 0;
                // batchCount deÄŸiÅŸkeni artÄ±k dizi uzunluÄŸu ile kontrol edilecek 
                const totalLines = lines.length - 1; // Header hariÃ§
                const hatalar = []; // Hata detaylarÄ±
                let kolonHatasi = 0;
                let validasyonHatasi = 0;
                let tipHatasi = 0;
                let digerHatalar = 0;

                showProgress(15);

                // Ä°lk satÄ±rÄ± atla (header)
                for (let i = 1; i < lines.length; i++) {
                  const satirNo = i + 1; // Excel satÄ±r numarasÄ± (header dahil)
                  const progress = 15 + Math.floor((i / totalLines) * 75); // 15-90 arasÄ±
                  showProgress(progress);

                  try {
                    const values = parseCSVLine(lines[i]);
                    if (values.length < 5) { // En az 5 kolon olmalÄ± (yil, tip, sahip, diger, tutar)
                      skipped++;
                      kolonHatasi++;
                      hatalar.push({ satir: satirNo, hata: 'Yetersiz kolon sayÄ±sÄ±', veri: lines[i].substring(0, 50) });
                      continue;
                    }

                    const csvYil = values[0]?.trim() || yil;
                    const tip = normalizeTurkish(values[1]?.trim() || ''); // TÃ¼rkÃ§e karakter uyumu
                    const sahip = values[2]?.trim() || ''; // Sahip adÄ±nÄ± olduÄŸu gibi sakla
                    const diger = values[3]?.trim() || ''; // DiÄŸer boÅŸ olabilir, sorun deÄŸil
                    const tutar = parseTutar(values[4]?.trim() || '0');
                    const referans = values[5]?.trim() || ''; // Referans = hangi personele ait olduÄŸu

                    // Personel bilgisini belirle:
                    // - EÄŸer referans = "DiÄŸer" ise, yÃ¶netici bilgisini kullan (CSV'yi yÃ¼kleyen kiÅŸi)
                    // - DeÄŸilse, referans deÄŸerini personel adÄ± olarak kullan
                    let personelAd = '';
                    let personelUid = null;

                    if (!referans || normalizeTurkish(referans) === 'diÄŸer') {
                      // "DiÄŸer" referansÄ± iÃ§in yÃ¶netici bilgisini kullan
                      personelAd = normalizePersonelName(yoneticiAd);
                      personelUid = yoneticiUid;
                    } else {
                      // Referans deÄŸerini personel adÄ± olarak kullan (normalize et)
                      personelAd = normalizePersonelName(referans);
                      personelUid = null; // Sistemde kayÄ±tlÄ± deÄŸil, sadece isim olarak sakla
                    }

                    // Validasyon - Sahip ve DiÄŸer aynÄ± olabilir, sorun deÄŸil
                    // DiÄŸer boÅŸ olabilir, sorun deÄŸil
                    if (!tip || !sahip || !tutar || tutar <= 0) {
                      skipped++;
                      validasyonHatasi++;
                      hatalar.push({
                        satir: satirNo,
                        hata: 'Validasyon hatasÄ± (tip, sahip veya tutar eksik/geÃ§ersiz)',
                        veri: `Tip: ${tip || 'boÅŸ'}, Sahip: ${sahip || 'boÅŸ'}, Tutar: ${tutar || '0'}`
                      });
                      continue;
                    }

                    // Sahip ve DiÄŸer aynÄ±ysa veya DiÄŸer boÅŸsa - normal durum, devam et
                    // Tip kontrolÃ¼ (TÃ¼rkÃ§e karakter uyumlu: I->Ä±, Ä°->i)
                    if (!['iftar', 'sahur', 'taahhut', 'teberru'].includes(tip)) {
                      skipped++;
                      tipHatasi++;
                      hatalar.push({
                        satir: satirNo,
                        hata: `GeÃ§ersiz tip: "${tip}" (iftar, sahur, taahhut, teberru olmalÄ±)`,
                        veri: `Tip: ${tip}`
                      });
                      continue;
                    }

                    // Supabase'e kaydet (1000'erli gruplar halinde veya tek tek)
                    // Supabase Ã§oklu insert destekler

                    const data = {
                      yil: parseInt(csvYil) || parseInt(yil),
                      tip: tip,
                      sahip: sahip.trim(),
                      diger: (diger || '').trim(),
                      tutar: tutar,
                      referans: (referans || '').trim(),
                      personel: personelAd,
                      personelUid: personelUid,
                      yukleyen: normalizePersonelName(yoneticiAd),
                      yukleyenUid: yoneticiUid,
                      createdAt: new Date().toISOString(),
                      updatedAt: new Date().toISOString()
                    };

                    // Supabase insert iÃ§in listeye ekle
                    batchData.push(data);
                    imported++;

                    // 100'lÃ¼k paketler halinde gÃ¶nder (Supabase limitlerine takÄ±lmamak iÃ§in)
                    if (batchData.length >= 100) {
                      try {
                        const { error } = await supabase
                          .from('ramazan_veriler')
                          .insert(batchData);

                        if (error) throw error;

                        batchData = []; // Temizle
                        showToast('Bilgi', `${imported} kayÄ±t iÅŸlendi...`, 'info', 1000);
                      } catch (err) {
                        console.error('Insert hatasÄ±:', err);
                        digerHatalar += batchData.length;
                        hatalar.push({
                          satir: `Batch`,
                          hata: 'Batch insert hatasÄ±',
                          veri: err.message
                        });
                        batchData = []; // Hataya raÄŸmen temizle ve devam et
                      }
                    }
                  } catch (rowError) {
                    skipped++;
                    digerHatalar++;
                    hatalar.push({
                      satir: satirNo,
                      hata: 'SatÄ±r iÅŸleme hatasÄ±',
                      veri: rowError.message
                    });
                    console.error(`SatÄ±r ${satirNo} hatasÄ±:`, rowError);
                  }
                }

                // Kalan verileri gÃ¶nder
                if (batchData.length > 0) {
                  try {
                    const { error } = await supabase
                      .from('ramazan_veriler')
                      .insert(batchData);

                    if (error) throw error;
                  } catch (err) {
                    console.error('Final Insert hatasÄ±:', err);
                    digerHatalar += batchData.length;
                    hatalar.push({
                      satir: `Final Batch`,
                      hata: 'Batch insert hatasÄ±',
                      veri: err.message
                    });
                  }
                }

                showProgress(100);

                // SonuÃ§ bildirimi
                setTimeout(() => {
                  showProgress(0);

                  if (imported > 0) {
                    let hataMesaji = '';
                    if (skipped > 0) {
                      hataMesaji = `\n\nâš ï¸ ${skipped} kayÄ±t atlandÄ±:\n`;
                      if (kolonHatasi > 0) hataMesaji += `â€¢ ${kolonHatasi} kolon hatasÄ±\n`;
                      if (validasyonHatasi > 0) hataMesaji += `â€¢ ${validasyonHatasi} validasyon hatasÄ±\n`;
                      if (tipHatasi > 0) hataMesaji += `â€¢ ${tipHatasi} tip hatasÄ±\n`;
                      if (digerHatalar > 0) hataMesaji += `â€¢ ${digerHatalar} diÄŸer hata\n`;

                      if (hatalar.length > 0 && hatalar.length <= 10) {
                        hataMesaji += '\nğŸ“‹ Ä°lk 10 hata detayÄ±:\n';
                        hatalar.slice(0, 10).forEach((h, idx) => {
                          hataMesaji += `${idx + 1}. SatÄ±r ${h.satir}: ${h.hata}\n`;
                        });
                      } else if (hatalar.length > 10) {
                        hataMesaji += `\nğŸ“‹ Toplam ${hatalar.length} hata var (ilk 10 gÃ¶steriliyor)\n`;
                        hatalar.slice(0, 10).forEach((h, idx) => {
                          hataMesaji += `${idx + 1}. SatÄ±r ${h.satir}: ${h.hata}\n`;
                        });
                      }
                    }

                    showToast(
                      'BaÅŸarÄ±lÄ±! âœ…',
                      `${imported} kayÄ±t baÅŸarÄ±yla yÃ¼klendi!${hataMesaji}`,
                      'success',
                      8000
                    );
                  } else {
                    showToast(
                      'UyarÄ± âš ï¸',
                      `HiÃ§bir kayÄ±t yÃ¼klenemedi! ${skipped} kayÄ±t atlandÄ±. Hata detaylarÄ±nÄ± kontrol edin.`,
                      'warning',
                      6000
                    );
                  }

                  submitBtn.disabled = false;
                  submitBtn.textContent = originalBtnText;

                  // HatalarÄ± konsola yazdÄ±r (geliÅŸtirici iÃ§in)
                  if (hatalar.length > 0) {
                    console.group('ğŸ“‹ CSV YÃ¼kleme Hata DetaylarÄ±');
                    hatalar.forEach(h => {
                      console.warn(`SatÄ±r ${h.satir}:`, h.hata, h.veri);
                    });
                    console.groupEnd();
                  }

                  closeVeriYukleModal();

                  // Analiz verilerini yeniden yÃ¼kle
                  loadAnalizVerileri().then(() => {
                    loadAnalizDashboard();
                  });
                }, 500);

              } catch (e) {
                showProgress(0);
                console.error('Veri yÃ¼kleme hatasÄ±:', e);
                showToast(
                  'Kritik Hata âŒ',
                  `Veri yÃ¼klenirken hata oluÅŸtu: ${e.message}\n\nLÃ¼tfen dosya formatÄ±nÄ± kontrol edin.`,
                  'error',
                  8000
                );
                submitBtn.disabled = false;
                submitBtn.textContent = originalBtnText;
              }
            });
          }
        }, 200);

        // Analiz verilerini yÃ¼kle (3 yÄ±l)
        async function loadAnalizVerileri() {
          // EÄŸer zaten yÃ¼kleniyorsa, mevcut yÃ¼kleme tamamlanana kadar bekle
          if (analizVerileriYukleniyor) {
            console.log('Analiz verileri zaten yÃ¼kleniyor, bekleniyor...');
            // Mevcut yÃ¼kleme tamamlanana kadar bekle (max 10 saniye)
            let beklemeSayaci = 0;
            while (analizVerileriYukleniyor && beklemeSayaci < 100) {
              await new Promise(resolve => setTimeout(resolve, 100));
              beklemeSayaci++;
            }
            if (beklemeSayaci >= 100) {
              console.warn('Analiz verileri yÃ¼kleme timeout!');
            }
            return; // Mevcut yÃ¼kleme tamamlandÄ±, tekrar yÃ¼kleme
          }

          // YÃ¼kleme baÅŸladÄ±
          analizVerileriYukleniyor = true;

          try {
            const yillar = [2023, 2024, 2025];
            // Ã–nce mevcut verileri tamamen temizle
            analizVerileri = {};

            const supabase = getSupabase();
            if (!supabase) {
              console.error('Supabase client hazÄ±r deÄŸil');
              analizVerileriYukleniyor = false;
              return;
            }

            for (const yil of yillar) {
              try {
                const { data, error } = await supabase
                  .from('ramazan_veriler')
                  .select('*')
                  .eq('yil', yil);

                if (error) {
                  console.warn(`YÄ±l ${yil} verileri yÃ¼klenemedi:`, error);
                  if (!analizVerileri[yil]) analizVerileri[yil] = {};
                  continue;
                }

                if (!analizVerileri[yil]) analizVerileri[yil] = {};

                // Document ID bazlÄ± duplicate kontrolÃ¼ (aynÄ± document birden fazla kez eklenmesin)
                const loadedDocIds = new Set();

                // TÃœM kayÄ±tlarÄ± yÃ¼kle - duplicate filtreleme YOK (iÃ§erik bazlÄ±)
                // AynÄ± veri kombinasyonu birden fazla kez kaydedilebilir
                // Her kayÄ±t ayrÄ± ayrÄ± sayÄ±lÄ±r ve toplanÄ±r
                (data || []).forEach(doc => {
                  try {
                    // AynÄ± document ID'yi birden fazla kez yÃ¼kleme
                    if (loadedDocIds.has(doc.id)) {
                      console.warn(`DokÃ¼man ${doc.id} zaten yÃ¼klendi, atlanÄ±yor.`);
                      return;
                    }
                    loadedDocIds.add(doc.id);

                    if (!doc) {
                      console.warn(`DokÃ¼man ${doc.id} verisi boÅŸ, atlanÄ±yor.`);
                      return;
                    }

                    const tip = doc.tip || 'diÄŸer';
                    const sahip = doc.sahip || 'Bilinmeyen';

                    if (!analizVerileri[yil][tip]) analizVerileri[yil][tip] = {};
                    if (!analizVerileri[yil][tip][sahip]) {
                      analizVerileri[yil][tip][sahip] = [];
                    }

                    // AynÄ± document ID'yi bu sahip iÃ§in de kontrol et (ek gÃ¼venlik)
                    const mevcutKayit = analizVerileri[yil][tip][sahip].find(v => v.id === doc.id);
                    if (mevcutKayit) {
                      console.warn(`DokÃ¼man ${doc.id} zaten ${sahip} iÃ§in yÃ¼klÃ¼, atlanÄ±yor.`);
                      return;
                    }

                    // Her kayÄ±t ayrÄ± ayrÄ± eklenir (duplicate kontrolÃ¼ yok - iÃ§erik bazlÄ±)
                    // Personel bilgisini normalize et (eÅŸleÅŸtirme iÃ§in)
                    const rawPersonel = doc.personel || doc.referans || '';
                    const normalizedPersonel = normalizePersonelName(rawPersonel);

                    // TutarÄ± sayÄ±ya Ã§evir (gÃ¼venlik iÃ§in)
                    const tutar = Number(doc.tutar) || 0;

                    analizVerileri[yil][tip][sahip].push({
                      id: doc.id, // Benzersiz document ID
                      diger: doc.diger || '',
                      tutar: tutar, // SayÄ± olarak sakla
                      referans: doc.referans || '',
                      personel: normalizedPersonel, // Normalize edilmiÅŸ personel bilgisi
                      createdAt: doc.createdat || doc.createdAt // Åemadan gelen createdat -> createdAt
                    });
                  } catch (docError) {
                    // Tek bir dokÃ¼manda hata varsa atla, diÄŸerlerini yÃ¼kle
                    console.warn(`YÄ±l ${yil} - DokÃ¼man ${doc.id} yÃ¼klenemedi:`, docError);
                  }
                });
              } catch (yilError) {
                // Bir yÄ±lÄ±n verileri yÃ¼klenemezse diÄŸer yÄ±llarÄ± yÃ¼klemeye devam et
                console.warn(`YÄ±l ${yil} verileri yÃ¼klenemedi:`, yilError);
                if (!analizVerileri[yil]) analizVerileri[yil] = {};
              }
            }
          } catch (e) {
            console.error('Analiz verileri yÃ¼klenirken genel hata:', e);
            // Hata olsa bile boÅŸ veri yapÄ±sÄ± dÃ¶ndÃ¼r
            if (!analizVerileri || Object.keys(analizVerileri).length === 0) {
              analizVerileri = { 2023: {}, 2024: {}, 2025: {} };
            }
          } finally {
            // YÃ¼kleme tamamlandÄ±
            analizVerileriYukleniyor = false;
          }
        }

        // Genel Ã¶zet dashboard yÃ¼kle
        function loadAnalizDashboard() {
          const secilenYil = qs('#analizYil').value;
          const container = qs('#analizDashboard');
          if (!container) return;

          // TÃ¼m yÄ±llar iÃ§in Ã¶zet hesapla
          const yillar = [2023, 2024, 2025];
          const tipler = ['iftar', 'sahur', 'taahhut', 'teberru'];

          let summary = {};

          // Ã–nce tÃ¼m yÄ±llar iÃ§in summary objelerini baÅŸlat
          yillar.forEach(yil => {
            if (!analizVerileri[yil]) analizVerileri[yil] = {};
            summary[yil] = { toplamTutar: 0, toplamKayit: 0, kisiSayisi: 0 };
          });

          // Her yÄ±l iÃ§in verileri hesapla
          yillar.forEach(yil => {
            if (!analizVerileri[yil]) return;
            if (!summary[yil]) summary[yil] = { toplamTutar: 0, toplamKayit: 0, kisiSayisi: 0 };

            const uniqueKisiler = new Set(); // Benzersiz kiÅŸiler iÃ§in

            tipler.forEach(tip => {
              if (!analizVerileri[yil][tip]) analizVerileri[yil][tip] = {};
              const kisiler = Object.keys(analizVerileri[yil][tip]);
              let tipTutar = 0;
              let tipKayit = 0;

              kisiler.forEach(kisi => {
                const veriler = analizVerileri[yil][tip][kisi];
                if (!veriler || !Array.isArray(veriler)) return; // GÃ¼venlik kontrolÃ¼
                veriler.forEach(v => {
                  const tutar = Number(v.tutar) || 0;
                  tipTutar += tutar;
                  tipKayit++;
                });
                // Benzersiz kiÅŸileri topla
                uniqueKisiler.add(kisi);
              });

              if (!summary[yil][tip]) summary[yil][tip] = {};
              summary[yil][tip] = { tutar: tipTutar, kayit: tipKayit, kisi: kisiler.length };
              summary[yil].toplamTutar += tipTutar;
              summary[yil].toplamKayit += tipKayit;
            });

            // KiÅŸi sayÄ±sÄ±nÄ± doÄŸru hesapla (tÃ¼m tiplerdeki benzersiz kiÅŸiler)
            summary[yil].kisiSayisi = uniqueKisiler.size;
          });

          // HTML oluÅŸtur
          let html = `
        <div class="stats-grid">
          ${yillar.map(yil => `
            <div class="stat-card">
              <div class="stat-label">${yil} Toplam</div>
              <div class="stat-value">â‚º${summary[yil].toplamTutar.toLocaleString('tr-TR', { minimumFractionDigits: 2 })}</div>
              <div style="font-size:12px;color:var(--muted)">${summary[yil].toplamKayit} kayÄ±t, ${summary[yil].kisiSayisi} kiÅŸi</div>
            </div>
          `).join('')}
        </div>
        
        <div class="card" style="margin-top:16px">
          <h4 style="margin:0 0 12px 0">YÄ±llÄ±k KarÅŸÄ±laÅŸtÄ±rma</h4>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>YÄ±l</th>
                  <th>Ä°ftar</th>
                  <th>Sahur</th>
                  <th>TaahhÃ¼t</th>
                  <th>Teberru</th>
                  <th>Toplam</th>
                  <th>KiÅŸi SayÄ±sÄ±</th>
                </tr>
              </thead>
              <tbody>
                ${yillar.map(yil => {
            const trend = yil > 2023 ? calculateTrend(summary[yil - 1].toplamTutar, summary[yil].toplamTutar) : '';
            return `
                    <tr>
                      <td><strong>${yil}</strong></td>
                      <td>â‚º${summary[yil].iftar?.tutar.toLocaleString('tr-TR', { minimumFractionDigits: 2 }) || '0,00'}</td>
                      <td>â‚º${summary[yil].sahur?.tutar.toLocaleString('tr-TR', { minimumFractionDigits: 2 }) || '0,00'}</td>
                      <td>â‚º${summary[yil].taahhut?.tutar.toLocaleString('tr-TR', { minimumFractionDigits: 2 }) || '0,00'}</td>
                      <td>â‚º${summary[yil].teberru?.tutar.toLocaleString('tr-TR', { minimumFractionDigits: 2 }) || '0,00'}</td>
                      <td><strong>â‚º${summary[yil].toplamTutar.toLocaleString('tr-TR', { minimumFractionDigits: 2 })}</strong> ${trend}</td>
                      <td>${summary[yil].kisiSayisi}</td>
                    </tr>
                  `;
          }).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;

          container.innerHTML = html;
        }

        // Trend hesapla
        function calculateTrend(onceki, simdi) {
          if (!onceki || onceki === 0) return '';
          const degisim = ((simdi - onceki) / onceki) * 100;
          if (degisim > 0) return `<span class="trend-up">â†‘ ${degisim.toFixed(1)}%</span>`;
          if (degisim < 0) return `<span class="trend-down">â†“ ${Math.abs(degisim).toFixed(1)}%</span>`;
          return '<span class="trend-same">â†’ 0%</span>';
        }

        window.loadAnalizDashboard = loadAnalizDashboard;

        // KiÅŸi bazlÄ± analiz yÃ¼kle
        function loadKisiAnalizi() {
          const arama = qs('#kisiAra').value.trim();
          const tipFiltre = qs('#kisiFiltreTip').value;
          const container = qs('#kisiAnalizList');
          if (!container) return;

          // TÃ¼m kiÅŸileri topla
          let kisiler = {};
          const yillar = [2023, 2024, 2025];
          const tipler = ['iftar', 'sahur', 'taahhut', 'teberru'];

          yillar.forEach(yil => {
            if (!analizVerileri[yil]) return;
            tipler.forEach(tip => {
              if (tipFiltre && tip !== tipFiltre) return;
              if (!analizVerileri[yil][tip]) return;

              Object.keys(analizVerileri[yil][tip]).forEach(kisiAdi => {
                // TÃ¼rkÃ§e karakter uyumlu arama
                if (arama && !turkishIncludes(kisiAdi, arama)) return;

                if (!kisiler[kisiAdi]) {
                  kisiler[kisiAdi] = { toplamTutar: 0, veriler: {}, kategori: '' };
                }

                const veriler = analizVerileri[yil][tip][kisiAdi];
                let tipTutar = 0;
                veriler.forEach(v => {
                  tipTutar += v.tutar || 0;
                });

                if (!kisiler[kisiAdi].veriler[yil]) kisiler[kisiAdi].veriler[yil] = {};
                kisiler[kisiAdi].veriler[yil][tip] = { tutar: tipTutar, kayit: veriler.length };
                kisiler[kisiAdi].toplamTutar += tipTutar;
              });
            });
          });

          // KiÅŸileri kategorize et
          const kisilerList = Object.keys(kisiler).map(kisiAdi => {
            const kisi = kisiler[kisiAdi];
            const yillarList = Object.keys(kisi.veriler);
            let kategori = 'yeni';

            if (yillarList.length === 3) {
              // 3 yÄ±lda da var
              const sonYil = Math.max(...yillarList.map(Number));
              if (kisi.veriler[sonYil]) {
                kategori = 'daimi';
              }
            } else if (yillarList.length === 1) {
              kategori = 'yeni';
            } else if (yillarList.length === 2) {
              const enSonYil = Math.max(...yillarList.map(Number));
              if (kisi.veriler[enSonYil]) {
                kategori = 'daimi';
              } else {
                kategori = 'pasif';
              }
            }

            return { ...kisi, adi: kisiAdi, kategori };
          });

          // Toplam tutara gÃ¶re sÄ±rala
          kisilerList.sort((a, b) => b.toplamTutar - a.toplamTutar);

          // HTML oluÅŸtur
          if (kisilerList.length === 0) {
            container.innerHTML = '<p style="text-align:center;color:var(--muted);padding:20px">KayÄ±t bulunamadÄ±.</p>';
            return;
          }

          let html = `
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>KiÅŸi</th>
                <th>2023</th>
                <th>2024</th>
                <th>2025</th>
                <th>Toplam</th>
                <th>Kategori</th>
                <th style="width:120px">Ä°ÅŸlemler</th>
              </tr>
            </thead>
            <tbody>
              ${kisilerList.slice(0, 50).map(kisi => {
            const yil2023 = kisi.veriler['2023'] ?
              Object.values(kisi.veriler['2023']).reduce((sum, v) => sum + v.tutar, 0) : 0;
            const yil2024 = kisi.veriler['2024'] ?
              Object.values(kisi.veriler['2024']).reduce((sum, v) => sum + v.tutar, 0) : 0;
            const yil2025 = kisi.veriler['2025'] ?
              Object.values(kisi.veriler['2025']).reduce((sum, v) => sum + v.tutar, 0) : 0;

            const kategoriBadge = kisi.kategori === 'daimi' ?
              '<span class="badge-daimi">Daimi BaÄŸÄ±ÅŸÃ§Ä±</span>' :
              kisi.kategori === 'yeni' ?
                '<span class="badge-yeni">Yeni BaÄŸÄ±ÅŸÃ§Ä±</span>' :
                '<span class="badge-pasif">Pasif OlmuÅŸ</span>';

            return `
                  <tr>
                    <td><strong>${kisi.adi}</strong></td>
                    <td>${yil2023 > 0 ? 'â‚º' + yil2023.toLocaleString('tr-TR', { minimumFractionDigits: 2 }) : '-'}</td>
                    <td>${yil2024 > 0 ? 'â‚º' + yil2024.toLocaleString('tr-TR', { minimumFractionDigits: 2 }) : '-'}</td>
                    <td>${yil2025 > 0 ? 'â‚º' + yil2025.toLocaleString('tr-TR', { minimumFractionDigits: 2 }) : '-'}</td>
                    <td><strong>â‚º${kisi.toplamTutar.toLocaleString('tr-TR', { minimumFractionDigits: 2 })}</strong></td>
                    <td>${kategoriBadge}</td>
                    <td><button onclick="openKisiDetay('${kisi.adi.replace(/'/g, "\\'")}')" style="padding:4px 8px;font-size:12px">Detay</button></td>
                  </tr>
                `;
          }).join('')}
            </tbody>
          </table>
        </div>
      `;

          container.innerHTML = html;
        }

        window.loadKisiAnalizi = loadKisiAnalizi;

        // Personel/Referans BazlÄ± DetaylÄ± Analiz
        function loadPersonelAnalizi() {
          const arama = normalizeTurkish(qs('#personelAra')?.value || '');
          const filtreYil = qs('#personelFiltreYil')?.value || '';
          const filtreTip = normalizeTurkish(qs('#personelFiltreTip')?.value || '');
          const container = qs('#personelAnalizList');

          if (!container) return;

          container.innerHTML = '<p style="text-align:center;color:var(--muted);padding:20px">YÃ¼kleniyor...</p>';

          // Personel/Referans bazlÄ± verileri topla
          const personeller = {}; // { personelAdi: { yillar: { 2023: {...}, 2024: {...}, 2025: {...} } } }
          const yillar = [2023, 2024, 2025];
          const tipler = ['iftar', 'sahur', 'taahhut', 'teberru'];

          yillar.forEach(yil => {
            if (filtreYil && String(yil) !== filtreYil) return; // YÄ±l filtresi
            if (!analizVerileri[yil]) return;

            tipler.forEach(tip => {
              if (filtreTip && tip !== filtreTip) return; // Tip filtresi
              if (!analizVerileri[yil][tip]) return;

              // Her sahip (baÄŸÄ±ÅŸ yapan kiÅŸi) iÃ§in personel/referans bilgisini al
              Object.keys(analizVerileri[yil][tip]).forEach(sahip => {
                const veriler = analizVerileri[yil][tip][sahip];
                veriler.forEach(v => {
                  // Personel adÄ±nÄ± normalize et (eÅŸleÅŸtirme iÃ§in)
                  // EÄŸer referans "DÄ°ÄER" ise, personel adÄ± olarak "DÄ°ÄER" gÃ¶ster
                  let rawPersonelAdi = v.personel || v.referans || 'Bilinmeyen';
                  // Referans "DÄ°ÄER" ise ve personel adÄ± yÃ¶netici adÄ± ise, "DÄ°ÄER" olarak gÃ¶ster
                  if (v.referans && normalizeTurkish(v.referans) === 'diÄŸer') {
                    rawPersonelAdi = 'DÄ°ÄER';
                  }
                  const personelAdi = normalizePersonelName(rawPersonelAdi);

                  // Arama filtresi (normalize edilmiÅŸ deÄŸerlerle)
                  if (arama && !turkishIncludes(normalizeTurkish(personelAdi), arama)) return;

                  // Normalize edilmiÅŸ personel adÄ±nÄ± key olarak kullan
                  if (!personeller[personelAdi]) {
                    personeller[personelAdi] = {
                      veriler: {},
                      toplamTutar: 0,
                      toplamKayit: 0
                    };
                  }

                  if (!personeller[personelAdi].veriler[yil]) {
                    personeller[personelAdi].veriler[yil] = {};
                  }

                  if (!personeller[personelAdi].veriler[yil][tip]) {
                    personeller[personelAdi].veriler[yil][tip] = [];
                  }

                  const tutar = Number(v.tutar) || 0;
                  personeller[personelAdi].veriler[yil][tip].push({
                    sahip: sahip,
                    diger: v.diger || '',
                    tutar: tutar,
                    referans: v.referans || ''
                  });

                  personeller[personelAdi].toplamTutar += tutar;
                  personeller[personelAdi].toplamKayit++;
                });
              });
            });
          });

          // Personelleri kategorize et ve sÄ±rala
          const personellerList = Object.keys(personeller).map(personelAdi => {
            const personel = personeller[personelAdi];
            const yillarList = Object.keys(personel.veriler).map(Number);

            // KiÅŸi kategorisi (baÄŸÄ±ÅŸ yapan kiÅŸiler iÃ§in deÄŸil, personel iÃ§in)
            // Burada personel'in kaÃ§ yÄ±ldÄ±r Ã§alÄ±ÅŸtÄ±ÄŸÄ±na bakÄ±yoruz
            let kategori = 'yeni';
            if (yillarList.length === 3) {
              kategori = 'daimi'; // 3 yÄ±ldÄ±r var
            } else if (yillarList.length === 1 && yillarList[0] === 2025) {
              kategori = 'yeni'; // Sadece 2025'te
            } else if (yillarList.length > 0 && Math.max(...yillarList) < 2025) {
              kategori = 'pasif'; // 2025'te yok
            } else if (yillarList.length === 2) {
              kategori = 'daimi'; // 2 yÄ±ldÄ±r var
            }

            return { ...personel, adi: personelAdi, kategori };
          });

          // Toplam tutara gÃ¶re sÄ±rala
          personellerList.sort((a, b) => b.toplamTutar - a.toplamTutar);

          // HTML oluÅŸtur
          if (personellerList.length === 0) {
            container.innerHTML = '<p style="text-align:center;color:var(--muted);padding:20px">KayÄ±t bulunamadÄ±.</p>';
            return;
          }

          let html = `
        <div style="margin-bottom:16px;padding:12px;background:#f0f7ff;border-left:4px solid var(--accent);border-radius:8px">
          <p style="margin:0;font-size:13px;line-height:1.6">
            <strong>ğŸ“Š Toplam:</strong> ${personellerList.length} personel/referans, 
            ${personellerList.reduce((sum, p) => sum + p.toplamKayit, 0)} kayÄ±t, 
            â‚º${personellerList.reduce((sum, p) => sum + p.toplamTutar, 0).toLocaleString('tr-TR', { minimumFractionDigits: 2 })}
          </p>
        </div>
        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Personel/Referans</th>
                <th>2023</th>
                <th>2024</th>
                <th>2025</th>
                <th>Toplam</th>
                <th>KayÄ±t</th>
                <th>Kategori</th>
                <th style="width:120px">Ä°ÅŸlemler</th>
              </tr>
            </thead>
            <tbody>
              ${personellerList.map(personel => {
            const yil2023 = personel.veriler['2023'] ?
              Object.values(personel.veriler['2023']).flat().reduce((sum, v) => sum + (v.tutar || 0), 0) : 0;
            const yil2024 = personel.veriler['2024'] ?
              Object.values(personel.veriler['2024']).flat().reduce((sum, v) => sum + (v.tutar || 0), 0) : 0;
            const yil2025 = personel.veriler['2025'] ?
              Object.values(personel.veriler['2025']).flat().reduce((sum, v) => sum + (v.tutar || 0), 0) : 0;

            const kategoriBadge = personel.kategori === 'daimi' ?
              '<span class="badge-daimi">Daimi Personel</span>' :
              personel.kategori === 'yeni' ?
                '<span class="badge-yeni">Yeni Personel</span>' :
                '<span class="badge-pasif">Pasif Personel</span>';

            return `
                  <tr>
                    <td><strong>${personel.adi}</strong></td>
                    <td>${yil2023 > 0 ? 'â‚º' + yil2023.toLocaleString('tr-TR', { minimumFractionDigits: 2 }) : '-'}</td>
                    <td>${yil2024 > 0 ? 'â‚º' + yil2024.toLocaleString('tr-TR', { minimumFractionDigits: 2 }) : '-'}</td>
                    <td>${yil2025 > 0 ? 'â‚º' + yil2025.toLocaleString('tr-TR', { minimumFractionDigits: 2 }) : '-'}</td>
                    <td><strong>â‚º${personel.toplamTutar.toLocaleString('tr-TR', { minimumFractionDigits: 2 })}</strong></td>
                    <td>${personel.toplamKayit}</td>
                    <td>${kategoriBadge}</td>
                    <td><button onclick="openPersonelDetay('${personel.adi.replace(/'/g, "\\'")}')" style="padding:4px 8px;font-size:12px">Detay</button></td>
                  </tr>
                `;
          }).join('')}
            </tbody>
          </table>
        </div>
      `;

          container.innerHTML = html;
        }

        window.loadPersonelAnalizi = loadPersonelAnalizi;

        // Personel/Referans Detay Modal
        function openPersonelDetay(personelAdi) {
          qs('#personelDetayTitle').textContent = `ğŸ‘¥ ${personelAdi} - DetaylÄ± Analiz`;

          // Personelin tÃ¼m verilerini topla
          let personelVerileri = [];
          const yillar = [2023, 2024, 2025];
          const tipler = ['iftar', 'sahur', 'taahhut', 'teberru'];
          const tipLabels = { iftar: 'ğŸŒ™ Ä°ftar', sahur: 'ğŸŒŸ Sahur', taahhut: 'ğŸ“‹ TaahhÃ¼t', teberru: 'ğŸ’ Teberru' };

          yillar.forEach(yil => {
            if (!analizVerileri[yil]) return;
            tipler.forEach(tip => {
              if (!analizVerileri[yil][tip]) return;

              // Her sahip iÃ§in personel/referans kontrolÃ¼
              Object.keys(analizVerileri[yil][tip]).forEach(sahip => {
                const veriler = analizVerileri[yil][tip][sahip];
                veriler.forEach(v => {
                  // Personel adÄ±nÄ± normalize et ve karÅŸÄ±laÅŸtÄ±r
                  // EÄŸer referans "DÄ°ÄER" ise, personel adÄ± olarak "DÄ°ÄER" gÃ¶ster
                  let rawVPersonel = v.personel || v.referans || 'Bilinmeyen';
                  if (v.referans && normalizeTurkish(v.referans) === 'diÄŸer') {
                    rawVPersonel = 'DÄ°ÄER';
                  }
                  const vPersonel = normalizePersonelName(rawVPersonel);
                  const normalizedPersonelAdi = normalizePersonelName(personelAdi);

                  // Normalize edilmiÅŸ deÄŸerlerle karÅŸÄ±laÅŸtÄ±r
                  if (vPersonel === normalizedPersonelAdi) {
                    personelVerileri.push({
                      yil,
                      tip,
                      tipLabel: tipLabels[tip] || tip,
                      sahip: sahip,
                      diger: v.diger || '',
                      tutar: v.tutar || 0,
                      referans: v.referans || ''
                    });
                  }
                });
              });
            });
          });

          // YÄ±llara ve tiplere gÃ¶re grupla
          let yilTipOzeti = {};
          personelVerileri.forEach(v => {
            const key = `${v.yil}_${v.tip}`;
            if (!yilTipOzeti[key]) {
              yilTipOzeti[key] = {
                yil: v.yil,
                tip: v.tip,
                tipLabel: v.tipLabel,
                toplam: 0,
                kayitSayisi: 0,
                kisiler: []
              };
            }
            yilTipOzeti[key].toplam += v.tutar;
            yilTipOzeti[key].kayitSayisi++;
            if (!yilTipOzeti[key].kisiler.includes(v.sahip)) {
              yilTipOzeti[key].kisiler.push(v.sahip);
            }
          });

          const container = qs('#personelDetayContent');
          let html = `
        <div class="stats-grid">
          ${yillar.map(yil => {
            const yilVerileri = personelVerileri.filter(v => v.yil === yil);
            const yilToplam = yilVerileri.reduce((sum, v) => sum + v.tutar, 0);
            const trend = yil > 2023 ?
              calculateTrend(
                personelVerileri.filter(v => v.yil === yil - 1).reduce((sum, v) => sum + v.tutar, 0),
                yilToplam
              ) : '';
            return `
              <div class="stat-card">
                <div class="stat-label">${yil} Toplam</div>
                <div class="stat-value">â‚º${yilToplam.toLocaleString('tr-TR', { minimumFractionDigits: 2 })}</div>
                <div style="font-size:12px">${yilVerileri.length} kayÄ±t</div>
                <div style="font-size:12px">${trend || ''}</div>
              </div>
            `;
          }).join('')}
          <div class="stat-card">
            <div class="stat-label">Genel Toplam</div>
            <div class="stat-value">â‚º${personelVerileri.reduce((sum, v) => sum + v.tutar, 0).toLocaleString('tr-TR', { minimumFractionDigits: 2 })}</div>
            <div style="font-size:12px">${personelVerileri.length} kayÄ±t</div>
          </div>
        </div>
        
        <div class="card" style="margin-top:16px">
          <h4 style="margin:0 0 12px 0">YÄ±l ve Tip BazlÄ± Detay</h4>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>YÄ±l</th>
                  <th>Tip</th>
                  <th>Toplam Tutar (â‚º)</th>
                  <th>KayÄ±t SayÄ±sÄ±</th>
                  <th>BaÄŸÄ±ÅŸÃ§Ä± SayÄ±sÄ±</th>
                </tr>
              </thead>
              <tbody>
                ${Object.values(yilTipOzeti).sort((a, b) => {
            if (a.yil !== b.yil) return b.yil - a.yil;
            return a.tip.localeCompare(b.tip);
          }).map(ozet => `
                  <tr>
                    <td><strong>${ozet.yil}</strong></td>
                    <td>${ozet.tipLabel}</td>
                    <td><strong>â‚º${ozet.toplam.toLocaleString('tr-TR', { minimumFractionDigits: 2 })}</strong></td>
                    <td>${ozet.kayitSayisi}</td>
                    <td>${ozet.kisiler.length}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
        
        <div class="card" style="margin-top:16px">
          <h4 style="margin:0 0 12px 0">TÃ¼m KayÄ±tlar (DetaylÄ±)</h4>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>YÄ±l</th>
                  <th>Tip</th>
                  <th>Sahip (BaÄŸÄ±ÅŸ Yapan)</th>
                  <th>DiÄŸer</th>
                  <th>Tutar (â‚º)</th>
                  <th>Referans</th>
                </tr>
              </thead>
              <tbody>
                ${personelVerileri.sort((a, b) => {
            if (a.yil !== b.yil) return b.yil - a.yil;
            if (a.tip !== b.tip) return a.tip.localeCompare(b.tip);
            return b.tutar - a.tutar;
          }).map(v => `
                  <tr>
                    <td>${v.yil}</td>
                    <td>${v.tipLabel}</td>
                    <td>${v.sahip}</td>
                    <td>${v.diger || '-'}</td>
                    <td>â‚º${v.tutar.toLocaleString('tr-TR', { minimumFractionDigits: 2 })}</td>
                    <td>${v.referans || '-'}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;

          container.innerHTML = html;
          qs('#modalPersonelDetay').classList.add('show');
          document.body.classList.add('modal-open');
        }

        window.openPersonelDetay = openPersonelDetay;

        function closePersonelDetay() {
          qs('#modalPersonelDetay').classList.remove('show');
          document.body.classList.remove('modal-open');
        }

        window.closePersonelDetay = closePersonelDetay;

        // KiÅŸi detay modal
        function openKisiDetay(kisiAdi) {
          qs('#kisiDetayTitle').textContent = `ğŸ‘¤ ${kisiAdi} - DetaylÄ± Analiz`;

          // KiÅŸinin tÃ¼m verilerini topla
          let kisiVerileri = [];
          const yillar = [2023, 2024, 2025];
          const tipler = ['iftar', 'sahur', 'taahhut', 'teberru'];
          const tipLabels = { iftar: 'ğŸŒ™ Ä°ftar', sahur: 'ğŸŒŸ Sahur', taahhut: 'ğŸ“‹ TaahhÃ¼t', teberru: 'ğŸ’ Teberru' };

          yillar.forEach(yil => {
            if (!analizVerileri[yil]) return;
            tipler.forEach(tip => {
              if (!analizVerileri[yil][tip] || !analizVerileri[yil][tip][kisiAdi]) return;

              const veriler = analizVerileri[yil][tip][kisiAdi];
              veriler.forEach(v => {
                kisiVerileri.push({
                  yil,
                  tip,
                  tipLabel: tipLabels[tip] || tip,
                  diger: v.diger || '',
                  tutar: v.tutar || 0,
                  referans: v.referans || ''
                });
              });
            });
          });

          // YÄ±llara gÃ¶re grupla
          let yilOzeti = {};
          kisiVerileri.forEach(v => {
            if (!yilOzeti[v.yil]) yilOzeti[v.yil] = { toplam: 0, tipler: {} };
            yilOzeti[v.yil].toplam += v.tutar;
            if (!yilOzeti[v.yil].tipler[v.tip]) yilOzeti[v.yil].tipler[v.tip] = 0;
            yilOzeti[v.yil].tipler[v.tip] += v.tutar;
          });

          const container = qs('#kisiDetayContent');
          let html = `
        <div class="stats-grid">
          ${yillar.map(yil => {
            const ozet = yilOzeti[yil] || { toplam: 0, tipler: {} };
            const trend = yil > 2023 && yilOzeti[yil - 1] ?
              calculateTrend(yilOzeti[yil - 1].toplam, ozet.toplam) : '';
            return `
              <div class="stat-card">
                <div class="stat-label">${yil} Toplam</div>
                <div class="stat-value">â‚º${ozet.toplam.toLocaleString('tr-TR', { minimumFractionDigits: 2 })}</div>
                <div style="font-size:12px">${trend || ''}</div>
              </div>
            `;
          }).join('')}
        </div>
        
        <div class="card" style="margin-top:16px">
          <h4 style="margin:0 0 12px 0">YÄ±llÄ±k Detay</h4>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>YÄ±l</th>
                  <th>Tip</th>
                  <th>DiÄŸer</th>
                  <th>Tutar (â‚º)</th>
                  <th>Referans</th>
                </tr>
              </thead>
              <tbody>
                ${kisiVerileri.sort((a, b) => {
            if (a.yil !== b.yil) return b.yil - a.yil;
            return b.tutar - a.tutar;
          }).map(v => `
                  <tr>
                    <td><strong>${v.yil}</strong></td>
                    <td>${v.tipLabel}</td>
                    <td>${v.diger || '-'}</td>
                    <td><strong>â‚º${v.tutar.toLocaleString('tr-TR', { minimumFractionDigits: 2 })}</strong></td>
                    <td>${v.referans || '-'}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;

          container.innerHTML = html;
          qs('#modalKisiDetay').classList.add('show');
          document.body.classList.add('modal-open');
        }

        function closeKisiDetayModal() {
          qs('#modalKisiDetay').classList.remove('show');
          document.body.classList.remove('modal-open');
        }

        window.openKisiDetay = openKisiDetay;
        window.closeKisiDetayModal = closeKisiDetayModal;

        // Trend analizi yÃ¼kle
        function loadTrendAnaliz() {
          const container = qs('#trendAnaliz');
          if (!container) return;

          const yillar = [2023, 2024, 2025];
          const tipler = ['iftar', 'sahur', 'taahhut', 'teberru'];
          const tipLabels = { iftar: 'ğŸŒ™ Ä°ftar', sahur: 'ğŸŒŸ Sahur', taahhut: 'ğŸ“‹ TaahhÃ¼t', teberru: 'ğŸ’ Teberru' };

          let html = '<div class="card"><h4 style="margin:0 0 12px 0">Tip BazlÄ± Trend Analizi</h4>';

          tipler.forEach(tip => {
            let tipVeriler = [];
            yillar.forEach(yil => {
              if (!analizVerileri[yil] || !analizVerileri[yil][tip]) {
                tipVeriler.push({ yil, tutar: 0, kayit: 0, kisi: 0 });
                return;
              }

              const kisiler = Object.keys(analizVerileri[yil][tip]);
              let tutar = 0;
              let kayit = 0;

              kisiler.forEach(kisi => {
                const veriler = analizVerileri[yil][tip][kisi];
                veriler.forEach(v => {
                  tutar += v.tutar || 0;
                  kayit++;
                });
              });

              tipVeriler.push({ yil, tutar, kayit, kisi: kisiler.length });
            });

            const maxTutar = Math.max(...tipVeriler.map(v => v.tutar));

            html += `
          <div style="margin-bottom:20px;padding:12px;background:#f8f9fa;border-radius:8px">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
              <strong>${tipLabels[tip] || tip}</strong>
              <span style="font-size:12px;color:var(--muted)">
                Toplam: â‚º${tipVeriler.reduce((sum, v) => sum + v.tutar, 0).toLocaleString('tr-TR', { minimumFractionDigits: 2 })}
              </span>
            </div>
            ${yillar.map(yil => {
              const veri = tipVeriler.find(v => v.yil === yil);
              const trend = yil > 2023 ? calculateTrend(
                tipVeriler.find(v => v.yil === yil - 1)?.tutar || 0,
                veri.tutar
              ) : '';
              const yuzde = maxTutar > 0 ? (veri.tutar / maxTutar) * 100 : 0;

              return `
                <div style="margin-bottom:8px">
                  <div style="display:flex;justify-content:space-between;margin-bottom:4px">
                    <span style="font-size:13px"><strong>${yil}:</strong> â‚º${veri.tutar.toLocaleString('tr-TR', { minimumFractionDigits: 2 })}</span>
                    <span style="font-size:12px">${veri.kayit} kayÄ±t, ${veri.kisi} kiÅŸi ${trend}</span>
                  </div>
                  <div class="progress-bar">
                    <div class="progress-fill" style="width:${yuzde}%"></div>
                  </div>
                </div>
              `;
            }).join('')}
          </div>
        `;
          });

          html += '</div>';
          container.innerHTML = html;
        }

        window.loadTrendAnaliz = loadTrendAnaliz;

        // Kategori analizi yÃ¼kle
        function loadKategoriAnaliz() {
          const container = qs('#kategoriAnaliz');
          if (!container) return;

          // TÃ¼m kiÅŸileri kategorize et
          let kisiler = {};
          const yillar = [2023, 2024, 2025];
          const tipler = ['iftar', 'sahur', 'taahhut', 'teberru'];

          yillar.forEach(yil => {
            if (!analizVerileri[yil]) return;
            tipler.forEach(tip => {
              if (!analizVerileri[yil][tip]) return;
              Object.keys(analizVerileri[yil][tip]).forEach(kisiAdi => {
                if (!kisiler[kisiAdi]) {
                  kisiler[kisiAdi] = { veriler: {} };
                }
                if (!kisiler[kisiAdi].veriler[yil]) {
                  kisiler[kisiAdi].veriler[yil] = [];
                }
                kisiler[kisiAdi].veriler[yil].push(...analizVerileri[yil][tip][kisiAdi]);
              });
            });
          });

          let daimi = [];
          let yeni = [];
          let pasif = [];

          Object.keys(kisiler).forEach(kisiAdi => {
            const kisi = kisiler[kisiAdi];
            const yillarList = Object.keys(kisi.veriler).map(Number);
            const toplamTutar = Object.values(kisi.veriler).flat().reduce((sum, v) => sum + (v.tutar || 0), 0);

            if (yillarList.length === 3) {
              // 3 yÄ±lda da var - daimi
              daimi.push({ adi: kisiAdi, toplamTutar, yillar: yillarList });
            } else if (yillarList.length === 1 && yillarList[0] === 2025) {
              // Sadece 2025'te var - yeni
              yeni.push({ adi: kisiAdi, toplamTutar, yillar: yillarList });
            } else if (yillarList.length > 0 && Math.max(...yillarList) < 2025) {
              // 2025'te yok - pasif
              pasif.push({ adi: kisiAdi, toplamTutar, yillar: yillarList });
            } else {
              yeni.push({ adi: kisiAdi, toplamTutar, yillar: yillarList });
            }
          });

          // Toplam tutara gÃ¶re sÄ±rala
          daimi.sort((a, b) => b.toplamTutar - a.toplamTutar);
          yeni.sort((a, b) => b.toplamTutar - a.toplamTutar);
          pasif.sort((a, b) => b.toplamTutar - a.toplamTutar);

          let html = `
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Daimi BaÄŸÄ±ÅŸÃ§Ä±</div>
            <div class="stat-value">${daimi.length}</div>
            <div style="font-size:12px;color:var(--muted)">
              â‚º${daimi.reduce((sum, k) => sum + k.toplamTutar, 0).toLocaleString('tr-TR', { minimumFractionDigits: 2 })}
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Yeni BaÄŸÄ±ÅŸÃ§Ä±</div>
            <div class="stat-value">${yeni.length}</div>
            <div style="font-size:12px;color:var(--muted)">
              â‚º${yeni.reduce((sum, k) => sum + k.toplamTutar, 0).toLocaleString('tr-TR', { minimumFractionDigits: 2 })}
            </div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Pasif OlmuÅŸ</div>
            <div class="stat-value">${pasif.length}</div>
            <div style="font-size:12px;color:var(--muted)">
              â‚º${pasif.reduce((sum, k) => sum + k.toplamTutar, 0).toLocaleString('tr-TR', { minimumFractionDigits: 2 })}
            </div>
          </div>
        </div>
        
        <div class="card" style="margin-top:16px">
          <h4 style="margin:0 0 12px 0">Daimi BaÄŸÄ±ÅŸÃ§Ä±lar (Top ${daimi.length})</h4>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>KiÅŸi</th>
                  <th>2023</th>
                  <th>2024</th>
                  <th>2025</th>
                  <th>Toplam</th>
                  <th style="width:120px">Ä°ÅŸlemler</th>
                </tr>
              </thead>
              <tbody>
                ${daimi.slice(0, 20).map(k => {
            const yil2023 = k.yillar.includes(2023) ? 'âœ“' : '-';
            const yil2024 = k.yillar.includes(2024) ? 'âœ“' : '-';
            const yil2025 = k.yillar.includes(2025) ? 'âœ“' : '-';
            return `
                    <tr>
                      <td><strong>${k.adi}</strong></td>
                      <td>${yil2023}</td>
                      <td>${yil2024}</td>
                      <td>${yil2025}</td>
                      <td><strong>â‚º${k.toplamTutar.toLocaleString('tr-TR', { minimumFractionDigits: 2 })}</strong></td>
                      <td><button onclick="openKisiDetay('${k.adi.replace(/'/g, "\\'")}')" style="padding:4px 8px;font-size:12px">Detay</button></td>
                    </tr>
                  `;
          }).join('')}
              </tbody>
            </table>
          </div>
        </div>
        
        <div class="card" style="margin-top:16px">
          <h4 style="margin:0 0 12px 0">Yeni BaÄŸÄ±ÅŸÃ§Ä±lar (Top ${yeni.length})</h4>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>KiÅŸi</th>
                  <th>Ä°lk YÄ±l</th>
                  <th>Toplam</th>
                  <th style="width:120px">Ä°ÅŸlemler</th>
                </tr>
              </thead>
              <tbody>
                ${yeni.slice(0, 20).map(k => {
            const ilkYil = Math.min(...k.yillar);
            return `
                    <tr>
                      <td><strong>${k.adi}</strong></td>
                      <td>${ilkYil}</td>
                      <td><strong>â‚º${k.toplamTutar.toLocaleString('tr-TR', { minimumFractionDigits: 2 })}</strong></td>
                      <td><button onclick="openKisiDetay('${k.adi.replace(/'/g, "\\'")}')" style="padding:4px 8px;font-size:12px">Detay</button></td>
                    </tr>
                  `;
          }).join('')}
              </tbody>
            </table>
          </div>
        </div>
        
        <div class="card" style="margin-top:16px">
          <h4 style="margin:0 0 12px 0">Pasif OlmuÅŸ BaÄŸÄ±ÅŸÃ§Ä±lar (Top ${pasif.length})</h4>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th>KiÅŸi</th>
                  <th>Son YÄ±l</th>
                  <th>Toplam</th>
                  <th style="width:120px">Ä°ÅŸlemler</th>
                </tr>
              </thead>
              <tbody>
                ${pasif.slice(0, 20).map(k => {
            const sonYil = Math.max(...k.yillar);
            return `
                    <tr>
                      <td><strong>${k.adi}</strong></td>
                      <td>${sonYil}</td>
                      <td><strong>â‚º${k.toplamTutar.toLocaleString('tr-TR', { minimumFractionDigits: 2 })}</strong></td>
                      <td><button onclick="openKisiDetay('${k.adi.replace(/'/g, "\\'")}')" style="padding:4px 8px;font-size:12px">Detay</button></td>
                    </tr>
                  `;
          }).join('')}
              </tbody>
            </table>
          </div>
        </div>
      `;

          container.innerHTML = html;
        }

        window.loadKategoriAnaliz = loadKategoriAnaliz;

        // Veri DÃ¼zenleme FonksiyonlarÄ± - SÄ±ralama durumu
        let veriDuzenlemeSiralama = {
          column: 'createdAt',
          direction: 'desc'
        };

        function loadVeriDuzenleme() {
          const yil = qs('#duzenleYil')?.value || '2023';
          const tip = normalizeTurkish(qs('#duzenleTip')?.value || '');
          const arama = qs('#duzenleAra')?.value?.trim() || '';
          const container = qs('#veriDuzenlemeList');

          if (!container) return;

          container.innerHTML = '<p style="text-align:center;color:var(--muted);padding:20px">YÃ¼kleniyor...</p>';

          // Supabase'den verileri Ã§ek
          const supabase = getSupabase();
          if (!supabase) {
            container.innerHTML = '<p style="text-align:center;color:var(--danger);padding:20px">Supabase baÄŸlantÄ±sÄ± kurulamadÄ±.</p>';
            return;
          }

          let query = supabase
            .from('ramazan_veriler')
            .select('*')
            .eq('yil', parseInt(yil));

          // Arama filtresi (Supabase'de 'ilike' ile yapÄ±labilir ama karmaÅŸÄ±k string aramasÄ± iÃ§in client-side filtreleme daha gÃ¼venli olabilir 
          // veya 'or' filtresi kullanÄ±labilir. Åimdilik verileri Ã§ekip client-side filtreleyelim Ã§Ã¼nkÃ¼ arama birden fazla alanÄ± kapsÄ±yor)
          // GerÃ§i 'ilike' ile tek tek yapmak zor, tÃ¼m veriyi Ã§ekmek performansÄ± etkileyebilir ama veri seti kÃ¼Ã§Ã¼kse sorun olmaz.
          // Åimdilik sadece yÄ±lÄ± filtreleyip Ã§ekiyoruz.

          query.then(({ data, error }) => {
            if (error) {
              console.error('Veri yÃ¼kleme hatasÄ±:', error);
              container.innerHTML = '<p style="text-align:center;color:var(--danger);padding:20px">Veri yÃ¼klenirken hata oluÅŸtu.</p>';
              return;
            }

            let veriler = [];

            (data || []).forEach(d => {
              const docTip = normalizeTurkish(d.tip || '');

              // Tip filtresi
              if (tip && docTip !== tip) return;

              // Arama filtresi (sahip, personel, referans)
              if (arama) {
                const searchText = normalizeTurkish(arama);
                const sahipText = normalizeTurkish(d.sahip || '');
                const personelText = normalizeTurkish(d.personel || '');
                const referansText = normalizeTurkish(d.referans || '');

                if (!sahipText.includes(searchText) &&
                  !personelText.includes(searchText) &&
                  !referansText.includes(searchText)) {
                  return;
                }
              }

              veriler.push({
                id: d.id,
                yil: d.yil || 2025,
                tip: d.tip || '',
                sahip: d.sahip || '',
                diger: d.diger || '',
                tutar: d.tutar || 0,
                referans: d.referans || '',
                personel: d.personel || '',
                createdAt: d.createdat ? new Date(d.createdat) : (d.createdAt ? new Date(d.createdAt) : new Date()) // Åemadan gelen createdat -> createdAt
              });
            });

            // Client-side sÄ±ralama (sÄ±ralama durumuna gÃ¶re)
            veriler.sort((a, b) => {
              let aVal, bVal;

              switch (veriDuzenlemeSiralama.column) {
                case 'tip':
                  aVal = (a.tip || '').toLowerCase();
                  bVal = (b.tip || '').toLowerCase();
                  break;
                case 'sahip':
                  aVal = (a.sahip || '').toLowerCase();
                  bVal = (b.sahip || '').toLowerCase();
                  break;
                case 'diger':
                  aVal = (a.diger || '').toLowerCase();
                  bVal = (b.diger || '').toLowerCase();
                  break;
                case 'tutar':
                  aVal = a.tutar || 0;
                  bVal = b.tutar || 0;
                  break;
                case 'personel':
                  aVal = (a.personel || a.referans || '').toLowerCase();
                  bVal = (b.personel || b.referans || '').toLowerCase();
                  break;
                case 'createdAt':
                default:
                  aVal = a.createdAt instanceof Date ? a.createdAt.getTime() : (a.createdAt ? new Date(a.createdAt).getTime() : 0);
                  bVal = b.createdAt instanceof Date ? b.createdAt.getTime() : (b.createdAt ? new Date(b.createdAt).getTime() : 0);
                  break;
              }

              if (typeof aVal === 'string') {
                return veriDuzenlemeSiralama.direction === 'asc'
                  ? aVal.localeCompare(bVal, 'tr')
                  : bVal.localeCompare(aVal, 'tr');
              } else {
                return veriDuzenlemeSiralama.direction === 'asc'
                  ? aVal - bVal
                  : bVal - aVal;
              }
            });

            // HTML oluÅŸtur
            if (veriler.length === 0) {
              container.innerHTML = '<p style="text-align:center;color:var(--muted);padding:20px">KayÄ±t bulunamadÄ±.</p>';
              return;
            }

            const tipLabels = {
              iftar: 'ğŸŒ™ Ä°ftar',
              sahur: 'ğŸŒŸ Sahur',
              taahhut: 'ğŸ“‹ TaahhÃ¼t',
              teberru: 'ğŸ’ Teberru'
            };

            let html = `
          <div style="margin-bottom:16px;padding:12px;background:#f0f7ff;border-left:4px solid var(--accent);border-radius:8px;display:flex;justify-content:space-between;align-items:center">
            <p style="margin:0;font-size:13px;line-height:1.6">
              <strong>ğŸ“Š Toplam:</strong> ${veriler.length} kayÄ±t
            </p>
            <div style="display:flex;gap:8px;align-items:center">
              <span id="selectedCount" style="font-size:13px;color:var(--accent);font-weight:600;display:none">0 seÃ§ili</span>
              <button id="btnTopluPersonel" onclick="openTopluPersonelModal()" style="display:none;padding:6px 12px;font-size:13px;background:var(--accent);color:white;border:none;border-radius:6px;cursor:pointer">âœï¸ Personel DeÄŸiÅŸtir</button>
            </div>
          </div>
          <div class="table-wrap">
            <table>
              <thead>
                <tr>
                  <th style="width:40px"><input type="checkbox" id="selectAllVeriler" onchange="toggleSelectAllVeriler(this)" /></th>
                  <th style="width:80px">ID</th>
                  <th class="sortable" data-column="tip" style="cursor:pointer;user-select:none">
                    Tip
                  </th>
                  <th class="sortable" data-column="sahip" style="cursor:pointer;user-select:none">
                    Sahip
                  </th>
                  <th class="sortable" data-column="diger" style="cursor:pointer;user-select:none">
                    DiÄŸer
                  </th>
                  <th class="sortable" data-column="tutar" style="cursor:pointer;user-select:none">
                    Tutar (â‚º)
                  </th>
                  <th class="sortable" data-column="personel" style="cursor:pointer;user-select:none">
                    Personel/Referans
                  </th>
                  <th style="width:120px">Ä°ÅŸlemler</th>
                </tr>
              </thead>
              <tbody>
                ${veriler.map(v => {
              const tipLabel = tipLabels[v.tip] || v.tip;
              const shortId = v.id.substring(0, 8);
              return `
                    <tr>
                      <td><input type="checkbox" class="veri-checkbox" data-id="${v.id}" onchange="updateSelectedCount()" /></td>
                      <td style="font-size:11px;color:var(--muted)">${shortId}...</td>
                      <td>${tipLabel}</td>
                      <td><strong>${v.sahip}</strong></td>
                      <td>${v.diger || '-'}</td>
                      <td>â‚º${v.tutar.toLocaleString('tr-TR', { minimumFractionDigits: 2 })}</td>
                      <td>${(v.referans && normalizeTurkish(v.referans) === 'diÄŸer') ? 'DÄ°ÄER' : (v.personel || v.referans || '-')}</td>
                      <td>
                        <button onclick="openVeriDuzenlemeModal('${v.id}')" style="padding:4px 8px;font-size:12px">DÃ¼zenle</button>
                      </td>
                    </tr>
                  `;
            }).join('')}
              </tbody>
            </table>
          </div>
        `;

            container.innerHTML = html;
            
            // SÄ±ralama event listener'larÄ±nÄ± ekle
            const sortableHeaders = container.querySelectorAll('.sortable[data-column]');
            sortableHeaders.forEach(header => {
              header.addEventListener('click', function() {
                const column = this.getAttribute('data-column');
                // AynÄ± kolona tÄ±klanÄ±rsa yÃ¶n deÄŸiÅŸtir, farklÄ± kolona tÄ±klanÄ±rsa asc yap
                if (veriDuzenlemeSiralama.column === column) {
                  veriDuzenlemeSiralama.direction = veriDuzenlemeSiralama.direction === 'asc' ? 'desc' : 'asc';
                } else {
                  veriDuzenlemeSiralama.column = column;
                  veriDuzenlemeSiralama.direction = 'asc';
                }
                // Listeyi yeniden yÃ¼kle
                loadVeriDuzenleme();
              });
            });
          }).catch(error => {
            console.error('Veri dÃ¼zenleme yÃ¼kleme hatasÄ±:', error);
            container.innerHTML = '<p style="text-align:center;color:var(--danger);padding:20px">Veri yÃ¼klenirken hata oluÅŸtu.</p>';
          });
        }

        window.loadVeriDuzenleme = loadVeriDuzenleme;

        // Personel dropdown'unu doldur
        async function fillPersonelDropdown(selectId) {
          if (!kullanicilarList || kullanicilarList.length === 0) {
            await loadKullanicilar();
          }
          const select = qs(selectId);
          if (!select) return;
          
          // Mevcut "Personel SeÃ§iniz" ve "Manuel GiriÅŸ" seÃ§eneklerini koru
          const firstOption = select.querySelector('option[value=""]');
          const manualOption = select.querySelector('option[value="__MANUEL__"]');
          select.innerHTML = '';
          if (firstOption) select.appendChild(firstOption);
          if (manualOption) select.appendChild(manualOption);
          
          kullanicilarList.forEach(k => {
            const option = document.createElement('option');
            option.value = k.id;
            option.textContent = k.adsoyad || k.email || k.id;
            select.appendChild(option);
          });
        }

        // Veri dÃ¼zenleme modalÄ±nÄ± aÃ§
        async function openVeriDuzenlemeModal(docId) {
          // Personel dropdown'unu doldur
          await fillPersonelDropdown('#duzenlePersonel');
          
          // Manuel giriÅŸ toggle
          const personelSelect = qs('#duzenlePersonel');
          const referansWrapper = qs('#duzenleReferansWrapper');
          if (personelSelect && referansWrapper) {
            personelSelect.onchange = function() {
              referansWrapper.style.display = this.value === '__MANUEL__' ? 'block' : 'none';
              if (this.value !== '__MANUEL__') {
                qs('#duzenleReferans').value = '';
              }
            };
          }

          if (!docId) {
            // Yeni kayÄ±t
            qs('#veriDuzenlemeTitle').textContent = 'âœï¸ Yeni Veri Ekle';
            qs('#formVeriDuzenleme').reset();
            qs('#duzenleId').value = '';
            qs('#btnDeleteVeri').style.display = 'none';
            qs('#duzenleYilInput').value = qs('#duzenleYil')?.value || '2023';
            qs('#duzenlePersonel').value = '';
            qs('#duzenleReferansWrapper').style.display = 'none';
            qs('#modalVeriDuzenleme').classList.add('show');
            document.body.classList.add('modal-open');
            return;
          }

          // Mevcut kaydÄ± yÃ¼kle - Supabase
          const supabase = getSupabase();
          if (!supabase) return;

          supabase
            .from('ramazan_veriler')
            .select('*')
            .eq('id', docId)
            .single()
            .then(async ({ data, error }) => {
              if (error || !data) {
                showToast('KayÄ±t bulunamadÄ±.', '', 'error');
                return;
              }

              // KullanÄ±cÄ± listesinin yÃ¼klÃ¼ olduÄŸundan emin ol
              if (!kullanicilarList || kullanicilarList.length === 0) {
                await loadKullanicilar();
              }

              qs('#veriDuzenlemeTitle').textContent = 'âœï¸ Veri DÃ¼zenleme';
              qs('#duzenleId').value = docId;
              qs('#duzenleYilInput').value = String(data.yil || '2023');
              qs('#duzenleTipInput').value = data.tip || 'iftar';
              qs('#duzenleSahip').value = data.sahip || '';
              qs('#duzenleDiger').value = data.diger || '';
              // TutarÄ± TÃ¼rkÃ§e formatÄ±nda gÃ¶ster
              const tutar = data.tutar || 0;
              qs('#duzenleTutar').value = tutar.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).replace(/\./g, '|TEMP|').replace(/,/g, '.').replace(/\|TEMP\|/g, ',');
              
              // Personel bilgisini doldur (ramazan_veriler tablosunda personeluid kolonu yok, sadece personel ve referans var)
              // Personel dropdown'unda kullanÄ±cÄ± listesi var, ama mevcut kayÄ±tta personel adÄ± var
              // EÄŸer personel adÄ± kullanÄ±cÄ± listesinde varsa onu seÃ§, yoksa manuel giriÅŸ yap
              if (data.personel) {
                // Personel adÄ±nÄ± kullanÄ±cÄ± listesinde ara
                const matchingPersonel = kullanicilarList.find(k => {
                  const kullaniciAdi = (k.adsoyad || k.email || '').trim();
                  const kayitPersoneli = (data.personel || '').trim();
                  return kullaniciAdi === kayitPersoneli || kullaniciAdi.toLowerCase() === kayitPersoneli.toLowerCase();
                });
                
                if (matchingPersonel) {
                  qs('#duzenlePersonel').value = matchingPersonel.id;
                  qs('#duzenleReferansWrapper').style.display = 'none';
                } else {
                  // Manuel giriÅŸ
                  qs('#duzenlePersonel').value = '__MANUEL__';
                  qs('#duzenleReferans').value = data.referans || data.personel || '';
                  qs('#duzenleReferansWrapper').style.display = 'block';
                }
              } else if (data.referans) {
                qs('#duzenlePersonel').value = '__MANUEL__';
                qs('#duzenleReferans').value = data.referans;
                qs('#duzenleReferansWrapper').style.display = 'block';
              } else {
                qs('#duzenlePersonel').value = '';
                qs('#duzenleReferansWrapper').style.display = 'none';
              }
              
              qs('#btnDeleteVeri').style.display = 'inline-block';
              qs('#btnDeleteVeri').setAttribute('data-doc-id', docId);

              qs('#modalVeriDuzenleme').classList.add('show');
              document.body.classList.add('modal-open');
            }).catch(error => {
              console.error('Veri yÃ¼kleme hatasÄ±:', error);
              showToast('Veri yÃ¼klenirken hata oluÅŸtu.', '', 'error');
            });
        }

        window.openVeriDuzenlemeModal = openVeriDuzenlemeModal;

        // Veri dÃ¼zenleme modalÄ±nÄ± kapat
        function closeVeriDuzenlemeModal() {
          qs('#modalVeriDuzenleme').classList.remove('show');
          document.body.classList.remove('modal-open');
          qs('#formVeriDuzenleme').reset();
          qs('#duzenleId').value = '';
          qs('#btnDeleteVeri').style.display = 'none';
        }

        window.closeVeriDuzenlemeModal = closeVeriDuzenlemeModal;

        // Checkbox seÃ§im yÃ¶netimi
        function toggleSelectAllVeriler(checkbox) {
          const checkboxes = document.querySelectorAll('.veri-checkbox');
          checkboxes.forEach(cb => cb.checked = checkbox.checked);
          updateSelectedCount();
        }

        function updateSelectedCount() {
          const selected = document.querySelectorAll('.veri-checkbox:checked');
          const count = selected.length;
          const countSpan = qs('#selectedCount');
          const btnToplu = qs('#btnTopluPersonel');
          
          if (countSpan) {
            if (count > 0) {
              countSpan.textContent = `${count} seÃ§ili`;
              countSpan.style.display = 'inline';
            } else {
              countSpan.style.display = 'none';
            }
          }
          
          if (btnToplu) {
            btnToplu.style.display = count > 0 ? 'inline-block' : 'none';
          }
        }

        window.toggleSelectAllVeriler = toggleSelectAllVeriler;
        window.updateSelectedCount = updateSelectedCount;

        // Toplu personel dÃ¼zenleme modalÄ±nÄ± aÃ§
        async function openTopluPersonelModal() {
          const selected = document.querySelectorAll('.veri-checkbox:checked');
          if (selected.length === 0) {
            showToast('LÃ¼tfen en az bir kayÄ±t seÃ§in.', '', 'error');
            return;
          }

          // Personel dropdown'unu doldur
          await fillPersonelDropdown('#topluPersonelYeni');
          
          // Manuel giriÅŸ toggle
          const personelSelect = qs('#topluPersonelYeni');
          const manuelWrapper = qs('#topluPersonelManuelWrapper');
          if (personelSelect && manuelWrapper) {
            personelSelect.onchange = function() {
              manuelWrapper.style.display = this.value === '__MANUEL__' ? 'block' : 'none';
              if (this.value !== '__MANUEL__') {
                qs('#topluPersonelManuel').value = '';
              }
            };
          }

          // SeÃ§ilen kayÄ±tlarÄ±n personel bilgilerini al
          const selectedIds = Array.from(selected).map(cb => cb.getAttribute('data-id'));
          const personelSet = new Set();
          
          try {
            const supabase = getSupabase();
            if (!supabase) return;
            
            const { data: veriler, error } = await supabase
              .from('ramazan_veriler')
              .select('personel, referans')
              .in('id', selectedIds);

            if (!error && veriler) {
              veriler.forEach(v => {
                const personelText = v.personel || v.referans || '';
                if (personelText) personelSet.add(personelText);
              });
            }
          } catch (e) {
            console.error('Personel bilgileri alÄ±namadÄ±:', e);
          }

          const personelList = Array.from(personelSet);
          qs('#topluPersonelKayitSayisi').textContent = selectedIds.length;
          qs('#topluPersonelEski').value = personelList.length === 1 
            ? personelList[0] 
            : personelList.length > 1 
              ? `${personelList.length} farklÄ± personel: ${personelList.slice(0, 3).join(', ')}${personelList.length > 3 ? '...' : ''}`
              : 'Personel bilgisi yok';

          qs('#topluPersonelYeni').value = '';
          qs('#topluPersonelManuel').value = '';
          qs('#topluPersonelManuelWrapper').style.display = 'none';

          qs('#modalTopluPersonel').classList.add('show');
          document.body.classList.add('modal-open');
        }

        function closeTopluPersonelModal() {
          qs('#modalTopluPersonel').classList.remove('show');
          document.body.classList.remove('modal-open');
          qs('#formTopluPersonel').reset();
        }

        window.openTopluPersonelModal = openTopluPersonelModal;
        window.closeTopluPersonelModal = closeTopluPersonelModal;

        // Toplu personel deÄŸiÅŸtirme form submit
        const formTopluPersonel = qs('#formTopluPersonel');
        if (formTopluPersonel) {
          formTopluPersonel.addEventListener('submit', async (e) => {
            e.preventDefault();

            const selected = document.querySelectorAll('.veri-checkbox:checked');
            if (selected.length === 0) {
              showToast('LÃ¼tfen en az bir kayÄ±t seÃ§in.', '', 'error');
              return;
            }

            const selectedIds = Array.from(selected).map(cb => cb.getAttribute('data-id'));
            const personelSelect = qs('#topluPersonelYeni').value;
            const personelManuel = qs('#topluPersonelManuel').value.trim();

            if (!personelSelect) {
              showToast('LÃ¼tfen yeni personel seÃ§in.', '', 'error');
              return;
            }

            if (personelSelect === '__MANUEL__' && !personelManuel) {
              showToast('LÃ¼tfen manuel personel adÄ±nÄ± girin.', '', 'error');
              return;
            }

            // YÃ¶netici bilgisi
            const supabase = getSupabase();
            if (!supabase) return;

            const { data: { user } } = await supabase.auth.getUser();
            if (!user) {
              showToast('Oturum aÃ§Ä±k deÄŸil.', '', 'error');
              return;
            }

            // Personel bilgisini belirle
            let personelAd = '';
            let personelUid = null;
            let referans = '';

            if (personelSelect && personelSelect !== '__MANUEL__') {
              const selectedPersonel = kullanicilarList.find(k => k.id === personelSelect);
              if (selectedPersonel) {
                personelAd = selectedPersonel.adsoyad || selectedPersonel.email || selectedPersonel.id;
                personelUid = selectedPersonel.id;
              }
            } else if (personelSelect === '__MANUEL__' && personelManuel) {
              personelAd = normalizePersonelName(personelManuel);
              personelUid = null;
              referans = personelManuel;
            }

            // GÃ¼ncelleme yap
            try {
              // ramazan_veriler tablosunda personeluid kolonu yok, sadece personel ve referans var
              const updateData = {
                personel: personelAd,
                referans: referans,
                updatedat: new Date().toISOString()
              };

              // SeÃ§ilen tÃ¼m kayÄ±tlarÄ± gÃ¼ncelle
              const { error } = await supabase
                .from('ramazan_veriler')
                .update(updateData)
                .in('id', selectedIds);

              if (error) throw error;

              showToast('BaÅŸarÄ±lÄ±!', `${selectedIds.length} kaydÄ±n personel bilgisi gÃ¼ncellendi.`, 'success', 3000);

              // Checkbox'larÄ± temizle ve listeyi yenile
              selected.forEach(cb => cb.checked = false);
              updateSelectedCount();

              // Analiz verilerini yenile
              if (typeof loadAnalizVerileri === 'function') {
                await loadAnalizVerileri();
              }
              if (typeof loadAnalizDashboard === 'function') loadAnalizDashboard();
              if (typeof loadPersonelAnalizi === 'function') loadPersonelAnalizi();
              loadVeriDuzenleme();

              closeTopluPersonelModal();
            } catch (error) {
              console.error('Toplu personel gÃ¼ncelleme hatasÄ±:', error);
              showToast('Hata', `Personel bilgisi gÃ¼ncellenirken hata oluÅŸtu: ${error.message}`, 'error');
            }
          });
        }

        // Veri kaydet (gÃ¼ncelle veya ekle)
        const formVeriDuzenleme = qs('#formVeriDuzenleme');
        if (formVeriDuzenleme) {
          formVeriDuzenleme.addEventListener('submit', async (e) => {
            e.preventDefault();

            const docId = qs('#duzenleId').value;
            const yil = parseInt(qs('#duzenleYilInput').value);
            const tip = qs('#duzenleTipInput').value;
            const sahip = qs('#duzenleSahip').value.trim();
            const diger = qs('#duzenleDiger').value.trim();
            const tutar = parseTutar(qs('#duzenleTutar').value || '0');
            const personelSelect = qs('#duzenlePersonel').value;
            const referansManuel = qs('#duzenleReferans').value.trim();

            // Validasyon
            if (!sahip || !tip || !tutar || tutar <= 0) {
              showToast('LÃ¼tfen tÃ¼m zorunlu alanlarÄ± doldurun.', '', 'error');
              return;
            }

            // YÃ¶netici bilgisi - Supabase
            const supabase = getSupabase();
            if (!supabase) return;

            const { data: { user } } = await supabase.auth.getUser();
            if (!user) {
              showToast('Oturum aÃ§Ä±k deÄŸil.', '', 'error');
              return;
            }

            let yoneticiAd = 'Bilinmeyen';
            try {
              const { data: userData } = await supabase
                .from('kullanicilar')
                .select('adsoyad, email')
                .eq('id', user.id)
                .single();

              if (userData) {
                yoneticiAd = userData.adsoyad || userData.email || 'Bilinmeyen';
              } else if (user.email) {
                yoneticiAd = user.email;
              }
            } catch (e) {
              console.warn('YÃ¶netici bilgisi alÄ±namadÄ±:', e);
            }
            const yoneticiUid = user.id;

            // Personel bilgisini belirle
            let personelAd = '';
            let personelUid = null;
            let referans = '';

            if (personelSelect && personelSelect !== '__MANUEL__') {
              // Personel dropdown'undan seÃ§ildi
              const selectedPersonel = kullanicilarList.find(k => k.id === personelSelect);
              if (selectedPersonel) {
                personelAd = selectedPersonel.adsoyad || selectedPersonel.email || selectedPersonel.id;
                personelUid = selectedPersonel.id;
              }
            } else if (personelSelect === '__MANUEL__' && referansManuel) {
              // Manuel giriÅŸ
              personelAd = normalizePersonelName(referansManuel);
              personelUid = null;
              referans = referansManuel;
            } else {
              // VarsayÄ±lan: YÃ¶netici
              personelAd = normalizePersonelName(yoneticiAd);
              personelUid = yoneticiUid;
            }

            // ramazan_veriler tablosunda personeluid ve yukleyenuid kolonlarÄ± yok
            const data = {
              yil: yil,
              tip: tip,
              sahip: sahip,
              diger: diger || '',
              tutar: tutar,
              referans: referans,
              personel: personelAd,
              yukleyen: normalizePersonelName(yoneticiAd),
              updatedat: new Date().toISOString()
            };

            if (docId) {
              // GÃ¼ncelle
              const { error } = await supabase
                .from('ramazan_veriler')
                .update(data)
                .eq('id', docId);

              if (error) throw error;
              showToast('Veri gÃ¼ncellendi.', '', 'success');
            } else {
              // Yeni kayÄ±t
              // UUID oluÅŸtur
              let newId;
              if (typeof crypto !== 'undefined' && crypto.randomUUID) {
                newId = crypto.randomUUID();
              } else {
                newId = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                  const r = Math.random() * 16 | 0;
                  const v = c === 'x' ? r : (r & 0x3 | 0x8);
                  return v.toString(16);
                });
              }
              data.id = newId;
              data.createdAt = new Date().toISOString();

              const { error } = await supabase
                .from('ramazan_veriler')
                .insert(data);

              if (error) throw error;
              showToast('Veri eklendi.', '', 'success');
            }

            // Analiz verilerini yenile ve listeyi gÃ¼ncelle (sayfa yenilenmeden)
            try {
              if (typeof loadAnalizVerileri === 'function') {
                await loadAnalizVerileri();
              }
              // Dashboard ve analizleri yenile
              if (typeof loadAnalizDashboard === 'function') loadAnalizDashboard();
              if (typeof loadTrendAnaliz === 'function') loadTrendAnaliz();
              if (typeof loadKategoriAnaliz === 'function') loadKategoriAnaliz();
              if (typeof loadKisiAnalizi === 'function') loadKisiAnalizi();
              if (typeof loadPersonelAnalizi === 'function') loadPersonelAnalizi();
              // Veri dÃ¼zenleme listesini yenile
              loadVeriDuzenleme();
              closeVeriDuzenlemeModal();
            } catch (error) {
              console.error('Veri yenileme hatasÄ±:', error);
              showToast('Veri gÃ¼ncellendi ancak listeler yenilenirken hata oluÅŸtu.', '', 'warning');
              closeVeriDuzenlemeModal();
              loadVeriDuzenleme();
            }
          });
        }

        // Veri sil
        async function deleteVeriKayit() {
          const docId = qs('#duzenleId').value || qs('#btnDeleteVeri')?.getAttribute('data-doc-id');

          if (!docId) {
            showToast('Silinecek kayÄ±t bulunamadÄ±.', '', 'error');
            return;
          }

          if (!confirm('Bu kaydÄ± silmek istediÄŸinizden emin misiniz?')) {
            return;
          }

          try {
            const supabase = getSupabase();
            if (!supabase) return;

            const { error } = await supabase
              .from('ramazan_veriler')
              .delete()
              .eq('id', docId);

            if (error) throw error;

            showToast('Veri silindi.', '', 'success');

            // Analiz verilerini yenile ve listeyi gÃ¼ncelle (sayfa yenilenmeden)
            if (typeof loadAnalizVerileri === 'function') {
              await loadAnalizVerileri();
            }
            // Dashboard ve analizleri yenile
            if (typeof loadAnalizDashboard === 'function') loadAnalizDashboard();
            if (typeof loadTrendAnaliz === 'function') loadTrendAnaliz();
            if (typeof loadKategoriAnaliz === 'function') loadKategoriAnaliz();
            if (typeof loadKisiAnalizi === 'function') loadKisiAnalizi();
            if (typeof loadPersonelAnalizi === 'function') loadPersonelAnalizi();
            // Veri dÃ¼zenleme listesini yenile
            loadVeriDuzenleme();
            closeVeriDuzenlemeModal();
          } catch (error) {
            console.error('Silme hatasÄ±:', error);
            showToast('Veri silinirken hata oluÅŸtu.', '', 'error');
          }
        }

        window.deleteVeriKayit = deleteVeriKayit;

        // Event listeners - Veri dÃ¼zenleme
        setTimeout(() => {
          const duzenleYil = qs('#duzenleYil');
          const duzenleTip = qs('#duzenleTip');
          const duzenleAra = qs('#duzenleAra');

          if (duzenleYil) {
            duzenleYil.addEventListener('change', () => {
              if (typeof loadVeriDuzenleme === 'function') loadVeriDuzenleme();
            });
          }
          if (duzenleTip) {
            duzenleTip.addEventListener('change', () => {
              if (typeof loadVeriDuzenleme === 'function') loadVeriDuzenleme();
            });
          }
          if (duzenleAra) {
            let searchTimeout;
            duzenleAra.addEventListener('input', () => {
              clearTimeout(searchTimeout);
              searchTimeout = setTimeout(() => {
                if (typeof loadVeriDuzenleme === 'function') loadVeriDuzenleme();
              }, 500);
            });
          }
        }, 500);

        // Tab deÄŸiÅŸtiÄŸinde analiz verilerini yÃ¼kle
        if (qs('#analizYil')) {
          qs('#analizYil').addEventListener('change', () => {
            loadAnalizDashboard();
          });
        }

        // Event listeners - Personel analizi
        setTimeout(() => {
          const personelAra = qs('#personelAra');
          const personelFiltreYil = qs('#personelFiltreYil');
          const personelFiltreTip = qs('#personelFiltreTip');
          if (personelAra) {
            personelAra.addEventListener('input', () => {
              if (typeof loadPersonelAnalizi === 'function') loadPersonelAnalizi();
            });
          }
          if (personelFiltreYil) {
            personelFiltreYil.addEventListener('change', () => {
              if (typeof loadPersonelAnalizi === 'function') loadPersonelAnalizi();
            });
          }
          if (personelFiltreTip) {
            personelFiltreTip.addEventListener('change', () => {
              if (typeof loadPersonelAnalizi === 'function') loadPersonelAnalizi();
            });
          }

          // KiÅŸi analizi event listeners
          const kisiAra = qs('#kisiAra');
          const kisiFiltreTip = qs('#kisiFiltreTip');
          if (kisiAra) {
            kisiAra.addEventListener('input', () => {
              if (typeof loadKisiAnalizi === 'function') loadKisiAnalizi();
            });
          }
          if (kisiFiltreTip) {
            kisiFiltreTip.addEventListener('change', () => {
              if (typeof loadKisiAnalizi === 'function') loadKisiAnalizi();
            });
          }
        }, 500);

        // Ä°lk yÃ¼kleme - analiz verilerini yÃ¼kle
        setTimeout(async () => {
          await loadAnalizVerileri();
          loadAnalizDashboard();
          loadTrendAnaliz();
          loadKategoriAnaliz();
          if (typeof loadPersonelAnalizi === 'function') loadPersonelAnalizi();
        }, 500);

        // ===== HEDEF TANIMLAMA SÄ°STEMÄ° =====

        // Hedef verilerini yÃ¼kle ve gÃ¶ster
        async function loadHedefTanÄ±mlama() {
          // Ã–nce analiz verilerinin yÃ¼klendiÄŸinden emin ol
          if (!analizVerileri || Object.keys(analizVerileri).length === 0) {
            await loadAnalizVerileri();
          }

          // 2025 gerÃ§ekleÅŸen toplamlarÄ± hesapla
          const yil2025 = analizVerileri[2025] || {};
          const tipler = ['iftar', 'sahur', 'taahhut', 'teberru'];
          const tipLabels = { iftar: 'ğŸŒ™ Ä°ftar', sahur: 'ğŸŒŸ Sahur', taahhut: 'ğŸ“‹ TaahhÃ¼t', teberru: 'ğŸ’ Teberru' };

          let toplam2025 = 0;
          let tipBazlÄ±2025 = {};

          tipler.forEach(tip => {
            if (!yil2025[tip]) yil2025[tip] = {};
            const kisiler = Object.keys(yil2025[tip]);
            let tipToplam = 0;

            kisiler.forEach(kisi => {
              const veriler = yil2025[tip][kisi];
              if (!veriler || !Array.isArray(veriler)) return;
              veriler.forEach(v => {
                tipToplam += Number(v.tutar) || 0;
              });
            });

            tipBazlÄ±2025[tip] = tipToplam;
            toplam2025 += tipToplam;
          });

          // 2025 gerÃ§ekleÅŸen toplamÄ± gÃ¶ster
          qs('#hedef2025Toplam').textContent = `â‚º${toplam2025.toLocaleString('tr-TR', { minimumFractionDigits: 2 })}`;

          // 2025 detayÄ±nÄ± gÃ¶ster
          const detayHtml = tipler.map(tip => {
            const tutar = tipBazlÄ±2025[tip] || 0;
            return `${tipLabels[tip]}: â‚º${tutar.toLocaleString('tr-TR', { minimumFractionDigits: 2 })}`;
          }).join(' | ');
          qs('#hedef2025Detay').textContent = detayHtml;

          // Supabase'den mevcut hedefleri yÃ¼kle
          try {
            const supabase = getSupabase();
            if (!supabase) {
              console.error('Supabase client hazÄ±r deÄŸil');
              return;
            }

            // NOT: Åemada genelHedef kolonu yok, sadece personel bazlÄ± hedefler var
            // Genel hedef iÃ§in personel hedeflerinin toplamÄ± kullanÄ±labilir veya ayrÄ± bir yapÄ± gerekebilir
            // Åimdilik personel hedeflerini yÃ¼klÃ¼yoruz
            const { data: hedeflerData, error } = await supabase
              .from('ramazan_hedefler')
              .select('*')
              .eq('yil', 2026);

            if (!error && hedeflerData && hedeflerData.length > 0) {
              // Personel hedeflerinin toplamÄ±nÄ± genel hedef olarak kullan
              const toplamHedef = hedeflerData.reduce((sum, h) => sum + (Number(h.hedef) || 0), 0);
              if (toplamHedef > 0) {
                qs('#hedef2026Genel').value = toplamHedef.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).replace(/\./g, '|TEMP|').replace(/,/g, '.').replace(/\|TEMP\|/g, ',');
                // ArtÄ±ÅŸ yÃ¼zdesini hesapla
                if (toplam2025 > 0) {
                  const artisYuzde = ((toplamHedef - toplam2025) / toplam2025) * 100;
                  qs('#hedef2026ArtisYuzde').value = `%${artisYuzde.toFixed(2)}`;
                }
              }
            }
          } catch (e) {
            console.error('Hedef verileri yÃ¼klenemedi:', e);
          }

          // Genel hedef input'u deÄŸiÅŸtiÄŸinde otomatik artÄ±ÅŸ hesapla ve formatla
          const hedef2026GenelInput = qs('#hedef2026Genel');
          if (hedef2026GenelInput) {
            // Ã–nceki listener'larÄ± kaldÄ±r
            const newInput = hedef2026GenelInput.cloneNode(true);
            hedef2026GenelInput.parentNode.replaceChild(newInput, hedef2026GenelInput);

            // Format desteÄŸi: Input'ta sadece temizle, formatlamayÄ± blur'da yap
            newInput.addEventListener('input', (e) => {
              let value = e.target.value;
              // Sadece rakam, nokta ve virgÃ¼l bÄ±rak
              value = value.replace(/[^\d.,]/g, '');
              e.target.value = value;

              // ArtÄ±ÅŸ hesapla (parse ederek)
              hesaplaGenelArtis();
            });

            // Blur'da format kontrolÃ¼ (gÃ¶rsel olarak)
            newInput.addEventListener('blur', (e) => {
              const parsed = parseTutar(e.target.value || '0');
              if (parsed > 0) {
                // TÃ¼rkÃ§e format: binlik ayÄ±rÄ±cÄ± nokta, kÃ¼sÃ¼rat virgÃ¼l
                const formatted = parsed.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                e.target.value = formatted;
              } else if (e.target.value && e.target.value.trim() !== '' && e.target.value !== '0') {
                // GeÃ§ersiz format, temizle
                e.target.value = '';
                showToast('UyarÄ±', 'GeÃ§ersiz tutar formatÄ±! LÃ¼tfen 100.000,50 formatÄ±nda girin.', 'warning', 3000);
              }
            });
          }

          // Tip bazlÄ± hedefleri gÃ¶ster
          renderTipBazlÄ±Hedefler(tipBazlÄ±2025, toplam2025);

          // Personel bazlÄ± hedefleri gÃ¶ster
          await renderPersonelBazlÄ±Hedefler();
        }

        // Genel hedef deÄŸiÅŸtiÄŸinde artÄ±ÅŸ yÃ¼zdesini hesapla ve personel hedeflerini gÃ¼ncelle
        function hesaplaGenelArtis() {
          const hedef2026GenelInput = qs('#hedef2026Genel');
          if (!hedef2026GenelInput) return;

          const hedef2025ToplamText = qs('#hedef2025Toplam').textContent;
          const toplam2025 = parseTutar(hedef2025ToplamText.replace(/â‚º/g, '').trim());
          const hedef2026Genel = parseTutar(hedef2026GenelInput.value || '0');

          if (toplam2025 > 0 && hedef2026Genel > 0) {
            const artisYuzde = ((hedef2026Genel - toplam2025) / toplam2025) * 100;
            qs('#hedef2026ArtisYuzde').value = `%${artisYuzde.toFixed(2)}`;

            // Tip bazlÄ± hedefleri gÃ¼ncelle
            const tipBazlÄ±2025 = {};
            const tipler = ['iftar', 'sahur', 'taahhut', 'teberru'];
            const yil2025 = analizVerileri[2025] || {};

            tipler.forEach(tip => {
              if (!yil2025[tip]) yil2025[tip] = {};
              const kisiler = Object.keys(yil2025[tip]);
              let tipToplam = 0;

              kisiler.forEach(kisi => {
                const veriler = yil2025[tip][kisi];
                if (!veriler || !Array.isArray(veriler)) return;
                veriler.forEach(v => {
                  tipToplam += Number(v.tutar) || 0;
                });
              });

              tipBazlÄ±2025[tip] = tipToplam;
            });

            renderTipBazlÄ±Hedefler(tipBazlÄ±2025, toplam2025);

            // Personel bazlÄ± hedefleri otomatik gÃ¼ncelle
            guncellePersonelHedefleri(hedef2026Genel, toplam2025);
          } else {
            qs('#hedef2026ArtisYuzde').value = '%0,00';
          }

          // Toplam satÄ±rÄ±nÄ± gÃ¼ncelle
          setTimeout(() => guncelleHedefToplamlari(), 100);
        }

        // Personel bazlÄ± hedefleri genel hedefe gÃ¶re otomatik gÃ¼ncelle
        function guncellePersonelHedefleri(hedef2026Genel, toplam2025) {
          if (!hedef2026Genel || !toplam2025 || toplam2025 <= 0) return;

          const tbody = qs('#hedefPersonelBody');
          if (!tbody) return;

          const rows = tbody.querySelectorAll('tr');
          const tipler = ['iftar', 'sahur', 'taahhut', 'teberru'];

          // Genel artÄ±ÅŸ oranÄ±nÄ± hesapla
          const genelArtisOrani = hedef2026Genel / toplam2025;

          rows.forEach(row => {
            const personelAdi = row.querySelector('.hedef-personel-toplam')?.getAttribute('data-personel');
            if (!personelAdi) return;

            // 2025 verilerini al (analiz verilerinden)
            const yil2025 = analizVerileri[2025] || {};
            let yil2025Toplam = 0;
            const tip2025 = {};

            tipler.forEach(tip => {
              if (!yil2025[tip]) yil2025[tip] = {};
              let tipToplam = 0;

              Object.keys(yil2025[tip]).forEach(sahip => {
                const veriler = yil2025[tip][sahip];
                if (!veriler || !Array.isArray(veriler)) return; // GÃ¼venlik kontrolÃ¼
                veriler.forEach(v => {
                  let rawPersonelAdi = v.personel || v.referans || 'Bilinmeyen';
                  if (v.referans && normalizeTurkish(v.referans) === 'diÄŸer') {
                    rawPersonelAdi = 'DÄ°ÄER';
                  }
                  const vPersonelAdi = normalizePersonelName(rawPersonelAdi);

                  if (vPersonelAdi === personelAdi) {
                    const tutar = Number(v.tutar) || 0;
                    tipToplam += tutar;
                    yil2025Toplam += tutar;
                  }
                });
              });

              tip2025[tip] = tipToplam;
            });

            if (yil2025Toplam <= 0) return; // 2025'te veri yoksa gÃ¼ncelleme

            // Yeni toplam hedefi hesapla
            const yeniToplamHedef = yil2025Toplam * genelArtisOrani;

            // Toplam input'unu gÃ¼ncelle
            const toplamInput = row.querySelector('.hedef-personel-toplam');
            if (toplamInput) {
              toplamInput.value = yeniToplamHedef.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            }

            // Tip bazlÄ± hedefleri gÃ¼ncelle
            tipler.forEach(tip => {
              const tip2025Tutar = tip2025[tip] || 0;
              const yeniTipHedef = tip2025Tutar * genelArtisOrani;

              // Tip input'unu gÃ¼ncelle
              const tipInput = row.querySelector(`.hedef-personel-tip[data-tip="${tip}"]`);
              if (tipInput) {
                tipInput.value = yeniTipHedef.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
              }
            });

            // ArtÄ±ÅŸ yÃ¼zdesini gÃ¼ncelle
            const artisYuzde = yil2025Toplam > 0 ? ((yeniToplamHedef - yil2025Toplam) / yil2025Toplam) * 100 : 0;
            const artisCell = row.cells[9];
            if (artisCell) {
              artisCell.innerHTML = `<span class="${artisYuzde >= 0 ? 'trend-up' : 'trend-down'}">%${artisYuzde.toFixed(2)}</span>`;
            }
          });

          // Toplam satÄ±rÄ±nÄ± gÃ¼ncelle
          setTimeout(() => guncelleHedefToplamlari(), 100);
        }

        // Tip bazlÄ± hedefleri render et
        function renderTipBazlÄ±Hedefler(tipBazlÄ±2025, toplam2025) {
          const tbody = qs('#hedefTipBazlÄ±Body');
          if (!tbody) return;

          const tipler = ['iftar', 'sahur', 'taahhut', 'teberru'];
          const tipLabels = { iftar: 'ğŸŒ™ Ä°ftar', sahur: 'ğŸŒŸ Sahur', taahhut: 'ğŸ“‹ TaahhÃ¼t', teberru: 'ğŸ’ Teberru' };
          const hedef2026GenelInput = qs('#hedef2026Genel');
          const hedef2026Genel = parseTutar(hedef2026GenelInput ? hedef2026GenelInput.value || '0' : '0');

          tbody.innerHTML = '';

          tipler.forEach(tip => {
            const gerceklesen2025 = tipBazlÄ±2025[tip] || 0;
            let hedef2026 = 0;
            let artisYuzde = 0;
            let artisTutar = 0;

            if (toplam2025 > 0 && hedef2026Genel > 0) {
              // AynÄ± oranda artÄ±ÅŸ
              const oran = gerceklesen2025 / toplam2025;
              hedef2026 = hedef2026Genel * oran;
              artisTutar = hedef2026 - gerceklesen2025;
              artisYuzde = gerceklesen2025 > 0 ? ((hedef2026 - gerceklesen2025) / gerceklesen2025) * 100 : 0;
            }

            const tr = document.createElement('tr');
            tr.innerHTML = `
          <td><strong>${tipLabels[tip]}</strong></td>
          <td>â‚º${gerceklesen2025.toLocaleString('tr-TR', { minimumFractionDigits: 2 })}</td>
          <td><strong style="color:var(--accent)">â‚º${hedef2026.toLocaleString('tr-TR', { minimumFractionDigits: 2 })}</strong></td>
          <td><span class="${artisYuzde >= 0 ? 'trend-up' : 'trend-down'}">%${artisYuzde.toFixed(2)}</span></td>
          <td><span class="${artisTutar >= 0 ? 'trend-up' : 'trend-down'}">â‚º${artisTutar.toLocaleString('tr-TR', { minimumFractionDigits: 2 })}</span></td>
        `;
            tbody.appendChild(tr);
          });
        }

        // Personel bazlÄ± hedefleri render et
        async function renderPersonelBazlÄ±Hedefler() {
          const tbody = qs('#hedefPersonelBody');
          if (!tbody) return;

          tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;padding:20px">YÃ¼kleniyor...</td></tr>';

          // Sabit personel listesi (2026 iÃ§in)
          const sabitPersonelListesi = [
            'MUHSÄ°N Ã‡ELÄ°K',
            'SERHAN DURAK',
            'FARUK NAFÄ°Z Ã–ZGAN',
            'KEREM KOCAOÄLU',
            'MAHMUT SOLMAZ',
            'SAMET Ã‡AKIR',
            'MEHMET TAHA KESKÄ°N',
            'Ä°BRAHÄ°M AY',
            'AHMETALÄ° EMRE ÅAHÄ°N'
          ];

          // TÃ¼m personelleri topla (DÄ°ÄER dahil - toplam hesaplamalarÄ± iÃ§in)
          const personeller = {};
          const yillar = [2023, 2024, 2025];
          const tipler = ['iftar', 'sahur', 'taahhut', 'teberru'];

          yillar.forEach(yil => {
            if (!analizVerileri[yil]) return;

            tipler.forEach(tip => {
              if (!analizVerileri[yil][tip]) return;

              Object.keys(analizVerileri[yil][tip]).forEach(sahip => {
                const veriler = analizVerileri[yil][tip][sahip];
                if (!veriler || !Array.isArray(veriler)) return; // GÃ¼venlik kontrolÃ¼
                veriler.forEach(v => {
                  let rawPersonelAdi = v.personel || v.referans || 'Bilinmeyen';
                  if (v.referans && normalizeTurkish(v.referans) === 'diÄŸer') {
                    rawPersonelAdi = 'DÄ°ÄER';
                  }
                  const personelAdi = normalizePersonelName(rawPersonelAdi);

                  if (!personeller[personelAdi]) {
                    personeller[personelAdi] = {
                      veriler: {},
                      toplamTutar: 0
                    };
                  }

                  if (!personeller[personelAdi].veriler[yil]) {
                    personeller[personelAdi].veriler[yil] = {};
                  }

                  if (!personeller[personelAdi].veriler[yil][tip]) {
                    personeller[personelAdi].veriler[yil][tip] = [];
                  }

                  const tutar = Number(v.tutar) || 0;
                  personeller[personelAdi].veriler[yil][tip].push({
                    sahip: sahip,
                    tutar: tutar
                  });

                  personeller[personelAdi].toplamTutar += tutar;
                });
              });
            });
          });

          // Supabase'den mevcut hedefleri yÃ¼kle
          let mevcutHedefler = {};
          try {
            const supabase = getSupabase();
            if (!supabase) {
              console.error('Supabase client hazÄ±r deÄŸil');
              return;
            }

            // Personel bazlÄ± hedefleri yÃ¼kle
            const { data: hedeflerData, error } = await supabase
              .from('ramazan_hedefler')
              .select('*')
              .eq('yil', 2026);

            if (!error && hedeflerData) {
              // Personel bazlÄ± hedefleri map'e Ã§evir
              mevcutHedefler = {};
              hedeflerData.forEach(h => {
                if (h.personeladi) {
                  mevcutHedefler[h.personeladi] = {
                    toplam: Number(h.hedef) || 0
                  };
                }
              });
            }
          } catch (e) {
            console.error('Hedef verileri yÃ¼klenemedi:', e);
          }

          // Genel hedef ve toplam 2025'i al
          const hedef2026GenelInput = qs('#hedef2026Genel');
          const hedef2026Genel = parseTutar(hedef2026GenelInput ? hedef2026GenelInput.value || '0' : '0');
          const hedef2025ToplamText = qs('#hedef2025Toplam').textContent;
          const toplam2025 = parseTutar(hedef2025ToplamText.replace(/â‚º/g, '').trim());
          const genelArtisOrani = toplam2025 > 0 && hedef2026Genel > 0 ? hedef2026Genel / toplam2025 : 1.2; // VarsayÄ±lan %20 artÄ±ÅŸ

          tbody.innerHTML = '';

          // Sabit personel listesini kullan (DÄ°ÄER hariÃ§)
          sabitPersonelListesi.forEach(personelAdi => {
            const personel = personeller[personelAdi] || { veriler: {}, toplamTutar: 0 };
            const adi = personel.adi;

            // 2023-2024-2025 verilerini hesapla
            const yil2023 = personel.veriler[2023] ?
              Object.values(personel.veriler[2023]).flat().reduce((sum, v) => sum + (v.tutar || 0), 0) : 0;
            const yil2024 = personel.veriler[2024] ?
              Object.values(personel.veriler[2024]).flat().reduce((sum, v) => sum + (v.tutar || 0), 0) : 0;
            const yil2025 = personel.veriler[2025] ?
              Object.values(personel.veriler[2025]).flat().reduce((sum, v) => sum + (v.tutar || 0), 0) : 0;

            // Tip bazlÄ± 2025 verileri
            const tip2025 = {};
            tipler.forEach(tip => {
              if (personel.veriler[2025] && personel.veriler[2025][tip]) {
                tip2025[tip] = personel.veriler[2025][tip].reduce((sum, v) => sum + (v.tutar || 0), 0);
              } else {
                tip2025[tip] = 0;
              }
            });

            // Mevcut hedef veya otomatik hesaplanan hedef
            const mevcutHedef = mevcutHedefler[personelAdi] || {};
            let hedef2026Toplam = mevcutHedef.toplam || 0;

            // Otomatik hesaplama: Genel hedefe gÃ¶re orantÄ±lÄ± artÄ±ÅŸ
            if (!mevcutHedef.toplam && yil2025 > 0 && toplam2025 > 0) {
              hedef2026Toplam = yil2025 * genelArtisOrani;
            } else if (!mevcutHedef.toplam && yil2025 > 0) {
              // Genel hedef yoksa varsayÄ±lan %20 artÄ±ÅŸ
              hedef2026Toplam = yil2025 * 1.2;
            }

            // Tip bazlÄ± hedefler
            const hedefTip = {};
            tipler.forEach(tip => {
              hedefTip[tip] = mevcutHedef[tip] || 0;
              if (!mevcutHedef[tip] && tip2025[tip] > 0) {
                if (toplam2025 > 0 && hedef2026Genel > 0) {
                  // Genel hedefe gÃ¶re orantÄ±lÄ± artÄ±ÅŸ
                  hedefTip[tip] = tip2025[tip] * genelArtisOrani;
                } else {
                  // Genel hedef yoksa varsayÄ±lan %20 artÄ±ÅŸ
                  hedefTip[tip] = tip2025[tip] * 1.2;
                }
              }
            });

            // ArtÄ±ÅŸ yÃ¼zdesi
            const artisYuzde = yil2025 > 0 ? ((hedef2026Toplam - yil2025) / yil2025) * 100 : 0;

            const tr = document.createElement('tr');
            tr.innerHTML = `
          <td><strong>${personelAdi}</strong></td>
          <td>${yil2023 > 0 ? 'â‚º' + yil2023.toLocaleString('tr-TR', { minimumFractionDigits: 2 }) : '-'}</td>
          <td>${yil2024 > 0 ? 'â‚º' + yil2024.toLocaleString('tr-TR', { minimumFractionDigits: 2 }) : '-'}</td>
          <td>${yil2025 > 0 ? 'â‚º' + yil2025.toLocaleString('tr-TR', { minimumFractionDigits: 2 }) : '-'}</td>
          <td>
            <input type="text" 
              class="hedef-personel-toplam" 
              data-personel="${personelAdi}" 
              data-original="${hedef2026Toplam}"
              value="${hedef2026Toplam.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}" 
              style="width:100%;padding:6px;border:1px solid var(--border);border-radius:6px;text-align:right;font-weight:600" 
            />
            <div class="hedef-personel-uyari" data-personel="${personelAdi}" style="display:none;font-size:10px;color:var(--bad);margin-top:2px"></div>
          </td>
          <td>
            <input type="text" 
              class="hedef-personel-tip" 
              data-personel="${personelAdi}" 
              data-tip="iftar"
              data-original="${hedefTip.iftar}"
              value="${hedefTip.iftar.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}" 
              style="width:100%;padding:6px;border:1px solid var(--border);border-radius:6px;text-align:right" 
            />
          </td>
          <td>
            <input type="text" 
              class="hedef-personel-tip" 
              data-personel="${personelAdi}" 
              data-tip="sahur"
              data-original="${hedefTip.sahur}"
              value="${hedefTip.sahur.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}" 
              style="width:100%;padding:6px;border:1px solid var(--border);border-radius:6px;text-align:right" 
            />
          </td>
          <td>
            <input type="text" 
              class="hedef-personel-tip" 
              data-personel="${personelAdi}" 
              data-tip="taahhut"
              data-original="${hedefTip.taahhut}"
              value="${hedefTip.taahhut.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}" 
              style="width:100%;padding:6px;border:1px solid var(--border);border-radius:6px;text-align:right" 
            />
          </td>
          <td>
            <input type="text" 
              class="hedef-personel-tip" 
              data-personel="${personelAdi}" 
              data-tip="teberru"
              data-original="${hedefTip.teberru}"
              value="${hedefTip.teberru.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}" 
              style="width:100%;padding:6px;border:1px solid var(--border);border-radius:6px;text-align:right" 
            />
          </td>
          <td><span class="${artisYuzde >= 0 ? 'trend-up' : 'trend-down'}">%${artisYuzde.toFixed(2)}</span></td>
        `;
            tbody.appendChild(tr);

            // Personel hedef input'larÄ±na event listener ekle
            const row = tbody.lastElementChild;
            const toplamInput = row.querySelector('.hedef-personel-toplam');
            const tipInputs = row.querySelectorAll('.hedef-personel-tip');

            // Toplam deÄŸiÅŸtiÄŸinde kontrol et ve formatla
            if (toplamInput) {
              // Input event: sadece geÃ§ersiz karakterleri temizle, formatlamayÄ± blur'da yap
              toplamInput.addEventListener('input', (e) => {
                let value = e.target.value;
                // Sadece rakam, nokta ve virgÃ¼l bÄ±rak
                value = value.replace(/[^\d.,]/g, '');
                e.target.value = value;

                // Toplam satÄ±rÄ±nÄ± gÃ¼ncelle (parse ederek)
                setTimeout(() => {
                  kontrolPersonelHedefleri(personelAdi, yil2025);
                  guncelleHedefToplamlari();
                }, 100);
              });

              toplamInput.addEventListener('blur', (e) => {
                const parsed = parseTutar(e.target.value || '0');
                if (parsed > 0) {
                  // TÃ¼rkÃ§e format: binlik ayÄ±rÄ±cÄ± nokta, kÃ¼sÃ¼rat virgÃ¼l
                  const formatted = parsed.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                  e.target.value = formatted;
                } else if (e.target.value && e.target.value.trim() !== '' && e.target.value !== '0') {
                  e.target.value = '';
                }
                kontrolPersonelHedefleri(personelAdi, yil2025);
                setTimeout(() => guncelleHedefToplamlari(), 100);
              });
            }

            // Tip hedefleri deÄŸiÅŸtiÄŸinde kontrol et ve formatla
            tipInputs.forEach(tipInput => {
              // Input event: sadece geÃ§ersiz karakterleri temizle, formatlamayÄ± blur'da yap
              tipInput.addEventListener('input', (e) => {
                let value = e.target.value;
                // Sadece rakam, nokta ve virgÃ¼l bÄ±rak
                value = value.replace(/[^\d.,]/g, '');
                e.target.value = value;

                // Toplam satÄ±rÄ±nÄ± gÃ¼ncelle (parse ederek)
                setTimeout(() => {
                  kontrolPersonelHedefleri(personelAdi, yil2025);
                  guncelleHedefToplamlari();
                }, 100);
              });

              tipInput.addEventListener('blur', (e) => {
                const parsed = parseTutar(e.target.value || '0');
                if (parsed > 0) {
                  // TÃ¼rkÃ§e format: binlik ayÄ±rÄ±cÄ± nokta, kÃ¼sÃ¼rat virgÃ¼l
                  const formatted = parsed.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
                  e.target.value = formatted;
                } else if (e.target.value && e.target.value.trim() !== '' && e.target.value !== '0') {
                  e.target.value = '';
                }
                kontrolPersonelHedefleri(personelAdi, yil2025);
                setTimeout(() => guncelleHedefToplamlari(), 100);
              });
            });
          });

          // Toplam satÄ±rÄ±nÄ± gÃ¶ster ve hesapla
          setTimeout(() => {
            guncelleHedefToplamlari();
          }, 100);
        }

        // Hedef toplamlarÄ±nÄ± gÃ¼ncelle
        function guncelleHedefToplamlari() {
          const tbody = qs('#hedefPersonelBody');
          const tfoot = qs('#hedefPersonelToplam');

          if (!tbody || !tfoot) return;

          const rows = tbody.querySelectorAll('tr');
          if (rows.length === 0) {
            tfoot.style.display = 'none';
            return;
          }

          tfoot.style.display = 'table-footer-group';

          const tipler = ['iftar', 'sahur', 'taahhut', 'teberru'];
          const tipIds = {
            'iftar': 'toplamIftar',
            'sahur': 'toplamSahur',
            'taahhut': 'toplamTaahhut',
            'teberru': 'toplamTeberru'
          };

          let toplam2023 = 0;
          let toplam2024 = 0;
          let toplam2025 = 0;
          let toplam2026Hedef = 0;
          const toplamTip = { iftar: 0, sahur: 0, taahhut: 0, teberru: 0 };

          rows.forEach(row => {
            // 2023, 2024, 2025 toplamlarÄ± (cell'lerden)
            const cell2023 = row.cells[1]?.textContent;
            const cell2024 = row.cells[2]?.textContent;
            const cell2025 = row.cells[3]?.textContent;

            if (cell2023 && cell2023 !== '-') {
              toplam2023 += parseTutar(cell2023.replace(/â‚º/g, '').trim());
            }
            if (cell2024 && cell2024 !== '-') {
              toplam2024 += parseTutar(cell2024.replace(/â‚º/g, '').trim());
            }
            if (cell2025 && cell2025 !== '-') {
              toplam2025 += parseTutar(cell2025.replace(/â‚º/g, '').trim());
            }

            // 2026 hedef toplamÄ±
            const toplamInput = row.querySelector('.hedef-personel-toplam');
            if (toplamInput) {
              toplam2026Hedef += parseTutar(toplamInput.value || '0');
            }

            // Tip bazlÄ± hedefler
            tipler.forEach(tip => {
              const tipInput = row.querySelector(`.hedef-personel-tip[data-tip="${tip}"]`);
              if (tipInput) {
                toplamTip[tip] += parseTutar(tipInput.value || '0');
              }
            });
          });

          // Toplam satÄ±rÄ±nÄ± gÃ¼ncelle
          qs('#toplam2023').textContent = toplam2023 > 0 ? 'â‚º' + toplam2023.toLocaleString('tr-TR', { minimumFractionDigits: 2 }) : '-';
          qs('#toplam2024').textContent = toplam2024 > 0 ? 'â‚º' + toplam2024.toLocaleString('tr-TR', { minimumFractionDigits: 2 }) : '-';
          qs('#toplam2025').textContent = toplam2025 > 0 ? 'â‚º' + toplam2025.toLocaleString('tr-TR', { minimumFractionDigits: 2 }) : '-';
          qs('#toplam2026Hedef').textContent = toplam2026Hedef > 0 ? 'â‚º' + toplam2026Hedef.toLocaleString('tr-TR', { minimumFractionDigits: 2 }) : '-';

          tipler.forEach(tip => {
            const tipId = tipIds[tip];
            qs('#' + tipId).textContent = toplamTip[tip] > 0 ? 'â‚º' + toplamTip[tip].toLocaleString('tr-TR', { minimumFractionDigits: 2 }) : '-';
          });

          // ArtÄ±ÅŸ yÃ¼zdesi toplamÄ± (ortalama)
          const ortalamaArtis = toplam2025 > 0 ? ((toplam2026Hedef - toplam2025) / toplam2025) * 100 : 0;
          qs('#toplamArtis').innerHTML = ortalamaArtis !== 0 ?
            `<span class="${ortalamaArtis >= 0 ? 'trend-up' : 'trend-down'}">%${ortalamaArtis.toFixed(2)}</span>` : '-';

          // Genel hedef
          const hedef2026GenelInput = qs('#hedef2026Genel');
          const hedef2026Genel = parseTutar(hedef2026GenelInput ? hedef2026GenelInput.value || '0' : '0');
          qs('#genelHedefToplam').textContent = hedef2026Genel > 0 ?
            'â‚º' + hedef2026Genel.toLocaleString('tr-TR', { minimumFractionDigits: 2 }) : '-';

          // Fark hesapla
          const fark = toplam2026Hedef - hedef2026Genel;
          const farkCell = qs('#hedefFark');

          if (hedef2026Genel > 0) {
            if (Math.abs(fark) < 0.01) {
              farkCell.innerHTML = '<span style="color:var(--good);font-weight:700">âœ“ EÅŸit</span>';
            } else if (fark > 0) {
              farkCell.innerHTML = `<span style="color:var(--bad);font-weight:700">+â‚º${fark.toLocaleString('tr-TR', { minimumFractionDigits: 2 })} (Fazla)</span>`;
            } else {
              farkCell.innerHTML = `<span style="color:var(--warn);font-weight:700">â‚º${Math.abs(fark).toLocaleString('tr-TR', { minimumFractionDigits: 2 })} (Eksik)</span>`;
            }
          } else {
            farkCell.textContent = '-';
          }
        }

        // Hedefleri kaydet
        async function kaydetHedefler() {
          const hedef2026Genel = parseTutar(qs('#hedef2026Genel').value || '0');

          if (hedef2026Genel <= 0) {
            showToast('Hata', 'LÃ¼tfen 2026 genel hedefini giriniz!', 'error');
            return;
          }

          // Personel bazlÄ± hedefleri topla
          const personelHedefleri = {};
          const toplamInputs = qs('#hedefPersonelBody').querySelectorAll('.hedef-personel-toplam');

          toplamInputs.forEach(input => {
            const personelAdi = input.getAttribute('data-personel');
            const toplam = parseTutar(input.value || '0');

            if (!personelHedefleri[personelAdi]) {
              personelHedefleri[personelAdi] = {};
            }

            personelHedefleri[personelAdi].toplam = toplam;
          });

          const tipInputs = qs('#hedefPersonelBody').querySelectorAll('.hedef-personel-tip');
          tipInputs.forEach(input => {
            const personelAdi = input.getAttribute('data-personel');
            const tip = input.getAttribute('data-tip');
            const tutar = parseTutar(input.value || '0');

            if (!personelHedefleri[personelAdi]) {
              personelHedefleri[personelAdi] = {};
            }

            personelHedefleri[personelAdi][tip] = tutar;
          });

          // Supabase'e kaydet
          try {
            const supabase = getSupabase();
            if (!supabase) {
              throw new Error('Supabase client hazÄ±r deÄŸil');
            }

            const auth = getAuth();
            const user = auth?.currentUser;
            const yil = 2026;

            // Personel bazlÄ± hedefleri kaydet (her personel iÃ§in ayrÄ± kayÄ±t)
            const personelHedefKayitlari = [];
            Object.keys(personelHedefleri).forEach(personelAdi => {
              const hedefler = personelHedefleri[personelAdi];
              const toplamHedef = hedefler.toplam || 0;
              
              if (toplamHedef > 0) {
                // UUID oluÅŸtur
                let hedefId;
                if (typeof crypto !== 'undefined' && crypto.randomUUID) {
                  hedefId = crypto.randomUUID();
                } else {
                  hedefId = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                    const r = Math.random() * 16 | 0;
                    const v = c === 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                  });
                }

                personelHedefKayitlari.push({
                  id: hedefId,
                  personeladi: personelAdi,
                  hedef: toplamHedef,
                  yil: yil,
                  personeluid: null, // Personel UID bulunursa eklenebilir
                  updatedat: new Date().toISOString(),
                  createdat: new Date().toISOString()
                });
              }
            });

            // Ã–nce mevcut 2026 hedeflerini sil (opsiyonel - veya upsert yapÄ±labilir)
            // Åimdilik sadece yeni kayÄ±tlarÄ± ekleyelim, gÃ¼ncelleme iÃ§in ayrÄ± bir mekanizma gerekebilir
            
            // Batch insert
            if (personelHedefKayitlari.length > 0) {
              const { error: insertError } = await supabase
                .from('ramazan_hedefler')
                .upsert(personelHedefKayitlari, { onConflict: 'id' });
              
              if (insertError) {
                console.error('Hedef kayÄ±tlarÄ± eklenirken hata:', insertError);
                throw insertError;
              }
            }

            // NOT: genelHedef iÃ§in ÅŸemada ayrÄ± bir tablo yok, ÅŸimdilik personel hedefleri kaydediliyor
            // Genel hedef iÃ§in ayrÄ± bir tablo veya yapÄ± gerekebilir

            showToast('BaÅŸarÄ±lÄ±! âœ…', 'Hedefler baÅŸarÄ±yla kaydedildi!', 'success');
          } catch (e) {
            console.error('Hedef kaydetme hatasÄ±:', e);
            showToast('Hata âŒ', 'Hedefler kaydedilirken hata oluÅŸtu: ' + e.message, 'error');
          }
        }

        // Personel hedeflerini kontrol et (manuel deÄŸiÅŸiklik sonrasÄ±)
        function kontrolPersonelHedefleri(personelAdi, yil2025) {
          const tbody = qs('#hedefPersonelBody');
          if (!tbody) return;

          // Bu personelin satÄ±rÄ±nÄ± bul
          const row = Array.from(tbody.querySelectorAll('tr')).find(r => {
            const input = r.querySelector('.hedef-personel-toplam');
            return input && input.getAttribute('data-personel') === personelAdi;
          });

          if (!row) return;

          const toplamInput = row.querySelector('.hedef-personel-toplam');
          const tipInputs = row.querySelectorAll('.hedef-personel-tip');
          const uyariDiv = row.querySelector('.hedef-personel-uyari');

          if (!toplamInput || !uyariDiv) return;

          // Toplam hedefi al
          const toplamHedef = parseTutar(toplamInput.value || '0');

          // Tip bazlÄ± hedeflerin toplamÄ±nÄ± hesapla
          let tipToplam = 0;
          tipInputs.forEach(input => {
            const tutar = parseTutar(input.value || '0');
            tipToplam += tutar;
          });

          // Genel hedefi al
          const hedef2026GenelInput = qs('#hedef2026Genel');
          const hedef2026Genel = parseTutar(hedef2026GenelInput ? hedef2026GenelInput.value || '0' : '0');
          const hedef2025ToplamText = qs('#hedef2025Toplam').textContent;
          const toplam2025 = parseTutar(hedef2025ToplamText.replace(/â‚º/g, '').trim());
          const genelArtisOrani = toplam2025 > 0 && hedef2026Genel > 0 ? hedef2026Genel / toplam2025 : 1.2;

          // Otomatik hesaplanan hedef
          const otomatikHedef = yil2025 > 0 ? yil2025 * genelArtisOrani : 0;

          // UyarÄ± mesajlarÄ±
          const uyarilar = [];

          // Toplam ile tip toplamlarÄ± eÅŸleÅŸmeli
          const fark = Math.abs(toplamHedef - tipToplam);
          if (fark > 0.01) { // 0.01 TL tolerans
            if (toplamHedef > tipToplam) {
              uyarilar.push(`âš ï¸ Toplam hedef (â‚º${toplamHedef.toLocaleString('tr-TR', { minimumFractionDigits: 2 })}) tip bazlÄ± hedeflerden â‚º${fark.toLocaleString('tr-TR', { minimumFractionDigits: 2 })} fazla!`);
            } else {
              uyarilar.push(`âš ï¸ Toplam hedef (â‚º${toplamHedef.toLocaleString('tr-TR', { minimumFractionDigits: 2 })}) tip bazlÄ± hedeflerden â‚º${fark.toLocaleString('tr-TR', { minimumFractionDigits: 2 })} az!`);
            }
          }

          // Genel hedefe gÃ¶re sapma kontrolÃ¼
          if (otomatikHedef > 0 && toplamHedef > 0) {
            const sapma = ((toplamHedef - otomatikHedef) / otomatikHedef) * 100;
            const sapmaTutar = toplamHedef - otomatikHedef;

            if (Math.abs(sapma) > 5) { // %5'ten fazla sapma
              if (sapma > 0) {
                uyarilar.push(`ğŸ“Š Genel hedefe gÃ¶re otomatik hesaplanandan â‚º${sapmaTutar.toLocaleString('tr-TR', { minimumFractionDigits: 2 })} (%${sapma.toFixed(1)}) fazla!`);
              } else {
                uyarilar.push(`ğŸ“Š Genel hedefe gÃ¶re otomatik hesaplanandan â‚º${Math.abs(sapmaTutar).toLocaleString('tr-TR', { minimumFractionDigits: 2 })} (%${Math.abs(sapma).toFixed(1)}) az!`);
              }
            }
          }

          // UyarÄ± gÃ¶ster/gizle
          if (uyarilar.length > 0) {
            uyariDiv.style.display = 'block';
            uyariDiv.innerHTML = uyarilar.join('<br>');
            uyariDiv.style.color = 'var(--bad)';
            uyariDiv.style.fontSize = '10px';
            uyariDiv.style.marginTop = '4px';
          } else {
            uyariDiv.style.display = 'none';
          }

          // Genel uyarÄ± mesajÄ±nÄ± gÃ¼ncelle
          guncelleGenelUyariMesaji();

          // Toplam satÄ±rÄ±nÄ± gÃ¼ncelle
          setTimeout(() => guncelleHedefToplamlari(), 100);
        }

        // Genel uyarÄ± mesajÄ±nÄ± gÃ¼ncelle
        function guncelleGenelUyariMesaji() {
          const uyariMesaji = qs('#hedefUyariMesaji');
          if (!uyariMesaji) return;

          const tbody = qs('#hedefPersonelBody');
          if (!tbody) return;

          const rows = tbody.querySelectorAll('tr');
          const uyarilar = [];

          rows.forEach(row => {
            const uyariDiv = row.querySelector('.hedef-personel-uyari');
            if (uyariDiv && uyariDiv.style.display !== 'none' && uyariDiv.textContent.trim()) {
              const personelAdi = row.querySelector('.hedef-personel-toplam')?.getAttribute('data-personel');
              if (personelAdi) {
                uyarilar.push(`<strong>${personelAdi}:</strong> ${uyariDiv.textContent.trim()}`);
              }
            }
          });

          if (uyarilar.length > 0) {
            uyariMesaji.style.display = 'block';
            uyariMesaji.innerHTML = `
          <strong>âš ï¸ UyarÄ±lar:</strong><br>
          ${uyarilar.join('<br>')}
        `;
          } else {
            uyariMesaji.style.display = 'none';
          }
        }

        window.loadHedefTanÄ±mlama = loadHedefTanÄ±mlama;
        window.kaydetHedefler = kaydetHedefler;

        // ===== TALEPLER YÃ–NETÄ°MÄ° =====

        function escapeHtml(str) {
          if (str == null) return '';
          const s = String(str);
          return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }
        function talepOnayRow(label, value) {
          return '<div class="talep-onay-satir"><span class="label">' + escapeHtml(label) + '</span><span class="value">' + escapeHtml(String(value ?? '')) + '</span></div>';
        }

        let talepler = [];
        /** Silinen kayÄ±tlar (ramazan_arsiv tablosundan - talepler tablosunda gÃ¶sterilir) */
        let silinenKayitlar = [];
        /** Talepler sekmesinde seÃ§ilen yÄ±la gÃ¶re yÃ¼klenen kayÄ±tlar (Sahip, Mahal vb. boÅŸ kalmamasÄ± iÃ§in) */
        let kayitlarForTalepler = [];

        // AÃ§Ä±klamadan bilgileri parse et
        function parseAciklama(aciklama) {
          const result = {
            musafirAdedi: null,
            tutar: null,
            sahip: null,
            mahalId: null,
            mahalAdi: null
          };

          if (!aciklama) return result;

          const lower = aciklama.toLowerCase();

          // KiÅŸi artÄ±ÅŸÄ±: "kiÅŸi", "mÃ¼safir", "artÄ±r", "Ã§Ä±kar", "ekle" gibi kelimeler
          const kisiMatch = aciklama.match(/(?:kiÅŸi|mÃ¼safir|misafir).*?(\d+)/i);
          if (kisiMatch) {
            result.musafirAdedi = parseInt(kisiMatch[1]);
          }

          // Tutar: "tutar", "Ã¼cret", "fiyat" gibi kelimeler
          const tutarMatch = aciklama.match(/(?:tutar|Ã¼cret|fiyat).*?(\d+(?:[.,]\d+)?)/i);
          if (tutarMatch) {
            result.tutar = parseFloat(tutarMatch[1].replace(',', '.'));
          }

          // Mahal: "mahal", "yer" gibi kelimeler
          const mahalMatch = aciklama.match(/(?:mahal|yer).*?[:]\s*([^,|]+)/i);
          if (mahalMatch) {
            result.mahalAdi = mahalMatch[1].trim();
          }

          // Sahip deÄŸiÅŸikliÄŸi: "sahip", "isim" gibi kelimeler
          const sahipMatch = aciklama.match(/(?:sahip|isim).*?[:]\s*([^,|]+)/i);
          if (sahipMatch) {
            result.sahip = sahipMatch[1].trim();
          }

          return result;
        }

        /** Talepler sekmesindeki seÃ§ili yÄ±la gÃ¶re kayÄ±tlarÄ± yÃ¼kler; bÃ¶ylece tabloda Sahip/Mahal/Tarih vb. boÅŸ kalmaz. */
        async function loadKayitlarForTaleplerYil(yil) {
          const yilNum = parseInt(yil, 10);
          if (isNaN(yilNum)) {
            kayitlarForTalepler = [];
            return;
          }
          try {
            const supabase = getSupabase();
            if (!supabase) {
              kayitlarForTalepler = [];
              return;
            }
            let mahallerForKayitlar = mahalList && mahalList.length ? mahalList.map(m => ({ id: m.id, adi: m.adi })) : [];
            if (mahallerForKayitlar.length === 0) {
              try {
                const { data: mahalData } = await supabase.from('ramazan_mahaller').select('id, adi').order('adi', { ascending: true });
                mahallerForKayitlar = (mahalData || []).map(m => ({ id: m.id, adi: m.adi }));
              } catch (_) {}
            }
            let iftarSahurKayitlar = [];
            try {
              const { data: ramazanKayitData, error: ramazanError } = await supabase
                .from('ramazan_kayitlari')
                .select('*')
                .eq('yil', yilNum);
              if (!ramazanError && ramazanKayitData) {
                iftarSahurKayitlar = ramazanKayitData.map(d => {
                  const created_at = d.createdAt || d.createdat;
                  let tarih = null;
                  if (d.tarih) tarih = typeof d.tarih === 'string' ? new Date(d.tarih) : new Date(d.tarih);
                  else if (created_at) tarih = typeof created_at === 'string' ? new Date(created_at) : new Date(created_at);
                  else tarih = new Date();
                  const personelVal = d.personel || d.personelAdi || d.personeladi || '';
                  const mahalidVal = d.mahalid || d.mahalId || null;
                  const mahalAdiResolved = d.mahal || (mahalidVal && mahallerForKayitlar.find(m => m.id === mahalidVal)?.adi) || null;
                  return {
                    id: d.id,
                    ...d,
                    tarih, kayitTipi: 'iftar-sahur', personel: personelVal,
                    personelAdi: d.personeladi || d.personelAdi || personelVal,
                    musafirAdedi: d.musafiradedi || d.musafirAdedi || 0,
                    mahal: mahalAdiResolved, mahalid: mahalidVal,
                    createdAt: created_at, updatedAt: d.updatedat || d.updatedAt
                  };
                });
              }
            } catch (e) { console.warn('Talepler: iftar-sahur kayÄ±tlarÄ± yÃ¼klenemedi', e); }
            let teberruKayitlar = [];
            try {
              const { data: teberruData, error: teberruError } = await supabase
                .from('teberru_kayitlari').select('*').eq('yil', yilNum).order('createdat', { ascending: false });
              if (!teberruError && teberruData) {
                teberruKayitlar = teberruData.map(d => {
                  const created_at = d.createdAt || d.createdat;
                  let tarih = null;
                  if (d.tarih) tarih = typeof d.tarih === 'string' ? new Date(d.tarih) : new Date(d.tarih);
                  else if (created_at) tarih = typeof created_at === 'string' ? new Date(created_at) : new Date(created_at);
                  else tarih = new Date();
                  return {
                    id: d.id, ...d, tip: 'teberru', sahip: d.bagisci || '', tutar: d.miktar || 0,
                    tarih, yil: d.yil || (tarih ? tarih.getFullYear() : yilNum),
                    kayitTipi: 'teberru', personel: d.personel || d.kaydedenpersonel || '',
                    createdAt: created_at, updatedAt: d.updatedAt || d.updatedat
                  };
                });
              }
            } catch (e) { console.warn('Talepler: teberru kayÄ±tlarÄ± yÃ¼klenemedi', e); }
            let taahhutKayitlar = [];
            try {
              const { data: taahhutData, error: taahhutError } = await supabase
                .from('taahhut_kayitlari').select('*').eq('yil', yilNum).order('createdat', { ascending: false });
              if (!taahhutError && taahhutData) {
                taahhutKayitlar = taahhutData.map(d => {
                  const created_at = d.createdAt || d.createdat;
                  let tarih = null;
                  if (d.tarih) tarih = typeof d.tarih === 'string' ? new Date(d.tarih) : new Date(d.tarih);
                  else if (created_at) tarih = typeof created_at === 'string' ? new Date(created_at) : new Date(created_at);
                  else tarih = new Date();
                  return {
                    id: d.id, ...d, tip: 'taahhut', sahip: d.bagisci || '', tutar: d.miktar || 0,
                    tarih, yil: d.yil || (tarih ? tarih.getFullYear() : yilNum),
                    kayitTipi: 'taahhut', personel: d.personel || d.kaydedenpersonel || '',
                    createdAt: created_at, updatedAt: d.updatedAt || d.updatedat
                  };
                });
              }
            } catch (e) { console.warn('Talepler: taahhut kayÄ±tlarÄ± yÃ¼klenemedi', e); }
            kayitlarForTalepler = [...iftarSahurKayitlar, ...teberruKayitlar, ...taahhutKayitlar];
            kayitlarForTalepler.sort((a, b) => {
              const getT = (k) => (k.tarih ? (typeof k.tarih === 'string' ? new Date(k.tarih) : k.tarih) : (k.createdAt ? new Date(k.createdAt) : new Date(0)));
              return getT(b).getTime() - getT(a).getTime();
            });
          } catch (e) {
            console.warn('Talepler: kayÄ±tlar yÃ¼klenemedi', e);
            kayitlarForTalepler = [];
          }
        }

        async function loadTalepler() {
          const yil = qs('#taleplerFiltreYil')?.value || qs('#filtreYil')?.value || '2025';
          try {
            const supabase = getSupabase();
            if (!supabase) {
              console.error('Supabase client hazÄ±r deÄŸil');
              talepler = [];
              renderTalepler();
              return;
            }
            await loadKayitlarForTaleplerYil(yil);

            const { data, error } = await supabase
              .from('duzenleme_talepleri')
              .select('*')
              .eq('yil', yil)
              .order('createdat', { ascending: false }); // Åemada createdat (kÃ¼Ã§Ã¼k harf)

            if (error) {
              console.error('Talepler yÃ¼klenemedi:', error);
              talepler = [];
            } else {
              // VeritabanÄ± ÅŸemasÄ±na gÃ¶re lowercase -> camelCase mapping
              talepler = (data || []).map(d => ({
                id: d.id,
                yil: d.yil,
                talepTipi: d.taleptipi,           // taleptipi -> talepTipi
                kayitTipi: d.kayittipi,           // kayittipi -> kayitTipi
                kayitId: d.kayitid,               // kayitid -> kayitId
                personelAdi: d.personeladi,       // personeladi -> personelAdi
                yeniTarih: d.yenitarih,           // yenitarih -> yeniTarih
                mahalId: d.mahalid,               // mahalid -> mahalId
                aciklama: d.aciklama,
                durum: d.durum,
                onaylayanUid: d.onaylayanuid,     // onaylayanuid -> onaylayanUid
                onaylanmaTarihi: d.onaylanmatarihi, // onaylanmatarihi -> onaylanmaTarihi
                redEdenUid: d.rededenuid,         // rededenuid -> redEdenUid
                redTarihi: d.redtarihi,           // redtarihi -> redTarihi
                redAciklama: d.redaciklama,       // redaciklama -> redAciklama
                createdAt: d.createdat,           // createdat -> createdAt
                updatedAt: d.updatedat,           // updatedat -> updatedAt
                ...d  // DiÄŸer alanlar iÃ§in fallback
              }));
            }

            // Silinen kayÄ±tlarÄ± ramazan_arsiv tablosundan yÃ¼kle (talepler tablosunda gÃ¶sterilecek)
            try {
              const { data: arsivData, error: arsivError } = await supabase
                .from('ramazan_arsiv')
                .select('*')
                .eq('yil', parseInt(yil, 10))
                .order('arsiv_tarihi', { ascending: false });
              if (!arsivError && arsivData && arsivData.length > 0) {
                silinenKayitlar = arsivData.map(d => ({
                  id: d.id,
                  isArsiv: true,
                  yil: d.yil,
                  talepTipi: 'sil',
                  kayitTipi: 'iftar-sahur',
                  kayitId: null,
                  personelAdi: d.personeladi || d.personel || d.silenpersoneladi || d.silen_kisi || '-',
                  yeniTarih: null,
                  mahalId: d.mahalid,
                  aciklama: d.notlar || d.silme_sebebi || '-',
                  durum: 'silindi_arsiv',
                  tip: d.tip,
                  sahip: d.sahip,
                  tutar: d.tutar,
                  musafirAdedi: d.musafiradedi ?? d.musafirAdedi ?? 0,
                  istirak: d.istirak,
                  mahal: d.mahal,
                  tarih: d.tarih,
                  createdAt: d.arsiv_tarihi || d.createdat,
                  silenKisi: d.silenpersoneladi || d.silen_kisi || null
                }));
              } else {
                silinenKayitlar = [];
              }
            } catch (arsivE) {
              console.warn('Silinen kayÄ±tlar (ramazan_arsiv) yÃ¼klenemedi:', arsivE);
              silinenKayitlar = [];
            }

            renderTalepler();
          } catch (e) {
            console.error('Talepler yÃ¼klenemedi:', e);
            talepler = [];
            renderTalepler();
          }
        }

        function filterTalepler() {
          renderTalepler();
        }

        function renderTalepler() {
          const tbody = qs('#tbodyTalepler');
          if (!tbody) return;
          tbody.innerHTML = '';

          let filtered = [...talepler];

          const durum = qs('#taleplerFiltreDurum')?.value || '';
          if (durum) filtered = filtered.filter(t => t.durum === durum);

          const tip = qs('#taleplerFiltreTip')?.value || '';
          if (tip) filtered = filtered.filter(t => t.talepTipi === tip);

          const ara = qs('#taleplerAraInput')?.value.trim() || '';
          const kayitlarTalepler = kayitlarForTalepler.length ? kayitlarForTalepler : kayitlar;
          if (ara) {
            filtered = filtered.filter(t => {
              if (turkishIncludes(t.personelAdi || '', ara) || turkishIncludes(t.aciklama || '', ara)) return true;
              const kayit = kayitlarTalepler.find(k => k.id === t.kayitId);
              return !!(kayit && turkishIncludes((kayit.sahip || '').toString(), ara));
            });
          }

          // "Otomatik > TÃ¼m Durumlar" seÃ§iliyse silinen kayÄ±tlarÄ± (ramazan_arsiv) da ekle
          let filteredSilinen = [];
          if (durum === '') {
            filteredSilinen = [...silinenKayitlar];
            if (tip) filteredSilinen = filteredSilinen.filter(t => t.talepTipi === tip);
            if (ara) {
              filteredSilinen = filteredSilinen.filter(t =>
                turkishIncludes(t.personelAdi || '', ara) ||
                turkishIncludes((t.sahip || '').toString(), ara) ||
                turkishIncludes(t.aciklama || '', ara)
              );
            }
          }

          if (filtered.length === 0 && filteredSilinen.length === 0) {
            tbody.innerHTML = '<tr><td colspan="15" style="text-align:center;color:var(--muted);padding:20px">Talep bulunamadÄ±</td></tr>';
            return;
          }

          filtered.forEach(t => {
            const tr = document.createElement('tr');

            // Tarih formatla (Supabase formatÄ± - Firestore formatÄ± kontrolÃ¼ yok)
            let tarihStr = '-';
            if (t.createdAt) {
              const date = typeof t.createdAt === 'string' 
                ? new Date(t.createdAt) 
                : (t.createdAt instanceof Date ? t.createdAt : new Date(t.createdAt));
              if (!isNaN(date.getTime())) {
                tarihStr = `${date.getDate()}.${date.getMonth() + 1}.${date.getFullYear()}`;
              }
            }

            // Talep tipi label
            const talepTipiLabel = {
              'duzenle': 'âœï¸ DÃ¼zenle',
              'yer_degistir': 'ğŸ”„ Yer DeÄŸiÅŸtir',
              'sil': 'ğŸ—‘ï¸ Sil'
            }[t.talepTipi] || t.talepTipi;

            // KayÄ±t tipi label
            const kayitTipiLabel = {
              'iftar-sahur': 'ğŸŒ™ Ä°ftar/Sahur',
              'taahhut': 'ğŸ“ TaahhÃ¼t',
              'teberru': 'ğŸ’° Teberru'
            }[t.kayitTipi] || t.kayitTipi;

            // Durum badge
            const durumBadge = {
              'beklemede': '<span style="background:#fff3cd;color:#856404;padding:4px 8px;border-radius:4px;font-size:11px;font-weight:600">â³ Beklemede</span>',
              'onaylandi': '<span style="background:#d4edda;color:#155724;padding:4px 8px;border-radius:4px;font-size:11px;font-weight:600">âœ“ OnaylandÄ±</span>',
              'reddedildi': '<span style="background:#f8d7da;color:#721c24;padding:4px 8px;border-radius:4px;font-size:11px;font-weight:600">âœ— Reddedildi</span>',
              'silindi_arsiv': '<span style="background:#e2e3e5;color:#383d41;padding:4px 8px;border-radius:4px;font-size:11px;font-weight:600">ğŸ“¦ Silindi (ArÅŸiv)</span>'
            }[t.durum] || t.durum;

            // Yeni tarih
            let yeniTarihStr = '-';
            if (t.yeniTarih) {
              const date = new Date(t.yeniTarih);
              yeniTarihStr = `${date.getDate()}.${date.getMonth() + 1}.${date.getFullYear()}`;
            }

            // KayÄ±t bilgilerini al
            let sahipBilgisi = '-';
            let mevcutTarihStr = '-';
            let musafirAdedi = '-';
            let mahalAdi = '-';
            let kayitTip = '-';
            let tutarBilgisi = '-';
            let istirakBilgisi = '-';

            if (t.kayitId) {
              const kayit = kayitlarTalepler.find(k => k.id === t.kayitId);
              if (kayit) {
                if (t.kayitTipi === 'iftar-sahur') {
                  sahipBilgisi = kayit.sahip || '-';
                  musafirAdedi = kayit.musafirAdedi || kayit.musafiradedi || 0;
                  mahalAdi = kayit.mahal || '-';
                  tutarBilgisi = kayit.tutar ? `â‚º${Number(kayit.tutar).toLocaleString('tr-TR', { minimumFractionDigits: 2 })}` : '-';
                  istirakBilgisi = kayit.istirak ? 'âœ“ Evet' : 'âœ— HayÄ±r';
                  kayitTip = kayit.tip === 'iftar' ? 'ğŸŒ™ Ä°ftar' : 'ğŸŒŸ Sahur';
                  if (kayit.tarih) {
                    const tarih = typeof kayit.tarih === 'string' ? new Date(kayit.tarih) : (kayit.tarih instanceof Date ? kayit.tarih : new Date(kayit.tarih));
                    if (!isNaN(tarih.getTime())) mevcutTarihStr = `${tarih.getDate()}.${tarih.getMonth() + 1}.${tarih.getFullYear()}`;
                  }
                } else if (t.kayitTipi === 'taahhut' || t.kayitTipi === 'teberru') {
                  sahipBilgisi = kayit.sahip || '-';
                  tutarBilgisi = kayit.tutar != null ? `â‚º${Number(kayit.tutar).toLocaleString('tr-TR', { minimumFractionDigits: 2 })}` : '-';
                  kayitTip = t.kayitTipi === 'taahhut' ? 'ğŸ“ TaahhÃ¼t' : 'ğŸ’° Teberru';
                  musafirAdedi = '-';
                  istirakBilgisi = '-';
                  mahalAdi = kayit.mahal || '-';
                  if (kayit.tarih) {
                    const tarih = typeof kayit.tarih === 'string' ? new Date(kayit.tarih) : (kayit.tarih instanceof Date ? kayit.tarih : new Date(kayit.tarih));
                    if (!isNaN(tarih.getTime())) mevcutTarihStr = `${tarih.getDate()}.${tarih.getMonth() + 1}.${tarih.getFullYear()}`;
                  }
                }
              }
            }

            tr.innerHTML = `
          <td>${tarihStr}</td>
          <td>${t.tip ? (t.tip === 'iftar' ? 'ğŸŒ™ Ä°ftar' : 'ğŸŒŸ Sahur') : kayitTip}</td>
          <td>${talepTipiLabel}</td>
          <td>${kayitTipiLabel}</td>
          <td><strong>${sahipBilgisi}</strong></td>
          <td>${mevcutTarihStr}</td>
          <td>${musafirAdedi}</td>
          <td>${tutarBilgisi}</td>
          <td>${istirakBilgisi}</td>
          <td>${mahalAdi}</td>
          <td>${t.personelAdi || '-'}</td>
          <td style="max-width:280px; max-height:120px; overflow-y:auto; overflow-x:hidden; white-space:normal; word-wrap:break-word;">${t.aciklama || '-'}</td>
          <td>${yeniTarihStr}</td>
          <td>${durumBadge}</td>
          <td>
            ${t.durum === 'beklemede' && !t.isArsiv ? `
              <button onclick="onaylaTalep('${t.id}')" style="padding:4px 8px;font-size:12px;background:var(--good);color:white;border:none;border-radius:4px;cursor:pointer;margin-right:4px">âœ“ Onayla</button>
              <button onclick="reddetTalep('${t.id}')" class="danger" style="padding:4px 8px;font-size:12px;background:var(--bad);color:white;border:none;border-radius:4px;cursor:pointer">âœ— Reddet</button>
            ` : (t.isArsiv ? '-' : '-')}
          </td>
        `;
            tbody.appendChild(tr);
          });

          // Silinen kayÄ±tlar (ramazan_arsiv) satÄ±rlarÄ±
          filteredSilinen.forEach(t => {
            const tr = document.createElement('tr');
            tr.style.background = 'rgba(0,0,0,0.03)';
            let tarihStr = '-';
            if (t.createdAt) {
              const date = typeof t.createdAt === 'string' ? new Date(t.createdAt) : (t.createdAt instanceof Date ? t.createdAt : new Date(t.createdAt));
              if (!isNaN(date.getTime())) tarihStr = `${date.getDate()}.${date.getMonth() + 1}.${date.getFullYear()}`;
            }
            let mevcutTarihStr = '-';
            if (t.tarih) {
              const date = typeof t.tarih === 'string' ? new Date(t.tarih) : (t.tarih instanceof Date ? t.tarih : new Date(t.tarih));
              if (!isNaN(date.getTime())) mevcutTarihStr = `${date.getDate()}.${date.getMonth() + 1}.${date.getFullYear()}`;
            }
            const kayitTip = t.tip === 'iftar' ? 'ğŸŒ™ Ä°ftar' : 'ğŸŒŸ Sahur';
            const tutarBilgisi = t.tutar != null ? `â‚º${Number(t.tutar).toLocaleString('tr-TR', { minimumFractionDigits: 2 })}` : '-';
            const istirakBilgisi = t.istirak ? 'âœ“ Evet' : 'âœ— HayÄ±r';
            const durumBadgeSilinen = '<span style="background:#e2e3e5;color:#383d41;padding:4px 8px;border-radius:4px;font-size:11px;font-weight:600">ğŸ“¦ Silindi (ArÅŸiv)</span>';
            tr.innerHTML = `
          <td>${tarihStr}</td>
          <td>${kayitTip}</td>
          <td>ğŸ—‘ï¸ Sil</td>
          <td>ğŸŒ™ Ä°ftar/Sahur</td>
          <td><strong>${t.sahip || '-'}</strong></td>
          <td>${mevcutTarihStr}</td>
          <td>${t.musafirAdedi ?? '-'}</td>
          <td>${tutarBilgisi}</td>
          <td>${istirakBilgisi}</td>
          <td>${t.mahal || '-'}</td>
          <td>${t.personelAdi || '-'}</td>
          <td style="max-width:280px; max-height:120px; overflow-y:auto; overflow-x:hidden; white-space:normal; word-wrap:break-word;">${t.aciklama || '-'}</td>
          <td>-</td>
          <td>${durumBadgeSilinen}</td>
          <td>-</td>
        `;
            tbody.appendChild(tr);
          });
        }

        async function onaylaTalep(talepId) {
          const talep = talepler.find(t => t.id === talepId);
          if (!talep) {
            showAlertModal('Hata', 'Talep bulunamadÄ±!');
            return;
          }

          const talepTipiLabel = {
            'duzenle': 'DÃ¼zenle',
            'yer_degistir': 'Yer DeÄŸiÅŸtir',
            'sil': 'Sil'
          }[talep.talepTipi] || talep.talepTipi;

          const kayitlarOnay = kayitlarForTalepler.length ? kayitlarForTalepler : kayitlar;
          const kayit = talep.kayitId ? kayitlarOnay.find(k => k.id === talep.kayitId) : null;

          const formatTarihStr = (dateVal) => {
            if (!dateVal) return '-';
            const d = typeof dateVal === 'string' ? new Date(dateVal) : (dateVal instanceof Date ? dateVal : new Date(dateVal));
            return isNaN(d.getTime()) ? '-' : `${d.getDate()}.${d.getMonth() + 1}.${d.getFullYear()}`;
          };

          let eskiHtml = '';
          let yeniHtml = '';

          if (kayit) {
            if (talep.kayitTipi === 'iftar-sahur') {
              eskiHtml = talepOnayRow('Tarih', formatTarihStr(kayit.tarih))
                + talepOnayRow('Tip', kayit.tip === 'iftar' ? 'Ä°ftar' : 'Sahur')
                + talepOnayRow('Sahip', kayit.sahip || '-')
                + talepOnayRow('MÃ¼safir', kayit.musafirAdedi ?? kayit.musafiradedi ?? 0)
                + talepOnayRow('Tutar', kayit.tutar != null ? 'â‚º' + Number(kayit.tutar).toLocaleString('tr-TR', { minimumFractionDigits: 2 }) : '-')
                + talepOnayRow('Ä°ÅŸtirak', kayit.istirak ? 'Evet' : 'HayÄ±r')
                + talepOnayRow('Mahal', kayit.mahal || '-');

              if (talep.talepTipi === 'yer_degistir') {
                yeniHtml = talepOnayRow('Yeni Tarih', formatTarihStr(talep.yeniTarih));
                if (talep.mahalId && kayit.mahalId !== talep.mahalId) yeniHtml += talepOnayRow('Yeni Mahal', '(SeÃ§ilen mahal)');
              } else if (talep.talepTipi === 'duzenle') {
                const g = parseAciklama(talep.aciklama || '');
                yeniHtml = talepOnayRow('GÃ¼ncelleme', 'AÃ§Ä±klamaya gÃ¶re');
                if (g.musafirAdedi != null) yeniHtml += talepOnayRow('MÃ¼safir', g.musafirAdedi);
                if (g.tutar != null) yeniHtml += talepOnayRow('Tutar', 'â‚º' + Number(g.tutar).toLocaleString('tr-TR', { minimumFractionDigits: 2 }));
                if (g.sahip) yeniHtml += talepOnayRow('Sahip', g.sahip);
                if (g.mahalAdi) yeniHtml += talepOnayRow('Mahal', g.mahalAdi);
              } else if (talep.talepTipi === 'sil') {
                yeniHtml = '<div class="talep-onay-satir"><span class="value" style="color:var(--bad);font-weight:600;">KayÄ±t silinecek</span></div>';
              }
            } else if (talep.kayitTipi === 'taahhut' || talep.kayitTipi === 'teberru') {
              eskiHtml = talepOnayRow('Sahip', kayit.sahip || '-')
                + talepOnayRow('Tutar', kayit.tutar != null ? 'â‚º' + Number(kayit.tutar).toLocaleString('tr-TR', { minimumFractionDigits: 2 }) : '-')
                + talepOnayRow('Tarih', formatTarihStr(kayit.tarih));
              yeniHtml = '<div class="talep-onay-satir"><span class="value">Talep onaylandÄ± olarak iÅŸaretlenecek</span></div>';
            }
          }

          if (!eskiHtml) eskiHtml = talepOnayRow('KayÄ±t', 'BulunamadÄ±');
          if (!yeniHtml) yeniHtml = talepOnayRow('Ä°ÅŸlem', talepTipiLabel);

          const confirmed = await showTalepOnayModal(eskiHtml, yeniHtml, talep.aciklama);

          if (!confirmed) {
            return;
          }

          try {
            const yil = qs('#taleplerFiltreYil')?.value || qs('#filtreYil')?.value || new Date().getFullYear().toString();
            const supabase = getSupabase();
            if (!supabase) {
              showAlertModal('Hata', 'Supabase client hazÄ±r deÄŸil');
              return;
            }

            if (talep.kayitTipi === 'iftar-sahur') {
              const kayit = kayitlarOnay.find(k => k.id === talep.kayitId);
              if (!kayit) {
                showAlertModal('Hata', 'KayÄ±t bulunamadÄ±!');
                return;
              }

              if (talep.talepTipi === 'yer_degistir' && talep.yeniTarih) {
                // Yer deÄŸiÅŸtirme - Tarih gÃ¼ncelle (YYYY-MM-DD veya ISO veya DD.MM.YYYY destekle)
                let yeniTarih = null;
                const raw = String(talep.yeniTarih).trim();
                if (raw.includes('-')) {
                  const parts = raw.split('-');
                  const y = parseInt(parts[0], 10);
                  const m = parseInt(parts[1], 10) - 1;
                  const d = parseInt(parts[2], 10);
                  if (!isNaN(y) && !isNaN(m) && !isNaN(d)) yeniTarih = new Date(y, m, d, 12, 0, 0);
                }
                if (!yeniTarih || isNaN(yeniTarih.getTime())) yeniTarih = new Date(raw);
                if (!yeniTarih || isNaN(yeniTarih.getTime())) {
                  const dmY = raw.match(/^(\d{1,2})[.\/](\d{1,2})[.\/](\d{4})$/);
                  if (dmY) yeniTarih = new Date(parseInt(dmY[3], 10), parseInt(dmY[2], 10) - 1, parseInt(dmY[1], 10), 12, 0, 0);
                }
                if (!yeniTarih || isNaN(yeniTarih.getTime())) {
                  showAlertModal('Hata', 'GeÃ§ersiz yeni tarih: ' + raw);
                  return;
                }
                const yil = yeniTarih.getFullYear();
                const ay = yeniTarih.getMonth() + 1;

                // Not alanÄ±na geÃ§miÅŸ tarihleri ekle
                let tarihGecmisi = kayit.notlar || kayit.not || '';
                const formatTarih = (date) => {
                  const d = new Date(date);
                  const gun = String(d.getDate()).padStart(2, '0');
                  const ay = String(d.getMonth() + 1).padStart(2, '0');
                  const yil = d.getFullYear();
                  return `${gun}.${ay}.${yil}`;
                };

                let eskiTarih;
                if (kayit.tarih) {
                  eskiTarih = typeof kayit.tarih === 'string' 
                    ? new Date(kayit.tarih) 
                    : (kayit.tarih instanceof Date ? kayit.tarih : new Date(kayit.tarih));
                  if (isNaN(eskiTarih.getTime())) {
                    eskiTarih = new Date();
                  }
                } else {
                  eskiTarih = new Date();
                }

                if (tarihGecmisi && tarihGecmisi.includes('tarihine geÃ§ti')) {
                  const tarihListesi = tarihGecmisi.match(/\d{2}\.\d{2}\.\d{4}/g) || [];
                  const yeniTarihStr = formatTarih(yeniTarih);
                  tarihGecmisi = tarihListesi.join(' > ') + ' > ' + yeniTarihStr + ' tarihine geÃ§ti';
                } else {
                  const eskiTarihStr = formatTarih(eskiTarih);
                  const yeniTarihStr = formatTarih(yeniTarih);
                  tarihGecmisi = (tarihGecmisi ? tarihGecmisi + ' | ' : '') +
                    eskiTarihStr + ' > ' + yeniTarihStr + ' tarihine geÃ§ti';
                }

                // Mahal deÄŸiÅŸikliÄŸi kontrolÃ¼
                let mahalGuncellemesi = {};
                if (talep.mahalId && kayit.mahalId !== talep.mahalId) {
                  // Mahal deÄŸiÅŸikliÄŸi yap - Supabase'den mahal bilgisini al
                  const { data: mahalData, error: mahalError } = await supabase
                    .from('ramazan_mahaller')
                    .select('*')
                    .eq('id', talep.mahalId)
                    .single();

                  if (!mahalError && mahalData) {
                    // Åemaya gÃ¶re: mahalid (kÃ¼Ã§Ã¼k harf)
                    mahalGuncellemesi = {
                      mahalid: talep.mahalId,
                      mahal: mahalData.adi || kayit.mahal
                    };
                  }
                }

                // KaydÄ± gÃ¼ncelle - Supabase
                // Åemaya gÃ¶re: updatedat, notlar (kÃ¼Ã§Ã¼k harf)
                const updateData = {
                  tarih: yeniTarih.toISOString(),
                  notlar: tarihGecmisi,
                  yil: yil,
                  ay: ay,
                  updatedat: new Date().toISOString(),
                  ...mahalGuncellemesi
                };

                const { error: updateError } = await supabase
                  .from('ramazan_kayitlari')
                  .update(updateData)
                  .eq('id', talep.kayitId);

                if (updateError) throw updateError;

              } else if (talep.talepTipi === 'duzenle') {
                // Normal dÃ¼zenleme - AÃ§Ä±klamadan bilgileri parse et
                const guncelleme = parseAciklama(talep.aciklama || '');
                let not = kayit.notlar || kayit.not || '';

                // AÃ§Ä±klamayÄ± not alanÄ±na ekle
                if (talep.aciklama) {
                  not = (not ? not + ' | ' : '') + `DÃ¼zenleme: ${talep.aciklama}`;
                }

                // GÃ¼ncelleme objesi oluÅŸtur
                // Åemaya gÃ¶re: musafiradedi, updatedat, mahalid, notlar (kÃ¼Ã§Ã¼k harf)
                const updateData = {
                  notlar: not,
                  updatedat: new Date().toISOString()
                };

                // KiÅŸi artÄ±ÅŸÄ± varsa
                if (guncelleme.musafirAdedi !== null) {
                  updateData.musafiradedi = guncelleme.musafirAdedi;
                }

                // Tutar deÄŸiÅŸikliÄŸi varsa
                if (guncelleme.tutar !== null) {
                  updateData.tutar = guncelleme.tutar;
                }

                // Sahip deÄŸiÅŸikliÄŸi varsa
                if (guncelleme.sahip) {
                  updateData.sahip = guncelleme.sahip;
                }

                // Mahal deÄŸiÅŸikliÄŸi varsa
                if (guncelleme.mahalId) {
                  const { data: mahalData, error: mahalError } = await supabase
                    .from('ramazan_mahaller')
                    .select('*')
                    .eq('id', guncelleme.mahalId)
                    .single();

                  if (!mahalError && mahalData) {
                    // Åemaya gÃ¶re: mahalid (kÃ¼Ã§Ã¼k harf)
                    updateData.mahalid = mahalData.id;
                    updateData.mahal = mahalData.adi || kayit.mahal;
                  } else if (guncelleme.mahalAdi) {
                    // ID bulunamazsa ad ile ara
                    const { data: mahalList, error: mahalListError } = await supabase
                      .from('ramazan_mahaller')
                      .select('*')
                      .ilike('adi', guncelleme.mahalAdi)
                      .limit(1);

                    if (!mahalListError && mahalList && mahalList.length > 0) {
                      // Åemaya gÃ¶re: mahalid (kÃ¼Ã§Ã¼k harf)
                      updateData.mahalid = mahalList[0].id;
                      updateData.mahal = mahalList[0].adi || kayit.mahal;
                    }
                  }
                }

                // Supabase'de gÃ¼ncelle
                const { error: updateError } = await supabase
                  .from('ramazan_kayitlari')
                  .update(updateData)
                  .eq('id', talep.kayitId);

                if (updateError) throw updateError;
              } else if (talep.talepTipi === 'sil') {
                // Silme iÅŸlemi - Supabase
                const { error: deleteError } = await supabase
                  .from('ramazan_kayitlari')
                  .delete()
                  .eq('id', talep.kayitId);

                if (deleteError) throw deleteError;
              }
            } else {
              // TaahhÃ¼t veya Teberru iÃ§in sadece durum gÃ¼ncelle
              // Bu kayÄ±tlar farklÄ± koleksiyonlarda olabilir
              // Åimdilik sadece talep durumunu gÃ¼ncelliyoruz
            }

            // Talep durumunu gÃ¼ncelle - Supabase
            // KullanÄ±cÄ± bilgisini al (Supabase'den)
            let userId = null;
            try {
              const { data: { user } } = await supabase.auth.getUser();
              userId = user?.id || null;
            } catch (e) {
              console.warn('KullanÄ±cÄ± bilgisi alÄ±namadÄ±, devam ediliyor:', e);
            }

            // Talep durumunu gÃ¼ncelle - Åemaya gÃ¶re lowercase kullan
            const { error: talepUpdateError } = await supabase
              .from('duzenleme_talepleri')
              .update({
                durum: 'onaylandi',
                onaylayanuid: userId,              // âœ… lowercase (ÅŸemada onaylayanuid)
                onaylanmatarihi: new Date().toISOString()  // âœ… lowercase (ÅŸemada onaylanmatarihi)
              })
              .eq('id', talepId);

            if (talepUpdateError) throw talepUpdateError;

            showToast('BaÅŸarÄ±lÄ±', 'Talep baÅŸarÄ±yla onaylandÄ±!', 'success');
            await loadTalepler();
            await loadKayitlar(); // KayÄ±tlarÄ± yeniden yÃ¼kle
          } catch (e) {
            console.error('Talep onaylanamadÄ±:', e);
            showAlertModal('Hata', 'Talep onaylanamadÄ±: ' + e.message);
          }
        }

        async function reddetTalep(talepId) {
          const talep = talepler.find(t => t.id === talepId);
          if (!talep) {
            showAlertModal('Hata', 'Talep bulunamadÄ±!');
            return;
          }

          // Red modal'Ä± iÃ§in input alanÄ± oluÅŸtur
          const redAciklama = await showPromptModal(
            'Talep Reddetme',
            'Red sebebini giriniz (opsiyonel):',
            'Reddet',
            'danger'
          );

          if (redAciklama === null) return; // KullanÄ±cÄ± iptal etti

          try {
            const yil = qs('#taleplerFiltreYil')?.value || qs('#filtreYil')?.value || new Date().getFullYear().toString();
            const supabase = getSupabase();
            if (!supabase) {
              showAlertModal('Hata', 'Supabase client hazÄ±r deÄŸil');
              return;
            }

            // KullanÄ±cÄ± bilgisini al (Supabase'den)
            let userId = null;
            try {
              const { data: { user } } = await supabase.auth.getUser();
              userId = user?.id || null;
            } catch (e) {
              console.warn('KullanÄ±cÄ± bilgisi alÄ±namadÄ±, devam ediliyor:', e);
            }

            // Talep durumunu gÃ¼ncelle - Åemaya gÃ¶re lowercase kullan
            const { error } = await supabase
              .from('duzenleme_talepleri')
              .update({
                durum: 'reddedildi',
                rededenuid: userId,                // âœ… lowercase (ÅŸemada rededenuid)
                redtarihi: new Date().toISOString(), // âœ… lowercase (ÅŸemada redtarihi)
                redaciklama: redAciklama || ''      // âœ… lowercase (ÅŸemada redaciklama)
              })
              .eq('id', talepId);

            if (error) throw error;

            showToast('BaÅŸarÄ±lÄ±', 'Talep reddedildi!', 'success');
            await loadTalepler();
          } catch (e) {
            console.error('Talep reddedilemedi:', e);
            showAlertModal('Hata', 'Talep reddedilemedi: ' + e.message);
          }
        }

        window.loadTalepler = loadTalepler;
        window.filterTalepler = filterTalepler;
        window.onaylaTalep = onaylaTalep;
        window.reddetTalep = reddetTalep;

        // YÄ±l deÄŸiÅŸtiÄŸinde talepleri yeniden yÃ¼kle
        if (qs('#taleplerFiltreYil')) {
          qs('#taleplerFiltreYil').addEventListener('change', loadTalepler);
        }

        // ===== PERSONEL HEDEF YÃ–NETÄ°MÄ° =====

        let personelHedefleri = [];
        let kullanicilarList = [];

        // Tutar parse fonksiyonu
        function parseTutar(str) {
          // str bir string deÄŸilse string'e Ã§evir
          if (str === null || str === undefined) return 0;
          const strValue = String(str);
          if (!strValue || strValue.trim() === '') return 0;
          return parseFloat(strValue.replace(/\./g, '').replace(',', '.')) || 0;
        }

        // Tutar format fonksiyonu
        function formatTutar(tutar) {
          return tutar.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        async function loadKullanicilar() {
          try {
            const supabase = getSupabase();
            if (!supabase) {
              console.error('Supabase client hazÄ±r deÄŸil');
              return;
            }
            const { data, error } = await supabase
              .from('kullanicilar')
              .select('*')
              .order('adsoyad', { ascending: true });

            if (error) {
              console.error('KullanÄ±cÄ±lar yÃ¼klenemedi:', error);
              kullanicilarList = [];
            } else {
              kullanicilarList = (data || []).map(d => ({ id: d.id, ...d }));
            }
          } catch (e) {
            console.error('KullanÄ±cÄ±lar yÃ¼klenemedi:', e);
            kullanicilarList = [];
          }
        }

        async function loadPersonelHedefleri() {
          const yil = qs('#hedefYonetimYil')?.value || new Date().getFullYear().toString();
          try {
            const supabase = getSupabase();
            if (!supabase) {
              console.error('Supabase client hazÄ±r deÄŸil');
              return;
            }
            const { data, error } = await supabase
              .from('ramazan_hedefler')
              .select('*')
              .eq('yil', parseInt(yil))
              .order('personeladi', { ascending: true });

            if (error) {
              console.error('Personel hedefleri yÃ¼klenemedi:', error);
              personelHedefleri = [];
            } else {
              // Åemadan gelen verileri camelCase'e Ã§evir (personeladi -> personelAdi)
              personelHedefleri = (data || []).map(d => ({
                id: d.id,
                ...d,
                personelAdi: d.personeladi || d.personelAdi || '',
                personelUid: d.personeluid || d.personelUid || null,
                createdAt: d.createdat || d.createdAt,
                updatedAt: d.updatedat || d.updatedAt
              }));
            }

            // KullanÄ±cÄ±larÄ± da yÃ¼kle
            await loadKullanicilar();
            renderPersonelHedefleri();
          } catch (e) {
            console.error('Personel hedefleri yÃ¼klenemedi:', e);
            personelHedefleri = [];
            await loadKullanicilar();
            renderPersonelHedefleri();
          }
        }

        function renderPersonelHedefleri() {
          const tbody = qs('#tbodyPersonelHedefleri');
          if (!tbody) return;
          tbody.innerHTML = '';

          if (personelHedefleri.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" style="text-align:center;color:var(--muted);padding:20px">Hedef bulunamadÄ±</td></tr>';
            return;
          }

          personelHedefleri.forEach(h => {
            const tr = document.createElement('tr');
            const hedef = h.hedef || h.iftarHedefi || h.sahurHedefi || h.taahhutHedefi || h.teberruHedefi || '0';

            tr.innerHTML = `
          <td><strong>${h.personeladi || h.personelAdi || '-'}</strong></td>
          <td>${h.yil || '-'}</td>
          <td class="right"><strong>${hedef ? `â‚º${formatTutar(typeof hedef === 'number' ? hedef : parseTutar(String(hedef || '0')))}` : '-'}</strong></td>
          <td>
            <button onclick="editPersonelHedef('${h.id}')" style="padding:4px 8px;font-size:12px;margin-right:4px">DÃ¼zenle</button>
            <button onclick="deletePersonelHedef('${h.id}')" class="danger" style="padding:4px 8px;font-size:12px">Sil</button>
          </td>
        `;
            tbody.appendChild(tr);
          });
        }

        async function openPersonelHedefModal(id = null) {
          await loadKullanicilar();

          qs('#personelHedefId').value = id || '';
          qs('#personelHedefTitle').textContent = id ? 'Personel Hedefi DÃ¼zenle' : 'Yeni Personel Hedefi';

          // Personel dropdown'unu doldur
          const personelSelect = qs('#personelHedefPersonel');
          personelSelect.innerHTML = '<option value="">Personel SeÃ§iniz</option>';
          kullanicilarList.forEach(k => {
            const option = document.createElement('option');
            option.value = k.id;
            option.textContent = k.adsoyad || k.email || k.id;
            personelSelect.appendChild(option);
          });

          if (id) {
            const hedef = personelHedefleri.find(h => h.id === id);
            if (hedef) {
              qs('#personelHedefPersonel').value = hedef.personelUid || '';
              qs('#personelHedefYil').value = hedef.yil || new Date().getFullYear().toString();
              qs('#personelHedefTutar').value = hedef.hedef || hedef.iftarHedefi || hedef.sahurHedefi || hedef.taahhutHedefi || hedef.teberruHedefi || '';
            }
          } else {
            qs('#formPersonelHedef').reset();
            qs('#personelHedefYil').value = qs('#hedefYonetimYil')?.value || new Date().getFullYear().toString();
          }

          qs('#modalPersonelHedef').classList.add('show');
          document.body.classList.add('modal-open');
        }

        function closePersonelHedefModal() {
          qs('#modalPersonelHedef').classList.remove('show');
          document.body.classList.remove('modal-open');
          qs('#formPersonelHedef').reset();
        }

        async function editPersonelHedef(id) {
          await openPersonelHedefModal(id);
        }

        async function deletePersonelHedef(id) {
          const hedef = personelHedefleri.find(h => h.id === id);
          if (!hedef) {
            showAlertModal('Hata', 'Hedef bulunamadÄ±!');
            return;
          }

          const confirmed = await showConfirmModal(
            'Hedef Silme',
            `${hedef.personeladi || hedef.personelAdi || 'Bu personel'} iÃ§in ${hedef.yil || ''} yÄ±lÄ± hedefini silmek istediÄŸinizden emin misiniz?`,
            'Sil',
            'danger'
          );

          if (!confirmed) return;

          try {
            const supabase = getSupabase();
            if (!supabase) {
              showToast('error', 'Hata', 'Supabase client hazÄ±r deÄŸil');
              return;
            }

            const { error } = await supabase
              .from('ramazan_hedefler')
              .delete()
              .eq('id', id);

            if (error) throw error;

            showToast('BaÅŸarÄ±lÄ±', 'Hedef silindi!', 'success');
            await loadPersonelHedefleri();
          } catch (e) {
            console.error('Hedef silinemedi:', e);
            showAlertModal('Hata', 'Hedef silinemedi: ' + e.message);
          }
        }

        qs('#formPersonelHedef').addEventListener('submit', async (e) => {
          e.preventDefault();

          const id = qs('#personelHedefId').value;
          const personelUid = qs('#personelHedefPersonel').value;
          const yil = qs('#personelHedefYil').value;
          const hedefTutar = qs('#personelHedefTutar').value.trim();

          if (!personelUid) {
            showAlertModal('Hata', 'LÃ¼tfen bir personel seÃ§iniz!');
            return;
          }

          if (!hedefTutar) {
            showAlertModal('Hata', 'LÃ¼tfen hedef tutarÄ± giriniz!');
            return;
          }

          const personel = kullanicilarList.find(k => k.id === personelUid);
          const personelAdi = personel?.adsoyad || personel?.email || 'Bilinmeyen';

          try {
            const supabase = getSupabase();
            if (!supabase) {
              showToast('error', 'Hata', 'Supabase client hazÄ±r deÄŸil');
              return;
            }

            // Åemaya gÃ¶re: personeladi, personeluid, createdat, updatedat (kÃ¼Ã§Ã¼k harf)
            const data = {
              personeluid: personelUid,
              personeladi: personelAdi,
              yil: parseInt(yil),
              hedef: typeof hedefTutar === 'string' ? parseFloat(hedefTutar.replace(/\./g, '').replace(',', '.')) : hedefTutar,
              updatedat: new Date().toISOString()
            };

            if (id) {
              const { error } = await supabase
                .from('ramazan_hedefler')
                .update(data)
                .eq('id', id);
              if (error) throw error;
            } else {
              // Yeni kayÄ±t
              // UUID oluÅŸtur
              let newId;
              if (typeof crypto !== 'undefined' && crypto.randomUUID) {
                newId = crypto.randomUUID();
              } else {
                newId = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                  const r = Math.random() * 16 | 0;
                  const v = c === 'x' ? r : (r & 0x3 | 0x8);
                  return v.toString(16);
                });
              }
              data.id = newId;
              data.createdat = new Date().toISOString(); // Åemada createdat (kÃ¼Ã§Ã¼k harf)

              const { error } = await supabase
                .from('ramazan_hedefler')
                .insert(data);
              if (error) throw error;
            }

            showToast('BaÅŸarÄ±lÄ±', 'Hedef baÅŸarÄ±yla kaydedildi!', 'success');
            closePersonelHedefModal();
            await loadPersonelHedefleri();
          } catch (e) {
            console.error('Hedef kaydedilemedi:', e);
            showAlertModal('Hata', 'Hedef kaydedilemedi: ' + e.message);
          }
        });

        window.loadPersonelHedefleri = loadPersonelHedefleri;
        window.openPersonelHedefModal = openPersonelHedefModal;
        window.closePersonelHedefModal = closePersonelHedefModal;
        window.editPersonelHedef = editPersonelHedef;
        window.deletePersonelHedef = deletePersonelHedef;

        // YÄ±l deÄŸiÅŸtiÄŸinde hedefleri yeniden yÃ¼kle
        if (qs('#hedefYonetimYil')) {
          qs('#hedefYonetimYil').addEventListener('change', loadPersonelHedefleri);
        }

        // ===== MENÃœ YÃ–NETÄ°MÄ° =====

        let menuler = [];

        async function loadMenuler() {
          const yil = Number(qs('#menuFiltreYil')?.value || new Date().getFullYear().toString());
          try {
            const supabase = getSupabase();
            if (!supabase) {
              console.error('Supabase client hazÄ±r deÄŸil');
              return;
            }
            const { data, error } = await supabase
              .from('ramazan_menuler')
              .select('*')
              .eq('yil', yil)
              .order('tarih', { ascending: false });
            if (error) {
              console.error('MenÃ¼ler yÃ¼klenemedi:', error);
              menuler = [];
            } else {
              menuler = (data || []).map(d => ({ id: d.id, ...d }));
            }
            renderMenuler();
          } catch (e) {
            console.error('MenÃ¼ler yÃ¼klenemedi:', e);
            menuler = [];
            renderMenuler();
          }
        }

        function filterMenuler() {
          renderMenuler();
        }

        function renderMenuler() {
          const tbody = qs('#tbodyMenuler');
          if (!tbody) return;
          tbody.innerHTML = '';

          let filtered = [...menuler];

          const tip = qs('#menuFiltreTip')?.value || '';
          if (tip) filtered = filtered.filter(m => m.tip === tip);

          const tarih = qs('#menuFiltreTarih')?.value || '';
          if (tarih) {
            filtered = filtered.filter(m => {
              let menuTarih = '';
              if (m.tarih) {
                if (typeof m.tarih === 'string') {
                  menuTarih = m.tarih.slice(0, 10);
                } else if (m.tarih instanceof Date) {
                  menuTarih = m.tarih.toISOString().slice(0, 10);
                } else {
                  // Supabase timestamp string
                  const d = new Date(m.tarih);
                  if (!isNaN(d.getTime())) {
                    menuTarih = d.toISOString().slice(0, 10);
                  }
                }
              }
              return menuTarih === tarih;
            });
          }

          if (filtered.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;color:var(--muted);padding:20px">MenÃ¼ bulunamadÄ±</td></tr>';
            return;
          }

          filtered.forEach(m => {
            const tr = document.createElement('tr');

            // Tarih formatla
            let tarihStr = '-';
            if (m.tarih) {
              let tarih;
              if (typeof m.tarih === 'string') {
                tarih = new Date(m.tarih);
              } else if (m.tarih instanceof Date) {
                tarih = m.tarih;
              } else {
                // Supabase timestamp string
                tarih = new Date(m.tarih);
              }
              if (!isNaN(tarih.getTime())) {
                tarihStr = `${tarih.getDate()}.${tarih.getMonth() + 1}.${tarih.getFullYear()}`;
              }
            }

            const tipLabel = m.tip === 'iftar' ? 'ğŸŒ™ Ä°ftar' : 'ğŸŒŸ Sahur';

            tr.innerHTML = `
          <td><strong>${tarihStr}</strong></td>
          <td>${tipLabel}</td>
          <td>${m.corba || '-'}</td>
          <td>${m.yemek || '-'}</td>
          <td>${m.soguk || '-'}</td>
          <td>${m.icecek || '-'}</td>
          <td style="max-width:200px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;" title="${m.diger || ''}">${m.diger || '-'}</td>
          <td>
            <button onclick="editMenu('${m.id}')" style="padding:4px 8px;font-size:12px;margin-right:4px">DÃ¼zenle</button>
            <button onclick="deleteMenu('${m.id}')" class="danger" style="padding:4px 8px;font-size:12px">Sil</button>
          </td>
        `;
            tbody.appendChild(tr);
          });
        }

        async function openMenuModal(id = null) {
          qs('#menuId').value = id || '';
          qs('#menuTitle').textContent = id ? 'MenÃ¼ DÃ¼zenle' : 'Yeni MenÃ¼';

          if (id) {
            const menu = menuler.find(m => m.id === id);
            if (menu) {
              let tarihStr = '';
              if (menu.tarih) {
                if (typeof menu.tarih === 'string') {
                  tarihStr = menu.tarih.slice(0, 10);
                } else if (menu.tarih instanceof Date) {
                  tarihStr = menu.tarih.toISOString().slice(0, 10);
                } else {
                  const d = new Date(menu.tarih);
                  if (!isNaN(d.getTime())) {
                    tarihStr = d.toISOString().slice(0, 10);
                  }
                }
              }
              qs('#menuTarih').value = tarihStr;
              qs('#menuTip').value = menu.tip || '';
              qs('#menuCorba').value = menu.corba || '';
              qs('#menuYemek').value = menu.yemek || '';
              qs('#menuSoguk').value = menu.soguk || '';
              qs('#menuIcecek').value = menu.icecek || '';
              qs('#menuDiger').value = menu.diger || '';
            }
          } else {
            qs('#formMenu').reset();
            qs('#menuTarih').value = new Date().toISOString().slice(0, 10);
          }

          qs('#modalMenu').classList.add('show');
          document.body.classList.add('modal-open');
        }

        function closeMenuModal() {
          qs('#modalMenu').classList.remove('show');
          document.body.classList.remove('modal-open');
          qs('#formMenu').reset();
        }

        async function editMenu(id) {
          await openMenuModal(id);
        }

        async function deleteMenu(id) {
          const menu = menuler.find(m => m.id === id);
          if (!menu) {
            showAlertModal('Hata', 'MenÃ¼ bulunamadÄ±!');
            return;
          }

          let tarihStr = '-';
          if (menu.tarih) {
            let tarih;
            if (typeof menu.tarih === 'string') {
              tarih = new Date(menu.tarih);
            } else if (menu.tarih instanceof Date) {
              tarih = menu.tarih;
            } else {
              tarih = new Date(menu.tarih);
            }
            if (!isNaN(tarih.getTime())) {
              tarihStr = `${tarih.getDate()}.${tarih.getMonth() + 1}.${tarih.getFullYear()}`;
            }
          }

          const confirmed = await showConfirmModal(
            'MenÃ¼ Silme',
            `${tarihStr} tarihli ${menu.tip === 'iftar' ? 'Ä°ftar' : 'Sahur'} menÃ¼sÃ¼nÃ¼ silmek istediÄŸinizden emin misiniz?`,
            'Sil',
            'danger'
          );

          if (!confirmed) return;

          try {
            const supabase = getSupabase();
            if (!supabase) {
              showToast('error', 'Hata', 'Supabase client hazÄ±r deÄŸil');
              return;
            }
            const { error } = await supabase
              .from('ramazan_menuler')
              .delete()
              .eq('id', id);
            if (error) {
              throw error;
            }
            showToast('success', 'BaÅŸarÄ±lÄ±', 'MenÃ¼ silindi!');
            await loadMenuler();
          } catch (e) {
            console.error('MenÃ¼ silinemedi:', e);
            showToast('error', 'Hata', 'MenÃ¼ silinemedi: ' + (e.message || e));
          }
        }

        qs('#formMenu').addEventListener('submit', async (e) => {
          e.preventDefault();

          const id = qs('#menuId').value;
          const tarih = qs('#menuTarih').value;
          const tip = qs('#menuTip').value;
          const corba = qs('#menuCorba').value.trim();
          const yemek = qs('#menuYemek').value.trim();
          const soguk = qs('#menuSoguk').value.trim();
          const icecek = qs('#menuIcecek').value.trim();
          const diger = qs('#menuDiger').value.trim();

          if (!tarih || !tip) {
            showAlertModal('Hata', 'LÃ¼tfen tarih ve tip seÃ§iniz!');
            return;
          }

          const date = new Date(tarih);
          const yil = date.getFullYear();

          try {
            const supabase = getSupabase();
            if (!supabase) {
              showToast('error', 'Hata', 'Supabase client hazÄ±r deÄŸil');
              return;
            }

            // Tarih formatÄ±nÄ± dÃ¼zelt - sadece tarih kÄ±smÄ±nÄ± al (saat bilgisi olmadan)
            const tarihStr = tarih; // Input'tan gelen tarih string'i (YYYY-MM-DD formatÄ±nda)

            // Åemaya gÃ¶re: updatedat, createdat (kÃ¼Ã§Ã¼k harf)
            const data = {
              tip: tip,
              corba: corba || null,
              yemek: yemek || null,
              soguk: soguk || null,
              icecek: icecek || null,
              diger: diger || null,
              yil: yil,
              tarih: tarihStr, // Tarih string olarak (YYYY-MM-DD)
              updatedat: new Date().toISOString()
            };

            if (id) {
              const { error } = await supabase
                .from('ramazan_menuler')
                .update(data)
                .eq('id', id);
              if (error) throw error;
            } else {
              // AynÄ± tarih ve tip iÃ§in menÃ¼ var mÄ± kontrol et
              const { data: mevcutMenuList, error: checkError } = await supabase
                .from('ramazan_menuler')
                .select('id')
                .eq('yil', yil)
                .eq('tip', tip)
                .eq('tarih', tarihStr) // Tarih string olarak karÅŸÄ±laÅŸtÄ±r
                .limit(1);

              if (mevcutMenuList && mevcutMenuList.length > 0 && !checkError) {
                // Mevcut menÃ¼yÃ¼ gÃ¼ncelle
                const { error } = await supabase
                  .from('ramazan_menuler')
                  .update(data)
                  .eq('id', mevcutMenuList[0].id);
                if (error) {
                  console.error('âŒ MenÃ¼ update hatasÄ±:', error);
                  throw error;
                }
              } else {
                // Yeni menÃ¼ oluÅŸtur - UUID oluÅŸtur
                let newId;
                if (typeof crypto !== 'undefined' && crypto.randomUUID) {
                  newId = crypto.randomUUID();
                } else {
                  // Fallback: basit UUID v4 oluÅŸtur
                  newId = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
                    const r = Math.random() * 16 | 0;
                    const v = c === 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                  });
                }

                data.id = newId;
                data.createdat = new Date().toISOString();

                const { error } = await supabase
                  .from('ramazan_menuler')
                  .insert(data);
                if (error) {
                  console.error('âŒ MenÃ¼ insert hatasÄ±:', error);
                  console.error('âŒ GÃ¶nderilen data:', data);
                  throw error;
                }
              }
            }

            showToast('success', 'BaÅŸarÄ±lÄ±', 'MenÃ¼ baÅŸarÄ±yla kaydedildi!');
            closeMenuModal();
            await loadMenuler();
          } catch (e) {
            console.error('MenÃ¼ kaydedilemedi:', e);
            showToast('error', 'Hata', 'MenÃ¼ kaydedilemedi: ' + (e.message || e));
          }
        });

        window.loadMenuler = loadMenuler;
        window.filterMenuler = filterMenuler;
        window.openMenuModal = openMenuModal;
        window.closeMenuModal = closeMenuModal;
        window.editMenu = editMenu;
        window.deleteMenu = deleteMenu;

        // YÄ±l deÄŸiÅŸtiÄŸinde menÃ¼leri yeniden yÃ¼kle
        if (qs('#menuFiltreYil')) {
          qs('#menuFiltreYil').addEventListener('change', loadMenuler);
        }

      }); // waitForSupabaseAndOrtak callback kapanÄ±ÅŸÄ±
    }); // DOMContentLoaded event listener kapanÄ±ÅŸÄ±
  </script>
</body>

</html>