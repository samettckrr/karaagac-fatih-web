<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8" />
  <title>N√∂bet Planƒ± | Karaaƒüa√ß Fatih</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="icon" type="image/png" href="../img/logo.png" />
  <link rel="stylesheet" href="../css/app-shell.css" />

  <style>
    html, body { height: 100%; overflow-x: hidden; }
    body { padding-top: var(--appbar-h) !important; overflow-y: auto; }
    .wrap { max-width: 1750px; margin: 0 auto; padding: 16px 16px 24px; }

    /* Tabs */
    .tabs { display: flex; gap: 0; margin-bottom: 20px; background: var(--card); border-radius: 14px; padding: 4px; border: 1px solid var(--stroke); }
    .tab-btn { flex: 1; padding: 12px 16px; border: none; background: transparent; color: var(--muted); font-weight: 600; font-size: 14px; cursor: pointer; border-radius: 10px; display: flex; align-items: center; justify-content: center; gap: 8px; }
    .tab-btn:hover { color: var(--text); background: var(--surface); }
    .tab-btn.active { background: linear-gradient(135deg, var(--brand2), var(--brand)); color: #fff; }
    .tab-btn .tab-icon { font-size: 16px; }

    /* Info bar */
    .info-bar { display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; }
    .info-chip { padding: 8px 14px; border-radius: 10px; background: var(--card); border: 1px solid var(--stroke); font-size: 13px; display: flex; align-items: center; gap: 6px; }
    .info-chip b { color: var(--brand2); }

    /* Card */
    .card { background: var(--card); border: 1px solid var(--stroke); border-radius: 16px; box-shadow: var(--shadow); padding: 20px; margin-bottom: 16px; }
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 12px; }
    .card-title { font-size: 18px; font-weight: 700; margin: 0; display: flex; align-items: center; gap: 8px; }
    .card-title .icon { font-size: 20px; }

    /* Controls */
    .ctrls { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }
    .ctrls input, .ctrls select { padding: 10px 14px; border: 1px solid var(--stroke); border-radius: 10px; background: var(--surface); color: var(--text); font-size: 14px; }
    .ctrls .btn { padding: 10px 18px; border: none; border-radius: 10px; background: linear-gradient(135deg, var(--brand2), var(--brand)); color: #fff; font-weight: 600; cursor: pointer; }
    .ctrls .btn:hover { opacity: 0.9; }

    /* Date Navigation */
    .date-nav { display: flex; align-items: center; gap: 8px; }
    .date-nav-btn { width: 38px; height: 38px; border: 1px solid var(--stroke); background: var(--card); color: var(--text); border-radius: 10px; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; }
    .date-nav-btn:hover { background: var(--surface); border-color: var(--brand2); }
    .date-nav-label { font-size: 15px; font-weight: 700; min-width: 140px; text-align: center; color: var(--text); padding: 8px 12px; background: var(--surface); border: 1px solid var(--stroke); border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 6px; }
    .date-nav-label:hover { border-color: var(--brand2); background: var(--card); }
    .date-nav-label::after { content: 'üìÖ'; font-size: 14px; }
    .date-nav-input { position: absolute; opacity: 0; pointer-events: none; }

    /* Dashboard Cards */
    .dashboard-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; margin-bottom: 20px; }
    .dash-card { background: var(--card); border: 1px solid var(--stroke); border-radius: 16px; padding: 20px; position: relative; overflow: hidden; }
    .dash-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: linear-gradient(90deg, var(--brand2), var(--brand)); }
    .dash-card.next::before { background: linear-gradient(90deg, #10b981, #34d399); }
    .dash-card.stats::before { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
    .dash-card-header { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
    .dash-card-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
    .dash-card.next .dash-card-icon { background: rgba(16, 185, 129, 0.15); }
    .dash-card.stats .dash-card-icon { background: rgba(245, 158, 11, 0.15); }
    .dash-card-title { font-size: 13px; color: var(--muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    .dash-card-value { font-size: 24px; font-weight: 700; margin-bottom: 4px; }
    .dash-card-sub { font-size: 13px; color: var(--muted); }
    .dash-card .countdown { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; background: rgba(16, 185, 129, 0.1); border-radius: 6px; font-size: 12px; color: #10b981; font-weight: 600; margin-top: 8px; }

    /* Welcome */
    .welcome-section { background: linear-gradient(135deg, var(--brand2), var(--brand)); border-radius: 16px; padding: 24px; margin-bottom: 20px; color: #fff; }
    .welcome-title { font-size: 20px; font-weight: 700; margin-bottom: 4px; }
    .welcome-sub { opacity: 0.85; font-size: 14px; }

    /* N√∂bet list */
    .nobet-list { display: flex; flex-direction: column; gap: 8px; }
    .nobet-item { display: flex; align-items: center; gap: 12px; padding: 14px 16px; background: var(--surface); border: 1px solid var(--stroke); border-radius: 12px; }
    .nobet-status { width: 10px; height: 10px; border-radius: 50%; flex-shrink: 0; }
    .nobet-status.done { background: #10b981; }
    .nobet-status.upcoming { background: #3b82f6; }
    .nobet-status.planned { background: var(--muted); }
    .nobet-info { flex: 1; min-width: 0; }
    .nobet-date { font-weight: 600; font-size: 14px; }
    .nobet-day { color: var(--muted); font-size: 12px; }
    .nobet-time { font-weight: 700; color: var(--brand2); font-size: 14px; font-variant-numeric: tabular-nums; }
    .nobet-badge { padding: 4px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; }
    .nobet-badge.done { background: rgba(16, 185, 129, 0.15); color: #10b981; }
    .nobet-badge.upcoming { background: rgba(59, 130, 246, 0.15); color: #3b82f6; }
    .nobet-badge.planned { background: var(--pill); color: var(--muted); }

    /* Section title */
    .section-title { font-size: 15px; font-weight: 700; margin: 20px 0 12px; display: flex; align-items: center; gap: 8px; color: var(--text); }
    .section-title .icon { font-size: 16px; }

    /* ===== DESKTOP/TABLET TABLE ===== */
    .table-wrap { overflow: auto; -webkit-overflow-scrolling: touch; border-radius: 12px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { border-bottom: 1px solid var(--stroke); padding: 14px 12px; text-align: left; }
    thead th { font-size: 12px; color: var(--muted); font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
    tbody tr:nth-child(even) { background: var(--surface); }
    .time { font-variant-numeric: tabular-nums; font-weight: 700; color: var(--brand2); }
    .muted { color: var(--muted); }

    /* ===== DESKTOP/TABLET CALENDAR ===== */
    .cal-wrap { overflow-x: auto; margin-top: 12px; }
    .cal { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; min-width: 700px; }
    .cal-weekday { text-align: center; font-size: 12px; font-weight: 700; color: var(--muted); padding: 10px 4px; text-transform: uppercase; background: var(--surface); border-radius: 8px; }
    .cal-cell { border: 1px solid var(--stroke); background: var(--card); border-radius: 10px; padding: 10px; min-height: 100px; display: flex; flex-direction: column; }
    .cal-cell.empty { background: var(--surface); opacity: 0.5; }
    .cal-cell.today { border-color: var(--brand2); background: rgba(99, 102, 241, 0.05); }
    .cal-date { font-weight: 700; font-size: 14px; color: var(--text); margin-bottom: 6px; }
    .cal-time { font-size: 10px; font-weight: 600; color: var(--brand2); margin-bottom: 6px; }
    .cal-persons { display: flex; flex-direction: column; gap: 4px; flex: 1; }
    .cal-person { display: flex; align-items: center; gap: 6px; font-size: 11px; padding: 4px 6px; background: var(--surface); border-radius: 6px; }
    .cal-person-tag { font-weight: 800; font-size: 9px; padding: 2px 5px; border-radius: 3px; flex-shrink: 0; }
    .cal-person-tag.evli { background: rgba(16, 185, 129, 0.15); color: #10b981; }
    .cal-person-tag.bekar { background: rgba(59, 130, 246, 0.15); color: #3b82f6; }
    .cal-person-name { color: var(--text); overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

    /* ===== MOBILE CARD LIST (Haftalƒ±k) ===== */
    .mobile-week-list { display: none; flex-direction: column; gap: 10px; }
    .week-card { background: var(--surface); border: 1px solid var(--stroke); border-radius: 14px; padding: 16px; }
    .week-card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; padding-bottom: 10px; border-bottom: 1px solid var(--stroke); }
    .week-card-day { font-weight: 700; font-size: 16px; }
    .week-card-date { color: var(--muted); font-size: 13px; }
    .week-card-time { background: linear-gradient(135deg, var(--brand2), var(--brand)); color: #fff; padding: 6px 12px; border-radius: 8px; font-weight: 700; font-size: 13px; }
    .week-card-body { display: flex; flex-direction: column; gap: 10px; }
    .week-card-person { display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: var(--card); border-radius: 10px; }
    .week-card-person-icon { width: 36px; height: 36px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0; }
    .week-card-person-icon.evli { background: rgba(16, 185, 129, 0.15); }
    .week-card-person-icon.bekar { background: rgba(59, 130, 246, 0.15); }
    .week-card-person-info { flex: 1; }
    .week-card-person-role { font-size: 11px; color: var(--muted); text-transform: uppercase; font-weight: 600; }
    .week-card-person-name { font-size: 14px; font-weight: 600; }

    /* ===== MOBILE CALENDAR LIST (Aylƒ±k) ===== */
    .mobile-cal-list { display: none; flex-direction: column; gap: 8px; }
    .mcal-item { display: flex; align-items: stretch; background: var(--card); border: 1px solid var(--stroke); border-radius: 12px; overflow: hidden; }
    .mcal-date { width: 70px; flex-shrink: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 12px 8px; background: var(--surface); border-right: 1px solid var(--stroke); }
    .mcal-date-num { font-size: 22px; font-weight: 800; color: var(--text); line-height: 1; }
    .mcal-date-day { font-size: 11px; color: var(--muted); margin-top: 4px; }
    .mcal-content { flex: 1; padding: 12px 14px; display: flex; flex-direction: column; gap: 6px; }
    .mcal-time { font-size: 12px; font-weight: 700; color: var(--brand2); }
    .mcal-persons { display: flex; flex-direction: column; gap: 4px; }
    .mcal-person { display: flex; align-items: center; gap: 8px; font-size: 13px; }
    .mcal-person-label { font-size: 10px; font-weight: 700; padding: 2px 6px; border-radius: 4px; }
    .mcal-person-label.evli { background: rgba(16, 185, 129, 0.15); color: #10b981; }
    .mcal-person-label.bekar { background: rgba(59, 130, 246, 0.15); color: #3b82f6; }
    .mcal-person-name { color: var(--text); font-weight: 500; }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 900px) { 
      .cal { min-width: 600px; gap: 4px; }
      .cal-cell { padding: 8px; min-height: 90px; }
      .cal-date { font-size: 13px; }
    }

    @media (max-width: 768px) {
      .tabs { flex-direction: column; gap: 4px; }
      .tab-btn { justify-content: flex-start; padding: 14px 16px; }
      .dashboard-grid { grid-template-columns: 1fr; }
      .ctrls { flex-direction: column; align-items: stretch; }
      .ctrls input, .ctrls select, .ctrls .btn { width: 100%; }
      .info-bar { flex-direction: column; gap: 8px; }
      .info-chip { justify-content: center; }

      /* Mobilde tablo gizle, kart g√∂ster */
      .table-wrap { display: none; }
      .mobile-week-list { display: flex; }
      
      /* Mobilde grid gizle, liste g√∂ster */
      .cal { display: none; }
      .mobile-cal-list { display: flex; }
    }

    .page-end { height: 60px; }
  </style>

  <!-- Supabase (Auth + Database i√ßin) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../src/supabase.js"></script>
  <script src="../src/supabase-auth-wrapper.js"></script>
  <script defer src="../js/ortak.js"></script>
</head>

<body>

  <!-- √úST APPBAR (ortak.js + app-shell.css ile aynƒ± yapƒ±) -->
  <div class="appbar">
    <div class="brand" onclick="location.href='../panel.html'">
      <img src="../img/logo.png" alt="logo"><span>KARAAƒûA√á FATƒ∞H</span>
    </div>
    <nav class="nav-center">
      <ul class="nav-list" id="navMain"></ul>
    </nav>
    <div class="nav-right">
      <button class="btn hamb" id="hamburger" title="Men√º">‚ò∞</button>

      <!-- Bildirim -->
      <div class="nav-item">
        <button class="iconbtn" id="btnNotif" title="Bildirimler">üîî
          <span class="badge" id="notifBadge" style="display:none">0</span>
        </button>
        <div class="dropdown drop-right" id="notifDropdown" aria-label="Bildirim listesi">
          <div class="muted" style="padding:6px 8px">Son bildirimler</div>
          <div id="notifList" class="list" style="max-height:300px;overflow:auto"></div>
        </div>
      </div>

      <!-- Profil -->
      <div class="nav-item">
        <button class="iconbtn" id="btnProfile" title="Profil">
          <span class="avatar"></span> <span id="profName" class="muted">Profil</span>
        </button>
        <div class="dropdown drop-right" id="profDropdown" aria-label="Profil men√ºs√º">
          <a href="../diger/kullanici-yonetimi.html">üë§ Profil</a>
          <a href="../diger/sistem-ayarlari.html">‚öôÔ∏è Sistem Ayarlarƒ±</a>
          <a href="#" id="btnLogout">üö™ √áƒ±kƒ±≈ü Yap</a>
        </div>
      </div>
    </div>
  </div>
  <aside class="drawer" id="drawer"></aside>
  <div class="toast-container" id="toastContainer"></div>

  <!-- CONTENT -->
  <main class="wrap">
    <!-- Tabs -->
    <div class="tabs">
      <button class="tab-btn active" data-mode="hafta">
        <span class="tab-icon">üìÖ</span> Haftalƒ±k
      </button>
      <button class="tab-btn" data-mode="ay">
        <span class="tab-icon">üóìÔ∏è</span> Aylƒ±k
      </button>
      <button class="tab-btn" data-mode="personel">
        <span class="tab-icon">üë§</span> Benim N√∂betlerim
      </button>
    </div>

    <!-- Info Bar (Haftalƒ±k/Aylƒ±k i√ßin) -->
    <div class="info-bar" id="infoBar">
      <div class="info-chip">üìÜ <span id="todayText">‚Äî</span></div>
      <div class="info-chip">Hafta: <b id="outWeek">‚Äî</b></div>
      <div class="info-chip">√ñzel Pazar: <b id="sumPazar">‚Äî</b></div>
    </div>

    <!-- Genel G√∂r√ºn√ºm (Haftalƒ±k/Aylƒ±k) -->
    <section class="card" id="generalView">
      <div class="card-header">
        <h3 class="card-title" id="viewTitle"><span class="icon">üìÖ</span> Haftalƒ±k N√∂bet Takvimi</h3>
        <div class="ctrls" id="controls"></div>
      </div>
      <div id="results"></div>
    </section>

    <!-- Ki≈üisel Dashboard (Personel i√ßin) -->
    <section id="personalDashboard" style="display: none;">
      <!-- Ho≈ügeldin -->
      <div class="welcome-section">
        <div class="welcome-title">üëã Merhaba, <span id="welcomeName">‚Äî</span></div>
        <div class="welcome-sub">N√∂bet takviminize ho≈ü geldiniz</div>
      </div>

      <!-- Dashboard Kartlarƒ± -->
      <div class="dashboard-grid">
        <div class="dash-card next">
          <div class="dash-card-header">
            <div class="dash-card-icon">üîú</div>
            <div class="dash-card-title">Sƒ±radaki N√∂bet</div>
          </div>
          <div class="dash-card-value" id="nextNobetDate">‚Äî</div>
          <div class="dash-card-sub" id="nextNobetTime">‚Äî</div>
          <div class="countdown" id="nextNobetCountdown">‚Äî g√ºn kaldƒ±</div>
        </div>
        <div class="dash-card stats">
          <div class="dash-card-header">
            <div class="dash-card-icon">üìä</div>
            <div class="dash-card-title" id="statsYearTitle">2026 √ñzeti</div>
          </div>
          <div style="display: flex; gap: 20px; margin-top: 8px;">
            <div>
              <div class="dash-card-value" id="statTotal">0</div>
              <div class="dash-card-sub">Toplam</div>
            </div>
            <div>
              <div class="dash-card-value" id="statDone">0</div>
              <div class="dash-card-sub">Tamamlanan</div>
            </div>
            <div>
              <div class="dash-card-value" id="statRemaining">0</div>
              <div class="dash-card-sub">Kalan</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Yƒ±l Se√ßici -->
      <div class="ctrls" style="margin-bottom: 16px;">
        <select id="personalYear"></select>
        <button class="btn" id="btnRefreshPersonal">Yenile</button>
      </div>

      <!-- N√∂bet Listesi -->
      <div class="card">
        <h3 class="section-title"><span class="icon">üìã</span> Hafta ƒ∞√ßi N√∂betlerim</h3>
        <div class="nobet-list" id="weekdayList"></div>
      </div>

      <div class="card">
        <h3 class="section-title"><span class="icon">üåÖ</span> Pazar N√∂betlerim</h3>
        <div class="nobet-list" id="sundayList"></div>
      </div>
    </section>

    <div class="page-end"></div>
  </main>

  <script>
    window.initPage = async function () {
      const supabase = window.supabase;
      if (!supabase) { console.error('Supabase client y√ºklenmedi'); return; }
      const toast = (msg, type = 'info') => window.showToast?.(type, 'Bilgi', msg);
      const escapeHtml = window.escapeHtml || ((text) => { const div = document.createElement('div'); div.textContent = text; return div.innerHTML; });

      const dayNames = ['Pazar', 'Pazartesi', 'Salƒ±', '√áar≈üamba', 'Per≈üembe', 'Cuma', 'Cumartesi'];
      function setToday() { const d = new Date(); document.getElementById('todayText').textContent = `${String(d.getDate()).padStart(2, '0')}.${String(d.getMonth() + 1).padStart(2, '0')}.${d.getFullYear()} ‚Ä¢ ${dayNames[d.getDay()]}`; }
      function fmtTR(iso) { const d = new Date(iso + 'T12:00:00'); return `${String(d.getDate()).padStart(2, '0')}.${String(d.getMonth() + 1).padStart(2, '0')}.${d.getFullYear()}`; }
      function isoWeek(date) { const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate())); const day = d.getUTCDay() || 7; d.setUTCDate(d.getUTCDate() + 4 - day); const yStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1)); const w = Math.ceil((((d - yStart) / 86400000) + 1) / 7); return { isoYear: d.getUTCFullYear(), weekNo: w }; }
      function weekKeyFrom(date) { const { isoYear, weekNo } = isoWeek(date); return `${isoYear}-W${('0' + weekNo).slice(-2)}`; }
      function gunTR(y, m, d) { const t = new Date(y, m - 1, d); return dayNames[t.getDay()]; }
      function daysDiff(d1, d2) { return Math.ceil((d2 - d1) / (1000 * 60 * 60 * 24)); }

      const controls = document.getElementById('controls');
      const infoBar = document.getElementById('infoBar');
      const generalView = document.getElementById('generalView');
      const personalDashboard = document.getElementById('personalDashboard');
      const viewTitle = document.getElementById('viewTitle');
      let currentMode = 'hafta';

      document.querySelectorAll('.tab-btn').forEach(b => b.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(x => x.classList.remove('active'));
        b.classList.add('active');
        currentMode = b.dataset.mode;
        switchView();
      }));

      function switchView() {
        if (currentMode === 'personel') {
          infoBar.style.display = 'none';
          generalView.style.display = 'none';
          personalDashboard.style.display = 'block';
          loadPersonalDashboard();
        } else {
          infoBar.style.display = 'flex';
          generalView.style.display = 'block';
          personalDashboard.style.display = 'none';
          buildControls();
        }
      }

      let currentWeekDate = new Date();
      let currentMonthDate = new Date();

      function buildControls() {
        const res = document.getElementById('results'); res.innerHTML = '';
        if (currentMode === 'hafta') {
          viewTitle.innerHTML = '<span class="icon">üìÖ</span> Haftalƒ±k N√∂bet Takvimi';
          controls.innerHTML = `
            <div class="date-nav">
              <button class="date-nav-btn" id="prevWeek" title="√ñnceki Hafta">‚óÄ</button>
              <span class="date-nav-label" id="weekLabel">‚Äî</span>
              <input type="date" class="date-nav-input" id="weekDatePicker">
              <button class="date-nav-btn" id="nextWeek" title="Sonraki Hafta">‚ñ∂</button>
            </div>
            <button class="btn" id="btnTodayWeek">Bug√ºn</button>`;
          const weekPicker = document.getElementById('weekDatePicker');
          document.getElementById('prevWeek').onclick = () => { currentWeekDate.setDate(currentWeekDate.getDate() - 7); loadWeek(currentWeekDate); };
          document.getElementById('nextWeek').onclick = () => { currentWeekDate.setDate(currentWeekDate.getDate() + 7); loadWeek(currentWeekDate); };
          document.getElementById('btnTodayWeek').onclick = () => { currentWeekDate = new Date(); loadWeek(currentWeekDate); };
          document.getElementById('weekLabel').onclick = () => { try { weekPicker.showPicker(); } catch(e) { weekPicker.click(); } };
          weekPicker.onchange = (e) => { if(e.target.value) { currentWeekDate = new Date(e.target.value + 'T12:00:00'); loadWeek(currentWeekDate); } };
          currentWeekDate = new Date();
          loadWeek(currentWeekDate);
        } else if (currentMode === 'ay') {
          viewTitle.innerHTML = '<span class="icon">üóìÔ∏è</span> Aylƒ±k N√∂bet Takvimi';
          controls.innerHTML = `
            <div class="date-nav">
              <button class="date-nav-btn" id="prevMonth" title="√ñnceki Ay">‚óÄ</button>
              <span class="date-nav-label" id="monthLabel">‚Äî</span>
              <input type="month" class="date-nav-input" id="monthPicker">
              <button class="date-nav-btn" id="nextMonth" title="Sonraki Ay">‚ñ∂</button>
            </div>
            <button class="btn" id="btnTodayMonth">Bu Ay</button>`;
          const monthPicker = document.getElementById('monthPicker');
          document.getElementById('prevMonth').onclick = () => { currentMonthDate.setMonth(currentMonthDate.getMonth() - 1); loadMonthNav(); };
          document.getElementById('nextMonth').onclick = () => { currentMonthDate.setMonth(currentMonthDate.getMonth() + 1); loadMonthNav(); };
          document.getElementById('btnTodayMonth').onclick = () => { currentMonthDate = new Date(); loadMonthNav(); };
          document.getElementById('monthLabel').onclick = () => { try { monthPicker.showPicker(); } catch(e) { monthPicker.click(); } };
          monthPicker.onchange = (e) => { if(e.target.value) { const [y, m] = e.target.value.split('-'); currentMonthDate = new Date(y, m - 1, 1); loadMonthNav(); } };
          currentMonthDate = new Date();
          loadMonthNav();
        }
      }

      function loadMonthNav() {
        const ym = `${currentMonthDate.getFullYear()}-${String(currentMonthDate.getMonth() + 1).padStart(2, '0')}`;
        const monthNames = ['Ocak', '≈ûubat', 'Mart', 'Nisan', 'Mayƒ±s', 'Haziran', 'Temmuz', 'Aƒüustos', 'Eyl√ºl', 'Ekim', 'Kasƒ±m', 'Aralƒ±k'];
        document.getElementById('monthLabel').textContent = `${monthNames[currentMonthDate.getMonth()]} ${currentMonthDate.getFullYear()}`;
        loadMonth(ym);
      }

      /* === Haftalƒ±k === */
      async function loadWeek(date) {
        const key = weekKeyFrom(date);
        document.getElementById('outWeek').textContent = key;
        const weekLabelEl = document.getElementById('weekLabel');
        if (weekLabelEl) {
          const monday = new Date(date);
          const day = monday.getDay();
          const diff = monday.getDate() - day + (day === 0 ? -6 : 1);
          monday.setDate(diff);
          const sunday = new Date(monday);
          sunday.setDate(monday.getDate() + 6);
          weekLabelEl.textContent = `${String(monday.getDate()).padStart(2,'0')}.${String(monday.getMonth()+1).padStart(2,'0')} - ${String(sunday.getDate()).padStart(2,'0')}.${String(sunday.getMonth()+1).padStart(2,'0')}`;
        }
        try {
          const { data, error } = await supabase.from('nobet_planlari').select('id, isspecialpazar, ispazartehir, rows').eq('id', key).single();
          if (error || !data) { 
            document.getElementById('results').innerHTML = '<div class="muted" style="padding:20px;text-align:center;">Bu hafta i√ßin plan bulunamadƒ±</div>'; 
            document.getElementById('sumPazar').textContent = '‚Äî'; 
            return; 
          }
          document.getElementById('sumPazar').textContent = data.isspecialpazar ? 'Var' : (data.ispazartehir ? 'Tehir' : 'Yok');
          
          const dataRows = data.rows || [];
          
          const desktopRows = dataRows.map(r => `
            <tr>
              <td>${escapeHtml(r.gun || '')}</td>
              <td>${fmtTR(r.tarihISO || '')}</td>
              <td class="time">${escapeHtml(r.saat || '')}</td>
              <td>${escapeHtml(r.bekar || '') || '<span class="muted">‚Äî</span>'}</td>
              <td>${escapeHtml(r.evli || '') || '<span class="muted">‚Äî</span>'}</td>
            </tr>`).join('');
          
          const mobileCards = dataRows.map(r => `
            <div class="week-card">
              <div class="week-card-header">
                <div>
                  <div class="week-card-day">${escapeHtml(r.gun || '')}</div>
                  <div class="week-card-date">${fmtTR(r.tarihISO || '')}</div>
                </div>
                <div class="week-card-time">${escapeHtml(r.saat || '')}</div>
              </div>
              <div class="week-card-body">
                <div class="week-card-person">
                  <div class="week-card-person-icon evli">üë®</div>
                  <div class="week-card-person-info">
                    <div class="week-card-person-role">Evli N√∂bet√ßi</div>
                    <div class="week-card-person-name">${escapeHtml(r.evli || '') || '‚Äî'}</div>
                  </div>
                </div>
                <div class="week-card-person">
                  <div class="week-card-person-icon bekar">üë§</div>
                  <div class="week-card-person-info">
                    <div class="week-card-person-role">Bek√¢r N√∂bet√ßi</div>
                    <div class="week-card-person-name">${escapeHtml(r.bekar || '') || '‚Äî'}</div>
                  </div>
                </div>
              </div>
            </div>`).join('');
          
          document.getElementById('results').innerHTML = `
            <div class="table-wrap">
              <table>
                <thead><tr><th>G√ºn</th><th>Tarih</th><th>Saat</th><th>Bek√¢r</th><th>Evli</th></tr></thead>
                <tbody>${desktopRows}</tbody>
              </table>
            </div>
            <div class="mobile-week-list">${mobileCards}</div>`;
        } catch (e) { console.error(e); toast('Hata'); }
      }

      /* === Aylƒ±k === */
      async function loadMonth(ym) {
        const wrap = document.getElementById('results'); wrap.innerHTML = '';
        if (!ym) return;
        try {
          const { data: indexData, error: indexError } = await supabase.from('nobet_index').select('date, role, person, saat').eq('monthkey', ym);
          if (indexError) { wrap.innerHTML = '<div class="muted" style="padding:20px;text-align:center;">Veri y√ºklenemedi</div>'; return; }
          
          const byDate = {};
          (indexData || []).forEach(x => { 
            const dt = x.date; 
            if (!dt) return; 
            if (!byDate[dt]) byDate[dt] = { b: new Set(), e: new Set(), s: new Set() }; 
            if (x.role === 'bekar') byDate[dt].b.add(x.person); 
            else if (x.role === 'evli' || x.role === 'ihvan') byDate[dt].e.add(x.person); 
            if (x.saat) byDate[dt].s.add(x.saat); 
          });
          
          const [Y, M] = ym.split('-').map(Number);
          if (!Y || !M || M < 1 || M > 12) { wrap.innerHTML = '<div class="muted">Ge√ßersiz ay</div>'; return; }
          
          const daysInMonth = new Date(Y, M, 0).getDate();
          const startPad = (new Date(Y, M - 1, 1).getDay() + 6) % 7;
          const todayISO = new Date().toISOString().slice(0, 10);
          
          const calWrap = document.createElement('div');
          calWrap.className = 'cal-wrap';
          
          const grid = document.createElement('div'); 
          grid.className = 'cal';
          
          const weekDays = ['Pzt', 'Sal', '√áar', 'Per', 'Cum', 'Cmt', 'Paz'];
          weekDays.forEach(day => {
            const hdr = document.createElement('div');
            hdr.className = 'cal-weekday';
            hdr.textContent = day;
            grid.appendChild(hdr);
          });
          
          for (let i = 0; i < startPad; i++) { 
            const c = document.createElement('div'); 
            c.className = 'cal-cell empty'; 
            grid.appendChild(c); 
          }
          
          const mobileList = document.createElement('div');
          mobileList.className = 'mobile-cal-list';
          
          for (let d = 1; d <= daysInMonth; d++) {
            const iso = `${Y}-${String(M).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
            const info = byDate[iso] || { b: new Set(), e: new Set(), s: new Set() };
            const dayName = gunTR(Y, M, d);
            const saatStr = [...info.s].join('+');
            const evliNames = [...info.e].map(n => escapeHtml(n));
            const bekarNames = [...info.b].map(n => escapeHtml(n));
            const hasData = evliNames.length || bekarNames.length;
            const isToday = iso === todayISO;
            
            const cell = document.createElement('div'); 
            cell.className = 'cal-cell' + (isToday ? ' today' : '');
            
            let cellHTML = `<div class="cal-date">${d}</div>`;
            if (saatStr) cellHTML += `<div class="cal-time">${saatStr}</div>`;
            cellHTML += '<div class="cal-persons">';
            
            evliNames.forEach(name => {
              cellHTML += `<div class="cal-person"><span class="cal-person-tag evli">E</span><span class="cal-person-name">${name}</span></div>`;
            });
            bekarNames.forEach(name => {
              cellHTML += `<div class="cal-person"><span class="cal-person-tag bekar">B</span><span class="cal-person-name">${name}</span></div>`;
            });
            cellHTML += '</div>';
            cell.innerHTML = cellHTML;
            grid.appendChild(cell);
            
            if (hasData) {
              let mobileItem = `
                <div class="mcal-item">
                  <div class="mcal-date">
                    <div class="mcal-date-num">${String(d).padStart(2, '0')}</div>
                    <div class="mcal-date-day">${dayName}</div>
                  </div>
                  <div class="mcal-content">
                    ${saatStr ? `<div class="mcal-time">${saatStr}</div>` : ''}
                    <div class="mcal-persons">`;
              evliNames.forEach(name => {
                mobileItem += `<div class="mcal-person"><span class="mcal-person-label evli">E</span><span class="mcal-person-name">${name}</span></div>`;
              });
              bekarNames.forEach(name => {
                mobileItem += `<div class="mcal-person"><span class="mcal-person-label bekar">B</span><span class="mcal-person-name">${name}</span></div>`;
              });
              mobileItem += '</div></div></div>';
              mobileList.innerHTML += mobileItem;
            }
          }
          
          const endPad = (7 - ((startPad + daysInMonth) % 7)) % 7;
          for (let i = 0; i < endPad; i++) { 
            const c = document.createElement('div'); 
            c.className = 'cal-cell empty'; 
            grid.appendChild(c); 
          }
          
          calWrap.appendChild(grid);
          wrap.appendChild(calWrap);
          wrap.appendChild(mobileList);
        } catch (e) { console.error(e); toast('Aylƒ±k g√∂r√ºn√ºm y√ºklenemedi', 'error'); }
      }

      /* === Ki≈üisel Dashboard === */
      async function loadPersonalDashboard() {
        const person = window.__ME_PERSON__;
        if (!person) { document.getElementById('weekdayList').innerHTML = '<div class="muted">Kullanƒ±cƒ± e≈üle≈ümedi</div>'; return; }
        document.getElementById('welcomeName').textContent = person;
        const ySel = document.getElementById('personalYear');
        const yr = new Date().getFullYear();
        if (!ySel.options.length) {
          ySel.innerHTML = [yr - 1, yr, yr + 1].map(y => `<option ${y === yr ? 'selected' : ''}>${y}</option>`).join('');
          document.getElementById('btnRefreshPersonal').onclick = () => loadPersonalDashboard();
        }
        const selectedYear = ySel.value || yr;
        document.getElementById('statsYearTitle').textContent = `${selectedYear} √ñzeti`;

        try {
          const { data, error } = await supabase.from('nobet_index').select('date, day, saat, role, type, year').eq('person', person);
          if (error) { toast('Veriler y√ºklenemedi', 'error'); return; }
          const all = (data || []).filter(x => String(x.year) === String(selectedYear)).sort((a, b) => (a.date || '').localeCompare(b.date || ''));
          const today = new Date(); today.setHours(0, 0, 0, 0);
          const todayISO = today.toISOString().slice(0, 10);

          // Stats
          const total = all.length;
          const done = all.filter(x => x.date < todayISO).length;
          const remaining = total - done;
          document.getElementById('statTotal').textContent = total;
          document.getElementById('statDone').textContent = done;
          document.getElementById('statRemaining').textContent = remaining;

          // Next n√∂bet
          const upcoming = all.filter(x => x.date >= todayISO);
          if (upcoming.length) {
            const next = upcoming[0];
            document.getElementById('nextNobetDate').textContent = `${fmtTR(next.date)} ${next.day}`;
            document.getElementById('nextNobetTime').textContent = next.saat || '‚Äî';
            const diff = daysDiff(today, new Date(next.date + 'T12:00:00'));
            document.getElementById('nextNobetCountdown').textContent = diff === 0 ? 'Bug√ºn!' : diff === 1 ? 'Yarƒ±n!' : `${diff} g√ºn kaldƒ±`;
          } else {
            document.getElementById('nextNobetDate').textContent = '‚Äî';
            document.getElementById('nextNobetTime').textContent = 'Planlanmƒ±≈ü n√∂bet yok';
            document.getElementById('nextNobetCountdown').textContent = '‚Äî';
          }

          // Lists
          const haftaiciDays = new Set(['Pazartesi', 'Salƒ±', '√áar≈üamba', 'Per≈üembe', 'Cuma', 'Cumartesi']);
          const isEvli = all.some(x => x.role === 'evli' || x.role === 'ihvan');
          const weekdays = all.filter(x => x.type === '24s' && haftaiciDays.has(x.day));
          const sundays = isEvli ? all.filter(x => x.day === 'Pazar' && x.type === 'pazar-gunduz') : all.filter(x => x.day === 'Pazar' && x.type === 'pazar-aksam');

          const renderList = (items, container) => {
            if (!items.length) { document.getElementById(container).innerHTML = '<div class="muted" style="padding:16px;text-align:center;">Kayƒ±t yok</div>'; return; }
            document.getElementById(container).innerHTML = items.map(r => {
              const isPast = r.date < todayISO;
              const isToday = r.date === todayISO;
              const statusClass = isPast ? 'done' : (isToday || (upcoming[0] && r.date === upcoming[0].date) ? 'upcoming' : 'planned');
              const badgeText = isPast ? 'Tamamlandƒ±' : (isToday ? 'Bug√ºn' : (upcoming[0] && r.date === upcoming[0].date ? 'Sƒ±radaki' : 'Planlandƒ±'));
              return `<div class="nobet-item"><div class="nobet-status ${statusClass}"></div><div class="nobet-info"><div class="nobet-date">${fmtTR(r.date)}</div><div class="nobet-day">${r.day}</div></div><div class="nobet-time">${escapeHtml(r.saat || '‚Äî')}</div><div class="nobet-badge ${statusClass}">${badgeText}</div></div>`;
            }).join('');
          };
          renderList(weekdays, 'weekdayList');
          renderList(sundays, 'sundayList');
        } catch (e) { console.error(e); toast('Hata', 'error'); }
      }

      // Init
      setToday();
      try {
        const { data: { user }, error: userError } = await supabase.auth.getUser();
        if (userError || !user) { console.error('Auth hatasƒ±:', userError); return; }
        const { data: userData } = await supabase.from('kullanicilar').select('adsoyad').eq('id', user.id).single();
        const myPreferred = (userData?.adsoyad || user.email?.split('@')[0] || '').trim();
        let me = myPreferred;
        try {
          const { data: indexData } = await supabase.from('nobet_index').select('person').limit(400);
          const persons = [...new Set((indexData || []).map(d => (d.person || '').trim()).filter(Boolean))];
          me = persons.find(p => p.toLowerCase() === myPreferred.toLowerCase()) || persons.find(p => p.toLowerCase().startsWith(myPreferred.toLowerCase())) || persons[0] || myPreferred;
        } catch (e) { console.error(e); }
        window.__ME_PERSON__ = me;
        switchView();
        try { await supabase.from('islem_log').insert({ islem: 'sayfa_acildi', uid: user?.id || null, sayfa: 'nobet', path: 'personel/nobet.html', user_agent: navigator?.userAgent || null }); } catch (e) {}
      } catch (e) { console.error(e); toast('Veriler y√ºklenirken hata', 'error'); }
    };
  </script>
</body>

</html>