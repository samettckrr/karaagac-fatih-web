<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8" />
  <title>N√∂bet Planƒ± | Karaaƒüa√ß Fatih</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <link rel="icon" type="image/png" href="../img/logo.png" />
  <link rel="stylesheet" href="../css/app-shell.css" />

  <style>
    /* app-shell.css √ºst bar/arka plan/toast/yetki yapƒ±sƒ±nƒ± saƒülar.
     Burada sayfa-√∂zel stiller kaldƒ±. */
    html,
    body {
      height: 100%;
      overflow-x: hidden;
    }

    body {
      padding-top: var(--appbar-h) !important;
      overflow-y: auto;
    }

    /* CONTENT */
    .wrap {
      max-width: 1100px;
      margin: 0 auto;
      padding: 16px 16px 24px
    }

    .hero {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      padding: 16px;
      margin: 16px 0;
      box-shadow: var(--shadow)
    }

    .hero h2 {
      margin: 0 0 6px;
      font-size: 20px
    }

    .hero-sub {
      color: var(--muted);
      font-size: 13px
    }

    .mini {
      display: flex;
      gap: 8px;
      flex-wrap: wrap
    }

    .pill {
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--stroke);
      background: var(--pill);
      font-size: 12px
    }

    .card {
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px;
      margin-bottom: 16px
    }

    .card h3 {
      margin: 0 0 10px;
      font-size: 16px;
      display: flex;
      justify-content: space-between;
      align-items: center
    }

    .toolbar {
      display: flex;
      gap: 8px;
      flex-wrap: wrap
    }

    .tbtn {
      border: 1px solid var(--stroke);
      background: var(--pill);
      color: var(--text);
      padding: 8px 12px;
      border-radius: 10px;
      cursor: pointer;
      font-weight: 700
    }

    .tbtn.active {
      background: linear-gradient(90deg, var(--brand2), var(--brand));
      color: #fff;
      border-color: transparent
    }

    .ctrls {
      margin-top: 10px;
      display: flex;
      gap: 8px;
      flex-wrap: nowrap;
      /* Yan yana olsun, alt alta ge√ßmesin */
      align-items: center;
      /* Dikey hizalama */
      width: 100%;
      /* Kart geni≈üliƒüinde */
      max-width: 100%;
      /* Ta≈ümasƒ±n */
      box-sizing: border-box;
      /* Padding dahil */
      overflow: hidden;
      /* Ta≈üan i√ßeriƒüi gizle */
    }

    .ctrls input,
    .ctrls select {
      padding: 8px 10px;
      border: 1px solid var(--stroke);
      border-radius: 10px;
      background: var(--pill);
      color: var(--text);
      flex: 1 1 auto;
      /* Geni≈ülesin ama ta≈ümasƒ±n */
      min-width: 0;
      /* Minimum geni≈ülik sƒ±nƒ±rƒ± yok */
      max-width: 100%;
      /* Ta≈ümasƒ±n */
      box-sizing: border-box;
      /* Padding dahil */
    }

    .ctrls button {
      flex: 0 0 auto;
      /* Buton geni≈ülemesin */
      white-space: nowrap;
      /* Buton metni kƒ±rƒ±lmasƒ±n */
      min-width: fit-content;
      /* Buton i√ßeriƒüine g√∂re geni≈ülik */
      max-width: 100%;
      /* Ta≈ümasƒ±n */
    }

    table {
      width: 100%;
      border-collapse: collapse
    }

    th,
    td {
      border-bottom: 1px solid var(--stroke);
      padding: 12px 10px;
      text-align: left
    }

    thead th {
      font-size: 12px;
      color: var(--muted)
    }

    .time {
      font-variant-numeric: tabular-nums;
      font-weight: 700;
      color: var(--brand2)
    }

    .muted {
      color: var(--muted)
    }

    .caret {
      font-size: 12px;
      opacity: .6
    }

    .mobile-only {
      display: none
    }

    .desktop-only {
      display: block
    }

    @media (max-width:640px) {
      .mobile-only {
        display: block
      }

      .desktop-only {
        display: none
      }

      .card h3 {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px
      }

      .toolbar {
        display: grid;
        gap: 8px;
        width: 100%;
        grid-template-columns: 1fr 1fr
      }

      .toolbar .tbtn {
        width: 100%
      }

      .toolbar .tbtn.primary {
        grid-column: 1 / -1
      }

      .ctrls {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
        /* Mobilde wrap olsun */
        align-items: center;
      }

      .ctrls input,
      .ctrls select {
        flex: 1 1 auto;
        /* Mobilde geni≈ülesin */
        min-width: 120px;
        /* Mobilde minimum geni≈ülik */
      }

      .ctrls button {
        flex: 0 0 auto;
        /* Buton geni≈ülemesin */
      }
    }

    /* Aylƒ±k grid */
    .cal {
      display: grid;
      gap: 8px;
      grid-template-columns: repeat(7, 1fr);
      grid-auto-rows: auto;
      /* Otomatik y√ºkseklik */
      margin-top: 10px;
    }

    .cal-cell {
      border: 1px solid var(--stroke);
      background: var(--surface);
      border-radius: 12px;
      padding: 6px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      /* Gap'i artƒ±rdƒ±m */
      overflow: hidden;
      min-width: 0;
      max-width: 100%;
      min-height: 120px;
      position: relative;
      align-items: stretch;
    }

    .cal-date {
      font-weight: 800;
      font-size: 11px;
      color: var(--muted);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      flex: 0 0 auto;
      line-height: 1.3;
      width: 100%;
      max-width: 100%;
      margin-bottom: 2px;
      /* Tarih altƒ±na bo≈üluk */
    }

    .cal .time {
      font-size: 10px;
      font-weight: 600;
      color: var(--muted);
      opacity: .9;
      flex: 0 0 auto;
      line-height: 1.3;
      width: 100%;
      max-width: 100%;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      margin-bottom: 4px;
      /* Saat altƒ±na daha fazla bo≈üluk - badge'lerden ayrƒ±lsƒ±n */
      margin-top: 2px;
      /* Saat √ºst√ºne bo≈üluk */
    }

    .cal-cell .badge {
      display: flex !important;
      align-items: flex-start !important;
      /* Soldan hizalƒ± */
      justify-content: flex-start !important;
      /* ƒ∞√ßerik soldan ba≈ülasƒ±n */
      gap: 4px;
      border: 1px solid var(--stroke);
      border-radius: 8px;
      padding: 4px 6px;
      font-size: 10px;
      background: var(--card);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      width: 100% !important;
      max-width: 100% !important;
      min-width: 0 !important;
      flex: 0 0 auto;
      box-sizing: border-box !important;
      position: relative !important;
      margin-top: 2px !important;
      margin-bottom: 0 !important;
      margin-left: 0 !important;
      margin-right: 0 !important;
      text-align: left !important;
      /* Chip kartƒ± soldan hizalƒ± */
      /* Animasyonlarƒ± tamamen kapat */
      transition: none !important;
      animation: none !important;
      transform: none !important;
      will-change: auto !important;
    }

    .cal-cell .badge:hover {
      transform: none !important;
      transition: none !important;
    }

    .cal-cell .badge.role-e {
      order: 3;
      margin-top: 4px !important;
    }

    .cal-cell .badge.role-b {
      order: 4;
      margin-top: 2px !important;
    }

    /* Badge i√ßindeki metin i√ßin ekstra koruma - KAYMAYI ENGELLE */
    .cal-cell .badge *,
    .cal-cell .badge span {
      overflow: hidden !important;
      text-overflow: ellipsis !important;
      white-space: nowrap !important;
      max-width: 100% !important;
      min-width: 0 !important;
      flex: 1 1 0 !important;
      display: block !important;
      word-break: normal !important;
      word-wrap: normal !important;
      overflow-wrap: normal !important;
      text-align: left !important;
      /* ƒ∞sim soldan hizalƒ± */
      margin: 0 !important;
      padding: 0 !important;
    }

    /* Role etiketleri (B:, E:) i√ßin */
    .cal-cell .badge.role-b::before,
    .cal-cell .badge.role-e::before {
      flex-shrink: 0 !important;
      flex-grow: 0 !important;
      flex-basis: auto !important;
    }

    .role-b::before {
      content: "B:";
      font-weight: 800;
      flex-shrink: 0;
      margin-right: 2px;
    }

    .role-e::before {
      content: "E:";
      font-weight: 800;
      flex-shrink: 0;
      margin-right: 2px;
    }

    @media (max-width:1024px) {
      .cal {
        grid-template-columns: repeat(2, 1fr)
      }
    }

    /* Haftalƒ±k g√∂r√ºn√ºm ‚Äì tek tablo, mobilde tablo scroll */
    .table-wrap {
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      border-radius: 12px
    }

    /* Personel tablosu */
    .per-table {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed
    }

    .per-table th,
    .per-table td {
      border-bottom: 1px solid var(--stroke);
      padding: 10px 8px
    }

    .per-table thead th {
      font-size: 12px;
      color: var(--muted)
    }

    .per-table td:nth-child(1) {
      width: 26%
    }

    .per-table td:nth-child(2) {
      width: 26%
    }

    .per-table td:nth-child(3) {
      width: 26%
    }

    .per-table td:nth-child(4) {
      width: 22%
    }

    td,
    .badge {
      word-break: break-word;
      overflow-wrap: anywhere
    }

    .page-end {
      height: 84px;
      margin-top: 16px;
      background: linear-gradient(180deg, rgba(2, 6, 23, 0), rgba(2, 6, 23, .08) 45%, rgba(2, 6, 23, .12));
      border-top: 1px solid var(--stroke);
      border-bottom-left-radius: 16px;
      border-bottom-right-radius: 16px;
    }

    /* === Mobil tablo iyile≈ütirmeleri (yalnƒ±zca ‚â§640px) === */
    @media (max-width:640px) {

      /* Sayfa deƒüil tablo kayacak */
      .table-wrap {
        overflow: auto;
        -webkit-overflow-scrolling: touch
      }

      /* Tablo geni≈üliƒüi sabit olsun ki metinler kƒ±rƒ±lmasƒ±n */
      .table-wrap table {
        min-width: 560px;
        border-collapse: separate;
        border-spacing: 0
      }

      /* G√ºn, tarih, saat ve ki≈üiler TEK satƒ±r kalsƒ±n */
      .weekly-table th,
      .weekly-table td,
      .per-table th,
      .per-table td {
        white-space: nowrap
      }

      /* Saatler daha kompakt */
      .weekly-table .time,
      .per-table .time {
        white-space: nowrap;
        font-size: 12px;
      }

      /* ƒ∞lk iki kolon i√ßin minimum geni≈ülik (okunurluk) */
      .weekly-table th:nth-child(1),
      .weekly-table td:nth-child(1) {
        min-width: 80px
      }

      .weekly-table th:nth-child(2),
      .weekly-table td:nth-child(2) {
        min-width: 80px
      }

      /* Satƒ±r i√ßi notlar mobilde gizlensin (ta≈ümayƒ± azaltƒ±r) */
      .note-inline {
        display: none
      }
    }
  </style>

  <!-- Supabase (Auth + Database i√ßin) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="../src/supabase.js"></script>
  <script src="../src/supabase-auth-wrapper.js"></script>
  <script defer src="../js/ortak.js"></script>
</head>

<body>

  <!-- √úST APPBAR (ortak.js + app-shell.css ile aynƒ± yapƒ±) -->
  <div class="appbar">
    <div class="brand" onclick="location.href='../panel.html'">
      <img src="../img/logo.png" alt="logo"><span>KARAAƒûA√á FATƒ∞H</span>
    </div>
    <nav class="nav-center">
      <ul class="nav-list" id="navMain"></ul>
    </nav>
    <div class="nav-right">
      <button class="btn hamb" id="hamburger" title="Men√º">‚ò∞</button>

      <!-- Bildirim -->
      <div class="nav-item">
        <button class="iconbtn" id="btnNotif" title="Bildirimler">üîî
          <span class="badge" id="notifBadge" style="display:none">0</span>
        </button>
        <div class="dropdown drop-right" id="notifDropdown" aria-label="Bildirim listesi">
          <div class="muted" style="padding:6px 8px">Son bildirimler</div>
          <div id="notifList" class="list" style="max-height:300px;overflow:auto"></div>
        </div>
      </div>

      <!-- Profil -->
      <div class="nav-item">
        <button class="iconbtn" id="btnProfile" title="Profil">
          <span class="avatar"></span> <span id="profName" class="muted">Profil</span>
        </button>
        <div class="dropdown drop-right" id="profDropdown" aria-label="Profil men√ºs√º">
          <a href="../diger/kullanici-yonetimi.html">üë§ Profil</a>
          <a href="../diger/sistem-ayarlari.html">‚öôÔ∏è Sistem Ayarlarƒ±</a>
          <a href="#" id="btnLogout">üö™ √áƒ±kƒ±≈ü Yap</a>
        </div>
      </div>
    </div>
  </div>
  <aside class="drawer" id="drawer"></aside>
  <div class="toast-container" id="toastContainer"></div>

  <!-- CONTENT -->
  <main class="wrap">
    <section class="hero">
      <div>
        <h2>N√∂bet Planƒ±</h2>
        <div class="hero-sub">Bug√ºn: <span id="todayText">‚Äî</span></div>
        <div class="mini">
          <span class="pill">Hafta: <b id="outWeek">‚Äî</b></span>
          <span class="pill">√ñzel Pazar: <b id="sumPazar">‚Äî</b></span>
        </div>
      </div>
      <!-- Tema artƒ±k app-shell.css + ortak.js √ºzerinden y√∂netilir -->
    </section>

    <section class="card">
      <h3>
        <span>N√∂bet G√∂r√ºn√ºmleri</span>
        <div class="toolbar">
          <button class="tbtn primary active" data-mode="hafta">Haftalƒ±k N√∂bet Takvimi</button>
          <button class="tbtn" data-mode="ay">Aylƒ±k N√∂bet Takvimi</button>
          <button class="tbtn" data-mode="personel">Personel N√∂bet Takvimi</button>
        </div>
      </h3>

      <div id="controls" class="ctrls"></div>
      <div id="results" style="margin-top:10px"></div>
    </section>

    <div class="page-end"></div>
  </main>

  <script>
    // ortak.js y√ºklendikten ve auth tamamlandƒ±ktan sonra √ßaƒürƒ±lƒ±r
    window.initPage = async function () {
      const supabase = window.supabase;
      if (!supabase) {
        console.error('Supabase client y√ºklenmedi');
        return;
      }
      const toast = (msg, type = 'info') => window.showToast?.(type, 'Bilgi', msg);
      const escapeHtml = window.escapeHtml || ((text) => {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
      });

      function setToday() { const d = new Date(); const days = ['Pazar', 'Pazartesi', 'Salƒ±', '√áar≈üamba', 'Per≈üembe', 'Cuma', 'Cumartesi']; document.getElementById('todayText').textContent = `${String(d.getDate()).padStart(2, '0')}.${String(d.getMonth() + 1).padStart(2, '0')}.${d.getFullYear()} ‚Ä¢ ${days[d.getDay()]}`; }
      function fmtTR(iso) { const d = new Date(iso + 'T12:00:00'); return `${String(d.getDate()).padStart(2, '0')}-${String(d.getMonth() + 1).padStart(2, '0')}-${d.getFullYear()}`; }
      function isoWeek(date) { const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate())); const day = d.getUTCDay() || 7; d.setUTCDate(d.getUTCDate() + 4 - day); const yStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1)); const w = Math.ceil((((d - yStart) / 86400000) + 1) / 7); return { isoYear: d.getUTCFullYear(), weekNo: w }; }
      function weekKeyFrom(date) { const { isoYear, weekNo } = isoWeek(date); return `${isoYear}-W${('0' + weekNo).slice(-2)}`; }
      function gunTR(y, m, d) { const t = new Date(y, m - 1, d); const dn = ['Pazar', 'Pazartesi', 'Salƒ±', '√áar≈üamba', 'Per≈üembe', 'Cuma', 'Cumartesi']; return dn[t.getDay()]; }

      /* ===== G√∂r√ºn√ºmler ===== */
      const controls = document.getElementById('controls');
      let currentMode = 'hafta';
      document.querySelectorAll('.tbtn').forEach(b => b.addEventListener('click', () => {
        document.querySelectorAll('.tbtn').forEach(x => x.classList.remove('active'));
        b.classList.add('active'); currentMode = b.dataset.mode; buildControls();
      }));

      function buildControls() {
        const res = document.getElementById('results'); res.innerHTML = '';
        if (currentMode === 'hafta') {
          controls.innerHTML = `<input type="date" id="ctlHaftaDate"> <button class="tbtn" id="btnFetchWeek">Getir</button>`;
          const d = new Date(); document.getElementById('ctlHaftaDate').value = d.toISOString().slice(0, 10);
          document.getElementById('btnFetchWeek').onclick = () => loadWeek(new Date(document.getElementById('ctlHaftaDate').value + "T12:00:00"));
          loadWeek(new Date());
        } else if (currentMode === 'ay') {
          controls.innerHTML = `<input type="month" id="ctlAy"> <button class="tbtn" id="btnFetchMonth">Getir</button>`;
          const d = new Date(); document.getElementById('ctlAy').value = `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}`;
          document.getElementById('btnFetchMonth').onclick = () => loadMonth(document.getElementById('ctlAy').value);
          loadMonth(document.getElementById('ctlAy').value);
        } else if (currentMode === 'personel') {
          controls.innerHTML = `<span id="whoPill" class="pill">Kullanƒ±cƒ±: <b id="meName">‚Äî</b></span>
      <select id="ctlYear"></select>
      <button class="tbtn" id="btnFetchPerson">Getir</button>`;
          const ySel = document.getElementById('ctlYear'); const yr = new Date().getFullYear();
          ySel.innerHTML = [yr - 1, yr, yr + 1].map(y => `<option ${y === yr ? 'selected' : ''}>${y}</option>`).join('');
          document.getElementById('btnFetchPerson').onclick = () => loadPerson(window.__ME_PERSON__, ySel.value);
          if (window.__ME_PERSON__) { document.getElementById('meName').textContent = window.__ME_PERSON__; loadPerson(window.__ME_PERSON__, yr); }
        }
      }

      /* === Haftalƒ±k (tek tablo) === */
      async function loadWeek(date) {
        const key = weekKeyFrom(date);
        document.getElementById('outWeek').textContent = key;
        try {
          const { data, error } = await supabase
            .from('nobet_planlari')
            .select('id, isspecialpazar, ispazartehir, rows')
            .eq('id', key)
            .single();
          
          if (error || !data) {
            document.getElementById('results').innerHTML = '<div class="muted">Plan bulunamadƒ±</div>';
            document.getElementById('sumPazar').textContent = '‚Äî'; return;
          }
          
          document.getElementById('sumPazar').textContent = data.isspecialpazar ? 'Var' : (data.ispazartehir ? 'Tehir' : 'Yok');

          const rows = ((data.rows || [])).map(r => {
            const bekar = escapeHtml(r.bekar || '');
            const evli = escapeHtml(r.evli || '');
            const not = escapeHtml(r.not || '');
            return `
      <tr>
        <td>${escapeHtml(r.gun || '')}</td>
        <td>${fmtTR(r.tarihISO || '')}</td>
        <td class="time">${escapeHtml(r.saat || '')}</td>
        <td>${bekar ? bekar : '<span class="muted">‚Äî</span>'}</td>
        <td>${evli ? evli : '<span class="muted">‚Äî</span>'}${not ? `<span class="note-inline"> ‚Ä¢ ${not}</span>` : ''}</td>
      </tr>`;
          }).join('');

          const wrap = document.getElementById('results');
          wrap.innerHTML = `
      <div class="table-wrap">
        <table class="weekly-table">
          <thead><tr><th>G√ºn</th><th>Tarih</th><th>Saat</th><th>Bek√¢r</th><th>Evli</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>
      </div>`;
        } catch (e) { console.error(e); toast('Hata'); }
      }

      /* === Aylƒ±k === */
      async function loadMonth(ym) {
        const wrap = document.getElementById('results');
        wrap.innerHTML = '';
        if (!ym) return;


        try {
          const { data: indexData, error: indexError } = await supabase
            .from('nobet_index')
            .select('date, role, person, saat')
            .eq('monthkey', ym);
          
          if (indexError) {
            console.error('N√∂bet index y√ºklenemedi:', indexError);
            toast('Aylƒ±k g√∂r√ºn√ºm y√ºklenemedi.', 'error');
            wrap.innerHTML = '<div class="muted">Veri y√ºklenirken hata olu≈ütu.</div>';
            return;
          }
          
          const byDate = {};
          (indexData || []).forEach(x => {
            const dt = x.date;
            if (!dt) return; // date yoksa atla
            if (!byDate[dt]) byDate[dt] = { b: new Set(), e: new Set(), s: new Set() };
            // bekar ise bekar setine, evli/ihvan ise evli setine ekle
            if (x.role === 'bekar') {
              byDate[dt].b.add(x.person);
            } else if (x.role === 'evli' || x.role === 'ihvan') {
              byDate[dt].e.add(x.person);
            }
            if (x.saat) byDate[dt].s.add(x.saat);
          });

          const [Y, M] = ym.split('-').map(Number);
          if (!Y || !M || M < 1 || M > 12) {
            wrap.innerHTML = '<div class="muted">Ge√ßersiz ay formatƒ±.</div>';
            return;
          }

          const first = new Date(Y, M - 1, 1);
          const daysInMonth = new Date(Y, M, 0).getDate();
          const startPad = (first.getDay() + 6) % 7;
          const isMobileGrid = window.matchMedia('(max-width:1024px)').matches;
          const pad = isMobileGrid ? 0 : startPad;

          const h = document.createElement('h3');
          h.textContent = `${ym} Aylƒ±k Takvim`;
          wrap.appendChild(h);

          const grid = document.createElement('div');
          grid.className = 'cal';
          for (let i = 0; i < pad; i++) {
            const c = document.createElement('div');
            c.className = 'cal-cell';
            c.style.visibility = 'hidden';
            grid.appendChild(c);
          }

          for (let d = 1; d <= daysInMonth; d++) {
            const iso = `${Y}-${String(M).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
            const info = byDate[iso] || { b: new Set(), e: new Set(), s: new Set() };

            const cell = document.createElement('div');
            cell.className = 'cal-cell';

            // 1. Tarih (√ºstte)
            const dateEl = document.createElement('div');
            dateEl.className = 'cal-date';
            dateEl.textContent = `${String(d).padStart(2, '0')}-${String(M).padStart(2, '0')}-${Y}  ${gunTR(Y, M, d)}`;
            cell.appendChild(dateEl);

            // 2. Saat bilgisi (tarihin altƒ±nda)
            const saat = [...info.s].join(' + ');
            if (saat) {
              const t = document.createElement('div');
              t.className = 'time';
              t.textContent = saat;
              cell.appendChild(t);
            }

            const fmt = a => a.length <= 2 ? a.join(', ') : `${a.slice(0, 2).join(', ')} +${a.length - 2}`;

            // 3. Evli personel ismi (saat altƒ±nda)
            if (info.e.size > 0) {
              const eBadge = document.createElement('div');
              eBadge.className = 'badge role-e';
              // Animasyonlarƒ± kapat
              eBadge.style.transition = 'none';
              eBadge.style.animation = 'none';
              eBadge.style.transform = 'none';
              eBadge.style.willChange = 'auto';

              const eText = document.createElement('span');
              const eNames = [...info.e].map(n => escapeHtml(n));
              eText.textContent = fmt(eNames);
              // ƒ∞sim kaymasƒ±nƒ± tamamen engelle
              eText.style.overflow = 'hidden';
              eText.style.textOverflow = 'ellipsis';
              eText.style.whiteSpace = 'nowrap';
              eText.style.flex = '1 1 0';
              eText.style.minWidth = '0';
              eText.style.maxWidth = '100%';
              eText.style.display = 'block';
              eText.style.wordBreak = 'normal';
              eText.style.wordWrap = 'normal';
              eText.style.overflowWrap = 'normal';
              eBadge.appendChild(eText);
              cell.appendChild(eBadge);
            }

            // 4. Bekar personel ismi (evli altƒ±nda)
            if (info.b.size > 0) {
              const bBadge = document.createElement('div');
              bBadge.className = 'badge role-b';
              // Animasyonlarƒ± kapat
              bBadge.style.transition = 'none';
              bBadge.style.animation = 'none';
              bBadge.style.transform = 'none';
              bBadge.style.willChange = 'auto';

              const bText = document.createElement('span');
              const bNames = [...info.b].map(n => escapeHtml(n));
              bText.textContent = fmt(bNames);
              // ƒ∞sim kaymasƒ±nƒ± tamamen engelle
              bText.style.overflow = 'hidden';
              bText.style.textOverflow = 'ellipsis';
              bText.style.whiteSpace = 'nowrap';
              bText.style.flex = '1 1 0';
              bText.style.minWidth = '0';
              bText.style.maxWidth = '100%';
              bText.style.display = 'block';
              bText.style.wordBreak = 'normal';
              bText.style.wordWrap = 'normal';
              bText.style.overflowWrap = 'normal';
              bBadge.appendChild(bText);
              cell.appendChild(bBadge);
            }

            grid.appendChild(cell);
          }
          wrap.appendChild(grid);
        } catch (e) {
          console.error('loadMonth hatasƒ±:', e);
          toast('Aylƒ±k g√∂r√ºn√ºm y√ºklenemedi.', 'error');
          wrap.innerHTML = '<div class="muted">Veri y√ºklenirken hata olu≈ütu.</div>';
        }
      }

      /* === PERSONEL === */
      async function loadPerson(person, year) {
        if (!person) { document.getElementById('results').innerHTML = '<div class="muted">Kullanƒ±cƒ± ismi e≈üle≈ümedi.</div>'; return; }
        const wrap = document.getElementById('results'); wrap.innerHTML = '';
        try {
          const { data: personData, error: personError } = await supabase
            .from('nobet_index')
            .select('date, day, saat, role, type, year')
            .eq('person', person);
          
          if (personError) {
            console.error('Personel n√∂bet verisi y√ºklenemedi:', personError);
            toast('Personel n√∂bet verisi y√ºklenemedi.', 'error');
            wrap.innerHTML = '<div class="muted">Veri y√ºklenirken hata olu≈ütu.</div>';
            return;
          }
          
          const all = (personData || [])
            .filter(x => String(x.year) === String(year))
            .sort((a, b) => (a.date || '').localeCompare(b.date || ''));

          if (!all.length) { wrap.innerHTML = '<div class="muted">Kayƒ±t bulunamadƒ±.</div>'; return; }

          const haftaiciDays = new Set(['Pazartesi', 'Salƒ±', '√áar≈üamba', 'Per≈üembe', 'Cuma', 'Cumartesi']);
          const isEvli = all.some(x => x.role === 'evli' || x.role === 'ihvan');

          const haftaici = all.filter(x => x.type === '24s' && haftaiciDays.has(x.day));
          const pazarG = all.filter(x => x.day === 'Pazar' && x.type === 'pazar-gunduz');
          const pazarA = all.filter(x => x.day === 'Pazar' && x.type === 'pazar-aksam');

          const mk = (title, rows) => `
      <h3 style="margin-top:8px">${escapeHtml(title)}</h3>
      <div class="table-wrap">
        <table class="per-table">
          <thead><tr><th>G√ºn</th><th>Tarih</th><th>Saat</th><th>Rol</th></tr></thead>
          <tbody>${rows.map(r => `
            <tr>
              <td>${escapeHtml(r.day || '')}</td>
              <td>${fmtTR(r.date || '')}</td>
              <td class="time">${escapeHtml(r.saat || '')}</td>
              <td>${escapeHtml(r.role || '')}</td>
            </tr>`).join('')}
          </tbody>
        </table>
      </div>`;

          wrap.innerHTML =
            mk('Hafta ƒ∞√ßi (Pazartesi‚ÄìCumartesi)', haftaici) +
            (isEvli ? mk('Hafta Sonu (Pazar ‚Äì G√ºnd√ºz)', pazarG) : mk('Hafta Sonu (Pazar ‚Äì Ak≈üam)', pazarA));
        } catch (e) { console.error(e); toast('Hata', 'error'); }
      }

      // ilk y√ºkleme
      setToday();

      try {
        const { data: { user }, error: userError } = await supabase.auth.getUser();
        if (userError || !user) { 
          console.error('Kullanƒ±cƒ± bilgisi alƒ±namadƒ±:', userError);
          return; 
        }
        
        const { data: userData, error: userDataError } = await supabase
          .from('kullanicilar')
          .select('adsoyad')
          .eq('id', user.id)
          .single();
        
        if (userDataError) {
          console.error('Kullanƒ±cƒ± verisi alƒ±namadƒ±:', userDataError);
        }

        const myPreferred = (userData?.adsoyad || user.email?.split('@')[0] || '').trim();
        let me = myPreferred;
        try {
          const { data: indexData } = await supabase
            .from('nobet_index')
            .select('person')
            .limit(400);
          
          const persons = [...new Set((indexData || []).map(d => (d.person || '').trim()).filter(Boolean))];
          me = persons.find(p => p.toLowerCase() === myPreferred.toLowerCase())
            || persons.find(p => p.toLowerCase().startsWith(myPreferred.toLowerCase()))
            || persons[0] || myPreferred;
        } catch (e) { 
          console.error('Personel listesi alƒ±namadƒ±:', e);
        }

        window.__ME_PERSON__ = me;
        buildControls();
        const meNameEl = document.getElementById('meName');
        if (meNameEl) {
          meNameEl.textContent = me;
        }
      } catch (e) {
        console.error(e);
        toast('Veriler y√ºklenirken hata.', 'error');
      }
    };
  </script>
</body>

</html>