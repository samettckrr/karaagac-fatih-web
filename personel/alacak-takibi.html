<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Personel Alacak Takibi ve YÃ¶netimi</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <link rel="icon" type="image/png" href="../img/logo.png" />

  <!-- Supabase (Auth + Database iÃ§in) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="../../src/supabase.js"></script>
  <script src="../../src/supabase-auth-wrapper.js"></script>
  <script src="../../src/supabase-db-wrapper.js"></script>
  
  <!-- Ortak CSS (App Shell TasarÄ±m Sistemi) -->
  <link rel="stylesheet" href="../../css/app-shell.css">
  
  <!-- Ortak JS (navigation, toast, vs) -->
  <script src="../../js/ortak.js"></script>

  <!-- html2pdf -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" defer></script>

  <style>
    /* Sayfa Ã¶zel stilleri - app-shell.css'den sonra yÃ¼klenir */
    /* Arka plan, appbar, drawer, toast, modal, card, button vb. app-shell.css'den geliyor */
    
    /* Modal iyileÅŸtirmeleri - modern ve temiz tasarÄ±m */
    .modal{
      backdrop-filter:blur(6px);
      -webkit-backdrop-filter:blur(6px);
    }
    .modal .sheet{
      max-width:760px;
      width:min(760px, 96vw);
      border-radius:18px;
      box-shadow:0 24px 48px rgba(15,23,42,.2), 0 1px 0 rgba(255,255,255,.05) inset;
    }
    .modal .sheet .body{
      padding:24px;
    }
    .modal .sheet .body h3{
      margin:0 0 24px 0;
      font-size:22px;
      font-weight:700;
      color:var(--text);
      padding-bottom:16px;
      border-bottom:2px solid var(--stroke);
    }
    .modal .sheet footer{
      gap:12px;
      padding:20px 24px;
      border-top:1px solid var(--stroke);
    }
    .modal .sheet footer .btn{
      min-width:120px;
      padding:12px 24px;
      font-weight:600;
      font-size:15px;
      border-radius:10px;
    }
    .modal .sheet footer .btn-success{
      box-shadow:0 4px 12px rgba(16,185,129,.25);
    }
    .modal .sheet footer .btn-success:hover{
      transform:translateY(-2px);
      box-shadow:0 6px 16px rgba(16,185,129,.35);
    }
    .modal .sheet footer .btn-ghost:hover{
      transform:translateY(-1px);
      background:var(--surface);
    }

    /* Sayfa header kaldÄ±rÄ±ldÄ± - baÅŸlÄ±k #tools kartÄ± iÃ§inde */
    .wrap{
      max-width:1400px;
      margin:0 auto;
      padding:16px;
    }
    @media (max-width:640px){
      .wrap{padding:12px}
    }
    .row{display:grid;gap:12px}
    .row.cols-4{grid-template-columns:repeat(4,1fr)}
    @media (max-width:900px){.row.cols-4{grid-template-columns:1fr 1fr}}
    @media (max-width:640px){.row.cols-4{grid-template-columns:1fr}}

    /* Toolbar - filter kartÄ± (baÅŸlÄ±k ve filtreler birlikte) */
    #tools{
      margin-top:20px;
      margin-bottom:0;
      padding:24px;
    }
    #tools > div:first-child{
      /* BaÅŸlÄ±k ve aÃ§Ä±klama container'Ä± */
      margin-bottom:20px;
      padding-bottom:16px;
      border-bottom:1px solid var(--stroke);
    }
    #tools > div:last-child,
    #tools > div:nth-child(2){
      /* Filtre container'Ä± */
      display:flex;
      gap:16px;
      flex-wrap:wrap;
      align-items:flex-end;
      padding:0;
    }
    @media (max-width:640px){
      #tools{
        padding:20px 16px;
      }
      #tools > div:last-child,
      #tools > div:nth-child(2){
        gap:12px;
      }
    }
    /* Field container */
    .field{
      display:flex;
      flex-direction:column;
      gap:0;
    }
    /* Form elemanlarÄ± app-shell.css'den geliyor, Ã¶zel ayarlar */
    select, input[type="text"], input[type="number"], input[type="date"]{
      min-width:180px;
    }
    @media (max-width:640px){
      select, input[type="text"], input[type="number"], input[type="date"]{
        min-width:140px;
        width:100%;
      }
    }
    .chip{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#ffffff;
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
    }
    /* Card app-shell.css'den geliyor */
    .kpi{display:flex;flex-direction:column;gap:4px}
    .kpi .label{color:var(--muted);font-size:12px}
    .kpi .value{font-size:20px;font-weight:600}
    .kpi.good .value{color:var(--good)}
    .kpi.warn .value{color:var(--warn)}
    .kpi.bad  .value{color:var(--bad)}
    .muted{color:var(--muted)}
    .line{height:1px;background:var(--border);margin:8px 0}

    /* Modal ve Sheet app-shell.css'den geliyor */
    /* Modal stilleri app-shell.css'den geliyor */
    body.modal-open{overflow:hidden}

    .table-wrap{overflow:auto;border:1px solid var(--border);border-radius:12px;background:#ffffff}
    table{width:100%;border-collapse:collapse;background:transparent;min-width:1000px}
    thead th{
      position:sticky;top:0;
      background:#f9fafb;
      border-bottom:1px solid var(--border);
      font-weight:500;
      text-align:left;
      font-size:12px;
      letter-spacing:.03em;
      text-transform:uppercase;
      color:var(--muted);
      padding:10px 12px;
    }
    tbody td{border-bottom:1px solid #edf0f3;padding:10px 12px;font-size:14px}
    tbody tr.zero{background:#f0fdf4}
    tfoot td{
      border-top:2px solid var(--border);
      padding:10px 12px;
      font-weight:600;
      background:#f9fafb;
    }
    .right{text-align:right}
    .person-link{color:#2563eb;text-decoration:none}
    .person-link:hover{text-decoration:underline}

    .avoid-break{page-break-inside:avoid;break-inside:avoid}
    @media print{
      .toolbar{display:none!important}
      .wrap{max-width:100%;padding:0}
      .card{border:none;padding:0}
      .table-wrap{border:none}
    }

    /* Modal iÃ§i form elemanlarÄ± - app-shell.css ile uyumlu */
    .modal .sheet .body .grid{
      display:grid;
      grid-template-columns:repeat(3, 1fr);
      gap:16px;
    }
    @media (max-width:768px){
      .modal .sheet .body .grid{
        grid-template-columns:1fr;
      }
    }
    .modal .sheet .body label{
      display:block;
      font-size:13px;
      font-weight:600;
      color:var(--muted);
      margin-bottom:8px;
    }
    .modal .sheet .body input,
    .modal .sheet .body select,
    .modal .sheet .body textarea{
      width:100%;
      min-height:44px;
      padding:10px 14px;
      border:1px solid var(--stroke);
      border-radius:10px;
      background:var(--card);
      color:var(--text);
      font-size:14px;
      font-family:inherit;
      transition:all .2s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .modal .sheet .body input:focus,
    .modal .sheet .body select:focus,
    .modal .sheet .body textarea:focus{
      border-color:var(--brand);
      background:var(--surface);
      box-shadow:0 0 0 3px rgba(59,130,246,.12);
      outline:none;
    }
    .modal .sheet .body input:hover,
    .modal .sheet .body select:hover,
    .modal .sheet .body textarea:hover{
      border-color:var(--border);
    }
    .modal .sheet .body textarea{
      height:auto;
      min-height:140px;
      resize:vertical;
      line-height:1.6;
      padding:12px 14px;
    }
    .modal .sheet .body input[readonly]{
      background:var(--surface2);
      cursor:not-allowed;
      opacity:0.8;
    }

    header strong{font-size:clamp(22px,4.4vw,28px);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:60vw}

    .card-list{display:none;gap:10px}
    .mini-card{
      background:#ffffff;
      border:1px solid var(--border);
      border-radius:12px;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:6px;
      box-shadow:0 8px 20px rgba(15,23,42,.06);
    }
    .mini-line{display:flex;justify-content:space-between;gap:8px;font-size:14px}
    .mini-hl{font-weight:600}
    .switcher{display:flex;gap:6px;align-items:center;white-space:nowrap}

    /* Button stilleri app-shell.css'den geliyor */
    /* Sayfa Ã¶zel button stilleri */
    .btn-small{
      height:32px;
      font-size:13px;
      padding:0 12px;
      border-radius:8px;
      font-weight:600;
    }
    button.btn-ghost.btn-small,
    .btn-small.btn-ghost{
      padding:0 10px;
    }

    td.action-col{width:160px;white-space:nowrap}
    td.action-col .action-cell{display:flex;justify-content:flex-end;gap:6px}

    .yeni-filter{display:flex;flex-direction:column;gap:4px;min-width:220px}
    .yeni-range{display:flex;gap:6px;align-items:center}

    /* #tools stilleri yukarÄ±da tanÄ±mlandÄ± */

    /* Toast sistemi app-shell.css'den geliyor */

    @media (max-width:540px){
      .table-wrap{display:none}
      .card-list{display:grid}
      input{min-width:160px}
    }
  </style>
</head>
<body>
  <!-- ÃœST APPBAR (app-shell.css ile uyumlu) -->
  <div class="appbar">
    <div class="brand" onclick="location.href='../panel.html'">
      <img src="../img/logo.png" alt="logo"><span>KARAAÄAÃ‡ FATÄ°H</span>
    </div>
    <nav class="nav-center"><ul class="nav-list" id="navMain"></ul></nav>
    <div class="nav-right">
      <button class="btn hamb" id="hamburger" title="MenÃ¼">â˜°</button>
      
      <!-- Bildirim -->
      <div class="nav-item">
        <button class="iconbtn" id="btnNotif" title="Bildirimler">ğŸ””
          <span class="badge" id="notifBadge" style="display:none">0</span>
        </button>
        <div class="dropdown drop-right" id="notifDropdown" aria-label="Bildirim listesi">
          <div class="muted" style="padding:10px 12px 8px">Son bildirimler</div>
          <div id="notifList" class="list"></div>
        </div>
      </div>

      <!-- Profil -->
      <div class="nav-item">
        <button class="iconbtn" id="btnProfile" title="Profil">
          <span id="profName" class="muted">Profil</span>
        </button>
        <div class="dropdown drop-right" id="profDropdown" aria-label="Profil menÃ¼sÃ¼">
          <a href="../diger/kullanici-yonetimi.html">ğŸ‘¤ Profil</a>
          <a href="../diger/sistem-ayarlari.html">âš™ï¸ Sistem AyarlarÄ±</a>
          <a href="#" id="btnLogout">ğŸšª Ã‡Ä±kÄ±ÅŸ Yap</a>
        </div>
      </div>
    </div>
  </div>
  <aside class="drawer" id="drawer"></aside>

  <!-- Toast Container (ortak.js tarafÄ±ndan kullanÄ±lÄ±r) -->
  <div class="toast-container" id="toastContainer"></div>
  <!-- basit sayfa yÃ¼kleme ilerleme Ã§ubuÄŸu istersen buradan kontrol edebilirsin -->

  <main class="wrap" id="pdf-root">
    <div class="card" id="tools" style="margin-top:20px">
      <div style="margin-bottom:20px;padding-bottom:16px;border-bottom:1px solid var(--stroke)">
        <h1 style="margin:0 0 8px 0;font-size:28px;font-weight:800;color:var(--text)">Personel Alacak Takibi ve YÃ¶netimi</h1>
        <p class="muted" style="margin:0;font-size:13px">YÄ±l ve faaliyet bazÄ±nda tahakkuk, tahsilat ve kalan bakiyeleri tek ekranda yÃ¶netin.</p>
      </div>
      <div style="display:flex;flex-wrap:wrap;gap:10px;align-items:flex-end">
        <div class="field">
          <label class="muted" style="font-size:12px;font-weight:600;margin-bottom:6px;display:block">YÄ±l</label>
          <select id="filtreYil">
            <option value="tum">TÃ¼mÃ¼</option>
            <option>2023</option><option>2024</option><option selected>2025</option>
          </select>
        </div>
        <div class="field">
          <label class="muted" style="font-size:12px;font-weight:600;margin-bottom:6px;display:block">Faaliyet</label>
          <select id="filtreFaaliyet">
            <option value="tum">TÃ¼mÃ¼</option>
            <option>Ä°ftar</option><option>Sahur</option><option>Ä°hvan TaahhÃ¼t</option>
            <option>Muhibban TaahhÃ¼t</option><option>BaÄŸÄ±ÅŸ Kurban</option>
            <option>BÃ¼yÃ¼kbaÅŸ Kurban</option><option>Veli Teberrusu</option>
          </select>
        </div>
        <div style="flex:1;min-width:240px">
          <label class="muted" style="font-size:12px;display:block;margin-bottom:6px;font-weight:600">Arama</label>
          <input id="ara" type="text" placeholder="Personel / BorÃ§lu / Ã–deyen ara..." class="search-input">
        </div>
        <div class="field yeni-filter">
          <label class="muted" style="font-size:12px;font-weight:600;margin-bottom:6px;display:block">Yeni Tahsilat GÃ¶rÃ¼nÃ¼mÃ¼</label>
          <select id="yeniMode">
            <option value="7g">Son 7 GÃ¼n</option>
            <option value="range">Tarih AralÄ±ÄŸÄ±</option>
          </select>
          <div id="yeniRange" class="yeni-range" style="display:none;margin-top:8px;gap:8px;display:flex;align-items:center">
            <input id="yeniBaslangic" type="date" style="flex:1" />
            <span class="muted" style="font-size:12px;align-self:center">-</span>
            <input id="yeniBitis" type="date" style="flex:1" />
          </div>
        </div>
        <div style="flex:1"></div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          <button id="btnExport" class="btn btn-ghost">CSV</button>
          <button id="btnOrphan" class="btn btn-ghost" title="Tahsilat kaydÄ± olup eÅŸleÅŸen tahakkuk bulunamayanlar">âš </button>
          <button id="btnTahakkuk" class="btn btn-primary">Tahakkuk Ekle</button>
          <button id="btnTahsilat" class="btn btn-ghost">Tahsilat Ekle</button>
          <button id="btnPDF" class="btn btn-success">PDF</button>
          <button id="btnAyarlar" class="btn btn-ghost">Ayarlar</button>
        </div>
      </div>
    </div>

    <div class="row cols-4" id="kpiRow" style="margin-top:14px">
      <div class="card kpi"><span class="label">SeÃ§ili YÄ±l Toplam Alacak</span><span class="value" id="kpiToplam">â‚º0</span></div>
      <div class="card kpi"><span class="label">SeÃ§ili YÄ±l Toplam Tahsilat</span><span class="value" id="kpiTahsilat">â‚º0</span></div>
      <div class="card kpi warn"><span class="label">SeÃ§ili YÄ±l Kalan</span><span class="value" id="kpiKalan">â‚º0</span></div>
      <div class="card kpi"><span class="label">Tahsilat Nispeti</span><span class="value" id="kpiOran">0%</span></div>
    </div>
    <div class="row" id="kpiFaaliyetRow" style="margin-top:10px;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:10px"></div>

      <div class="card" style="margin-top:14px">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;flex-wrap:wrap">
        <h3 style="margin:0">DetaylÄ± Liste | SeÃ§ime GÃ¶re</h3>
        <span class="muted">Yeni Tahsilat = son 7 gÃ¼n (varsayÄ±lan).</span>
      </div>

      <div class="table-wrap" id="tableWrap">
        <table id="tbl">
          <thead>
            <tr>
              <th data-sort="yil">YÄ±l</th>
              <th data-sort="faaliyet">Faaliyet</th>
              <th data-sort="personel">Personel AdÄ± SoyadÄ±</th>
              <th data-sort="borclu">BorÃ§lu AdÄ± SoyadÄ±</th>
              <th data-sort="odeyen">Ã–deyen KiÅŸi</th>
              <th data-sort="aciklama">AÃ§Ä±klama</th>
              <th class="right" data-sort="tahakkuk">Tahakkuk</th>
              <th class="right" data-sort="tahsilat">Tahsilat</th>
              <th class="right" data-sort="yeni">Yeni Tahsilat</th>
              <th class="right" data-sort="kalan">Kalan</th>
              <th class="right">Ä°ÅŸlem</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
          <tfoot>
            <tr>
              <td colspan="6" class="right">TOPLAM</td>
              <td class="right" id="sumTahakkuk">â‚º0</td>
              <td class="right" id="sumTahsilat">â‚º0</td>
              <td class="right" id="sumYeni">â‚º0</td>
              <td class="right" id="sumKalan">â‚º0</td>
              <td></td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="card-list" id="cardList"></div>
    </div>
  </main>

  <!-- MODAL: Tahakkuk -->
<div class="modal" id="mTahakkuk">
  <div class="sheet">
    <div class="body">
      <h3>Tahakkuk Ekle</h3>
      <div class="grid">
        <div><label>YÄ±l</label>
          <select id="t_yil">
            <option>2023</option><option>2024</option><option selected>2025</option>
          </select>
        </div>
        <div><label>Faaliyet</label>
          <select id="t_faaliyet">
            <option>Ä°ftar</option><option>Sahur</option><option>Ä°hvan TaahhÃ¼t</option>
            <option>Muhibban TaahhÃ¼t</option><option>BaÄŸÄ±ÅŸ Kurban</option>
            <option>BÃ¼yÃ¼kbaÅŸ Kurban</option><option>Veli Teberrusu</option>
          </select>
        </div>
        <div><label>Tutar (â‚º)</label><input id="t_tutar" type="number" step="0.01" inputmode="decimal"></div>
        <div><label>Personel</label><input id="t_personel" placeholder="Ad Soyad"></div>
        <div><label>BorÃ§lu</label><input id="t_borclu" placeholder="Ad Soyad"></div>
        <div><label>Ã–deyen (opsiyonel)</label><input id="t_odeyen" placeholder="Ad Soyad"></div>
        <div><label>AÃ§Ä±klama</label><input id="t_aciklama" placeholder="(opsiyonel)"></div>
      </div>
    </div>
    <footer>
      <button class="btn btn-ghost" onclick="closeModal('mTahakkuk')">Kapat</button>
      <button class="btn btn-success" onclick="saveTahakkuk()">Kaydet</button>
    </footer>
  </div>
</div>

<!-- MODAL: Tahsilat -->
<div class="modal" id="mTahsilat">
  <div class="sheet">
    <div class="body">
      <h3>Tahsilat Ekle</h3>
      <div class="grid">
      <!-- SatÄ±ra tÄ±klayÄ±nca burasÄ± JS ile dolduruluyor -->
      <div style="grid-column:span 3"><label>Tahakkuk (satÄ±ra tÄ±kla â†’ oto dolar)</label>
        <input id="s_tahakkukRef" placeholder="SatÄ±ra tÄ±klayÄ±n ya da elle seÃ§in" readonly>
      </div>
      <div><label>Tarih</label><input id="s_tarih" type="date"></div>
      <div><label>Tutar (â‚º)</label><input id="s_tutar" type="number" step="0.01" inputmode="decimal"></div>
      <div><label>Ã–deyen KiÅŸi</label><input id="s_odeyen" placeholder="Ad Soyad"></div>
      <div><label>YÃ¶ntem/Makbuz</label><input id="s_yontem" placeholder="(opsiyonel)"></div>
    </div>
    <div style="margin-top:12px">
      <div class="line"></div>
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;gap:8px">
        <span class="muted" style="font-size:12px">Ã–nceki Tahsilatlar</span>
      </div>
      <div id="s_historyEmpty" class="muted" style="font-size:12px;display:none">Bu tahakkuk iÃ§in kayÄ±tlÄ± tahsilat yok.</div>
      <div id="s_historyWrap" style="max-height:220px;overflow:auto;border:1px solid var(--border);border-radius:10px;background:#fafbfc;display:none">
        <table style="width:100%;border-collapse:collapse;font-size:12px;min-width:100%">
          <thead>
            <tr>
              <th style="padding:6px 8px;border-bottom:1px solid var(--border);text-align:left">Tarih</th>
              <th style="padding:6px 8px;border-bottom:1px solid var(--border);text-align:left">Ã–deyen</th>
              <th style="padding:6px 8px;border-bottom:1px solid var(--border);text-align:right">Tutar</th>
              <th style="padding:6px 8px;border-bottom:1px solid var(--border);text-align:left">YÃ¶ntem</th>
            </tr>
          </thead>
          <tbody id="s_historyBody">          </tbody>
        </table>
      </div>
    </div>
    </div>
    <footer>
      <button class="btn btn-ghost" onclick="closeModal('mTahsilat')">Kapat</button>
      <button class="btn btn-success" onclick="saveTahsilat()">Kaydet</button>
    </footer>
  </div>
</div>

<!-- MODAL: CSV Ä°Ã§e Aktar -->
<div class="modal" id="mImport">
  <div class="sheet">
    <div class="body">
      <h3>Veri Ä°Ã§e Aktar (CSV)</h3>
      <p class="muted" style="margin:6px 0 12px">
      <b>1)</b> <u>tahakkuklar.csv</u>: <code>yil,faaliyet,personel,borclu,tahakkuk,aciklama</code><br>
      <b>2)</b> <u>tahsilatlar.csv</u>: <code>yil,faaliyet,personel,borclu,tutar,tarih,odeyen,yontem</code><br>
      EÅŸleÅŸtirme: <code>yil+faaliyet+personel+borclu</code>
    </p>
    <div class="grid">
      <div>
        <label>Tahakkuklar CSV</label>
        <input id="csvTahakkuk" type="file" accept=".csv" />
      </div>
      <div>
        <label>Tahsilatlar CSV</label>
        <input id="csvTahsilat" type="file" accept=".csv" />
      </div>
    </div>
    </div>
    <footer>
      <button class="btn btn-ghost" onclick="closeModal('mImport')">Kapat</button>
      <button class="btn btn-success" onclick="window.runImport && window.runImport()">Ä°Ã§e Aktar</button>
    </footer>
  </div>
</div>

<!-- MODAL: Ayarlar (YÄ±l & Faaliyet YÃ¶netimi) -->
<div class="modal" id="mAyarlar">
  <div class="sheet">
    <div class="body">
      <h3>Ayarlar â€¢ YÄ±l ve Faaliyetler</h3>
      <div class="grid" style="grid-template-columns:1fr 1fr;gap:16px">
      <div>
        <label>YÄ±llar (her satÄ±ra bir yÄ±l)</label>
        <textarea id="ayarYillar"></textarea>
      </div>
      <div>
        <label>Faaliyetler (her satÄ±ra bir faaliyet)</label>
        <textarea id="ayarFaaliyetler"></textarea>
      </div>
    </div>
      <p class="muted" style="font-size:12px;margin-top:8px">
        Bu listeler hem filtrelerde hem de "Tahakkuk Ekle" formunda kullanÄ±lÄ±r. DeÄŸiÅŸiklikler Supabase Ã¼zerinde <code>alacak_ayar / meta</code> kaydÄ±na kaydedilir.
      </p>
    </div>
    </div>
    <footer>
      <button class="btn btn-ghost" onclick="closeModal('mAyarlar')">VazgeÃ§</button>
      <button class="btn btn-success" onclick="saveAyarlar()">Kaydet</button>
    </footer>
  </div>
</div>

<!-- MODAL: EÅŸleÅŸmeyen Tahsilatlar -->
<div class="modal" id="mOrphan">
  <div class="sheet">
    <div class="body">
      <h3>Tahakkuku Bulunamayan Tahsilatlar</h3>
      <p class="muted" style="font-size:12px;margin:4px 0 10px">
      Bu listede, <b>tahsilatlar</b> koleksiyonunda kayÄ±tlÄ± olup, yÄ±l / faaliyet / personel / borÃ§lu bilgilerinden bir tahakkuk kaydÄ±yla eÅŸleÅŸmeyen satÄ±rlar gÃ¶sterilir.
      Ä°sterseniz ilgili tahakkuku sonradan oluÅŸturup bu tahsilatlarÄ± elle baÄŸlayabilirsiniz.
    </p>
    <div class="table-wrap" style="max-height:360px;overflow:auto">
      <table style="min-width:720px">
        <thead>
          <tr>
            <th>YÄ±l</th>
            <th>Faaliyet</th>
            <th>Personel</th>
            <th>BorÃ§lu</th>
            <th>Tarih</th>
            <th class="right">Tutar</th>
            <th>Ã–deyen</th>
            <th>YÃ¶ntem</th>
          </tr>
        </thead>
        <tbody id="tbodyOrphan">        </tbody>
      </table>
    </div>
    </div>
    <footer>
      <button class="btn btn-ghost" onclick="closeModal('mOrphan')">Kapat</button>
    </footer>
  </div>
</div>

  <!-- Modaller (deÄŸiÅŸmedi) -->
  <!-- ... (modallerin HTMLâ€™i aynÄ± bÄ±rakÄ±ldÄ±) ... -->

  <script>
    // ===== YardÄ±mcÄ±lar
    const qs = s => document.querySelector(s);
    const money = n => new Intl.NumberFormat('tr-TR',{style:'currency',currency:'TRY',maximumFractionDigits:2}).format(n||0);
    const todayStr = ()=> new Date().toISOString().slice(0,10);
    
    // Supabase client
    const getSupabase = () => window.supabase;
    const getAuth = () => window.getSupabaseAuth ? window.getSupabaseAuth() : null;

    // UUID oluÅŸturucu (Supabase id alanlarÄ± iÃ§in)
    function generateUUID() {
      if (typeof crypto !== 'undefined' && crypto.randomUUID) {
        return crypto.randomUUID();
      }
      // Fallback: basit UUID v4 oluÅŸturucu
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
        const r = Math.random() * 16 | 0;
        const v = c === 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    // Normalize yardÄ±mcÄ±larÄ± (TR duyarlÄ±)
    // ==== TR title-case: boÅŸluk, tire, apostrof, nokta vb. ayÄ±rÄ±cÄ±larÄ± korur
const tidy   = s => (s||'').toString().trim().replace(/\s+/g,' ');
const normTR = s => tidy(s).toLocaleLowerCase('tr-TR');
function titleTR(s){
  const lower = normTR(s);
  // ayÄ±rÄ±cÄ±larÄ± (boÅŸluk, -, _, ., /, :, ;, ,, parantez, apostrof, saÄŸ apostrof) koru
  const SEP = /([ \t\r\n\-\u2019'_/.,;:()]+)/;
  return lower.split(SEP).map(part=>{
    if (!part || SEP.test(part)) return part; // ayÄ±rÄ±cÄ±ysa dokunma
    return part.charAt(0).toLocaleUpperCase('tr-TR') + part.slice(1);
  }).join('');
}

// Date / string iÃ§in gÃ¼venli tarih-anahtarÄ± (YYYY-MM-DD)
function toDateKey(v){
  if (!v) return '';
  if (typeof v === 'string') return v.slice(0,10);
  if (v instanceof Date) return v.toISOString().slice(0,10);
  if (typeof v === 'object' && typeof v.toDate === 'function'){
    try {
      return v.toDate().toISOString().slice(0,10);
    } catch(e){
      return '';
    }
  }
  return '';
}

    let tahakkukDocs = [], tahsilatDocs = [], tableRows = [], orphanPayments = [];
    let editingTahakkukId = null;
    let sortState = { key:null, dir:'asc' };

    // Modal davranÄ±ÅŸlarÄ± (app-shell.css ile uyumlu: .modal.open)
    function closeModal(id){ 
      const modal = qs('#'+id);
      if(modal) {
        modal.classList.remove('open');
        if(!document.querySelector('.modal.open')) document.body.classList.remove('modal-open');
      }
    }
    document.addEventListener('click', (e)=>{ if(e.target.classList?.contains('modal')) closeModal(e.target.id); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') document.querySelectorAll('.modal.open').forEach(m=>m.classList.remove('open')); });
    ['#mTahakkuk','#mTahsilat'].forEach(mid=>{
      const m = qs(mid);
      m?.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ if(mid==='#mTahakkuk') saveTahakkuk(); else saveTahsilat(); } });
    });

    function openModal(id){
      const el = document.getElementById(id);
      if(!el){ console.warn('Modal bulunamadÄ±:', id); return; }
      el.classList.add('open'); // app-shell.css ile uyumlu: .modal.open
      document.body.classList.add('modal-open');
      setTimeout(()=> el.querySelector('input,select')?.focus(), 50);
    }

    function ensureMobileDefaults(){
      toggleView();
    }
    window.addEventListener('resize', ensureMobileDefaults);
    function toggleView(){
      const useCards = window.innerWidth<=540;
      qs('#tableWrap').style.display = useCards ? 'none' : 'block';
      qs('#cardList').style.display  = useCards ? 'grid' : 'none';
      render();
    }

    // SeÃ§enekler (yÄ±l ve faaliyet) iÃ§in meta veriler
    let yilOptions = ['2023','2024','2025'];
    let faaliyetOptions = ['Ä°ftar','Sahur','Ä°hvan TaahhÃ¼t','Muhibban TaahhÃ¼t','BaÄŸÄ±ÅŸ Kurban','BÃ¼yÃ¼kbaÅŸ Kurban','Veli Teberrusu'];

    async function loadMetaOptions(){
      try{
        const supabase = getSupabase();
        if (!supabase) {
          console.warn('Supabase client henÃ¼z hazÄ±r deÄŸil');
          applyOptionLists();
          return;
        }
        
        const { data, error } = await supabase
          .from('alacak_ayar')
          .select('id, yillar, faaliyetler')
          .eq('id', 'meta')
          .single();
          
        if (error) {
          console.error('Meta ayarlar yÃ¼klenemedi:', error);
          applyOptionLists();
          return;
        }
        
        if (data) {
          if (Array.isArray(data.yillar) && data.yillar.length) yilOptions = data.yillar.map(String);
          if (Array.isArray(data.faaliyetler) && data.faaliyetler.length) faaliyetOptions = data.faaliyetler.map(String);
        }
      }catch(e){ console.error('Meta ayarlar yÃ¼klenemedi', e); }
      applyOptionLists();
    }

    function applyOptionLists(){
      const yilFilter = qs('#filtreYil');
      const yilInput  = qs('#t_yil');
      if (yilFilter && yilInput){
        yilFilter.innerHTML = '<option value="tum">YÄ±l: TÃ¼mÃ¼</option>' + yilOptions.map(y=>`<option>${y}</option>`).join('');
        yilInput.innerHTML  = yilOptions.map((y,i)=>`<option${i===yilOptions.length-1?' selected':''}>${y}</option>`).join('');
      }
      const faFilter = qs('#filtreFaaliyet');
      const faInput  = qs('#t_faaliyet');
      if (faFilter && faInput){
        faFilter.innerHTML = '<option value="tum">Faaliyet: TÃ¼mÃ¼</option>' + faaliyetOptions.map(f=>`<option>${f}</option>`).join('');
        faInput.innerHTML  = faaliyetOptions.map(f=>`<option>${f}</option>`).join('');
      }
    }

    function openAyarlarModal(focus){
      const yilEl = document.getElementById('ayarYillar');
      const faEl  = document.getElementById('ayarFaaliyetler');
      if (yilEl) yilEl.value = yilOptions.join('\n');
      if (faEl)  faEl.value  = faaliyetOptions.join('\n');
      openModal('mAyarlar');
      setTimeout(()=>{
        if (focus==='yil' && yilEl) yilEl.focus();
        else if (focus==='faaliyet' && faEl) faEl.focus();
      },50);
    }

    async function saveAyarlar(){
      const yilEl = document.getElementById('ayarYillar');
      const faEl  = document.getElementById('ayarFaaliyetler');
      const yRaw = (yilEl?.value||'').split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      const fRaw = (faEl?.value||'').split(/\r?\n/).map(s=>s.trim()).filter(Boolean);
      if (!yRaw.length || !fRaw.length){
        if(typeof window.showToast==='function') window.showToast('warning','Eksik Ayar','En az bir yÄ±l ve bir faaliyet girmelisiniz.');
        return;
      }
      yilOptions = Array.from(new Set(yRaw.map(String)));
      faaliyetOptions = Array.from(new Set(fRaw.map(titleTR)));
      applyOptionLists();
      try{
        const supabase = getSupabase();
        if (!supabase) throw new Error('Supabase client hazÄ±r deÄŸil');
        
        const { error } = await supabase
          .from('alacak_ayar')
          .upsert(
            { id: 'meta', yillar: yilOptions, faaliyetler: faaliyetOptions },
            { onConflict: 'id' }
          );
          
        if (error) throw error;
        
        if(typeof window.showToast==='function') window.showToast('success','Ayarlar kaydedildi','YÄ±l ve faaliyet listeleri gÃ¼ncellendi.');
        closeModal('mAyarlar');
      }catch(e){
        console.error('Ayarlar kaydedilemedi', e);
        if(typeof window.showToast==='function') window.showToast('error','Hata','Ayarlar kaydedilirken bir hata oluÅŸtu.');
      }
    }

    // Supabase yÃ¼kle
    async function loadAll(){
      const supabase = getSupabase();
      if (!supabase) {
        console.error('Supabase client hazÄ±r deÄŸil');
        return;
      }
      
      try {
        // Tahakkuklar
        const { data: tahakkukData, error: tahakkukError } = await supabase
          .from('tahakkuklar')
          .select('id, yil, faaliyet, personel, borclu, tahakkuk, aciklama, createdat');
          
        if (tahakkukError) throw tahakkukError;
        tahakkukDocs = (tahakkukData || []).map(d=>({ id: d.id, ...d }));

        // Tahsilatlar
        const { data: tahsilatData, error: tahsilatError } = await supabase
          .from('tahsilatlar')
          .select('id, yil, faaliyet, personel, borclu, tahakkukid, tutar, tarih, odeyen, yontem, createdat');
          
        if (tahsilatError) throw tahsilatError;
        tahsilatDocs = (tahsilatData || []).map(d=>({ id: d.id, ...d }));
      } catch (error) {
        console.error('Veri yÃ¼kleme hatasÄ±:', error);
        throw error;
      }

      // Tahakkuk haritasÄ± ve anahtar kÃ¼meleri (eÅŸleÅŸtirme + yetim tahsilatlar iÃ§in)
      const tahById = new Map();
      const tahKeys = new Set();
      tahakkukDocs.forEach(t=>{
        tahById.set(t.id, t);
        const key = `${t.yil}||${normTR(t.faaliyet)}||${normTR(t.personel)}||${normTR(t.borclu)}`;
        tahKeys.add(key);
      });

      // Tahsilatlardan, hiÃ§bir tahakkuka eÅŸleÅŸmeyenleri topla
      orphanPayments = [];
      tahsilatDocs.forEach(s=>{
        if (s.tahakkukid){
          if (!tahById.has(s.tahakkukid)){
            orphanPayments.push(s);
          }
        } else {
          const sKey = `${s.yil}||${normTR(s.faaliyet)}||${normTR(s.personel)}||${normTR(s.borclu)}`;
          if (!tahKeys.has(sKey)){
            orphanPayments.push(s);
          }
        }
      });

      tableRows = tahakkukDocs.map(t=>{
        // EÅLEÅTÄ°RME: varsa sadece tahakkukid ile, yoksa TRâ€‘locale anahtar
        const key = `${t.yil}||${normTR(t.faaliyet)}||${normTR(t.personel)}||${normTR(t.borclu)}`;
        const related = tahsilatDocs.filter(s=>{
          if (s.tahakkukid){
            return s.tahakkukid === t.id;
          }
          const sKey = `${s.yil}||${normTR(s.faaliyet)}||${normTR(s.personel)}||${normTR(s.borclu)}`;
          return sKey === key;
        });

        // TEKÄ°LLEÅTÄ°R
        const seen = new Set(); const uniq = [];
        related.forEach(x=>{ if(!seen.has(x.id)){ seen.add(x.id); uniq.push(x); } });

        return {
          id:t.id,
          yil:Number(t.yil),
          faaliyet: titleTR(t.faaliyet),
          personel: titleTR(t.personel),
          borclu:   titleTR(t.borclu),
          faaliyetKey: normTR(t.faaliyet),
          personelKey: normTR(t.personel),
          borcluKey:   normTR(t.borclu),
          personelRaw: tidy(t.personel),
          tahakkuk: Number(t.tahakkuk||0),
          aciklama: tidy(t.aciklama),
          odeyenKayit: tidy(t.odeyen),
          payments: uniq.slice(), // tÃ¼m tahsilatlar (tutar, tarih, odeyen, yontem)
        };
      });

      render();
    }

    // Tablo satÄ±rlarÄ±nÄ± yeniden oluÅŸtur (tahakkuk ve tahsilat verilerinden)
    function rebuildTableRows(){
      const tahById = new Map();
      const tahKeys = new Set();
      tahakkukDocs.forEach(t=>{
        tahById.set(t.id, t);
        const key = `${t.yil}||${normTR(t.faaliyet)}||${normTR(t.personel)}||${normTR(t.borclu)}`;
        tahKeys.add(key);
      });

      // Yetim tahsilatlarÄ± gÃ¼ncelle
      orphanPayments = [];
      tahsilatDocs.forEach(s=>{
        if (s.tahakkukid){
          if (!tahById.has(s.tahakkukid)){
            orphanPayments.push(s);
          }
        } else {
          const sKey = `${s.yil}||${normTR(s.faaliyet)}||${normTR(s.personel)}||${normTR(s.borclu)}`;
          if (!tahKeys.has(sKey)){
            orphanPayments.push(s);
          }
        }
      });

      tableRows = tahakkukDocs.map(t=>{
        const key = `${t.yil}||${normTR(t.faaliyet)}||${normTR(t.personel)}||${normTR(t.borclu)}`;
        const related = tahsilatDocs.filter(s=>{
          if (s.tahakkukid){
            return s.tahakkukid === t.id;
          }
          const sKey = `${s.yil}||${normTR(s.faaliyet)}||${normTR(s.personel)}||${normTR(s.borclu)}`;
          return sKey === key;
        });

        const seen = new Set(); const uniq = [];
        related.forEach(x=>{ if(!seen.has(x.id)){ seen.add(x.id); uniq.push(x); } });

        return {
          id:t.id,
          yil:Number(t.yil),
          faaliyet: titleTR(t.faaliyet),
          personel: titleTR(t.personel),
          borclu:   titleTR(t.borclu),
          faaliyetKey: normTR(t.faaliyet),
          personelKey: normTR(t.personel),
          borcluKey:   normTR(t.borclu),
          personelRaw: tidy(t.personel),
          tahakkuk: Number(t.tahakkuk||0),
          aciklama: tidy(t.aciklama),
          odeyenKayit: tidy(t.odeyen),
          payments: uniq.slice(),
        };
      });
    }

    // Belirli bir satÄ±rÄ± tabloda gÃ¼ncelle veya ekle
    function refreshRowInTable(rowId){
      const row = tableRows.find(r=>r.id===rowId);
      if (!row) {
        // SatÄ±r bulunamadÄ±ysa DOM'dan kaldÄ±r
        const useCards = qs('#cardList').style.display==='grid';
        if (!useCards){
          const tbody = qs('#tbody');
          Array.from(tbody.children).forEach(tr=>{
            if (tr.dataset.rowId === rowId) tr.remove();
          });
        } else {
          const list = qs('#cardList');
          Array.from(list.children).forEach(card=>{
            if (card.dataset.rowId === rowId) card.remove();
          });
        }
        return;
      }

      const computed = computeRowView(row);
      const useCards = qs('#cardList').style.display==='grid';
      const yil = qs('#filtreYil').value;
      const faaliyet = qs('#filtreFaaliyet').value;
      const q = (qs('#ara').value||'').trim().toLocaleLowerCase('tr-TR');

      // Filtre kontrolÃ¼ - uymuyorsa DOM'dan kaldÄ±r
      const passesFilter = 
        (yil === 'tum' || String(computed.yil) === yil) &&
        (faaliyet === 'tum' || computed.faaliyetKey === normTR(faaliyet)) &&
        (!q || [computed.personel,computed.borclu,computed.odeyen,computed.faaliyet,(computed.aciklama||'')].join(' ').toLocaleLowerCase('tr-TR').includes(q));

      if (!passesFilter) {
        // Filtrelere uymuyorsa DOM'dan kaldÄ±r
        if (!useCards){
          const tbody = qs('#tbody');
          Array.from(tbody.children).forEach(tr=>{
            if (tr.dataset.rowId === rowId) tr.remove();
          });
        } else {
          const list = qs('#cardList');
          Array.from(list.children).forEach(card=>{
            if (card.dataset.rowId === rowId) card.remove();
          });
        }
        return;
      }

      if (!useCards){
        // Tablo gÃ¶rÃ¼nÃ¼mÃ¼ - Ã–nce mevcut satÄ±rÄ± kaldÄ±r (duplicate Ã¶nlemek iÃ§in)
        const tbody = qs('#tbody');
        let existingTr = null;
        Array.from(tbody.children).forEach(tr=>{
          if (tr.dataset.rowId === rowId) {
            existingTr = tr;
            tr.remove(); // Mevcut satÄ±rÄ± kaldÄ±r (duplicate Ã¶nlemek iÃ§in)
          }
        });

        const personParam = encodeURIComponent(computed.personelRaw || computed.personel);
        const yilParam = (yil==='tum') ? 'tum' : computed.yil;

        const tr = document.createElement('tr');
        tr.dataset.rowId = rowId;
        if (Math.abs(computed.kalan) < 0.001) tr.classList.add('zero');
        else tr.classList.remove('zero');

        tr.innerHTML = `
          <td>${computed.yil}</td>
          <td>${computed.faaliyet}</td>
          <td><a class="person-link" href="rapor-personel.html?personel=${personParam}&yil=${yilParam}" title="KiÅŸi Raporu">${computed.personel||''}</a></td>
          <td>${computed.borclu||''}</td>
          <td>${computed.odeyen||computed.odeyenKayit||''}</td>
          <td>${computed.aciklama||''}</td>
          <td class="right">${money(computed.tahakkuk)}</td>
          <td class="right">${money(computed.tahsilat)}</td>
          <td class="right">${money(computed.yeni)}</td>
          <td class="right">${money(computed.kalan)}</td>
          <td class="right action-col">
            <div class="action-cell">
              <button class="btn-small btn-ghost" data-act="edit">DÃ¼zenle</button>
              <button class="btn-small btn-danger" data-act="delete">Sil</button>
            </div>
          </td>
        `;

        tr.addEventListener('click', (ev)=>{
          if (ev.target && (ev.target.classList.contains('person-link') || ev.target.closest('button'))) return;
          openTahsilatModalForRow(computed);
        });
        tr.querySelector('[data-act="edit"]').onclick = (ev)=>{
          ev.stopPropagation();
          openTahakkukEdit(computed.id);
        };
        tr.querySelector('[data-act="delete"]').onclick = async (ev)=>{
          ev.stopPropagation();
          await deleteTahakkuk(computed.id);
        };

        // SÄ±ralama durumuna gÃ¶re doÄŸru konuma ekle
        if (sortState.key) {
          // SÄ±ralama varsa, doÄŸru konuma ekle
          const base = getFilteredBase();
          const sorted = base.slice().sort((a,b)=>{
            const key = sortState.key;
            const av = a[key] ?? '';
            const bv = b[key] ?? '';
            if (typeof av === 'number' && typeof bv === 'number') {
              return sortState.dir === 'desc' ? bv - av : av - bv;
            }
            const cmp = String(av).localeCompare(String(bv), 'tr-TR');
            return sortState.dir === 'desc' ? -cmp : cmp;
          });
          
          const currentIndex = sorted.findIndex(r => r.id === rowId);
          if (currentIndex >= 0 && currentIndex < sorted.length - 1) {
            // Sonraki satÄ±rÄ± bul ve ondan Ã¶nce ekle
            const nextRowId = sorted[currentIndex + 1].id;
            const nextTr = Array.from(tbody.children).find(tr => tr.dataset.rowId === nextRowId);
            if (nextTr) {
              tbody.insertBefore(tr, nextTr);
            } else {
              tbody.appendChild(tr);
            }
          } else {
            tbody.appendChild(tr);
          }
        } else {
          // SÄ±ralama yoksa en sona ekle
          tbody.appendChild(tr);
        }
      } else {
        // Kart gÃ¶rÃ¼nÃ¼mÃ¼ - Ã–nce mevcut kartÄ± kaldÄ±r (duplicate Ã¶nlemek iÃ§in)
        const list = qs('#cardList');
        let existingCard = null;
        Array.from(list.children).forEach(card=>{
          if (card.dataset.rowId === rowId) {
            existingCard = card;
            card.remove(); // Mevcut kartÄ± kaldÄ±r (duplicate Ã¶nlemek iÃ§in)
          }
        });

        const personParam = encodeURIComponent(computed.personel||'');
        const yilParam = (yil==='tum') ? 'tum' : computed.yil;

        const div = document.createElement('div');
        div.className='mini-card';
        div.dataset.rowId = rowId;
        div.innerHTML = `
          <div class="mini-line"><span class="mini-hl">${computed.personel||''}</span> <a class="person-link" href="rapor-personel.html?personel=${personParam}&yil=${yilParam}">KiÅŸi Raporu â†’</a></div>
          <div class="mini-line"><span>${computed.yil} â€¢ ${computed.faaliyet}</span><span>${computed.borclu||''}</span></div>
          <div class="mini-line"><span>Ã–deyen</span><span>${computed.odeyen||'-'}</span></div>
          <div class="mini-line"><span>Tahakkuk</span><span>${money(computed.tahakkuk)}</span></div>
          <div class="mini-line"><span>Eski Tahsilat</span><span>${money(computed.tahsilat)}</span></div>
          <div class="mini-line"><span>Yeni</span><span>${money(computed.yeni)}</span></div>
          <div class="mini-line"><span>Kalan</span><span style="font-weight:600">${money(computed.kalan)}</span></div>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
            <button class="btn btn-ghost btn-small" data-act="tahsilat">Tahsilat Ekle</button>
            <button class="btn btn-small btn-ghost" data-act="edit">DÃ¼zenle</button>
            <button class="btn btn-small btn-danger" data-act="delete">Sil</button>
          </div>
        `;

        div.querySelector('[data-act="tahsilat"]').onclick = (ev)=>{
          ev.preventDefault(); ev.stopPropagation();
          openTahsilatModalForRow(computed);
        };
        div.querySelector('[data-act="edit"]').onclick = (ev)=>{
          ev.preventDefault(); ev.stopPropagation();
          openTahakkukEdit(computed.id);
        };
        div.querySelector('[data-act="delete"]').onclick = async (ev)=>{
          ev.preventDefault(); ev.stopPropagation();
          await deleteTahakkuk(computed.id);
        };

        // SÄ±ralama durumuna gÃ¶re doÄŸru konuma ekle
        if (sortState.key) {
          const base = getFilteredBase();
          const sorted = base.slice().sort((a,b)=>{
            const key = sortState.key;
            const av = a[key] ?? '';
            const bv = b[key] ?? '';
            if (typeof av === 'number' && typeof bv === 'number') {
              return sortState.dir === 'desc' ? bv - av : av - bv;
            }
            const cmp = String(av).localeCompare(String(bv), 'tr-TR');
            return sortState.dir === 'desc' ? -cmp : cmp;
          });
          
          const currentIndex = sorted.findIndex(r => r.id === rowId);
          if (currentIndex >= 0 && currentIndex < sorted.length - 1) {
            const nextRowId = sorted[currentIndex + 1].id;
            const nextCard = Array.from(list.children).find(card => card.dataset.rowId === nextRowId);
            if (nextCard) {
              list.insertBefore(div, nextCard);
            } else {
              list.appendChild(div);
            }
          } else {
            list.appendChild(div);
          }
        } else {
          list.appendChild(div);
        }
      }
    }

    // KPI'larÄ± ve toplamlarÄ± gÃ¼ncelle
    function updateKPIs(){
      const base = getFilteredBase();
      const yil = qs('#filtreYil').value;

      const sumTahakkuk = base.reduce((a,b)=>a+(b.tahakkuk||0),0);
      const sumTahsilat = base.reduce((a,b)=>a+((b.tahsilat||0)),0);
      const sumYeni     = base.reduce((a,b)=>a+((b.yeni||0)),0);
      const sumKalan    = base.reduce((a,b)=>a+((b.kalan||0)),0);

      const yilFilter = (yil==='tum') ? tableRows.map(r=>computeRowView(r)) : tableRows.filter(r=>String(r.yil)===yil).map(r=>computeRowView(r));
      const tTahakkuk = yilFilter.reduce((a,b)=>a+(b.tahakkuk||0),0);
      const tTsl      = yilFilter.reduce((a,b)=>a+((b.tahsilat||0)+(b.yeni||0)),0);
      const tKalan    = tTahakkuk - tTsl;
      const oran      = tTahakkuk>0 ? (tTsl/tTahakkuk*100) : 0;

      qs('#sumTahakkuk').textContent = money(sumTahakkuk);
      qs('#sumTahsilat').textContent = money(sumTahsilat);
      qs('#sumYeni').textContent     = money(sumYeni);
      qs('#sumKalan').textContent    = money(sumKalan);
      qs('#kpiToplam').textContent   = money(tTahakkuk);
      qs('#kpiTahsilat').textContent = money(tTsl);
      qs('#kpiKalan').textContent    = money(tKalan);
      qs('#kpiOran').textContent     = `${oran.toFixed(1)}%`;

      // Faaliyet bazlÄ± KPI kartlarÄ±
      const faMap = new Map();
      base.forEach(r=>{
        const key = r.faaliyetKey || normTR(r.faaliyet||'');
        if (!key) return;
        if (!faMap.has(key)){
          faMap.set(key,{
            ad:r.faaliyet,
            tahakkuk:0,
            tahsilat:0,
            yeni:0,
            kalan:0
          });
        }
        const obj = faMap.get(key);
        obj.tahakkuk += r.tahakkuk||0;
        obj.tahsilat += r.tahsilat||0;
        obj.yeni     += r.yeni||0;
        obj.kalan    += r.kalan||0;
      });
      const faWrap = document.getElementById('kpiFaaliyetRow');
      if (faWrap){
        faWrap.innerHTML='';
        Array.from(faMap.values()).forEach(f=>{
          const totalT = f.tahsilat + f.yeni;
          const oranF = f.tahakkuk>0 ? (totalT/f.tahakkuk*100) : 0;
          const div = document.createElement('div');
          div.className='card kpi avoid-break';
          div.innerHTML = `
            <span class="label">${f.ad}</span>
            <span class="value">${money(f.tahakkuk)}</span>
            <span class="muted" style="font-size:12px">Tahsilat: ${money(totalT)} â€¢ Kalan: ${money(f.kalan)} â€¢ Oran: ${oranF.toFixed(1)}%</span>
          `;
          faWrap.appendChild(div);
        });
      }
    }

    // Kaydet (tahakkuk)
    async function saveTahakkuk(){
      try {
        const base = {
          yil: Number(qs('#t_yil').value),
          faaliyet: titleTR(qs('#t_faaliyet').value),
          personel: titleTR(qs('#t_personel').value),
          borclu:   titleTR(qs('#t_borclu').value),
          // odeyen alanÄ± tahakkuklar tablosunda yok, sadece tahsilatlar tablosunda var
          tahakkuk: Number(qs('#t_tutar').value||0),
          aciklama: tidy(qs('#t_aciklama').value) || null,
        };
        if(!base.yil || !base.faaliyet || !base.personel || !base.borclu || !base.tahakkuk){
          if(typeof window.showToast==='function') window.showToast('warning','Eksik Bilgi','Zorunlu alanlar boÅŸ.');
          return;
        }

        const supabase = getSupabase();
        if (!supabase) throw new Error('Supabase client hazÄ±r deÄŸil');
        
        if (editingTahakkukId){
          const existing = tahakkukDocs.find(x=>x.id===editingTahakkukId) || {};
          // id alanÄ±nÄ± payload'dan Ã§Ä±kar (id gÃ¼ncellenemez)
          const { id, ...payload } = { ...base };
          
          console.log('Tahakkuk gÃ¼ncelleniyor:', editingTahakkukId, payload);
          
          const { data, error } = await supabase
            .from('tahakkuklar')
            .update(payload)
            .eq('id', editingTahakkukId)
            .select()
            .single();
            
          if (error) {
            console.error('Tahakkuk gÃ¼ncelleme hatasÄ±:', error);
            console.error('Hata detaylarÄ±:', JSON.stringify(error, null, 2));
            throw error;
          }
          
          console.log('Tahakkuk baÅŸarÄ±yla gÃ¼ncellendi:', data);
          
          // Mevcut kaydÄ± gÃ¼ncelle
          const index = tahakkukDocs.findIndex(x=>x.id===editingTahakkukId);
          if (index !== -1) {
            tahakkukDocs[index] = { ...tahakkukDocs[index], ...payload };
          }
          
          // Tablo satÄ±rlarÄ±nÄ± yeniden oluÅŸtur ve ilgili satÄ±rÄ± gÃ¼ncelle
          rebuildTableRows();
          refreshRowInTable(editingTahakkukId);
          updateKPIs();
          
          if(typeof window.showToast==='function') window.showToast('success','BaÅŸarÄ±lÄ±','Tahakkuk gÃ¼ncellendi.');
        } else {
          const r = { 
            id: generateUUID(), // Supabase id alanÄ± iÃ§in UUID
            ...base, 
            createdat: new Date().toISOString() 
          };
          
          console.log('Tahakkuk ekleniyor:', r);
          
          const { data, error } = await supabase
            .from('tahakkuklar')
            .insert(r)
            .select()
            .single();
            
          if (error) {
            console.error('Tahakkuk ekleme hatasÄ±:', error);
            throw error;
          }
          console.log('Tahakkuk baÅŸarÄ±yla eklendi:', data);
          tahakkukDocs.push({id: data.id, ...data});
          
          // Tablo satÄ±rlarÄ±nÄ± yeniden oluÅŸtur ve yeni satÄ±rÄ± ekle
          rebuildTableRows();
          refreshRowInTable(data.id);
          updateKPIs();
          
          if(typeof window.showToast==='function') window.showToast('success','BaÅŸarÄ±lÄ±','Tahakkuk kaydÄ± eklendi.');
        }

        editingTahakkukId = null;
        closeModal('mTahakkuk');
      } catch (error) {
        console.error('saveTahakkuk hatasÄ±:', error);
        const errorMsg = error?.message || error?.details || 'Bilinmeyen bir hata oluÅŸtu.';
        if(typeof window.showToast==='function') {
          window.showToast('error','KayÄ±t HatasÄ±',`Tahakkuk kaydedilemedi: ${errorMsg}`);
        }
      }
    }

    // Kaydet (tahsilat)
    async function saveTahsilat(){
      try {
        const ref = qs('#s_tahakkukRef').dataset.tahakkukId || '';
        const tutar = Number(qs('#s_tutar').value||0);
        const tarihStr = qs('#s_tarih').value || todayStr();
        
        if(!ref || !tutar){
          if(typeof window.showToast==='function') window.showToast('warning','Eksik Bilgi','Tahakkuk seÃ§ ve tutar yaz.');
          return;
        }
        
        const tah = tahakkukDocs.find(x=>x.id===ref);
        if(!tah){
          if(typeof window.showToast==='function') window.showToast('error','Hata','EÅŸleÅŸen tahakkuk bulunamadÄ±.');
          return;
        }

        // Mevcut tahsilat toplamÄ± (ilgili tahakkuk iÃ§in)
        const mevcut = tahsilatDocs
          .filter(x=>x.tahakkukid===ref)
          .reduce((a,b)=>a+Number(b.tutar||0),0);
        if (mevcut + tutar > Number(tah.tahakkuk||0) + 0.0001){
          if(typeof window.showToast==='function') window.showToast('warning','Tutar AÅŸÄ±mÄ±','Toplam tahsilat, tahakkuk tutarÄ±nÄ± geÃ§emez.');
          return;
        }

        const supabase = getSupabase();
        if (!supabase) {
          throw new Error('Supabase client hazÄ±r deÄŸil');
        }
        
        // Tarih formatÄ±nÄ± ISO string'e Ã§evir (Supabase timestamp iÃ§in)
        const tarihISO = tarihStr ? new Date(tarihStr + 'T00:00:00').toISOString() : new Date().toISOString();
        const createdAtISO = new Date().toISOString();
        
        const sDoc = {
          id: generateUUID(), // Supabase id alanÄ± iÃ§in UUID
          tahakkukid: ref,
          yil: Number(tah.yil),
          faaliyet: normTR(tah.faaliyet),
          personel: normTR(tah.personel),
          borclu: normTR(tah.borclu),
          tutar: Number(tutar),
          tarih: tarihISO,
          odeyen: tidy(qs('#s_odeyen').value) || null,
          yontem: tidy(qs('#s_yontem').value) || null,
          createdat: createdAtISO
        };
        
        console.log('Tahsilat kaydediliyor:', sDoc);
        
        const { data, error } = await supabase
          .from('tahsilatlar')
          .insert(sDoc)
          .select()
          .single();
          
        if (error) {
          console.error('Tahsilat kaydetme hatasÄ±:', error);
          throw error;
        }
        
        console.log('Tahsilat baÅŸarÄ±yla kaydedildi:', data);
        tahsilatDocs.push({ id: data.id, ...data });
        
        // Tablo satÄ±rlarÄ±nÄ± yeniden oluÅŸtur ve ilgili tahakkuk satÄ±rÄ±nÄ± gÃ¼ncelle
        rebuildTableRows();
        refreshRowInTable(ref);
        updateKPIs();
        
        if(typeof window.showToast==='function') window.showToast('success','BaÅŸarÄ±lÄ±','Tahsilat kaydÄ± eklendi.');
        
        closeModal('mTahsilat');
      } catch (error) {
        console.error('saveTahsilat hatasÄ±:', error);
        const errorMsg = error?.message || error?.details || 'Bilinmeyen bir hata oluÅŸtu.';
        if(typeof window.showToast==='function') {
          window.showToast('error','KayÄ±t HatasÄ±',`Tahsilat kaydedilemedi: ${errorMsg}`);
        }
      }
    }

    function computeRowView(row){
      const mode = qs('#yeniMode')?.value || '7g';
      const today = new Date();
      const seven = new Date(); seven.setDate(today.getDate()-7);
      const sevenStr = seven.toISOString().slice(0,10);
      const start = qs('#yeniBaslangic')?.value || '';
      const end   = qs('#yeniBitis')?.value || '';

      const payments = row.payments || [];
      const totalAll = payments.reduce((a,p)=>a+Number(p.tutar||0),0);

      let yeni = 0;
      if (mode === '7g'){
        yeni = payments
          .filter(p => toDateKey(p.tarih) >= sevenStr)
          .reduce((a,p)=>a+Number(p.tutar||0),0);
      } else if (mode === 'range' && start && end){
        yeni = payments
          .filter(p => {
            const k = toDateKey(p.tarih);
            return k >= start && k <= end;
          })
          .reduce((a,p)=>a+Number(p.tutar||0),0);
      }

      const tahsilat = totalAll - yeni;
      const kalan = Number(row.tahakkuk||0) - totalAll;

      // Son tahsilat bilgisi
      let lastPayment = null;
      if (payments.length){
        lastPayment = payments
          .slice()
          .sort((a,b)=> toDateKey(a.tarih).localeCompare(toDateKey(b.tarih)))[payments.length-1];
      }

      return {
        ...row,
        tahsilat,
        yeni,
        kalan,
        odeyen: titleTR(lastPayment?.odeyen || ''),
        tarih: toDateKey(lastPayment?.tarih) || (row.createdat || '')
      };
    }

    // Filtre uygulanmÄ±ÅŸ temel listeyi Ã¼ret (KPI ve faaliyet kartlarÄ± iÃ§in kullanÄ±lÄ±r)
    function getFilteredBase(){
      const yil = qs('#filtreYil').value;
      const faaliyet = qs('#filtreFaaliyet').value;
      const q = (qs('#ara').value||'').trim().toLocaleLowerCase('tr-TR');

      let base = tableRows.map(r=>({ ...r })); // kopya
      if (yil !== 'tum') base = base.filter(r => String(r.yil) === yil);
      if (faaliyet !== 'tum') base = base.filter(r => r.faaliyetKey === normTR(faaliyet));
      base = base.map(r => computeRowView(r));
      if (q) base = base.filter(r => [r.personel,r.borclu,r.odeyen,r.faaliyet,(r.aciklama||'')].join(' ').toLocaleLowerCase('tr-TR').includes(q));
      return base;
    }

    // Render (tablo + kart)
    function render(){
      const yil = qs('#filtreYil').value;
      const base = getFilteredBase();
      const useCards = qs('#cardList').style.display==='grid';

      // TOPLAM/KPI â€” tek tanÄ±m (filtrelenmiÅŸ temel liste Ã¼zerinden)
      const sumTahakkuk = base.reduce((a,b)=>a+(b.tahakkuk||0),0);
      const sumTahsilat = base.reduce((a,b)=>a+((b.tahsilat||0)),0);
      const sumYeni     = base.reduce((a,b)=>a+((b.yeni||0)),0);
      const sumKalan    = base.reduce((a,b)=>a+((b.kalan||0)),0);

      const yilFilter = (yil==='tum') ? tableRows.map(r=>computeRowView(r)) : tableRows.filter(r=>String(r.yil)===yil).map(r=>computeRowView(r));
      const tTahakkuk = yilFilter.reduce((a,b)=>a+(b.tahakkuk||0),0);
      const tTsl      = yilFilter.reduce((a,b)=>a+((b.tahsilat||0)+(b.yeni||0)),0); // toplam tahsilat = eski + yeni
      const tKalan    = tTahakkuk - tTsl;
      const oran      = tTahakkuk>0 ? (tTsl/tTahakkuk*100) : 0;

      qs('#sumTahakkuk').textContent = money(sumTahakkuk);
      qs('#sumTahsilat').textContent = money(sumTahsilat);
      qs('#sumYeni').textContent     = money(sumYeni);
      qs('#sumKalan').textContent    = money(sumKalan);
      qs('#kpiToplam').textContent   = money(tTahakkuk);
      qs('#kpiTahsilat').textContent = money(tTsl);
      qs('#kpiKalan').textContent    = money(tKalan);
      qs('#kpiOran').textContent     = `${oran.toFixed(1)}%`;

      // Faaliyet bazlÄ± kartlar (filtrelenmiÅŸ temel liste Ã¼zerinden), sÄ±ralamadan baÄŸÄ±msÄ±z
      const faGroups = new Map();
      base.forEach(r=>{
        const key = r.faaliyet || '-';
        const agg = faGroups.get(key) || { ad: r.faaliyet || '-', tahakkuk:0, tahsilat:0, yeni:0, kalan:0 };
        agg.tahakkuk += (r.tahakkuk || 0);
        const totalT = (r.tahsilat || 0) + (r.yeni || 0);
        agg.tahsilat += totalT;
        agg.yeni     += (r.yeni || 0);
        agg.kalan    += (r.kalan || 0);
        faGroups.set(key, agg);
      });

      const faWrap = qs('#kpiFaaliyetRow');
      if (faWrap){
        faWrap.innerHTML = '';
        faGroups.forEach((v, key)=>{
          const div = document.createElement('div');
          div.className = 'card kpi';
          const oran = v.tahakkuk > 0 ? (v.tahsilat / v.tahakkuk * 100) : 0;
          div.innerHTML = `
            <span class="label">${key}</span>
            <span class="value">${money(v.tahsilat)}</span>
            <span class="muted" style="font-size:12px">Tahsilat OranÄ±: ${oran.toFixed(1)}%</span>
          `;
          faWrap.appendChild(div);
        });
      }

      // Tablo (sadece sÄ±ralÄ± kopya Ã¼zerinden)
      if (!useCards){
        const tbody = qs('#tbody'); tbody.innerHTML = '';
        base.slice().sort((a,b)=>{
          if (!sortState.key) return 0;
          const key = sortState.key;
          const av = a[key] ?? '';
          const bv = b[key] ?? '';
          if (typeof av === 'number' && typeof bv === 'number') {
            return sortState.key && sortState.dir==='desc' ? bv-av : av-bv;
          }
          const cmp = String(av).localeCompare(String(bv), 'tr-TR');
          return sortState.dir==='desc' ? -cmp : cmp;
        }).forEach(r=>{
          const personParam = encodeURIComponent(r.personelRaw || r.personel);
          const yilParam = (String(qs('#filtreYil').value)==='tum') ? r.yil : r.yil;
          const tr = document.createElement('tr');
          if (Math.abs(r.kalan) < 0.001) tr.classList.add('zero');
          tr.innerHTML = `
            <td>${r.yil}</td>
            <td>${r.faaliyet}</td>
            <td><a class="person-link" href="rapor-personel.html?personel=${personParam}&yil=${yilParam}" title="KiÅŸi Raporu">${r.personel||''}</a></td>
            <td>${r.borclu||''}</td>
            <td>${r.odeyen || r.odeyenKayit || ''}</td>
            <td>${r.aciklama||''}</td>
            <td class="right">${money(r.tahakkuk)}</td>
            <td class="right">${money(r.tahsilat)}</td>
            <td class="right">${money(r.yeni)}</td>
            <td class="right">${money(r.kalan)}</td>
            <td class="right action-col">
              <button class="btn btn-small btn-ghost" data-act="edit">DÃ¼zenle</button>
              <button class="btn btn-small btn-danger" data-act="delete">Sil</button>
            </td>
          `;
          tr.addEventListener('click', (ev)=>{
            if (ev.target && (ev.target.classList.contains('person-link') || ev.target.closest('button'))) return;
            openTahsilatModalForRow(r);
          });
          tr.querySelector('[data-act="edit"]').onclick = (ev)=>{
            ev.stopPropagation();
            openTahakkukEdit(r.id);
          };
          tr.querySelector('[data-act="delete"]').onclick = async (ev)=>{
            ev.stopPropagation();
            await deleteTahakkuk(r.id);
          };
          tbody.appendChild(tr);
        });
      } else {
        const list = qs('#cardList'); list.innerHTML='';
        base.forEach(r=>{
          const personParam = encodeURIComponent(r.personel||'');
          const yilParam = (qs('#filtreYil').value==='tum') ? r.yil : r.yil;
          const div = document.createElement('div');
          div.className='mini-card';
          div.innerHTML = `
            <div class="mini-line"><span class="mini-hl">${r.personel||''}</span> <a class="person-link" href="rapor-personel.html?personel=${personParam}&yil=${yilParam}">KiÅŸi Raporu â†’</a></div>
            <div class="mini-line"><span>${r.yil} â€¢ ${r.faaliyet}</span><span>${r.borclu||''}</span></div>
            <div class="mini-line"><span>Ã–deyen</span><span>${r.odeyen||r.odeyenKayit||'-'}</span></div>
            <div class="mini-line"><span>AÃ§Ä±klama</span><span>${r.aciklama||'-'}</span></div>
            <div class="mini-line"><span>Tahakkuk</span><span>${money(r.tahakkuk)}</span></div>
            <div class="mini-line"><span>Eski Tahsilat</span><span>${money(r.tahsilat)}</span></div>
            <div class="mini-line"><span>Yeni (7g)</span><span>${money(r.yeni)}</span></div>
            <div class="mini-line"><span>Kalan</span><span style="font-weight:600">${money(r.kalan)}</span></div>
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
              <button class="btn btn-ghost btn-small" data-act="tahsilat">Tahsilat Ekle</button>
              <button class="btn btn-small btn-ghost" data-act="edit">DÃ¼zenle</button>
              <button class="btn btn-small btn-danger" data-act="delete">Sil</button>
            </div>
          `;
          div.querySelector('[data-act="tahsilat"]').onclick = (ev)=>{
            ev.preventDefault(); ev.stopPropagation();
            openTahsilatModalForRow(r);
          };
          div.querySelector('[data-act="edit"]').onclick = (ev)=>{
            ev.preventDefault(); ev.stopPropagation();
            openTahakkukEdit(r.id);
          };
          div.querySelector('[data-act="delete"]').onclick = async (ev)=>{
            ev.preventDefault(); ev.stopPropagation();
            await deleteTahakkuk(r.id);
          };
          list.appendChild(div);
        });
      }
    }
    function render(){
      const yil = qs('#filtreYil').value;
      const faaliyet = qs('#filtreFaaliyet').value;
      const q = (qs('#ara').value||'').trim().toLocaleLowerCase('tr-TR');
      const useCards = qs('#cardList').style.display==='grid';

      // FiltrelenmiÅŸ temel veri (KPI ve faaliyet kartlarÄ± bunun Ã¼zerinden hesaplanÄ±r)
      let base = tableRows.slice();
      if (yil !== 'tum') base = base.filter(r => String(r.yil) === yil);
      if (faaliyet !== 'tum') base = base.filter(r => r.faaliyetKey === normTR(faaliyet));
      base = base.map(r => computeRowView(r));
      if (q) base = base.filter(r => [r.personel,r.borclu,r.odeyen,r.faaliyet].join(' ').toLocaleLowerCase('tr-TR').includes(q));

      // SÄ±ralama yalnÄ±zca tabloda gÃ¶sterilen kopya Ã¼zerinde uygulanÄ±r
      let data = base.slice();
      if (sortState.key){
        const key = sortState.key;
        const dir = sortState.dir === 'desc' ? -1 : 1;
        data.sort((a,b)=>{
          const av = a[key] ?? '';
          const bv = b[key] ?? '';
          if (typeof av === 'number' && typeof bv === 'number') return (av-bv)*dir;
          return String(av).localeCompare(String(bv),'tr-TR')*dir;
        });
      }

      // TOPLAM/KPI â€” tek tanÄ±m
      const sumTahakkuk = base.reduce((a,b)=>a+(b.tahakkuk||0),0);
      const sumTahsilat = base.reduce((a,b)=>a+((b.tahsilat||0)),0);
      const sumYeni     = base.reduce((a,b)=>a+((b.yeni||0)),0);
      const sumKalan    = base.reduce((a,b)=>a+((b.kalan||0)),0);

      const yilFilter = (yil==='tum') ? tableRows.map(r=>computeRowView(r)) : tableRows.filter(r=>String(r.yil)===yil).map(r=>computeRowView(r));
      const tTahakkuk = yilFilter.reduce((a,b)=>a+(b.tahakkuk||0),0);
      const tTsl      = yilFilter.reduce((a,b)=>a+((b.tahsilat||0)+(b.yeni||0)),0); // toplam tahsilat = eski + yeni
      const tKalan    = tTahakkuk - tTsl;
      const oran      = tTahakkuk>0 ? (tTsl/tTahakkuk*100) : 0;

      qs('#sumTahakkuk').textContent = money(sumTahakkuk);
      qs('#sumTahsilat').textContent = money(sumTahsilat);
      qs('#sumYeni').textContent     = money(sumYeni);
      qs('#sumKalan').textContent    = money(sumKalan);
      qs('#kpiToplam').textContent   = money(tTahakkuk);
      qs('#kpiTahsilat').textContent = money(tTsl);
      qs('#kpiKalan').textContent    = money(tKalan);
      qs('#kpiOran').textContent     = `${oran.toFixed(1)}%`;

      // Faaliyet bazlÄ± KPI kartlarÄ± (seÃ§ili yÄ±l + filtrelere gÃ¶re)
      const faMap = new Map();
      base.forEach(r=>{
        const key = r.faaliyetKey || normTR(r.faaliyet||'');
        if (!key) return;
        if (!faMap.has(key)){
          faMap.set(key,{
            ad:r.faaliyet,
            tahakkuk:0,
            tahsilat:0,
            yeni:0,
            kalan:0
          });
        }
        const obj = faMap.get(key);
        obj.tahakkuk += r.tahakkuk||0;
        obj.tahsilat += r.tahsilat||0;
        obj.yeni     += r.yeni||0;
        obj.kalan    += r.kalan||0;
      });
      const faWrap = document.getElementById('kpiFaaliyetRow');
      if (faWrap){
        faWrap.innerHTML='';
        Array.from(faMap.values()).forEach(f=>{
          const totalT = f.tahsilat + f.yeni;
          const oranF = f.tahakkuk>0 ? (totalT/f.tahakkuk*100) : 0;
          const div = document.createElement('div');
          div.className='card kpi avoid-break';
          div.innerHTML = `
            <span class="label">${f.ad}</span>
            <span class="value">${money(f.tahakkuk)}</span>
            <span class="muted" style="font-size:12px">Tahsilat: ${money(totalT)} â€¢ Kalan: ${money(f.kalan)} â€¢ Oran: ${oranF.toFixed(1)}%</span>
          `;
          faWrap.appendChild(div);
        });
      }

      if (!useCards){
        const tbody = qs('#tbody'); tbody.innerHTML = '';
        data.forEach(r=>{
          const personParam = encodeURIComponent(r.personelRaw || r.personel);
          const yilParam = (yil==='tum') ? 'tum' : r.yil;
          const tr = document.createElement('tr');
          if (Math.abs(r.kalan) < 0.001) tr.classList.add('zero');
          tr.innerHTML = `
            <td>${r.yil}</td>
            <td>${r.faaliyet}</td>
            <td><a class="person-link" href="rapor-personel.html?personel=${personParam}&yil=${yilParam}" title="KiÅŸi Raporu">${r.personel||''}</a></td>
            <td>${r.borclu||''}</td>
            <td>${r.odeyen||r.odeyenKayit||''}</td>
            <td>${r.aciklama||''}</td>
            <td class="right">${money(r.tahakkuk)}</td>
            <td class="right">${money(r.tahsilat)}</td>
            <td class="right">${money(r.yeni)}</td>
            <td class="right">${money(r.kalan)}</td>
            <td class="right action-col">
              <div class="action-cell">
                <button class="btn-small btn-ghost" data-act="edit">DÃ¼zenle</button>
                <button class="btn-small btn-danger" data-act="delete">Sil</button>
              </div>
            </td>
          `;
          tr.addEventListener('click', (ev)=>{
            if (ev.target && (ev.target.classList.contains('person-link') || ev.target.closest('button'))) return;
            openTahsilatModalForRow(r);
          });
          tr.querySelector('[data-act="edit"]').onclick = (ev)=>{
            ev.stopPropagation();
            openTahakkukEdit(r.id);
          };
          tr.querySelector('[data-act="delete"]').onclick = async (ev)=>{
            ev.stopPropagation();
            await deleteTahakkuk(r.id);
          };
          tbody.appendChild(tr);
        });
      } else {
        const list = qs('#cardList'); list.innerHTML='';
        data.forEach(r=>{
          const personParam = encodeURIComponent(r.personel||'');
          const yilParam = (yil==='tum') ? 'tum' : r.yil;
          const div = document.createElement('div');
          div.className='mini-card';
          div.innerHTML = `
            <div class="mini-line"><span class="mini-hl">${r.personel||''}</span> <a class="person-link" href="rapor-personel.html?personel=${personParam}&yil=${yilParam}">KiÅŸi Raporu â†’</a></div>
            <div class="mini-line"><span>${r.yil} â€¢ ${r.faaliyet}</span><span>${r.borclu||''}</span></div>
            <div class="mini-line"><span>Ã–deyen</span><span>${r.odeyen||'-'}</span></div>
            <div class="mini-line"><span>Tahakkuk</span><span>${money(r.tahakkuk)}</span></div>
            <div class="mini-line"><span>Eski Tahsilat</span><span>${money(r.tahsilat)}</span></div>
            <div class="mini-line"><span>Yeni</span><span>${money(r.yeni)}</span></div>
            <div class="mini-line"><span>Kalan</span><span style="font-weight:600">${money(r.kalan)}</span></div>
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
              <button class="btn btn-ghost btn-small" data-act="tahsilat">Tahsilat Ekle</button>
              <button class="btn btn-small btn-ghost" data-act="edit">DÃ¼zenle</button>
              <button class="btn btn-small btn-danger" data-act="delete">Sil</button>
            </div>
          `;
          div.querySelector('[data-act="tahsilat"]').onclick = (ev)=>{
            ev.preventDefault(); ev.stopPropagation();
            openTahsilatModalForRow(r);
          };
          div.querySelector('[data-act="edit"]').onclick = (ev)=>{
            ev.preventDefault(); ev.stopPropagation();
            openTahakkukEdit(r.id);
          };
          div.querySelector('[data-act="delete"]').onclick = async (ev)=>{
            ev.preventDefault(); ev.stopPropagation();
            await deleteTahakkuk(r.id);
          };
          list.appendChild(div);
        });
      }
    }

    function openTahsilatModalForRow(r){
      qs('#s_tahakkukRef').value = `${r.yil} â€¢ ${r.faaliyet} â€¢ ${r.personel} â€¢ ${money(r.tahakkuk)}`;
      qs('#s_tahakkukRef').dataset.tahakkukId = r.id;
      qs('#s_tarih').value = todayStr();
      qs('#s_tutar').value = '';
      qs('#s_odeyen').value = '';
      qs('#s_yontem').value = '';

      const body = qs('#s_historyBody');
      const wrap = qs('#s_historyWrap');
      const empty = qs('#s_historyEmpty');
      body.innerHTML = '';
      const payments = r.payments || [];
      if (!payments.length){
        wrap.style.display='none';
        empty.style.display='block';
      } else {
        empty.style.display='none';
        wrap.style.display='block';
        payments
          .slice()
          .sort((a,b)=> toDateKey(a.tarih).localeCompare(toDateKey(b.tarih)))
          .forEach(p=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td style="padding:4px 8px;border-bottom:1px solid var(--border)">${toDateKey(p.tarih)||''}</td>
              <td style="padding:4px 8px;border-bottom:1px solid var(--border)">${titleTR(p.odeyen||'')}</td>
              <td style="padding:4px 8px;border-bottom:1px solid var(--border);text-align:right">${money(p.tutar||0)}</td>
              <td style="padding:4px 8px;border-bottom:1px solid var(--border)">${p.yontem||''}</td>
            `;
            body.appendChild(tr);
          });
      }
      openModal('mTahsilat');
    }

    function openTahakkukEdit(id){
      const t = tahakkukDocs.find(x=>x.id===id);
      if (!t) {
        console.warn('Tahakkuk bulunamadÄ±:', id);
        return;
      }
      editingTahakkukId = id;
      
      // Faaliyet deÄŸerini select'teki title-case deÄŸerle eÅŸleÅŸtir
      const faaliyetValue = titleTR(t.faaliyet || '');
      const faaliyetSelect = qs('#t_faaliyet');
      if (faaliyetSelect) {
        // Select'teki option'larÄ± kontrol et ve eÅŸleÅŸeni bul
        const options = Array.from(faaliyetSelect.options);
        const matchingOption = options.find(opt => titleTR(opt.value) === faaliyetValue || opt.value === faaliyetValue);
        if (matchingOption) {
          faaliyetSelect.value = matchingOption.value;
        } else {
          faaliyetSelect.value = faaliyetValue; // Fallback: direkt deÄŸeri kullan
        }
      }
      
      qs('#t_yil').value = t.yil || '';
      qs('#t_personel').value = t.personel || '';
      qs('#t_borclu').value = t.borclu || '';
      qs('#t_tutar').value = t.tahakkuk || '';
      // odeyen alanÄ± tahakkuklar tablosunda yok, sadece tahsilatlar tablosunda var
      qs('#t_odeyen').value = '';
      qs('#t_aciklama').value = t.aciklama || '';
      qs('#mTahakkuk h3').textContent = 'Tahakkuk DÃ¼zenle';
      openModal('mTahakkuk');
    }

    async function deleteTahakkuk(id){
      const t = tahakkukDocs.find(x=>x.id===id);
      const ok = confirm((t?.personel ? (t.personel + ' - ') : '') + 'Tahakkuk ve baÄŸlÄ± tahsilatlar silinsin mi?');
      if (!ok) return;
      
      const supabase = getSupabase();
      if (!supabase) throw new Error('Supabase client hazÄ±r deÄŸil');
      
      // Ã–nce tahsilatlarÄ± sil
      const related = tahsilatDocs.filter(x=>x.tahakkukid===id);
      if (related.length > 0) {
        const relatedIds = related.map(s => s.id);
        const { error: deleteTahsilatError } = await supabase
          .from('tahsilatlar')
          .delete()
          .in('id', relatedIds);
          
        if (deleteTahsilatError) throw deleteTahsilatError;
      }
      
      // Sonra tahakkuku sil
      const { error: deleteTahakkukError } = await supabase
        .from('tahakkuklar')
        .delete()
        .eq('id', id);
        
      if (deleteTahakkukError) throw deleteTahakkukError;
      
      tahakkukDocs = tahakkukDocs.filter(x=>x.id!==id);
      tahsilatDocs = tahsilatDocs.filter(x=>x.tahakkukid!==id);
      
      // Tablo satÄ±rlarÄ±nÄ± yeniden oluÅŸtur
      rebuildTableRows();
      
      // DOM'dan satÄ±rÄ± kaldÄ±r
      const useCards = qs('#cardList').style.display==='grid';
      if (!useCards){
        const tbody = qs('#tbody');
        Array.from(tbody.children).forEach(tr=>{
          if (tr.dataset.rowId === id) tr.remove();
        });
      } else {
        const list = qs('#cardList');
        Array.from(list.children).forEach(card=>{
          if (card.dataset.rowId === id) card.remove();
        });
      }
      
      // KPI'larÄ± gÃ¼ncelle
      updateKPIs();
      
      if(typeof window.showToast==='function') window.showToast('success','BaÅŸarÄ±lÄ±','Tahakkuk ve baÄŸlÄ± tahsilatlar silindi.');
    }

    // CSV dÄ±ÅŸa aktar
    function exportCSV(){
      const yil = qs('#filtreYil').value;
      const faaliyet = qs('#filtreFaaliyet').value;
      const q = (qs('#ara').value||'').trim().toLocaleLowerCase('tr-TR');

      let data = tableRows.slice();
      if (yil !== 'tum') data = data.filter(r => String(r.yil) === yil);
      if (faaliyet !== 'tum') data = data.filter(r => normTR(r.faaliyet) === normTR(faaliyet));
      data = data.map(r=>computeRowView(r));
      if (q) data = data.filter(r => [r.personel,r.borclu,r.odeyen,r.faaliyet].join(' ').toLocaleLowerCase('tr-TR').includes(q));

      const rows = [['yil','faaliyet','personel','borclu','odeyen','tahakkuk','tahsilat_eski','yeni','kalan']];
      data.forEach(r=>{
        rows.push([
          r.yil, r.faaliyet, r.personel||'', r.borclu||'', r.odeyen||'',
          (r.tahakkuk||0), (r.tahsilat||0), (r.yeni||0), (r.kalan||0)
        ]);
      });
      const csv = rows.map(a=>a.map(x=>String(x).includes(',')?`"${String(x).replace(/"/g,'""')}"`:x).join(',')).join('\n');
      const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a');
      a.href = URL.createObjectURL(blob); a.download = 'alacaklar-filtreli.csv'; document.body.appendChild(a); a.click(); a.remove();
    }

    // Toast bildirimi - ortak.js'den kullan (window.showToast)

    // Basit CSV iÃ§e aktar (yer tutucu)
    window.runImport = async function runImport(){
      const tahFile = document.getElementById('csvTahakkuk')?.files?.[0];
      const tslFile = document.getElementById('csvTahsilat')?.files?.[0];
      if(!tahFile && !tslFile){
        if(typeof window.showToast==='function') window.showToast('warning','Eksik Dosya','LÃ¼tfen en az bir CSV dosyasÄ± seÃ§in.');
        return;
      }
      if(typeof window.showToast==='function') window.showToast('info','CSV Ä°Ã§e Aktarma','CSV iÃ§e aktarma modÃ¼lÃ¼ bu sÃ¼rÃ¼mde Ã¶rnek amaÃ§lÄ±dÄ±r. GerÃ§ek aktarÄ±m mantÄ±ÄŸÄ± daha sonra eklenecektir.');
    };

    // PDF
    qs('#btnPDF').onclick = ()=>{
      const el = document.getElementById('pdf-root');
      const opt = {
        margin:[10,10,10,10],
        filename:'alacaklar.pdf',
        image:{type:'jpeg',quality:0.98},
        html2canvas:{scale:2, useCORS:true, scrollY:-window.scrollY},
        pagebreak:{mode:['css','legacy']},
        jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}
      };
      html2pdf().set(opt).from(el).save();
    };

    // BaÄŸlantÄ±lar
    qs('#btnExport').onclick = exportCSV;
    ['#filtreYil','#filtreFaaliyet','#ara','#yeniMode','#yeniBaslangic','#yeniBitis'].forEach(sel=>{
      const el = qs(sel);
      if (el) el.addEventListener('input', render);
    });

    // Ayarlar butonu (YÄ±l & Faaliyet modali)
    const btnAyarlar = qs('#btnAyarlar');
    if (btnAyarlar){
      btnAyarlar.addEventListener('click', ()=> openAyarlarModal());
    }

    // EÅŸleÅŸmeyen tahsilatlar (âš  butonu)
    const btnOrphan = qs('#btnOrphan');
    if (btnOrphan){
      btnOrphan.addEventListener('click', ()=>{
        const tbody = document.getElementById('tbodyOrphan');
        if (!tbody){
          openModal('mOrphan');
          return;
        }
        tbody.innerHTML = '';
        if (!orphanPayments.length){
          const tr = document.createElement('tr');
          tr.innerHTML = `<td colspan="8" class="muted" style="padding:10px;text-align:center">TÃ¼m tahsilatlar bir tahakkuk kaydÄ±yla eÅŸleÅŸiyor.</td>`;
          tbody.appendChild(tr);
        } else {
          orphanPayments.forEach(s=>{
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${s.yil || ''}</td>
              <td>${titleTR(s.faaliyet || '')}</td>
              <td>${titleTR(s.personel || '')}</td>
              <td>${titleTR(s.borclu || '')}</td>
              <td>${s.tarih || ''}</td>
              <td class="right">${money(s.tutar || 0)}</td>
              <td>${titleTR(s.odeyen || '')}</td>
              <td>${s.yontem || ''}</td>
            `;
            tbody.appendChild(tr);
          });
        }
        openModal('mOrphan');
      });
    }

    // Tablo sÃ¼tun baÅŸlÄ±klarÄ±nda sÄ±ralama
    (function initSorting(){
      const thead = document.querySelector('#tbl thead');
      if (!thead) return;
      thead.addEventListener('click',(e)=>{
        const th = e.target.closest('th[data-sort]');
        if (!th) return;
        const key = th.getAttribute('data-sort');
        if (!key) return;
        if (sortState.key === key){
          sortState.dir = sortState.dir === 'asc' ? 'desc' : 'asc';
        } else {
          sortState.key = key;
          sortState.dir = 'asc';
        }
        render();
      });
    })();

    const yeniModeEl = qs('#yeniMode');
    if (yeniModeEl){
      yeniModeEl.addEventListener('change', ()=>{
        const mode = yeniModeEl.value;
        const range = qs('#yeniRange');
        if (mode==='range'){
          range.style.display='flex';
          if (!qs('#yeniBaslangic').value || !qs('#yeniBitis').value){
            const today = new Date();
            const seven = new Date(); seven.setDate(today.getDate()-7);
            qs('#yeniBaslangic').value = seven.toISOString().slice(0,10);
            qs('#yeniBitis').value = today.toISOString().slice(0,10);
          }
        } else {
          range.style.display='none';
        }
        render();
      });
    }

    // Modaller
    qs('#btnTahakkuk').onclick = ()=>{
      editingTahakkukId = null;
      qs('#mTahakkuk h3').textContent = 'Tahakkuk Ekle';
      qs('#t_tutar').value='';
      qs('#t_personel').value='';
      qs('#t_borclu').value='';
      qs('#t_odeyen').value='';
      qs('#t_aciklama').value='';
      openModal('mTahakkuk');
    };
    qs('#btnTahsilat').onclick  = ()=> openModal('mTahsilat');

    // BaÅŸlat
    async function initPage(){
      await loadMetaOptions();
      loadAll().then(ensureMobileDefaults).catch(e=>{
        console.error('Veri yÃ¼klenemedi', e);
        const errorMsg = e && e.message ? e.message : String(e);
        if(typeof window.showToast==='function') {
          window.showToast('error','Veri YÃ¼kleme HatasÄ±',`Veri yÃ¼klenirken bir hata oluÅŸtu: ${errorMsg}`);
        }
        tableRows=[]; render(); ensureMobileDefaults();
      });

      // Ä°ÅŸlem logu: sayfa aÃ§Ä±ldÄ± kaydÄ±
      const sb = getSupabase();
      if (sb) {
        try {
          const { data: { user } } = await sb.auth.getUser();
          await sb.from('islem_log').insert({
            islem: 'sayfa_acildi',
            uid: user?.id || null,
            sayfa: 'alacak-takibi',
            path: 'personel/alacak-takibi.html',
            user_agent: typeof navigator !== 'undefined' ? navigator.userAgent : null
          });
        } catch (logErr) {
          console.warn('Ä°ÅŸlem logu kaydedilemedi:', logErr);
        }
      }
    }

    // Navigation, Auth, Bildirimler ve Toast ortak.js'den geliyor
    // Sayfa Ã¶zel verilerini yÃ¼klemek iÃ§in initPage() fonksiyonu ortak.js tarafÄ±ndan Ã§aÄŸrÄ±lacak
    
    // Sayfa Ã¶zel init fonksiyonu - ortak.js tarafÄ±ndan Ã§aÄŸrÄ±lacak
    window.initPage = initPage;
  </script>
</body>
</html>
