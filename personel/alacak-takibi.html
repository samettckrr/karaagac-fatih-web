<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Alacaklar | Personel</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="../../js/firebase/firebase-init.js"></script>

  <!-- html2pdf -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" defer></script>

  <style>
    :root{
      --bg:#f4f6f9; --card:#ffffff; --ink:#2c3e50; --muted:#6c7a89;
      --accent:#324960; --good:#2d6a4f; --warn:#d35400; --bad:#c0392b;
      --border:#e6ebf2;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:'Segoe UI',system-ui,-apple-system,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    header{position:sticky;top:0;z-index:5;background:var(--card);border-bottom:1px solid var(--border)}
    .wrap{max-width:1180px;margin:0 auto;padding:12px 16px}
    .row{display:grid;gap:12px}
    .row.cols-4{grid-template-columns:repeat(4,1fr)}
    @media (max-width:900px){.row.cols-4{grid-template-columns:1fr 1fr}}
    @media (max-width:640px){.row.cols-4{grid-template-columns:1fr}}

    .toolbar{display:flex;gap:10px;flex-wrap:nowrap;align-items:center;overflow:auto;padding-bottom:6px}
    .toolbar::-webkit-scrollbar{height:6px}
    .toolbar::-webkit-scrollbar-thumb{background:#d7dde6;border-radius:999px}
    select,input,button{
      height:38px;border:1px solid var(--border);background:#fff;border-radius:10px;padding:0 12px;font:inherit;color:var(--ink);white-space:nowrap
    }
    input{min-width:220px}
    button{background:var(--accent);color:#fff;border:none;cursor:pointer;white-space:nowrap}
    button.secondary{background:#fff;color:var(--ink);border:1px solid var(--border)}
    button.good{background:var(--good)}
    button.bad{background:var(--bad)}
    .chip{padding:8px 10px;border-radius:999px;border:1px solid var(--border);background:#fff;color:var(--muted);font-size:12px;white-space:nowrap}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:14px}
    .kpi{display:flex;flex-direction:column;gap:4px}
    .kpi .label{color:var(--muted);font-size:12px}
    .kpi .value{font-size:20px;font-weight:600}
    .kpi.good .value{color:var(--good)}
    .kpi.warn .value{color:var(--warn)}
    .kpi.bad  .value{color:var(--bad)}
    .muted{color:var(--muted)}
    .line{height:1px;background:var(--border);margin:8px 0}

    body.modal-open{overflow:hidden}
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.28);display:none;align-items:center;justify-content:center;padding:16px;z-index:9999}
    .modal.show{display:flex}
    .sheet{max-width:760px;width:100%;background:#fff;border-radius:16px;padding:18px;border:1px solid var(--border)}

    .table-wrap{overflow:auto;border:1px solid var(--border);border-radius:12px}
    table{width:100%;border-collapse:collapse;background:#fff;min-width:880px}
    thead th{position:sticky;top:0;background:#fafbfc;border-bottom:1px solid var(--border);font-weight:600;text-align:left;font-size:13px;color:var(--muted);padding:10px}
    tbody td{border-bottom:1px solid var(--border);padding:10px;font-size:14px}
    tbody tr.zero{background:#f2fbf6}
    tfoot td{border-top:2px solid var(--border);padding:10px;font-weight:600}
    .right{text-align:right}
    .person-link{color:#1f6feb;text-decoration:none}
    .person-link:hover{text-decoration:underline}

    .avoid-break{page-break-inside:avoid;break-inside:avoid}
    @media print{
      header{position:static;border:none}
      .toolbar{display:none!important}
      .wrap{max-width:100%;padding:0}
      .card{border:none;padding:0}
      .table-wrap{border:none}
    }

    .modal .sheet .grid{display:grid;gap:10px}
    .modal .sheet label{display:block;font-size:12px;color:var(--muted);margin-bottom:4px}
    .modal .sheet input, .modal .sheet select{width:100%;height:38px;border:1px solid var(--border);border-radius:10px;padding:0 10px}
    .modal .sheet .actions{display:flex;justify-content:flex-end;gap:8px;margin-top:10px}

    header strong{font-size:clamp(16px,3.8vw,18px);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:40vw}

    .card-list{display:none;gap:10px}
    .mini-card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:6px}
    .mini-line{display:flex;justify-content:space-between;gap:8px;font-size:14px}
    .mini-hl{font-weight:600}
    .switcher{display:flex;gap:6px;align-items:center;white-space:nowrap}

    @media (max-width:540px){
      .table-wrap{display:none}
      .card-list{display:grid}
      input{min-width:160px}
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="toolbar">
        <strong>Alacaklar</strong>
        <span class="chip">Kolonlar: Yıl / Faaliyet / Personel / Borçlu / Ödeyen / Tahakkuk / Tahsilat / Yeni Tahsilat / Kalan</span>
        <div style="flex:1"></div>
        <label class="switcher" title="Mobilde kart görünüm otomatik açılır">
          <input id="toggleKart" type="checkbox" style="accent-color:#324960" />
          <span class="muted">Kart Görünüm</span>
        </label>
      </div>
      <div class="line"></div>
      <div class="toolbar" id="tools">
        <select id="filtreYil">
          <option value="tum">Yıl: Tümü</option>
          <option>2023</option><option>2024</option><option selected>2025</option>
        </select>
        <select id="filtreFaaliyet">
          <option value="tum">Faaliyet: Tümü</option>
          <option>İftar</option><option>Sahur</option><option>İhvan Taahhüt</option>
          <option>Muhibban Taahhüt</option><option>Bağış Kurban</option>
          <option>Büyükbaş Kurban</option><option>Veli Teberrusu</option>
        </select>
        <input id="ara" placeholder="Personel / Borçlu / Ödeyen ara..." />
        <select id="kesit">
          <option value="tum">Kesit: Tümü</option>
          <option value="once">16 Haziran öncesi</option>
          <option value="sonra">16 Haziran sonrası</option>
        </select>
        <div style="flex:1"></div>
        <button id="btnImport" class="secondary">Veri İçe Aktar (CSV)</button>
        <button id="btnExport" class="secondary">CSV Dışa Aktar</button>
        <button id="btnTahakkuk">Tahakkuk Ekle</button>
        <button id="btnTahsilat" class="secondary">Tahsilat Ekle</button>
        <button id="btnPDF" class="good">PDF'ye Aktar</button>
      </div>
    </div>
  </header>

  <main class="wrap" id="pdf-root">
    <div class="row cols-4" id="kpiRow">
      <div class="card kpi"><span class="label">Seçili Yıl Toplam Alacak</span><span class="value" id="kpiToplam">₺0</span></div>
      <div class="card kpi"><span class="label">Seçili Yıl Toplam Tahsilat</span><span class="value" id="kpiTahsilat">₺0</span></div>
      <div class="card kpi warn"><span class="label">Seçili Yıl Kalan</span><span class="value" id="kpiKalan">₺0</span></div>
      <div class="card kpi"><span class="label">Tahsilat Nispeti</span><span class="value" id="kpiOran">0%</span></div>
    </div>

    <div class="card" style="margin-top:14px">
      <div style="display:flex;align-items:center;gap:10px;margin-bottom:8px;flex-wrap:wrap">
        <h3 style="margin:0">Detaylı Liste | Seçime Göre</h3>
        <span class="muted">Veri Firestore'dan gelir; Yeni Tahsilat = son 7 gün.</span>
      </div>

      <div class="table-wrap" id="tableWrap">
        <table id="tbl">
          <thead>
            <tr>
              <th>Yıl</th><th>Faaliyet</th><th>Personel Adı Soyadı</th><th>Borçlu Adı Soyadı</th><th>Ödeyen Kişi</th>
              <th class="right">Tahakkuk</th><th class="right">Tahsilat</th><th class="right">Yeni Tahsilat</th><th class="right">Kalan</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
          <tfoot>
            <tr>
              <td colspan="5" class="right">TOPLAM</td>
              <td class="right" id="sumTahakkuk">₺0</td>
              <td class="right" id="sumTahsilat">₺0</td>
              <td class="right" id="sumYeni">₺0</td>
              <td class="right" id="sumKalan">₺0</td>
            </tr>
          </tfoot>
        </table>
      </div>

      <div class="card-list" id="cardList"></div>
    </div>
  </main>

  <!-- Modaller (değişmedi) -->
  <!-- ... (modallerin HTML’i aynı bırakıldı) ... -->

  <script>
    // ===== Yardımcılar
    const qs = s => document.querySelector(s);
    const money = n => new Intl.NumberFormat('tr-TR',{style:'currency',currency:'TRY',maximumFractionDigits:2}).format(n||0);
    const todayStr = ()=> new Date().toISOString().slice(0,10);
    const CUTOFF = '2025-06-16';
    const db = window.db;

    // Normalize yardımcıları (TR duyarlı)
    // ==== TR title-case: boşluk, tire, apostrof, nokta vb. ayırıcıları korur
const tidy   = s => (s||'').toString().trim().replace(/\s+/g,' ');
const normTR = s => tidy(s).toLocaleLowerCase('tr-TR');
function titleTR(s){
  const lower = normTR(s);
  // ayırıcıları (boşluk, -, _, ., /, :, ;, ,, parantez, apostrof, sağ apostrof) koru
  const SEP = /([ \t\r\n\-\u2019'_/.,;:()]+)/;
  return lower.split(SEP).map(part=>{
    if (!part || SEP.test(part)) return part; // ayırıcıysa dokunma
    return part.charAt(0).toLocaleUpperCase('tr-TR') + part.slice(1);
  }).join('');
}

    let tahakkukDocs = [], tahsilatDocs = [], tableRows = [];

    // Modal davranışları (aynı)
    function openModal(id){ qs('#'+id).classList.add('show'); document.body.classList.add('modal-open'); setTimeout(()=> qs('#'+id).querySelector('input,select')?.focus(), 50); }
    function closeModal(id){ qs('#'+id).classList.remove('show'); if(!document.querySelector('.modal.show')) document.body.classList.remove('modal-open'); }
    document.addEventListener('click', (e)=>{ if(e.target.classList?.contains('modal')) closeModal(e.target.id); });
    document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') document.querySelectorAll('.modal.show').forEach(m=>m.classList.remove('show')); });
    ['#mTahakkuk','#mTahsilat'].forEach(mid=>{
      const m = qs(mid);
      m?.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ if(mid==='#mTahakkuk') saveTahakkuk(); else saveTahsilat(); } });
    });

    function ensureMobileDefaults(){
      if (window.innerWidth <= 540) qs('#toggleKart').checked = true;
      toggleView();
    }
    window.addEventListener('resize', ensureMobileDefaults);
    function toggleView(){
      const useCards = qs('#toggleKart').checked || window.innerWidth<=540;
      qs('#tableWrap').style.display = useCards ? 'none' : 'block';
      qs('#cardList').style.display  = useCards ? 'grid' : 'none';
      render();
    }
    qs('#toggleKart').addEventListener('change', toggleView);

    // Firestore yükle
    async function loadAll(){
      const tSnap = await db.collection('tahakkuklar').get();
      tahakkukDocs = tSnap.docs.map(d=>({ id:d.id, ...d.data() }));

      const sSnap = await db.collection('tahsilatlar').get();
      tahsilatDocs = sSnap.docs.map(d=>({ id:d.id, ...d.data() }));

      const sevenDaysAgo = new Date(); sevenDaysAgo.setDate(sevenDaysAgo.getDate()-7);
      const sevenStr = sevenDaysAgo.toISOString().slice(0,10);

      tableRows = tahakkukDocs.map(t=>{
        // EŞLEŞTİRME: önce tahakkukId, yoksa TR‑locale anahtar
        const key = `${t.yil}||${normTR(t.faaliyet)}||${normTR(t.personel)}||${normTR(t.borclu)}`;
        const related = tahsilatDocs.filter(s=>{
        const sKey = `${s.yil}||${normTR(s.faaliyet)}||${normTR(s.personel)}||${normTR(s.borclu)}`;
         return (s.tahakkukId===t.id) || (sKey===key);
        });

        // TEKİLLEŞTİR
        const seen = new Set(); const uniq = [];
        related.forEach(x=>{ if(!seen.has(x.id)){ seen.add(x.id); uniq.push(x); } });

        // TOPLAMLAR
        const sumAll = uniq.reduce((a,b)=>a+Number(b.tutar||0),0);
        const sumNew = uniq.filter(x=> (x.tarih||'') >= sevenStr).reduce((a,b)=>a+Number(b.tutar||0),0);

        return {
          id:t.id,
          yil:Number(t.yil),
          // EKRANDA GÖRÜNECEK metinler
          faaliyet: titleTR(t.faaliyet),
          personel: titleTR(t.personel),
          borclu:   titleTR(t.borclu),
          odeyen:   titleTR(related[related.length-1]?.odeyen || ''),
         // FİLTRE/EŞLEŞTİRME anahtarları (gerekirse)
          faaliyetKey: normTR(t.faaliyet),
          personelKey: normTR(t.personel),
          borcluKey:   normTR(t.borclu),
          personelRaw: tidy(t.personel),  // link için ham değer
          tahakkuk: Number(t.tahakkuk||0),
          // ÖNEMLİ: eski tahsilat = tüm tahsilat - son 7 gün
          tahsilat: Number(sumAll - sumNew),
          // yeni = son 7 gün
          yeni:     Number(sumNew),
          tarih:    uniq[uniq.length-1]?.tarih || t.createdAt || '',
        };
      });

      render();
    }

    // Kaydet (tahakkuk)
    async function saveTahakkuk(){
      const r = {
        yil: Number(qs('#t_yil').value),
        faaliyet: titleTR(qs('#t_faaliyet').value),
        personel: titleTR(qs('#t_personel').value),
        borclu:   titleTR(qs('#t_borclu').value),
        tahakkuk: Number(qs('#t_tutar').value||0),
        aciklama: tidy(qs('#t_aciklama').value),
        createdAt: todayStr(),
      };
      if(!r.yil || !r.faaliyet || !r.personel || !r.borclu || !r.tahakkuk){ alert('Zorunlu alanlar boş.'); return; }
      const docRef = await db.collection('tahakkuklar').add(r);
      tahakkukDocs.push({id:docRef.id, ...r});
      closeModal('mTahakkuk'); await loadAll();
    }

    // Kaydet (tahsilat)
    async function saveTahsilat(){
      const ref = qs('#s_tahakkukRef').dataset.tahakkukId || '';
      const tutar = Number(qs('#s_tutar').value||0);
      const tarih = qs('#s_tarih').value || todayStr();
      if(!ref || !tutar){ alert('Tahakkuk seç ve tutar yaz.'); return; }
      const tah = tahakkukDocs.find(x=>x.id===ref);
      if(!tah){ alert('Eşleşen tahakkuk bulunamadı.'); return; }
      const sDoc = {
        tahakkukId: ref,
        yil: tah.yil, faaliyet: normTR(tah.faaliyet), personel: normTR(tah.personel), borclu: normTR(tah.borclu),
        tutar, tarih,
        odeyen: tidy(qs('#s_odeyen').value),
        yontem: tidy(qs('#s_yontem').value),
        createdAt: todayStr()
      };
      await db.collection('tahsilatlar').add(sDoc);
      tahsilatDocs.push({ id:'tmp', ...sDoc });
      closeModal('mTahsilat'); await loadAll();
    }

    // Render (tablo + kart)
    function render(){
      const yil = qs('#filtreYil').value;
      const faaliyet = qs('#filtreFaaliyet').value;
      const q = (qs('#ara').value||'').trim().toLocaleLowerCase('tr-TR');
      const kesit = qs('#kesit').value;
      const useCards = qs('#cardList').style.display==='grid';

      let data = tableRows.slice();
      if (yil !== 'tum') data = data.filter(r => String(r.yil) === yil);
      if (faaliyet !== 'tum') data = data.filter(r => r.faaliyetKey === normTR(faaliyet));      if (q) data = data.filter(r => [r.personel,r.borclu,r.odeyen,r.faaliyet].join(' ').toLocaleLowerCase('tr-TR').includes(q));
      if (kesit !== 'tum') {
        data = data.filter(r => r.tarih && (kesit==='once' ? (r.tarih < CUTOFF) : (r.tarih >= CUTOFF)));
      }

      // TOPLAM/KPI — tek tanım
      const sumTahakkuk = data.reduce((a,b)=>a+(b.tahakkuk||0),0);
      const sumTahsilat = data.reduce((a,b)=>a+((b.tahsilat||0)),0);
      const sumYeni     = data.reduce((a,b)=>a+((b.yeni||0)),0);
      const sumKalan    = data.reduce((a,b)=>a+((b.tahakkuk||0)-((b.tahsilat||0)+(b.yeni||0))),0);

      const yilFilter = (yil==='tum') ? tableRows : tableRows.filter(r=>String(r.yil)===yil);
      const tTahakkuk = yilFilter.reduce((a,b)=>a+(b.tahakkuk||0),0);
      const tTsl      = yilFilter.reduce((a,b)=>a+((b.tahsilat||0)+(b.yeni||0)),0); // toplam tahsilat = eski + yeni
      const tKalan    = tTahakkuk - tTsl;
      const oran      = tTahakkuk>0 ? (tTsl/tTahakkuk*100) : 0;

      qs('#sumTahakkuk').textContent = money(sumTahakkuk);
      qs('#sumTahsilat').textContent = money(sumTahsilat);
      qs('#sumYeni').textContent     = money(sumYeni);
      qs('#sumKalan').textContent    = money(sumKalan);
      qs('#kpiToplam').textContent   = money(tTahakkuk);
      qs('#kpiTahsilat').textContent = money(tTsl);
      qs('#kpiKalan').textContent    = money(tKalan);
      qs('#kpiOran').textContent     = `${oran.toFixed(1)}%`;

      if (!useCards){
        const tbody = qs('#tbody'); tbody.innerHTML = '';
        data.forEach(r=>{
          const toplamTsl = (r.tahsilat||0)+(r.yeni||0);
          const kalan = (r.tahakkuk||0) - toplamTsl;
          const personParam = encodeURIComponent(r.personelRaw || r.personel);
          const yilParam = (yil==='tum') ? 'tum' : r.yil;
          const tr = document.createElement('tr');
          if (Math.abs(kalan) < 0.001) tr.classList.add('zero');
          tr.innerHTML = `
            <td>${r.yil}</td>
            <td>${r.faaliyet}</td>
            <td><a class="person-link" href="rapor-personel.html?personel=${personParam}&yil=${yilParam}" title="Kişi Raporu">${r.personel||''}</a></td>
            <td>${r.borclu||''}</td>
            <td>${r.odeyen||''}</td>
            <td class="right">${money(r.tahakkuk)}</td>
            <td class="right">${money(r.tahsilat)}</td>
            <td class="right">${money(r.yeni)}</td>
            <td class="right">${money(kalan)}</td>
          `;
          tr.addEventListener('click', (ev)=>{
            if (ev.target && ev.target.classList.contains('person-link')) return;
            qs('#s_tahakkukRef').value = `${r.yil} • ${r.faaliyet} • ${r.personel} • ${money(r.tahakkuk)}`;
            qs('#s_tahakkukRef').dataset.tahakkukId = r.id;
            openModal('mTahsilat');
          });
          tbody.appendChild(tr);
        });
      } else {
        const list = qs('#cardList'); list.innerHTML='';
        data.forEach(r=>{
          const toplamTsl = (r.tahsilat||0)+(r.yeni||0);
          const kalan = (r.tahakkuk||0) - toplamTsl;
          const personParam = encodeURIComponent(r.personel||'');
          const yilParam = (yil==='tum') ? 'tum' : r.yil;
          const div = document.createElement('div');
          div.className='mini-card';
          div.innerHTML = `
            <div class="mini-line"><span class="mini-hl">${r.personel||''}</span> <a class="person-link" href="rapor-personel.html?personel=${personParam}&yil=${yilParam}">Kişi Raporu →</a></div>
            <div class="mini-line"><span>${r.yil} • ${r.faaliyet}</span><span>${r.borclu||''}</span></div>
            <div class="mini-line"><span>Ödeyen</span><span>${r.odeyen||'-'}</span></div>
            <div class="mini-line"><span>Tahakkuk</span><span>${money(r.tahakkuk)}</span></div>
            <div class="mini-line"><span>Eski Tahsilat</span><span>${money(r.tahsilat)}</span></div>
            <div class="mini-line"><span>Yeni (7g)</span><span>${money(r.yeni)}</span></div>
            <div class="mini-line"><span>Kalan</span><span style="font-weight:600">${money(kalan)}</span></div>
            <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
              <button class="secondary" style="height:34px" data-act="tahsilat">Tahsilat Ekle</button>
            </div>
          `;
          div.querySelector('[data-act="tahsilat"]').onclick = (ev)=>{
            ev.preventDefault(); ev.stopPropagation();
            qs('#s_tahakkukRef').value = `${r.yil} • ${r.faaliyet} • ${r.personel} • ${money(r.tahakkuk)}`;
            qs('#s_tahakkukRef').dataset.tahakkukId = r.id;
            openModal('mTahsilat');
          };
          list.appendChild(div);
        });
      }
    }

    // CSV dışa aktar
    function exportCSV(){
      const yil = qs('#filtreYil').value;
      const faaliyet = qs('#filtreFaaliyet').value;
      const q = (qs('#ara').value||'').trim().toLocaleLowerCase('tr-TR');
      const kesit = qs('#kesit').value;

      let data = tableRows.slice();
      if (yil !== 'tum') data = data.filter(r => String(r.yil) === yil);
      if (faaliyet !== 'tum') data = data.filter(r => normTR(r.faaliyet) === normTR(faaliyet));
      if (q) data = data.filter(r => [r.personel,r.borclu,r.odeyen,r.faaliyet].join(' ').toLocaleLowerCase('tr-TR').includes(q));
      if (kesit !== 'tum') data = data.filter(r => r.tarih && (kesit==='once' ? (r.tarih < CUTOFF) : (r.tarih >= CUTOFF)));

      const rows = [['yil','faaliyet','personel','borclu','odeyen','tahakkuk','tahsilat_eski','yeni_7g','kalan']];
      data.forEach(r=>{
        rows.push([
          r.yil, r.faaliyet, r.personel||'', r.borclu||'', r.odeyen||'',
          (r.tahakkuk||0), (r.tahsilat||0), (r.yeni||0), ((r.tahakkuk||0)-(r.tahsilat||0)-(r.yeni||0))
        ]);
      });
      const csv = rows.map(a=>a.map(x=>String(x).includes(',')?`"${String(x).replace(/"/g,'""')}"`:x).join(',')).join('\n');
      const blob = new Blob([csv],{type:'text/csv;charset=utf-8;'}); const a=document.createElement('a');
      a.href = URL.createObjectURL(blob); a.download = 'alacaklar-filtreli.csv'; document.body.appendChild(a); a.click(); a.remove();
    }

    // PDF
    qs('#btnPDF').onclick = ()=>{
      const el = document.getElementById('pdf-root');
      const opt = {
        margin:[10,10,10,10],
        filename:'alacaklar.pdf',
        image:{type:'jpeg',quality:0.98},
        html2canvas:{scale:2, useCORS:true, scrollY:-window.scrollY},
        pagebreak:{mode:['css','legacy']},
        jsPDF:{unit:'mm',format:'a4',orientation:'portrait'}
      };
      html2pdf().set(opt).from(el).save();
    };

    // Bağlantılar
    qs('#btnExport').onclick = exportCSV;
    ['#filtreYil','#filtreFaaliyet','#ara','#kesit'].forEach(sel=>{ qs(sel).addEventListener('input', render); });

    // Modaller
    qs('#btnTahakkuk').onclick = ()=> openModal('mTahakkuk');
    qs('#btnTahsilat').onclick  = ()=> openModal('mTahsilat');
    qs('#btnImport').onclick    = ()=> openModal('mImport');

    // Başlat
    loadAll().then(ensureMobileDefaults).catch(e=>{
      console.error('Firestore yüklenemedi', e);
      tableRows=[]; render(); ensureMobileDefaults();
    });
  </script>
</body>
</html>
