<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Karaağaç Fatih</title>

<!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="../../js/firebase/firebase-init.js"></script>

<style>
  :root{
    --bg:#fafaf9; --paper:#ffffff; --ink:#0f172a; --muted:#6b7280; --line:#e7e5e4;
    --accent:#16a34a; --accent2:#f59e0b;
    --good:#16a34a; --warn:#ea580c; --bad:#dc2626;
    --r:16px; --shadow:0 10px 30px rgba(2,6,12,.08);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial; color:var(--ink); background:var(--bg)}
  a{color:inherit; text-decoration:none}

  header{position:sticky; top:0; z-index:50; background:rgba(255,255,255,.9); backdrop-filter:blur(8px); border-bottom:1px solid var(--line)}
  .topbar{height:56px; display:flex; align-items:center; justify-content:space-between; gap:12px; padding:0 12px}
  .brand{font-weight:800; letter-spacing:.2px; cursor:pointer}
  .right{display:flex; align-items:center; gap:10px}
  .tabs{display:flex; gap:8px}
  .tab{padding:8px 12px; border:1px solid var(--line); border-radius:999px; background:#fff; cursor:pointer}
  .tab.active{background:linear-gradient(90deg,var(--accent),var(--accent2)); color:white; border:none}
  .pill{font-size:12px; color:var(--muted)}

  .wrap{max-width:1000px; margin:0 auto; padding:12px}
  .card{background:var(--paper); border:1px solid var(--line); border-radius:var(--r); box-shadow:var(--shadow); padding:14px; margin:12px 0}

  .hero h1{margin:0 0 6px 0; font-size:26px}
  .hero p{margin:0 0 12px 0; color:var(--muted)}
  input[type="text"], select, input[type="date"], input[type="number"]{
    width:100%; padding:12px 14px; background:#fff; color:var(--ink);
    border:1px solid var(--line); border-radius:12px; outline:none;
  }
  .btn{display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:10px 14px; border-radius:12px; border:1px solid var(--line); background:#fff; color:var(--ink); font-weight:700; cursor:pointer}
  .btn.primary{background:linear-gradient(90deg,var(--accent),var(--accent2)); color:#fff; border:none}
  .btn[disabled]{opacity:.5; pointer-events:none}
  .hint{font-size:12px; color:var(--muted)}
  .num{font-variant-numeric:tabular-nums}

  .kpi{display:grid; grid-template-columns:1fr 1fr; gap:10px}
  .kpi .box{background:#fff; border:1px solid var(--line); border-radius:12px; padding:10px}
  .kpi .label{font-size:12px; color:var(--muted)}
  .kpi .value{font-size:20px; font-weight:800; margin-top:2px}

  .qs{display:grid; gap:10px}
  .alacak{background:#fff; border:1px solid var(--line); border-radius:14px; padding:12px; margin:10px 0; animation:fadeUp .25s ease both}
  .title{font-weight:800}
  .meta{display:flex; gap:6px; flex-wrap:wrap; margin:6px 0}
  .badge{font-size:11px; padding:4px 8px; border-radius:999px; background:#f3f4f6; border:1px solid var(--line); color:#111827}
  .money .line{display:flex; justify-content:space-between}
  .good{color:var(--good)} .warn{color:var(--warn)} .bad{color:var(--bad)}
  .empty{padding:18px; text-align:center; color:var(--muted)}
  @keyframes fadeUp{from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:translateY(0)}}

  .modal{position:fixed; inset:0; z-index:80; display:none; align-items:flex-end; background:rgba(15,23,42,.18)}
  .modal.open{display:flex}
  .sheet{width:100%; background:#fff; border-top:1px solid var(--line); border-radius:16px 16px 0 0; box-shadow:0 -20px 40px rgba(2,6,12,.18)}
  .sheet .head{display:flex; align-items:center; justify-content:space-between; padding:12px; border-bottom:1px solid var(--line)}
  .sheet .body{padding:12px}
  .field{margin:8px 0}

  .calHead{display:flex; align-items:center; justify-content:space-between; gap:8px}
  .calGrid{margin-top:8px; display:grid; grid-template-columns:repeat(7,1fr); gap:6px}
  .dow{font-size:12px; color:var(--muted); text-align:center}
  .day{border:1px solid var(--line); border-radius:12px; min-height:72px; padding:6px; background:#fff; display:flex; flex-direction:column; justify-content:space-between; transition:transform .12s ease}
  .day:hover{transform:translateY(-1px)}
  .day .n{font-size:12px; opacity:.8}
  .dot{align-self:flex-end; font-size:11px; background:#fef3c7; color:#7c2d12; border:1px solid #fde68a; padding:2px 6px; border-radius:999px}
  .hm-0{background:#fff} .hm-1{background:#ecfdf5} .hm-2{background:#dcfce7} .hm-3{background:#bbf7d0} .hm-4{background:#86efac} .hm-5{background:#4ade80}
  .chart{width:100%; height:160px; border:1px solid var(--line); border-radius:12px; background:#fff; margin-top:10px; padding:6px}
</style>
</head>
<body>

<header>
  <div class="topbar">
    <a class="brand" href="../panel.html" title="Panele git">Karaağaç Fatih</a>
    <div class="right">
      <div class="tabs" role="tablist" aria-label="Mod">
        <button id="tabForm" class="tab active" role="tab" aria-selected="true">Form</button>
        <button id="tabCal"  class="tab" role="tab" aria-selected="false">Takvim</button>
      </div>
      <span id="userPill" class="pill" style="display:none">
        <b id="userPillName"></b> · <a href="#" id="btnChange">Değiştir</a>
      </span>
    </div>
  </div>
</header>

<div class="wrap">

  <!-- TEK SORU: isim seç -->
  <section id="hero" class="card hero">
    <h1>Önce isminizi seçin</h1>
    <p>Seçim cihazda saklanır. Formda kartlar veya takvim anında yüklenir.</p>
    <div style="display:grid; gap:10px; grid-template-columns:1fr; max-width:560px">
      <div>
        <label class="hint" for="selPersonel">İsim seçiniz</label>
        <select id="selPersonel"><option value="">— Seçiniz —</option></select>
        <div class="hint">Seçim: yerelde saklanır (<code>localStorage</code>).</div>
      </div>
    </div>
  </section>

  <!-- FORM -->
  <section id="formArea" class="card" style="display:none">
    <div class="kpi">
      <div class="box"><div class="label">Kullanıcı Adı</div><div class="value" id="kpiAd">—</div></div>
      <div class="box"><div class="label">2024 Kalan</div><div class="value num" id="kpi2024">—</div></div>
      <div class="box"><div class="label">2025 Kalan</div><div class="value num" id="kpi2025">—</div></div>
      <div class="box"><div class="label">Toplam Alacak</div><div class="value num" id="kpiToplam">—</div></div>
    </div>

    <div class="qs" style="margin-top:12px">
      <div>
        <label class="hint" for="selTercih">1) Zaman — Faaliyet — İsim (filtre türü)</label>
        <select id="selTercih">
          <option value="">(Filtreleme yok — tümü)</option>
          <option value="zaman">Zaman</option>
          <option value="faaliyet">Faaliyet</option>
          <option value="isim">İsim</option>
        </select>
      </div>
      <div>
        <label class="hint" id="lblIkincil" for="selIkincil">2) … seçiniz</label>
        <select id="selIkincil" disabled><option>Filtre türü seçiniz</option></select>
      </div>
    </div>
  </section>

  <!-- Liste -->
  <section id="listArea" class="card" style="display:none">
    <div id="listHost"><div class="empty">Kartlar yükleniyor…</div></div>
  </section>

  <!-- TAKVİM -->
  <section id="calArea" class="card" style="display:none">
    <div class="calHead">
      <div class="hint">Kullanıcı: <b id="calUser">—</b></div>
      <div class="hint" id="calTitle">—</div>
      <div style="display:flex; gap:6px">
        <button id="btnPrev" class="btn">←</button>
        <button id="btnToday" class="btn">Bugün</button>
        <button id="btnNext" class="btn">→</button>
      </div>
    </div>
    <div class="calGrid" id="calDow">
      <div class="dow">Pzt</div><div class="dow">Sal</div><div class="dow">Çar</div>
      <div class="dow">Per</div><div class="dow">Cum</div><div class="dow">Cmt</div><div class="dow">Paz</div>
    </div>
    <div class="calGrid" id="calGrid"></div>

    <div class="chart">
      <svg id="barChart" width="100%" height="140" preserveAspectRatio="none"></svg>
      <div class="hint" style="margin-top:4px">Çubuklar: Günlük toplam söz tutarı (₺)</div>
    </div>
  </section>

</div>

<!-- ÖDEME ZAMANI MODAL -->
<div id="modal" class="modal" aria-hidden="true">
  <div class="sheet">
    <div class="head">
      <div id="mTitle" class="title">Ödeme Zamanı Ekle</div>
      <button id="mClose" class="btn">Kapat</button>
    </div>
    <div class="body">
      <div id="mMeta" class="hint">—</div>
      <div class="field"><label class="hint" for="mDate">Ödeme Tarihi</label><input id="mDate" type="date"/></div>
      <div class="field"><label class="hint" for="mAmount">Ödeme Tutarı (₺)</label><input id="mAmount" type="number" min="1" step="1" placeholder="₺"/></div>
      <div class="field"><label class="hint" for="mTaksit">Taksit Sayısı (peşinse 0)</label><input id="mTaksit" type="number" min="0" step="1" value="0"/></div>
      <div class="row" style="margin-top:8px"><button id="mSave" class="btn primary">Kaydet</button><div id="mMsg" class="hint"></div></div>
    </div>
  </div>
</div>

<!-- GÜN DETAY SHEET -->
<div id="daySheet" class="modal" aria-hidden="true">
  <div class="sheet">
    <div class="head">
      <div class="title" id="dayTitle">Gün Detayı</div>
      <button id="dClose" class="btn">Kapat</button>
    </div>
    <div class="body" id="dayList"></div>
  </div>
</div>

<script>
/* =================== SABİT/LS =================== */
const LS_KEY = 'kf_selected_personel';

/* =================== PERSONEL (kanonik + alias) =================== */
const PERSONEL_CANON = [
  "Muhsin Çelik",
  "Faruk Nafiz Özgan",
  "Kerem Kocaoğlu",  // UI'da tek seçenek
  "Serhan Durak",
  "Mahmut Solmaz",
  "Samet Çakır",
  "Mehmet Taha Keskin",
  "Ahmetali Emre Şahin",
  "Muharrem Morcalı",
  "Burak Serin"
];
const PERSONEL_ALIASES = {
  "Kerem Kocaoğlu": ["Keramettin Kocaoğlu","KERAMETTIN KOCAOGLU","KERAMETTİN KOCAOĞLU"]
};

/* =================== YARDIMCI FONKSİYONLAR =================== */
const q = s=>document.querySelector(s);
const el = id=>document.getElementById(id);

const norm = s => (s||'').toLowerCase()
 .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
 .replaceAll('ı','i').replaceAll('ş','s').replaceAll('ğ','g').replaceAll('ü','u').replaceAll('ö','o').replaceAll('ç','c')
 .replace(/\s+/g,' ').trim();

function canonicalizeName(name){
  const n = norm(name);
  for(const c of PERSONEL_CANON){ if(norm(c)===n) return c; }
  for(const [canon, arr] of Object.entries(PERSONEL_ALIASES)){
    if(arr.some(a=> norm(a)===n)) return canon;
  }
  // heuristik: soyad eşit + ad ilk harf/önek
  for(const c of PERSONEL_CANON){ if(samePersonHeuristic(c, name)) return c; }
  return name;
}
function samePersonHeuristic(a,b){
  const A=norm(a), B=norm(b); if(!A||!B) return false;
  if(A===B) return true;
  const ta=A.split(' '), tb=B.split(' '), sa=ta.at(-1), sb=tb.at(-1), fa=ta[0], fb=tb[0];
  return (sa&&sb&&sa===sb) && (fa&&fb&&(fa[0]===fb[0] || fa.startsWith(fb) || fb.startsWith(fa)));
}
function samePerson(a,b){
  const A=canonicalizeName(a), B=canonicalizeName(b);
  return norm(A)===norm(B) || samePersonHeuristic(A,B);
}
function escapeHtml(str){ return (str||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
function fmtDate(d){try{const y=d.getFullYear(),m=String(d.getMonth()+1).padStart(2,'0'),dd=String(d.getDate()).padStart(2,'0');return `${dd}.${m}.${y}`}catch(e){return '—'}}
function fmtTS(ts){ try{ return fmtDate(ts.toDate()); }catch(e){ return '—'; } }
// TRY string -> number (11.500,90 => 11500.90)
function toNum(x){ if(typeof x==='number') return x; if(typeof x==='string'){ return Number(x.replace(/\./g,'').replace(',','.'))||0; } return 0; }
const fmtTRY = v => new Intl.NumberFormat('tr-TR',{style:'currency',currency:'TRY',maximumFractionDigits:2}).format(toNum(v));
const todayISO = ()=> new Date().toISOString().slice(0,10);

/* =================== DURUM =================== */
let SELECTED_PERSONEL = null;
let RAW = [];                 // seçili kişiye ait tahakkuklar
let YEARS=[], ACTS=[], NAMES=[];
let CURRENT_TERCIH=null, CURRENT_FILTER=null;
let CURRENT_TAH=null;         // modal context
let PERSON_TAH_IDS = new Set();
let CAL_MONTH = new Date();
let TAH_SAYIMAP = new Map();  // tahakkukId -> toplam tahsilat

/* =================== İSİM SEÇ (UI) =================== */
(function initNameSelect(){
  const sel = el('selPersonel');
  PERSONEL_CANON.forEach(n=>{ const o=document.createElement('option'); o.value=n; o.textContent=n; sel.appendChild(o); });

  const cached = localStorage.getItem(LS_KEY);
  if(cached){ const c=canonicalizeName(cached); sel.value=c; setPerson(c); afterNameChosen(); }

  sel.onchange = ()=>{ if(sel.value){ setPerson(sel.value); afterNameChosen(); } };
})();

function setPerson(name){
  SELECTED_PERSONEL = canonicalizeName(name);
  localStorage.setItem(LS_KEY, SELECTED_PERSONEL);
  el('kpiAd').textContent = SELECTED_PERSONEL;
  el('calUser').textContent = SELECTED_PERSONEL;
  el('userPill').style.display = 'inline';
  el('userPillName').textContent = SELECTED_PERSONEL;
}
el('btnChange').onclick = (e)=>{
  e.preventDefault();
  localStorage.removeItem(LS_KEY);
  SELECTED_PERSONEL = null;
  el('userPill').style.display = 'none';
  el('hero').style.display='';
  el('formArea').style.display='none';
  el('listArea').style.display='none';
  el('calArea').style.display='none';
  el('selPersonel').value='';
};

/* =================== AKIŞ: isim seçildikten sonra =================== */
async function afterNameChosen(){
  await loadTahakkukForPerson(SELECTED_PERSONEL);
  await loadTahsilatlarMap(SELECTED_PERSONEL);
  await buildKPI();

  el('hero').style.display='none';

  if (el('tabForm').classList.contains('active')){
    el('formArea').style.display=''; el('listArea').style.display=''; el('calArea').style.display='none';
    CURRENT_TERCIH=null; CURRENT_FILTER=null;
    el('selTercih').value='';
    const sec2=el('selIkincil'); sec2.disabled=true; sec2.innerHTML='<option>(Filtre yok)</option>';
    await renderList();
  } else {
    el('formArea').style.display='none'; el('listArea').style.display='none'; el('calArea').style.display='';
    await buildCalendar();
  }
}

/* =================== VERİ ÇEKİMİ =================== */
async function loadTahakkukForPerson(personName){
  RAW=[]; YEARS=[]; ACTS=[]; NAMES=[]; PERSON_TAH_IDS = new Set();
  const all = await db.collection('tahakkuklar').get();
  all.forEach(d=>{
    const r = { id:d.id, ...d.data() };
    if (samePerson(r.personel||'', personName)) { RAW.push(r); PERSON_TAH_IDS.add(d.id); }
  });
  YEARS=[...new Set(RAW.map(r=>Number(r.yil)).filter(Boolean))].sort();
  ACTS=[...new Set(RAW.map(r=>(r.faaliyet||'').trim()).filter(Boolean))].sort((a,b)=>a.localeCompare(b,'tr'));
  NAMES=[...new Set(RAW.map(r=>(r.borclu||'').trim()).filter(Boolean))].sort((a,b)=>a.localeCompare(b,'tr'));
  console.info('TAHAKKUK match sayısı:', RAW.length);
}
async function loadTahsilatlarMap(personName){
  TAH_SAYIMAP = new Map();
  const all = await db.collection('tahsilatlar').get();
  all.forEach(d=>{
    const x=d.data();
    if(!samePerson(x.personel||'', personName)) return;
    const key=String(x.tahakkukId||'');
    TAH_SAYIMAP.set(key, (TAH_SAYIMAP.get(key)||0) + toNum(x.tutar||0));
  });
  console.info('TAHSILAT map (adet):', TAH_SAYIMAP.size);
}

/* =================== KPI =================== */
async function buildKPI(){
  let k2024=0, k2025=0, kTop=0;
  for(const r of RAW){
    const tahakkuk=toNum(r.tahakkuk||r.toplamTahakkuk||0);
    const od=toNum(TAH_SAYIMAP.get(r.id)||0);
    const kalan=Math.max(0, tahakkuk-od);
    if(Number(r.yil)===2024) k2024+=kalan;
    if(Number(r.yil)===2025) k2025+=kalan;
    kTop+=kalan;
  }
  el('kpi2024').textContent=fmtTRY(k2024);
  el('kpi2025').textContent=fmtTRY(k2025);
  el('kpiToplam').textContent=fmtTRY(kTop);
}

/* =================== FORM FİLTRELERİ =================== */
el('selTercih').onchange = ()=>{
  CURRENT_TERCIH = el('selTercih').value || null;
  CURRENT_FILTER = null;
  const sec2 = el('selIkincil'); sec2.innerHTML='';
  if(!CURRENT_TERCIH){
    sec2.disabled=true; sec2.innerHTML='<option>(Filtre yok)</option>'; renderList(); return;
  }
  sec2.disabled=false;
  const add=(v,t)=>{ const o=document.createElement('option'); o.value=v; o.textContent=t; sec2.appendChild(o); };
  add('','— Seçiniz —');
  if(CURRENT_TERCIH==='zaman'){ YEARS.forEach(y=>add(y,y)); el('lblIkincil').textContent='2) Yıl seçiniz'; }
  if(CURRENT_TERCIH==='faaliyet'){ ACTS.forEach(f=>add(f,f)); el('lblIkincil').textContent='2) Faaliyet seçiniz'; }
  if(CURRENT_TERCIH==='isim'){ NAMES.forEach(n=>add(n,n)); el('lblIkincil').textContent='2) Borçlu seçiniz'; }
};
el('selIkincil').onchange = ()=>{ CURRENT_FILTER = el('selIkincil').value || null; renderList(); };

/* =================== LİSTE =================== */
async function renderList(){
  const host=el('listHost');
  let list = RAW.slice();
  if(CURRENT_TERCIH==='zaman' && CURRENT_FILTER) list = list.filter(r=> Number(r.yil)===Number(CURRENT_FILTER));
  if(CURRENT_TERCIH==='faaliyet' && CURRENT_FILTER) list = list.filter(r=> (r.faaliyet||'')===CURRENT_FILTER);
  if(CURRENT_TERCIH==='isim' && CURRENT_FILTER) list = list.filter(r=> (r.borclu||'')===CURRENT_FILTER);

  if(list.length===0){ host.innerHTML='<div class="empty">Kayıt bulunamadı.</div>'; return; }

  const cards = list.map(r=>{
    const tahakkuk=toNum(r.tahakkuk||r.toplamTahakkuk||0);
    const od=toNum(TAH_SAYIMAP.get(r.id)||0);
    const kalan=Math.max(0, tahakkuk-od);
    return {r,tahakkuk,od,kalan};
  }).sort((a,b)=> b.kalan - a.kalan);

  host.innerHTML='';
  for(const c of cards){
    const d=document.createElement('div');
    d.className='alacak';
    d.innerHTML=`
      <div class="row wrap">
        <div>
          <div class="title">${escapeHtml(c.r.borclu||'(isim yok)')}</div>
          <div class="meta">
            ${c.r.yil? `<span class="badge">${c.r.yil}</span>`:''}
            ${c.r.faaliyet? `<span class="badge">${escapeHtml(c.r.faaliyet)}</span>`:''}
            <span class="badge">${escapeHtml(c.r.personel||'—')}</span>
          </div>
        </div>
        <div style="text-align:right">
          <div class="money">
            <div class="line"><span>Tahakkuk</span><b class="num">${fmtTRY(c.tahakkuk)}</b></div>
            <div class="line"><span>Ödenen</span><b class="num ${c.od>0?'good':''}">${fmtTRY(c.od)}</b></div>
            <div class="line"><span>Kalan</span><b class="num ${c.kalan===0?'good':'warn'}">${fmtTRY(c.kalan)}</b></div>
          </div>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn primary" data-soz="${c.r.id}">Ödeme Zamanı Ekle</button>
      </div>
    `;
    host.appendChild(d);
  }
  host.querySelectorAll('[data-soz]').forEach(b=>{
    b.onclick=()=>{
      const id=b.getAttribute('data-soz');
      const r=list.find(x=>x.id===id);
      openModal(r);
    };
  });
}

/* =================== MODAL: ÖDEME ZAMANI =================== */
function openModal(r){
  CURRENT_TAH=r;
  el('mMeta').textContent = `${r.yil || '—'} • ${r.faaliyet || '—'} • ${r.borclu || '—'}`;
  el('mDate').value=todayISO(); el('mAmount').value=''; el('mTaksit').value=0; el('mMsg').textContent='';
  openSheet('modal');
}
function openSheet(id){ const m=el(id); m.classList.add('open'); m.setAttribute('aria-hidden','false'); }
function closeSheet(id){
  const m=el(id);
  if(document.activeElement) document.activeElement.blur();
  m.classList.remove('open'); m.setAttribute('aria-hidden','true');
}
el('mClose').onclick = ()=> closeSheet('modal');
el('dClose').onclick = ()=> closeSheet('daySheet');

el('mSave').onclick = async ()=>{
  const d = el('mDate').value, t=toNum(el('mAmount').value||0), k=Number(el('mTaksit').value||0);
  if(!d){ el('mMsg').textContent='Tarih seçiniz.'; return; }
  if(!(t>0)){ el('mMsg').textContent='Tutar 0’dan büyük olmalı.'; return; }
  if(k<0){ el('mMsg').textContent='Taksit 0 veya üzeri olmalı.'; return; }
  try{
    await db.collection('alacaktahsilattakibi').add({
      tahakkukId: CURRENT_TAH.id,
      borclu: CURRENT_TAH.borclu || null,
      faaliyet: CURRENT_TAH.faaliyet || null,
      personel: CURRENT_TAH.personel || null,
      yil: Number(CURRENT_TAH.yil)||null,
      sozTarih: firebase.firestore.Timestamp.fromDate(new Date(d+'T00:00:00')),
      sozTutar: toNum(t),
      taksitSayisi: Number(k),
      createdAt: firebase.firestore.Timestamp.now(),
      updatedAt: firebase.firestore.Timestamp.now()
    });
    el('mMsg').textContent='Kaydedildi.';
    setTimeout(()=> closeSheet('modal'), 350);
  }catch(e){ console.error(e); el('mMsg').textContent='Hata oluştu.'; }
};

/* =================== TAKVİM =================== */
el('tabForm').onclick = ()=>{
  el('tabForm').classList.add('active'); el('tabCal').classList.remove('active');
  if(SELECTED_PERSONEL){ el('formArea').style.display=''; el('listArea').style.display=''; el('calArea').style.display='none'; renderList(); }
  else { el('hero').scrollIntoView({behavior:'smooth'}); }
};
el('tabCal').onclick  = ()=>{
  el('tabCal').classList.add('active');  el('tabForm').classList.remove('active');
  if(SELECTED_PERSONEL){ el('formArea').style.display='none'; el('listArea').style.display='none'; el('calArea').style.display=''; buildCalendar(); }
  else { el('hero').scrollIntoView({behavior:'smooth'}); }
};
el('btnPrev').onclick = ()=>{ CAL_MONTH = new Date(CAL_MONTH.getFullYear(), CAL_MONTH.getMonth()-1, 1); buildCalendar(); };
el('btnNext').onclick = ()=>{ CAL_MONTH = new Date(CAL_MONTH.getFullYear(), CAL_MONTH.getMonth()+1, 1); buildCalendar(); };
el('btnToday').onclick= ()=>{ CAL_MONTH = new Date(); buildCalendar(); };

function calTitle(d){ const ay=['Ocak','Şubat','Mart','Nisan','Mayıs','Haziran','Temmuz','Ağustos','Eylül','Ekim','Kasım','Aralık'][d.getMonth()]; return `${ay} ${d.getFullYear()}`; }
function heatLevel(count){ if(count<=0) return 0; if(count===1) return 1; if(count===2) return 2; if(count<=4) return 3; if(count<=7) return 4; return 5; }

async function buildCalendar(){
  el('calTitle').textContent = calTitle(CAL_MONTH);
  const grid = el('calGrid'); grid.innerHTML='';
  const y = CAL_MONTH.getFullYear(), m = CAL_MONTH.getMonth();
  const start = new Date(y,m,1), end = new Date(y,m+1,1);
  const startDow = (start.getDay()+6)%7; // Pzt=0
  const dim = Math.round((end - start)/86400000);

  const monthSoz = await fetchMonthSoz(start, end);
  const perDay = new Map(); // iso -> {items:[], count,sum}
  monthSoz.forEach(x=>{
    const dt=x.sozTarih.toDate(); const iso=dt.toISOString().slice(0,10);
    if(!perDay.has(iso)) perDay.set(iso,{items:[],count:0,sum:0});
    const v=perDay.get(iso); v.items.push(x); v.count++; v.sum += toNum(x.sozTutar||0);
  });

  for(let i=0;i<startDow;i++){ const c=document.createElement('div'); c.className='day hm-0'; c.style.visibility='hidden'; grid.appendChild(c); }

  const todayIso = new Date().toISOString().slice(0,10);
  for(let d=1; d<=dim; d++){
    const dt=new Date(y,m,d); const iso=dt.toISOString().slice(0,10);
    const meta = perDay.get(iso) || {count:0,sum:0,items:[]};
    const level = heatLevel(meta.count);
    const cell=document.createElement('div'); cell.className=`day hm-${level}`+(iso===todayIso?' today':'');
    cell.innerHTML=`<div class="n">${d}</div>${meta.count? `<div class="dot">${meta.count}</div>`:''}`;
    cell.onclick = ()=> openDaySheet(iso, meta.items);
    grid.appendChild(cell);
  }
  drawBarChart(perDay, dim, y, m);
}

async function fetchMonthSoz(start, end){
  const arr=[];
  const qs = await db.collection('alacaktahsilattakibi')
    .where('sozTarih','>=', firebase.firestore.Timestamp.fromDate(start))
    .where('sozTarih','<',  firebase.firestore.Timestamp.fromDate(end))
    .get();
  qs.forEach(d=>{
    const x=d.data();
    if(PERSON_TAH_IDS.has(x.tahakkukId) || samePerson(x.personel||'', SELECTED_PERSONEL||'')) arr.push({id:d.id, ...x});
  });
  return arr;
}

function openDaySheet(iso, items){
  const [y,m,d]=iso.split('-'); el('dayTitle').textContent=`Gün: ${d}.${m}.${y}`;
  const list=el('dayList'); list.innerHTML= items.length? '' : '<div class="hint">Kayıt yok.</div>';
  items.sort((a,b)=> (a.borclu||'').localeCompare(b.borclu||'','tr'));
  items.forEach(x=>{
    const div=document.createElement('div');
    div.className='alacak';
    div.innerHTML=`<div class="row wrap">
      <div><div class="title">${escapeHtml(x.borclu||'—')}</div>
      <div class="meta"><span class="badge">${x.yil||'—'}</span> ${x.faaliyet? `<span class="badge">${escapeHtml(x.faaliyet)}</span>`:''}</div></div>
      <div style="text-align:right">
        <div class="hint">Tutar</div><div class="num"><b>${fmtTRY(x.sozTutar||0)}</b></div>
        <div class="hint">Taksit</div><div class="num"><b>${Number(x.taksitSayisi||0)}</b></div>
      </div>
    </div>`;
    list.appendChild(div);
  });
  openSheet('daySheet');
}

/* =================== CHART =================== */
function drawBarChart(perDay, dim, year, month){
  const svg = el('barChart');
  const w = svg.clientWidth || svg.parentElement.clientWidth;
  const h = Number(svg.getAttribute('height')) || 140;
  while(svg.firstChild) svg.removeChild(svg.firstChild);

  const values = Array.from({length:dim}, (_,i)=>{
    const d = new Date(year,month,i+1).toISOString().slice(0,10);
    return (perDay.get(d)?.sum || 0);
  });
  const max = Math.max(1, ...values);
  const barW = (w - 10) / dim;

  const axis = document.createElementNS('http://www.w3.org/2000/svg','line');
  axis.setAttribute('x1','0'); axis.setAttribute('x2',String(w));
  axis.setAttribute('y1',String(h-18)); axis.setAttribute('y2',String(h-18));
  axis.setAttribute('stroke','#e7e5e4'); svg.appendChild(axis);

  values.forEach((v,idx)=>{
    const bh = Math.round((v/max)*(h-28));
    const x = 5 + idx*barW;
    const y = (h-18) - bh;
    const rect = document.createElementNS('http://www.w3.org/2000/svg','rect');
    rect.setAttribute('x', String(x)); rect.setAttribute('y', String(y));
    rect.setAttribute('width', String(Math.max(1, barW-2))); rect.setAttribute('height', String(bh));
    rect.setAttribute('rx','3');
    rect.setAttribute('fill', idx%2 ? '#86efac' : '#fcd34d');
    rect.style.transition='height .35s ease';
    svg.appendChild(rect);
  });
}

/* =================== ESC & ERİŞİLEBİLİRLİK =================== */
document.addEventListener('keydown', e=>{
  if(e.key==='Escape'){
    if(el('modal').classList.contains('open')) closeSheet('modal');
    if(el('daySheet').classList.contains('open')) closeSheet('daySheet');
  }
});
</script>
</body>
</html>
