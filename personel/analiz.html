<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Personel Analiz (Açık Tema) | Karaağaç Fatih</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" type="image/png" href="../img/logo.png" />

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <!-- Projene uygun init -->
  <script src="../js/firebase/firebase-init.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <!-- html2pdf -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha512-YcsIPYv3W9bOibM6d8WJKQJmXhCPwW6ct3b8zT5r6nzeT8uEwWZL1QmJj1M4Dq6sa8lB+7mD8YV4Yxg8q0G4fA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <style>
    /* ============================
       AÇIK TEMA TASARIM DEĞERLERİ
       ============================ */
    :root{
      --appbar-h:56px;
      --radius:14px;
      --shadow:0 10px 24px rgba(15, 23, 42, .06);

      --bg:#f6f7fb;              /* sayfa zemini */
      --bg-grad1:#ffffff;        /* yumuşak degrade */
      --bg-grad2:#eef2ff;

      --card:#ffffff;            /* kart zemini */
      --stroke:rgba(15, 23, 42, .08); /* çerçeve */
      --text:#0f172a;            /* ana metin */
      --muted:#475569;           /* ikincil metin */

      --brand:#2563eb;           /* vurgu */
      --brand-weak:#e8eeff;

      --ok:#059669;
      --err:#e11d48;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji","Segoe UI Emoji";
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 20% -10%, var(--bg-grad2), transparent 60%),
        radial-gradient(900px 600px at 120% 10%, var(--bg-grad1), transparent 50%),
        var(--bg);
    }

    /* ÜST BAR */
    header{
      height:var(--appbar-h);
      display:flex; align-items:center; justify-content:space-between;
      padding:0 12px 0 16px; border-bottom:1px solid var(--stroke);
      position:sticky; top:0; z-index:10;
      background:linear-gradient(180deg, #ffffffee, #ffffffcc);
      backdrop-filter:saturate(160%) blur(6px);
    }
    header .title{display:flex; align-items:center; gap:10px; font-weight:700}
    header .title img{width:28px; height:28px; border-radius:8px}
    header .subtitle{font-size:12px; color:var(--muted); font-weight:500}

    .actions{display:flex; gap:8px}
    .btn{
      border:1px solid var(--stroke);
      background:#fff; color:var(--text);
      padding:8px 12px; border-radius:12px; cursor:pointer; transition:.2s; font-weight:600;
      box-shadow:0 2px 0 rgba(15,23,42,.02);
    }
    .btn:hover{transform:translateY(-1px); box-shadow:0 8px 18px rgba(15,23,42,.08)}
    .btn.brand{border-color:#c7d2fe; background:linear-gradient(180deg, var(--brand-weak), #fff)}
    .btn.danger{border-color:#fecaca; background:linear-gradient(180deg,#fff1f2,#fff)}

    main{padding:16px; max-width:1200px; margin:0 auto}
    .panel{display:grid; gap:14px; grid-template-columns: 1fr; margin-top:14px}

    /* FİLTRE KARTI */
    .card{
      background:var(--card); border:1px solid var(--stroke);
      border-radius:var(--radius); padding:14px; box-shadow:var(--shadow);
    }
    .filters{display:grid; gap:12px}
    .filters .row{display:grid; gap:10px; grid-template-columns: repeat(12, 1fr)}
    .filters .f{grid-column: span 12}
    .filters label{font-size:12px; color:var(--muted); display:block; margin-bottom:6px; font-weight:600}
    .filters select, .filters input{
      width:100%; padding:10px 12px; border-radius:12px; border:1px solid var(--stroke);
      background:#fff; color:var(--text);
      outline-color:#c7d2fe;
    }
    .inline{display:flex; gap:8px; flex-wrap:wrap}
    .tag{
      padding:6px 10px; border:1px solid var(--stroke); border-radius:999px; font-size:12px;
      background:#fff; cursor:pointer; user-select:none;
    }
    .tag.active{border-color:#c7d2fe; background:var(--brand-weak)}

    /* ÖZET KARTLAR */
    .cards{display:grid; gap:12px; grid-template-columns: repeat(4, 1fr)}
    .metric .sub{font-size:12px; color:var(--muted)}
    .metric .big{font-size:22px; font-weight:800; letter-spacing:.2px}
    .delta{font-size:12px; font-weight:700; margin-top:6px}
    .delta.up{color:var(--ok)} .delta.down{color:var(--err)}

    /* GRAFİKLER */
    .grid-2{display:grid; gap:12px; grid-template-columns: 2fr 1.4fr}
    canvas{width:100%; height:320px}

    /* TABLO */
    .table-wrap{overflow:auto; border:1px solid var(--stroke); border-radius:12px; background:#fff}
    table{width:100%; border-collapse:collapse; font-size:14px}
    th,td{padding:10px 12px; border-bottom:1px solid var(--stroke); background:#fff}
    th{text-align:left; color:#334155; background:#f8fafc; position:sticky; top:0; z-index:1}
    tr:hover td{background:#f9fbff}

    .footer-actions{display:flex; gap:8px; justify-content:flex-end; margin-top:10px}

    /* MODAL */
    dialog{
      width:min(960px, 94vw); border:none; padding:0; border-radius:16px; overflow:hidden;
      background:#fff; color:var(--text);
      box-shadow:0 40px 80px rgba(15,23,42,.15), 0 0 0 1px var(--stroke);
    }
    dialog::backdrop{background:linear-gradient(180deg,rgba(2,6,23,.25),rgba(2,6,23,.45))}
    .modal-head{display:flex; justify-content:space-between; align-items:center; padding:12px 14px; border-bottom:1px solid var(--stroke); background:#f8fafc}
    .modal-body{max-height:70vh; overflow:auto; padding:14px}
    .modal-foot{padding:12px 14px; border-top:1px solid var(--stroke); display:flex; gap:8px; justify-content:flex-end; background:#fff}

    /* RESPONSIVE */
    @media (max-width: 1024px){
      .cards{grid-template-columns: repeat(2, 1fr)}
      .grid-2{grid-template-columns:1fr}
    }
    @media (max-width: 680px){
      header .subtitle{display:none}
      .cards{grid-template-columns: 1fr}
      .filters .f{grid-column: span 12}
    }
  </style>
</head>
<body>
<header>
  <div class="title">
    <img src="../img/logo.png" alt="KF"/>
    <div>
      <div style="font-weight:800">Karaağaç Fatih – Personel Analiz</div>
      <div class="subtitle">Açık Tema • Yıllara göre artış-azalış, kategori dağılımı ve detay rapor</div>
    </div>
  </div>
  <div class="actions">
    <button class="btn" id="btnBack" title="Geri Dön">Geri Dön</button>
    <button class="btn" id="btnPDF" title="PDF Çıktı">PDF</button>
    <button class="btn brand" id="btnLogout" title="Çıkış Yap">Çıkış</button>
  </div>
</header>

<main id="printArea">
  <section class="panel">
    <!-- FİLTRELER -->
    <div class="card filters">
      <div class="row">
        <div class="f" style="grid-column:span 3">
          <label>Personel</label>
          <select id="selPersonel"></select>
        </div>
        <div class="f" style="grid-column:span 3">
          <label>Yıl Aralığı</label>
          <div class="inline">
            <select id="selYilBas"></select>
            <select id="selYilBit"></select>
          </div>
        </div>
        <div class="f" style="grid-column:span 4">
          <label>Kategori (çoklu seçim)</label>
          <div id="katTags" class="inline"></div>
        </div>
        <div class="f" style="grid-column:span 2">
          <label>&nbsp;</label>
          <button class="btn brand" id="btnUygula">Uygula</button>
        </div>
      </div>
    </div>

    <!-- KARTLAR -->
    <div class="cards">
      <div class="card metric">
        <div class="sub">Toplam (Seçilen Aralık)</div>
        <div id="mToplam" class="big">₺0</div>
      </div>
      <div class="card metric">
        <div class="sub">Geçen Yıl → Bu Yıl</div>
        <div id="mYilKiyas" class="big">₺0 → ₺0</div>
        <div id="mDelta" class="delta">0%</div>
      </div>
      <div class="card metric">
        <div class="sub">En Güçlü Kategori</div>
        <div id="mBestKat" class="big">—</div>
      </div>
      <div class="card metric">
        <div class="sub">Kayıt Adedi</div>
        <div id="mAdet" class="big">0</div>
      </div>
    </div>

    <!-- GRAFİKLER -->
    <div class="grid-2">
      <div class="card">
        <div class="sub" style="margin-bottom:8px">Yıllara Göre Toplam (Seçili Kategoriler)</div>
        <canvas id="chYillar"></canvas>
      </div>
      <div class="card">
        <div class="sub" style="margin-bottom:8px">Kategori Dağılımı (Seçili Yıllar)</div>
        <canvas id="chKategoriler"></canvas>
      </div>
    </div>

    <!-- DETAY TABLO -->
    <div class="card">
      <div class="sub" style="display:flex; gap:8px; justify-content:space-between; align-items:center">
        <span>Detay Kayıtlar</span>
        <div class="inline">
          <input id="txtAra" placeholder="Ara (ad, açıklama, referans...)" />
          <button class="btn" id="btnDetay">Detay Penceresi</button>
        </div>
      </div>
      <div class="table-wrap" style="margin-top:10px">
        <table id="tbl">
          <thead>
            <tr>
              <th>Tarih</th>
              <th>Kategori</th>
              <th>Faaliyet</th>
              <th>Açıklama/Ref</th>
              <th style="text-align:right">Tutar</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
      <div class="footer-actions">
        <button class="btn" id="btnCSV">CSV İndir</button>
      </div>
    </div>
  </section>
</main>

<!-- DETAY MODAL -->
<dialog id="dlg">
  <div class="modal-head">
    <div style="font-weight:700">Detay Kayıtlar</div>
    <button class="btn" id="dlgClose">Kapat</button>
  </div>
  <div class="modal-body">
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Tarih</th>
            <th>Kategori</th>
            <th>Faaliyet</th>
            <th>Açıklama/Ref</th>
            <th style="text-align:right">Tutar</th>
          </tr>
        </thead>
        <tbody id="dlgBody"></tbody>
      </table>
    </div>
  </div>
  <div class="modal-foot">
    <button class="btn" id="dlgPdf">PDF</button>
    <button class="btn brand" id="dlgClose2">Kapat</button>
  </div>
</dialog>

<script>
/* =========================
   FIREBASE REFERANSLARI
   ========================= */
const db = window.db;          // firebase-init.js içinde set ediliyor
const auth = firebase.auth();

const tl = new Intl.NumberFormat('tr-TR', { style:'currency', currency:'TRY', maximumFractionDigits:2 });

const KATEGORILER = [
  "Kurban","Büyükbaş Kurban","Bağış Hisse","Ramazan-ı Şerif","İftar","Sahur",
  "Teberru","Zarf","İhvan Zarf","Ahavat Zarf","Talebe Zarf","Kumanya","Fidye/Zekat",
  "Taahhüt","Şehiriçi Teberru","Diğer"
];

/* =========================
   DURUM
   ========================= */
let state = {
  user:null,
  isAdmin:false,
  personelList:[],
  selectedPersonel:null,
  yilBas: new Date().getFullYear()-1,
  yilBit: new Date().getFullYear(),
  katSecili: new Set(["Kurban","Bağış Hisse","Ramazan-ı Şerif","Teberru","İftar","Sahur"]),
  hamVeri:[],
  gorunenVeri:[]
};

/* =========================
   YARDIMCILAR
   ========================= */
async function checkClaims(user){
  try {
    const token = await user.getIdTokenResult();
    return (token.claims && token.claims.role === 'admin');
  } catch(e){
    return false;
  }
}

async function logAccess(page="analiz.html"){
  try{
    await db.collection("sayfa_erisimleri").add({
      uid: state.user?.uid || null,
      email: state.user?.email || null,
      page, zaman: firebase.firestore.FieldValue.serverTimestamp(),
      userAgent: navigator.userAgent
    });
  }catch(e){}
}

async function loadPersoneller(){
  try{
    const usersSnap = await db.collection("users").get();
    if(!usersSnap.empty){
      state.personelList = usersSnap.docs.map(d=>({
        id: d.id,
        ad: d.data().ad || d.data().displayName || d.data().email || d.id
      }));
    }else{
      const snap = await db.collection("islemler").limit(5000).get();
      const m = new Map();
      snap.forEach(doc=>{
        const r=doc.data();
        if(r.personelId){
          m.set(r.personelId, r.personelAd || r.personelId);
        }
      });
      state.personelList = [...m].map(([id,ad])=>({id,ad}));
    }
  }catch(e){
    state.personelList = [{id: state.user.uid, ad: state.user.displayName || state.user.email || "Ben"}];
  }

  if(!state.isAdmin){
    state.personelList = [{
      id: state.user.uid,
      ad: state.user.displayName || state.user.email || "Ben"
    }];
  }

  const sel = document.getElementById("selPersonel");
  sel.innerHTML = "";
  state.personelList.forEach(p=>{
    const opt = document.createElement("option");
    opt.value = p.id; opt.textContent = p.ad;
    sel.appendChild(opt);
  });
  state.selectedPersonel = sel.value || state.personelList[0]?.id || state.user.uid;
}

function fillYearSelects(){
  const yilNow = new Date().getFullYear();
  const years = [];
  for(let y=2023; y<=yilNow+1; y++) years.push(y);
  const s1 = document.getElementById("selYilBas");
  const s2 = document.getElementById("selYilBit");
  s1.innerHTML=""; s2.innerHTML="";
  years.forEach(y=>{
    const o1=document.createElement("option"); o1.value=y; o1.textContent=y; s1.appendChild(o1);
    const o2=document.createElement("option"); o2.value=y; o2.textContent=y; s2.appendChild(o2);
  });
  s1.value = state.yilBas; s2.value = state.yilBit;
}

function buildKatTags(){
  const wrap = document.getElementById("katTags");
  wrap.innerHTML="";
  KATEGORILER.forEach(k=>{
    const b = document.createElement("span");
    b.className = "tag" + (state.katSecili.has(k) ? " active":"");
    b.textContent = k;
    b.onclick = ()=>{
      if(state.katSecili.has(k)) state.katSecili.delete(k); else state.katSecili.add(k);
      buildKatTags();
    };
    wrap.appendChild(b);
  });
}

async function fetchData(){
  const start = new Date(`${state.yilBas}-01-01T00:00:00`);
  const end = new Date(`${state.yilBit}-12-31T23:59:59`);

  const q = await db.collection("islemler")
    .where("personelId","==", state.selectedPersonel)
    .where("tarih", ">=", start)
    .where("tarih", "<=", end)
    .orderBy("tarih","asc")
    .get();

  state.hamVeri = q.docs.map(d=>({ id:d.id, ...d.data() }));

  state.gorunenVeri = state.hamVeri.filter(r=>{
    const kat = (r.kategori || "").trim();
    if(state.katSecili.size===0) return true;
    for(const k of state.katSecili){
      if(kat.toLowerCase().includes(k.toLowerCase())) return true;
    }
    return false;
  });
}

function updateMetrics(){
  const byYear = new Map();
  const byKat  = new Map();
  let adet = 0; let toplam = 0;

  state.gorunenVeri.forEach(r=>{
    adet++;
    const tutar = Number(r.tutar||0);
    toplam += tutar;
    const d = r.tarih?.toDate ? r.tarih.toDate() : new Date(r.tarih);
    const y = d.getFullYear();
    byYear.set(y, (byYear.get(y)||0) + tutar);
    const k = (r.kategori||"Diğer");
    byKat.set(k, (byKat.get(k)||0) + tutar);
  });

  document.getElementById("mToplam").textContent = tl.format(toplam);
  document.getElementById("mAdet").textContent = adet.toString();

  const gy = state.yilBit-1;
  const by = state.yilBit;
  const valGy = byYear.get(gy)||0;
  const valBy = byYear.get(by)||0;
  document.getElementById("mYilKiyas").textContent = `${tl.format(valGy)} → ${tl.format(valBy)}`;
  let deltaTxt = "0%"; let cls="delta";
  if(valGy===0 && valBy>0){ deltaTxt = "+%100"; cls = "delta up"; }
  else if(valGy>0){
    const dlt = ((valBy - valGy) / valGy) * 100;
    deltaTxt = (dlt>=0?"+":"") + dlt.toFixed(1) + "%";
    cls = "delta " + (dlt>=0?"up":"down");
  }
  const mDelta = document.getElementById("mDelta");
  mDelta.className = cls; mDelta.textContent = deltaTxt;

  let bestKat="—"; let bestVal=0;
  for(const [k,v] of byKat.entries()){
    if(v>bestVal){bestVal=v; bestKat=k;}
  }
  document.getElementById("mBestKat").textContent = bestKat==="—"?"—":`${bestKat} (${tl.format(bestVal)})`;

  fillTable(state.gorunenVeri);
  drawCharts(byYear, byKat);
}

function fillTable(rows){
  const q = (document.getElementById("txtAra").value||"").toLowerCase().trim();
  const tbody = document.getElementById("tbody");
  tbody.innerHTML = "";
  rows.filter(r=>{
    if(!q) return true;
    const inx = [r.kategori||"", r.faaliyet||"", r.aciklama||"", r.referans||""].join(" ").toLowerCase();
    return inx.includes(q);
  }).forEach(r=>{
    const d = r.tarih?.toDate ? r.tarih.toDate() : new Date(r.tarih);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${d.toLocaleDateString('tr-TR')}</td>
      <td>${r.kategori||""}</td>
      <td>${r.faaliyet||""}</td>
      <td>${(r.aciklama||r.referans||"").toString().slice(0,120)}</td>
      <td style="text-align:right">${tl.format(Number(r.tutar||0))}</td>
    `;
    tbody.appendChild(tr);
  });
}

function fillDialogTable(){
  const q = (document.getElementById("txtAra").value||"").toLowerCase().trim();
  const body = document.getElementById("dlgBody");
  body.innerHTML="";
  state.gorunenVeri.filter(r=>{
    if(!q) return true;
    const inx = [r.kategori||"", r.faaliyet||"", r.aciklama||"", r.referans||""].join(" ").toLowerCase();
    return inx.includes(q);
  }).forEach(r=>{
    const d = r.tarih?.toDate ? r.tarih.toDate() : new Date(r.tarih);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${d.toLocaleDateString('tr-TR')}</td>
      <td>${r.kategori||""}</td>
      <td>${r.faaliyet||""}</td>
      <td>${(r.aciklama||r.referans||"").toString()}</td>
      <td style="text-align:right">${tl.format(Number(r.tutar||0))}</td>
    `;
    body.appendChild(tr);
  });
}

/* Grafikler */
let ch1=null, ch2=null;
function drawCharts(byYear, byKat){
  const yKeys = [...byYear.keys()].sort((a,b)=>a-b);
  const yVals = yKeys.map(k=> byYear.get(k)||0);
  const c1 = document.getElementById("chYillar").getContext("2d");
  if(ch1) ch1.destroy();
  ch1 = new Chart(c1, {
    type:"line",
    data:{ labels:yKeys, datasets:[{ label:"Toplam (₺)", data:yVals }]},
    options:{
      responsive:true,
      plugins:{ legend:{display:false}, tooltip:{mode:'index',intersect:false}},
      scales:{ y:{ ticks:{ callback:(v)=> tl.format(v).replace('₺','₺ ') } } }
    }
  });

  const kKeys = [...byKat.keys()].sort();
  const kVals = kKeys.map(k=> byKat.get(k)||0);
  const c2 = document.getElementById("chKategoriler").getContext("2d");
  if(ch2) ch2.destroy();
  ch2 = new Chart(c2, {
    type:"bar",
    data:{ labels:kKeys, datasets:[{ label:"Toplam (₺)", data:kVals }]},
    options:{
      indexAxis:'y',
      responsive:true,
      plugins:{ legend:{display:false}, tooltip:{mode:'index',intersect:false}},
      scales:{ x:{ ticks:{ callback:(v)=> tl.format(v).replace('₺','₺ ') } } }
    }
  });
}

/* CSV / PDF */
function toCSV(rows){
  const head = ["Tarih","Kategori","Faaliyet","Açıklama/Ref","Tutar"];
  const body = rows.map(r=>{
    const d = r.tarih?.toDate ? r.tarih.toDate() : new Date(r.tarih);
    return [
      d.toISOString().slice(0,10),
      (r.kategori||""),
      (r.faaliyet||""),
      (r.aciklama||r.referans||"").toString().replaceAll('"','""'),
      Number(r.tutar||0).toFixed(2)
    ];
  });
  const lines = [head, ...body].map(arr=> arr.map(v=> `"${v}"`).join(",")).join("\n");
  return lines;
}
function download(filename, text){
  const a = document.createElement("a");
  a.href = URL.createObjectURL(new Blob([text], {type:"text/csv;charset=utf-8;"}));
  a.download = filename;
  a.click();
  URL.revokeObjectURL(a.href);
}
function exportPDF(element, fileName="personel-analiz.pdf"){
  const opt = {
    margin: [10,10,10,10],
    filename: fileName,
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2, useCORS:true, allowTaint:true },
    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
  };
  html2pdf().set(opt).from(element).save();
}

/* OLAYLAR */
document.getElementById("btnBack").onclick = ()=> history.length>1 ? history.back() : location.href="panel.html";
document.getElementById("btnLogout").onclick = async ()=> { await auth.signOut(); location.href="index.html"; };
document.getElementById("btnPDF").onclick = ()=> exportPDF(document.getElementById("printArea"), "analiz-"+(state.user?.uid||"")+".pdf");
document.getElementById("btnCSV").onclick = ()=> download("detay-kayitlar.csv", toCSV(state.gorunenVeri));
document.getElementById("btnDetay").onclick = ()=> { fillDialogTable(); document.getElementById("dlg").showModal(); };
document.getElementById("dlgClose").onclick = ()=> document.getElementById("dlg").close();
document.getElementById("dlgClose2").onclick = ()=> document.getElementById("dlg").close();
document.getElementById("dlgPdf").onclick = ()=> exportPDF(document.querySelector("#dlg .modal-body"), "detay-kayitlar.pdf");
document.getElementById("txtAra").addEventListener("input", ()=> fillTable(state.gorunenVeri));
document.getElementById("btnUygula").onclick = async ()=>{
  const selP = document.getElementById("selPersonel");
  const s1 = document.getElementById("selYilBas");
  const s2 = document.getElementById("selYilBit");
  state.selectedPersonel = selP.value;
  state.yilBas = Number(s1.value);
  state.yilBit = Number(s2.value);
  if(state.yilBit < state.yilBas){
    const t = state.yilBas; state.yilBas = Number(s2.value); state.yilBit = Number(s1.value);
    s1.value = state.yilBas; s2.value = state.yilBit;
  }
  await fetchData();
  updateMetrics();
};

/* BAŞLANGIÇ */
auth.onAuthStateChanged(async (user)=>{
  if(!user){ location.href = "index.html"; return; }
  state.user = user;
  state.isAdmin = await checkClaims(user);
  await logAccess("analiz.html");
  await loadPersoneller();
  fillYearSelects();
  buildKatTags();
  await fetchData();
  updateMetrics();
});
</script>
</body>
</html>
