<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>Karaaƒüa√ß Fatih | Ki≈üi Bazlƒ± Alacak Raporu</title>
  <link rel="icon" type="image/png" href="../img/logo.png" />
  <link rel="stylesheet" href="../css/app-shell.css" />

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="../../js/firebase/firebase-init.js"></script>
  <script defer src="../../js/ortak.js"></script>

  <style>
    /* ========== Sayfa-√∂zel stiller (app-shell.css'den sonra) ========== */
    /* Body - app-shell.css'den gelecek (arka plan, padding, font vs.) */
    body {
      padding-top: var(--appbar-h) !important;
      overflow-x: hidden;
      overflow-y: auto;
    }
    
    main {
      min-height: calc(100vh - var(--appbar-h));
      padding-bottom: 40px;
    }

    /* Appbar - app-shell.css ile uyumlu */
    .appbar {
      position: fixed !important;
      top: 0 !important;
      left: 0 !important;
      right: 0 !important;
      z-index: 60 !important;
      height: var(--appbar-h);
      padding-top: env(safe-area-inset-top);
      display: grid !important;
      grid-template-columns: auto 1fr auto !important;
      align-items: center !important;
      gap: 16px !important;
      padding-left: 16px !important;
      padding-right: 16px !important;
      background: var(--card) !important;
      backdrop-filter: blur(10px) !important;
      -webkit-backdrop-filter: blur(10px) !important;
      border-bottom: 1px solid var(--stroke) !important;
    }

    .wrap {
      max-width: 1600px;
      margin: 0 auto;
      padding: 12px 24px;
    }
    
    @media (min-width: 1400px) {
      .wrap {
        max-width: 1800px;
      }
    }

    /* Header kaldƒ±rƒ±ldƒ± - ba≈ülƒ±k main i√ßinde */
    .rapor-ust {
      padding: 16px 0;
      margin-bottom: 16px;
    }

    .rapor-baslik {
      font-size: 22px;
      line-height: 1.25;
      margin: 0 0 16px 0;
      white-space: normal;
      word-break: break-word;
      overflow-wrap: anywhere
    }

    .kisi-secim {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: nowrap;
      padding: 8px 0;
    }
    
    .kisi-secim select {
      min-width:430px;
      max-width: 100px;
      flex: 0 0 auto;
      height: 40px;
      padding: 8px 10px;
      font-size: 13px;
    }
    
    .kisi-secim button {
      flex: 0 0 auto;
      white-space: nowrap;
      padding: 8px 12px;
      font-size: 17px;
      height: 40px;
    }
    
    .kisi-secim button.btn-primary {
      padding: 8px 14px;
    }

    /* Card - app-shell.css'den geliyor, sadece sayfa-√∂zel override'lar */

    .row {
      display: grid;
      gap: 12px
    }

    .row.cols-4 {
      grid-template-columns: repeat(4, 1fr)
    }

    @media (max-width:900px) {
      .row.cols-4 {
        grid-template-columns: 1fr 1fr
      }
    }

    @media (max-width:640px) {
      .row.cols-4 {
        grid-template-columns: 1fr
      }
    }

    .kpi {
      display: flex;
      flex-direction: column;
      gap: 4px
    }

    .kpi .label {
      color: var(--muted);
      font-size: 12px
    }

    .kpi .value {
      font-size: 20px;
      font-weight: 600
    }

    .kpi.warn .value {
      color: var(--warn)
    }

    .kpi.good .value {
      color: var(--good)
    }

    /* Sƒ±ralama Rozeti */
    .rank-card {
      background: linear-gradient(135deg, #fff, #f8fafc);
      border: 1px solid var(--stroke);
      border-radius: 12px;
      padding: 12px;
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.03);
    }

    .rank-icon {
      font-size: 24px
    }

    .rank-info {
      flex: 1
    }

    .rank-title {
      font-size: 13px;
      color: var(--muted);
      font-weight: 600
    }

    .rank-val {
      font-size: 16px;
      font-weight: 700;
      color: var(--ink)
    }

    /* Faaliyet Grid */
    .faaliyet-grid {
      display: grid;
      gap: 10px;
      grid-template-columns: repeat(4, 1fr)
    }

    @media (max-width:900px) {
      .faaliyet-grid {
        grid-template-columns: 1fr 1fr
      }
    }

    @media (max-width:640px) {
      .faaliyet-grid {
        grid-template-columns: 1fr
      }
    }

    .faaliyet-kart {
      display: flex;
      flex-direction: column;
      gap: 4px;
      padding: 12px;
      border: 1px solid #eef2f7;
      border-radius: 12px;
      background: #fff;
    }

    .f-title {
      font-weight: 700;
      margin-bottom: 4px
    }

    .f-row {
      display: flex;
      justify-content: space-between;
      font-size: 13px
    }

    .kalan-etiket {
      align-self: flex-start;
      margin-top: 6px;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 700;
    }

    .kalan-pozitif {
      background: #fff7ed;
      color: #9a3412;
      border: 1px solid #fdba74
    }

    .kalan-non {
      background: #ecfdf5;
      color: #065f46;
      border: 1px solid #86efac
    }

    .kalan-negatif {
      background: #eff6ff;
      color: #1d4ed8;
      border: 1px solid #93c5fd
    }

    /* Tablo */
    .table-wrap {
      overflow-x: auto;
      overflow-y: visible;
      border: 1px solid var(--stroke);
      border-radius: 12px;
      -webkit-overflow-scrolling: touch;
      background: var(--card);
      position: relative;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      border-spacing: 0;
      background: #fff;
      min-width: 760px;
    }

    thead {
      position: relative;
    }

    thead th {
      position: sticky;
      top: 0;
      background: #fafbfc;
      border-bottom: 1px solid var(--stroke);
      font-weight: 600;
      text-align: left;
      font-size: 13px;
      color: var(--muted);
      padding: 12px 10px;
      white-space: nowrap;
      cursor: pointer;
      user-select: none;
      z-index: 4;
      box-shadow: 0 2px 2px -1px rgba(0, 0, 0, 0.1);
    }

    thead th:hover {
      background: #f1f5f9;
      color: var(--ink);
    }

    thead th.sort-asc::after {
      content: " ‚ñ≤";
      font-size: 10px;
    }

    thead th.sort-desc::after {
      content: " ‚ñº";
      font-size: 10px;
    }

    tbody td {
      border-bottom: 1px solid var(--stroke);
      padding: 10px;
      font-size: 14px;
      vertical-align: top;
    }

    tbody tr:hover {
      background: #fafbfc;
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    tfoot td {
      border-top: 2px solid var(--stroke);
      padding: 10px;
      font-weight: 700;
      background: #f8fafc;
      color: var(--ink);
    }

    .right {
      text-align: right
    }

    /* Progress Bar */
    .progress-bg {
      background: #e2e8f0;
      height: 6px;
      border-radius: 999px;
      overflow: hidden;
      width: 80px;
      display: inline-block;
      vertical-align: middle;
      margin-right: 6px
    }

    .progress-fill {
      height: 100%;
      background: var(--accent);
      border-radius: 999px
    }

    .progress-text {
      font-size: 12px;
      font-weight: 600;
      color: var(--muted)
    }

    /* Ayrƒ±lan Personel */
    .separator-row td {
      background: #f1f5f9;
      color: var(--muted);
      font-weight: 700;
      text-align: center;
      padding: 8px;
      font-size: 12px;
      letter-spacing: 1px
    }

    .ayrilan-row {
      background: #fff1f2
    }

    .ayrilan-row td {
      color: #881337
    }

    /* Print */
    @media print {
      header {
        display: none
      }

      .wrap {
        max-width: 100%;
        padding: 0
      }

      .card {
        border: none;
        padding: 0;
        margin: 0
      }

      .table-wrap {
        border: none
      }
    }

    /* Toast - app-shell.css'den geliyor */
  </style>
</head>

<body>
  <!-- √úST APPBAR (alacak-takibi ile aynƒ± yapƒ±) -->
  <div class="appbar">
    <div class="brand" onclick="location.href='../panel.html'">
      <img src="../img/logo.png" alt="logo"><span>KARAAƒûA√á FATƒ∞H</span>
    </div>
    <nav class="nav-center">
      <ul class="nav-list" id="navMain"></ul>
    </nav>
    <div class="nav-right">
      <button class="btn hamb" id="hamburger" title="Men√º">‚ò∞</button>
      
      <!-- Bildirim -->
      <div class="nav-item">
        <button class="iconbtn" id="btnNotif" title="Bildirimler">üîî
          <span class="badge" id="notifBadge" style="display:none">0</span>
        </button>
        <div class="dropdown drop-right" id="notifDropdown" aria-label="Bildirim listesi">
          <div class="muted" style="padding:6px 8px">Son bildirimler</div>
          <div id="notifList" class="list" style="max-height:300px;overflow:auto"></div>
        </div>
      </div>

      <!-- Profil -->
      <div class="nav-item">
        <button class="iconbtn" id="btnProfile" title="Profil">
          <span class="avatar"></span> <span id="profName" class="muted">Profil</span>
        </button>
        <div class="dropdown drop-right" id="profDropdown" aria-label="Profil men√ºs√º">
          <a href="../../diger/kullanici-yonetimi.html">üë§ Profil</a>
          <a href="../../diger/sistem-ayarlari.html">‚öôÔ∏è Sistem Ayarlarƒ±</a>
          <a href="#" id="btnLogout">üö™ √áƒ±kƒ±≈ü Yap</a>
        </div>
      </div>
    </div>
  </div>
  <aside class="drawer" id="drawer"></aside>
  <div class="toast-container" id="toastContainer"></div>

  <main class="wrap">
    <!-- Ba≈ülƒ±k ve Kontroller -->
    <div class="rapor-ust">
      <h1 class="rapor-baslik">Ki≈üi Bazlƒ± Alacak Raporu</h1>
      <div class="kisi-secim" id="controlPanel" style="display:none">
        <select id="personelSecim"></select>
        <select id="selYil">
          <option value="2023">2023</option>
          <option value="2024">2024</option>
          <option value="2025" selected>2025</option>
          <option value="2026">2026</option>
          <option value="tum">T√ºm Yƒ±llar</option>
        </select>
        <button id="btnYukle" class="btn btn-primary">Y√ºkle</button>
        <button id="btnGizle" class="btn">Kalan Sƒ±fƒ±r Olanlarƒ± Gizle</button>
        <button id="btnYazdir" class="btn">üñ®Ô∏è Yazdƒ±r</button>
      </div>
    </div>

    <!-- √úst Bilgi Kartƒ± -->
    <div class="card" id="infoCard">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
        <div>
          <h2 id="baslik" style="margin:0">Y√ºkleniyor...</h2>
          <div class="muted" id="altBaslik"></div>
        </div>
        <div><span class="pill" id="pillAdet"
            style="background:#f1f5f9;padding:4px 10px;border-radius:6px;font-size:13px;font-weight:600"></span></div>
      </div>
    </div>

    <!-- Sƒ±ralama Kartƒ± (Tek Personel Modu) -->
    <div id="rankArea" style="margin-top:12px; display:none"></div>

    <!-- KPI Kartlarƒ± -->
    <div class="row cols-4" style="margin-top:12px">
      <div class="card kpi"><span class="label">Toplam Tahakkuk</span><span class="value" id="kpiTahakkuk">‚Ç∫0</span>
      </div>
      <div class="card kpi good"><span class="label">Toplam Tahsilat</span><span class="value"
          id="kpiTahsilat">‚Ç∫0</span></div>
      <div class="card kpi warn"><span class="label">Kalan</span><span class="value" id="kpiKalan">‚Ç∫0</span></div>
      <div class="card kpi good"><span class="label">Tahsilat Nispeti</span><span class="value" id="kpiNispet">0%</span>
      </div>
    </div>

    <!-- Faaliyet √ñzeti (Tek Personel Modu) -->
    <div class="card" id="faaliyetCard" style="margin-top:12px; display:none">
      <h3 style="margin:0 0 12px">Faaliyet Bazlƒ± √ñzet</h3>
      <div class="faaliyet-grid" id="faaliyetGrid"></div>
    </div>

    <!-- Ba≈üarƒ± Sƒ±ralamasƒ± Tablosu (Sadece T√ºm Personel Modunda) -->
    <div class="card" id="rankTableCard" style="margin-top:12px; display:none">
      <h3 style="margin:0 0 12px">Personel Ba≈üarƒ± Sƒ±ralamasƒ±</h3>
      <div class="table-wrap">
        <table id="rankTbl">
          <thead>
            <tr>
              <th style="width:50px">#</th>
              <th>Personel</th>
              <th class="right">Toplam Tahakkuk</th>
              <th class="right">Toplam Tahsilat</th>
              <th class="right">Kalan</th>
              <th style="width:200px">Tahsilat Nispeti</th>
            </tr>
          </thead>
          <tbody id="rankTbody"></tbody>
        </table>
      </div>
    </div>

    <!-- Detay Tablo -->
    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 12px" id="tabloBaslik">Detaylƒ± Liste</h3>
      <div class="table-wrap">
        <table id="tbl">
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
          <tfoot id="tfoot"></tfoot>
        </table>
      </div>
    </div>

  </main>

  <script>
    // DOMContentLoaded'da √ßalƒ±≈ütƒ±r - ortak.js y√ºklenene kadar bekle
    document.addEventListener('DOMContentLoaded', function(){
      // Ortak.js y√ºklenene kadar bekle
      function waitForOrtak(callback){
        if(typeof window.norm !== 'undefined' && typeof window.showToast !== 'undefined' && typeof firebase !== 'undefined'){
          callback();
        }else{
          setTimeout(()=> waitForOrtak(callback), 50);
        }
      }
      
      waitForOrtak(()=>{
        // --- Ayarlar & Sabitler ---
        const ADMINS = ['samet √ßakƒ±r', 'muhsin √ßelik'];
        const MERGE_MAP = {
          'keramettin kocaoƒülu': 'Kerem Kocaoƒülu',
          'kerem kocaoƒülu': 'Kerem Kocaoƒülu'
        };
        const AYRILANLAR = ['burak serin'];

        // db ve auth - ortak.js'den window.db ve window.auth olarak gelecek
        const db = window.db || firebase.firestore();
        const auth = window.auth || firebase.auth();

    // --- Yardƒ±mcƒ±lar ---
    const qs = s => document.querySelector(s);
    const money = n => new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY', maximumFractionDigits: 2 }).format(n || 0);
    const tidy = s => (s || '').toString().trim().replace(/\s+/g, ' ');
    const normTR = s => tidy(s).toLocaleLowerCase('tr-TR');

    function titleTR(s) {
      const lower = normTR(s);
      const SEP = /([ \t\r\n\-\u2019'_/.,;:()]+)/;
      return lower.split(SEP).map(part => {
        if (!part || SEP.test(part)) return part;
        return part.charAt(0).toLocaleUpperCase('tr-TR') + part.slice(1);
      }).join('');
    }

    function resolveName(name) {
      const n = normTR(name);
      if (MERGE_MAP[n]) return MERGE_MAP[n];
      return titleTR(name);
    }

    // Tarih alanƒ±nƒ± (string / Date / Firestore Timestamp) g√ºvenli ≈üekilde YYYY-MM-DD'e √ßevir
    function toDateKey(v) {
      if (!v) return '';
      if (typeof v === 'string') return v.slice(0, 10);
      if (v instanceof Date) return v.toISOString().slice(0, 10);
      if (typeof v === 'object' && typeof v.toDate === 'function') {
        try { return v.toDate().toISOString().slice(0, 10); } catch (e) { return ''; }
      }
      return '';
    }

    // --- Ana Mantƒ±k ---
    let currentUser = null;
    let isAdmin = false;
    let allTahakkuk = [];
    let allTahsilat = [];
    let currentRows = []; // Sƒ±ralama i√ßin aktif satƒ±rlar
    let sortCol = null;
    let sortDir = 'asc';
    let hideZero = false; // Kalan sƒ±fƒ±r gizle
    let rankSortCol = null; // Personel sƒ±ralamasƒ± i√ßin sƒ±ralama s√ºtunu
    let rankSortDir = 'desc'; // Varsayƒ±lan: Tahsilat nispetine g√∂re azalan
    let rankListData = []; // Sƒ±ralama tablosu i√ßin veri

    // window.initPage - ortak.js'deki initAppShellAuth tarafƒ±ndan √ßaƒürƒ±lacak
    window.initPage = async function() {
      // Kullanƒ±cƒ± bilgisini ortak.js'den al
      const profNameEl = document.getElementById('profName');
      if(profNameEl && profNameEl.textContent){
        const nameText = profNameEl.textContent.replace('üë§ ', '').trim();
        const adSoyad = nameText || '';
        currentUser = resolveName(adSoyad);
        isAdmin = ADMINS.includes(normTR(currentUser));
      }
      
      await loadData();

      const sel = qs('#personelSecim');
      const controlPanel = qs('#controlPanel');

      const personSet = new Set();
      allTahakkuk.forEach(t => personSet.add(t.personel));
      const personList = [...personSet].sort((a, b) => a.localeCompare(b, 'tr'));

      sel.innerHTML = `<option value="ALL">T√ºm Personel (√ñzet + Detay)</option>` +
        personList.map(p => `<option value="${p}">${p}</option>`).join('');

      if (isAdmin) {
        controlPanel.style.display = 'flex';
        sel.value = 'ALL';
      } else {
        controlPanel.style.display = 'none';
        sel.innerHTML = `<option value="${currentUser}">${currentUser}</option>`;
        sel.value = currentUser;
      }

      renderReport();
    };

    async function loadData() {
      const tSnap = await db.collection('tahakkuklar').get();
      allTahakkuk = tSnap.docs.map(d => {
        const x = d.data();
        return {
          id: d.id,
          ...x,
          personel: resolveName(x.personel),
          borclu: resolveName(x.borclu),
          faaliyet: titleTR(x.faaliyet)
        };
      });

      const sSnap = await db.collection('tahsilatlar').get();
      allTahsilat = sSnap.docs.map(d => {
        const x = d.data();
        return {
          id: d.id,
          ...x,
          personel: resolveName(x.personel),
          borclu: resolveName(x.borclu),
          faaliyet: titleTR(x.faaliyet)
        };
      });
    }

    function renderReport() {
      const selectedPerson = qs('#personelSecim').value;
      const selectedYil = qs('#selYil').value;

      qs('#baslik').textContent = selectedPerson === 'ALL' ? 'T√ºm Personel √ñzeti' : selectedPerson;
      qs('#altBaslik').textContent = `Yƒ±l: ${selectedYil === 'tum' ? 'T√ºm√º' : selectedYil}`;

      let fTahakkuk = allTahakkuk;
      let fTahsilat = allTahsilat;

      if (selectedYil !== 'tum') {
        fTahakkuk = fTahakkuk.filter(x => String(x.yil) === selectedYil);
        fTahsilat = fTahsilat.filter(x => String(x.yil) === selectedYil);
      }

      if (selectedPerson !== 'ALL') {
        fTahakkuk = fTahakkuk.filter(x => x.personel === selectedPerson);
        fTahsilat = fTahsilat.filter(x => x.personel === selectedPerson);

        qs('#rankTableCard').style.display = 'none';
        renderSinglePerson(fTahakkuk, fTahsilat, selectedPerson, selectedYil);
      } else {
        renderAllPersons(fTahakkuk, fTahsilat, selectedYil);
      }
    }

    // E≈üle≈ütirme Fonksiyonu (G√º√ßlendirilmi≈ü)
    function getRelatedTahsilat(tahakkuk, allTahsilatList) {
      return allTahsilatList.filter(s => {
        if (s.tahakkukId && s.tahakkukId === tahakkuk.id) return true;
        if (String(s.yil) === String(tahakkuk.yil) &&
          s.faaliyet === tahakkuk.faaliyet &&
          s.personel === tahakkuk.personel &&
          s.borclu === tahakkuk.borclu) return true;
        return false;
      });
    }

    function renderSinglePerson(tahakkuklar, tahsilatlar, personName, yil) {
      // 1. KPI Hesapla (Daha basit ve doƒüru)
      const sumTah = tahakkuklar.reduce((a, b) => a + (b.tahakkuk || 0), 0);
      const sumTsl = tahsilatlar.reduce((a, b) => a + (b.tutar || 0), 0);

      const kalan = sumTah - sumTsl;
      const nispet = sumTah > 0 ? (sumTsl / sumTah) * 100 : 0;

      qs('#kpiTahakkuk').textContent = money(sumTah);
      qs('#kpiTahsilat').textContent = money(sumTsl);
      qs('#kpiKalan').textContent = money(kalan);
      qs('#kpiNispet').textContent = `%${nispet.toFixed(1)}`;

      // 2. Sƒ±ralama Analizi
      const stats = {};
      let globalTah = allTahakkuk;
      let globalTsl = allTahsilat;
      if (yil !== 'tum') {
        globalTah = globalTah.filter(x => String(x.yil) === yil);
        globalTsl = globalTsl.filter(x => String(x.yil) === yil);
      }

      globalTah.forEach(t => { if (!stats[t.personel]) stats[t.personel] = { t: 0, s: 0 }; stats[t.personel].t += (t.tahakkuk || 0); });
      globalTsl.forEach(t => { if (!stats[t.personel]) stats[t.personel] = { t: 0, s: 0 }; stats[t.personel].s += (t.tutar || 0); });

      const ranking = Object.entries(stats).map(([p, v]) => ({ p, r: v.t > 0 ? (v.s / v.t) * 100 : 0 })).sort((a, b) => b.r - a.r);
      const myRank = ranking.findIndex(r => r.p === personName) + 1;

      const rankArea = qs('#rankArea');
      rankArea.style.display = 'block';
      rankArea.innerHTML = `
        <div class="rank-card">
          <div class="rank-icon">üèÜ</div>
          <div class="rank-info">
            <div class="rank-title">Tahsilat Ba≈üarƒ± Sƒ±ralamasƒ±</div>
            <div class="rank-val">${yil === 'tum' ? 'T√ºm Yƒ±llar' : yil} yƒ±lƒ±nda ${ranking.length} personel arasƒ±nda <strong>${myRank}.</strong> sƒ±radasƒ±nƒ±z.</div>
          </div>
          <div style="font-size:20px; font-weight:800; color:var(--accent)">#${myRank}</div>
        </div>
      `;

      // 3. Faaliyet √ñzeti
      qs('#faaliyetCard').style.display = 'block';
      const fMap = {};
      tahakkuklar.forEach(t => {
        const k = t.faaliyet;
        if (!fMap[k]) fMap[k] = { tah: 0, tsl: 0 };
        fMap[k].tah += (t.tahakkuk || 0);
      });
      tahsilatlar.forEach(t => {
        const k = t.faaliyet;
        if (!fMap[k]) fMap[k] = { tah: 0, tsl: 0 };
        fMap[k].tsl += (t.tutar || 0);
      });

      const fGrid = qs('#faaliyetGrid');
      fGrid.innerHTML = '';
      Object.entries(fMap).forEach(([key, val]) => {
        const kal = val.tah - val.tsl;
        let cls = 'kalan-non';
        if (kal > 0.1) cls = 'kalan-pozitif';
        if (kal < -0.1) cls = 'kalan-negatif';
        fGrid.innerHTML += `
          <div class="faaliyet-kart">
            <div class="f-title">${key}</div>
            <div class="f-row"><span>Tahakkuk:</span> <span>${money(val.tah)}</span></div>
            <div class="f-row"><span>Tahsilat:</span> <span>${money(val.tsl)}</span></div>
            <span class="kalan-etiket ${cls}">Kalan: ${money(kal)}</span>
          </div>
        `;
      });

      // 4. Detay Tablo
      prepareTableData(tahakkuklar, tahsilatlar, false);
    }

    function renderAllPersons(tahakkuklar, tahsilatlar, yil) {
      // KPI Hesapla
      const sumTah = tahakkuklar.reduce((a, b) => a + (b.tahakkuk || 0), 0);
      const sumTsl = tahsilatlar.reduce((a, b) => a + (b.tutar || 0), 0);
      const kalan = sumTah - sumTsl;
      const nispet = sumTah > 0 ? (sumTsl / sumTah) * 100 : 0;

      qs('#kpiTahakkuk').textContent = money(sumTah);
      qs('#kpiTahsilat').textContent = money(sumTsl);
      qs('#kpiKalan').textContent = money(kalan);
      qs('#kpiNispet').textContent = `%${nispet.toFixed(1)}`;

      qs('#rankArea').style.display = 'none';
      qs('#faaliyetCard').style.display = 'none';
      qs('#rankTableCard').style.display = 'block';

      // Sƒ±ralama Tablosu
      const stats = {};
      tahakkuklar.forEach(t => {
        const p = t.personel;
        if (!stats[p]) stats[p] = { t: 0, s: 0 };
        stats[p].t += (t.tahakkuk || 0);
      });
      tahsilatlar.forEach(t => {
        const p = t.personel;
        if (!stats[p]) stats[p] = { t: 0, s: 0 };
        stats[p].s += (t.tutar || 0);
      });

      let list = Object.entries(stats).map(([p, v]) => {
        const k = v.t - v.s;
        const n = v.t > 0 ? (v.s / v.t) * 100 : 0;
        return { p, t: v.t, s: v.s, k, n, isAyrilan: AYRILANLAR.includes(normTR(p)) };
      });

      // Ayrƒ±lan personelleri ayƒ±r
      const ayrilanList = list.filter(r => r.isAyrilan);
      const aktifList = list.filter(r => !r.isAyrilan);

      // Aktif personelleri sƒ±rala (ayrƒ±lanlar sƒ±ralamaya dahil deƒüil)
      if (rankSortCol) {
        aktifList.sort((a, b) => {
          let va = a[rankSortCol], vb = b[rankSortCol];
          if (typeof va === 'string') {
            return rankSortDir === 'asc' ? va.localeCompare(vb, 'tr') : vb.localeCompare(va, 'tr');
          }
          return rankSortDir === 'asc' ? va - vb : vb - va;
        });
      } else {
        // Varsayƒ±lan sƒ±ralama: Tahsilat nispetine g√∂re azalan
        aktifList.sort((a, b) => b.n - a.n);
      }

      rankListData = [...aktifList, ...ayrilanList];
      renderRankTable(aktifList, ayrilanList);

      prepareTableData(tahakkuklar, tahsilatlar, true);
    }

    function renderRankTable(aktifList, ayrilanList) {
      const rankTbl = qs('#rankTbl');
      const rankThead = rankTbl.querySelector('thead');
      const rBody = qs('#rankTbody');

      // Thead'i g√ºncelle - sƒ±ralama √∂zellikleri ekle
      rankThead.innerHTML = `
        <tr>
          <th style="width:50px" data-key="index">#</th>
          <th data-key="p">Personel</th>
          <th class="right" data-key="t">Toplam Tahakkuk</th>
          <th class="right" data-key="s">Toplam Tahsilat</th>
          <th class="right" data-key="k">Kalan</th>
          <th style="width:200px" data-key="n">Tahsilat Nispeti</th>
        </tr>
      `;

      // Sƒ±ralama class'larƒ±nƒ± ekle
      rankThead.querySelectorAll('th').forEach(th => {
        const key = th.dataset.key;
        if (key && rankSortCol === key) {
          th.classList.add(rankSortDir === 'asc' ? 'sort-asc' : 'sort-desc');
        }
        // Click event listener ekle
        if (key && key !== 'index') {
          th.addEventListener('click', () => {
            if (rankSortCol === key) {
              rankSortDir = rankSortDir === 'asc' ? 'desc' : 'asc';
            } else {
              rankSortCol = key;
              rankSortDir = 'asc';
            }
            // Sƒ±ralamayƒ± yeniden yap
            const selectedYil = qs('#selYil').value;
            let fTahakkuk = allTahakkuk;
            let fTahsilat = allTahsilat;
            if (selectedYil !== 'tum') {
              fTahakkuk = fTahakkuk.filter(x => String(x.yil) === selectedYil);
              fTahsilat = fTahsilat.filter(x => String(x.yil) === selectedYil);
            }
            renderAllPersons(fTahakkuk, fTahsilat, selectedYil);
          });
        }
      });

      rBody.innerHTML = '';
      let sep = false;

      // Aktif personelleri g√∂ster
      aktifList.forEach((r, idx) => {
        let color = '#ef4444';
        if (r.n >= 50) color = '#f59e0b';
        if (r.n >= 80) color = '#22c55e';
        if (r.n >= 100) color = '#15803d';

        rBody.innerHTML += `
          <tr>
            <td>${idx + 1}</td>
            <td style="font-weight:600">${r.p}</td>
            <td class="right">${money(r.t)}</td>
            <td class="right">${money(r.s)}</td>
            <td class="right" style="color:${r.k > 0 ? 'var(--warn)' : 'var(--muted)'}">${money(r.k)}</td>
            <td>
              <div style="display:flex;align-items:center">
                <div class="progress-bg"><div class="progress-fill" style="width:${Math.min(r.n, 100)}%; background:${color}"></div></div>
                <span class="progress-text" style="color:${color}">%${r.n.toFixed(1)}</span>
              </div>
            </td>
          </tr>
        `;
      });

      // Ayrƒ±lan personelleri g√∂ster
      if (ayrilanList.length > 0) {
        rBody.innerHTML += `<tr class="separator-row"><td colspan="6">AYRILAN PERSONEL</td></tr>`;
        ayrilanList.forEach((r) => {
          let color = '#ef4444';
          if (r.n >= 50) color = '#f59e0b';
          if (r.n >= 80) color = '#22c55e';
          if (r.n >= 100) color = '#15803d';

          rBody.innerHTML += `
            <tr class="ayrilan-row">
              <td>-</td>
              <td style="font-weight:600">${r.p}</td>
              <td class="right">${money(r.t)}</td>
              <td class="right">${money(r.s)}</td>
              <td class="right" style="color:${r.k > 0 ? 'var(--warn)' : 'var(--muted)'}">${money(r.k)}</td>
              <td>
                <div style="display:flex;align-items:center">
                  <div class="progress-bg"><div class="progress-fill" style="width:${Math.min(r.n, 100)}%; background:${color}"></div></div>
                  <span class="progress-text" style="color:${color}">%${r.n.toFixed(1)}</span>
                </div>
              </td>
            </tr>
          `;
        });
      }
    }

    function prepareTableData(tahakkuklar, tahsilatlar, showPersonelColumn) {
      const usedTahsilatIds = new Set();
      const rows = [];

      // 1. Tahakkuklarƒ± ve e≈üle≈üen tahsilatlarƒ± i≈üle
      tahakkuklar.forEach(t => {
        const related = getRelatedTahsilat(t, tahsilatlar);
        related.forEach(s => usedTahsilatIds.add(s.id)); // Kullanƒ±lanlarƒ± i≈üaretle

        const tslSum = related.reduce((a, b) => a + (b.tutar || 0), 0);

        // En g√ºncel ve dolu "√∂deyen" bilgisini bul
        let lastPayment = null;
        if (related.length > 0) {
          const sorted = related.slice().sort((a, b) => toDateKey(a.tarih).localeCompare(toDateKey(b.tarih)));
          for (let i = sorted.length - 1; i >= 0; i--) {
            if (sorted[i].odeyen && tidy(sorted[i].odeyen)) {
              lastPayment = sorted[i];
              break;
            }
          }
          if (!lastPayment) lastPayment = sorted[sorted.length - 1];
        }
        const odeyen = (lastPayment && tidy(lastPayment.odeyen)) || tidy(t.odeyen) || '-';

        rows.push({
          yil: t.yil,
          faaliyet: t.faaliyet,
          personel: t.personel,
          borclu: t.borclu,
          odeyen: odeyen,
          aciklama: tidy(t.aciklama),
          tah: t.tahakkuk,
          tsl: tslSum,
          kal: t.tahakkuk - tslSum,
          isOrphan: false
        });
      });

      // 2. E≈üle≈ümeyen (Yetim) Tahsilatlarƒ± Bul
      tahsilatlar.forEach(s => {
        if (!usedTahsilatIds.has(s.id)) {
          rows.push({
            yil: s.yil,
            faaliyet: s.faaliyet,
            personel: s.personel,
            borclu: s.borclu,
            odeyen: s.odeyen || '-',
            aciklama: tidy(s.aciklama),
            tah: 0, // Tahakkuk yok
            tsl: s.tutar,
            kal: 0 - s.tutar, // Eksi bakiye (Alacaklƒ±)
            isOrphan: true
          });
        }
      });

      currentRows = rows;
      renderTable(showPersonelColumn);
    }

    function renderTable(showPersonelColumn) {
      const thead = qs('#thead');
      const tbody = qs('#tbody');
      const tfoot = qs('#tfoot');

      let headers = [
        { key: 'yil', label: 'Yƒ±l' },
        { key: 'faaliyet', label: 'Faaliyet' },
        ...(showPersonelColumn ? [{ key: 'personel', label: 'Personel' }] : []),
        { key: 'borclu', label: 'Bor√ßlu' },
        { key: 'odeyen', label: '√ñdeyen' },
        { key: 'aciklama', label: 'A√ßƒ±klama' },
        { key: 'tah', label: 'Tahakkuk', cls: 'right' },
        { key: 'tsl', label: 'Tahsilat', cls: 'right' },
        { key: 'kal', label: 'Kalan', cls: 'right' }
      ];

      thead.innerHTML = '<tr>' + headers.map(h =>
        `<th data-key="${h.key}" class="${h.cls || ''} ${sortCol === h.key ? (sortDir === 'asc' ? 'sort-asc' : 'sort-desc') : ''}">${h.label}</th>`
      ).join('') + '</tr>';

      thead.querySelectorAll('th').forEach(th => {
        th.addEventListener('click', () => {
          const key = th.dataset.key;
          if (sortCol === key) sortDir = sortDir === 'asc' ? 'desc' : 'asc';
          else { sortCol = key; sortDir = 'asc'; }
          renderTable(showPersonelColumn);
        });
      });

      let displayRows = [...currentRows];

      if (hideZero) {
        displayRows = displayRows.filter(r => Math.abs(r.kal) > 0.1);
      }

      if (sortCol) {
        displayRows.sort((a, b) => {
          let va = a[sortCol], vb = b[sortCol];
          if (typeof va === 'string') return sortDir === 'asc' ? va.localeCompare(vb, 'tr') : vb.localeCompare(va, 'tr');
          return sortDir === 'asc' ? va - vb : vb - va;
        });
      }

      tbody.innerHTML = '';
      let totTah = 0, totTsl = 0, totKal = 0;

      displayRows.forEach(r => {
        totTah += r.tah; totTsl += r.tsl; totKal += r.kal;

        // Yetim kayƒ±tlar i√ßin farklƒ± bir stil (opsiyonel)
        const rowStyle = r.isOrphan ? 'background:#fff7ed' : ''; // Hafif turuncu

        tbody.innerHTML += `
          <tr style="${rowStyle}">
            <td>${r.yil}</td>
            <td>${r.faaliyet} ${r.isOrphan ? '<span style="color:red;font-size:10px">(Tahakkuksuz)</span>' : ''}</td>
            ${showPersonelColumn ? `<td>${r.personel}</td>` : ''}
            <td>${r.borclu}</td>
            <td>${r.odeyen}</td>
            <td>${r.aciklama || ''}</td>
            <td class="right">${money(r.tah)}</td>
            <td class="right">${money(r.tsl)}</td>
            <td class="right" style="color:${r.kal > 0 ? 'var(--warn)' : 'var(--ink)'}">${money(r.kal)}</td>
          </tr>
        `;
      });

      const colSpan = showPersonelColumn ? 6 : 5;
      tfoot.innerHTML = `
        <tr>
          <td colspan="${colSpan}" class="right">GENEL TOPLAM</td>
          <td class="right">${money(totTah)}</td>
          <td class="right">${money(totTsl)}</td>
          <td class="right">${money(totKal)}</td>
        </tr>
      `;

      qs('#pillAdet').textContent = `${displayRows.length} Kayƒ±t`;
    }

    // --- Event Listeners ---
    qs('#btnYukle').addEventListener('click', async () => {
      const btn = qs('#btnYukle');
      const oldText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Y√ºkleniyor...';
      try {
        await loadData();     // Firestore'dan veriyi yeniden √ßek
        renderReport();       // G√ºncel veriyle raporu yeniden olu≈ütur
      } catch (e) {
        console.error('Yeniden y√ºkleme hatasƒ±:', e);
      } finally {
        btn.disabled = false;
        btn.textContent = oldText;
      }
    });
    qs('#personelSecim').addEventListener('change', renderReport);
    qs('#selYil').addEventListener('change', renderReport);
    qs('#btnYazdir').addEventListener('click', () => {
      const p = qs('#personelSecim').value;
      const y = qs('#selYil').value;
      window.open(`rapor-yazdir.html?personel=${encodeURIComponent(p)}&yil=${y}`, '_blank');
    });

    qs('#btnGizle').addEventListener('click', () => {
      hideZero = !hideZero;
      qs('#btnGizle').textContent = hideZero ? 'Kalan Sƒ±fƒ±r Olanlarƒ± G√∂ster' : 'Kalan Sƒ±fƒ±r Olanlarƒ± Gizle';
      const isAll = qs('#personelSecim').value === 'ALL';
      renderTable(isAll);
    });

        /* ===== Toast, Nav, Auth - ortak.js'den gelecek ===== */
        // showToast, fetchPanels, renderNav, loadNotifications, initAppShell, initAppShellAuth - ortak.js'de tanƒ±mlƒ±
        // window.initPage fonksiyonu ortak.js tarafƒ±ndan √ßaƒürƒ±lacak
      }); // waitForOrtak callback kapat
    }); // DOMContentLoaded kapat
  </script>
</body>

</html>