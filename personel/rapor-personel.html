<!DOCTYPE html>
<html lang="tr">

<head>
  <meta charset="UTF-8" />
  <title>Ki≈üi Bazlƒ± Alacak Raporu</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="../../js/firebase/firebase-init.js"></script>

  <style>
    :root {
      --appbar-h: 56px;
      --bg: #f4f6f9;
      --card: #fff;
      --ink: #2c3e50;
      --muted: #6c7a89;
      --accent: #324960;
      --good: #2d6a4f;
      --warn: #d35400;
      --border: #e6ebf2;
      --danger: #c0392b;
      --stroke: rgba(15, 23, 42, 0.12);
      --text: #0b1220;
      --surface: #f1f5ff;
      --surface2: #f6f8ff;
      --shadow: 0 12px 28px rgba(0, 0, 0, 0.12);
    }

    * {
      box-sizing: border-box
    }

    body {
      margin: 0;
      font-family: 'Segoe UI', system-ui, -apple-system, Arial, sans-serif;
      background: var(--bg);
      color: var(--ink)
    }

    img {
      max-width: 100%;
      height: auto;
      display: block
    }

    /* √úst APPBAR & Navigasyon (alacak-takibi ile uyumlu) */
    .appbar {
      position: sticky;
      top: 0;
      z-index: 60;
      height: var(--appbar-h);
      background: var(--card);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid var(--stroke);
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 0 12px
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
      cursor: pointer
    }

    .brand img {
      width: 24px;
      height: 24px
    }

    .brand span {
      font-weight: 900;
      letter-spacing: .02em;
      color: var(--text)
    }

    .nav-center {
      margin: 0 auto;
      height: 100%
    }

    .nav-list {
      display: flex;
      gap: 22px;
      align-items: center;
      height: 100%;
      list-style: none;
      margin: 0;
      padding: 0
    }

    .nav-item {
      position: relative;
      height: 100%
    }

    .nav-btn {
      height: 100%;
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 800;
      cursor: pointer;
      color: var(--text)
    }

    .nav-btn:hover {
      color: var(--accent)
    }

    .caret {
      font-size: 12px;
      opacity: .6
    }

    .dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      min-width: 240px;
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: 12px;
      box-shadow: var(--shadow);
      padding: 8px;
      display: none
    }

    .dropdown a {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 10px 12px;
      border-radius: 10px;
      color: var(--text);
      text-decoration: none
    }

    .dropdown a:hover {
      background: var(--surface2)
    }

    .nav-item.open .dropdown {
      display: block
    }

    .nav-right {
      display: flex;
      gap: 8px;
      align-items: center
    }

    .btn {
      border: 1px solid var(--stroke);
      background: var(--surface2);
      color: var(--text);
      border-radius: 999px;
      padding: 8px 14px;
      cursor: pointer;
      white-space: nowrap;
      font-weight: 700
    }

    .hamb {
      display: none
    }

    .iconbtn {
      position: relative;
      border: 1px solid var(--stroke);
      background: var(--card);
      color: var(--text);
      border-radius: 999px;
      padding: 8px 12px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px
    }

    .drop-right {
      left: auto;
      right: 0
    }

    .avatar {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background: linear-gradient(180deg, #94a3b8, #64748b)
    }

    @media (max-width: 960px) {
      .nav-center {
        display: none
      }

      .hamb {
        display: inline-flex
      }
    }

    /* Drawer */
    .drawer {
      position: fixed;
      top: var(--appbar-h);
      right: 0;
      bottom: 0;
      left: 34%;
      transform: translateX(100%);
      transition: .25s;
      background: var(--card);
      border-left: 1px solid var(--stroke);
      z-index: 70;
      overflow: auto;
      padding: 16px
    }

    .drawer.open {
      transform: translateX(0)
    }

    .drawer .panel-title {
      margin: 14px 4px 6px;
      font-weight: 800;
      color: var(--muted);
      font-size: 13px
    }

    .drawer a {
      display: block;
      padding: 12px;
      border-radius: 12px;
      border: 1px solid var(--stroke);
      margin: 8px 0;
      color: var(--text);
      background: var(--surface2);
      text-decoration: none
    }

    .drawer a:hover {
      background: var(--surface)
    }

    .wrap {
      max-width: 1180px;
      margin: 0 auto;
      padding: 12px 16px
    }

    header {
      position: sticky;
      top: var(--appbar-h);
      z-index: 5;
      background: var(--card);
      border-bottom: 1px solid var(--border);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05)
    }

    .rapor-ust {
      display: flex;
      gap: 16px;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      padding: 12px 0
    }

    .rapor-baslik {
      font-size: 22px;
      line-height: 1.25;
      margin: 0;
      white-space: normal;
      word-break: break-word;
      overflow-wrap: anywhere
    }

    .kisi-secim {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap
    }

    select,
    button {
      height: 38px;
      border: 1px solid var(--border);
      background: #fff;
      border-radius: 10px;
      padding: 0 12px;
      font: inherit;
      color: var(--ink)
    }

    button {
      background: var(--accent);
      color: #fff;
      border: none;
      cursor: pointer
    }

    button.secondary {
      background: #fff;
      color: var(--ink);
      border: 1px solid var(--border)
    }

    button:hover {
      opacity: 0.9
    }

    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px;
      margin-top: 12px
    }

    .row {
      display: grid;
      gap: 12px
    }

    .row.cols-4 {
      grid-template-columns: repeat(4, 1fr)
    }

    @media (max-width:900px) {
      .row.cols-4 {
        grid-template-columns: 1fr 1fr
      }
    }

    @media (max-width:640px) {
      .row.cols-4 {
        grid-template-columns: 1fr
      }
    }

    .kpi {
      display: flex;
      flex-direction: column;
      gap: 4px
    }

    .kpi .label {
      color: var(--muted);
      font-size: 12px
    }

    .kpi .value {
      font-size: 20px;
      font-weight: 600
    }

    .kpi.warn .value {
      color: var(--warn)
    }

    .kpi.good .value {
      color: var(--good)
    }

    /* Sƒ±ralama Rozeti */
    .rank-card {
      background: linear-gradient(135deg, #fff, #f8fafc);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 12px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.03);
    }

    .rank-icon {
      font-size: 24px
    }

    .rank-info {
      flex: 1
    }

    .rank-title {
      font-size: 13px;
      color: var(--muted);
      font-weight: 600
    }

    .rank-val {
      font-size: 16px;
      font-weight: 700;
      color: var(--ink)
    }

    /* Faaliyet Grid */
    .faaliyet-grid {
      display: grid;
      gap: 10px;
      grid-template-columns: repeat(4, 1fr)
    }

    @media (max-width:900px) {
      .faaliyet-grid {
        grid-template-columns: 1fr 1fr
      }
    }

    @media (max-width:640px) {
      .faaliyet-grid {
        grid-template-columns: 1fr
      }
    }

    .faaliyet-kart {
      display: flex;
      flex-direction: column;
      gap: 4px;
      padding: 12px;
      border: 1px solid #eef2f7;
      border-radius: 12px;
      background: #fff;
    }

    .f-title {
      font-weight: 700;
      margin-bottom: 4px
    }

    .f-row {
      display: flex;
      justify-content: space-between;
      font-size: 13px
    }

    .kalan-etiket {
      align-self: flex-start;
      margin-top: 6px;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 700;
    }

    .kalan-pozitif {
      background: #fff7ed;
      color: #9a3412;
      border: 1px solid #fdba74
    }

    .kalan-non {
      background: #ecfdf5;
      color: #065f46;
      border: 1px solid #86efac
    }

    .kalan-negatif {
      background: #eff6ff;
      color: #1d4ed8;
      border: 1px solid #93c5fd
    }

    /* Tablo */
    .table-wrap {
      overflow: visible;
      border: 1px solid var(--border);
      border-radius: 12px
    }

    /* Scroll kaldƒ±rƒ±ldƒ± */
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
      min-width: 760px
    }

    thead th {
      position: sticky;
      top: 60px;
      background: #fafbfc;
      border-bottom: 1px solid var(--border);
      font-weight: 600;
      text-align: left;
      font-size: 13px;
      color: var(--muted);
      padding: 10px;
      white-space: nowrap;
      cursor: pointer;
      user-select: none;
      z-index: 4
    }

    thead th:hover {
      background: #f1f5f9;
      color: var(--ink)
    }

    thead th.sort-asc::after {
      content: " ‚ñ≤";
      font-size: 10px
    }

    thead th.sort-desc::after {
      content: " ‚ñº";
      font-size: 10px
    }

    tbody td {
      border-bottom: 1px solid var(--border);
      padding: 10px;
      font-size: 14px
    }

    tbody tr:last-child td {
      border-bottom: none
    }

    tfoot td {
      border-top: 2px solid var(--border);
      padding: 10px;
      font-weight: 700;
      background: #f8fafc;
      color: var(--ink)
    }

    .right {
      text-align: right
    }

    /* Progress Bar */
    .progress-bg {
      background: #e2e8f0;
      height: 6px;
      border-radius: 999px;
      overflow: hidden;
      width: 80px;
      display: inline-block;
      vertical-align: middle;
      margin-right: 6px
    }

    .progress-fill {
      height: 100%;
      background: var(--accent);
      border-radius: 999px
    }

    .progress-text {
      font-size: 12px;
      font-weight: 600;
      color: var(--muted)
    }

    /* Ayrƒ±lan Personel */
    .separator-row td {
      background: #f1f5f9;
      color: var(--muted);
      font-weight: 700;
      text-align: center;
      padding: 8px;
      font-size: 12px;
      letter-spacing: 1px
    }

    .ayrilan-row {
      background: #fff1f2
    }

    .ayrilan-row td {
      color: #881337
    }

    /* Print */
    @media print {
      header {
        display: none
      }

      .wrap {
        max-width: 100%;
        padding: 0
      }

      .card {
        border: none;
        padding: 0;
        margin: 0
      }

      .table-wrap {
        border: none
      }
    }

    /* Toasts (alacak-takibi ile uyumlu) */
    .toast-container {
      position: fixed;
      top: 72px;
      right: 16px;
      z-index: 12000;
      display: flex;
      flex-direction: column;
      gap: 8px;
      pointer-events: none
    }

    .toast {
      min-width: 260px;
      max-width: 360px;
      background: rgba(15, 23, 42, .96);
      color: #f9fafb;
      border-radius: 12px;
      padding: 10px 12px;
      display: flex;
      align-items: flex-start;
      gap: 8px;
      box-shadow: 0 18px 40px rgba(15, 23, 42, .35);
      transform: translateY(-8px) translateX(8px);
      opacity: 0;
      transition: all .25s ease;
      pointer-events: auto;
      border: 1px solid rgba(148, 163, 184, .35);
      backdrop-filter: blur(14px);
      -webkit-backdrop-filter: blur(14px);
      font-size: 13px
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0) translateX(0)
    }

    .toast-icon {
      font-size: 18px;
      margin-top: 2px
    }

    .toast-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 2px
    }

    .toast-title {
      font-weight: 600;
      letter-spacing: .01em
    }

    .toast-message {
      font-size: 12px;
      color: #e5e7eb
    }

    .toast-close {
      background: transparent;
      border: none;
      color: #94a3b8;
      font-size: 16px;
      cursor: pointer;
      padding: 0 0 0 4px;
      line-height: 1
    }

    .toast-close:hover {
      color: #e5e7eb
    }

    .toast.success {
      border-left: 3px solid #22c55e
    }

    .toast.error {
      border-left: 3px solid #ef4444
    }

    .toast.warning {
      border-left: 3px solid #f59e0b
    }

    .toast.info {
      border-left: 3px solid #3b82f6
    }

    @media (max-width:640px) {
      .toast-container {
        left: 12px;
        right: 12px
      }

      .toast {
        width: 100%;
        max-width: none
      }
    }
  </style>
</head>

<body>
  <!-- √úST APPBAR (alacak-takibi ile aynƒ± yapƒ±) -->
  <div class="appbar">
    <div class="brand" onclick="location.href='../panel.html'">
      <img src="../img/logo.png" alt="logo"><span>KARAAƒûA√á FATƒ∞H</span>
    </div>
    <nav class="nav-center">
      <ul class="nav-list" id="navMain"></ul>
    </nav>
    <div class="nav-right">
      <button class="btn hamb" id="hamburger" title="Men√º">‚ò∞</button>
      <div class="nav-item">
        <button class="iconbtn" id="btnProfile" title="Profil">
          <span class="avatar"></span> <span id="profName" class="muted">Profil</span>
        </button>
        <div class="dropdown drop-right" id="profDropdown">
          <a href="../diger/kullanici-yonetimi.html">üë§ Profil</a>
          <a href="../diger/sistem-ayarlari.html">‚öôÔ∏è Ayarlar</a>
          <a href="#" id="btnLogout">üö™ √áƒ±kƒ±≈ü Yap</a>
        </div>
      </div>
    </div>
  </div>
  <aside class="drawer" id="drawer"></aside>
  <div class="toast-container" id="toastContainer"></div>

  <header>
    <div class="wrap">
      <div class="rapor-ust">
        <h1 class="rapor-baslik">Ki≈üi Bazlƒ± Alacak Raporu</h1>
        <div class="kisi-secim" id="controlPanel" style="display:none">
          <select id="personelSecim"></select>
          <select id="selYil">
            <option value="2023">2023</option>
            <option value="2024">2024</option>
            <option value="2025" selected>2025</option>
            <option value="2026">2026</option>
            <option value="tum">T√ºm Yƒ±llar</option>
          </select>
          <button id="btnYukle">Y√ºkle</button>
          <button id="btnGizle" class="secondary">Kalan Sƒ±fƒ±r Olanlarƒ± Gizle</button>
          <button id="btnYazdir" class="secondary">üñ®Ô∏è Yazdƒ±r</button>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">

    <!-- √úst Bilgi Kartƒ± -->
    <div class="card" id="infoCard">
      <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
        <div>
          <h2 id="baslik" style="margin:0">Y√ºkleniyor...</h2>
          <div class="muted" id="altBaslik"></div>
        </div>
        <div><span class="pill" id="pillAdet"
            style="background:#f1f5f9;padding:4px 10px;border-radius:6px;font-size:13px;font-weight:600"></span></div>
      </div>
    </div>

    <!-- Sƒ±ralama Kartƒ± (Tek Personel Modu) -->
    <div id="rankArea" style="margin-top:12px; display:none"></div>

    <!-- KPI Kartlarƒ± -->
    <div class="row cols-4" style="margin-top:12px">
      <div class="card kpi"><span class="label">Toplam Tahakkuk</span><span class="value" id="kpiTahakkuk">‚Ç∫0</span>
      </div>
      <div class="card kpi good"><span class="label">Toplam Tahsilat</span><span class="value"
          id="kpiTahsilat">‚Ç∫0</span></div>
      <div class="card kpi warn"><span class="label">Kalan</span><span class="value" id="kpiKalan">‚Ç∫0</span></div>
      <div class="card kpi good"><span class="label">Tahsilat Nispeti</span><span class="value" id="kpiNispet">0%</span>
      </div>
    </div>

    <!-- Faaliyet √ñzeti (Tek Personel Modu) -->
    <div class="card" id="faaliyetCard" style="margin-top:12px; display:none">
      <h3 style="margin:0 0 12px">Faaliyet Bazlƒ± √ñzet</h3>
      <div class="faaliyet-grid" id="faaliyetGrid"></div>
    </div>

    <!-- Ba≈üarƒ± Sƒ±ralamasƒ± Tablosu (Sadece T√ºm Personel Modunda) -->
    <div class="card" id="rankTableCard" style="margin-top:12px; display:none">
      <h3 style="margin:0 0 12px">Personel Ba≈üarƒ± Sƒ±ralamasƒ±</h3>
      <div class="table-wrap">
        <table id="rankTbl">
          <thead>
            <tr>
              <th style="width:50px">#</th>
              <th>Personel</th>
              <th class="right">Toplam Tahakkuk</th>
              <th class="right">Toplam Tahsilat</th>
              <th class="right">Kalan</th>
              <th style="width:200px">Tahsilat Nispeti</th>
            </tr>
          </thead>
          <tbody id="rankTbody"></tbody>
        </table>
      </div>
    </div>

    <!-- Detay Tablo -->
    <div class="card" style="margin-top:12px">
      <h3 style="margin:0 0 12px" id="tabloBaslik">Detaylƒ± Liste</h3>
      <div class="table-wrap">
        <table id="tbl">
          <thead id="thead"></thead>
          <tbody id="tbody"></tbody>
          <tfoot id="tfoot"></tfoot>
        </table>
      </div>
    </div>

  </main>

  <script>
    // --- Ayarlar & Sabitler ---
    const ADMINS = ['samet √ßakƒ±r', 'muhsin √ßelik'];
    const MERGE_MAP = {
      'keramettin kocaoƒülu': 'Kerem Kocaoƒülu',
      'kerem kocaoƒülu': 'Kerem Kocaoƒülu'
    };
    const AYRILANLAR = ['burak serin'];

    const db = window.db;
    const auth = firebase.auth();

    // --- Yardƒ±mcƒ±lar ---
    const qs = s => document.querySelector(s);
    const money = n => new Intl.NumberFormat('tr-TR', { style: 'currency', currency: 'TRY', maximumFractionDigits: 2 }).format(n || 0);
    const tidy = s => (s || '').toString().trim().replace(/\s+/g, ' ');
    const normTR = s => tidy(s).toLocaleLowerCase('tr-TR');

    function titleTR(s) {
      const lower = normTR(s);
      const SEP = /([ \t\r\n\-\u2019'_/.,;:()]+)/;
      return lower.split(SEP).map(part => {
        if (!part || SEP.test(part)) return part;
        return part.charAt(0).toLocaleUpperCase('tr-TR') + part.slice(1);
      }).join('');
    }

    function resolveName(name) {
      const n = normTR(name);
      if (MERGE_MAP[n]) return MERGE_MAP[n];
      return titleTR(name);
    }

    // Tarih alanƒ±nƒ± (string / Date / Firestore Timestamp) g√ºvenli ≈üekilde YYYY-MM-DD'e √ßevir
    function toDateKey(v) {
      if (!v) return '';
      if (typeof v === 'string') return v.slice(0, 10);
      if (v instanceof Date) return v.toISOString().slice(0, 10);
      if (typeof v === 'object' && typeof v.toDate === 'function') {
        try { return v.toDate().toISOString().slice(0, 10); } catch (e) { return ''; }
      }
      return '';
    }

    // --- Ana Mantƒ±k ---
    let currentUser = null;
    let isAdmin = false;
    let allTahakkuk = [];
    let allTahsilat = [];
    let currentRows = []; // Sƒ±ralama i√ßin aktif satƒ±rlar
    let sortCol = null;
    let sortDir = 'asc';
    let hideZero = false; // Kalan sƒ±fƒ±r gizle
    let rankSortCol = null; // Personel sƒ±ralamasƒ± i√ßin sƒ±ralama s√ºtunu
    let rankSortDir = 'desc'; // Varsayƒ±lan: Tahsilat nispetine g√∂re azalan
    let rankListData = []; // Sƒ±ralama tablosu i√ßin veri

    async function initPage() {
      await loadData();

      const sel = qs('#personelSecim');
      const controlPanel = qs('#controlPanel');

      const personSet = new Set();
      allTahakkuk.forEach(t => personSet.add(t.personel));
      const personList = [...personSet].sort((a, b) => a.localeCompare(b, 'tr'));

      sel.innerHTML = `<option value="ALL">T√ºm Personel (√ñzet + Detay)</option>` +
        personList.map(p => `<option value="${p}">${p}</option>`).join('');

      if (isAdmin) {
        controlPanel.style.display = 'flex';
        sel.value = 'ALL';
      } else {
        controlPanel.style.display = 'none';
        sel.innerHTML = `<option value="${currentUser}">${currentUser}</option>`;
        sel.value = currentUser;
      }

      renderReport();
    }

    async function loadData() {
      const tSnap = await db.collection('tahakkuklar').get();
      allTahakkuk = tSnap.docs.map(d => {
        const x = d.data();
        return {
          id: d.id,
          ...x,
          personel: resolveName(x.personel),
          borclu: resolveName(x.borclu),
          faaliyet: titleTR(x.faaliyet)
        };
      });

      const sSnap = await db.collection('tahsilatlar').get();
      allTahsilat = sSnap.docs.map(d => {
        const x = d.data();
        return {
          id: d.id,
          ...x,
          personel: resolveName(x.personel),
          borclu: resolveName(x.borclu),
          faaliyet: titleTR(x.faaliyet)
        };
      });
    }

    function renderReport() {
      const selectedPerson = qs('#personelSecim').value;
      const selectedYil = qs('#selYil').value;

      qs('#baslik').textContent = selectedPerson === 'ALL' ? 'T√ºm Personel √ñzeti' : selectedPerson;
      qs('#altBaslik').textContent = `Yƒ±l: ${selectedYil === 'tum' ? 'T√ºm√º' : selectedYil}`;

      let fTahakkuk = allTahakkuk;
      let fTahsilat = allTahsilat;

      if (selectedYil !== 'tum') {
        fTahakkuk = fTahakkuk.filter(x => String(x.yil) === selectedYil);
        fTahsilat = fTahsilat.filter(x => String(x.yil) === selectedYil);
      }

      if (selectedPerson !== 'ALL') {
        fTahakkuk = fTahakkuk.filter(x => x.personel === selectedPerson);
        fTahsilat = fTahsilat.filter(x => x.personel === selectedPerson);

        qs('#rankTableCard').style.display = 'none';
        renderSinglePerson(fTahakkuk, fTahsilat, selectedPerson, selectedYil);
      } else {
        renderAllPersons(fTahakkuk, fTahsilat, selectedYil);
      }
    }

    // E≈üle≈ütirme Fonksiyonu (G√º√ßlendirilmi≈ü)
    function getRelatedTahsilat(tahakkuk, allTahsilatList) {
      return allTahsilatList.filter(s => {
        if (s.tahakkukId && s.tahakkukId === tahakkuk.id) return true;
        if (String(s.yil) === String(tahakkuk.yil) &&
          s.faaliyet === tahakkuk.faaliyet &&
          s.personel === tahakkuk.personel &&
          s.borclu === tahakkuk.borclu) return true;
        return false;
      });
    }

    function renderSinglePerson(tahakkuklar, tahsilatlar, personName, yil) {
      // 1. KPI Hesapla (Daha basit ve doƒüru)
      const sumTah = tahakkuklar.reduce((a, b) => a + (b.tahakkuk || 0), 0);
      const sumTsl = tahsilatlar.reduce((a, b) => a + (b.tutar || 0), 0);

      const kalan = sumTah - sumTsl;
      const nispet = sumTah > 0 ? (sumTsl / sumTah) * 100 : 0;

      qs('#kpiTahakkuk').textContent = money(sumTah);
      qs('#kpiTahsilat').textContent = money(sumTsl);
      qs('#kpiKalan').textContent = money(kalan);
      qs('#kpiNispet').textContent = `%${nispet.toFixed(1)}`;

      // 2. Sƒ±ralama Analizi
      const stats = {};
      let globalTah = allTahakkuk;
      let globalTsl = allTahsilat;
      if (yil !== 'tum') {
        globalTah = globalTah.filter(x => String(x.yil) === yil);
        globalTsl = globalTsl.filter(x => String(x.yil) === yil);
      }

      globalTah.forEach(t => { if (!stats[t.personel]) stats[t.personel] = { t: 0, s: 0 }; stats[t.personel].t += (t.tahakkuk || 0); });
      globalTsl.forEach(t => { if (!stats[t.personel]) stats[t.personel] = { t: 0, s: 0 }; stats[t.personel].s += (t.tutar || 0); });

      const ranking = Object.entries(stats).map(([p, v]) => ({ p, r: v.t > 0 ? (v.s / v.t) * 100 : 0 })).sort((a, b) => b.r - a.r);
      const myRank = ranking.findIndex(r => r.p === personName) + 1;

      const rankArea = qs('#rankArea');
      rankArea.style.display = 'block';
      rankArea.innerHTML = `
        <div class="rank-card">
          <div class="rank-icon">üèÜ</div>
          <div class="rank-info">
            <div class="rank-title">Tahsilat Ba≈üarƒ± Sƒ±ralamasƒ±</div>
            <div class="rank-val">${yil === 'tum' ? 'T√ºm Yƒ±llar' : yil} yƒ±lƒ±nda ${ranking.length} personel arasƒ±nda <strong>${myRank}.</strong> sƒ±radasƒ±nƒ±z.</div>
          </div>
          <div style="font-size:20px; font-weight:800; color:var(--accent)">#${myRank}</div>
        </div>
      `;

      // 3. Faaliyet √ñzeti
      qs('#faaliyetCard').style.display = 'block';
      const fMap = {};
      tahakkuklar.forEach(t => {
        const k = t.faaliyet;
        if (!fMap[k]) fMap[k] = { tah: 0, tsl: 0 };
        fMap[k].tah += (t.tahakkuk || 0);
      });
      tahsilatlar.forEach(t => {
        const k = t.faaliyet;
        if (!fMap[k]) fMap[k] = { tah: 0, tsl: 0 };
        fMap[k].tsl += (t.tutar || 0);
      });

      const fGrid = qs('#faaliyetGrid');
      fGrid.innerHTML = '';
      Object.entries(fMap).forEach(([key, val]) => {
        const kal = val.tah - val.tsl;
        let cls = 'kalan-non';
        if (kal > 0.1) cls = 'kalan-pozitif';
        if (kal < -0.1) cls = 'kalan-negatif';
        fGrid.innerHTML += `
          <div class="faaliyet-kart">
            <div class="f-title">${key}</div>
            <div class="f-row"><span>Tahakkuk:</span> <span>${money(val.tah)}</span></div>
            <div class="f-row"><span>Tahsilat:</span> <span>${money(val.tsl)}</span></div>
            <span class="kalan-etiket ${cls}">Kalan: ${money(kal)}</span>
          </div>
        `;
      });

      // 4. Detay Tablo
      prepareTableData(tahakkuklar, tahsilatlar, false);
    }

    function renderAllPersons(tahakkuklar, tahsilatlar, yil) {
      // KPI Hesapla
      const sumTah = tahakkuklar.reduce((a, b) => a + (b.tahakkuk || 0), 0);
      const sumTsl = tahsilatlar.reduce((a, b) => a + (b.tutar || 0), 0);
      const kalan = sumTah - sumTsl;
      const nispet = sumTah > 0 ? (sumTsl / sumTah) * 100 : 0;

      qs('#kpiTahakkuk').textContent = money(sumTah);
      qs('#kpiTahsilat').textContent = money(sumTsl);
      qs('#kpiKalan').textContent = money(kalan);
      qs('#kpiNispet').textContent = `%${nispet.toFixed(1)}`;

      qs('#rankArea').style.display = 'none';
      qs('#faaliyetCard').style.display = 'none';
      qs('#rankTableCard').style.display = 'block';

      // Sƒ±ralama Tablosu
      const stats = {};
      tahakkuklar.forEach(t => {
        const p = t.personel;
        if (!stats[p]) stats[p] = { t: 0, s: 0 };
        stats[p].t += (t.tahakkuk || 0);
      });
      tahsilatlar.forEach(t => {
        const p = t.personel;
        if (!stats[p]) stats[p] = { t: 0, s: 0 };
        stats[p].s += (t.tutar || 0);
      });

      let list = Object.entries(stats).map(([p, v]) => {
        const k = v.t - v.s;
        const n = v.t > 0 ? (v.s / v.t) * 100 : 0;
        return { p, t: v.t, s: v.s, k, n, isAyrilan: AYRILANLAR.includes(normTR(p)) };
      });

      // Ayrƒ±lan personelleri ayƒ±r
      const ayrilanList = list.filter(r => r.isAyrilan);
      const aktifList = list.filter(r => !r.isAyrilan);

      // Aktif personelleri sƒ±rala (ayrƒ±lanlar sƒ±ralamaya dahil deƒüil)
      if (rankSortCol) {
        aktifList.sort((a, b) => {
          let va = a[rankSortCol], vb = b[rankSortCol];
          if (typeof va === 'string') {
            return rankSortDir === 'asc' ? va.localeCompare(vb, 'tr') : vb.localeCompare(va, 'tr');
          }
          return rankSortDir === 'asc' ? va - vb : vb - va;
        });
      } else {
        // Varsayƒ±lan sƒ±ralama: Tahsilat nispetine g√∂re azalan
        aktifList.sort((a, b) => b.n - a.n);
      }

      rankListData = [...aktifList, ...ayrilanList];
      renderRankTable(aktifList, ayrilanList);

      prepareTableData(tahakkuklar, tahsilatlar, true);
    }

    function renderRankTable(aktifList, ayrilanList) {
      const rankTbl = qs('#rankTbl');
      const rankThead = rankTbl.querySelector('thead');
      const rBody = qs('#rankTbody');

      // Thead'i g√ºncelle - sƒ±ralama √∂zellikleri ekle
      rankThead.innerHTML = `
        <tr>
          <th style="width:50px" data-key="index">#</th>
          <th data-key="p">Personel</th>
          <th class="right" data-key="t">Toplam Tahakkuk</th>
          <th class="right" data-key="s">Toplam Tahsilat</th>
          <th class="right" data-key="k">Kalan</th>
          <th style="width:200px" data-key="n">Tahsilat Nispeti</th>
        </tr>
      `;

      // Sƒ±ralama class'larƒ±nƒ± ekle
      rankThead.querySelectorAll('th').forEach(th => {
        const key = th.dataset.key;
        if (key && rankSortCol === key) {
          th.classList.add(rankSortDir === 'asc' ? 'sort-asc' : 'sort-desc');
        }
        // Click event listener ekle
        if (key && key !== 'index') {
          th.addEventListener('click', () => {
            if (rankSortCol === key) {
              rankSortDir = rankSortDir === 'asc' ? 'desc' : 'asc';
            } else {
              rankSortCol = key;
              rankSortDir = 'asc';
            }
            // Sƒ±ralamayƒ± yeniden yap
            const selectedYil = qs('#selYil').value;
            let fTahakkuk = allTahakkuk;
            let fTahsilat = allTahsilat;
            if (selectedYil !== 'tum') {
              fTahakkuk = fTahakkuk.filter(x => String(x.yil) === selectedYil);
              fTahsilat = fTahsilat.filter(x => String(x.yil) === selectedYil);
            }
            renderAllPersons(fTahakkuk, fTahsilat, selectedYil);
          });
        }
      });

      rBody.innerHTML = '';
      let sep = false;

      // Aktif personelleri g√∂ster
      aktifList.forEach((r, idx) => {
        let color = '#ef4444';
        if (r.n >= 50) color = '#f59e0b';
        if (r.n >= 80) color = '#22c55e';
        if (r.n >= 100) color = '#15803d';

        rBody.innerHTML += `
          <tr>
            <td>${idx + 1}</td>
            <td style="font-weight:600">${r.p}</td>
            <td class="right">${money(r.t)}</td>
            <td class="right">${money(r.s)}</td>
            <td class="right" style="color:${r.k > 0 ? 'var(--warn)' : 'var(--muted)'}">${money(r.k)}</td>
            <td>
              <div style="display:flex;align-items:center">
                <div class="progress-bg"><div class="progress-fill" style="width:${Math.min(r.n, 100)}%; background:${color}"></div></div>
                <span class="progress-text" style="color:${color}">%${r.n.toFixed(1)}</span>
              </div>
            </td>
          </tr>
        `;
      });

      // Ayrƒ±lan personelleri g√∂ster
      if (ayrilanList.length > 0) {
        rBody.innerHTML += `<tr class="separator-row"><td colspan="6">AYRILAN PERSONEL</td></tr>`;
        ayrilanList.forEach((r) => {
          let color = '#ef4444';
          if (r.n >= 50) color = '#f59e0b';
          if (r.n >= 80) color = '#22c55e';
          if (r.n >= 100) color = '#15803d';

          rBody.innerHTML += `
            <tr class="ayrilan-row">
              <td>-</td>
              <td style="font-weight:600">${r.p}</td>
              <td class="right">${money(r.t)}</td>
              <td class="right">${money(r.s)}</td>
              <td class="right" style="color:${r.k > 0 ? 'var(--warn)' : 'var(--muted)'}">${money(r.k)}</td>
              <td>
                <div style="display:flex;align-items:center">
                  <div class="progress-bg"><div class="progress-fill" style="width:${Math.min(r.n, 100)}%; background:${color}"></div></div>
                  <span class="progress-text" style="color:${color}">%${r.n.toFixed(1)}</span>
                </div>
              </td>
            </tr>
          `;
        });
      }
    }

    function prepareTableData(tahakkuklar, tahsilatlar, showPersonelColumn) {
      const usedTahsilatIds = new Set();
      const rows = [];

      // 1. Tahakkuklarƒ± ve e≈üle≈üen tahsilatlarƒ± i≈üle
      tahakkuklar.forEach(t => {
        const related = getRelatedTahsilat(t, tahsilatlar);
        related.forEach(s => usedTahsilatIds.add(s.id)); // Kullanƒ±lanlarƒ± i≈üaretle

        const tslSum = related.reduce((a, b) => a + (b.tutar || 0), 0);

        // En g√ºncel ve dolu "√∂deyen" bilgisini bul
        let lastPayment = null;
        if (related.length > 0) {
          const sorted = related.slice().sort((a, b) => toDateKey(a.tarih).localeCompare(toDateKey(b.tarih)));
          for (let i = sorted.length - 1; i >= 0; i--) {
            if (sorted[i].odeyen && tidy(sorted[i].odeyen)) {
              lastPayment = sorted[i];
              break;
            }
          }
          if (!lastPayment) lastPayment = sorted[sorted.length - 1];
        }
        const odeyen = (lastPayment && tidy(lastPayment.odeyen)) || tidy(t.odeyen) || '-';

        rows.push({
          yil: t.yil,
          faaliyet: t.faaliyet,
          personel: t.personel,
          borclu: t.borclu,
          odeyen: odeyen,
          aciklama: tidy(t.aciklama),
          tah: t.tahakkuk,
          tsl: tslSum,
          kal: t.tahakkuk - tslSum,
          isOrphan: false
        });
      });

      // 2. E≈üle≈ümeyen (Yetim) Tahsilatlarƒ± Bul
      tahsilatlar.forEach(s => {
        if (!usedTahsilatIds.has(s.id)) {
          rows.push({
            yil: s.yil,
            faaliyet: s.faaliyet,
            personel: s.personel,
            borclu: s.borclu,
            odeyen: s.odeyen || '-',
            aciklama: tidy(s.aciklama),
            tah: 0, // Tahakkuk yok
            tsl: s.tutar,
            kal: 0 - s.tutar, // Eksi bakiye (Alacaklƒ±)
            isOrphan: true
          });
        }
      });

      currentRows = rows;
      renderTable(showPersonelColumn);
    }

    function renderTable(showPersonelColumn) {
      const thead = qs('#thead');
      const tbody = qs('#tbody');
      const tfoot = qs('#tfoot');

      let headers = [
        { key: 'yil', label: 'Yƒ±l' },
        { key: 'faaliyet', label: 'Faaliyet' },
        ...(showPersonelColumn ? [{ key: 'personel', label: 'Personel' }] : []),
        { key: 'borclu', label: 'Bor√ßlu' },
        { key: 'odeyen', label: '√ñdeyen' },
        { key: 'aciklama', label: 'A√ßƒ±klama' },
        { key: 'tah', label: 'Tahakkuk', cls: 'right' },
        { key: 'tsl', label: 'Tahsilat', cls: 'right' },
        { key: 'kal', label: 'Kalan', cls: 'right' }
      ];

      thead.innerHTML = '<tr>' + headers.map(h =>
        `<th data-key="${h.key}" class="${h.cls || ''} ${sortCol === h.key ? (sortDir === 'asc' ? 'sort-asc' : 'sort-desc') : ''}">${h.label}</th>`
      ).join('') + '</tr>';

      thead.querySelectorAll('th').forEach(th => {
        th.addEventListener('click', () => {
          const key = th.dataset.key;
          if (sortCol === key) sortDir = sortDir === 'asc' ? 'desc' : 'asc';
          else { sortCol = key; sortDir = 'asc'; }
          renderTable(showPersonelColumn);
        });
      });

      let displayRows = [...currentRows];

      if (hideZero) {
        displayRows = displayRows.filter(r => Math.abs(r.kal) > 0.1);
      }

      if (sortCol) {
        displayRows.sort((a, b) => {
          let va = a[sortCol], vb = b[sortCol];
          if (typeof va === 'string') return sortDir === 'asc' ? va.localeCompare(vb, 'tr') : vb.localeCompare(va, 'tr');
          return sortDir === 'asc' ? va - vb : vb - va;
        });
      }

      tbody.innerHTML = '';
      let totTah = 0, totTsl = 0, totKal = 0;

      displayRows.forEach(r => {
        totTah += r.tah; totTsl += r.tsl; totKal += r.kal;

        // Yetim kayƒ±tlar i√ßin farklƒ± bir stil (opsiyonel)
        const rowStyle = r.isOrphan ? 'background:#fff7ed' : ''; // Hafif turuncu

        tbody.innerHTML += `
          <tr style="${rowStyle}">
            <td>${r.yil}</td>
            <td>${r.faaliyet} ${r.isOrphan ? '<span style="color:red;font-size:10px">(Tahakkuksuz)</span>' : ''}</td>
            ${showPersonelColumn ? `<td>${r.personel}</td>` : ''}
            <td>${r.borclu}</td>
            <td>${r.odeyen}</td>
            <td>${r.aciklama || ''}</td>
            <td class="right">${money(r.tah)}</td>
            <td class="right">${money(r.tsl)}</td>
            <td class="right" style="color:${r.kal > 0 ? 'var(--warn)' : 'var(--ink)'}">${money(r.kal)}</td>
          </tr>
        `;
      });

      const colSpan = showPersonelColumn ? 6 : 5;
      tfoot.innerHTML = `
        <tr>
          <td colspan="${colSpan}" class="right">GENEL TOPLAM</td>
          <td class="right">${money(totTah)}</td>
          <td class="right">${money(totTsl)}</td>
          <td class="right">${money(totKal)}</td>
        </tr>
      `;

      qs('#pillAdet').textContent = `${displayRows.length} Kayƒ±t`;
    }

    // --- Event Listeners ---
    qs('#btnYukle').addEventListener('click', async () => {
      const btn = qs('#btnYukle');
      const oldText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'Y√ºkleniyor...';
      try {
        await loadData();     // Firestore'dan veriyi yeniden √ßek
        renderReport();       // G√ºncel veriyle raporu yeniden olu≈ütur
      } catch (e) {
        console.error('Yeniden y√ºkleme hatasƒ±:', e);
      } finally {
        btn.disabled = false;
        btn.textContent = oldText;
      }
    });
    qs('#personelSecim').addEventListener('change', renderReport);
    qs('#selYil').addEventListener('change', renderReport);
    qs('#btnYazdir').addEventListener('click', () => {
      const p = qs('#personelSecim').value;
      const y = qs('#selYil').value;
      window.open(`rapor-yazdir.html?personel=${encodeURIComponent(p)}&yil=${y}`, '_blank');
    });

    qs('#btnGizle').addEventListener('click', () => {
      hideZero = !hideZero;
      qs('#btnGizle').textContent = hideZero ? 'Kalan Sƒ±fƒ±r Olanlarƒ± G√∂ster' : 'Kalan Sƒ±fƒ±r Olanlarƒ± Gizle';
      const isAll = qs('#personelSecim').value === 'ALL';
      renderTable(isAll);
    });

    // ==== Toast helper (appbar ile uyumlu) ====
    function showToast(type, title, message) {
      const cont = document.getElementById('toastContainer');
      if (!cont) return;
      const div = document.createElement('div');
      div.className = `toast ${type || 'info'}`;
      div.innerHTML = `
        <div class="toast-icon">${type === 'success' ? '‚úÖ' : type === 'error' ? '‚ö†Ô∏è' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è'}</div>
        <div class="toast-content">
          <div class="toast-title">${title || ''}</div>
          <div class="toast-message">${message || ''}</div>
        </div>
        <button class="toast-close" type="button">&times;</button>
      `;
      cont.appendChild(div);
      requestAnimationFrame(() => div.classList.add('show'));
      const close = () => { div.classList.remove('show'); setTimeout(() => div.remove(), 200); };
      div.querySelector('.toast-close')?.addEventListener('click', close);
      setTimeout(close, 4000);
    }

    /* ===== Navigation Bar (alacak-takibi ile uyumlu) ===== */
    let CURRENT_ALLOW = new Set(), CURRENT_DENY = new Set();
    const norm = (s) => String(s || '').normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase().trim();

    function normalizeUrl(u) {
      if (!u || u === '#') return '#';
      if (/^https?:\/\//i.test(u)) return u;
      if (u.startsWith('//')) return u;
      if (u.startsWith('../') || u.startsWith('./')) return u;
      const currentPath = location.pathname;
      const currentDir = currentPath.substring(0, currentPath.lastIndexOf('/'));
      const currentDepth = currentDir.split('/').filter(x => x).length;
      const upLevels = currentDepth > 0 ? '../'.repeat(currentDepth) : '';
      const targetPath = u.startsWith('/') ? u.substring(1) : u;
      return upLevels + targetPath;
    }

    async function fetchPanels(allowSet, denySet) {
      const res = [];
      try {
        const snap = await db.collection('sayfa_manifesti').get();
        snap.forEach(doc => {
          const d = doc.data() || {}, id = doc.id, panelTitle = d.title || id;
          const panelGrant = allowSet.has(norm(id)) || allowSet.has(norm(panelTitle));
          let pages = Array.isArray(d.pages) ? d.pages : [];
          pages = pages
            .filter(pg => {
              const keyNorm = norm(pg.key || pg.title || '');
              const pageGrant = allowSet.has(keyNorm), denied = denySet.has(keyNorm);
              return !denied && (panelGrant || pageGrant);
            })
            .map(pg => ({
              baslik: pg.title || pg.key || 'Sayfa',
              url: normalizeUrl(pg.path || '#'),
              key: pg.key || pg.title || '',
              sira: typeof pg.order === 'number' ? pg.order : 9999
            }))
            .sort((a, b) => a.sira - b.sira);
          if (pages.length) res.push({ id, baslik: panelTitle, sira: typeof d.order === 'number' ? d.order : 9999, pages });
        });
        res.sort((a, b) => a.sira - b.sira);
      } catch (e) { console.error(e); }
      return res;
    }

    function renderNav(panels) {
      const ul = document.getElementById('navMain'), drawer = document.getElementById('drawer');
      if (!ul || !drawer) return;
      ul.innerHTML = ''; drawer.innerHTML = '';
      if (!panels.length) {
        ul.innerHTML = '<li class="nav-item"><div class="nav-btn">Panel yok</div></li>';
        drawer.innerHTML = '<div class="muted" style="padding:8px">Men√º bulunamadƒ±</div>';
        return;
      }
      panels.forEach(p => {
        const li = document.createElement('li'); li.className = 'nav-item';
        li.innerHTML = `<div class="nav-btn">${p.baslik} <span class="caret">‚ñæ</span></div>`;
        const dd = document.createElement('div'); dd.className = 'dropdown';
        (p.pages || []).forEach(pg => {
          const a = document.createElement('a');
          a.href = normalizeUrl(pg.url || pg.path || '#'); a.textContent = pg.baslik;
          a.dataset.key = pg.key || pg.baslik; a.dataset.panel = p.id; a.dataset.panelTitle = p.baslik;
          dd.appendChild(a);
        });
        li.appendChild(dd);
        li.querySelector('.nav-btn').addEventListener('click', (e) => {
          e.stopPropagation();
          ul.querySelectorAll('.nav-item').forEach(x => { if (x !== li) x.classList.remove('open'); });
          li.classList.toggle('open');
        });
        ul.appendChild(li);

        const h = document.createElement('div'); h.className = 'panel-title'; h.textContent = p.baslik; drawer.appendChild(h);
        (p.pages || []).forEach(pg => {
          const a = document.createElement('a');
          a.href = normalizeUrl(pg.url || pg.path || '#'); a.textContent = pg.baslik;
          a.dataset.key = pg.key || pg.baslik; a.dataset.panel = p.id; a.dataset.panelTitle = p.baslik;
          drawer.appendChild(a);
        });
      });
      document.addEventListener('click', (e) => { if (!ul.contains(e.target)) ul.querySelectorAll('.nav-item').forEach(x => x.classList.remove('open')); });
    }

    (function () {
      const hamb = document.getElementById('hamburger'), drawer = document.getElementById('drawer');
      if (!hamb || !drawer) return;
      hamb.addEventListener('click', () => drawer.classList.toggle('open'));
      document.addEventListener('click', (e) => {
        if (!drawer.contains(e.target) && !hamb.contains(e.target)) drawer.classList.remove('open');
      });
    })();

    document.addEventListener('click', (e) => {
      const a = e.target.closest('a[data-key]'); if (!a) return;
      const key = norm(a.dataset.key), pnl = norm(a.dataset.panel || ''), pnlTitle = norm(a.dataset.panelTitle || '');
      if (CURRENT_DENY.has(key)) { e.preventDefault(); return; }
      const allowed = CURRENT_ALLOW.has(key) || CURRENT_ALLOW.has(pnl) || CURRENT_ALLOW.has(pnlTitle);
      if (!allowed) { e.preventDefault(); }
    });

    (function () {
      const profBtn = document.getElementById('btnProfile'), profDD = document.getElementById('profDropdown');
      function closeAll(e) {
        if (!profDD.contains(e.target) && e.target !== profBtn) profDD.parentElement.classList.remove('open');
      }
      document.addEventListener('click', closeAll);
      profBtn?.addEventListener('click', (e) => { e.stopPropagation(); profDD.parentElement.classList.toggle('open'); });
      document.getElementById('btnLogout')?.addEventListener('click', async (e) => {
        e.preventDefault();
        try { await auth.signOut(); location.assign('../../index.html'); }
        catch (err) { console.error(err); }
      });
    })();

    // Auth + nav + sayfa ba≈ülatma
    auth.onAuthStateChanged(async (user) => {
      if (!user) {
        window.location.href = '../../index.html';
        return;
      }
      try {
        const userDoc = await db.collection('kullanicilar').doc(user.uid).get();
        if (userDoc.exists) {
          const data = userDoc.data();
          const profNameEl = document.getElementById('profName');
          if (profNameEl) profNameEl.textContent = data.adSoyad || user.email?.split('@')[0] || 'Profil';

          const rawPerms = Array.isArray(data.yetkiler) ? data.yetkiler : [];
          CURRENT_ALLOW = new Set(rawPerms.filter(s => !String(s).trim().startsWith('-') && !String(s).trim().startsWith('!')).map(norm));
          CURRENT_DENY = new Set(rawPerms.filter(s => String(s).trim().startsWith('-') || String(s).trim().startsWith('!')).map(s => norm(String(s).replace(/^[-!]\s*/, ''))));

          const panels = await fetchPanels(CURRENT_ALLOW, CURRENT_DENY);
          renderNav(panels);

          // Rapor sayfasƒ± √∂zel mantƒ±k: mevcut kullanƒ±cƒ± bilgisini de ayarla
          const adSoyad = data.adSoyad || data.isim || user.displayName || 'Bilinmeyen';
          currentUser = resolveName(adSoyad);
          isAdmin = ADMINS.includes(normTR(currentUser));
        }
      } catch (e) {
        console.error('Kullanƒ±cƒ± bilgisi alƒ±namadƒ±:', e);
      }

      await initPage();
    });

  </script>
</body>

</html>