<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Yeni Talebe KaydÄ± â€” AdÄ±m 2 (Okul Bilgileri)</title>
  <link rel="stylesheet" href="../css/form.css"/>
</head>
<body>

<div class="kayÄ±t-karti">
  <div class="kart-baslik">
    <h2>ğŸ“ Yeni Talebe KaydÄ±</h2>
    <p>2. AÅŸama â€“ Okul Bilgileri</p>
  </div>

  <div class="form-alani">
    <label>Ã–ÄŸrenim Seviyesi</label>
    <select id="ogrenimSeviyesi" onchange="okulSeviyesiDegisti()">
      <option value="">SeÃ§iniz...</option>
      <option value="Ä°lkokul">Ä°lkokul</option>
      <option value="Ortaokul">Ortaokul</option>
      <option value="Lise">Lise</option>
      <option value="Ãœniversite">Ãœniversite</option>
    </select>

    <label>Mezuniyet Durumu</label>
    <select id="mezuniyetDurumu">
      <option value="">SeÃ§iniz...</option>
      <option value="Mezun">Mezun</option>
      <option value="Devam">Devam Ediyor</option>
    </select>

    <label>EÄŸitim TÃ¼rÃ¼</label>
    <select id="egitimTuru">
      <option value="">SeÃ§iniz...</option>
      <option value="Ã–rgÃ¼n">Ã–rgÃ¼n</option>
      <option value="AÃ§Ä±k">AÃ§Ä±k</option>
    </select>

    <!-- Ãœniversite Bilgileri -->
    <div id="universiteAlani" style="display:none">
      <label>Ãœniversite TÃ¼rÃ¼</label>
      <select id="universiteTuru">
        <option value="">SeÃ§iniz...</option>
        <option value="Ã–nlisans">Ã–n Lisans</option>
        <option value="Lisans">Lisans</option>
      </select>

      <label>Ãœniversite AdÄ±</label>
      <input type="text" id="universiteAdi" placeholder="Ã–rn: Ä°stanbul Ãœniversitesi"/>

      <label>BÃ¶lÃ¼m</label>
      <input type="text" id="bolum" placeholder="Ã–rn: Ä°ÅŸ SaÄŸlÄ±ÄŸÄ± ve GÃ¼venliÄŸi"/>

      <label>Ãœniversite SÄ±nÄ±f</label>
      <input type="text" id="uniSinif" placeholder="Ã–rn: 2. SÄ±nÄ±f"/>
    </div>
  </div>

  <div class="ilerleme-paneli">
    <button class="geri-buton" onclick="geriGelAdim1()">â—€ Geri</button>
    <div class="form-asama-gostergesi">AdÄ±m 2 / 6</div>
    <button class="ileri-buton" onclick="ilerleAdim2()">Ä°lerle â–¶</button>
  </div>
</div>

<div id="toast" class="toast-bildirim"></div>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="../js/firebase/firebase-init.js"></script>

<script>
/* ================================================
   AdÄ±m-2 â€” Okul Bilgileri (aynÄ± UID/ÅŸema)
================================================ */
(function(){
  const UID_KEY   = 'talebeUID_v1';
  const DEVRE_KEY = 'talebeDevre_v1';
  const DRAFT_KEY = 'talebeDraft_adim2_v1'; // sadece adÄ±m-2 iÃ§in

  const db = window.db || firebase.firestore();
  const $  = s => document.querySelector(s);

  // --- Ã–NCE TANIMLA: Ãœniversite alanÄ± aÃ§/kapa
  function toggleUni(){
    const val = $('#ogrenimSeviyesi')?.value || '';
    const box = $('#universiteAlani');
    if(box) box.style.display = (val === 'Ãœniversite') ? 'block' : 'none';
  }
  // HTML'deki onchange="okulSeviyesiDegisti()" iÃ§in dÄ±ÅŸarÄ± ver
  window.okulSeviyesiDegisti = toggleUni;

  // AdÄ±m-1 yapÄ±lmadan gelindiyse uyar
  const uid   = localStorage.getItem(UID_KEY);
  const devre = localStorage.getItem(DEVRE_KEY);
  if(!uid || !devre){
    toast('Ã–nce AdÄ±m 1â€™i tamamlayÄ±n.');
    setTimeout(()=>{ location.href = 'talebe-kayit-adim1.html'; }, 900);
    return; // kritik: devam etmeyelim
  }

  // Taslak yardÄ±mcÄ±larÄ±
  function getDraft(){ try{ return JSON.parse(localStorage.getItem(DRAFT_KEY)||'{}'); }catch(_){ return {}; } }
  function setDraft(o){ localStorage.setItem(DRAFT_KEY, JSON.stringify(o||{})); }

  // AlanlarÄ± taslaktan doldur
  (function restore(){
    const d = getDraft();
    const map = {
      ogrenimSeviyesi: '#ogrenimSeviyesi',
      mezuniyetDurumu: '#mezuniyetDurumu',
      egitimTuru: '#egitimTuru',
      universiteTuru: '#universiteTuru',
      universiteAdi:  '#universiteAdi',
      bolum:          '#bolum',
      uniSinif:       '#uniSinif'
    };
    Object.keys(map).forEach(k=>{
      const el = $(map[k]);
      if(el && d[k] != null) el.value = d[k];
    });
    // ArtÄ±k gÃ¼venle Ã§aÄŸÄ±rabiliriz
    toggleUni();
  })();

  // Otomatik taslak kaydÄ±
  ['ogrenimSeviyesi','mezuniyetDurumu','egitimTuru',
   'universiteTuru','universiteAdi','bolum','uniSinif'
  ].forEach(id=>{
    const el = document.getElementById(id);
    if(!el) return;
    ['input','change'].forEach(ev=> el.addEventListener(ev, ()=>{
      const d = getDraft(); d[id] = el.value; setDraft(d);
      if(id==='ogrenimSeviyesi') toggleUni();
    }));
  });

  // Firestore yardÄ±mcÄ±
  function talebeKokRef(devre, uid){
    return db.collection('talebeler').doc(devre).collection('Ã¶ÄŸrenciler').doc(uid);
  }
  function talebeOkulRef(devre, uid){
    return talebeKokRef(devre, uid).collection('bilgiler').doc('okul');
  }

  // Gezinti
  window.geriGelAdim1 = function(){ location.href = 'talebe-kayit-adim1.html'; };

  // Ä°lerle (kayÄ±t)
  window.ilerleAdim2 = async function(){
    const d = getDraft();

    const okul = {
      uid, devre,
      ogrenimSeviyesi: d.ogrenimSeviyesi || '',
      mezuniyetDurumu: d.mezuniyetDurumu || '',
      egitimTuru: d.egitimTuru || '',
      universiteTuru: d.universiteTuru || '',
      universiteAdi:  d.universiteAdi  || '',
      bolum:          d.bolum          || '',
      uniSinif:       d.uniSinif       || '',
      updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    try{
      await talebeKokRef(devre, uid).set({
        ogrenimSeviyesi: okul.ogrenimSeviyesi,
        mezuniyetDurumu: okul.mezuniyetDurumu,
        egitimTuru: okul.egitimTuru,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge:true });

      await talebeOkulRef(devre, uid).set(okul, { merge:true });

      toast('Okul bilgileri kaydedildi. AdÄ±m 3â€™e geÃ§iliyor...');
      location.href = 'talebe-kayit-adim3.html';
    }catch(e){
      console.error(e);
      toast('KayÄ±t sÄ±rasÄ±nda bir hata oluÅŸtu.');
    }
  };

  function toast(m){
    const t = document.getElementById('toast'); if(!t) return alert(m);
    t.textContent = m; t.classList.add('show');
    clearTimeout(window.__tto2);
    window.__tto2 = setTimeout(()=> t.classList.remove('show'), 1600);
  }
})();
</script>
</body>
</html>
