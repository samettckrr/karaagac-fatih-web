<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Yeni Talebe KaydÄ± â€” AdÄ±m 1</title>
  <link rel="stylesheet" href="../css/form.css"/>
  <style>
    :root{ --gap:12px; --radius:12px; --stroke:#e5e7eb }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{ margin:0 }
    .wrap{ max-width:980px; margin:16px auto; padding:16px }
    .card{ background:#fff; border:1px solid var(--stroke); border-radius:var(--radius); padding:16px }
    @media (prefers-color-scheme:dark){
      .card{ background:#0f172a; border-color:#223046; color:#e5e7eb }
    }

    .head h2{ margin:0 0 6px }
    .grid{ display:grid; gap:var(--gap) }
    .grid label{ font-weight:600 }
    .in, select{ width:100%; padding:12px; border-radius:10px; border:1px solid var(--stroke) }
    @media (prefers-color-scheme:dark){
      .in, select{ background:#0b1624; color:#e5e7eb; border-color:#223046 }
    }

    .row{ display:flex; gap:10px; flex-wrap:wrap }
    .btn{ padding:10px 14px; border-radius:10px; border:1px solid #d1d5db; background:#f3f4f6; font-weight:700; cursor:pointer }
    .btn.primary{ background:#10b981; border-color:#10b981; color:#fff }
    .btn.muted{ background:#6b7280; border-color:#6b7280; color:#fff }
    .bar{ display:flex; justify-content:space-between; align-items:center; gap:10px; margin-top:14px; flex-wrap:wrap }

    .hint{ font-size:12px; opacity:.8 }
    .status{ font-size:12px; }
    .status.ok{ color:#10b981 }
    .status.err{ color:#ef4444 }

    /* Mobil taÅŸma Ã¶nleme */
    .head p, .status, .hint{ word-break:break-word }
    .actions{ display:flex; gap:8px; flex-wrap:wrap }

    @media (max-width:720px){
      .wrap{ padding:12px }
      .row > *{ flex:1 1 100% }
    }
  </style>
</head>
<body>

<div class="wrap">
  <div class="card">
    <div class="head">
      <h2>ğŸ“ Yeni Talebe KaydÄ±</h2>
      <p>AdÄ±m 1 â€” Talebe Bilgileri</p>
    </div>

    <div class="grid" id="adim1Form">
      <!-- DEVRE -->
      <label for="devre">DÃ¶nem (Devre) <span class="hint">* zorunlu</span></label>
      <select id="devre" data-field="devre" required>
        <option value="">SeÃ§iniz...</option>
        <option>5.Devre</option><option>6.Devre</option><option>7.Devre</option><option>8.Devre</option>
      </select>

      <!-- FOTOÄRAF (Ã–NÄ°ZLEME YOK) -->
      <label for="fotoFile">FotoÄŸraf <span class="hint">* zorunlu â€” yÃ¼kleyip onaylayÄ±n</span></label>
      <div class="row">
        <input type="file" id="fotoFile" accept="image/*" class="in" style="max-width:420px"/>
        <div class="actions">
          <button type="button" class="btn primary" id="btnFotoYukle">YÃ¼kle</button>
          <button type="button" class="btn" id="btnFotoTemizle">Temizle</button>
        </div>
      </div>
      <div id="fotoDurum" class="status">HenÃ¼z yÃ¼klenmedi.</div>

      <!-- Ä°SÄ°MLER -->
      <label for="kimlikAd">Kimlikteki AdÄ± SoyadÄ± <span class="hint">* zorunlu</span></label>
      <input type="text" id="kimlikAd" data-field="kimlikAd" class="in" placeholder="Ã–rn: MEHMET YILMAZ"/>

      <label for="kullAd">KullandÄ±ÄŸÄ± AdÄ± SoyadÄ± <span class="hint">* zorunlu</span></label>
      <input type="text" id="kullAd" data-field="kullAd" class="in" placeholder="Ã–rn: Mehmet YÄ±lmaz"/>

      <!-- KURS -->
      <label for="kurs">GeldiÄŸi Kurs <span class="hint">* zorunlu</span></label>
      <select id="kurs" data-field="kurs">
        <option value="">SeÃ§iniz...</option>
        <option>AtÄ±ÅŸalanÄ± Birlik</option><option>BoÄŸazkÃ¶y</option><option>Esenyurt</option><option>Florya</option>
        <option>GÃ¼neÅŸli Ferah</option><option>GÃ¼rcistan Ofis</option><option>GÃ¼ven Proje</option><option>KabakÃ§a</option>
        <option>Yavuz Selim</option><option>Yusuf AydÄ±n</option>
      </select>

      <!-- DURUM -->
      <label for="durum">Durum (Muhacir / Ensar) <span class="hint">* zorunlu</span></label>
      <select id="durum" data-field="durum">
        <option value="">SeÃ§iniz...</option>
        <option>Muhacir</option>
        <option>Ensar</option>
      </select>

      <!-- Muhacir AlanlarÄ± -->
      <div id="muhacirAlani" style="display:none">
        <label for="ikametDurumu">Ä°kameti Var mÄ±?</label>
        <select id="ikametDurumu" data-field="ikametDurumu">
          <option value="">SeÃ§iniz...</option>
          <option>Var</option><option>Yok</option>
        </select>

        <div id="kimlikBitisDiv" style="display:none">
          <label for="kimlikBitis">Kimlik BitiÅŸ Tarihi</label>
          <input type="date" id="kimlikBitis" data-field="kimlikBitis" class="in"/>
        </div>

        <label for="ulke">Memleket (Ãœlke)</label>
        <select id="ulke" data-field="ulke">
          <option value="">Bir Ã¼lke seÃ§iniz...</option>
          <!-- KISA GÃ–VDE: Tam listeyi kullanÄ±yoruz -->
          <option>Afganistan</option><option>Almanya</option><option>Amerika BirleÅŸik Devletleri</option>
          <option>Arnavutluk</option><option>Avusturya</option><option>Azerbaycan</option><option>BangladeÅŸ</option>
          <option>BelÃ§ika</option><option>BirleÅŸik Arap Emirlikleri</option><option>BirleÅŸik KrallÄ±k</option>
          <option>Bosna-Hersek</option><option>Brezilya</option><option>Bulgaristan</option><option>Cezayir</option>
          <option>Ã‡ad</option><option>Ã‡ekya</option><option>Ã‡in</option><option>Danimarka</option><option>Endonezya</option>
          <option>Etiyopya</option><option>Fas</option><option>Filistin</option><option>Fransa</option><option>Gana</option>
          <option>GÃ¼rcistan</option><option>Hindistan</option><option>Hollanda</option><option>Irak</option><option>Ä°ran</option>
          <option>Ä°spanya</option><option>Ä°srail</option><option>Ä°sveÃ§</option><option>Ä°sviÃ§re</option><option>Ä°talya</option>
          <option>Japonya</option><option>Kazakistan</option><option>KÄ±rgÄ±zistan</option><option>Kenya</option><option>Kuveyt</option>
          <option>LÃ¼bnan</option><option>Macaristan</option><option>MÄ±sÄ±r</option><option>Morocco</option>
          <option>Nijer</option><option>Nijerya</option><option>Ã–zbekistan</option><option>Pakistan</option>
          <option>Romanya</option><option>Rusya</option><option>Senegal</option><option>Somali</option><option>Sudan</option>
          <option>Suriye</option><option>Suudi Arabistan</option><option>Tacikistan</option><option>Tanzanya</option>
          <option>Tayland</option><option>Tunus</option><option>TÃ¼rkiye</option><option>TÃ¼rkmenistan</option>
          <option>Ukrayna</option><option>Umman</option><option>ÃœrdÃ¼n</option><option>Venezuela</option><option>Vietnam</option>
          <option>Yemen</option><option>Yunanistan</option><option>Zambiya</option><option>Zimbabve</option>
        </select>
      </div>

      <!-- Ensar AlanlarÄ± -->
      <div id="ensarAlani" style="display:none">
        <label for="tc">TC Kimlik No</label>
        <input type="text" id="tc" data-field="tc" class="in" maxlength="11" placeholder="11 haneli"/>

        <label for="il">Memleket (Ä°l)</label>
        <select id="il" data-field="il">
          <option value="">SeÃ§iniz...</option>
          <!-- 81 Ä°L -->
          <option>Adana</option><option>AdÄ±yaman</option><option>Afyonkarahisar</option><option>AÄŸrÄ±</option>
          <option>Aksaray</option><option>Amasya</option><option>Ankara</option><option>Antalya</option>
          <option>Ardahan</option><option>Artvin</option><option>AydÄ±n</option><option>BalÄ±kesir</option>
          <option>BartÄ±n</option><option>Batman</option><option>Bayburt</option><option>Bilecik</option>
          <option>BingÃ¶l</option><option>Bitlis</option><option>Bolu</option><option>Burdur</option>
          <option>Bursa</option><option>Ã‡anakkale</option><option>Ã‡ankÄ±rÄ±</option><option>Ã‡orum</option>
          <option>Denizli</option><option>DiyarbakÄ±r</option><option>DÃ¼zce</option><option>Edirne</option>
          <option>ElazÄ±ÄŸ</option><option>Erzincan</option><option>Erzurum</option><option>EskiÅŸehir</option>
          <option>Gaziantep</option><option>Giresun</option><option>GÃ¼mÃ¼ÅŸhane</option><option>Hakkari</option>
          <option>Hatay</option><option>IÄŸdÄ±r</option><option>Isparta</option><option>Ä°stanbul</option>
          <option>Ä°zmir</option><option>KahramanmaraÅŸ</option><option>KarabÃ¼k</option><option>Karaman</option>
          <option>Kars</option><option>Kastamonu</option><option>Kayseri</option><option>KÄ±rÄ±kkale</option>
          <option>KÄ±rklareli</option><option>KÄ±rÅŸehir</option><option>Kilis</option><option>Kocaeli</option>
          <option>Konya</option><option>KÃ¼tahya</option><option>Malatya</option><option>Manisa</option>
          <option>Mardin</option><option>Mersin</option><option>MuÄŸla</option><option>MuÅŸ</option>
          <option>NevÅŸehir</option><option>NiÄŸde</option><option>Ordu</option><option>Osmaniye</option>
          <option>Rize</option><option>Sakarya</option><option>Samsun</option><option>Siirt</option>
          <option>Sinop</option><option>Sivas</option><option>ÅanlÄ±urfa</option><option>ÅÄ±rnak</option>
          <option>TekirdaÄŸ</option><option>Tokat</option><option>Trabzon</option><option>Tunceli</option>
          <option>UÅŸak</option><option>Van</option><option>Yalova</option><option>Yozgat</option><option>Zonguldak</option>
        </select>
      </div>

      <!-- TARÄ°H / MEZHEP / KAN GRUBU -->
      <label for="dogumTarihi">DoÄŸum Tarihi <span class="hint">* zorunlu</span></label>
      <input type="date" id="dogumTarihi" data-field="dogumTarihi" class="in"/>

      <label for="mezhep">Mezhebi <span class="hint">* zorunlu</span></label>
      <select id="mezhep" data-field="mezhep">
        <option value="">SeÃ§iniz...</option>
        <option>Hanefi</option><option>Åafi</option><option>Hanbeli</option><option>Maliki</option>
      </select>

      <label for="kanGrubu">Kan Grubu <span class="hint">(tercihe baÄŸlÄ±)</span></label>
      <select id="kanGrubu" data-field="kanGrubu">
        <option value="">Bilmiyorum</option>
        <option>A+</option><option>A-</option><option>B+</option><option>B-</option>
        <option>AB+</option><option>AB-</option><option>0+</option><option>0-</option>
      </select>
    </div>

    <div class="bar">
      <div id="adimBilgi" class="hint">AdÄ±m 1 / 6</div>
      <div class="actions">
        <button class="btn muted" id="btnSifirla" type="button">ğŸ§¹ SÄ±fÄ±rla</button>
        <button class="btn primary" id="btnIleri" onclick="ilerleAdim1()">Ä°lerle â–¶</button>
      </div>
    </div>

    <div id="toast" class="hint" style="margin-top:10px"></div>
  </div>
</div>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
<script src="../js/firebase/firebase-init.js"></script>

<script>
/* ===================================================
   AdÄ±m-1 (Ã–nizlemesiz) â€” UID, Storage upload, Firestore
   YapÄ±:
   Storage: talebe-fotolar/{uid}/profil.{ext}
   Firestore: talebeler/{devre}/Ã¶ÄŸrenciler/{uid}
              â””â”€ bilgiler/profil (dokÃ¼man)
=================================================== */
(function(){
  const DRAFT_KEY='talebeDraft_v1';
  const UID_KEY='talebeUID_v1';
  const DEVRE_KEY='talebeDevre_v1';

  const db = window.db || firebase.firestore();
  const storage = firebase.storage();
  const $ = s => document.querySelector(s);

  function getDraft(){ try{ return JSON.parse(localStorage.getItem(DRAFT_KEY)||'{}'); }catch(_){ return {}; } }
  function setDraft(o){ localStorage.setItem(DRAFT_KEY, JSON.stringify(o||{})); }
  function clearDraft(){ localStorage.removeItem(DRAFT_KEY); localStorage.removeItem(UID_KEY); }

  function getOrMakeUID(){
    let uid = localStorage.getItem(UID_KEY);
    if(!uid){ uid = (crypto.randomUUID?.() || ('u_'+Date.now())); localStorage.setItem(UID_KEY, uid); }
    return uid;
  }

  // alanlarÄ± taslaktan doldur
  const formEl = $('#adim1Form');
  (function restore(){
    const d=getDraft();
    formEl.querySelectorAll('[data-field]').forEach(el=>{
      const k=el.getAttribute('data-field');
      if(d[k]!=null) el.value=d[k];
    });
    if(d.devre) localStorage.setItem(DEVRE_KEY, d.devre);
    applyVisibility();
    updateFotoStatus();
  })();

  // autosave
  formEl.querySelectorAll('[data-field]').forEach(el=>{
    const key=el.getAttribute('data-field');
    ['input','change'].forEach(ev=> el.addEventListener(ev, ()=>{
      const d=getDraft(); d[key]=el.value; setDraft(d);
      if(key==='devre') localStorage.setItem(DEVRE_KEY, el.value||'');
      if(key==='durum' || key==='ikametDurumu') applyVisibility();
    }));
  });

  function applyVisibility(){
    const d = getDraft();
    const durum = d.durum || $('#durum').value || '';
    const ikamet = d.ikametDurumu || $('#ikametDurumu')?.value || '';
    $('#muhacirAlani').style.display = (durum==='Muhacir') ? 'block':'none';
    $('#ensarAlani').style.display   = (durum==='Ensar')   ? 'block':'none';
    $('#kimlikBitisDiv').style.display = (durum==='Muhacir' && ikamet==='Var') ? 'block':'none';
  }
  $('#durum').addEventListener('change', applyVisibility);
  $('#ikametDurumu')?.addEventListener('change', applyVisibility);

  // FOTO YÃœKLEME (Ã¶nizleme yok)
  async function uploadToStorage(file){
    const uid = getOrMakeUID();
    const ext = (file.name.split('.').pop()||'jpg').toLowerCase();
    const path = `talebe-fotolar/${uid}/profil.${ext}`;
    const ref = storage.ref().child(path);
    const snap = await ref.put(file);
    const url = await snap.ref.getDownloadURL();
    return { url, path };
  }

  function updateFotoStatus(){
    const st = $('#fotoDurum');
    const d = getDraft();
    if(d.fotoURL){
      st.textContent = 'FotoÄŸraf yÃ¼klendi.';
      st.className = 'status ok';
    }else{
      st.textContent = 'HenÃ¼z yÃ¼klenmedi.';
      st.className = 'status';
    }
  }

  $('#btnFotoYukle').addEventListener('click', async ()=>{
    const f = $('#fotoFile').files?.[0];
    if(!f){ return toast('LÃ¼tfen bir fotoÄŸraf seÃ§in.'); }
    try{
      const {url, path} = await uploadToStorage(f);
      const d=getDraft(); d.fotoURL=url; d.fotoPath=path; setDraft(d);
      updateFotoStatus();
      toast('FotoÄŸraf yÃ¼klendi.');
    }catch(e){
      console.error(e); toast('FotoÄŸraf yÃ¼klenemedi.');
    }
  });

  $('#btnFotoTemizle').addEventListener('click', async ()=>{
    const d=getDraft();
    if(d.fotoPath){
      try{ await storage.ref().child(d.fotoPath).delete(); }catch(e){}
    }
    delete d.fotoURL; delete d.fotoPath; setDraft(d);
    $('#fotoFile').value='';
    updateFotoStatus();
    toast('FotoÄŸraf temizlendi.');
  });

  // Firestore yardÄ±mcÄ±larÄ±
  function talebeKokRef(devre, uid){
    return db.collection('talebeler').doc(devre).collection('Ã¶ÄŸrenciler').doc(uid);
  }
  function talebeBilgiRef(devre, uid){
    return talebeKokRef(devre, uid).collection('bilgiler').doc('profil');
  }

  // Ä°LERLE
  const NEXT_URL = 'talebe-kayit-adim2.html';
  window.ilerleAdim1 = async function(){
    const d = getDraft();
    // Zorunlu alan kontrolÃ¼
    const required = {
      devre: 'DÃ¶nem (Devre)',
      fotoURL: 'FotoÄŸraf',
      kimlikAd: 'Kimlikteki Ad Soyad',
      kullAd: 'KullandÄ±ÄŸÄ± Ad Soyad',
      kurs: 'GeldiÄŸi Kurs',
      durum: 'Muhacir/Ensar',
      dogumTarihi: 'DoÄŸum Tarihi',
      mezhep: 'Mezhep'
      // kanGrubu zorunlu deÄŸil
    };
    const eksikler = Object.keys(required).filter(k=>!d[k] || String(d[k]).trim()==='');
    if(eksikler.length){
      const ilk = required[eksikler[0]];
      toast(`LÃ¼tfen zorunlu alanÄ± doldurun: ${ilk}`);
      return;
    }

    const uid = getOrMakeUID();
    const devre = d.devre || localStorage.getItem(DEVRE_KEY) || 'Genel';
    localStorage.setItem(DEVRE_KEY, devre);

    const profil = {
      uid, devre,
      kimlikAd: d.kimlikAd || '',
      kullAd: d.kullAd || '',
      kurs: d.kurs || '',
      durum: d.durum || '',
      ikametDurumu: d.ikametDurumu || '',
      kimlikBitis: d.kimlikBitis || '',
      ulke: d.ulke || '',
      tc: d.tc || '',
      il: d.il || '',
      dogumTarihi: d.dogumTarihi || '',
      mezhep: d.mezhep || '',
      kanGrubu: d.kanGrubu || '',  // opsiyonel
      fotoURL: d.fotoURL || '',
      fotoPath: d.fotoPath || '',
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    try{
      await talebeKokRef(devre, uid).set({
        uid, devre,
        kimlikAd: profil.kimlikAd,
        kullAd: profil.kullAd,
        kurs: profil.kurs,
        durum: profil.durum,
        fotoURL: profil.fotoURL || '',
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge:true });

      await talebeBilgiRef(devre, uid).set(profil, { merge:true });

      toast('Kaydedildi. AdÄ±m 2â€™ye geÃ§iliyor...');
      location.href = NEXT_URL;
    }catch(e){
      console.error(e);
      toast('KayÄ±t sÄ±rasÄ±nda bir hata oluÅŸtu.');
    }
  };

  function toast(m){
    const t = $('#toast'); if(!t) return alert(m);
    t.textContent = m; t.style.opacity=1;
    clearTimeout(window.__tto);
    window.__tto = setTimeout(()=>{ t.style.opacity=.0 }, 1800);
  }

  // SIFIRLA
  $('#btnSifirla').addEventListener('click', async ()=>{
    if(!confirm('Bu adÄ±mÄ±n taslak verileri silinsin mi?')) return;
    const d=getDraft();
    if(d.fotoPath){ try{ await storage.ref().child(d.fotoPath).delete(); }catch(e){} }
    clearDraft();
    formEl.querySelectorAll('[data-field]').forEach(el=> el.value='');
    $('#fotoFile').value='';
    updateFotoStatus();
    applyVisibility();
    toast('Temizlendi.');
  });
})();
</script>
</body>
</html>
