<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Yeni Talebe Kaydı — Adım 1</title>
  <link rel="stylesheet" href="../css/form.css"/>
  <style>
    :root{ --gap:12px; --radius:12px; --stroke:#e5e7eb }
    *{ box-sizing:border-box }
    html,body{ height:100% }
    body{ margin:0 }
    .wrap{ max-width:980px; margin:16px auto; padding:16px }
    .card{ background:#fff; border:1px solid var(--stroke); border-radius:var(--radius); padding:16px }
    @media (prefers-color-scheme:dark){
      .card{ background:#0f172a; border-color:#223046; color:#e5e7eb }
    }

    .head h2{ margin:0 0 6px }
    .grid{ display:grid; gap:var(--gap) }
    .grid label{ font-weight:600 }
    .in, select{ width:100%; padding:12px; border-radius:10px; border:1px solid var(--stroke) }
    @media (prefers-color-scheme:dark){
      .in, select{ background:#0b1624; color:#e5e7eb; border-color:#223046 }
    }

    .row{ display:flex; gap:10px; flex-wrap:wrap }
    .btn{ padding:10px 14px; border-radius:10px; border:1px solid #d1d5db; background:#f3f4f6; font-weight:700; cursor:pointer }
    .btn.primary{ background:#10b981; border-color:#10b981; color:#fff }
    .btn.muted{ background:#6b7280; border-color:#6b7280; color:#fff }
    .bar{ display:flex; justify-content:space-between; align-items:center; gap:10px; margin-top:14px; flex-wrap:wrap }

    .hint{ font-size:12px; opacity:.8 }
    .status{ font-size:12px; }
    .status.ok{ color:#10b981 }
    .status.err{ color:#ef4444 }

    /* Mobil taşma önleme */
    .head p, .status, .hint{ word-break:break-word }
    .actions{ display:flex; gap:8px; flex-wrap:wrap }

    @media (max-width:720px){
      .wrap{ padding:12px }
      .row > *{ flex:1 1 100% }
    }
  </style>
</head>
<body>

<div class="wrap">
  <div class="card">
    <div class="head">
      <h2>📝 Yeni Talebe Kaydı</h2>
      <p>Adım 1 — Talebe Bilgileri</p>
    </div>

    <div class="grid" id="adim1Form">
      <!-- DEVRE -->
      <label for="devre">Dönem (Devre) <span class="hint">* zorunlu</span></label>
      <select id="devre" data-field="devre" required>
        <option value="">Seçiniz...</option>
        <option>5.Devre</option><option>6.Devre</option><option>7.Devre</option><option>8.Devre</option>
      </select>

      <!-- FOTOĞRAF (ÖNİZLEME YOK) -->
      <label for="fotoFile">Fotoğraf <span class="hint">* zorunlu — yükleyip onaylayın</span></label>
      <div class="row">
        <input type="file" id="fotoFile" accept="image/*" class="in" style="max-width:420px"/>
        <div class="actions">
          <button type="button" class="btn primary" id="btnFotoYukle">Yükle</button>
          <button type="button" class="btn" id="btnFotoTemizle">Temizle</button>
        </div>
      </div>
      <div id="fotoDurum" class="status">Henüz yüklenmedi.</div>

      <!-- İSİMLER -->
      <label for="kimlikAd">Kimlikteki Adı Soyadı <span class="hint">* zorunlu</span></label>
      <input type="text" id="kimlikAd" data-field="kimlikAd" class="in" placeholder="Örn: MEHMET YILMAZ"/>

      <label for="kullAd">Kullandığı Adı Soyadı <span class="hint">* zorunlu</span></label>
      <input type="text" id="kullAd" data-field="kullAd" class="in" placeholder="Örn: Mehmet Yılmaz"/>

      <!-- KURS -->
      <label for="kurs">Geldiği Kurs <span class="hint">* zorunlu</span></label>
      <select id="kurs" data-field="kurs">
        <option value="">Seçiniz...</option>
        <option>Atışalanı Birlik</option><option>Boğazköy</option><option>Esenyurt</option><option>Florya</option>
        <option>Güneşli Ferah</option><option>Gürcistan Ofis</option><option>Güven Proje</option><option>Kabakça</option>
        <option>Yavuz Selim</option><option>Yusuf Aydın</option>
      </select>

      <!-- DURUM -->
      <label for="durum">Durum (Muhacir / Ensar) <span class="hint">* zorunlu</span></label>
      <select id="durum" data-field="durum">
        <option value="">Seçiniz...</option>
        <option>Muhacir</option>
        <option>Ensar</option>
      </select>

      <!-- Muhacir Alanları -->
      <div id="muhacirAlani" style="display:none">
        <label for="ikametDurumu">İkameti Var mı?</label>
        <select id="ikametDurumu" data-field="ikametDurumu">
          <option value="">Seçiniz...</option>
          <option>Var</option><option>Yok</option>
        </select>

        <div id="kimlikBitisDiv" style="display:none">
          <label for="kimlikBitis">Kimlik Bitiş Tarihi</label>
          <input type="date" id="kimlikBitis" data-field="kimlikBitis" class="in"/>
        </div>

        <label for="ulke">Memleket (Ülke)</label>
        <select id="ulke" data-field="ulke">
          <option value="">Bir ülke seçiniz...</option>
          <!-- KISA GÖVDE: Tam listeyi kullanıyoruz -->
          <option>Afganistan</option><option>Almanya</option><option>Amerika Birleşik Devletleri</option>
          <option>Arnavutluk</option><option>Avusturya</option><option>Azerbaycan</option><option>Bangladeş</option>
          <option>Belçika</option><option>Birleşik Arap Emirlikleri</option><option>Birleşik Krallık</option>
          <option>Bosna-Hersek</option><option>Brezilya</option><option>Bulgaristan</option><option>Cezayir</option>
          <option>Çad</option><option>Çekya</option><option>Çin</option><option>Danimarka</option><option>Endonezya</option>
          <option>Etiyopya</option><option>Fas</option><option>Filistin</option><option>Fransa</option><option>Gana</option>
          <option>Gürcistan</option><option>Hindistan</option><option>Hollanda</option><option>Irak</option><option>İran</option>
          <option>İspanya</option><option>İsrail</option><option>İsveç</option><option>İsviçre</option><option>İtalya</option>
          <option>Japonya</option><option>Kazakistan</option><option>Kırgızistan</option><option>Kenya</option><option>Kuveyt</option>
          <option>Lübnan</option><option>Macaristan</option><option>Mısır</option><option>Morocco</option>
          <option>Nijer</option><option>Nijerya</option><option>Özbekistan</option><option>Pakistan</option>
          <option>Romanya</option><option>Rusya</option><option>Senegal</option><option>Somali</option><option>Sudan</option>
          <option>Suriye</option><option>Suudi Arabistan</option><option>Tacikistan</option><option>Tanzanya</option>
          <option>Tayland</option><option>Tunus</option><option>Türkiye</option><option>Türkmenistan</option>
          <option>Ukrayna</option><option>Umman</option><option>Ürdün</option><option>Venezuela</option><option>Vietnam</option>
          <option>Yemen</option><option>Yunanistan</option><option>Zambiya</option><option>Zimbabve</option>
        </select>
      </div>

      <!-- Ensar Alanları -->
      <div id="ensarAlani" style="display:none">
        <label for="tc">TC Kimlik No</label>
        <input type="text" id="tc" data-field="tc" class="in" maxlength="11" placeholder="11 haneli"/>

        <label for="il">Memleket (İl)</label>
        <select id="il" data-field="il">
          <option value="">Seçiniz...</option>
          <!-- 81 İL -->
          <option>Adana</option><option>Adıyaman</option><option>Afyonkarahisar</option><option>Ağrı</option>
          <option>Aksaray</option><option>Amasya</option><option>Ankara</option><option>Antalya</option>
          <option>Ardahan</option><option>Artvin</option><option>Aydın</option><option>Balıkesir</option>
          <option>Bartın</option><option>Batman</option><option>Bayburt</option><option>Bilecik</option>
          <option>Bingöl</option><option>Bitlis</option><option>Bolu</option><option>Burdur</option>
          <option>Bursa</option><option>Çanakkale</option><option>Çankırı</option><option>Çorum</option>
          <option>Denizli</option><option>Diyarbakır</option><option>Düzce</option><option>Edirne</option>
          <option>Elazığ</option><option>Erzincan</option><option>Erzurum</option><option>Eskişehir</option>
          <option>Gaziantep</option><option>Giresun</option><option>Gümüşhane</option><option>Hakkari</option>
          <option>Hatay</option><option>Iğdır</option><option>Isparta</option><option>İstanbul</option>
          <option>İzmir</option><option>Kahramanmaraş</option><option>Karabük</option><option>Karaman</option>
          <option>Kars</option><option>Kastamonu</option><option>Kayseri</option><option>Kırıkkale</option>
          <option>Kırklareli</option><option>Kırşehir</option><option>Kilis</option><option>Kocaeli</option>
          <option>Konya</option><option>Kütahya</option><option>Malatya</option><option>Manisa</option>
          <option>Mardin</option><option>Mersin</option><option>Muğla</option><option>Muş</option>
          <option>Nevşehir</option><option>Niğde</option><option>Ordu</option><option>Osmaniye</option>
          <option>Rize</option><option>Sakarya</option><option>Samsun</option><option>Siirt</option>
          <option>Sinop</option><option>Sivas</option><option>Şanlıurfa</option><option>Şırnak</option>
          <option>Tekirdağ</option><option>Tokat</option><option>Trabzon</option><option>Tunceli</option>
          <option>Uşak</option><option>Van</option><option>Yalova</option><option>Yozgat</option><option>Zonguldak</option>
        </select>
      </div>

      <!-- TARİH / MEZHEP / KAN GRUBU -->
      <label for="dogumTarihi">Doğum Tarihi <span class="hint">* zorunlu</span></label>
      <input type="date" id="dogumTarihi" data-field="dogumTarihi" class="in"/>

      <label for="mezhep">Mezhebi <span class="hint">* zorunlu</span></label>
      <select id="mezhep" data-field="mezhep">
        <option value="">Seçiniz...</option>
        <option>Hanefi</option><option>Şafi</option><option>Hanbeli</option><option>Maliki</option>
      </select>

      <label for="kanGrubu">Kan Grubu <span class="hint">(tercihe bağlı)</span></label>
      <select id="kanGrubu" data-field="kanGrubu">
        <option value="">Bilmiyorum</option>
        <option>A+</option><option>A-</option><option>B+</option><option>B-</option>
        <option>AB+</option><option>AB-</option><option>0+</option><option>0-</option>
      </select>
    </div>

    <div class="bar">
      <div id="adimBilgi" class="hint">Adım 1 / 6</div>
      <div class="actions">
        <button class="btn muted" id="btnSifirla" type="button">🧹 Sıfırla</button>
        <button class="btn primary" id="btnIleri" onclick="ilerleAdim1()">İlerle ▶</button>
      </div>
    </div>

    <div id="toast" class="hint" style="margin-top:10px"></div>
  </div>
</div>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
<script src="../js/firebase/firebase-init.js"></script>

<script>
/* ===================================================
   Adım-1 (Önizlemesiz) — UID, Storage upload, Firestore
   Yapı:
   Storage: talebe-fotolar/{uid}/profil.{ext}
   Firestore: talebeler/{devre}/öğrenciler/{uid}
              └─ bilgiler/profil (doküman)
=================================================== */
(function(){
  const DRAFT_KEY='talebeDraft_v1';
  const UID_KEY='talebeUID_v1';
  const DEVRE_KEY='talebeDevre_v1';

  const db = window.db || firebase.firestore();
  const storage = firebase.storage();
  const $ = s => document.querySelector(s);

  function getDraft(){ try{ return JSON.parse(localStorage.getItem(DRAFT_KEY)||'{}'); }catch(_){ return {}; } }
  function setDraft(o){ localStorage.setItem(DRAFT_KEY, JSON.stringify(o||{})); }
  function clearDraft(){ localStorage.removeItem(DRAFT_KEY); localStorage.removeItem(UID_KEY); }

  function getOrMakeUID(){
    let uid = localStorage.getItem(UID_KEY);
    if(!uid){ uid = (crypto.randomUUID?.() || ('u_'+Date.now())); localStorage.setItem(UID_KEY, uid); }
    return uid;
  }

  // alanları taslaktan doldur
  const formEl = $('#adim1Form');
  (function restore(){
    const d=getDraft();
    formEl.querySelectorAll('[data-field]').forEach(el=>{
      const k=el.getAttribute('data-field');
      if(d[k]!=null) el.value=d[k];
    });
    if(d.devre) localStorage.setItem(DEVRE_KEY, d.devre);
    applyVisibility();
    updateFotoStatus();
  })();

  // autosave
  formEl.querySelectorAll('[data-field]').forEach(el=>{
    const key=el.getAttribute('data-field');
    ['input','change'].forEach(ev=> el.addEventListener(ev, ()=>{
      const d=getDraft(); d[key]=el.value; setDraft(d);
      if(key==='devre') localStorage.setItem(DEVRE_KEY, el.value||'');
      if(key==='durum' || key==='ikametDurumu') applyVisibility();
    }));
  });

  function applyVisibility(){
    const d = getDraft();
    const durum = d.durum || $('#durum').value || '';
    const ikamet = d.ikametDurumu || $('#ikametDurumu')?.value || '';
    $('#muhacirAlani').style.display = (durum==='Muhacir') ? 'block':'none';
    $('#ensarAlani').style.display   = (durum==='Ensar')   ? 'block':'none';
    $('#kimlikBitisDiv').style.display = (durum==='Muhacir' && ikamet==='Var') ? 'block':'none';
  }
  $('#durum').addEventListener('change', applyVisibility);
  $('#ikametDurumu')?.addEventListener('change', applyVisibility);

  // FOTO YÜKLEME (önizleme yok)
  async function uploadToStorage(file){
    const uid = getOrMakeUID();
    const ext = (file.name.split('.').pop()||'jpg').toLowerCase();
    const path = `talebe-fotolar/${uid}/profil.${ext}`;
    const ref = storage.ref().child(path);
    const snap = await ref.put(file);
    const url = await snap.ref.getDownloadURL();
    return { url, path };
  }

  function updateFotoStatus(){
    const st = $('#fotoDurum');
    const d = getDraft();
    if(d.fotoURL){
      st.textContent = 'Fotoğraf yüklendi.';
      st.className = 'status ok';
    }else{
      st.textContent = 'Henüz yüklenmedi.';
      st.className = 'status';
    }
  }

  $('#btnFotoYukle').addEventListener('click', async ()=>{
    const f = $('#fotoFile').files?.[0];
    if(!f){ return toast('Lütfen bir fotoğraf seçin.'); }
    try{
      const {url, path} = await uploadToStorage(f);
      const d=getDraft(); d.fotoURL=url; d.fotoPath=path; setDraft(d);
      updateFotoStatus();
      toast('Fotoğraf yüklendi.');
    }catch(e){
      console.error(e); toast('Fotoğraf yüklenemedi.');
    }
  });

  $('#btnFotoTemizle').addEventListener('click', async ()=>{
    const d=getDraft();
    if(d.fotoPath){
      try{ await storage.ref().child(d.fotoPath).delete(); }catch(e){}
    }
    delete d.fotoURL; delete d.fotoPath; setDraft(d);
    $('#fotoFile').value='';
    updateFotoStatus();
    toast('Fotoğraf temizlendi.');
  });

  // Firestore yardımcıları
  function talebeKokRef(devre, uid){
    return db.collection('talebeler').doc(devre).collection('öğrenciler').doc(uid);
  }
  function talebeBilgiRef(devre, uid){
    return talebeKokRef(devre, uid).collection('bilgiler').doc('profil');
  }

  // İLERLE
  const NEXT_URL = 'talebe-kayit-adim2.html';
  window.ilerleAdim1 = async function(){
    const d = getDraft();
    // Zorunlu alan kontrolü
    const required = {
      devre: 'Dönem (Devre)',
      fotoURL: 'Fotoğraf',
      kimlikAd: 'Kimlikteki Ad Soyad',
      kullAd: 'Kullandığı Ad Soyad',
      kurs: 'Geldiği Kurs',
      durum: 'Muhacir/Ensar',
      dogumTarihi: 'Doğum Tarihi',
      mezhep: 'Mezhep'
      // kanGrubu zorunlu değil
    };
    const eksikler = Object.keys(required).filter(k=>!d[k] || String(d[k]).trim()==='');
    if(eksikler.length){
      const ilk = required[eksikler[0]];
      toast(`Lütfen zorunlu alanı doldurun: ${ilk}`);
      return;
    }

    const uid = getOrMakeUID();
    const devre = d.devre || localStorage.getItem(DEVRE_KEY) || 'Genel';
    localStorage.setItem(DEVRE_KEY, devre);

    const profil = {
      uid, devre,
      kimlikAd: d.kimlikAd || '',
      kullAd: d.kullAd || '',
      kurs: d.kurs || '',
      durum: d.durum || '',
      ikametDurumu: d.ikametDurumu || '',
      kimlikBitis: d.kimlikBitis || '',
      ulke: d.ulke || '',
      tc: d.tc || '',
      il: d.il || '',
      dogumTarihi: d.dogumTarihi || '',
      mezhep: d.mezhep || '',
      kanGrubu: d.kanGrubu || '',  // opsiyonel
      fotoURL: d.fotoURL || '',
      fotoPath: d.fotoPath || '',
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    };

    try{
      await talebeKokRef(devre, uid).set({
        uid, devre,
        kimlikAd: profil.kimlikAd,
        kullAd: profil.kullAd,
        kurs: profil.kurs,
        durum: profil.durum,
        fotoURL: profil.fotoURL || '',
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      }, { merge:true });

      await talebeBilgiRef(devre, uid).set(profil, { merge:true });

      toast('Kaydedildi. Adım 2’ye geçiliyor...');
      location.href = NEXT_URL;
    }catch(e){
      console.error(e);
      toast('Kayıt sırasında bir hata oluştu.');
    }
  };

  function toast(m){
    const t = $('#toast'); if(!t) return alert(m);
    t.textContent = m; t.style.opacity=1;
    clearTimeout(window.__tto);
    window.__tto = setTimeout(()=>{ t.style.opacity=.0 }, 1800);
  }

  // SIFIRLA
  $('#btnSifirla').addEventListener('click', async ()=>{
    if(!confirm('Bu adımın taslak verileri silinsin mi?')) return;
    const d=getDraft();
    if(d.fotoPath){ try{ await storage.ref().child(d.fotoPath).delete(); }catch(e){} }
    clearDraft();
    formEl.querySelectorAll('[data-field]').forEach(el=> el.value='');
    $('#fotoFile').value='';
    updateFotoStatus();
    applyVisibility();
    toast('Temizlendi.');
  });
})();
</script>
</body>
</html>
