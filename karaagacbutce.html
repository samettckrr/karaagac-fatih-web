<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Karaaƒüa√ß B√ºt√ße Analizi</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" href="./img/logo.png" />
  
  <!-- SheetJS for Excel reading -->
  <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
  <!-- Chart.js for graphs -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  
  <style>
    /* ===================== THEME VARIABLES ===================== */
    :root {
      --radius: 14px;
      --shadow: 0 12px 28px rgba(0,0,0,.14);
      --bg: #0f172a;
      --bg2: #0b1324;
      --grad1: #0ea5e922;
      --grad2: #22d3ee22;
      --card: rgba(15,23,42,.92);
      --stroke: rgba(148,163,184,.18);
      --text: #e5e7eb;
      --muted: #9aa4b2;
      --brand: #38bdf8;
      --brand2: #0ea5e9;
      --pill: #0b1220;
      --pill-hover: #101a2b;
      --link: #c7e9ff;
      --surface: rgba(2,6,23,.08);
      --danger: #ef4444;
      --success: #22c55e;
      --warn: #f59e0b;
      --info: #3b82f6;
    }

    @media (prefers-color-scheme: light) {
      :root {
        --bg: #f5f5f0;
        --bg2: #fafaf5;
        --grad1: #e5e5e022;
        --grad2: #d4d4d022;
        --card: rgba(255,255,255,.95);
        --stroke: rgba(15,23,42,.12);
        --text: #0b1220;
        --muted: #4b5563;
        --brand: #0ea5e9;
        --brand2: #0284c7;
        --pill: #f5f5f0;
        --pill-hover: #e9e9e4;
        --link: #0b5ea8;
        --surface: #f0f0eb;
        --danger: #b91c1c;
        --success: #16a34a;
        --warn: #d97706;
        --info: #2563eb;
      }
    }

    html[data-theme="dark"] {
      --bg: #0f172a;
      --bg2: #0b1324;
      --grad1: #0ea5e922;
      --grad2: #22d3ee22;
      --card: rgba(15,23,42,.92);
      --stroke: rgba(148,163,184,.18);
      --text: #e5e7eb;
      --muted: #9aa4b2;
      --brand: #38bdf8;
      --brand2: #0ea5e9;
      --pill: #0b1220;
      --pill-hover: #101a2b;
      --link: #c7e9ff;
      --surface: rgba(2,6,23,.08);
      --danger: #ef4444;
      --success: #22c55e;
      --warn: #f59e0b;
      --info: #3b82f6;
    }

    html[data-theme="light"] {
      --bg: #f5f5f0;
      --bg2: #fafaf5;
      --grad1: #e5e5e022;
      --grad2: #d4d4d022;
      --card: rgba(255,255,255,.95);
      --stroke: rgba(15,23,42,.12);
      --text: #0b1220;
      --muted: #4b5563;
      --brand: #0ea5e9;
      --brand2: #0284c7;
      --pill: #f5f5f0;
      --pill-hover: #e9e9e4;
      --link: #0b5ea8;
      --surface: #f0f0eb;
      --danger: #b91c1c;
      --success: #16a34a;
      --warn: #d97706;
      --info: #2563eb;
    }

    /* ===================== BASE STYLES ===================== */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    html, body {
      height: 100%;
    }

    body {
      font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      color: var(--text);
      background: var(--bg);
      line-height: 1.6;
      overflow-x: hidden;
    }

    /* ===================== HEADER ===================== */
    .header {
      background: var(--card);
      border-bottom: 1px solid var(--stroke);
      padding: 20px;
      position: sticky;
      top: 0;
      z-index: 50;
      box-shadow: var(--shadow);
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 20px;
    }

    .header h1 {
      font-size: 24px;
      font-weight: 800;
      background: linear-gradient(135deg, var(--brand), var(--brand2));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      margin: 0;
    }

    .theme-toggle {
      background: var(--pill);
      border: 1px solid var(--stroke);
      color: var(--text);
      padding: 8px 16px;
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 14px;
      transition: all 0.2s;
    }

    .theme-toggle:hover {
      background: var(--pill-hover);
    }

    /* ===================== CONTAINER ===================== */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    /* ===================== CARDS ===================== */
    .card {
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      padding: 24px;
      box-shadow: var(--shadow);
      margin-bottom: 20px;
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, var(--brand), var(--brand2));
      opacity: 0;
      transition: opacity 0.3s;
    }

    .card:hover::before {
      opacity: 1;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 12px;
    }

    .card-title {
      font-size: 20px;
      font-weight: 700;
      color: var(--text);
      margin: 0;
    }

    /* ===================== BUTTONS ===================== */
    .btn {
      background: var(--brand);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: var(--radius);
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn:hover {
      background: var(--brand2);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      background: var(--pill);
      color: var(--text);
    }

    .btn-secondary:hover {
      background: var(--pill-hover);
    }

    .btn-success {
      background: var(--success);
    }

    .btn-success:hover {
      background: #16a34a;
    }

    .btn-danger {
      background: var(--danger);
    }

    .btn-danger:hover {
      background: #dc2626;
    }

    /* ===================== FILE INPUT ===================== */
    .file-input-wrapper {
      position: relative;
      display: inline-block;
      width: 100%;
    }

    .file-input {
      width: 100%;
      padding: 12px;
      border: 2px dashed var(--stroke);
      border-radius: var(--radius);
      background: var(--surface);
      color: var(--text);
      font-size: 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .file-input:hover {
      border-color: var(--brand);
      background: var(--card);
    }

    .file-input:focus {
      outline: none;
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
    }

    /* ===================== KPI CARDS ===================== */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }

    .kpi-card {
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      padding: 20px;
      position: relative;
      overflow: hidden;
    }

    .kpi-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--brand), var(--brand2));
    }

    .kpi-card.gelir::before {
      background: linear-gradient(90deg, var(--success), #16a34a);
    }

    .kpi-card.gider::before {
      background: linear-gradient(90deg, var(--danger), #dc2626);
    }

    .kpi-card.net::before {
      background: linear-gradient(90deg, var(--info), #2563eb);
    }

    .kpi-label {
      font-size: 12px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .kpi-value {
      font-size: 32px;
      font-weight: 800;
      color: var(--text);
      margin-bottom: 4px;
    }

    .kpi-year {
      font-size: 11px;
      color: var(--muted);
      margin-top: 8px;
    }

    .kpi-change {
      font-size: 13px;
      display: flex;
      align-items: center;
      gap: 4px;
      margin-top: 8px;
    }

    .kpi-change.positive {
      color: var(--success);
    }

    .kpi-change.negative {
      color: var(--danger);
    }

    /* ===================== CHARTS ===================== */
    .charts-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .chart-container {
      position: relative;
      height: 350px;
      padding: 16px;
    }

    /* ===================== TABLE ===================== */
    .table-wrapper {
      overflow-x: auto;
      margin-top: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    thead {
      background: var(--surface);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    th {
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: var(--text);
      border-bottom: 2px solid var(--stroke);
      white-space: nowrap;
      cursor: pointer;
      user-select: none;
    }

    th:hover {
      background: var(--pill-hover);
    }

    th.sortable::after {
      content: ' ‚Üï';
      opacity: 0.5;
      font-size: 10px;
    }

    th.sort-asc::after {
      content: ' ‚Üë';
      opacity: 1;
    }

    th.sort-desc::after {
      content: ' ‚Üì';
      opacity: 1;
    }

    td {
      padding: 10px 12px;
      border-bottom: 1px solid var(--stroke);
      color: var(--text);
    }

    tbody tr:hover {
      background: var(--surface);
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    .number-cell {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    .positive {
      color: var(--success);
    }

    .negative {
      color: var(--danger);
    }

    /* ===================== SEARCH/FILTER ===================== */
    .search-box {
      width: 100%;
      padding: 10px 16px;
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      background: var(--surface);
      color: var(--text);
      font-size: 14px;
      margin-bottom: 16px;
    }

    .search-box:focus {
      outline: none;
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
    }

    /* ===================== LOADING ===================== */
    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid var(--stroke);
      border-top-color: var(--brand);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ===================== TOAST ===================== */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .toast {
      background: var(--card);
      border: 1px solid var(--stroke);
      border-radius: var(--radius);
      padding: 16px 20px;
      box-shadow: var(--shadow);
      min-width: 300px;
      max-width: 400px;
      animation: slideIn 0.3s ease;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .toast.success {
      border-left: 4px solid var(--success);
    }

    .toast.error {
      border-left: 4px solid var(--danger);
    }

    .toast.warning {
      border-left: 4px solid var(--warn);
    }

    .toast.info {
      border-left: 4px solid var(--info);
    }

    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .toast-message {
      flex: 1;
      color: var(--text);
      font-size: 14px;
    }

    .toast-close {
      background: none;
      border: none;
      color: var(--muted);
      cursor: pointer;
      font-size: 18px;
      padding: 0;
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .toast-close:hover {
      color: var(--text);
    }

    /* ===================== EMPTY STATE ===================== */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--muted);
    }

    .empty-state-icon {
      font-size: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-state-text {
      font-size: 16px;
    }

    /* ===================== RESPONSIVE ===================== */
    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        align-items: flex-start;
      }

      .kpi-grid {
        grid-template-columns: 1fr;
      }

      .charts-grid {
        grid-template-columns: 1fr;
      }

      .container {
        padding: 16px;
      }

      .card {
        padding: 16px;
      }

      .chart-container {
        height: 280px;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-content">
      <h1>üìä Karaaƒüa√ß B√ºt√ße Analizi</h1>
      <button class="theme-toggle" id="themeToggle">üåì Tema</button>
    </div>
  </header>

  <!-- Main Container -->
  <div class="container">
    <!-- File Upload Cards -->
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 20px;">
      <!-- Gelir Upload -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title" style="color: var(--success);">üí∞ Gelir Dosyasƒ±</h2>
        </div>
        <div class="file-input-wrapper">
          <input type="file" id="gelirFile" class="file-input" accept=".xlsx,.xls,.xlsm,.csv" />
        </div>
        <div style="margin-top: 16px; display: flex; gap: 12px; flex-wrap: wrap;">
          <button class="btn btn-success" id="btnReadGelir">
            <span>üìÅ</span>
            <span>Gelir Dosyasƒ±nƒ± Oku</span>
          </button>
          <button class="btn btn-secondary" id="btnClearGelir" style="display: none;">
            <span>üóëÔ∏è</span>
            <span>Temizle</span>
          </button>
        </div>
        <div id="gelirInfo" style="margin-top: 16px; color: var(--muted); font-size: 14px;"></div>
      </div>

      <!-- Gider Upload -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title" style="color: var(--danger);">üí∏ Gider Dosyasƒ±</h2>
        </div>
        <div class="file-input-wrapper">
          <input type="file" id="giderFile" class="file-input" accept=".xlsx,.xls,.xlsm,.csv" />
        </div>
        <div style="margin-top: 16px; display: flex; gap: 12px; flex-wrap: wrap;">
          <button class="btn btn-danger" id="btnReadGider">
            <span>üìÅ</span>
            <span>Gider Dosyasƒ±nƒ± Oku</span>
          </button>
          <button class="btn btn-secondary" id="btnClearGider" style="display: none;">
            <span>üóëÔ∏è</span>
            <span>Temizle</span>
          </button>
        </div>
        <div id="giderInfo" style="margin-top: 16px; color: var(--muted); font-size: 14px;"></div>
      </div>
    </div>

    <!-- KPI Dashboard -->
    <div class="card" id="kpiCard" style="display: none;">
      <div class="card-header">
        <h2 class="card-title">üìà √ñzet Dashboard</h2>
      </div>
      <div class="kpi-grid" id="kpiGrid"></div>
    </div>

    <!-- Charts Section -->
    <div class="card" id="chartsCard" style="display: none;">
      <div class="card-header">
        <h2 class="card-title">üìä Grafikler</h2>
      </div>
      <div class="charts-grid">
        <div class="card">
          <h3 style="margin-bottom: 16px; font-size: 16px;">Yƒ±llar Arasƒ± Kar≈üƒ±la≈ütƒ±rma</h3>
          <div class="chart-container">
            <canvas id="chartYears"></canvas>
          </div>
        </div>
        <div class="card">
          <h3 style="margin-bottom: 16px; font-size: 16px;">2024 Kategori Daƒüƒ±lƒ±mƒ± (Gelir)</h3>
          <div class="chart-container">
            <canvas id="chartGelir2024"></canvas>
          </div>
        </div>
        <div class="card">
          <h3 style="margin-bottom: 16px; font-size: 16px;">2024 Kategori Daƒüƒ±lƒ±mƒ± (Gider)</h3>
          <div class="chart-container">
            <canvas id="chartGider2024"></canvas>
          </div>
        </div>
        <div class="card">
          <h3 style="margin-bottom: 16px; font-size: 16px;">En Y√ºksek Kalemler (2024)</h3>
          <div class="chart-container">
            <canvas id="chartTopItems"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Gelir Table -->
    <div class="card" id="gelirTableCard" style="display: none;">
      <div class="card-header">
        <h2 class="card-title" style="color: var(--success);">üí∞ Gelir Detaylarƒ±</h2>
        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
          <input type="text" class="search-box" id="gelirSearch" placeholder="Kalem ara..." style="max-width: 300px;" />
          <button class="btn btn-secondary" id="btnExportGelirJSON">JSON</button>
          <button class="btn btn-secondary" id="btnExportGelirCSV">CSV</button>
        </div>
      </div>
      <div class="table-wrapper">
        <table id="gelirTable">
          <thead id="gelirTableHead"></thead>
          <tbody id="gelirTableBody"></tbody>
        </table>
      </div>
    </div>

    <!-- Gider Table -->
    <div class="card" id="giderTableCard" style="display: none;">
      <div class="card-header">
        <h2 class="card-title" style="color: var(--danger);">üí∏ Gider Detaylarƒ±</h2>
        <div style="display: flex; gap: 8px; flex-wrap: wrap;">
          <input type="text" class="search-box" id="giderSearch" placeholder="Kalem ara..." style="max-width: 300px;" />
          <button class="btn btn-secondary" id="btnExportGiderJSON">JSON</button>
          <button class="btn btn-secondary" id="btnExportGiderCSV">CSV</button>
        </div>
      </div>
      <div class="table-wrapper">
        <table id="giderTable">
          <thead id="giderTableHead"></thead>
          <tbody id="giderTableBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <script>
    // ===================== THEME TOGGLE =====================
    const themeToggle = document.getElementById('themeToggle');
    const currentTheme = localStorage.getItem('theme') || 'auto';
    
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
    }

    setTheme(currentTheme);

    themeToggle.addEventListener('click', () => {
      const current = document.documentElement.getAttribute('data-theme');
      const next = current === 'dark' ? 'light' : current === 'light' ? 'auto' : 'dark';
      setTheme(next);
      const icons = { dark: 'üåô', light: '‚òÄÔ∏è', auto: 'üåì' };
      themeToggle.textContent = `${icons[next]} Tema`;
    });

    // ===================== TOAST SYSTEM =====================
    function showToast(type, message) {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      
      const icons = {
        success: '‚úÖ',
        error: '‚ùå',
        warning: '‚ö†Ô∏è',
        info: '‚ÑπÔ∏è'
      };

      toast.innerHTML = `
        <span>${icons[type] || '‚ÑπÔ∏è'}</span>
        <div class="toast-message">${escapeHtml(message)}</div>
        <button class="toast-close" onclick="this.parentElement.remove()">√ó</button>
      `;

      container.appendChild(toast);

      setTimeout(() => {
        if (toast.parentElement) {
          toast.remove();
        }
      }, 5000);
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // ===================== CSV PARSING =====================
    function parseCSV(text) {
      const lines = text.split('\n').filter(line => line.trim());
      if (lines.length === 0) return { data: [], headers: [] };

      const headers = lines[0].split(',').map(h => h.trim());
      const data = [];

      for (let i = 1; i < lines.length; i++) {
        const values = [];
        let current = '';
        let inQuotes = false;

        for (let j = 0; j < lines[i].length; j++) {
          const char = lines[i][j];
          if (char === '"') {
            inQuotes = !inQuotes;
          } else if (char === ',' && !inQuotes) {
            values.push(current.trim());
            current = '';
          } else {
            current += char;
          }
        }
        values.push(current.trim());

        if (values.length === headers.length) {
          const row = {};
          headers.forEach((header, idx) => {
            row[header] = values[idx] || '';
          });
          data.push(row);
        }
      }

      return { data, headers };
    }

    // ===================== EXCEL READING =====================
    async function readExcelFile(file, options = {}) {
      return new Promise((resolve, reject) => {
        if (typeof XLSX === 'undefined') {
          reject(new Error('SheetJS k√ºt√ºphanesi y√ºklenmedi.'));
          return;
        }

        if (!file) {
          reject(new Error('Dosya se√ßilmedi.'));
          return;
        }

        const reader = new FileReader();

        reader.onload = (e) => {
          try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { 
              type: 'array',
              cellDates: true,
              cellNF: false,
            });

            if (!workbook.SheetNames || workbook.SheetNames.length === 0) {
              reject(new Error('Excel dosyasƒ±nda sheet bulunamadƒ±.'));
              return;
            }

            const sheetIndex = options.sheetIndex !== undefined ? options.sheetIndex : 0;
            let sheetName;
            
            if (typeof sheetIndex === 'number') {
              if (sheetIndex < 0 || sheetIndex >= workbook.SheetNames.length) {
                reject(new Error(`Sheet index ${sheetIndex} ge√ßersiz.`));
                return;
              }
              sheetName = workbook.SheetNames[sheetIndex];
            } else {
              if (!workbook.SheetNames.includes(sheetIndex)) {
                reject(new Error(`Sheet adƒ± "${sheetIndex}" bulunamadƒ±.`));
                return;
              }
              sheetName = sheetIndex;
            }

            const worksheet = workbook.Sheets[sheetName];
            if (!worksheet) {
              reject(new Error(`Sheet "${sheetName}" okunamadƒ±.`));
              return;
            }

            const header = options.header !== false;
            const defval = options.defval !== undefined ? options.defval : '';

            let jsonData;
            if (header) {
              jsonData = XLSX.utils.sheet_to_json(worksheet, { 
                defval: defval,
                raw: false,
                dateNF: 'yyyy-mm-dd',
              });
            } else {
              const range = XLSX.utils.decode_range(worksheet['!ref'] || 'A1');
              jsonData = [];
              for (let R = range.s.r; R <= range.e.r; R++) {
                const row = [];
                for (let C = range.s.c; C <= range.e.c; C++) {
                  const cellAddress = XLSX.utils.encode_cell({ r: R, c: C });
                  const cell = worksheet[cellAddress];
                  row.push(cell ? (cell.w || cell.v || defval) : defval);
                }
                jsonData.push(row);
              }
            }

            resolve({
              data: jsonData,
              sheetName: sheetName,
              sheetNames: workbook.SheetNames,
              totalSheets: workbook.SheetNames.length,
            });

          } catch (error) {
            reject(new Error('Excel dosyasƒ± okunurken hata olu≈ütu: ' + error.message));
          }
        };

        reader.onerror = () => {
          reject(new Error('Dosya okunamadƒ±.'));
        };

        reader.readAsArrayBuffer(file);
      });
    }

    // ===================== FILE READING =====================
    async function readFile(file) {
      if (file.name.endsWith('.csv')) {
        return new Promise((resolve, reject) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            try {
              const result = parseCSV(e.target.result);
              resolve({
                data: result.data,
                sheetName: 'CSV',
                sheetNames: ['CSV'],
                totalSheets: 1
              });
            } catch (error) {
              reject(new Error('CSV dosyasƒ± okunamadƒ±: ' + error.message));
            }
          };
          reader.onerror = () => reject(new Error('Dosya okunamadƒ±.'));
          reader.readAsText(file, 'UTF-8');
        });
      } else {
        return readExcelFile(file, { sheetIndex: 0, header: true, defval: '' });
      }
    }

    // ===================== GLOBAL DATA STORAGE =====================
    let gelirData = null;
    let giderData = null;
    let gelirHeaders = [];
    let giderHeaders = [];
    let charts = {};

    // ===================== DATA PROCESSING =====================
    function processData(data, type) {
      if (!data || data.length === 0) return null;

      const processed = {
        raw: data,
        totals: {
          2023: 0,
          2024: 0,
          2025: 0
        },
        categories: {},
        topItems: []
      };

      data.forEach(row => {
        const kalem = (row.Kalem || '').trim();
        const altAciklama = (row.Alt_Aciklama || '').trim();
        const y2023 = parseFloat(row['2023'] || 0);
        const y2024 = parseFloat(row['2024'] || 0);
        const y2025 = parseFloat(row['2025'] || 0);

        processed.totals[2023] += y2023;
        processed.totals[2024] += y2024;
        processed.totals[2025] += y2025;

        if (kalem) {
          if (!processed.categories[kalem]) {
            processed.categories[kalem] = {
              total2023: 0,
              total2024: 0,
              total2025: 0,
              items: []
            };
          }
          processed.categories[kalem].total2023 += y2023;
          processed.categories[kalem].total2024 += y2024;
          processed.categories[kalem].total2025 += y2025;
          processed.categories[kalem].items.push({
            kalem,
            altAciklama,
            y2023,
            y2024,
            y2025
          });
        }

        if (y2024 > 0) {
          processed.topItems.push({
            kalem: kalem || altAciklama,
            altAciklama,
            value: y2024
          });
        }
      });

      processed.topItems.sort((a, b) => b.value - a.value);
      processed.topItems = processed.topItems.slice(0, 10);

      return processed;
    }

    // ===================== KPI RENDERING =====================
    function renderKPIs() {
      if (!gelirData && !giderData) return;

      const kpiGrid = document.getElementById('kpiGrid');
      const kpis = [];

      if (gelirData) {
        const g = gelirData.totals;
        kpis.push({
          label: 'Toplam Gelir 2023',
          value: formatCurrency(g[2023]),
          year: '2023',
          type: 'gelir'
        });
        kpis.push({
          label: 'Toplam Gelir 2024',
          value: formatCurrency(g[2024]),
          year: '2024',
          type: 'gelir',
          change: g[2023] > 0 ? ((g[2024] - g[2023]) / g[2023] * 100) : 0
        });
        kpis.push({
          label: 'Toplam Gelir 2025',
          value: formatCurrency(g[2025]),
          year: '2025',
          type: 'gelir',
          change: g[2024] > 0 ? ((g[2025] - g[2024]) / g[2024] * 100) : 0
        });
      }

      if (giderData) {
        const g = giderData.totals;
        kpis.push({
          label: 'Toplam Gider 2023',
          value: formatCurrency(g[2023]),
          year: '2023',
          type: 'gider'
        });
        kpis.push({
          label: 'Toplam Gider 2024',
          value: formatCurrency(g[2024]),
          year: '2024',
          type: 'gider',
          change: g[2023] > 0 ? ((g[2024] - g[2023]) / g[2023] * 100) : 0
        });
        kpis.push({
          label: 'Toplam Gider 2025',
          value: formatCurrency(g[2025]),
          year: '2025',
          type: 'gider',
          change: g[2024] > 0 ? ((g[2025] - g[2024]) / g[2024] * 100) : 0
        });
      }

      if (gelirData && giderData) {
        const net2023 = gelirData.totals[2023] - giderData.totals[2023];
        const net2024 = gelirData.totals[2024] - giderData.totals[2024];
        const net2025 = gelirData.totals[2025] - giderData.totals[2025];

        kpis.push({
          label: 'Net Gelir 2023',
          value: formatCurrency(net2023),
          year: '2023',
          type: 'net'
        });
        kpis.push({
          label: 'Net Gelir 2024',
          value: formatCurrency(net2024),
          year: '2024',
          type: 'net',
          change: net2023 !== 0 ? ((net2024 - net2023) / Math.abs(net2023) * 100) : 0
        });
        kpis.push({
          label: 'Net Gelir 2025',
          value: formatCurrency(net2025),
          year: '2025',
          type: 'net',
          change: net2024 !== 0 ? ((net2025 - net2024) / Math.abs(net2024) * 100) : 0
        });
      }

      kpiGrid.innerHTML = kpis.map(kpi => `
        <div class="kpi-card ${kpi.type}">
          <div class="kpi-label">${kpi.label}</div>
          <div class="kpi-value">${kpi.value}</div>
          <div class="kpi-year">${kpi.year}</div>
          ${kpi.change !== undefined ? `
            <div class="kpi-change ${kpi.change >= 0 ? 'positive' : 'negative'}">
              ${kpi.change >= 0 ? '‚Üë' : '‚Üì'} ${Math.abs(kpi.change).toFixed(2)}%
            </div>
          ` : ''}
        </div>
      `).join('');

      document.getElementById('kpiCard').style.display = 'block';
    }

    // ===================== CHARTS RENDERING =====================
    function renderCharts() {
      if (!gelirData && !giderData) return;

      const chartColors = {
        gelir: 'rgba(34, 197, 94, 0.8)',
        gider: 'rgba(239, 68, 68, 0.8)',
        net: 'rgba(59, 130, 246, 0.8)'
      };

      // Destroy existing charts
      Object.values(charts).forEach(chart => {
        if (chart) chart.destroy();
      });
      charts = {};

      // Years Comparison Chart
      if (gelirData || giderData) {
        const ctx = document.getElementById('chartYears');
        if (ctx) {
          const labels = ['2023', '2024', '2025'];
          const datasets = [];

          if (gelirData) {
            datasets.push({
              label: 'Gelir',
              data: [gelirData.totals[2023], gelirData.totals[2024], gelirData.totals[2025]],
              borderColor: chartColors.gelir,
              backgroundColor: chartColors.gelir.replace('0.8', '0.2'),
              tension: 0.4
            });
          }

          if (giderData) {
            datasets.push({
              label: 'Gider',
              data: [giderData.totals[2023], giderData.totals[2024], giderData.totals[2025]],
              borderColor: chartColors.gider,
              backgroundColor: chartColors.gider.replace('0.8', '0.2'),
              tension: 0.4
            });
          }

          if (gelirData && giderData) {
            const net2023 = gelirData.totals[2023] - giderData.totals[2023];
            const net2024 = gelirData.totals[2024] - giderData.totals[2024];
            const net2025 = gelirData.totals[2025] - giderData.totals[2025];
            datasets.push({
              label: 'Net Gelir',
              data: [net2023, net2024, net2025],
              borderColor: chartColors.net,
              backgroundColor: chartColors.net.replace('0.8', '0.2'),
              tension: 0.4
            });
          }

          charts.years = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { position: 'top' },
                tooltip: {
                  callbacks: {
                    label: (context) => formatCurrency(context.parsed.y)
                  }
                }
              },
              scales: {
                y: {
                  ticks: {
                    callback: (value) => formatCurrency(value)
                  }
                }
              }
            }
          });
        }
      }

      // Gelir 2024 Pie Chart
      if (gelirData && gelirData.categories) {
        const ctx = document.getElementById('chartGelir2024');
        if (ctx) {
          const categories = Object.entries(gelirData.categories)
            .filter(([_, cat]) => cat.total2024 > 0)
            .sort((a, b) => b[1].total2024 - a[1].total2024)
            .slice(0, 8);

          charts.gelir2024 = new Chart(ctx, {
            type: 'doughnut',
            data: {
              labels: categories.map(([name]) => name),
              datasets: [{
                data: categories.map(([_, cat]) => cat.total2024),
                backgroundColor: [
                  'rgba(34, 197, 94, 0.8)',
                  'rgba(34, 197, 94, 0.7)',
                  'rgba(34, 197, 94, 0.6)',
                  'rgba(34, 197, 94, 0.5)',
                  'rgba(34, 197, 94, 0.4)',
                  'rgba(34, 197, 94, 0.3)',
                  'rgba(34, 197, 94, 0.2)',
                  'rgba(34, 197, 94, 0.1)'
                ]
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { position: 'right' },
                tooltip: {
                  callbacks: {
                    label: (context) => {
                      const label = context.label || '';
                      const value = formatCurrency(context.parsed);
                      const total = categories.reduce((sum, [_, cat]) => sum + cat.total2024, 0);
                      const percent = ((context.parsed / total) * 100).toFixed(1);
                      return `${label}: ${value} (${percent}%)`;
                    }
                  }
                }
              }
            }
          });
        }
      }

      // Gider 2024 Pie Chart
      if (giderData && giderData.categories) {
        const ctx = document.getElementById('chartGider2024');
        if (ctx) {
          const categories = Object.entries(giderData.categories)
            .filter(([_, cat]) => cat.total2024 > 0)
            .sort((a, b) => b[1].total2024 - a[1].total2024)
            .slice(0, 8);

          charts.gider2024 = new Chart(ctx, {
            type: 'doughnut',
            data: {
              labels: categories.map(([name]) => name),
              datasets: [{
                data: categories.map(([_, cat]) => cat.total2024),
                backgroundColor: [
                  'rgba(239, 68, 68, 0.8)',
                  'rgba(239, 68, 68, 0.7)',
                  'rgba(239, 68, 68, 0.6)',
                  'rgba(239, 68, 68, 0.5)',
                  'rgba(239, 68, 68, 0.4)',
                  'rgba(239, 68, 68, 0.3)',
                  'rgba(239, 68, 68, 0.2)',
                  'rgba(239, 68, 68, 0.1)'
                ]
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { position: 'right' },
                tooltip: {
                  callbacks: {
                    label: (context) => {
                      const label = context.label || '';
                      const value = formatCurrency(context.parsed);
                      const total = categories.reduce((sum, [_, cat]) => sum + cat.total2024, 0);
                      const percent = ((context.parsed / total) * 100).toFixed(1);
                      return `${label}: ${value} (${percent}%)`;
                    }
                  }
                }
              }
            }
          });
        }
      }

      // Top Items Chart
      if (gelirData && giderData) {
        const ctx = document.getElementById('chartTopItems');
        if (ctx) {
          const allItems = [
            ...gelirData.topItems.map(item => ({ ...item, type: 'gelir' })),
            ...giderData.topItems.map(item => ({ ...item, type: 'gider' }))
          ].sort((a, b) => b.value - a.value).slice(0, 10);

          charts.topItems = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: allItems.map(item => item.kalem || item.altAciklama),
              datasets: [{
                label: 'Tutar',
                data: allItems.map(item => item.value),
                backgroundColor: allItems.map(item => 
                  item.type === 'gelir' ? chartColors.gelir : chartColors.gider
                )
              }]
            },
            options: {
              indexAxis: 'y',
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                tooltip: {
                  callbacks: {
                    label: (context) => formatCurrency(context.parsed.x)
                  }
                }
              },
              scales: {
                x: {
                  ticks: {
                    callback: (value) => formatCurrency(value)
                  }
                }
              }
            }
          });
        }
      }

      document.getElementById('chartsCard').style.display = 'block';
    }

    // ===================== TABLE RENDERING =====================
    function renderTable(data, headers, tableId, searchId) {
      if (!data || data.length === 0) return;

      const tableHead = document.getElementById(tableId + 'Head');
      const tableBody = document.getElementById(tableId + 'Body');
      const searchInput = document.getElementById(searchId);

      // Headers
      const displayHeaders = ['Kalem', 'Alt_Aciklama', '2023', '2024', '2025', 
                            'Degisim_Yuzde_23_24', 'Degisim_Tutar_23_24',
                            'Degisim_Yuzde_24_25', 'Degisim_Tutar_24_25'];
      const availableHeaders = displayHeaders.filter(h => headers.includes(h));

      tableHead.innerHTML = `
        <tr>
          ${availableHeaders.map(h => `<th class="sortable">${escapeHtml(h)}</th>`).join('')}
        </tr>
      `;

      // Search functionality
      let filteredData = data;
      if (searchInput) {
        searchInput.addEventListener('input', (e) => {
          const query = e.target.value.toLowerCase();
          filteredData = data.filter(row => {
            const kalem = (row.Kalem || '').toLowerCase();
            const alt = (row.Alt_Aciklama || '').toLowerCase();
            return kalem.includes(query) || alt.includes(query);
          });
          renderTableBody(filteredData, availableHeaders, tableBody);
        });
      }

      renderTableBody(filteredData, availableHeaders, tableBody);

      // Sort functionality
      tableHead.querySelectorAll('th.sortable').forEach((th, idx) => {
        th.addEventListener('click', () => {
          const currentSort = th.classList.contains('sort-asc') ? 'desc' : 'asc';
          tableHead.querySelectorAll('th').forEach(h => {
            h.classList.remove('sort-asc', 'sort-desc');
          });
          th.classList.add(`sort-${currentSort}`);

          filteredData.sort((a, b) => {
            const key = availableHeaders[idx];
            let valA = a[key] || '';
            let valB = b[key] || '';

            // Try to parse as number
            const numA = parseFloat(valA);
            const numB = parseFloat(valB);
            if (!isNaN(numA) && !isNaN(numB)) {
              return currentSort === 'asc' ? numA - numB : numB - numA;
            }

            // String comparison
            valA = String(valA).toLowerCase();
            valB = String(valB).toLowerCase();
            if (currentSort === 'asc') {
              return valA.localeCompare(valB);
            } else {
              return valB.localeCompare(valA);
            }
          });

          renderTableBody(filteredData, availableHeaders, tableBody);
        });
      });
    }

    function renderTableBody(data, headers, tableBody) {
      tableBody.innerHTML = data.map(row => {
        return `
          <tr>
            ${headers.map(header => {
              let value = row[header] || '';
              let className = '';
              let isNumber = false;

              if (header.includes('2023') || header.includes('2024') || header.includes('2025') || 
                  header.includes('Tutar')) {
                const num = parseFloat(value);
                if (!isNaN(num)) {
                  value = formatCurrency(num);
                  className = 'number-cell';
                  if (header.includes('Degisim_Yuzde') || header.includes('Degisim_Tutar')) {
                    className += num >= 0 ? ' positive' : ' negative';
                  }
                  isNumber = true;
                }
              } else if (header.includes('Yuzde')) {
                const num = parseFloat(value);
                if (!isNaN(num)) {
                  value = num.toFixed(2) + '%';
                  className = num >= 0 ? 'positive' : 'negative';
                  isNumber = true;
                }
              }

              return `<td class="${className}">${escapeHtml(String(value))}</td>`;
            }).join('')}
          </tr>
        `;
      }).join('');
    }

    // ===================== UTILITY FUNCTIONS =====================
    function formatCurrency(num) {
      return new Intl.NumberFormat('tr-TR', {
        style: 'currency',
        currency: 'TRY',
        minimumFractionDigits: 0,
        maximumFractionDigits: 0
      }).format(num);
    }

    // ===================== EVENT LISTENERS =====================
    // Gelir File
    document.getElementById('btnReadGelir').addEventListener('click', async () => {
      const file = document.getElementById('gelirFile').files[0];
      if (!file) {
        showToast('warning', 'L√ºtfen bir gelir dosyasƒ± se√ßin.');
        return;
      }

      try {
        const btn = document.getElementById('btnReadGelir');
        btn.disabled = true;
        btn.innerHTML = '<span class="loading"></span> <span>Okunuyor...</span>';
        
        showToast('info', 'Gelir dosyasƒ± okunuyor...');
        
        const result = await readFile(file);
        const rawData = result.data;
        gelirHeaders = rawData.length > 0 ? Object.keys(rawData[0]) : [];
        gelirData = processData(rawData, 'gelir');

        document.getElementById('gelirInfo').innerHTML = `
          <strong>Dosya:</strong> ${escapeHtml(file.name)}<br>
          <strong>Toplam Satƒ±r:</strong> ${rawData.length}<br>
          <strong>Toplam 2024:</strong> ${formatCurrency(gelirData.totals[2024])}
        `;

        document.getElementById('btnClearGelir').style.display = 'inline-flex';
        document.getElementById('gelirTableCard').style.display = 'block';

        renderTable(gelirData.raw, gelirHeaders, 'gelirTable', 'gelirSearch');
        renderKPIs();
        renderCharts();

        showToast('success', `Gelir dosyasƒ± ba≈üarƒ±yla y√ºklendi (${rawData.length} satƒ±r).`);

      } catch (error) {
        console.error('Gelir okuma hatasƒ±:', error);
        showToast('error', error.message);
      } finally {
        const btn = document.getElementById('btnReadGelir');
        btn.disabled = false;
        btn.innerHTML = '<span>üìÅ</span> <span>Gelir Dosyasƒ±nƒ± Oku</span>';
      }
    });

    // Gider File
    document.getElementById('btnReadGider').addEventListener('click', async () => {
      const file = document.getElementById('giderFile').files[0];
      if (!file) {
        showToast('warning', 'L√ºtfen bir gider dosyasƒ± se√ßin.');
        return;
      }

      try {
        const btn = document.getElementById('btnReadGider');
        btn.disabled = true;
        btn.innerHTML = '<span class="loading"></span> <span>Okunuyor...</span>';
        
        showToast('info', 'Gider dosyasƒ± okunuyor...');
        
        const result = await readFile(file);
        const rawData = result.data;
        giderHeaders = rawData.length > 0 ? Object.keys(rawData[0]) : [];
        giderData = processData(rawData, 'gider');

        document.getElementById('giderInfo').innerHTML = `
          <strong>Dosya:</strong> ${escapeHtml(file.name)}<br>
          <strong>Toplam Satƒ±r:</strong> ${rawData.length}<br>
          <strong>Toplam 2024:</strong> ${formatCurrency(giderData.totals[2024])}
        `;

        document.getElementById('btnClearGider').style.display = 'inline-flex';
        document.getElementById('giderTableCard').style.display = 'block';

        renderTable(giderData.raw, giderHeaders, 'giderTable', 'giderSearch');
        renderKPIs();
        renderCharts();

        showToast('success', `Gider dosyasƒ± ba≈üarƒ±yla y√ºklendi (${rawData.length} satƒ±r).`);

      } catch (error) {
        console.error('Gider okuma hatasƒ±:', error);
        showToast('error', error.message);
      } finally {
        const btn = document.getElementById('btnReadGider');
        btn.disabled = false;
        btn.innerHTML = '<span>üìÅ</span> <span>Gider Dosyasƒ±nƒ± Oku</span>';
      }
    });

    // Clear buttons
    document.getElementById('btnClearGelir').addEventListener('click', () => {
      if (confirm('Gelir verilerini temizlemek istediƒüinize emin misiniz?')) {
        gelirData = null;
        gelirHeaders = [];
        document.getElementById('gelirFile').value = '';
        document.getElementById('gelirInfo').textContent = '';
        document.getElementById('btnClearGelir').style.display = 'none';
        document.getElementById('gelirTableCard').style.display = 'none';
        renderKPIs();
        renderCharts();
        showToast('info', 'Gelir verileri temizlendi.');
      }
    });

    document.getElementById('btnClearGider').addEventListener('click', () => {
      if (confirm('Gider verilerini temizlemek istediƒüinize emin misiniz?')) {
        giderData = null;
        giderHeaders = [];
        document.getElementById('giderFile').value = '';
        document.getElementById('giderInfo').textContent = '';
        document.getElementById('btnClearGider').style.display = 'none';
        document.getElementById('giderTableCard').style.display = 'none';
        renderKPIs();
        renderCharts();
        showToast('info', 'Gider verileri temizlendi.');
      }
    });

    // Export buttons
    document.getElementById('btnExportGelirJSON').addEventListener('click', () => {
      if (!gelirData || !gelirData.raw) {
        showToast('warning', '√ñnce gelir dosyasƒ± y√ºkleyin.');
        return;
      }
      const jsonStr = JSON.stringify(gelirData.raw, null, 2);
      const blob = new Blob([jsonStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'gelir-verileri.json';
      a.click();
      URL.revokeObjectURL(url);
      showToast('success', 'Gelir JSON dosyasƒ± indirildi.');
    });

    document.getElementById('btnExportGelirCSV').addEventListener('click', () => {
      if (!gelirData || !gelirData.raw || gelirData.raw.length === 0) {
        showToast('warning', '√ñnce gelir dosyasƒ± y√ºkleyin.');
        return;
      }
      const headers = gelirHeaders.join(',');
      const rows = gelirData.raw.map(row => {
        return gelirHeaders.map(header => {
          const value = row[header] || '';
          if (typeof value === 'string' && (value.includes(',') || value.includes('"') || value.includes('\n'))) {
            return `"${value.replace(/"/g, '""')}"`;
          }
          return value;
        }).join(',');
      });
      const csvContent = [headers, ...rows].join('\n');
      const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'gelir-verileri.csv';
      a.click();
      URL.revokeObjectURL(url);
      showToast('success', 'Gelir CSV dosyasƒ± indirildi.');
    });

    document.getElementById('btnExportGiderJSON').addEventListener('click', () => {
      if (!giderData || !giderData.raw) {
        showToast('warning', '√ñnce gider dosyasƒ± y√ºkleyin.');
        return;
      }
      const jsonStr = JSON.stringify(giderData.raw, null, 2);
      const blob = new Blob([jsonStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'gider-verileri.json';
      a.click();
      URL.revokeObjectURL(url);
      showToast('success', 'Gider JSON dosyasƒ± indirildi.');
    });

    document.getElementById('btnExportGiderCSV').addEventListener('click', () => {
      if (!giderData || !giderData.raw || giderData.raw.length === 0) {
        showToast('warning', '√ñnce gider dosyasƒ± y√ºkleyin.');
        return;
      }
      const headers = giderHeaders.join(',');
      const rows = giderData.raw.map(row => {
        return giderHeaders.map(header => {
          const value = row[header] || '';
          if (typeof value === 'string' && (value.includes(',') || value.includes('"') || value.includes('\n'))) {
            return `"${value.replace(/"/g, '""')}"`;
          }
          return value;
        }).join(',');
      });
      const csvContent = [headers, ...rows].join('\n');
      const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'gider-verileri.csv';
      a.click();
      URL.revokeObjectURL(url);
      showToast('success', 'Gider CSV dosyasƒ± indirildi.');
    });
  </script>
</body>
</html>