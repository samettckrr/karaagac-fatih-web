<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>KullanÄ±cÄ± & Yetki YÃ¶netimi</title>
<link rel="icon" type="image/png" href="../img/logo.png" />
<link rel="stylesheet" href="../css/app-shell.css" />
<style>
  /* GÃœVENLÄ°K: Body baÅŸlangÄ±Ã§ta gizli, erken auth kontrolÃ¼ baÅŸarÄ±lÄ± olunca gÃ¶sterilir */
  body { visibility: hidden; }
  html { visibility: hidden; }
</style>

<!-- ====== TEMA (panel.html ile aynÄ±) ====== -->
<style>
  :root{
    --appbar-h:56px;
    --radius:14px; --shadow:0 12px 28px rgba(0,0,0,.14);
    --bg:#f5f5f0; --bg2:#fafaf5;
    --grad1:#e5e5e022; --grad2:#d4d4d022;
    --card:rgba(255,255,255,.95); --stroke:rgba(15,23,42,.12);
    --text:#0b1220; --muted:#4b5563;
    --brand:#0ea5e9; --brand2:#0284c7;
    --pill:#f5f5f0; --pill-hover:#e9e9e4;
    --link:#0b5ea8; --surface:#f0f0eb;
    --ok:#33c27f; --danger:#ff4255;
  }
  /* Light tema varsayÄ±lan - dark tema kaldÄ±rÄ±ldÄ± */
  /* Sadece light tema kullanÄ±lÄ±yor - dark tema kaldÄ±rÄ±ldÄ± */

  *{box-sizing:border-box}
  body{
    margin:0; 
    padding:0;
    padding-top:var(--appbar-h) !important; /* Ãœst panel iÃ§in boÅŸluk */
    color:var(--text);
    font-family:ui-sans-serif,-apple-system,"Segoe UI",Roboto,Arial;
    background:
      radial-gradient(900px 680px at 12% 8%, var(--grad1), transparent 45%),
      radial-gradient(800px 640px at 88% 92%, var(--grad2), transparent 50%),
      linear-gradient(140deg, var(--bg), var(--bg2) 60%);
    overflow-x:hidden;
  }
  a{color:var(--link); text-decoration:none}
  a:hover{text-decoration:underline}

  /* APPBAR - app-shell.css'den geliyor, burada sadece Ã¶zel override'lar */
  .appbar{
    position:fixed !important; 
    top:0 !important; 
    left:0 !important;
    right:0 !important;
    z-index:60 !important;
  }

  /* LAYOUT */
  .container{width:100%; margin:0 auto; padding:8px; box-sizing:border-box}
  .grid{display:grid; gap:10px; grid-template-columns:repeat(12, minmax(0,1fr))}
  .col-8{grid-column:span 12}
  .col-4{grid-column:span 12}
  @media (max-width:980px){ 
    .col-8,.col-4{grid-column:span 12}
    .summary{position:static; margin-top:16px}
  }
  
  /* Mobil genel iyileÅŸtirmeler */
  @media (max-width: 640px){
    .container{padding:8px}
    .card{padding:12px}
    .mini{gap:6px}
    .btn{padding:6px 10px; font-size:12px}
    h3{font-size:15px}
    .kpi{padding:10px}
    .kpi .val{font-size:20px}
  }
  
  /* Tablet ve masaÃ¼stÃ¼ iÃ§in padding */
  @media (min-width: 641px){
    .container{padding:10px}
  }
  @media (min-width: 1024px){
    .container{padding:12px}
  }

  .card{background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px}
  .card h3{margin:0 0 10px; font-size:16px}
  .mini{display:flex; gap:8px; flex-wrap:wrap}
  .pill{padding:6px 10px; border-radius:999px; border:1px solid var(--stroke); background:var(--pill); font-size:12px}

  /* FORM */
  label{font-weight:700; display:block; margin:10px 0 6px; font-size:13px}
  input,select,textarea{width:100%; padding:11px 12px; border:1px solid var(--stroke); border-radius:12px; background:var(--pill); color:var(--text); outline:none; transition:all .15s ease; font-size:14px}
  input:focus,select:focus,textarea:focus{box-shadow:0 0 0 4px rgba(56,189,248,.18); border-color:var(--brand); background:var(--pill-hover)}
  input:disabled{opacity:.6; cursor:not-allowed}
  .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  @media(max-width:900px){.row{grid-template-columns:1fr}}

  /* PERM TREE */
  .perm-group{border:1px dashed var(--stroke); border-radius:12px; padding:12px; margin:12px 0; background:var(--surface)}
  .perm-head{display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:8px}
  .perm-grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:8px}
  .perm-item{display:flex; align-items:center; gap:8px; background:var(--pill); border:1px solid var(--stroke); border-radius:999px; padding:8px 10px}
  .perm-item input{width:18px;height:18px}

  /* TABLE & CARDS */
  .table{width:100%; border-collapse:collapse; min-width:800px}
  .sayfa-grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(400px,1fr)); gap:14px}
  .sayfa-card{background:var(--card); border:1px solid var(--stroke); border-radius:12px; padding:16px; transition:transform .15s ease, box-shadow .15s ease}
  .sayfa-card:hover{transform:translateY(-2px); box-shadow:0 8px 24px rgba(0,0,0,.12)}
  .sayfa-card-header{margin-bottom:14px; padding-bottom:12px; border-bottom:1px solid var(--stroke)}
  .sayfa-card-title{font-size:16px; font-weight:700; margin-bottom:6px; color:var(--text)}
  .sayfa-card-meta{display:flex; gap:8px; flex-wrap:wrap; align-items:center; font-size:12px; color:var(--muted)}
  .sayfa-card-body{margin-top:12px}
  .sayfa-personel-item{display:flex; align-items:center; justify-content:space-between; padding:8px 0; border-bottom:1px solid var(--pill)}
  .sayfa-personel-item:last-child{border-bottom:none}
  .sayfa-personel-name{font-size:13px; font-weight:500; flex:1}
  .sayfa-personel-checkbox{width:20px; height:20px; cursor:pointer; accent-color:var(--brand)}
  .gridcards{display:grid; grid-template-columns:repeat(auto-fill,minmax(500px,1fr)); gap:14px}
  .ucard{background:var(--card); border:1px solid var(--stroke); border-radius:12px; padding:14px; transition:transform .15s ease, box-shadow .15s ease}
  .ucard:hover{transform:translateY(-2px); box-shadow:0 8px 24px rgba(0,0,0,.12)}
  
  /* Mobil tablo gÃ¶rÃ¼nÃ¼mÃ¼ */
  @media (max-width: 900px){
    .table-wrapper{overflow-x:auto}
    .table th,.table td{padding:8px 6px; font-size:13px}
    .table th{font-size:11px}
  }
  
  /* Mobil kart gÃ¶rÃ¼nÃ¼mÃ¼ */
  @media (max-width: 768px){
    .gridcards{grid-template-columns:1fr; gap:12px}
    .ucard{padding:12px}
  }
  /* Tablet iÃ§in kart geniÅŸliÄŸi */
  @media (min-width: 769px) and (max-width: 1024px){
    .gridcards{grid-template-columns:repeat(auto-fill,minmax(350px,1fr)); gap:12px}
  }

  /* MODAL - app-shell.css'den geliyor */

  /* RIGHT SUMMARY */
  .summary{position:static}
  .kpi{display:flex; justify-content:space-between; align-items:center; padding:12px; background:var(--pill); border:1px solid var(--stroke); border-radius:12px; gap:12px}
  .kpi .val{font-size:24px; font-weight:800; color:var(--brand2); line-height:1.2}
  .kpi .sub{font-size:12px; color:var(--muted); margin-top:4px}
  .kpi > div:last-child{font-size:28px; opacity:.8}

  /* Toast - app-shell.css'den geliyor */
</style>

<!-- Firebase kaldÄ±rÄ±ldÄ± - ArtÄ±k sadece Supabase kullanÄ±lÄ±yor -->

<!-- Supabase (veritabanÄ± iÃ§in) -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
<script>
  // Bu sayfa iÃ§in Ã¶zel iÅŸaret - ortak.js'den Ã¶nce Ã§alÄ±ÅŸsÄ±n
  window.IS_KULLANICI_EKLE_PAGE = true;
  
  // Supabase client'Ä± oluÅŸtur (index.html'deki mantÄ±k)
  (function() {
    const SUPABASE_URL = 'https://lmwfibippjvqctccxiwb.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imxtd2ZpYmlwcGp2cWN0Y2N4aXdiIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2NjE2NzA1NCwiZXhwIjoyMDgxNzQzMDU0fQ.lzoudrJx_V4RdCCxPRfgLA1riWNKZ3HyFzeqRynYHeQ';
    
    function initSupabase() {
      if (typeof supabase !== 'undefined' && typeof supabase.createClient === 'function') {
        window.supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        // window.auth'u da set et (ortak.js uyumluluÄŸu iÃ§in)
        if (window.supabase && window.supabase.auth) {
          window.auth = window.supabase.auth;
        }
        return true;
      }
      return false;
    }
    
    // Hemen dene
    if (!initSupabase()) {
      // Biraz bekle ve tekrar dene (CDN yÃ¼kleniyor olabilir)
      let retries = 0;
      const maxRetries = 30; // 3 saniye
      const retryInterval = setInterval(function() {
        retries++;
        if (initSupabase() || retries >= maxRetries) {
          clearInterval(retryInterval);
          if (window.supabase) {
            console.log('âœ… Supabase client hazÄ±r (kullanici-ekle.html)');
          } else {
            console.warn('âš ï¸ Supabase client yÃ¼klenemedi (kullanici-ekle.html)');
          }
        }
      }, 100);
    } else {
      console.log('âœ… Supabase client hazÄ±r (kullanici-ekle.html)');
    }
  })();
  
  // ERKEN AUTH KONTROLÃœ - Sayfa yÃ¼klenmeden Ã¶nce
  // Body zaten CSS ile gizli (gÃ¶rÃ¼nÃ¼rlÃ¼k kontrolÃ¼ iÃ§in)
  (async function earlyAuthCheck(){
    try {
      // Supabase client'Ä±n yÃ¼klenmesini bekle
      let retries = 0;
      while(retries < 50 && (!window.supabase || !window.supabase.auth)){
        await new Promise(resolve => setTimeout(resolve, 100));
        retries++;
      }
      
      if(!window.supabase || !window.supabase.auth){
        console.error('âŒ GÃœVENLÄ°K: Supabase yÃ¼klenemedi');
        window.location.href = '../index.html';
        return;
      }
      
      // Session kontrolÃ¼
      const { data: { session }, error: sessionError } = await window.supabase.auth.getSession();
      
      if(sessionError){
        console.error('âŒ GÃœVENLÄ°K: Session alÄ±namadÄ±:', sessionError);
        window.location.href = '../index.html';
        return;
      }
      
      if(!session || !session.user){
        console.error('âŒ GÃœVENLÄ°K: KullanÄ±cÄ± giriÅŸ yapmamÄ±ÅŸ');
        window.location.href = '../index.html';
        return;
      }
      
      // KullanÄ±cÄ± bilgilerini kontrol et (window.supabase hazÄ±r)
      const { data: userData, error: userError } = await window.supabase
        .from('kullanicilar')
        .select('id, adsoyad, email, rol, yetkiler, aktif')
        .eq('id', session.user.id)
        .single();
      
      if(userError || !userData){
        console.error('âŒ GÃœVENLÄ°K: KullanÄ±cÄ± kaydÄ± bulunamadÄ±:', userError);
        window.location.href = '../index.html';
        return;
      }
      
      // Yetki kontrolÃ¼ - Ã¼st nav kontrolÃ¼ yeterli
      // Ãœst nav'da yetki varsa sayfaya eriÅŸim var, iÃ§erde iÅŸlem yapÄ±labilir
      // Bu kontrol sadece ekstra gÃ¼venlik iÃ§in, ana kontrol Ã¼st nav'da
      const yetkiler = Array.isArray(userData.yetkiler) ? userData.yetkiler : [];
      // Wildcard kontrolÃ¼ varsa geÃ§, yoksa Ã¼st nav kontrolÃ¼ yeterli
      
      // Auth baÅŸarÄ±lÄ± - body'yi gÃ¶ster (DOMContentLoaded beklenmeden)
      if(document.body) {
        document.body.style.visibility = 'visible';
        document.documentElement.style.visibility = 'visible';
      } else {
        // Body henÃ¼z yÃ¼klenmemiÅŸse, yÃ¼klendiÄŸinde gÃ¶ster
        document.addEventListener('DOMContentLoaded', function() {
          document.body.style.visibility = 'visible';
          document.documentElement.style.visibility = 'visible';
        });
      }
    } catch(e){
      console.error('âŒ GÃœVENLÄ°K: Erken auth kontrolÃ¼ hatasÄ±:', e);
      window.location.href = '../index.html';
    }
  })();
</script>

<!-- ORTAK APP SHELL JS -->
<script src="../js/ortak.js"></script>
</head>
<body>
<!-- GÃœVENLÄ°K: Body baÅŸlangÄ±Ã§ta erken auth kontrolÃ¼ tarafÄ±ndan gizlenir, baÅŸarÄ±lÄ± olunca gÃ¶sterilir -->

<!-- ====== APPBAR ====== -->
<div class="appbar">
    <div class="brand" onclick="location.href='../panel.html'">
    <img src="../img/logo.png" alt="logo"><span>KARAAÄAÃ‡ FATÄ°H</span>
  </div>
  <nav class="nav-center"><ul class="nav-list" id="navMain"></ul></nav>
  <div class="nav-right">
    <button class="btn hamb" id="hamburger" title="MenÃ¼">â˜°</button>
    
    <!-- Bildirim -->
    <div class="nav-item">
      <button class="iconbtn" id="btnNotif" title="Bildirimler">ğŸ””
        <span class="badge" id="notifBadge" style="display:none">0</span>
      </button>
      <div class="dropdown drop-right" id="notifDropdown" aria-label="Bildirim listesi">
        <div class="muted" style="padding:6px 8px">Son bildirimler</div>
        <div id="notifList" style="max-height:300px;overflow:auto"></div>
        <a href="../diger/bildirim.html">TÃ¼m bildirimleri gÃ¶r â†’</a>
      </div>
    </div>

    <!-- Profil -->
    <div class="nav-item">
      <button class="iconbtn" id="btnProfile" title="Profil">
        <span id="profName" class="muted">Profil</span>
      </button>
      <div class="dropdown drop-right" id="profDropdown" aria-label="Profil menÃ¼sÃ¼">
        <a href="../diger/kullanici-yonetimi.html">ğŸ‘¤ Profil</a>
        <a href="../diger/sistem-ayarlari.html">âš™ï¸ Sistem AyarlarÄ±</a>
        <a href="#" id="btnLogout">ğŸšª Ã‡Ä±kÄ±ÅŸ Yap</a>
      </div>
    </div>
  </div>
</div>
<aside class="drawer" id="drawer"></aside>

<!-- Toast Container (ortak sistem) -->
<div class="toast-container" id="toastContainer"></div>

<!-- ====== CONTENT ====== -->
<main class="container">
  <div class="grid">
    <!-- SOL -->
    <section class="col-8" style="grid-column:span 12">
      <div class="card">
        <div class="mini" style="gap:6px">
          <button class="btn" id="tabAdd">KullanÄ±cÄ± Ekle</button>
          <button class="btn" id="tabMan">Yetki (Manifest)</button>
          <button class="btn" id="tabList">KullanÄ±cÄ±lar</button>
        </div>
      </div>

      <!-- EKLE -->
      <section id="viewAdd" class="card" style="display:none">
        <h3>KullanÄ±cÄ± Ekle</h3>
        <form id="frmAdd" style="margin-top:8px">
          <div class="row">
            <div><label>Ad Soyad</label><input id="adSoyad" required></div>
            <div>
              <label>Rol</label>
              <select id="rol" required>
                <option value="" disabled selected>SeÃ§iniz</option>
                <option>admin</option><option>personel</option><option>ziyaret</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div><label>GÃ¶rev</label><input id="gorev" required></div>
            <div>
              <label>E-posta</label>
              <input id="email" type="email" required>
              <div id="emailHint" style="margin-top:6px;font-size:12px;color:var(--muted)">â€”</div>
            </div>
          </div>
          <div class="row">
            <div>
              <label>GeÃ§ici Åifre</label>
              <div class="mini" style="align-items:center">
                <input id="sifre" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" style="flex:1">
                <button type="button" class="btn" id="togglePw">ğŸ‘</button>
                <button type="button" class="btn" id="btnPwGen">Rastgele</button>
                <label class="mini" style="align-items:center"><input type="checkbox" id="chkEmailNotify" checked> <span style="font-size:12px;color:var(--muted)">E-posta bildir</span></label>
              </div>
              <div style="margin-top:8px;height:8px;background:var(--surface);border-radius:6px;overflow:hidden"><span id="meterBar" style="display:block;height:100%;width:0%"></span></div>
              <div id="pwLabel" style="margin-top:6px;font-size:12px;color:var(--muted)">GÃ¼Ã§: â€”</div>
            </div>
            <div class="mini" style="align-items:center"><span class="pill">KayÄ±ttan sonra ÅŸifre sÄ±fÄ±rlama e-postasÄ± gider.</span></div>
          </div>

          <label style="margin-top:8px">Yetkiler</label>
          <div id="permTreeAdd"><div class="pill">Manifest boÅŸsa â€œYetki (Manifest)â€ sekmesinden ekleyin.</div></div>

          <div class="mini" style="margin-top:12px">
            <button type="button" class="btn" id="btnPreview">Ã–nizle</button>
            <button class="btn" id="btnSubmit">Kaydet</button>
          </div>
        </form>
      </section>

      <!-- MANIFEST -->
      <section id="viewMan" class="card" style="display:none">
        <h3>Yetki (Manifest)</h3>
        <form id="frmPanel" style="margin-top:8px">
          <div class="row">
            <div><label>Panel Anahtar</label><input id="p_key" placeholder="Talebe" required></div>
            <div><label>Panel BaÅŸlÄ±k</label><input id="p_title" placeholder="Talebe Paneli" required></div>
          </div>
          <div class="row">
            <div><label>SÄ±ra</label><input id="p_order" type="number" value="1"></div>
            <div class="mini" style="align-items:end">
              <button class="btn" id="btnPanelSave">Kaydet/GÃ¼ncelle</button>
              <button type="button" class="btn" id="btnQuickPanels">HÄ±zlÄ± Panel Seti</button>
            </div>
          </div>
        </form>

        <div style="height:12px"></div>
        <form id="frmPage">
          <div class="row">
            <div><label>Panel SeÃ§</label><select id="s_panel" required></select></div>
            <div><label>Sayfa BaÅŸlÄ±k</label><input id="s_title" required></div>
          </div>
          <div class="row">
            <div><label>Path</label><input id="s_path" placeholder="talebe/talebe-liste.html" required></div>
            <div><label>SÄ±ra</label><input id="s_order" type="number" value="1"></div>
          </div>
          <div class="mini"><button class="btn" id="btnPageAdd">Ekle</button></div>
        </form>

        <div style="height:12px"></div>
        <div class="card" style="padding:12px">
          <h3>Mevcut Manifest</h3>
          <div id="manifestList" style="margin-top:6px"><div class="pill">Panel ve sayfalar burada listelenir.</div></div>
        </div>
      </section>

      <!-- LÄ°STE -->
      <section id="viewList" class="card">
        <h3 style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">
          <span>ğŸ‘¥ KullanÄ±cÄ±lar</span>
          <span class="mini" style="gap:6px">
            <button class="btn" id="btnSayfa" style="background:var(--brand);color:#fff">ğŸ“„ Sayfa</button>
            <button class="btn" id="btnPersonel">ğŸ‘¤ Personel</button>
          </span>
        </h3>
        <div class="mini" style="margin-bottom:10px;flex-wrap:wrap;gap:8px">
          <input id="sch" placeholder="ğŸ” Ara (ad, e-posta, gÃ¶rev)" style="min-width:220px;flex:1;max-width:400px">
          <select id="fltRol" style="min-width:140px"><option value="">Rol (tÃ¼mÃ¼)</option><option>admin</option><option>personel</option><option>ziyaret</option></select>
          <select id="fltDurum" style="min-width:140px"><option value="">Durum (tÃ¼mÃ¼)</option><option value="true">Aktif</option><option value="false">Pasif</option></select>
          <button class="btn" id="btnRef">ğŸ”„ Yenile</button>
        </div>

        <!-- Ã–ZET - KartlarÄ±n Ã¼stÃ¼nde -->
        <div id="summaryCardInline" style="display:none;margin-bottom:14px">
          <div class="card summary" style="position:static;margin:0">
            <h3>Ã–zet</h3>
            <div class="mini" style="flex-direction:row;flex-wrap:wrap; gap:10px; margin-top:8px">
              <div class="kpi" style="flex:1;min-width:150px"><div><div class="val" id="kpiUsersInline">â€”</div><div class="sub">Toplam KullanÄ±cÄ±</div></div><div>ğŸ‘¥</div></div>
              <div class="kpi" style="flex:1;min-width:150px"><div><div class="val" id="kpiActiveInline">â€”</div><div class="sub">Aktif</div></div><div>âœ…</div></div>
              <div class="kpi" style="flex:1;min-width:150px"><div><div class="val" id="kpiPassiveInline">â€”</div><div class="sub">Pasif</div></div><div>â›”</div></div>
              <div class="kpi" style="flex:1;min-width:150px"><div><div class="val" id="kpiPanelsInline">â€”</div><div class="sub">Panel</div></div><div>ğŸ“¦</div></div>
              <div class="kpi" style="flex:1;min-width:150px"><div><div class="val" id="kpiPagesInline">â€”</div><div class="sub">Sayfa</div></div><div>ğŸ§©</div></div>
            </div>
          </div>
        </div>

        <div id="sayfaWrap" class="sayfa-grid" style="display:none"></div>
        <div id="usersCardsWrap" class="gridcards" style="display:none"></div>
      </section>
    </section>

    <!-- Ã–ZET - KartlarÄ±n arasÄ±nda gÃ¶sterilecek -->
    <div id="summaryCard" style="display:none;grid-column:span 12">
      <div class="card summary" style="position:static;margin:0">
        <h3>Ã–zet</h3>
        <div class="mini" style="flex-direction:row;flex-wrap:wrap; gap:10px; margin-top:8px">
          <div class="kpi" style="flex:1;min-width:150px"><div><div class="val" id="kpiUsers">â€”</div><div class="sub">Toplam KullanÄ±cÄ±</div></div><div>ğŸ‘¥</div></div>
          <div class="kpi" style="flex:1;min-width:150px"><div><div class="val" id="kpiActive">â€”</div><div class="sub">Aktif</div></div><div>âœ…</div></div>
          <div class="kpi" style="flex:1;min-width:150px"><div><div class="val" id="kpiPassive">â€”</div><div class="sub">Pasif</div></div><div>â›”</div></div>
          <div class="kpi" style="flex:1;min-width:150px"><div><div class="val" id="kpiPanels">â€”</div><div class="sub">Panel</div></div><div>ğŸ“¦</div></div>
          <div class="kpi" style="flex:1;min-width:150px"><div><div class="val" id="kpiPages">â€”</div><div class="sub">Sayfa</div></div><div>ğŸ§©</div></div>
        </div>
      </div>
    </div>
  </div>
</main>


<!-- Ã–NÄ°ZLEME MODAL -->
<div class="modal" id="mPrev">
  <div class="sheet">
    <header>
      <h3>KayÄ±t Ã–nizleme</h3>
    </header>
    <div class="body" id="prevContent"></div>
    <footer>
      <button class="btn btn-ghost" id="btnPrevClose">VazgeÃ§</button>
      <button class="btn btn-primary" id="btnPrevOk">Onayla & Kaydet</button>
    </footer>
  </div>
</div>

<!-- DÃœZENLE MODAL -->
<div class="modal" id="mEdit">
  <div class="sheet">
    <header>
      <h3>KullanÄ±cÄ± DÃ¼zenle</h3>
    </header>
    <div class="body">
      <form id="frmEdit">
        <input type="hidden" id="e_uid">
        <div class="row"><div><label>Ad Soyad</label><input id="e_ad"></div><div><label>Rol</label><select id="e_rol"><option>admin</option><option>personel</option><option>ziyaret</option></select></div></div>
        <div class="row"><div><label>GÃ¶rev</label><input id="e_gorev"></div><div><label>E-posta</label><input id="e_mail" type="email" disabled></div></div>
        <label style="margin-top:10px">Yetkiler</label>
        <div id="permTreeEdit"></div>
        <div class="row"><div><label><input type="checkbox" id="e_aktif"> Aktif</label></div></div>
      </form>
    </div>
    <footer>
      <button class="btn btn-ghost" id="btnEditClose">Kapat</button>
      <button class="btn btn-primary" id="btnEditSave">Kaydet</button>
    </footer>
  </div>
</div>

<!-- SAYFA DÃœZENLE MODAL -->
<div class="modal" id="mEditPage">
  <div class="sheet">
    <header>
      <h3>Sayfa DÃ¼zenle</h3>
    </header>
    <div class="body">
      <form id="frmEditPage">
        <input type="hidden" id="ep_panel">
        <input type="hidden" id="ep_key">
        <div class="row">
          <div><label>Panel</label><input id="ep_panelName" disabled></div>
          <div><label>Sayfa BaÅŸlÄ±k</label><input id="ep_title" required></div>
        </div>
        <div class="row">
          <div><label>Path</label><input id="ep_path" placeholder="talebe/talebe-liste.html" required></div>
          <div><label>SÄ±ra</label><input id="ep_order" type="number" value="1"></div>
        </div>
      </form>
    </div>
    <footer>
      <button class="btn btn-ghost" id="btnEditPageClose">VazgeÃ§</button>
      <button class="btn btn-primary" id="btnEditPageSave">GÃ¼ncelle</button>
    </footer>
  </div>
</div>

<!-- ÅÄ°FRE GÃ–STERÄ°M MODAL -->
<div class="modal" id="mPasswordShow">
  <div class="sheet">
    <header>
      <h3>KullanÄ±cÄ± Åifresi</h3>
    </header>
    <div class="body">
      <div id="passwordShowContent">
        <div style="margin-bottom:16px">
          <div style="margin-bottom:8px"><strong>Ad Soyad:</strong> <span id="passwordShowAdSoyad">â€”</span></div>
          <div style="margin-bottom:8px"><strong>E-posta:</strong> <span id="passwordShowEmail">â€”</span></div>
        </div>
        <div style="margin-bottom:16px; padding:12px; background:var(--surface); border-radius:8px; border:2px solid var(--stroke)">
          <div style="margin-bottom:8px; font-size:12px; color:var(--muted)">Åifre:</div>
          <div style="font-size:18px; font-weight:600; font-family:monospace; word-break:break-all; color:var(--text)" id="passwordShowSifre">â€”</div>
        </div>
        <div style="padding:12px; background:rgba(251,191,36,.1); border-radius:8px; border:1px solid rgba(251,191,36,.3); margin-bottom:16px">
          <div style="font-size:12px; color:var(--muted)">
            âš ï¸ <strong>UyarÄ±:</strong> Bu ÅŸifre admin tarafÄ±ndan belirlenmiÅŸtir. KullanÄ±cÄ± ÅŸifresini deÄŸiÅŸtirdiyse bu ÅŸifre geÃ§ersiz olabilir.
          </div>
        </div>
        <div style="display:flex; gap:10px">
          <button class="btn btn-primary" id="btnPasswordCopy" style="flex:1">ğŸ“‹ Kopyala</button>
          <button class="btn btn-ghost" id="btnPasswordClose">Kapat</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ÅÄ°FRE SIFIRLA VE KAYDET MODAL -->
<div class="modal" id="mPasswordReset">
  <div class="sheet">
    <header>
      <h3>Åifre SÄ±fÄ±rla ve Kaydet</h3>
    </header>
    <div class="body">
      <div id="passwordResetContent">
        <div style="margin-bottom:16px">
          <div style="margin-bottom:8px"><strong>Ad Soyad:</strong> <span id="passwordResetAdSoyad">â€”</span></div>
          <div style="margin-bottom:8px"><strong>E-posta:</strong> <span id="passwordResetEmail">â€”</span></div>
        </div>
        <div style="margin-bottom:16px">
          <label style="display:block; margin-bottom:8px; font-weight:600">Yeni Åifre</label>
          <div class="mini" style="align-items:center">
            <input id="passwordResetInput" type="password" placeholder="Yeni ÅŸifreyi giriniz" style="flex:1">
            <button type="button" class="btn" id="togglePasswordReset">ğŸ‘</button>
            <button type="button" class="btn" id="btnPasswordResetGen">Rastgele</button>
          </div>
          <div style="margin-top:8px;height:8px;background:var(--surface);border-radius:6px;overflow:hidden">
            <span id="passwordResetMeterBar" style="display:block;height:100%;width:0%"></span>
          </div>
          <div id="passwordResetMeterLabel" style="margin-top:6px;font-size:12px;color:var(--muted)">GÃ¼Ã§: â€”</div>
        </div>
        <div style="display:flex; gap:10px">
          <button class="btn btn-primary" id="btnPasswordResetSave" style="flex:1">ğŸ’¾ Kaydet</button>
          <button class="btn btn-ghost" id="btnPasswordResetClose">Ä°ptal</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ====== JS ====== -->
<script>
/* ===== Tema - Sadece AÃ§Ä±k Tema ===== */
(function(){
  const root=document.documentElement;
  // Sadece light tema kullan
  root.setAttribute('data-theme','light');
  // Tema butonunu gizle veya kaldÄ±r
  const btn=document.getElementById('themeToggle');
  if(btn){
    btn.style.display='none';
  }
})();

/* ===== Shortcuts ===== */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));

// Supabase client (auth + veritabanÄ± iÃ§in)
// Supabase client'Ä±n yÃ¼klenmesini bekler (async)
const getSupabase = async () => {
  // EÄŸer zaten yÃ¼klÃ¼yse direkt dÃ¶ndÃ¼r
  if(window.supabase && window.supabase.from && window.supabase.auth){
    return window.supabase;
  }
  
  // YÃ¼klenmemiÅŸse bekle (CDN yÃ¼kleniyor olabilir)
  let retries = 0;
  const maxRetries = 50; // 5 saniye
  while(retries < maxRetries){
    await new Promise(resolve => setTimeout(resolve, 100));
    if(window.supabase && window.supabase.from && window.supabase.auth){
      return window.supabase;
    }
    retries++;
  }
  
  console.warn('âš ï¸ Supabase client yÃ¼klenemedi (getSupabase timeout)');
  return null;
};

const getAuth = () => {
  // Ã–nce window.auth'u kontrol et (ortak.js uyumluluÄŸu iÃ§in)
  if(window.auth && window.auth.onAuthStateChanged){
    return window.auth;
  }
  
  // EÄŸer window.auth yoksa Supabase auth'u kullan
  // NOT: getSupabase async olduÄŸu iÃ§in burada await kullanamayÄ±z (sync fonksiyon)
  // Bu yÃ¼zden direkt window.supabase'i kontrol edelim
  if(window.supabase && window.supabase.auth){
    window.auth = window.supabase.auth;
    return window.supabase.auth;
  }
  return null;
  
  // Supabase auth'u window.auth olarak set et
  if(supabase.auth){
    window.auth = supabase.auth;
    return supabase.auth;
  }
  
  return null;
};

// escapeHtml ve normalizeUrl ortak.js'den geliyor
// showToast ortak.js'den geliyor (window.showToast)

/* ===== Nav - ortak.js'den geliyor ===== */
// fetchPanels ve renderNav ortak.js'den geliyor
// initAppShell ortak.js'den geliyor

/* ===== Tabs ===== */
function setActiveTab(activeId){
  ["tabAdd","tabMan","tabList"].forEach(id=>{
    const btn=$("#"+id);
    if(btn){
      if(id===activeId){
        btn.style.background="var(--brand)";
        btn.style.color="#fff";
      }else{
        btn.style.background="";
        btn.style.color="";
      }
    }
  });
}
$("#tabAdd").onclick=()=>{ 
  setActiveTab("tabAdd");
  $("#viewAdd").style.display="block"; 
  $("#viewMan").style.display="none"; 
  $("#viewList").style.display="none"; 
};
$("#tabMan").onclick=()=>{ 
  setActiveTab("tabMan");
  $("#viewAdd").style.display="none"; 
  $("#viewMan").style.display="block"; 
  $("#viewList").style.display="none"; 
};
$("#tabList").onclick=()=>{ 
  console.log('ğŸ”µ KullanÄ±cÄ±lar sekmesine tÄ±klandÄ±');
  console.log('ğŸ”µ USERS durumu:', USERS?.length || 0, 'kullanÄ±cÄ±');
  
  setActiveTab("tabList");
  $("#viewAdd").style.display="none"; 
  $("#viewMan").style.display="none"; 
  $("#viewList").style.display="block";
  
  // Sayfa gÃ¶rÃ¼nÃ¼mÃ¼nÃ¼ gizle, kullanÄ±cÄ± gÃ¶rÃ¼nÃ¼mÃ¼nÃ¼ gÃ¶ster
  const sayfaWrap = $("#sayfaWrap");
  const usersWrap = $("#usersCardsWrap");
  
  if(sayfaWrap) sayfaWrap.style.display = "none";
  if(usersWrap) {
    usersWrap.style.display = "grid";
    console.log('âœ… usersCardsWrap gÃ¶rÃ¼nÃ¼r yapÄ±ldÄ±');
  }
  
  // Hangi gÃ¶rÃ¼nÃ¼m aktifse ona gÃ¶re render et
  const isSayfa = sayfaWrap && (sayfaWrap.style.display==="grid" || sayfaWrap.style.display==="block");
  
  if(isSayfa) {
    renderSayfa();
  } else {
    // KullanÄ±cÄ±larÄ± yeniden render et
    if(USERS && USERS.length > 0){
      console.log('âœ… USERS var, renderUsers Ã§aÄŸrÄ±lÄ±yor');
      renderUsers();
    } else {
      console.warn('âš ï¸ USERS boÅŸ, loadUsers Ã§aÄŸrÄ±lÄ±yor');
      // EÄŸer veri yoksa yeniden yÃ¼kle
      loadUsers().catch(err => {
        console.error('KullanÄ±cÄ±lar yÃ¼klenirken hata:', err);
      });
    }
  }
};


/* ===== Manifest & Permission Trees ===== */
let manifest={};

function renderPermTree(targetSel, selected=[]){
  const wrap=document.createElement("div");
  const selectedSet=new Set((selected||[]).map(s=>String(s).trim()));
  Object.keys(manifest).sort((a,b)=>(manifest[a].order||0)-(manifest[b].order||0)).forEach(panelKey=>{
    const grp=document.createElement("div"); grp.className="perm-group"; grp.dataset.group=panelKey;
    
    // GÃ¼venli DOM oluÅŸturma (innerHTML yerine)
    const head=document.createElement("div"); head.className="perm-head";
    const titleDiv=document.createElement("div");
    const titleB=document.createElement("b"); titleB.textContent=manifest[panelKey].title || panelKey;
    const pill=document.createElement("span"); pill.className="pill"; pill.textContent=panelKey;
    titleDiv.appendChild(titleB); titleDiv.appendChild(document.createTextNode(" ")); titleDiv.appendChild(pill);
    
    const btnSpan=document.createElement("span"); btnSpan.className="mini";
    const btnAll=document.createElement("button"); btnAll.type="button"; btnAll.className="btn"; btnAll.dataset.gsel=panelKey; btnAll.textContent="Hepsi";
    const btnClr=document.createElement("button"); btnClr.type="button"; btnClr.className="btn"; btnClr.dataset.gclr=panelKey; btnClr.textContent="Temizle";
    btnSpan.appendChild(btnAll); btnSpan.appendChild(btnClr);
    head.appendChild(titleDiv); head.appendChild(btnSpan);
    
    const grid=document.createElement("div"); grid.className="perm-grid";
    (manifest[panelKey].pages||[]).forEach(p=>{
      const val=p.key || `${panelKey}: ${p.title}`;
      const label=document.createElement("label"); label.className="perm-item";
      const chk=document.createElement("input"); chk.type="checkbox"; chk.value=val;
      if(selectedSet.has(val)) chk.checked=true;
      const span=document.createElement("span"); span.textContent=p.title || '';
      label.appendChild(chk); label.appendChild(span);
      grid.appendChild(label);
    });
    
    grp.appendChild(head); grp.appendChild(grid);
    wrap.appendChild(grp);
  });
  const target=$(targetSel); if(target){ target.innerHTML=''; target.appendChild(wrap); }

  // Grup butonlarÄ±
  target.querySelectorAll("[data-gsel]").forEach(btn=>{
    btn.onclick=()=>{ const g=btn.dataset.gsel; target.querySelectorAll(`.perm-group[data-group="${g}"] input`).forEach(c=>c.checked=true); };
  });
  target.querySelectorAll("[data-gclr]").forEach(btn=>{
    btn.onclick=()=>{ const g=btn.dataset.gclr; target.querySelectorAll(`.perm-group[data-group="${g}"] input`).forEach(c=>c.checked=false); };
  });
}
const getChecked = root => Array.from(document.querySelectorAll(`${root} input[type=checkbox]:checked`)).map(i=>i.value);

function fillPanelSelect(){
  const sel=$("#s_panel"); 
  if(!sel) return;
  const keys=Object.keys(manifest).sort((a,b)=> (manifest[a].order||0)-(manifest[b].order||0));
  sel.innerHTML = '';
  const escape = typeof window.escapeHtml === 'function' ? window.escapeHtml : (t => String(t || ''));
  keys.forEach(k=>{
    const opt = document.createElement('option');
    opt.value = escape(k);
    opt.textContent = `${manifest[k].title} (${k})`;
    sel.appendChild(opt);
  });
}
function renderManifestAdmin(){
  const box=$("#manifestList");
  if(!box) return;
  if(!Object.keys(manifest).length){
    box.innerHTML='<div class="pill">HenÃ¼z panel yok.</div>';
    return;
  }
  box.innerHTML="";
  Object.keys(manifest).sort((a,b)=> (manifest[a].order||0)-(manifest[b].order||0)).forEach(k=>{
    const p=manifest[k];
    const it=document.createElement("div"); it.className="perm-group";
    
    // GÃ¼venli DOM oluÅŸturma
    const head=document.createElement("div"); head.className="perm-head";
    const titleDiv=document.createElement("div");
    const titleB=document.createElement("b"); titleB.textContent=p.title||k;
    const pill=document.createElement("span"); pill.className="pill"; pill.textContent=k;
    titleDiv.appendChild(titleB); titleDiv.appendChild(document.createTextNode(" ")); titleDiv.appendChild(pill);
    
    const delBtn=document.createElement("button"); delBtn.className="btn"; delBtn.dataset.delPanel=k; delBtn.textContent="Paneli Sil";
    head.appendChild(titleDiv); head.appendChild(delBtn);
    it.appendChild(head);
    
    if(p.pages && p.pages.length > 0){
      p.pages.forEach(pg=>{
        const pageDiv=document.createElement("div");
        pageDiv.className="mini";
        pageDiv.style.justifyContent="space-between";
        pageDiv.style.border="1px solid var(--stroke)";
        pageDiv.style.borderRadius="10px";
        pageDiv.style.padding="8px";
        pageDiv.style.background="var(--surface)";
        pageDiv.style.marginBottom="6px";
        
        const leftDiv=document.createElement("div");
        const pgTitle=document.createElement("b"); pgTitle.textContent=pg.title||"";
        const pgPill=document.createElement("span"); pgPill.className="pill"; pgPill.style.marginLeft="6px"; pgPill.textContent=pg.path||"";
        leftDiv.appendChild(pgTitle); leftDiv.appendChild(document.createTextNode(" ")); leftDiv.appendChild(pgPill);
        
        const btnSpan=document.createElement("span"); btnSpan.className="mini";
        const editData=JSON.stringify({panel:k,key:pg.key||`${k}: ${pg.title}`});
        const editBtn=document.createElement("button"); editBtn.className="btn"; editBtn.dataset.editPage=editData; editBtn.textContent="DÃ¼zenle";
        const delPageBtn=document.createElement("button"); delPageBtn.className="btn"; delPageBtn.dataset.delPage=editData; delPageBtn.textContent="Sil";
        btnSpan.appendChild(editBtn); btnSpan.appendChild(delPageBtn);
        
        pageDiv.appendChild(leftDiv); pageDiv.appendChild(btnSpan);
        it.appendChild(pageDiv);
      });
    }else{
      const noPage=document.createElement("div"); noPage.className="pill"; noPage.textContent="Sayfa yok.";
      it.appendChild(noPage);
    }
    
    box.appendChild(it);
  });

  box.querySelectorAll("[data-del-panel]").forEach(b=>{
    b.onclick=async()=>{ 
      if(!confirm("Panel silinsin mi?")) return; 
      const supabase = await getSupabase(); 
      if(!supabase) { 
        if(typeof window.showToast==='function') window.showToast('error','Hata','Supabase baÄŸlantÄ±sÄ± yok'); 
        return; 
      }
      const { error } = await supabase.from('sayfa_manifesti').delete().eq('id', b.dataset.delPanel);
      if(error) {
        console.error('Panel silme hatasÄ±:', error);
        if(typeof window.showToast==='function') window.showToast('error','Hata','Panel silinemedi');
      } else {
        if(typeof window.showToast==='function') window.showToast('success','BaÅŸarÄ±lÄ±','Panel silindi');
      }
    };
  });
  box.querySelectorAll("[data-del-page]").forEach(b=>{
    b.onclick=async()=>{ 
      const d=JSON.parse(b.dataset.delPage);
      const supabase = await getSupabase(); 
      if(!supabase) { 
        if(typeof window.showToast==='function') window.showToast('error','Hata','Supabase baÄŸlantÄ±sÄ± yok'); 
        return; 
      }
      const { data: doc, error: fetchError } = await supabase.from('sayfa_manifesti').select('id, order, title, pages').eq('id', d.panel).single();
      if(fetchError || !doc) {
        if(typeof window.showToast==='function') window.showToast('error','Hata','Panel bulunamadÄ±');
        return;
      }
      const arr = Array.isArray(doc.pages) ? doc.pages.filter(x=>(x.key||`${d.panel}: ${x.title}`)!==d.key) : [];
      const { error } = await supabase.from('sayfa_manifesti').update({pages: arr}).eq('id', d.panel);
      if(error) {
        console.error('Sayfa silme hatasÄ±:', error);
        if(typeof window.showToast==='function') window.showToast('error','Hata','Sayfa silinemedi');
      } else {
        if(typeof window.showToast==='function') window.showToast('success','BaÅŸarÄ±lÄ±','Sayfa silindi');
      }
    };
  });
  box.querySelectorAll("[data-edit-page]").forEach(b=>{
    b.onclick=async()=>{
      console.log('ğŸ”µ Sayfa dÃ¼zenle butonuna tÄ±klandÄ±, data:', b.dataset.editPage);
      try{
        const d=JSON.parse(b.dataset.editPage);
        console.log('ğŸ”µ Parse edilen data:', d);
        const supabase = await getSupabase(); 
        if(!supabase) {
          if(typeof window.showToast==='function') window.showToast('error','Hata','Supabase baÄŸlantÄ±sÄ± yok');
          return;
        }
        const { data: doc, error: fetchError } = await supabase.from('sayfa_manifesti').select('id, order, title, pages').eq('id', d.panel).single();
        if(fetchError || !doc){
          console.error('âŒ Panel bulunamadÄ±:', fetchError);
          if(typeof window.showToast==='function') window.showToast('warning','UyarÄ±','Panel bulunamadÄ±');
          return;
        }
        const pages = Array.isArray(doc.pages) ? doc.pages : [];
        const pg=pages.find(x=>(x.key||`${d.panel}: ${x.title}`)===d.key);
        if(!pg){
          console.error('âŒ Sayfa bulunamadÄ±, key:', d.key);
          if(typeof window.showToast==='function') window.showToast('warning','UyarÄ±','Sayfa bulunamadÄ±');
          return;
        }
        
        // Modal'Ä± doldur ve aÃ§
        if(!mEditPage){
          console.error('âŒ mEditPage modal elementi bulunamadÄ±');
          if(typeof window.showToast==='function') window.showToast('error','Hata','Modal elementi bulunamadÄ±');
          return;
        }
        
        const epPanel=$("#ep_panel"), epKey=$("#ep_key"), epPanelName=$("#ep_panelName"), epTitle=$("#ep_title"), epPath=$("#ep_path"), epOrder=$("#ep_order");
        if(epPanel) epPanel.value=d.panel||"";
        if(epKey) epKey.value=d.key||"";
        if(epPanelName) epPanelName.value=manifest[d.panel]?.title || d.panel||"";
        if(epTitle) epTitle.value=pg.title||"";
        if(epPath) epPath.value=pg.path||"";
        if(epOrder) epOrder.value=pg.order||0;
        
        console.log('âœ… Modal aÃ§Ä±lÄ±yor (mEditPage)');
        mEditPage.classList.add('open');
        console.log('âœ… Modal aÃ§Ä±ldÄ±, classList:', mEditPage.classList.toString());
      }catch(e){
        console.error('Sayfa dÃ¼zenleme hatasÄ±:', e);
        if(typeof window.showToast==='function') window.showToast('error','Hata',e?.message||'Bilinmeyen hata');
      }
    };
  });
}

/* ===== Sayfa DÃ¼zenle Modal (erken tanÄ±m - renderManifestAdmin'de kullanÄ±lÄ±yor) ===== */
const mEditPage=$("#mEditPage");

/* ===== Manifest actions ===== */
$("#btnPanelSave").onclick=async(e)=>{
  e.preventDefault();
  const key=$("#p_key").value.trim(), title=$("#p_title").value.trim(), order=parseInt($("#p_order").value||"0");
  if(!key||!title){ if(typeof window.showToast==='function') window.showToast('warning','UyarÄ±','Panel anahtar/baÅŸlÄ±k gerekli'); return; }
  const supabase = await getSupabase(); 
  if(!supabase) { 
    if(typeof window.showToast==='function') window.showToast('error','Hata','Supabase baÄŸlantÄ±sÄ± yok'); 
    return; 
  }
  const { error } = await supabase.from('sayfa_manifesti').upsert({id: key, title, order: order}, {onConflict: 'id'});
  if(error) {
    console.error('Panel kaydetme hatasÄ±:', error);
    if(typeof window.showToast==='function') window.showToast('error','Hata','Panel kaydedilemedi');
  } else {
    $("#frmPanel").reset(); 
    if(typeof window.showToast==='function') window.showToast('success','BaÅŸarÄ±lÄ±','Panel kaydedildi');
  }
};
$("#btnQuickPanels").onclick=async()=>{
  if(!confirm("Standart paneller eklensin mi?")) return;
  const panels=[{id:"Admin",title:"Admin Paneli",order:5},{id:"Talebe",title:"Talebe Paneli",order:10},{id:"Personel",title:"Personel Paneli",order:20},{id:"Nehari",title:"Nehari Paneli",order:30},{id:"Kermes",title:"Kermes Paneli",order:40},{id:"Muhasebe",title:"Muhasebe Paneli",order:50},{id:"Sistem AyarlarÄ±",title:"Sistem AyarlarÄ±",order:60},];
  const supabase = await getSupabase(); 
  if(!supabase) { 
    if(typeof window.showToast==='function') window.showToast('error','Hata','Supabase baÄŸlantÄ±sÄ± yok'); 
    return; 
  }
  const { error } = await supabase.from('sayfa_manifesti').upsert(panels, {onConflict: 'id'});
  if(error) {
    console.error('Paneller ekleme hatasÄ±:', error);
    if(typeof window.showToast==='function') window.showToast('error','Hata','Paneller eklenemedi');
  } else {
    if(typeof window.showToast==='function') window.showToast('success','BaÅŸarÄ±lÄ±','Paneller eklendi');
  }
};
$("#btnPageAdd").onclick=async(e)=>{
  e.preventDefault();
  const panel=$("#s_panel").value, title=$("#s_title").value.trim(), path=$("#s_path").value.trim(), order=parseInt($("#s_order").value||"9999");
  if(!panel||!title||!path){ if(typeof window.showToast==='function') window.showToast('warning','UyarÄ±','Panel, baÅŸlÄ±k ve path zorunlu'); return; }
  const supabase = await getSupabase(); 
  if(!supabase) { 
    if(typeof window.showToast==='function') window.showToast('error','Hata','Supabase baÄŸlantÄ±sÄ± yok'); 
    return; 
  }
  const { data: doc, error: fetchError } = await supabase.from('sayfa_manifesti').select('id, order, title, pages').eq('id', panel).single();
  const cur = doc || {pages:[]};
  const key=`${panel}: ${title}`;
  const map=new Map((Array.isArray(cur.pages)?cur.pages:[]).map(p=>[(p.key||`${panel}: ${p.title}`), p]));
  map.set(key,{key,title,path,order});
  const merged=[...map.values()].sort((a,b)=>(a.order||0)-(b.order||0) || String(a.title).localeCompare(String(b.title),"tr"));
  const { error } = await supabase.from('sayfa_manifesti').update({pages:merged}).eq('id', panel);
  if(error) {
    console.error('Sayfa ekleme hatasÄ±:', error);
    if(typeof window.showToast==='function') window.showToast('error','Hata','Sayfa eklenemedi');
  } else {
    $("#frmPage").reset(); fillPanelSelect(); 
    if(typeof window.showToast==='function') window.showToast('success','BaÅŸarÄ±lÄ±','Sayfa eklendi');
  }
};

/* ===== Sayfa DÃ¼zenle Modal (devam - mEditPage yukarÄ±da tanÄ±mlandÄ±) ===== */
if(mEditPage){
  // Backdrop'a tÄ±klanÄ±nca kapat (modal element'ine tÄ±klanÄ±nca)
  mEditPage.onclick=(e)=>{
    if(e.target===mEditPage) mEditPage.classList.remove('open');
  };
}
if($("#btnEditPageClose")){
  $("#btnEditPageClose").onclick=()=>{
    if(mEditPage) mEditPage.classList.remove('open');
  };
}

/* ===== Åifre GÃ¶sterim Modal ===== */
const mPasswordShow = $("#mPasswordShow");
if(mPasswordShow){
  // Backdrop'a tÄ±klanÄ±nca kapat
  mPasswordShow.onclick=(e)=>{
    if(e.target===mPasswordShow) mPasswordShow.classList.remove('open');
  };
}
if($("#btnPasswordClose")){
  $("#btnPasswordClose").onclick=()=>{
    if(mPasswordShow) mPasswordShow.classList.remove('open');
  };
}
if($("#btnPasswordCopy")){
  $("#btnPasswordCopy").onclick=async()=>{
    const password = $("#passwordShowSifre")?.textContent?.trim();
    if(!password || password === 'â€”' || password === 'Åifre kaydÄ± bulunamadÄ±'){
      if(typeof window.showToast==='function') window.showToast('warning','UyarÄ±','Kopyalanacak ÅŸifre yok');
      return;
    }
    try{
      await navigator.clipboard.writeText(password);
      if(typeof window.showToast==='function') window.showToast('success','BaÅŸarÄ±lÄ±','Åifre panoya kopyalandÄ±');
    }catch(e){
      console.error('Kopyalama hatasÄ±:', e);
      // Fallback: Manuel kopyalama
      const textArea = document.createElement('textarea');
      textArea.value = password;
      textArea.style.position = 'fixed';
      textArea.style.opacity = '0';
      document.body.appendChild(textArea);
      textArea.select();
      try{
        document.execCommand('copy');
        if(typeof window.showToast==='function') window.showToast('success','BaÅŸarÄ±lÄ±','Åifre panoya kopyalandÄ±');
      }catch(fallbackError){
        if(typeof window.showToast==='function') window.showToast('error','Hata','Åifre kopyalanamadÄ±');
      }
      document.body.removeChild(textArea);
    }
  };
}

/* ===== Åifre SÄ±fÄ±rla Modal Event Handler'larÄ± ===== */
const mPasswordReset = $("#mPasswordReset");
if(mPasswordReset){
  // Backdrop'a tÄ±klanÄ±nca kapat
  mPasswordReset.onclick=(e)=>{
    if(e.target===mPasswordReset) mPasswordReset.classList.remove('open');
  };
}
if($("#btnPasswordResetClose")){
  $("#btnPasswordResetClose").onclick=()=>{
    if(mPasswordReset) mPasswordReset.classList.remove('open');
  };
}
if($("#btnPasswordResetSave")){
  $("#btnPasswordResetSave").onclick=()=>{
    savePasswordReset();
  };
}
if($("#togglePasswordReset")){
  $("#togglePasswordReset").onclick=()=>{
    const input = $("#passwordResetInput");
    if(input) input.type = input.type==="password" ? "text" : "password";
  };
}
if($("#btnPasswordResetGen")){
  $("#btnPasswordResetGen").onclick=()=>{
    const input = $("#passwordResetInput");
    if(input){
      const chars="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()_+";
      const rnd=(len)=>Array.from(crypto.getRandomValues(new Uint32Array(len))).map(n=>chars[n%chars.length]).join("");
      input.value=rnd(12);
      renderPasswordResetMeter();
      if(typeof window.showToast==='function') window.showToast('success','BaÅŸarÄ±lÄ±','Rastgele ÅŸifre oluÅŸturuldu');
    }
  };
}
if($("#btnEditPageSave")){
  $("#btnEditPageSave").onclick=async()=>{
    const btn=$("#btnEditPageSave");
    const originalText=btn.textContent;
    btn.disabled=true;
    btn.textContent='â³ GÃ¼ncelleniyor...';
    
    try{
      const panel=$("#ep_panel")?.value||"";
      const key=$("#ep_key")?.value||"";
      const title=$("#ep_title")?.value.trim()||"";
      const path=$("#ep_path")?.value.trim()||"";
      const order=parseInt($("#ep_order")?.value||"0");
      
      if(!panel || !key || !title || !path){
        throw new Error('TÃ¼m alanlar zorunludur');
      }
      
      const supabase = await getSupabase(); 
      if(!supabase) throw new Error('Supabase baÄŸlantÄ±sÄ± yok');
      
      const { data: doc, error: fetchError } = await supabase.from('sayfa_manifesti').select('id, order, title, pages').eq('id', panel).single();
      if(fetchError || !doc){
        throw new Error('Panel bulunamadÄ±');
      }
      
      const pages = Array.isArray(doc.pages) ? doc.pages : [];
      const updatedPages=pages.map(p=>{
        const pKey=p.key||`${panel}: ${p.title}`;
        if(pKey===key){
          return {key,title,path,order};
        }
        return p;
      }).sort((a,b)=>(a.order||0)-(b.order||0) || String(a.title).localeCompare(String(b.title),"tr"));
      
      const { error: updateError } = await supabase.from('sayfa_manifesti').update({pages:updatedPages}).eq('id', panel);
      if(updateError) throw updateError;
      
      if(mEditPage) mEditPage.classList.remove('open');
      if(typeof window.showToast==='function') window.showToast('success','BaÅŸarÄ±lÄ±','Sayfa gÃ¼ncellendi');
    }catch(e){
      console.error('Sayfa gÃ¼ncelleme hatasÄ±:', e);
      if(typeof window.showToast==='function') window.showToast('error','Hata',e?.message||e||'Bilinmeyen hata');
    }finally{
      btn.disabled=false;
      btn.textContent=originalText;
    }
  };
}

/* ===== Password meter ===== */
const pw=$("#sifre"), meterBar=$("#meterBar"), pwLabel=$("#pwLabel");
function scorePw(p){ let s=0; if(p.length>=8) s++; if(/[A-Z]/.test(p)) s++; if(/[0-9]/.test(p)) s++; if(/[^A-Za-z0-9]/.test(p)) s++; return s; }
function renderMeter(){ if(!pw || !meterBar || !pwLabel) return; const s=scorePw(pw.value||""); let w=0,c="#ef4444",t="ZayÄ±f"; if(s<=1){w=25}else if(s<=3){w=60;c="#f59e0b";t="Ä°yi"} else {w=100;c="#22c55e";t="GÃ¼Ã§lÃ¼"} meterBar.style.width=w+"%"; meterBar.style.background=c; pwLabel.textContent="GÃ¼Ã§: "+t; }
if(pw && meterBar && pwLabel){ pw.addEventListener("input",renderMeter); renderMeter(); }
if($("#togglePw") && pw){ $("#togglePw").onclick=()=>{ if(pw) pw.type = pw.type==="password" ? "text" : "password"; }; }
if($("#btnPwGen") && pw){ $("#btnPwGen").onclick=()=>{ const chars="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()_+"; const rnd=(len)=>Array.from(crypto.getRandomValues(new Uint32Array(len))).map(n=>chars[n%chars.length]).join(""); if(pw) pw.value=rnd(12); renderMeter(); if(typeof window.showToast==='function') window.showToast('success','BaÅŸarÄ±lÄ±','Rastgele ÅŸifre oluÅŸturuldu'); }; }
if($("#email")){
  $("#email").addEventListener("input",()=>{
    const v=$("#email").value.trim();
    const hint=$("#emailHint");
    if(hint){
      if(!v){
        hint.textContent = "â€”";
      } else {
        // Email regex dÃ¼zeltmesi (\\ yerine \)
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        hint.textContent = emailRegex.test(v) ? "âœ”ï¸ geÃ§erli gÃ¶rÃ¼nÃ¼yor" : "âš ï¸ geÃ§ersiz e-posta";
      }
    }
  });
}

/* ===== Ã–nizleme & Ekle ===== */
const mPrev=$("#mPrev");
if(mPrev){
  // Backdrop'a tÄ±klanÄ±nca kapat
  mPrev.onclick=(e)=>{
    if(e.target===mPrev) mPrev.classList.remove('open');
  };
}
if($("#btnPreview")){
  $("#btnPreview").onclick=()=>{
    const yetkiler=getChecked("#permTreeAdd");
    const content=$("#prevContent");
    if(content){
      // GÃ¼venli DOM oluÅŸturma
      content.innerHTML='';
      const div=document.createElement("div"); div.className="mini"; div.style.flexDirection="column"; div.style.gap="6px";
      const fields=[
        ["Ad Soyad", $("#adSoyad")?.value||"-"],
        ["Rol", $("#rol")?.value||"-"],
        ["GÃ¶rev", $("#gorev")?.value||"-"],
        ["E-posta", $("#email")?.value||"-"],
        ["Yetkiler", yetkiler.length? yetkiler.join(", "):"â€”"]
      ];
      fields.forEach(([label,value])=>{
        const row=document.createElement("div");
        const b=document.createElement("b"); b.textContent=label+": ";
        row.appendChild(b);
        row.appendChild(document.createTextNode(String(value)));
        div.appendChild(row);
      });
      content.appendChild(div);
    }
    if(mPrev) mPrev.classList.add('open');
  };
}
if($("#btnPrevClose")){
  $("#btnPrevClose").onclick=()=> { if(mPrev) mPrev.classList.remove('open'); };
}
$("#frmAdd").addEventListener("submit",(e)=>{ e.preventDefault(); $("#btnPreview").click(); });

// Yetki gÃ¼ncellemesi maili gÃ¶nderme fonksiyonu
async function sendPermissionUpdateEmail(email, adSoyad, eskiRol, yeniRol, eskiGorev, yeniGorev, eskiYetkiler, yeniYetkiler){
  try {
    const supabase = await getSupabase();
    if(!supabase){
      throw new Error('Supabase baÄŸlantÄ±sÄ± yok');
    }
    
    const { data: edgeData, error: edgeError } = await supabase.functions.invoke('send-permission-update', {
      body: {
        to: email,
        adSoyad,
        eskiRol: eskiRol || undefined,
        yeniRol: yeniRol || undefined,
        eskiGorev: eskiGorev || undefined,
        yeniGorev: yeniGorev || undefined,
        eskiYetkiler: eskiYetkiler || undefined,
        yeniYetkiler: yeniYetkiler || undefined
      }
    });

    if(edgeError){
      // 403 hatasÄ± genellikle Edge Function'Ä±n deploy edilmemiÅŸ olmasÄ±ndan kaynaklanÄ±r
      if(edgeError.status === 403 || edgeError.message?.includes('403')){
        console.warn('âš ï¸ Edge Function deploy edilmemiÅŸ veya eriÅŸim reddedildi (403). Edge Function\'Ä± deploy edin: send-permission-update');
      } else {
        console.warn('âš ï¸ Yetki gÃ¼ncelleme maili gÃ¶nderilemedi:', edgeError);
      }
      return false;
    }

    if(edgeData){
      console.log('âœ… Yetki gÃ¼ncelleme maili gÃ¶nderildi:', edgeData);
      return true;
    }
    return false;
  } catch(e){
    console.error('Yetki gÃ¼ncelleme maili gÃ¶nderme hatasÄ±:', e);
    return false;
  }
}

// KullanÄ±cÄ± oluÅŸturma artÄ±k Edge Function (admin-create-user) ile yapÄ±lÄ±yor
// Bu fonksiyon kaldÄ±rÄ±ldÄ± - Edge Function Admin API kullanarak kullanÄ±cÄ± oluÅŸturur

// Mail gÃ¶nderme artÄ±k Edge Function (admin-create-user) iÃ§inde yapÄ±lÄ±yor
// Bu fonksiyon kaldÄ±rÄ±ldÄ±
if($("#btnPrevOk")){
  $("#btnPrevOk").onclick=async()=>{
    // Modal'Ä± hemen kapat (iÅŸlem baÅŸlar baÅŸlamaz)
    if(mPrev) mPrev.classList.remove('open');
    
    const btn=$("#btnPrevOk");
    const originalText=btn.textContent;
    btn.disabled=true;
    btn.textContent='â³ Kaydediliyor...';
    
    try{
      console.log('ğŸ”µ AdÄ±m 1: Form verileri alÄ±nÄ±yor...');
      const adSoyad=$("#adSoyad")?.value.trim()||"", email=$("#email")?.value.trim()||"", sifre=$("#sifre")?.value||"", rol=$("#rol")?.value||"", gorev=$("#gorev")?.value.trim()||"";
      const yetkiler=getChecked("#permTreeAdd");
      console.log('âœ… AdÄ±m 1 tamamlandÄ± - Form verileri:', { adSoyad, email, rol, gorev, yetkilerLength: yetkiler?.length || 0 });
      
      // Input validasyonu
      console.log('ğŸ”µ AdÄ±m 2: Input validasyonu yapÄ±lÄ±yor...');
      if(!adSoyad || adSoyad.length < 2){
        throw new Error('Ad Soyad en az 2 karakter olmalÄ±');
      }
      if(!email){
        throw new Error('E-posta gerekli');
      }
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if(!emailRegex.test(email)){
        throw new Error('GeÃ§ersiz e-posta formatÄ±');
      }
      if(!sifre || sifre.length < 6){
        throw new Error('Åifre en az 6 karakter olmalÄ±');
      }
      if(!rol){
        throw new Error('Rol seÃ§ilmelidir');
      }
      if(!gorev || gorev.length < 2){
        throw new Error('GÃ¶rev en az 2 karakter olmalÄ±');
      }
      console.log('âœ… AdÄ±m 2 tamamlandÄ± - Validasyon baÅŸarÄ±lÄ±');
      
      console.log('ğŸ”µ AdÄ±m 3: Supabase client alÄ±nÄ±yor...');
      const supabase = await getSupabase();
      if(!supabase){
        throw new Error('Supabase baÄŸlantÄ±sÄ± yok');
      }
      console.log('âœ… AdÄ±m 3 tamamlandÄ± - Supabase client alÄ±ndÄ±');
      
      // TÃ¼m iÅŸlemler Edge Function Ã¼zerinden yapÄ±lacak (yeni kullanÄ±cÄ± ve gÃ¼ncelleme)
      // Edge Function service role key kullanÄ±r, bu yÃ¼zden admin session korunur
      console.log('ğŸ”µ AdÄ±m 4: Edge Function Ã§aÄŸrÄ±lÄ±yor (yeni kullanÄ±cÄ± veya gÃ¼ncelleme)...');
      
      // Admin UID'sini al (ÅŸifre kaydÄ± iÃ§in)
      const { data: { user: adminUser } } = await supabase.auth.getUser();
      const adminUid = adminUser?.id || null;
      
      // Debug: GÃ¶nderilen veriyi konsola yazdÄ±r
      const requestBody = {
        email: email,
        password: sifre,
        adSoyad: adSoyad,
        rol: rol,
        gorev: gorev,
        yetkiler: yetkiler || [],
        adminUid: adminUid
      };
      console.log('ğŸ“¤ AdÄ±m 4a - GÃ¶nderilen Veri:', requestBody);
      
      // Edge Function'Ä± Ã§aÄŸÄ±r - body direkt obje olarak gÃ¶nder (Supabase SDK otomatik JSON'a Ã§evirir)
      const { data: edgeData, error: edgeError } = await supabase.functions.invoke('admin-create-user', {
        body: requestBody
      });
      console.log('âœ… AdÄ±m 4b tamamlandÄ± - Edge Function yanÄ±tÄ± alÄ±ndÄ±');
      
      if(edgeError){
        console.error('âŒ Edge Function hatasÄ± (tam obje):', edgeError);
        console.error('âŒ Edge Function hatasÄ± (message):', edgeError.message);
        console.error('âŒ Edge Function hatasÄ± (status):', edgeError.status);
        console.error('âŒ Edge Function hatasÄ± (context):', edgeError.context);
        
        // Hata mesajÄ±nÄ± detaylandÄ±r
        let errorMessage = 'KullanÄ±cÄ± iÅŸlemi baÅŸarÄ±sÄ±z';
        
        // Ã–nce error.message'i kontrol et
        if(edgeError.message){
          errorMessage = edgeError.message;
        }
        
        // Edge Function'dan gelen hata detaylarÄ±nÄ± kontrol et
        if(edgeError.context){
          console.log('ğŸ” Error context iÃ§eriÄŸi:', edgeError.context);
          
          // Context iÃ§inde body olabilir (ReadableStream veya string)
          if(edgeError.context.body){
            try {
              let errorBodyText;
              
              // EÄŸer ReadableStream ise text() ile oku
              if(edgeError.context.body && typeof edgeError.context.body.getReader === 'function'){
                console.log('ğŸ“‹ Error body ReadableStream olarak algÄ±landÄ±, text() ile okunuyor...');
                const response = new Response(edgeError.context.body);
                errorBodyText = await response.text();
              } else if(typeof edgeError.context.body === 'string'){
                errorBodyText = edgeError.context.body;
              } else {
                errorBodyText = JSON.stringify(edgeError.context.body);
              }
              
              // Text'i JSON'a parse et
              const errorBody = JSON.parse(errorBodyText);
              console.log('ğŸ“‹ Parse edilmiÅŸ hata body:', errorBody);
              
              if(errorBody.error){
                errorMessage = errorBody.error;
                if(errorBody.details){
                  errorMessage += ': ' + errorBody.details;
                }
                if(errorBody.required && Array.isArray(errorBody.required)){
                  errorMessage += ' (Eksik alanlar: ' + errorBody.required.join(', ') + ')';
                }
              }
            } catch(parseError){
              console.warn('âš ï¸ Hata body parse edilemedi:', parseError);
              console.warn('âš ï¸ Raw error body:', edgeError.context.body);
            }
          }
          
          // Context iÃ§inde data da olabilir
          if(edgeError.context.data && !errorMessage.includes(':')){
            try {
              let errorDataText;
              
              // EÄŸer ReadableStream ise text() ile oku
              if(edgeError.context.data && typeof edgeError.context.data.getReader === 'function'){
                const response = new Response(edgeError.context.data);
                errorDataText = await response.text();
              } else if(typeof edgeError.context.data === 'string'){
                errorDataText = edgeError.context.data;
              } else {
                errorDataText = JSON.stringify(edgeError.context.data);
              }
              
              const errorData = JSON.parse(errorDataText);
              
              if(errorData.error){
                errorMessage = errorData.error;
                if(errorData.details){
                  errorMessage += ': ' + errorData.details;
                }
              }
            } catch(parseError){
              console.warn('âš ï¸ Hata data parse edilemedi:', parseError);
            }
          }
        }
        
        console.error('âŒ Son hata mesajÄ±:', errorMessage);
        throw new Error(errorMessage);
      }
      
      console.log('ğŸ”µ AdÄ±m 4c: Edge Function yanÄ±tÄ± kontrol ediliyor...');
      if(!edgeData || !edgeData.success || !edgeData.user){
        console.error('âŒ AdÄ±m 4c hatasÄ± - Edge Function baÅŸarÄ±sÄ±z yanÄ±t:', edgeData);
        throw new Error('KullanÄ±cÄ± iÅŸlemi baÅŸarÄ±sÄ±z: Edge Function baÅŸarÄ±sÄ±z yanÄ±t dÃ¶ndÃ¼');
      }
      
      const uid = edgeData.user.id;
      // Edge Function yeni kullanÄ±cÄ± oluÅŸturduysa success dÃ¶ner, gÃ¼ncelleme yaptÄ±ysa da success dÃ¶ner
      // Edge Function iÃ§inde kontrol yapÄ±lÄ±yor, burada sadece baÅŸarÄ± mesajÄ±nÄ± gÃ¶steriyoruz
      console.log('âœ… AdÄ±m 4c tamamlandÄ± - KullanÄ±cÄ± iÅŸlemi baÅŸarÄ±lÄ± - ID:', uid);
      console.log('âœ… KullanÄ±cÄ± bilgileri:', edgeData.user);
      
      // Åifreyi sakla (form reset edilmeden Ã¶nce)
      const savedPassword = sifre;
      const savedAdSoyad = adSoyad;
      const savedEmail = email;
      
      // Formu temizle ve UI'Ä± gÃ¼ncelle
      console.log('ğŸ”µ AdÄ±m 5: Form temizleniyor ve UI gÃ¼ncelleniyor...');
      if($("#frmAdd")) $("#frmAdd").reset();
      if(typeof renderMeter === 'function') renderMeter();
      renderPermTree("#permTreeAdd");
      console.log('âœ… AdÄ±m 5 tamamlandÄ± - Form temizlendi');
      
      // Åifre modal'Ä±nÄ± aÃ§
      const mPasswordShow = $("#mPasswordShow");
      if(mPasswordShow && savedPassword){
        $("#passwordShowAdSoyad").textContent = savedAdSoyad || 'â€”';
        $("#passwordShowEmail").textContent = savedEmail || 'â€”';
        $("#passwordShowSifre").textContent = savedPassword;
        $("#passwordShowSifre").style.color = 'var(--text)';
        $("#btnPasswordCopy").disabled = false;
        mPasswordShow.classList.add('open');
      }
      
      // BaÅŸarÄ± mesajÄ± gÃ¶ster
      if(typeof window.showToast==='function'){
        window.showToast('success','BaÅŸarÄ±lÄ±','KullanÄ±cÄ± iÅŸlemi baÅŸarÄ±yla tamamlandÄ± ve e-posta gÃ¶nderildi');
      }
      
      // NOT: Edge Function service role key kullanÄ±r, bu yÃ¼zden admin session korunur
      // KullanÄ±cÄ± listesi real-time subscription ile otomatik gÃ¼ncellenecek
      // Admin kullanÄ±cÄ±sÄ± iÅŸlemlerine devam edebilir (session deÄŸiÅŸmez)
      console.log('âœ… TÃ¼m iÅŸlemler baÅŸarÄ±yla tamamlandÄ±');
    }catch(err){
      console.error('âŒ KullanÄ±cÄ± ekleme/gÃ¼ncelleme hatasÄ±:', err);
      console.error('âŒ Hata detaylarÄ±:', {
        message: err?.message,
        stack: err?.stack,
        name: err?.name
      });
      
      // Hata mesajÄ±nÄ± detaylÄ± gÃ¶ster
      const errorMessage = err?.message || String(err) || 'Bilinmeyen hata';
      if(typeof window.showToast==='function'){
        window.showToast('error','Hata', errorMessage);
      } else {
        alert('Hata: ' + errorMessage);
      }
    }finally{
      btn.disabled=false;
      btn.textContent=originalText;
      console.log('ğŸ”š Ä°ÅŸlem sonlandÄ±rÄ±ldÄ± (finally bloÄŸu)');
    }
  };
}

/* ===== KullanÄ±cÄ±lar ===== */
let USERS=[]; let unsubUsers=null;
function normalizeYetkiler(v){ if(Array.isArray(v)) return v.map(s=>String(s).trim()).filter(Boolean); if(typeof v==='string') return v.split(/[,\n;]+/).map(s=>s.trim()).filter(Boolean); return []; }

async function listenUsers(){
  try {
    if(unsubUsers) unsubUsers();
    const supabase = await getSupabase(); 
    if(!supabase) {
      console.warn('âš ï¸ listenUsers: Supabase baÄŸlantÄ±sÄ± yok');
      return;
    }
    
    // Ä°lk yÃ¼kleme
    await loadUsers();
    
    // Real-time subscription (Supabase)
    const channel = supabase.channel('kullanicilar-changes')
      .on('postgres_changes', 
        { event: '*', schema: 'public', table: 'kullanicilar' },
        () => {
          loadUsers().catch(err => {
            console.error('Real-time kullanÄ±cÄ± gÃ¼ncelleme hatasÄ±:', err);
          });
        }
      )
      .subscribe();
    
    unsubUsers = () => {
      try {
        supabase.removeChannel(channel);
      } catch(e) {
        console.error('Channel kaldÄ±rma hatasÄ±:', e);
      }
    };
  } catch(e) {
    console.error('listenUsers fonksiyonu hatasÄ±:', e);
    throw e;
  }
}

async function loadUsers(){
  try {
    const supabase = await getSupabase(); 
    if(!supabase) {
      console.warn('âš ï¸ loadUsers: Supabase baÄŸlantÄ±sÄ± yok');
      return;
    }
    
    const { data, error } = await supabase
      .from('kullanicilar')
      .select('id, adsoyad, email, rol, gorev, aktif, eklenmetarihi, yetkiler')
      .order('eklenmetarihi', { ascending: false });
    
    if(error) {
      console.error('âŒ KullanÄ±cÄ±lar yÃ¼klenemedi:', error);
      // Hata olsa bile boÅŸ liste gÃ¶ster
      USERS = [];
      renderKPIs();
      const wrap=$("#usersCardsWrap");
      if(wrap) {
        wrap.innerHTML='<div class="pill">KullanÄ±cÄ±lar yÃ¼klenemedi. LÃ¼tfen sayfayÄ± yenileyin.</div>';
      }
      return;
    }
    
    USERS = (data || []).map(d => ({
      uid: d.id, 
      adSoyad: d.adsoyad || d.adSoyad, // VeritabanÄ±ndan gelen adsoyad'Ä± adSoyad'a map et
      ...d
    }));
    console.log('âœ… KullanÄ±cÄ±lar yÃ¼klendi:', USERS.length, 'kullanÄ±cÄ±');
    renderKPIs(); 
    // Hangi gÃ¶rÃ¼nÃ¼m aktifse onu render et
    const sayfaWrap=$("#sayfaWrap");
    const isSayfa = sayfaWrap && (sayfaWrap.style.display==="grid" || sayfaWrap.style.display==="block");
    if(isSayfa) renderSayfa(); else renderUsers();
  } catch(e) {
    console.error('loadUsers fonksiyonu hatasÄ±:', e);
    USERS = [];
    renderKPIs();
    const wrap=$("#usersCardsWrap");
    if(wrap) {
      wrap.innerHTML='<div class="pill" style="color:var(--error)">KullanÄ±cÄ±lar yÃ¼klenirken hata oluÅŸtu: ' + (e?.message || 'Bilinmeyen hata') + '</div>';
    }
  }
}
function renderKPIs(){
  const total=USERS.length, active=USERS.filter(u=>u.aktif!==false).length, passive=total-active;
  const panels=Object.keys(manifest).length;
  const pages=Object.values(manifest).reduce((s,p)=>s+(p.pages?.length||0),0);
  
  // Eski Ã¶zet (sidebar)
  if($("#kpiUsers")) $("#kpiUsers").textContent=total;
  if($("#kpiActive")) $("#kpiActive").textContent=active;
  if($("#kpiPassive")) $("#kpiPassive").textContent=passive;
  if($("#kpiPanels")) $("#kpiPanels").textContent=panels;
  if($("#kpiPages")) $("#kpiPages").textContent=pages;
  
  // Yeni inline Ã¶zet (filtrelerin altÄ±nda)
  if($("#kpiUsersInline")) $("#kpiUsersInline").textContent=total;
  if($("#kpiActiveInline")) $("#kpiActiveInline").textContent=active;
  if($("#kpiPassiveInline")) $("#kpiPassiveInline").textContent=passive;
  if($("#kpiPanelsInline")) $("#kpiPanelsInline").textContent=panels;
  if($("#kpiPagesInline")) $("#kpiPagesInline").textContent=pages;
  
  // Ã–zeti gÃ¶ster (her zaman gÃ¶rÃ¼nÃ¼r)
  const summaryInline=$("#summaryCardInline");
  if(summaryInline) summaryInline.style.display="block";
}
if($("#btnSayfa")){
  $("#btnSayfa").onclick=()=>{
    console.log('ğŸ”µ Sayfa butonuna tÄ±klandÄ±');
    $("#usersCardsWrap").style.display="none";
    $("#sayfaWrap").style.display="grid";
    $("#btnSayfa").style.background="var(--brand)";
    $("#btnSayfa").style.color="#fff";
    $("#btnPersonel").style.background="";
    $("#btnPersonel").style.color="";
    
    // Veriler yÃ¼klÃ¼ mÃ¼ kontrol et
    if((!USERS || USERS.length === 0) || (!manifest || Object.keys(manifest).length === 0)){
      console.warn('âš ï¸ Veriler eksik, yÃ¼kleniyor...');
      Promise.all([
        USERS && USERS.length > 0 ? Promise.resolve() : loadUsers(),
        manifest && Object.keys(manifest).length > 0 ? Promise.resolve() : loadManifest()
      ]).then(() => {
        console.log('âœ… Veriler yÃ¼klendi, renderSayfa Ã§aÄŸrÄ±lÄ±yor');
        renderSayfa();
        renderKPIs();
      }).catch(err => {
        console.error('Veri yÃ¼kleme hatasÄ±:', err);
        renderSayfa(); // Yine de render et, hata mesajÄ± gÃ¶sterecek
        renderKPIs();
      });
    } else {
      renderSayfa();
      renderKPIs(); // Ã–zeti gÃ¼ncelle
    }
  };
}
if($("#btnPersonel")){
  $("#btnPersonel").onclick=()=>{
    $("#sayfaWrap").style.display="none";
    $("#usersCardsWrap").style.display="grid";
    $("#btnPersonel").style.background="var(--brand)";
    $("#btnPersonel").style.color="#fff";
    $("#btnSayfa").style.background="";
    $("#btnSayfa").style.color="";
    // KullanÄ±cÄ±larÄ± yeniden render et
    if(USERS && USERS.length > 0){
      renderUsers();
    } else {
      // EÄŸer veri yoksa yeniden yÃ¼kle
      loadUsers().catch(err => {
        console.error('KullanÄ±cÄ±lar yÃ¼klenirken hata:', err);
      });
    }
  };
}
$("#sch").oninput=()=>{ 
  const sayfaWrap = $("#sayfaWrap");
  const isSayfa = sayfaWrap && (sayfaWrap.style.display==="grid" || sayfaWrap.style.display==="block");
  if(isSayfa) renderSayfa(); 
  else {
    if(USERS && USERS.length > 0){
      renderUsers();
    }
  }
}; 
$("#fltRol").onchange=()=>{
  if(USERS && USERS.length > 0){
    renderUsers();
  }
}; 
$("#fltDurum").onchange=()=>{
  if(USERS && USERS.length > 0){
    renderUsers();
  }
}; 
$("#btnRef").onclick=()=>{ 
  const sayfaWrap = $("#sayfaWrap");
  const isSayfa = sayfaWrap && (sayfaWrap.style.display==="grid" || sayfaWrap.style.display==="block");
  if(isSayfa) renderSayfa(); 
  else {
    // Yenile butonuna tÄ±klanÄ±nca verileri yeniden yÃ¼kle
    loadUsers().catch(err => {
      console.error('KullanÄ±cÄ±lar yenilenirken hata:', err);
    });
  }
};

function bindListButtons(scope){
  if(!scope) {
    console.error('âŒ bindListButtons: scope boÅŸ');
    return;
  }
  
  console.log('ğŸ”µ bindListButtons Ã§aÄŸrÄ±ldÄ±, scope:', scope);
  
  // DÃ¼zenle butonlarÄ±
  const editButtons = scope.querySelectorAll("[data-edit]");
  console.log('ğŸ”µ DÃ¼zenle butonlarÄ± bulundu:', editButtons.length);
  editButtons.forEach(b=> {
    console.log('ğŸ”µ DÃ¼zenle butonu baÄŸlanÄ±yor, data-edit:', b.dataset.edit);
    b.onclick=()=> {
      console.log('ğŸ”µ DÃ¼zenle butonuna tÄ±klandÄ±, uid:', b.dataset.edit);
      openEdit(b.dataset.edit);
    };
  });
  
  scope.querySelectorAll("[data-reset]").forEach(b=> {
    b.onclick=()=> {
      console.log('ğŸ”µ Åifre sÄ±fÄ±rla butonuna tÄ±klandÄ±, email:', b.dataset.reset);
      resetPass(b.dataset.reset);
    };
  });
  
  scope.querySelectorAll("[data-show-password]").forEach(b=> {
    b.onclick=()=> {
      console.log('ğŸ”µ Åifre gÃ¶ster butonuna tÄ±klandÄ±, uid:', b.dataset.showPassword);
      showPassword(b.dataset.showPassword);
    };
  });
  
  scope.querySelectorAll("[data-reset-and-save]").forEach(b=> {
    b.onclick=()=> {
      try {
        const userInfo = JSON.parse(b.dataset.resetAndSave);
        console.log('ğŸ”µ Åifre sÄ±fÄ±rla ve kaydet butonuna tÄ±klandÄ±, userInfo:', userInfo);
        resetAndSavePassword(userInfo);
      } catch(e) {
        console.error('âŒ JSON parse hatasÄ±:', e);
        if(typeof window.showToast==='function') window.showToast('error','Hata','Veri parse edilemedi');
      }
    };
  });
  
  scope.querySelectorAll("[data-toggle]").forEach(b=> {
    b.onclick=()=> {
      try {
        const data = JSON.parse(b.dataset.toggle);
        console.log('ğŸ”µ Toggle butonuna tÄ±klandÄ±, data:', data);
        toggleActive(data);
      } catch(e) {
        console.error('âŒ JSON parse hatasÄ±:', e);
        if(typeof window.showToast==='function') window.showToast('error','Hata','Veri parse edilemedi');
      }
    };
  });
  
  scope.querySelectorAll("[data-softdel]").forEach(b=> {
    b.onclick=()=> {
      console.log('ğŸ”µ Sil butonuna tÄ±klandÄ±, uid:', b.dataset.softdel);
      softDelete(b.dataset.softdel);
    };
  });
}

/* ===== Sayfa GÃ¶rÃ¼nÃ¼mÃ¼ ===== */
function renderSayfa(){
  console.log('ğŸ”µ renderSayfa Ã§aÄŸrÄ±ldÄ±');
  console.log('ğŸ”µ USERS.length:', USERS?.length || 0);
  console.log('ğŸ”µ manifest keys:', Object.keys(manifest || {}).length);
  
  const wrap=$("#sayfaWrap");
  if(!wrap) {
    console.error('âŒ sayfaWrap elementi bulunamadÄ±');
    return;
  }
  
  // Veri kontrolÃ¼
  if(!USERS || USERS.length === 0){
    console.warn('âš ï¸ USERS boÅŸ, yÃ¼kleniyor...');
    wrap.innerHTML='<div class="pill" style="text-align:center;padding:40px;grid-column:1/-1">KullanÄ±cÄ±lar yÃ¼kleniyor...</div>';
    loadUsers().catch(err => {
      console.error('KullanÄ±cÄ±lar yÃ¼klenirken hata:', err);
      wrap.innerHTML='<div class="pill" style="text-align:center;padding:40px;grid-column:1/-1;color:var(--error)">KullanÄ±cÄ±lar yÃ¼klenemedi</div>';
    });
    return;
  }
  
  if(!manifest || Object.keys(manifest).length === 0){
    console.warn('âš ï¸ manifest boÅŸ, yÃ¼kleniyor...');
    wrap.innerHTML='<div class="pill" style="text-align:center;padding:40px;grid-column:1/-1">Manifest yÃ¼kleniyor...</div>';
    loadManifest().catch(err => {
      console.error('Manifest yÃ¼klenirken hata:', err);
      wrap.innerHTML='<div class="pill" style="text-align:center;padding:40px;grid-column:1/-1;color:var(--error)">Manifest yÃ¼klenemedi</div>';
    });
    return;
  }
  
  // TÃ¼m sayfalarÄ± topla
  const allPages=[];
  Object.keys(manifest).sort((a,b)=>(manifest[a].order||0)-(manifest[b].order||0)).forEach(panelKey=>{
    const panel=manifest[panelKey];
    (panel.pages||[]).forEach(page=>{
      allPages.push({
        panelKey,
        panelTitle:panel.title||panelKey,
        pageKey:page.key||`${panelKey}: ${page.title}`,
        pageTitle:page.title||'',
        pagePath:page.path||''
      });
    });
  });
  
  console.log('ğŸ”µ Toplam sayfa:', allPages.length);
  
  // Arama filtresi
  const q=$("#sch")?.value.toLowerCase().trim()||"";
  let filteredPages=allPages;
  if(q){
    filteredPages=allPages.filter(p=>
      (p.pageTitle||"").toLowerCase().includes(q) ||
      (p.panelTitle||"").toLowerCase().includes(q) ||
      (p.pagePath||"").toLowerCase().includes(q)
    );
  }
  
  wrap.innerHTML="";
  
  if(!filteredPages.length){
    const div=document.createElement('div');
    div.className="pill";
    div.style.textAlign="center";
    div.style.padding="40px";
    div.style.gridColumn="1 / -1";
    div.textContent=q ? "Arama sonucu bulunamadÄ±" : "Sayfa yok";
    wrap.appendChild(div);
    return;
  }
  
  console.log('âœ… FiltrelenmiÅŸ sayfa sayÄ±sÄ±:', filteredPages.length);
  
  // Her sayfa iÃ§in kart
  filteredPages.forEach(page=>{
    const card=document.createElement('div');
    card.className="sayfa-card";
    
    // Kart baÅŸlÄ±ÄŸÄ±
    const header=document.createElement('div');
    header.className="sayfa-card-header";
    
    const title=document.createElement('div');
    title.className="sayfa-card-title";
    title.textContent=escapeHtml(page.pageTitle);
    header.appendChild(title);
    
    const meta=document.createElement('div');
    meta.className="sayfa-card-meta";
    meta.innerHTML=`
      <span class="pill" style="font-size:11px;padding:4px 8px">${escapeHtml(page.panelTitle)}</span>
      <span style="font-family:monospace;font-size:11px;color:var(--muted)">${escapeHtml(page.pagePath)}</span>
    `;
    header.appendChild(meta);
    card.appendChild(header);
    
    // Personel listesi
    const body=document.createElement('div');
    body.className="sayfa-card-body";
    
    if(USERS.length===0){
      const empty=document.createElement('div');
      empty.className="pill";
      empty.style.textAlign="center";
      empty.style.padding="12px";
      empty.textContent="Personel yok";
      body.appendChild(empty);
    }else{
      USERS.forEach(u=>{
        const item=document.createElement('div');
        item.className="sayfa-personel-item";
        
        const name=document.createElement('div');
        name.className="sayfa-personel-name";
        name.textContent=u.adSoyad||u.email||"";
        name.title=u.email||"";
        item.appendChild(name);
        
        const chk=document.createElement('input');
        chk.type="checkbox";
        chk.className="sayfa-personel-checkbox";
        const yetkiler=Array.isArray(u.yetkiler)?u.yetkiler:[];
        const hasPage=yetkiler.some(y=>{
          const yNorm=String(y||"").trim().toLowerCase();
          const pageKeyNorm=String(page.pageKey||"").trim().toLowerCase();
          return yNorm===pageKeyNorm;
        });
        chk.checked=hasPage;
        
        chk.onchange=async()=>{
          try{
            const supabase = await getSupabase();
            if(!supabase) {
              if(typeof window.showToast==='function') window.showToast('error','Hata','Supabase baÄŸlantÄ±sÄ± yok');
              return;
            }
            let yetkiler=Array.isArray(u.yetkiler)?[...u.yetkiler]:[];
            if(chk.checked){
              if(!yetkiler.includes(page.pageKey)){
                yetkiler.push(page.pageKey);
              }
            }else{
              yetkiler=yetkiler.filter(y=>String(y||"").trim()!==String(page.pageKey||"").trim());
            }
            const { error } = await supabase.from('kullanicilar').update({yetkiler}).eq('id', u.uid);
            if(error) throw error;
            if(typeof window.showToast==='function') window.showToast('success','BaÅŸarÄ±lÄ±',`${u.adSoyad} iÃ§in ${page.pageTitle} ${chk.checked?'aktif':'pasif'} edildi`);
          }catch(e){
            console.error('Yetki gÃ¼ncelleme hatasÄ±:',e);
            chk.checked=!chk.checked;
            if(typeof window.showToast==='function') window.showToast('error','Hata',e?.message||'Bilinmeyen hata');
          }
        };
        
        item.appendChild(chk);
        body.appendChild(item);
      });
    }
    
    card.appendChild(body);
    wrap.appendChild(card);
  });
}

function escapeHtml(text){
  // Sayfa iÃ§i Ã¶zel escapeHtml - window.escapeHtml'i kullanmÄ±yoruz (sonsuz dÃ¶ngÃ¼ Ã¶nleme)
  const div=document.createElement('div');
  div.textContent=String(text||'');
  return div.innerHTML;
}
function renderUsers(){
  console.log('ğŸ”µ renderUsers Ã§aÄŸrÄ±ldÄ±, USERS.length:', USERS?.length || 0);
  
  const q=$("#sch")?.value.toLowerCase().trim()||"", fr=$("#fltRol")?.value||"", fd=$("#fltDurum")?.value||"";
  let list=USERS.slice();
  console.log('ğŸ”µ Filtre Ã¶ncesi liste uzunluÄŸu:', list.length);
  
  if(q) list=list.filter(x=>(x.adSoyad||"").toLowerCase().includes(q) || (x.email||"").toLowerCase().includes(q) || (x.gorev||"").toLowerCase().includes(q));
  if(fr) list=list.filter(x=> (x.rol||"")===fr);
  if(fd!=="") list=list.filter(x=> String(!!x.aktif)===fd);
  
  console.log('ğŸ”µ Filtre sonrasÄ± liste uzunluÄŸu:', list.length);

  const wrap=$("#usersCardsWrap");
  if(!wrap) {
    console.error('âŒ usersCardsWrap elementi bulunamadÄ±');
    return;
  }
  
  wrap.innerHTML="";
  
  if(!list.length){
    console.warn('âš ï¸ FiltrelenmiÅŸ liste boÅŸ');
    const div=document.createElement('div'); 
    div.className="pill"; 
    if(USERS.length === 0){
      div.textContent="KullanÄ±cÄ±lar yÃ¼kleniyor...";
    } else {
      div.textContent="Filtreye uygun kayÄ±t yok";
    }
    wrap.appendChild(div);
    return;
  }
  
  console.log('âœ… Liste render ediliyor,', list.length, 'kullanÄ±cÄ±');
  
  // Escape fonksiyonu (bir kez tanÄ±mla)
  const escape = (t) => {
    const div=document.createElement('div');
    div.textContent=String(t||'');
    return div.innerHTML;
  };
  
  list.forEach((u)=>{
    
    // Supabase'de timestamp string olarak gelir
    const d = u.eklenmetarihi ? (typeof u.eklenmetarihi === 'string' ? new Date(u.eklenmetarihi) : (u.eklenmetarihi?.toDate ? u.eklenmetarihi.toDate() : null)) : null;
    const adSoyad=escape(u.adSoyad||"-");
    const email=escape(u.email||"-");
    const rol=escape(u.rol||"-");
    const gorev=escape(u.gorev||"-");
    const yetkiCount=(u.yetkiler||[]).length;
    const dateStr=d? d.toLocaleDateString("tr-TR"):"-";
    const toggleData=JSON.stringify({uid:u.uid,aktif:!!u.aktif});
    
    // Sadece kart gÃ¶rÃ¼nÃ¼mÃ¼ (tablo kaldÄ±rÄ±ldÄ±)
    {
      const card=document.createElement('div'); card.className='ucard';
      const header=document.createElement('div');
      header.style.display="flex";
      header.style.justifyContent="space-between";
      header.style.alignItems="flex-start";
      header.style.gap="12px";
      header.style.marginBottom="12px";
      
      const left=document.createElement('div');
      left.style.flex="1";
      const name=document.createElement('div');
      name.style.fontWeight="800";
      name.style.fontSize="16px";
      name.style.marginBottom="4px";
      name.textContent=adSoyad;
      const info=document.createElement('div');
      info.style.fontSize="12px";
      info.style.color="var(--muted)";
      info.style.lineHeight="1.5";
      info.innerHTML=`<div>ğŸ“§ ${email}</div><div>ğŸ‘¤ ${rol} Â· ${gorev}</div><div>ğŸ“… ${dateStr}</div><div>ğŸ”‘ ${yetkiCount} yetki</div>`;
      left.appendChild(name);
      left.appendChild(info);
      
      const right=document.createElement('div');
      right.innerHTML=u.aktif? '<span class="pill" style="background:var(--ok);color:#fff">Aktif</span>':'<span class="pill" style="background:var(--muted);color:#fff">Pasif</span>';
      
      header.appendChild(left);
      header.appendChild(right);
      
      const actions=document.createElement('div');
      actions.className="mini";
      actions.style.marginTop="12px";
      actions.style.flexWrap="wrap";
      actions.style.gap="6px";
      const btnEdit=document.createElement('button');
      btnEdit.className="btn";
      btnEdit.dataset.edit=u.uid; // UUID iÃ§in escape gerekmez
      btnEdit.textContent="âœï¸ DÃ¼zenle";
      btnEdit.style.fontSize="12px";
      btnEdit.style.padding="6px 10px";
      
      const btnReset=document.createElement('button');
      btnReset.className="btn";
      btnReset.dataset.reset=email; // Email iÃ§in escape gerekmez (data attribute)
      btnReset.textContent="ğŸ”‘ Åifre";
      btnReset.style.fontSize="12px";
      btnReset.style.padding="6px 10px";
      
      const btnShowPassword=document.createElement('button');
      btnShowPassword.className="btn";
      btnShowPassword.dataset.showPassword=u.uid; // UUID iÃ§in escape gerekmez
      btnShowPassword.textContent="ğŸ” Åifre GÃ¶ster";
      btnShowPassword.style.fontSize="12px";
      btnShowPassword.style.padding="6px 10px";
      btnShowPassword.style.background="rgba(34,197,94,.1)";
      btnShowPassword.style.borderColor="rgba(34,197,94,.3)";
      
      const btnResetAndSave=document.createElement('button');
      btnResetAndSave.className="btn";
      // JSON string iÃ§in escape gerekmez, data attribute otomatik encode eder
      btnResetAndSave.dataset.resetAndSave=JSON.stringify({uid: u.uid, email: email, adSoyad: u.adSoyad || u.adsoyad});
      btnResetAndSave.textContent="ğŸ”„ Åifre SÄ±fÄ±rla ve Kaydet";
      btnResetAndSave.style.fontSize="12px";
      btnResetAndSave.style.padding="6px 10px";
      btnResetAndSave.style.background="rgba(59,130,246,.1)";
      btnResetAndSave.style.borderColor="rgba(59,130,246,.3)";
      
      const btnToggle=document.createElement('button');
      btnToggle.className="btn";
      // JSON string iÃ§in escape gerekmez, data attribute otomatik encode eder
      btnToggle.dataset.toggle=toggleData;
      btnToggle.textContent=u.aktif? "â›” Pasifle":"âœ… Aktifle";
      btnToggle.style.fontSize="12px";
      btnToggle.style.padding="6px 10px";
      
      const btnDel=document.createElement('button');
      btnDel.className="btn";
      btnDel.dataset.softdel=u.uid; // UUID iÃ§in escape gerekmez
      btnDel.textContent="ğŸ—‘ï¸ Sil";
      btnDel.style.fontSize="12px";
      btnDel.style.padding="6px 10px";
      btnDel.style.background="rgba(255,66,85,.1)";
      btnDel.style.borderColor="rgba(255,66,85,.3)";
      
      actions.appendChild(btnEdit);
      actions.appendChild(btnReset);
      actions.appendChild(btnShowPassword);
      actions.appendChild(btnResetAndSave);
      actions.appendChild(btnToggle);
      actions.appendChild(btnDel);
      
      card.appendChild(header);
      card.appendChild(actions);
      wrap.appendChild(card);
    }
  });
  
  bindListButtons(wrap);
}

/* DÃ¼zenleme */
let mEdit = null;

// Modal element'ini sayfa yÃ¼klendikten sonra al
(function initModals(){
  mEdit = $("#mEdit");
  if(mEdit){
    console.log('âœ… mEdit modal elementi bulundu');
    // Backdrop'a tÄ±klanÄ±nca kapat (modal element'ine tÄ±klanÄ±nca)
    mEdit.onclick=(e)=>{
      if(e.target===mEdit) mEdit.classList.remove('open');
    };
  } else {
    console.error('âŒ mEdit modal elementi bulunamadÄ±');
  }
})();
// Eski kullanÄ±cÄ± deÄŸerlerini sakla (mail gÃ¶ndermek iÃ§in)
let eskiKullaniciVerileri = null;

async function openEdit(uid){
  console.log('ğŸ”µ openEdit Ã§aÄŸrÄ±ldÄ±, uid:', uid);
  
  if(!uid){
    console.error('âŒ openEdit: uid boÅŸ');
    if(typeof window.showToast==='function') window.showToast('error','Hata','KullanÄ±cÄ± ID bulunamadÄ±');
    return;
  }
  
  const supabase = await getSupabase(); 
  if(!supabase) {
    if(typeof window.showToast==='function') window.showToast('error','Hata','Supabase baÄŸlantÄ±sÄ± yok');
    return;
  }
  
  console.log('ğŸ”µ KullanÄ±cÄ± verisi Ã§ekiliyor, uid:', uid);
  const { data: doc, error } = await supabase.from('kullanicilar').select('id, adsoyad, email, rol, gorev, aktif, eklenmetarihi, yetkiler').eq('id', uid).single();
  if(error || !doc){ 
    if(typeof window.showToast==='function') window.showToast('warning','UyarÄ±','KullanÄ±cÄ± bulunamadÄ±'); 
    return; 
  }
  const u={uid:doc.id, ...doc};
  // VeritabanÄ±ndan gelen adsoyad'Ä± kullan (snake_case)
  const adSoyadValue = u.adsoyad || u.adSoyad || "";
  
  // Eski deÄŸerleri sakla (mail gÃ¶ndermek iÃ§in)
  eskiKullaniciVerileri = {
    rol: u.rol || '',
    gorev: u.gorev || '',
    yetkiler: Array.isArray(u.yetkiler) ? [...u.yetkiler] : []
  };
  
  const eUid=$("#e_uid"), eAd=$("#e_ad"), eRol=$("#e_rol"), eGorev=$("#e_gorev"), eMail=$("#e_mail"), eAktif=$("#e_aktif");
  if(eUid) eUid.value=u.uid||"";
  if(eAd) eAd.value=adSoyadValue;
  if(eRol) eRol.value=u.rol||"personel";
  if(eGorev) eGorev.value=u.gorev||"";
  if(eMail) eMail.value=u.email||"";
  if(eAktif) eAktif.checked=!!u.aktif;
  renderPermTree("#permTreeEdit", u.yetkiler||[]);
  
  // Modal'Ä± aÃ§ (eÄŸer henÃ¼z alÄ±nmadÄ±ysa tekrar al)
  if(!mEdit){
    mEdit = $("#mEdit");
  }
  
  if(!mEdit){
    console.error('âŒ mEdit modal elementi bulunamadÄ±');
    if(typeof window.showToast==='function') window.showToast('error','Hata','Modal elementi bulunamadÄ±');
    return;
  }
  
  console.log('âœ… Modal aÃ§Ä±lÄ±yor, mEdit:', mEdit);
  mEdit.classList.add('open');
  console.log('âœ… Modal aÃ§Ä±ldÄ±, classList:', mEdit.classList.toString());
  
  // Modal'Ä±n gÃ¶rÃ¼nÃ¼r olduÄŸunu kontrol et
  const isVisible = window.getComputedStyle(mEdit).display !== 'none';
  console.log('ğŸ”µ Modal gÃ¶rÃ¼nÃ¼r mÃ¼?', isVisible);
}
if($("#btnEditClose")){
  $("#btnEditClose").onclick=()=> { if(mEdit) mEdit.classList.remove('open'); };
}
if($("#btnEditSave")){
  $("#btnEditSave").onclick=async()=>{
    const btn=$("#btnEditSave");
    const originalText=btn.textContent;
    btn.disabled=true;
    btn.textContent='â³ Kaydediliyor...';
    
    try{
      const uid=$("#e_uid")?.value||"";
      const ad=$("#e_ad")?.value.trim()||"";
      const rol=$("#e_rol")?.value||"";
      const gorev=$("#e_gorev")?.value.trim()||"";
      const aktif=$("#e_aktif")?.checked||false;
      const yetkiler=normalizeYetkiler(getChecked("#permTreeEdit"));
      
      if(!uid){
        throw new Error('KullanÄ±cÄ± ID bulunamadÄ±');
      }
      if(!ad || ad.length < 2){
        throw new Error('Ad Soyad en az 2 karakter olmalÄ±');
      }
      if(!rol){
        throw new Error('Rol seÃ§ilmelidir');
      }
      
      const supabase = await getSupabase(); 
      if(!supabase) throw new Error('Supabase baÄŸlantÄ±sÄ± yok');
      
      // Yeni deÄŸerler
      const yeniRol = rol;
      const yeniGorev = gorev;
      const yeniYetkiler = yetkiler;
      
      // Eski deÄŸerlerle karÅŸÄ±laÅŸtÄ±r
      const eskiRol = eskiKullaniciVerileri?.rol || '';
      const eskiGorev = eskiKullaniciVerileri?.gorev || '';
      const eskiYetkiler = eskiKullaniciVerileri?.yetkiler || [];
      
      // DeÄŸiÅŸiklik var mÄ± kontrol et
      const rolDegisti = eskiRol !== yeniRol;
      const gorevDegisti = eskiGorev !== yeniGorev;
      const yetkiDegisti = JSON.stringify(eskiYetkiler.sort()) !== JSON.stringify(yeniYetkiler.sort());
      const degisiklikVar = rolDegisti || gorevDegisti || yetkiDegisti;
      
      const { error } = await supabase.from('kullanicilar').update({adsoyad:ad, rol, gorev, aktif, yetkiler}).eq('id', uid);
      if(error) throw error;
      
      // KullanÄ±cÄ± email'ini al (mail gÃ¶ndermek iÃ§in)
      const email = $("#e_mail")?.value?.trim() || '';
      
      // DeÄŸiÅŸiklik varsa mail gÃ¶nder
      if(degisiklikVar && email && eskiKullaniciVerileri){
        try {
          await sendPermissionUpdateEmail(email, ad, eskiRol, yeniRol, eskiGorev, yeniGorev, eskiYetkiler, yeniYetkiler);
        } catch(mailErr) {
          console.warn('Yetki gÃ¼ncelleme maili gÃ¶nderilemedi (kritik deÄŸil):', mailErr);
        }
      }
      
      // Eski deÄŸerleri temizle
      eskiKullaniciVerileri = null;
      
      if(mEdit) mEdit.classList.remove('open');
      if(typeof window.showToast==='function') window.showToast('success','BaÅŸarÄ±lÄ±','GÃ¼ncellendi');
    }catch(e){
      console.error('GÃ¼ncelleme hatasÄ±:', e);
      if(typeof window.showToast==='function') window.showToast('error','Hata',e?.message||e||'Bilinmeyen hata');
    }finally{
      btn.disabled=false;
      btn.textContent=originalText;
    }
  };
}

/* Åifre GÃ¶ster */
async function showPassword(uid){
  if(!uid){
    if(typeof window.showToast==='function') window.showToast('warning','UyarÄ±','KullanÄ±cÄ± ID bulunamadÄ±');
    return;
  }
  try{
    const supabase = await getSupabase();
    if(!supabase) {
      if(typeof window.showToast==='function') window.showToast('error','Hata','Supabase baÄŸlantÄ±sÄ± yok');
      return;
    }
    
    // KullanÄ±cÄ± bilgilerini al
    const { data: userData, error: userError } = await supabase
      .from('kullanicilar')
      .select('id, adsoyad, email')
      .eq('id', uid)
      .single();
    
    if(userError || !userData){
      if(typeof window.showToast==='function') window.showToast('error','Hata','KullanÄ±cÄ± bulunamadÄ±');
      return;
    }
    
    // Åifreyi al
    const { data: passwordData, error: passwordError } = await supabase
      .from('kullanici_sifreleri')
      .select('sifre')
      .eq('uid', uid)
      .single();
    
    const mPasswordShow = $("#mPasswordShow");
    if(!mPasswordShow) return;
    
    // Modal iÃ§eriÄŸini doldur
    $("#passwordShowAdSoyad").textContent = userData.adsoyad || 'â€”';
    $("#passwordShowEmail").textContent = userData.email || 'â€”';
    
    if(passwordError || !passwordData){
      $("#passwordShowSifre").textContent = 'Åifre kaydÄ± bulunamadÄ±';
      $("#passwordShowSifre").style.color = 'var(--muted)';
      $("#btnPasswordCopy").disabled = true;
    } else {
      $("#passwordShowSifre").textContent = passwordData.sifre || 'â€”';
      $("#passwordShowSifre").style.color = 'var(--text)';
      $("#btnPasswordCopy").disabled = false;
    }
    
    // Modal'Ä± aÃ§
    mPasswordShow.classList.add('open');
  }catch(e){
    console.error('Åifre gÃ¶sterme hatasÄ±:', e);
    if(typeof window.showToast==='function') window.showToast('error','Hata','Åifre gÃ¶sterilemedi: '+(e?.message||e||'Bilinmeyen hata'));
  }
}

/* Åifre SÄ±fÄ±rla ve Kaydet */
async function resetAndSavePassword(userInfo){
  if(!userInfo || !userInfo.uid || !userInfo.email){
    if(typeof window.showToast==='function') window.showToast('warning','UyarÄ±','KullanÄ±cÄ± bilgileri eksik');
    return;
  }
  
  try{
    const supabase = await getSupabase();
    if(!supabase) {
      if(typeof window.showToast==='function') window.showToast('error','Hata','Supabase baÄŸlantÄ±sÄ± yok');
      return;
    }
    
    // KullanÄ±cÄ± bilgilerini al
    const { data: userData, error: userError } = await supabase
      .from('kullanicilar')
      .select('id, adsoyad, email, rol, gorev')
      .eq('id', userInfo.uid)
      .single();
    
    if(userError || !userData){
      if(typeof window.showToast==='function') window.showToast('error','Hata','KullanÄ±cÄ± bulunamadÄ±');
      return;
    }
    
    // Modal'Ä± aÃ§ ve kullanÄ±cÄ± bilgilerini doldur
    const mPasswordReset = $("#mPasswordReset");
    if(!mPasswordReset) return;
    
    $("#passwordResetAdSoyad").textContent = userData.adsoyad || userInfo.adSoyad || 'â€”';
    $("#passwordResetEmail").textContent = userData.email || userInfo.email || 'â€”';
    const input = $("#passwordResetInput");
    if(input) input.value = '';
    // Elementleri yeniden al (modal aÃ§Ä±ldÄ±ktan sonra)
    passwordResetInput = $("#passwordResetInput");
    passwordResetMeterBar = $("#passwordResetMeterBar");
    passwordResetMeterLabel = $("#passwordResetMeterLabel");
    renderPasswordResetMeter();
    
    // KullanÄ±cÄ± bilgilerini modal'a sakla (kaydet butonunda kullanmak iÃ§in)
    mPasswordReset.dataset.userInfo = JSON.stringify({
      uid: userInfo.uid,
      email: userData.email,
      adSoyad: userData.adsoyad || userInfo.adSoyad,
      rol: userData.rol,
      gorev: userData.gorev
    });
    
    mPasswordReset.classList.add('open');
  }catch(e){
    console.error('Åifre sÄ±fÄ±rlama modal aÃ§ma hatasÄ±:', e);
    if(typeof window.showToast==='function') window.showToast('error','Hata','Modal aÃ§Ä±lamadÄ±: '+(e?.message||e||'Bilinmeyen hata'));
  }
}

/* Åifre SÄ±fÄ±rla ve Kaydet - Kaydet Butonu */
async function savePasswordReset(){
  const mPasswordReset = $("#mPasswordReset");
  if(!mPasswordReset) return;
  
  const passwordInput = $("#passwordResetInput");
  if(!passwordInput) return;
  
  const newPassword = passwordInput.value.trim();
  
  // Validasyon
  if(!newPassword || newPassword.length < 6){
    if(typeof window.showToast==='function') window.showToast('warning','UyarÄ±','Åifre en az 6 karakter olmalÄ±');
    return;
  }
  
  // KullanÄ±cÄ± bilgilerini al
  const userInfoStr = mPasswordReset.dataset.userInfo;
  if(!userInfoStr){
    if(typeof window.showToast==='function') window.showToast('error','Hata','KullanÄ±cÄ± bilgileri bulunamadÄ±');
    return;
  }
  
  let userInfo;
  try{
    userInfo = JSON.parse(userInfoStr);
  }catch(e){
    if(typeof window.showToast==='function') window.showToast('error','Hata','KullanÄ±cÄ± bilgileri parse edilemedi');
    return;
  }
  
  const btn = $("#btnPasswordResetSave");
  const originalText = btn?.textContent || 'Kaydet';
  if(btn) {
    btn.disabled = true;
    btn.textContent = 'â³ Kaydediliyor...';
  }
  
  try{
    const supabase = await getSupabase();
    if(!supabase) {
      throw new Error('Supabase baÄŸlantÄ±sÄ± yok');
    }
    
    // Admin UID'sini al
    const { data: { user: adminUser } } = await supabase.auth.getUser();
    const adminUid = adminUser?.id || null;
    
    // Edge Function'Ä± Ã§aÄŸÄ±r (ÅŸifre gÃ¼ncelleme)
    const { data: edgeData, error: edgeError } = await supabase.functions.invoke('admin-create-user', {
      body: {
        email: userInfo.email,
        password: newPassword,
        adSoyad: userInfo.adSoyad,
        rol: userInfo.rol,
        gorev: userInfo.gorev,
        yetkiler: [],
        adminUid: adminUid
      }
    });
    
    if(edgeError){
      console.error('Edge Function hatasÄ±:', edgeError);
      throw new Error(edgeError.message || 'Åifre gÃ¼ncellenemedi');
    }
    
    if(!edgeData || !edgeData.success){
      throw new Error('Åifre gÃ¼ncellenemedi: Edge Function baÅŸarÄ±sÄ±z yanÄ±t');
    }
    
    // Modal'Ä± kapat
    mPasswordReset.classList.remove('open');
    
    // BaÅŸarÄ±lÄ± - ÅŸifre gÃ¶sterim modal'Ä±nda gÃ¶ster
    const mPasswordShow = $("#mPasswordShow");
    if(mPasswordShow){
      $("#passwordShowAdSoyad").textContent = userInfo.adSoyad || 'â€”';
      $("#passwordShowEmail").textContent = userInfo.email || 'â€”';
      $("#passwordShowSifre").textContent = newPassword;
      $("#passwordShowSifre").style.color = 'var(--text)';
      $("#btnPasswordCopy").disabled = false;
      mPasswordShow.classList.add('open');
    }
    
    if(typeof window.showToast==='function') window.showToast('success','BaÅŸarÄ±lÄ±','Yeni ÅŸifre kaydedildi');
  }catch(e){
    console.error('Åifre kaydetme hatasÄ±:', e);
    if(typeof window.showToast==='function') window.showToast('error','Hata','Åifre kaydedilemedi: '+(e?.message||e||'Bilinmeyen hata'));
  }finally{
    if(btn) {
      btn.disabled = false;
      btn.textContent = originalText;
    }
  }
}

/* Åifre Reset Meter */
let passwordResetInput, passwordResetMeterBar, passwordResetMeterLabel;

function scorePasswordReset(p){ 
  let s=0; 
  if(p.length>=8) s++; 
  if(/[A-Z]/.test(p)) s++; 
  if(/[0-9]/.test(p)) s++; 
  if(/[^A-Za-z0-9]/.test(p)) s++; 
  return s; 
}

function renderPasswordResetMeter(){ 
  if(!passwordResetInput || !passwordResetMeterBar || !passwordResetMeterLabel) return; 
  const s=scorePasswordReset(passwordResetInput.value||""); 
  let w=0,c="#ef4444",t="ZayÄ±f"; 
  if(s<=1){w=25}else if(s<=3){w=60;c="#f59e0b";t="Ä°yi"} else {w=100;c="#22c55e";t="GÃ¼Ã§lÃ¼"} 
  passwordResetMeterBar.style.width=w+"%"; 
  passwordResetMeterBar.style.background=c; 
  passwordResetMeterLabel.textContent="GÃ¼Ã§: "+t; 
}

// Sayfa yÃ¼klendikten sonra elementleri al
(function initPasswordResetMeter(){
  passwordResetInput = $("#passwordResetInput");
  passwordResetMeterBar = $("#passwordResetMeterBar");
  passwordResetMeterLabel = $("#passwordResetMeterLabel");
  
  if(passwordResetInput && passwordResetMeterBar && passwordResetMeterLabel){ 
    passwordResetInput.addEventListener("input",renderPasswordResetMeter); 
    renderPasswordResetMeter(); 
  }
})();

/* Reset/Toggle/Delete */
async function resetPass(email){
  if(!email){
    if(typeof window.showToast==='function') window.showToast('warning','UyarÄ±','E-posta bulunamadÄ±');
    return;
  }
  try{
    const supabase = await getSupabase();
    if(!supabase || !supabase.auth) {
      if(typeof window.showToast==='function') window.showToast('error','Hata','Supabase baÄŸlantÄ±sÄ± yok');
      return;
    }
    const { error } = await supabase.auth.resetPasswordForEmail(email, {
      redirectTo: window.location.origin + '/sifre-yenile.html'
    });
    if(error) throw error;
    if(typeof window.showToast==='function') window.showToast('success','BaÅŸarÄ±lÄ±','SÄ±fÄ±rlama e-postasÄ± gÃ¶nderildi');
  }catch(e){
    console.error('Åifre sÄ±fÄ±rlama hatasÄ±:', e);
    if(typeof window.showToast==='function') window.showToast('error','Hata','GÃ¶nderilemedi: '+(e?.message||e||'Bilinmeyen hata'));
  }
}
async function toggleActive(d){
  if(!d || !d.uid){
    if(typeof window.showToast==='function') window.showToast('warning','UyarÄ±','GeÃ§ersiz veri');
    return;
  }
  try{
    const supabase = await getSupabase(); 
    if(!supabase) {
      if(typeof window.showToast==='function') window.showToast('error','Hata','Supabase baÄŸlantÄ±sÄ± yok');
      return;
    }
    const { error } = await supabase.from('kullanicilar').update({aktif: !d.aktif}).eq('id', d.uid);
    if(error) throw error;
    if(typeof window.showToast==='function') window.showToast('success','BaÅŸarÄ±lÄ±','Durum gÃ¼ncellendi');
  }catch(e){
    console.error('Durum gÃ¼ncelleme hatasÄ±:', e);
    if(typeof window.showToast==='function') window.showToast('error','Hata',e?.message||e||'Bilinmeyen hata');
  }
}
async function softDelete(uid){
  if(!uid){
    if(typeof window.showToast==='function') window.showToast('warning','UyarÄ±','GeÃ§ersiz ID');
    return;
  }
  if(!confirm("Bu kullanÄ±cÄ± pasifleÅŸtirilecek (aktif=false).\n\nBu iÅŸlem geri alÄ±nabilir. OnaylÄ±yor musunuz?")){
    return;
  }
  try{
    const supabase = await getSupabase(); 
    if(!supabase) {
      if(typeof window.showToast==='function') window.showToast('error','Hata','Supabase baÄŸlantÄ±sÄ± yok');
      return;
    }
    // sqleditor.md ÅŸemasÄ±na gÃ¶re sadece aktif kolonu var, silindi kolonu yok
    const { error } = await supabase.from('kullanicilar').update({aktif:false}).eq('id', uid);
    if(error) throw error;
    if(typeof window.showToast==='function') window.showToast('success','BaÅŸarÄ±lÄ±','KullanÄ±cÄ± pasifleÅŸtirildi');
  }catch(e){
    console.error('Soft silme hatasÄ±:', e);
    if(typeof window.showToast==='function') window.showToast('error','Hata',e?.message||e||'Bilinmeyen hata');
  }
}

/* ===== Manifest listener ===== */
async function listenManifest(){
  const supabase = await getSupabase(); 
  if(!supabase) return;
  
  // Ä°lk yÃ¼kleme
  loadManifest();
  
  // Real-time subscription (Supabase)
  const channel = supabase.channel('sayfa-manifesti-changes')
    .on('postgres_changes', 
      { event: '*', schema: 'public', table: 'sayfa_manifesti' },
      () => {
        loadManifest();
      }
    )
    .subscribe();
}

async function loadManifest(){
  try {
    const supabase = await getSupabase(); 
    if(!supabase) {
      console.warn('âš ï¸ loadManifest: Supabase baÄŸlantÄ±sÄ± yok');
      return;
    }
    
    // GÃœVENLÄ°K: Sadece gereken sÃ¼tunlarÄ± seÃ§ (.cursorrules kuralÄ±na uygun)
    const { data, error } = await supabase
      .from('sayfa_manifesti')
      .select('id, order, title, pages')
      .order('order', { ascending: true });
    
    if(error) {
      console.error('âŒ Manifest yÃ¼klenemedi:', error);
      // RLS hatasÄ± olabilir - kullanÄ±cÄ±yÄ± bilgilendir
      if(error.code === '42501' || error.message?.includes('permission denied') || error.message?.includes('RLS')){
        console.error('ğŸ”’ RLS (Row Level Security) hatasÄ±: Bu sayfaya eriÅŸim iÃ§in admin yetkisi gerekiyor.');
        if(typeof window.showToast === 'function'){
          window.showToast('error', 'Yetki HatasÄ±', 'Manifest verilerine eriÅŸim reddedildi. Admin yetkisi gerekiyor.');
        }
      }
      return;
    }
    
    // Veri doÄŸrulama ve iÅŸleme
    const m={};
    const allPageKeys = new Set(); // TÃ¼m sayfa key'lerini topla (doÄŸrulama iÃ§in)
    
    (data || []).forEach(d=>{
      const v = d || {};
      const pages = Array.isArray(v.pages) ? v.pages : [];
      
      // Her sayfanÄ±n key'ini topla
      pages.forEach(page => {
        const pageKey = page.key || `${d.id}: ${page.title}`;
        allPageKeys.add(pageKey);
      });
      
      m[d.id] = {
        title: v.title || d.id, 
        order: v.order || 0, 
        pages: pages.sort((a,b)=>(a.order||0)-(b.order||0) || String(a.title||'').localeCompare(String(b.title||''), "tr"))
      };
    });
    
    manifest = m;
    
    console.log('âœ… Manifest yÃ¼klendi:', Object.keys(manifest).length, 'panel,', allPageKeys.size, 'sayfa');
    
    // Opsiyonel: KullanÄ±cÄ± yetkilerini doÄŸrula (debug modunda)
    if(window.DEBUG_MODE){
      validateUserPermissionsAgainstManifest(allPageKeys);
    }
    
    fillPanelSelect(); 
    renderPermTree("#permTreeAdd"); 
    if($("#permTreeEdit").children.length) renderPermTree("#permTreeEdit", getChecked("#permTreeEdit")); 
    renderManifestAdmin(); 
    renderKPIs();
    
    // Sayfa gÃ¶rÃ¼nÃ¼mÃ¼ aktifse yeniden render et
    const sayfaWrap = $("#sayfaWrap");
    const isSayfa = sayfaWrap && (sayfaWrap.style.display==="grid" || sayfaWrap.style.display==="block");
    if(isSayfa) {
      console.log('âœ… Sayfa gÃ¶rÃ¼nÃ¼mÃ¼ aktif, renderSayfa Ã§aÄŸrÄ±lÄ±yor');
      renderSayfa();
    }
  } catch(e) {
    console.error('loadManifest fonksiyonu hatasÄ±:', e);
    // Hata olsa bile sayfa gÃ¶rÃ¼nÃ¼mÃ¼ aktifse render et (hata mesajÄ± gÃ¶sterecek)
    const sayfaWrap = $("#sayfaWrap");
    const isSayfa = sayfaWrap && (sayfaWrap.style.display==="grid" || sayfaWrap.style.display==="block");
    if(isSayfa) {
      renderSayfa();
    }
  }
}

// Opsiyonel: KullanÄ±cÄ± yetkilerini manifest ile karÅŸÄ±laÅŸtÄ±r (debug/doÄŸrulama)
async function validateUserPermissionsAgainstManifest(allPageKeys){
  try {
    const supabase = await getSupabase();
    if(!supabase) return;
    
    const { data: usersData } = await supabase
      .from('kullanicilar')
      .select('id, adsoyad, email, yetkiler')
      .eq('aktif', true);
    
    if(!usersData || usersData.length === 0) return;
    
    const invalidUsers = [];
    usersData.forEach(user => {
      const yetkiler = Array.isArray(user.yetkiler) ? user.yetkiler : [];
      const invalidKeys = yetkiler.filter(y => {
        const yetkiStr = String(y || '').trim();
        return yetkiStr && !allPageKeys.has(yetkiStr) && yetkiStr !== '*';
      });
      
      if(invalidKeys.length > 0){
        invalidUsers.push({
          user: user.adsoyad || user.email,
          userId: user.id,
          invalidKeys: invalidKeys
        });
      }
    });
    
    if(invalidUsers.length > 0){
      console.warn('âš ï¸ GeÃ§ersiz yetkilere sahip kullanÄ±cÄ±lar bulundu:', invalidUsers);
    }
  } catch(e){
    console.warn('Yetki doÄŸrulama hatasÄ± (kritik deÄŸil):', e);
  }
}

/* ===== Auth + Yetki + MenÃ¼ ===== */
// Bu sayfa Ã¶zel: KullanÄ±cÄ± ekleme sayfasÄ± olduÄŸu iÃ§in auth kontrolÃ¼nÃ¼ esnek tutuyoruz
// EÄŸer kullanÄ±cÄ± varsa ve admin ise normal Ã§alÄ±ÅŸÄ±r
// EÄŸer kullanÄ±cÄ± yoksa veya admin deÄŸilse, yine de sayfa Ã§alÄ±ÅŸÄ±r (kullanÄ±cÄ± eklemek iÃ§in gerekli)

// Sayfaya Ã¶zel fetchPanels (Supabase uyumlu)
async function fetchPanelsSupabase(allowSet, denySet) {
  const res = [];
  try {
    const supabase = await getSupabase();
    if (!supabase) {
      console.error('Supabase client yÃ¼klenmedi (fetchPanelsSupabase)');
      return res;
    }
    
    const { data, error } = await supabase
      .from('sayfa_manifesti')
      .select('id, order, title, pages')
      .order('order', { ascending: true });
    
    if (error) {
      console.error('sayfa_manifesti okunamadÄ±:', error);
      return res;
    }
    
    if (!data || data.length === 0) {
      return res;
    }
    
    // norm fonksiyonu window'da olmalÄ± (ortak.js'den geliyor)
    const norm = window.norm || ((s) => String(s || '').normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase().trim());
    
    data.forEach(doc => {
      const d = doc || {};
      const id = doc.id;
      const panelTitle = d.title || id;
      
      // Sistem AyarlarÄ± panelini Ã¼st menÃ¼den kaldÄ±r
      const panelTitleNorm = norm(panelTitle);
      const idNorm = norm(id);
      const excludedPanels = ['sistem ayarlarÄ±', 'ayarlar', 'diÄŸer', 'sistemayarlarÄ±', 'sistem-ayarlari'];
      if (excludedPanels.includes(panelTitleNorm) || excludedPanels.includes(idNorm) ||
          (panelTitleNorm.includes('sistem') && panelTitleNorm.includes('ayar'))) {
        return; // Bu paneli atla
      }
      
      const panelGrant = allowSet.has(norm(id)) || allowSet.has(norm(panelTitle));
      let pages = Array.isArray(d.pages) ? d.pages : [];
      pages = pages.filter(pg => {
        const keyNorm = norm(pg.key || pg.title || '');
        const pageGrant = allowSet.has(keyNorm);
        const denied = denySet.has(keyNorm);
        return !denied && (panelGrant || pageGrant);
      }).map(pg => ({
        baslik: pg.title || pg.key || 'Sayfa',
        url: (typeof window.normalizeUrl === 'function' ? window.normalizeUrl(pg.path || '#') : pg.path || '#'),
        key: pg.key || pg.title || '',
        sira: typeof pg.order === 'number' ? pg.order : 9999
      })).sort((a, b) => a.sira - b.sira);
      
      if (pages.length) {
        res.push({ 
          id, 
          baslik: panelTitle, 
          sira: typeof d.order === 'number' ? d.order : 9999, 
          pages 
        });
      }
    });
    
    res.sort((a, b) => a.sira - b.sira);
  } catch (e) {
    console.error('fetchPanelsSupabase hatasÄ±:', e);
  }
  return res;
}

// Ortak.js'deki initAppShellAuth'u bu sayfa iÃ§in override et
// Bu kod ortak.js yÃ¼klenmeden Ã–NCE Ã§alÄ±ÅŸmalÄ±
(function(){
  // Bu sayfa iÃ§in Ã¶zel auth kontrolÃ¼
  const currentPath = window.location.pathname;
  const isKullaniciEklePage = window.IS_KULLANICI_EKLE_PAGE || currentPath.includes('kullanici-ekle.html');
  
  if(isKullaniciEklePage){
    // Ortak.js'deki initAppShellAuth'u geÃ§ici olarak override et
    const originalInitAppShellAuth = window.initAppShellAuth;
    
    window.initAppShellAuth = async function() {
      // Supabase'in yÃ¼klenmesini bekle
      let supabase = await getSupabase();
      if(!supabase) {
        console.warn('Supabase yÃ¼klenmedi, sayfa sÄ±nÄ±rlÄ± modda Ã§alÄ±ÅŸacak');
      }
      
      if(!supabase) {
        console.warn('Supabase yÃ¼klenmedi, sayfa sÄ±nÄ±rlÄ± modda Ã§alÄ±ÅŸacak');
        // Sayfa yine de Ã§alÄ±ÅŸsÄ±n
        setTimeout(async () => {
          if(typeof window.initPage === 'function'){
            await window.initPage();
          }
        }, 500);
        return;
      }
      
      // window.auth'u set et (ortak.js uyumluluÄŸu iÃ§in)
      if(!window.auth && supabase.auth){
        window.auth = supabase.auth;
        console.log('âœ… window.auth set edildi (Supabase auth)');
      }
      
      // GÃœVENLÄ°K: Auth kontrolÃ¼ zorunlu (erken kontrol zaten yapÄ±ldÄ±, burada sadece doÄŸrulama)
      const auth = getAuth();
      if(!auth){
        console.error('âŒ GÃœVENLÄ°K: Auth sistemi yÃ¼klenemedi');
        window.location.href = '../index.html';
        return;
      }
      
      // Mevcut kullanÄ±cÄ±yÄ± hemen kontrol et (auth state deÄŸiÅŸikliÄŸi beklenmeden)
      const loadUserData = async (user) => {
        // GÃœVENLÄ°K: Anonim kullanÄ±cÄ±lar eriÅŸemez
        if(!user) {
          console.error('âŒ GÃœVENLÄ°K: KullanÄ±cÄ± giriÅŸ yapmamÄ±ÅŸ, eriÅŸim reddedildi');
          const profNameEl = document.getElementById('profName');
          if(profNameEl){
            profNameEl.textContent = 'GiriÅŸ YapÄ±lmamÄ±ÅŸ';
          }
          if(typeof window.showToast === 'function'){
            window.showToast('error', 'EriÅŸim Reddedildi', 'Bu sayfaya eriÅŸim iÃ§in giriÅŸ yapmanÄ±z gerekmektedir.');
          }
          setTimeout(() => {
            window.location.href = '../index.html';
          }, 2000);
          return;
        }
        
        // GÃœVENLÄ°K: Admin kontrolÃ¼ yap
        // KullanÄ±cÄ± varsa bilgilerini yÃ¼kle
        try {
          const { data: userData, error } = await supabase
            .from('kullanicilar')
            .select('id, adsoyad, email, rol, gorev, aktif, eklenmetarihi, yetkiler')
            .eq('id', user.id || user.uid)
            .single();
          
          if(userData){
            // GÃœVENLÄ°K: Yetki kontrolÃ¼ - Ã¼st nav kontrolÃ¼ yeterli, burada sadece wildcard kontrolÃ¼
            // Ãœst nav'da yetki varsa sayfaya eriÅŸim var, iÃ§erde iÅŸlem yapÄ±labilir
            const yetkiler = Array.isArray(userData.yetkiler) ? userData.yetkiler : [];
            const hasWildcard = yetkiler.includes('*');
            
            // Wildcard yoksa, Ã¼st nav kontrolÃ¼ yeterli - sayfa aÃ§Ä±lmÄ±ÅŸsa yetki var demektir
            // Bu kontrol sadece ekstra gÃ¼venlik iÃ§in, ana kontrol Ã¼st nav'da
            if(!hasWildcard && yetkiler.length === 0){
              console.warn('âš ï¸ KullanÄ±cÄ±nÄ±n yetkisi yok, ancak sayfa aÃ§Ä±lmÄ±ÅŸsa Ã¼st nav kontrolÃ¼ geÃ§miÅŸ demektir');
            }
            
            const profNameEl = document.getElementById('profName');
            if(profNameEl){
              const name = userData.adsoyad || userData.adSoyad || user.email?.split('@')[0] || 'Profil';
              profNameEl.textContent = `ğŸ‘¤ ${name}`;
            }
            
            // Yetkileri yÃ¼kle - "*" yetkisini de destekle
            // norm fonksiyonu window'da olmalÄ± (ortak.js'den geliyor)
            const norm = window.norm || ((s) => String(s || '').normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase().trim());
            const rawPerms = Array.isArray(userData.yetkiler) ? userData.yetkiler : [];
            const normalizedPerms = rawPerms.filter(s => !String(s).trim().startsWith('-') && !String(s).trim().startsWith('!')).map(s => String(s).trim());
            window.CURRENT_ALLOW = new Set();
            normalizedPerms.forEach(perm => {
              const normalized = norm(perm);
              window.CURRENT_ALLOW.add(perm); // Orijinal hali
              window.CURRENT_ALLOW.add(normalized); // Normalize edilmiÅŸ hali
              if (perm === '*' || normalized === '*') {
                window.CURRENT_ALLOW.add('*'); // Wildcard yetkisi
              }
            });
            window.CURRENT_DENY = new Set(rawPerms.filter(s => String(s).trim().startsWith('-') || String(s).trim().startsWith('!')).map(s => norm(String(s).replace(/^[-!]\s*/, ''))));
            
            // Navigasyonu yÃ¼kle (Supabase uyumlu fetchPanels kullan)
            if(typeof window.renderNav === 'function'){
              try {
                const panels = await fetchPanelsSupabase(window.CURRENT_ALLOW, window.CURRENT_DENY);
                window.renderNav(panels);
              } catch(e){
                console.warn('Paneller yÃ¼klenemedi:', e);
              }
            }
            
            // Bildirimleri yÃ¼kle
            if(typeof window.loadNotifications === 'function'){
              try {
                await window.loadNotifications();
              } catch(e){
                console.warn('Bildirimler yÃ¼klenemedi:', e);
              }
            }
          } else {
            // KullanÄ±cÄ± veritabanÄ±nda yok
            console.error('âŒ GÃœVENLÄ°K: KullanÄ±cÄ± kaydÄ± bulunamadÄ±');
            if(typeof window.showToast === 'function'){
              window.showToast('error', 'Hata', 'KullanÄ±cÄ± kaydÄ±nÄ±z bulunamadÄ±. LÃ¼tfen yÃ¶neticiyle iletiÅŸime geÃ§in.');
            }
            setTimeout(() => {
              window.location.href = '../index.html';
            }, 2000);
            return;
          }
        } catch(e){
          console.error('âŒ KullanÄ±cÄ± bilgisi yÃ¼klenemedi:', e);
          if(typeof window.showToast === 'function'){
            window.showToast('error', 'Hata', 'KullanÄ±cÄ± bilgileriniz alÄ±namadÄ±. LÃ¼tfen tekrar giriÅŸ yapÄ±n.');
          }
          setTimeout(() => {
            window.location.href = '../index.html';
          }, 2000);
          return;
        }
        
        // Sayfa Ã¶zel init fonksiyonunu Ã§aÄŸÄ±r (manifest ve users yÃ¼klenecek)
        // Ortak.js mantÄ±ÄŸÄ±na uygun olarak initPage'i Ã§aÄŸÄ±r
        if(typeof window.initPage === 'function'){
          try {
            await window.initPage();
          } catch(e) {
            console.error('initPage hatasÄ±:', e);
          }
        }
      };
      
      // Ã–nce mevcut kullanÄ±cÄ±yÄ± kontrol et (Supabase session kullan)
      let currentUser = null;
      try {
        const { data: { session }, error: sessionError } = await supabase.auth.getSession();
        if(sessionError){
          console.error('Session alÄ±namadÄ±:', sessionError);
        } else if(session?.user){
          currentUser = session.user;
        }
      } catch(sessionErr){
        console.error('Session kontrolÃ¼ hatasÄ±:', sessionErr);
      }
      
      if(currentUser){
        await loadUserData(currentUser);
      } else {
        // GÃœVENLÄ°K: KullanÄ±cÄ± yoksa eriÅŸim reddedilir
        console.error('âŒ GÃœVENLÄ°K: KullanÄ±cÄ± giriÅŸ yapmamÄ±ÅŸ');
        if(typeof window.showToast === 'function'){
          window.showToast('error', 'EriÅŸim Reddedildi', 'Bu sayfaya eriÅŸim iÃ§in giriÅŸ yapmanÄ±z gerekmektedir.');
        }
        setTimeout(() => {
          window.location.href = '../index.html';
        }, 2000);
        return;
      }
        
      // Auth state deÄŸiÅŸikliklerini dinle (Supabase API)
      // Supabase'de onAuthStateChange kullanÄ±lÄ±r (Firebase'den farklÄ±)
      if(supabase && supabase.auth){
        supabase.auth.onAuthStateChange(async (event, session) => {
          const user = session?.user || null;
          await loadUserData(user);
        });
      }
    };
    
    // Ortak.js'deki initWhenReady Firebase kontrolÃ¼ yapÄ±yor, bu sayfada Supabase kullanÄ±lÄ±yor
    // Bu yÃ¼zden initAppShellAuth'u manuel olarak Ã§aÄŸÄ±rmalÄ±yÄ±z
    // DOMContentLoaded veya sayfa yÃ¼klendiÄŸinde Ã§aÄŸÄ±r
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', function() {
        if(typeof window.initAppShellAuth === 'function'){
          window.initAppShellAuth();
        }
      });
    } else {
      // Sayfa zaten yÃ¼klendi
      if(typeof window.initAppShellAuth === 'function'){
        window.initAppShellAuth();
      }
    }
  }
})();

// Sayfa Ã¶zel init fonksiyonu - ortak.js'den sonra Ã§aÄŸrÄ±lacak
window.initPage = async function() {
  try {
    console.log('initPage Ã§aÄŸrÄ±ldÄ±');
    
    // Supabase'in yÃ¼klenmesini bekle
    let supabase = await getSupabase();
    if (!supabase) {
      console.warn('Supabase baÄŸlantÄ±sÄ± yok, sayfa sÄ±nÄ±rlÄ± modda Ã§alÄ±ÅŸacak');
      return;
    }
    
    // GÃœVENLÄ°K: Session kontrolÃ¼ (Supabase auth state'i doÄŸru kontrol etmek iÃ§in)
    let user = null;
    try {
      const { data: { session }, error } = await supabase.auth.getSession();
      if(error){
        console.error('Session alÄ±namadÄ±:', error);
      } else if(session?.user){
        user = session.user;
      }
    } catch(sessionError){
      console.error('Session kontrolÃ¼ hatasÄ±:', sessionError);
    }
    
    // EÄŸer session'dan user alÄ±namadÄ±ysa, getAuth() ile dene (uyumluluk iÃ§in)
    if(!user){
      const auth = getAuth();
      // Supabase auth'da currentUser yok, session kullanmalÄ±yÄ±z
      // Ama yine de kontrol edelim
      if(auth && auth.getUser){
        try {
          const { data: { user: authUser } } = await auth.getUser();
          user = authUser;
        } catch(e){
          console.warn('getUser() hatasÄ±:', e);
        }
      }
    }
    
    // GÃœVENLÄ°K: Anonim kullanÄ±cÄ±lar sayfayÄ± kullanamaz
    if(!user){
      console.error('âŒ GÃœVENLÄ°K: Anonim kullanÄ±cÄ±lar bu sayfaya eriÅŸemez');
      if(typeof window.showToast === 'function'){
        window.showToast('error', 'EriÅŸim Reddedildi', 'Bu sayfaya eriÅŸim iÃ§in giriÅŸ yapmanÄ±z gerekmektedir.');
      }
      // Ana sayfaya yÃ¶nlendir
      setTimeout(() => {
        window.location.href = '../index.html';
      }, 2000);
      return;
    }
    
    // GÃœVENLÄ°K: KullanÄ±cÄ± admin deÄŸilse eriÅŸim reddedilir
    let isAdmin = false;
    try {
      const { data: userData, error: userError } = await supabase
        .from('kullanicilar')
        .select('rol, yetkiler, adsoyad')
        .eq('id', user.id || user.uid)
        .single();
      
      if(userError){
        console.error('âŒ KullanÄ±cÄ± bilgisi alÄ±namadÄ±:', userError);
        if(typeof window.showToast === 'function'){
          window.showToast('error', 'Hata', 'KullanÄ±cÄ± bilgileriniz alÄ±namadÄ±. LÃ¼tfen tekrar giriÅŸ yapÄ±n.');
        }
        setTimeout(() => {
          window.location.href = '../index.html';
        }, 2000);
        return;
      }
      
      if(userData){
        // Yetki kontrolÃ¼ - Ã¼st nav kontrolÃ¼ yeterli
        // Ãœst nav'da yetki varsa sayfaya eriÅŸim var, iÃ§erde iÅŸlem yapÄ±labilir
        // Bu kontrol sadece ekstra gÃ¼venlik iÃ§in, ana kontrol Ã¼st nav'da
        const yetkiler = Array.isArray(userData.yetkiler) ? userData.yetkiler : [];
        // Sayfa aÃ§Ä±lmÄ±ÅŸsa yetki var demektir (Ã¼st nav kontrolÃ¼ geÃ§miÅŸ)
        isAdmin = true; // Ãœst nav kontrolÃ¼ yeterli
      } else {
        // KullanÄ±cÄ± veritabanÄ±nda yok
        console.error('âŒ GÃœVENLÄ°K: KullanÄ±cÄ± kaydÄ± bulunamadÄ±');
        if(typeof window.showToast === 'function'){
          window.showToast('error', 'Hata', 'KullanÄ±cÄ± kaydÄ±nÄ±z bulunamadÄ±. LÃ¼tfen yÃ¶neticiyle iletiÅŸime geÃ§in.');
        }
        setTimeout(() => {
          window.location.href = '../index.html';
        }, 2000);
        return;
      }
    } catch(e){
      console.error('âŒ KullanÄ±cÄ± yetki kontrolÃ¼ hatasÄ±:', e);
      if(typeof window.showToast === 'function'){
        window.showToast('error', 'Hata', 'Yetki kontrolÃ¼ yapÄ±lamadÄ±. LÃ¼tfen tekrar giriÅŸ yapÄ±n.');
      }
      setTimeout(() => {
        window.location.href = '../index.html';
      }, 2000);
      return;
    }
    
    // Sayfa Ã¶zel iÅŸlemler (sadece admin kullanÄ±cÄ±lar iÃ§in)
    console.log('Manifest ve Users yÃ¼kleniyor...');
    try {
      listenManifest();
    } catch(e){
      console.error('listenManifest hatasÄ±:', e);
    }
    
    try {
      await listenUsers();
    } catch(e){
      console.error('listenUsers hatasÄ±:', e);
      // Hata olsa bile sayfa yenilenmesin
      if(typeof window.showToast === 'function'){
        window.showToast('warning', 'UyarÄ±', 'KullanÄ±cÄ±lar yÃ¼klenirken hata: ' + (e?.message || 'Bilinmeyen hata'));
      }
    }
    
    // Ä°lk aÃ§Ä±lÄ±ÅŸta "KullanÄ±cÄ±lar" sekmesi ve "Sayfa" gÃ¶rÃ¼nÃ¼mÃ¼ aÃ§Ä±k olsun
    setTimeout(()=>{
      if($("#tabList")){
        if(typeof setActiveTab==='function') setActiveTab("tabList");
        $("#viewAdd").style.display="none";
        $("#viewMan").style.display="none";
        $("#viewList").style.display="block";
        setTimeout(()=>{
          if($("#btnSayfa")) $("#btnSayfa").click();
        }, 50);
      }
    }, 200);
    
    console.log('initPage tamamlandÄ±');
  } catch (e) {
    console.error('Sayfa init hatasÄ±:', e);
    if (typeof window.showToast === 'function') {
      window.showToast('error', 'Hata', 'Veriler yÃ¼klenirken hata: ' + (e?.message || 'Bilinmeyen hata'));
    }
  }
};
</script>
</body>
</html>


