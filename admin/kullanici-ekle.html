<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>KullanÄ±cÄ± & Yetki YÃ¶netimi</title>
<link rel="icon" type="image/png" href="../img/logo.png" />
<link rel="stylesheet" href="../css/app-shell.css" />

<!-- ====== TEMA (panel.html ile aynÄ±) ====== -->
<style>
  :root{
    --appbar-h:56px;
    --radius:14px; --shadow:0 12px 28px rgba(0,0,0,.14);
    --bg:#f5f5f0; --bg2:#fafaf5;
    --grad1:#e5e5e022; --grad2:#d4d4d022;
    --card:rgba(255,255,255,.95); --stroke:rgba(15,23,42,.12);
    --text:#0b1220; --muted:#4b5563;
    --brand:#0ea5e9; --brand2:#0284c7;
    --pill:#f5f5f0; --pill-hover:#e9e9e4;
    --link:#0b5ea8; --surface:#f0f0eb;
    --ok:#33c27f; --danger:#ff4255;
  }
  /* Light tema varsayÄ±lan - dark tema kaldÄ±rÄ±ldÄ± */
  /* Sadece light tema kullanÄ±lÄ±yor - dark tema kaldÄ±rÄ±ldÄ± */

  *{box-sizing:border-box}
  body{
    margin:0; 
    padding:0;
    padding-top:var(--appbar-h) !important; /* Ãœst panel iÃ§in boÅŸluk */
    color:var(--text);
    font-family:ui-sans-serif,-apple-system,"Segoe UI",Roboto,Arial;
    background:
      radial-gradient(900px 680px at 12% 8%, var(--grad1), transparent 45%),
      radial-gradient(800px 640px at 88% 92%, var(--grad2), transparent 50%),
      linear-gradient(140deg, var(--bg), var(--bg2) 60%);
    overflow-x:hidden;
  }
  a{color:var(--link); text-decoration:none}
  a:hover{text-decoration:underline}

  /* APPBAR - app-shell.css'den geliyor, burada sadece Ã¶zel override'lar */
  .appbar{
    position:fixed !important; 
    top:0 !important; 
    left:0 !important;
    right:0 !important;
    z-index:60 !important;
  }

  /* LAYOUT */
  .container{width:100%; margin:0 auto; padding:8px; box-sizing:border-box}
  .grid{display:grid; gap:10px; grid-template-columns:repeat(12, minmax(0,1fr))}
  .col-8{grid-column:span 12}
  .col-4{grid-column:span 12}
  @media (max-width:980px){ 
    .col-8,.col-4{grid-column:span 12}
    .summary{position:static; margin-top:16px}
  }
  
  /* Mobil genel iyileÅŸtirmeler */
  @media (max-width: 640px){
    .container{padding:8px}
    .card{padding:12px}
    .mini{gap:6px}
    .btn{padding:6px 10px; font-size:12px}
    h3{font-size:15px}
    .kpi{padding:10px}
    .kpi .val{font-size:20px}
  }
  
  /* Tablet ve masaÃ¼stÃ¼ iÃ§in padding */
  @media (min-width: 641px){
    .container{padding:10px}
  }
  @media (min-width: 1024px){
    .container{padding:12px}
  }

  .card{background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px}
  .card h3{margin:0 0 10px; font-size:16px}
  .mini{display:flex; gap:8px; flex-wrap:wrap}
  .pill{padding:6px 10px; border-radius:999px; border:1px solid var(--stroke); background:var(--pill); font-size:12px}

  /* FORM */
  label{font-weight:700; display:block; margin:10px 0 6px; font-size:13px}
  input,select,textarea{width:100%; padding:11px 12px; border:1px solid var(--stroke); border-radius:12px; background:var(--pill); color:var(--text); outline:none; transition:all .15s ease; font-size:14px}
  input:focus,select:focus,textarea:focus{box-shadow:0 0 0 4px rgba(56,189,248,.18); border-color:var(--brand); background:var(--pill-hover)}
  input:disabled{opacity:.6; cursor:not-allowed}
  .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  @media(max-width:900px){.row{grid-template-columns:1fr}}

  /* PERM TREE */
  .perm-group{border:1px dashed var(--stroke); border-radius:12px; padding:12px; margin:12px 0; background:var(--surface)}
  .perm-head{display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:8px}
  .perm-grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(220px,1fr)); gap:8px}
  .perm-item{display:flex; align-items:center; gap:8px; background:var(--pill); border:1px solid var(--stroke); border-radius:999px; padding:8px 10px}
  .perm-item input{width:18px;height:18px}

  /* TABLE & CARDS */
  .table{width:100%; border-collapse:collapse; min-width:800px}
  .sayfa-grid{display:grid; grid-template-columns:repeat(auto-fill,minmax(400px,1fr)); gap:14px}
  .sayfa-card{background:var(--card); border:1px solid var(--stroke); border-radius:12px; padding:16px; transition:transform .15s ease, box-shadow .15s ease}
  .sayfa-card:hover{transform:translateY(-2px); box-shadow:0 8px 24px rgba(0,0,0,.12)}
  .sayfa-card-header{margin-bottom:14px; padding-bottom:12px; border-bottom:1px solid var(--stroke)}
  .sayfa-card-title{font-size:16px; font-weight:700; margin-bottom:6px; color:var(--text)}
  .sayfa-card-meta{display:flex; gap:8px; flex-wrap:wrap; align-items:center; font-size:12px; color:var(--muted)}
  .sayfa-card-body{margin-top:12px}
  .sayfa-personel-item{display:flex; align-items:center; justify-content:space-between; padding:8px 0; border-bottom:1px solid var(--pill)}
  .sayfa-personel-item:last-child{border-bottom:none}
  .sayfa-personel-name{font-size:13px; font-weight:500; flex:1}
  .sayfa-personel-checkbox{width:20px; height:20px; cursor:pointer; accent-color:var(--brand)}
  .gridcards{display:grid; grid-template-columns:repeat(auto-fill,minmax(500px,1fr)); gap:14px}
  .ucard{background:var(--card); border:1px solid var(--stroke); border-radius:12px; padding:14px; transition:transform .15s ease, box-shadow .15s ease}
  .ucard:hover{transform:translateY(-2px); box-shadow:0 8px 24px rgba(0,0,0,.12)}
  
  /* Mobil tablo gÃ¶rÃ¼nÃ¼mÃ¼ */
  @media (max-width: 900px){
    .table-wrapper{overflow-x:auto}
    .table th,.table td{padding:8px 6px; font-size:13px}
    .table th{font-size:11px}
  }
  
  /* Mobil kart gÃ¶rÃ¼nÃ¼mÃ¼ */
  @media (max-width: 768px){
    .gridcards{grid-template-columns:1fr; gap:12px}
    .ucard{padding:12px}
  }
  /* Tablet iÃ§in kart geniÅŸliÄŸi */
  @media (min-width: 769px) and (max-width: 1024px){
    .gridcards{grid-template-columns:repeat(auto-fill,minmax(350px,1fr)); gap:12px}
  }

  /* MODAL - app-shell.css'den geliyor */

  /* RIGHT SUMMARY */
  .summary{position:static}
  .kpi{display:flex; justify-content:space-between; align-items:center; padding:12px; background:var(--pill); border:1px solid var(--stroke); border-radius:12px; gap:12px}
  .kpi .val{font-size:24px; font-weight:800; color:var(--brand2); line-height:1.2}
  .kpi .sub{font-size:12px; color:var(--muted); margin-top:4px}
  .kpi > div:last-child{font-size:28px; opacity:.8}

  /* Toast - app-shell.css'den geliyor */
</style>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="../js/firebase/firebase-init.js"></script>
<!-- ORTAK APP SHELL JS -->
<script src="../js/ortak.js"></script>
</head>
<body>

<!-- ====== APPBAR ====== -->
<div class="appbar">
    <div class="brand" onclick="location.href='../panel.html'">
    <img src="../img/logo.png" alt="logo"><span>KARAAÄAÃ‡ FATÄ°H</span>
  </div>
  <nav class="nav-center"><ul class="nav-list" id="navMain"></ul></nav>
  <div class="nav-right">
    <button class="btn hamb" id="hamburger" title="MenÃ¼">â˜°</button>
    
    <!-- Bildirim -->
    <div class="nav-item">
      <button class="iconbtn" id="btnNotif" title="Bildirimler">ğŸ””
        <span class="badge" id="notifBadge" style="display:none">0</span>
      </button>
      <div class="dropdown drop-right" id="notifDropdown" aria-label="Bildirim listesi">
        <div class="muted" style="padding:6px 8px">Son bildirimler</div>
        <div id="notifList" style="max-height:300px;overflow:auto"></div>
        <a href="../diger/bildirim.html">TÃ¼m bildirimleri gÃ¶r â†’</a>
      </div>
    </div>

    <!-- Profil -->
    <div class="nav-item">
      <button class="iconbtn" id="btnProfile" title="Profil">
        <span id="profName" class="muted">Profil</span>
      </button>
      <div class="dropdown drop-right" id="profDropdown" aria-label="Profil menÃ¼sÃ¼">
        <a href="../diger/kullanici-yonetimi.html">ğŸ‘¤ Profil</a>
        <a href="../diger/sistem-ayarlari.html">âš™ï¸ Sistem AyarlarÄ±</a>
        <a href="#" id="btnLogout">ğŸšª Ã‡Ä±kÄ±ÅŸ Yap</a>
      </div>
    </div>
  </div>
</div>
<aside class="drawer" id="drawer"></aside>

<!-- Toast Container (ortak sistem) -->
<div class="toast-container" id="toastContainer"></div>

<!-- ====== CONTENT ====== -->
<main class="container">
  <div class="grid">
    <!-- SOL -->
    <section class="col-8" style="grid-column:span 12">
      <div class="card">
        <div class="mini" style="gap:6px">
          <button class="btn" id="tabAdd">KullanÄ±cÄ± Ekle</button>
          <button class="btn" id="tabMan">Yetki (Manifest)</button>
          <button class="btn" id="tabList">KullanÄ±cÄ±lar</button>
        </div>
      </div>

      <!-- EKLE -->
      <section id="viewAdd" class="card" style="display:none">
        <h3>KullanÄ±cÄ± Ekle</h3>
        <form id="frmAdd" style="margin-top:8px">
          <div class="row">
            <div><label>Ad Soyad</label><input id="adSoyad" required></div>
            <div>
              <label>Rol</label>
              <select id="rol" required>
                <option value="" disabled selected>SeÃ§iniz</option>
                <option>admin</option><option>personel</option><option>ziyaret</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div><label>GÃ¶rev</label><input id="gorev" required></div>
            <div>
              <label>E-posta</label>
              <input id="email" type="email" required>
              <div id="emailHint" style="margin-top:6px;font-size:12px;color:var(--muted)">â€”</div>
            </div>
          </div>
          <div class="row">
            <div>
              <label>GeÃ§ici Åifre</label>
              <div class="mini" style="align-items:center">
                <input id="sifre" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" style="flex:1">
                <button type="button" class="btn" id="togglePw">ğŸ‘</button>
                <button type="button" class="btn" id="btnPwGen">Rastgele</button>
                <label class="mini" style="align-items:center"><input type="checkbox" id="chkEmailNotify" checked> <span style="font-size:12px;color:var(--muted)">E-posta bildir</span></label>
              </div>
              <div style="margin-top:8px;height:8px;background:var(--surface);border-radius:6px;overflow:hidden"><span id="meterBar" style="display:block;height:100%;width:0%"></span></div>
              <div id="pwLabel" style="margin-top:6px;font-size:12px;color:var(--muted)">GÃ¼Ã§: â€”</div>
            </div>
            <div class="mini" style="align-items:center"><span class="pill">KayÄ±ttan sonra ÅŸifre sÄ±fÄ±rlama e-postasÄ± gider.</span></div>
          </div>

          <label style="margin-top:8px">Yetkiler</label>
          <div id="permTreeAdd"><div class="pill">Manifest boÅŸsa â€œYetki (Manifest)â€ sekmesinden ekleyin.</div></div>

          <div class="mini" style="margin-top:12px">
            <button type="button" class="btn" id="btnPreview">Ã–nizle</button>
            <button class="btn" id="btnSubmit">Kaydet</button>
          </div>
        </form>
      </section>

      <!-- MANIFEST -->
      <section id="viewMan" class="card" style="display:none">
        <h3>Yetki (Manifest)</h3>
        <form id="frmPanel" style="margin-top:8px">
          <div class="row">
            <div><label>Panel Anahtar</label><input id="p_key" placeholder="Talebe" required></div>
            <div><label>Panel BaÅŸlÄ±k</label><input id="p_title" placeholder="Talebe Paneli" required></div>
          </div>
          <div class="row">
            <div><label>SÄ±ra</label><input id="p_order" type="number" value="1"></div>
            <div class="mini" style="align-items:end">
              <button class="btn" id="btnPanelSave">Kaydet/GÃ¼ncelle</button>
              <button type="button" class="btn" id="btnQuickPanels">HÄ±zlÄ± Panel Seti</button>
            </div>
          </div>
        </form>

        <div style="height:12px"></div>
        <form id="frmPage">
          <div class="row">
            <div><label>Panel SeÃ§</label><select id="s_panel" required></select></div>
            <div><label>Sayfa BaÅŸlÄ±k</label><input id="s_title" required></div>
          </div>
          <div class="row">
            <div><label>Path</label><input id="s_path" placeholder="talebe/talebe-liste.html" required></div>
            <div><label>SÄ±ra</label><input id="s_order" type="number" value="1"></div>
          </div>
          <div class="mini"><button class="btn" id="btnPageAdd">Ekle</button></div>
        </form>

        <div style="height:12px"></div>
        <div class="card" style="padding:12px">
          <h3>Mevcut Manifest</h3>
          <div id="manifestList" style="margin-top:6px"><div class="pill">Panel ve sayfalar burada listelenir.</div></div>
        </div>
      </section>

      <!-- LÄ°STE -->
      <section id="viewList" class="card">
        <h3 style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px">
          <span>ğŸ‘¥ KullanÄ±cÄ±lar</span>
          <span class="mini" style="gap:6px">
            <button class="btn" id="btnSayfa" style="background:var(--brand);color:#fff">ğŸ“„ Sayfa</button>
            <button class="btn" id="btnPersonel">ğŸ‘¤ Personel</button>
          </span>
        </h3>
        <div class="mini" style="margin-bottom:10px;flex-wrap:wrap;gap:8px">
          <input id="sch" placeholder="ğŸ” Ara (ad, e-posta, gÃ¶rev)" style="min-width:220px;flex:1;max-width:400px">
          <select id="fltRol" style="min-width:140px"><option value="">Rol (tÃ¼mÃ¼)</option><option>admin</option><option>personel</option><option>ziyaret</option></select>
          <select id="fltDurum" style="min-width:140px"><option value="">Durum (tÃ¼mÃ¼)</option><option value="true">Aktif</option><option value="false">Pasif</option></select>
          <button class="btn" id="btnRef">ğŸ”„ Yenile</button>
        </div>

        <!-- Ã–ZET - KartlarÄ±n Ã¼stÃ¼nde -->
        <div id="summaryCardInline" style="display:none;margin-bottom:14px">
          <div class="card summary" style="position:static;margin:0">
            <h3>Ã–zet</h3>
            <div class="mini" style="flex-direction:row;flex-wrap:wrap; gap:10px; margin-top:8px">
              <div class="kpi" style="flex:1;min-width:150px"><div><div class="val" id="kpiUsersInline">â€”</div><div class="sub">Toplam KullanÄ±cÄ±</div></div><div>ğŸ‘¥</div></div>
              <div class="kpi" style="flex:1;min-width:150px"><div><div class="val" id="kpiActiveInline">â€”</div><div class="sub">Aktif</div></div><div>âœ…</div></div>
              <div class="kpi" style="flex:1;min-width:150px"><div><div class="val" id="kpiPassiveInline">â€”</div><div class="sub">Pasif</div></div><div>â›”</div></div>
              <div class="kpi" style="flex:1;min-width:150px"><div><div class="val" id="kpiPanelsInline">â€”</div><div class="sub">Panel</div></div><div>ğŸ“¦</div></div>
              <div class="kpi" style="flex:1;min-width:150px"><div><div class="val" id="kpiPagesInline">â€”</div><div class="sub">Sayfa</div></div><div>ğŸ§©</div></div>
            </div>
          </div>
        </div>

        <div id="sayfaWrap" class="sayfa-grid" style="display:none"></div>
        <div id="usersCardsWrap" class="gridcards" style="display:none"></div>
      </section>
    </section>

    <!-- Ã–ZET - KartlarÄ±n arasÄ±nda gÃ¶sterilecek -->
    <div id="summaryCard" style="display:none;grid-column:span 12">
      <div class="card summary" style="position:static;margin:0">
        <h3>Ã–zet</h3>
        <div class="mini" style="flex-direction:row;flex-wrap:wrap; gap:10px; margin-top:8px">
          <div class="kpi" style="flex:1;min-width:150px"><div><div class="val" id="kpiUsers">â€”</div><div class="sub">Toplam KullanÄ±cÄ±</div></div><div>ğŸ‘¥</div></div>
          <div class="kpi" style="flex:1;min-width:150px"><div><div class="val" id="kpiActive">â€”</div><div class="sub">Aktif</div></div><div>âœ…</div></div>
          <div class="kpi" style="flex:1;min-width:150px"><div><div class="val" id="kpiPassive">â€”</div><div class="sub">Pasif</div></div><div>â›”</div></div>
          <div class="kpi" style="flex:1;min-width:150px"><div><div class="val" id="kpiPanels">â€”</div><div class="sub">Panel</div></div><div>ğŸ“¦</div></div>
          <div class="kpi" style="flex:1;min-width:150px"><div><div class="val" id="kpiPages">â€”</div><div class="sub">Sayfa</div></div><div>ğŸ§©</div></div>
        </div>
      </div>
    </div>
  </div>
</main>


<!-- Ã–NÄ°ZLEME MODAL -->
<div class="modal" id="mPrev">
  <div class="sheet">
    <header>
      <h3>KayÄ±t Ã–nizleme</h3>
    </header>
    <div class="body" id="prevContent"></div>
    <footer>
      <button class="btn btn-ghost" id="btnPrevClose">VazgeÃ§</button>
      <button class="btn btn-primary" id="btnPrevOk">Onayla & Kaydet</button>
    </footer>
  </div>
</div>

<!-- DÃœZENLE MODAL -->
<div class="modal" id="mEdit">
  <div class="sheet">
    <header>
      <h3>KullanÄ±cÄ± DÃ¼zenle</h3>
    </header>
    <div class="body">
      <form id="frmEdit">
        <input type="hidden" id="e_uid">
        <div class="row"><div><label>Ad Soyad</label><input id="e_ad"></div><div><label>Rol</label><select id="e_rol"><option>admin</option><option>personel</option><option>ziyaret</option></select></div></div>
        <div class="row"><div><label>GÃ¶rev</label><input id="e_gorev"></div><div><label>E-posta</label><input id="e_mail" type="email" disabled></div></div>
        <label style="margin-top:10px">Yetkiler</label>
        <div id="permTreeEdit"></div>
        <div class="row"><div><label><input type="checkbox" id="e_aktif"> Aktif</label></div></div>
      </form>
    </div>
    <footer>
      <button class="btn btn-ghost" id="btnEditClose">Kapat</button>
      <button class="btn btn-primary" id="btnEditSave">Kaydet</button>
    </footer>
  </div>
</div>

<!-- SAYFA DÃœZENLE MODAL -->
<div class="modal" id="mEditPage">
  <div class="sheet">
    <header>
      <h3>Sayfa DÃ¼zenle</h3>
    </header>
    <div class="body">
      <form id="frmEditPage">
        <input type="hidden" id="ep_panel">
        <input type="hidden" id="ep_key">
        <div class="row">
          <div><label>Panel</label><input id="ep_panelName" disabled></div>
          <div><label>Sayfa BaÅŸlÄ±k</label><input id="ep_title" required></div>
        </div>
        <div class="row">
          <div><label>Path</label><input id="ep_path" placeholder="talebe/talebe-liste.html" required></div>
          <div><label>SÄ±ra</label><input id="ep_order" type="number" value="1"></div>
        </div>
      </form>
    </div>
    <footer>
      <button class="btn btn-ghost" id="btnEditPageClose">VazgeÃ§</button>
      <button class="btn btn-primary" id="btnEditPageSave">GÃ¼ncelle</button>
    </footer>
  </div>
</div>

<!-- ====== JS ====== -->
<script>
/* ===== Tema - Sadece AÃ§Ä±k Tema ===== */
(function(){
  const root=document.documentElement;
  // Sadece light tema kullan
  root.setAttribute('data-theme','light');
  // Tema butonunu gizle veya kaldÄ±r
  const btn=document.getElementById('themeToggle');
  if(btn){
    btn.style.display='none';
  }
})();

/* ===== Shortcuts ===== */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));

// db ve auth ortak.js'den geliyor, window.db ve window.auth olarak eriÅŸilebilir
// Ortak.js'de zaten tanÄ±mlÄ±, burada tekrar tanÄ±mlamaya gerek yok
// Helper fonksiyonlarÄ±
const getDb = () => window.db || (typeof firebase !== 'undefined' ? firebase.firestore() : null);
const getAuth = () => window.auth || (typeof firebase !== 'undefined' ? firebase.auth() : null);

// escapeHtml ve normalizeUrl ortak.js'den geliyor
// showToast ortak.js'den geliyor (window.showToast)

/* ===== Nav - ortak.js'den geliyor ===== */
// fetchPanels ve renderNav ortak.js'den geliyor
// initAppShell ortak.js'den geliyor

/* ===== Tabs ===== */
function setActiveTab(activeId){
  ["tabAdd","tabMan","tabList"].forEach(id=>{
    const btn=$("#"+id);
    if(btn){
      if(id===activeId){
        btn.style.background="var(--brand)";
        btn.style.color="#fff";
      }else{
        btn.style.background="";
        btn.style.color="";
      }
    }
  });
}
$("#tabAdd").onclick=()=>{ 
  setActiveTab("tabAdd");
  $("#viewAdd").style.display="block"; 
  $("#viewMan").style.display="none"; 
  $("#viewList").style.display="none"; 
};
$("#tabMan").onclick=()=>{ 
  setActiveTab("tabMan");
  $("#viewAdd").style.display="none"; 
  $("#viewMan").style.display="block"; 
  $("#viewList").style.display="none"; 
};
$("#tabList").onclick=()=>{ 
  setActiveTab("tabList");
  $("#viewAdd").style.display="none"; 
  $("#viewMan").style.display="none"; 
  $("#viewList").style.display="block"; 
};


/* ===== Manifest & Permission Trees ===== */
let manifest={};

function renderPermTree(targetSel, selected=[]){
  const wrap=document.createElement("div");
  const selectedSet=new Set((selected||[]).map(s=>String(s).trim()));
  Object.keys(manifest).sort((a,b)=>(manifest[a].order||0)-(manifest[b].order||0)).forEach(panelKey=>{
    const grp=document.createElement("div"); grp.className="perm-group"; grp.dataset.group=panelKey;
    
    // GÃ¼venli DOM oluÅŸturma (innerHTML yerine)
    const head=document.createElement("div"); head.className="perm-head";
    const titleDiv=document.createElement("div");
    const titleB=document.createElement("b"); titleB.textContent=manifest[panelKey].title || panelKey;
    const pill=document.createElement("span"); pill.className="pill"; pill.textContent=panelKey;
    titleDiv.appendChild(titleB); titleDiv.appendChild(document.createTextNode(" ")); titleDiv.appendChild(pill);
    
    const btnSpan=document.createElement("span"); btnSpan.className="mini";
    const btnAll=document.createElement("button"); btnAll.type="button"; btnAll.className="btn"; btnAll.dataset.gsel=panelKey; btnAll.textContent="Hepsi";
    const btnClr=document.createElement("button"); btnClr.type="button"; btnClr.className="btn"; btnClr.dataset.gclr=panelKey; btnClr.textContent="Temizle";
    btnSpan.appendChild(btnAll); btnSpan.appendChild(btnClr);
    head.appendChild(titleDiv); head.appendChild(btnSpan);
    
    const grid=document.createElement("div"); grid.className="perm-grid";
    (manifest[panelKey].pages||[]).forEach(p=>{
      const val=p.key || `${panelKey}: ${p.title}`;
      const label=document.createElement("label"); label.className="perm-item";
      const chk=document.createElement("input"); chk.type="checkbox"; chk.value=val;
      if(selectedSet.has(val)) chk.checked=true;
      const span=document.createElement("span"); span.textContent=p.title || '';
      label.appendChild(chk); label.appendChild(span);
      grid.appendChild(label);
    });
    
    grp.appendChild(head); grp.appendChild(grid);
    wrap.appendChild(grp);
  });
  const target=$(targetSel); if(target){ target.innerHTML=''; target.appendChild(wrap); }

  // Grup butonlarÄ±
  target.querySelectorAll("[data-gsel]").forEach(btn=>{
    btn.onclick=()=>{ const g=btn.dataset.gsel; target.querySelectorAll(`.perm-group[data-group="${g}"] input`).forEach(c=>c.checked=true); };
  });
  target.querySelectorAll("[data-gclr]").forEach(btn=>{
    btn.onclick=()=>{ const g=btn.dataset.gclr; target.querySelectorAll(`.perm-group[data-group="${g}"] input`).forEach(c=>c.checked=false); };
  });
}
const getChecked = root => Array.from(document.querySelectorAll(`${root} input[type=checkbox]:checked`)).map(i=>i.value);

function fillPanelSelect(){
  const sel=$("#s_panel"); 
  if(!sel) return;
  const keys=Object.keys(manifest).sort((a,b)=> (manifest[a].order||0)-(manifest[b].order||0));
  sel.innerHTML = '';
  const escape = typeof window.escapeHtml === 'function' ? window.escapeHtml : (t => String(t || ''));
  keys.forEach(k=>{
    const opt = document.createElement('option');
    opt.value = escape(k);
    opt.textContent = `${manifest[k].title} (${k})`;
    sel.appendChild(opt);
  });
}
function renderManifestAdmin(){
  const box=$("#manifestList");
  if(!box) return;
  if(!Object.keys(manifest).length){
    box.innerHTML='<div class="pill">HenÃ¼z panel yok.</div>';
    return;
  }
  box.innerHTML="";
  Object.keys(manifest).sort((a,b)=> (manifest[a].order||0)-(manifest[b].order||0)).forEach(k=>{
    const p=manifest[k];
    const it=document.createElement("div"); it.className="perm-group";
    
    // GÃ¼venli DOM oluÅŸturma
    const head=document.createElement("div"); head.className="perm-head";
    const titleDiv=document.createElement("div");
    const titleB=document.createElement("b"); titleB.textContent=p.title||k;
    const pill=document.createElement("span"); pill.className="pill"; pill.textContent=k;
    titleDiv.appendChild(titleB); titleDiv.appendChild(document.createTextNode(" ")); titleDiv.appendChild(pill);
    
    const delBtn=document.createElement("button"); delBtn.className="btn"; delBtn.dataset.delPanel=k; delBtn.textContent="Paneli Sil";
    head.appendChild(titleDiv); head.appendChild(delBtn);
    it.appendChild(head);
    
    if(p.pages && p.pages.length > 0){
      p.pages.forEach(pg=>{
        const pageDiv=document.createElement("div");
        pageDiv.className="mini";
        pageDiv.style.justifyContent="space-between";
        pageDiv.style.border="1px solid var(--stroke)";
        pageDiv.style.borderRadius="10px";
        pageDiv.style.padding="8px";
        pageDiv.style.background="var(--surface)";
        pageDiv.style.marginBottom="6px";
        
        const leftDiv=document.createElement("div");
        const pgTitle=document.createElement("b"); pgTitle.textContent=pg.title||"";
        const pgPill=document.createElement("span"); pgPill.className="pill"; pgPill.style.marginLeft="6px"; pgPill.textContent=pg.path||"";
        leftDiv.appendChild(pgTitle); leftDiv.appendChild(document.createTextNode(" ")); leftDiv.appendChild(pgPill);
        
        const btnSpan=document.createElement("span"); btnSpan.className="mini";
        const editData=JSON.stringify({panel:k,key:pg.key||`${k}: ${pg.title}`});
        const editBtn=document.createElement("button"); editBtn.className="btn"; editBtn.dataset.editPage=editData; editBtn.textContent="DÃ¼zenle";
        const delPageBtn=document.createElement("button"); delPageBtn.className="btn"; delPageBtn.dataset.delPage=editData; delPageBtn.textContent="Sil";
        btnSpan.appendChild(editBtn); btnSpan.appendChild(delPageBtn);
        
        pageDiv.appendChild(leftDiv); pageDiv.appendChild(btnSpan);
        it.appendChild(pageDiv);
      });
    }else{
      const noPage=document.createElement("div"); noPage.className="pill"; noPage.textContent="Sayfa yok.";
      it.appendChild(noPage);
    }
    
    box.appendChild(it);
  });

  box.querySelectorAll("[data-del-panel]").forEach(b=>{
    b.onclick=async()=>{ if(!confirm("Panel silinsin mi?")) return; const db=getDb(); if(db) await db.collection("sayfa_manifesti").doc(b.dataset.delPanel).delete(); if(typeof window.showToast==='function') window.showToast('success','BaÅŸarÄ±lÄ±','Panel silindi'); };
  });
  box.querySelectorAll("[data-del-page]").forEach(b=>{
    b.onclick=async()=>{ const d=JSON.parse(b.dataset.delPage);
      const db=getDb(); if(!db) return; const ref=db.collection("sayfa_manifesti").doc(d.panel); const doc=await ref.get(); if(!doc.exists) return;
      const v=doc.data(); const arr=(v.pages||[]).filter(x=>(x.key||`${d.panel}: ${x.title}`)!==d.key);
      await ref.update({pages:arr}); if(typeof window.showToast==='function') window.showToast('success','BaÅŸarÄ±lÄ±','Sayfa silindi');
    };
  });
  box.querySelectorAll("[data-edit-page]").forEach(b=>{
    b.onclick=async()=>{
      try{
        const d=JSON.parse(b.dataset.editPage);
        const db=getDb(); if(!db) return; const doc=await db.collection("sayfa_manifesti").doc(d.panel).get();
        if(!doc.exists){
          if(typeof window.showToast==='function') window.showToast('warning','UyarÄ±','Panel bulunamadÄ±');
          return;
        }
        const pg=(doc.data().pages||[]).find(x=>(x.key||`${d.panel}: ${x.title}`)===d.key);
        if(!pg){
          if(typeof window.showToast==='function') window.showToast('warning','UyarÄ±','Sayfa bulunamadÄ±');
          return;
        }
        
        // Modal'Ä± doldur ve aÃ§
        if(mEditPage){
          $("#ep_panel").value=d.panel;
          $("#ep_key").value=d.key;
          $("#ep_panelName").value=manifest[d.panel]?.title || d.panel;
          $("#ep_title").value=pg.title||"";
          $("#ep_path").value=pg.path||"";
          $("#ep_order").value=pg.order||0;
          mEditPage.classList.add('open');
        }
      }catch(e){
        console.error('Sayfa dÃ¼zenleme hatasÄ±:', e);
        if(typeof window.showToast==='function') window.showToast('error','Hata',e?.message||'Bilinmeyen hata');
      }
    };
  });
}

/* ===== Manifest actions ===== */
$("#btnPanelSave").onclick=async(e)=>{
  e.preventDefault();
  const key=$("#p_key").value.trim(), title=$("#p_title").value.trim(), order=parseInt($("#p_order").value||"0");
  if(!key||!title){ if(typeof window.showToast==='function') window.showToast('warning','UyarÄ±','Panel anahtar/baÅŸlÄ±k gerekli'); return; }
  const db=getDb(); if(!db) return; await db.collection("sayfa_manifesti").doc(key).set({title,order}, {merge:true});
  $("#frmPanel").reset(); if(typeof window.showToast==='function') window.showToast('success','BaÅŸarÄ±lÄ±','Panel kaydedildi');
};
$("#btnQuickPanels").onclick=async()=>{
  if(!confirm("Standart paneller eklensin mi?")) return;
  const panels=[{key:"Admin",title:"Admin Paneli",order:5},{key:"Talebe",title:"Talebe Paneli",order:10},{key:"Personel",title:"Personel Paneli",order:20},{key:"Nehari",title:"Nehari Paneli",order:30},{key:"Kermes",title:"Kermes Paneli",order:40},{key:"Muhasebe",title:"Muhasebe Paneli",order:50},{key:"Sistem AyarlarÄ±",title:"Sistem AyarlarÄ±",order:60},];
  const db=getDb(); if(!db) return; const batch=db.batch(); panels.forEach(p=> batch.set(db.collection("sayfa_manifesti").doc(p.key), {title:p.title, order:p.order}, {merge:true}));
  await batch.commit(); if(typeof window.showToast==='function') window.showToast('success','BaÅŸarÄ±lÄ±','Paneller eklendi');
};
$("#btnPageAdd").onclick=async(e)=>{
  e.preventDefault();
  const panel=$("#s_panel").value, title=$("#s_title").value.trim(), path=$("#s_path").value.trim(), order=parseInt($("#s_order").value||"9999");
  if(!panel||!title||!path){ if(typeof window.showToast==='function') window.showToast('warning','UyarÄ±','Panel, baÅŸlÄ±k ve path zorunlu'); return; }
  const db=getDb(); if(!db) return; const ref=db.collection("sayfa_manifesti").doc(panel); const snap=await ref.get();
  const cur=snap.exists? (snap.data()||{}):{pages:[]};
  const key=`${panel}: ${title}`;
  const map=new Map((cur.pages||[]).map(p=>[(p.key||`${panel}: ${p.title}`), p]));
  map.set(key,{key,title,path,order});
  const merged=[...map.values()].sort((a,b)=>(a.order||0)-(b.order||0) || String(a.title).localeCompare(String(b.title),"tr"));
  await ref.set({pages:merged},{merge:true});
  $("#frmPage").reset(); fillPanelSelect(); if(typeof window.showToast==='function') window.showToast('success','BaÅŸarÄ±lÄ±','Sayfa eklendi');
};

/* ===== Sayfa DÃ¼zenle Modal ===== */
const mEditPage=$("#mEditPage");
if(mEditPage){
  // Backdrop'a tÄ±klanÄ±nca kapat (modal element'ine tÄ±klanÄ±nca)
  mEditPage.onclick=(e)=>{
    if(e.target===mEditPage) mEditPage.classList.remove('open');
  };
}
if($("#btnEditPageClose")){
  $("#btnEditPageClose").onclick=()=>{
    if(mEditPage) mEditPage.classList.remove('open');
  };
}
if($("#btnEditPageSave")){
  $("#btnEditPageSave").onclick=async()=>{
    const btn=$("#btnEditPageSave");
    const originalText=btn.textContent;
    btn.disabled=true;
    btn.textContent='â³ GÃ¼ncelleniyor...';
    
    try{
      const panel=$("#ep_panel")?.value||"";
      const key=$("#ep_key")?.value||"";
      const title=$("#ep_title")?.value.trim()||"";
      const path=$("#ep_path")?.value.trim()||"";
      const order=parseInt($("#ep_order")?.value||"0");
      
      if(!panel || !key || !title || !path){
        throw new Error('TÃ¼m alanlar zorunludur');
      }
      
      if(!db){
        throw new Error('Firebase baÄŸlantÄ±sÄ± yok');
      }
      
      const db=getDb(); if(!db) throw new Error('Firebase baÄŸlantÄ±sÄ± yok'); const ref=db.collection("sayfa_manifesti").doc(panel);
      const snap=await ref.get();
      if(!snap.exists){
        throw new Error('Panel bulunamadÄ±');
      }
      
      const cur=snap.data()||{};
      const pages=Array.isArray(cur.pages)? cur.pages : [];
      const updatedPages=pages.map(p=>{
        const pKey=p.key||`${panel}: ${p.title}`;
        if(pKey===key){
          return {key,title,path,order};
        }
        return p;
      }).sort((a,b)=>(a.order||0)-(b.order||0) || String(a.title).localeCompare(String(b.title),"tr"));
      
      await ref.set({pages:updatedPages},{merge:true});
      
      if(mEditPage) mEditPage.classList.remove('open');
      if(typeof window.showToast==='function') window.showToast('success','BaÅŸarÄ±lÄ±','Sayfa gÃ¼ncellendi');
    }catch(e){
      console.error('Sayfa gÃ¼ncelleme hatasÄ±:', e);
      if(typeof window.showToast==='function') window.showToast('error','Hata',e?.message||e||'Bilinmeyen hata');
    }finally{
      btn.disabled=false;
      btn.textContent=originalText;
    }
  };
}

/* ===== Password meter ===== */
const pw=$("#sifre"), meterBar=$("#meterBar"), pwLabel=$("#pwLabel");
function scorePw(p){ let s=0; if(p.length>=8) s++; if(/[A-Z]/.test(p)) s++; if(/[0-9]/.test(p)) s++; if(/[^A-Za-z0-9]/.test(p)) s++; return s; }
function renderMeter(){ const s=scorePw(pw.value); let w=0,c="#ef4444",t="ZayÄ±f"; if(s<=1){w=25}else if(s<=3){w=60;c="#f59e0b";t="Ä°yi"} else {w=100;c="#22c55e";t="GÃ¼Ã§lÃ¼"} meterBar.style.width=w+"%"; meterBar.style.background=c; pwLabel.textContent="GÃ¼Ã§: "+t; }
pw.addEventListener("input",renderMeter); renderMeter();
$("#togglePw").onclick=()=>{ pw.type = pw.type==="password" ? "text" : "password"; };
$("#btnPwGen").onclick=()=>{ const chars="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()_+"; const rnd=(len)=>Array.from(crypto.getRandomValues(new Uint32Array(len))).map(n=>chars[n%chars.length]).join(""); pw.value=rnd(12); renderMeter(); if(typeof window.showToast==='function') window.showToast('success','BaÅŸarÄ±lÄ±','Rastgele ÅŸifre oluÅŸturuldu'); };
if($("#email")){
  $("#email").addEventListener("input",()=>{
    const v=$("#email").value.trim();
    const hint=$("#emailHint");
    if(hint){
      if(!v){
        hint.textContent = "â€”";
      } else {
        // Email regex dÃ¼zeltmesi (\\ yerine \)
        const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
        hint.textContent = emailRegex.test(v) ? "âœ”ï¸ geÃ§erli gÃ¶rÃ¼nÃ¼yor" : "âš ï¸ geÃ§ersiz e-posta";
      }
    }
  });
}

/* ===== Ã–nizleme & Ekle ===== */
const mPrev=$("#mPrev");
if(mPrev){
  // Backdrop'a tÄ±klanÄ±nca kapat
  mPrev.onclick=(e)=>{
    if(e.target===mPrev) mPrev.classList.remove('open');
  };
}
if($("#btnPreview")){
  $("#btnPreview").onclick=()=>{
    const yetkiler=getChecked("#permTreeAdd");
    const content=$("#prevContent");
    if(content){
      // GÃ¼venli DOM oluÅŸturma
      content.innerHTML='';
      const div=document.createElement("div"); div.className="mini"; div.style.flexDirection="column"; div.style.gap="6px";
      const fields=[
        ["Ad Soyad", $("#adSoyad")?.value||"-"],
        ["Rol", $("#rol")?.value||"-"],
        ["GÃ¶rev", $("#gorev")?.value||"-"],
        ["E-posta", $("#email")?.value||"-"],
        ["Yetkiler", yetkiler.length? yetkiler.join(", "):"â€”"]
      ];
      fields.forEach(([label,value])=>{
        const row=document.createElement("div");
        const b=document.createElement("b"); b.textContent=label+": ";
        row.appendChild(b);
        row.appendChild(document.createTextNode(String(value)));
        div.appendChild(row);
      });
      content.appendChild(div);
    }
    if(mPrev) mPrev.classList.add('open');
  };
}
if($("#btnPrevClose")){
  $("#btnPrevClose").onclick=()=> { if(mPrev) mPrev.classList.remove('open'); };
}
$("#frmAdd").addEventListener("submit",(e)=>{ e.preventDefault(); $("#btnPreview").click(); });

async function createUserSecondary(email,password){
  if(!email || !password){
    throw new Error('E-posta ve ÅŸifre gerekli');
  }
  if(password.length < 6){
    throw new Error('Åifre en az 6 karakter olmalÄ±');
  }
  try {
    const cfg=firebase.app().options;
    let sec=firebase.apps.find(a=>a.name==="Secondary");
    if(!sec) sec=firebase.initializeApp(cfg,"Secondary");
    const secAuth=sec.auth();
    const cred=await secAuth.createUserWithEmailAndPassword(email,password);
    // Åifre sÄ±fÄ±rlama e-postasÄ± gÃ¶nder
    try{
      await secAuth.sendPasswordResetEmail(email);
    }catch(e){
      console.warn('Åifre sÄ±fÄ±rlama e-postasÄ± gÃ¶nderilemedi:', e);
      // Kritik deÄŸil, devam et
    }
    // Secondary app'i temizle
    try{
      await sec.delete();
    }catch(e){
      console.warn('Secondary app silinemedi:', e);
    }
    return cred;
  } catch(e){
    // Secondary app'i temizle (hata olsa bile)
    try{
      const sec=firebase.apps.find(a=>a.name==="Secondary");
      if(sec) await sec.delete();
    }catch(cleanErr){}
    throw e;
  }
}
if($("#btnPrevOk")){
  $("#btnPrevOk").onclick=async()=>{
    if(mPrev) mPrev.classList.remove('open');
    const btn=$("#btnPrevOk");
    const originalText=btn.textContent;
    btn.disabled=true;
    btn.textContent='â³ Kaydediliyor...';
    
    try{
      const adSoyad=$("#adSoyad")?.value.trim()||"", email=$("#email")?.value.trim()||"", sifre=$("#sifre")?.value||"", rol=$("#rol")?.value||"", gorev=$("#gorev")?.value.trim()||"";
      const yetkiler=getChecked("#permTreeAdd");
      
      // Input validasyonu
      if(!adSoyad || adSoyad.length < 2){
        throw new Error('Ad Soyad en az 2 karakter olmalÄ±');
      }
      if(!email){
        throw new Error('E-posta gerekli');
      }
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if(!emailRegex.test(email)){
        throw new Error('GeÃ§ersiz e-posta formatÄ±');
      }
      if(!sifre || sifre.length < 6){
        throw new Error('Åifre en az 6 karakter olmalÄ±');
      }
      if(!rol){
        throw new Error('Rol seÃ§ilmelidir');
      }
      if(!gorev || gorev.length < 2){
        throw new Error('GÃ¶rev en az 2 karakter olmalÄ±');
      }
      
      if(!db){
        throw new Error('Firebase baÄŸlantÄ±sÄ± yok');
      }
      
      const cred=await createUserSecondary(email,sifre);
      const uid=cred.user.uid;
      await db.collection("kullanicilar").doc(uid).set({
        adSoyad,email,rol,gorev,yetkiler,aktif:true,
        eklenmeTarihi: firebase.firestore.FieldValue.serverTimestamp()
      },{merge:true});
      
      if($("#frmAdd")) $("#frmAdd").reset();
      if(typeof renderMeter === 'function') renderMeter();
      renderPermTree("#permTreeAdd");
      if(typeof window.showToast==='function') window.showToast('success','BaÅŸarÄ±lÄ±','KullanÄ±cÄ± baÅŸarÄ±yla eklendi');
    }catch(err){
      console.error('KullanÄ±cÄ± ekleme hatasÄ±:', err);
      if(typeof window.showToast==='function') window.showToast('error','Hata',err?.message||err||'Bilinmeyen hata');
    }finally{
      btn.disabled=false;
      btn.textContent=originalText;
    }
  };
}

/* ===== KullanÄ±cÄ±lar ===== */
let USERS=[]; let unsubUsers=null;
function normalizeYetkiler(v){ if(Array.isArray(v)) return v.map(s=>String(s).trim()).filter(Boolean); if(typeof v==='string') return v.split(/[,\n;]+/).map(s=>s.trim()).filter(Boolean); return []; }

function listenUsers(){
  if(unsubUsers) unsubUsers();
  const db=getDb(); if(!db) return; unsubUsers = db.collection("kullanicilar").orderBy("eklenmeTarihi","desc").onSnapshot(snap=>{
    USERS = snap.docs.map(d=>({uid:d.id, ...d.data()}));
    renderKPIs(); 
    // Hangi gÃ¶rÃ¼nÃ¼m aktifse onu render et
    const sayfaWrap=$("#sayfaWrap");
    const isSayfa = sayfaWrap && (sayfaWrap.style.display==="grid" || sayfaWrap.style.display==="block");
    if(isSayfa) renderSayfa(); else renderUsers();
  });
}
function renderKPIs(){
  const total=USERS.length, active=USERS.filter(u=>u.aktif!==false).length, passive=total-active;
  const panels=Object.keys(manifest).length;
  const pages=Object.values(manifest).reduce((s,p)=>s+(p.pages?.length||0),0);
  
  // Eski Ã¶zet (sidebar)
  if($("#kpiUsers")) $("#kpiUsers").textContent=total;
  if($("#kpiActive")) $("#kpiActive").textContent=active;
  if($("#kpiPassive")) $("#kpiPassive").textContent=passive;
  if($("#kpiPanels")) $("#kpiPanels").textContent=panels;
  if($("#kpiPages")) $("#kpiPages").textContent=pages;
  
  // Yeni inline Ã¶zet (filtrelerin altÄ±nda)
  if($("#kpiUsersInline")) $("#kpiUsersInline").textContent=total;
  if($("#kpiActiveInline")) $("#kpiActiveInline").textContent=active;
  if($("#kpiPassiveInline")) $("#kpiPassiveInline").textContent=passive;
  if($("#kpiPanelsInline")) $("#kpiPanelsInline").textContent=panels;
  if($("#kpiPagesInline")) $("#kpiPagesInline").textContent=pages;
  
  // Ã–zeti gÃ¶ster (her zaman gÃ¶rÃ¼nÃ¼r)
  const summaryInline=$("#summaryCardInline");
  if(summaryInline) summaryInline.style.display="block";
}
if($("#btnSayfa")){
  $("#btnSayfa").onclick=()=>{
    $("#usersCardsWrap").style.display="none";
    $("#sayfaWrap").style.display="grid";
    $("#btnSayfa").style.background="var(--brand)";
    $("#btnSayfa").style.color="#fff";
    $("#btnPersonel").style.background="";
    $("#btnPersonel").style.color="";
    renderSayfa();
    renderKPIs(); // Ã–zeti gÃ¼ncelle
  };
}
if($("#btnPersonel")){
  $("#btnPersonel").onclick=()=>{
    $("#sayfaWrap").style.display="none";
    $("#usersCardsWrap").style.display="grid";
    $("#btnPersonel").style.background="var(--brand)";
    $("#btnPersonel").style.color="#fff";
    $("#btnSayfa").style.background="";
    $("#btnSayfa").style.color="";
    renderUsers();
  };
}
$("#sch").oninput=()=>{ 
  const isSayfa = $("#sayfaWrap") && ($("#sayfaWrap").style.display==="" || $("#sayfaWrap").style.display==="block");
  if(isSayfa) renderSayfa(); else renderUsers(); 
}; 
$("#fltRol").onchange=renderUsers; 
$("#fltDurum").onchange=renderUsers; 
$("#btnRef").onclick=()=>{ 
  const isSayfa = $("#sayfaWrap") && ($("#sayfaWrap").style.display==="" || $("#sayfaWrap").style.display==="block");
  if(isSayfa) renderSayfa(); else renderUsers(); 
};

function bindListButtons(scope){
  scope.querySelectorAll("[data-edit]").forEach(b=> b.onclick=()=> openEdit(b.dataset.edit));
  scope.querySelectorAll("[data-reset]").forEach(b=> b.onclick=()=> resetPass(b.dataset.reset));
  scope.querySelectorAll("[data-toggle]").forEach(b=> b.onclick=()=> toggleActive(JSON.parse(b.dataset.toggle)));
  scope.querySelectorAll("[data-softdel]").forEach(b=> b.onclick=()=> softDelete(b.dataset.softdel));
}

/* ===== Sayfa GÃ¶rÃ¼nÃ¼mÃ¼ ===== */
function renderSayfa(){
  const wrap=$("#sayfaWrap");
  if(!wrap) return;
  
  // TÃ¼m sayfalarÄ± topla
  const allPages=[];
  Object.keys(manifest).sort((a,b)=>(manifest[a].order||0)-(manifest[b].order||0)).forEach(panelKey=>{
    const panel=manifest[panelKey];
    (panel.pages||[]).forEach(page=>{
      allPages.push({
        panelKey,
        panelTitle:panel.title||panelKey,
        pageKey:page.key||`${panelKey}: ${page.title}`,
        pageTitle:page.title||'',
        pagePath:page.path||''
      });
    });
  });
  
  // Arama filtresi
  const q=$("#sch")?.value.toLowerCase().trim()||"";
  let filteredPages=allPages;
  if(q){
    filteredPages=allPages.filter(p=>
      (p.pageTitle||"").toLowerCase().includes(q) ||
      (p.panelTitle||"").toLowerCase().includes(q) ||
      (p.pagePath||"").toLowerCase().includes(q)
    );
  }
  
  wrap.innerHTML="";
  
  if(!USERS.length || !filteredPages.length){
    const div=document.createElement('div');
    div.className="pill";
    div.style.textAlign="center";
    div.style.padding="40px";
    div.style.gridColumn="1 / -1";
    div.textContent=!USERS.length ? "Personel yok" : "Sayfa yok";
    wrap.appendChild(div);
    return;
  }
  
  // Her sayfa iÃ§in kart
  filteredPages.forEach(page=>{
    const card=document.createElement('div');
    card.className="sayfa-card";
    
    // Kart baÅŸlÄ±ÄŸÄ±
    const header=document.createElement('div');
    header.className="sayfa-card-header";
    
    const title=document.createElement('div');
    title.className="sayfa-card-title";
    title.textContent=escapeHtml(page.pageTitle);
    header.appendChild(title);
    
    const meta=document.createElement('div');
    meta.className="sayfa-card-meta";
    meta.innerHTML=`
      <span class="pill" style="font-size:11px;padding:4px 8px">${escapeHtml(page.panelTitle)}</span>
      <span style="font-family:monospace;font-size:11px;color:var(--muted)">${escapeHtml(page.pagePath)}</span>
    `;
    header.appendChild(meta);
    card.appendChild(header);
    
    // Personel listesi
    const body=document.createElement('div');
    body.className="sayfa-card-body";
    
    if(USERS.length===0){
      const empty=document.createElement('div');
      empty.className="pill";
      empty.style.textAlign="center";
      empty.style.padding="12px";
      empty.textContent="Personel yok";
      body.appendChild(empty);
    }else{
      USERS.forEach(u=>{
        const item=document.createElement('div');
        item.className="sayfa-personel-item";
        
        const name=document.createElement('div');
        name.className="sayfa-personel-name";
        name.textContent=u.adSoyad||u.email||"";
        name.title=u.email||"";
        item.appendChild(name);
        
        const chk=document.createElement('input');
        chk.type="checkbox";
        chk.className="sayfa-personel-checkbox";
        const yetkiler=Array.isArray(u.yetkiler)?u.yetkiler:[];
        const hasPage=yetkiler.some(y=>{
          const yNorm=String(y||"").trim().toLowerCase();
          const pageKeyNorm=String(page.pageKey||"").trim().toLowerCase();
          return yNorm===pageKeyNorm;
        });
        chk.checked=hasPage;
        
        chk.onchange=async()=>{
          try{
            const db=getDb();
            if(!db) return;
            let yetkiler=Array.isArray(u.yetkiler)?[...u.yetkiler]:[];
            if(chk.checked){
              if(!yetkiler.includes(page.pageKey)){
                yetkiler.push(page.pageKey);
              }
            }else{
              yetkiler=yetkiler.filter(y=>String(y||"").trim()!==String(page.pageKey||"").trim());
            }
            await db.collection("kullanicilar").doc(u.uid).set({yetkiler},{merge:true});
            if(typeof window.showToast==='function') window.showToast('success','BaÅŸarÄ±lÄ±',`${u.adSoyad} iÃ§in ${page.pageTitle} ${chk.checked?'aktif':'pasif'} edildi`);
          }catch(e){
            console.error('Yetki gÃ¼ncelleme hatasÄ±:',e);
            chk.checked=!chk.checked;
            if(typeof window.showToast==='function') window.showToast('error','Hata',e?.message||'Bilinmeyen hata');
          }
        };
        
        item.appendChild(chk);
        body.appendChild(item);
      });
    }
    
    card.appendChild(body);
    wrap.appendChild(card);
  });
}

function escapeHtml(text){
  // Sayfa iÃ§i Ã¶zel escapeHtml - window.escapeHtml'i kullanmÄ±yoruz (sonsuz dÃ¶ngÃ¼ Ã¶nleme)
  const div=document.createElement('div');
  div.textContent=String(text||'');
  return div.innerHTML;
}
function renderUsers(){
  const q=$("#sch")?.value.toLowerCase().trim()||"", fr=$("#fltRol")?.value||"", fd=$("#fltDurum")?.value||"";
  let list=USERS.slice();
  if(q) list=list.filter(x=>(x.adSoyad||"").toLowerCase().includes(q) || (x.email||"").toLowerCase().includes(q) || (x.gorev||"").toLowerCase().includes(q));
  if(fr) list=list.filter(x=> (x.rol||"")===fr);
  if(fd!=="") list=list.filter(x=> String(!!x.aktif)===fd);

  const wrap=$("#usersCardsWrap");
  if(!wrap) return;
  
  wrap.innerHTML="";
  
  if(!list.length){
    const div=document.createElement('div'); div.className="pill"; div.textContent="KayÄ±t yok";
    wrap.appendChild(div);
    return;
  }
  
  list.forEach((u)=>{
    
    const d=u.eklenmeTarihi?.toDate? u.eklenmeTarihi.toDate() : null;
    const escape = (t) => {
      const div=document.createElement('div');
      div.textContent=String(t||'');
      return div.innerHTML;
    };
    const adSoyad=escape(u.adSoyad||"-");
    const email=escape(u.email||"-");
    const rol=escape(u.rol||"-");
    const gorev=escape(u.gorev||"-");
    const yetkiCount=(u.yetkiler||[]).length;
    const dateStr=d? d.toLocaleDateString("tr-TR"):"-";
    const toggleData=JSON.stringify({uid:u.uid,aktif:!!u.aktif});
    
    // Sadece kart gÃ¶rÃ¼nÃ¼mÃ¼ (tablo kaldÄ±rÄ±ldÄ±)
    {
      const card=document.createElement('div'); card.className='ucard';
      const header=document.createElement('div');
      header.style.display="flex";
      header.style.justifyContent="space-between";
      header.style.alignItems="flex-start";
      header.style.gap="12px";
      header.style.marginBottom="12px";
      
      const left=document.createElement('div');
      left.style.flex="1";
      const name=document.createElement('div');
      name.style.fontWeight="800";
      name.style.fontSize="16px";
      name.style.marginBottom="4px";
      name.textContent=adSoyad;
      const info=document.createElement('div');
      info.style.fontSize="12px";
      info.style.color="var(--muted)";
      info.style.lineHeight="1.5";
      info.innerHTML=`<div>ğŸ“§ ${email}</div><div>ğŸ‘¤ ${rol} Â· ${gorev}</div><div>ğŸ“… ${dateStr}</div><div>ğŸ”‘ ${yetkiCount} yetki</div>`;
      left.appendChild(name);
      left.appendChild(info);
      
      const right=document.createElement('div');
      right.innerHTML=u.aktif? '<span class="pill" style="background:var(--ok);color:#fff">Aktif</span>':'<span class="pill" style="background:var(--muted);color:#fff">Pasif</span>';
      
      header.appendChild(left);
      header.appendChild(right);
      
      const actions=document.createElement('div');
      actions.className="mini";
      actions.style.marginTop="12px";
      actions.style.flexWrap="wrap";
      actions.style.gap="6px";
      
      const escape = (t) => {
        const div=document.createElement('div');
        div.textContent=String(t||'');
        return div.innerHTML;
      };
      const btnEdit=document.createElement('button');
      btnEdit.className="btn";
      btnEdit.dataset.edit=escape(u.uid);
      btnEdit.textContent="âœï¸ DÃ¼zenle";
      btnEdit.style.fontSize="12px";
      btnEdit.style.padding="6px 10px";
      
      const btnReset=document.createElement('button');
      btnReset.className="btn";
      btnReset.dataset.reset=escape(email);
      btnReset.textContent="ğŸ”‘ Åifre";
      btnReset.style.fontSize="12px";
      btnReset.style.padding="6px 10px";
      
      const btnToggle=document.createElement('button');
      btnToggle.className="btn";
      btnToggle.dataset.toggle=escape(toggleData);
      btnToggle.textContent=u.aktif? "â›” Pasifle":"âœ… Aktifle";
      btnToggle.style.fontSize="12px";
      btnToggle.style.padding="6px 10px";
      
      const btnDel=document.createElement('button');
      btnDel.className="btn";
      btnDel.dataset.softdel=escape(u.uid);
      btnDel.textContent="ğŸ—‘ï¸ Sil";
      btnDel.style.fontSize="12px";
      btnDel.style.padding="6px 10px";
      btnDel.style.background="rgba(255,66,85,.1)";
      btnDel.style.borderColor="rgba(255,66,85,.3)";
      
      actions.appendChild(btnEdit);
      actions.appendChild(btnReset);
      actions.appendChild(btnToggle);
      actions.appendChild(btnDel);
      
      card.appendChild(header);
      card.appendChild(actions);
      wrap.appendChild(card);
    }
  });
  
  bindListButtons(wrap);
}

/* DÃ¼zenleme */
const mEdit=$("#mEdit");
if(mEdit){
  // Backdrop'a tÄ±klanÄ±nca kapat (modal element'ine tÄ±klanÄ±nca)
  mEdit.onclick=(e)=>{
    if(e.target===mEdit) mEdit.classList.remove('open');
  };
}
async function openEdit(uid){
  const db=getDb(); if(!db) return; const doc=await db.collection("kullanicilar").doc(uid).get(); if(!doc.exists){ if(typeof window.showToast==='function') window.showToast('warning','UyarÄ±','KullanÄ±cÄ± bulunamadÄ±'); return; }
  const u={uid:doc.id, ...doc.data()};
  $("#e_uid").value=u.uid; $("#e_ad").value=u.adSoyad||""; $("#e_rol").value=u.rol||"personel"; $("#e_gorev").value=u.gorev||""; $("#e_mail").value=u.email||""; $("#e_aktif").checked=!!u.aktif;
  renderPermTree("#permTreeEdit", u.yetkiler||[]);
  mEdit.classList.add('open');
}
if($("#btnEditClose")){
  $("#btnEditClose").onclick=()=> { if(mEdit) mEdit.classList.remove('open'); };
}
if($("#btnEditSave")){
  $("#btnEditSave").onclick=async()=>{
    const btn=$("#btnEditSave");
    const originalText=btn.textContent;
    btn.disabled=true;
    btn.textContent='â³ Kaydediliyor...';
    
    try{
      const uid=$("#e_uid")?.value||"";
      const ad=$("#e_ad")?.value.trim()||"";
      const rol=$("#e_rol")?.value||"";
      const gorev=$("#e_gorev")?.value.trim()||"";
      const aktif=$("#e_aktif")?.checked||false;
      const yetkiler=normalizeYetkiler(getChecked("#permTreeEdit"));
      
      if(!uid){
        throw new Error('KullanÄ±cÄ± ID bulunamadÄ±');
      }
      if(!ad || ad.length < 2){
        throw new Error('Ad Soyad en az 2 karakter olmalÄ±');
      }
      if(!rol){
        throw new Error('Rol seÃ§ilmelidir');
      }
      
      const db=getDb(); if(!db) throw new Error('Firebase baÄŸlantÄ±sÄ± yok'); await db.collection("kullanicilar").doc(uid).set({adSoyad:ad, rol, gorev, aktif, yetkiler},{merge:true});
      if(mEdit) mEdit.classList.remove('open');
      if(typeof window.showToast==='function') window.showToast('success','BaÅŸarÄ±lÄ±','GÃ¼ncellendi');
    }catch(e){
      console.error('GÃ¼ncelleme hatasÄ±:', e);
      if(typeof window.showToast==='function') window.showToast('error','Hata',e?.message||e||'Bilinmeyen hata');
    }finally{
      btn.disabled=false;
      btn.textContent=originalText;
    }
  };
}

/* Reset/Toggle/Delete */
async function resetPass(email){
  if(!email || !auth){
    if(typeof window.showToast==='function') window.showToast('warning','UyarÄ±','E-posta veya auth bulunamadÄ±');
    return;
  }
  try{
    const auth=getAuth(); if(!auth) return; await auth.sendPasswordResetEmail(email);
    if(typeof window.showToast==='function') window.showToast('success','BaÅŸarÄ±lÄ±','SÄ±fÄ±rlama e-postasÄ± gÃ¶nderildi');
  }catch(e){
    console.error('Åifre sÄ±fÄ±rlama hatasÄ±:', e);
    if(typeof window.showToast==='function') window.showToast('error','Hata','GÃ¶nderilemedi: '+(e?.message||e||'Bilinmeyen hata'));
  }
}
async function toggleActive(d){
  if(!d || !d.uid || !db){
    if(typeof window.showToast==='function') window.showToast('warning','UyarÄ±','GeÃ§ersiz veri veya baÄŸlantÄ±');
    return;
  }
  try{
    const db=getDb(); if(!db) return; await db.collection("kullanicilar").doc(d.uid).set({aktif: !d.aktif},{merge:true});
    if(typeof window.showToast==='function') window.showToast('success','BaÅŸarÄ±lÄ±','Durum gÃ¼ncellendi');
  }catch(e){
    console.error('Durum gÃ¼ncelleme hatasÄ±:', e);
    if(typeof window.showToast==='function') window.showToast('error','Hata',e?.message||e||'Bilinmeyen hata');
  }
}
async function softDelete(uid){
  if(!uid || !db){
    if(typeof window.showToast==='function') window.showToast('warning','UyarÄ±','GeÃ§ersiz ID veya baÄŸlantÄ±');
    return;
  }
  if(!confirm("Bu kullanÄ±cÄ± soft-silinecek (aktif=false, silindi=true).\n\nBu iÅŸlem geri alÄ±namaz. OnaylÄ±yor musunuz?")){
    return;
  }
  try{
    const db=getDb(); if(!db) return; await db.collection("kullanicilar").doc(uid).set({aktif:false, silindi:true},{merge:true});
    if(typeof window.showToast==='function') window.showToast('success','BaÅŸarÄ±lÄ±','Soft silindi');
  }catch(e){
    console.error('Soft silme hatasÄ±:', e);
    if(typeof window.showToast==='function') window.showToast('error','Hata',e?.message||e||'Bilinmeyen hata');
  }
}

/* ===== Manifest listener ===== */
function listenManifest(){
  const db=getDb(); if(!db) return; db.collection("sayfa_manifesti").orderBy("order","asc").onSnapshot(snap=>{
    const m={};
    snap.forEach(d=>{
      const v=d.data()||{};
      m[d.id]={title:v.title||d.id, order:v.order||0, pages:Array.isArray(v.pages)? v.pages.sort((a,b)=>(a.order||0)-(b.order||0)) : []};
    });
    manifest=m;
    fillPanelSelect(); renderPermTree("#permTreeAdd"); if($("#permTreeEdit").children.length) renderPermTree("#permTreeEdit", getChecked("#permTreeEdit")); renderManifestAdmin(); renderKPIs();
    // Sayfa gÃ¶rÃ¼nÃ¼mÃ¼ aktifse yeniden render et
    const isSayfa = $("#sayfaWrap") && ($("#sayfaWrap").style.display==="" || $("#sayfaWrap").style.display==="block");
    if(isSayfa) renderSayfa();
  });
}

/* ===== Auth + Yetki + MenÃ¼ ===== */
// Ortak.js'den gelen initAppShellAuth kullanÄ±lacak, burada sadece sayfa Ã¶zel iÅŸlemler

// Sayfa Ã¶zel init fonksiyonu - ortak.js'den sonra Ã§aÄŸrÄ±lacak
window.initPage = async function() {
  try {
    const db = getDb();
    const auth = getAuth();
    if (!db || !auth) {
      throw new Error('Firebase baÄŸlantÄ±sÄ± yok');
    }
    
    const user = auth.currentUser;
    if (!user) return;
    
    // Bu sayfaya eriÅŸim yetkisi kontrolÃ¼ (opsiyonel)
    const allowSet = window.CURRENT_ALLOW || new Set();
    // if(!allowSet.has('admin') && !allowSet.has('kullanÄ±cÄ± yÃ¶netimi')){
    //   if(typeof window.showToast==='function') window.showToast('warning', 'Yetki Yok', 'Bu sayfaya eriÅŸim yetkiniz yok.');
    //   setTimeout(()=>location.replace('../panel.html'), 2000);
    //   return;
    // }
    
    // Sayfa Ã¶zel iÅŸlemler
    listenManifest();
    listenUsers();
    
    // Ä°lk aÃ§Ä±lÄ±ÅŸta "KullanÄ±cÄ±lar" sekmesi ve "Sayfa" gÃ¶rÃ¼nÃ¼mÃ¼ aÃ§Ä±k olsun
    setTimeout(()=>{
      if($("#tabList")){
        if(typeof setActiveTab==='function') setActiveTab("tabList");
        $("#viewAdd").style.display="none";
        $("#viewMan").style.display="none";
        $("#viewList").style.display="block";
        setTimeout(()=>{
          if($("#btnSayfa")) $("#btnSayfa").click();
        }, 50);
      }
    }, 200);
  } catch (e) {
    console.error('Sayfa init hatasÄ±:', e);
    if (typeof window.showToast === 'function') {
      window.showToast('error', 'Hata', 'Veriler yÃ¼klenirken hata: ' + (e?.message || 'Bilinmeyen hata'));
    }
  }
};
</script>
</body>
</html>

