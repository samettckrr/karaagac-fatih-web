<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Giri≈ü Kayƒ±tlarƒ± | Karaaƒüa√ß Fatih</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" type="image/png" href="../img/logo.png" />

  <style>
    :root{
      --appbar-h:56px; --radius:14px; --shadow:0 12px 28px rgba(0,0,0,.14);
      --bg:#0f172a; --bg2:#0b1324; --grad1:#0ea5e922; --grad2:#22d3ee22;
      --card:rgba(15,23,42,.92); --stroke:rgba(148,163,184,.18);
      --text:#e5e7eb; --muted:#9aa4b2; --brand:#38bdf8; --brand2:#0ea5e9;
      --pill:#0b1220; --pill-hover:#101a2b; --link:#c7e9ff; --surface:rgba(2,6,23,.08);
      --good:#22c55e; --warn:#f59e0b; --bad:#ef4444; --great:#16a34a;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#eef6ff; --bg2:#f7fbff; --grad1:#38bdf822; --grad2:#22d3ee22;
        --card:rgba(255,255,255,.95); --stroke:rgba(15,23,42,.12);
        --text:#0b1220; --muted:#4b5563; --brand:#0ea5e9; --brand2:#0284c7;
        --pill:#f5f8ff; --pill-hover:#e9f2ff; --link:#0b5ea8; --surface:#eef3ff;
        --good:#16a34a; --warn:#d97706; --bad:#dc2626; --great:#15803d;
      }
    }
    html[data-theme="dark"]{
      --bg:#0f172a; --bg2:#0b1324; --grad1:#0ea5e922; --grad2:#22d3ee22;
      --card:rgba(15,23,42,.92); --stroke:rgba(148,163,184,.18);
      --text:#e5e7eb; --muted:#9aa4b2; --brand:#38bdf8; --brand2:#0ea5e9;
      --pill:#0b1220; --pill-hover:#101a2b; --link:#c7e9ff; --surface:rgba(2,6,23,.08);
      --good:#22c55e; --warn:#f59e0b; --bad:#ef4444; --great:#16a34a;
    }
    html[data-theme="light"]{
      --bg:#eef6ff; --bg2:#f7fbff; --grad1:#38bdf822; --grad2:#22d3ee22;
      --card:rgba(255,255,255,.95); --stroke:rgba(15,23,42,.12);
      --text:#0b1220; --muted:#4b5563; --brand:#0ea5e9; --brand2:#0284c7;
      --pill:#f5f8ff; --pill-hover:#e9f2ff; --link:#0b5ea8; --surface:#eef3ff;
      --good:#16a34a; --warn:#d97706; --bad:#dc2626; --great:#15803d;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      font-family:ui-sans-serif,-apple-system,"Segoe UI",Roboto,Arial;
      background:
        radial-gradient(900px 680px at 12% 8%, var(--grad1), transparent 45%),
        radial-gradient(800px 640px at 88% 92%, var(--grad2), transparent 50%),
        linear-gradient(140deg, var(--bg), var(--bg2) 60%);
      overflow-x:hidden; word-wrap:break-word;
    }
    a{color:var(--link); text-decoration:none}
    a:hover{text-decoration:underline}

    .appbar{
      position:sticky; top:0; z-index:60; height:var(--appbar-h);
      background:var(--card); backdrop-filter:blur(10px);
      border-bottom:1px solid var(--stroke);
      display:flex; align-items:center;
      padding:0 max(12px, env(safe-area-inset-right)) 0 max(12px, env(safe-area-inset-left));
    }
    .brand{display:flex; align-items:center; gap:10px; cursor:pointer}
    .brand img{width:24px; height:24px}
    .brand span{font-weight:900; letter-spacing:.02em}
    .nav-center{margin:0 auto; height:100%}
    .nav-list{display:flex; gap:22px; align-items:center; height:100%; list-style:none; margin:0; padding:0}
    .nav-item{position:relative; height:100%}
    .nav-btn{height:100%; display:flex; align-items:center; gap:6px; font-weight:600; cursor:pointer}
    .nav-btn:hover{color:var(--brand)}
    .caret{font-size:12px; opacity:.6}
    .dropdown{position:absolute; top:100%; left:0; min-width:240px; background:var(--card); border:1px solid var(--stroke); border-radius:10px; box-shadow:var(--shadow); padding:8px; display:none}
    .dropdown a{display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:8px}
    .dropdown a:hover{background:var(--surface)}
    .nav-item.open .dropdown{display:block}
    .nav-right{display:flex; gap:8px; align-items:center}
    .btn{border:1px solid var(--stroke); background:var(--card); color:var(--text); border-radius:999px; padding:8px 12px; cursor:pointer}
    .hamb{display:none}

    .drawer{
      position:fixed; top:var(--appbar-h); right:0; bottom:0; left:30%;
      transform:translateX(100%); transition:transform .25s ease;
      background:var(--card); border-left:1px solid var(--stroke);
      z-index:70; overflow:auto; padding:12px;
    }
    .drawer.open{transform:translateX(0)}
    .drawer .panel-title{margin:14px 4px 6px; font-weight:800; color:var(--muted); font-size:13px}
    .drawer a{display:block; padding:10px; border-radius:10px; border:1px solid var(--stroke); margin:6px 0; background:var(--pill)}
    .drawer a:hover{background:var(--pill-hover)}

    .container{max-width:1550px; margin:0 auto; padding:16px}
    .hero{display:flex; justify-content:space-between; align-items:flex-start; gap:16px; background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius); padding:16px; margin:16px 0; box-shadow:var(--shadow)}
    .hero h2{margin:0 0 6px; font-size:20px}
    .hero-sub{color:var(--muted); font-size:13px; line-height:1.35}
    .mini{display:flex; gap:8px; flex-wrap:wrap}
    .pill{padding:6px 10px; border-radius:999px; border:1px solid var(--stroke); background:var(--pill); font-size:12px}

    .card{background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px; margin-bottom:14px}
    .card h3{margin:0 0 10px; font-size:16px}

    /* TABS */
    .tabs{display:flex; gap:8px; margin-bottom:16px; border-bottom:2px solid var(--stroke); overflow-x:auto}
    .tab{padding:12px 20px; background:transparent; border:none; color:var(--muted); font-weight:600; cursor:pointer; border-bottom:3px solid transparent; margin-bottom:-2px; transition:all .2s; white-space:nowrap; font-size:14px}
    .tab:hover{color:var(--text); background:var(--surface)}
    .tab.active{color:var(--brand); border-bottom-color:var(--brand)}
    .tab-content{display:none}
    .tab-content.active{display:block}

    /* LOG TABLE */
    .log-table-wrapper{overflow-x:auto; margin-top:12px}
    .log-table{width:100%; border-collapse:separate; border-spacing:0 6px; min-width:800px}
    .log-table thead th{background:var(--surface); padding:12px; border-bottom:2px solid var(--stroke); text-align:left; font-weight:700; font-size:13px; color:var(--muted)}
    .log-table tbody td{background:var(--card); border:1px solid var(--stroke); padding:12px; border-radius:8px}
    .log-table tbody tr:hover td{background:var(--surface)}

    /* LOG ITEM CARD */
    .log-grid{display:grid; grid-template-columns:repeat(auto-fill, minmax(320px, 1fr)); gap:12px; margin-top:12px}
    .log-card{background:var(--card); border:1px solid var(--stroke); border-radius:12px; padding:14px; transition:all .2s}
    .log-card:hover{background:var(--surface); transform:translateY(-2px); box-shadow:var(--shadow)}
    .log-card-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; padding-bottom:10px; border-bottom:1px solid var(--stroke)}
    .log-card-title{font-weight:700; font-size:14px; color:var(--text)}
    .log-card-time{font-size:11px; color:var(--muted)}
    .log-card-body{display:flex; flex-direction:column; gap:6px}
    .log-card-item{display:flex; gap:8px; font-size:12px}
    .log-card-label{color:var(--muted); font-weight:600; min-width:80px}
    .log-card-value{color:var(--text); word-break:break-word}

    /* STATS CARDS */
    .stats-grid{display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:12px; margin-bottom:20px}
    .stat-card{background:var(--card); border:1px solid var(--stroke); border-radius:12px; padding:16px; text-align:center}
    .stat-card-value{font-size:32px; font-weight:900; color:var(--brand); margin:8px 0}
    .stat-card-label{font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:.05em}

    /* FILTERS */
    .filters{display:flex; gap:12px; margin-bottom:16px; flex-wrap:wrap; align-items:end}
    .filter-group{display:flex; flex-direction:column; gap:6px}
    .filter-group label{font-size:12px; color:var(--muted); font-weight:600}
    .filter-group select, .filter-group input{width:100%; padding:8px 12px; border-radius:8px; border:1px solid var(--stroke); background:var(--pill); color:var(--text); font-size:13px}

    /* BADGES */
    .badge{display:inline-block; padding:4px 10px; border-radius:999px; font-size:11px; font-weight:700; border:1px solid var(--stroke)}
    .badge-success{background:rgba(34,197,94,.15); color:var(--good); border-color:rgba(34,197,94,.3)}
    .badge-warning{background:rgba(245,158,11,.15); color:var(--warn); border-color:rgba(245,158,11,.3)}
    .badge-info{background:rgba(14,165,233,.15); color:var(--brand); border-color:rgba(14,165,233,.3)}

    .toast{position:fixed; left:50%; bottom:24px; transform:translateX(-50%) translateY(20px); background:rgba(2,6,23,.95); color:#fff; border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:10px 12px; opacity:0; pointer-events:none; transition:opacity .25s, transform .25s; z-index:200}
    .toast.show{opacity:1; transform:translateX(-50%) translateY(0)}

    @media (max-width: 1024px){
      .nav-center{display:none} .hamb{display:inline-flex}
      .stats-grid{grid-template-columns:repeat(2, 1fr)}
      .log-grid{grid-template-columns:1fr}
    }
    @media (max-width: 768px){
      .container{padding:12px}
      .hero{flex-direction:column; padding:12px}
      .tabs{overflow-x:auto; -webkit-overflow-scrolling:touch}
      .tab{padding:10px 14px; font-size:13px}
      .filters{flex-direction:column}
      .filter-group{width:100%}
    }
  </style>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="../js/firebase/firebase-init.js"></script>
</head>
<body>
  <div class="appbar">
    <div class="brand" onclick="location.href='../panel.html'">
      <img src="../img/logo.png" alt="logo"><span>KARAAƒûA√á FATƒ∞H</span>
    </div>
    <nav class="nav-center"><ul class="nav-list" id="navMain"></ul></nav>
    <div class="nav-right">
      <button class="btn hamb" id="hamburger" title="Men√º">‚ò∞</button>
      <button class="btn" onclick="logout()">√áƒ±kƒ±≈ü Yap</button>
    </div>
  </div>

  <aside class="drawer" id="drawer"></aside>

  <main class="container">
    <section class="hero">
      <div>
        <h2>Giri≈ü Kayƒ±tlarƒ± ve Log Y√∂netimi</h2>
        <div class="hero-sub">Sistem kullanƒ±cƒ± giri≈üleri, sayfa hareketleri ve i≈ülem kayƒ±tlarƒ±nƒ± g√∂r√ºnt√ºleyin</div>
        <div class="mini">
          <span class="pill">üïí Son G√ºncelleme: <b id="lastUpdate">y√ºkleniyor‚Ä¶</b></span>
          <span class="pill">üìä Toplam Kayƒ±t: <b id="totalLogs">-</b></span>
        </div>
      </div>
    </section>

    <!-- STATS -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-card-label">Giri≈ü Kayƒ±tlarƒ±</div>
        <div class="stat-card-value" id="statGiris">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-card-label">Sayfa Hareketleri</div>
        <div class="stat-card-value" id="statSayfa">0</div>
  </div>
      <div class="stat-card">
        <div class="stat-card-label">ƒ∞≈ülem Kayƒ±tlarƒ±</div>
        <div class="stat-card-value" id="statIslem">0</div>
  </div>
      <div class="stat-card">
        <div class="stat-card-label">Aktif Kullanƒ±cƒ±lar</div>
        <div class="stat-card-value" id="statAktif">0</div>
  </div>
</div>

    <!-- TABS -->
    <div class="card">
      <div class="tabs">
        <button class="tab active" data-tab="giris">üü¢ Giri≈ü Loglarƒ±</button>
        <button class="tab" data-tab="sayfa">üü† Sayfa Hareketleri</button>
        <button class="tab" data-tab="islem">üîµ ƒ∞≈ülem Kayƒ±tlarƒ±</button>
        <button class="tab" data-tab="rapor">üìä Raporlar</button>
      </div>

      <!-- Gƒ∞Rƒ∞≈û LOGLARI -->
      <div class="tab-content active" id="tab-giris">
        <div class="filters">
          <div class="filter-group">
            <label>Tarih Aralƒ±ƒüƒ±</label>
            <input type="date" id="filterGirisBaslangic">
          </div>
          <div class="filter-group">
            <label>Biti≈ü</label>
            <input type="date" id="filterGirisBitis">
          </div>
          <div class="filter-group">
            <label>G√∂r√ºn√ºm</label>
            <select id="viewGiris">
              <option value="table">Tablo</option>
              <option value="card">Kart</option>
            </select>
          </div>
        </div>
        <div id="girisLoglari"></div>
      </div>

      <!-- SAYFA HAREKETLERƒ∞ -->
      <div class="tab-content" id="tab-sayfa">
        <div class="filters">
          <div class="filter-group">
            <label>Tarih Aralƒ±ƒüƒ±</label>
            <input type="date" id="filterSayfaBaslangic">
          </div>
          <div class="filter-group">
            <label>Biti≈ü</label>
            <input type="date" id="filterSayfaBitis">
          </div>
          <div class="filter-group">
            <label>Sayfa</label>
            <select id="filterSayfaAdi">
              <option value="">T√ºm√º</option>
            </select>
          </div>
          <div class="filter-group">
            <label>G√∂r√ºn√ºm</label>
            <select id="viewSayfa">
              <option value="table">Tablo</option>
              <option value="card">Kart</option>
            </select>
          </div>
        </div>
        <div id="sayfaLoglari"></div>
      </div>

      <!-- ƒ∞≈ûLEM KAYITLARI -->
      <div class="tab-content" id="tab-islem">
        <div class="filters">
          <div class="filter-group">
            <label>Tarih Aralƒ±ƒüƒ±</label>
            <input type="date" id="filterIslemBaslangic">
          </div>
          <div class="filter-group">
            <label>Biti≈ü</label>
            <input type="date" id="filterIslemBitis">
          </div>
          <div class="filter-group">
            <label>ƒ∞≈ülem T√ºr√º</label>
            <select id="filterIslemTuru">
              <option value="">T√ºm√º</option>
            </select>
          </div>
          <div class="filter-group">
            <label>G√∂r√ºn√ºm</label>
            <select id="viewIslem">
              <option value="table">Tablo</option>
              <option value="card">Kart</option>
            </select>
          </div>
        </div>
        <div id="islemLoglari"></div>
      </div>

      <!-- RAPORLAR -->
      <div class="tab-content" id="tab-rapor">
        <div class="filters">
          <div class="filter-group">
            <label>Rapor T√ºr√º</label>
            <select id="raporTuru">
              <option value="gunluk">G√ºnl√ºk √ñzet</option>
              <option value="haftalik">Haftalƒ±k √ñzet</option>
              <option value="aylik">Aylƒ±k √ñzet</option>
              <option value="kullanici">Kullanƒ±cƒ± Bazlƒ±</option>
            </select>
          </div>
          <div class="filter-group">
            <label>Tarih</label>
            <input type="date" id="raporTarih">
          </div>
          <div class="filter-group">
            <button class="btn" onclick="generateReport()" style="margin-top:20px">üìä Rapor Olu≈ütur</button>
          </div>
        </div>
        <div id="raporIcerik"></div>
      </div>
    </div>
  </main>

  <div id="toast" class="toast"></div>

<script>
    let db, auth;
    try{
      db = firebase.firestore();
      auth = firebase.auth();
    }catch(e){
      alert('Firebase y√ºklenemedi. Sayfayƒ± yenileyin.');
    }

    function showToast(msg){
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      setTimeout(() => t.classList.remove('show'), 3000);
    }

    function logout(){
      if(auth) auth.signOut().then(() => location.href = '../index.html');
    }

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const tabName = tab.dataset.tab;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(`tab-${tabName}`).classList.add('active');
        
        // Load data for active tab
        if(tabName === 'giris') loadGirisLoglari();
        else if(tabName === 'sayfa') loadSayfaLoglari();
        else if(tabName === 'islem') loadIslemLoglari();
        else if(tabName === 'rapor') loadRaporlar();
      });
    });

    // Drawer toggle
    document.getElementById('hamburger')?.addEventListener('click', (e) => {
      e.stopPropagation();
      document.getElementById('drawer').classList.toggle('open');
    });
    document.addEventListener('click', (e) => {
      const drawer = document.getElementById('drawer');
      const hamb = document.getElementById('hamburger');
      if(!drawer.contains(e.target) && !hamb.contains(e.target)){
        drawer.classList.remove('open');
      }
    });

    // Navigation System
    let CURRENT_ALLOW = new Set(), CURRENT_DENY = new Set();
    const norm = s => String(s||'').trim().toLowerCase();
    const PANEL_ICON = { 'Admin':'üéõÔ∏è','Talebe':'üìò','Personel':'üë§','Muhasebe':'üí∞','Kermes':'üè™','Nehari':'üïå','Sistem Ayarlarƒ±':'‚öôÔ∏è' };
    
    function resolveHref(path, panelId){
      if(!path || path === '#') return '#';
      // HTTP/HTTPS URL'leri olduƒüu gibi bƒ±rak
      if(/^https?:\/\//i.test(path)) return path;
      if(path.startsWith('//')) return path;
      // Zaten relative path'ler (../ veya ./ ile ba≈ülayan) olduƒüu gibi bƒ±rak
      if(path.startsWith('../') || path.startsWith('./')) return path;
      
      // Mevcut dosyanƒ±n konumuna g√∂re relative hale getir
      const currentPath = location.pathname;
      const currentDir = currentPath.substring(0, currentPath.lastIndexOf('/'));
      // Mevcut dizin seviyesini hesapla (ka√ß seviye yukarƒ± √ßƒ±kmalƒ±yƒ±z)
      const currentDepth = currentDir.split('/').filter(x => x).length;
      
      // Root'a d√∂nmek i√ßin ../ sayƒ±sƒ±
      const upLevels = currentDepth > 0 ? '../'.repeat(currentDepth) : '';
      
      // Path'i temizle: / ile ba≈ülƒ±yorsa kaldƒ±r, admin/ ile ba≈ülƒ±yorsa da kaldƒ±r
      let targetPath = path.startsWith('/') ? path.substring(1) : path;
      targetPath = targetPath.replace(/^admin\//, '');
      
      return upLevels + targetPath;
    }
    
    async function fetchPanels(allowSet, denySet){
      const res = [];
      try{
        const snap = await db.collection('sayfa_manifesti').get();
        snap.forEach(doc => {
          const d = doc.data() || {}, id = doc.id;
          const panelTitle = d.title || id;
          const panelGrant = allowSet.has(norm(id)) || allowSet.has(norm(panelTitle));
          let pages = Array.isArray(d.pages) ? d.pages : [];
          pages = pages.filter(pg => {
            const keyNorm = norm(pg.key || pg.title || '');
            const pageGrant = allowSet.has(keyNorm);
            const denied = denySet.has(keyNorm);
            return !denied && (panelGrant || pageGrant);
          }).map(pg => ({
            baslik: pg.title || pg.key || 'Sayfa',
            url: resolveHref(pg.path || '#', id),
            key: pg.key || pg.title || '',
            sira: typeof pg.order === 'number' ? pg.order : 9999
          })).sort((a,b) => a.sira - b.sira);
          if(pages.length) res.push({
            id, baslik: panelTitle, ikon: d.icon || PANEL_ICON[id] || 'üìÅ',
            sira: typeof d.order === 'number' ? d.order : 9999, pages
          });
        });
        res.sort((a,b) => a.sira - b.sira);
      }catch(e){
        console.warn('Panel y√ºkleme hatasƒ±:', e);
      }
      return res;
    }
    
    function renderNav(panels){
      const ul = document.getElementById('navMain'), drawer = document.getElementById('drawer');
      ul.innerHTML = ''; drawer.innerHTML = '';
      if(!panels.length){
        ul.innerHTML = '<li class="nav-item"><div class="nav-btn">Hi√ß panel yok</div></li>';
        drawer.innerHTML = '<div style="color:var(--muted);padding:8px">Hi√ß panel bulunamadƒ±</div>';
        return;
      }
      
      // Drawer toggle
      (function initDrawerToggle(){
        const hamb = document.getElementById('hamburger');
        if(!hamb || !drawer) return;
        if(hamb.dataset.inited === '1') return;
        hamb.dataset.inited = '1';
        hamb.addEventListener('click', (e) => {
          e.stopPropagation();
          drawer.classList.toggle('open');
        });
        document.addEventListener('click', (e) => {
          const inside = drawer.contains(e.target) || hamb.contains(e.target);
          if(!inside) drawer.classList.remove('open');
        });
        drawer.addEventListener('click', (e) => {
          const a = e.target.closest('a');
          if(a) drawer.classList.remove('open');
        });
        document.addEventListener('keydown', (e) => {
          if(e.key === 'Escape') drawer.classList.remove('open');
        });
      })();
      
      panels.forEach(p => {
        const li = document.createElement('li');
        li.className = 'nav-item';
        li.innerHTML = `<div class="nav-btn">${p.baslik} <span class="caret">‚ñæ</span></div>`;
        const dd = document.createElement('div');
        dd.className = 'dropdown';
        (p.pages || []).forEach(pg => {
          const a = document.createElement('a');
          a.href = pg.url;
          a.textContent = pg.baslik;
          a.dataset.key = pg.key || pg.baslik;
          a.dataset.panel = p.id;
          a.dataset.panelTitle = p.baslik;
          dd.appendChild(a);
        });
        li.appendChild(dd);
        li.querySelector('.nav-btn').addEventListener('click', (e) => {
          e.stopPropagation();
          ul.querySelectorAll('.nav-item').forEach(x => {
            if(x !== li) x.classList.remove('open');
          });
          li.classList.toggle('open');
        });
        ul.appendChild(li);
      });
      
      document.addEventListener('click', (e) => {
        if(!ul.contains(e.target)) ul.querySelectorAll('.nav-item').forEach(x => x.classList.remove('open'));
      });
      
      panels.forEach(p => {
        const h = document.createElement('div');
        h.className = 'panel-title';
        h.textContent = p.baslik;
        drawer.appendChild(h);
        (p.pages || []).forEach(pg => {
          const a = document.createElement('a');
          a.href = pg.url;
          a.textContent = pg.baslik;
          a.dataset.key = pg.key || pg.baslik;
          a.dataset.panel = p.id;
          a.dataset.panelTitle = p.baslik;
          drawer.appendChild(a);
        });
      });
    }
    
    document.addEventListener('click', (e) => {
      const a = e.target.closest('a[data-key]');
      if(!a) return;
      const key = norm(a.dataset.key), pnl = norm(a.dataset.panel || ''), pnlT = norm(a.dataset.panelTitle || '');
      if(CURRENT_DENY.has(key)){
        e.preventDefault();
        showToast('Bu sayfa i√ßin yetkiniz yok.');
        return;
      }
      const allowed = CURRENT_ALLOW.has(key) || CURRENT_ALLOW.has(pnl) || CURRENT_ALLOW.has(pnlT);
      if(!allowed){
        e.preventDefault();
        showToast('Bu sayfa i√ßin yetkiniz yok.');
      }
    });

    // Load functions
    async function loadGirisLoglari(){
      const container = document.getElementById('girisLoglari');
      container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--muted)">Y√ºkleniyor...</div>';
      
      try{
        const baslangic = document.getElementById('filterGirisBaslangic').value;
        const bitis = document.getElementById('filterGirisBitis').value;
        
        // kullanici_log koleksiyonunda giri≈ü kayƒ±tlarƒ± (durum="acilis" veya event yoksa veya page="index.html" gibi)
        // √ñnce basit sorgu dene
        let query = db.collection("kullanici_log");
        
        // Tarih filtreleri
        if(baslangic && bitis){
          const startTs = firebase.firestore.Timestamp.fromDate(new Date(baslangic + 'T00:00:00'));
          const endTs = firebase.firestore.Timestamp.fromDate(new Date(bitis + 'T23:59:59'));
          query = query.where("ts", ">=", startTs).where("ts", "<=", endTs);
        } else if(baslangic){
          const startTs = firebase.firestore.Timestamp.fromDate(new Date(baslangic + 'T00:00:00'));
          query = query.where("ts", ">=", startTs);
        } else if(bitis){
          const endTs = firebase.firestore.Timestamp.fromDate(new Date(bitis + 'T23:59:59'));
          query = query.where("ts", "<=", endTs);
        }
        
        // Giri≈ü kayƒ±tlarƒ±nƒ± filtrele (durum="acilis" veya mesaj="Uygulama a√ßƒ±ldƒ±" gibi)
        // Index hatasƒ± olmamasƒ± i√ßin √∂nce t√ºm√ºn√º √ßek, sonra filtrele
        const snap = await query.orderBy("ts", "desc").limit(200).get();
        const view = document.getElementById('viewGiris').value;
        
        // Client-side filtreleme (giri≈ü kayƒ±tlarƒ±)
        const girisLogs = [];
        snap.forEach(doc => {
      const d = doc.data();
          // Giri≈ü kaydƒ± kontrol√º: durum="acilis" veya mesaj i√ßinde "a√ßƒ±ldƒ±" veya page yoksa
          if(d.durum === 'acilis' || (d.mesaj && d.mesaj.includes('a√ßƒ±ldƒ±')) || (!d.page && !d.event)){
            girisLogs.push({id: doc.id, ...d});
          }
        });
        
        if(girisLogs.length === 0){
          container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--muted)">Kayƒ±t bulunamadƒ±</div>';
          document.getElementById('statGiris').textContent = '0';
          return;
        }
        
        if(view === 'table'){
          renderGirisTable(girisLogs, container);
        } else {
          renderGirisCards(girisLogs, container);
        }
        
        document.getElementById('statGiris').textContent = girisLogs.length;
      }catch(e){
        console.error('Giri≈ü loglarƒ± hatasƒ±:', e);
        if(e.message && e.message.includes('index')){
          container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--warn)">‚ö†Ô∏è Firestore index gerekli. L√ºtfen konsolu kontrol edin ve √∂nerilen index\'i olu≈üturun.</div>';
        } else {
          container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--bad)">Hata: ' + e.message + '</div>';
        }
      }
    }

    function renderGirisTable(logs, container){
      let html = `
        <div class="log-table-wrapper">
          <table class="log-table">
            <thead>
              <tr>
                <th>UID</th>
                <th>Email</th>
                <th>Zaman</th>
                <th>Durum/Mesaj</th>
                <th>Tarayƒ±cƒ±</th>
              </tr>
            </thead>
            <tbody>
      `;
      logs.forEach(log => {
        const ts = log.ts?.toDate ? log.ts.toDate() : (log.zaman?.toDate ? log.zaman.toDate() : new Date());
        const ua = log.ua || log.userAgent || '-';
        html += `
          <tr>
            <td><code style="font-size:11px">${log.uid || '-'}</code></td>
            <td>${log.email || '-'}</td>
            <td>${ts.toLocaleString('tr-TR')}</td>
            <td>${log.durum ? `<span class="badge badge-success">${log.durum}</span>` : ''} ${log.mesaj || log.title || '-'}</td>
            <td style="max-width:300px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap" title="${ua}">${ua.substring(0, 60)}...</td>
          </tr>
        `;
      });
      html += '</tbody></table></div>';
      container.innerHTML = html;
    }

    function renderGirisCards(logs, container){
      let html = '<div class="log-grid">';
      logs.forEach(log => {
        const ts = log.ts?.toDate ? log.ts.toDate() : (log.zaman?.toDate ? log.zaman.toDate() : new Date());
        const ua = log.ua || log.userAgent || '-';
        html += `
          <div class="log-card">
            <div class="log-card-header">
              <div class="log-card-title">Giri≈ü Kaydƒ± ${log.durum ? `<span class="badge badge-success">${log.durum}</span>` : ''}</div>
              <div class="log-card-time">${ts.toLocaleString('tr-TR')}</div>
            </div>
            <div class="log-card-body">
              <div class="log-card-item">
                <span class="log-card-label">UID:</span>
                <span class="log-card-value"><code>${log.uid || '-'}</code></span>
              </div>
              <div class="log-card-item">
                <span class="log-card-label">Email:</span>
                <span class="log-card-value">${log.email || '-'}</span>
              </div>
              <div class="log-card-item">
                <span class="log-card-label">Mesaj:</span>
                <span class="log-card-value">${log.mesaj || log.title || '-'}</span>
              </div>
              <div class="log-card-item">
                <span class="log-card-label">Tarayƒ±cƒ±:</span>
                <span class="log-card-value" style="font-size:11px">${ua.substring(0, 80)}${ua.length > 80 ? '...' : ''}</span>
              </div>
            </div>
        </div>
      `;
    });
      html += '</div>';
      container.innerHTML = html;
    }

    async function loadSayfaLoglari(){
      const container = document.getElementById('sayfaLoglari');
      container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--muted)">Y√ºkleniyor...</div>';
      
      try{
        const baslangic = document.getElementById('filterSayfaBaslangic').value;
        const bitis = document.getElementById('filterSayfaBitis').value;
        const sayfaAdi = document.getElementById('filterSayfaAdi').value;
        
        // kullanici_log koleksiyonundan sayfa hareketlerini √ßek
        let query = db.collection("kullanici_log");
        
        // Tarih filtreleri
        if(baslangic && bitis){
          const startTs = firebase.firestore.Timestamp.fromDate(new Date(baslangic + 'T00:00:00'));
          const endTs = firebase.firestore.Timestamp.fromDate(new Date(bitis + 'T23:59:59'));
          query = query.where("ts", ">=", startTs).where("ts", "<=", endTs);
        } else if(baslangic){
          const startTs = firebase.firestore.Timestamp.fromDate(new Date(baslangic + 'T00:00:00'));
          query = query.where("ts", ">=", startTs);
        } else if(bitis){
          const endTs = firebase.firestore.Timestamp.fromDate(new Date(bitis + 'T23:59:59'));
          query = query.where("ts", "<=", endTs);
        }
        
        const snap = await query.orderBy("ts", "desc").limit(200).get();
        const view = document.getElementById('viewSayfa').value;
        
        // Client-side filtreleme (sayfa hareketleri - giri≈ü kayƒ±tlarƒ± deƒüil)
        const sayfaLogs = [];
        snap.forEach(doc => {
      const d = doc.data();
          // Sayfa hareketi kontrol√º: page var veya event var veya durum giri≈ü deƒüilse
          const isSayfaHareketi = d.page || d.event || (d.durum && d.durum !== 'acilis');
          if(isSayfaHareketi){
            if(!sayfaAdi || d.page === sayfaAdi || d.sayfa === sayfaAdi){
              sayfaLogs.push({id: doc.id, ...d});
            }
          }
        });
        
        if(sayfaLogs.length === 0){
          container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--muted)">Kayƒ±t bulunamadƒ±</div>';
          document.getElementById('statSayfa').textContent = '0';
          return;
        }
        
        if(view === 'table'){
          renderSayfaTable(sayfaLogs, container);
        } else {
          renderSayfaCards(sayfaLogs, container);
        }
        
        document.getElementById('statSayfa').textContent = sayfaLogs.length;
      }catch(e){
        console.error('Sayfa loglarƒ± hatasƒ±:', e);
        if(e.message && e.message.includes('index')){
          container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--warn)">‚ö†Ô∏è Firestore index gerekli. L√ºtfen konsolu kontrol edin ve √∂nerilen index\'i olu≈üturun.</div>';
        } else {
          container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--bad)">Hata: ' + e.message + '</div>';
        }
      }
    }

    function renderSayfaTable(logs, container){
      let html = `
        <div class="log-table-wrapper">
          <table class="log-table">
            <thead>
              <tr>
                <th>Sayfa/Event</th>
                <th>UID</th>
                <th>Email</th>
                <th>Zaman</th>
                <th>Detay</th>
              </tr>
            </thead>
            <tbody>
      `;
      logs.forEach(log => {
        const ts = log.ts?.toDate ? log.ts.toDate() : (log.zaman?.toDate ? log.zaman.toDate() : new Date());
        const sayfa = log.page || log.sayfa || log.extra?.sayfa || '-';
        const event = log.event || '-';
        html += `
          <tr>
            <td>${sayfa !== '-' ? `<span class="badge badge-info">${sayfa}</span>` : ''} ${event !== '-' ? `<span class="badge badge-warning">${event}</span>` : ''}</td>
            <td><code style="font-size:11px">${log.uid || '-'}</code></td>
            <td>${log.email || '-'}</td>
            <td>${ts.toLocaleString('tr-TR')}</td>
            <td>${log.title || log.mesaj || log.detay || '-'}</td>
          </tr>
        `;
      });
      html += '</tbody></table></div>';
      container.innerHTML = html;
    }

    function renderSayfaCards(logs, container){
      let html = '<div class="log-grid">';
      logs.forEach(log => {
        const ts = log.ts?.toDate ? log.ts.toDate() : (log.zaman?.toDate ? log.zaman.toDate() : new Date());
        const sayfa = log.page || log.sayfa || log.extra?.sayfa || '-';
        const event = log.event || '-';
        html += `
          <div class="log-card">
            <div class="log-card-header">
              <div class="log-card-title">
                ${sayfa !== '-' ? `<span class="badge badge-info">${sayfa}</span>` : ''}
                ${event !== '-' ? `<span class="badge badge-warning">${event}</span>` : ''}
              </div>
              <div class="log-card-time">${ts.toLocaleString('tr-TR')}</div>
            </div>
            <div class="log-card-body">
              <div class="log-card-item">
                <span class="log-card-label">UID:</span>
                <span class="log-card-value"><code>${log.uid || '-'}</code></span>
              </div>
              <div class="log-card-item">
                <span class="log-card-label">Email:</span>
                <span class="log-card-value">${log.email || '-'}</span>
              </div>
              <div class="log-card-item">
                <span class="log-card-label">Detay:</span>
                <span class="log-card-value">${log.title || log.mesaj || log.detay || '-'}</span>
              </div>
            </div>
        </div>
      `;
    });
      html += '</div>';
      container.innerHTML = html;
    }

    async function loadIslemLoglari(){
      const container = document.getElementById('islemLoglari');
      container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--muted)">Y√ºkleniyor...</div>';
      
      try{
        const baslangic = document.getElementById('filterIslemBaslangic').value;
        const bitis = document.getElementById('filterIslemBitis').value;
        const islemTuru = document.getElementById('filterIslemTuru').value;
        
        // islem_log koleksiyonundan i≈ülem kayƒ±tlarƒ±nƒ± √ßek
        let query = db.collection("islem_log");
        
        // Tarih filtreleri
        if(baslangic && bitis){
          const startTs = firebase.firestore.Timestamp.fromDate(new Date(baslangic + 'T00:00:00'));
          const endTs = firebase.firestore.Timestamp.fromDate(new Date(bitis + 'T23:59:59'));
          query = query.where("zaman", ">=", startTs).where("zaman", "<=", endTs);
        } else if(baslangic){
          const startTs = firebase.firestore.Timestamp.fromDate(new Date(baslangic + 'T00:00:00'));
          query = query.where("zaman", ">=", startTs);
        } else if(bitis){
          const endTs = firebase.firestore.Timestamp.fromDate(new Date(bitis + 'T23:59:59'));
          query = query.where("zaman", "<=", endTs);
        }
        
        const snap = await query.orderBy("zaman", "desc").limit(200).get();
        const view = document.getElementById('viewIslem').value;
        
        // Client-side filtreleme (i≈ülem t√ºr√º)
        const islemLogs = [];
        snap.forEach(doc => {
      const d = doc.data();
          if(!islemTuru || d.detay === islemTuru || d.islem === islemTuru || (d.detay && d.detay.includes(islemTuru))){
            islemLogs.push({id: doc.id, ...d});
          }
        });
        
        if(islemLogs.length === 0){
          container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--muted)">Kayƒ±t bulunamadƒ±</div>';
          document.getElementById('statIslem').textContent = '0';
          return;
        }
        
        if(view === 'table'){
          renderIslemTable(islemLogs, container);
        } else {
          renderIslemCards(islemLogs, container);
        }
        
        document.getElementById('statIslem').textContent = islemLogs.length;
      }catch(e){
        console.error('ƒ∞≈ülem loglarƒ± hatasƒ±:', e);
        if(e.message && e.message.includes('index')){
          container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--warn)">‚ö†Ô∏è Firestore index gerekli. L√ºtfen konsolu kontrol edin ve √∂nerilen index\'i olu≈üturun.<br><br>√ñnerilen index: <code>islem_log: zaman (Ascending)</code></div>';
        } else {
          container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--bad)">Hata: ' + e.message + '</div>';
        }
      }
    }

    function renderIslemTable(logs, container){
      let html = `
        <div class="log-table-wrapper">
          <table class="log-table">
            <thead>
              <tr>
                <th>ƒ∞≈ülem/Detay</th>
                <th>Yapan UID</th>
                <th>Email</th>
                <th>Zaman</th>
                <th>Ekstra Bilgi</th>
              </tr>
            </thead>
            <tbody>
      `;
      logs.forEach(log => {
        const ts = log.zaman?.toDate ? log.zaman.toDate() : new Date();
        const detay = log.detay || log.islem || '-';
        html += `
          <tr>
            <td><span class="badge badge-warning">${detay}</span></td>
            <td><code style="font-size:11px">${log.uid || '-'}</code></td>
            <td>${log.email || '-'}</td>
            <td>${ts.toLocaleString('tr-TR')}</td>
            <td>${log.extra ? JSON.stringify(log.extra).substring(0, 50) + '...' : '-'}</td>
          </tr>
        `;
      });
      html += '</tbody></table></div>';
      container.innerHTML = html;
    }

    function renderIslemCards(logs, container){
      let html = '<div class="log-grid">';
      logs.forEach(log => {
        const ts = log.zaman?.toDate ? log.zaman.toDate() : new Date();
        const detay = log.detay || log.islem || '-';
        html += `
          <div class="log-card">
            <div class="log-card-header">
              <div class="log-card-title"><span class="badge badge-warning">${detay}</span></div>
              <div class="log-card-time">${ts.toLocaleString('tr-TR')}</div>
            </div>
            <div class="log-card-body">
              <div class="log-card-item">
                <span class="log-card-label">Yapan UID:</span>
                <span class="log-card-value"><code>${log.uid || '-'}</code></span>
              </div>
              <div class="log-card-item">
                <span class="log-card-label">Email:</span>
                <span class="log-card-value">${log.email || '-'}</span>
              </div>
              <div class="log-card-item">
                <span class="log-card-label">Detay:</span>
                <span class="log-card-value">${detay}</span>
              </div>
              ${log.extra ? `
              <div class="log-card-item">
                <span class="log-card-label">Ekstra:</span>
                <span class="log-card-value" style="font-size:11px">${JSON.stringify(log.extra)}</span>
              </div>
              ` : ''}
              ${log.userAgent ? `
              <div class="log-card-item">
                <span class="log-card-label">Tarayƒ±cƒ±:</span>
                <span class="log-card-value" style="font-size:11px">${log.userAgent.substring(0, 60)}...</span>
              </div>
              ` : ''}
            </div>
          </div>
        `;
      });
      html += '</div>';
      container.innerHTML = html;
    }

    async function loadRaporlar(){
      const container = document.getElementById('raporIcerik');
      container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--muted)">Rapor olu≈üturmak i√ßin filtreleri se√ßin ve "Rapor Olu≈ütur" butonuna tƒ±klayƒ±n</div>';
    }

    async function generateReport(){
      const turu = document.getElementById('raporTuru').value;
      const tarih = document.getElementById('raporTarih').value;
      const container = document.getElementById('raporIcerik');
      container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--muted)">Rapor olu≈üturuluyor...</div>';
      
      try{
        const selectedDate = tarih ? new Date(tarih) : new Date();
        let startDate, endDate, title;
        
        if(turu === 'gunluk'){
          startDate = new Date(selectedDate);
          startDate.setHours(0,0,0,0);
          endDate = new Date(selectedDate);
          endDate.setHours(23,59,59,999);
          title = `G√ºnl√ºk √ñzet - ${selectedDate.toLocaleDateString('tr-TR')}`;
        } else if(turu === 'haftalik'){
          const day = selectedDate.getDay();
          const diff = selectedDate.getDate() - day + (day === 0 ? -6 : 1);
          startDate = new Date(selectedDate.setDate(diff));
          startDate.setHours(0,0,0,0);
          endDate = new Date(startDate);
          endDate.setDate(endDate.getDate() + 6);
          endDate.setHours(23,59,59,999);
          title = `Haftalƒ±k √ñzet - ${startDate.toLocaleDateString('tr-TR')} / ${endDate.toLocaleDateString('tr-TR')}`;
        } else if(turu === 'aylik'){
          startDate = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1);
          endDate = new Date(selectedDate.getFullYear(), selectedDate.getMonth() + 1, 0, 23, 59, 59, 999);
          title = `Aylƒ±k √ñzet - ${selectedDate.toLocaleDateString('tr-TR', {month:'long', year:'numeric'})}`;
        } else {
          title = 'Kullanƒ±cƒ± Bazlƒ± √ñzet';
        }
        
        const startTs = firebase.firestore.Timestamp.fromDate(startDate);
        const endTs = firebase.firestore.Timestamp.fromDate(endDate);
        
        let html = `<div class="card"><h3>${title}</h3>`;
        
        if(turu === 'kullanici'){
          // Kullanƒ±cƒ± bazlƒ± rapor
          const [kullaniciSnap, islemSnap] = await Promise.all([
            db.collection("kullanici_log").orderBy("ts", "desc").limit(2000).get(),
            db.collection("islem_log").orderBy("zaman", "desc").limit(2000).get()
          ]);
          
          const userStats = {};
          
          // kullanici_log'dan giri≈ü ve sayfa hareketlerini ayƒ±r
          kullaniciSnap.forEach(doc => {
            const d = doc.data();
            const uid = d.uid;
            if(!uid) return;
            if(!userStats[uid]) userStats[uid] = {giris:0, sayfa:0, islem:0, email: d.email || '-'};
            
            if(d.durum === 'acilis' || (d.mesaj && d.mesaj.includes('a√ßƒ±ldƒ±')) || (!d.page && !d.event)){
              userStats[uid].giris++;
            } else {
              userStats[uid].sayfa++;
            }
          });
          
          // islem_log'dan i≈ülemleri say
          islemSnap.forEach(doc => {
            const d = doc.data();
            const uid = d.uid;
            if(!uid) return;
            if(!userStats[uid]) userStats[uid] = {giris:0, sayfa:0, islem:0, email: d.email || '-'};
            userStats[uid].islem++;
          });
          
          html += '<table class="log-table"><thead><tr><th>Kullanƒ±cƒ± UID</th><th>Email</th><th>Giri≈ü</th><th>Sayfa</th><th>ƒ∞≈ülem</th><th>Toplam</th></tr></thead><tbody>';
          Object.entries(userStats).sort((a,b) => (b[1].giris + b[1].sayfa + b[1].islem) - (a[1].giris + a[1].sayfa + a[1].islem)).forEach(([uid, stats]) => {
            const total = stats.giris + stats.sayfa + stats.islem;
            html += `<tr><td><code>${uid}</code></td><td>${stats.email}</td><td>${stats.giris}</td><td>${stats.sayfa}</td><td>${stats.islem}</td><td><strong>${total}</strong></td></tr>`;
          });
          html += '</tbody></table>';
        } else {
          // Tarih bazlƒ± rapor
          const [kullaniciSnap, islemSnap] = await Promise.all([
            db.collection("kullanici_log").where("ts", ">=", startTs).where("ts", "<=", endTs).orderBy("ts", "desc").limit(1000).get().catch(() => {
              // Index hatasƒ± olursa tarih filtresiz √ßek
              return db.collection("kullanici_log").orderBy("ts", "desc").limit(1000).get();
            }),
            db.collection("islem_log").where("zaman", ">=", startTs).where("zaman", "<=", endTs).orderBy("zaman", "desc").limit(1000).get().catch(() => {
              return db.collection("islem_log").orderBy("zaman", "desc").limit(1000).get();
            })
          ]);
          
          // Client-side tarih filtreleme (index hatasƒ± durumunda)
          let girisCount = 0, sayfaCount = 0;
          kullaniciSnap.forEach(doc => {
            const d = doc.data();
            const docTs = d.ts?.toDate ? d.ts.toDate() : new Date();
            // Eƒüer where ile filtreleme yapƒ±ldƒ±ysa zaten filtrelenmi≈ü, yoksa client-side filtrele
            if(turu !== 'kullanici' && startDate && endDate){
              if(docTs < startDate || docTs > endDate) return;
            }
            if(d.durum === 'acilis' || (d.mesaj && d.mesaj.includes('a√ßƒ±ldƒ±')) || (!d.page && !d.event)){
              girisCount++;
            } else {
              sayfaCount++;
            }
          });
          
          let islemCount = 0;
          islemSnap.forEach(doc => {
            const d = doc.data();
            const docTs = d.zaman?.toDate ? d.zaman.toDate() : new Date();
            if(turu !== 'kullanici' && startDate && endDate){
              if(docTs < startDate || docTs > endDate) return;
            }
            islemCount++;
          });
          
          html += `
            <div class="stats-grid" style="margin-bottom:20px">
              <div class="stat-card">
                <div class="stat-card-label">Giri≈ü Kayƒ±tlarƒ±</div>
                <div class="stat-card-value">${girisCount}</div>
              </div>
              <div class="stat-card">
                <div class="stat-card-label">Sayfa Hareketleri</div>
                <div class="stat-card-value">${sayfaCount}</div>
              </div>
              <div class="stat-card">
                <div class="stat-card-label">ƒ∞≈ülem Kayƒ±tlarƒ±</div>
                <div class="stat-card-value">${islemCount}</div>
              </div>
              <div class="stat-card">
                <div class="stat-card-label">Toplam</div>
                <div class="stat-card-value">${girisCount + sayfaCount + islemCount}</div>
              </div>
            </div>
          `;
          
          // En √ßok ziyaret edilen sayfalar
          const sayfaCounts = {};
          kullaniciSnap.forEach(doc => {
            const d = doc.data();
            const docTs = d.ts?.toDate ? d.ts.toDate() : new Date();
            if(turu !== 'kullanici' && startDate && endDate){
              if(docTs < startDate || docTs > endDate) return;
            }
            const sayfa = d.page || d.sayfa || d.extra?.sayfa;
            if(sayfa && d.durum !== 'acilis'){
              sayfaCounts[sayfa] = (sayfaCounts[sayfa] || 0) + 1;
            }
          });
          
          if(Object.keys(sayfaCounts).length > 0){
            html += '<h4 style="margin-top:20px">En √áok Ziyaret Edilen Sayfalar</h4><table class="log-table"><thead><tr><th>Sayfa</th><th>Ziyaret</th></tr></thead><tbody>';
            Object.entries(sayfaCounts).sort((a,b) => b[1] - a[1]).slice(0, 10).forEach(([sayfa, count]) => {
              html += `<tr><td><span class="badge badge-info">${sayfa}</span></td><td>${count}</td></tr>`;
            });
            html += '</tbody></table>';
          }
        }
        
        html += '</div>';
        container.innerHTML = html;
        showToast('‚úÖ Rapor olu≈üturuldu');
      }catch(e){
        console.error('Rapor hatasƒ±:', e);
        container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--bad)">Hata: ' + e.message + '</div>';
        showToast('‚ùå Rapor olu≈üturulamadƒ±');
      }
    }

    // Filter change listeners
    document.getElementById('filterGirisBaslangic')?.addEventListener('change', loadGirisLoglari);
    document.getElementById('filterGirisBitis')?.addEventListener('change', loadGirisLoglari);
    document.getElementById('viewGiris')?.addEventListener('change', loadGirisLoglari);
    document.getElementById('filterSayfaBaslangic')?.addEventListener('change', loadSayfaLoglari);
    document.getElementById('filterSayfaBitis')?.addEventListener('change', loadSayfaLoglari);
    document.getElementById('filterSayfaAdi')?.addEventListener('change', loadSayfaLoglari);
    document.getElementById('viewSayfa')?.addEventListener('change', loadSayfaLoglari);
    document.getElementById('filterIslemBaslangic')?.addEventListener('change', loadIslemLoglari);
    document.getElementById('filterIslemBitis')?.addEventListener('change', loadIslemLoglari);
    document.getElementById('filterIslemTuru')?.addEventListener('change', loadIslemLoglari);
    document.getElementById('viewIslem')?.addEventListener('change', loadIslemLoglari);

    // Initialize
    try{
      firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL);
    }catch(e){}
    
    if(auth){
      auth.onAuthStateChanged(async user => {
        if(!user){
          setTimeout(() => {
            if(!auth.currentUser) location.replace('../index.html');
          }, 150);
          return;
        }
        
        try{
          // Load user permissions
          const uSnap = await db.collection('kullanicilar').doc(user.uid).get();
          const data = uSnap.exists ? uSnap.data() : {};
          const rawPerms = Array.isArray(data.yetkiler) ? data.yetkiler : [];
          CURRENT_ALLOW = new Set(rawPerms.filter(s => !String(s).trim().startsWith('-') && !String(s).trim().startsWith('!')).map(norm));
          CURRENT_DENY = new Set(rawPerms.filter(s => String(s).trim().startsWith('-') || String(s).trim().startsWith('!')).map(s => norm(String(s).replace(/^[-!]\s*/,''))));
          
          // Load navigation
          const panels = await fetchPanels(CURRENT_ALLOW, CURRENT_DENY);
          renderNav(panels);
          
          // Set default dates
          const today = new Date();
          const lastWeek = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
          document.getElementById('filterGirisBaslangic').value = lastWeek.toISOString().split('T')[0];
          document.getElementById('filterGirisBitis').value = today.toISOString().split('T')[0];
          document.getElementById('filterSayfaBaslangic').value = lastWeek.toISOString().split('T')[0];
          document.getElementById('filterSayfaBitis').value = today.toISOString().split('T')[0];
          document.getElementById('filterIslemBaslangic').value = lastWeek.toISOString().split('T')[0];
          document.getElementById('filterIslemBitis').value = today.toISOString().split('T')[0];
          document.getElementById('raporTarih').value = today.toISOString().split('T')[0];
          
          // Load unique pages for filter
          try{
            const sayfaSnap = await db.collection("kullanici_log").orderBy("ts", "desc").limit(500).get();
            const uniquePages = new Set();
            sayfaSnap.forEach(doc => {
              const d = doc.data();
              const sayfa = d.page || d.sayfa || d.extra?.sayfa;
              if(sayfa) uniquePages.add(sayfa);
            });
            const sayfaSelect = document.getElementById('filterSayfaAdi');
            Array.from(uniquePages).sort().forEach(sayfa => {
              const opt = document.createElement('option');
              opt.value = sayfa;
              opt.textContent = sayfa;
              sayfaSelect.appendChild(opt);
            });
          }catch(e){
            console.warn('Sayfa filtreleri y√ºklenemedi:', e);
          }
          
          // Load unique operations for filter
          try{
            const islemSnap = await db.collection("islem_log").orderBy("zaman", "desc").limit(500).get();
            const uniqueIslemler = new Set();
            islemSnap.forEach(doc => {
              const d = doc.data();
              const islem = d.detay || d.islem;
              if(islem){
                // Detay alanƒ±ndan i≈ülem t√ºr√ºn√º √ßƒ±kar (√∂rn: "TEMIZLIK_KATLARI:SAYFA_GIRIS" -> "TEMIZLIK_KATLARI")
                const parts = islem.split(':');
                if(parts.length > 0) uniqueIslemler.add(parts[0]);
                uniqueIslemler.add(islem);
              }
            });
            const islemSelect = document.getElementById('filterIslemTuru');
            Array.from(uniqueIslemler).sort().forEach(islem => {
              const opt = document.createElement('option');
              opt.value = islem;
              opt.textContent = islem;
              islemSelect.appendChild(opt);
            });
          }catch(e){
            console.warn('ƒ∞≈ülem filtreleri y√ºklenemedi:', e);
          }
          
          // Load initial data
          loadGirisLoglari();
          
          // Update last update time
          document.getElementById('lastUpdate').textContent = new Date().toLocaleString('tr-TR');
          
          // Calculate total logs (basit sorgular - index hatasƒ± olmamasƒ± i√ßin)
          try{
            const [kullaniciSnap, islemSnap] = await Promise.all([
              db.collection("kullanici_log").orderBy("ts", "desc").limit(1000).get(),
              db.collection("islem_log").orderBy("zaman", "desc").limit(1000).get()
            ]);
            
            // Client-side filtreleme
            let girisCount = 0, sayfaCount = 0;
            kullaniciSnap.forEach(doc => {
              const d = doc.data();
              if(d.durum === 'acilis' || (d.mesaj && d.mesaj.includes('a√ßƒ±ldƒ±')) || (!d.page && !d.event)){
                girisCount++;
              } else {
                sayfaCount++;
              }
            });
            
            document.getElementById('statGiris').textContent = girisCount >= 1000 ? '1000+' : girisCount;
            document.getElementById('statSayfa').textContent = sayfaCount >= 1000 ? '1000+' : sayfaCount;
            document.getElementById('statIslem').textContent = islemSnap.size >= 1000 ? '1000+' : islemSnap.size;
            
            // Get unique users
            const uniqueUsers = new Set();
            kullaniciSnap.forEach(doc => {
              const uid = doc.data().uid;
              if(uid) uniqueUsers.add(uid);
            });
            document.getElementById('statAktif').textContent = uniqueUsers.size;
            document.getElementById('totalLogs').textContent = girisCount + sayfaCount + islemSnap.size;
          }catch(e){
            console.error('Stats error:', e);
            // Index hatasƒ± olursa basit sayƒ±m yap
            try{
              const kullaniciSnap = await db.collection("kullanici_log").limit(100).get();
              const islemSnap = await db.collection("islem_log").limit(100).get();
              document.getElementById('statGiris').textContent = kullaniciSnap.size;
              document.getElementById('statSayfa').textContent = kullaniciSnap.size;
              document.getElementById('statIslem').textContent = islemSnap.size;
            }catch(e2){
              console.error('Basit stats error:', e2);
            }
          }
        }catch(e){
          console.error('Init error:', e);
          showToast('‚ùå Veriler y√ºklenirken hata: ' + (e.message || 'Bilinmeyen hata'));
        }
      });
    }
</script>
</body>
</html>
