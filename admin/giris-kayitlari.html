<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>GiriÅŸ KayÄ±tlarÄ± | KaraaÄŸaÃ§ Fatih</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" type="image/png" href="../img/logo.png" />
  <link rel="stylesheet" href="../css/app-shell.css" />

  <style>
    /* app-shell.css Ã¼st panel/nav/arka plan saÄŸlar. Sadece sayfa-Ã¶zel stiller burada. */
    body { padding-top: var(--appbar-h) !important; overflow-x: hidden; }
    .container{max-width:1550px; margin:0 auto; padding:16px}
    .hero{display:flex; justify-content:space-between; align-items:flex-start; gap:16px; background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius); padding:16px; margin:16px 0; box-shadow:var(--shadow)}
    .hero h2{margin:0 0 6px; font-size:20px}
    .hero-sub{color:var(--muted); font-size:13px; line-height:1.35}
    .mini{display:flex; gap:8px; flex-wrap:wrap}
    .pill{padding:6px 10px; border-radius:999px; border:1px solid var(--stroke); background:var(--pill); font-size:12px}

    .card{background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px; margin-bottom:14px}
    .card h3{margin:0 0 10px; font-size:16px}

    /* TABS */
    .tabs{display:flex; gap:8px; margin-bottom:16px; border-bottom:2px solid var(--stroke); overflow-x:auto}
    .tab{padding:12px 20px; background:transparent; border:none; color:var(--muted); font-weight:600; cursor:pointer; border-bottom:3px solid transparent; margin-bottom:-2px; transition:all .2s; white-space:nowrap; font-size:14px}
    .tab:hover{color:var(--text); background:var(--surface)}
    .tab.active{color:var(--brand); border-bottom-color:var(--brand)}
    .tab-content{display:none}
    .tab-content.active{display:block}

    /* LOG TABLE */
    .log-table-wrapper{overflow-x:auto; margin-top:12px}
    .log-table{width:100%; border-collapse:separate; border-spacing:0 6px; min-width:800px}
    .log-table thead th{background:var(--surface); padding:12px; border-bottom:2px solid var(--stroke); text-align:left; font-weight:700; font-size:13px; color:var(--muted)}
    .log-table tbody td{background:var(--card); border:1px solid var(--stroke); padding:12px; border-radius:8px}
    .log-table tbody tr:hover td{background:var(--surface)}

    /* LOG ITEM CARD */
    .log-grid{display:grid; grid-template-columns:repeat(auto-fill, minmax(320px, 1fr)); gap:12px; margin-top:12px}
    .log-card{background:var(--card); border:1px solid var(--stroke); border-radius:12px; padding:14px; transition:all .2s}
    .log-card:hover{background:var(--surface); transform:translateY(-2px); box-shadow:var(--shadow)}
    .log-card-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; padding-bottom:10px; border-bottom:1px solid var(--stroke)}
    .log-card-title{font-weight:700; font-size:14px; color:var(--text)}
    .log-card-time{font-size:11px; color:var(--muted)}
    .log-card-body{display:flex; flex-direction:column; gap:6px}
    .log-card-item{display:flex; gap:8px; font-size:12px}
    .log-card-label{color:var(--muted); font-weight:600; min-width:80px}
    .log-card-value{color:var(--text); word-break:break-word}

    /* STATS CARDS */
    .stats-grid{display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:12px; margin-bottom:20px}
    .stat-card{background:var(--card); border:1px solid var(--stroke); border-radius:12px; padding:16px; text-align:center}
    .stat-card-value{font-size:32px; font-weight:900; color:var(--brand); margin:8px 0}
    .stat-card-label{font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:.05em}

    /* FILTERS */
    .filters{display:flex; gap:12px; margin-bottom:16px; flex-wrap:wrap; align-items:end}
    .filter-group{display:flex; flex-direction:column; gap:6px}
    .filter-group label{font-size:12px; color:var(--muted); font-weight:600}
    .filter-group select, .filter-group input{width:100%; padding:8px 12px; border-radius:8px; border:1px solid var(--stroke); background:var(--pill); color:var(--text); font-size:13px}

    .toast{position:fixed; left:50%; bottom:24px; transform:translateX(-50%) translateY(20px); background:rgba(2,6,23,.95); color:#fff; border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:10px 12px; opacity:0; pointer-events:none; transition:opacity .25s, transform .25s; z-index:200}
    .toast.show{opacity:1; transform:translateX(-50%) translateY(0)}

    @media (max-width: 1024px){
      .stats-grid{grid-template-columns:repeat(2, 1fr)}
      .log-grid{grid-template-columns:1fr}
    }
    @media (max-width: 768px){
      .container{padding:12px}
      .hero{flex-direction:column; padding:12px}
      .tabs{overflow-x:auto; -webkit-overflow-scrolling:touch}
      .tab{padding:10px 14px; font-size:13px}
      .filters{flex-direction:column}
      .filter-group{width:100%}
    }
  </style>

  <!-- Supabase (Auth + Database) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="../src/supabase.js"></script>
  <script src="../src/supabase-auth-wrapper.js"></script>
  <script src="../js/ortak.js"></script>
</head>
<body>
  <div class="appbar">
    <div class="brand" onclick="location.href='../panel.html'">
      <img src="../img/logo.png" alt="logo"><span>KARAAÄAÃ‡ FATÄ°H</span>
    </div>
    <nav class="nav-center">
      <ul class="nav-list" id="navMain"></ul>
    </nav>
    <div class="nav-right">
      <button class="btn hamb" id="hamburger" title="MenÃ¼">â˜°</button>
      <div class="nav-item">
        <button class="iconbtn" id="btnNotif" title="Bildirimler">ğŸ””
          <span class="badge" id="notifBadge" style="display:none">0</span>
        </button>
        <div class="dropdown drop-right" id="notifDropdown" aria-label="Bildirim listesi">
          <div class="muted" style="padding:6px 8px">Son bildirimler</div>
          <div id="notifList" class="list" style="max-height:300px;overflow:auto"></div>
        </div>
      </div>
      <div class="nav-item">
        <button class="iconbtn" id="btnProfile" title="Profil">
          <span class="avatar"></span> <span id="profName" class="muted">Profil</span>
        </button>
        <div class="dropdown drop-right" id="profDropdown" aria-label="Profil menÃ¼sÃ¼">
          <a href="../diger/kullanici-yonetimi.html">ğŸ‘¤ Profil</a>
          <a href="../diger/sistem-ayarlari.html">âš™ï¸ Sistem AyarlarÄ±</a>
          <a href="#" id="btnLogout">ğŸšª Ã‡Ä±kÄ±ÅŸ Yap</a>
        </div>
      </div>
    </div>
  </div>
  <aside class="drawer" id="drawer"></aside>
  <div class="toast-container" id="toastContainer"></div>

  <main class="container">
    <section class="hero">
      <div>
        <h2>GiriÅŸ KayÄ±tlarÄ± ve Log YÃ¶netimi</h2>
        <div class="hero-sub">Sistem kullanÄ±cÄ± giriÅŸleri, sayfa hareketleri ve iÅŸlem kayÄ±tlarÄ±nÄ± gÃ¶rÃ¼ntÃ¼leyin</div>
        <div class="mini">
          <span class="pill">ğŸ•’ Son GÃ¼ncelleme: <b id="lastUpdate">yÃ¼kleniyorâ€¦</b></span>
          <span class="pill">ğŸ“Š Toplam KayÄ±t: <b id="totalLogs">-</b></span>
        </div>
      </div>
    </section>

    <!-- STATS -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-card-label">GiriÅŸ KayÄ±tlarÄ±</div>
        <div class="stat-card-value" id="statGiris">0</div>
      </div>
      <div class="stat-card">
        <div class="stat-card-label">Sayfa Hareketleri</div>
        <div class="stat-card-value" id="statSayfa">0</div>
  </div>
      <div class="stat-card">
        <div class="stat-card-label">Ä°ÅŸlem KayÄ±tlarÄ±</div>
        <div class="stat-card-value" id="statIslem">0</div>
  </div>
      <div class="stat-card">
        <div class="stat-card-label">Aktif KullanÄ±cÄ±lar</div>
        <div class="stat-card-value" id="statAktif">0</div>
  </div>
</div>

    <!-- TABS -->
    <div class="card">
      <div class="tabs">
        <button class="tab active" data-tab="giris">ğŸŸ¢ GiriÅŸ LoglarÄ±</button>
        <button class="tab" data-tab="sayfa">ğŸŸ  Sayfa Hareketleri</button>
        <button class="tab" data-tab="islem">ğŸ”µ Ä°ÅŸlem KayÄ±tlarÄ±</button>
        <button class="tab" data-tab="rapor">ğŸ“Š Raporlar</button>
      </div>

      <!-- GÄ°RÄ°Å LOGLARI -->
      <div class="tab-content active" id="tab-giris">
        <div class="filters">
          <div class="filter-group">
            <label>Tarih AralÄ±ÄŸÄ±</label>
            <input type="date" id="filterGirisBaslangic">
          </div>
          <div class="filter-group">
            <label>BitiÅŸ</label>
            <input type="date" id="filterGirisBitis">
          </div>
          <div class="filter-group">
            <label>GÃ¶rÃ¼nÃ¼m</label>
            <select id="viewGiris">
              <option value="table">Tablo</option>
              <option value="card">Kart</option>
            </select>
          </div>
          <div class="filter-group">
            <label>&nbsp;</label>
            <button type="button" class="btn" onclick="loadGirisLoglari()" title="Listeyi yenile">ğŸ”„ Yenile</button>
          </div>
        </div>
        <div id="girisLoglari"></div>
      </div>

      <!-- SAYFA HAREKETLERÄ° -->
      <div class="tab-content" id="tab-sayfa">
        <div class="filters">
          <div class="filter-group">
            <label>Tarih AralÄ±ÄŸÄ±</label>
            <input type="date" id="filterSayfaBaslangic">
          </div>
          <div class="filter-group">
            <label>BitiÅŸ</label>
            <input type="date" id="filterSayfaBitis">
          </div>
          <div class="filter-group">
            <label>Sayfa</label>
            <select id="filterSayfaAdi">
              <option value="">TÃ¼mÃ¼</option>
            </select>
          </div>
          <div class="filter-group">
            <label>GÃ¶rÃ¼nÃ¼m</label>
            <select id="viewSayfa">
              <option value="table">Tablo</option>
              <option value="card">Kart</option>
            </select>
          </div>
          <div class="filter-group">
            <label>&nbsp;</label>
            <button type="button" class="btn" onclick="loadSayfaLoglari()" title="Listeyi yenile">ğŸ”„ Yenile</button>
          </div>
        </div>
        <div id="sayfaLoglari"></div>
      </div>

      <!-- Ä°ÅLEM KAYITLARI -->
      <div class="tab-content" id="tab-islem">
        <div class="filters">
          <div class="filter-group">
            <label>Tarih AralÄ±ÄŸÄ±</label>
            <input type="date" id="filterIslemBaslangic">
          </div>
          <div class="filter-group">
            <label>BitiÅŸ</label>
            <input type="date" id="filterIslemBitis">
          </div>
          <div class="filter-group">
            <label>Ä°ÅŸlem TÃ¼rÃ¼</label>
            <select id="filterIslemTuru">
              <option value="">TÃ¼mÃ¼</option>
            </select>
          </div>
          <div class="filter-group">
            <label>GÃ¶rÃ¼nÃ¼m</label>
            <select id="viewIslem">
              <option value="table">Tablo</option>
              <option value="card">Kart</option>
            </select>
          </div>
          <div class="filter-group">
            <label>&nbsp;</label>
            <button type="button" class="btn" onclick="loadIslemLoglari()" title="Listeyi yenile">ğŸ”„ Yenile</button>
          </div>
        </div>
        <div id="islemLoglari"></div>
      </div>

      <!-- RAPORLAR -->
      <div class="tab-content" id="tab-rapor">
        <div class="filters">
          <div class="filter-group">
            <label>Rapor TÃ¼rÃ¼</label>
            <select id="raporTuru">
              <option value="gunluk">GÃ¼nlÃ¼k Ã–zet</option>
              <option value="haftalik">HaftalÄ±k Ã–zet</option>
              <option value="aylik">AylÄ±k Ã–zet</option>
              <option value="kullanici">KullanÄ±cÄ± BazlÄ±</option>
            </select>
          </div>
          <div class="filter-group">
            <label>Tarih</label>
            <input type="date" id="raporTarih">
          </div>
          <div class="filter-group">
            <button class="btn" onclick="generateReport()" style="margin-top:20px">ğŸ“Š Rapor OluÅŸtur</button>
          </div>
        </div>
        <div id="raporIcerik"></div>
      </div>
    </div>
  </main>

<script>
    const getSupabase = () => window.supabase;
    const showMsg = (msg, type) => { if(typeof showToast==='function') showToast(type||'info','',msg); else console.log(msg); };
    
    function parseLogTime(log){
      const z = log.zaman || log.ts;
      if(!z) return new Date();
      if(typeof z === 'string') return new Date(z);
      if(z && typeof z.toDate === 'function') return z.toDate();
      return new Date(z);
    }
    
    function dateToISO(dateStr, endOfDay){
      if(!dateStr) return null;
      const d = endOfDay ? new Date(dateStr + 'T23:59:59.999') : new Date(dateStr + 'T00:00:00');
      return isNaN(d.getTime()) ? null : d.toISOString();
    }

    // Tab switching
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        const tabName = tab.dataset.tab;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(`tab-${tabName}`).classList.add('active');
        
        // Load data for active tab
        if(tabName === 'giris') loadGirisLoglari();
        else if(tabName === 'sayfa') loadSayfaLoglari();
        else if(tabName === 'islem') loadIslemLoglari();
        else if(tabName === 'rapor') loadRaporlar();
      });
    });

    // Auth + Nav (ortak.js fetchPanels/renderNav kullanÄ±r)
    (function init(){
      const auth = typeof window.getSupabaseAuth === 'function' ? window.getSupabaseAuth() : null;
      if(!auth || typeof auth.onAuthStateChanged !== 'function'){
        setTimeout(init, 150);
        return;
      }
      auth.onAuthStateChanged(async (user) => {
        if(!user){ location.replace('../index.html'); return; }
        const norm = (s) => String(s||'').trim().toLowerCase();
        try{
          const sb = getSupabase();
          if(!sb) return;
          const { data, error } = await sb.from('kullanicilar').select('yetkiler, adsoyad').eq('id', user.uid || user.id).single();
          const rawPerms = (!error && data && Array.isArray(data.yetkiler)) ? data.yetkiler : [];
          window.CURRENT_ALLOW = new Set(rawPerms.filter(s => !String(s).trim().startsWith('-') && !String(s).trim().startsWith('!')).map(norm));
          const profEl = document.getElementById('profName');
          if(profEl) profEl.textContent = 'ğŸ‘¤ ' + (data?.adsoyad || user.email?.split('@')[0] || 'Profil');
          window.CURRENT_DENY = new Set(rawPerms.filter(s => String(s).trim().startsWith('-') || String(s).trim().startsWith('!')).map(s => norm(String(s).replace(/^[-!]\s*/,''))));
          const panels = typeof window.fetchPanels === 'function' ? await window.fetchPanels(window.CURRENT_ALLOW, window.CURRENT_DENY) : [];
          if(typeof window.renderNav === 'function') window.renderNav(panels);
          if(typeof window.initPage === 'function') await window.initPage();
        }catch(e){
          console.error('Init error:', e);
          showMsg('âŒ Veriler yÃ¼klenirken hata: ' + (e.message || 'Bilinmeyen hata'), 'error');
        }
      });
    })();

    // Load functions
    async function loadGirisLoglari(){
      const container = document.getElementById('girisLoglari');
      container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--muted)">YÃ¼kleniyor...</div>';
      
      try{
        const sb = getSupabase();
        if(!sb) { container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--bad)">Supabase baÄŸlantÄ±sÄ± yok.</div>'; return; }
        
        const baslangic = document.getElementById('filterGirisBaslangic').value;
        const bitis = document.getElementById('filterGirisBitis').value;
        
        let query = sb.from('kullanici_log').select('*');
        const startISO = dateToISO(baslangic, false), endISO = dateToISO(bitis, true);
        if(baslangic && bitis && startISO && endISO){
          query = query.gte('zaman', startISO).lte('zaman', endISO);
        } else if(baslangic && startISO){
          query = query.gte('zaman', startISO);
        } else if(bitis && endISO){
          query = query.lte('zaman', endISO);
        }
        const { data: rows, error } = await query.order('zaman', { ascending: false }).limit(200);
        
        if(error) throw error;
        
        const view = document.getElementById('viewGiris').value;
        const girisLogs = (rows || []).filter(d => 
          d.durum === 'acilis' || (d.mesaj && d.mesaj.includes('aÃ§Ä±ldÄ±')) || (!d.page && !d.event)
        );
        
        if(girisLogs.length === 0){
          container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--muted)">KayÄ±t bulunamadÄ±</div>';
          document.getElementById('statGiris').textContent = '0';
          return;
        }
        
        if(view === 'table'){
          renderGirisTable(girisLogs, container);
        } else {
          renderGirisCards(girisLogs, container);
        }
        
        document.getElementById('statGiris').textContent = girisLogs.length;
      }catch(e){
        console.error('GiriÅŸ loglarÄ± hatasÄ±:', e);
        container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--bad)">Hata: ' + (e.message || e) + '</div>';
      }
    }

    function renderGirisTable(logs, container){
      let html = `
        <div class="log-table-wrapper">
          <table class="log-table">
            <thead>
              <tr>
                <th>UID</th>
                <th>Email</th>
                <th>Zaman</th>
                <th>Durum/Mesaj</th>
                <th>TarayÄ±cÄ±</th>
              </tr>
            </thead>
            <tbody>
      `;
      logs.forEach(log => {
        const ts = parseLogTime(log);
        const ua = log.ua || log.user_agent || log.userAgent || '-';
        html += `
          <tr>
            <td><code style="font-size:11px">${log.uid || '-'}</code></td>
            <td>${log.email || '-'}</td>
            <td>${ts.toLocaleString('tr-TR')}</td>
            <td>${log.durum ? log.durum + ' ' : ''}${log.mesaj || log.title || '-'}</td>
            <td style="max-width:300px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap" title="${ua}">${ua.substring(0, 60)}${ua.length > 60 ? '...' : ''}</td>
          </tr>
        `;
      });
      html += '</tbody></table></div>';
      container.innerHTML = html;
    }

    function renderGirisCards(logs, container){
      let html = '<div class="log-grid">';
      logs.forEach(log => {
        const ts = parseLogTime(log);
        const ua = log.ua || log.user_agent || log.userAgent || '-';
        html += `
          <div class="log-card">
            <div class="log-card-header">
              <div class="log-card-title">GiriÅŸ KaydÄ± ${log.durum ? log.durum : ''}</div>
              <div class="log-card-time">${ts.toLocaleString('tr-TR')}</div>
            </div>
            <div class="log-card-body">
              <div class="log-card-item">
                <span class="log-card-label">UID:</span>
                <span class="log-card-value"><code>${log.uid || '-'}</code></span>
              </div>
              <div class="log-card-item">
                <span class="log-card-label">Email:</span>
                <span class="log-card-value">${log.email || '-'}</span>
              </div>
              <div class="log-card-item">
                <span class="log-card-label">Mesaj:</span>
                <span class="log-card-value">${log.mesaj || log.title || '-'}</span>
              </div>
              <div class="log-card-item">
                <span class="log-card-label">TarayÄ±cÄ±:</span>
                <span class="log-card-value" style="font-size:11px">${ua.substring(0, 80)}${ua.length > 80 ? '...' : ''}</span>
              </div>
            </div>
        </div>
      `;
    });
      html += '</div>';
      container.innerHTML = html;
    }

    async function loadSayfaLoglari(){
      const container = document.getElementById('sayfaLoglari');
      container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--muted)">YÃ¼kleniyor...</div>';
      
      try{
        const sb = getSupabase();
        if(!sb) { container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--bad)">Supabase baÄŸlantÄ±sÄ± yok.</div>'; return; }
        
        const baslangic = document.getElementById('filterSayfaBaslangic').value;
        const bitis = document.getElementById('filterSayfaBitis').value;
        const sayfaAdi = document.getElementById('filterSayfaAdi').value;
        
        let query = sb.from('kullanici_log').select('*');
        const startISO = dateToISO(baslangic, false), endISO = dateToISO(bitis, true);
        if(baslangic && bitis && startISO && endISO){
          query = query.gte('zaman', startISO).lte('zaman', endISO);
        } else if(baslangic && startISO){
          query = query.gte('zaman', startISO);
        } else if(bitis && endISO){
          query = query.lte('zaman', endISO);
        }
        const { data: rows, error } = await query.order('zaman', { ascending: false }).limit(200);
        
        if(error) throw error;
        
        const view = document.getElementById('viewSayfa').value;
        const sayfaLogs = (rows || []).filter(d => {
          const isSayfaHareketi = d.page || d.event || (d.durum && d.durum !== 'acilis');
          if(!isSayfaHareketi) return false;
          if(!sayfaAdi || d.page === sayfaAdi || d.sayfa === sayfaAdi) return true;
          return false;
        });
        
        if(sayfaLogs.length === 0){
          container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--muted)">KayÄ±t bulunamadÄ±</div>';
          document.getElementById('statSayfa').textContent = '0';
          return;
        }
        
        if(view === 'table'){
          renderSayfaTable(sayfaLogs, container);
        } else {
          renderSayfaCards(sayfaLogs, container);
        }
        
        document.getElementById('statSayfa').textContent = sayfaLogs.length;
      }catch(e){
        console.error('Sayfa loglarÄ± hatasÄ±:', e);
        container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--bad)">Hata: ' + (e.message || e) + '</div>';
      }
    }

    function renderSayfaTable(logs, container){
      let html = `
        <div class="log-table-wrapper">
          <table class="log-table">
            <thead>
              <tr>
                <th>Sayfa/Event</th>
                <th>UID</th>
                <th>Email</th>
                <th>Zaman</th>
                <th>Detay</th>
              </tr>
            </thead>
            <tbody>
      `;
      logs.forEach(log => {
        const ts = parseLogTime(log);
        const sayfa = log.page || log.sayfa || log.extra?.sayfa || '-';
        const event = log.event || '-';
        html += `
          <tr>
            <td>${sayfa !== '-' ? sayfa : ''} ${event !== '-' ? event : ''}</td>
            <td><code style="font-size:11px">${log.uid || '-'}</code></td>
            <td>${log.email || '-'}</td>
            <td>${ts.toLocaleString('tr-TR')}</td>
            <td>${log.title || log.mesaj || log.detay || '-'}</td>
          </tr>
        `;
      });
      html += '</tbody></table></div>';
      container.innerHTML = html;
    }

    function renderSayfaCards(logs, container){
      let html = '<div class="log-grid">';
      logs.forEach(log => {
        const ts = parseLogTime(log);
        const sayfa = log.page || log.sayfa || log.extra?.sayfa || '-';
        const event = log.event || '-';
        html += `
          <div class="log-card">
            <div class="log-card-header">
              <div class="log-card-title">
                ${sayfa !== '-' ? sayfa : ''}
                ${event !== '-' ? event : ''}
              </div>
              <div class="log-card-time">${ts.toLocaleString('tr-TR')}</div>
            </div>
            <div class="log-card-body">
              <div class="log-card-item">
                <span class="log-card-label">UID:</span>
                <span class="log-card-value"><code>${log.uid || '-'}</code></span>
              </div>
              <div class="log-card-item">
                <span class="log-card-label">Email:</span>
                <span class="log-card-value">${log.email || '-'}</span>
              </div>
              <div class="log-card-item">
                <span class="log-card-label">Detay:</span>
                <span class="log-card-value">${log.title || log.mesaj || log.detay || '-'}</span>
              </div>
            </div>
        </div>
      `;
    });
      html += '</div>';
      container.innerHTML = html;
    }

    async function loadIslemLoglari(){
      const container = document.getElementById('islemLoglari');
      container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--muted)">YÃ¼kleniyor...</div>';
      
      try{
        const sb = getSupabase();
        if(!sb) { container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--bad)">Supabase baÄŸlantÄ±sÄ± yok.</div>'; return; }
        
        const baslangic = document.getElementById('filterIslemBaslangic').value;
        const bitis = document.getElementById('filterIslemBitis').value;
        const islemTuru = document.getElementById('filterIslemTuru').value;
        
        let query = sb.from('islem_log').select('*');
        const startISO = dateToISO(baslangic, false), endISO = dateToISO(bitis, true);
        if(baslangic && bitis && startISO && endISO){
          query = query.gte('zaman', startISO).lte('zaman', endISO);
        } else if(baslangic && startISO){
          query = query.gte('zaman', startISO);
        } else if(bitis && endISO){
          query = query.lte('zaman', endISO);
        }
        const { data: rows, error } = await query.order('zaman', { ascending: false }).limit(200);
        
        if(error) throw error;
        
        const view = document.getElementById('viewIslem').value;
        const islemLogs = (rows || []).filter(d => {
          if(!islemTuru) return true;
          return (d.islem === islemTuru) || (d.sayfa === islemTuru);
        });
        
        if(islemLogs.length === 0){
          container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--muted)">KayÄ±t bulunamadÄ±</div>';
          document.getElementById('statIslem').textContent = '0';
          return;
        }
        
        if(view === 'table'){
          renderIslemTable(islemLogs, container);
        } else {
          renderIslemCards(islemLogs, container);
        }
        
        document.getElementById('statIslem').textContent = islemLogs.length;
      }catch(e){
        console.error('Ä°ÅŸlem loglarÄ± hatasÄ±:', e);
        container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--bad)">Hata: ' + (e.message || e) + '</div>';
      }
    }

    function renderIslemTable(logs, container){
      let html = `
        <div class="log-table-wrapper">
          <table class="log-table">
            <thead>
              <tr>
                <th>Ä°ÅŸlem</th>
                <th>Sayfa</th>
                <th>Path</th>
                <th>Yapan UID</th>
                <th>Zaman</th>
                <th>TarayÄ±cÄ±</th>
              </tr>
            </thead>
            <tbody>
      `;
      logs.forEach(log => {
        const ts = parseLogTime(log);
        const ua = (log.user_agent || log.userAgent || '-');
        html += `
          <tr>
            <td>${log.islem || '-'}</td>
            <td>${log.sayfa || '-'}</td>
            <td><code style="font-size:11px">${log.path || '-'}</code></td>
            <td><code style="font-size:11px">${log.uid || '-'}</code></td>
            <td>${ts.toLocaleString('tr-TR')}</td>
            <td style="font-size:11px; max-width:180px; overflow:hidden; text-overflow:ellipsis;" title="${(ua || '').replace(/"/g, '&quot;')}">${ua.length > 40 ? ua.substring(0, 40) + 'â€¦' : ua}</td>
          </tr>
        `;
      });
      html += '</tbody></table></div>';
      container.innerHTML = html;
    }

    function renderIslemCards(logs, container){
      let html = '<div class="log-grid">';
      logs.forEach(log => {
        const ts = parseLogTime(log);
        const ua = (log.user_agent || log.userAgent || '-');
        html += `
          <div class="log-card">
            <div class="log-card-header">
              <div class="log-card-title">${log.islem || '-'}</div>
              <div class="log-card-time">${ts.toLocaleString('tr-TR')}</div>
            </div>
            <div class="log-card-body">
              <div class="log-card-item">
                <span class="log-card-label">Sayfa:</span>
                <span class="log-card-value">${log.sayfa || '-'}</span>
              </div>
              <div class="log-card-item">
                <span class="log-card-label">Path:</span>
                <span class="log-card-value"><code style="font-size:11px">${log.path || '-'}</code></span>
              </div>
              <div class="log-card-item">
                <span class="log-card-label">Yapan UID:</span>
                <span class="log-card-value"><code>${log.uid || '-'}</code></span>
              </div>
              ${ua !== '-' ? `
              <div class="log-card-item">
                <span class="log-card-label">TarayÄ±cÄ±:</span>
                <span class="log-card-value" style="font-size:11px">${ua.length > 80 ? ua.substring(0, 80) + 'â€¦' : ua}</span>
              </div>
              ` : ''}
            </div>
          </div>
        `;
      });
      html += '</div>';
      container.innerHTML = html;
    }

    async function loadRaporlar(){
      const container = document.getElementById('raporIcerik');
      container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--muted)">Rapor oluÅŸturmak iÃ§in filtreleri seÃ§in ve "Rapor OluÅŸtur" butonuna tÄ±klayÄ±n</div>';
    }

    async function generateReport(){
      const turu = document.getElementById('raporTuru').value;
      const tarih = document.getElementById('raporTarih').value;
      const container = document.getElementById('raporIcerik');
      container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--muted)">Rapor oluÅŸturuluyor...</div>';
      
      try{
        const selectedDate = tarih ? new Date(tarih) : new Date();
        let startDate, endDate, title;
        
        if(turu === 'gunluk'){
          startDate = new Date(selectedDate);
          startDate.setHours(0,0,0,0);
          endDate = new Date(selectedDate);
          endDate.setHours(23,59,59,999);
          title = `GÃ¼nlÃ¼k Ã–zet - ${selectedDate.toLocaleDateString('tr-TR')}`;
        } else if(turu === 'haftalik'){
          const day = selectedDate.getDay();
          const diff = selectedDate.getDate() - day + (day === 0 ? -6 : 1);
          startDate = new Date(selectedDate.setDate(diff));
          startDate.setHours(0,0,0,0);
          endDate = new Date(startDate);
          endDate.setDate(endDate.getDate() + 6);
          endDate.setHours(23,59,59,999);
          title = `HaftalÄ±k Ã–zet - ${startDate.toLocaleDateString('tr-TR')} / ${endDate.toLocaleDateString('tr-TR')}`;
        } else if(turu === 'aylik'){
          startDate = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1);
          endDate = new Date(selectedDate.getFullYear(), selectedDate.getMonth() + 1, 0, 23, 59, 59, 999);
          title = `AylÄ±k Ã–zet - ${selectedDate.toLocaleDateString('tr-TR', {month:'long', year:'numeric'})}`;
        } else {
          title = 'KullanÄ±cÄ± BazlÄ± Ã–zet';
        }
        
        const startISO = startDate.toISOString();
        const endISO = endDate.toISOString();
        
        let html = `<div class="card"><h3>${title}</h3>`;
        
        const sb = getSupabase();
        if(!sb) { container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--bad)">Supabase baÄŸlantÄ±sÄ± yok.</div>'; return; }
        
        if(turu === 'kullanici'){
          const [{ data: kullaniciRows }, { data: islemRows }] = await Promise.all([
            sb.from("kullanici_log").select('*').order('zaman', { ascending: false }).limit(2000),
            sb.from("islem_log").select('*').order('zaman', { ascending: false }).limit(2000)
          ]);
          
          const userStats = {};
          
          (kullaniciRows || []).forEach(d => {
            const uid = d.uid;
            if(!uid) return;
            if(!userStats[uid]) userStats[uid] = {giris:0, sayfa:0, islem:0, email: d.email || '-'};
            if(d.durum === 'acilis' || (d.mesaj && d.mesaj.includes('aÃ§Ä±ldÄ±')) || (!d.page && !d.event)){
              userStats[uid].giris++;
            } else {
              userStats[uid].sayfa++;
            }
          });
          
          (islemRows || []).forEach(d => {
            const uid = d.uid;
            if(!uid) return;
            if(!userStats[uid]) userStats[uid] = {giris:0, sayfa:0, islem:0, email: d.email || '-'};
            userStats[uid].islem++;
          });
          
          html += '<table class="log-table"><thead><tr><th>KullanÄ±cÄ± UID</th><th>Email</th><th>GiriÅŸ</th><th>Sayfa</th><th>Ä°ÅŸlem</th><th>Toplam</th></tr></thead><tbody>';
          Object.entries(userStats).sort((a,b) => (b[1].giris + b[1].sayfa + b[1].islem) - (a[1].giris + a[1].sayfa + a[1].islem)).forEach(([uid, stats]) => {
            const total = stats.giris + stats.sayfa + stats.islem;
            html += `<tr><td><code>${uid}</code></td><td>${stats.email}</td><td>${stats.giris}</td><td>${stats.sayfa}</td><td>${stats.islem}</td><td><strong>${total}</strong></td></tr>`;
          });
          html += '</tbody></table>';
        } else {
          const [{ data: kullaniciRows }, { data: islemRows }] = await Promise.all([
            sb.from("kullanici_log").select('*').gte('zaman', startISO).lte('zaman', endISO).order('zaman', { ascending: false }).limit(1000),
            sb.from("islem_log").select('*').gte('zaman', startISO).lte('zaman', endISO).order('zaman', { ascending: false }).limit(1000)
          ]);
          
          let girisCount = 0, sayfaCount = 0;
          (kullaniciRows || []).forEach(d => {
            const docTs = parseLogTime(d);
            if(docTs < startDate || docTs > endDate) return;
            if(d.durum === 'acilis' || (d.mesaj && d.mesaj.includes('aÃ§Ä±ldÄ±')) || (!d.page && !d.event)){
              girisCount++;
            } else {
              sayfaCount++;
            }
          });
          
          let islemCount = 0;
          (islemRows || []).forEach(d => {
            const docTs = parseLogTime(d);
            if(docTs < startDate || docTs > endDate) return;
            islemCount++;
          });
          
          html += `
            <div class="stats-grid" style="margin-bottom:20px">
              <div class="stat-card">
                <div class="stat-card-label">GiriÅŸ KayÄ±tlarÄ±</div>
                <div class="stat-card-value">${girisCount}</div>
              </div>
              <div class="stat-card">
                <div class="stat-card-label">Sayfa Hareketleri</div>
                <div class="stat-card-value">${sayfaCount}</div>
              </div>
              <div class="stat-card">
                <div class="stat-card-label">Ä°ÅŸlem KayÄ±tlarÄ±</div>
                <div class="stat-card-value">${islemCount}</div>
              </div>
              <div class="stat-card">
                <div class="stat-card-label">Toplam</div>
                <div class="stat-card-value">${girisCount + sayfaCount + islemCount}</div>
              </div>
            </div>
          `;
          
          const sayfaCounts = {};
          (kullaniciRows || []).forEach(d => {
            const docTs = parseLogTime(d);
            if(docTs < startDate || docTs > endDate) return;
            const sayfa = d.page || d.sayfa || d.extra?.sayfa;
            if(sayfa && d.durum !== 'acilis'){
              sayfaCounts[sayfa] = (sayfaCounts[sayfa] || 0) + 1;
            }
          });
          
          if(Object.keys(sayfaCounts).length > 0){
            html += '<h4 style="margin-top:20px">En Ã‡ok Ziyaret Edilen Sayfalar</h4><table class="log-table"><thead><tr><th>Sayfa</th><th>Ziyaret</th></tr></thead><tbody>';
            Object.entries(sayfaCounts).sort((a,b) => b[1] - a[1]).slice(0, 10).forEach(([sayfa, count]) => {
              html += `<tr><td>${sayfa}</td><td>${count}</td></tr>`;
            });
            html += '</tbody></table>';
          }
        }
        
        html += '</div>';
        container.innerHTML = html;
        showMsg('âœ… Rapor oluÅŸturuldu', 'success');
      }catch(e){
        console.error('Rapor hatasÄ±:', e);
        container.innerHTML = '<div style="text-align:center; padding:40px; color:var(--bad)">Hata: ' + e.message + '</div>';
        showMsg('âŒ Rapor oluÅŸturulamadÄ±', 'error');
      }
    }

    // Filter change listeners
    document.getElementById('filterGirisBaslangic')?.addEventListener('change', loadGirisLoglari);
    document.getElementById('filterGirisBitis')?.addEventListener('change', loadGirisLoglari);
    document.getElementById('viewGiris')?.addEventListener('change', loadGirisLoglari);
    document.getElementById('filterSayfaBaslangic')?.addEventListener('change', loadSayfaLoglari);
    document.getElementById('filterSayfaBitis')?.addEventListener('change', loadSayfaLoglari);
    document.getElementById('filterSayfaAdi')?.addEventListener('change', loadSayfaLoglari);
    document.getElementById('viewSayfa')?.addEventListener('change', loadSayfaLoglari);
    document.getElementById('filterIslemBaslangic')?.addEventListener('change', loadIslemLoglari);
    document.getElementById('filterIslemBitis')?.addEventListener('change', loadIslemLoglari);
    document.getElementById('filterIslemTuru')?.addEventListener('change', loadIslemLoglari);
    document.getElementById('viewIslem')?.addEventListener('change', loadIslemLoglari);

    // Sayfa Ã¶zel init - ortak.js auth sonrasÄ± Ã§aÄŸÄ±rÄ±r
    window.initPage = async function(){
      try{
        const sb = getSupabase();
        if(!sb) return;
        const today = new Date();
        const lastWeek = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
        document.getElementById('filterGirisBaslangic').value = lastWeek.toISOString().split('T')[0];
        document.getElementById('filterGirisBitis').value = today.toISOString().split('T')[0];
        document.getElementById('filterSayfaBaslangic').value = lastWeek.toISOString().split('T')[0];
        document.getElementById('filterSayfaBitis').value = today.toISOString().split('T')[0];
        document.getElementById('filterIslemBaslangic').value = lastWeek.toISOString().split('T')[0];
        document.getElementById('filterIslemBitis').value = today.toISOString().split('T')[0];
        document.getElementById('raporTarih').value = today.toISOString().split('T')[0];
        
        try{
          if(sb){
            const { data: sayfaRows } = await sb.from("kullanici_log").select('*').order('zaman', { ascending: false }).limit(500);
            const uniquePages = new Set();
            (sayfaRows || []).forEach(d => {
              const sayfa = d.page || d.sayfa || d.extra?.sayfa;
              if(sayfa) uniquePages.add(sayfa);
            });
            const sayfaSelect = document.getElementById('filterSayfaAdi');
            if(sayfaSelect) Array.from(uniquePages).sort().forEach(sayfa => {
              const opt = document.createElement('option');
              opt.value = sayfa;
              opt.textContent = sayfa;
              sayfaSelect.appendChild(opt);
            });
          }
        }catch(e){
          console.warn('Sayfa filtreleri yÃ¼klenemedi:', e);
        }
        
        try{
          if(sb){
            const { data: islemRows } = await sb.from("islem_log").select('*').order('zaman', { ascending: false }).limit(500);
            const uniqueIslemler = new Set();
            (islemRows || []).forEach(d => {
              if(d.islem) uniqueIslemler.add(d.islem);
              if(d.sayfa) uniqueIslemler.add(d.sayfa);
            });
            const islemSelect = document.getElementById('filterIslemTuru');
            if(islemSelect) Array.from(uniqueIslemler).sort().forEach(val => {
              const opt = document.createElement('option');
              opt.value = val;
              opt.textContent = val;
              islemSelect.appendChild(opt);
            });
          }
        }catch(e){
          console.warn('Ä°ÅŸlem filtreleri yÃ¼klenemedi:', e);
        }
        
        loadGirisLoglari();
        document.getElementById('lastUpdate').textContent = new Date().toLocaleString('tr-TR');
        
        try{
          const [{ data: kullaniciRows }, { data: islemRows }] = await Promise.all([
            sb.from("kullanici_log").select('*').order('zaman', { ascending: false }).limit(1000),
            sb.from("islem_log").select('*').order('zaman', { ascending: false }).limit(1000)
          ]);
          let girisCount = 0, sayfaCount = 0;
          (kullaniciRows || []).forEach(d => {
            if(d.durum === 'acilis' || (d.mesaj && d.mesaj.includes('aÃ§Ä±ldÄ±')) || (!d.page && !d.event)){
              girisCount++;
            } else {
              sayfaCount++;
            }
          });
          const islemCount = (islemRows || []).length;
          document.getElementById('statGiris').textContent = girisCount >= 1000 ? '1000+' : girisCount;
          document.getElementById('statSayfa').textContent = sayfaCount >= 1000 ? '1000+' : sayfaCount;
          document.getElementById('statIslem').textContent = islemCount >= 1000 ? '1000+' : islemCount;
          const uniqueUsers = new Set((kullaniciRows || []).map(d => d.uid).filter(Boolean));
          document.getElementById('statAktif').textContent = uniqueUsers.size;
          document.getElementById('totalLogs').textContent = girisCount + sayfaCount + islemCount;
        }catch(e){
          console.error('Stats error:', e);
        }
      }catch(e){
        console.error('Init error:', e);
        showMsg('âŒ Veriler yÃ¼klenirken hata: ' + (e.message || 'Bilinmeyen hata'), 'error');
      }
    };
</script>
</body>
</html>
