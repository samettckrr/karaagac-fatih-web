<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Bildirim ve GÃ¶rev</title>
  <link rel="icon" type="image/png" href="../img/logo.png" />
  <link rel="stylesheet" href="../css/app-shell.css" />
  <style>
    :root{
      --appbar-h:56px;
      --radius:14px;
      --shadow:0 12px 28px rgba(0,0,0,.14);
      --bg:#f5f5f0;
      --bg2:#fafaf5;
      --grad1:#e5e5e022;
      --grad2:#d4d4d022;
      --card:rgba(255,255,255,.95);
      --stroke:rgba(15,23,42,.12);
      --text:#0b1220;
      --muted:#4b5563;
      --brand:#0ea5e9;
      --brand2:#0284c7;
      --pill:#f5f5f0;
      --pill-hover:#e9e9e4;
      --link:#0b5ea8;
      --surface:#f0f0eb;
      --ok:#33c27f;
      --danger:#ff4255;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      padding:0;
      padding-top:var(--appbar-h) !important;
      color:var(--text);
      font-family:ui-sans-serif,-apple-system,"Segoe UI",Roboto,Arial;
      background:
        radial-gradient(900px 680px at 12% 8%, var(--grad1), transparent 45%),
        radial-gradient(800px 640px at 88% 92%, var(--grad2), transparent 50%),
        linear-gradient(140deg, var(--bg), var(--bg2) 60%);
      overflow-x:hidden;
    }

    .appbar{
      position:fixed !important;
      top:0 !important;
      left:0 !important;
      right:0 !important;
      z-index:60 !important;
    }

    .container{
      max-width:1200px;
      width:100%;
      margin:0 auto;
      padding:20px;
    }

    .kartlar {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 24px;
    }

    .kart {
      background: var(--card);
      padding: 20px;
      border-radius: var(--radius);
      border: 1px solid var(--stroke);
      box-shadow: var(--shadow);
      transition: all 0.3s ease;
    }

    .kart:hover {
      box-shadow: 0 8px 24px rgba(0,0,0,.15);
      transform: translateY(-2px);
    }

    .kart h3 {
      margin: 0 0 10px 0;
      font-size: 18px;
      font-weight: 700;
      color: var(--text);
    }

    .kart p {
      font-size: 14px;
      color: var(--muted);
      margin: 0 0 12px 0;
      line-height: 1.5;
    }

    .kart button {
      margin-top: 10px;
      padding: 10px 16px;
      border: none;
      border-radius: 12px;
      background: linear-gradient(180deg, var(--brand), var(--brand2));
      color: white;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.2s ease;
    }

    .kart button:hover {
      box-shadow: 0 4px 12px rgba(14,165,233,.3);
      transform: translateY(-1px);
    }

    .bildirim-item {
      background: var(--card);
      padding: 16px;
      margin-top: 12px;
      border-radius: 12px;
      border: 1px solid var(--stroke);
      box-shadow: 0 2px 8px rgba(0,0,0,.08);
      transition: all 0.2s ease;
    }

    .bildirim-item:hover {
      background: var(--surface);
      box-shadow: 0 4px 12px rgba(0,0,0,.12);
    }

    .bildirim-item b {
      display: block;
      font-size: 15px;
      font-weight: 700;
      color: var(--text);
      margin-bottom: 8px;
    }

    .bildirim-item span {
      display: block;
      font-size: 14px;
      color: var(--muted);
      margin-bottom: 8px;
      line-height: 1.5;
    }

    .bildirim-item small {
      display: block;
      font-size: 12px;
      color: var(--muted);
      margin-top: 8px;
    }

    .bildirim-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--stroke);
      flex-wrap: wrap;
    }

    .bildirim-actions button {
      padding: 6px 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.2s ease;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-edit {
      background: var(--brand);
      color: white;
    }

    .btn-edit:hover {
      background: var(--brand2);
      box-shadow: 0 2px 8px rgba(14,165,233,.3);
    }

    .btn-resend {
      background: var(--ok);
      color: white;
    }

    .btn-resend:hover {
      background: #2ab06d;
      box-shadow: 0 2px 8px rgba(51,194,127,.3);
    }

    .btn-delete {
      background: var(--danger);
      color: white;
    }

    .btn-delete:hover {
      background: #e6394a;
      box-shadow: 0 2px 8px rgba(255,66,85,.3);
    }

    /* KullanÄ±cÄ± arama sonuÃ§larÄ± */
    #kullaniciSonuclari {
      position: absolute;
      z-index: 1000;
      margin-top: 4px;
      box-shadow: var(--shadow-lg);
    }

    #kullaniciSonuclari > div:last-child {
      border-bottom: none;
    }

    #kullaniciSonuclari > div:hover {
      background: var(--surface) !important;
    }

    /* Modal - app-shell.css'den geliyor, burada sadece Ã¶zel stiller gerekirse eklenir */

    @media (max-width: 640px) {
      .container {
        padding: 12px;
      }
      .kartlar {
        grid-template-columns: 1fr;
        gap: 16px;
      }
      .kart {
        padding: 16px;
      }
    }
  </style>
</head>
<body>

<!-- ====== APPBAR ====== -->
<div class="appbar">
  <div class="brand" onclick="location.href='../panel.html'">
    <img src="../img/logo.png" alt="logo"><span>KARAAÄAÃ‡ FATÄ°H</span>
  </div>
  <nav class="nav-center"><ul class="nav-list" id="navMain"></ul></nav>
  <div class="nav-right">
    <button class="btn hamb" id="hamburger" title="MenÃ¼">â˜°</button>
    
    <!-- Bildirim -->
    <div class="nav-item">
      <button class="iconbtn" id="btnNotif" title="Bildirimler">ğŸ””
        <span class="badge" id="notifBadge" style="display:none">0</span>
      </button>
      <div class="dropdown drop-right" id="notifDropdown" aria-label="Bildirim listesi">
        <div class="muted" style="padding:6px 8px">Son bildirimler</div>
        <div id="notifList" style="max-height:300px;overflow:auto"></div>
      </div>
    </div>

    <!-- Profil -->
    <div class="nav-item">
      <button class="iconbtn" id="btnProfile" title="Profil">
        <span id="profName" class="muted">Profil</span>
      </button>
      <div class="dropdown drop-right" id="profDropdown" aria-label="Profil menÃ¼sÃ¼">
        <a href="../diger/kullanici-yonetimi.html">ğŸ‘¤ Profil</a>
        <a href="../diger/sistem-ayarlari.html">âš™ï¸ Sistem AyarlarÄ±</a>
        <a href="#" id="btnLogout">ğŸšª Ã‡Ä±kÄ±ÅŸ Yap</a>
      </div>
    </div>
  </div>
</div>
<aside class="drawer" id="drawer"></aside>

<!-- Toast Container (ortak sistem) -->
<div class="toast-container" id="toastContainer"></div>

<div class="container">
  <div class="kartlar">
    <div class="kart">
      <h3>ğŸ“¤ Toplu Bildirim GÃ¶nder</h3>
      <p>Belirli role veya tÃ¼m kullanÄ±cÄ±lara bildirim gÃ¶nder.</p>
      <button onclick="modalAc('toplu')">GÃ¶nder</button>
    </div>
    <div class="kart">
      <h3>âœ‰ï¸ KiÅŸisel Bildirim / GÃ¶rev</h3>
      <p>Bir kullanÄ±cÄ±ya Ã¶zel mesaj veya gÃ¶rev tanÄ±mlayÄ±n.</p>
      <button onclick="modalAc('kisisel')">GÃ¶nder</button>
    </div>
    <div class="kart">
      <h3>ğŸ“ƒ Bildirim Takibi</h3>
      <p>Sisteme gÃ¶nderilen tÃ¼m bildirimleri inceleyin.</p>
      <button onclick="bildirimleriListele()">Listele</button>
    </div>
  </div>

  <div id="bildirimListesi"></div>
</div>

<!-- Modal -->
<div class="modal" id="bildirimModal">
  <div class="sheet">
    <header>
      <h3 id="modalBaslik">Bildirim GÃ¶nder</h3>
    </header>
    <div class="body">
      <form id="bildirimForm">
        <div class="field">
          <label>BaÅŸlÄ±k</label>
          <input type="text" id="baslik" placeholder="Bildirim baÅŸlÄ±ÄŸÄ±" required>
        </div>
        <div class="field">
          <label>Mesaj Ä°Ã§eriÄŸi</label>
          <textarea id="icerik" placeholder="Mesaj iÃ§eriÄŸi" rows="4" required></textarea>
        </div>

        <div id="kimeToplu" class="field">
          <label>Hedef Rol</label>
          <select id="hedefRol">
            <option value="">Rol SeÃ§in</option>
            <option value="admin">Admin</option>
            <option value="personel">Personel</option>
            <option value="tum">TÃ¼m KullanÄ±cÄ±lar</option>
          </select>
        </div>

        <div id="kimeKisisel" class="field" style="display:none; position: relative;">
          <label>KullanÄ±cÄ± SeÃ§</label>
          <input type="text" id="kullaniciAra" placeholder="KullanÄ±cÄ± adÄ± veya e-posta ile ara..." autocomplete="off">
          <div id="kullaniciSonuclari" style="display:none; margin-top: 4px; border: 1px solid var(--stroke); border-radius: 12px; background: var(--card); max-height: 200px; overflow-y: auto; position: absolute; top: 100%; left: 0; right: 0; z-index: 1000; box-shadow: var(--shadow-lg);"></div>
          <input type="hidden" id="hedefUID">
          <div id="seciliKullanici" style="margin-top: 8px; padding: 10px; background: var(--surface); border-radius: 8px; display: none; border: 1px solid var(--stroke);">
            <span id="seciliKullaniciAd" style="font-weight: 600; color: var(--text);"></span>
            <button type="button" onclick="seciliKullaniciyiTemizle()" style="margin-left: 8px; padding: 4px 10px; background: var(--danger); color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; float: right;">âœ• KaldÄ±r</button>
          </div>
        </div>
      </form>
    </div>
    <footer>
      <button type="button" class="btn btn-ghost" onclick="window.modalKapat()">Kapat</button>
      <button type="button" class="btn btn-primary" id="modalSubmitBtn" onclick="window.bildirimGonder()">GÃ¶nder</button>
    </footer>
  </div>
</div>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="../js/firebase/firebase-init.js"></script>
<!-- ORTAK APP SHELL JS -->
<script src="../js/ortak.js"></script>

<script>
  // Global deÄŸiÅŸkenler - ortak.js'den gelen db ve auth'u kullan (zaten tanÄ±mlÄ±, sadece referans al)
  // db ve auth ortak.js'de zaten tanÄ±mlÄ±, burada sadece kullanÄ±yoruz
  const getDb = () => window.db || (typeof firebase !== 'undefined' ? firebase.firestore() : null);
  const getAuth = () => window.auth || (typeof firebase !== 'undefined' ? firebase.auth() : null);

  const modal = document.getElementById("bildirimModal");
  const hedefRolDiv = document.getElementById("kimeToplu");
  const hedefUIDDiv = document.getElementById("kimeKisisel");
  window.aktifTip = "toplu"; // Global scope'ta tut
  window.duzenlenenBildirimId = null; // DÃ¼zenleme modunda hangi bildirim dÃ¼zenleniyor

  // Global fonksiyonlar - window'a ekle
  window.modalAc = function(tip, bildirimId = null) {
    window.aktifTip = tip;
    window.duzenlenenBildirimId = bildirimId;
    const modalBaslik = document.getElementById("modalBaslik");
    const submitBtn = document.getElementById("modalSubmitBtn");
    if (modalBaslik) {
      if (bildirimId) {
        modalBaslik.textContent = tip === "toplu" ? "Toplu Bildirim DÃ¼zenle" : "KiÅŸisel Bildirim DÃ¼zenle";
      } else {
        modalBaslik.textContent = tip === "toplu" ? "Toplu Bildirim GÃ¶nder" : "KiÅŸisel Bildirim GÃ¶nder";
      }
    }
    if (submitBtn) {
      submitBtn.textContent = bildirimId ? "GÃ¼ncelle" : "GÃ¶nder";
    }
    if (hedefRolDiv) {
      hedefRolDiv.style.display = tip === "toplu" ? "block" : "none";
      const hedefRolSelect = document.getElementById("hedefRol");
      if (hedefRolSelect) {
        hedefRolSelect.required = tip === "toplu";
        if (tip !== "toplu") hedefRolSelect.value = "";
      }
    }
    if (hedefUIDDiv) {
      hedefUIDDiv.style.display = tip === "kisisel" ? "block" : "none";
      const hedefUIDInput = document.getElementById("hedefUID");
      if (hedefUIDInput) {
        hedefUIDInput.required = tip === "kisisel";
        if (tip !== "kisisel") {
          hedefUIDInput.value = "";
          if (typeof window.seciliKullaniciyiTemizle === 'function') {
            window.seciliKullaniciyiTemizle();
          }
        }
      }
      // KullanÄ±cÄ± arama alanÄ±nÄ± temizle
      const aramaInput = document.getElementById("kullaniciAra");
      if (aramaInput) aramaInput.value = "";
      const sonuclar = document.getElementById("kullaniciSonuclari");
      if (sonuclar) sonuclar.style.display = "none";
    }
    if (modal) {
      modal.classList.add("open");
      // Body scroll'u engelle
      document.body.style.overflow = "hidden";
    }
  }

  window.modalKapat = function() {
    if (modal) {
      modal.classList.remove("open");
      // Body scroll'u geri aÃ§
      document.body.style.overflow = "";
    }
    // Formu temizle
    const form = document.getElementById("bildirimForm");
    if (form) form.reset();
    // KullanÄ±cÄ± seÃ§imini temizle
    if (typeof window.seciliKullaniciyiTemizle === 'function') {
      window.seciliKullaniciyiTemizle();
    }
    const sonuclar = document.getElementById("kullaniciSonuclari");
    if (sonuclar) sonuclar.style.display = "none";
    // DÃ¼zenleme modunu sÄ±fÄ±rla
    window.duzenlenenBildirimId = null;
  };

  // KullanÄ±cÄ± arama fonksiyonu
  let kullaniciAramaTimeout;
  window.kullaniciAra = async function(arama) {
    const db = getDb();
    if (!db || !arama || arama.length < 2) {
      const sonuclar = document.getElementById("kullaniciSonuclari");
      if (sonuclar) sonuclar.style.display = "none";
      return;
    }

    try {
      const kullanicilar = await db.collection("kullanicilar")
        .where("aktif", "==", true)
        .get();

      const sonuclar = document.getElementById("kullaniciSonuclari");
      if (!sonuclar) return;

      const aramaLower = arama.toLowerCase();
      const eslesenler = [];

      kullanicilar.forEach(doc => {
        const d = doc.data();
        const adSoyad = (d.adSoyad || "").toLowerCase();
        const email = (d.email || "").toLowerCase();
        
        if (adSoyad.includes(aramaLower) || email.includes(aramaLower)) {
          eslesenler.push({
            uid: doc.id,
            adSoyad: d.adSoyad || "Ä°simsiz",
            email: d.email || "",
            rol: d.rol || "personel"
          });
        }
      });

      sonuclar.innerHTML = "";
      if (eslesenler.length === 0) {
        sonuclar.innerHTML = "<div style='padding: 12px; color: var(--muted); text-align: center;'>KullanÄ±cÄ± bulunamadÄ±</div>";
        sonuclar.style.display = "block";
        return;
      }

      eslesenler.slice(0, 10).forEach(k => {
        const div = document.createElement("div");
        div.style.cssText = "padding: 10px 12px; cursor: pointer; border-bottom: 1px solid var(--stroke); transition: background 0.2s;";
        div.innerHTML = `
          <div style="font-weight: 600; color: var(--text);">${k.adSoyad}</div>
          <div style="font-size: 12px; color: var(--muted);">${k.email} â€¢ ${k.rol}</div>
        `;
        div.onmouseenter = () => div.style.background = "var(--surface)";
        div.onmouseleave = () => div.style.background = "transparent";
        div.onclick = () => window.kullaniciSec(k);
        sonuclar.appendChild(div);
      });

      sonuclar.style.display = "block";
    } catch (error) {
      console.error("KullanÄ±cÄ± arama hatasÄ±:", error);
    }
  }

  window.kullaniciSec = function(kullanici) {
    document.getElementById("hedefUID").value = kullanici.uid;
    document.getElementById("kullaniciAra").value = "";
    document.getElementById("kullaniciSonuclari").style.display = "none";
    
    const seciliDiv = document.getElementById("seciliKullanici");
    const seciliAd = document.getElementById("seciliKullaniciAd");
    if (seciliDiv && seciliAd) {
      seciliAd.textContent = `${kullanici.adSoyad} (${kullanici.email})`;
      seciliDiv.style.display = "block";
    }
  };

  window.seciliKullaniciyiTemizle = function() {
    document.getElementById("hedefUID").value = "";
    document.getElementById("seciliKullanici").style.display = "none";
  };

  window.bildirimGonder = async function() {
    const db = getDb();
    const auth = getAuth();
    if (!db || !auth) {
      if (typeof window.showToast === 'function') {
        window.showToast('error', 'Hata', 'VeritabanÄ± baÄŸlantÄ±sÄ± yok.');
      } else {
        alert('VeritabanÄ± baÄŸlantÄ±sÄ± yok.');
      }
      return;
    }

    const baslik = document.getElementById("baslik").value.trim();
    const icerik = document.getElementById("icerik").value.trim();

    if (!baslik || !icerik) {
      if (typeof window.showToast === 'function') {
        window.showToast('warning', 'UyarÄ±', 'LÃ¼tfen tÃ¼m alanlarÄ± doldurun.');
      } else {
        alert("LÃ¼tfen tÃ¼m alanlarÄ± doldurun.");
      }
      return;
    }

    const gondericiUID = auth.currentUser?.uid;
    if (!gondericiUID) {
      if (typeof window.showToast === 'function') {
        window.showToast('error', 'Hata', 'Oturum aÃ§Ä±k deÄŸil.');
      }
      return;
    }

    // DÃ¼zenleme modu
    if (window.duzenlenenBildirimId) {
      try {
        const bildirimRef = db.collection("bildirimler").doc(window.duzenlenenBildirimId);
        const bildirimDoc = await bildirimRef.get();
        
        if (!bildirimDoc.exists) {
          if (typeof window.showToast === 'function') {
            window.showToast('error', 'Hata', 'Bildirim bulunamadÄ±.');
          }
          return;
        }

        const eskiVeri = bildirimDoc.data();
        const eskiBildirimId = window.duzenlenenBildirimId;

        // Ana bildirim kaydÄ±nÄ± gÃ¼ncelle
        await bildirimRef.update({
          baslik,
          icerik,
          guncellemeZamani: firebase.firestore.FieldValue.serverTimestamp(),
          guncellendi: true
        });

        // TÃ¼m kullanÄ±cÄ± bildirimlerini gÃ¼ncelle
        const kullanicilarSnap = await db.collection("kullanici_bildirimleri").get();
        const batch = db.batch();
        let guncellenenSayisi = 0;

        for (const kullaniciDoc of kullanicilarSnap.docs) {
          const kullaniciBildirimRef = kullaniciDoc.ref
            .collection("bildirimler")
            .doc(eskiBildirimId);
          
          const kullaniciBildirimDoc = await kullaniciBildirimRef.get();
          if (kullaniciBildirimDoc.exists) {
            batch.update(kullaniciBildirimRef, {
              baslik,
              icerik,
              guncellemeZamani: firebase.firestore.FieldValue.serverTimestamp()
            });
            guncellenenSayisi++;
          }
        }

        await batch.commit();

        // Ä°ÅŸlem logu
        await db.collection("islem_log").add({
          islem: `Bildirim gÃ¼ncellendi - ${guncellenenSayisi} kullanÄ±cÄ±ya`,
          uid: gondericiUID,
          zaman: new Date(),
          detay: {
            bildirimId: eskiBildirimId,
            baslik,
            hedefSayisi: guncellenenSayisi
          }
        });

        if (typeof window.showToast === 'function') {
          window.showToast('success', 'BaÅŸarÄ±lÄ±', 'Bildirim gÃ¼ncellendi.');
        }
        if (typeof window.modalKapat === 'function') {
          window.modalKapat();
        }
        // Listeyi yenile
        if (typeof window.bildirimleriListele === 'function') {
          window.bildirimleriListele();
        }
        return;
      } catch (error) {
        console.error('Bildirim gÃ¼ncelleme hatasÄ±:', error);
        if (typeof window.showToast === 'function') {
          window.showToast('error', 'Hata', 'Bildirim gÃ¼ncellenemedi: ' + error.message);
        }
        return;
      }
    }

    // Yeni bildirim gÃ¶nderme
    let hedefKullanicilar = [];

    try {
      if (window.aktifTip === "toplu") {
        const hedefRol = document.getElementById("hedefRol").value;
        if (!hedefRol) {
          if (typeof window.showToast === 'function') {
            window.showToast('warning', 'UyarÄ±', 'LÃ¼tfen hedef rol seÃ§in.');
          } else {
            alert("LÃ¼tfen hedef rol seÃ§in.");
          }
          return;
        }

        // Hedef kullanÄ±cÄ±larÄ± bul
        let query = db.collection("kullanicilar").where("aktif", "==", true);
        
        if (hedefRol !== "tum") {
          query = query.where("rol", "==", hedefRol);
        }

        const kullanicilarSnap = await query.get();
        kullanicilarSnap.forEach(doc => {
          hedefKullanicilar.push({
            uid: doc.id,
            email: doc.data().email || "",
            adSoyad: doc.data().adSoyad || "Ä°simsiz"
          });
        });
      } else {
        const hedefUID = document.getElementById("hedefUID").value.trim();
        if (!hedefUID) {
          if (typeof window.showToast === 'function') {
            window.showToast('warning', 'UyarÄ±', 'LÃ¼tfen bir kullanÄ±cÄ± seÃ§in.');
          } else {
            alert("LÃ¼tfen bir kullanÄ±cÄ± seÃ§in.");
          }
          return;
        }

        // KullanÄ±cÄ± bilgisini al
        const kullaniciDoc = await db.collection("kullanicilar").doc(hedefUID).get();
        if (kullaniciDoc.exists) {
          const data = kullaniciDoc.data();
          hedefKullanicilar.push({
            uid: hedefUID,
            email: data.email || "",
            adSoyad: data.adSoyad || "Ä°simsiz"
          });
        } else {
          if (typeof window.showToast === 'function') {
            window.showToast('error', 'Hata', 'SeÃ§ilen kullanÄ±cÄ± bulunamadÄ±.');
          }
          return;
        }
      }

      if (hedefKullanicilar.length === 0) {
        if (typeof window.showToast === 'function') {
          window.showToast('warning', 'UyarÄ±', 'Hedef kullanÄ±cÄ± bulunamadÄ±.');
        }
        return;
      }

      // Ana bildirim kaydÄ± oluÅŸtur
      const bildirimVeri = {
        baslik,
        icerik,
        tip: window.aktifTip,
        gondericiUID,
        hedefRol: window.aktifTip === "toplu" ? document.getElementById("hedefRol").value : null,
        hedefUID: window.aktifTip === "kisisel" ? hedefKullanicilar[0].uid : null,
        hedefKullaniciSayisi: hedefKullanicilar.length,
        zaman: firebase.firestore.FieldValue.serverTimestamp(),
        createdAt: new Date()
      };

      const bildirimRef = await db.collection("bildirimler").add(bildirimVeri);
      const bildirimId = bildirimRef.id;

      // Her kullanÄ±cÄ± iÃ§in bildirim kaydÄ± oluÅŸtur
      const batch = db.batch();
      const kullaniciBildirimleriRef = db.collection("kullanici_bildirimleri");

      hedefKullanicilar.forEach(kullanici => {
        const kullaniciBildirimRef = kullaniciBildirimleriRef
          .doc(kullanici.uid)
          .collection("bildirimler")
          .doc(bildirimId);

        batch.set(kullaniciBildirimRef, {
          bildirimId,
          baslik,
          icerik,
          tip: window.aktifTip,
          gondericiUID,
          okunduMu: false,
          okunmaZamani: null,
          zaman: firebase.firestore.FieldValue.serverTimestamp(),
          createdAt: new Date()
        });

        // KullanÄ±cÄ±nÄ±n bildirim sayacÄ±nÄ± gÃ¼ncelle
        const kullaniciRef = kullaniciBildirimleriRef.doc(kullanici.uid);
        batch.set(kullaniciRef, {
          sonGuncelleme: firebase.firestore.FieldValue.serverTimestamp(),
          toplamBildirim: firebase.firestore.FieldValue.increment(1),
          okunmamisBildirim: firebase.firestore.FieldValue.increment(1)
        }, { merge: true });
      });

      await batch.commit();

      // Ä°ÅŸlem logu
      await db.collection("islem_log").add({
        islem: `Bildirim gÃ¶nderildi (${window.aktifTip}) - ${hedefKullanicilar.length} kullanÄ±cÄ±ya`,
        uid: gondericiUID,
        zaman: new Date(),
        detay: {
          baslik,
          hedefSayisi: hedefKullanicilar.length
        }
      });

      if (typeof window.showToast === 'function') {
        window.showToast('success', 'BaÅŸarÄ±lÄ±', `${hedefKullanicilar.length} kullanÄ±cÄ±ya bildirim gÃ¶nderildi.`);
      } else {
        alert(`${hedefKullanicilar.length} kullanÄ±cÄ±ya bildirim gÃ¶nderildi.`);
      }
      if (typeof window.modalKapat === 'function') {
        window.modalKapat();
      }
      // Listeyi yenile
      if (typeof window.bildirimleriListele === 'function') {
        window.bildirimleriListele();
      }
    } catch (error) {
      console.error('Bildirim gÃ¶nderme hatasÄ±:', error);
      if (typeof window.showToast === 'function') {
        window.showToast('error', 'Hata', 'Bildirim gÃ¶nderilemedi: ' + error.message);
      } else {
        alert('Bildirim gÃ¶nderilemedi: ' + error.message);
      }
    }
  };

  window.bildirimleriListele = async function() {
    const db = getDb();
    if (!db) {
      if (typeof window.showToast === 'function') {
        window.showToast('error', 'Hata', 'VeritabanÄ± baÄŸlantÄ±sÄ± yok.');
      } else {
        alert('VeritabanÄ± baÄŸlantÄ±sÄ± yok.');
      }
      return;
    }

    const liste = document.getElementById("bildirimListesi");
    if (!liste) return;

    liste.innerHTML = "<h3 style='margin-bottom: 16px; font-size: 20px; font-weight: 700; color: var(--text);'>ğŸ“ƒ GÃ¶nderilen Bildirimler</h3>";

    try {
      const snap = await db.collection("bildirimler")
        .orderBy("createdAt", "desc")
        .limit(50)
        .get();
      
      if (snap.empty) {
        liste.innerHTML += "<div class='bildirim-item'><span>HenÃ¼z bildirim gÃ¶nderilmemiÅŸ.</span></div>";
        return;
      }

      snap.forEach(doc => {
        const d = doc.data();
        const z = d.createdAt ? new Date(d.createdAt).toLocaleString('tr-TR') : 
                  (d.zaman?.toDate ? d.zaman.toDate().toLocaleString('tr-TR') : "-");
        
        const div = document.createElement("div");
        div.className = "bildirim-item";
        
        // GÃ¼venli DOM oluÅŸturma
        const baslikEl = document.createElement("b");
        const tipText = d.tip === "toplu" ? "Toplu" : "KiÅŸisel";
        baslikEl.textContent = (d.baslik || 'BaÅŸlÄ±ksÄ±z') + ` (${tipText})`;
        
        const icerikEl = document.createElement("span");
        icerikEl.textContent = d.icerik || '';
        
        const detayEl = document.createElement("div");
        detayEl.style.cssText = "margin-top: 8px; padding-top: 8px; border-top: 1px solid var(--stroke); font-size: 12px; color: var(--muted);";
        
        const zamanSpan = document.createElement("span");
        zamanSpan.innerHTML = '<b>Zaman:</b> ' + z;
        detayEl.appendChild(zamanSpan);
        
        if (d.hedefKullaniciSayisi) {
          const sayiSpan = document.createElement("span");
          sayiSpan.style.marginLeft = "12px";
          sayiSpan.innerHTML = '<b>Hedef:</b> ' + d.hedefKullaniciSayisi + ' kullanÄ±cÄ±';
          detayEl.appendChild(sayiSpan);
        }
        
        if (d.hedefRol && d.tip === "toplu") {
          const rolSpan = document.createElement("span");
          rolSpan.style.marginLeft = "12px";
          rolSpan.innerHTML = '<b>Rol:</b> ' + d.hedefRol;
          detayEl.appendChild(rolSpan);
        }
        
        // Aksiyon butonlarÄ±
        const actionsDiv = document.createElement("div");
        actionsDiv.className = "bildirim-actions";
        
        const editBtn = document.createElement("button");
        editBtn.className = "btn-edit";
        editBtn.innerHTML = "âœï¸ DÃ¼zenle";
        editBtn.onclick = () => window.bildirimDuzenle(doc.id, d);
        
        const resendBtn = document.createElement("button");
        resendBtn.className = "btn-resend";
        resendBtn.innerHTML = "ğŸ”„ Yeniden GÃ¶nder";
        resendBtn.onclick = () => window.bildirimYenidenGonder(doc.id, d);
        
        const deleteBtn = document.createElement("button");
        deleteBtn.className = "btn-delete";
        deleteBtn.innerHTML = "ğŸ—‘ï¸ Sil";
        deleteBtn.onclick = () => window.bildirimSil(doc.id);
        
        actionsDiv.appendChild(editBtn);
        actionsDiv.appendChild(resendBtn);
        actionsDiv.appendChild(deleteBtn);
        
        div.appendChild(baslikEl);
        div.appendChild(icerikEl);
        div.appendChild(detayEl);
        div.appendChild(actionsDiv);
        
        liste.appendChild(div);
      });
    } catch (error) {
      console.error('Bildirim listeleme hatasÄ±:', error);
      if (typeof window.showToast === 'function') {
        window.showToast('error', 'Hata', 'Bildirimler yÃ¼klenemedi: ' + error.message);
      } else {
        alert('Bildirimler yÃ¼klenemedi: ' + error.message);
      }
    }
  };

  // Modal backdrop'a tÄ±klanÄ±nca kapat (sadece backdrop'a, sheet'e deÄŸil)
  if (modal) {
    modal.addEventListener('click', (e) => {
      // Sadece modal container'a (backdrop) tÄ±klanÄ±nca kapat, sheet iÃ§ine tÄ±klanÄ±nca kapatma
      const sheet = modal.querySelector('.sheet');
      if (e.target === modal && !sheet?.contains(e.target)) {
        if (typeof window.modalKapat === 'function') {
          window.modalKapat();
        }
      }
    });

    // Sheet iÃ§ine tÄ±klanÄ±nca event propagation'Ä± durdur
    const sheet = modal.querySelector('.sheet');
    if (sheet) {
      sheet.addEventListener('click', (e) => {
        e.stopPropagation();
      });
    }

    // ESC tuÅŸu ile kapat
    const escHandler = (e) => {
      if (e.key === 'Escape' && modal.classList.contains('open')) {
        if (typeof window.modalKapat === 'function') {
          window.modalKapat();
        }
      }
    };
    document.addEventListener('keydown', escHandler);
  }

  // KullanÄ±cÄ± arama input listener
  document.addEventListener("DOMContentLoaded", () => {
    const aramaInput = document.getElementById("kullaniciAra");
    if (aramaInput) {
      aramaInput.addEventListener("input", (e) => {
        clearTimeout(kullaniciAramaTimeout);
        kullaniciAramaTimeout = setTimeout(() => {
          if (typeof window.kullaniciAra === 'function') {
            window.kullaniciAra(e.target.value);
          }
        }, 300);
      });

      // DÄ±ÅŸarÄ± tÄ±klanÄ±nca sonuÃ§larÄ± kapat
      document.addEventListener("click", (e) => {
        if (!aramaInput.contains(e.target) && !document.getElementById("kullaniciSonuclari")?.contains(e.target)) {
          document.getElementById("kullaniciSonuclari").style.display = "none";
        }
      });
    }
  });

  // Bildirim silme fonksiyonu
  window.bildirimSil = async function(bildirimId) {
    if (!confirm('Bu bildirimi silmek istediÄŸinizden emin misiniz? Bu iÅŸlem geri alÄ±namaz.')) {
      return;
    }

    const db = getDb();
    const auth = getAuth();
    if (!db || !auth) {
      if (typeof window.showToast === 'function') {
        window.showToast('error', 'Hata', 'VeritabanÄ± baÄŸlantÄ±sÄ± yok.');
      }
      return;
    }

    try {
      const bildirimDoc = await db.collection("bildirimler").doc(bildirimId).get();
      if (!bildirimDoc.exists) {
        if (typeof window.showToast === 'function') {
          window.showToast('error', 'Hata', 'Bildirim bulunamadÄ±.');
        }
        return;
      }

      // TÃ¼m kullanÄ±cÄ± bildirimlerini sil
      const kullanicilarSnap = await db.collection("kullanici_bildirimleri").get();
      const batch = db.batch();
      let silinenSayisi = 0;

      for (const kullaniciDoc of kullanicilarSnap.docs) {
        const kullaniciBildirimRef = kullaniciDoc.ref
          .collection("bildirimler")
          .doc(bildirimId);
        
        const kullaniciBildirimDoc = await kullaniciBildirimRef.get();
        if (kullaniciBildirimDoc.exists) {
          const bildirimData = kullaniciBildirimDoc.data();
          // EÄŸer okunmamÄ±ÅŸsa sayacÄ± azalt
          if (!bildirimData.okunduMu) {
            const kullaniciRef = kullaniciDoc.ref;
            batch.update(kullaniciRef, {
              okunmamisBildirim: firebase.firestore.FieldValue.increment(-1)
            });
          }
          batch.delete(kullaniciBildirimRef);
          silinenSayisi++;
        }
      }

      // Ana bildirim kaydÄ±nÄ± sil
      batch.delete(db.collection("bildirimler").doc(bildirimId));
      await batch.commit();

      // Ä°ÅŸlem logu
      await db.collection("islem_log").add({
        islem: `Bildirim silindi - ${silinenSayisi} kullanÄ±cÄ±dan`,
        uid: auth.currentUser?.uid,
        zaman: new Date(),
        detay: {
          bildirimId,
          silinenSayisi
        }
      });

      if (typeof window.showToast === 'function') {
        window.showToast('success', 'BaÅŸarÄ±lÄ±', 'Bildirim silindi.');
      }
      // Listeyi yenile
      if (typeof window.bildirimleriListele === 'function') {
        window.bildirimleriListele();
      }
    } catch (error) {
      console.error('Bildirim silme hatasÄ±:', error);
      if (typeof window.showToast === 'function') {
        window.showToast('error', 'Hata', 'Bildirim silinemedi: ' + error.message);
      }
    }
  };

  // Bildirim dÃ¼zenleme fonksiyonu
  window.bildirimDuzenle = async function(bildirimId, bildirimData) {
    const db = getDb();
    if (!db) {
      if (typeof window.showToast === 'function') {
        window.showToast('error', 'Hata', 'VeritabanÄ± baÄŸlantÄ±sÄ± yok.');
      }
      return;
    }

    try {
      // Form alanlarÄ±nÄ± doldur
      document.getElementById("baslik").value = bildirimData.baslik || "";
      document.getElementById("icerik").value = bildirimData.icerik || "";

      // Tip'e gÃ¶re modal'Ä± aÃ§
      const tip = bildirimData.tip || "toplu";
      window.modalAc(tip, bildirimId);

      // Hedef bilgilerini doldur
      if (tip === "toplu") {
        if (bildirimData.hedefRol) {
          document.getElementById("hedefRol").value = bildirimData.hedefRol;
        }
      } else {
        if (bildirimData.hedefUID) {
          // KullanÄ±cÄ± bilgisini al ve gÃ¶ster
          const kullaniciDoc = await db.collection("kullanicilar").doc(bildirimData.hedefUID).get();
          if (kullaniciDoc.exists) {
            const kullaniciData = kullaniciDoc.data();
            document.getElementById("hedefUID").value = bildirimData.hedefUID;
            const seciliDiv = document.getElementById("seciliKullanici");
            const seciliAd = document.getElementById("seciliKullaniciAd");
            if (seciliDiv && seciliAd) {
              seciliAd.textContent = `${kullaniciData.adSoyad || "Ä°simsiz"} (${kullaniciData.email || ""})`;
              seciliDiv.style.display = "block";
            }
          }
        }
      }
    } catch (error) {
      console.error('Bildirim dÃ¼zenleme hatasÄ±:', error);
      if (typeof window.showToast === 'function') {
        window.showToast('error', 'Hata', 'Bildirim yÃ¼klenemedi: ' + error.message);
      }
    }
  };

  // Bildirim yeniden gÃ¶nderme fonksiyonu
  window.bildirimYenidenGonder = async function(bildirimId, bildirimData) {
    if (!confirm('Bu bildirimi aynÄ± hedef kullanÄ±cÄ±lara yeniden gÃ¶ndermek istediÄŸinizden emin misiniz?')) {
      return;
    }

    const db = getDb();
    const auth = getAuth();
    if (!db || !auth) {
      if (typeof window.showToast === 'function') {
        window.showToast('error', 'Hata', 'VeritabanÄ± baÄŸlantÄ±sÄ± yok.');
      }
      return;
    }

    try {
      const gondericiUID = auth.currentUser?.uid;
      if (!gondericiUID) {
        if (typeof window.showToast === 'function') {
          window.showToast('error', 'Hata', 'Oturum aÃ§Ä±k deÄŸil.');
        }
        return;
      }

      let hedefKullanicilar = [];

      // Hedef kullanÄ±cÄ±larÄ± bul
      if (bildirimData.tip === "toplu") {
        let query = db.collection("kullanicilar").where("aktif", "==", true);
        
        if (bildirimData.hedefRol && bildirimData.hedefRol !== "tum") {
          query = query.where("rol", "==", bildirimData.hedefRol);
        }

        const kullanicilarSnap = await query.get();
        kullanicilarSnap.forEach(doc => {
          hedefKullanicilar.push({
            uid: doc.id,
            email: doc.data().email || "",
            adSoyad: doc.data().adSoyad || "Ä°simsiz"
          });
        });
      } else {
        if (bildirimData.hedefUID) {
          const kullaniciDoc = await db.collection("kullanicilar").doc(bildirimData.hedefUID).get();
          if (kullaniciDoc.exists) {
            const data = kullaniciDoc.data();
            hedefKullanicilar.push({
              uid: bildirimData.hedefUID,
              email: data.email || "",
              adSoyad: data.adSoyad || "Ä°simsiz"
            });
          }
        }
      }

      if (hedefKullanicilar.length === 0) {
        if (typeof window.showToast === 'function') {
          window.showToast('warning', 'UyarÄ±', 'Hedef kullanÄ±cÄ± bulunamadÄ±.');
        }
        return;
      }

      // Yeni bildirim kaydÄ± oluÅŸtur
      const bildirimVeri = {
        baslik: bildirimData.baslik,
        icerik: bildirimData.icerik,
        tip: bildirimData.tip,
        gondericiUID,
        hedefRol: bildirimData.hedefRol || null,
        hedefUID: bildirimData.hedefUID || null,
        hedefKullaniciSayisi: hedefKullanicilar.length,
        yenidenGonderildi: true,
        orijinalBildirimId: bildirimId,
        zaman: firebase.firestore.FieldValue.serverTimestamp(),
        createdAt: new Date()
      };

      const bildirimRef = await db.collection("bildirimler").add(bildirimVeri);
      const yeniBildirimId = bildirimRef.id;

      // Her kullanÄ±cÄ± iÃ§in bildirim kaydÄ± oluÅŸtur
      const batch = db.batch();
      const kullaniciBildirimleriRef = db.collection("kullanici_bildirimleri");

      hedefKullanicilar.forEach(kullanici => {
        const kullaniciBildirimRef = kullaniciBildirimleriRef
          .doc(kullanici.uid)
          .collection("bildirimler")
          .doc(yeniBildirimId);

        batch.set(kullaniciBildirimRef, {
          bildirimId: yeniBildirimId,
          baslik: bildirimData.baslik,
          icerik: bildirimData.icerik,
          tip: bildirimData.tip,
          gondericiUID,
          okunduMu: false,
          okunmaZamani: null,
          zaman: firebase.firestore.FieldValue.serverTimestamp(),
          createdAt: new Date()
        });

        // KullanÄ±cÄ±nÄ±n bildirim sayacÄ±nÄ± gÃ¼ncelle
        const kullaniciRef = kullaniciBildirimleriRef.doc(kullanici.uid);
        batch.set(kullaniciRef, {
          sonGuncelleme: firebase.firestore.FieldValue.serverTimestamp(),
          toplamBildirim: firebase.firestore.FieldValue.increment(1),
          okunmamisBildirim: firebase.firestore.FieldValue.increment(1)
        }, { merge: true });
      });

      await batch.commit();

      // Ä°ÅŸlem logu
      await db.collection("islem_log").add({
        islem: `Bildirim yeniden gÃ¶nderildi (${bildirimData.tip}) - ${hedefKullanicilar.length} kullanÄ±cÄ±ya`,
        uid: gondericiUID,
        zaman: new Date(),
        detay: {
          orijinalBildirimId: bildirimId,
          yeniBildirimId,
          baslik: bildirimData.baslik,
          hedefSayisi: hedefKullanicilar.length
        }
      });

      if (typeof window.showToast === 'function') {
        window.showToast('success', 'BaÅŸarÄ±lÄ±', `${hedefKullanicilar.length} kullanÄ±cÄ±ya bildirim yeniden gÃ¶nderildi.`);
      }
      // Listeyi yenile
      if (typeof window.bildirimleriListele === 'function') {
        window.bildirimleriListele();
      }
    } catch (error) {
      console.error('Bildirim yeniden gÃ¶nderme hatasÄ±:', error);
      if (typeof window.showToast === 'function') {
        window.showToast('error', 'Hata', 'Bildirim yeniden gÃ¶nderilemedi: ' + error.message);
      }
    }
  };

  // Sayfa Ã¶zel init fonksiyonu
  window.initPage = async function() {
    // Sayfa yÃ¼klendiÄŸinde yapÄ±lacak iÅŸlemler
    // Yetki kontrolÃ¼ ortak.js'den geliyor
  };

  // Yetki kontrolÃ¼ - ortak.js'den geliyor, burada sadece sayfa Ã¶zel kontrol varsa eklenir
  // GÃ¼venlik ve yetki kontrolÃ¼ ortak.js'deki initAppShellAuth() tarafÄ±ndan yapÄ±lÄ±yor
</script>

</body>
</html>
