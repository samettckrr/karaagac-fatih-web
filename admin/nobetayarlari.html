<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Nöbet Ayarla | Karaağaç Fatih</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" type="image/png" href="../img/logo.png" />

  <style>
    :root{
      --appbar-h:56px;
      --radius:14px; --shadow:0 12px 28px rgba(0,0,0,.14);
      --bg:#0f172a; --bg2:#0b1324;
      --grad1:#0ea5e922; --grad2:#22d3ee22;
      --card:rgba(15,23,42,.92); --stroke:rgba(148,163,184,.18);
      --text:#e5e7eb; --muted:#9aa4b2;
      --brand:#38bdf8; --brand2:#0ea5e9;
      --pill:#0b1220; --pill-hover:#101a2b;
      --link:#c7e9ff; --surface:rgba(2,6,23,.08);
      --danger:#ff4255; --ok:#33c27f;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#eef6ff; --bg2:#f7fbff; --grad1:#38bdf822; --grad2:#22d3ee22;
        --card:rgba(255,255,255,.95);
        --stroke:rgba(15,23,42,.12);
        --text:#0b1220; --muted:#4b5563; --brand:#0ea5e9; --brand2:#0284c7;
        --pill:#f5f8ff; --pill-hover:#e9f2ff; --link:#0b5ea8; --surface:#eef3ff;
      }
    }
    html[data-theme="dark"]{
      --bg:#0f172a; --bg2:#0b1324; --grad1:#0ea5e922; --grad2:#22d3ee22;
      --card:rgba(15,23,42,.92); --stroke:rgba(148,163,184,.18);
      --text:#e5e7eb; --muted:#9aa4b2; --brand:#38bdf8; --brand2:#0ea5e9;
      --pill:#0b1220; --pill-hover:#101a2b; --link:#c7e9ff; --surface:rgba(2,6,23,.08);
    }
    html[data-theme="light"]{
      --bg:#eef6ff; --bg2:#f7fbff; --grad1:#38bdf822; --grad2:#22d3ee22;
      --card:rgba(255,255,255,.95); --stroke:rgba(15,23,42,.12);
      --text:#0b1220; --muted:#4b5563; --brand:#0ea5e9; --brand2:#0284c7;
      --pill:#f5f8ff; --pill-hover:#e9f2ff; --link:#0b5ea8; --surface:#eef3ff;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; color:var(--text);
      font-family:ui-sans-serif,-apple-system,"Segoe UI",Roboto,Arial;
      background:
        radial-gradient(900px 680px at 12% 8%, var(--grad1), transparent 45%),
        radial-gradient(800px 640px at 88% 92%, var(--grad2), transparent 50%),
        linear-gradient(140deg, var(--bg), var(--bg2) 60%);
      overflow-x:hidden; word-wrap:break-word;
    }
    a{color:var(--link); text-decoration:none}
    a:hover{text-decoration:underline}

    /* APPBAR */
    .appbar{
      position:sticky; top:0; z-index:60;
      height:var(--appbar-h);
      background:var(--card); backdrop-filter:blur(10px);
      border-bottom:1px solid var(--stroke);
      display:flex; align-items:center; gap:10px;
      padding:0 max(12px, env(safe-area-inset-right)) 0 max(12px, env(safe-area-inset-left));
    }
    .brand{display:flex; align-items:center; gap:10px; cursor:pointer}
    .brand img{width:24px; height:24px}
    .brand span{font-weight:900; letter-spacing:.02em; color:var(--text)}

    .nav-center{margin:0 auto; height:100%}
    .nav-list{display:flex; gap:22px; align-items:center; height:100%; list-style:none; margin:0; padding:0}
    .nav-item{position:relative; height:100%}
    .nav-btn{height:100%; display:flex; align-items:center; gap:6px; color:var(--text); font-weight:600; cursor:pointer}
    .nav-btn:hover{color:var(--brand)}
    .caret{font-size:12px; opacity:.6}
    .dropdown{position:absolute; top:100%; left:0; min-width:240px; background:var(--card); border:1px solid var(--stroke); border-radius:10px; box-shadow:var(--shadow); padding:8px; display:none}
    .dropdown a{display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:8px; color:var(--text); text-decoration:none}
    .dropdown a:hover{background:var(--surface)}
    .nav-item.open .dropdown{display:block}

    .nav-right{display:flex; gap:8px; align-items:center}
    .iconbtn{border:1px solid var(--stroke); background:var(--card); color:var(--text); border-radius:999px; padding:8px 12px; cursor:pointer}
    .badge{background:var(--danger); color:#fff; font-size:11px; padding:2px 6px; border-radius:8px; margin-left:6px}
    .dropdown-panel{position:absolute; top:100%; right:0; min-width:280px; background:var(--card); border:1px solid var(--stroke); border-radius:12px; box-shadow:var(--shadow); padding:8px; display:none; z-index:80}
    .nav-right .open + .dropdown-panel{display:block}
    .drop-row{padding:8px 10px; border-radius:8px; display:flex; justify-content:space-between; align-items:center}
    .drop-row:hover{background:var(--surface)}
    .muted{color:var(--muted); font-size:12px}

    /* DRAWER (mobil) */
    .drawer{
      position:fixed;
      top:var(--appbar-h); right:0; bottom:0; left:30%;
      transform:translateX(100%); transition:transform .25s ease;
      background:var(--card); border-left:1px solid var(--stroke);
      z-index:70; overflow:auto; -webkit-overflow-scrolling:touch; padding:12px;
    }
    .drawer.open{transform:translateX(0)}
    .drawer .panel-title{margin:14px 4px 6px; font-weight:800; color:var(--muted); font-size:13px}
    .drawer a{display:block; padding:10px; border-radius:10px; border:1px solid var(--stroke); margin:6px 0; color:var(--text); background:var(--pill)}
    .drawer a:hover{background:var(--pill-hover)}

    /* CONTENT */
    .container{max-width:1200px; margin:0 auto; padding:16px}
    .hero{display:flex; justify-content:space-between; align-items:flex-start; gap:16px; background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius); padding:16px; margin:16px 0; box-shadow:var(--shadow)}
    .hero h2{margin:0 0 6px; font-size:20px}
    .hero-sub{color:var(--muted); font-size:13px}
    .mini{display:flex; gap:8px; flex-wrap:wrap}
    .pill{padding:6px 10px; border-radius:999px; border:1px solid var(--stroke); background:var(--pill); font-size:12px}

    .grid{display:grid; gap:14px; grid-template-columns:repeat(12, minmax(0,1fr))}
    .col-3{grid-column:span 3} .col-4{grid-column:span 4} .col-6{grid-column:span 6} .col-8{grid-column:span 8} .col-12{grid-column:span 12}
    .card{background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px}
    .card h3{margin:0 0 10px; font-size:16px}
    .form-grid{display:grid; gap:12px; grid-template-columns:repeat(12, minmax(0,1fr))}
    .fg-4{grid-column:span 4} .fg-6{grid-column:span 6} .fg-12{grid-column:span 12}
    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px}
    input[type="text"],input[type="date"],select{
      width:100%; padding:10px 12px; border:1px solid var(--stroke); border-radius:12px; background:var(--pill); color:var(--text); outline:none
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .soft{background:var(--surface); border:1px solid var(--stroke); color:var(--text)}
    .right{display:flex; gap:8px; justify-content:flex-end}

    table{width:100%; border-collapse:collapse; margin-top:8px}
    th,td{border-bottom:1px solid var(--stroke); padding:10px 8px; text-align:left}
    thead th{font-size:12px; color:var(--muted)}
    .time{font-variant-numeric:tabular-nums; font-weight:700; color:var(--brand2)}
    .inline{min-width:150px}

    .toast{position:fixed; left:50%; bottom:24px; transform:translateX(-50%) translateY(20px); background:rgba(2,6,23,.95); color:#fff; border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:10px 12px; opacity:0; pointer-events:none; transition:opacity .25s, transform .25s; z-index:200}
    .toast.show{opacity:1; transform:translateX(-50%) translateY(0)}

    @media (max-width: 1024px){ .nav-center{display:none} .hamb{display:inline-flex} }
    @media (max-width: 960px){
      .col-3{grid-column:span 6} .col-4{grid-column:span 6} .col-6{grid-column:span 6} .col-8{grid-column:span 6} .col-12{grid-column:span 12}
      .hero{flex-direction:column}
    }
    /* === Masaüstünde hamburger görünmesin === */
.hamb{ display: none !important; }

/* === Appbar ve butonlara modern dokunuşlar === */
.appbar{
  background: color-mix(in oklab, var(--card), transparent 10%);
  backdrop-filter: saturate(160%) blur(14px);
  border-bottom: 1px solid color-mix(in oklab, var(--stroke), transparent 25%);
}

/* Eski .iconbtn'yi biraz “pill” ve hover/press animasyonlu yapalım */
.iconbtn{
  display:inline-flex; align-items:center; gap:8px;
  padding:8px 12px; line-height:1;
  border-radius:12px;
  background: linear-gradient(180deg,
              color-mix(in oklab, var(--pill), white 6%),
              var(--pill));
  border:1px solid var(--stroke);
  transition: transform .12s ease, box-shadow .12s ease, background .18s ease, border-color .18s ease;
}
.iconbtn:hover{
  transform: translateY(-1px);
  box-shadow: 0 8px 20px rgba(0,0,0,.14);
  background: color-mix(in oklab, var(--pill), white 10%);
  border-color: color-mix(in oklab, var(--stroke), white 12%);
}
.iconbtn:active{ transform: translateY(0); box-shadow:none; }

/* Bildirim sayacı (daha net pill) */
.badge{
  display:inline-flex; align-items:center; justify-content:center;
  min-width:18px; height:18px; padding:0 6px;
  border-radius:999px; margin-left:6px;
  font-size:11px; font-weight:700;
  background: color-mix(in oklab, var(--danger), black 6%); color:#fff;
  border: 1px solid color-mix(in oklab, var(--danger), white 20%);
}

/* Dropdown panel – yumuşak gölge ve pop animasyonu */
.dropdown-panel{
  border-radius:14px;
  border:1px solid color-mix(in oklab, var(--stroke), transparent 10%);
  box-shadow: 0 10px 30px rgba(0,0,0,.18);
  background: color-mix(in oklab, var(--card), transparent 4%);
  animation: pop .14s ease;
}
.drop-row{ transition: background .15s ease, transform .08s ease; }
.drop-row:hover{ background: var(--surface); transform: translateX(2px); }

@keyframes pop{
  from{ opacity:0; transform: translateY(6px) scale(.98); }
  to  { opacity:1; transform: translateY(0)   scale(1); }
}

/* Masaüstü/mobil kırılımı: hamburger sadece mobilde görünsün */
@media (max-width: 1024px){
  .nav-center{ display:none; }
  .hamb{ display:inline-flex !important; } /* sadece mobilde göster */
}
/* ===== Mobilde tabloyu kart görünümüne çevir ===== */
@media (max-width: 720px){
  /* Başlık gizle, table yapısını block'a çevir */
  table{border-collapse:separate;border-spacing:0}
  thead{display:none}
  table, thead, tbody, tr, th, td{display:block; width:100%}

  /* Her TR bir “kart” olsun */
  tbody tr{
    background: var(--card);
    border: 1px solid var(--stroke);
    border-radius: 14px;
    box-shadow: var(--shadow);
    margin: 10px 0 14px;
    overflow: hidden;
  }

  /* Satır içi hücreler: etiket + değer düzeni */
  tbody td{
    display:grid;
    grid-template-columns: 120px 1fr; /* sol etiket / sağ içerik */
    align-items:center;
    gap:10px;
    padding:12px 14px;
    border-bottom:1px solid var(--stroke);
    word-break: break-word;
  }
  tbody td:last-child{ border-bottom: none; }

  /* Etiketleri pseudo ile veriyoruz (thead gizli) */
  tbody td:nth-child(1)::before{ content:"Gün";      color:var(--muted); font-size:12px; font-weight:700; }
  tbody td:nth-child(2)::before{ content:"Tarih";    color:var(--muted); font-size:12px; font-weight:700; }
  tbody td:nth-child(3)::before{ content:"Saat";     color:var(--muted); font-size:12px; font-weight:700; }
  tbody td:nth-child(4)::before{ content:"Bekâr";    color:var(--muted); font-size:12px; font-weight:700; }
  tbody td:nth-child(5)::before{ content:"Evli/Sabit"; color:var(--muted); font-size:12px; font-weight:700; }
  tbody td:nth-child(6)::before{ content:"Not";      color:var(--muted); font-size:12px; font-weight:700; }

  /* İçerik (sağ kolon) tipografisi */
  .time{ font-weight:700; color:var(--brand2); }

  /* Select'ler kart içinde tam genişlik olsun */
  select.inline{ min-width:0; width:100%; }

  /* Küçük ekranlarda pill’ler taşmasın */
  .pill{ display:inline-flex; align-items:center; max-width:100%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
}

/* İsteğe bağlı: çok dar ekranlarda etiket kolonu biraz daralsın */
@media (max-width: 380px){
  tbody td{ grid-template-columns: 96px 1fr; }
}

  </style>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="../js/firebase/firebase-init.js"></script>
</head>
<body>

  <!-- APPBAR -->
  <div class="appbar">
    <div class="brand" onclick="location.href='../panel.html'">
      <img src="../img/logo.png" alt="logo"><span>KARAAĞAÇ FATİH</span>
    </div>

    <nav class="nav-center"><ul class="nav-list" id="navMain"></ul></nav>

    <div class="nav-right">
      <!-- Bildirim -->
      <button class="iconbtn" id="btnNotif" title="Bildirimler">🔔<span class="badge" id="notifBadge" style="display:none">0</span></button>
      <div class="dropdown-panel" id="notifDropdown">
        <div class="muted" style="padding:6px 8px">Son bildirimler</div>
        <div id="notifList" style="max-height:300px;overflow:auto"></div>
        <a href="../diger/bildirim.html" class="drop-row">Tüm bildirimleri gör →</a>
      </div>

      <!-- Profil -->
      <button class="iconbtn" id="btnProfile" title="Profil">👤 <span id="profName" class="muted">Profil</span></button>
      <div class="dropdown-panel" id="profDropdown">
        <a href="../admin/kullanici-listesi.html" class="drop-row">Kullanıcı Yönetimi</a>
        <a href="../ayarlar.html" class="drop-row">Ayarlar</a>
        <a href="../privacy.html" class="drop-row">Gizlilik</a>
        <a href="#" id="btnLogout" class="drop-row" style="color:#fff;background:#b91c1c;border-color:#b91c1c">Çıkış Yap</a>
      </div>

      <button class="iconbtn hamb" id="hamburger" title="Menü">☰</button>
    </div>
  </div>

  <!-- Mobil çekmece -->
  <aside class="drawer" id="drawer"></aside>

  <!-- CONTENT -->
  <main class="container">
    <!-- HERO -->
    <section class="hero">
      <div>
        <h2>Nöbet Ayarla</h2>
        <div class="hero-sub">Bugün: <span id="todayText">—</span> • <span id="username">—</span></div>
        <div class="mini" style="margin-top:8px">
          <span class="pill">Seçili Hafta: <b id="outWeek">—</b></span>
          <span class="pill">Bekâr start: <b id="outBStart">-</b></span>
          <span class="pill">Evli start: <b id="outEStart">-</b></span>
          <span class="pill">Özel Pazar: <b id="sumPazar">—</b></span>
        </div>
      </div>
    </section>

    <!-- AYARLAR -->
    <section class="card">
      <h3>Ayarlar</h3>
      <div class="form-grid" style="margin-top:6px">
        <div class="fg-4">
          <label>Haftadan Bir Tarih</label>
          <input type="date" id="inpTarih">
        </div>
        <div class="fg-4">
          <label>Pazartesi Sabit İhvan</label>
          <input type="text" id="inpIhvan" value="İhvan">
        </div>
        <div class="fg-4">
          <label>Özel Pazar Otomatiği</label>
          <select id="selOtoPazar">
            <option value="auto">2 haftada bir (otomatik)</option>
            <option value="none">Kapalı</option>
          </select>
        </div>

        <div class="fg-6">
          <label>Bekâr Listesi (virgülle)</label>
          <input type="text" id="inpBekar" value="B1,B2,B3">
        </div>
        <div class="fg-6">
          <label>Evli Listesi (virgülle)</label>
          <input type="text" id="inpEvli" value="E1,E2,E3,E4,E5">
        </div>

        <div class="fg-12">
          <div class="row">
            <label class="pill"><input type="checkbox" id="chkManPazar"> Bu hafta Özel Pazar (08:00–19:30 evli + 18:00→09:00 bekâr)</label>
            <label class="pill"><input type="checkbox" id="chkTehir"> Pazar Tehir</label>
            <label class="pill"><input type="checkbox" id="chkAyarKaydet" checked> Ayarları kaydet</label>
          </div>
        </div>
      </div>

      <div class="row right" style="margin-top:10px">
        <button class="iconbtn soft" id="btnOlustur" style="border-color:transparent; background:linear-gradient(90deg,var(--brand2),var(--brand)); color:#fff">Planı Oluştur / Yükle</button>
        <button class="iconbtn soft" id="btnKaydet" style="border-color:transparent; background:linear-gradient(90deg,var(--brand),#60a5fa); color:#fff">Planı Kaydet</button>
        <button class="iconbtn soft" id="btnHaftaSil" style="display:none;background:#b91c1c;border-color:#b91c1c;color:#fff">Bu Haftayı Sil</button>
      </div>
      <div class="muted" id="existInfo" style="display:none;margin-top:8px"></div>
    </section>

    <!-- PLAN -->
    <section class="card">
      <h3>Haftalık Plan (Düzenlenebilir)</h3>
      <table>
        <thead>
          <tr>
            <th>Gün</th><th>Tarih</th><th>Saat</th><th>Bekâr</th><th>Evli / Sabit</th><th>Not</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </section>

    <div class="page-gap"></div>
  </main>

  <div class="toast" id="toast"></div>

  <script>
    /* ===== Tema (Auto) – sadece görünüm için, profil menüsüne taşındı ===== */
    (function(){ const root=document.documentElement; const mode=localStorage.getItem('kf_theme')||'auto';
      const sysDark=()=>matchMedia && matchMedia('(prefers-color-scheme: dark)').matches;
      root.setAttribute('data-theme', mode==='auto' ? (sysDark()?'dark':'light') : mode);
      if(window.matchMedia){ const m=matchMedia('(prefers-color-scheme: dark)'); m.addEventListener?.('change',()=>{ if((localStorage.getItem('kf_theme')||'auto')==='auto'){ root.setAttribute('data-theme', sysDark()?'dark':'light'); } }); }
    })();

    /* ====== Firebase ====== */
    const db=firebase.firestore(), auth=firebase.auth();

    /* ===== UI yardımcıları ===== */
    function showToast(msg){const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); clearTimeout(window.__to); window.__to=setTimeout(()=>t.classList.remove('show'),3000);}

    const norm = s => String(s||'').trim().toLowerCase();
    function setToday(){
      const d=new Date(); const days=['Pazar','Pazartesi','Salı','Çarşamba','Perşembe','Cuma','Cumartesi'];
      document.getElementById('todayText').textContent=`${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()} • ${days[d.getDay()]}`;
    }

    /* ===== Bildirim & Profil menüleri ===== */
    (function(){
      const btnN = document.getElementById('btnNotif');
      const dropN= document.getElementById('notifDropdown');
      const btnP = document.getElementById('btnProfile');
      const dropP= document.getElementById('profDropdown');
      function toggle(el,btn){ btn.classList.toggle('open'); el.style.display = btn.classList.contains('open') ? 'block' : 'none'; }
      btnN.addEventListener('click',(e)=>{ e.stopPropagation(); btnP.classList.remove('open'); dropP.style.display='none'; toggle(dropN,btnN); });
      btnP.addEventListener('click',(e)=>{ e.stopPropagation(); btnN.classList.remove('open'); dropN.style.display='none'; toggle(dropP,btnP); });
      document.addEventListener('click',()=>{ btnN.classList.remove('open'); btnP.classList.remove('open'); dropN.style.display='none'; dropP.style.display='none'; });
      document.getElementById('btnLogout').addEventListener('click',(e)=>{ e.preventDefault(); auth.signOut().then(()=>location.replace('../index.html')); });
    })();

    /* ===== Nav Manifest (link normalizasyonu) ===== */
    let CURRENT_ALLOW = new Set(), CURRENT_DENY = new Set();
    const PANEL_ICON = { 'Admin':'🎛️','Talebe':'📘','Personel':'👤','Muhasebe':'💰','Kermes':'🏪','Nehari':'🕌','Sistem Ayarları':'⚙️' };
    function resolveHref(path){
      if(!path) return '#';
      if(/^https?:\/\//i.test(path)) return path;
      if(path.startsWith('./') || path.startsWith('../')) return path;
      const inAdmin = location.pathname.includes('/admin/');
      // manifestte "admin/..." verilmişse ve şu an admin altındaysak gereksiz ön eki kaldır
      if(inAdmin){
        if(path.startsWith('admin/')) return '../' + path.replace(/^admin\//,'');
        return '../' + path.replace(/^\/+/,''); // köke göre verilenleri bir seviye yukarı taşı
      }else{
        return path.startsWith('/') ? path : ('./' + path);
      }
    }
    async function fetchPanels(allowSet, denySet){
      const res=[]; try{
        const snap=await db.collection('sayfa_manifesti').get();
        snap.forEach(doc=>{
          const d=doc.data()||{}, id=doc.id;
          const panelTitle=d.title||id;
          const panelGrant = allowSet.has(norm(id)) || allowSet.has(norm(panelTitle));
          let pages = Array.isArray(d.pages)? d.pages : [];
          pages = pages.filter(pg=>{
            const keyNorm = norm(pg.key || pg.title || '');
            const pageGrant = allowSet.has(keyNorm);
            const denied    = denySet.has(keyNorm);
            return !denied && (panelGrant || pageGrant);
          }).map(pg=>({ baslik: pg.title || pg.key || 'Sayfa', url: resolveHref(pg.path || '#'), key: pg.key || pg.title || '', sira: typeof pg.order==='number'?pg.order:9999 })).sort((a,b)=>a.sira-b.sira);
          if(pages.length) res.push({ id, baslik:panelTitle, ikon:d.icon||PANEL_ICON[id]||'📁', sira: typeof d.order==='number'?d.order:9999, pages });
        });
        res.sort((a,b)=>a.sira-b.sira);
      }catch(e){ console.warn(e); }
      return res;
    }
    function renderNav(panels){
      const ul=document.getElementById('navMain'), drawer=document.getElementById('drawer');
      ul.innerHTML=''; drawer.innerHTML='';
      if(!panels.length){ ul.innerHTML='<li class="nav-item"><div class="nav-btn">Menü Yok</div></li>'; return; }
      panels.forEach(p=>{
        const li=document.createElement('li'); li.className='nav-item';
        li.innerHTML=`<div class="nav-btn">${p.baslik} <span class="caret">▾</span></div>`;
        const dd=document.createElement('div'); dd.className='dropdown';
        (p.pages||[]).forEach(pg=>{ const a=document.createElement('a'); a.href=pg.url; a.textContent=pg.baslik; a.dataset.key=pg.key||pg.baslik; a.dataset.panel=p.id; a.dataset.panelTitle=p.baslik; dd.appendChild(a); });
        li.appendChild(dd);
        li.querySelector('.nav-btn').addEventListener('click',(e)=>{ e.stopPropagation(); ul.querySelectorAll('.nav-item').forEach(x=>{ if(x!==li) x.classList.remove('open'); }); li.classList.toggle('open'); });
        ul.appendChild(li);
      });
      document.addEventListener('click',(e)=>{ if(!ul.contains(e.target)) ul.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('open')); });

      panels.forEach(p=>{
        const h=document.createElement('div'); h.className='panel-title'; h.textContent=p.baslik; drawer.appendChild(h);
        (p.pages||[]).forEach(pg=>{ const a=document.createElement('a'); a.href=pg.url; a.textContent=pg.baslik; a.dataset.key=pg.key||pg.baslik; a.dataset.panel=p.id; a.dataset.panelTitle=p.baslik; drawer.appendChild(a); });
      });
      const hamb=document.getElementById('hamburger');
      hamb?.addEventListener('click',()=>drawer.classList.toggle('open'));
      document.addEventListener('click',(e)=>{ if(!drawer.contains(e.target) && !hamb?.contains(e.target)) drawer.classList.remove('open'); });
    }
    document.addEventListener('click', (e) => {
      const a = e.target.closest('a[data-key]'); if (!a) return;
      const key = norm(a.dataset.key), pnl = norm(a.dataset.panel||''), pnlTitle = norm(a.dataset.panelTitle||'');
      if (CURRENT_DENY.has(key)) { e.preventDefault(); showToast('Bu sayfa için yetkiniz yok.'); return; }
      const allowed = CURRENT_ALLOW.has(key) || CURRENT_ALLOW.has(pnl) || CURRENT_ALLOW.has(pnlTitle);
      if (!allowed) { e.preventDefault(); showToast('Bu sayfa için yetkiniz yok.'); }
    });

    /* ===== Sayfa özgü: Nöbet planlayıcı ===== */
    const inpTarih=document.getElementById('inpTarih');
    const inpIhvan=document.getElementById('inpIhvan');
    const inpBekar=document.getElementById('inpBekar');
    const inpEvli=document.getElementById('inpEvli');
    const selOtoPazar=document.getElementById('selOtoPazar');
    const tbody=document.getElementById('tbody');
    const existInfo=document.getElementById('existInfo');
    const btnHaftaSil=document.getElementById('btnHaftaSil');

    function pad(n){return n<10?'0'+n:''+n}
    function toISO(d){return d.toISOString().split('T')[0]}
    function isoWeek(date){
      const d=new Date(Date.UTC(date.getFullYear(),date.getMonth(),date.getDate()));
      const day=d.getUTCDay()||7; d.setUTCDate(d.getUTCDate()+4-day);
      const yStart=new Date(Date.UTC(d.getUTCFullYear(),0,1));
      const w=Math.ceil((((d-yStart)/86400000)+1)/7);
      return {isoYear:d.getUTCFullYear(),weekNo:w}
    }
    function buildWeek(date){ const d=new Date(date); const off=(d.getDay()+6)%7; const pzt=new Date(d); pzt.setDate(d.getDate()-off); const arr=[]; for(let i=0;i<7;i++){ const x=new Date(pzt); x.setDate(pzt.getDate()+i); arr.push(x);} return arr; }
    const DAYS=["Pazartesi","Salı","Çarşamba","Perşembe","Cuma","Cumartesi","Pazar"];
    const FULLDAY="09:00 → ertesi 09:00";
    const PZ_GUN="08:00 → 19:30";           // evli (özel pazar)
    const PZ_BEKAR="18:00 → ertesi 09:00";  // bekâr (özel pazar)

    /* ---- Önceki haftadan türetme ---- */
    function mapFromPrevWeek(prevRows, isSpecialPazarCurr){
      const byDay = Object.fromEntries(prevRows.map(r=>[r.gun,r]));
      const result = {};
      // EVLİ: örnek kural (isteğin doğrultusunda geri kaydırma & Pazartesi sabit ihvan)
      const mapEvli = {
        "Cumartesi": byDay["Salı"]?.evli || null,
        "Salı":      byDay["Çarşamba"]?.evli || null,
        "Çarşamba":  byDay["Perşembe"]?.evli || null,
        "Perşembe":  byDay["Cuma"]?.evli || null,
        "Cuma":      byDay["Cumartesi"]?.evli || null,
        "Pazar":     isSpecialPazarCurr ? (byDay["Pazar"]?.evli || null) : null,
        "Pazartesi": null // ihvan sabit
      };
      // BEKÂR: 1 gün geri kaydırma (genel kural)
      const prevOrder = ["Pazartesi","Salı","Çarşamba","Perşembe","Cuma","Cumartesi","Pazar"];
      const back1 = d => prevOrder[(prevOrder.indexOf(d)+1)%7]; // “geri” = bir sonraki günün kişisi
      const mapBekar = Object.fromEntries(prevOrder.map(day => [day, byDay[back1(day)]?.bekar || null]));
      return {evli:mapEvli, bekar:mapBekar};
    }

    function makeSelect(options,val,onChange,disabled){
      const s=document.createElement('select'); s.className="inline"; if(disabled) s.disabled=true;
      const o0=document.createElement('option'); o0.value=""; o0.textContent="—"; s.appendChild(o0);
      options.forEach(o=>{ const op=document.createElement('option'); op.value=o; op.textContent=o; if(o===val) op.selected=true; s.appendChild(op); });
      s.addEventListener('change',()=>onChange(s.value||null)); return s;
    }

    function drawPlan(plan){
      const tb=document.getElementById('tbody'); tb.innerHTML="";
      document.getElementById('sumPazar').textContent=plan.isPazarTehir?"Tehir":(plan.isSpecialPazar?"Var":"Yok");
      const bOps=(inpBekar.value||'').split(',').map(x=>x.trim()).filter(Boolean);
      const eOps=(inpEvli.value||'').split(',').map(x=>x.trim()).filter(Boolean);
      plan.rows.forEach(r=>{
        const tr=document.createElement('tr');
        const tdG=document.createElement('td'); tdG.textContent=r.gun;
        const tdD=document.createElement('td'); tdD.textContent=r.tarihISO;
        const tdS=document.createElement('td'); tdS.innerHTML=`<span class="time">${r.saat}</span>`;
        const tdB=document.createElement('td'); const tdE=document.createElement('td'); const tdN=document.createElement('td');

        if(r.gun==="Cumartesi" && plan.isSpecialPazar){ tdB.innerHTML=`<span class="muted">—</span>`; }
        else{ tdB.appendChild(makeSelect(bOps,r.bekar,v=>r.bekar=v)); }

        if(r.gun==="Pazartesi"){
          const ih=plan.ihvan || inpIhvan.value.trim();
          tdE.appendChild(makeSelect([ih], ih, v=>r.evli=v, true));
        }else if(r.gun==="Pazar" && plan.isSpecialPazar && !plan.isPazarTehir){
          tdE.appendChild(makeSelect(eOps,r.evli,v=>r.evli=v));
        }else if(r.gun==="Pazar"){
          tdE.innerHTML=`<span class="muted">—</span>`;
        }else{
          tdE.appendChild(makeSelect(eOps,r.evli,v=>r.evli=v));
        }

        tdN.textContent=r.not||"—";
        tr.append(tdG,tdD,tdS,tdB,tdE,tdN); tb.appendChild(tr);
      });
    }

    function planFromInputs(date, prevPlanOrNull){
      const iso=isoWeek(date); const weekDates=buildWeek(date);
      const isAuto = (selOtoPazar.value==="auto") ? (iso.weekNo%2===0) : false;
      const isSpecial = document.getElementById('chkManPazar').checked || isAuto;
      const isTehir = document.getElementById('chkTehir').checked;
      const ihvan = inpIhvan.value.trim();

      let rows=[];
      if(prevPlanOrNull){
        // Önceki haftadan türet
        const maps = mapFromPrevWeek(prevPlanOrNull.rows||[], isSpecial && !isTehir);
        DAYS.forEach((g,i)=>{
          const tarihISO=toISO(weekDates[i]); const monthKey=tarihISO.slice(0,7);
          let saat = FULLDAY, not="";
          let bekar = maps.bekar[g] ?? null;
          let evli  = maps.evli[g]  ?? null;

          if(g==="Pazar" && isSpecial && !isTehir){
            saat=`${PZ_BEKAR} (bekâr) + ${PZ_GUN} (evli)`;
            not="Özel Pazar (önceki haftadan türetildi)";
          }else if(g==="Pazar"){
            evli=null; not=isTehir?"Pazar tehir":"Normal Pazar — evli yok";
          }else if(g==="Pazartesi"){
            evli=ihvan; not="Pazartesi sabit ihvan";
          }
          if(g==="Cumartesi" && isSpecial){ bekar=null; not = (not?not+'; ':'')+"Cumartesi bekâr yok (özel pazar)"; }

          rows.push({gun:g,tarihISO,monthKey,saat,bekar,evli,not});
        });
        return {isoYear:iso.isoYear,weekNo:iso.weekNo,isSpecialPazar:isSpecial,isPazarTehir:isTehir,pazarEvli:rows.find(r=>r.gun==='Pazar')?.evli||null, ihvan, rows};
      }

      // Sıfırdan (mevcut algoritman)
      const bekarList=(inpBekar.value||'').split(',').map(x=>x.trim()).filter(Boolean);
      const evliList =(inpEvli.value||'').split(',').map(x=>x.trim()).filter(Boolean);
      const bStart=bekarList.length?(iso.weekNo%bekarList.length):0;
      const eStart=evliList.length?(iso.weekNo%evliList.length):0;
      const rotate=(a,i)=>{ if(!a.length) return []; const k=((i%a.length)+a.length)%a.length; return a.slice(k).concat(a.slice(0,k)); }
      let bSeq=rotate(bekarList,bStart); let eSeq=rotate(evliList,eStart);
      const pazarEvli=(isSpecial&&evliList.length)?eSeq[0]:null;

      DAYS.forEach((g,i)=>{
        let bekar=null, evli=null, saat=FULLDAY, not="";
        const tarihISO=toISO(weekDates[i]); const monthKey=tarihISO.slice(0,7);

        if(g==="Pazartesi"){
          bekar=bSeq[0]||null; if(bekar) bSeq=rotate(bSeq,1);
          evli=ihvan||null; not="Pazartesi sabit ihvan";
        } else if(["Salı","Çarşamba","Perşembe","Cuma"].includes(g)){
          bekar=bSeq[0]||null; if(bekar) bSeq=rotate(bSeq,1);
          evli=eSeq[0]||null;  if(evli)  eSeq=rotate(eSeq,1);
        } else if(g==="Cumartesi"){
          if(isSpecial){ bekar=null; not="Özel Pazar haftası → Cumartesi bekâr yok"; }
          else{ bekar=bSeq[0]||null; if(bekar) bSeq=rotate(bSeq,1); }
          if(evliList.length){
            let chosen=null,k=0;
            while(k<eSeq.length){
              const cand=eSeq[k];
              if(!(isSpecial && pazarEvli && cand===pazarEvli)){ chosen=cand; break; }
              k++;
            }
            if(chosen){ evli=chosen; eSeq=rotate(eSeq,k+1); }
            else{ evli=eSeq[0]||null; if(evli) eSeq=rotate(eSeq,1); }
          }
        } else if(g==="Pazar"){
          if(isSpecial && !isTehir){
            bekar=bSeq[0]||null; if(bekar) bSeq=rotate(bSeq,1);
            evli=pazarEvli;
            saat=`${PZ_BEKAR} (bekâr) + ${PZ_GUN} (evli)`; not="Özel Pazar";
            if(evli){ const ix=eSeq.indexOf(evli); if(ix>=0) eSeq=rotate(eSeq,ix+1); }
          } else {
            bekar=bSeq[0]||null; if(bekar) bSeq=rotate(bSeq,1);
            evli=null; not=isTehir?"Pazar tehir":"Normal Pazar — evli yok";
          }
        }
        rows.push({gun:g,tarihISO,monthKey,saat,bekar,evli,not});
      });

      return {isoYear:iso.isoYear,weekNo:iso.weekNo,isSpecialPazar:isSpecial,isPazarTehir:isTehir,pazarEvli, ihvan, rows};
    }

    function renderWeekBadge(d){
      const {isoYear,weekNo}=isoWeek(d);
      document.getElementById('outWeek').textContent=`${isoYear}-W${('0'+weekNo).slice(-2)}`;
    }

    async function saveAyarIf(){
      if(!document.getElementById('chkAyarKaydet').checked) return;
      await db.collection('nobet_ayar').doc('genel').set({
        bekarlar:(inpBekar.value||'').split(',').map(x=>x.trim()).filter(Boolean),
        evliler: (inpEvli.value||'').split(',').map(x=>x.trim()).filter(Boolean),
        ihvan:   inpIhvan.value.trim(),
        otoPazar:selOtoPazar.value
      },{merge:true});
    }

    async function savePlan(plan){
      const weekKey=`${plan.isoYear}-W${('0'+plan.weekNo).slice(-2)}`;
      // 1) Bu haftanın mevcut index kayıtlarını temizle
      const idxCol = db.collection('nobet_index');
      const old = await idxCol.where('weekKey','==',weekKey).get();
      let batch = db.batch(); let i=0;
      old.forEach(doc=>{ batch.delete(doc.ref); if(++i%450===0){ /* commit parça parça*/ }});
      if(i) await batch.commit();

      // 2) Plan belgesi ve yeni index kayıtları
      batch = db.batch();
      const planRef = db.collection('nobet_planlari').doc(weekKey);
      batch.set(planRef,{
        weekKey, isoYear:plan.isoYear, weekNo:plan.weekNo,
        isSpecialPazar:plan.isSpecialPazar, isPazarTehir:plan.isPazarTehir, pazarEvli:plan.pazarEvli||null,
        rows:plan.rows, ihvan:plan.ihvan||null,
        updatedAt:firebase.firestore.FieldValue.serverTimestamp(), updatedBy:auth.currentUser?auth.currentUser.uid:null
      },{merge:true});

      plan.rows.forEach(r=>{
        if(r.bekar){
          const type=(r.gun==="Pazar" && plan.isSpecialPazar && !plan.isPazarTehir)?"pazar-aksam":"24s";
          batch.set(idxCol.doc(),{
            weekKey,date:r.tarihISO,day:r.gun,person:r.bekar,role:"bekar",
            saat:type==="pazar-aksam"?"18:00→09:00":"09:00→09:00", type, monthKey:r.monthKey, year:r.tarihISO.slice(0,4),
            createdAt:firebase.firestore.FieldValue.serverTimestamp()
          });
        }
        if(r.evli){
          const type=(r.gun==="Pazar" && plan.isSpecialPazar && !plan.isPazarTehir)?"pazar-gunduz":"24s";
          batch.set(idxCol.doc(),{
            weekKey,date:r.tarihISO,day:r.gun,person:r.evli,role:(r.gun==="Pazartesi"?"ihvan":"evli"),
            saat:type==="pazar-gunduz"?"08:00→19:30":"09:00→09:00", type, monthKey:r.monthKey, year:r.tarihISO.slice(0,4),
            createdAt:firebase.firestore.FieldValue.serverTimestamp()
          });
        }
      });

      await batch.commit();
      await saveAyarIf();
      showToast("✅ Plan kaydedildi.");
    }

    /* ==== Auth ve init ==== */
    function setDefaults(){
      const t=new Date(); const iso=`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}-${String(t.getDate()).padStart(2,'0')}`;
      document.getElementById('inpTarih').value=iso;
      renderWeekBadge(t);
    }

    try{ firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL); }catch(e){}

    auth.onAuthStateChanged(async (user)=>{
      if(!user){ setTimeout(()=>{ if(!auth.currentUser) location.replace('../index.html'); },150); return; }
      try{
        setToday();
        const uSnap = await db.collection('kullanicilar').doc(user.uid).get();
        const data  = uSnap.exists ? uSnap.data() : {};
        document.getElementById('username').textContent = data.adSoyad || user.email || 'Kullanıcı';
        document.getElementById('profName').textContent = data.adSoyad?.split(' ')[0] || 'Profil';

        // yetkiler
        const rawPerms = Array.isArray(data.yetkiler) ? data.yetkiler : [];
        CURRENT_ALLOW = new Set(rawPerms.filter(s=>!String(s).trim().startsWith('-') && !String(s).trim().startsWith('!')).map(norm));
        CURRENT_DENY  = new Set(rawPerms.filter(s=>String(s).trim().startsWith('-') || String(s).trim().startsWith('!')).map(s=>norm(String(s).replace(/^[-!]\s*/,''))));

        const panels = await fetchPanels(CURRENT_ALLOW, CURRENT_DENY);
        renderNav(panels);

        // Ayarları yükle
        try{
          const snap=await db.collection('nobet_ayar').doc('genel').get();
          if(snap.exists){
            const a=snap.data();
            if(a.bekarlar) inpBekar.value=a.bekarlar.join(',');
            if(a.evliler)  inpEvli.value=a.evliler.join(',');
            if(a.ihvan)    inpIhvan.value=a.ihvan;
            if(a.otoPazar) selOtoPazar.value=a.otoPazar;
          }
        }catch(e){ console.warn(e); }
        setDefaults();
      }catch(e){ console.error(e); showToast('Veriler yüklenirken hata.'); }
    });

    // Tarih değişikliği: hafta rozeti
    document.getElementById('inpTarih').addEventListener('change', (e)=>{ const d=new Date(e.target.value+"T12:00:00"); renderWeekBadge(d); });

    let lastPlan=null, lastWeekKey=null, loadedExisting=false;

    // Planı oluştur / yükle
    document.getElementById('btnOlustur').addEventListener('click', async ()=>{
      const val = inpTarih.value; if(!val){ showToast('Tarih seçin'); return; }
      const d=new Date(val+"T12:00:00");
      const {isoYear,weekNo}=isoWeek(d);
      const weekKey=`${isoYear}-W${('0'+weekNo).slice(-2)}`;

      // Hafta var mı?
      const exist = await db.collection('nobet_planlari').doc(weekKey).get();
      if(exist.exists){
        const planDoc = exist.data();
        showToast('ℹ️ Seçili tarihte daha önceden plan var. Yüklendi.');
        existInfo.style.display='block';
        existInfo.textContent = `Bu hafta (${weekKey}) mevcut plan düzenleniyor. Kaydedersen üzerine yazılır.`;
        btnHaftaSil.style.display='inline-block';

        // UI'ya doldur
        inpIhvan.value = planDoc.ihvan || inpIhvan.value;
        document.getElementById('chkTehir').checked = !!planDoc.isPazarTehir;
        document.getElementById('chkManPazar').checked = !!planDoc.isSpecialPazar;

        lastPlan = { isoYear, weekNo, isSpecialPazar:!!planDoc.isSpecialPazar, isPazarTehir:!!planDoc.isPazarTehir, pazarEvli:planDoc.pazarEvli||null, ihvan: planDoc.ihvan||inpIhvan.value, rows: planDoc.rows||[] };
        drawPlan(lastPlan);
        lastWeekKey = weekKey;
        return;
      }

      // Yoksa: bir önceki haftaya bak
      const prevKey = (wk=>{ const [y, w]=wk; let Y=y, W=w-1; if(W===0){ Y=y-1; W=53; } return `${Y}-W${String(W).padStart(2,'0')}`; })([isoYear, weekNo]);
      const prevDoc = await db.collection('nobet_planlari').doc(prevKey).get();
      const prevPlan = prevDoc.exists ? prevDoc.data() : null;

      lastPlan = planFromInputs(d, prevPlan);
      drawPlan(lastPlan);
      existInfo.style.display='none';
      btnHaftaSil.style.display='none';
      lastWeekKey = weekKey;
    });

    // Planı kaydet
    document.getElementById('btnKaydet').addEventListener('click', async ()=>{
      if(!lastPlan){ showToast('Önce planı oluşturun veya yükleyin.'); return; }
      try{
        // tabloda yapılan değişiklikler lastPlan.rows içine zaten yazılıyor (select onChange)
        await savePlan(lastPlan);
      }catch(e){ console.error(e); showToast('Kaydetme hatası.'); }
    });

    // Bu haftayı tamamen sil
    btnHaftaSil.addEventListener('click', async ()=>{
      if(!lastWeekKey){ showToast('Hafta bulunamadı.'); return; }
      if(!confirm(`${lastWeekKey} haftasındaki plan ve index kayıtları silinsin mi?`)) return;
      // plan sil
      await db.collection('nobet_planlari').doc(lastWeekKey).delete().catch(()=>{});
      // index sil
      const idx = await db.collection('nobet_index').where('weekKey','==',lastWeekKey).get();
      let batch=db.batch(); let i=0;
      idx.forEach(doc=>{ batch.delete(doc.ref); if(++i%450===0){/* parça commit edilebilir */}});
      if(i) await batch.commit();
      showToast('🗑️ Hafta silindi.');
      document.getElementById('tbody').innerHTML='';
      existInfo.style.display='none'; btnHaftaSil.style.display='none';
      lastPlan=null; lastWeekKey=null;
    });

    // Bildirim listesine sahte içerik (bağla: Firestore bildirimlerin varsa oradan çek)
    (function seedNotif(){
      const list=document.getElementById('notifList');
      list.innerHTML = `
        <div class="drop-row"><span>Nöbet planı güncellendi</span><span class="muted">az önce</span></div>
        <div class="drop-row"><span>Temizlik raporu yayımlandı</span><span class="muted">1s</span></div>
      `;
      const badge=document.getElementById('notifBadge'); badge.style.display='inline-block'; badge.textContent='2';
    })();

    // Başlangıç
    setToday();

  </script>
</body>
</html>
