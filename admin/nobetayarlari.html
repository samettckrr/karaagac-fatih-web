<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>NÃ¶bet Ayarla | KaraaÄŸaÃ§ Fatih</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" type="image/png" href="../img/logo.png" />
  <link rel="stylesheet" href="../css/app-shell.css" />
  
  <style>
    /* app-shell.css Ã¼st bar/arka plan/toast/yetki yapÄ±sÄ±nÄ± kullanÄ±r.
       Burada sadece sayfa-Ã¶zel kÃ¼Ã§Ã¼k dÃ¼zenlemeler var. */
    body {
      padding-top: var(--appbar-h) !important;
      overflow-x: hidden;
      overflow-y: auto;
    }

    /* Drawer masaÃ¼stÃ¼nde kapalÄ± kalmalÄ± */
    @media (min-width: 1025px) {
      .drawer {
        transform: translateX(100%) !important;
      }

      .drawer.open {
        transform: translateX(0) !important;
      }
    }

    /* CONTENT */
    .container{max-width:1200px; margin:0 auto; padding:16px}
    .hero{display:flex; justify-content:space-between; align-items:flex-start; gap:16px; background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius); padding:16px; margin:16px 0; box-shadow:var(--shadow)}
    .hero h2{margin:0 0 6px; font-size:20px}
    .hero-sub{color:var(--muted); font-size:13px}
    .mini{display:flex; gap:8px; flex-wrap:wrap}
    .pill{padding:6px 10px; border-radius:999px; border:1px solid var(--stroke); background:var(--pill); font-size:12px}

    .grid{display:grid; gap:14px; grid-template-columns:repeat(12, minmax(0,1fr))}
    .col-3{grid-column:span 3} .col-4{grid-column:span 4} .col-6{grid-column:span 6} .col-8{grid-column:span 8} .col-12{grid-column:span 12}
    .card{background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px}
    .card h3{margin:0 0 10px; font-size:16px}
    .form-grid{display:grid; gap:12px; grid-template-columns:repeat(12, minmax(0,1fr))}
    .fg-4{grid-column:span 4} .fg-6{grid-column:span 6} .fg-12{grid-column:span 12}
    label{display:block; font-size:12px; color:var(--muted); margin:0 0 6px}
    input[type="text"],input[type="date"],select{
      width:100%; padding:10px 12px; border:1px solid var(--stroke); border-radius:12px; background:var(--pill); color:var(--text); outline:none
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .soft{background:var(--surface); border:1px solid var(--stroke); color:var(--text)}
    .right{display:flex; gap:8px; justify-content:flex-end}

    table{width:100%; border-collapse:collapse; margin-top:8px}
    th,td{border-bottom:1px solid var(--stroke); padding:10px 8px; text-align:left}
    thead th{font-size:12px; color:var(--muted)}
    .time{font-variant-numeric:tabular-nums; font-weight:700; color:var(--brand2)}
    .inline{min-width:150px}

    /* Toast sistemi ortak.js'den geliyor */

    /* SEKMELER */
    .tabs{display:flex; gap:8px; border-bottom:2px solid var(--stroke); margin-bottom:16px; overflow-x:auto; -webkit-overflow-scrolling:touch}
    .tab{flex:0 0 auto; padding:12px 20px; background:transparent; border:none; border-bottom:3px solid transparent; color:var(--muted); cursor:pointer; font-weight:600; font-size:14px; transition:all .2s; white-space:nowrap; min-height:44px; display:flex; align-items:center; touch-action:manipulation; -webkit-tap-highlight-color:transparent}
    .tab:hover{color:var(--text); background:var(--surface)}
    .tab:active{transform:scale(0.98); background:var(--pill)}
    .tab.active{color:var(--brand); border-bottom-color:var(--brand); background:var(--surface)}
    .tab-content{display:none}
    .tab-content.active{display:block; animation:fadeIn .3s}
    @keyframes fadeIn{from{opacity:0; transform:translateY(8px)} to{opacity:1; transform:translateY(0)}}
    
    /* Ä°STATÄ°STÄ°KLER */
    .stat-grid{display:grid; gap:14px; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr))}
    .stat-card{background:var(--pill); border:1px solid var(--stroke); border-radius:var(--radius); padding:16px; text-align:center}
    .stat-card .val{font-size:32px; font-weight:900; color:var(--brand); margin:8px 0}
    .stat-card .label{font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:.5px}
    .chart-container{background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius); padding:20px; margin:16px 0}
    .chart-title{font-size:16px; font-weight:700; margin-bottom:16px; color:var(--text)}
    
    /* GEÃ‡MÄ°Å */
    .history-filters{display:flex; gap:10px; flex-wrap:wrap; margin-bottom:16px; padding:12px; background:var(--pill); border-radius:var(--radius)}
    .history-table-wrapper{overflow-x:auto; max-height:600px; overflow-y:auto}
    .history-table{width:100%; border-collapse:collapse}
    .history-table th{position:sticky; top:0; background:var(--card); z-index:10; padding:12px; text-align:left; font-size:12px; color:var(--muted); border-bottom:2px solid var(--stroke)}
    .history-table td{padding:10px 12px; border-bottom:1px solid var(--stroke); min-height:44px; display:table-cell; vertical-align:middle}
    .history-table tr:hover{background:var(--surface)}
    .history-table tr:active{background:var(--pill)}
    
    /* TOUCH-FRIENDLY */
    button, .iconbtn, .btn, input[type="button"], input[type="submit"]{
      min-height:44px; min-width:44px; touch-action:manipulation; -webkit-tap-highlight-color:transparent;
      user-select:none; -webkit-user-select:none
    }
    input[type="text"], input[type="date"], select, textarea{
      min-height:44px; font-size:16px; touch-action:manipulation
    }
    @media (max-width: 768px){
      input[type="text"], input[type="date"], select{font-size:16px !important}
    }
    
    /* DASHBOARD */
    .dashboard-grid{display:grid; gap:16px; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr))}
    .dashboard-card{background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius); padding:20px; box-shadow:var(--shadow)}
    .dashboard-card h4{margin:0 0 12px; font-size:14px; color:var(--muted); text-transform:uppercase; letter-spacing:.5px}
    .dashboard-card .big-val{font-size:48px; font-weight:900; color:var(--brand); margin:8px 0; line-height:1}
    .dashboard-card .trend{display:flex; align-items:center; gap:8px; margin-top:8px; font-size:12px}
    .dashboard-card .trend.up{color:var(--ok)}
    .dashboard-card .trend.down{color:var(--danger)}
    .comparison-chart{display:flex; align-items:flex-end; gap:8px; height:200px; margin-top:16px; padding:12px; background:var(--pill); border-radius:8px; overflow-x:auto; -webkit-overflow-scrolling:touch}
    .comparison-bar{flex:1; background:linear-gradient(180deg, var(--brand), var(--brand2)); border-radius:4px 4px 0 0; min-height:4px; position:relative; cursor:pointer; transition:opacity .2s; min-width:30px}
    .comparison-bar:hover{opacity:.8}
    .comparison-bar::after{content:attr(data-val); position:absolute; top:-24px; left:50%; transform:translateX(-50%); font-size:11px; font-weight:700; color:var(--text); white-space:nowrap; z-index:5; background:var(--card); padding:2px 4px; border-radius:4px; border:1px solid var(--stroke)}
    .month-label{text-align:center; font-size:11px; color:var(--muted); margin-top:8px; min-width:40px}
    .comparison-bar-wrapper{flex:1; display:flex; flex-direction:column; align-items:center; gap:2px; min-width:30px}
    .comparison-bar-group{display:flex; flex-direction:row; align-items:flex-end; gap:2px; width:100%; height:100%; justify-content:center}
    
    /* RAPOR */
    .report-section{margin:24px 0; padding:20px; background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius)}
    .report-header{display:flex; justify-content:space-between; align-items:center; margin-bottom:16px; padding-bottom:12px; border-bottom:2px solid var(--stroke)}
    .report-header h3{margin:0; font-size:18px}
    .report-actions{display:flex; gap:8px}
    .report-table{width:100%; border-collapse:collapse; margin-top:12px}
    .report-table th{background:var(--pill); padding:12px; text-align:left; font-size:12px; color:var(--muted); font-weight:700; border-bottom:2px solid var(--stroke)}
    .report-table td{padding:10px 12px; border-bottom:1px solid var(--stroke)}
    .report-table tr:last-child td{border-bottom:none}
    .report-summary{display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:12px; margin-top:16px; padding:16px; background:var(--pill); border-radius:8px}
    .report-summary-item{text-align:center}
    .report-summary-item .label{font-size:11px; color:var(--muted); text-transform:uppercase; margin-bottom:4px}
    .report-summary-item .value{font-size:24px; font-weight:900; color:var(--brand)}
    
    /* AYARLAR KARTI Ä°YÄ°LEÅTÄ°RMELERÄ° */
    .option-card:hover{background:var(--surface); border-color:var(--brand); transform:translateY(-2px); box-shadow:0 4px 12px rgba(0,0,0,.1)}
    .option-card input[type="checkbox"]:checked + div{color:var(--brand)}
    .option-card:has(input:checked){border-color:var(--brand); background:rgba(14,165,233,.08)}
    input[type="text"]:focus, input[type="date"]:focus, select:focus{
      border-color:var(--brand); box-shadow:0 0 0 3px rgba(14,165,233,.1); outline:none
    }
    
    /* MOBÄ°L WEEK INDICATOR */
    @media (max-width: 768px){
      .week-indicator{padding:8px !important; border-radius:8px !important}
      .week-indicator > div:first-child{font-size:9px !important; margin-bottom:3px !important}
      .week-indicator > div:last-child{font-size:14px !important}
    }
    @media (max-width: 480px){
      .week-indicator{padding:6px !important; border-radius:6px !important}
      .week-indicator > div:first-child{font-size:8px !important; margin-bottom:2px !important}
      .week-indicator > div:last-child{font-size:12px !important}
    }

    @media (max-width: 1024px){ .nav-center{display:none} .hamb{display:inline-flex} }
    @media (max-width: 960px){
      .col-3{grid-column:span 6} .col-4{grid-column:span 6} .col-6{grid-column:span 6} .col-8{grid-column:span 6} .col-12{grid-column:span 12}
      .hero{flex-direction:column}
      .dashboard-grid{grid-template-columns:1fr}
      .comparison-chart{gap:4px; padding:8px}
      .comparison-bar-wrapper{min-width:25px}
    }
    @media (max-width: 768px){
      .container{padding:8px; overflow-x:hidden; max-width:100vw}
      .card{padding:12px; overflow-x:hidden; border-radius:8px}
      .tabs{overflow-x:auto; -webkit-overflow-scrolling:touch; padding-bottom:4px; margin-left:-8px; margin-right:-8px; padding-left:8px; padding-right:8px}
      .tab{padding:8px 12px; font-size:12px; min-width:auto; border-radius:6px}
      .dashboard-card .big-val{font-size:28px}
      .report-header{flex-direction:column; align-items:flex-start; gap:8px}
      .report-summary{grid-template-columns:repeat(2, 1fr); gap:8px; padding:12px}
      .comparison-chart{height:160px; gap:3px; padding:6px}
      .comparison-bar-wrapper{min-width:18px}
      .month-label{font-size:9px}
      .comparison-bar::after{font-size:9px; top:-18px}
      
      /* AYARLAR KARTI MOBÄ°L */
      .form-grid{gap:10px}
      .fg-4, .fg-6, .fg-12{grid-column:span 12}
      .option-card{grid-column:span 1; padding:8px; gap:8px; border-radius:8px}
      .option-card > div{font-size:11px}
      .option-card > div > div:first-child{font-size:12px; margin-bottom:2px}
      .option-card > div > div:last-child{font-size:10px}
      .option-card input[type="checkbox"]{width:16px; height:16px}
      .row{flex-direction:column; gap:6px}
      input[type="text"], input[type="date"], select{width:100%; font-size:14px !important; padding:8px 10px; border-radius:6px}
      label{font-size:12px; margin-bottom:6px}
      label span{font-size:11px}
      
      /* BUTONLAR MOBÄ°L */
      .row.right{flex-direction:column; width:100%; gap:8px}
      .row.right .iconbtn{width:100%; justify-content:center; padding:10px 14px; font-size:13px; border-radius:8px}
      
      /* HERO MOBÄ°L */
      .hero{padding:10px; flex-direction:column; gap:8px; border-radius:8px}
      .hero h2{font-size:16px; margin:0}
      .hero-sub{font-size:11px; margin-top:4px}
      .mini{flex-wrap:wrap; gap:4px; margin-top:6px}
      .pill{font-size:10px; padding:4px 8px; border-radius:6px}
      
      /* KART BAÅLIKLARI */
      .card h3{font-size:16px; margin-bottom:12px}
      section.card > div:first-child{margin-bottom:10px; padding-bottom:10px; gap:8px}
      section.card > div:first-child > div:first-child{width:36px; height:36px; font-size:18px; border-radius:8px}
      section.card > div:first-child h3{font-size:16px}
      section.card > div:first-child > div:last-child > div:last-child{font-size:11px; margin-top:2px}
      
      /* NOT KUTUSU MOBÄ°L */
      section.card > div:nth-child(2){padding:8px 10px !important; margin-bottom:12px !important; font-size:11px !important; border-radius:5px !important}
      section.card > div:nth-child(2) > div{gap:5px !important}
      section.card > div:nth-child(2) span:first-child{font-size:12px !important}
      section.card > div:nth-child(2) strong{font-size:11px !important}
      section.card > div:nth-child(2) span[style*="monospace"]{font-size:10px !important; padding:1px 3px !important}
      
      /* TABLO MOBÄ°L */
      table{font-size:12px}
      th, td{padding:6px 8px}
      th{font-size:11px}
      
      /* DASHBOARD MOBÄ°L */
      .dashboard-grid{gap:10px}
      .dashboard-card{padding:12px; border-radius:8px}
      .dashboard-card h4{font-size:13px; margin-bottom:8px}
      .stat-item{padding:8px; border-radius:6px}
      .stat-item .label{font-size:10px}
      .stat-item .value{font-size:14px}
    }
    @media (max-width: 480px){
      .comparison-chart{height:140px; gap:2px; padding:4px}
      .comparison-bar-wrapper{min-width:16px}
      .month-label{font-size:8px}
      
      .container{padding:6px}
      .card{padding:10px; border-radius:6px}
      .hero{padding:8px; border-radius:6px}
      .hero h2{font-size:14px}
      .hero-sub{font-size:10px}
      .mini{gap:3px}
      .pill{font-size:9px; padding:3px 6px}
      
      .option-card{padding:6px; gap:6px; border-radius:6px}
      .option-card > div > div:first-child{font-size:11px}
      .option-card > div > div:last-child{font-size:9px}
      .option-card input[type="checkbox"]{width:14px; height:14px}
      
      .form-grid{gap:8px}
      input[type="text"], input[type="date"], select{padding:7px 9px; font-size:13px !important; border-radius:5px}
      label{font-size:11px; margin-bottom:5px}
      
      .row.right .iconbtn{padding:8px 12px; font-size:12px; border-radius:6px}
      
      .tabs{padding:4px; margin-left:-6px; margin-right:-6px; padding-left:6px; padding-right:6px}
      .tab{padding:6px 10px; font-size:11px; border-radius:5px}
      
      .card h3{font-size:14px}
      section.card > div:first-child{margin-bottom:8px; padding-bottom:8px}
      section.card > div:first-child > div:first-child{width:32px; height:32px; font-size:16px}
      section.card > div:first-child h3{font-size:14px}
      
      /* NOT KUTUSU MOBÄ°L KÃœÃ‡ÃœK */
      section.card > div:nth-child(2){padding:6px 8px !important; margin-bottom:10px !important; font-size:10px !important; border-radius:4px !important}
      section.card > div:nth-child(2) > div{gap:4px !important}
      section.card > div:nth-child(2) span:first-child{font-size:11px !important}
      section.card > div:nth-child(2) strong{font-size:10px !important}
      section.card > div:nth-child(2) span[style*="monospace"]{font-size:9px !important; padding:1px 2px !important}
      
      table{font-size:11px}
      th, td{padding:5px 6px}
      th{font-size:10px}
      
      .dashboard-card{padding:10px}
      .dashboard-card h4{font-size:12px}
      .stat-item{padding:6px}
      .stat-item .value{font-size:12px}
    }
    
    /* YAZDIRMA STÄ°LLERÄ° */
    @media print{
      *{box-shadow:none !important; text-shadow:none !important}
      body{background:#fff; color:#000; font-size:12pt; line-height:1.5}
      .appbar, .drawer, .tabs, .iconbtn, button, .report-actions, .history-filters, .form-grid, .hero, .nav-right, nav{display:none !important}
      .container{max-width:100%; padding:0; margin:0}
      .card, .report-section{page-break-inside:avoid; border:1px solid #000; padding:12pt; margin:12pt 0; background:#fff !important}
      .report-table{width:100%; border-collapse:collapse; font-size:10pt}
      .report-table th, .report-table td{border:1px solid #000; padding:6pt; text-align:left}
      .report-table th{background:#f0f0f0 !important; font-weight:bold}
      .report-summary{display:grid; grid-template-columns:repeat(4, 1fr); gap:8pt; page-break-inside:avoid}
      .report-summary-item .value{font-size:18pt}
      .comparison-chart, .chart-container{page-break-inside:avoid; height:auto !important; min-height:200px}
      .comparison-bar{min-width:20px !important}
      h1, h2, h3, h4{page-break-after:avoid; color:#000 !important}
      a{color:#000; text-decoration:underline}
      .muted{color:#666 !important}
    }
    /* === MasaÃ¼stÃ¼nde hamburger gÃ¶rÃ¼nmesin === */
    /* app-shell.css'de zaten var, burada override ediyoruz */
    @media (min-width: 1025px) {
.hamb{ display: none !important; }
}

/* App-shell.css'deki stiller kullanÄ±lÄ±yor, burada sadece sayfa Ã¶zel override'lar */
/* ===== Mobilde tabloyu kart gÃ¶rÃ¼nÃ¼mÃ¼ne Ã§evir ===== */
@media (max-width: 720px){
  /* BaÅŸlÄ±k gizle, table yapÄ±sÄ±nÄ± block'a Ã§evir */
  table{border-collapse:separate;border-spacing:0}
  thead{display:none}
  table, thead, tbody, tr, th, td{display:block; width:100%}

  /* Her TR bir â€œkartâ€ olsun */
  tbody tr{
    background: var(--card);
    border: 1px solid var(--stroke);
    border-radius: 14px;
    box-shadow: var(--shadow);
    margin: 10px 0 14px;
    overflow: hidden;
  }

  /* SatÄ±r iÃ§i hÃ¼creler: etiket + deÄŸer dÃ¼zeni */
  tbody td{
    display:grid;
    grid-template-columns: 120px 1fr; /* sol etiket / saÄŸ iÃ§erik */
    align-items:center;
    gap:10px;
    padding:12px 14px;
    border-bottom:1px solid var(--stroke);
    word-break: break-word;
  }
  tbody td:last-child{ border-bottom: none; }

  /* Etiketleri pseudo ile veriyoruz (thead gizli) */
  tbody td:nth-child(1)::before{ content:"GÃ¼n";      color:var(--muted); font-size:12px; font-weight:700; }
  tbody td:nth-child(2)::before{ content:"Tarih";    color:var(--muted); font-size:12px; font-weight:700; }
  tbody td:nth-child(3)::before{ content:"Saat";     color:var(--muted); font-size:12px; font-weight:700; }
  tbody td:nth-child(4)::before{ content:"BekÃ¢r";    color:var(--muted); font-size:12px; font-weight:700; }
  tbody td:nth-child(5)::before{ content:"Evli"; color:var(--muted); font-size:12px; font-weight:700; }
  tbody td:nth-child(6)::before{ content:"Not";      color:var(--muted); font-size:12px; font-weight:700; }

  /* Ä°Ã§erik (saÄŸ kolon) tipografisi */
  .time{ font-weight:700; color:var(--brand2); }

  /* Select'ler kart iÃ§inde tam geniÅŸlik olsun */
  select.inline{ min-width:0; width:100%; }

  /* KÃ¼Ã§Ã¼k ekranlarda pillâ€™ler taÅŸmasÄ±n */
  .pill{ display:inline-flex; align-items:center; max-width:100%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
}

/* Ä°steÄŸe baÄŸlÄ±: Ã§ok dar ekranlarda etiket kolonu biraz daralsÄ±n */
@media (max-width: 380px){
  tbody td{ grid-template-columns: 96px 1fr; }
}

  </style>

  <!-- Supabase (Auth + Database iÃ§in) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
  <script src="../src/supabase.js"></script>
  <script src="../src/supabase-auth-wrapper.js"></script>
  <script src="../src/supabase-db-wrapper.js"></script>
  <script src="../js/ortak.js"></script>
</head>
<body>

  <!-- ÃœST APPBAR (hedef-grafik.html ile aynÄ± yapÄ±) -->
  <div class="appbar">
    <div class="brand" onclick="location.href='../panel.html'">
      <img src="../img/logo.png" alt="logo"><span>KARAAÄAÃ‡ FATÄ°H</span>
    </div>
    <nav class="nav-center">
      <ul class="nav-list" id="navMain"></ul>
    </nav>
    <div class="nav-right">
      <button class="btn hamb" id="hamburger" title="MenÃ¼">â˜°</button>

      <!-- Bildirim -->
      <div class="nav-item">
        <button class="iconbtn" id="btnNotif" title="Bildirimler">ğŸ””
          <span class="badge" id="notifBadge" style="display:none">0</span>
        </button>
        <div class="dropdown drop-right" id="notifDropdown" aria-label="Bildirim listesi">
          <div class="muted" style="padding:6px 8px">Son bildirimler</div>
          <div id="notifList" class="list" style="max-height:300px;overflow:auto"></div>
        </div>
      </div>

      <!-- Profil -->
      <div class="nav-item">
        <button class="iconbtn" id="btnProfile" title="Profil">
          <span class="avatar"></span> <span id="profName" class="muted">Profil</span>
        </button>
        <div class="dropdown drop-right" id="profDropdown" aria-label="Profil menÃ¼sÃ¼">
          <a href="../diger/kullanici-yonetimi.html">ğŸ‘¤ Profil</a>
          <a href="../diger/sistem-ayarlari.html">âš™ï¸ Sistem AyarlarÄ±</a>
          <a href="#" id="btnLogout">ğŸšª Ã‡Ä±kÄ±ÅŸ Yap</a>
        </div>
      </div>
    </div>
  </div>
  <aside class="drawer" id="drawer"></aside>
  <div class="toast-container" id="toastContainer"></div>

  <!-- CONTENT -->
  <main class="container">
    <!-- HERO -->
    <section class="hero">
      <div>
        <h2>NÃ¶bet YÃ¶netimi</h2>
        <div class="hero-sub">BugÃ¼n: <span id="todayText">â€”</span> â€¢ <span id="username">â€”</span></div>
        <div class="mini" style="margin-top:8px">
          <span class="pill">SeÃ§ili Hafta: <b id="outWeek">â€”</b></span>
          <span class="pill">BekÃ¢r start: <b id="outBStart">-</b></span>
          <span class="pill">Evli start: <b id="outEStart">-</b></span>
          <span class="pill">Ã–zel Pazar: <b id="sumPazar">â€”</b></span>
        </div>
      </div>
    </section>

    <!-- SEKMELER -->
    <div class="tabs">
      <button class="tab active" data-tab="plan">ğŸ“… Plan OluÅŸtur</button>
      <button class="tab" data-tab="dashboard">ğŸ“ˆ Dashboard</button>
      <button class="tab" data-tab="stats">ğŸ“Š Ä°statistikler</button>
      <button class="tab" data-tab="reports">ğŸ“„ Raporlar</button>
      <button class="tab" data-tab="history">ğŸ“œ GeÃ§miÅŸ</button>
    </div>

    <!-- PLAN OLUÅTUR SEKME -->
    <div class="tab-content active" id="tab-plan">
    <!-- AYARLAR -->
    <section class="card" style="position:relative; overflow:hidden">
      <div style="display:flex; align-items:center; gap:12px; margin-bottom:12px; padding-bottom:12px; border-bottom:2px solid var(--stroke)">
        <div style="width:48px; height:48px; background:linear-gradient(135deg, var(--brand), var(--brand2)); border-radius:12px; display:flex; align-items:center; justify-content:center; font-size:24px">âš™ï¸</div>
        <div style="flex:1">
          <h3 style="margin:0; font-size:20px; font-weight:800">NÃ¶bet PlanÄ± AyarlarÄ±</h3>
          <div style="font-size:12px; color:var(--muted); margin-top:4px">HaftalÄ±k nÃ¶bet planÄ±nÄ±zÄ± oluÅŸturun ve yÃ¶netin</div>
        </div>
      </div>
      <div style="padding:10px 12px; margin-bottom:16px; background:linear-gradient(135deg, rgba(251,191,36,.1), rgba(252,211,77,.1)); border-left:3px solid #fbbf24; border-radius:6px; font-size:12px; line-height:1.5; color:var(--text)">
        <div style="display:flex; align-items:flex-start; gap:6px">
          <span style="font-size:14px; flex-shrink:0">â„¹ï¸</span>
          <div>
            <strong style="color:#f59e0b">Pazar NÃ¶betleri</strong> <span style="font-family:monospace; background:rgba(0,0,0,.05); padding:2px 4px; border-radius:3px; font-size:11px">"Serhan Durak > Faruk Nafiz Ã–zgan > Ä°brahim Ay > Kerem KocaoÄŸlu > Mahmut Solmaz"</span> sÄ±rasÄ± ile devam etmektedir. 
            <span style="color:#dc2626; font-weight:600">!Normal sÄ±ra bu farklÄ± durumlarda takdim-tehir olabilir!</span>
          </div>
        </div>
      </div>
      
      <div class="form-grid" style="margin-top:6px">
        <div class="fg-4">
          <label style="display:flex; align-items:center; gap:6px; font-weight:600; margin-bottom:8px">
            <span>ğŸ“…</span>
            <span>Haftadan Bir Tarih</span>
          </label>
          <input type="date" id="inpTarih" style="font-size:15px; padding:12px 14px">
        </div>
        <div class="fg-4">
          <label style="display:flex; align-items:center; gap:6px; font-weight:600; margin-bottom:8px">
            <span>ğŸ”„</span>
            <span>Ã–zel Pazar OtomatiÄŸi</span>
          </label>
          <select id="selOtoPazar" style="font-size:15px; padding:12px 14px">
            <option value="auto">2 haftada bir (otomatik)</option>
            <option value="none">KapalÄ±</option>
          </select>
        </div>
        <div class="fg-4" style="display:flex; align-items:flex-end">
          <div style="flex:1; padding:12px; background:linear-gradient(135deg, rgba(14,165,233,.1), rgba(34,211,238,.1)); border-radius:12px; border:1px solid var(--stroke); text-align:center" class="week-indicator">
            <div style="font-size:11px; color:var(--muted); margin-bottom:4px">SeÃ§ili Hafta</div>
            <div style="font-size:18px; font-weight:900; color:var(--brand)" id="outWeek">â€”</div>
          </div>
        </div>

        <div class="fg-6">
          <label style="display:flex; align-items:center; gap:6px; font-weight:600; margin-bottom:8px">
            <span>ğŸ‘¤</span>
            <span>BekÃ¢r Listesi</span>
            <span style="font-size:11px; color:var(--muted); font-weight:400">(virgÃ¼lle ayÄ±rÄ±n)</span>
          </label>
          <input type="text" id="inpBekar" value="B1,B2,B3" placeholder="Ã–rn: Ahmet, Mehmet, Ali" style="font-size:15px; padding:12px 14px">
        </div>
        <div class="fg-6">
          <label style="display:flex; align-items:center; gap:6px; font-weight:600; margin-bottom:8px">
            <span>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</span>
            <span>Evli Listesi</span>
            <span style="font-size:11px; color:var(--muted); font-weight:400">(virgÃ¼lle ayÄ±rÄ±n)</span>
          </label>
          <input type="text" id="inpEvli" value="E1,E2,E3,E4,E5" placeholder="Ã–rn: Veli, Can, Murat" style="font-size:15px; padding:12px 14px">
        </div>

        <div class="fg-12" style="margin-top:8px">
          <label style="display:block; font-weight:600; margin-bottom:12px; font-size:14px">âš¡ HÄ±zlÄ± SeÃ§enekler</label>
          <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:10px">
            <label class="option-card" style="display:flex; align-items:center; gap:10px; padding:12px; background:var(--pill); border:2px solid var(--stroke); border-radius:12px; cursor:pointer; transition:all .2s">
              <input type="checkbox" id="chkManPazar" style="width:20px; height:20px; cursor:pointer">
              <div style="flex:1">
                <div style="font-weight:600; font-size:13px; margin-bottom:2px">Ã–zel Pazar</div>
                <div style="font-size:11px; color:var(--muted)">08:00â€“19:30 evli + 18:00â†’09:00 bekÃ¢r</div>
              </div>
            </label>
            <label class="option-card" style="display:flex; align-items:center; gap:10px; padding:12px; background:var(--pill); border:2px solid var(--stroke); border-radius:12px; cursor:pointer; transition:all .2s">
              <input type="checkbox" id="chkTehir" style="width:20px; height:20px; cursor:pointer">
              <div style="flex:1">
                <div style="font-weight:600; font-size:13px; margin-bottom:2px">Pazar Tehir</div>
                <div style="font-size:11px; color:var(--muted)">Pazar gÃ¼nÃ¼ nÃ¶bet ertelenir</div>
              </div>
            </label>
            <label class="option-card" style="display:flex; align-items:center; gap:10px; padding:12px; background:var(--pill); border:2px solid var(--stroke); border-radius:12px; cursor:pointer; transition:all .2s">
              <input type="checkbox" id="chkOzelNobet" style="width:20px; height:20px; cursor:pointer">
              <div style="flex:1">
                <div style="font-weight:600; font-size:13px; margin-bottom:2px">Ã–zel NÃ¶bet</div>
                <div style="font-size:11px; color:var(--muted)">TÃ¼m gÃ¼nler manuel doldurulacak</div>
              </div>
            </label>
            <label class="option-card" style="display:flex; align-items:center; gap:10px; padding:12px; background:var(--pill); border:2px solid var(--stroke); border-radius:12px; cursor:pointer; transition:all .2s">
              <input type="checkbox" id="chkAyarKaydet" checked style="width:20px; height:20px; cursor:pointer">
              <div style="flex:1">
                <div style="font-weight:600; font-size:13px; margin-bottom:2px">AyarlarÄ± Kaydet</div>
                <div style="font-size:11px; color:var(--muted)">Ayarlar otomatik kaydedilsin</div>
              </div>
            </label>
          </div>
        </div>
      </div>

      <div class="row right" style="margin-top:10px">
        <button class="iconbtn soft" id="btnOlustur" style="border-color:transparent; background:linear-gradient(90deg,var(--brand2),var(--brand)); color:#fff">PlanÄ± OluÅŸtur / YÃ¼kle</button>
        <button class="iconbtn soft" id="btnKaydet" style="border-color:transparent; background:linear-gradient(90deg,var(--brand),#60a5fa); color:#fff">PlanÄ± Kaydet</button>
        <button class="iconbtn soft" id="btnWhatsApp" style="display:none;border-color:transparent; background:linear-gradient(90deg,#25d366,#128c7e); color:#fff">ğŸ“± WhatsApp ile PaylaÅŸ</button>
        <button class="iconbtn soft" id="btnKopyala" style="display:none;border-color:transparent; background:linear-gradient(90deg,#8b5cf6,#a78bfa); color:#fff">HaftayÄ± Kopyala</button>
        <button class="iconbtn soft" id="btnHaftaSil" style="display:none;background:#b91c1c;border-color:#b91c1c;color:#fff">Bu HaftayÄ± Sil</button>
      </div>
      <div class="muted" id="existInfo" style="display:none;margin-top:8px"></div>
    </section>

    <!-- PLAN -->
    <section class="card">
      <h3>HaftalÄ±k Plan (DÃ¼zenlenebilir)</h3>
      <table>
        <thead>
          <tr>
            <th>GÃ¼n</th><th>Tarih</th><th>Saat</th><th>BekÃ¢r</th><th>Evli</th><th>Not</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </section>
    </div>

    <!-- Ä°STATÄ°STÄ°KLER SEKME -->
    <div class="tab-content" id="tab-stats">
      <section class="card">
        <h3>ğŸ“Š NÃ¶bet Ä°statistikleri</h3>
        
        <div class="form-grid" style="margin-bottom:20px">
          <div class="fg-4">
            <label>YÄ±l SeÃ§</label>
            <select id="statYear">
              <option value="">TÃ¼m YÄ±llar</option>
            </select>
          </div>
          <div class="fg-4">
            <label>Ay SeÃ§</label>
            <select id="statMonth">
              <option value="">TÃ¼m Aylar</option>
              <option value="01">Ocak</option>
              <option value="02">Åubat</option>
              <option value="03">Mart</option>
              <option value="04">Nisan</option>
              <option value="05">MayÄ±s</option>
              <option value="06">Haziran</option>
              <option value="07">Temmuz</option>
              <option value="08">AÄŸustos</option>
              <option value="09">EylÃ¼l</option>
              <option value="10">Ekim</option>
              <option value="11">KasÄ±m</option>
              <option value="12">AralÄ±k</option>
            </select>
          </div>
          <div class="fg-4">
            <label>Rol</label>
            <select id="statRole">
              <option value="">TÃ¼m Roller</option>
              <option value="bekar">BekÃ¢r</option>
              <option value="evli">Evli</option>
            </select>
          </div>
        </div>

        <div class="stat-grid" id="statCards"></div>

        <div class="chart-container">
          <div class="chart-title">ğŸ“ˆ KiÅŸi BazÄ±nda Toplam NÃ¶bet SayÄ±sÄ±</div>
          <div id="chartPerson"></div>
        </div>

        <div class="chart-container">
          <div class="chart-title">ğŸ“… AylÄ±k NÃ¶bet DaÄŸÄ±lÄ±mÄ±</div>
          <div id="chartMonthly"></div>
        </div>

        <div class="card" style="margin-top:16px">
          <h3>ğŸ† En Ã‡ok / Az NÃ¶bet Tutanlar</h3>
          <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-top:12px">
            <div>
              <h4 style="margin:0 0 10px; color:var(--ok)">âœ… En Ã‡ok NÃ¶bet</h4>
              <div id="topNobetciler"></div>
            </div>
            <div>
              <h4 style="margin:0 0 10px; color:var(--muted)">âšª En Az NÃ¶bet</h4>
              <div id="azNobetciler"></div>
            </div>
          </div>
        </div>
      </section>
    </div>

    <!-- DASHBOARD SEKME -->
    <div class="tab-content" id="tab-dashboard">
      <section class="card">
        <h3>ğŸ“ˆ Dashboard & Trend Analizi</h3>
        
        <div class="form-grid" style="margin-bottom:20px">
          <div class="fg-4">
            <label>KarÅŸÄ±laÅŸtÄ±rma YÄ±lÄ± 1</label>
            <select id="dashboardYear1">
              <option value="">SeÃ§iniz</option>
            </select>
          </div>
          <div class="fg-4">
            <label>KarÅŸÄ±laÅŸtÄ±rma YÄ±lÄ± 2</label>
            <select id="dashboardYear2">
              <option value="">SeÃ§iniz</option>
            </select>
          </div>
          <div class="fg-4">
            <label>GÃ¶sterim</label>
            <select id="dashboardView">
              <option value="yearly">YÄ±llÄ±k</option>
              <option value="monthly">AylÄ±k</option>
              <option value="comparison">KarÅŸÄ±laÅŸtÄ±rma</option>
            </select>
          </div>
        </div>

        <div class="dashboard-grid" id="dashboardCards"></div>

        <div class="card" style="margin-top:16px">
          <h3>ğŸ“Š Trend Analizi</h3>
          <div id="trendChart" style="margin-top:16px"></div>
        </div>

        <div class="card" style="margin-top:16px">
          <h3>ğŸ“ˆ KarÅŸÄ±laÅŸtÄ±rmalÄ± Rapor</h3>
          <div id="comparisonChart" style="margin-top:16px"></div>
          <div id="comparisonLegend" style="margin-top:16px; display:flex; gap:16px; justify-content:center; flex-wrap:wrap"></div>
        </div>
      </section>
    </div>

    <!-- RAPORLAR SEKME -->
    <div class="tab-content" id="tab-reports">
      <section class="card">
        <h3>ğŸ“„ AylÄ±k Ã–zet Raporlar</h3>
        
        <div class="form-grid" style="margin-bottom:20px">
          <div class="fg-4">
            <label>YÄ±l SeÃ§</label>
            <select id="reportYear">
              <option value="">YÄ±l SeÃ§iniz</option>
            </select>
          </div>
          <div class="fg-4">
            <label>Ay SeÃ§</label>
            <select id="reportMonth">
              <option value="">TÃ¼m Aylar</option>
              <option value="01">Ocak</option>
              <option value="02">Åubat</option>
              <option value="03">Mart</option>
              <option value="04">Nisan</option>
              <option value="05">MayÄ±s</option>
              <option value="06">Haziran</option>
              <option value="07">Temmuz</option>
              <option value="08">AÄŸustos</option>
              <option value="09">EylÃ¼l</option>
              <option value="10">Ekim</option>
              <option value="11">KasÄ±m</option>
              <option value="12">AralÄ±k</option>
            </select>
          </div>
          <div class="fg-4" style="display:flex; align-items:flex-end">
            <button class="iconbtn" id="btnGenerateReport" style="width:100%">ğŸ“„ Rapor OluÅŸtur</button>
          </div>
        </div>

        <div id="reportContent"></div>
      </section>
    </div>

    <!-- GEÃ‡MÄ°Å SEKME -->
    <div class="tab-content" id="tab-history">
      <section class="card">
        <h3>ğŸ“œ NÃ¶bet GeÃ§miÅŸi</h3>
        
        <div class="history-filters">
          <div>
            <label style="display:block; font-size:12px; color:var(--muted); margin-bottom:4px">BaÅŸlangÄ±Ã§ Tarihi</label>
            <input type="date" id="historyStart" style="width:150px">
          </div>
          <div>
            <label style="display:block; font-size:12px; color:var(--muted); margin-bottom:4px">BitiÅŸ Tarihi</label>
            <input type="date" id="historyEnd" style="width:150px">
          </div>
          <div>
            <label style="display:block; font-size:12px; color:var(--muted); margin-bottom:4px">KiÅŸi</label>
            <select id="historyPerson" style="width:150px">
              <option value="">TÃ¼m KiÅŸiler</option>
            </select>
          </div>
          <div style="display:flex; align-items:flex-end">
            <button class="iconbtn" id="btnHistoryFilter" style="margin-top:0">ğŸ” Filtrele</button>
            <button class="iconbtn" id="btnHistoryReset" style="margin-top:0; margin-left:8px">ğŸ”„ SÄ±fÄ±rla</button>
          </div>
        </div>

        <div class="history-table-wrapper">
          <table class="history-table">
            <thead>
              <tr>
                <th>Tarih</th>
                <th>GÃ¼n</th>
                <th>KiÅŸi</th>
                <th>Rol</th>
                <th>Saat</th>
                <th>Tip</th>
              </tr>
            </thead>
            <tbody id="historyTbody"></tbody>
          </table>
        </div>
        <div id="historyInfo" class="muted" style="margin-top:12px; text-align:center"></div>
      </section>
    </div>

    <div class="page-gap"></div>
  </main>


  <script>
    /* ===== Tema (Auto) â€“ sadece gÃ¶rÃ¼nÃ¼m iÃ§in, profil menÃ¼sÃ¼ne taÅŸÄ±ndÄ± ===== */
    (function(){ const root=document.documentElement; const mode=localStorage.getItem('kf_theme')||'auto';
      const sysDark=()=>matchMedia && matchMedia('(prefers-color-scheme: dark)').matches;
      root.setAttribute('data-theme', mode==='auto' ? (sysDark()?'dark':'light') : mode);
      if(window.matchMedia){ const m=matchMedia('(prefers-color-scheme: dark)'); m.addEventListener?.('change',()=>{ if((localStorage.getItem('kf_theme')||'auto')==='auto'){ root.setAttribute('data-theme', sysDark()?'dark':'light'); } }); }
    })();

    /* ====== Supabase ve Auth ====== */
    const getSupabase = () => window.supabase;

    /* ===== Sekme YÃ¶netimi ===== */
    (function initTabsSystem(){
      function handleTabClick(e){
        const tab = e.target.closest('.tab');
        if(!tab || !tab.dataset.tab) return;
        e.preventDefault();
        e.stopPropagation();
        
          const targetTab = tab.dataset.tab;
        
          // TÃ¼m sekmeleri ve iÃ§erikleri kapat
        document.querySelectorAll('.tab').forEach(function(t){ t.classList.remove('active'); });
        document.querySelectorAll('.tab-content').forEach(function(c){ c.classList.remove('active'); });
        
          // SeÃ§ili sekmeyi ve iÃ§eriÄŸi aÃ§
          tab.classList.add('active');
        const targetContent = document.getElementById('tab-' + targetTab);
        if(targetContent) {
          targetContent.classList.add('active');
        }
          
          // Sekme deÄŸiÅŸtiÄŸinde ilgili verileri yÃ¼kle
        if(targetTab === 'dashboard' && typeof loadDashboard === 'function'){
            loadDashboard();
        }else if(targetTab === 'stats' && typeof loadStatistics === 'function'){
            loadStatistics();
        }else if(targetTab === 'reports' && typeof initReports === 'function'){
            initReports();
        }else if(targetTab === 'history' && typeof loadHistory === 'function'){
            loadHistory();
          }
      }
      
      // Event delegation ile tÃ¼m tab tÄ±klamalarÄ±nÄ± yakala
      const tabsContainer = document.querySelector('.tabs');
      if(tabsContainer){
        tabsContainer.addEventListener('click', handleTabClick);
      }
      
      // DOM yÃ¼klenmeden Ã¶nce Ã§alÄ±ÅŸtÄ±rÄ±lÄ±rsa tekrar dene
      if(!tabsContainer){
        if(document.readyState === 'loading'){
          document.addEventListener('DOMContentLoaded', initTabsSystem);
        } else {
          setTimeout(initTabsSystem, 100);
        }
      }
    })();

/* ===== UI yardÄ±mcÄ±larÄ± ===== */
    // Ortak toast sistemi kullan (ortak.js'den geliyor) - window.showToast kullan
    if (typeof window.showToast === 'undefined') {
      window.showToast = function(type, title, message) {
        const msg = title ? `${title}: ${message}` : message;
        console.log(`[${type}] ${msg}`);
        alert(msg);
      };
    }

    // const norm = ... SATIRI SÄ°LÄ°NDÄ°, Ã‡ÃœNKÃœ ORTAK.JS'DEN GELÄ°YOR

    function setToday(){
      const d=new Date(); const days=['Pazar','Pazartesi','SalÄ±','Ã‡arÅŸamba','PerÅŸembe','Cuma','Cumartesi'];
      document.getElementById('todayText').textContent=`${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()} â€¢ ${days[d.getDay()]}`;
    }

    /* ===== Nav Manifest (ortak.js'den geliyor) ===== */
    // Navigasyon, bildirim ve profil menÃ¼leri ortak.js'deki initAppShellAuth() tarafÄ±ndan yÃ¶netiliyor
    // CURRENT_ALLOW ve CURRENT_DENY ortak.js'den geliyor
    // Ortak.js yÃ¼klendikten sonra kullanÄ±lacak
    // Burada tanÄ±mlamÄ±yoruz, sadece window'dan eriÅŸiyoruz (ortak.js Ã§ift yÃ¼kleme hatasÄ±nÄ± Ã¶nler)
    // EÄŸer ortak.js henÃ¼z yÃ¼klenmemiÅŸse, geÃ§ici olarak boÅŸ Set oluÅŸtur (sadece window'da)
    if(typeof window.CURRENT_ALLOW === 'undefined') {
      window.CURRENT_ALLOW = new Set();
    }
    if(typeof window.CURRENT_DENY === 'undefined') {
      window.CURRENT_DENY = new Set();
    }
    // let/const tanÄ±mlamÄ±yoruz - ortak.js zaten tanÄ±mlÄ±yor
    // KullanÄ±rken: window.CURRENT_ALLOW veya CURRENT_ALLOW (ortak.js yÃ¼klendikten sonra global olarak eriÅŸilebilir)

    /* ===== Sayfa Ã¶zgÃ¼: NÃ¶bet planlayÄ±cÄ± ===== */
    const inpTarih=document.getElementById('inpTarih');
    const inpBekar=document.getElementById('inpBekar');
    const inpEvli=document.getElementById('inpEvli');
    const selOtoPazar=document.getElementById('selOtoPazar');
    const tbody=document.getElementById('tbody');
    const existInfo=document.getElementById('existInfo');
    const btnHaftaSil=document.getElementById('btnHaftaSil');

    function toISO(d){
      const yy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${yy}-${mm}-${dd}`;
    }
    function isoWeek(date){
      // ISO 8601 hafta hesaplama (hafta Pazartesi baÅŸlar, yÄ±lÄ±n ilk haftasÄ± en az 4 gÃ¼n iÃ§erir)
      const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
      const day = d.getUTCDay() || 7; // 0=Pazar -> 7, 1=Pazartesi -> 1
      d.setUTCDate(d.getUTCDate() + 4 - day); // HaftanÄ±n PerÅŸembe gÃ¼nÃ¼ne git
      const yStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 4)); // YÄ±lÄ±n 4 Ocak'Ä±na git
      yStart.setUTCDate(yStart.getUTCDate() - (yStart.getUTCDay() || 7) + 1); // O haftanÄ±n Pazartesi'sine git
      const weekNo = Math.ceil(((d - yStart) / 86400000 + 1) / 7);
      return { isoYear: d.getUTCFullYear(), weekNo: weekNo || 1 };
    }
    function buildWeek(date){ const d=new Date(date); const off=(d.getDay()+6)%7; const pzt=new Date(d); pzt.setDate(d.getDate()-off); const arr=[]; for(let i=0;i<7;i++){ const x=new Date(pzt); x.setDate(pzt.getDate()+i); arr.push(x);} return arr; }
    const DAYS=["Pazartesi","SalÄ±","Ã‡arÅŸamba","PerÅŸembe","Cuma","Cumartesi","Pazar"];
    const FULLDAY="09:00 â†’ ertesi 09:00";
    const PZ_GUN="08:00 â†’ 19:30";           // evli (Ã¶zel pazar)
    const PZ_BEKAR="18:00 â†’ ertesi 09:00";  // bekÃ¢r (Ã¶zel pazar)

    /* ---- Ã–nceki haftadan tÃ¼retme ---- */
    function mapFromPrevWeek(prevRows, isSpecialPazarCurr){
      if(!prevRows || !Array.isArray(prevRows) || prevRows.length === 0){
        return {evli: {}, bekar: {}};
      }
      const byDay = Object.fromEntries(prevRows.map(r=>[r.gun,r]));
      // 1 gÃ¼n ileri kaydÄ±rma (Pazartesi -> SalÄ±, SalÄ± -> Ã‡arÅŸamba, ... Pazar -> Pazartesi)
      const order = ["Pazartesi","SalÄ±","Ã‡arÅŸamba","PerÅŸembe","Cuma","Cumartesi","Pazar"];
      const forward1 = d => {
        const idx = order.indexOf(d);
        return idx >= 0 ? order[(idx + 1) % 7] : d;
      };

      const mapBekar = Object.fromEntries(order.map(day => [day, byDay[forward1(day)]?.bekar || null]));
      const mapEvli  = Object.fromEntries(order.map(day => [day, byDay[forward1(day)]?.evli  || null]));

      // Pazar Ã¶zel kuralÄ±: Ã¶zel pazar yoksa evliyi boÅŸalt
      if(!isSpecialPazarCurr){
        mapEvli["Pazar"] = null;
      }
      return {evli:mapEvli, bekar:mapBekar};
    }

    function makeSelect(options,val,onChange,disabled){
      const s=document.createElement('select'); s.className="inline"; if(disabled) s.disabled=true;
      const o0=document.createElement('option'); o0.value=""; o0.textContent="â€”"; s.appendChild(o0);
      options.forEach(o=>{ const op=document.createElement('option'); op.value=o; op.textContent=o; if(o===val) op.selected=true; s.appendChild(op); });
      s.addEventListener('change',()=>onChange(s.value||null)); return s;
    }

    function drawPlan(plan){
      const tb=document.getElementById('tbody'); tb.innerHTML="";
      const isOzelNobet = plan.isOzelNobet || false;
      document.getElementById('sumPazar').textContent=plan.isPazarTehir?"Tehir":(plan.isSpecialPazar?"Var":"Yok");
      
      // Ã–zel nÃ¶bet bilgi mesajÄ± (sadece bir kez gÃ¶ster)
      const existingInfo = tb.parentElement.querySelector('.ozel-nobet-info');
      if(existingInfo) existingInfo.remove();
      
      if(isOzelNobet){
        const infoDiv = document.createElement('div');
        infoDiv.className="pill ozel-nobet-info";
        infoDiv.style.background="rgba(14,165,233,.15)";
        infoDiv.style.borderColor="var(--brand)";
        infoDiv.style.marginBottom="10px";
        infoDiv.style.padding="10px";
        infoDiv.textContent="âš ï¸ Ã–zel NÃ¶bet Modu: TÃ¼m gÃ¼nler manuel olarak doldurulacak";
        tb.parentElement.insertBefore(infoDiv, tb);
      }
      const bOps=(inpBekar.value||'').split(',').map(x=>x.trim()).filter(Boolean);
      const eOps=(inpEvli.value||'').split(',').map(x=>x.trim()).filter(Boolean);
      plan.rows.forEach(r=>{
        const tr=document.createElement('tr');
        const tdG=document.createElement('td'); tdG.textContent=r.gun;
        const tdD=document.createElement('td'); tdD.textContent=r.tarihISO;
        const tdS=document.createElement('td'); tdS.innerHTML=`<span class="time">${r.saat}</span>`;
        const tdB=document.createElement('td'); const tdE=document.createElement('td'); const tdN=document.createElement('td');

        // Ã–zel nÃ¶bet modunda tÃ¼m gÃ¼nler seÃ§ilebilir
        if(isOzelNobet){
          // Ã–zel nÃ¶bet modu: TÃ¼m gÃ¼nler iÃ§in bekÃ¢r ve evli seÃ§ilebilir
          tdB.appendChild(makeSelect(bOps,r.bekar,v=>r.bekar=v));
          if(r.gun==="Pazar" && !plan.isSpecialPazar && !plan.isPazarTehir){
            // Normal pazar - evli yok
            tdE.innerHTML=`<span class="muted">â€”</span>`;
          }else{
            tdE.appendChild(makeSelect(eOps,r.evli,v=>r.evli=v));
          }
        }else{
          // Normal mod
          if(r.gun==="Cumartesi" && plan.isSpecialPazar){ tdB.innerHTML=`<span class="muted">â€”</span>`; }
          else{ tdB.appendChild(makeSelect(bOps,r.bekar,v=>r.bekar=v)); }

          if(r.gun==="Pazartesi"){
            tdE.appendChild(makeSelect(eOps,r.evli,v=>r.evli=v));
          }else if(r.gun==="Pazar" && plan.isSpecialPazar && !plan.isPazarTehir){
            tdE.appendChild(makeSelect(eOps,r.evli,v=>r.evli=v));
          }else if(r.gun==="Pazar"){
            tdE.innerHTML=`<span class="muted">â€”</span>`;
          }else{
            tdE.appendChild(makeSelect(eOps,r.evli,v=>r.evli=v));
          }
        }

        tdN.textContent=r.not||"â€”";
        tr.append(tdG,tdD,tdS,tdB,tdE,tdN); tb.appendChild(tr);
      });
    }

    function planFromInputs(date, prevPlanOrNull){
      if(!date || isNaN(date.getTime())){
        throw new Error('GeÃ§ersiz tarih');
      }
      const iso=isoWeek(date);
      const weekDates=buildWeek(date);
      if(weekDates.length !== 7){
        throw new Error('Hafta tarihleri oluÅŸturulamadÄ±');
      }
      const isAuto = (selOtoPazar.value==="auto") ? (iso.weekNo%2===0) : false;
      const isSpecial = document.getElementById('chkManPazar').checked || isAuto;
      const isTehir = document.getElementById('chkTehir').checked;
      const isOzelNobet = document.getElementById('chkOzelNobet').checked;

      let rows=[];
      
      // Ã–zel nÃ¶bet modu: TÃ¼m gÃ¼nler boÅŸ, manuel doldurulacak
      if(isOzelNobet){
        DAYS.forEach((g,i)=>{
          const tarihISO=toISO(weekDates[i]); const monthKey=tarihISO.slice(0,7);
          let saat = FULLDAY, not="Ã–zel NÃ¶bet (Manuel)";
          
          // Pazar Ã¶zel durumlarÄ±
          if(g==="Pazar" && isSpecial && !isTehir){
            saat=`${PZ_BEKAR} (bekÃ¢r) + ${PZ_GUN} (evli)`;
            not="Ã–zel NÃ¶bet - Ã–zel Pazar";
          }else if(g==="Pazar"){
            not=isTehir?"Ã–zel NÃ¶bet - Pazar Tehir":"Ã–zel NÃ¶bet - Normal Pazar";
          }
          
          rows.push({gun:g,tarihISO,monthKey,saat,bekar:null,evli:null,not});
        });
        return {isoYear:iso.isoYear,weekNo:iso.weekNo,isSpecialPazar:isSpecial,isPazarTehir:isTehir,isOzelNobet:true,pazarEvli:null, rows};
      }
      
      if(prevPlanOrNull && prevPlanOrNull.rows && Array.isArray(prevPlanOrNull.rows) && prevPlanOrNull.rows.length > 0){
        // Ã–nceki haftadan tÃ¼ret
        const maps = mapFromPrevWeek(prevPlanOrNull.rows||[], isSpecial && !isTehir);
        DAYS.forEach((g,i)=>{
          const tarihISO=toISO(weekDates[i]); const monthKey=tarihISO.slice(0,7);
          let saat = FULLDAY, not="";
          let bekar = maps.bekar[g] ?? null;
          let evli  = maps.evli[g]  ?? null;

          if(g==="Pazar" && isSpecial && !isTehir){
            saat=`${PZ_BEKAR} (bekÃ¢r) + ${PZ_GUN} (evli)`;
            not="Ã–zel Pazar (Ã¶nceki haftadan tÃ¼retildi)";
          }else if(g==="Pazar"){
            evli=null; not=isTehir?"Pazar tehir":"Normal Pazar â€” evli yok";
          }
          if(g==="Cumartesi" && isSpecial){ bekar=null; not = (not?not+'; ':'')+"Cumartesi bekÃ¢r yok (Ã¶zel pazar)"; }

          rows.push({gun:g,tarihISO,monthKey,saat,bekar,evli,not});
        });
        return {isoYear:iso.isoYear,weekNo:iso.weekNo,isSpecialPazar:isSpecial,isPazarTehir:isTehir,isOzelNobet:false,pazarEvli:rows.find(r=>r.gun==='Pazar')?.evli||null, rows};
      }

      // SÄ±fÄ±rdan (mevcut algoritman)
      const bekarList=(inpBekar.value||'').split(',').map(x=>x.trim()).filter(Boolean);
      const evliList =(inpEvli.value||'').split(',').map(x=>x.trim()).filter(Boolean);
      if(bekarList.length === 0 && evliList.length === 0){
        throw new Error('En az bir bekÃ¢r veya evli listesi gerekli');
      }
      const bStart=bekarList.length?(iso.weekNo%bekarList.length):0;
      const eStart=evliList.length?(iso.weekNo%evliList.length):0;
      const rotate=(a,i)=>{ if(!a.length) return []; const k=((i%a.length)+a.length)%a.length; return a.slice(k).concat(a.slice(0,k)); }
      let bSeq=rotate(bekarList,bStart); let eSeq=rotate(evliList,eStart);
      const pazarEvli=(isSpecial&&evliList.length)?eSeq[0]:null;

      DAYS.forEach((g,i)=>{
        let bekar=null, evli=null, saat=FULLDAY, not="";
        const tarihISO=toISO(weekDates[i]); const monthKey=tarihISO.slice(0,7);

        if(g==="Pazartesi"){
          // ArtÄ±k normal gÃ¼n: evli/bekÃ¢r rotasyondan
          bekar=bSeq[0]||null; if(bekar) bSeq=rotate(bSeq,1);
          evli=eSeq[0]||null;  if(evli)  eSeq=rotate(eSeq,1);
        } else if(["SalÄ±","Ã‡arÅŸamba","PerÅŸembe","Cuma"].includes(g)){
          bekar=bSeq[0]||null; if(bekar) bSeq=rotate(bSeq,1);
          evli=eSeq[0]||null;  if(evli)  eSeq=rotate(eSeq,1);
        } else if(g==="Cumartesi"){
          if(isSpecial){ bekar=null; not="Ã–zel Pazar haftasÄ± â†’ Cumartesi bekÃ¢r yok"; }
          else{ bekar=bSeq[0]||null; if(bekar) bSeq=rotate(bSeq,1); }
          if(evliList.length){
            let chosen=null,k=0;
            while(k<eSeq.length){
              const cand=eSeq[k];
              if(!(isSpecial && pazarEvli && cand===pazarEvli)){ chosen=cand; break; }
              k++;
            }
            if(chosen){ evli=chosen; eSeq=rotate(eSeq,k+1); }
            else{ evli=eSeq[0]||null; if(evli) eSeq=rotate(eSeq,1); }
          }
        } else if(g==="Pazar"){
          if(isSpecial && !isTehir){
            bekar=bSeq[0]||null; if(bekar) bSeq=rotate(bSeq,1);
            evli=pazarEvli;
            saat=`${PZ_BEKAR} (bekÃ¢r) + ${PZ_GUN} (evli)`; not="Ã–zel Pazar";
            if(evli){ const ix=eSeq.indexOf(evli); if(ix>=0) eSeq=rotate(eSeq,ix+1); }
          } else {
            bekar=bSeq[0]||null; if(bekar) bSeq=rotate(bSeq,1);
            evli=null; not=isTehir?"Pazar tehir":"Normal Pazar â€” evli yok";
          }
        }
        rows.push({gun:g,tarihISO,monthKey,saat,bekar,evli,not});
      });

          return {isoYear:iso.isoYear,weekNo:iso.weekNo,isSpecialPazar:isSpecial,
             isPazarTehir:isTehir,isOzelNobet:false,pazarEvli, rows};
          }

    function renderWeekBadge(d){
      const {isoYear,weekNo}=isoWeek(d);
      document.getElementById('outWeek').textContent=`${isoYear}-W${('0'+weekNo).slice(-2)}`;
    }

    async function saveAyarIf(){
      if(!document.getElementById('chkAyarKaydet').checked) return;
      const supabase = getSupabase();
      if(!supabase) {
        console.warn('Supabase yÃ¼klenmedi, ayarlar kaydedilemedi');
        return;
      }
      try {
        const { data, error } = await supabase.from('nobet_ayar').upsert({
          id: 'genel',
          bekarlar:(inpBekar.value||'').split(',').map(x=>x.trim()).filter(Boolean),
          evliler:(inpEvli.value||'').split(',').map(x=>x.trim()).filter(Boolean),
          otopazar:selOtoPazar.value
        }, {onConflict: 'id'});
        
        if(error) {
          console.error('âŒ Ayarlar kaydedilemedi:', error);
          window.showToast('error', 'Hata', 'Ayarlar kaydedilemedi: ' + (error.message || 'Bilinmeyen hata'));
        } else {
          console.log('âœ… Ayarlar kaydedildi');
        }
      } catch(e){
        console.error('âŒ Ayarlar kaydetme hatasÄ±:', e);
        window.showToast('error', 'Hata', 'Ayarlar kaydedilemedi: ' + (e.message || 'Bilinmeyen hata'));
      }
    }
    async function deleteWeekIndex(weekKey){
      try {
        const supabase = getSupabase();
        if(!supabase) throw new Error('Supabase yÃ¼klenmedi');
        
        // weekkey'e gÃ¶re tÃ¼m index kayÄ±tlarÄ±nÄ± sil (schema: lowercase weekkey)
        const { error } = await supabase
          .from('nobet_index')
          .delete()
          .eq('weekkey', weekKey);
        
        if(error) throw error;
      } catch(e){
        console.error('Index silme hatasÄ±:', e);
        throw new Error('Index kayÄ±tlarÄ± silinirken hata oluÅŸtu: ' + e.message);
      }
    }

    async function savePlan(plan){
      if(!plan || !plan.rows || !Array.isArray(plan.rows)){
        throw new Error('GeÃ§ersiz plan verisi');
      }
      const supabase = getSupabase();
      if(!supabase) throw new Error('Supabase yÃ¼klenmedi');
      
      const weekKey = `${plan.isoYear}-W${('0'+plan.weekNo).slice(-2)}`;
      
      // Supabase auth'dan kullanÄ±cÄ± bilgisini al
      let user = null;
      try {
        if(supabase && supabase.auth) {
          const { data: { user: authUser } } = await supabase.auth.getUser();
          user = authUser;
        }
      } catch(e) {
        console.warn('KullanÄ±cÄ± bilgisi alÄ±namadÄ±:', e);
      }

      try {
        // 1) Eski indexleri sil
        await deleteWeekIndex(weekKey);

        // 2) Plan belgesini kaydet/ gÃ¼ncelle (sÃ¼tun isimleri ÅŸemaya uygun: snake_case)
        const planData = {
          id: weekKey,
          weekkey: weekKey,
          isoyear: plan.isoYear,
          weekno: plan.weekNo,
          isspecialpazar: plan.isSpecialPazar || false,
          ispazartehir: plan.isPazarTehir || false,
          isozelnobet: plan.isOzelNobet || false,
          pazarevli: plan.pazarEvli || null,
          rows: plan.rows,
          createdat: new Date().toISOString(),
          createdby: user ? user.id : null
        };

        const { error: planError } = await supabase
          .from('nobet_planlari')
          .upsert(planData, { onConflict: 'id' });

        if(planError) {
          console.error('âŒ Plan kaydetme hatasÄ±:', planError);
          // RLS hatasÄ± kontrolÃ¼
          if(planError.code === 'PGRST301' || planError.message?.includes('permission') || planError.message?.includes('policy')) {
            window.showToast('error', 'Yetki HatasÄ±', 'Plan kaydedilemedi. RLS politikalarÄ±nÄ± kontrol edin: ' + planError.message);
          } else {
            window.showToast('error', 'Hata', 'Plan kaydedilemedi: ' + planError.message);
          }
          throw planError;
        }
        console.log('âœ… Plan kaydedildi:', weekKey);

        // 3) Index kayÄ±tlarÄ±nÄ± ekle
        const indexRecords = [];
        for(const r of plan.rows){
          if(!r.tarihISO || !r.monthKey) {
            console.warn('âš ï¸ Eksik tarih bilgisi:', r);
            continue;
          }
          
          if(r.bekar){
            const type = (r.gun==="Pazar" && plan.isSpecialPazar && !plan.isPazarTehir) ? "pazar-aksam" : "24s";
            indexRecords.push({
              weekkey: weekKey, 
              date: r.tarihISO, 
              day: r.gun, 
              person: r.bekar, 
              role: "bekar",
              saat: type==="pazar-aksam" ? "18:00â†’09:00" : "09:00â†’09:00",
              type, 
              monthkey: r.monthKey, 
              year: r.tarihISO.slice(0,4),
              createdat: new Date().toISOString()
            });
          }
          if(r.evli){
            const type = (r.gun==="Pazar" && plan.isSpecialPazar && !plan.isPazarTehir) ? "pazar-gunduz" : "24s";
            indexRecords.push({
              weekkey: weekKey, 
              date: r.tarihISO, 
              day: r.gun, 
              person: r.evli, 
              role: "evli",
              saat: type==="pazar-gunduz" ? "08:00â†’19:30" : "09:00â†’09:00",
              type, 
              monthkey: r.monthKey, 
              year: r.tarihISO.slice(0,4),
              createdat: new Date().toISOString()
            });
          }
        }
        
        if(indexRecords.length > 0){
          // Her kayÄ±t iÃ§in id oluÅŸtur (weekkey + date + person + role kombinasyonu)
          const recordsWithId = indexRecords.map(r => ({
            id: `${r.weekkey}-${r.date}-${r.person}-${r.role}`,
            ...r
          }));
          
          const { error: indexError } = await supabase
            .from('nobet_index')
            .upsert(recordsWithId, { onConflict: 'id' });
            
          if(indexError) {
            console.error('âŒ Index kaydetme hatasÄ±:', indexError);
            throw new Error('Index kayÄ±tlarÄ± kaydedilemedi: ' + indexError.message);
          }
          console.log(`âœ… ${indexRecords.length} adet index kaydÄ± eklendi`);
        } else {
          console.warn('âš ï¸ Index kaydÄ± oluÅŸturulmadÄ± (plan.rows boÅŸ veya geÃ§ersiz)');
        }

        // 4) AyarlarÄ± kaydet (eÄŸer deÄŸiÅŸtiyse)
        await saveAyarIf();
        
        window.showToast('success', 'BaÅŸarÄ±lÄ±', 'Plan ve index kayÄ±tlarÄ± kaydedildi.');
      } catch(e){
        console.error('Plan kaydetme hatasÄ±:', e);
        window.showToast('error', 'Hata', 'Plan kaydedilirken hata oluÅŸtu: ' + (e.message || 'Bilinmeyen hata'));
        throw e;
      }
    }
    
    /* ===== WhatsApp PaylaÅŸÄ±m ===== */
    function formatPlanForWhatsApp(plan){
      if(!plan || !plan.rows) return '';
      
      const weekKey = `${plan.isoYear}-W${('0'+plan.weekNo).slice(-2)}`;
      let message = `ğŸ“… *NÃ¶bet PlanÄ± - ${weekKey}*\n\n`;
      
      if(plan.isSpecialPazar){
        message += `âš ï¸ *Ã–zel Pazar HaftasÄ±*\n`;
      }
      if(plan.isPazarTehir){
        message += `â° *Pazar Tehir*\n`;
      }
      if(plan.isOzelNobet){
        message += `ğŸ”§ *Ã–zel NÃ¶bet (Manuel)*\n`;
      }
      message += `\n`;
      
      plan.rows.forEach(row => {
        const tarih = row.tarihISO ? new Date(row.tarihISO + 'T00:00:00').toLocaleDateString('tr-TR', {day:'2-digit', month:'2-digit'}) : '';
        let line = `*${row.gun}* (${tarih})\n`;
        
        if(row.bekar){
          line += `ğŸ‘¤ BekÃ¢r: ${row.bekar}`;
          if(row.saat && row.saat !== '09:00â†’09:00'){
            line += ` (${row.saat})`;
          }
          line += `\n`;
        }
        
        if(row.evli){
          line += `ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Evli: ${row.evli}`;
          if(row.saat && row.saat !== '09:00â†’09:00'){
            line += ` (${row.saat})`;
          }
          line += `\n`;
        }
        
        if(row.not){
          line += `â„¹ï¸ ${row.not}\n`;
        }
        
        if(!row.bekar && !row.evli){
          line += `_NÃ¶bet yok_\n`;
        }
        
        message += line + `\n`;
      });
      
      message += `\n_KARAAÄAÃ‡ FATÄ°H - NÃ¶bet YÃ¶netim Sistemi_`;
      return message;
    }
    
    function shareToWhatsApp(plan){
      if(!plan || !plan.rows){
        window.showToast('warning', 'UyarÄ±', 'Ã–nce planÄ± oluÅŸturun');
        return;
      }
      
      const message = formatPlanForWhatsApp(plan);
      const encodedMessage = encodeURIComponent(message);
      
      // WhatsApp Web linki (telefon numarasÄ± olmadan, sadece mesaj)
      // KullanÄ±cÄ± kendi telefon numarasÄ±nÄ± seÃ§ebilir
      const whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
      
      // Yeni pencerede aÃ§
      window.open(whatsappUrl, '_blank');
      
        window.showToast('info', 'Bilgi', 'WhatsApp aÃ§Ä±lÄ±yor...');
    }
    

    /* ==== Auth ve init ==== */
    function setDefaults(){
      const t=new Date(); const iso=`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}-${String(t.getDate()).padStart(2,'0')}`;
      document.getElementById('inpTarih').value=iso;
      renderWeekBadge(t);
    }

    // Sayfa Ã¶zel init - Auth init ortak.js'de yapÄ±lÄ±yor
    window.initPage = async function(){
      // Prevent multiple executions
      if(window.isPageInitialized) {
        console.log('âš ï¸ initPage zaten Ã§alÄ±ÅŸtÄ±rÄ±ldÄ±, tekrar Ã§alÄ±ÅŸtÄ±rÄ±lmÄ±yor');
        return;
      }
      window.isPageInitialized = true;
      
      console.log('ğŸš€ initPage Ã§aÄŸrÄ±ldÄ±');
      const supabase = getSupabase();
      if(!supabase) {
        console.error('âŒ Supabase yÃ¼klenmedi, initPage iptal edildi');
        window.isPageInitialized = false; // Reset flag on error
        return;
      }
      
      try {
        // BugÃ¼nÃ¼n tarihini set et
        setToday();
        
        // KullanÄ±cÄ± bilgisi ortak.js'den geliyor, burada sadece username'i set et
        const usernameEl = document.getElementById('username');
        const profNameEl = document.getElementById('profName');
        if(usernameEl && profNameEl) {
          const profNameText = profNameEl.textContent || 'KullanÄ±cÄ±';
          usernameEl.textContent = profNameText.replace('ğŸ‘¤ ', '');
        }
        
        // AyarlarÄ± yÃ¼kle
        const { data, error } = await supabase.from('nobet_ayar').select('*').eq('id', 'genel').single();
        if(error) {
          console.error('âŒ Ayarlar yÃ¼klenemedi:', error);
          if(error.code === 'PGRST301' || error.message?.includes('permission') || error.message?.includes('policy')) {
            window.showToast('warning', 'Yetki UyarÄ±sÄ±', 'Ayarlar yÃ¼klenemedi. RLS politikalarÄ±nÄ± kontrol edin.');
          }
        } else if(data) {
          console.log('âœ… Ayarlar yÃ¼klendi');
          if(Array.isArray(data.bekarlar) && data.bekarlar.length > 0) inpBekar.value = data.bekarlar.join(',');
          if(Array.isArray(data.evliler) && data.evliler.length > 0) inpEvli.value = data.evliler.join(',');
          if(data.otopazar) selOtoPazar.value = data.otopazar;
        }
        
        setDefaults();
      } catch(e) {
        console.error('Sayfa init hatasÄ±:', e);
        window.isPageInitialized = false; // Reset flag on error
      }
    };

    // Sayfa yÃ¼klendiÄŸinde event listener'larÄ± baÄŸla
    function initEventListeners() {
      console.log('ğŸ”— Event listener\'lar baÄŸlanÄ±yor...');
      
      // Tarih deÄŸiÅŸikliÄŸi: hafta rozeti
      const inpTarihEl = document.getElementById('inpTarih');
      if(inpTarihEl) {
        inpTarihEl.addEventListener('change', (e)=>{ 
          const d=new Date(e.target.value+"T12:00:00"); 
          renderWeekBadge(d); 
        });
      }

      // PlanÄ± oluÅŸtur / yÃ¼kle
      const btnOlustur = document.getElementById('btnOlustur');
      if(btnOlustur) {
        btnOlustur.addEventListener('click', handlePlanOlustur);
      } else {
        console.error('âŒ btnOlustur bulunamadÄ±!');
      }

      // PlanÄ± kaydet
      const btnKaydet = document.getElementById('btnKaydet');
      if(btnKaydet) {
        btnKaydet.addEventListener('click', handlePlanKaydet);
      } else {
        console.error('âŒ btnKaydet bulunamadÄ±!');
      }

      // HaftayÄ± kopyala
      const btnKopyala = document.getElementById('btnKopyala');
      if(btnKopyala) {
        btnKopyala.addEventListener('click', handleHaftaKopyala);
      }

      // HaftayÄ± sil
      const btnHaftaSilEl = document.getElementById('btnHaftaSil');
      if(btnHaftaSilEl) {
        btnHaftaSilEl.addEventListener('click', handleHaftaSil);
      }

      // WhatsApp paylaÅŸÄ±m
      const btnWhatsApp = document.getElementById('btnWhatsApp');
      if(btnWhatsApp) {
        btnWhatsApp.addEventListener('click', () => {
          if(lastPlan){
            shareToWhatsApp(lastPlan);
          } else {
            window.showToast('warning', 'UyarÄ±', 'Ã–nce planÄ± oluÅŸturun veya yÃ¼kleyin');
          }
        });
      }

      // Ä°statistik filtreleri
      document.getElementById('statYear')?.addEventListener('change', loadStatistics);
      document.getElementById('statMonth')?.addEventListener('change', loadStatistics);
      document.getElementById('statRole')?.addEventListener('change', loadStatistics);

      // GeÃ§miÅŸ filtreleri
      document.getElementById('btnHistoryFilter')?.addEventListener('click', loadHistory);
      document.getElementById('btnHistoryReset')?.addEventListener('click', () => {
        const start = document.getElementById('historyStart');
        const end = document.getElementById('historyEnd');
        const person = document.getElementById('historyPerson');
        if(start) start.value = '';
        if(end) end.value = '';
        if(person) person.value = '';
        loadHistory();
      });

      // Dashboard filtreleri
      document.getElementById('dashboardYear1')?.addEventListener('change', () => {
        const year1 = document.getElementById('dashboardYear1')?.value;
        if(year1) loadDashboard();
      });
      document.getElementById('dashboardYear2')?.addEventListener('change', () => {
        const year2 = document.getElementById('dashboardYear2')?.value;
        if(year2) loadDashboard();
      });
      document.getElementById('dashboardView')?.addEventListener('change', loadDashboard);

      // Rapor oluÅŸtur
      document.getElementById('btnGenerateReport')?.addEventListener('click', generateReport);

      console.log('âœ… Event listener\'lar baÄŸlandÄ±');
    }

    let lastPlan=null, lastWeekKey=null;

    // PlanÄ± oluÅŸtur / yÃ¼kle
    async function handlePlanOlustur(){
      const btn = document.getElementById('btnOlustur');
      const val = inpTarih.value;
      if(!val){
        window.showToast('warning', 'UyarÄ±', 'LÃ¼tfen bir tarih seÃ§in');
        return;
      }

      // Input validasyonu
      const bl = (inpBekar.value||'').split(',').map(s=>s.trim()).filter(Boolean);
      const el = (inpEvli.value||'').split(',').map(s=>s.trim()).filter(Boolean);
      if(bl.length === 0 && el.length === 0){
        window.showToast('warning', 'UyarÄ±', 'En az bir bekÃ¢r veya evli listesi girmelisiniz');
        return;
      }

      // Tarih validasyonu
      const d = new Date(val+"T12:00:00");
      if(isNaN(d.getTime())){
        window.showToast('warning', 'UyarÄ±', 'GeÃ§ersiz tarih');
        return;
      }

      // Loading state
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'â³ YÃ¼kleniyor...';

      try {
        const { isoYear, weekNo } = isoWeek(d);
        const weekKey = `${isoYear}-W${('0'+weekNo).slice(-2)}`;

        document.getElementById('outBStart').textContent = bl.length ? (weekNo % bl.length) : '-';
        document.getElementById('outEStart').textContent = el.length ? (weekNo % el.length) : '-';

        // Hafta var mÄ±?
        const supabase = getSupabase();
        if(!supabase) throw new Error('Supabase yÃ¼klenmedi');
        
        const { data: exist, error: existError } = await supabase.from('nobet_planlari').select('*').eq('id', weekKey).single();
        
        if(existError) {
          console.error('âŒ Plan sorgulama hatasÄ±:', existError);
          console.error('Hata detayÄ±:', JSON.stringify(existError, null, 2));
          // RLS hatasÄ± kontrolÃ¼
          if(existError.code === 'PGRST301' || existError.message?.includes('permission') || existError.message?.includes('policy')) {
            window.showToast('error', 'Yetki HatasÄ±', 'Plan sorgulanamadÄ±. RLS politikalarÄ±nÄ± kontrol edin: ' + existError.message);
          } else if(existError.code === 'PGRST116') {
            // KayÄ±t bulunamadÄ± - bu normal, devam et
            console.log('â„¹ï¸ Plan bulunamadÄ±, yeni plan oluÅŸturulacak');
          } else {
            window.showToast('error', 'Hata', 'Plan sorgulanamadÄ±: ' + existError.message);
          }
        }
        
        if(!existError && exist){
          const planDoc = exist;
          if(!planDoc || !Array.isArray(planDoc.rows)){
            throw new Error('Plan verisi geÃ§ersiz');
          }
          window.showToast('info', 'Bilgi', 'SeÃ§ili tarihte daha Ã¶nceden plan var. YÃ¼klendi.');
        existInfo.style.display='block';
        existInfo.textContent = `Bu hafta (${weekKey}) mevcut plan dÃ¼zenleniyor. Kaydedersen Ã¼zerine yazÄ±lÄ±r.`;
        btnHaftaSil.style.display='inline-block';
        document.getElementById('btnKopyala').style.display='inline-block';

          // UI'ya doldur (veritabanÄ±ndan snake_case okunuyor)
          document.getElementById('chkTehir').checked = !!planDoc.ispazartehir;
          document.getElementById('chkManPazar').checked = !!planDoc.isspecialpazar;
          document.getElementById('chkOzelNobet').checked = !!planDoc.isozelnobet;

          // JavaScript'te camelCase kullan (kod okunabilirliÄŸi iÃ§in)
          lastPlan = { 
            isoYear: planDoc.isoyear || isoYear, 
            weekNo: planDoc.weekno || weekNo, 
            isSpecialPazar: !!planDoc.isspecialpazar,
            isPazarTehir: !!planDoc.ispazartehir, 
            isOzelNobet: !!planDoc.isozelnobet,
            pazarEvli: planDoc.pazarevli || null, 
            rows: planDoc.rows || [] 
          };
          drawPlan(lastPlan);
          lastWeekKey = weekKey;
          // WhatsApp butonunu gÃ¶ster
          const btnWhatsApp = document.getElementById('btnWhatsApp');
          if(btnWhatsApp) btnWhatsApp.style.display = 'inline-flex';
          return;
        }

        // Yoksa: bir Ã¶nceki haftaya bak
        const prevKey = (() => {
          const d2 = new Date(d); d2.setDate(d2.getDate() - 7);
          const { isoYear:py, weekNo:pw } = isoWeek(d2);
          return `${py}-W${String(pw).padStart(2,'0')}`;
        })();
        const { data: prevDoc } = await supabase.from('nobet_planlari').select('*').eq('id', prevKey).single();
        const prevPlan = prevDoc || null;

        lastPlan = planFromInputs(d, prevPlan);
        if(!lastPlan || !lastPlan.rows){
          throw new Error('Plan oluÅŸturulamadÄ±');
        }
        drawPlan(lastPlan);
        existInfo.style.display='none';
        btnHaftaSil.style.display='none';
        document.getElementById('btnKopyala').style.display='none';
        lastWeekKey = weekKey;
        // WhatsApp butonunu gÃ¶ster
        const btnWhatsApp = document.getElementById('btnWhatsApp');
        if(btnWhatsApp) btnWhatsApp.style.display = 'inline-flex';
        window.showToast('success', 'BaÅŸarÄ±lÄ±', 'Plan oluÅŸturuldu');
      } catch(e){
        console.error('Plan oluÅŸturma hatasÄ±:', e);
        window.showToast('error', 'Hata', e.message || 'Plan oluÅŸturulamadÄ±');
      } finally {
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }

    // PlanÄ± kaydet
    async function handlePlanKaydet(){
      if(!lastPlan || !lastPlan.rows || lastPlan.rows.length === 0){
        window.showToast('warning', 'UyarÄ±', 'Ã–nce planÄ± oluÅŸturun veya yÃ¼kleyin.');
        return;
      }

      const btn = document.getElementById('btnKaydet');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'â³ Kaydediliyor...';

      try{
        // tabloda yapÄ±lan deÄŸiÅŸiklikler lastPlan.rows iÃ§ine zaten yazÄ±lÄ±yor (select onChange)
        await savePlan(lastPlan);
        // Plan kaydedildikten sonra UI'yi gÃ¼ncelle
        existInfo.style.display='block';
        existInfo.textContent = `Plan kaydedildi (${lastWeekKey}).`;
        btnHaftaSil.style.display='inline-block';
        document.getElementById('btnKopyala').style.display='inline-block';
        // WhatsApp butonunu gÃ¶ster
        const btnWhatsApp = document.getElementById('btnWhatsApp');
        if(btnWhatsApp) btnWhatsApp.style.display = 'inline-flex';
      }catch(e){
        console.error('Kaydetme hatasÄ±:', e);
        window.showToast('error', 'Hata', 'Kaydetme hatasÄ±: ' + (e.message || 'Bilinmeyen hata'));
      }finally{
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }

    // HaftayÄ± kopyala
    async function handleHaftaKopyala(){
      if(!lastPlan || !lastWeekKey){
        window.showToast('warning', 'UyarÄ±', 'Ã–nce bir hafta yÃ¼kleyin.');
        return;
      }
      
      const targetDate = prompt(`Hangi haftaya kopyalanacak? (Tarih formatÄ±: YYYY-MM-DD)\n\nMevcut hafta: ${lastWeekKey}`);
      if(!targetDate) return;
      
      const d = new Date(targetDate+"T12:00:00");
      if(isNaN(d.getTime())){
        window.showToast('warning', 'UyarÄ±', 'GeÃ§ersiz tarih formatÄ±');
        return;
      }
      
      const { isoYear, weekNo } = isoWeek(d);
      const targetWeekKey = `${isoYear}-W${('0'+weekNo).slice(-2)}`;
      
      if(targetWeekKey === lastWeekKey){
        window.showToast('warning', 'UyarÄ±', 'AynÄ± haftaya kopyalayamazsÄ±nÄ±z');
        return;
      }
      
      if(!confirm(`${lastWeekKey} haftasÄ± ${targetWeekKey} haftasÄ±na kopyalanacak.\n\nMevcut plan Ã¼zerine yazÄ±lacak. Devam edilsin mi?`)){
        return;
      }
      
      const btn = document.getElementById('btnKopyala');
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'â³ KopyalanÄ±yor...';
      
      try{
        // Hedef haftanÄ±n indexlerini sil
        await deleteWeekIndex(targetWeekKey);
        
        // PlanÄ± kopyala (tarihleri gÃ¼ncelle)
        const weekDates = buildWeek(d);
        const copiedRows = lastPlan.rows.map((r, i) => {
          const tarihISO = toISO(weekDates[i]);
          return {
            ...r,
            tarihISO,
            monthKey: tarihISO.slice(0,7)
          };
        });
        
        const copiedPlan = {
          ...lastPlan,
          isoYear,
          weekNo,
          weekKey: targetWeekKey,
          rows: copiedRows
        };
        
        await savePlan(copiedPlan);
        window.showToast(`âœ… ${lastWeekKey} â†’ ${targetWeekKey} kopyalandÄ±`);
      }catch(e){
        console.error('Kopyalama hatasÄ±:', e);
        window.showToast('error', 'Hata', 'Kopyalama hatasÄ±: ' + (e.message || 'Bilinmeyen hata'));
      }finally{
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }

    // Bu haftayÄ± tamamen sil
    async function handleHaftaSil(){
      if(!lastWeekKey){
        window.showToast('warning', 'UyarÄ±', 'Hafta bulunamadÄ±.');
        return;
      }
      if(!confirm(`${lastWeekKey} haftasÄ±ndaki plan ve index kayÄ±tlarÄ± silinsin mi?\n\nBu iÅŸlem geri alÄ±namaz!`)){
        return;
      }

      const btn = btnHaftaSil;
      const originalText = btn.textContent;
      btn.disabled = true;
      btn.textContent = 'â³ Siliniyor...';

      try{
        const supabase = getSupabase();
        if(!supabase) throw new Error('Supabase yÃ¼klenmedi');
        
        // indexleri gÃ¼venli ÅŸekilde parÃ§a parÃ§a sil
        await deleteWeekIndex(lastWeekKey);

        // planÄ± sil
        const { error } = await supabase.from('nobet_planlari').delete().eq('id', lastWeekKey);
        if(error) throw error;

        window.showToast('success', 'BaÅŸarÄ±lÄ±', 'Hafta silindi.');
        document.getElementById('tbody').innerHTML='';
        existInfo.style.display='none';
        btnHaftaSil.style.display='none';
        document.getElementById('btnKopyala').style.display='none';
        lastPlan=null;
        lastWeekKey=null;
      }catch(e){
        console.error('Silme hatasÄ±:', e);
        window.showToast('error', 'Hata', e.message || 'Hafta silinemedi');
      }finally{
        btn.disabled = false;
        btn.textContent = originalText;
      }
    }

    // Bildirimler ortak.js'deki loadNotifications() tarafÄ±ndan yÃ¶netiliyor

    /* ===== Ä°statistikler ===== */
    async function loadStatistics(){
      try{
        const supabase = getSupabase();
        if(!supabase){
          window.showToast('error', 'Hata', 'Supabase baÄŸlantÄ±sÄ± yok');
          return;
        }
        
        const year = document.getElementById('statYear')?.value || '';
        const month = document.getElementById('statMonth')?.value || '';
        const role = document.getElementById('statRole')?.value || '';
        
        // YÄ±l listesini doldur
        const currentYear = new Date().getFullYear();
        const yearSelect = document.getElementById('statYear');
        if(yearSelect && yearSelect.children.length <= 1){
          for(let y = currentYear - 2; y <= currentYear + 1; y++){
            const opt = document.createElement('option');
            opt.value = y;
            opt.textContent = y;
            if(y === currentYear) opt.selected = true;
            yearSelect.appendChild(opt);
          }
        }
        
        // Supabase'den verileri Ã§ek
        let query = supabase.from('nobet_index').select('*');
        if(year) query = query.eq('year', String(year));
        if(month && year) query = query.eq('monthkey', `${year}-${String(month).padStart(2,'0')}`);
        if(role) query = query.eq('role', role);
        
        const { data, error } = await query;
        if(error) throw error;
        
        // Ä°statistikleri hesapla
        const stats = calculateStats(data);
        // renderStatistics(stats, data);
      }catch(e){
        console.error('Ä°statistik yÃ¼kleme hatasÄ±:', e);
        const errorMsg = e.message || e.details || 'Bilinmeyen hata';
        window.showToast('error', 'Hata', 'Ä°statistikler yÃ¼klenemedi: ' + errorMsg);
      }
    }
    
    function calculateStats(data){
      const personCount = {};
      const monthlyCount = {};
      const roleCount = { bekar: 0, evli: 0 };
      
      data.forEach(d => {
        // KiÅŸi bazÄ±nda
        if(d.person){
          if(!personCount[d.person]) personCount[d.person] = 0;
          personCount[d.person]++;
        }
        
        // AylÄ±k
        if(d.monthKey){
          if(!monthlyCount[d.monthKey]) monthlyCount[d.monthKey] = 0;
          monthlyCount[d.monthKey]++;
        }
        
        // Rol bazÄ±nda
        if(d.role === 'bekar') roleCount.bekar++;
        else if(d.role === 'evli') roleCount.evli++;
      });
      
      return { personCount, monthlyCount, roleCount, total: data.length };
    }
    
    function renderStatistics(stats, data){
      // Ä°statistik kartlarÄ±
      const cards = document.getElementById('statCards');
      if(cards){
        cards.innerHTML = `
          <div class="stat-card">
            <div class="label">Toplam NÃ¶bet</div>
            <div class="val">${stats.total}</div>
          </div>
          <div class="stat-card">
            <div class="label">BekÃ¢r NÃ¶bet</div>
            <div class="val">${stats.roleCount.bekar}</div>
          </div>
          <div class="stat-card">
            <div class="label">Evli NÃ¶bet</div>
            <div class="val">${stats.roleCount.evli}</div>
          </div>
          <div class="stat-card">
            <div class="label">Toplam KiÅŸi</div>
            <div class="val">${Object.keys(stats.personCount).length}</div>
          </div>
        `;
      }
      
      // KiÅŸi bazÄ±nda grafik (basit bar chart)
      const chartPerson = document.getElementById('chartPerson');
      if(chartPerson){
        const sortedPersons = Object.entries(stats.personCount)
          .sort((a,b) => b[1] - a[1])
          .slice(0, 15);
        
        if(sortedPersons.length === 0){
          chartPerson.innerHTML = '<div class="muted" style="text-align:center; padding:40px">HenÃ¼z veri yok</div>';
        }else{
          const maxCount = Math.max(...sortedPersons.map(p => p[1]));
          chartPerson.innerHTML = sortedPersons.map(([person, count]) => {
            const width = (count / maxCount) * 100;
            return `
              <div style="display:flex; align-items:center; gap:12px; margin-bottom:12px">
                <div style="flex:0 0 120px; font-size:13px; font-weight:600">${person}</div>
                <div style="flex:1; background:var(--pill); border-radius:8px; height:28px; position:relative; overflow:hidden">
                  <div style="background:linear-gradient(90deg, var(--brand), var(--brand2)); height:100%; width:${width}%; border-radius:8px; display:flex; align-items:center; padding:0 10px; color:#fff; font-weight:700; font-size:12px">${count}</div>
                </div>
              </div>
            `;
          }).join('');
        }
      }
      
      // AylÄ±k grafik
      const chartMonthly = document.getElementById('chartMonthly');
      if(chartMonthly){
        const sortedMonths = Object.entries(stats.monthlyCount)
          .sort((a,b) => a[0].localeCompare(b[0]))
          .slice(-12);
        
        if(sortedMonths.length === 0){
          chartMonthly.innerHTML = '<div class="muted" style="text-align:center; padding:40px">HenÃ¼z veri yok</div>';
        }else{
          const maxMonth = Math.max(...sortedMonths.map(m => m[1]), 1);
          const monthNames = ['Ocak','Åubat','Mart','Nisan','MayÄ±s','Haziran','Temmuz','AÄŸustos','EylÃ¼l','Ekim','KasÄ±m','AralÄ±k'];
          chartMonthly.innerHTML = sortedMonths.map(([monthKey, count]) => {
            const [year, month] = monthKey.split('-');
            const monthName = monthNames[parseInt(month) - 1] || month;
            const width = (count / maxMonth) * 100;
            return `
              <div style="display:flex; align-items:center; gap:12px; margin-bottom:12px">
                <div style="flex:0 0 100px; font-size:13px; font-weight:600">${monthName} ${year}</div>
                <div style="flex:1; background:var(--pill); border-radius:8px; height:28px; position:relative; overflow:hidden">
                  <div style="background:linear-gradient(90deg, #8b5cf6, #a78bfa); height:100%; width:${width}%; border-radius:8px; display:flex; align-items:center; padding:0 10px; color:#fff; font-weight:700; font-size:12px">${count}</div>
                </div>
              </div>
            `;
          }).join('');
        }
      }
      
      // En Ã§ok/az nÃ¶bet tutanlar
      const topList = Object.entries(stats.personCount)
        .sort((a,b) => b[1] - a[1])
        .slice(0, 5);
      const bottomList = Object.entries(stats.personCount)
        .sort((a,b) => a[1] - b[1])
        .slice(0, 5);
      
      const topDiv = document.getElementById('topNobetciler');
      if(topDiv){
        topDiv.innerHTML = topList.length > 0 
          ? topList.map(([person, count], i) => `
              <div style="display:flex; justify-content:space-between; padding:8px; background:var(--pill); border-radius:8px; margin-bottom:6px">
                <span><strong>${i+1}.</strong> ${person}</span>
                <span style="color:var(--brand); font-weight:700">${count}</span>
              </div>
            `).join('')
          : '<div class="muted">Veri yok</div>';
      }
      
      const bottomDiv = document.getElementById('azNobetciler');
      if(bottomDiv){
        bottomDiv.innerHTML = bottomList.length > 0
          ? bottomList.map(([person, count], i) => `
              <div style="display:flex; justify-content:space-between; padding:8px; background:var(--pill); border-radius:8px; margin-bottom:6px">
                <span><strong>${i+1}.</strong> ${person}</span>
                <span style="color:var(--muted); font-weight:700">${count}</span>
              </div>
            `).join('')
          : '<div class="muted">Veri yok</div>';
      }
    }
    
    /* ===== GeÃ§miÅŸ ===== */
    async function loadHistory(){
      try{
        const supabase = getSupabase();
        if(!supabase){
          window.showToast('error', 'Hata', 'Supabase baÄŸlantÄ±sÄ± yok');
          return;
        }
        
        const startDate = document.getElementById('historyStart')?.value || '';
        const endDate = document.getElementById('historyEnd')?.value || '';
        const person = document.getElementById('historyPerson')?.value || '';
        
        // KiÅŸi listesini doldur
        const personSelect = document.getElementById('historyPerson');
        if(personSelect && personSelect.children.length <= 1){
          const { data: personData } = await supabase.from('nobet_index').select('person').order('person').limit(1000);
          const persons = new Set();
          (personData || []).forEach(d => {
            if(d.person) persons.add(d.person);
          });
          Array.from(persons).sort().forEach(p => {
            const opt = document.createElement('option');
            opt.value = p;
            opt.textContent = p;
            personSelect.appendChild(opt);
          });
        }
        
        // Verileri Ã§ek
        let query = supabase.from('nobet_index').select('*').order('date', { ascending: false });
        if(startDate) query = query.gte('date', startDate);
        if(endDate) query = query.lte('date', endDate);
        if(person) query = query.eq('person', person);
        
        const { data, error } = await query.limit(500);
        if(error) throw error;
        
        const tbody = document.getElementById('historyTbody');
        const info = document.getElementById('historyInfo');
        
        if(!data || data.length === 0){
          if(tbody) tbody.innerHTML = '<tr><td colspan="6" style="text-align:center; padding:40px" class="muted">KayÄ±t bulunamadÄ±</td></tr>';
          if(info) info.textContent = '0 kayÄ±t bulundu';
          return;
        }
        
        if(tbody){
          tbody.innerHTML = '';
          data.forEach(d => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${d.date || 'â€”'}</td>
              <td>${d.day || 'â€”'}</td>
              <td><strong>${d.person || 'â€”'}</strong></td>
              <td><span class="pill" style="font-size:11px">${d.role === 'bekar' ? 'ğŸ‘¤ BekÃ¢r' : 'ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Evli'}</span></td>
              <td><span class="time">${d.saat || 'â€”'}</span></td>
              <td><span class="pill" style="font-size:11px">${d.type || 'â€”'}</span></td>
            `;
            tbody.appendChild(tr);
          });
        }
        
        if(info) info.textContent = `${data.length} kayÄ±t gÃ¶steriliyor`;
      }catch(e){
        console.error('GeÃ§miÅŸ yÃ¼kleme hatasÄ±:', e);
        window.showToast('error', 'Hata', 'GeÃ§miÅŸ yÃ¼klenemedi: ' + (e.message || 'Bilinmeyen hata'));
      }
    }
    

    /* ===== Dashboard ===== */
    async function loadDashboard(){
      try{
        const supabase = getSupabase();
        if(!supabase){
          window.showToast('error', 'Hata', 'Supabase baÄŸlantÄ±sÄ± yok');
          return;
        }
        
        const year1 = document.getElementById('dashboardYear1')?.value || '';
        const year2 = document.getElementById('dashboardYear2')?.value || '';
        const view = document.getElementById('dashboardView')?.value || 'yearly';
        
        // YÄ±l listelerini doldur
        const currentYear = new Date().getFullYear();
        [document.getElementById('dashboardYear1'), document.getElementById('dashboardYear2')].forEach((select, idx) => {
          if(select && select.children.length <= 1){
            for(let y = currentYear - 3; y <= currentYear; y++){
              const opt = document.createElement('option');
              opt.value = y;
              opt.textContent = y;
              if((idx === 0 && y === currentYear) || (idx === 1 && y === currentYear - 1)) opt.selected = true;
              select.appendChild(opt);
            }
          }
        });
        
        // Supabase'den verileri Ã§ek
        const { data: indexData, error } = await supabase.from('nobet_index').select('*');
        if(error) throw error;
        
        const data = [];
        (indexData || []).forEach(d => {
          data.push({
            person: d.person,
            role: d.role,
            date: d.date,
            monthKey: d.monthKey,
            year: d.year,
            month: d.monthKey ? d.monthKey.split('-')[1] : null
          });
        });
        
        renderDashboard(data, year1 || currentYear, year2 || (currentYear - 1), view);
      }catch(e){
        console.error('Dashboard yÃ¼kleme hatasÄ±:', e);
        window.showToast('error', 'Hata', 'Dashboard yÃ¼klenemedi: ' + (e.message || 'Bilinmeyen hata'));
      }
    }
    
    function renderDashboard(data, year1, year2, view){
      // Dashboard kartlarÄ±
      const currentMonth = new Date().getMonth() + 1;
      const currentYear = new Date().getFullYear();
      const currentMonthKey = `${currentYear}-${String(currentMonth).padStart(2,'0')}`;
      const prevMonthKey = currentMonth === 1 
        ? `${currentYear - 1}-12`
        : `${currentYear}-${String(currentMonth - 1).padStart(2,'0')}`;
      
      const currentMonthData = data.filter(d => d.monthKey === currentMonthKey);
      const prevMonthData = data.filter(d => d.monthKey === prevMonthKey);
      const year1Data = data.filter(d => d.year === year1);
      const year2Data = data.filter(d => d.year === year2);
      
      const cards = document.getElementById('dashboardCards');
      if(cards){
        const currentTotal = currentMonthData.length;
        const prevTotal = prevMonthData.length;
        const trend = currentTotal - prevTotal;
        const trendPercent = prevTotal > 0 ? ((trend / prevTotal) * 100).toFixed(1) : 0;
        
        cards.innerHTML = `
          <div class="dashboard-card">
            <h4>Bu Ay Toplam</h4>
            <div class="big-val">${currentTotal}</div>
            <div class="trend ${trend >= 0 ? 'up' : 'down'}">
              ${trend >= 0 ? 'ğŸ“ˆ' : 'ğŸ“‰'} ${Math.abs(trend)} (${trendPercent}%)
              <span style="color:var(--muted); font-size:11px">Ã¶nceki aya gÃ¶re</span>
            </div>
          </div>
          <div class="dashboard-card">
            <h4>${year1} YÄ±lÄ± Toplam</h4>
            <div class="big-val">${year1Data.length}</div>
            <div class="trend">
              <span style="color:var(--muted); font-size:11px">${year1Data.filter(d => d.role === 'bekar').length} bekÃ¢r, ${year1Data.filter(d => d.role === 'evli').length} evli</span>
            </div>
          </div>
          <div class="dashboard-card">
            <h4>${year2} YÄ±lÄ± Toplam</h4>
            <div class="big-val">${year2Data.length}</div>
            <div class="trend">
              <span style="color:var(--muted); font-size:11px">${year2Data.filter(d => d.role === 'bekar').length} bekÃ¢r, ${year2Data.filter(d => d.role === 'evli').length} evli</span>
            </div>
          </div>
          <div class="dashboard-card">
            <h4>Aktif KiÅŸi SayÄ±sÄ±</h4>
            <div class="big-val">${new Set(data.map(d => d.person)).size}</div>
            <div class="trend">
              <span style="color:var(--muted); font-size:11px">Toplam ${new Set(data.map(d => d.person)).size} farklÄ± kiÅŸi</span>
            </div>
          </div>
        `;
      }
      
      // Trend grafiÄŸi
      if(view === 'monthly' || view === 'yearly'){
        renderTrendChart(data, year1, view);
      }
      
      // KarÅŸÄ±laÅŸtÄ±rma grafiÄŸi
      if(view === 'comparison' && year1 && year2){
        renderComparisonChart(data, year1, year2);
      }
    }
    
    function renderTrendChart(data, year, view){
      const chartDiv = document.getElementById('trendChart');
      if(!chartDiv) return;
      
      const monthNames = ['Ocak','Åubat','Mart','Nisan','MayÄ±s','Haziran','Temmuz','AÄŸustos','EylÃ¼l','Ekim','KasÄ±m','AralÄ±k'];
      let chartData = {};
      
      if(view === 'monthly'){
        data.filter(d => d.year === year).forEach(d => {
          if(d.monthKey){
            if(!chartData[d.monthKey]) chartData[d.monthKey] = 0;
            chartData[d.monthKey]++;
          }
        });
      }else{
        data.forEach(d => {
          if(d.year){
            if(!chartData[d.year]) chartData[d.year] = 0;
            chartData[d.year]++;
          }
        });
      }
      
      const sorted = Object.entries(chartData).sort((a,b) => a[0].localeCompare(b[0]));
      const maxVal = Math.max(...sorted.map(s => s[1]), 1);
      
      chartDiv.innerHTML = `
        <div class="comparison-chart" style="height:250px">
          ${sorted.map(([key, val]) => {
            const height = (val / maxVal) * 100;
            const label = view === 'monthly' 
              ? `${monthNames[parseInt(key.split('-')[1]) - 1] || ''} ${key.split('-')[0]}`
              : key;
            return `
              <div class="comparison-bar-wrapper">
                <div class="comparison-bar" data-val="${val}" style="height:${height}%; width:100%; background:linear-gradient(180deg, var(--brand), var(--brand2))"></div>
                <div class="month-label">${label}</div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    }
    
    function renderComparisonChart(data, year1, year2){
      const chartDiv = document.getElementById('comparisonChart');
      const legendDiv = document.getElementById('comparisonLegend');
      if(!chartDiv || !legendDiv) return;
      
      const monthNames = ['Ocak','Åubat','Mart','Nisan','MayÄ±s','Haziran','Temmuz','AÄŸustos','EylÃ¼l','Ekim','KasÄ±m','AralÄ±k'];
      const year1Data = {};
      const year2Data = {};
      
      data.filter(d => d.year === year1).forEach(d => {
        if(d.monthKey){
          if(!year1Data[d.monthKey]) year1Data[d.monthKey] = 0;
          year1Data[d.monthKey]++;
        }
      });
      
      data.filter(d => d.year === year2).forEach(d => {
        if(d.monthKey){
          if(!year2Data[d.monthKey]) year2Data[d.monthKey] = 0;
          year2Data[d.monthKey]++;
        }
      });
      
      const allMonths = new Set([...Object.keys(year1Data), ...Object.keys(year2Data)]);
      const sortedMonths = Array.from(allMonths).sort();
      const maxVal = Math.max(
        ...Object.values(year1Data),
        ...Object.values(year2Data),
        1
      );
      
      chartDiv.innerHTML = `
        <div class="comparison-chart" style="height:300px; gap:4px">
          ${sortedMonths.map(monthKey => {
            const val1 = year1Data[monthKey] || 0;
            const val2 = year2Data[monthKey] || 0;
            const height1 = (val1 / maxVal) * 100;
            const height2 = (val2 / maxVal) * 100;
            const month = parseInt(monthKey.split('-')[1]);
            return `
              <div class="comparison-bar-wrapper">
                <div class="comparison-bar-group">
                  <div class="comparison-bar" data-val="${val1}" style="height:${height1}%; width:48%; background:linear-gradient(180deg, var(--brand), var(--brand2)); z-index:2"></div>
                  <div class="comparison-bar" data-val="${val2}" style="height:${height2}%; width:48%; background:linear-gradient(180deg, #8b5cf6, #a78bfa); z-index:1"></div>
                </div>
                <div class="month-label">${monthNames[month - 1] || ''}</div>
              </div>
            `;
          }).join('')}
        </div>
      `;
      
      legendDiv.innerHTML = `
        <div style="display:flex; align-items:center; gap:8px">
          <div style="width:20px; height:20px; background:linear-gradient(180deg, var(--brand), var(--brand2)); border-radius:4px"></div>
          <span style="font-size:12px; font-weight:600">${year1}</span>
        </div>
        <div style="display:flex; align-items:center; gap:8px">
          <div style="width:20px; height:20px; background:linear-gradient(180deg, #8b5cf6, #a78bfa); border-radius:4px"></div>
          <span style="font-size:12px; font-weight:600">${year2}</span>
        </div>
      `;
    }
    
    
    /* ===== Raporlar ===== */
    function initReports(){
      const currentYear = new Date().getFullYear();
      const yearSelect = document.getElementById('reportYear');
      if(yearSelect && yearSelect.children.length <= 1){
        for(let y = currentYear - 2; y <= currentYear; y++){
          const opt = document.createElement('option');
          opt.value = y;
          opt.textContent = y;
          if(y === currentYear) opt.selected = true;
          yearSelect.appendChild(opt);
        }
      }
    }
    
    async function generateReport(){
      try{
        const supabase = getSupabase();
        if(!supabase){
          window.showToast('error', 'Hata', 'Supabase baÄŸlantÄ±sÄ± yok');
          return;
        }
        
        const year = document.getElementById('reportYear')?.value;
        const month = document.getElementById('reportMonth')?.value;
        
        if(!year){
          window.showToast('warning', 'UyarÄ±', 'LÃ¼tfen yÄ±l seÃ§in');
          return;
        }
        
        // Supabase'den verileri Ã§ek
        let query = supabase.from('nobet_index').select('*');
        if(year) query = query.eq('year', String(year));
        if(month && year) query = query.eq('monthkey', `${year}-${String(month).padStart(2,'0')}`);
        
        const { data, error } = await query;
        if(error) throw error;
        
        renderReport(data, year, month);
      }catch(e){
        console.error('Rapor oluÅŸturma hatasÄ±:', e);
        const errorMsg = e.message || e.details || 'Bilinmeyen hata';
        window.showToast('error', 'Hata', 'Rapor oluÅŸturulamadÄ±: ' + errorMsg);
      }
    }
    
    function renderReport(data, year, month){
      const monthNames = ['Ocak','Åubat','Mart','Nisan','MayÄ±s','Haziran','Temmuz','AÄŸustos','EylÃ¼l','Ekim','KasÄ±m','AralÄ±k'];
      const reportDiv = document.getElementById('reportContent');
      if(!reportDiv) return;
      
      // KiÅŸi bazÄ±nda grupla
      const personStats = {};
      const monthlyStats = {};
      
      data.forEach(d => {
        if(d.person){
          if(!personStats[d.person]) personStats[d.person] = {total: 0, bekar: 0, evli: 0};
          personStats[d.person].total++;
          if(d.role === 'bekar') personStats[d.person].bekar++;
          else if(d.role === 'evli') personStats[d.person].evli++;
        }
        
        if(d.monthKey){
          if(!monthlyStats[d.monthKey]) monthlyStats[d.monthKey] = 0;
          monthlyStats[d.monthKey]++;
        }
      });
      
      const sortedPersons = Object.entries(personStats).sort((a,b) => b[1].total - a[1].total);
      const sortedMonths = Object.entries(monthlyStats).sort((a,b) => a[0].localeCompare(b[0]));
      
      const totalNobet = data.length;
      const totalBekar = data.filter(d => d.role === 'bekar').length;
      const totalEvli = data.filter(d => d.role === 'evli').length;
      const totalPerson = Object.keys(personStats).length;
      
      const reportTitle = month 
        ? `${monthNames[parseInt(month) - 1]} ${year} AylÄ±k Ã–zet Raporu`
        : `${year} YÄ±llÄ±k Ã–zet Raporu`;
      
      reportDiv.innerHTML = `
        <div class="report-section">
          <div class="report-header">
            <h3>${reportTitle}</h3>
            <div class="report-actions">
              <button class="iconbtn print-keep" onclick="window.print()">ğŸ–¨ï¸ YazdÄ±r</button>
            </div>
          </div>
          
          <div class="report-summary">
            <div class="report-summary-item">
              <div class="label">Toplam NÃ¶bet</div>
              <div class="value">${totalNobet}</div>
            </div>
            <div class="report-summary-item">
              <div class="label">BekÃ¢r NÃ¶bet</div>
              <div class="value">${totalBekar}</div>
            </div>
            <div class="report-summary-item">
              <div class="label">Evli NÃ¶bet</div>
              <div class="value">${totalEvli}</div>
            </div>
            <div class="report-summary-item">
              <div class="label">Toplam KiÅŸi</div>
              <div class="value">${totalPerson}</div>
            </div>
          </div>
          
          <h4 style="margin-top:24px; margin-bottom:12px">KiÅŸi BazÄ±nda Detay</h4>
          <table class="report-table">
            <thead>
              <tr>
                <th>SÄ±ra</th>
                <th>KiÅŸi</th>
                <th>Toplam</th>
                <th>BekÃ¢r</th>
                <th>Evli</th>
              </tr>
            </thead>
            <tbody>
              ${sortedPersons.map(([person, stats], idx) => `
                <tr>
                  <td>${idx + 1}</td>
                  <td><strong>${person}</strong></td>
                  <td>${stats.total}</td>
                  <td>${stats.bekar}</td>
                  <td>${stats.evli}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>
          
          ${!month ? `
            <h4 style="margin-top:24px; margin-bottom:12px">AylÄ±k DaÄŸÄ±lÄ±m</h4>
            <table class="report-table">
              <thead>
                <tr>
                  <th>Ay</th>
                  <th>NÃ¶bet SayÄ±sÄ±</th>
                </tr>
              </thead>
              <tbody>
                ${sortedMonths.map(([monthKey, count]) => {
                  const [y, m] = monthKey.split('-');
                  return `
                    <tr>
                      <td>${monthNames[parseInt(m) - 1]} ${y}</td>
                      <td><strong>${count}</strong></td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          ` : ''}
        </div>
      `;
    }
    
    // BaÅŸlangÄ±Ã§
    setToday();

    // Sayfa yÃ¼klendiÄŸinde initPage'i Ã§aÄŸÄ±r ve event listener'larÄ± baÄŸla
    // NOT: initPage artÄ±k Supabase client oluÅŸturulduktan sonra IIFE iÃ§inden Ã§aÄŸrÄ±lÄ±yor
    // Burada sadece event listener'larÄ± baÄŸlÄ±yoruz (initPage zaten IIFE'den Ã§aÄŸrÄ±ldÄ±)
    // EÄŸer initPage henÃ¼z Ã§aÄŸrÄ±lmadÄ±ysa (IIFE henÃ¼z Ã§alÄ±ÅŸmadÄ±ysa), bekle
    if(typeof window.initPage === 'function' && !window.initPageCalled){
      // IIFE client'Ä± oluÅŸturduÄŸunda initPage'i Ã§aÄŸÄ±racak, burada sadece event listener'larÄ± bekliyoruz
      const checkInitPage = setInterval(() => {
        if(window.initPageCalled) {
          clearInterval(checkInitPage);
          // initPage tamamlandÄ±ktan sonra event listener'larÄ± baÄŸla
          if(typeof initEventListeners === 'function') {
            initEventListeners();
          }
        }
      }, 100);
      // Max 5 saniye bekle
      setTimeout(() => {
        clearInterval(checkInitPage);
        // Timeout olduysa bile event listener'larÄ± baÄŸla
        if(typeof initEventListeners === 'function') {
          initEventListeners();
        }
      }, 5000);
    } else {
      // initPage zaten Ã§aÄŸrÄ±ldÄ± veya yoksa sadece event listener'larÄ± baÄŸla
      if(document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', initEventListeners);
      } else {
        initEventListeners();
      }
    }
  </script>
</body>
</html>
