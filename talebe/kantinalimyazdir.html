<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Alƒ±m Yazdƒ±r</title>
  <link rel="icon" type="image/png" href="../img/logo.png" />
  <style>
    @media print {
      body { margin: 0; padding: 20px; }
      .no-print { display: none !important; }
      .header { border-bottom: 3px solid #0ea5e9 !important; }
      table { page-break-inside: avoid; }
      tr { page-break-inside: avoid; }
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: 'Segoe UI', system-ui, -apple-system, Arial, sans-serif;
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
      color: #0b1220;
      background: #f3f6fc;
    }
    .header {
      text-align: center;
      margin-bottom: 30px;
      border-bottom: 3px solid #0ea5e9;
      padding-bottom: 20px;
      background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
      color: white;
      padding: 25px 20px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(14, 165, 233, 0.2);
    }
    .header h1 {
      margin: 0;
      font-size: 24px;
      font-weight: 900;
      color: white;
      text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .header .tarih {
      margin-top: 12px;
      font-size: 18px;
      font-weight: 600;
      color: rgba(255,255,255,0.95);
    }
    .info-section {
      margin: 25px 0;
      padding: 20px;
      background: linear-gradient(135deg, #f9fafb 0%, #f3f6fc 100%);
      border-radius: 12px;
      border-left: 4px solid #0ea5e9;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .info-row {
      display: flex;
      justify-content: space-between;
      margin-bottom: 12px;
      padding: 10px;
      background: white;
      border-radius: 8px;
      font-size: 15px;
    }
    .info-row:last-child {
      margin-bottom: 0;
    }
    .info-label {
      font-weight: 700;
      color: #0ea5e9;
    }
    .info-value {
      color: #0b1220;
      font-weight: 600;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 25px 0;
      background: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      border-radius: 8px;
      overflow: hidden;
      table-layout: fixed;
    }
    th, td {
      border: 1px solid #e5e7eb;
      padding: 12px;
      text-align: left;
    }
    th {
      background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
      color: white;
      font-weight: 800;
      text-align: center;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    td {
      text-align: center;
      font-size: 14px;
    }
    tbody tr:nth-child(even) {
      background: #f9fafb;
    }
    tbody tr:hover {
      background: #f3f6fc;
    }
    tfoot tr {
      border-top: 3px solid #0ea5e9;
    }
    tfoot td {
      padding: 12px;
      text-align: center;
      font-size: 14px;
    }
    .yeni-urun {
      color: #16a34a;
      font-size: 12px;
      font-weight: 700;
      margin-left: 6px;
    }
    .total {
      margin-top: 25px;
      padding: 20px;
      background: linear-gradient(135deg, #f3f6fc 0%, #e0e7ff 100%);
      border-radius: 12px;
      border: 2px solid #0ea5e9;
      box-shadow: 0 4px 12px rgba(14, 165, 233, 0.15);
      text-align: right;
      font-size: 24px;
      font-weight: 900;
      color: #0ea5e9;
      text-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .no-print {
      text-align: center;
      margin: 30px 0;
    }
    .no-print button {
      background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
      color: white;
      border: none;
      padding: 14px 28px;
      margin: 0 10px;
      border-radius: 10px;
      font-size: 16px;
      font-weight: 800;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(14, 165, 233, 0.3);
      transition: all 0.2s;
    }
    .no-print button:hover {
      background: linear-gradient(135deg, #0284c7 0%, #0369a1 100%);
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(14, 165, 233, 0.4);
    }
    .loading {
      text-align: center;
      padding: 60px;
      color: #4b5563;
    }
    .spinner {
      width: 40px;
      height: 40px;
      border: 4px solid #e5e7eb;
      border-top-color: #0ea5e9;
      border-radius: 50%;
      animation: spin .8s linear infinite;
      margin: 0 auto 16px;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
  </style>
</head>
<body>
  <div id="loading" class="loading">
    <div class="spinner"></div>
    <div>Alƒ±m bilgileri y√ºkleniyor...</div>
  </div>
  
  <div id="content" style="display:none">
    <div class="header">
      <h1>√úr√ºn Alƒ±m Raporu</h1>
      <div class="tarih" id="tarihDisplay">Tarih: -</div>
    </div>
    
    <div class="info-section" id="alimInfo"></div>
    
    <table id="urunTable">
      <thead>
        <tr>
          <th colspan="2" style="width:280px">Yeni - √úr√ºn Adƒ±</th>
          <th style="width:100px">Miktar</th>
          <th style="width:130px">Birim Alƒ±≈ü Fiyatƒ±</th>
          <th style="width:150px">Toplam Alƒ±≈ü Fiyatƒ±</th>
          <th style="width:130px">Birim Satƒ±≈ü Fiyatƒ±</th>
          <th style="width:120px">K√¢r Oranƒ±</th>
        </tr>
      </thead>
      <tbody id="urunTbody"></tbody>
      <tfoot id="urunTfoot"></tfoot>
    </table>
    
    <div class="total" id="totalDiv"></div>
    
    <div class="no-print">
      <button onclick="window.print()">üñ® Yazdƒ±r</button>
      <button onclick="window.close()">‚úñ Kapat</button>
    </div>
  </div>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <script src="../js/firebase/firebase-init.js"></script>
  <script>
    (async function(){
      const db = firebase.firestore();
      
      const urlParams = new URLSearchParams(window.location.search);
      const alimId = urlParams.get('id');
      
      if(!alimId){
        document.getElementById('loading').textContent = 'Alƒ±m ID bulunamadƒ±';
        return;
      }
      
      async function loadAlim(){
      try{
        const alimDoc = await db.collection('kantin_alinimlar').doc(alimId).get();
        
        if(!alimDoc.exists){
          document.getElementById('loading').textContent = 'Alƒ±m kaydƒ± bulunamadƒ±';
          return;
        }
        
        const data = alimDoc.data();
        const tarih = data.tarih || '-';
        const toplamTutar = parseFloat(data.toplamTutar || 0);
        const urunler = data.urunler || [];
        const aciklama = data.aciklama || '';
        
        // Tarih formatƒ±nƒ± d√ºzenle (YYYY-MM-DD -> DD.MM.YYYY)
        let tarihFormatted = tarih;
        if(tarih && tarih.includes('-')){
          const [y, m, g] = tarih.split('-');
          tarihFormatted = g + '.' + m + '.' + y;
        }
        
        // Tarih g√∂ster
        document.getElementById('tarihDisplay').textContent = 'üìÖ ' + tarihFormatted;
        
        // Bilgi satƒ±rlarƒ±
        let infoHtml = '';
        if(aciklama){
          infoHtml = '<div class="info-row">' +
            '<span class="info-label">üìù A√ßƒ±klama:</span>' +
            '<span class="info-value">' + aciklama + '</span>' +
            '</div>';
        }
        document.getElementById('alimInfo').innerHTML = infoHtml || '<div class="info-row"><span class="info-label">‚ÑπÔ∏è</span><span class="info-value">A√ßƒ±klama yok</span></div>';
        
        // √úr√ºn tablosu
        const tbody = document.getElementById('urunTbody');
        const tfoot = document.getElementById('urunTfoot');
        
        let toplamAlis = 0;
        let toplamSatis = 0;
        let toplamKar = 0;
        
        if(urunler.length === 0){
          tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; color:#9ca3af; padding:30px">√úr√ºn bulunamadƒ±</td></tr>';
          tfoot.innerHTML = '';
        } else {
          tbody.innerHTML = urunler.map(u=>{
            const birimAlis = parseFloat(u.birimAlisFiyat || 0);
            const toplamAlisUrun = parseFloat(u.toplamAlisFiyat || 0);
            const birimSatis = parseFloat(u.birimSatisFiyat || 0);
            const miktar = parseInt(u.miktar || 0);
            const toplamSatisUrun = birimSatis * miktar;
            const karUrun = toplamSatisUrun - toplamAlisUrun;
            const karOrani = birimAlis > 0 ? ((birimSatis - birimAlis) / birimAlis) * 100 : 0;
            
            // Toplamlarƒ± hesapla
            toplamAlis += toplamAlisUrun;
            toplamSatis += toplamSatisUrun;
            toplamKar += karUrun;
            
            // K√¢r oranƒ± hesaplama ve renklendirme
            const karArtis = karOrani > 0;
            const karRenk = karArtis ? '#16a34a' : (karOrani < 0 ? '#dc2626' : '#4b5563');
            const karOk = karArtis ? '‚Üë' : (karOrani < 0 ? '‚Üì' : '‚Üí');
            const karIsaret = karArtis ? '+' : '';
            const karOraniFormatted = karOrani.toFixed(2);
            
            const yeniBadge = u.yeniUrun ? '<span style="color:#16a34a; font-weight:800; font-size:14px">‚ú® YENƒ∞</span>' : '<span style="color:#9ca3af">-</span>';
            const rowStyle = u.yeniUrun ? 'background:#f0fdf4;' : '';
            
            return '<tr style="' + rowStyle + '">' +
              '<td style="text-align:center; font-weight:700">' + yeniBadge + '</td>' +
              '<td style="text-align:left; font-weight:600">' + (u.urunAd || '-') + '</td>' +
              '<td style="font-weight:700">' + miktar + ' adet</td>' +
              '<td style="font-weight:600">‚Ç∫ ' + birimAlis.toLocaleString('tr-TR',{minimumFractionDigits:2,maximumFractionDigits:2}) + '</td>' +
              '<td style="font-weight:700; color:#0ea5e9">‚Ç∫ ' + toplamAlisUrun.toLocaleString('tr-TR',{minimumFractionDigits:2,maximumFractionDigits:2}) + '</td>' +
              '<td style="font-weight:700; color:#16a34a">‚Ç∫ ' + birimSatis.toLocaleString('tr-TR',{minimumFractionDigits:2,maximumFractionDigits:2}) + '</td>' +
              '<td style="font-weight:800; color:' + karRenk + '; font-size:15px">' + karOk + ' ' + karIsaret + karOraniFormatted + '%</td>' +
              '</tr>';
          }).join('');
          
          // Toplam satƒ±rƒ±
          const toplamOran = toplamAlis > 0 ? ((toplamSatis - toplamAlis) / toplamAlis) * 100 : 0;
          const toplamKarArtis = toplamOran > 0;
          const toplamKarRenk = toplamKarArtis ? '#16a34a' : (toplamOran < 0 ? '#dc2626' : '#4b5563');
          const toplamKarOk = toplamKarArtis ? '‚Üë' : (toplamOran < 0 ? '‚Üì' : '‚Üí');
          const toplamKarIsaret = toplamKarArtis ? '+' : '';
          
          tfoot.innerHTML = '<tr style="background:linear-gradient(135deg, #f3f6fc 0%, #e0e7ff 100%); font-weight:900; border-top:3px solid #0ea5e9">' +
            '<td colspan="2" style="text-align:left; padding:15px; font-size:16px; color:#0b1220">TOPLAM</td>' +
            '<td style="padding:15px; font-size:15px; color:#0b1220">-</td>' +
            '<td style="padding:15px; font-size:15px; color:#0b1220">-</td>' +
            '<td style="padding:15px; font-size:16px; color:#0ea5e9; font-weight:900">‚Ç∫ ' + toplamAlis.toLocaleString('tr-TR',{minimumFractionDigits:2,maximumFractionDigits:2}) + '</td>' +
            '<td style="padding:15px; font-size:16px; color:#16a34a; font-weight:900">‚Ç∫ ' + toplamSatis.toLocaleString('tr-TR',{minimumFractionDigits:2,maximumFractionDigits:2}) + '</td>' +
            '<td style="padding:15px; font-size:16px; color:' + toplamKarRenk + '; font-weight:900">' + toplamKarOk + ' ' + toplamKarIsaret + toplamOran.toFixed(2) + '%</td>' +
            '</tr>' +
            '<tr style="background:linear-gradient(135deg, #f3f6fc 0%, #e0e7ff 100%); font-weight:900; border-top:2px solid #0ea5e9">' +
            '<td colspan="4" style="text-align:left; padding:12px; font-size:15px; color:#0b1220">TOPLAM K√ÇR:</td>' +
            '<td colspan="3" style="text-align:right; padding:12px; font-size:18px; color:' + (toplamKar >= 0 ? '#16a34a' : '#dc2626') + '; font-weight:900">‚Ç∫ ' + toplamKar.toLocaleString('tr-TR',{minimumFractionDigits:2,maximumFractionDigits:2}) + '</td>' +
            '</tr>';
        }
        
        // Toplam
        document.getElementById('totalDiv').innerHTML = 
          '<div style="display:flex; justify-content:space-between; align-items:center">' +
          '<span>Toplam Tutar:</span>' +
          '<span style="font-size:28px">‚Ç∫ ' + toplamTutar.toLocaleString('tr-TR',{minimumFractionDigits:2,maximumFractionDigits:2}) + '</span>' +
          '</div>';
        
        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';
        
      }catch(e){
        console.error(e);
        document.getElementById('loading').textContent = 'Alƒ±m y√ºklenirken hata olu≈ütu: ' + (e.message || 'Bilinmeyen hata');
      }
    }
    
      await loadAlim();
    })();
  </script>
</body>
</html>

