<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>KaraaÄŸaÃ§ Fatih | Kantin Sistemi</title>
<link rel="icon" type="image/png" href="../img/logo.png" />

<style>
  /* ========== Tema ========== */
  :root{
    --appbar-h:56px;
    --radius:14px; --shadow:0 12px 28px rgba(0,0,0,.12);
    --bg:#f3f6fc; --card:#ffffff; --stroke:rgba(15,23,42,.12);
    --text:#0b1220; --muted:#4b5563; --surface:#f1f5ff; --surface2:#f6f8ff;
    --brand:#0ea5e9; --brand2:#0284c7;
    --danger:#b91c1c; --success:#16a34a;
    --gap-lg:20px; --gap:14px; --gap-sm:10px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:'Segoe UI',system-ui,-apple-system,Arial,sans-serif}
  img,svg,video{max-width:100%;height:auto;display:block}

  /* ========== Appbar ========== */
  .appbar{
    position:sticky; top:0; z-index:60; height:var(--appbar-h);
    background:var(--card); backdrop-filter:blur(10px);
    border-bottom:1px solid var(--stroke);
    display:flex; align-items:center; gap:10px; padding:0 12px;
  }
  .brand{display:flex; align-items:center; gap:10px; cursor:pointer}
  .brand img{width:24px; height:24px}
  .brand span{font-weight:900; letter-spacing:.02em}
  .nav-center{margin:0 auto; height:100%}
  .nav-list{display:flex; gap:22px; align-items:center; height:100%; list-style:none; margin:0; padding:0}
  .nav-item{position:relative; height:100%}
  .nav-btn{height:100%; display:flex; align-items:center; gap:6px; font-weight:800; cursor:pointer}
  .nav-btn:hover{color:var(--brand)}
  .caret{font-size:12px; opacity:.6}
  .dropdown{position:absolute; top:100%; left:0; min-width:240px; background:var(--card); border:1px solid var(--stroke); border-radius:12px; box-shadow:var(--shadow); padding:8px; display:none}
  .dropdown a{display:flex; align-items:center; gap:8px; padding:10px 12px; border-radius:10px; color:var(--text); text-decoration:none}
  .dropdown a:hover{background:var(--surface2)}
  .nav-item.open .dropdown{display:block}
  .nav-right{display:flex; gap:8px; align-items:center}
  .btn{border:1px solid var(--stroke); background:var(--card); color:var(--text); border-radius:999px; padding:8px 12px; cursor:pointer; white-space:nowrap}
  .hamb{display:none}
  .iconbtn{position:relative; border:1px solid var(--stroke); background:var(--card); color:var(--text); border-radius:999px; padding:8px 12px; cursor:pointer; display:flex; align-items:center; gap:8px}
  .badge{position:absolute; top:-6px; right:-6px; background:var(--danger); color:#fff; font-size:11px; padding:2px 6px; border-radius:999px; border:2px solid var(--card)}
  .drop-right{left:auto; right:0}
  .avatar{width:22px;height:22px;border-radius:999px;background:linear-gradient(180deg,#94a3b8,#64748b)}
  @media (max-width: 960px){ .nav-center{display:none} .hamb{display:inline-flex} }

  /* ========== Drawer ========== */
  .drawer{position:fixed; top:var(--appbar-h); right:0; bottom:0; left:34%; transform:translateX(100%); transition:.25s; background:var(--card); border-left:1px solid var(--stroke); z-index:70; overflow:auto; padding:16px}
  .drawer.open{transform:translateX(0)}
  .drawer .panel-title{margin:14px 4px 6px; font-weight:800; color:var(--muted); font-size:13px}
  .drawer a{display:block; padding:12px; border-radius:12px; border:1px solid var(--stroke); margin:8px 0; color:var(--text); background:var(--surface2)}
  .drawer a:hover{background:var(--surface)}

  /* ========== Layout ========== */
  .container{max-width:1120px; margin:0 auto; padding:18px; display:grid; gap:var(--gap-lg)}
  .card{background:var(--card); border:1px solid var(--stroke); border-radius:16px; box-shadow:var(--shadow); padding:16px}
  .stack-lg{display:grid; gap:var(--gap-lg)}
  .stack   {display:grid; gap:var(--gap)}
  .row{display:grid; grid-template-columns:repeat(12,minmax(0,1fr)); gap:var(--gap)}
  .col-6{grid-column:span 6} .col-4{grid-column:span 4} .col-3{grid-column:span 3} .col-12{grid-column:span 12}

  @media (max-width: 960px){
    .container{padding:14px}
    .row{grid-template-columns:repeat(6,minmax(0,1fr))}
    .col-6{grid-column:span 6} .col-4{grid-column:span 6} .col-3{grid-column:span 3} .col-12{grid-column:span 6}
  }
  @media (max-width: 640px){
    .row{grid-template-columns:repeat(4,minmax(0,1fr))}
    .col-6,.col-4,.col-3,.col-12{grid-column:span 4}
  }

  .muted{color:var(--muted)}

  /* ========== Form ========== */
  label{display:block; margin-bottom:6px; font-size:13px; color:var(--muted)}
  .field{display:flex; flex-direction:column; gap:6px}
  input,select,textarea{
    width:100%; height:44px; padding:10px 12px; border:1px solid var(--stroke);
    border-radius:12px; background:var(--surface2); color:var(--text); outline:none;
  }
  textarea{height:auto; min-height:88px; resize:vertical}
  input:focus,select:focus,textarea:focus{ box-shadow:0 0 0 3px rgba(14,165,233,.25); border-color:#0ea5e9; background:var(--surface) }
  .hint{font-size:12px; color:var(--muted)}

  /* ========== Minimal Tabs ========== */
  .mini-tabs{
    display:flex; gap:16px; align-items:center;
    border-bottom:1px solid rgba(148,163,184,.16);
    overflow-x:auto; scrollbar-width:none;
  }
  .mini-tabs::-webkit-scrollbar{display:none}
  .mini-tab{
    background:none; border:none; padding:10px 0; font-weight:700; color:var(--muted); cursor:pointer;
    position:relative; white-space:nowrap; font-size:14px;
  }
  .mini-tab.active{color:var(--text)}
  .mini-tab.active::after{
    content:''; position:absolute; left:0; right:0; bottom:-1px; height:2px;
    background:linear-gradient(90deg,var(--brand),var(--brand2));
    border-radius:99px;
  }

  /* ========== Toast ========== */
  .toast{position:fixed; left:50%; bottom:24px; transform:translateX(-50%) translateY(20px); background:rgba(2,6,23,.95); color:#fff; border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:10px 12px; opacity:0; pointer-events:none; transition:opacity .25s, transform .25s; z-index:200}
  .toast.show{opacity:1; transform:translateX(-50%) translateY(0)}

  /* ========== Kantin Ã–zel Stiller ========== */
  .bakiye-card{
    background:linear-gradient(135deg, var(--brand), var(--brand2));
    color:#fff; padding:20px; border-radius:16px; text-align:center;
  }
  .bakiye-card .label{font-size:13px; opacity:.9; margin-bottom:6px}
  .bakiye-card .value{font-size:32px; font-weight:900; margin-bottom:4px}
  .bakiye-card .hint{font-size:12px; opacity:.8}

  .section-header{
    display:flex; align-items:center; justify-content:space-between;
    margin-bottom:16px;
  }
  .section-header h2{margin:0}
  .section-actions{
    display:flex; gap:8px;
  }
  .btn-icon{
    width:36px; height:36px; border-radius:50%;
    border:1px solid var(--stroke); background:var(--surface2);
    display:flex; align-items:center; justify-content:center;
    cursor:pointer; font-size:18px; font-weight:800;
    transition:all .15s;
  }
  .btn-icon:hover{
    background:var(--surface); transform:scale(1.05);
  }
  .btn-icon.btn-primary{
    background:var(--brand); color:#fff; border-color:var(--brand);
  }
  .btn-icon.btn-primary:hover{
    background:var(--brand2);
  }

  .marka-suggestions{
    position:absolute; top:100%; left:0; right:0; z-index:10;
    background:var(--card); border:1px solid var(--stroke);
    border-radius:12px; box-shadow:var(--shadow); margin-top:4px;
    max-height:200px; overflow-y:auto; display:none;
  }
  .marka-suggestions.show{display:block}
  .marka-suggestion-item{
    padding:10px 12px; cursor:pointer; border-bottom:1px solid var(--stroke);
    transition:background .15s;
  }
  .marka-suggestion-item:last-child{border-bottom:none}
  .marka-suggestion-item:hover{background:var(--surface2)}

  .toplu-urun-item{
    border:1px solid var(--stroke); border-radius:12px; padding:14px;
    background:var(--surface2); margin-bottom:12px;
  }
  .toplu-urun-item .item-header{
    display:flex; justify-content:space-between; align-items:center;
    margin-bottom:10px;
  }
  .toplu-urun-item .item-title{
    font-weight:800; font-size:14px;
  }
  .toplu-urun-item .item-remove{
    background:transparent; border:none; color:var(--danger);
    cursor:pointer; font-size:18px; padding:4px 8px;
  }

  .urun-grid{
    display:grid; grid-template-columns:repeat(auto-fill, minmax(200px, 1fr));
    gap:14px; margin-top:16px;
  }
  .urun-card{
    border:1px solid var(--stroke); border-radius:14px; padding:14px;
    background:var(--card); transition:transform .15s, box-shadow .15s;
    cursor:pointer;
  }
  .urun-card:hover{
    transform:translateY(-2px); box-shadow:var(--shadow);
  }
  .urun-card .urun-adi{font-weight:800; font-size:15px; margin-bottom:6px}
  .urun-card.stok-bitti{border:2px solid var(--danger); background:rgba(185,28,28,.05)}
  .urun-card.stok-bitti .urun-adi{color:var(--danger)}
  .urun-card .urun-kategori{font-size:12px; color:var(--muted); margin-bottom:8px}
  .urun-card .urun-fiyat{font-size:18px; font-weight:900; color:var(--brand); margin-bottom:10px}
  .urun-card .urun-actions{
    display:flex; gap:8px; align-items:center;
  }
  .urun-card .miktar-control{
    display:flex; align-items:center; gap:8px;
    border:1px solid var(--stroke); border-radius:999px; padding:4px 8px;
  }
  .urun-card .miktar-btn{
    width:24px; height:24px; border:none; background:var(--surface2);
    border-radius:50%; cursor:pointer; font-weight:800; font-size:14px;
    display:flex; align-items:center; justify-content:center;
  }
  .urun-card .miktar-btn:hover{background:var(--surface)}
  .urun-card .miktar-val{min-width:30px; text-align:center; font-weight:700}

  .sepet-card{
    position:sticky; top:80px; border:2px solid var(--brand);
    background:var(--card); border-radius:16px; padding:16px;
  }
  .sepet-item{
    display:flex; align-items:center; justify-content:space-between;
    padding:10px 0; border-bottom:1px solid var(--stroke);
  }
  .sepet-item:last-child{border-bottom:none}
  .sepet-item .info{flex:1}
  .sepet-item .info .ad{font-weight:700; font-size:14px}
  .sepet-item .info .fiyat{font-size:12px; color:var(--muted)}
  .sepet-item .miktar{display:flex; align-items:center; gap:8px}
  .sepet-item .miktar input{
    width:50px; height:32px; text-align:center; padding:0;
    border:1px solid var(--stroke); border-radius:8px;
  }
  .sepet-item .sil-btn{
    background:transparent; border:none; color:var(--danger);
    cursor:pointer; padding:4px 8px; font-size:18px;
  }
  .sepet-toplam{
    margin-top:16px; padding-top:16px; border-top:2px solid var(--stroke);
    display:flex; justify-content:space-between; align-items:center;
  }
  .sepet-toplam .label{font-weight:800; font-size:16px}
  .sepet-toplam .tutar{font-weight:900; font-size:20px; color:var(--brand)}

  .chip{
    display:inline-flex; align-items:center; gap:6px;
    padding:6px 10px; border-radius:999px; font-size:12px; font-weight:700;
    border:1px solid rgba(148,163,184,.18); background:var(--surface2); color:var(--text);
  }
  .chip--ok{ background:rgba(22,163,74,.12); color:#166534; border-color:rgba(22,163,74,.25); }
  .chip--warn{ background:rgba(245,158,11,.12); color:#92400e; border-color:rgba(245,158,11,.25); }
  .chip--bad{ background:rgba(239,68,68,.12); color:#991b1b; border-color:rgba(239,68,68,.25); }

  .table-wrap{ overflow-x:auto; }
  table{ width:100%; border-collapse:collapse; }
  th,td{ padding:10px; text-align:left; border-bottom:1px solid var(--stroke); }
  th{ background:var(--surface2); font-weight:700; font-size:13px; }

  .loading{ display:flex; flex-direction:column; align-items:center; justify-content:center; gap:12px; padding:40px; color:var(--muted); }
  .spinner{ width:32px; height:32px; border:3px solid var(--stroke); border-top-color:var(--brand); border-radius:50%; animation:spin .8s linear infinite; }
  @keyframes spin{ to{ transform:rotate(360deg); } }

  .kategori-filtre{
    display:flex; gap:8px; flex-wrap:wrap; margin-bottom:16px;
  }
  .kategori-btn{
    padding:6px 12px; border:1px solid var(--stroke); background:var(--surface2);
    border-radius:999px; cursor:pointer; font-size:13px; font-weight:600;
    transition:all .15s;
  }
  .kategori-btn:hover{background:var(--surface)}
  .kategori-btn.active{
    background:var(--brand); color:#fff; border-color:var(--brand);
  }

  /* ========== Modal ========== */
  .modal{
    position:fixed; inset:0; z-index:120;
    display:none; align-items:center; justify-content:center;
    padding:18px;
    background:rgba(2,6,23,.58);
    backdrop-filter:saturate(1.2) blur(6px);
    -webkit-backdrop-filter:saturate(1.2) blur(6px);
    opacity:0; pointer-events:none; transition:opacity .18s ease-out;
  }
  .modal.show{ display:flex; opacity:1; pointer-events:auto; }
  .modal__panel{
    width:96%; max-width:520px; background:var(--card); border:1px solid var(--stroke);
    border-radius:18px; box-shadow:0 20px 60px rgba(0,0,0,.35), 0 1px 0 rgba(255,255,255,.03) inset;
    overflow:hidden; transform:translateY(10px) scale(.985); opacity:.98;
    transition:transform .22s cubic-bezier(.2,.8,.2,1), opacity .22s ease;
  }
  .modal__panel--lg{ max-width:900px; }
  .modal.show .modal__panel{ transform:translateY(0) scale(1); opacity:1; }
  .modal__header{
    position:sticky; top:0; z-index:1; display:flex; align-items:center; justify-content:space-between;
    padding:14px 16px;
    background:
      linear-gradient(180deg, color-mix(in oklab, var(--brand) 28%, transparent), transparent),
      linear-gradient(180deg, var(--surface2, rgba(2,6,23,.06)), transparent);
    border-bottom:1px solid var(--stroke);
  }
  .modal__title{ font-weight:900; letter-spacing:.01em; }
  .modal__close{ border:none; background:transparent; cursor:pointer; font-size:20px; color:var(--muted); line-height:1; border-radius:10px; padding:6px; }
  .modal__close:hover{ color:var(--text); background:rgba(148,163,184,.10); }
  .modal__body{ padding:16px; max-height:calc(80vh - 120px); overflow:auto; display:grid; gap:14px; }
  .modal__footer{
    position:sticky; bottom:0; z-index:1; display:flex; gap:10px; justify-content:flex-end; padding:12px 16px;
    background: linear-gradient(0deg, var(--surface2, rgba(2,6,23,.06)), transparent);
    border-top:1px solid var(--stroke);
  }
  .btn{ border:1px solid var(--stroke); background:var(--surface2, rgba(2,6,23,.06)); color:var(--text); border-radius:999px; padding:10px 14px; cursor:pointer; }
  .btn:hover{ background:rgba(148,163,184,.12); }
  .btn--primary{ border:none; color:#fff; font-weight:800; background:linear-gradient(180deg,var(--brand),var(--brand2)); box-shadow:0 10px 24px color-mix(in oklab, var(--brand2) 30%, transparent); }
  .btn--disabled{ opacity:.5; cursor:not-allowed; }
  .btn-ghost{ background:transparent; border:none; color:var(--text); cursor:pointer; padding:8px; border-radius:8px; font-size:18px; }
  .btn-ghost:hover{ background:var(--surface2); }

  .siparis-item{
    display:flex; align-items:center; justify-content:space-between;
    padding:12px; border:1px solid var(--stroke); border-radius:12px;
    margin-bottom:10px; background:var(--surface2);
  }
  .siparis-item .info{flex:1}
  .siparis-item .info .tarih{font-size:12px; color:var(--muted); margin-bottom:4px}
  .siparis-item .info .urunler{font-size:14px; font-weight:600}
  .siparis-item .tutar{font-weight:900; font-size:16px; color:var(--brand)}
  .siparis-item .durum{font-size:12px; padding:4px 8px; border-radius:6px; margin-left:8px}
</style>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
<script src="../js/firebase/firebase-init.js"></script>
</head>
<body>

<!-- APPBAR -->
<div class="appbar">
  <div class="brand" id="brandLink">
    <img src="../img/logo.png" alt="logo"><span>KARAAÄAÃ‡ FATÄ°H</span>
  </div>
  <nav class="nav-center"><ul class="nav-list" id="navMain"></ul></nav>
  <div class="nav-right">
    <button class="btn hamb" id="hamburger" title="MenÃ¼">â˜°</button>
    <div class="nav-item">
      <button class="iconbtn" id="btnProfile" title="Profil">
        <span class="avatar"></span> <span id="profName" class="muted">Profil</span>
      </button>
      <div class="dropdown drop-right" id="profDropdown">
        <a href="/diger/kullanici-yonetimi.html" >ğŸ‘¤ Profil</a>
        <a href="/diger/sistem-ayarlari.html" >âš™ï¸ Ayarlar</a>
        <a href="#" id="btnLogout">ğŸšª Ã‡Ä±kÄ±ÅŸ Yap</a>
      </div>
    </div>
  </div>
</div>
<aside class="drawer" id="drawer"></aside>

<!-- CONTENT -->
<main class="container stack-lg">
  <!-- Bakiye KartÄ± -->
  <section class="card">
    <div class="bakiye-card">
      <div class="label">Kantin Bakiyeniz</div>
      <div class="value" id="bakiyeTutar">â‚º 0,00</div>
      <div class="hint" id="bakiyeHint">Bakiye yÃ¼kleniyor...</div>
    </div>
  </section>

  <!-- Ana Sekmeler -->
  <section class="card">
    <div class="mini-tabs" id="mainTabs">
      <button class="mini-tab active" data-target="urunlerWrap">ÃœrÃ¼nler</button>
      <button class="mini-tab" data-target="alinimlarWrap">AlÄ±mlar</button>
      <button class="mini-tab" data-target="sayimWrap">SayÄ±m</button>
      <button class="mini-tab" data-target="borclarWrap">BorÃ§lar</button>
      <button class="mini-tab" data-target="ayarlarWrap">Ayarlar</button>
    </div>
  </section>

  <!-- ÃœrÃ¼nler -->
  <section class="card stack" id="urunlerWrap">
    <div class="section-header">
      <h2 style="margin:0">ÃœrÃ¼nler</h2>
      <div class="section-actions">
        <button class="btn-icon" id="btnUrunYazdir" title="Fiyat Listesi YazdÄ±r">ğŸ–¨</button>
      </div>
    </div>
    <!-- KPI KartlarÄ± -->
    <div class="row" style="margin-bottom:16px">
      <div class="col-6">
        <div class="card" style="background:linear-gradient(135deg, #b91c1c, #991b1b); color:#fff; padding:16px; border:none">
          <div style="font-size:13px; opacity:.9; margin-bottom:6px">Toplam Gider (AlÄ±ÅŸ)</div>
          <div style="font-size:28px; font-weight:900" id="toplamGiderKPI">â‚º 0,00</div>
          <div style="font-size:11px; opacity:.8; margin-top:4px">TÃ¼m Ã¼rÃ¼nlerin toplam alÄ±ÅŸ fiyatÄ±</div>
        </div>
      </div>
      <div class="col-6">
        <div class="card" style="background:linear-gradient(135deg, #16a34a, #15803d); color:#fff; padding:16px; border:none">
          <div style="font-size:13px; opacity:.9; margin-bottom:6px">Tahmini Gelir (SatÄ±ÅŸ)</div>
          <div style="font-size:28px; font-weight:900" id="tahminiGelirKPI">â‚º 0,00</div>
          <div style="font-size:11px; opacity:.8; margin-top:4px">TÃ¼m Ã¼rÃ¼nlerin satÄ±ÅŸ fiyatÄ± Ã— stok</div>
        </div>
      </div>
    </div>
    <div style="display:flex; gap:12px; align-items:center; margin-bottom:16px; flex-wrap:wrap">
      <div class="kategori-filtre" id="kategoriFiltre" style="flex:1; min-width:200px">
        <button class="kategori-btn active" data-kategori="tumu">TÃ¼mÃ¼</button>
        <button class="kategori-btn" data-kategori="yemek">ğŸ½ï¸ Yemek</button>
        <button class="kategori-btn" data-kategori="icecek">ğŸ¥¤ Ä°Ã§ecek</button>
        <button class="kategori-btn" data-kategori="atistirmalik">ğŸª AtÄ±ÅŸtÄ±rmalÄ±k</button>
      </div>
      <div style="display:flex; align-items:center; gap:8px">
        <label style="font-size:13px; color:var(--muted); white-space:nowrap">SÄ±rala:</label>
        <select id="urunSiralama" style="min-width:150px; padding:8px 12px; border:1px solid var(--stroke); border-radius:8px; background:var(--surface2); color:var(--text)">
          <option value="ad-asc">Ad (Aâ†’Z)</option>
          <option value="ad-desc">Ad (Zâ†’A)</option>
          <option value="fiyat-asc">Fiyat (DÃ¼ÅŸÃ¼kâ†’YÃ¼ksek)</option>
          <option value="fiyat-desc">Fiyat (YÃ¼ksekâ†’DÃ¼ÅŸÃ¼k)</option>
          <option value="stok-asc">Stok (Azâ†’Ã‡ok)</option>
          <option value="stok-desc">Stok (Ã‡okâ†’Az)</option>
          <option value="kategori-asc">Kategori (Aâ†’Z)</option>
        </select>
      </div>
    </div>
    <div class="urun-grid" id="urunGrid">
      <div class="loading" style="grid-column:1/-1">
        <div class="spinner"></div>
        <span>ÃœrÃ¼nler yÃ¼kleniyor...</span>
      </div>
    </div>
  </section>

  <!-- SayÄ±m -->
  <section class="card stack" id="sayimWrap" style="display:none">
    <div class="section-header">
      <h2 style="margin:0">GÃ¼n Sonu SayÄ±m</h2>
      <button class="btn-icon btn-primary" id="btnSayimEkle" title="SayÄ±m Ekle">+</button>
    </div>
    <div id="sayimListe" class="stack" style="margin-top:16px">
      <div class="loading">
        <div class="spinner"></div>
        <span>SayÄ±mlar yÃ¼kleniyor...</span>
      </div>
    </div>
  </section>

  <!-- AlÄ±mlar -->
  <section class="card stack" id="alinimlarWrap" style="display:none">
    <div class="section-header">
      <h2 style="margin:0">ÃœrÃ¼n AlÄ±mlarÄ±</h2>
      <div class="section-actions">
        <button class="btn-icon" id="btnTekAlimEkle" title="Tek ÃœrÃ¼n AlÄ±mÄ±">+</button>
        <button class="btn-icon btn-primary" id="btnTopluAlimEkle" title="Toplu ÃœrÃ¼n AlÄ±mÄ±">++</button>
      </div>
    </div>
    <!-- Rapor Filtreleri -->
    <div style="margin-bottom:16px; display:flex; gap:8px; flex-wrap:wrap">
      <button class="btn" id="btnAlimHaftalik" style="font-size:13px">ğŸ“Š HaftalÄ±k Rapor</button>
      <button class="btn" id="btnAlimAylik" style="font-size:13px">ğŸ“ˆ AylÄ±k Rapor</button>
    </div>
    <div id="alinimlarListe" class="stack" style="margin-top:16px">
      <div class="loading">
        <div class="spinner"></div>
        <span>AlÄ±mlar yÃ¼kleniyor...</span>
      </div>
    </div>
  </section>

  <!-- BorÃ§lar -->
  <section class="card stack" id="borclarWrap" style="display:none">
    <h2 style="margin:0">BorÃ§lar</h2>
    <div id="borclarListe" class="stack" style="margin-top:16px">
      <div class="loading">
        <div class="spinner"></div>
        <span>BorÃ§lar yÃ¼kleniyor...</span>
      </div>
    </div>
  </section>

  <!-- Ayarlar -->
  <section class="card stack" id="ayarlarWrap" style="display:none">
    <div class="section-header">
      <h2 style="margin:0">ÃœrÃ¼n YÃ¶netimi</h2>
      <div class="section-actions">
        <button class="btn btn--danger" id="btnTopluSil" style="font-size:13px; padding:8px 16px">ğŸ—‘ï¸ Toplu Sil</button>
      </div>
    </div>
    <div id="urunYonetimListe" style="margin-top:16px">
      <div class="loading">
        <div class="spinner"></div>
        <span>ÃœrÃ¼nler yÃ¼kleniyor...</span>
      </div>
    </div>
  </section>

  <div style="height:40px"></div>
</main>

<!-- Tek ÃœrÃ¼n AlÄ±m Modal -->
<div class="modal" id="tekUrunEkleModal">
  <div class="modal__panel">
    <div class="modal__header">
      <div class="modal__title">Tek ÃœrÃ¼n AlÄ±mÄ±</div>
      <button class="modal__close" data-close>âœ–</button>
    </div>
    <div class="modal__body">
      <div class="stack">
        <div class="field" style="position:relative">
          <label>ÃœrÃ¼n Marka</label>
          <input type="text" id="tek-marka" placeholder="Ã–rn: Ãœlker" autocomplete="off" />
          <div class="marka-suggestions" id="tek-marka-suggestions"></div>
        </div>
        <div class="field">
          <label>ÃœrÃ¼n AdÄ±</label>
          <input type="text" id="tek-ad" placeholder="ÃœrÃ¼n adÄ±nÄ± girin" />
        </div>
        <div class="row">
          <div class="col-6 field">
            <label>Gramaj</label>
            <input type="text" id="tek-gramaj" placeholder="Ã–rn: 200g" />
          </div>
          <div class="col-6 field">
            <label>Kategori</label>
            <select id="tek-kategori">
              <option value="yemek">ğŸ½ï¸ Yemek</option>
              <option value="icecek">ğŸ¥¤ Ä°Ã§ecek</option>
              <option value="atistirmalik">ğŸª AtÄ±ÅŸtÄ±rmalÄ±k</option>
              <option value="diger">ğŸ“¦ DiÄŸer</option>
            </select>
          </div>
        </div>
        <div class="row">
          <div class="col-6 field">
            <label>ÃœrÃ¼n Adet</label>
            <input type="number" id="tek-adet" min="1" value="1" />
          </div>
          <div class="col-6 field">
            <label>GeliÅŸ/AlÄ±ÅŸ FiyatÄ± (â‚º)</label>
            <input type="number" id="tek-gelis-fiyat" step="0.01" min="0" placeholder="0.00" />
          </div>
        </div>
        <div class="row">
          <div class="col-6 field">
            <label>YÃ¼zde ArtÄ±ÅŸ (%)</label>
            <input type="number" id="tek-yuzde" step="0.1" min="0" placeholder="0" />
          </div>
          <div class="col-6 field">
            <label>Hesaplanan SatÄ±ÅŸ FiyatÄ± (â‚º)</label>
            <input type="number" id="tek-satis-fiyat" step="0.01" min="0" placeholder="0.00" readonly style="background:var(--surface)" />
          </div>
        </div>
        <div class="field">
          <label>Manuel SatÄ±ÅŸ FiyatÄ± (â‚º) - DÃ¼zenlenebilir</label>
          <input type="number" id="tek-manuel-fiyat" step="0.01" min="0" placeholder="0.00" />
          <div class="hint">Hesaplanan fiyatÄ± manuel olarak dÃ¼zenleyebilirsiniz</div>
        </div>
        <div class="field">
          <label>AÃ§Ä±klama (Opsiyonel)</label>
          <textarea id="tek-aciklama" placeholder="ÃœrÃ¼n aÃ§Ä±klamasÄ±"></textarea>
        </div>
      </div>
    </div>
    <div class="modal__footer">
      <button class="btn" data-close>VazgeÃ§</button>
      <button class="btn btn--primary" id="tekUrunKaydetBtn">Kaydet</button>
    </div>
  </div>
</div>

<!-- Toplu ÃœrÃ¼n AlÄ±m Modal -->
<div class="modal" id="topluUrunEkleModal">
  <div class="modal__panel modal__panel--lg">
    <div class="modal__header">
      <div class="modal__title">Toplu ÃœrÃ¼n AlÄ±mÄ±</div>
      <button class="modal__close" data-close>âœ–</button>
    </div>
    <div class="modal__body">
      <div class="stack">
        <div class="field">
          <label>Tarih</label>
          <input type="date" id="toplu-alim-tarih" />
        </div>
        <div id="topluUrunListe" class="stack"></div>
        <button class="btn" id="toplu-urun-ekle-btn" style="width:100%">+ Yeni ÃœrÃ¼n Ekle</button>
      </div>
    </div>
    <div class="modal__footer">
      <button class="btn" data-close>VazgeÃ§</button>
      <button class="btn btn--primary" id="topluUrunKaydetBtn">TÃ¼mÃ¼nÃ¼ Kaydet</button>
    </div>
  </div>
</div>

<!-- SayÄ±m Ekle Modal -->
<div class="modal" id="sayimEkleModal">
  <div class="modal__panel modal__panel--lg">
    <div class="modal__header">
      <div class="modal__title" id="sayimModalTitle">GÃ¼n Sonu SayÄ±m</div>
      <button class="modal__close" data-close>âœ–</button>
    </div>
    <div class="modal__body">
      <div class="stack">
        <input type="hidden" id="sayimDuzenleId" />
        <div class="row">
          <div class="col-4 field">
            <label>Tarih</label>
            <input type="date" id="sayim-tarih" />
          </div>
          <div class="col-4 field">
            <label>Personel</label>
            <select id="sayim-personel">
              <option value="">â€” SeÃ§iniz â€”</option>
            </select>
          </div>
          <div class="col-4 field">
            <label>Kantinci</label>
            <input type="text" id="sayim-kantinci" placeholder="Ã–rn: Kantinci-1, Kantinci-2" />
            <div class="hint">Birden fazla kantinci iÃ§in virgÃ¼lle ayÄ±rÄ±n</div>
          </div>
        </div>
        <div class="table-wrap" style="max-height:500px; overflow-y:auto">
          <table>
            <thead>
              <tr>
                <th>ÃœrÃ¼n</th>
                <th>Mevcut Adet</th>
                <th>Kalan Adet</th>
                <th>SatÄ±lan Adet</th>
              </tr>
            </thead>
            <tbody id="sayimUrunListe">
              <tr><td colspan="4" class="muted">ÃœrÃ¼nler yÃ¼kleniyor...</td></tr>
            </tbody>
          </table>
        </div>
        
        <!-- Para DaÄŸÄ±lÄ±mÄ± BÃ¶lÃ¼mÃ¼ -->
        <div style="margin-top:24px; padding-top:24px; border-top:2px solid var(--stroke)">
          <h3 style="margin:0 0 16px; font-size:16px">ğŸ’° Para DaÄŸÄ±lÄ±mÄ±</h3>
          <div class="row">
            <div class="col-12 field">
              <label>Toplam Gelir (Otomatik)</label>
              <input type="text" id="sayim-toplam-gelir" readonly style="background:var(--surface); font-weight:700; font-size:18px; color:var(--brand)" />
            </div>
          </div>
          <div class="row" style="margin-top:12px">
            <div class="col-4 field">
              <label>Muhasebeye Teslim (â‚º)</label>
              <input type="number" step="0.01" id="sayim-muhasebe" placeholder="0.00" />
            </div>
            <div class="col-4 field">
              <label>BorÃ§lar - Toplam (â‚º)</label>
              <input type="number" step="0.01" id="sayim-borclar-toplam" placeholder="0.00" readonly style="background:var(--surface)" />
              <div class="hint">AÅŸaÄŸÄ±dan borÃ§ ekleyin</div>
            </div>
            <div class="col-4 field">
              <label>Nakit Bozuk Para (â‚º)</label>
              <input type="number" step="0.01" id="sayim-nakit" placeholder="0.00" />
            </div>
          </div>
          <div id="sayim-borclar-kontrol" style="margin-top:12px; padding:12px; background:var(--surface2); border-radius:8px; display:none">
            <div style="font-weight:700; margin-bottom:8px; color:var(--danger)">âš ï¸ Para daÄŸÄ±lÄ±mÄ± toplam gelire eÅŸit deÄŸil!</div>
            <div style="font-size:13px; color:var(--muted)">Toplam: <span id="sayim-dagilim-toplam">0.00</span>â‚º | Gelir: <span id="sayim-gelir-goster">0.00</span>â‚º | Fark: <span id="sayim-fark">0.00</span>â‚º</div>
          </div>
          
          <!-- BorÃ§lar Detay -->
          <div style="margin-top:20px">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px">
              <label style="margin:0; font-weight:700">BorÃ§lar (KiÅŸi BazlÄ±)</label>
              <button type="button" class="btn" id="sayim-borc-ekle-btn" style="font-size:12px; padding:6px 12px">+ BorÃ§ Ekle</button>
            </div>
            <div id="sayim-borclar-liste" class="stack" style="max-height:200px; overflow-y:auto">
              <!-- BorÃ§lar buraya eklenecek -->
            </div>
          </div>
          
          <div class="field" style="margin-top:16px">
            <label>AÃ§Ä±klama (Opsiyonel)</label>
            <textarea id="sayim-aciklama" placeholder="GÃ¼nlÃ¼k notlar, Ã¶zel durumlar..." style="min-height:60px"></textarea>
          </div>
        </div>
      </div>
    </div>
    <div class="modal__footer">
      <button class="btn" data-close>VazgeÃ§</button>
      <button class="btn btn--primary" id="sayimKaydetBtn">Kaydet ve Kapat</button>
      <button class="btn btn--primary" id="sayimGuncelleBtn" style="display:none">GÃ¼ncelle</button>
    </div>
  </div>
</div>

<!-- AlÄ±m DÃ¼zenle Modal -->
<div class="modal" id="alimDuzenleModal">
  <div class="modal__panel modal__panel--lg">
    <div class="modal__header">
      <div class="modal__title">AlÄ±m DÃ¼zenle</div>
      <button class="modal__close" data-close>âœ–</button>
    </div>
    <div class="modal__body">
      <div class="stack">
        <input type="hidden" id="alimDuzenleId" />
        <div class="field">
          <label>Tarih</label>
          <input type="date" id="alimDuzenleTarih" />
        </div>
        <div id="alimDuzenleUrunlerListe" class="stack"></div>
        <button class="btn" id="alimDuzenleUrunEkleBtn" style="width:100%; margin-top:8px">+ ÃœrÃ¼n Ekle</button>
        <div class="field">
          <label>AÃ§Ä±klama (Opsiyonel)</label>
          <textarea id="alimDuzenleAciklama" placeholder="AÃ§Ä±klama"></textarea>
        </div>
        <div style="padding:12px; background:var(--surface2); border-radius:8px; margin-top:12px">
          <div style="font-size:14px; color:var(--muted); margin-bottom:4px">Toplam Tutar</div>
          <div style="font-size:20px; font-weight:900; color:var(--primary)" id="alimDuzenleToplamTutar">â‚º 0,00</div>
        </div>
      </div>
    </div>
    <div class="modal__footer">
      <button class="btn" data-close>VazgeÃ§</button>
      <button class="btn btn--primary" id="alimDuzenleYeniKaydetBtn">Yeni Olarak Kaydet</button>
      <button class="btn btn--primary" id="alimDuzenleGuncelleBtn">GÃ¼ncelle</button>
    </div>
  </div>
</div>

<!-- ÃœrÃ¼n DÃ¼zenle Modal -->
<div class="modal" id="urunDuzenleModal">
  <div class="modal__panel">
    <div class="modal__header">
      <div class="modal__title">ÃœrÃ¼n DÃ¼zenle</div>
      <button class="modal__close" data-close>âœ–</button>
    </div>
    <div class="modal__body">
      <div class="stack">
        <input type="hidden" id="urunDuzenleId" />
        <div class="field">
          <label>ÃœrÃ¼n AdÄ±</label>
          <input type="text" id="urunDuzenleAd" placeholder="ÃœrÃ¼n adÄ±" />
        </div>
        <div class="field">
          <label>Kategori</label>
          <select id="urunDuzenleKategori">
            <option value="yemek">ğŸ½ï¸ Yemek</option>
            <option value="icecek">ğŸ¥¤ Ä°Ã§ecek</option>
            <option value="atistirmalik">ğŸª AtÄ±ÅŸtÄ±rmalÄ±k</option>
            <option value="diger">ğŸ“¦ DiÄŸer</option>
          </select>
        </div>
        <div class="row">
          <div class="col-6 field">
            <label>GeliÅŸ FiyatÄ± (â‚º)</label>
            <input type="number" step="0.01" id="urunDuzenleGelisFiyat" placeholder="0.00" />
          </div>
          <div class="col-6 field">
            <label>SatÄ±ÅŸ FiyatÄ± (â‚º)</label>
            <input type="number" step="0.01" id="urunDuzenleFiyat" placeholder="0.00" />
          </div>
        </div>
        <div class="field">
          <label>Stok Adedi</label>
          <input type="number" id="urunDuzenleStok" placeholder="0" />
        </div>
        <div class="field">
          <label>AÃ§Ä±klama</label>
          <textarea id="urunDuzenleAciklama" placeholder="ÃœrÃ¼n aÃ§Ä±klamasÄ± (opsiyonel)"></textarea>
        </div>
        <div class="field">
          <label>
            <input type="checkbox" id="urunDuzenleAktif" checked />
            Aktif (ÃœrÃ¼n gÃ¶rÃ¼nÃ¼r)
          </label>
        </div>
      </div>
    </div>
    <div class="modal__footer">
      <button class="btn" data-close>VazgeÃ§</button>
      <button class="btn btn--danger" id="urunDuzenleSilBtn">Sil</button>
      <button class="btn btn--primary" id="urunDuzenleKaydetBtn">Kaydet</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* ===== Helpers ===== */
const db=firebase.firestore(), auth=firebase.auth();
const userAgent = navigator.userAgent || '';
const cihazTipi = ()=> (window.innerWidth<700?'mobile':(window.innerWidth<960?'tablet':'desktop'));
const tsISO = ()=> new Date().toISOString();
const norm=(s)=> String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
function toast(msg){const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); clearTimeout(window.__to); window.__to=setTimeout(()=>t.classList.remove('show'),2400);}
function toNum(v){ if (typeof v === 'number') return v; if (typeof v === 'string'){ const n=Number(v.replace(/\./g,'').replace(',', '.')); return isNaN(n)?0:n; } return 0; }

/* ===== Modal Utils ===== */
function openModal(id){
  const m=document.getElementById(id);
  if(!m) return;
  m.classList.add('show');
}
function closeModal(el){
  const m = el?.closest?.('.modal') || document.querySelector('.modal.show');
  m?.classList.remove('show');
}
document.addEventListener('click',(e)=>{
  if(e.target.matches('[data-close]')) closeModal(e.target);
  // topluUrunEkleModal iÃ§in dÄ±ÅŸ tÄ±klamayla kapanmayÄ± engelle
  if(e.target.classList?.contains('modal') && e.target.id !== 'topluUrunEkleModal'){
    e.target.classList.remove('show');
  }
});
document.addEventListener('keydown',(e)=>{
  if(e.key==='Escape'){ 
    // topluUrunEkleModal iÃ§in Escape ile kapanmayÄ± engelle
    document.querySelectorAll('.modal.show').forEach(m=>{
      if(m.id !== 'topluUrunEkleModal'){
        m.classList.remove('show');
      }
    });
  }
});

/* ===== NAV ===== */
// Brand link click handler
(function(){
  const brandLink = document.getElementById('brandLink');
  if(brandLink){
    brandLink.addEventListener('click', ()=>{
      location.href = '../panel.html';
    });
  }
})();

let CURRENT_ALLOW=new Set(), CURRENT_DENY=new Set();
async function fetchPanels(allowSet, denySet){
  const res=[]; try{
    const snap=await db.collection('sayfa_manifesti').get();
    snap.forEach(doc=>{
      const d=doc.data()||{}, id=doc.id, panelTitle=d.title||id;
      const panelGrant = allowSet.has(norm(id)) || allowSet.has(norm(panelTitle));
      let pages = Array.isArray(d.pages)? d.pages : [];
      pages = pages.filter(pg=>{
        const keyNorm=norm(pg.key||pg.title||'');
        const pageGrant=allowSet.has(keyNorm), denied=denySet.has(keyNorm);
        return !denied && (panelGrant || pageGrant);
      }).map(pg=>({ baslik: pg.title||pg.key||'Sayfa', url: pg.path||'#', key: pg.key||pg.title||'', sira: typeof pg.order==='number'? pg.order:9999 }))
        .sort((a,b)=>a.sira-b.sira);
      if(pages.length) res.push({ id, baslik:panelTitle, sira: typeof d.order==='number'? d.order:9999, pages });
    });
    res.sort((a,b)=>a.sira-b.sira);
  }catch(e){ console.error(e); toast('MenÃ¼ yÃ¼klenemedi'); }
  return res;
}
function renderNav(panels){
  const ul=document.getElementById('navMain'), drawer=document.getElementById('drawer');
  ul.innerHTML=''; drawer.innerHTML='';
  if(!panels.length){
    ul.innerHTML='<li class="nav-item"><div class="nav-btn">Panel yok</div></li>';
    drawer.innerHTML='<div class="muted" style="padding:8px">MenÃ¼ bulunamadÄ±</div>'; return;
  }
  panels.forEach(p=>{
    const li=document.createElement('li'); li.className='nav-item';
    li.innerHTML='<div class="nav-btn">' + p.baslik + ' <span class="caret">â–¾</span></div>';
    const dd=document.createElement('div'); dd.className='dropdown';
    (p.pages||[]).forEach(pg=>{
      const a=document.createElement('a');
      a.href=pg.url || pg.path || '#'; a.textContent=pg.baslik;
      a.dataset.key=pg.key||pg.baslik; a.dataset.panel=p.id; a.dataset.panelTitle=p.baslik;
      dd.appendChild(a);
    });
    li.appendChild(dd);
    li.querySelector('.nav-btn').addEventListener('click',(e)=>{
      e.stopPropagation();
      ul.querySelectorAll('.nav-item').forEach(x=>{ if(x!==li) x.classList.remove('open'); });
      li.classList.toggle('open');
    });
    ul.appendChild(li);

    const h=document.createElement('div'); h.className='panel-title'; h.textContent=p.baslik; drawer.appendChild(h);
    (p.pages||[]).forEach(pg=>{
      const a=document.createElement('a');
      a.href=pg.url || pg.path || '#'; a.textContent=pg.baslik;
      a.dataset.key=pg.key||pg.baslik; a.dataset.panel=p.id; a.dataset.panelTitle=p.baslik;
      drawer.appendChild(a);
    });
  });
  document.addEventListener('click',(e)=>{ if(!ul.contains(e.target)) ul.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('open')); });
}
(function(){ const hamb=document.getElementById('hamburger'), drawer=document.getElementById('drawer'); if(!hamb) return; hamb.addEventListener('click',()=>drawer.classList.toggle('open')); document.addEventListener('click',(e)=>{ if(!drawer.contains(e.target) && !hamb.contains(e.target)) drawer.classList.remove('open'); }); })();
(function(){
  const profBtn=document.getElementById('btnProfile'), profDD=document.getElementById('profDropdown');
  function closeAll(e){
    if(!profDD.contains(e.target)  && e.target!==profBtn)  profDD.parentElement.classList.remove('open');
  }
  document.addEventListener('click', closeAll);
  profBtn?.addEventListener('click',(e)=>{ e.stopPropagation(); profDD.parentElement.classList.toggle('open'); });
  document.getElementById('btnLogout')?.addEventListener('click', async (e) => {
    e.preventDefault();
    try { await auth.signOut(); location.assign('/index.html'); }
    catch(err){ console.error(err); toast('Ã‡Ä±kÄ±ÅŸ yapÄ±lamadÄ±'); }
  });
})();

/* ===== Auth & Profil ===== */
let currentUser=null, currentUserName='', currentUserUid='';
try{ firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL); }catch(e){}
auth.onAuthStateChanged(async (user)=>{
  currentUser=user||null;
  if(!user){
    setTimeout(()=>{ if(!auth.currentUser) location.replace('index.html'); },150);
    return;
  }
  try{
    const profEl = document.getElementById('profName');
    const uSnap = await db.collection('kullanicilar').doc(user.uid).get();
    const data  = uSnap.exists ? (uSnap.data()||{}) : {};
    let gosterilecek = (data.adSoyad || '').trim();
    if(!gosterilecek && user.displayName) gosterilecek = user.displayName.trim();
    if(!gosterilecek && user.email){
      const namePart = user.email.split('@')[0];
      gosterilecek = namePart.charAt(0).toUpperCase() + namePart.slice(1);
    }
    currentUserName = gosterilecek || '';
    currentUserUid = user.uid || '';
    profEl.textContent = (gosterilecek.split(' ')[0] || 'Profil');

    const rawPerms=Array.isArray(data.yetkiler)? data.yetkiler : [];
    CURRENT_ALLOW=new Set(rawPerms.filter(s=>!String(s).trim().startsWith('-') && !String(s).trim().startsWith('!')).map(norm));
    CURRENT_DENY =new Set(rawPerms.filter(s=> String(s).trim().startsWith('-') || String(s).trim().startsWith('!')).map(s=>norm(String(s).replace(/^[-!]\s*/,''))));
    const panels=await fetchPanels(CURRENT_ALLOW, CURRENT_DENY);
    renderNav(panels);

    // Bakiye ve Ã¼rÃ¼nleri yÃ¼kle
    await loadBakiye();
    await loadUrunler();
  }catch(e){ console.error(e); }
});

/* ===== Sekme YÃ¶netimi ===== */
(function(){
  function initTabs(){
    const tabs=document.querySelectorAll('#mainTabs .mini-tab');
    if(!tabs.length) return;
    
    tabs.forEach(t=>{
      t.addEventListener('click',()=>{
        tabs.forEach(x=>x.classList.remove('active'));
        t.classList.add('active');
        const target=t.dataset.target;
        const ids=['urunlerWrap','alinimlarWrap','sayimWrap','borclarWrap','ayarlarWrap'];
        ids.forEach(id=>{ 
          const el=document.getElementById(id); 
          if(el) el.style.display = (target===id)?'':'none'; 
        });
        if(target==='alinimlarWrap' && typeof loadAlinimlar === 'function') loadAlinimlar();
        if(target==='sayimWrap' && typeof loadSayimlar === 'function') loadSayimlar();
        if(target==='borclarWrap' && typeof loadBorclar === 'function') loadBorclar();
        if(target==='ayarlarWrap' && typeof loadUrunYonetim === 'function') loadUrunYonetim();
      });
    });
  }
  
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', initTabs);
  } else {
    initTabs();
  }
})();

/* ===== Bakiye ===== */
let currentBakiye = 0;
async function loadBakiye(){
  if(!currentUserUid) return;
  try{
    const bakiyeSnap = await db.collection('kantin_bakiyeler').doc(currentUserUid).get();
    const data = bakiyeSnap.exists ? (bakiyeSnap.data()||{}) : {};
    currentBakiye = toNum(data.bakiye || 0);
    document.getElementById('bakiyeTutar').textContent = 'â‚º ' + currentBakiye.toLocaleString('tr-TR',{minimumFractionDigits:2,maximumFractionDigits:2});
    document.getElementById('bakiyeHint').textContent = 'Bakiye gÃ¼ncel';
  }catch(e){
    console.error(e);
    document.getElementById('bakiyeHint').textContent = 'Bakiye yÃ¼klenemedi';
  }
}

/* ===== ÃœrÃ¼nler ===== */
let allUrunler = [];
let selectedKategori = 'tumu';
let selectedSiralama = 'ad-asc';
let markaListesi = []; // Marka hatÄ±rlatma iÃ§in

// Marka listesini yÃ¼kle
function loadMarkaListesi(){
  try{
    const stored = localStorage.getItem('kantin_markalar');
    if(stored){
      markaListesi = JSON.parse(stored);
    }
  }catch(e){
    markaListesi = [];
  }
}

// Marka ekle
function addMarka(marka){
  if(!marka || !marka.trim()) return;
  const m = marka.trim();
  if(!markaListesi.includes(m)){
    markaListesi.push(m);
    markaListesi.sort();
    try{
      localStorage.setItem('kantin_markalar', JSON.stringify(markaListesi));
    }catch(e){}
  }
}

// Marka Ã¶nerilerini gÃ¶ster
function showMarkaSuggestions(inputId, suggestionsId){
  const input = document.getElementById(inputId);
  const suggestions = document.getElementById(suggestionsId);
  if(!input || !suggestions) return;

  function renderSuggestions(filteredList){
    suggestions.innerHTML = filteredList.map(m=>{
      const escapedMarka = m.replace(/"/g, '&quot;');
      return '<div class="marka-suggestion-item" data-marka="' + escapedMarka + '" data-input-id="' + inputId + '">' + m + '</div>';
    }).join('');
  }

  input.addEventListener('focus', ()=>{
    if(markaListesi.length === 0) return;
    renderSuggestions(markaListesi);
    suggestions.classList.add('show');
  });

  input.addEventListener('blur', ()=>{
    setTimeout(()=>{
      suggestions.classList.remove('show');
    }, 200);
  });

  input.addEventListener('input', (e)=>{
    const val = e.target.value.toLowerCase();
    if(!val){
      renderSuggestions(markaListesi);
      return;
    }
    const filtered = markaListesi.filter(m=>m.toLowerCase().includes(val));
    if(filtered.length > 0){
      renderSuggestions(filtered);
      suggestions.classList.add('show');
    } else {
      suggestions.classList.remove('show');
    }
  });

  // Event delegation for suggestion clicks
  suggestions.addEventListener('click', (e)=>{
    const item = e.target.closest('.marka-suggestion-item');
    if(item){
      const marka = item.dataset.marka;
      const targetInputId = item.dataset.inputId;
      const targetInput = document.getElementById(targetInputId);
      if(targetInput){
        targetInput.value = marka;
        suggestions.classList.remove('show');
      }
    }
  });
}

// Fiyat hesaplama (gelisFiyat = toplam alÄ±ÅŸ fiyatÄ±, adet = Ã¼rÃ¼n adedi)
// Birim satÄ±ÅŸ fiyatÄ± = (gelisFiyat / adet) * (1 + yuzdeArtis/100)
function hesaplaSatisFiyati(gelisFiyat, yuzdeArtis, adet){
  if(!gelisFiyat || !adet || adet <= 0) return 0;
  const birimAlisFiyat = gelisFiyat / adet;
  const birimSatisFiyat = birimAlisFiyat * (1 + (yuzdeArtis || 0) / 100);
  return parseFloat(birimSatisFiyat.toFixed(2));
}

// Yuvarlama
function yuvarlaYukari(sayi){
  return Math.ceil(sayi * 100) / 100;
}

function yuvarlaAsagi(sayi){
  return Math.floor(sayi * 100) / 100;
}

async function loadUrunler(){
  try{
    const snap = await db.collection('kantin_urunler').where('aktif','==',true).get();
    allUrunler = [];
    snap.forEach(doc=>{
      const d = doc.data()||{};
      allUrunler.push({
        id: doc.id,
        ad: d.ad || 'Ä°simsiz',
        kategori: d.kategori || 'diger',
        fiyat: toNum(d.fiyat || 0),
        aciklama: d.aciklama || '',
        stok: toNum(d.stok || 0),
        gelisFiyat: toNum(d.gelisFiyat || 0),
        resim: d.resim || ''
      });
    });
    renderUrunler();
    updateUrunKPI();
  }catch(e){
    console.error(e);
    document.getElementById('urunGrid').innerHTML = '<div class="muted" style="grid-column:1/-1; padding:20px; text-align:center">ÃœrÃ¼nler yÃ¼klenemedi.</div>';
  }
}

// ÃœrÃ¼n KPI gÃ¼ncelle (Toplam Gider ve Tahmini Gelir)
function updateUrunKPI(){
  let toplamGider = 0;
  let tahminiGelir = 0;
  
  allUrunler.forEach(urun=>{
    const stok = urun.stok || 0;
    const gelisFiyat = urun.gelisFiyat || 0; // gelisFiyat zaten toplam alÄ±ÅŸ fiyatÄ± (30 adet iÃ§in 300â‚º gibi)
    const satisFiyat = urun.fiyat || 0; // fiyat birim satÄ±ÅŸ fiyatÄ±
    
    toplamGider += gelisFiyat; // Stok ile Ã§arpma, Ã§Ã¼nkÃ¼ gelisFiyat zaten toplam
    tahminiGelir += satisFiyat * stok; // Birim fiyat Ã— stok
  });
  
  const giderEl = document.getElementById('toplamGiderKPI');
  const gelirEl = document.getElementById('tahminiGelirKPI');
  
  if(giderEl) giderEl.textContent = 'â‚º ' + toplamGider.toLocaleString('tr-TR',{minimumFractionDigits:2,maximumFractionDigits:2});
  if(gelirEl) gelirEl.textContent = 'â‚º ' + tahminiGelir.toLocaleString('tr-TR',{minimumFractionDigits:2,maximumFractionDigits:2});
}

function renderUrunler(){
  const grid = document.getElementById('urunGrid');
  let filtered = selectedKategori === 'tumu' 
    ? allUrunler 
    : allUrunler.filter(u=>u.kategori === selectedKategori);
  
  // SÄ±ralama
  filtered = [...filtered].sort((a, b)=>{
    switch(selectedSiralama){
      case 'ad-asc':
        return (a.ad || '').localeCompare(b.ad || '', 'tr');
      case 'ad-desc':
        return (b.ad || '').localeCompare(a.ad || '', 'tr');
      case 'fiyat-asc':
        return (a.fiyat || 0) - (b.fiyat || 0);
      case 'fiyat-desc':
        return (b.fiyat || 0) - (a.fiyat || 0);
      case 'stok-asc':
        return (a.stok || 0) - (b.stok || 0);
      case 'stok-desc':
        return (b.stok || 0) - (a.stok || 0);
      case 'kategori-asc':
        return (a.kategori || '').localeCompare(b.kategori || '', 'tr');
      default:
        return 0;
    }
  });
  
  if(!filtered.length){
    grid.innerHTML = '<div class="muted" style="grid-column:1/-1; padding:20px; text-align:center">Bu kategoride Ã¼rÃ¼n bulunamadÄ±.</div>';
    return;
  }

  grid.innerHTML = filtered.map(urun=>{
    const fiyatStr = urun.fiyat.toLocaleString('tr-TR',{minimumFractionDigits:2,maximumFractionDigits:2});
    const kategoriLabel = getKategoriLabel(urun.kategori);
    const stokAdet = (urun.stok || 0);
    const stokBitti = stokAdet <= 0;
    const stokClass = stokBitti ? ' stok-bitti' : '';
    const aciklamaHtml = urun.aciklama ? '<div class="muted" style="font-size:12px; margin-bottom:10px">' + urun.aciklama + '</div>' : '';
    return '<div class="urun-card' + stokClass + '">' +
      '<div class="urun-adi">' + urun.ad + '</div>' +
      '<div class="urun-kategori">' + kategoriLabel + '</div>' +
      '<div class="urun-fiyat">â‚º ' + fiyatStr + '</div>' +
      aciklamaHtml +
      '<div style="font-size:12px; color:var(--muted); margin-top:8px">' +
      'Stok: ' + stokAdet + ' adet' +
      '</div>' +
      '</div>';
  }).join('');
}

function getKategoriLabel(kat){
  const map = {
    'yemek': 'ğŸ½ï¸ Yemek',
    'icecek': 'ğŸ¥¤ Ä°Ã§ecek',
    'atistirmalik': 'ğŸª AtÄ±ÅŸtÄ±rmalÄ±k',
    'diger': 'ğŸ“¦ DiÄŸer'
  };
  return map[kat] || kat;
}

// Kategori filtre
(function(){
  function initKategoriFiltre(){
    const btns = document.querySelectorAll('#kategoriFiltre .kategori-btn');
    if(!btns.length) return;
    
    btns.forEach(btn=>{
      btn.addEventListener('click',()=>{
        document.querySelectorAll('#kategoriFiltre .kategori-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        selectedKategori = btn.dataset.kategori;
        renderUrunler();
      });
    });
  }
  
  // SÄ±ralama
  const siralamaSelect = document.getElementById('urunSiralama');
  if(siralamaSelect){
    siralamaSelect.addEventListener('change', (e)=>{
      selectedSiralama = e.target.value;
      renderUrunler();
    });
  }
  
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', initKategoriFiltre);
  } else {
    initKategoriFiltre();
  }
})();

// ÃœrÃ¼n yazdÄ±r (Fiyat Listesi)
(function(){
  const btn = document.getElementById('btnUrunYazdir');
  if(!btn) return;
  
  btn.addEventListener('click', ()=>{
    window.open('kantinfiyatlistesi.html', '_blank');
  });
})();

/* ===== ÃœrÃ¼n Ekleme ===== */
loadMarkaListesi();

// Tek Ã¼rÃ¼n alÄ±m modal
(function(){
  const btn = document.getElementById('btnTekAlimEkle');
  if(btn){
    btn.addEventListener('click', ()=>{
      // Formu temizle
      const today = new Date().toISOString().slice(0,10);
      document.getElementById('tek-alim-tarih').value = today;
      document.getElementById('tek-marka').value = '';
      document.getElementById('tek-ad').value = '';
      document.getElementById('tek-gramaj').value = '';
      document.getElementById('tek-kategori').value = 'yemek';
      document.getElementById('tek-adet').value = '1';
      document.getElementById('tek-gelis-fiyat').value = '';
      document.getElementById('tek-yuzde').value = '';
      document.getElementById('tek-satis-fiyat').value = '';
      document.getElementById('tek-manuel-fiyat').value = '';
      document.getElementById('tek-aciklama').value = '';
      openModal('tekUrunEkleModal');
    });
  }
  
  // Marka Ã¶nerilerini aktif et
  showMarkaSuggestions('tek-marka', 'tek-marka-suggestions');
  
  // Fiyat hesaplama (tek Ã¼rÃ¼n)
  function updateTekUrunFiyat(){
    const gelisFiyat = toNum(document.getElementById('tek-gelis-fiyat')?.value || 0);
    const yuzde = toNum(document.getElementById('tek-yuzde')?.value || 0);
    const adet = toNum(document.getElementById('tek-adet')?.value || 1);
    
    const hesaplanan = hesaplaSatisFiyati(gelisFiyat, yuzde, adet);
    const satisFiyatEl = document.getElementById('tek-satis-fiyat');
    if(satisFiyatEl) satisFiyatEl.value = hesaplanan.toFixed(2);
    
    // Manuel fiyatÄ± da gÃ¼ncelle (eÄŸer boÅŸsa)
    const manuel = document.getElementById('tek-manuel-fiyat');
    if(manuel && (!manuel.value || manuel.value === '0' || manuel.value === '0.00')){
      manuel.value = hesaplanan.toFixed(2);
    }
  }
  
  const gelisFiyatEl = document.getElementById('tek-gelis-fiyat');
  const yuzdeEl = document.getElementById('tek-yuzde');
  const adetEl = document.getElementById('tek-adet');
  
  if(gelisFiyatEl) gelisFiyatEl.addEventListener('input', updateTekUrunFiyat);
  if(yuzdeEl) yuzdeEl.addEventListener('input', updateTekUrunFiyat);
  if(adetEl) adetEl.addEventListener('input', updateTekUrunFiyat);
  
  // Tek Ã¼rÃ¼n alÄ±m kaydet
  const kaydetBtn = document.getElementById('tekUrunKaydetBtn');
  if(kaydetBtn){
    kaydetBtn.addEventListener('click', async ()=>{
      const tarih = document.getElementById('tek-alim-tarih').value;
      const marka = (document.getElementById('tek-marka').value || '').trim();
      const ad = (document.getElementById('tek-ad').value || '').trim();
      const gramaj = (document.getElementById('tek-gramaj').value || '').trim();
      const kategori = document.getElementById('tek-kategori').value;
      const adet = toNum(document.getElementById('tek-adet').value) || 1;
      const gelisFiyat = toNum(document.getElementById('tek-gelis-fiyat').value);
      const yuzde = toNum(document.getElementById('tek-yuzde').value);
      const satisFiyat = toNum(document.getElementById('tek-manuel-fiyat').value);
      const aciklama = (document.getElementById('tek-aciklama').value || '').trim();

      if(!tarih){
        toast('Tarih seÃ§iniz');
        return;
      }
      if(!marka || !ad){
        toast('Marka ve Ã¼rÃ¼n adÄ± zorunludur');
        return;
      }
      if(!gelisFiyat || gelisFiyat <= 0){
        toast('Toplam alÄ±ÅŸ fiyatÄ± giriniz');
        return;
      }
      if(!satisFiyat || satisFiyat <= 0){
        toast('SatÄ±ÅŸ fiyatÄ± giriniz');
        return;
      }

      try{
        const urunAdi = marka ? (marka + ' ' + ad).trim() : ad;
        const batch = db.batch();
        
        // Mevcut Ã¼rÃ¼nÃ¼ kontrol et (aynÄ± isim ve kategori)
        const mevcutUrunSnap = await db.collection('kantin_urunler')
          .where('ad','==',urunAdi)
          .where('kategori','==',kategori)
          .where('aktif','==',true)
          .limit(1)
          .get();
        
        let urunId;
        let yeniUrun = false;
        
        if(!mevcutUrunSnap.empty){
          // Mevcut Ã¼rÃ¼n var - stok artÄ±r ve fiyat gÃ¼ncelle
          const mevcutUrun = mevcutUrunSnap.docs[0];
          urunId = mevcutUrun.id;
          const mevcutData = mevcutUrun.data();
          const mevcutStok = toNum(mevcutData.stok || 0);
          
          const urunRef = db.collection('kantin_urunler').doc(urunId);
          batch.update(urunRef, {
            stok: mevcutStok + adet,
            gelisFiyat: gelisFiyat, // Yeni alÄ±ÅŸ fiyatÄ±
            fiyat: satisFiyat, // Yeni satÄ±ÅŸ fiyatÄ±
            yuzdeArtis: yuzde,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        } else {
          // Yeni Ã¼rÃ¼n ekle
          const urunRef = db.collection('kantin_urunler').doc();
          urunId = urunRef.id;
          yeniUrun = true;
          batch.set(urunRef, {
            ad: urunAdi,
            marka: marka,
            gramaj: gramaj,
            kategori: kategori,
            adet: adet,
            gelisFiyat: gelisFiyat,
            yuzdeArtis: yuzde,
            fiyat: satisFiyat,
            aciklama: aciklama,
            stok: adet,
            aktif: true,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            createdBy: currentUser?.email || null,
            uid: currentUserUid || null
          });
          addMarka(marka);
        }
        
        // AlÄ±m kaydÄ± oluÅŸtur
        const alimRef = db.collection('kantin_alinimlar').doc();
        batch.set(alimRef, {
          tarih: tarih,
          urunler: [{
            urunId: urunId,
            urunAd: urunAdi,
            miktar: adet,
            birimAlisFiyat: gelisFiyat / adet,
            toplamAlisFiyat: gelisFiyat,
            birimSatisFiyat: satisFiyat,
            yeniUrun: yeniUrun
          }],
          toplamTutar: gelisFiyat,
          aciklama: aciklama,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          createdBy: currentUser?.email || null,
          uid: currentUserUid || null
        });
        
        await batch.commit();
        
        toast('âœ… AlÄ±m kaydedildi ve stoklar gÃ¼ncellendi!');
        closeModal(document.getElementById('tekUrunEkleModal'));
        // AlÄ±m ekleme yapÄ±nca tÃ¼m sekmeler gÃ¼ncellenmeli (alÄ±mlar ana kaynak)
        await loadAlinimlar();
        await loadUrunler();
        await loadUrunYonetim(); // Ayarlar sekmesi de gÃ¼ncellenmeli
      }catch(e){
        console.error(e);
        toast('AlÄ±m kaydedilemedi');
      }
    });
  }
})();

// Toplu Ã¼rÃ¼n ekle
let topluUrunListesi = [];

function addTopluUrunItem(){
  // Ã–nce mevcut input deÄŸerlerini kaydet
  saveTopluUrunInputs();
  
  const index = topluUrunListesi.length;
  topluUrunListesi.push({
    marka: '',
    ad: '',
    gramaj: '',
    kategori: 'yemek',
    adet: 1,
    gelisFiyat: 0,
    yuzde: 0,
    satisFiyat: 0
  });
  renderTopluUrunListe();
}

// Mevcut input deÄŸerlerini topluUrunListesi'ne kaydet
function saveTopluUrunInputs(){
  topluUrunListesi.forEach((item, index)=>{
    const markaInput = document.querySelector(`.toplu-marka[data-index="${index}"]`);
    const adInput = document.querySelector(`.toplu-ad[data-index="${index}"]`);
    const gramajInput = document.querySelector(`.toplu-gramaj[data-index="${index}"]`);
    const kategoriSelect = document.querySelector(`.toplu-kategori[data-index="${index}"]`);
    const adetInput = document.querySelector(`.toplu-adet[data-index="${index}"]`);
    const gelisInput = document.querySelector(`.toplu-gelis[data-index="${index}"]`);
    const yuzdeInput = document.querySelector(`.toplu-yuzde[data-index="${index}"]`);
    const satisInput = document.querySelector(`.toplu-satis[data-index="${index}"]`);
    
    if(markaInput) item.marka = markaInput.value.trim();
    if(adInput) item.ad = adInput.value.trim();
    if(gramajInput) item.gramaj = gramajInput.value.trim();
    if(kategoriSelect) item.kategori = kategoriSelect.value;
    if(adetInput) item.adet = parseInt(adetInput.value.toString().replace(/[^\d]/g, '')) || 1;
    // GeliÅŸ fiyatÄ±nÄ± kaydet - virgÃ¼lÃ¼ noktaya Ã§evir
    if(gelisInput){
      const gelisValue = gelisInput.value.toString().replace(/[^\d.,]/g, '').replace(',', '.');
      item.gelisFiyat = parseFloat(gelisValue) || 0;
    }
    // YÃ¼zde artÄ±ÅŸÄ± kaydet - virgÃ¼lÃ¼ noktaya Ã§evir
    if(yuzdeInput){
      const yuzdeValue = yuzdeInput.value.toString().replace(/[^\d.,]/g, '').replace(',', '.');
      item.yuzde = parseFloat(yuzdeValue) || 0;
    }
    // SatÄ±ÅŸ fiyatÄ±nÄ± kaydet - string deÄŸerleri temizle ve sayÄ±ya dÃ¶nÃ¼ÅŸtÃ¼r
    if(satisInput){
      const satisValue = satisInput.value.toString().replace(/[^\d.,]/g, '').replace(',', '.');
      item.satisFiyat = parseFloat(satisValue) || 0;
    }
  });
}

// Toplu Ã¼rÃ¼n item'Ä± kaldÄ±r
function removeTopluUrunItem(index){
  // Ã–nce mevcut input deÄŸerlerini kaydet
  saveTopluUrunInputs();
  topluUrunListesi.splice(index, 1);
  renderTopluUrunListe();
}

function renderTopluUrunListe(){
  const liste = document.getElementById('topluUrunListe');
  if(!liste) return;

  if(topluUrunListesi.length === 0){
    liste.innerHTML = '<div class="muted" style="text-align:center; padding:20px">HenÃ¼z Ã¼rÃ¼n eklenmedi</div>';
    return;
  }

  liste.innerHTML = topluUrunListesi.map((item, index)=>{
    const selectedYemek = item.kategori==='yemek'?'selected':'';
    const selectedIcecek = item.kategori==='icecek'?'selected':'';
    const selectedAtistirmalik = item.kategori==='atistirmalik'?'selected':'';
    const selectedDiger = item.kategori==='diger'?'selected':'';
    return '<div class="toplu-urun-item" data-index="' + index + '">' +
      '<div class="item-header">' +
      '<div class="item-title">ÃœrÃ¼n #' + (index + 1) + '</div>' +
      '<button class="item-remove" data-remove-index="' + index + '" title="KaldÄ±r">âœ–</button>' +
      '</div>' +
      '<div class="row">' +
      '<div class="col-6 field" style="position:relative">' +
      '<label>Marka</label>' +
      '<input type="text" class="toplu-marka" data-index="' + index + '" placeholder="Ã–rn: Ãœlker" value="' + (item.marka || '') + '" />' +
      '<div class="marka-suggestions" id="toplu-marka-suggestions-' + index + '"></div>' +
      '</div>' +
      '<div class="col-6 field">' +
      '<label>ÃœrÃ¼n AdÄ±</label>' +
      '<input type="text" class="toplu-ad" data-index="' + index + '" placeholder="ÃœrÃ¼n adÄ±" value="' + (item.ad || '') + '" />' +
      '</div>' +
      '</div>' +
      '<div class="row">' +
      '<div class="col-4 field">' +
      '<label>Gramaj</label>' +
      '<input type="text" class="toplu-gramaj" data-index="' + index + '" placeholder="200g" value="' + (item.gramaj || '') + '" />' +
      '</div>' +
      '<div class="col-4 field">' +
      '<label>Kategori</label>' +
      '<select class="toplu-kategori" data-index="' + index + '">' +
      '<option value="yemek" ' + selectedYemek + '>ğŸ½ï¸ Yemek</option>' +
      '<option value="icecek" ' + selectedIcecek + '>ğŸ¥¤ Ä°Ã§ecek</option>' +
      '<option value="atistirmalik" ' + selectedAtistirmalik + '>ğŸª AtÄ±ÅŸtÄ±rmalÄ±k</option>' +
      '<option value="diger" ' + selectedDiger + '>ğŸ“¦ DiÄŸer</option>' +
      '</select>' +
      '</div>' +
      '<div class="col-4 field">' +
      '<label>Adet</label>' +
      '<input type="number" class="toplu-adet" data-index="' + index + '" min="1" value="' + (item.adet || 1) + '" />' +
      '</div>' +
      '</div>' +
      '<div class="row">' +
      '<div class="col-4 field">' +
      '<label>GeliÅŸ FiyatÄ± (â‚º)</label>' +
      '<input type="number" class="toplu-gelis" data-index="' + index + '" step="0.01" min="0" value="' + (item.gelisFiyat || 0) + '" />' +
      '</div>' +
      '<div class="col-4 field">' +
      '<label>YÃ¼zde ArtÄ±ÅŸ (%)</label>' +
      '<input type="number" class="toplu-yuzde" data-index="' + index + '" step="0.1" min="0" value="' + (item.yuzde || 0) + '" />' +
      '</div>' +
      '<div class="col-4 field">' +
      '<label>SatÄ±ÅŸ FiyatÄ± (â‚º)</label>' +
      '<input type="number" class="toplu-satis" data-index="' + index + '" step="0.01" min="0" value="' + (parseFloat(item.satisFiyat) || 0).toFixed(2) + '" data-manuel-degistirildi="false" />' +
      '</div>' +
      '</div>' +
      '</div>';
  }).join('');

  // Event listener'larÄ± ekle
  liste.querySelectorAll('.toplu-gelis, .toplu-yuzde, .toplu-adet').forEach(input=>{
    // VirgÃ¼l giriÅŸi desteÄŸi (TÃ¼rkÃ§e format)
    input.addEventListener('input', (e)=>{
      // VirgÃ¼lÃ¼ noktaya Ã§evir (sadece bir kez)
      let value = e.target.value;
      if(value.includes(',')){
        value = value.replace(',', '.');
        e.target.value = value;
      }
      const index = parseInt(input.dataset.index);
      updateTopluUrunFiyat(index);
    });
  });
  
  // SatÄ±ÅŸ fiyatÄ± input'u iÃ§in blur ve input event listener (manuel deÄŸiÅŸiklikleri kaydet)
  liste.querySelectorAll('.toplu-satis').forEach(input=>{
    input.addEventListener('input', (e)=>{
      // VirgÃ¼lÃ¼ noktaya Ã§evir (TÃ¼rkÃ§e format)
      let value = e.target.value;
      if(value.includes(',')){
        value = value.replace(',', '.');
        e.target.value = value;
      }
      // KullanÄ±cÄ± manuel deÄŸiÅŸtirdiÄŸini iÅŸaretle
      input.dataset.manuelDegistirildi = 'true';
    });
    input.addEventListener('blur', ()=>{
      const index = parseInt(input.dataset.index);
      const item = topluUrunListesi[index];
      if(item){
        // String deÄŸeri temizle ve sayÄ±ya dÃ¶nÃ¼ÅŸtÃ¼r
        const satisValue = input.value.toString().replace(/[^\d.,]/g, '').replace(',', '.');
        const manuelFiyat = parseFloat(satisValue) || 0;
        item.satisFiyat = manuelFiyat;
        // Input deÄŸerini de dÃ¼zelt
        input.value = manuelFiyat.toFixed(2);
      }
    });
  });

  // DiÄŸer input'lar iÃ§in blur event listener (deÄŸer kaydetmek iÃ§in)
  liste.querySelectorAll('.toplu-ad, .toplu-gramaj').forEach(input=>{
    input.addEventListener('blur', ()=>{
      const index = parseInt(input.dataset.index);
      const item = topluUrunListesi[index];
      if(item){
        if(input.classList.contains('toplu-ad')){
          item.ad = input.value.trim();
        } else if(input.classList.contains('toplu-gramaj')){
          item.gramaj = input.value.trim();
        }
      }
    });
  });

  // Kategori select iÃ§in change event listener
  liste.querySelectorAll('.toplu-kategori').forEach(select=>{
    select.addEventListener('change', ()=>{
      const index = parseInt(select.dataset.index);
      const item = topluUrunListesi[index];
      if(item){
        item.kategori = select.value;
      }
    });
  });

  // Marka Ã¶nerilerini aktif et
  liste.querySelectorAll('.toplu-marka').forEach(input=>{
    const index = input.dataset.index;
    showTopluMarkaSuggestions(index);
  });

  // Event delegation for remove buttons
  liste.addEventListener('click', (e)=>{
    const removeBtn = e.target.closest('.item-remove');
    if(removeBtn && removeBtn.dataset.removeIndex){
      const index = parseInt(removeBtn.dataset.removeIndex);
      removeTopluUrunItem(index);
    }
  });
}

function updateTopluUrunFiyat(index){
  const item = topluUrunListesi[index];
  if(!item) return;

  const gelisInput = document.querySelector(`.toplu-gelis[data-index="${index}"]`);
  const yuzdeInput = document.querySelector(`.toplu-yuzde[data-index="${index}"]`);
  const adetInput = document.querySelector(`.toplu-adet[data-index="${index}"]`);
  const satisInput = document.querySelector(`.toplu-satis[data-index="${index}"]`);
  
    // DeÄŸerleri temizle ve sayÄ±ya dÃ¶nÃ¼ÅŸtÃ¼r (virgÃ¼lÃ¼ noktaya Ã§evir)
  const gelisFiyat = gelisInput ? parseFloat(gelisInput.value.toString().replace(/[^\d.,]/g, '').replace(',', '.')) || 0 : 0;
  const yuzde = yuzdeInput ? parseFloat(yuzdeInput.value.toString().replace(/[^\d.,]/g, '').replace(',', '.')) || 0 : 0;
  const adet = adetInput ? parseInt(adetInput.value.toString().replace(/[^\d]/g, '')) || 1 : 1;
  
  item.gelisFiyat = gelisFiyat;
  item.yuzde = yuzde;
  item.adet = adet;

  // EÄŸer kullanÄ±cÄ± satÄ±ÅŸ fiyatÄ±nÄ± manuel deÄŸiÅŸtirmiÅŸse, o deÄŸeri koru
  const kullaniciManuelDegistirdi = satisInput && satisInput.dataset.manuelDegistirildi === 'true';
  
  if(!kullaniciManuelDegistirdi && gelisFiyat > 0 && adet > 0){
    // Sadece otomatik hesaplama yapÄ±lÄ±yorsa gÃ¼ncelle (gelisFiyat ve adet varsa)
    // gelisFiyat = toplam alÄ±ÅŸ fiyatÄ±, adet = Ã¼rÃ¼n adedi
    // Birim alÄ±ÅŸ fiyatÄ± = gelisFiyat / adet
    // Birim satÄ±ÅŸ fiyatÄ± = (birim alÄ±ÅŸ fiyatÄ±) * (1 + yuzde/100)
    const birimAlisFiyat = gelisFiyat / adet;
    const hesaplanan = birimAlisFiyat * (1 + (yuzde / 100));
    item.satisFiyat = parseFloat(hesaplanan.toFixed(2));
    if(satisInput){
      satisInput.value = item.satisFiyat.toFixed(2);
      satisInput.dataset.manuelDegistirildi = 'false';
    }
  } else if(satisInput && kullaniciManuelDegistirdi){
    // KullanÄ±cÄ± manuel deÄŸiÅŸtirmiÅŸse, mevcut input deÄŸerini koru
    const satisValue = satisInput.value.toString().replace(/[^\d.,]/g, '').replace(',', '.');
    const mevcutManuelFiyat = parseFloat(satisValue) || 0;
    item.satisFiyat = mevcutManuelFiyat;
  }
  // EÄŸer gelisFiyat veya adet yoksa, mevcut satÄ±ÅŸ fiyatÄ±nÄ± koru (deÄŸiÅŸtirme)
}

function showTopluMarkaSuggestions(index){
  const input = document.querySelector(`.toplu-marka[data-index="${index}"]`);
  const suggestions = document.getElementById(`toplu-marka-suggestions-${index}`);
  if(!input || !suggestions) return;

  function renderSuggestions(filteredList){
    suggestions.innerHTML = filteredList.map(m=>{
      const escapedMarka = m.replace(/"/g, '&quot;');
      return '<div class="marka-suggestion-item" data-marka="' + escapedMarka + '" data-index="' + index + '">' + m + '</div>';
    }).join('');
  }

  input.addEventListener('focus', ()=>{
    if(markaListesi.length === 0) return;
    renderSuggestions(markaListesi);
    suggestions.classList.add('show');
  });

  input.addEventListener('blur', ()=>{
    setTimeout(()=>{
      suggestions.classList.remove('show');
    }, 200);
  });

  input.addEventListener('input', (e)=>{
    const val = e.target.value.toLowerCase();
    const item = topluUrunListesi[index];
    if(item) item.marka = e.target.value;
    
    if(!val){
      renderSuggestions(markaListesi);
      return;
    }
    const filtered = markaListesi.filter(m=>m.toLowerCase().includes(val));
    if(filtered.length > 0){
      renderSuggestions(filtered);
      suggestions.classList.add('show');
    } else {
      suggestions.classList.remove('show');
    }
  });

  // Event delegation for suggestion clicks
  suggestions.addEventListener('click', (e)=>{
    const item = e.target.closest('.marka-suggestion-item');
    if(item){
      const marka = item.dataset.marka;
      const itemIndex = parseInt(item.dataset.index);
      const targetInput = document.querySelector(`.toplu-marka[data-index="${itemIndex}"]`);
      if(targetInput){
        targetInput.value = marka;
        const listItem = topluUrunListesi[itemIndex];
        if(listItem) listItem.marka = marka;
        suggestions.classList.remove('show');
      }
    }
  });
}

// Toplu Ã¼rÃ¼n alÄ±m modal aÃ§
(function(){
  const btn = document.getElementById('btnTopluAlimEkle');
  if(btn){
    btn.addEventListener('click', ()=>{
      topluUrunListesi = [];
      addTopluUrunItem();
      // Tarihi bugÃ¼n olarak ayarla
      const today = new Date().toISOString().slice(0,10);
      const tarihInput = document.getElementById('toplu-alim-tarih');
      if(tarihInput) tarihInput.value = today;
      openModal('topluUrunEkleModal');
    });
  }
  
  const btn2 = document.getElementById('toplu-urun-ekle-btn');
  if(btn2){
    btn2.addEventListener('click', ()=>{
      addTopluUrunItem();
    });
  }
})();

// Toplu Ã¼rÃ¼n alÄ±m kaydet
(function(){
  const btn = document.getElementById('topluUrunKaydetBtn');
  if(!btn) return;
  
  btn.addEventListener('click', async ()=>{
    const tarih = document.getElementById('toplu-alim-tarih').value;
    if(!tarih){
      toast('Tarih seÃ§iniz');
      return;
    }
    
    // Ã–nce mevcut input deÄŸerlerini kaydet
    saveTopluUrunInputs();

    // Validasyon
    const gecersiz = topluUrunListesi.find((item, index)=>{
      if(!item.marka || !item.ad){
        toast('ÃœrÃ¼n #' + (index + 1) + ': Marka ve ad zorunludur');
        return true;
      }
      if(!item.gelisFiyat || item.gelisFiyat <= 0){
        toast('ÃœrÃ¼n #' + (index + 1) + ': Toplam alÄ±ÅŸ fiyatÄ± giriniz');
        return true;
      }
      if(!item.satisFiyat || item.satisFiyat <= 0){
        toast('ÃœrÃ¼n #' + (index + 1) + ': SatÄ±ÅŸ fiyatÄ± giriniz');
        return true;
      }
      return false;
    });

    if(gecersiz) return;

    // Loading state gÃ¶ster
    btn.disabled = true;
    btn.textContent = 'â³ Kaydediliyor...';
    const modalBody = document.querySelector('#topluUrunEkleModal .modal__body');
    const originalContent = modalBody.innerHTML;
    modalBody.style.position = 'relative';
    const loadingDiv = document.createElement('div');
    loadingDiv.style.cssText = 'position:absolute; top:0; left:0; right:0; bottom:0; background:rgba(255,255,255,0.9); display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:1000; gap:12px;';
    loadingDiv.innerHTML = '<div class="spinner"></div><div style="font-size:14px; color:var(--text)">ÃœrÃ¼nler kaydediliyor... (' + topluUrunListesi.length + ' Ã¼rÃ¼n)</div>';
    modalBody.appendChild(loadingDiv);

    try{
      const batch = db.batch();
      const alimUrunler = [];
      let toplamTutar = 0;
      let islenenUrun = 0;

      for(const item of topluUrunListesi){
        islenenUrun++;
        // Loading durumunu gÃ¼ncelle
        loadingDiv.querySelector('div:last-child').textContent = 'ÃœrÃ¼nler kaydediliyor... (' + islenenUrun + '/' + topluUrunListesi.length + ')';
        const urunAdi = item.marka ? (item.marka + ' ' + item.ad).trim() : item.ad;
        
        // Mevcut Ã¼rÃ¼nÃ¼ kontrol et
        const mevcutUrunSnap = await db.collection('kantin_urunler')
          .where('ad','==',urunAdi)
          .where('kategori','==',item.kategori)
          .where('aktif','==',true)
          .limit(1)
          .get();
        
        let urunId;
        let yeniUrun = false;
        
        if(!mevcutUrunSnap.empty){
          // Mevcut Ã¼rÃ¼n var - stok artÄ±r ve fiyat gÃ¼ncelle
          const mevcutUrun = mevcutUrunSnap.docs[0];
          urunId = mevcutUrun.id;
          const mevcutData = mevcutUrun.data();
          const mevcutStok = toNum(mevcutData.stok || 0);
          
          const urunRef = db.collection('kantin_urunler').doc(urunId);
          batch.update(urunRef, {
            stok: mevcutStok + item.adet,
            gelisFiyat: item.gelisFiyat,
            fiyat: item.satisFiyat,
            yuzdeArtis: item.yuzde,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        } else {
          // Yeni Ã¼rÃ¼n ekle
          const urunRef = db.collection('kantin_urunler').doc();
          urunId = urunRef.id;
          yeniUrun = true;
          batch.set(urunRef, {
            ad: urunAdi,
            marka: item.marka,
            gramaj: item.gramaj,
            kategori: item.kategori,
            adet: item.adet,
            gelisFiyat: item.gelisFiyat,
            yuzdeArtis: item.yuzde,
            fiyat: item.satisFiyat,
            aciklama: '',
            stok: item.adet,
            aktif: true,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            createdBy: currentUser?.email || null,
            uid: currentUserUid || null
          });
          addMarka(item.marka);
        }
        
        alimUrunler.push({
          urunId: urunId,
          urunAd: urunAdi,
          miktar: item.adet,
          birimAlisFiyat: item.gelisFiyat / item.adet,
          toplamAlisFiyat: item.gelisFiyat,
          birimSatisFiyat: item.satisFiyat,
          yeniUrun: yeniUrun
        });
        
        toplamTutar += item.gelisFiyat;
      }
      
      // AlÄ±m kaydÄ± oluÅŸtur
      const alimRef = db.collection('kantin_alinimlar').doc();
      batch.set(alimRef, {
        tarih: tarih,
        urunler: alimUrunler,
        toplamTutar: toplamTutar,
        aciklama: '',
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        createdBy: currentUser?.email || null,
        uid: currentUserUid || null
      });

      await batch.commit();
      
      // Loading'i kaldÄ±r
      loadingDiv.remove();
      btn.disabled = false;
      btn.textContent = 'TÃ¼mÃ¼nÃ¼ Kaydet';
      
      toast('âœ… ' + topluUrunListesi.length + ' Ã¼rÃ¼n alÄ±mÄ± kaydedildi ve stoklar gÃ¼ncellendi!');
      closeModal(document.getElementById('topluUrunEkleModal'));
      // AlÄ±m ekleme yapÄ±nca tÃ¼m sekmeler gÃ¼ncellenmeli (alÄ±mlar ana kaynak)
      await loadAlinimlar();
      await loadUrunler();
      await loadUrunYonetim(); // Ayarlar sekmesi de gÃ¼ncellenmeli
    }catch(e){
      console.error(e);
      // Loading'i kaldÄ±r
      loadingDiv.remove();
      btn.disabled = false;
      btn.textContent = 'TÃ¼mÃ¼nÃ¼ Kaydet';
      toast('AlÄ±m kaydedilemedi: ' + (e.message || 'Bilinmeyen hata'));
    }
  });
})();

/* ===== SayÄ±m ===== */
let personelListesi = [];

// Personel listesini yÃ¼kle
async function loadPersonelListesi(){
  try{
    const snap = await db.collection('kullanicilar').limit(200).get();
    personelListesi = [];
    snap.forEach(doc=>{
      const d = doc.data()||{};
      const ad = (d.adSoyad || '').trim() || (d.email || '');
      if(ad) personelListesi.push(ad);
    });
    personelListesi.sort((a,b)=>a.localeCompare(b,'tr'));
    
    // Personel select'i doldur
    const sel = document.getElementById('sayim-personel');
    if(sel){
      sel.innerHTML = '<option value="">â€” SeÃ§iniz â€”</option>' + 
        personelListesi.map(p=>'<option value="' + p + '">' + p + '</option>').join('');
    }
  }catch(e){
    console.error(e);
  }
}

// SayÄ±m ekle modal aÃ§
(function(){
  const btn = document.getElementById('btnSayimEkle');
  if(!btn) return;
  
  btn.addEventListener('click', async ()=>{
    // Modal'Ä± yeni sayÄ±m moduna al
    document.getElementById('sayimModalTitle').textContent = 'GÃ¼n Sonu SayÄ±m';
    document.getElementById('sayimDuzenleId').value = '';
    document.getElementById('sayimKaydetBtn').style.display = 'inline-flex';
    document.getElementById('sayimGuncelleBtn').style.display = 'none';
    
    // Tarihi bugÃ¼n olarak ayarla
    const today = new Date().toISOString().slice(0,10);
    document.getElementById('sayim-tarih').value = today;
    document.getElementById('sayim-personel').value = '';
    document.getElementById('sayim-kantinci').value = '';
    
    // Para daÄŸÄ±lÄ±mÄ± formlarÄ±nÄ± temizle
    document.getElementById('sayim-muhasebe').value = '';
    document.getElementById('sayim-nakit').value = '';
    document.getElementById('sayim-aciklama').value = '';
    sayimBorclarListesi = [];
    renderSayimBorclarListe();

    // Personel listesini yÃ¼kle
    await loadPersonelListesi();
    
    // ÃœrÃ¼nleri gÃ¼ncel stoklarla yeniden yÃ¼kle
    await loadUrunler();
    
    // ÃœrÃ¼n listesini render et
    await renderSayimUrunListe();
    
    openModal('sayimEkleModal');
  });
})();

// SayÄ±m dÃ¼zenle modal aÃ§
async function openSayimDuzenleModal(sayimId){
  try{
    toast('ğŸ“‹ SayÄ±m verileri yÃ¼kleniyor...');
    
    const sayimDoc = await db.collection('kantin_sayimlar').doc(sayimId).get();
    if(!sayimDoc.exists){
      toast('âŒ SayÄ±m kaydÄ± bulunamadÄ±');
      return;
    }
    
    const data = sayimDoc.data();
    
    // Modal'Ä± dÃ¼zenle moduna al
    document.getElementById('sayimModalTitle').textContent = 'SayÄ±m DÃ¼zenle';
    document.getElementById('sayimDuzenleId').value = sayimId;
    document.getElementById('sayimKaydetBtn').style.display = 'none';
    document.getElementById('sayimGuncelleBtn').style.display = 'inline-flex';
    
    // Form alanlarÄ±nÄ± doldur
    document.getElementById('sayim-tarih').value = data.tarih || '';
    document.getElementById('sayim-personel').value = data.personel || '';
    document.getElementById('sayim-kantinci').value = data.kantinci || '';
    document.getElementById('sayim-aciklama').value = data.aciklama || '';
    
    // Para daÄŸÄ±lÄ±mÄ±
    const paraDagilimi = data.paraDagilimi || {};
    document.getElementById('sayim-muhasebe').value = paraDagilimi.muhasebe || '';
    document.getElementById('sayim-nakit').value = paraDagilimi.nakit || '';
    
    // BorÃ§larÄ± yÃ¼kle
    const borclarSnap = await db.collection('kantin_borclar')
      .where('sayimId', '==', sayimId)
      .get();
    
    sayimBorclarListesi = [];
    borclarSnap.forEach(doc=>{
      const borcData = doc.data();
      sayimBorclarListesi.push({
        kisi: borcData.kisi || '',
        miktar: toNum(borcData.miktar || 0)
      });
    });
    renderSayimBorclarListe();
    
    // ÃœrÃ¼nleri yÃ¼kle ve sayÄ±m verilerini gÃ¶ster
    await loadUrunler();
    
    // SayÄ±m Ã¼rÃ¼n listesini render et (mevcut sayÄ±m verileriyle)
    const sayimUrunler = data.urunler || [];
    const tbody = document.getElementById('sayimUrunListe');
    
    if(!allUrunler.length){
      tbody.innerHTML = '<tr><td colspan="4" class="muted">ÃœrÃ¼n bulunamadÄ±</td></tr>';
      return;
    }
    
    tbody.innerHTML = allUrunler.map(urun=>{
      // SayÄ±m verilerinden bu Ã¼rÃ¼nÃ¼ bul
      const sayimUrun = sayimUrunler.find(su=>su.urunId === urun.id);
      const mevcutAdet = sayimUrun ? (sayimUrun.mevcutAdet || urun.stok) : urun.stok;
      const kalanAdet = sayimUrun ? (sayimUrun.kalanAdet || urun.stok) : urun.stok;
      const gelisFiyat = urun.gelisFiyat || 0;
      
      return '<tr data-urun-id="' + urun.id + '">' +
        '<td style="text-align:left">' + urun.ad + '</td>' +
        '<td style="text-align:center; font-weight:700">' + mevcutAdet + '</td>' +
        '<td>' +
        '<input type="number" ' +
        'class="sayim-kalan-adet" ' +
        'data-urun-id="' + urun.id + '" ' +
        'data-mevcut="' + mevcutAdet + '" ' +
        'data-fiyat="' + urun.fiyat + '" ' +
        'data-gelis-fiyat="' + gelisFiyat + '" ' +
        'min="0" ' +
        'max="' + mevcutAdet + '" ' +
        'value="' + kalanAdet + '" ' +
        'style="width:100px; text-align:center" />' +
        '</td>' +
        '<td style="text-align:center; font-weight:700" id="satilan-' + urun.id + '">' + (sayimUrun ? (sayimUrun.satilanAdet || 0) : 0) + '</td>' +
        '</tr>';
    }).join('');
    
    // SatÄ±lan adetleri hesapla
    allUrunler.forEach(urun=>{
      updateSayimSatilanAdet(urun.id);
    });
    
    // Personel listesini yÃ¼kle
    await loadPersonelListesi();
    
    // Toplam geliri gÃ¼ncelle
    updateSayimToplamGelir();
    
    openModal('sayimEkleModal');
    toast('âœ… SayÄ±m verileri yÃ¼klendi');
  }catch(e){
    console.error(e);
    toast('âŒ SayÄ±m verileri yÃ¼klenemedi: ' + (e.message || 'Bilinmeyen hata'));
  }
}

// SayÄ±m iÃ§in Ã¼rÃ¼n listesini render et
async function renderSayimUrunListe(){
  const tbody = document.getElementById('sayimUrunListe');
  
  // Her zaman gÃ¼ncel Ã¼rÃ¼nleri yÃ¼kle (stoklar gÃ¼ncel olsun)
  await loadUrunler();
  
  if(!allUrunler.length){
    tbody.innerHTML = '<tr><td colspan="4" class="muted">ÃœrÃ¼n bulunamadÄ±</td></tr>';
    return;
  }
  
  tbody.innerHTML = allUrunler.map(urun=>{
    const mevcutAdet = urun.stok || 0;
    const gelisFiyat = urun.gelisFiyat || 0;
    return '<tr data-urun-id="' + urun.id + '">' +
      '<td style="text-align:left">' + urun.ad + '</td>' +
      '<td style="text-align:center; font-weight:700">' + mevcutAdet + '</td>' +
      '<td>' +
      '<input type="number" ' +
      'class="sayim-kalan-adet" ' +
      'data-urun-id="' + urun.id + '" ' +
      'data-mevcut="' + mevcutAdet + '" ' +
      'data-fiyat="' + urun.fiyat + '" ' +
      'data-gelis-fiyat="' + gelisFiyat + '" ' +
      'min="0" ' +
      'max="' + mevcutAdet + '" ' +
      'value="' + mevcutAdet + '" ' +
      'style="width:100px; text-align:center" />' +
      '</td>' +
      '<td style="text-align:center; font-weight:700" id="satilan-' + urun.id + '">0</td>' +
      '</tr>';
  }).join('');
  
  // Ä°lk yÃ¼klemede satÄ±lan adetleri hesapla
  allUrunler.forEach(urun=>{
    updateSayimSatilanAdet(urun.id);
  });

  // Event delegation for sayÄ±m input changes (sadece bir kez ekle)
  if(tbody && !tbody.dataset.listenerAdded){
    tbody.addEventListener('input', (e)=>{
      if(e.target.classList.contains('sayim-kalan-adet')){
        const urunId = e.target.dataset.urunId;
        if(urunId) updateSayimSatilanAdet(urunId);
      }
    });
    tbody.dataset.listenerAdded = 'true';
  }
}

// SayÄ±m satÄ±lan adet gÃ¼ncelle
function updateSayimSatilanAdet(urunId){
  const input = document.querySelector(`.sayim-kalan-adet[data-urun-id="${urunId}"]`);
  const satilanCell = document.getElementById(`satilan-${urunId}`);
  if(!input || !satilanCell) return;
  
  const mevcut = parseInt(input.dataset.mevcut) || 0;
  const kalan = parseInt(input.value) || 0;
  const satilan = Math.max(0, mevcut - kalan);
  
  satilanCell.textContent = satilan;
  if(satilan > 0){
    satilanCell.style.color = 'var(--success)';
  } else {
    satilanCell.style.color = 'var(--text)';
  }
  
  // Toplam gelir ve karÄ± gÃ¼ncelle
  updateSayimToplamGelir();
}

// SayÄ±m toplam gelir hesapla (kar hesaplama kaldÄ±rÄ±ldÄ±)
function updateSayimToplamGelir(){
  let toplamGelir = 0;
  
  document.querySelectorAll('.sayim-kalan-adet').forEach(input=>{
    const mevcut = parseInt(input.dataset.mevcut) || 0;
    const kalan = parseInt(input.value) || 0;
    const satilan = Math.max(0, mevcut - kalan);
    const fiyat = toNum(input.dataset.fiyat || 0);
    
    const gelir = satilan * fiyat;
    toplamGelir += gelir;
  });
  
  const gelirEl = document.getElementById('sayim-toplam-gelir');
  if(gelirEl) gelirEl.value = toplamGelir.toLocaleString('tr-TR',{minimumFractionDigits:2,maximumFractionDigits:2}) + ' â‚º';
  
  // Para daÄŸÄ±lÄ±mÄ± kontrolÃ¼
  updateSayimParaDagilimKontrol(toplamGelir);
}

// Para daÄŸÄ±lÄ±mÄ± kontrolÃ¼
function updateSayimParaDagilimKontrol(toplamGelir){
  const muhasebe = toNum(document.getElementById('sayim-muhasebe')?.value || 0);
  const borclarToplam = toNum(document.getElementById('sayim-borclar-toplam')?.value || 0);
  const nakit = toNum(document.getElementById('sayim-nakit')?.value || 0);
  
  const dagilimToplam = muhasebe + borclarToplam + nakit;
  const fark = Math.abs(toplamGelir - dagilimToplam);
  
  const kontrolEl = document.getElementById('sayim-borclar-kontrol');
  const dagilimToplamEl = document.getElementById('sayim-dagilim-toplam');
  const gelirGosterEl = document.getElementById('sayim-gelir-goster');
  const farkEl = document.getElementById('sayim-fark');
  
  if(kontrolEl && dagilimToplamEl && gelirGosterEl && farkEl){
    if(Math.abs(fark) > 0.01){ // 1 kuruÅŸ tolerans
      kontrolEl.style.display = 'block';
      dagilimToplamEl.textContent = dagilimToplam.toLocaleString('tr-TR',{minimumFractionDigits:2,maximumFractionDigits:2});
      gelirGosterEl.textContent = toplamGelir.toLocaleString('tr-TR',{minimumFractionDigits:2,maximumFractionDigits:2});
      farkEl.textContent = fark.toLocaleString('tr-TR',{minimumFractionDigits:2,maximumFractionDigits:2});
    } else {
      kontrolEl.style.display = 'none';
    }
  }
}

// BorÃ§lar yÃ¶netimi
let sayimBorclarListesi = [];

function addSayimBorcItem(){
  const index = sayimBorclarListesi.length;
  sayimBorclarListesi.push({
    kisi: '',
    miktar: 0
  });
  renderSayimBorclarListe();
}

function removeSayimBorcItem(index){
  sayimBorclarListesi.splice(index, 1);
  renderSayimBorclarListe();
}

function renderSayimBorclarListe(){
  const liste = document.getElementById('sayim-borclar-liste');
  if(!liste) return;
  
  if(sayimBorclarListesi.length === 0){
    liste.innerHTML = '<div class="muted" style="text-align:center; padding:12px; font-size:13px">HenÃ¼z borÃ§ eklenmedi</div>';
    document.getElementById('sayim-borclar-toplam').value = '0.00';
    return;
  }
  
  let toplam = 0;
  liste.innerHTML = sayimBorclarListesi.map((item, index)=>{
    const miktar = toNum(item.miktar || 0);
    toplam += miktar;
    return '<div style="display:flex; gap:8px; align-items:center; padding:8px; background:var(--surface2); border-radius:8px">' +
      '<input type="text" class="sayim-borc-kisi" data-index="' + index + '" placeholder="KiÅŸi adÄ±" value="' + (item.kisi || '') + '" style="flex:1; padding:8px; border:1px solid var(--stroke); border-radius:8px" />' +
      '<input type="number" step="0.01" class="sayim-borc-miktar" data-index="' + index + '" placeholder="0.00" value="' + miktar + '" style="width:120px; padding:8px; border:1px solid var(--stroke); border-radius:8px" />' +
      '<button type="button" class="btn-ghost" data-remove-borc-index="' + index + '" style="padding:6px 10px">âœ–</button>' +
      '</div>';
  }).join('');
  
  document.getElementById('sayim-borclar-toplam').value = toplam.toLocaleString('tr-TR',{minimumFractionDigits:2,maximumFractionDigits:2});
  
  // Event listeners
  liste.querySelectorAll('.sayim-borc-kisi').forEach(input=>{
    input.addEventListener('input', (e)=>{
      const index = parseInt(e.target.dataset.index);
      if(sayimBorclarListesi[index]) sayimBorclarListesi[index].kisi = e.target.value;
    });
  });
  
  liste.querySelectorAll('.sayim-borc-miktar').forEach(input=>{
    input.addEventListener('input', (e)=>{
      const index = parseInt(e.target.dataset.index);
      const miktar = toNum(e.target.value || 0);
      if(sayimBorclarListesi[index]) sayimBorclarListesi[index].miktar = miktar;
      renderSayimBorclarListe(); // ToplamÄ± gÃ¼ncelle
      const toplamGelir = toNum(document.getElementById('sayim-toplam-gelir')?.value?.replace(/[^\d,.-]/g, '').replace(',', '.') || 0);
      updateSayimParaDagilimKontrol(toplamGelir);
    });
  });
  
  liste.querySelectorAll('[data-remove-borc-index]').forEach(btn=>{
    btn.addEventListener('click', (e)=>{
      const index = parseInt(e.target.closest('[data-remove-borc-index]').dataset.removeBorcIndex);
      removeSayimBorcItem(index);
      const toplamGelir = toNum(document.getElementById('sayim-toplam-gelir')?.value?.replace(/[^\d,.-]/g, '').replace(',', '.') || 0);
      updateSayimParaDagilimKontrol(toplamGelir);
    });
  });
}

// BorÃ§ ekle butonu
(function(){
  const btn = document.getElementById('sayim-borc-ekle-btn');
  if(btn){
    btn.addEventListener('click', ()=>{
      addSayimBorcItem();
    });
  }
  
  // Para daÄŸÄ±lÄ±mÄ± input deÄŸiÅŸikliklerini dinle
  const muhasebeEl = document.getElementById('sayim-muhasebe');
  const nakitEl = document.getElementById('sayim-nakit');
  
  if(muhasebeEl) muhasebeEl.addEventListener('input', ()=>{
    const toplamGelir = toNum(document.getElementById('sayim-toplam-gelir')?.value?.replace(/[^\d,.-]/g, '').replace(',', '.') || 0);
    updateSayimParaDagilimKontrol(toplamGelir);
  });
  
  if(nakitEl) nakitEl.addEventListener('input', ()=>{
    const toplamGelir = toNum(document.getElementById('sayim-toplam-gelir')?.value?.replace(/[^\d,.-]/g, '').replace(',', '.') || 0);
    updateSayimParaDagilimKontrol(toplamGelir);
  });
})();

// SayÄ±m kaydet
(function(){
  const btn = document.getElementById('sayimKaydetBtn');
  if(!btn) return;
  
  btn.addEventListener('click', async ()=>{
    const tarih = document.getElementById('sayim-tarih').value;
    const personel = document.getElementById('sayim-personel').value;
    const kantinci = (document.getElementById('sayim-kantinci').value || '').trim();
    
    if(!tarih || !personel || !kantinci){
      toast('Tarih, personel ve kantinci seÃ§imi zorunludur');
      return;
    }
    
    // Para daÄŸÄ±lÄ±mÄ± kontrolÃ¼
    const muhasebe = toNum(document.getElementById('sayim-muhasebe')?.value || 0);
    const borclarToplam = toNum(document.getElementById('sayim-borclar-toplam')?.value || 0);
    const nakit = toNum(document.getElementById('sayim-nakit')?.value || 0);
    const aciklama = (document.getElementById('sayim-aciklama')?.value || '').trim();
    
    // TÃ¼m Ã¼rÃ¼n verilerini topla (satÄ±ÅŸ yapÄ±lan ve yapÄ±lmayan tÃ¼m Ã¼rÃ¼nler)
    const sayimUrunler = [];
    let toplamGelir = 0;
    const batch = db.batch();
    
    document.querySelectorAll('.sayim-kalan-adet').forEach(input=>{
      const urunId = input.dataset.urunId;
      const mevcut = parseInt(input.dataset.mevcut) || 0;
      const kalan = parseInt(input.value) || 0;
      const satilan = Math.max(0, mevcut - kalan);
      const fiyat = toNum(input.dataset.fiyat || 0);
      const gelisFiyat = toNum(input.dataset.gelisFiyat || 0);
      
      // Stok gÃ¼ncelle (kalan adet = yeni stok)
      const urunRef = db.collection('kantin_urunler').doc(urunId);
      batch.update(urunRef, {
        stok: kalan,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      
      // TÃ¼m Ã¼rÃ¼nleri kaydet (satÄ±ÅŸ yapÄ±lsÄ±n ya da yapÄ±lmasÄ±n)
      const gelir = satilan * fiyat;
      const maliyet = satilan * gelisFiyat;
      
      sayimUrunler.push({
        urunId: urunId,
        urunAd: allUrunler.find(u=>u.id === urunId)?.ad || '',
        mevcutAdet: mevcut,
        kalanAdet: kalan,
        satilanAdet: satilan,
        birimFiyat: fiyat,
        birimMaliyet: gelisFiyat,
        toplamGelir: gelir,
        toplamMaliyet: maliyet
      });
      
      toplamGelir += gelir;
    });
    
    // Para daÄŸÄ±lÄ±mÄ± kontrolÃ¼
    const dagilimToplam = muhasebe + borclarToplam + nakit;
    const fark = Math.abs(toplamGelir - dagilimToplam);
    if(fark > 0.01){
      if(!confirm('Para daÄŸÄ±lÄ±mÄ± toplam gelire eÅŸit deÄŸil! Fark: ' + fark.toLocaleString('tr-TR',{minimumFractionDigits:2,maximumFractionDigits:2}) + 'â‚º\n\nYine de kaydetmek istiyor musunuz?')){
        return;
      }
    }
    
    try{
      // SayÄ±m kaydÄ± ekle
      const sayimRef = db.collection('kantin_sayimlar').doc();
      const sayimId = sayimRef.id;
      
      batch.set(sayimRef, {
        tarih: tarih,
        personel: personel,
        kantinci: kantinci,
        urunler: sayimUrunler,
        toplamGelir: toplamGelir,
        paraDagilimi: {
          muhasebe: muhasebe,
          borclar: borclarToplam,
          nakit: nakit,
          toplam: dagilimToplam
        },
        aciklama: aciklama,
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        createdBy: currentUser?.email || null,
        uid: currentUserUid || null
      });
      
      // BorÃ§larÄ± kaydet (kiÅŸi bazlÄ±)
      sayimBorclarListesi.forEach(borc=>{
        if(borc.kisi && borc.miktar > 0){
          const borcRef = db.collection('kantin_borclar').doc();
          batch.set(borcRef, {
            kisi: borc.kisi.trim(),
            miktar: toNum(borc.miktar),
            sayimId: sayimId,
            sayimTarih: tarih,
            durum: 'beklemede', // beklemede, odenmis, iptal
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            createdBy: currentUser?.email || null,
            uid: currentUserUid || null
          });
        }
      });
      
      // TÃ¼m deÄŸiÅŸiklikleri commit et
      await batch.commit();
      
      // ÃœrÃ¼n listesini yenile (stoklar gÃ¼ncellendi)
      await loadUrunler();
      
      // Formu temizle
      sayimBorclarListesi = [];
      document.getElementById('sayim-muhasebe').value = '';
      document.getElementById('sayim-nakit').value = '';
      document.getElementById('sayim-aciklama').value = '';
      
      toast('âœ… SayÄ±m kaydedildi ve stoklar gÃ¼ncellendi!');
      closeModal(document.getElementById('sayimEkleModal'));
      await loadSayimlar();
    }catch(e){
      console.error(e);
      toast('SayÄ±m kaydedilemedi');
    }
  });
})();

// SayÄ±m gÃ¼ncelle
(function(){
  const btn = document.getElementById('sayimGuncelleBtn');
  if(!btn) return;
  
  btn.addEventListener('click', async ()=>{
    const sayimId = document.getElementById('sayimDuzenleId').value;
    if(!sayimId){
      toast('âŒ SayÄ±m ID bulunamadÄ±');
      return;
    }
    
    const tarih = document.getElementById('sayim-tarih').value;
    const personel = document.getElementById('sayim-personel').value;
    const kantinci = (document.getElementById('sayim-kantinci').value || '').trim();
    
    if(!tarih || !personel || !kantinci){
      toast('âš ï¸ Tarih, personel ve kantinci seÃ§imi zorunludur');
      return;
    }
    
    try{
      btn.disabled = true;
      btn.textContent = 'â³ GÃ¼ncelleniyor...';
      toast('ğŸ”„ SayÄ±m gÃ¼ncelleniyor...');
      
      // Eski sayÄ±m verilerini al
      const eskiSayimDoc = await db.collection('kantin_sayimlar').doc(sayimId).get();
      if(!eskiSayimDoc.exists){
        toast('âŒ SayÄ±m kaydÄ± bulunamadÄ±');
        btn.disabled = false;
        btn.textContent = 'GÃ¼ncelle';
        return;
      }
      
      const eskiData = eskiSayimDoc.data();
      const eskiUrunler = eskiData.urunler || [];
      
      // Para daÄŸÄ±lÄ±mÄ± kontrolÃ¼
      const muhasebe = toNum(document.getElementById('sayim-muhasebe')?.value || 0);
      const borclarToplam = toNum(document.getElementById('sayim-borclar-toplam')?.value || 0);
      const nakit = toNum(document.getElementById('sayim-nakit')?.value || 0);
      const aciklama = (document.getElementById('sayim-aciklama')?.value || '').trim();
      
      // TÃ¼m Ã¼rÃ¼n verilerini topla
      const sayimUrunler = [];
      let toplamGelir = 0;
      const batch = db.batch();
      
      // Eski stoklarÄ± geri al
      for(const eskiUrun of eskiUrunler){
        const urunRef = db.collection('kantin_urunler').doc(eskiUrun.urunId);
        const urunDoc = await urunRef.get();
        if(urunDoc.exists){
          const urunData = urunDoc.data();
          const mevcutStok = parseFloat(urunData.stok || 0);
          const satilanAdet = parseFloat(eskiUrun.satilanAdet || 0);
          // Eski stoku geri al
          const eskiStok = mevcutStok + satilanAdet;
          batch.update(urunRef, {
            stok: eskiStok,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        }
      }
      
      // Yeni sayÄ±m verilerini uygula
      document.querySelectorAll('.sayim-kalan-adet').forEach(input=>{
        const urunId = input.dataset.urunId;
        const mevcut = parseInt(input.dataset.mevcut) || 0;
        const kalan = parseInt(input.value) || 0;
        const satilan = Math.max(0, mevcut - kalan);
        const fiyat = toNum(input.dataset.fiyat || 0);
        const gelisFiyat = toNum(input.dataset.gelisFiyat || 0);
        
        // Stok gÃ¼ncelle (kalan adet = yeni stok)
        const urunRef = db.collection('kantin_urunler').doc(urunId);
        batch.update(urunRef, {
          stok: kalan,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        const gelir = satilan * fiyat;
        const maliyet = satilan * gelisFiyat;
        
        sayimUrunler.push({
          urunId: urunId,
          urunAd: allUrunler.find(u=>u.id === urunId)?.ad || '',
          mevcutAdet: mevcut,
          kalanAdet: kalan,
          satilanAdet: satilan,
          birimFiyat: fiyat,
          birimMaliyet: gelisFiyat,
          toplamGelir: gelir,
          toplamMaliyet: maliyet
        });
        
        toplamGelir += gelir;
      });
      
      // Para daÄŸÄ±lÄ±mÄ± kontrolÃ¼
      const dagilimToplam = muhasebe + borclarToplam + nakit;
      const fark = Math.abs(toplamGelir - dagilimToplam);
      if(fark > 0.01){
        if(!confirm('Para daÄŸÄ±lÄ±mÄ± toplam gelire eÅŸit deÄŸil! Fark: ' + fark.toLocaleString('tr-TR',{minimumFractionDigits:2,maximumFractionDigits:2}) + 'â‚º\n\nYine de gÃ¼ncellemek istiyor musunuz?')){
          btn.disabled = false;
          btn.textContent = 'GÃ¼ncelle';
          return;
        }
      }
      
      // SayÄ±m kaydÄ±nÄ± gÃ¼ncelle
      const sayimRef = db.collection('kantin_sayimlar').doc(sayimId);
      batch.update(sayimRef, {
        tarih: tarih,
        personel: personel,
        kantinci: kantinci,
        urunler: sayimUrunler,
        toplamGelir: toplamGelir,
        paraDagilimi: {
          muhasebe: muhasebe,
          borclar: borclarToplam,
          nakit: nakit,
          toplam: dagilimToplam
        },
        aciklama: aciklama,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedBy: currentUser?.email || null
      });
      
      // Eski borÃ§larÄ± sil
      const eskiBorclarSnap = await db.collection('kantin_borclar')
        .where('sayimId', '==', sayimId)
        .get();
      eskiBorclarSnap.forEach(borcDoc=>{
        batch.delete(borcDoc.ref);
      });
      
      // Yeni borÃ§larÄ± ekle
      sayimBorclarListesi.forEach(borc=>{
        if(borc.kisi && borc.miktar > 0){
          const borcRef = db.collection('kantin_borclar').doc();
          batch.set(borcRef, {
            kisi: borc.kisi.trim(),
            miktar: toNum(borc.miktar),
            sayimId: sayimId,
            sayimTarih: tarih,
            durum: 'beklemede',
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            createdBy: currentUser?.email || null,
            uid: currentUserUid || null
          });
        }
      });
      
      toast('ğŸ’¾ DeÄŸiÅŸiklikler kaydediliyor...');
      await batch.commit();
      
      toast('âœ… SayÄ±m gÃ¼ncellendi ve stoklar dÃ¼zenlendi!');
      closeModal(document.getElementById('sayimEkleModal'));
      
      await loadSayimlar();
      await loadUrunler();
      await loadBorclar();
      
      btn.disabled = false;
      btn.textContent = 'GÃ¼ncelle';
    }catch(e){
      console.error(e);
      toast('âŒ SayÄ±m gÃ¼ncellenemedi: ' + (e.message || 'Bilinmeyen hata'));
      btn.disabled = false;
      btn.textContent = 'GÃ¼ncelle';
    }
  });
})();

// SayÄ±mlarÄ± yÃ¼kle
async function loadSayimlar(){
  const liste = document.getElementById('sayimListe');
  try{
    let snap;
    try{
      snap = await db.collection('kantin_sayimlar')
        .orderBy('tarih','desc')
        .orderBy('createdAt','desc')
        .limit(50)
        .get();
    }catch(e){
      // Index yoksa fallback
      snap = await db.collection('kantin_sayimlar')
        .limit(50)
        .get();
      const docs = snap.docs.map(d=>({id:d.id, ...d.data()}));
      docs.sort((a,b)=>{
        const tarihA = a.tarih || '';
        const tarihB = b.tarih || '';
        if(tarihA !== tarihB) return tarihB.localeCompare(tarihA);
        const timeA = a.createdAt?.toDate ? a.createdAt.toDate().getTime() : 0;
        const timeB = b.createdAt?.toDate ? b.createdAt.toDate().getTime() : 0;
        return timeB - timeA;
      });
      snap = {docs: docs.map(d=>({id: d.id, data: ()=>d})), empty: docs.length === 0};
    }
    
    if(snap.empty || !snap.docs || snap.docs.length === 0){
      liste.innerHTML = '<div class="muted">HenÃ¼z sayÄ±m kaydÄ± yok</div>';
      return;
    }
    
    liste.innerHTML = snap.docs.map(doc=>{
      const d = doc.data ? doc.data() : (typeof doc === 'function' ? doc() : doc);
      const tarih = d.tarih || '-';
      const personel = d.personel || '-';
      const kantinci = d.kantinci || '-';
      const toplamGelir = toNum(d.toplamGelir || 0);
      const paraDagilimi = d.paraDagilimi || {};
      const muhasebe = toNum(paraDagilimi.muhasebe || 0);
      const borclar = toNum(paraDagilimi.borclar || 0);
      const nakit = toNum(paraDagilimi.nakit || 0);
      
      const docId = doc.id;
      const gelirStr = toplamGelir.toLocaleString('tr-TR',{minimumFractionDigits:2,maximumFractionDigits:2});
      
      const paraDagilimHtml = paraDagilimi.muhasebe !== undefined ? 
        '<div style="font-size:12px; color:var(--muted); margin-top:6px">' +
        'ğŸ’° Muhasebe: â‚º ' + muhasebe.toLocaleString('tr-TR',{minimumFractionDigits:2,maximumFractionDigits:2}) + 
        ' | BorÃ§lar: â‚º ' + borclar.toLocaleString('tr-TR',{minimumFractionDigits:2,maximumFractionDigits:2}) +
        ' | Nakit: â‚º ' + nakit.toLocaleString('tr-TR',{minimumFractionDigits:2,maximumFractionDigits:2}) +
        '</div>' : '';
      
      return '<div class="siparis-item">' +
        '<div class="info">' +
        '<div class="tarih">' + tarih + '</div>' +
        '<div class="urunler">' +
        '<strong>Personel:</strong> ' + personel + ' â€¢ ' +
        '<strong>Kantinci:</strong> ' + kantinci +
        paraDagilimHtml +
        '</div>' +
        '</div>' +
        '<div style="display:flex; align-items:center; gap:12px">' +
        '<span class="tutar">Gelir: â‚º ' + gelirStr + '</span>' +
        '<div style="display:flex; gap:4px">' +
        '<button class="btn-ghost" data-sayim-id="' + docId + '" data-action="sayim-duzenle" title="DÃ¼zenle">âœï¸</button>' +
        '<button class="btn-ghost" data-sayim-id="' + docId + '" data-action="sayim-sil" title="Sil">ğŸ—‘ï¸</button>' +
        '<button class="btn-ghost" data-sayim-id="' + docId + '" data-action="yazdir-sayim" title="YazdÄ±r">ğŸ–¨</button>' +
        '</div>' +
        '</div>' +
        '</div>';
    }).join('');

    // Event delegation for sayÄ±m actions
    if(!liste.dataset.listenerAdded){
      liste.addEventListener('click', async (e)=>{
        const btn = e.target.closest('[data-action]');
        if(!btn || !btn.dataset.sayimId) return;
        
        const action = btn.dataset.action;
        const sayimId = btn.dataset.sayimId;
        
        if(action === 'yazdir-sayim'){
          window.open('kantinyazdir.html?id=' + sayimId, '_blank');
        } else if(action === 'sayim-sil'){
          if(!confirm('Bu sayÄ±m kaydÄ±nÄ± silmek istediÄŸinizden emin misiniz?\n\nâš ï¸ Bu iÅŸlem geri alÄ±namaz ve stoklar geri alÄ±nacaktÄ±r.')){
            return;
          }
          
          try{
            toast('ğŸ”„ SayÄ±m kaydÄ± siliniyor...');
            
            // SayÄ±m verilerini al
            const sayimDoc = await db.collection('kantin_sayimlar').doc(sayimId).get();
            if(!sayimDoc.exists){
              toast('âŒ SayÄ±m kaydÄ± bulunamadÄ±');
              return;
            }
            
            const sayimData = sayimDoc.data();
            const urunler = sayimData.urunler || [];
            
            // StoklarÄ± geri al (kalan adetleri mevcut adetlere Ã§evir)
            const batch = db.batch();
            for(const urun of urunler){
              const urunRef = db.collection('kantin_urunler').doc(urun.urunId);
              const urunDoc = await urunRef.get();
              if(urunDoc.exists){
                const urunData = urunDoc.data();
                const mevcutStok = parseFloat(urunData.stok || 0);
                const satilanAdet = parseFloat(urun.satilanAdet || 0);
                // Kalan adet + satÄ±lan adet = eski mevcut adet
                const eskiStok = mevcutStok + satilanAdet;
                
                batch.update(urunRef, {
                  stok: eskiStok,
                  updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
              }
            }
            
            // SayÄ±m kaydÄ±nÄ± sil
            batch.delete(db.collection('kantin_sayimlar').doc(sayimId));
            
            // Ä°lgili borÃ§larÄ± da sil (eÄŸer varsa)
            const borclarSnap = await db.collection('kantin_borclar')
              .where('sayimId', '==', sayimId)
              .get();
            borclarSnap.forEach(borcDoc=>{
              batch.delete(borcDoc.ref);
            });
            
            await batch.commit();
            
            toast('âœ… SayÄ±m kaydÄ± silindi ve stoklar geri alÄ±ndÄ±!');
            await loadSayimlar();
            await loadUrunler();
            await loadBorclar();
          }catch(e){
            console.error(e);
            toast('âŒ SayÄ±m silinemedi: ' + (e.message || 'Bilinmeyen hata'));
          }
        } else if(action === 'sayim-duzenle'){
          await openSayimDuzenleModal(sayimId);
        }
      });
      liste.dataset.listenerAdded = 'true';
    }

  }catch(e){
    console.error(e);
    liste.innerHTML = '<div class="muted">SayÄ±mlar yÃ¼klenemedi</div>';
  }
}

// SayÄ±m yazdÄ±r - KALDIRILDI (sorun yaratÄ±yordu)

/* ===== AlÄ±mlar ===== */
async function loadAlinimlar(){
  if(!currentUserUid) return;
  const liste = document.getElementById('alinimlarListe');
  try{
    // Firestore composite index hatasÄ± olmamasÄ± iÃ§in sadece tarih ile sÄ±rala
    const snap = await db.collection('kantin_alinimlar')
      .orderBy('tarih','desc')
      .limit(100)
      .get();
    
    if(snap.empty){
      liste.innerHTML = '<div class="muted">HenÃ¼z alÄ±m kaydÄ± yok</div>';
      return;
    }
    
    // Client-side'da tarih ve createdAt'e gÃ¶re sÄ±rala
    const docs = snap.docs.sort((a,b)=>{
      const aData = a.data();
      const bData = b.data();
      const aTarih = aData.tarih || '';
      const bTarih = bData.tarih || '';
      if(aTarih !== bTarih){
        return bTarih.localeCompare(aTarih);
      }
      const aCreated = aData.createdAt?.toDate ? aData.createdAt.toDate().getTime() : 0;
      const bCreated = bData.createdAt?.toDate ? bData.createdAt.toDate().getTime() : 0;
      return bCreated - aCreated;
    });
    
    let toplamYatirim = 0;
    
    liste.innerHTML = docs.map(doc=>{
      const d = doc.data() || {};
      const tarih = d.tarih || '-';
      const toplamTutar = toNum(d.toplamTutar || 0);
      toplamYatirim += toplamTutar;
      const urunler = d.urunler || [];
      const urunListesi = urunler.map(u=>{
        const yeni = u.yeniUrun ? ' <span style="color:var(--success); font-size:11px">(Yeni)</span>' : '';
        return u.urunAd + ' (' + u.miktar + ' adet)' + yeni;
      }).join(', ');
      const docId = doc.id;
      
      return '<div class="siparis-item">' +
        '<div class="info">' +
        '<div class="tarih">' + tarih + '</div>' +
        '<div class="urunler">' + urunListesi + '</div>' +
        (d.aciklama ? '<div style="font-size:12px; color:var(--muted); margin-top:4px">' + d.aciklama + '</div>' : '') +
        '</div>' +
        '<div style="display:flex; align-items:center; gap:12px">' +
        '<span class="tutar">â‚º ' + toplamTutar.toLocaleString('tr-TR',{minimumFractionDigits:2,maximumFractionDigits:2}) + '</span>' +
        '<div style="display:flex; gap:4px">' +
        '<button class="btn-ghost" data-alim-id="' + docId + '" data-action="alim-duzenle" title="DÃ¼zenle">âœï¸</button>' +
        '<button class="btn-ghost" data-alim-id="' + docId + '" data-action="alim-sil" title="Sil">ğŸ—‘ï¸</button>' +
        '<button class="btn-ghost" data-alim-id="' + docId + '" data-action="alim-yazdir" title="YazdÄ±r">ğŸ–¨</button>' +
        '</div>' +
        '</div>' +
        '</div>';
    }).join('') +
    '<div style="margin-top:16px; padding:12px; background:var(--surface2); border-radius:8px">' +
    '<div style="font-size:14px; color:var(--muted); margin-bottom:4px">Toplam YatÄ±rÄ±m</div>' +
    '<div style="font-size:24px; font-weight:900; color:var(--primary)">â‚º ' + toplamYatirim.toLocaleString('tr-TR',{minimumFractionDigits:2,maximumFractionDigits:2}) + '</div>' +
    '</div>';
    
    // Event delegation for alÄ±m actions
    if(!liste.dataset.listenerAdded){
      liste.addEventListener('click', async (e)=>{
        const btn = e.target.closest('[data-action]');
        if(!btn || !btn.dataset.alimId) return;
        
        const action = btn.dataset.action;
        const alimId = btn.dataset.alimId;
        
        if(action === 'alim-sil'){
          if(!confirm('Bu alÄ±m kaydÄ±nÄ± silmek istediÄŸinizden emin misiniz? Bu iÅŸlem geri alÄ±namaz.')) return;
          try{
            // AlÄ±m kaydÄ±nÄ± getir
            const alimDoc = await db.collection('kantin_alinimlar').doc(alimId).get();
            if(!alimDoc.exists){
              toast('AlÄ±m kaydÄ± bulunamadÄ±');
              return;
            }
            const alimData = alimDoc.data();
            const urunler = alimData.urunler || [];
            
            // StoklarÄ± geri al
            const batch = db.batch();
            for(const urun of urunler){
              const urunRef = db.collection('kantin_urunler').doc(urun.urunId);
              const urunDoc = await urunRef.get();
              if(urunDoc.exists){
                const urunData = urunDoc.data();
                const mevcutStok = toNum(urunData.stok || 0);
                const yeniStok = Math.max(0, mevcutStok - urun.miktar);
                batch.update(urunRef, {
                  stok: yeniStok,
                  updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
              }
            }
            
            // AlÄ±m kaydÄ±nÄ± sil
            batch.delete(db.collection('kantin_alinimlar').doc(alimId));
            await batch.commit();
            
            toast('âœ… AlÄ±m kaydÄ± silindi ve stoklar gÃ¼ncellendi');
            await loadAlinimlar();
            await loadUrunler();
          }catch(e){
            console.error(e);
            toast('AlÄ±m silinemedi');
          }
        } else if(action === 'alim-yazdir'){
          window.open('kantinalimyazdir.html?id=' + alimId, '_blank');
        } else if(action === 'alim-duzenle'){
          await openAlimDuzenleModal(alimId);
        }
      });
      liste.dataset.listenerAdded = 'true';
    }
    
  }catch(e){
    console.error(e);
    liste.innerHTML = '<div class="muted">AlÄ±mlar yÃ¼klenemedi</div>';
  }
}

// AlÄ±m raporlarÄ±
(function(){
  const btnHaftalik = document.getElementById('btnAlimHaftalik');
  const btnAylik = document.getElementById('btnAlimAylik');
  
  async function generateHaftalikRapor(){
    try{
      const today = new Date();
      const haftaBaslangic = new Date(today);
      haftaBaslangic.setDate(today.getDate() - today.getDay()); // Pazar gÃ¼nÃ¼
      haftaBaslangic.setHours(0,0,0,0);
      
      const haftaBitis = new Date(haftaBaslangic);
      haftaBitis.setDate(haftaBaslangic.getDate() + 6);
      haftaBitis.setHours(23,59,59,999);
      
      const baslangicStr = haftaBaslangic.toISOString().slice(0,10);
      const bitisStr = haftaBitis.toISOString().slice(0,10);
      
      const snap = await db.collection('kantin_alinimlar')
        .where('tarih','>=',baslangicStr)
        .where('tarih','<=',bitisStr)
        .get();
      
      let toplamTutar = 0;
      let toplamUrunSayisi = 0;
      const urunDetaylari = {};
      
      snap.forEach(doc=>{
        const d = doc.data() || {};
        toplamTutar += toNum(d.toplamTutar || 0);
        const urunler = d.urunler || [];
        toplamUrunSayisi += urunler.length;
        
        urunler.forEach(u=>{
          if(!urunDetaylari[u.urunAd]){
            urunDetaylari[u.urunAd] = {
              toplamMiktar: 0,
              toplamAlis: 0
            };
          }
          urunDetaylari[u.urunAd].toplamMiktar += u.miktar || 0;
          urunDetaylari[u.urunAd].toplamAlis += u.toplamAlisFiyat || 0;
        });
      });
      
      const raporHtml = '<div style="padding:16px; background:var(--surface2); border-radius:8px; margin-bottom:16px">' +
        '<h3 style="margin:0 0 12px 0">ğŸ“Š HaftalÄ±k AlÄ±m Raporu</h3>' +
        '<div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:12px; margin-bottom:16px">' +
        '<div><strong>BaÅŸlangÄ±Ã§:</strong> ' + baslangicStr + '</div>' +
        '<div><strong>BitiÅŸ:</strong> ' + bitisStr + '</div>' +
        '<div><strong>Toplam AlÄ±m:</strong> ' + snap.size + ' kayÄ±t</div>' +
        '<div><strong>Toplam Tutar:</strong> â‚º ' + toplamTutar.toLocaleString('tr-TR',{minimumFractionDigits:2,maximumFractionDigits:2}) + '</div>' +
        '</div>' +
        '<div style="margin-top:16px"><strong>ÃœrÃ¼n DetaylarÄ±:</strong></div>' +
        '<table style="width:100%; margin-top:8px; border-collapse:collapse">' +
        '<thead><tr style="background:var(--surface); border-bottom:1px solid var(--border)">' +
        '<th style="padding:8px; text-align:left">ÃœrÃ¼n</th>' +
        '<th style="padding:8px; text-align:right">Toplam Miktar</th>' +
        '<th style="padding:8px; text-align:right">Toplam AlÄ±ÅŸ</th>' +
        '</tr></thead>' +
        '<tbody>' +
        Object.entries(urunDetaylari).map(([ad, detay])=>
          '<tr style="border-bottom:1px solid var(--border)">' +
          '<td style="padding:8px">' + ad + '</td>' +
          '<td style="padding:8px; text-align:right">' + detay.toplamMiktar + ' adet</td>' +
          '<td style="padding:8px; text-align:right">â‚º ' + detay.toplamAlis.toLocaleString('tr-TR',{minimumFractionDigits:2,maximumFractionDigits:2}) + '</td>' +
          '</tr>'
        ).join('') +
        '</tbody></table>' +
        '</div>';
      
      const liste = document.getElementById('alinimlarListe');
      liste.innerHTML = raporHtml + liste.innerHTML;
    }catch(e){
      console.error(e);
      toast('HaftalÄ±k rapor oluÅŸturulamadÄ±');
    }
  }
  
  async function generateAylikRapor(){
    try{
      const today = new Date();
      const ayBaslangic = new Date(today.getFullYear(), today.getMonth(), 1);
      const ayBitis = new Date(today.getFullYear(), today.getMonth() + 1, 0);
      
      const baslangicStr = ayBaslangic.toISOString().slice(0,10);
      const bitisStr = ayBitis.toISOString().slice(0,10);
      
      const snap = await db.collection('kantin_alinimlar')
        .where('tarih','>=',baslangicStr)
        .where('tarih','<=',bitisStr)
        .get();
      
      let toplamTutar = 0;
      let toplamUrunSayisi = 0;
      const urunDetaylari = {};
      const gunlukToplamlar = {};
      
      snap.forEach(doc=>{
        const d = doc.data() || {};
        const tarih = d.tarih || '';
        toplamTutar += toNum(d.toplamTutar || 0);
        const urunler = d.urunler || [];
        toplamUrunSayisi += urunler.length;
        
        if(!gunlukToplamlar[tarih]){
          gunlukToplamlar[tarih] = 0;
        }
        gunlukToplamlar[tarih] += toNum(d.toplamTutar || 0);
        
        urunler.forEach(u=>{
          if(!urunDetaylari[u.urunAd]){
            urunDetaylari[u.urunAd] = {
              toplamMiktar: 0,
              toplamAlis: 0
            };
          }
          urunDetaylari[u.urunAd].toplamMiktar += u.miktar || 0;
          urunDetaylari[u.urunAd].toplamAlis += u.toplamAlisFiyat || 0;
        });
      });
      
      const ayAdi = ayBaslangic.toLocaleDateString('tr-TR',{month:'long', year:'numeric'});
      
      const raporHtml = '<div style="padding:16px; background:var(--surface2); border-radius:8px; margin-bottom:16px">' +
        '<h3 style="margin:0 0 12px 0">ğŸ“ˆ AylÄ±k AlÄ±m Raporu - ' + ayAdi + '</h3>' +
        '<div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:12px; margin-bottom:16px">' +
        '<div><strong>BaÅŸlangÄ±Ã§:</strong> ' + baslangicStr + '</div>' +
        '<div><strong>BitiÅŸ:</strong> ' + bitisStr + '</div>' +
        '<div><strong>Toplam AlÄ±m:</strong> ' + snap.size + ' kayÄ±t</div>' +
        '<div><strong>Toplam Tutar:</strong> â‚º ' + toplamTutar.toLocaleString('tr-TR',{minimumFractionDigits:2,maximumFractionDigits:2}) + '</div>' +
        '</div>' +
        '<div style="margin-top:16px"><strong>GÃ¼nlÃ¼k Toplamlar:</strong></div>' +
        '<table style="width:100%; margin-top:8px; border-collapse:collapse; margin-bottom:16px">' +
        '<thead><tr style="background:var(--surface); border-bottom:1px solid var(--border)">' +
        '<th style="padding:8px; text-align:left">Tarih</th>' +
        '<th style="padding:8px; text-align:right">Toplam</th>' +
        '</tr></thead>' +
        '<tbody>' +
        Object.entries(gunlukToplamlar).sort((a,b)=>b[0].localeCompare(a[0])).map(([tarih, toplam])=>
          '<tr style="border-bottom:1px solid var(--border)">' +
          '<td style="padding:8px">' + tarih + '</td>' +
          '<td style="padding:8px; text-align:right">â‚º ' + toplam.toLocaleString('tr-TR',{minimumFractionDigits:2,maximumFractionDigits:2}) + '</td>' +
          '</tr>'
        ).join('') +
        '</tbody></table>' +
        '<div style="margin-top:16px"><strong>ÃœrÃ¼n DetaylarÄ±:</strong></div>' +
        '<table style="width:100%; margin-top:8px; border-collapse:collapse">' +
        '<thead><tr style="background:var(--surface); border-bottom:1px solid var(--border)">' +
        '<th style="padding:8px; text-align:left">ÃœrÃ¼n</th>' +
        '<th style="padding:8px; text-align:right">Toplam Miktar</th>' +
        '<th style="padding:8px; text-align:right">Toplam AlÄ±ÅŸ</th>' +
        '</tr></thead>' +
        '<tbody>' +
        Object.entries(urunDetaylari).map(([ad, detay])=>
          '<tr style="border-bottom:1px solid var(--border)">' +
          '<td style="padding:8px">' + ad + '</td>' +
          '<td style="padding:8px; text-align:right">' + detay.toplamMiktar + ' adet</td>' +
          '<td style="padding:8px; text-align:right">â‚º ' + detay.toplamAlis.toLocaleString('tr-TR',{minimumFractionDigits:2,maximumFractionDigits:2}) + '</td>' +
          '</tr>'
        ).join('') +
        '</tbody></table>' +
        '</div>';
      
      const liste = document.getElementById('alinimlarListe');
      liste.innerHTML = raporHtml + liste.innerHTML;
    }catch(e){
      console.error(e);
      toast('AylÄ±k rapor oluÅŸturulamadÄ±');
    }
  }
  
  if(btnHaftalik){
    btnHaftalik.addEventListener('click', generateHaftalikRapor);
  }
  if(btnAylik){
    btnAylik.addEventListener('click', generateAylikRapor);
  }
})();

/* ===== AlÄ±m DÃ¼zenleme ===== */
let alimDuzenleUrunler = [];

async function openAlimDuzenleModal(alimId){
  try{
    const alimDoc = await db.collection('kantin_alinimlar').doc(alimId).get();
    if(!alimDoc.exists){
      toast('AlÄ±m kaydÄ± bulunamadÄ±');
      return;
    }
    
    const data = alimDoc.data();
    document.getElementById('alimDuzenleId').value = alimId;
    document.getElementById('alimDuzenleTarih').value = data.tarih || '';
    document.getElementById('alimDuzenleAciklama').value = data.aciklama || '';
    
    // ÃœrÃ¼nleri yÃ¼kle
    alimDuzenleUrunler = (data.urunler || []).map(u=>({
      urunId: u.urunId || '',
      urunAd: u.urunAd || '',
      miktar: parseFloat(u.miktar) || 0,
      birimAlisFiyat: parseFloat(u.birimAlisFiyat) || 0,
      toplamAlisFiyat: parseFloat(u.toplamAlisFiyat) || 0,
      birimSatisFiyat: parseFloat(u.birimSatisFiyat) || 0,
      yeniUrun: u.yeniUrun || false
    }));
    
    renderAlimDuzenleUrunler();
    updateAlimDuzenleToplamTutar();
    openModal('alimDuzenleModal');
  }catch(e){
    console.error(e);
    toast('AlÄ±m bilgileri yÃ¼klenemedi');
  }
}

function renderAlimDuzenleUrunler(){
  const liste = document.getElementById('alimDuzenleUrunlerListe');
  if(!liste) return;
  
  if(alimDuzenleUrunler.length === 0){
    liste.innerHTML = '<div class="muted" style="text-align:center; padding:20px">HenÃ¼z Ã¼rÃ¼n yok</div>';
    return;
  }
  
  liste.innerHTML = alimDuzenleUrunler.map((item, index)=>{
    const urunAdEscaped = (item.urunAd || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
    const isReadonly = item.urunId ? 'readonly' : '';
    const readonlyStyle = item.urunId ? 'background:var(--surface)' : '';
    return '<div class="toplu-urun-item" data-index="' + index + '" style="margin-bottom:12px">' +
      '<div class="item-header">' +
      '<div class="item-title">ÃœrÃ¼n #' + (index + 1) + '</div>' +
      '<button class="item-remove" data-remove-index="' + index + '" title="KaldÄ±r">âœ–</button>' +
      '</div>' +
      '<div class="field">' +
      '<label>ÃœrÃ¼n AdÄ±</label>' +
      '<input type="text" class="alim-duzenle-urun-ad" data-index="' + index + '" value="' + urunAdEscaped + '" ' + isReadonly + ' style="' + readonlyStyle + '" placeholder="ÃœrÃ¼n adÄ± girin" />' +
      '</div>' +
      '<div class="row">' +
      '<div class="col-4 field">' +
      '<label>Miktar (Adet)</label>' +
      '<input type="number" class="alim-duzenle-miktar" data-index="' + index + '" min="1" value="' + (item.miktar || 0) + '" />' +
      '</div>' +
      '<div class="col-4 field">' +
      '<label>Toplam AlÄ±ÅŸ FiyatÄ± (â‚º)</label>' +
      '<input type="text" class="alim-duzenle-toplam-alis" data-index="' + index + '" value="' + (item.toplamAlisFiyat || 0).toFixed(2).replace('.', ',') + '" placeholder="0,00" />' +
      '</div>' +
      '<div class="col-4 field">' +
      '<label>Birim SatÄ±ÅŸ FiyatÄ± (â‚º)</label>' +
      '<input type="text" class="alim-duzenle-birim-satis" data-index="' + index + '" value="' + (item.birimSatisFiyat || 0).toFixed(2).replace('.', ',') + '" placeholder="0,00" />' +
      '</div>' +
      '</div>' +
      '</div>';
  }).join('');
  
  // Event listener'larÄ± ekle
  liste.querySelectorAll('.alim-duzenle-miktar, .alim-duzenle-toplam-alis, .alim-duzenle-birim-satis').forEach(input=>{
    input.addEventListener('input', ()=>{
      const index = parseInt(input.dataset.index);
      updateAlimDuzenleUrun(index);
      updateAlimDuzenleToplamTutar();
    });
  });
  
  // ÃœrÃ¼n adÄ± input'larÄ± iÃ§in event listener
  liste.querySelectorAll('.alim-duzenle-urun-ad').forEach(input=>{
    input.addEventListener('input', (e)=>{
      const index = parseInt(e.target.dataset.index);
      const item = alimDuzenleUrunler[index];
      if(item){
        item.urunAd = e.target.value.trim();
      }
    });
  });
  
  // Event delegation for remove buttons
  if(!liste.dataset.listenerAdded){
    liste.addEventListener('click', (e)=>{
      const removeBtn = e.target.closest('.item-remove');
      if(removeBtn && removeBtn.dataset.removeIndex){
        const index = parseInt(removeBtn.dataset.removeIndex);
        alimDuzenleUrunler.splice(index, 1);
        renderAlimDuzenleUrunler();
        updateAlimDuzenleToplamTutar();
      }
    });
    liste.dataset.listenerAdded = 'true';
  }
  
  // ÃœrÃ¼n ekle butonu event listener
  const urunEkleBtn = document.getElementById('alimDuzenleUrunEkleBtn');
  if(urunEkleBtn && !urunEkleBtn.dataset.listenerAdded){
    urunEkleBtn.addEventListener('click', ()=>{
      // Mevcut Ã¼rÃ¼nlerden birini kopyala veya boÅŸ Ã¼rÃ¼n ekle
      const yeniIndex = alimDuzenleUrunler.length;
      alimDuzenleUrunler.push({
        urunId: '',
        urunAd: '',
        miktar: 1,
        birimAlisFiyat: 0,
        toplamAlisFiyat: 0,
        birimSatisFiyat: 0,
        yeniUrun: false
      });
      renderAlimDuzenleUrunler();
      updateAlimDuzenleToplamTutar();
    });
    urunEkleBtn.dataset.listenerAdded = 'true';
  }
}

function updateAlimDuzenleUrun(index){
  const item = alimDuzenleUrunler[index];
  if(!item) return;
  
  const miktarInput = document.querySelector(`.alim-duzenle-miktar[data-index="${index}"]`);
  const toplamAlisInput = document.querySelector(`.alim-duzenle-toplam-alis[data-index="${index}"]`);
  const birimSatisInput = document.querySelector(`.alim-duzenle-birim-satis[data-index="${index}"]`);
  
  // VirgÃ¼lÃ¼ noktaya Ã§evir ama input'ta deÄŸiÅŸtirme (kullanÄ±cÄ± virgÃ¼l gÃ¶rmeli)
  const miktar = miktarInput ? parseInt(miktarInput.value.toString().replace(/[^\d]/g, '')) || 0 : 0;
  const toplamAlisValue = toplamAlisInput ? toplamAlisInput.value.toString().replace(/[^\d.,]/g, '').replace(',', '.') : '0';
  const birimSatisValue = birimSatisInput ? birimSatisInput.value.toString().replace(/[^\d.,]/g, '').replace(',', '.') : '0';
  
  const toplamAlis = parseFloat(toplamAlisValue) || 0;
  const birimSatis = parseFloat(birimSatisValue) || 0;
  
  item.miktar = miktar;
  item.toplamAlisFiyat = toplamAlis;
  item.birimSatisFiyat = birimSatis;
  item.birimAlisFiyat = miktar > 0 ? toplamAlis / miktar : 0;
}

function updateAlimDuzenleToplamTutar(){
  const toplam = alimDuzenleUrunler.reduce((sum, item)=>sum + (item.toplamAlisFiyat || 0), 0);
  const toplamEl = document.getElementById('alimDuzenleToplamTutar');
  if(toplamEl){
    toplamEl.textContent = 'â‚º ' + toplam.toLocaleString('tr-TR',{minimumFractionDigits:2,maximumFractionDigits:2});
  }
}

// AlÄ±m dÃ¼zenleme - Yeni olarak kaydet
(function(){
  const btn = document.getElementById('alimDuzenleYeniKaydetBtn');
  if(!btn) return;
  
  btn.addEventListener('click', async ()=>{
    const tarih = document.getElementById('alimDuzenleTarih').value;
    
    if(!tarih){
      toast('Tarih seÃ§iniz');
      return;
    }
    if(alimDuzenleUrunler.length === 0){
      toast('En az bir Ã¼rÃ¼n eklemelisiniz');
      return;
    }
    
    // Ã–nce tÃ¼m Ã¼rÃ¼n deÄŸerlerini gÃ¼ncelle
    alimDuzenleUrunler.forEach((item, index)=>{
      updateAlimDuzenleUrun(index);
    });
    
    // Validasyon
    const gecersiz = alimDuzenleUrunler.find((item, index)=>{
      if(!item.urunAd){
        toast('ÃœrÃ¼n #' + (index + 1) + ': ÃœrÃ¼n adÄ± zorunludur');
        return true;
      }
      if(!item.miktar || item.miktar <= 0){
        toast('ÃœrÃ¼n #' + (index + 1) + ': Miktar 0\'dan bÃ¼yÃ¼k olmalÄ±dÄ±r');
        return true;
      }
      if(!item.toplamAlisFiyat || item.toplamAlisFiyat <= 0){
        toast('ÃœrÃ¼n #' + (index + 1) + ': Toplam alÄ±ÅŸ fiyatÄ± giriniz');
        return true;
      }
      if(!item.birimSatisFiyat || item.birimSatisFiyat <= 0){
        toast('ÃœrÃ¼n #' + (index + 1) + ': Birim satÄ±ÅŸ fiyatÄ± giriniz');
        return true;
      }
      return false;
    });
    
    if(gecersiz) return;
    
    try{
      btn.disabled = true;
      btn.textContent = 'â³ Kaydediliyor...';
      
      const batch = db.batch();
      const yeniUrunler = [];
      let toplamTutar = 0;
      
      for(const item of alimDuzenleUrunler){
        let urunId = item.urunId;
        let yeniUrunFlag = false;
        
        // ÃœrÃ¼n adÄ± kontrolÃ¼
        if(!item.urunAd || !item.urunAd.trim()){
          toast('ÃœrÃ¼n #' + (alimDuzenleUrunler.indexOf(item) + 1) + ': ÃœrÃ¼n adÄ± zorunludur');
          btn.disabled = false;
          btn.textContent = 'Yeni Olarak Kaydet';
          return;
        }
        
        if(!urunId || urunId.trim() === ''){
          // Yeni Ã¼rÃ¼n oluÅŸtur
          toast('ğŸ”„ ÃœrÃ¼n #' + (alimDuzenleUrunler.indexOf(item) + 1) + ' sisteme ekleniyor: ' + item.urunAd.trim());
          
          const urunRef = db.collection('kantin_urunler').doc();
          urunId = urunRef.id;
          yeniUrunFlag = true;
          
          batch.set(urunRef, {
            ad: item.urunAd.trim(),
            kategori: 'diger', // VarsayÄ±lan kategori
            gelisFiyat: item.toplamAlisFiyat,
            fiyat: item.birimSatisFiyat,
            stok: item.miktar,
            aktif: true,
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            createdBy: currentUser?.email || null,
            uid: currentUserUid || null
          });
        } else {
          // Mevcut Ã¼rÃ¼nÃ¼ gÃ¼ncelle
          toast('ğŸ”„ ÃœrÃ¼n #' + (alimDuzenleUrunler.indexOf(item) + 1) + ' stok gÃ¼ncelleniyor: ' + item.urunAd.trim());
          
          const urunRef = db.collection('kantin_urunler').doc(urunId);
          const urunDoc = await urunRef.get();
          
          if(urunDoc.exists){
            const urunData = urunDoc.data();
            const mevcutStok = parseFloat(urunData.stok || 0);
            const yeniStok = mevcutStok + item.miktar;
            
            batch.update(urunRef, {
              stok: yeniStok,
              gelisFiyat: item.toplamAlisFiyat,
              fiyat: item.birimSatisFiyat,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
          } else {
            // ÃœrÃ¼n ID var ama dokÃ¼man bulunamadÄ± - yeni Ã¼rÃ¼n oluÅŸtur
            toast('âš ï¸ ÃœrÃ¼n bulunamadÄ±, yeni Ã¼rÃ¼n olarak ekleniyor: ' + item.urunAd.trim());
            const urunRef = db.collection('kantin_urunler').doc();
            urunId = urunRef.id;
            yeniUrunFlag = true;
            
            batch.set(urunRef, {
              ad: item.urunAd.trim(),
              kategori: 'diger',
              gelisFiyat: item.toplamAlisFiyat,
              fiyat: item.birimSatisFiyat,
              stok: item.miktar,
              aktif: true,
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              createdBy: currentUser?.email || null,
              uid: currentUserUid || null
            });
          }
        }
        
        yeniUrunler.push({
          urunId: urunId,
          urunAd: item.urunAd.trim(),
          miktar: item.miktar,
          birimAlisFiyat: item.birimAlisFiyat,
          toplamAlisFiyat: item.toplamAlisFiyat,
          birimSatisFiyat: item.birimSatisFiyat,
          yeniUrun: yeniUrunFlag
        });
        
        toplamTutar += item.toplamAlisFiyat;
      }
      
      // Yeni alÄ±m kaydÄ± oluÅŸtur
      toast('ğŸ’¾ AlÄ±m kaydÄ± oluÅŸturuluyor...');
      const alimRef = db.collection('kantin_alinimlar').doc();
      batch.set(alimRef, {
        tarih: tarih,
        urunler: yeniUrunler,
        toplamTutar: toplamTutar,
        aciklama: document.getElementById('alimDuzenleAciklama').value.trim(),
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        createdBy: currentUser?.email || null,
        uid: currentUserUid || null
      });
      
      toast('ğŸ’¾ TÃ¼m deÄŸiÅŸiklikler kaydediliyor...');
      await batch.commit();
      
      toast('âœ… Yeni alÄ±m kaydÄ± oluÅŸturuldu!');
      toast('ğŸ”„ ÃœrÃ¼n listeleri gÃ¼ncelleniyor...');
      
      btn.disabled = false;
      btn.textContent = 'Yeni Olarak Kaydet';
      
      closeModal(document.getElementById('alimDuzenleModal'));
      
      // TÃ¼m listeleri gÃ¼ncelle
      await loadAlinimlar();
      await loadUrunler();
      await loadUrunYonetim();
      
      toast('âœ… TÃ¼m iÅŸlemler tamamlandÄ±!');
    }catch(e){
      console.error(e);
      btn.disabled = false;
      btn.textContent = 'Yeni Olarak Kaydet';
      toast('AlÄ±m kaydedilemedi: ' + (e.message || 'Bilinmeyen hata'));
    }
  });
})();

// AlÄ±m dÃ¼zenleme - GÃ¼ncelle
(function(){
  const btn = document.getElementById('alimDuzenleGuncelleBtn');
  if(!btn) return;
  
  btn.addEventListener('click', async ()=>{
    const alimId = document.getElementById('alimDuzenleId').value;
    const tarih = document.getElementById('alimDuzenleTarih').value;
    
    if(!alimId){
      toast('AlÄ±m ID bulunamadÄ±');
      return;
    }
    if(!tarih){
      toast('Tarih seÃ§iniz');
      return;
    }
    if(alimDuzenleUrunler.length === 0){
      toast('En az bir Ã¼rÃ¼n eklemelisiniz');
      return;
    }
    
    // Ã–nce tÃ¼m Ã¼rÃ¼n deÄŸerlerini gÃ¼ncelle
    alimDuzenleUrunler.forEach((item, index)=>{
      updateAlimDuzenleUrun(index);
    });
    
    // Validasyon
    const gecersiz = alimDuzenleUrunler.find((item, index)=>{
      if(!item.urunAd){
        toast('ÃœrÃ¼n #' + (index + 1) + ': ÃœrÃ¼n adÄ± zorunludur');
        return true;
      }
      if(!item.miktar || item.miktar <= 0){
        toast('ÃœrÃ¼n #' + (index + 1) + ': Miktar 0\'dan bÃ¼yÃ¼k olmalÄ±dÄ±r');
        return true;
      }
      if(!item.toplamAlisFiyat || item.toplamAlisFiyat <= 0){
        toast('ÃœrÃ¼n #' + (index + 1) + ': Toplam alÄ±ÅŸ fiyatÄ± giriniz');
        return true;
      }
      if(!item.birimSatisFiyat || item.birimSatisFiyat <= 0){
        toast('ÃœrÃ¼n #' + (index + 1) + ': Birim satÄ±ÅŸ fiyatÄ± giriniz');
        return true;
      }
      return false;
    });
    
    if(gecersiz) return;
    
    try{
      btn.disabled = true;
      btn.textContent = 'â³ Kaydediliyor...';
      
      // Eski alÄ±m verilerini al
      const eskiAlimDoc = await db.collection('kantin_alinimlar').doc(alimId).get();
      if(!eskiAlimDoc.exists){
        toast('AlÄ±m kaydÄ± bulunamadÄ±');
        btn.disabled = false;
        btn.textContent = 'GÃ¼ncelle';
        return;
      }
      const eskiData = eskiAlimDoc.data();
      const eskiUrunler = eskiData.urunler || [];
      
      const batch = db.batch();
      
      // Stok deÄŸiÅŸikliklerini hesapla (eski ve yeni Ã¼rÃ¼nleri karÅŸÄ±laÅŸtÄ±r)
      const stokDegisiklikleri = {}; // urunId -> stok deÄŸiÅŸimi
      const urunGuncellemeleri = {}; // urunId -> {gelisFiyat, fiyat}
      
      // Eski Ã¼rÃ¼nlerin stoklarÄ±nÄ± geri al (eksi)
      for(const eskiUrun of eskiUrunler){
        const urunId = eskiUrun.urunId;
        if(!stokDegisiklikleri[urunId]){
          stokDegisiklikleri[urunId] = 0;
        }
        stokDegisiklikleri[urunId] -= parseFloat(eskiUrun.miktar || 0);
      }
      
      // Yeni Ã¼rÃ¼nlerin stoklarÄ±nÄ± ekle (artÄ±)
      const yeniUrunler = [];
      let toplamTutar = 0;
      
      for(const item of alimDuzenleUrunler){
        const urunId = item.urunId;
        if(!stokDegisiklikleri[urunId]){
          stokDegisiklikleri[urunId] = 0;
        }
        stokDegisiklikleri[urunId] += parseFloat(item.miktar || 0);
        
        // Fiyat gÃ¼ncellemelerini kaydet
        urunGuncellemeleri[urunId] = {
          gelisFiyat: item.toplamAlisFiyat,
          fiyat: item.birimSatisFiyat
        };
        
        yeniUrunler.push({
          urunId: item.urunId,
          urunAd: item.urunAd,
          miktar: item.miktar,
          birimAlisFiyat: item.birimAlisFiyat,
          toplamAlisFiyat: item.toplamAlisFiyat,
          birimSatisFiyat: item.birimSatisFiyat,
          yeniUrun: item.yeniUrun
        });
        
        toplamTutar += item.toplamAlisFiyat;
      }
      
      // TÃ¼m Ã¼rÃ¼nleri tek seferde gÃ¼ncelle (her Ã¼rÃ¼n iÃ§in sadece bir update)
      for(const urunId in stokDegisiklikleri){
        const stokDegisimi = stokDegisiklikleri[urunId];
        if(stokDegisimi === 0) continue; // DeÄŸiÅŸiklik yoksa atla
        
        const urunRef = db.collection('kantin_urunler').doc(urunId);
        const urunDoc = await urunRef.get();
        
        if(urunDoc.exists){
          const urunData = urunDoc.data();
          const mevcutStok = parseFloat(urunData.stok || 0);
          const yeniStok = Math.max(0, mevcutStok + stokDegisimi); // stokDegisimi zaten + veya - olabilir
          
          const updateData = {
            stok: yeniStok,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          };
          
          // EÄŸer bu Ã¼rÃ¼n yeni listede varsa fiyatlarÄ± da gÃ¼ncelle
          if(urunGuncellemeleri[urunId]){
            updateData.gelisFiyat = urunGuncellemeleri[urunId].gelisFiyat;
            updateData.fiyat = urunGuncellemeleri[urunId].fiyat;
          }
          
          batch.update(urunRef, updateData);
        }
      }
        
      // AlÄ±m kaydÄ±nÄ± gÃ¼ncelle
      const alimRef = db.collection('kantin_alinimlar').doc(alimId);
      batch.update(alimRef, {
        tarih: tarih,
        urunler: yeniUrunler,
        toplamTutar: toplamTutar,
        aciklama: document.getElementById('alimDuzenleAciklama').value.trim(),
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedBy: currentUser?.email || null
      });
      
      await batch.commit();
      
      btn.disabled = false;
      btn.textContent = 'GÃ¼ncelle';
      toast('âœ… AlÄ±m kaydÄ± gÃ¼ncellendi ve stoklar dÃ¼zenlendi!');
      closeModal(document.getElementById('alimDuzenleModal'));
      // AlÄ±m dÃ¼zenleme yapÄ±nca tÃ¼m sekmeler gÃ¼ncellenmeli (alÄ±mlar ana kaynak)
      await loadAlinimlar();
      await loadUrunler();
      await loadUrunYonetim(); // Ayarlar sekmesi de gÃ¼ncellenmeli
    }catch(e){
      console.error(e);
      btn.disabled = false;
      btn.textContent = 'GÃ¼ncelle';
      toast('AlÄ±m gÃ¼ncellenemedi: ' + (e.message || 'Bilinmeyen hata'));
    }
  });
})();

/* ===== BorÃ§lar ===== */
async function loadBorclar(){
  if(!currentUserUid) return;
  const liste = document.getElementById('borclarListe');
  try{
    const snap = await db.collection('kantin_borclar')
      .where('durum','==','beklemede')
      .orderBy('createdAt','desc')
      .limit(100)
      .get();
    
    if(snap.empty){
      liste.innerHTML = '<div class="muted">HenÃ¼z borÃ§ kaydÄ± yok</div>';
      return;
    }
    
    // KiÅŸi bazlÄ± toplam borÃ§larÄ± hesapla
    const kisiBorclari = {};
    snap.forEach(doc=>{
      const d = doc.data() || {};
      const kisi = d.kisi || 'Ä°simsiz';
      if(!kisiBorclari[kisi]){
        kisiBorclari[kisi] = {
          kisi: kisi,
          toplam: 0,
          kayitlar: []
        };
      }
      const miktar = toNum(d.miktar || 0);
      kisiBorclari[kisi].toplam += miktar;
      kisiBorclari[kisi].kayitlar.push({
        id: doc.id,
        miktar: miktar,
        tarih: d.sayimTarih || d.createdAt?.toDate ? d.createdAt.toDate().toLocaleDateString('tr-TR') : '-'
      });
    });
    
    // Toplam borÃ§ hesapla
    let genelToplam = 0;
    Object.values(kisiBorclari).forEach(kb=>{
      genelToplam += kb.toplam;
    });
    
    liste.innerHTML = '<div style="margin-bottom:16px; padding:12px; background:var(--surface2); border-radius:8px">' +
      '<div style="font-size:14px; color:var(--muted); margin-bottom:4px">Toplam BorÃ§</div>' +
      '<div style="font-size:24px; font-weight:900; color:var(--danger)">â‚º ' + genelToplam.toLocaleString('tr-TR',{minimumFractionDigits:2,maximumFractionDigits:2}) + '</div>' +
      '</div>' +
      Object.values(kisiBorclari).map(kb=>{
        return '<div class="siparis-item">' +
          '<div class="info">' +
          '<div class="tarih">' + kb.kisi + '</div>' +
          '<div class="urunler">' +
          kb.kayitlar.map(k=>'â‚º ' + k.miktar.toLocaleString('tr-TR',{minimumFractionDigits:2,maximumFractionDigits:2}) + ' (' + k.tarih + ')').join(', ') +
          '</div>' +
          '</div>' +
          '<div style="display:flex; align-items:center; gap:12px">' +
          '<span class="tutar">Toplam: â‚º ' + kb.toplam.toLocaleString('tr-TR',{minimumFractionDigits:2,maximumFractionDigits:2}) + '</span>' +
          '</div>' +
          '</div>';
      }).join('');
    
  }catch(e){
    console.error(e);
    liste.innerHTML = '<div class="muted">BorÃ§lar yÃ¼klenemedi</div>';
  }
}

/* ===== ÃœrÃ¼n YÃ¶netimi (Ayarlar) ===== */
async function loadUrunYonetim(){
  try{
    const snap = await db.collection('kantin_urunler').orderBy('ad').get();
    const liste = document.getElementById('urunYonetimListe');
    
    if(snap.empty){
      liste.innerHTML = '<div class="muted" style="padding:20px; text-align:center">HenÃ¼z Ã¼rÃ¼n eklenmemiÅŸ</div>';
      return;
    }
    
    liste.innerHTML = '<div class="table-wrap"><table><thead><tr><th style="width:40px"><input type="checkbox" id="urunYonetimSelectAll" title="TÃ¼mÃ¼nÃ¼ SeÃ§" /></th><th>ÃœrÃ¼n AdÄ±</th><th>Kategori</th><th>GeliÅŸ FiyatÄ±</th><th>SatÄ±ÅŸ FiyatÄ±</th><th>Stok</th><th>Durum</th><th>Ä°ÅŸlem</th></tr></thead><tbody id="urunYonetimTbody"></tbody></table></div>';
    
    const tbody = document.getElementById('urunYonetimTbody');
    tbody.innerHTML = snap.docs.map(doc=>{
      const d = doc.data() || {};
      const ad = d.ad || 'Ä°simsiz';
      const kategori = getKategoriLabel(d.kategori || 'diger');
      const gelisFiyat = toNum(d.gelisFiyat || 0);
      const fiyat = toNum(d.fiyat || 0);
      const stok = toNum(d.stok || 0);
      const aktif = d.aktif !== false;
      const durumClass = aktif ? 'success' : 'muted';
      const durumText = aktif ? 'âœ“ Aktif' : 'âœ— Pasif';
      
      return '<tr>' +
        '<td><input type="checkbox" class="urun-yonetim-checkbox" data-urun-id="' + doc.id + '" /></td>' +
        '<td>' + ad + '</td>' +
        '<td>' + kategori + '</td>' +
        '<td>â‚º ' + gelisFiyat.toLocaleString('tr-TR',{minimumFractionDigits:2,maximumFractionDigits:2}) + '</td>' +
        '<td>â‚º ' + fiyat.toLocaleString('tr-TR',{minimumFractionDigits:2,maximumFractionDigits:2}) + '</td>' +
        '<td>' + stok + ' adet</td>' +
        '<td><span class="urun-durum-toggle" data-urun-id="' + doc.id + '" data-aktif="' + aktif + '" style="color:var(--' + durumClass + '); cursor:pointer; user-select:none" title="TÄ±klayarak durumu deÄŸiÅŸtir">' + durumText + '</span></td>' +
        '<td><button class="btn-ghost" data-urun-id="' + doc.id + '" data-action="urun-duzenle" title="DÃ¼zenle">âœï¸</button></td>' +
        '</tr>';
    }).join('');
    
    // TÃ¼mÃ¼nÃ¼ seÃ§ checkbox
    const selectAll = document.getElementById('urunYonetimSelectAll');
    if(selectAll){
      selectAll.addEventListener('change', (e)=>{
        const checkboxes = document.querySelectorAll('.urun-yonetim-checkbox');
        checkboxes.forEach(cb=>cb.checked = e.target.checked);
      });
    }
    
    // Durum toggle event delegation
    if(!liste.dataset.durumListenerAdded){
      liste.addEventListener('click', async (e)=>{
        const durumToggle = e.target.closest('.urun-durum-toggle');
        if(durumToggle && durumToggle.dataset.urunId){
          const urunId = durumToggle.dataset.urunId;
          const mevcutAktif = durumToggle.dataset.aktif === 'true';
          const yeniAktif = !mevcutAktif;
          
          try{
            await db.collection('kantin_urunler').doc(urunId).update({
              aktif: yeniAktif,
              updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
              updatedBy: currentUser?.email || null
            });
            
            durumToggle.dataset.aktif = yeniAktif;
            durumToggle.textContent = yeniAktif ? 'âœ“ Aktif' : 'âœ— Pasif';
            durumToggle.style.color = yeniAktif ? 'var(--success)' : 'var(--muted)';
            toast('âœ… ÃœrÃ¼n durumu gÃ¼ncellendi');
            await loadUrunler(); // Ana Ã¼rÃ¼n listesini de yenile
          }catch(err){
            console.error(err);
            toast('Durum gÃ¼ncellenemedi');
          }
        }
      });
      liste.dataset.durumListenerAdded = 'true';
    }
    
    // Event delegation for dÃ¼zenle buttons
    if(!liste.dataset.listenerAdded){
      liste.addEventListener('click', (e)=>{
        const btn = e.target.closest('[data-action="urun-duzenle"]');
        if(btn && btn.dataset.urunId){
          openUrunDuzenleModal(btn.dataset.urunId);
        }
      });
      liste.dataset.listenerAdded = 'true';
    }
    
  }catch(e){
    console.error(e);
    document.getElementById('urunYonetimListe').innerHTML = '<div class="muted" style="padding:20px; text-align:center">ÃœrÃ¼nler yÃ¼klenemedi</div>';
  }
}

async function openUrunDuzenleModal(urunId){
  try{
    const doc = await db.collection('kantin_urunler').doc(urunId).get();
    if(!doc.exists){
      toast('ÃœrÃ¼n bulunamadÄ±');
      return;
    }
    
    const d = doc.data() || {};
    document.getElementById('urunDuzenleId').value = urunId;
    document.getElementById('urunDuzenleAd').value = d.ad || '';
    document.getElementById('urunDuzenleKategori').value = d.kategori || 'yemek';
    document.getElementById('urunDuzenleGelisFiyat').value = (parseFloat(d.gelisFiyat) || 0).toFixed(2);
    document.getElementById('urunDuzenleFiyat').value = (parseFloat(d.fiyat) || 0).toFixed(2);
    document.getElementById('urunDuzenleStok').value = parseInt(d.stok) || 0;
    document.getElementById('urunDuzenleAciklama').value = d.aciklama || '';
    document.getElementById('urunDuzenleAktif').checked = d.aktif !== false;
    
    // VirgÃ¼l giriÅŸi desteÄŸi ekle
    const gelisInput = document.getElementById('urunDuzenleGelisFiyat');
    const fiyatInput = document.getElementById('urunDuzenleFiyat');
    
    // Eski event listener'larÄ± temizle (clone ile)
    const gelisNew = gelisInput.cloneNode(true);
    gelisInput.parentNode.replaceChild(gelisNew, gelisInput);
    const fiyatNew = fiyatInput.cloneNode(true);
    fiyatInput.parentNode.replaceChild(fiyatNew, fiyatInput);
    
    // Yeni input'lara virgÃ¼l desteÄŸi ekle
    document.getElementById('urunDuzenleGelisFiyat').addEventListener('input', (e)=>{
      let value = e.target.value;
      if(value.includes(',')){
        value = value.replace(',', '.');
        e.target.value = value;
      }
    });
    document.getElementById('urunDuzenleFiyat').addEventListener('input', (e)=>{
      let value = e.target.value;
      if(value.includes(',')){
        value = value.replace(',', '.');
        e.target.value = value;
      }
    });
    
    openModal('urunDuzenleModal');
  }catch(e){
    console.error(e);
    toast('ÃœrÃ¼n bilgileri yÃ¼klenemedi');
  }
}

// ÃœrÃ¼n dÃ¼zenle kaydet
(function(){
  const btn = document.getElementById('urunDuzenleKaydetBtn');
  if(!btn) return;
  
  btn.addEventListener('click', async ()=>{
    const urunId = document.getElementById('urunDuzenleId').value;
    if(!urunId){
      toast('ÃœrÃ¼n ID bulunamadÄ±');
      return;
    }
    
    const ad = (document.getElementById('urunDuzenleAd').value || '').trim();
    const kategori = document.getElementById('urunDuzenleKategori').value || 'yemek';
    // VirgÃ¼lÃ¼ noktaya Ã§evir ve sayÄ±ya dÃ¶nÃ¼ÅŸtÃ¼r
    const gelisFiyatValue = document.getElementById('urunDuzenleGelisFiyat').value.toString().replace(/[^\d.,]/g, '').replace(',', '.');
    const fiyatValue = document.getElementById('urunDuzenleFiyat').value.toString().replace(/[^\d.,]/g, '').replace(',', '.');
    const stokValue = document.getElementById('urunDuzenleStok').value.toString().replace(/[^\d]/g, '');
    
    const gelisFiyat = parseFloat(gelisFiyatValue) || 0;
    const fiyat = parseFloat(fiyatValue) || 0;
    const stok = parseInt(stokValue) || 0;
    const aciklama = (document.getElementById('urunDuzenleAciklama').value || '').trim();
    const aktif = document.getElementById('urunDuzenleAktif').checked;
    
    if(!ad){
      toast('ÃœrÃ¼n adÄ± zorunludur');
      return;
    }
    if(fiyat <= 0){
      toast('SatÄ±ÅŸ fiyatÄ± 0\'dan bÃ¼yÃ¼k olmalÄ±dÄ±r');
      return;
    }
    
    try{
      await db.collection('kantin_urunler').doc(urunId).update({
        ad,
        kategori,
        gelisFiyat,
        fiyat,
        stok,
        aciklama,
        aktif,
        updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
        updatedBy: currentUser?.email || null
      });
      
      toast('âœ… ÃœrÃ¼n gÃ¼ncellendi!');
      closeModal(document.getElementById('urunDuzenleModal'));
      await loadUrunYonetim();
      await loadUrunler(); // Ana Ã¼rÃ¼n listesini de yenile
    }catch(e){
      console.error(e);
      toast('ÃœrÃ¼n gÃ¼ncellenemedi');
    }
  });
})();

// ÃœrÃ¼n sil
(function(){
  const btn = document.getElementById('urunDuzenleSilBtn');
  if(!btn) return;
  
  btn.addEventListener('click', async ()=>{
    const urunId = document.getElementById('urunDuzenleId').value;
    if(!urunId){
      toast('ÃœrÃ¼n ID bulunamadÄ±');
      return;
    }
    
    if(!confirm('Bu Ã¼rÃ¼nÃ¼ silmek istediÄŸinize emin misiniz? Bu iÅŸlem geri alÄ±namaz.')){
      return;
    }
    
    try{
      await db.collection('kantin_urunler').doc(urunId).delete();
      toast('âœ… ÃœrÃ¼n silindi!');
      closeModal(document.getElementById('urunDuzenleModal'));
      await loadUrunYonetim();
      await loadUrunler(); // Ana Ã¼rÃ¼n listesini de yenile
    }catch(e){
      console.error(e);
      toast('ÃœrÃ¼n silinemedi');
    }
  });
})();

// Toplu sil
(function(){
  const btn = document.getElementById('btnTopluSil');
  if(!btn) return;
  
  let isProcessing = false; // Ã‡ift tÄ±klamayÄ± engelle
  
  btn.addEventListener('click', async ()=>{
    // Ã‡ift tÄ±klamayÄ± engelle
    if(isProcessing){
      toast('â³ Ä°ÅŸlem devam ediyor, lÃ¼tfen bekleyin...');
      return;
    }
    
    const checkboxes = document.querySelectorAll('.urun-yonetim-checkbox:checked');
    if(checkboxes.length === 0){
      toast('âš ï¸ LÃ¼tfen silmek istediÄŸiniz Ã¼rÃ¼nleri seÃ§in');
      return;
    }
    
    const secilenUrunler = Array.from(checkboxes).map(cb=>cb.dataset.urunId);
    const urunAdlari = [];
    
    toast('ğŸ“‹ SeÃ§ili Ã¼rÃ¼nler kontrol ediliyor...');
    
    // ÃœrÃ¼n adlarÄ±nÄ± al
    for(const urunId of secilenUrunler){
      try{
        const doc = await db.collection('kantin_urunler').doc(urunId).get();
        if(doc.exists){
          const data = doc.data();
          urunAdlari.push(data.ad || 'Ä°simsiz');
        }
      }catch(e){
        console.error(e);
      }
    }
    
    if(secilenUrunler.length === 0){
      toast('âŒ Silinecek Ã¼rÃ¼n bulunamadÄ±');
      return;
    }
    
    const onayMesaji = 'SeÃ§ili ' + secilenUrunler.length + ' Ã¼rÃ¼nÃ¼ silmek istediÄŸinize emin misiniz?\n\n' +
      'âš ï¸ Bu iÅŸlem geri alÄ±namaz ve Ã¼rÃ¼nler kalÄ±cÄ± olarak silinecektir.\n\n' +
      'Silinecek Ã¼rÃ¼nler:\n' + 
      urunAdlari.slice(0, 10).join(', ') + 
      (urunAdlari.length > 10 ? '\n... ve ' + (urunAdlari.length - 10) + ' Ã¼rÃ¼n daha' : '');
    
    if(!confirm(onayMesaji)){
      toast('âŒ Ä°ÅŸlem iptal edildi');
      return;
    }
    
    try{
      isProcessing = true;
      btn.disabled = true;
      btn.textContent = 'â³ Siliniyor...';
      toast('ğŸ”„ ' + secilenUrunler.length + ' Ã¼rÃ¼n siliniyor...');
      
      const batch = db.batch();
      let silinenSayisi = 0;
      
      for(let i = 0; i < secilenUrunler.length; i++){
        const urunId = secilenUrunler[i];
        try{
          const urunRef = db.collection('kantin_urunler').doc(urunId);
          batch.delete(urunRef);
          silinenSayisi++;
          
          // Her 10 Ã¼rÃ¼nde bir durum gÃ¼ncelle
          if((i + 1) % 10 === 0 || (i + 1) === secilenUrunler.length){
            toast('ğŸ”„ ' + (i + 1) + '/' + secilenUrunler.length + ' Ã¼rÃ¼n iÅŸleniyor...');
          }
        }catch(e){
          console.error('ÃœrÃ¼n silme hatasÄ±:', urunId, e);
        }
      }
      
      if(silinenSayisi === 0){
        toast('âŒ Silinecek Ã¼rÃ¼n bulunamadÄ±');
        isProcessing = false;
        btn.disabled = false;
        btn.textContent = 'ğŸ—‘ï¸ Toplu Sil';
        return;
      }
      
      toast('ğŸ’¾ DeÄŸiÅŸiklikler kaydediliyor...');
      await batch.commit();
      
      toast('âœ… ' + silinenSayisi + ' Ã¼rÃ¼n baÅŸarÄ±yla silindi!');
      
      // TÃ¼mÃ¼nÃ¼ seÃ§ checkbox'Ä±nÄ± temizle
      const selectAll = document.getElementById('urunYonetimSelectAll');
      if(selectAll) selectAll.checked = false;
      
      // Listeleri yenile
      await loadUrunYonetim();
      await loadUrunler();
      
      isProcessing = false;
      btn.disabled = false;
      btn.textContent = 'ğŸ—‘ï¸ Toplu Sil';
      
    }catch(e){
      console.error('Toplu silme hatasÄ±:', e);
      toast('âŒ ÃœrÃ¼nler silinirken hata oluÅŸtu: ' + (e.message || 'Bilinmeyen hata'));
      isProcessing = false;
      btn.disabled = false;
      btn.textContent = 'ğŸ—‘ï¸ Toplu Sil';
    }
  });
})();

</script>
</body>
</html>

