<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Talebe Bilgi Formu | Karaağaç Fatih</title>
  <link rel="icon" type="image/png" href="../img/logo.png" />

  <style>
    :root{
      --appbar-h:56px; --radius:14px; --shadow:0 12px 28px rgba(0,0,0,.14);
      --bg:#0f172a; --bg2:#0b1324; --grad1:#0ea5e922; --grad2:#22d3ee22;
      --card:rgba(15,23,42,.92); --stroke:rgba(148,163,184,.18);
      --text:#e5e7eb; --muted:#9aa4b2; --brand:#38bdf8; --brand2:#0ea5e9;
      --pill:#0b1220; --pill-hover:#101a2b; --link:#c7e9ff; --surface:rgba(2,6,23,.08);
      --kpi-ok: #10b981; --kpi-warn:#ef4444;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#eef6ff;--bg2:#f7fbff;--grad1:#38bdf822;--grad2:#22d3ee22;
        --card:rgba(255,255,255,.95);--stroke:rgba(15,23,42,.12);
        --text:#0b1220;--muted:#4b5563;--brand:#0ea5e9;--brand2:#0284c7;
        --pill:#f5f8ff;--pill-hover:#e9f2ff;--link:#0b5ea8;--surface:#eef3ff;
    }}
    html[data-theme="dark"]{
      --bg:#0f172a;--bg2:#0b1324;--grad1:#0ea5e922;--grad2:#22d3ee22;
      --card:rgba(15,23,42,.92);--stroke:rgba(148,163,184,.18);
      --text:#e5e7eb;--muted:#9aa4b2;--brand:#38bdf8;--brand2:#0ea5e9;
      --pill:#0b1220;--pill-hover:#101a2b;--link:#c7e9ff;--surface:rgba(2,6,23,.08);
    }
    html[data-theme="light"]{
      --bg:#eef6ff;--bg2:#f7fbff;--grad1:#38bdf822;--grad2:#22d3ee22;
      --card:rgba(255,255,255,.95);--stroke:rgba(15,23,42,.12);
      --text:#0b1220;--muted:#4b5563;--brand:#0ea5e9;--brand2:#0284c7;
      --pill:#f5f8ff;--pill-hover:#e9f2ff;--link:#0b5ea8;--surface:#eef3ff;
    }

    *{box-sizing:border-box}
    html,body{height:100%; overflow-x:hidden;}
    body{
      margin:0; color:var(--text); font-family:ui-sans-serif,-apple-system,"Segoe UI",Roboto,Arial;
      background:
        radial-gradient(900px 680px at 12% 8%, var(--grad1), transparent 45%),
        radial-gradient(800px 640px at 88% 92%, var(--grad2), transparent 50%),
        linear-gradient(140deg, var(--bg), var(--bg2) 60%);
    }
    a{color:var(--link); text-decoration:none} a:hover{text-decoration:underline}

    /* APPBAR */
    .appbar{position:sticky; top:0; z-index:60; height:var(--appbar-h);
      background:var(--card); backdrop-filter:blur(10px); border-bottom:1px solid var(--stroke);
      display:flex; align-items:center; padding:0 12px;}
    .brand{display:flex; align-items:center; gap:10px; cursor:pointer}
    .brand img{width:24px; height:24px} .brand span{font-weight:900; color:var(--text)}
    .nav-center{margin:0 auto; height:100%}
    .nav-list{display:flex; gap:22px; align-items:center; height:100%; list-style:none; margin:0; padding:0}
    .nav-right{display:flex; gap:8px; align-items:center}
    .btn{border:1px solid var(--stroke); background:var(--card); color:var(--text); border-radius:999px; padding:8px 12px; cursor:pointer}
    .hamb{display:none}
    @media (max-width:640px){ .hamb{display:inline-block} .nav-center{display:none} }

    /* Drawer */
    .drawer{position:fixed; top:var(--appbar-h); right:0; bottom:0; width:78vw; max-width:420px;
      transform:translateX(100%); transition:transform .25s ease; background:var(--card); border-left:1px solid var(--stroke);
      z-index:70; overflow:auto; padding:12px}
    .drawer.open{ transform:translateX(0) }
    .drawer-backdrop{ position:fixed; inset:0; top:var(--appbar-h); background:rgba(2,6,23,.45);
      opacity:0; pointer-events:none; transition:opacity .2s ease; z-index:65; }
    .drawer-backdrop.show{ opacity:1; pointer-events:auto }

    /* CONTENT */
    .container{max-width:1150px; margin:0 auto; padding:16px 16px 24px}

    /* HERO */
    .hero{display:flex; justify-content:space-between; align-items:flex-start; gap:16px;
      background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius);
      padding:16px; margin:16px 0; box-shadow:var(--shadow)}
    .hero h2{margin:0 0 6px; font-size:20px}
    .hero-sub{color:var(--muted); font-size:13px}

    /* DEVRE SELECT — yeni stil */
    .devre-wrap{
      display:flex; align-items:center; gap:10px; margin-top:10px;
      background:var(--pill); border:1px solid var(--stroke); border-radius:999px; padding:6px 10px;
      position:relative; width:max-content;
    }
    .devre-wrap label{font-size:12px; color:var(--muted); font-weight:800}
    .devre-select{
      -webkit-appearance:none; appearance:none; outline:0; border:0;
      background:transparent; color:var(--text); font-weight:800; padding:6px 28px 6px 8px; border-radius:999px; cursor:pointer;
    }
    .devre-wrap .chev{
      position:absolute; right:8px; pointer-events:none; opacity:.7; font-size:12px;
    }
    .devre-wrap:focus-within{ box-shadow:0 0 0 3px rgba(56,189,248,.25) }

    /* KART ZEMİNİ */
    .card{background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px; margin-bottom:16px}
    .card h3{margin:0 0 10px; font-size:16px; display:flex; justify-content:space-between; align-items:center}

    /* KPI kutuları */
    .kpi{display:flex; gap:12px; flex-wrap:wrap}
    .kpi-item{
      min-width:180px; flex:1 1 0; border:1px solid var(--stroke); border-radius:14px; padding:14px 16px;
      background:var(--surface); box-shadow:inset 0 1px 0 rgba(255,255,255,.04), 0 6px 16px rgba(0,0,0,.08)
    }
    .kpi-title{font-size:12px; color:var(--muted); font-weight:800}
    .kpi-value{font-size:28px; font-weight:900; line-height:1.1; margin-top:6px}
    .kpi-ok{ border-color: color-mix(in oklab, var(--kpi-ok) 55%, transparent); }
    .kpi-warn{ border-color: color-mix(in oklab, var(--kpi-warn) 55%, transparent); }

    /* Dağılım pill'leri */
    .pill{display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; margin:6px 10px 0 0; line-height:1; border:1px solid var(--stroke); background:var(--pill)}

    /* Kart grid */
    .kartlar-alani{display:grid; gap:12px; grid-template-columns:repeat(5,1fr)}
    @media (max-width:1200px){ .kartlar-alani{grid-template-columns:repeat(4,1fr)} }
    @media (max-width:900px){ .kartlar-alani{grid-template-columns:repeat(3,1fr)} }
    @media (max-width:640px){ .kartlar-alani{grid-template-columns:repeat(2,1fr)} }
    @media (max-width:420px){ .kartlar-alani{grid-template-columns:1fr} }

    .talebe-kart{
      border:1px solid var(--stroke); background:var(--surface); border-radius:12px;
      padding:10px; display:flex; gap:10px; align-items:center; cursor:pointer;
      transition:transform .12s ease, box-shadow .12s ease;
    }
    .talebe-kart:hover{ transform:translateY(-1px); box-shadow:var(--shadow) }
    .talebe-foto{ width:52px; height:52px; object-fit:cover; border-radius:10px; }
    .talebe-info{flex:1 1 auto; min-width:0}
    .talebe-ad{font-weight:800; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
    .talebe-alt{font-size:12px; color:var(--muted); overflow:hidden; text-overflow:ellipsis; white-space:nowrap}

    /* MODAL */
    .modal{position:fixed; inset:0; display:none; place-items:center; background:rgba(2,6,23,.55); z-index:120}
    .modal.open{display:grid}
    .modal-icerik{
      max-width:980px; width:calc(100% - 24px);
      max-height:calc(100dvh - 24px); overflow:auto;
      background:var(--card); border:1px solid var(--stroke); border-radius:16px; box-shadow:var(--shadow);
    }

    /* Toast */
    .toast{
      position:fixed;left:50%;bottom:24px;transform:translateX(-50%) translateY(20px);
      background:rgba(2,6,23,.95);color:#fff;border:1px solid rgba(255,255,255,.08);
      border-radius:12px;padding:10px 12px;opacity:0;pointer-events:none;
      transition:opacity .25s, transform .25s;z-index:200
    }

    /* Modal içi (talebe-modal.js oluşturuyor, burada sadece temel stiller) */
    .modal-tabs{display:flex; gap:8px; padding:12px; border-bottom:1px solid var(--stroke); position:sticky; top:0; background:var(--card); z-index:2}
    .tab-btn{padding:8px 12px; border-radius:999px; border:1px solid var(--stroke); background:var(--pill); cursor:pointer; font-weight:700}
    .tab-btn.active{background:linear-gradient(90deg,var(--brand2),var(--brand)); color:#fff; border-color:transparent}
    .modal-body{padding:14px}
    .form-grid{display:grid; gap:10px; grid-template-columns:repeat(2,1fr)}
    .form-grid .fld{display:flex; flex-direction:column; gap:6px}
    .fld label{font-size:12px; color:var(--muted); font-weight:700}
    .fld input,.fld select,.fld textarea{padding:10px; border:1px solid var(--stroke); border-radius:10px; background:var(--pill); color:var(--text)}
    .fld textarea{min-height:84px; resize:vertical}
    @media (max-width:640px){ .form-grid{grid-template-columns:1fr} }
    .modal-actions{display:flex; gap:8px; justify-content:flex-end; padding:12px; border-top:1px solid var(--stroke); background:var(--card); position:sticky; bottom:0; z-index:2}
    .btn-ghost{border:1px solid var(--stroke); background:var(--pill); padding:10px 12px; border-radius:10px; font-weight:800; cursor:pointer}
    .btn-primary{border:0; background:linear-gradient(90deg,var(--brand2),var(--brand)); color:#fff; padding:10px 14px; border-radius:10px; font-weight:900; cursor:pointer}
    .btn-danger{border:1px solid #7f1d1d; background:#450a0a; color:#fff; padding:10px 12px; border-radius:10px; font-weight:800; cursor:pointer}
  </style>

  <link rel="stylesheet" href="../css/form.css" />
  <link rel="stylesheet" href="../css/stiller.css" />

  <!-- Firebase compat -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <!-- Proje Firebase init -->
  <script src="../js/firebase/firebase-init.js"></script>

  <!-- Ortak -->
  <script src="../js/ortak.js"></script>
  <script src="../js/icerikyukle.js"></script>

  <!-- Modal içerik (AŞAĞIDA dosyası ayrı verildi) -->
  <script defer src="../js/talebe-modal.js"></script>

  <!-- PDF araçları (korundu) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <script src="../js/pdf/pdf-cikti.js"></script>
</head>
<body>
<div class="appbar">
  <div class="brand" onclick="location.href='../panel.html'">
    <img src="../img/logo.png" alt="logo"><span>KARAAĞAÇ FATİH</span>
  </div>
  <nav class="nav-center"><ul class="nav-list" id="navMain"></ul></nav>
  <div class="nav-right">
    <button class="btn hamb" id="hamburger">☰</button>
    <button class="btn" id="themeToggle">🌗 <span id="themeLabel">Auto</span></button>
    <button class="btn" onclick="logout()">Çıkış Yap</button>
  </div>
</div>
<aside class="drawer" id="drawer"></aside>
<div class="drawer-backdrop" id="drawerBackdrop"></div>

<main class="container">
  <section class="hero">
    <div>
      <h2>Talebe Bilgi Formu</h2>
      <div class="hero-sub">Genel özet ve profil kartları</div>

      <!-- Yeni devre seçici -->
      <div class="devre-wrap">
        <label for="selDevre">Devre</label>
        <select id="selDevre" class="devre-select"></select>
        <span class="chev">▾</span>
      </div>
    </div>
  </section>

  <!-- KPI’lar -->
  <section class="card" id="kpiWrap">
    <h3><span>Özet</span></h3>
    <div class="kpi">
      <div class="kpi-item" id="kpiTotal">
        <div class="kpi-title">Toplam</div>
        <div class="kpi-value" id="kpiTotalVal">0</div>
      </div>
      <div class="kpi-item" id="kpiEnsar">
        <div class="kpi-title">Ensar</div>
        <div class="kpi-value" id="kpiEnsarVal">0</div>
      </div>
      <div class="kpi-item" id="kpiMuhacir">
        <div class="kpi-title">Muhacir</div>
        <div class="kpi-value" id="kpiMuhacirVal">0</div>
      </div>
    </div>
  </section>

  <!-- Dağılımlar -->
  <section class="card">
    <h3 style="margin:0 0 8px">Kurslara Göre Dağılım</h3>
    <div id="ozetKurslar"></div>
  </section>

  <section class="card">
    <h3 style="margin:0 0 8px">Memleket (İl/Ülke) Dağılımı</h3>
    <div id="ozetMemleket"></div>
  </section>

  <!-- Kartlar -->
  <section class="card">
    <h3><span>Talebe Kartları</span></h3>
    <div id="talebeKartAlani" class="kartlar-alani"></div>
  </section>

  <div style="height:84px;margin-top:16px;border-top:1px solid var(--stroke)"></div>
</main>

<!-- Modal -->
<div id="talebeModal" class="modal" aria-modal="true" role="dialog">
  <div class="modal-icerik" id="modalIcerik"></div>
</div>

<div class="toast" id="toast"></div>

<script>
(function (db, auth) {
/* ===== Tema (aynı) ===== */
(function(){
  const root=document.documentElement, btn=document.getElementById('themeToggle');
  const lab1=document.getElementById('themeLabel'), lab2=document.getElementById('themeLabel2');
  const sysDark=()=>window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches;
  function apply(mode){
    localStorage.setItem('kf_theme',mode);
    const eff=(mode==='auto')?(sysDark()?'dark':'light'):mode;
    root.setAttribute('data-theme',eff);
    const txt=mode[0].toUpperCase()+mode.slice(1);
    if(lab1) lab1.textContent=txt; if(lab2) lab2.textContent=txt;
    const icon=mode==='dark'?'🌙':mode==='light'?'☀️':'🌗';
    if(btn) btn.innerHTML=icon+' <span id="themeLabel">'+txt+'</span>';
  }
  apply(localStorage.getItem('kf_theme')||'auto');
  btn?.addEventListener('click',()=>{const cur=localStorage.getItem('kf_theme')||'auto'; apply(cur==='dark'?'light':(cur==='light'?'auto':'dark'));});
  if(window.matchMedia){ const m=window.matchMedia('(prefers-color-scheme: dark)'); m.addEventListener?.('change',()=>{ if((localStorage.getItem('kf_theme')||'auto')==='auto') apply('auto'); }); }
})();

/* ===== Yardımcılar ===== */
const lower= s => (s==null?'':String(s)).trim().toLowerCase();
const pick = (rec, keys)=>{ for(const k of keys){ if(rec?.[k]!=null && String(rec[k]).trim()!=='') return rec[k]; } return ''; };
const FIELD_GRP = {
  status:['durum','status','tip'],
  kurs:['kurs','geldigiKurs','kaynakKurs'],
  name:['kullAd','adSoyad','ad','isim','fullName'],
  sehir:['il','memleket','sehir'],
  ulke:['ulke','ülke','country'],
  foto:['fotoURL','fotograf','photoURL']
};
function normStatus(s){
  const t=lower(s);
  if(t.includes('ensar')) return 'Ensar';
  if(t.includes('muhacir')||t.includes('muhacır')) return 'Muhacir';
  return 'Diğer';
}
function showToast(m){
  const t=document.getElementById('toast'); if(!t) return;
  t.textContent=m; t.style.opacity=1; t.style.transform='translateX(-50%) translateY(0)';
  clearTimeout(window.__to); window.__to=setTimeout(()=>{t.style.opacity=0; t.style.transform='translateX(-50%) translateY(20px)';},1800);
}

/* ===== Devre seçici ===== */
let CURRENT_DEVRE = localStorage.getItem('kf_devre') || '6.Devre';
const DEVRE_FALLBACK = ['6.Devre','7.Devre','8.Devre'];
async function ensureDevreSelector(){
  const sel = document.getElementById('selDevre');
  sel.innerHTML = `<option disabled>Yükleniyor…</option>`;
  let devreList=[];
  try{
    const qs = await db.collection('talebeler').get();
    devreList = qs.docs.map(d=>d.id).filter(Boolean);
  }catch(e){}
  if(!devreList.length) devreList = DEVRE_FALLBACK;
  sel.innerHTML = devreList.map(d=>`<option ${d===CURRENT_DEVRE?'selected':''}>${d}</option>`).join('');
  sel.addEventListener('change', ()=>{
    CURRENT_DEVRE = sel.value;
    localStorage.setItem('kf_devre', CURRENT_DEVRE);
    loadTalebelerForDevre();
  });
}

/* ===== Veri okuma (yeni + eski uyum) ===== */
const STUDENTS_SUB_NAMES=['öğrenciler','ogrenciler'];
const FALLBACK_COLLECTIONS=['talebeler','talebe_kayit','talebeKayit','talebe_kayitlari','talebe_index'];

async function fetchTalebelerForDevre(devre){
  // 1) yeni şema
  for(const sub of STUDENTS_SUB_NAMES){
    try{
      const snap = await db.collection('talebeler').doc(devre).collection(sub).get();
      if(!snap.empty) return snap.docs.map(d=>({id:d.id, __devre:devre, ...d.data()}));
    }catch(e){}
  }
  // 2) fallback
  for(const col of FALLBACK_COLLECTIONS){
    try{
      const snap = await db.collection(col).get();
      if(!snap.empty) return snap.docs.map(d=>({id:d.id, __devre:devre, ...d.data()}));
    }catch(e){}
  }
  return [];
}

async function fetchProfilIfNeeded(devre, uid, currentData){
  const hasBasic = FIELD_GRP.name.some(k=>currentData?.[k]!=null) &&
                   FIELD_GRP.status.some(k=>currentData?.[k]!=null);
  if(hasBasic) return currentData;

  // önce "öğrenciler", sonra "ogrenciler"
  for(const sub of STUDENTS_SUB_NAMES){
    try{
      const p = await db.collection('talebeler').doc(devre).collection(sub).doc(uid)
        .collection('bilgiler').doc('profil').get();
      if(p.exists) return {...currentData, ...p.data()};
    }catch(e){}
  }
  return currentData;
}

/* ===== Kartlar + KPI ===== */
function renderPills(mapObj, container){
  if(!container) return;
  container.innerHTML='';
  const arr = Object.entries(mapObj).sort((a,b)=> b[1]-a[1] || a[0].localeCompare(b[0],'tr'));
  if(!arr.length){ container.innerHTML='<span class="talebe-alt">Kayıt yok</span>'; return; }
  arr.forEach(([k,v])=>{
    const span=document.createElement('span'); span.className='pill'; span.textContent=`${k}: ${v}`; container.appendChild(span);
  });
}
function sortCardsAZ(){
  const wrap=document.getElementById('talebeKartAlani'); if(!wrap) return;
  const cards=[...wrap.children]; cards.sort((a,b)=>{
    const an=(a.querySelector('.talebe-ad')?.textContent||'').trim();
    const bn=(b.querySelector('.talebe-ad')?.textContent||'').trim();
    return an.localeCompare(bn,'tr');
  });
  cards.forEach(c=>wrap.appendChild(c));
}

async function loadTalebelerForDevre(){
  const wrap=document.getElementById('talebeKartAlani'); if(!wrap) return;
  wrap.innerHTML='<div class="talebe-alt">Yükleniyor…</div>';

  const listRaw = await fetchTalebelerForDevre(CURRENT_DEVRE);

  // Eksikleri profil ile paralel zenginleştir
  const list = await Promise.all(listRaw.map(async x=>{
    const d = await fetchProfilIfNeeded(x.__devre || CURRENT_DEVRE, x.id, x);
    return {id:x.id, __devre:(x.__devre||CURRENT_DEVRE), ...d};
  }));

  // Özet sayımlar
  let total=0, ensar=0, muhacir=0; const byKurs={}, byMem={};

  wrap.innerHTML='';
  for(const d of list){
    total++;
    const ad   = pick(d, FIELD_GRP.name) || 'İsimsiz';
    const foto = pick(d, FIELD_GRP.foto) || `https://ui-avatars.com/api/?name=${encodeURIComponent(ad)}&background=random`;
    const durum= normStatus(pick(d, FIELD_GRP.status));
    const kurs = pick(d, FIELD_GRP.kurs) || 'Belirtilmemiş';
    const il   = pick(d, FIELD_GRP.sehir) || '';
    const ulke = pick(d, FIELD_GRP.ulke)  || '';
    const mem  = (durum==='Ensar' ? (il||'Belirtilmemiş') : (ulke||'Belirtilmemiş'));

    if(durum==='Ensar') ensar++; else if(durum==='Muhacir') muhacir++;
    byKurs[kurs]=(byKurs[kurs]||0)+1;
    byMem[mem]=(byMem[mem]||0)+1;

    const card=document.createElement('div');
    card.className='talebe-kart';
    card.dataset.id=d.id; card.dataset.devre=(d.__devre||CURRENT_DEVRE);
    card.innerHTML = `
      <img class="talebe-foto" loading="lazy" src="${foto}" alt="">
      <div class="talebe-info">
        <div class="talebe-ad">${ad}</div>
        <div class="talebe-alt">${kurs} • ${durum}</div>
      </div>`;
    card.addEventListener('click', ()=>{
      // HATA DÜZELTİLDİ: undefined uid çağrısı yok.
      localStorage.setItem('aktifTalebeUID', d.id);
      localStorage.setItem('aktifTalebeDevre', (d.__devre||CURRENT_DEVRE));
      const mm=document.getElementById('talebeModal'); mm?.classList.add('open');
      if(typeof window.yukleModalIcerik==='function') window.yukleModalIcerik();
    });
    wrap.appendChild(card);
  }

  // KPI’ları yaz
  document.getElementById('kpiTotalVal').textContent = total;
  document.getElementById('kpiEnsarVal').textContent = ensar;
  document.getElementById('kpiMuhacirVal').textContent = muhacir;

  // Basit renklendirme (opsiyonel)
  const k1=document.getElementById('kpiTotal'); const k2=document.getElementById('kpiEnsar'); const k3=document.getElementById('kpiMuhacir');
  [k1,k2,k3].forEach(k=>{k.classList.remove('kpi-ok','kpi-warn'); k.classList.add('kpi-ok');});

  // A–Z
  sortCardsAZ();

  // Dağılımlar
  renderPills(byKurs, document.getElementById('ozetKurslar'));
  renderPills(byMem,  document.getElementById('ozetMemleket'));
}

/* ===== Modal kapatma ===== */
(function(){
  const modal = document.getElementById('talebeModal');
  modal?.addEventListener('click', e=>{
    if(e.target===modal){ modal.classList.remove('open'); }
  });
  window.addEventListener('keydown', e=>{
    if(e.key==='Escape'){ modal?.classList.remove('open'); }
  });
})();

/* ===== Auth ===== */
auth.onAuthStateChanged(async user=>{
  if(!user){ location.replace("../index.html"); return; }
  await ensureDevreSelector();
  await loadTalebelerForDevre();
});
})(window.db, window.auth);
</script>
</body>
</html>
