<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Talebe Takip Sistemi</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!--
        SENİN FIREBASE KURULUMUN (v8/Compat)
        Bu scriptler, 'firebase-init.js' dosyanın çalışması için gereklidir.
    -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="../js/firebase/firebase-init.js"></script>
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .page, .dashboard-card { animation: fadeIn 0.3s ease-out; }
        .status-btn:not(:disabled):hover { opacity: 0.8; }
        
        /* Hafta sonu giriş listesi stilleri */
        .weekend-checkin-list button {
            transition: all 0.2s ease;
        }
    </style>
    <!-- İnter fontunu yükle -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body class="bg-gray-100 min-h-screen">
    
    <!-- Bildirim Kutusu -->
    <div id="notification" class="hidden fixed top-5 right-5 text-white py-2 px-4 rounded-lg shadow-lg z-50">
        Bildirim mesajı burada görünecek.
    </div>

    <!-- Header -->
    <header class="bg-white shadow-md">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold text-blue-700">Talebe Takip Sistemi</h1>
            <span class="text-sm text-gray-600">Yönetici Paneli</span>
        </div>
    </header>

    <!-- Navigasyon (Sekmeler) -->
    <nav class="bg-blue-500 text-white shadow-lg">
        <div class="container mx-auto px-4 flex flex-wrap justify-center space-x-1 sm:space-x-2">
            <button data-target="mainDashboard" class="tab-btn bg-blue-600 py-3 px-4 font-semibold hover:bg-blue-600 rounded-t-lg text-sm sm:text-base">Ana Panel</button>
            <button data-target="leaveTracking" class="tab-btn bg-blue-500 py-3 px-4 font-semibold hover:bg-blue-600 rounded-t-lg text-sm sm:text-base">İzin Takip</button>
            <button data-target="attendanceTracking" class="tab-btn bg-blue-500 py-3 px-4 font-semibold hover:bg-blue-600 rounded-t-lg text-sm sm:text-base">Toplu Yoklama</button>
            <button data-target="dataControl" class="tab-btn bg-blue-500 py-3 px-4 font-semibold hover:bg-blue-600 rounded-t-lg text-sm sm:text-base">Veri Kontrol</button>
        </div>
    </nav>

    <!-- Ana İçerik Alanı -->
    <main class="container mx-auto p-4">

        <!-- Sayfa 1: Ana Panel (Dashboard) -->
        <div id="mainDashboard" class="page">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Ana Panel (Raporlama)</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="dashboard-card bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold text-blue-600">Şu An İzinde Olanlar</h3>
                    <p id="statIzinde" class="text-3xl font-bold text-gray-800 mt-2">...</p>
                </div>
                <div class="dashboard-card bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold text-red-600">Bugün Yoklama (-)</h3>
                    <p id="statYoklama" class="text-3xl font-bold text-gray-800 mt-2">...</p>
                </div>
                <div class="dashboard-card bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-lg font-semibold text-green-600">Toplam Öğrenci</h3>
                    <p id="statToplamOgrenci" class="text-3xl font-bold text-gray-800 mt-2">...</p>
                </div>
            </div>
            
        </div>

        <!-- Sayfa 2: İzin Takip (Veri Girişi) - YENİ MANTIK -->
        <div id="leaveTracking" class="page hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Modül 2: İzin Takip Sistemi (Devre Odaklı)</h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                
                <!-- İzin Talep Formu (Güncellendi) -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Yeni İzin Kaydı</h3>
                    <form id="leaveRequestForm" class="space-y-4">
                        <div>
                            <label for="leaveDevreSelect" class="block text-sm font-medium text-gray-700">1. Adım: Devre Seç</label>
                            <select id="leaveDevreSelect" class="devre-select mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                <option value="">Devre Seçin</option>
                            </select>
                        </div>

                        <div>
                            <label for="leaveType" class="block text-sm font-medium text-gray-700">2. Adım: İzin Tipi Seç</label>
                            <select id="leaveType" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500" disabled>
                                <option value="">Önce Devre Seçin</option>
                                <option value="Hafta Sonu">Hafta Sonu İzni (Toplu)</option>
                                <option value="Hastane">Hastane</option>
                                <option value="Berber">Berber</option>
                                <option value="Market">Market</option>
                                <option value="Diğer">Diğer (Bireysel)</option>
                            </select>
                        </div>
                        
                        <!-- Bireysel İzin (Diğer) -->
                        <div id="individualLeaveSection" class="hidden space-y-4">
                            <div>
                                <label for="leaveStudentSelect" class="block text-sm font-medium text-gray-700">3. Adım: Öğrenci Seç</label>
                                <select id="leaveStudentSelect" class="student-select mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                    <option value="">Öğrenci Seçin</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="returnDateIndividual" class="block text-sm font-medium text-gray-700">Planlanan Dönüş Tarihi</label>
                                    <input type="date" id="returnDateIndividual" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label for="returnTimeIndividual" class="block text-sm font-medium text-gray-700">Planlanan Dönüş Saati</label>
                                    <input type="time" id="returnTimeIndividual" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                            <button type="submit" id="saveIndividualLeaveBtn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">
                                Bireysel İzin Kaydı Oluştur
                            </button>
                        </div>
                        
                        <!-- Toplu Hafta Sonu İzni -->
                        <div id="weekendLeaveSection" class="hidden space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="returnDateWeekend" class="block text-sm font-medium text-gray-700">Planlanan Dönüş Tarihi (TÜM DEVRE)</label>
                                    <input type="date" id="returnDateWeekend" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                </div>
                                <div>
                                    <label for="returnTimeWeekend" class="block text-sm font-medium text-gray-700">Planlanan Dönüş Saati (TÜM DEVRE)</label>
                                    <input type="time" id="returnTimeWeekend" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                                </div>
                            </div>
                            <button type="button" id="createWeekendListBtn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded">
                                Hafta Sonu Giriş Listesini Oluştur
                            </button>
                        </div>
                    </form>
                </div>

                <!-- İzinli Öğrenci Listesi (Giriş Kontrol - BİREYSEL) -->
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Giriş Kontrol (Bireysel ve Özel İzin)</h3>
                    <p class="text-sm text-gray-600 mb-4">Burada sadece 'Diğer' veya 'Özel İzin' alan talebeler listelenir. Hafta sonu grubu aşağıdadır.</p>
                    <ul id="activeLeaveList" class="space-y-3 max-h-96 overflow-y-auto">
                        <li class="text-gray-500">Yüklenecek...</li>
                    </ul>
                </div>

            </div>

            <!-- HAFTA SONU GİRİŞ KONTROL LİSTESİ (YENİ) -->
            <div id="weekendCheckinContainer" class="hidden mt-6 bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-xl font-semibold text-gray-800 mb-4">Hafta Sonu Giriş Takip Listesi</h3>
                <p class="text-sm text-gray-600 mb-4">Seçili Devre: <b id="weekendDevreLabel">...</b> | Planlanan Dönüş: <b id="weekendDonusLabel">...</b></p>
                <ul id="weekendCheckinList" class="space-y-3 max-h-[600px] overflow-y-auto weekend-checkin-list">
                    <!-- Hafta sonu giriş listesi buraya dolacak -->
                </ul>
            </div>
        </div>

        <!-- Sayfa 3: Yoklama (Toplu Veri Girişi) -->
        <div id="attendanceTracking" class="page hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Modül 3: Toplu Yoklama (Hızlı Giriş)</h2>
            <div class="bg-white p-6 rounded-lg shadow-md">
                <form id="batchAttendanceForm" class="space-y-4 md:flex md:space-y-0 md:space-x-4 md:items-end">
                    <div>
                        <label for="batchDevreSelect" class="block text-sm font-medium text-gray-700">Devre</s-label>
                        <select id="batchDevreSelect" class="devre-select mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="">Devre Seçin</option>
                        </select>
                    </div>
                    <div>
                        <label for="batchDate" class="block text-sm font-medium text-gray-700">Tarih</label>
                        <input type="date" id="batchDate" value="${new Date().toISOString().split('T')[0]}" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                    </div>
                    <div>
                        <label for="batchPrayerTime" class="block text-sm font-medium text-gray-700">Vakit</label>
                        <select id="batchPrayerTime" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="Sabah">Sabah</option>
                            <option value="Öğle">Öğle</option>
                            <option value="İkindi">İkindi</option>
                            <option value="Akşam">Akşam</option>
                            <option value="Yatsı">Yatsı</option>
                            <option value="Yat">Yat</option>
                        </select>
                    </div>
                    <button type="submit" class="w-full md:w-auto bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded">
                        Yoklama Listesini Getir
                    </button>
                </form>
            </div>
            
            <div id="batchAttendanceListContainer" class="mt-6"></div>
            <button id="saveBatchAttendanceBtn" class="hidden w-full mt-6 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded shadow-lg">
                Tüm Yoklamayı Kaydet
            </button>
        </div>

        <!-- Sayfa 4: Veri Kontrol -->
        <div id="dataControl" class="page hidden">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Sayfa 2: Veri Kontrol (Düzeltme/Silme)</h2>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Tüm İzin Kayıtları</h3>
                    <ul id="allLeaveList" class="space-y-2 max-h-96 overflow-y-auto">
                        <li class="text-gray-500">Yüklenecek...</li>
                    </ul>
                </div>
                
                <div class="bg-white p-6 rounded-lg shadow-md">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4">Tüm Yoklama Kayıtları</h3>
                    <ul id="recentAttendanceList" class="space-y-2 max-h-96 overflow-y-auto">
                        <li class="text-gray-500">Yüklenecek...</li>
                    </ul>
                </div>
            </div>
        </div>

    </main>

    <!-- 
        UYGULAMA SCRIPT'İ
        'firebase-init.js' içindeki global 'db' ve 'auth' değişkenlerini kullanır.
    -->
    <script>
    (function() {
        // --- 1. ADIM: Global Değişkenler ve DOM Elementleri ---
        
        // Bu değişkenler 'firebase-init.js' tarafından global (window) olarak tanımlanmalı
        // 'db' ve 'auth' direkt kullanılıyor.
        
        let currentUserId = null; 
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        let allStudentsCache = []; // Tüm öğrencileri hafızada tutmak için

        // Koleksiyon yolları
        const getPublicCollectionPath = (collectionName) => `artifacts/${appId}/public/data/${collectionName}`;
        const studentsCollectionGroup = () => db.collectionGroup('öğrenciler');
        const studentsCollectionByDevre = (devre) => db.collection('talebe').doc(devre).collection('öğrenciler');
        const leavesCollection = () => db.collection(getPublicCollectionPath('leaves'));
        const attendanceCollection = () => db.collection(getPublicCollectionPath('attendance'));
        
        const devreler = ["6.Devre", "7.Devre", "8.Devre", "Diğer"]; 

        // DOM Elementleri
        const studentSelects = document.querySelectorAll('.student-select');
        const leaveRequestForm = document.getElementById('leaveRequestForm');
        const activeLeaveList = document.getElementById('activeLeaveList');
        const batchAttendanceForm = document.getElementById('batchAttendanceForm');
        const batchAttendanceListContainer = document.getElementById('batchAttendanceListContainer');
        const saveBatchAttendanceBtn = document.getElementById('saveBatchAttendanceBtn');
        const allLeaveList = document.getElementById('allLeaveList');
        const recentAttendanceList = document.getElementById('recentAttendanceList');
        const notification = document.getElementById('notification');
        const tabs = document.querySelectorAll('.tab-btn');
        const pages = document.querySelectorAll('.page');
        
        // Yeni İzin Formu Elementleri
        const leaveDevreSelect = document.getElementById('leaveDevreSelect');
        const leaveTypeSelect = document.getElementById('leaveType');
        const individualLeaveSection = document.getElementById('individualLeaveSection');
        const weekendLeaveSection = document.getElementById('weekendLeaveSection');
        const leaveStudentSelect = document.getElementById('leaveStudentSelect');
        const createWeekendListBtn = document.getElementById('createWeekendListBtn');
        const saveIndividualLeaveBtn = document.getElementById('saveIndividualLeaveBtn');
        const weekendCheckinContainer = document.getElementById('weekendCheckinContainer');
        const weekendCheckinList = document.getElementById('weekendCheckinList');
        const weekendDevreLabel = document.getElementById('weekendDevreLabel');
        const weekendDonusLabel = document.getElementById('weekendDonusLabel');
        let groupExpectedReturnTimestamp = null; // Hafta sonu grubu için
        
        let currentBatchStatus = {}; // Toplu yoklama için
        const statuses = [ // Toplu yoklama statüleri
            { id: 'Geldi', text: 'G', color: 'green' },
            { id: '-', text: '-', color: 'red' },
            { id: 'V', text: 'V', color: 'yellow' },
            { id: 'İ', text: 'İ', color: 'blue' }
        ];

        // Dashboard İstatistik Elementleri
        const statIzinde = document.getElementById('statIzinde');
        const statYoklama = document.getElementById('statYoklama');
        const statToplamOgrenci = document.getElementById('statToplamOgrenci');

        // --- 2. ADIM: Kimlik Doğrulama ---
        
        auth.onAuthStateChanged((user) => {
            if (user) {
                console.log("Kullanıcı giriş yaptı:", user.uid);
                currentUserId = user.uid;
                loadAllStudentsToCache(); // Öğrencileri hafızaya al
                loadActiveLeaveList(); 
                loadAllLeaveRecords(); 
                loadRecentAttendanceRecords(); 
                populateDevreSelects(); 
                loadDashboardStats();
                showDashboard();
            } else {
                console.log("Kullanıcı çıkış yaptı veya bulunamadı.");
                currentUserId = null;
                showNotification("Kullanıcı doğrulaması başarısız. Sayfayı yenileyin.", "error");
            }
        });

        async function initializeAuth() {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await auth.signInWithCustomToken(__initial_auth_token);
                } else {
                    await auth.signInAnonymously();
                }
            } catch (error) {
                console.error("Firebase kimlik doğrulama hatası! (Token/Config sorunu olabilir):", error);
                showNotification(`Giriş yapılamadı. Hata: ${error.code || error.message}`, "error");
            }
        }
        
        // --- 3. ADIM: Ana Fonksiyonlar (v8/Compat) ---
        
        function populateDevreSelects() {
            const devreSelects = document.querySelectorAll('.devre-select');
            devreSelects.forEach(select => {
                select.innerHTML = '<option value="">Devre Seçin</option>';
                devreler.forEach(devre => {
                    const option = document.createElement('option');
                    option.value = devre;
                    option.textContent = devre;
                    select.appendChild(option);
                });
            });
        }

        // Öğrencileri Firestore'dan çekip 'allStudentsCache' dizisine atar
        function loadAllStudentsToCache() {
            if (!currentUserId) return;

            studentsCollectionGroup().onSnapshot((snapshot) => {
                allStudentsCache = []; // Hafızayı temizle
                snapshot.docs.forEach(doc => {
                    allStudentsCache.push({ id: doc.id, ...doc.data() });
                });
                
                allStudentsCache.sort((a, b) => a.name.localeCompare(b.name, 'tr'));
                statToplamOgrenci.textContent = `${allStudentsCache.length} Kişi`;
                
                // Devre seçiliyse, öğrenci listesini doldur
                if (leaveDevreSelect.value) {
                    populateStudentSelectByDevre(leaveDevreSelect.value);
                }

            }, (error) => {
                console.error("Öğrenci listesi alınamadı (collectionGroup hatası olabilir):", error);
                showNotification("Öğrenci listesi yüklenemedi. Firestore indekslerini kontrol edin.", "error");
            });
        }
        
        // Hafızadaki öğrencileri devreye göre filtreleyip <select> kutusunu doldurur
        function populateStudentSelectByDevre(devre) {
            leaveStudentSelect.innerHTML = '<option value="">Öğrenci Seçin</option>';
            if (!devre) return;
            
            const filteredStudents = allStudentsCache.filter(s => s.devre === devre);
            filteredStudents.forEach(student => {
                const option = document.createElement('option');
                option.value = student.id;
                option.textContent = `${student.name} (${student.devre})`;
                option.dataset.name = student.name; 
                option.dataset.devre = student.devre; 
                leaveStudentSelect.appendChild(option);
            });
        }
        
        // --- Yeni İzin Takip Modülü Olayları ---

        // 1. Devre seçildiğinde
        leaveDevreSelect.addEventListener('change', (e) => {
            const selectedDevre = e.target.value;
            if (selectedDevre) {
                leaveTypeSelect.disabled = false;
                leaveTypeSelect.value = ""; // İzin tipi seçimini sıfırla
                populateStudentSelectByDevre(selectedDevre); // Öğrenci listesini doldur
                individualLeaveSection.classList.add('hidden'); // Diğer formları gizle
                weekendLeaveSection.classList.add('hidden');
                weekendCheckinContainer.classList.add('hidden'); // Hafta sonu listesini gizle
            } else {
                leaveTypeSelect.disabled = true;
                leaveTypeSelect.value = "";
                individualLeaveSection.classList.add('hidden');
                weekendLeaveSection.classList.add('hidden');
                weekendCheckinContainer.classList.add('hidden');
            }
        });
        
        // 2. İzin Tipi seçildiğinde
        leaveTypeSelect.addEventListener('change', (e) => {
            const leaveType = e.target.value;
            if (leaveType === 'Hafta Sonu') {
                individualLeaveSection.classList.add('hidden');
                weekendLeaveSection.classList.remove('hidden');
                weekendCheckinContainer.classList.add('hidden');
            } else if (leaveType) { // Diğer, Hastane vb.
                individualLeaveSection.classList.remove('hidden');
                weekendLeaveSection.classList.add('hidden');
                weekendCheckinContainer.classList.add('hidden');
            } else {
                individualLeaveSection.classList.add('hidden');
                weekendLeaveSection.classList.add('hidden');
                weekendCheckinContainer.classList.add('hidden');
            }
        });
        
        // 3. BİREYSEL İzin Kaydet Butonu
        saveIndividualLeaveBtn.addEventListener('click', async (e) => {
            e.preventDefault();
            const studentId = leaveStudentSelect.value;
            const studentName = leaveStudentSelect.options[leaveStudentSelect.selectedIndex].dataset.name;
            const studentDevre = leaveStudentSelect.options[leaveStudentSelect.selectedIndex].dataset.devre;
            const leaveType = leaveTypeSelect.value;
            const returnDate = document.getElementById('returnDateIndividual').value;
            const returnTime = document.getElementById('returnTimeIndividual').value;

            if (!studentId || !leaveType || !returnDate || !returnTime || !currentUserId) {
                showNotification("Lütfen tüm alanları doldurun.", "error");
                return;
            }
            
            const expectedReturnTimestamp = firebase.firestore.Timestamp.fromDate(new Date(`${returnDate}T${returnTime}`));

            try {
                await leavesCollection().add({
                    studentId: studentId,
                    studentName: studentName,
                    studentDevre: studentDevre,
                    leaveType: leaveType,
                    expectedReturn: expectedReturnTimestamp,
                    actualReturn: null, 
                    status: 'İzinde'
                });
                showNotification("Bireysel izin talebi oluşturuldu.", "success");
                leaveRequestForm.reset();
                individualLeaveSection.classList.add('hidden');
                leaveTypeSelect.disabled = true;
            } catch (error) {
                console.error("Bireysel izin ekleme hatası:", error);
                showNotification("İzin eklenemedi.", "error");
            }
        });
        
        // 4. HAFTA SONU Giriş Listesi Oluştur Butonu
        createWeekendListBtn.addEventListener('click', () => {
            const devre = leaveDevreSelect.value;
            const returnDate = document.getElementById('returnDateWeekend').value;
            const returnTime = document.getElementById('returnTimeWeekend').value;
            
            if (!devre || !returnDate || !returnTime) {
                showNotification("Devre, tarih ve saat zorunludur.", "error");
                return;
            }
            
            const returnDateTime = new Date(`${returnDate}T${returnTime}`);
            groupExpectedReturnTimestamp = firebase.firestore.Timestamp.fromDate(returnDateTime);
            
            weekendDevreLabel.textContent = devre;
            weekendDonusLabel.textContent = returnDateTime.toLocaleString('tr-TR');
            
            weekendCheckinList.innerHTML = ''; // Listeyi temizle
            const studentsInDevre = allStudentsCache.filter(s => s.devre === devre);
            
            if (studentsInDevre.length === 0) {
                weekendCheckinList.innerHTML = '<li class="text-red-500">Bu devrede öğrenci bulunamadı.</li>';
                return;
            }
            
            studentsInDevre.forEach(student => {
                const li = document.createElement('li');
                li.className = "p-3 bg-gray-50 rounded-lg shadow-sm flex flex-col sm:flex-row justify-between items-start sm:items-center";
                li.innerHTML = `
                    <span classT="font-semibold text-gray-800">${student.name}</span>
                    <div class="flex space-x-2 mt-2 sm:mt-0" data-student-id="${student.id}" data-name="${student.name}" data-devre="${student.devre}">
                        <button class="weekend-check-in-btn bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded text-sm">
                            Gelmedi
                        </button>
                        <button class="weekend-special-leave-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-1 px-3 rounded text-sm">
                            Özel İzin Ver
                        </button>
                    </div>
                `;
                weekendCheckinList.appendChild(li);
            });
            
            weekendCheckinContainer.classList.remove('hidden');
        });

        // 5. HAFTA SONU Listesindeki Butonlara Tıklama (Event Delegation)
        weekendCheckinList.addEventListener('click', async (e) => {
            const button = e.target;
            const studentData = button.parentElement.dataset;
            const now = firebase.firestore.Timestamp.now();
            
            // "Giriş Yaptı" butonu
            if (button.classList.contains('weekend-check-in-btn')) {
                let newStatus = 'Döndü';
                let buttonClass = 'bg-green-500';
                let buttonText = 'GİRİŞ YAPILDI';
                
                if (now.seconds > groupExpectedReturnTimestamp.seconds) {
                    newStatus = 'Geç Kaldı';
                    buttonClass = 'bg-yellow-500';
                    buttonText = 'GEÇ KALDI';
                }
                
                try {
                    await leavesCollection().add({
                        studentId: studentData.studentId,
                        studentName: studentData.name,
                        studentDevre: studentData.devre,
                        leaveType: 'Hafta Sonu',
                        expectedReturn: groupExpectedReturnTimestamp,
                        actualReturn: now, 
                        status: newStatus
                    });
                    
                    // Butonları güncelle
                    button.parentElement.innerHTML = `<span class="font-semibold ${buttonClass === 'bg-green-500' ? 'text-green-600' : 'text-yellow-600'}">${buttonText}</span>`;
                    
                } catch (error) {
                    showNotification("Giriş kaydedilemedi.", "error");
                }
            }
            
            // "Özel İzin Ver" butonu
            if (button.classList.contains('weekend-special-leave-btn')) {
                const ozelDonusSaati = prompt(`${studentData.name} için özel dönüş tarihi ve saati girin (örn: 2025-10-22T23:00):`, new Date().toISOString().slice(0, 16));
                if (!ozelDonusSaati) return; // İptale basıldı
                
                try {
                    const ozelTimestamp = firebase.firestore.Timestamp.fromDate(new Date(ozelDonusSaati));
                    
                    await leavesCollection().add({
                        studentId: studentData.studentId,
                        studentName: studentData.name,
                        studentDevre: studentData.devre,
                        leaveType: 'Hafta Sonu (Özel)',
                        expectedReturn: ozelTimestamp,
                        actualReturn: null, 
                        status: 'İzinde'
                    });
                    
                    button.parentElement.innerHTML = `<span class="font-semibold text-blue-600">ÖZEL İZİN VERİLDİ</span>`;
                    // Bu talebe artık sağdaki "Giriş Kontrol" listesine düşecek (onSnapshot sayesinde)
                    
                } catch (error) {
                    showNotification("Özel izin kaydedilemedi. Tarih formatını kontrol edin.", "error");
                }
            }
        });

        // --- Bireysel Giriş Kontrol Listesi ---
        function loadActiveLeaveList() {
            if (!currentUserId) return;
            
            const q = leavesCollection().where("status", "==", "İzinde");
            
            q.onSnapshot((snapshot) => {
                activeLeaveList.innerHTML = '';
                
                statIzinde.textContent = `${snapshot.size} Kişi`; // Dashboard stat

                if (snapshot.empty) {
                    activeLeaveList.innerHTML = '<li class="text-gray-500">Aktif bireysel/özel izinli öğrenci bulunmuyor.</li>';
                    return;
                }
                snapshot.docs.forEach(doc => {
                    const leave = doc.data();
                    const leaveId = doc.id;
                    const expectedReturn = leave.expectedReturn.toDate();
                    
                    const li = document.createElement('li');
                    li.className = "p-3 bg-white rounded-lg shadow-sm flex flex-col sm:flex-row justify-between items-start sm:items-center space-y-2 sm:space-y-0";
                    li.innerHTML = `
                        <div>
                            <span class="font-semibold text-blue-700">${leave.studentName} <span class="text-xs text-gray-500">(${leave.studentDevre})</span></span>
                            <span class="text-sm text-gray-600 block">(${leave.leaveType})</span>
                            <span class="text-sm text-gray-500 block">Planlanan Dönüş: ${expectedReturn.toLocaleString('tr-TR')}</span>
                        </div>
                        <button data-id="${leaveId}" data-expected-return="${leave.expectedReturn.seconds}" class="check-in-btn bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded w-full sm:w-auto">
                            Giriş Yaptı
                        </button>
                    `;
                    activeLeaveList.appendChild(li);
                });
            }, (error) => {
                console.error("Aktif izin listesi alınamadı:", error);
            });
        }

        // Bireysel Giriş Kontrol Butonu
        activeLeaveList.addEventListener('click', async (e) => {
            if (e.target.classList.contains('check-in-btn')) {
                const leaveId = e.target.dataset.id;
                const expectedReturnSeconds = parseInt(e.target.dataset.expectedReturn, 10);
                const now = firebase.firestore.Timestamp.now();
                
                let newStatus = 'Döndü';
                if (now.seconds > expectedReturnSeconds) {
                    newStatus = 'Geç Kaldı';
                }
                
                try {
                    const leaveDocRef = leavesCollection().doc(leaveId);
                    await leaveDocRef.set({
                        actualReturn: now,
                        status: newStatus
                    }, { merge: true });

                    showNotification(`Öğrenci girişi '${newStatus}' olarak kaydedildi.`, "success");
                } catch (error) {
                    console.error("Giriş kaydı hatası:", error);
                    showNotification("Giriş kaydedilemedi.", "error");
                }
            }
        });

        // --- Toplu Yoklama Modülü ---
        batchAttendanceForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const devre = document.getElementById('batchDevreSelect').value;
            const date = document.getElementById('batchDate').value;
            const prayerTime = document.getElementById('batchPrayerTime').value;

            if (!devre || !date || !prayerTime) {
                showNotification("Devre, tarih ve vakit seçimi zorunludur.", "error");
                return;
            }
            
            batchAttendanceListContainer.innerHTML = '<p class="text-gray-500">Öğrenciler ve izin durumları yükleniyor...</p>';
            currentBatchStatus = {}; 

            try {
                const studentsQuery = studentsCollectionByDevre(devre);
                const studentsSnapshot = await studentsQuery.get();
                const students = studentsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                const todayStart = firebase.firestore.Timestamp.fromDate(new Date(date + "T00:00:00"));
                const leavesQuery = leavesCollection()
                    .where("expectedReturn", ">=", todayStart)
                    .where("status", "==", "İzinde");
                const leavesSnapshot = await leavesQuery.get();
                const onLeaveStudentIds = new Set(leavesSnapshot.docs.map(doc => doc.data().studentId));
                
                const attendanceQuery = attendanceCollection()
                    .where("devre", "==", devre)
                    .where("date", "==", date)
                    .where("prayerTime", "==", prayerTime);
                const attendanceSnapshot = await attendanceQuery.get();
                const existingAttendance = {};
                attendanceSnapshot.docs.forEach(doc => {
                    existingAttendance[doc.data().studentId] = doc.data().status;
                });

                batchAttendanceListContainer.innerHTML = '';
                
                if (students.length === 0) { 
                    batchAttendanceListContainer.innerHTML = '<p class="text-red-500">Bu devrede kayıtlı öğrenci bulunamadı.</p>';
                    return;
                }

                const listUl = document.createElement('ul');
                listUl.className = "space-y-2";

                students.sort((a, b) => a.name.localeCompare(b.name, 'tr')).forEach(student => {
                    let status = existingAttendance[student.id] || 'Geldi'; 
                    let disabled = false;
                    
                    if (onLeaveStudentIds.has(student.id)) {
                        status = 'İ'; 
                        disabled = true;
                    }
                    
                    currentBatchStatus[student.id] = {
                        name: student.name,
                        devre: student.devre,
                        status: status
                    }; 

                    const li = document.createElement('li');
                    li.className = "p-3 bg-white rounded-lg shadow-sm flex justify-between items-center";
                    li.innerHTML = `<span class="font-semibold text-gray-800">${student.name}</span>`;
                    
                    const statusButtons = document.createElement('div');
                    statusButtons.className = "flex space-x-1";
                    
                    statuses.forEach(s => {
                        const button = document.createElement('button');
                        button.type = 'button'; 
                        button.dataset.id = s.id;
                        button.dataset.studentId = student.id;
                        button.textContent = s.text;
                        button.className = `status-btn ${status === s.id ? `bg-${s.color}-500 text-white` : `bg-gray-200 text-gray-700`} w-8 h-8 rounded font-bold`;
                        
                        if (s.id === 'İ') { 
                            if (status !== 'İ') button.classList.add('hidden'); 
                            button.disabled = true;
                        }
                        if (disabled && s.id !== 'İ') { 
                            button.classList.add('hidden');
                        }
                        
                        statusButtons.appendChild(button);
                    });
                    
                    li.appendChild(statusButtons);
                    listUl.appendChild(li);
                });
                
                batchAttendanceListContainer.appendChild(listUl);
                saveBatchAttendanceBtn.classList.remove('hidden'); 

            } catch (error) {
                console.error("Toplu yoklama listesi yüklenemedi:", error);
                showNotification("Liste yüklenemedi. Firestore indekslerini kontrol edin.", "error");
            }
        });

        batchAttendanceListContainer.addEventListener('click', (e) => {
            if (e.target.classList.contains('status-btn')) {
                const newStatus = e.target.dataset.id;
                const studentId = e.target.dataset.studentId;
                
                currentBatchStatus[studentId].status = newStatus;
                
                const parent = e.target.parentElement;
                parent.querySelectorAll('.status-btn').forEach(btn => {
                    const s = statuses.find(st => st.id === btn.dataset.id);
                    if (btn.dataset.id === newStatus) {
                        btn.className = `status-btn bg-${s.color}-500 text-white w-8 h-8 rounded font-bold`;
                    } else {
                        btn.className = `status-btn bg-gray-200 text-gray-700 w-8 h-8 rounded font-bold`;
                        if (s.id === 'İ') btn.classList.add('hidden'); 
                    }
                });
            }
        });
        
        saveBatchAttendanceBtn.addEventListener('click', async () => {
            const devre = document.getElementById('batchDevreSelect').value;
            const date = document.getElementById('batchDate').value;
            const prayerTime = document.getElementById('batchPrayerTime').value;

            if (!devre || !date || !prayerTime || Object.keys(currentBatchStatus).length === 0) {
                showNotification("Kaydedilecek veri bulunamadı.", "error");
                return;
            }
            
            try {
                const batch = db.batch();
                
                const oldQuery = attendanceCollection()
                    .where("devre", "==", devre)
                    .where("date", "==", date)
                    .where("prayerTime", "==", prayerTime);
                const oldSnapshot = await oldQuery.get();
                oldSnapshot.docs.forEach(doc => {
                    batch.delete(doc.ref);
                });

                for (const studentId in currentBatchStatus) {
                    const data = currentBatchStatus[studentId];
                    const newDocRef = attendanceCollection().doc();
                    batch.set(newDocRef, {
                        studentId: studentId,
                        studentName: data.name,
                        devre: data.devre,
                        date: date,
                        prayerTime: prayerTime,
                        status: data.status, 
                        recordedBy: currentUserId,
                        createdAt: firebase.firestore.Timestamp.now()
                    });
                }
                
                await batch.commit(); 
                
                showNotification("Yoklama başarıyla kaydedildi.", "success");
                batchAttendanceListContainer.innerHTML = '';
                saveBatchAttendanceBtn.classList.add('hidden');

            } catch (error) {
                console.error("Toplu yoklama kaydı hatası:", error);
                showNotification("Kayıt hatası: " + error.message, "error");
            }
        });

        // --- Veri Kontrol Modülü ---
        function loadAllLeaveRecords() {
            if (!currentUserId) return;
            leavesCollection().onSnapshot((snapshot) => {
                allLeaveList.innerHTML = '';
                if (snapshot.empty) {
                    allLeaveList.innerHTML = '<li class="text-gray-500">İzin kaydı bulunmuyor.</li>';
                    return;
                }
                snapshot.docs.forEach(doc => {
                    const leave = doc.data();
                    const leaveId = doc.id;
                    const li = document.createElement('li');
                    li.className = "p-2 bg-gray-50 rounded flex justify-between items-center";
                    li.innerHTML = `
                        <div>
                            <span class="font-semibold">${leave.studentName}</span> (${leave.leaveType})
                            <span class="text-sm text-gray-600 block">Durum: ${leave.status}</span>
                        </div>
                        <div>
                            <button data-id="${leaveId}" class="edit-leave-btn text-blue-500 hover:text-blue-700 text-xs mr-2">Düzenle</button>
                            <button data-id="${leaveId}" class="delete-leave-btn text-red-500 hover:text-red-700 text-xs">Sil</button>
                        </div>
                    `;
                    allLeaveList.appendChild(li);
                });
            }, (error) => {
                 console.error("Tüm izin kayıtları alınamadı:", error);
            });
        }
        
        function loadRecentAttendanceRecords() {
            if (!currentUserId) return;
             attendanceCollection().onSnapshot((snapshot) => {
                recentAttendanceList.innerHTML = '';
                if (snapshot.empty) {
                    recentAttendanceList.innerHTML = '<li class="text-gray-500">Yoklama kaydı bulunmuyor.</li>';
                    return;
                }
                snapshot.docs.forEach(doc => {
                    const entry = doc.data();
                    const entryId = doc.id;
                    const li = document.createElement('li');
                    li.className = "p-2 bg-gray-50 rounded flex justify-between items-center";
                    li.innerHTML = `
                        <div>
                            <span class="font-semibold">${entry.studentName}</span> (${entry.date} - ${entry.prayerTime})
                            <span class="font-bold block ${entry.status === '-' ? 'text-red-500' : 'text-gray-700'}">
                                Durum: ${entry.status}
                            </span>
                        </div>
                        <div>
                            <button data-id="${entryId}" class="edit-attendance-btn text-blue-500 hover:text-blue-700 text-xs mr-2">Düzenle</button>
                            <button data-id="${entryId}" class="delete-attendance-btn text-red-500 hover:text-red-700 text-xs">Sil</button>
                        </div>
                    `;
                    recentAttendanceList.appendChild(li);
                });
            }, (error) => {
                 console.error("Yoklama kayıtları alınamadı:", error);
            });
        }
        
        document.getElementById('dataControl').addEventListener('click', async (e) => {
            if (e.target.classList.contains('delete-leave-btn')) {
                const docId = e.target.dataset.id;
                try {
                    await leavesCollection().doc(docId).delete();
                    showNotification("İzin kaydı silindi.", "success");
                } catch (error) {
                    showNotification("İzin kaydı silinemedi.", "error");
                }
            }
            
            if (e.target.classList.contains('delete-attendance-btn')) {
                const docId = e.target.dataset.id;
                 try {
                    await attendanceCollection().doc(docId).delete();
                    showNotification("Yoklama kaydı silindi.", "success");
                } catch (error) {
                    showNotification("Yoklama kaydı silinemedi.", "error");
                }
            }

            if (e.target.classList.contains('edit-leave-btn') || e.target.classList.contains('edit-attendance-btn')) {
                showNotification("Düzenleme özelliği yakında eklenecek.", "info");
            }
        });
        
        // --- Dashboard İstatistikleri ---
        function loadDashboardStats() {
            // Aktif izinler zaten 'loadActiveLeaveList' içinde statIzinde'i güncelliyor.
            // Toplam öğrenci 'loadAllStudentsToCache' içinde statToplamOgrenci'yi güncelliyor.
            
            const today = new Date().toISOString().split('T')[0];
            attendanceCollection()
                .where("date", "==", today)
                .where("status", "==", "-")
                .onSnapshot((snapshot) => {
                    statYoklama.textContent = `${snapshot.size} Kayıt`;
                }, (error) => {
                    console.error("Dashboard yoklama istatistiği alınamadı:", error);
                    statYoklama.textContent = "Hata";
                });
        }

        // --- Navigasyon (Sekmeler) ---
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const targetPageId = tab.dataset.target;
                pages.forEach(p => p.classList.add('hidden'));
                const targetPage = document.getElementById(targetPageId);
                if (targetPage) {
                    targetPage.classList.remove('hidden');
                }
                tabs.forEach(t => t.classList.replace('bg-blue-600', 'bg-blue-500'));
                tab.classList.replace('bg-blue-500', 'bg-blue-600');
            });
        });
        
        function showDashboard() {
            document.querySelector('[data-target="mainDashboard"]').click();
        }

        // --- Bildirim Sistemi ---
        function showNotification(message, type = 'success') {
            notification.textContent = message;
            notification.classList.remove('hidden', 'bg-green-500', 'bg-red-500', 'bg-blue-500');
            
            if (type === 'success') {
                notification.classList.add('bg-green-500');
            } else if (type === 'error') {
                notification.classList.add('bg-red-500');
            } else { // info
                 notification.classList.add('bg-blue-500');
            }
            
            setTimeout(() => {
                notification.classList.add('hidden');
            }, 3000);
        }

        // --- Sayfa Yüklendiğinde ---
        // 'firebase-init.js' dosyan 'window.db' ve 'window.auth'u tanımladıktan sonra,
        // bu script çalışır ve 'auth.onAuthStateChanged' listener'ı kurulur.
        // 'initializeAuth' çağrısı auth nesnesini (eğer varsa) kullanarak token ile giriş yapar.
        if (typeof firebase !== 'undefined' && typeof firebase.auth === 'function' && typeof firebase.firestore === 'function') {
            // 'firebase-init.js'nin 'db' ve 'auth'u window'a atadığını varsayıyoruz.
            // Bu script'in en altında olduğu için DOM'un hazır olduğunu varsayıyoruz.
            initializeAuth(); // Giriş yapmayı dene
        } else {
            console.error("Firebase düzgün yüklenmedi. 'firebase-init.js' dosyasının yolu ve içeriği doğru mu?");
            showNotification("Sistem yüklenemedi. 'firebase-init.js' dosyasını kontrol edin.", "error");
        }
        
    })(); // IIFE (Immediately Invoked Function Expression)
    </script>
</body>
</html>

