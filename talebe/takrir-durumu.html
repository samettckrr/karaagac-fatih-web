<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Takrir Takibi â€“ CanlÄ± Takip | KaraaÄŸaÃ§ Fatih</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <link rel="icon" type="image/png" href="../img/logo.png" />

  <style>
    /* SADECE AÃ‡IK TEMA */
    :root{
      --appbar-h:56px;
      --radius:14px; --shadow:0 12px 28px rgba(0,0,0,.14);
      --bg:#eef6ff; --bg2:#f7fbff;
      --grad1:#38bdf822; --grad2:#22d3ee22;
      --card:#ffffffF2; --stroke:rgba(15,23,42,.12);
      --text:#0b1220; --muted:#4b5563;
      --brand:#0ea5e9; --brand2:#0284c7;
      --pill:#f5f8ff; --pill-hover:#e9f2ff; --surface:#eef3ff;
      --danger:#b91c1c; --success:#16a34a; --warn:#f59e0b;
    }
    html { color-scheme: light; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:'Segoe UI',system-ui,-apple-system,Arial,sans-serif;background:var(--bg);color:var(--text)}
    a{color:#0ea5e9;text-decoration:none}
    a:hover{text-decoration:underline}

    /* APPBAR sade */
    .appbar{
      position:sticky; top:0; z-index:60; height:var(--appbar-h);
      background:var(--card); backdrop-filter:blur(10px);
      border-bottom:1px solid var(--stroke);
      display:flex; align-items:center; gap:10px; padding:0 12px;
    }
    .brand{display:flex; align-items:center; gap:10px; cursor:pointer}
    .brand img{width:24px;height:24px}
    .brand span{font-weight:900; letter-spacing:.02em}

    /* CONTENT */
    .container{max-width:1200px; margin:0 auto; padding:16px}
    .card{background:var(--card); border:1px solid var(--stroke); border-radius:14px; box-shadow:var(--shadow); padding:14px}

    /* Header */
    .header-card{display:flex; justify-content:space-between; align-items:center; gap:16px; margin:16px 0}
    .header-left h2{margin:0 0 6px; font-size:18px}
    .badges{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
    .chip{display:inline-flex; align-items:center; gap:6px; border:1px solid var(--stroke); background:var(--pill); border-radius:999px; padding:6px 10px; font-size:12.5px}
    .chip.live{border-color:#22c55e44; background:#16a34a12}
    .chip.warn{border-color:#f59e0b44; background:#f59e0b12}

    /* SeÃ§imler (minimum) */
    .controls-grid{ display:grid; grid-template-columns:repeat(12,minmax(0,1fr)); gap:10px; align-items:center }
    .grp{grid-column: span 4; border:1px dashed var(--stroke); border-radius:12px; padding:10px; background:var(--pill)}
    .label{ font-size:12.5px; color:var(--muted); font-weight:800; margin-bottom:6px }
    select{ padding:10px 12px; border:1px solid var(--stroke); border-radius:12px; background:#fff; color:var(--text); font-size:14px; min-width:220px }
    .inline{ display:flex; gap:10px; align-items:center; flex-wrap:wrap }
    .cta{border:0; background:linear-gradient(180deg,var(--brand),var(--brand2)); color:#fff; border-radius:999px; padding:10px 16px; cursor:pointer; font-weight:800; white-space:nowrap}
    .muted{color:var(--muted); font-size:12.5px}
    @media (max-width: 960px){ .grp{grid-column: span 12} }

    /* Liste/Tablo */
    .sList{ border:1px solid var(--stroke); border-radius:12px; overflow:hidden; background:var(--card) }
    .sHead{ background:var(--pill); padding:8px 10px; font-weight:900; display:flex; gap:10px; align-items:center; justify-content:space-between }
    .sRow{ padding:10px 12px; display:flex; align-items:center; justify-content:space-between; border-top:1px dashed var(--stroke) }
    .sRow:first-child{ border-top:none }
    .statBadge{ font-size:12px; border:1px solid var(--stroke); border-radius:999px; padding:4px 8px; }
    .tiny{ font-size:11px; color:var(--muted); }

    .st-none{ background:transparent; color:var(--text) }
    .st-verdi{ background:rgba(34,197,94,.08) }
    .st-veremedi{ background:rgba(239,68,68,.12) }
    .st-yarim{ background:rgba(250,204,21,.16) }

    .table{ border:1px solid var(--stroke); border-radius:12px; overflow:hidden }
    .thead, .trow{ display:grid; grid-template-columns:1fr 120px 120px; }
    .thead div{ background:var(--pill); font-weight:900; padding:8px 10px; border-bottom:1px dashed var(--stroke) }
    .trow div{ padding:8px 10px; border-bottom:1px dashed var(--stroke) }
    .trow:last-child div{ border-bottom:none }

    /* Toast */
    .toast{position:fixed; left:50%; bottom:24px; transform:translateX(-50%) translateY(20px); background:rgba(2,6,23,.95); color:#fff; border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:10px 12px; opacity:0; pointer-events:none; transition:opacity .25s, transform .25s; z-index:200}
    .toast.show{opacity:1; transform:translateX(-50%) translateY(0)}

    /* YÃ¼kleniyor */
    .loadbox{border:1px dashed var(--stroke); border-radius:12px; padding:10px; background:var(--pill); margin-bottom:10px}
    .loadrow{display:flex; align-items:center; gap:10px}
    .loadbar{position:relative; flex:1; height:10px; background:var(--surface); border:1px solid var(--stroke);
      border-radius:999px; overflow:hidden}
    .loadbar > i{display:block; height:100%; width:0%; background:linear-gradient(90deg,var(--brand),var(--brand2)); transition:width .25s ease}
    .loadpct{min-width:46px; font-weight:800}
    .loadlbl{color:var(--muted); font-size:12.5px}

    /* Kitap & Ders Modal */
    .modal{display:none; position:fixed; inset:0; background:rgba(2,6,23,.6); z-index:99; align-items:flex-end; justify-content:center; padding:0}
    .modal.open{display:flex}
    .kd-sheet{
      width:min(980px, 100%); max-height:80vh;
      background:var(--card); border:1px solid var(--stroke); border-top-left-radius:18px; border-top-right-radius:18px;
      box-shadow:var(--shadow); padding:12px 12px 14px; display:flex; flex-direction:column; gap:12px;
      transform:translateY(6px); animation:up .18s ease-out forwards;
    }
    @keyframes up{ to { transform:translateY(0) } }
    .kd-head{display:flex; align-items:center; justify-content:space-between; gap:10px}
    .kd-title{font-weight:900}
    .kd-close{border:1px solid var(--stroke); background:var(--pill); border-radius:999px; padding:8px 12px; cursor:pointer}
    .kd-cols{display:grid; grid-template-columns:320px 1fr; gap:10px}
    @media (max-width: 800px){ .kd-cols{ grid-template-columns:1fr } }
    .kd-left{
      border:1px solid var(--stroke); border-radius:12px; overflow:auto; max-height:60vh;
      scroll-snap-type:y mandatory; padding:8px; background:var(--pill)
    }
    .kd-right{
      border:1px solid var(--stroke); border-radius:12px; overflow:auto; max-height:60vh;
      padding:8px; background:var(--pill)
    }
    .k-item{padding:8px 10px; border-radius:10px; border:1px solid var(--stroke); margin:6px 0; background:#fff; cursor:pointer}
    .k-item.active{outline:2px solid var(--brand)}
    .d-list{ display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:8px }
    .d-card{padding:10px; border:1px solid var(--stroke); border-radius:10px; background:#fff}
  </style>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <script src="../js/firebase/firebase-init.js"></script>
</head>
<body>

<!-- APPBAR -->
<div class="appbar">
  <div class="brand" onclick="location.href='../panel.html'">
    <img src="../img/logo.png" alt="logo"><span>KARAAÄžAÃ‡ FATÄ°H</span>
  </div>
</div>

<main class="container">

  <!-- HEADER -->
  <section class="card header-card">
    <div class="header-left">
      <h2>Takrir Takibi â€¢ CanlÄ±</h2>
      <div class="muted">BugÃ¼n: <span id="todayText">â€”</span></div>
    </div>
    <div class="badges">
      <span class="chip live">ðŸŸ¢ CanlÄ± takip aÃ§Ä±k</span>
      <span class="chip" id="lastRef">âŸ³ Son yenileme: â€”</span>
      <span class="chip warn" id="liveWarn" style="display:none">Sekme arka planda â€“ duraklatÄ±ldÄ±</span>
    </div>
  </section>

  <!-- SEÃ‡Ä°MLER (minimum) -->
  <section class="card">
    <div class="controls-grid">
      <div class="grp">
        <div class="label">Devre</div>
        <select id="selDevre">
          <option value="6.Devre">6.Devre</option>
          <option value="7.Devre">7.Devre</option>
          <option value="8.Devre">8.Devre</option>
        </select>
      </div>
      <div class="grp">
        <div class="label">Kitap</div>
        <div class="inline">
          <select id="selKitap"><option value="">â€” Kitap SeÃ§ â€”</option></select>
          <button class="cta" id="btnTakvim" type="button">Kitap &amp; Ders GÃ¶r</button>
        </div>
      </div>
      <div class="grp">
        <div class="label">Ders</div>
        <select id="selDers"><option value="">â€” Ders SeÃ§ â€”</option></select>
      </div>
      <div class="grp" style="grid-column:span 12">
        <div class="inline">
          <label style="display:flex;align-items:center;gap:8px">
            <input type="radio" name="mode" value="rapor" checked> Rapor GÃ¶r
          </label>
          <label style="display:flex;align-items:center;gap:8px">
            <input type="radio" name="mode" value="islem"> Ä°ÅŸlem Yap
          </label>
          <button id="btnGit" class="cta" type="button">GÃ¶ster</button>
          <span id="goMsg" class="muted"></span>
        </div>
      </div>
    </div>
  </section>

  <!-- Ã‡IKTI -->
  <section class="card">
    <div class="sHead">
      <div id="outTitle">â€”</div>
      <div id="subInfo" class="tiny">â€”</div>
    </div>
    <div id="outArea" style="margin-top:10px"></div>
  </section>

  <!-- Ä°ÅžLEM: Talebe Listesi -->
  <section id="islemSection" class="card" style="display:none">
    <div class="sList">
      <div class="sHead">
        <div>Talebeler</div>
        <div class="tiny">CanlÄ± gÃ¼ncellenir</div>
      </div>
      <div id="talebeList"></div>
    </div>
  </section>

</main>

<!-- Kitap & Ders Modal -->
<div class="modal" id="kdModal" aria-hidden="true">
  <div class="kd-sheet" role="dialog" aria-modal="true" aria-labelledby="kdTitle">
    <div class="kd-head">
      <div class="kd-title" id="kdTitle">Kitap &amp; Ders Listesi</div>
      <button class="kd-close" id="kdClose" type="button">Kapat</button>
    </div>
    <div class="kd-cols">
      <div class="kd-left" id="kdKitapList" tabindex="0" aria-label="Kitap listesi (yukarÄ±-aÅŸaÄŸÄ± kaydÄ±rÄ±labilir)"></div>
      <div class="kd-right">
        <div class="d-list" id="kdDersList" aria-label="Ders listesi (saÄŸ-sol/aÅŸaÄŸÄ±-yukarÄ± kaydÄ±rÄ±labilir)"></div>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* === Tarih === */
(function(){
  const d=new Date();
  const days=['Pazar','Pazartesi','SalÄ±','Ã‡arÅŸamba','PerÅŸembe','Cuma','Cumartesi'];
  document.getElementById('todayText').textContent=`${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()} â€¢ ${days[d.getDay()]}`;
})();

/* === Firebase & helpers === */
const db=firebase.firestore(), auth=firebase.auth();
const $=(id)=>document.getElementById(id);
function toast(msg){const t=$('toast'); t.textContent=msg; t.classList.add('show'); clearTimeout(window.__to); window.__to=setTimeout(()=>t.classList.remove('show'),2200);}
const norm=(s)=>String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
function nowHHMM(){ const d=new Date(); return d.toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'}); }

/* === CanlÄ± yenile ayarlarÄ± === */
const AUTO_REFRESH_MS = 30000; // 30 sn
let liveTimer = null;
function startLiveTimer(fn){
  stopLiveTimer();
  liveTimer = setInterval(()=>{ if(document.hidden) return; fn(); }, AUTO_REFRESH_MS);
}
function stopLiveTimer(){ if(liveTimer){ clearInterval(liveTimer); liveTimer=null; } }
document.addEventListener('visibilitychange', ()=>{
  const warn=$('liveWarn');
  if(document.hidden){ warn.style.display='inline-flex'; }
  else { warn.style.display='none'; /* tetikle */ if(typeof window.__liveRefresh === 'function') window.__liveRefresh(); }
});

/* === YÃ¼kleniyor gÃ¶stergesi === */
let __loading = { box:null, bar:null, pct:null, lbl:null, timer:null, softCap:85, value:0 };
function loadingStart(label='Veriler getiriliyorâ€¦', softCap=88){
  loadingEnd();
  const wrap = document.createElement('div'); wrap.className='loadbox';
  wrap.innerHTML = `
    <div class="loadrow">
      <div class="loadpct" id="ldP">0%</div>
      <div class="loadbar"><i id="ldBar"></i></div>
    </div>
    <div class="loadlbl" id="ldLbl"></div>`;
  const host = document.getElementById('outArea') || document.body;
  host.prepend(wrap);
  __loading = { box:wrap, bar:wrap.querySelector('#ldBar'), pct:wrap.querySelector('#ldP'), lbl:wrap.querySelector('#ldLbl'), timer:null, softCap, value:0 };
  __loading.lbl.textContent = label;
  __loading.timer = setInterval(()=>{ if(__loading.value < __loading.softCap) setLoading(__loading.value + 0.6); }, 90);
}
function setLoading(p){ if(!__loading.bar) return; const v=Math.max(0,Math.min(100,p)); __loading.value=v; __loading.bar.style.width=v.toFixed(0)+'%'; __loading.pct.textContent=v.toFixed(0)+'%'; }
function bumpLoading(to){ if(!__loading.bar) return; if(to>__loading.value) setLoading(to); }
function loadingLabel(t){ if(__loading.lbl) __loading.lbl.textContent=t; }
function loadingEnd(){
  if(__loading.timer){ clearInterval(__loading.timer); __loading.timer=null; }
  if(__loading.bar){ setLoading(100); }
  if(__loading.box){ const b=__loading.box; setTimeout(()=>b.remove(), 320); }
  __loading = { box:null, bar:null, pct:null, lbl:null, timer:null, softCap:85, value:0 };
}

/* === Sabitler / Pathler === */
const PATHS={ users:'kullanicilar', talebeler:'talebeler', main:'takrir takibi', byDate:'takrir takibi tarih', index:'takrir_index' };
const STAT_NONE='none', STAT_VERDI='verdi', STAT_VEREMEDI='veremedi', STAT_YARIM='yarÄ±m kaldÄ±';
function rowClassByStat(s){ if(s===STAT_VERDI) return 'st-verdi'; if(s===STAT_VEREMEDI) return 'st-veremedi'; if(s===STAT_YARIM) return 'st-yarim'; return 'st-none'; }
function canonStat(raw){
  if(!raw) return STAT_NONE;
  let t=String(raw).trim().toLowerCase().replace(/Ä°/g,'i').replace(/Ä±/g,'i').normalize('NFD').replace(/[\u0300-\u036f]/g,'');
  t=t.replace(/[.\-_,]/g,' ').replace(/\s+/g,' ').trim();
  const verdiRe=/^(ver(di|ildi)?)$|^tamam$|^ok$|^oldu$|^hazir$|^geldi$/;
  const veremediHit=/ver(emedi|medi|ilmedi)/.test(t)||/^(yok|bos|hic)$/.test(t);
  const yarimHit=/yarim kaldi|yarisi kaldi|yarilad[Ä±i]?|kismen|kismi/.test(t)||t.startsWith('yar');
  if(verdiRe.test(t)||(t.startsWith('ver')&&!t.includes('me')&&!t.includes('ilme')&&!t.includes('eme'))) return STAT_VERDI;
  if(veremediHit) return STAT_VEREMEDI;
  if(yarimHit) return STAT_YARIM;
  return STAT_NONE;
}
function toISO10(any){
  if(!any) return null;
  if(typeof any?.toDate==='function'){ try{ return any.toDate().toISOString().slice(0,10);}catch(_){ return null; } }
  const s=String(any); return /\d{4}-\d{2}-\d{2}/.test(s)? s.slice(0,10): null;
}
function daysLate(lessonDateISO10, islemAny){
  const op10 = toISO10(islemAny); if(!op10||!lessonDateISO10) return 0;
  const d0=new Date(lessonDateISO10+'T00:00:00Z'); const d1=new Date(op10+'T00:00:00Z');
  const diff=Math.floor((d1-d0)/86400000); return diff>0?diff:0;
}

/* === Data ops === */
async function ensureIndexForDevre(devre){
  const ref=db.collection(PATHS.index).doc(devre); const doc=await ref.get();
  if(!doc.exists) await ref.set({kitaplar:[]});
}
async function listKitaplar(devre){
  await ensureIndexForDevre(devre);
  const snap=await db.collection(PATHS.index).doc(devre).get();
  const arr=(snap.exists && Array.isArray(snap.data().kitaplar))? snap.data().kitaplar: [];
  return arr.sort((a,b)=>a.localeCompare(b,'tr'));
}
async function listDerslerWithMeta(devre, kitap){
  if(!kitap) return [];
  const qs=await db.collection(PATHS.main).doc(devre).collection(kitap).get();
  const rows=[]; qs.forEach(doc=>{ if(doc.id==='__meta__') return; const x=doc.data()||{}; if(x.created||x.ilkKayitISO||Object.keys(x).length){ rows.push({ad:doc.id,ilkKayitISO:x.ilkKayitISO||x.created||null}); } });
  rows.sort((a,b)=>((b.ilkKayitISO||'').localeCompare(a.ilkKayitISO||''))); return rows;
}
async function loadTalebeler(devre){
  const list=[]; const base=db.collection(PATHS.talebeler).doc(devre).collection('Ã¶ÄŸrenciler');
  const qs=await base.get(); qs.forEach(d=>{ const x=d.data()||{}; list.push({ uid:d.id, ad:x.kullAd||'â€”' }); });
  return list.sort((a,b)=>a.ad.localeCompare(b.ad,'tr'));
}
async function readStatuses({devre, kitap, ders, dersISO}){
  const tKey=(dersISO||'').slice(0,10); if(!tKey) return {};
  const col=db.collection(PATHS.byDate).doc(devre).collection(tKey);
  const qs=await col.get();
  const out={}; const dersKey=encodeURIComponent(`${kitap}__${ders}`);
  for(const d of qs.docs){
    try{
      const dersDoc=await col.doc(d.id).collection('dersler').doc(dersKey).get();
      if(dersDoc.exists){
        const x=dersDoc.data()||{}; if(x.durum){
          const iso=x.islemISO?.toDate ? x.islemISO.toDate().toISOString() : (x.islemISOStr || null);
          out[d.id]={durum:canonStat(x.durum), islemISO:iso}; continue;
        }
      }
    }catch(_){}
    const data=d.data()||{};
    if(Array.isArray(data.kayitlar)){
      const rel=data.kayitlar.filter(x=>x.kitap===kitap && x.ders===ders).sort((a,b)=>String(b.islemISOStr||'').localeCompare(String(a.islemISOStr||'')));
      if(rel[0]){ out[d.id]={durum:canonStat(rel[0].durum), islemISO:rel[0].islemISOStr||null}; continue; }
    }
  }
  return out;
}

/* === UI state === */
let __ME=''; let state={ devre:'6.Devre', kitap:'', ders:'', dersKayitISO:null, talebeler:[], durumMap:{} };
let modalCtx={ uid:null, ad:'', pre:STAT_NONE };

/* === Rapor === */
async function showRapor(){
  $('islemSection').style.display='none';
  loadingStart('Durumlar okunuyorâ€¦', 88);

  // ders baÅŸlangÄ±Ã§ ISO
  if(!state.dersKayitISO){
    try{
      const mdoc=await db.collection(PATHS.main).doc(state.devre).collection(state.kitap).doc(state.ders).get();
      const m=mdoc.exists?mdoc.data():{}; state.dersKayitISO=m.ilkKayitISO||m.created||new Date().toISOString();
    }catch(_){ state.dersKayitISO=new Date().toISOString(); }
  }

  const sabitGun=state.dersKayitISO.slice(0,10);
  $('outTitle').textContent=`Rapor â€¢ ${state.devre} â€¢ ${state.kitap} â€¢ ${state.ders} â€¢ ${sabitGun}`;

  const statuses=await readStatuses({devre:state.devre, kitap:state.kitap, ders:state.ders, dersISO:state.dersKayitISO});
  bumpLoading(55); loadingLabel('Talebeler yÃ¼kleniyorâ€¦');

  const talebeler=await loadTalebeler(state.devre);
  bumpLoading(80); loadingLabel('Ã–zet hazÄ±rlanÄ±yorâ€¦');

  const counts={verdi:0,'yarÄ±m kaldÄ±':0,veremedi:0};
  talebeler.forEach(t=>{
    const st=canonStat((statuses[t.uid]?.durum) || STAT_NONE);
    if(st===STAT_VERDI) counts.verdi++; else if(st===STAT_YARIM) counts['yarÄ±m kaldÄ±']++; else if(st===STAT_VEREMEDI) counts.veremedi++;
  });

  const wrap=document.createElement('div');

  const table=document.createElement('div'); table.className='table';
  table.innerHTML=`
    <div class="thead"><div>Durum</div><div>Adet</div><div>Oran</div></div>
    ${[['Verdi',counts.verdi],['YarÄ±m kaldÄ±',counts['yarÄ±m kaldÄ±']],['Veremedi',counts.veremedi]].map(([lbl,val])=>{
      const total=talebeler.length||1; const oran=((val/total)*100).toFixed(1)+'%';
      return `<div class="trow"><div>${lbl}</div><div>${val}</div><div>${oran}</div></div>`;
    }).join('')}
  `;
  wrap.appendChild(table);

  const list=document.createElement('div'); list.className='sList'; list.style.marginTop='10px';
  list.innerHTML=`<div class="sHead">Talebe DÃ¶kÃ¼mÃ¼<span class="tiny">Toplam: ${talebeler.length}</span></div>`;
  const body=document.createElement('div');

  const total=talebeler.length||1; const start=80, end=96;
  talebeler.forEach((t,i)=>{
    const rec=statuses[t.uid]||{}; const st=canonStat(rec.durum||STAT_NONE);
    const late=(st===STAT_VERDI)? daysLate(sabitGun, rec.islemISO):0;
    const iso10=toISO10(rec.islemISO);
    const lateInfo=(late>0&&iso10)? `<div class="tiny">! ${iso10} â€” ${late} gÃ¼n geÃ§ verdi</div>`:'';
    const row=document.createElement('div'); row.className='sRow '+rowClassByStat(st);
    row.innerHTML=`<div><div>${t.ad}</div>${lateInfo}</div><div class="statBadge">${st===STAT_NONE?'â€”':st}</div>`;
    body.appendChild(row);
    const p=start+((i+1)/total)*(end-start); bumpLoading(p);
  });
  list.appendChild(body); wrap.appendChild(list);
  $('outArea').replaceChildren(wrap);

  // canlÄ± rozet & zaman
  $('lastRef').textContent = 'âŸ³ Son yenileme: ' + nowHHMM();
  loadingEnd();
}

/* === Ä°ÅŸlem === */
async function showIslem(){
  loadingStart('Talebeler yÃ¼kleniyorâ€¦', 88);

  if(!state.dersKayitISO){
    try{
      const mdoc=await db.collection(PATHS.main).doc(state.devre).collection(state.kitap).doc(state.ders).get();
      const m=mdoc.exists?mdoc.data():{}; state.dersKayitISO=m.ilkKayitISO||m.created||new Date().toISOString();
    }catch(_){ state.dersKayitISO=new Date().toISOString(); }
  }
  const sabitGun=state.dersKayitISO.slice(0,10);
  $('outTitle').textContent=`Ä°ÅŸlem â€¢ ${state.devre} â€¢ ${state.kitap} â€¢ ${state.ders} â€¢ ${sabitGun}`;

  state.talebeler=await loadTalebeler(state.devre);
  bumpLoading(55); loadingLabel('Durumlar okunuyorâ€¦');

  state.durumMap=await readStatuses({devre:state.devre, kitap:state.kitap, ders:state.ders, dersISO:state.dersKayitISO});
  bumpLoading(80);

  renderTalebeList();
  $('islemSection').style.display='block';
  $('lastRef').textContent = 'âŸ³ Son yenileme: ' + nowHHMM();
  loadingEnd();
}

function renderTalebeList(){
  const box=$('talebeList'); box.innerHTML='';
  let rows = state.talebeler.map(t=>{
    const rec=state.durumMap[t.uid]||{durum:STAT_NONE,islemISO:null};
    const stat=canonStat(rec.durum||STAT_NONE);
    const late=(stat===STAT_VERDI)? daysLate((state.dersKayitISO||'').slice(0,10), rec.islemISO):0;
    return { uid:t.uid, ad:t.ad, stat, islemISO:rec.islemISO, late };
  });
  // Durum sÄ±rasÄ±: Veremedi, YarÄ±m, None, Verdi
  const order={ [STAT_VEREMEDI]:0, [STAT_YARIM]:1, [STAT_NONE]:2, [STAT_VERDI]:3 };
  rows.sort((a,b)=>(order[a.stat]??5)-(order[b.stat]??5) || a.ad.localeCompare(b.ad,'tr'));

  rows.forEach(r=>{
    const iso10=toISO10(r.islemISO);
    const lateInfo=(r.late>0&&iso10)? `<div class="tiny">! ${iso10} â€” ${r.late} gÃ¼n geÃ§ verdi</div>`:'';
    const row=document.createElement('div'); row.className='sRow '+rowClassByStat(r.stat);
    row.innerHTML=`<div><div>${r.ad}</div>${lateInfo}</div><div class="statBadge">${r.stat===STAT_NONE?'â€”':r.stat}</div>`;
    box.appendChild(row);
  });
}

/* === Kitap & Ders Modal (kaydÄ±rmalÄ±) === */
const kdModal=$('kdModal'), kdClose=$('kdClose');
function openKD(){ kdModal.classList.add('open'); kdModal.setAttribute('aria-hidden','false'); }
function closeKD(){ kdModal.classList.remove('open'); kdModal.setAttribute('aria-hidden','true'); }
kdClose.addEventListener('click', closeKD);
kdModal.addEventListener('click', (e)=>{ if(e.target===kdModal) closeKD(); });
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape' && kdModal.classList.contains('open')) closeKD(); });

$('btnTakvim').addEventListener('click', async ()=>{
  const devre=$('selDevre').value;
  const kitaplar=await listKitaplar(devre);
  const kHost=$('kdKitapList'), dHost=$('kdDersList');
  kHost.innerHTML=''; dHost.innerHTML='';
  let activeKitap = state.kitap || kitaplar[0] || null;

  kitaplar.forEach(k=>{
    const el=document.createElement('div'); el.className='k-item'+(k===activeKitap?' active':''); el.textContent=k;
    el.onclick=async ()=>{
      activeKitap=k;
      [...kHost.children].forEach(c=>c.classList.toggle('active', c.textContent===k));
      const dersler=await listDerslerWithMeta(devre, k);
      dHost.innerHTML = dersler.length
        ? dersler.map(d=>`<div class="d-card">${d.ad}${d.ilkKayitISO?`<div class="tiny">${d.ilkKayitISO.slice(0,10)}</div>`:''}</div>`).join('')
        : '<div class="muted">Bu kitapta ders yok.</div>';
    };
    kHost.appendChild(el);
  });

  if(activeKitap){
    const dersler=await listDerslerWithMeta(devre, activeKitap);
    dHost.innerHTML = dersler.length
      ? dersler.map(d=>`<div class="d-card">${d.ad}${d.ilkKayitISO?`<div class="tiny">${d.ilkKayitISO.slice(0,10)}</div>`:''}</div>`).join('')
      : '<div class="muted">Bu kitapta ders yok.</div>';
  }
  openKD();
});

/* === CanlÄ± akÄ±ÅŸ â€“ seÃ§imler & gÃ¶ster === */
async function refreshKitap(resetDers=true){
  const kitaplar=await listKitaplar(state.devre);
  const sel=$('selKitap');
  sel.innerHTML=`<option value="">â€” Kitap SeÃ§ â€”</option>`+kitaplar.map(k=>`<option${k===state.kitap?' selected':''}>${k}</option>`).join('');
  if(resetDers){ state.kitap=sel.value||''; await refreshDers(); }
}
async function refreshDers(){
  const dersSel=$('selDers');
  if(!state.kitap){ dersSel.innerHTML=`<option value="">â€” Ders SeÃ§ â€”</option>`; state.ders=''; return; }
  const dersler=await listDerslerWithMeta(state.devre, state.kitap);
  dersSel.innerHTML=`<option value="">â€” Ders SeÃ§ â€”</option>`+dersler.map(d=>{
    const t=d.ilkKayitISO?` (${d.ilkKayitISO.slice(0,10)})`:''; return `<option value="${d.ad}"${state.ders===d.ad?' selected':''}>${d.ad}${t}</option>`;
  }).join('');
  if(!state.ders) state.ders=dersSel.value||'';
}

/* BUG FÄ°X: mode'u her seferinde direkt radiodan oku */
$('btnGit').addEventListener('click', async ()=>{
  $('goMsg').textContent='';
  const mode = (document.querySelector('input[name="mode"]:checked')?.value)||'rapor'; // <-- kritik
  if(!state.kitap){ $('goMsg').textContent='Kitap seÃ§iniz.'; return; }
  if(!state.ders){ $('goMsg').textContent='Ders seÃ§iniz.'; return; }

  stopLiveTimer(); // her geÃ§iÅŸte temizle
  loadingStart('Veriler getiriliyorâ€¦', 88);
  try{
    if(mode==='rapor') await showRapor();
    else await showIslem();
  } finally {
    loadingEnd();
  }

  // canlÄ± otomatik yenile
  window.__liveRefresh = async ()=>{
    if(document.hidden) return;
    const m = (document.querySelector('input[name="mode"]:checked')?.value)||'rapor';
    try{ if(m==='rapor') await showRapor(); else await showIslem(); }catch(_){}
  };
  startLiveTimer(window.__liveRefresh);
});

$('selDevre').addEventListener('change', async ()=>{
  state.devre=$('selDevre').value; stopLiveTimer();
  await refreshKitap(true);
});
$('selKitap').addEventListener('change', async ()=>{
  state.kitap=$('selKitap').value||''; state.ders=''; stopLiveTimer();
  await refreshDers();
});
$('selDers').addEventListener('change', async ()=>{
  state.ders=$('selDers').value||''; state.dersKayitISO=null; stopLiveTimer();
});

/* === Auth & ilk yÃ¼k === */
try{ firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL); }catch(e){}
auth.onAuthStateChanged(async (user)=>{
  if(!user){ setTimeout(()=>{ if(!auth.currentUser) location.replace('../index.html'); },150); return; }
  try{
    // Ä°lk deÄŸerleri ata ve kitap/dersleri getir
    state.devre = $('selDevre').value;
    await refreshKitap(true);
  }catch(e){ console.error(e); toast('Veriler yÃ¼klenirken hata.'); }
});
</script>
</body>
</html>
