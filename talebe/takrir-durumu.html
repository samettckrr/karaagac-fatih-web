<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Takrir Takibi | KaraaÄŸaÃ§ Fatih</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <link rel="icon" type="image/png" href="../img/logo.png" />
  
  <!-- Ortak CSS -->
  <link rel="stylesheet" href="../css/app-shell.css" />

  <style>
    /* Sayfa-Ã¶zel stiller (app-shell.css'den sonra) */

    /* Header */
    .header-card{display:flex; justify-content:space-between; align-items:center; gap:16px; margin:16px 0}
    .header-left h2{margin:0 0 6px; font-size:18px}
    .header-right{display:flex; align-items:center; gap:10px}
    @media (max-width: 600px){
      .header-card{flex-wrap:wrap}
      .header-right{width:100%; justify-content:flex-end}
      .header-right button{font-size:13px; padding:8px 12px}
    }

    /* Controls */
    .controls-grid{
      display:grid; grid-template-columns:repeat(12,minmax(0,1fr)); gap:10px; align-items:center;
    }
    .grp{grid-column: span 6; border:1px dashed var(--stroke); border-radius:12px; padding:10px; background:var(--pill)}
    .grp .label{ font-size:12.5px; color:var(--muted); font-weight:800; margin-bottom:6px }
    .inline{ display:flex; gap:8px; flex-wrap:wrap; align-items:center }
    select, input[type="text"], input[type="date"]{
      padding:10px 12px; border:1px solid var(--stroke); border-radius:12px; background:var(--card); color:var(--text); font-size:14px;
      min-width:220px;
    }
    .cta{border:1px solid var(--stroke); background:linear-gradient(180deg,var(--brand),var(--brand2)); color:#fff; border-radius:999px; padding:10px 16px; cursor:pointer; font-weight:800; white-space:nowrap}
    .btn-ghost{border:1px solid var(--stroke); background:var(--pill); border-radius:999px; padding:10px 14px; cursor:pointer; white-space:nowrap}
    @media (max-width: 960px){
      .grp{grid-column: span 12}
      select, input[type="text"], input[type="date"]{min-width:unset; width:100%}
    }

    /* Lists & tables */
    .sList{ border:1px solid var(--stroke); border-radius:12px; overflow:hidden; background:var(--card) }
    .sHead{ background:var(--pill); padding:8px 10px; font-weight:900; display:flex; gap:10px; align-items:center; justify-content:space-between }
    .sRow{ padding:10px 12px; display:flex; align-items:center; justify-content:space-between; border-top:1px dashed var(--stroke); cursor:pointer }
    .sRow:first-child{ border-top:none }
    .statBadge{ font-size:12px; border:1px solid var(--stroke); border-radius:999px; padding:4px 8px; }
    .tiny{ font-size:11px; color:var(--muted); }

    .st-none{ background:transparent; color:var(--text) }
    .st-verdi{ background:rgba(34,197,94,.08); }
    .st-veremedi{ background:rgba(239,68,68,.12); }
    .st-yarim{ background:rgba(250,204,21,.16); }

    .table{ border:1px solid var(--stroke); border-radius:12px; overflow:hidden }
    .thead, .trow{ display:grid; grid-template-columns:1fr 120px 120px; }
    .thead div{ background:var(--pill); font-weight:900; padding:8px 10px; border-bottom:1px dashed var(--stroke) }
    .trow div{ padding:8px 10px; border-bottom:1px dashed var(--stroke) }
    .trow:last-child div{ border-bottom:none }

    /* Modal (sayfa-Ã¶zel) */
    #duzenlemeModal{
      z-index:150; /* Ayarlar modalÄ±ndan (99) daha yÃ¼ksek */
    }
    .modal-content{
      background:var(--card); border:1px solid var(--stroke); width:95%; max-width:640px;
      border-radius:16px; box-shadow:var(--shadow); padding:16px;
    }
    .modal-buttons{display:flex; justify-content:flex-end; gap:8px; margin-top:14px}

    /* Loading */
    .loadbox{border:1px dashed var(--stroke); border-radius:12px; padding:10px; background:var(--pill); margin-bottom:10px}
    .loadrow{display:flex; align-items:center; gap:10px}
    .loadbar{position:relative; flex:1; height:10px; background:var(--surface); border:1px solid var(--stroke);
      border-radius:999px; overflow:hidden}
    .loadbar > i{display:block; height:100%; width:0%; background:linear-gradient(90deg,var(--brand),var(--brand2)); transition:width .25s ease}
    .loadpct{min-width:46px; font-weight:800}
    .loadlbl{color:var(--muted); font-size:12.5px}

    /* Kitap & Ders Modal */
    #kdModal .modal-content{ max-width:880px; width:100%; max-height:80vh; overflow:auto; }
    .kd-grid{ display:grid; grid-template-columns:280px 1fr; gap:12px; }
    .kd-col{ border:1px solid var(--stroke); border-radius:10px; background:var(--pill); padding:6px; max-height:60vh; overflow:auto; }
    .kd-item{ border:1px solid transparent; border-radius:8px; padding:6px 8px; margin:4px 0; cursor:pointer; }
    .kd-item.active{border-color:var(--brand); background:rgba(56,189,248,.12);}
    @media (max-width: 720px){
      #kdModal{align-items:center; justify-content:center;}
      #kdModal .modal-content{max-height:90vh;}
      .kd-grid{grid-template-columns:1fr;}
      .kd-col{max-height:unset;}
    }

    /* Ayarlar Modal */
    #ayarlarModal .modal-content{ 
      max-width:1000px; width:95%; max-height:90vh; overflow:hidden; 
      display:flex; flex-direction:column; padding:0;
    }
    .ayarlar-modal-header{
      display:flex; justify-content:space-between; align-items:center; gap:16px;
      padding:20px 24px; border-bottom:2px solid var(--stroke);
      background:linear-gradient(135deg, var(--grad1), var(--grad2));
      position:sticky; top:0; z-index:10; backdrop-filter:blur(10px);
    }
    .ayarlar-modal-header h3{ margin:0; font-size:20px; font-weight:900; 
      background:linear-gradient(135deg, var(--brand), var(--brand2));
      -webkit-background-clip:text; -webkit-text-fill-color:transparent;
      background-clip:text;
    }
    .ayarlar-modal-body{ padding:24px; overflow-y:auto; flex:1; }
    .ayarlar-grid{ display:grid; grid-template-columns:1fr 1fr; gap:20px; margin-bottom:24px; }
    .ayarlar-section{ 
      border:1px solid var(--stroke); border-radius:16px; 
      padding:20px; background:var(--card); 
      box-shadow:0 4px 12px rgba(0,0,0,.08);
      transition:transform .2s, box-shadow .2s;
    }
    .ayarlar-section:hover{ transform:translateY(-2px); box-shadow:0 6px 16px rgba(0,0,0,.12); }
    .ayarlar-section-header{ 
      display:flex; justify-content:space-between; align-items:center; 
      margin-bottom:16px; gap:12px; padding-bottom:12px;
      border-bottom:1px solid var(--stroke);
    }
    .ayarlar-section-header h4{ 
      margin:0; font-size:17px; font-weight:800; 
      display:flex; align-items:center; gap:8px;
    }
    .ayarlar-list{ 
      max-height:420px; overflow-y:auto; min-height:120px;
      padding:4px; margin:-4px;
    }
    .ayarlar-list::-webkit-scrollbar{ width:8px; }
    .ayarlar-list::-webkit-scrollbar-track{ background:var(--pill); border-radius:4px; }
    .ayarlar-list::-webkit-scrollbar-thumb{ 
      background:var(--stroke); border-radius:4px;
      transition:background .2s;
    }
    .ayarlar-list::-webkit-scrollbar-thumb:hover{ background:var(--brand); }
    .ayarlar-item{ 
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding:14px 16px; margin-bottom:10px; border:1px solid var(--stroke);
      border-radius:12px; background:var(--pill); 
      transition:all .25s cubic-bezier(0.4, 0, 0.2, 1);
    }
    .ayarlar-item:hover{ 
      border-color:var(--brand); background:rgba(56,189,248,.12);
      transform:translateX(4px); box-shadow:0 2px 8px rgba(56,189,248,.2);
    }
    .ayarlar-item-content{ flex:1; min-width:0; }
    .ayarlar-item-name{ 
      font-weight:700; margin-bottom:6px; word-break:break-word;
      font-size:15px; color:var(--text);
    }
    .ayarlar-item-meta{ 
      font-size:12px; color:var(--muted); 
      display:flex; align-items:center; gap:8px; flex-wrap:wrap;
    }
    .ayarlar-item-actions{ display:flex; gap:8px; flex-shrink:0; }
    .ayarlar-btn{ 
      border:1px solid var(--stroke); background:var(--card); 
      border-radius:10px; padding:8px 14px; cursor:pointer; font-size:13px;
      white-space:nowrap; transition:all .2s; font-weight:600;
      display:inline-flex; align-items:center; gap:6px;
    }
    .ayarlar-btn:hover{ 
      transform:translateY(-1px); box-shadow:0 2px 6px rgba(0,0,0,.1);
    }
    .ayarlar-btn-edit{ 
      color:var(--brand); border-color:var(--brand);
    }
    .ayarlar-btn-edit:hover{ 
      background:rgba(56,189,248,.15); border-color:var(--brand2);
    }
    .ayarlar-btn-delete{ 
      color:var(--danger); border-color:var(--danger);
    }
    .ayarlar-btn-delete:hover{ 
      background:rgba(239,68,68,.15); border-color:var(--danger);
    }
    .ayarlar-edit-mode{ 
      display:flex; gap:10px; align-items:stretch; width:100%; 
      flex-wrap:wrap;
    }
    .ayarlar-edit-mode input{ 
      flex:1; min-width:200px; padding:10px 14px; 
      border:2px solid var(--brand); border-radius:10px; 
      background:var(--card); color:var(--text); font-size:14px;
      font-weight:600;
    }
    .ayarlar-edit-mode input:focus{ 
      outline:none; border-color:var(--brand2);
      box-shadow:0 0 0 3px rgba(56,189,248,.2);
    }
    .ayarlar-edit-mode .ayarlar-btn{ padding:10px 16px; }
    .ayarlar-add-form{
      margin-top:16px; padding-top:16px; border-top:2px dashed var(--stroke);
    }
    .ayarlar-add-form input{
      width:100%; padding:12px 16px; margin-bottom:10px;
      border:1px solid var(--stroke); border-radius:10px;
      background:var(--card); color:var(--text); font-size:14px;
      transition:all .2s;
    }
    .ayarlar-add-form input:focus{
      outline:none; border-color:var(--brand);
      box-shadow:0 0 0 3px rgba(56,189,248,.15);
    }
    @media (max-width: 960px){
      .ayarlar-grid{ grid-template-columns:1fr; gap:16px; }
      .ayarlar-modal-body{ padding:16px; }
      .ayarlar-section{ padding:16px; }
      .ayarlar-section-header{ flex-wrap:wrap; }
      .ayarlar-item{ flex-wrap:wrap; padding:12px; }
      .ayarlar-item-actions{ width:100%; justify-content:flex-end; }
      .ayarlar-edit-mode{ flex-direction:column; }
      .ayarlar-edit-mode input{ min-width:100%; }
    }
    @media (max-width: 600px){
      #ayarlarModal .modal-content{ max-width:98vw; max-height:95vh; }
      .ayarlar-modal-header{ padding:16px; }
      .ayarlar-modal-header h3{ font-size:18px; }
      .ayarlar-modal-body{ padding:12px; }
      .ayarlar-section{ padding:12px; }
      .ayarlar-list{ max-height:300px; }
      .ayarlar-item-name{ font-size:14px; }
      .ayarlar-btn{ padding:6px 12px; font-size:12px; }
    }
  </style>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <script src="../js/firebase/firebase-init.js"></script>
  <!-- Ortak JavaScript -->
  <script src="../js/ortak.js"></script>
</head>
<body>

<!-- APPBAR -->
<div class="appbar">
  <div class="brand" onclick="location.href='../panel.html'">
    <img src="../img/logo.png" alt="logo"><span>KARAAÄAÃ‡ FATÄ°H</span>
  </div>

  <nav class="nav-center"><ul class="nav-list" id="navMain"></ul></nav>

  <div class="nav-right">
    <button class="btn hamb" id="hamburger" title="MenÃ¼">â˜°</button>

    <div class="nav-item">
      <button class="iconbtn" id="btnNotif" title="Bildirimler">ğŸ””
        <span class="badge" id="notifBadge" style="display:none">0</span>
      </button>
      <div class="dropdown drop-right" id="notifDropdown">
        <div class="muted" style="padding:6px 8px">Son bildirimler</div>
        <div id="notifList" style="max-height:300px;overflow:auto"></div>
        <a href="../diger/bildirim.html">TÃ¼m bildirimleri gÃ¶r â†’</a>
      </div>
    </div>

    <div class="nav-item">
      <button class="iconbtn" id="btnProfile" title="Profil">
        <span class="avatar"></span> <span id="profName" class="muted">Profil</span>
      </button>
      <div class="dropdown drop-right" id="profDropdown">
        <a href="../diger/kullanici-yonetimi.html">ğŸ‘¤ Profil</a>
        <a href="../diger/sistem-ayarlari.html">âš™ï¸ Sistem AyarlarÄ±</a>
        <a href="#" id="btnLogout">ğŸšª Ã‡Ä±kÄ±ÅŸ Yap</a>
      </div>
    </div>
  </div>
</div>

<aside class="drawer" id="drawer"></aside>

<main class="container">
  <!-- HEADER -->
  <section class="card header-card">
    <div class="header-left">
      <h2>Takrir Takibi</h2>
      <div class="muted">BugÃ¼n: <span id="todayText">â€”</span></div>
    </div>
    <div class="header-right">
      <button id="btnAyarlar" class="btn-ghost" type="button" title="YÃ¶netim &amp; Ayarlar">âš™ï¸ YÃ¶netim &amp; Ayarlar</button>
    </div>
  </section>

  <!-- SEÃ‡Ä°MLER -->
  <section class="card">
    <div class="controls-grid">
      <!-- Devre -->
      <div class="grp">
        <div class="label">Devre SeÃ§</div>
        <div class="inline">
          <select id="selDevre">
            <option value="6.Devre">6.Devre</option>
            <option value="7.Devre">7.Devre</option>
            <option value="8.Devre">8.Devre</option>
          </select>
          <span class="muted">SeÃ§ili devredeki talebeler yÃ¼klenir.</span>
        </div>
      </div>

      <!-- Kitap -->
      <div class="grp">
        <div class="label">Kitap SeÃ§ / Ekle</div>
        <div class="inline">
          <select id="selKitap"><option value="">â€” Kitap SeÃ§ â€”</option></select>
          <button id="btnKitapEkleToggle" class="btn-ghost" type="button">+ Kitap</button>
        </div>
        <div id="kitapEkleWrap" class="inline" style="display:none; margin-top:8px">
          <input id="inpKitap" type="text" placeholder="Kitap adÄ±" />
          <button id="btnKitapKaydet" class="cta" type="button">Kaydet</button>
          <span id="kitapMsg" class="muted"></span>
        </div>
      </div>

      <!-- Ders -->
      <div class="grp">
        <div class="label">Ders SeÃ§ / Ekle (SeÃ§ilen kitaba baÄŸlÄ±)</div>
        <div class="inline">
          <select id="selDers"><option value="">â€” Ders SeÃ§ â€”</option></select>
          <button id="btnDersEkleToggle" class="btn-ghost" type="button">+ Ders</button>
        </div>
        <div id="dersEkleWrap" class="inline" style="display:none; margin-top:8px">
          <input id="inpDers" type="text" placeholder="Ders adÄ±" />
          <button id="btnDersKaydet" class="cta" type="button">Kaydet</button>
          <span id="dersMsg" class="muted"></span>
        </div>
      </div>

      <!-- Talebe -->
      <div class="grp">
        <div class="label">Talebe SeÃ§ (Talebe GÃ¶rÃ¼nÃ¼mÃ¼ iÃ§in)</div>
        <div class="inline">
          <select id="selTalebe"><option value="">â€” Talebe SeÃ§ â€”</option></select>
          <span class="muted">Talebe seÃ§ildiÄŸinde, o talebenin tÃ¼m dersleri gÃ¶sterilir.</span>
        </div>
      </div>

      <!-- Rapor / Ä°ÅŸlem -->
      <div class="grp">
        <div class="label">Rapor / Ä°ÅŸlem</div>
        <div class="inline">
          <label><input type="radio" name="mode" value="rapor" checked> Rapor GÃ¶r</label>
          <label><input type="radio" name="mode" value="islem"> Ä°ÅŸlem Yap</label>
          <label><input type="radio" name="mode" value="talebe"> Talebe GÃ¶rÃ¼nÃ¼mÃ¼</label>
          <button id="btnGit" class="cta" type="button">GÃ¶ster</button>
          <button id="btnTakvim" class="btn-ghost" type="button">Kitap &amp; Ders GÃ¶r</button>
          <span id="goMsg" class="muted"></span>
        </div>
      </div>
    </div>
  </section>

  <!-- Ã‡IKTI -->
  <section class="card">
    <div class="sHead">
      <div id="outTitle">â€”</div>
      <div id="subInfo" class="tiny">â€”</div>
    </div>
    <div id="outArea" style="margin-top:10px"></div>
  </section>

  <!-- Ä°ÅLEM: Talebe Listesi -->
  <section id="islemSection" class="card" style="display:none">
    <div class="sList">
      <div class="sHead">
        <div>Talebeler</div>
        <div class="inline">
          <label for="selSort" class="tiny">SÄ±rala:</label>
          <select id="selSort">
            <option value="alpha">Alfabetik (Aâ†’Z)</option>
            <option value="status">Duruma gÃ¶re</option>
          </select>
          <button id="btnListeYenile" class="btn-ghost" type="button">Yenile</button>
        </div>
      </div>
      <div id="talebeList"></div>
    </div>
  </section>
</main>

<!-- Ä°ÅLEM MODAL -->
<div class="modal" id="mModal">
  <div class="modal-content">
    <h3 id="mHead">â€”</h3>
    <label><input type="radio" name="mStat" value="verdi"> Verdi</label>
    <label><input type="radio" name="mStat" value="veremedi"> Veremedi</label>
    <label><input type="radio" name="mStat" value="yarÄ±m kaldÄ±"> YarÄ±m kaldÄ±</label>
    <div class="modal-buttons">
      <button class="btn-ghost" id="mCancel">Kapat</button>
      <button class="cta" id="mSave">Kaydet</button>
    </div>
  </div>
</div>

<!-- RAPOR TALEBE MODAL -->
<div class="modal" id="raporTalebeModal">
  <div class="modal-content" id="raporTalebeContent"></div>
</div>

<!-- KÄ°TAP & DERS MODAL -->
<div class="modal" id="kdModal">
  <div class="modal-content">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:10px">
      <h3>Kitap &amp; Ders Listesi</h3>
      <button class="btn-ghost" id="kdClose">Kapat</button>
    </div>
    <div class="kd-grid">
      <div id="kdKitapList" class="kd-col"></div>
      <div id="kdDersList" class="kd-col"></div>
    </div>
  </div>
</div>

<!-- DÃœZENLEME MODAL -->
<div class="modal" id="duzenlemeModal">
  <div class="modal-content" style="max-width:500px">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:16px; padding-bottom:12px; border-bottom:1px solid var(--stroke)">
      <h3 id="duzenlemeTitle" style="margin:0">DÃ¼zenle</h3>
      <button type="button" class="btn-ghost" id="duzenlemeClose" style="padding:8px 14px">âœ• Kapat</button>
    </div>
    <div id="duzenlemeBody" style="padding:8px 0">
      <label style="display:block; margin-bottom:8px; font-weight:600; color:var(--muted); font-size:13px" id="duzenlemeLabel">Ä°sim</label>
      <input type="text" id="duzenlemeInput" style="width:100%; padding:12px 16px; border:2px solid var(--stroke); border-radius:10px; background:var(--card); color:var(--text); font-size:15px; font-weight:600; margin-bottom:16px" />
      <div id="duzenlemeMeta" style="padding:12px; background:var(--pill); border-radius:10px; margin-bottom:16px; font-size:13px; color:var(--muted)"></div>
      <div style="display:flex; gap:10px; justify-content:flex-end">
        <button type="button" class="btn-ghost" id="duzenlemeCancel">Ä°ptal</button>
        <button type="button" class="cta" id="duzenlemeSave">ğŸ’¾ Kaydet</button>
      </div>
    </div>
  </div>
</div>

<!-- AYARLAR MODAL -->
<div class="modal" id="ayarlarModal">
  <div class="modal-content">
    <div class="ayarlar-modal-header">
      <h3>âš™ï¸ YÃ¶netim &amp; Ayarlar</h3>
      <button type="button" class="btn-ghost" id="ayarlarClose" style="padding:8px 14px">âœ• Kapat</button>
    </div>
    
    <div class="ayarlar-modal-body">
      <div class="ayarlar-grid">
        <!-- KÄ°TAP YÃ–NETÄ°MÄ° -->
        <div class="ayarlar-section">
          <div class="ayarlar-section-header">
            <h4>ğŸ“š Kitap YÃ¶netimi</h4>
            <button type="button" id="ayarlarKitapYenile" class="btn-ghost" style="font-size:12px; padding:6px 12px">ğŸ”„ Yenile</button>
          </div>
          <div id="ayarlarKitapList" class="ayarlar-list"></div>
          <div id="ayarlarKitapEkle" class="ayarlar-add-form">
            <input id="ayarlarInpKitap" type="text" placeholder="Yeni kitap adÄ± giriniz..." />
            <button type="button" id="ayarlarBtnKitapEkle" class="cta" style="width:100%">â• Kitap Ekle</button>
          </div>
        </div>

        <!-- DERS YÃ–NETÄ°MÄ° -->
        <div class="ayarlar-section">
          <div class="ayarlar-section-header">
            <h4>ğŸ“– Ders YÃ¶netimi</h4>
            <select id="ayarlarSelKitap" style="min-width:180px; font-size:13px; padding:8px 12px; border:1px solid var(--stroke); border-radius:10px; background:var(--card); color:var(--text)">
              <option value="">Kitap seÃ§iniz</option>
            </select>
          </div>
          <div id="ayarlarDersList" class="ayarlar-list">
            <div class="muted" style="padding:20px; text-align:center; font-size:14px">ğŸ“‹ Ã–nce bir kitap seÃ§iniz</div>
          </div>
          <div id="ayarlarDersEkle" class="ayarlar-add-form" style="display:none">
            <input id="ayarlarInpDers" type="text" placeholder="Yeni ders adÄ± giriniz..." />
            <button type="button" id="ayarlarBtnDersEkle" class="cta" style="width:100%">â• Ders Ekle</button>
          </div>
        </div>
      </div>

      <!-- DÄ°ÄER AYARLAR -->
      <div class="ayarlar-section">
        <div class="ayarlar-section-header">
          <h4>âš™ï¸ DiÄŸer Ayarlar</h4>
        </div>
        <div style="padding:16px; color:var(--muted); font-size:14px; text-align:center; border:2px dashed var(--stroke); border-radius:12px; background:var(--pill)">
          <p style="margin:0">ğŸ”® Ek ayarlar buraya eklenecek...</p>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Toast Container (modern sistem) -->
<div class="toast-container" id="toastContainer"></div>

<script>
  /* === Tarih === */
  (function(){
    const d=new Date();
    const days=['Pazar','Pazartesi','SalÄ±','Ã‡arÅŸamba','PerÅŸembe','Cuma','Cumartesi'];
    document.getElementById('todayText').textContent=`${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()} â€¢ ${days[d.getDay()]}`;
  })();

  /* Firebase & helpers - ortak.js'den geliyor */
  // db ve auth ortak.js'den geliyor (window.db, window.auth)
  // Ortak.js'de zaten tanÄ±mlanmÄ±ÅŸ, bu yÃ¼zden window'dan kullan
  // EÄŸer window.db ve window.auth yoksa, burada tanÄ±mla
  if(typeof window.db === 'undefined'){
    window.db = firebase.firestore();
  }
  if(typeof window.auth === 'undefined'){
    window.auth = firebase.auth();
  }
  // Referans al - ortak.js'de const db tanÄ±mlanmÄ±ÅŸ (local scope), bu yÃ¼zden burada da tanÄ±mlayabiliriz
  // Ama Ã§akÄ±ÅŸmayÄ± Ã¶nlemek iÃ§in window'dan direkt kullan
  const db = window.db;
  const auth = window.auth;
  try{
    // Settings'i sadece bir kez ayarla (firebase-init.js'de zaten ayarlanmÄ±ÅŸ olabilir)
    if(!db._settingsApplied){
      db.settings({ cacheSizeBytes: firebase.firestore.CACHE_SIZE_UNLIMITED }, { merge: true });
      db._settingsApplied = true;
    }
    // Persistence'Ä± sessizce etkinleÅŸtir (deprecated uyarÄ±sÄ± gelecekte kaldÄ±rÄ±lacak)
    db.enablePersistence({ synchronizeTabs: true }).catch(()=>{ /* ignore */ });
  }catch(_){}
  const $=(id)=>document.getElementById(id);
  // Toast fonksiyonu ortak.js'den geliyor (window.showToast)
  // Geriye uyumluluk iÃ§in eski toast fonksiyonu
  function toast(msg){ 
    if(typeof window.showToast === 'function'){
      window.showToast('info', 'Bilgi', msg);
    } else {
      console.log('Toast:', msg);
    }
  }

  const PATHS={ users:'kullanicilar', manifest:'sayfa_manifesti', talebeler:'talebeler', main:'takrir takibi', byDate:'takrir takibi tarih', index:'takrir_index' };

  const STAT_NONE='none', STAT_VERDI='verdi', STAT_VEREMEDI='veremedi', STAT_YARIM='yarÄ±m kaldÄ±';
  // norm fonksiyonu ortak.js'den geliyor (window.norm) - zaten tanÄ±mlÄ±, tekrar tanÄ±mlamaya gerek yok
  // const norm zaten ortak.js'de tanÄ±mlÄ±, direkt window.norm kullanabiliriz veya referans alabiliriz

  function rowClassByStat(s){
    if(s===STAT_VERDI) return 'st-verdi';
    if(s===STAT_VEREMEDI) return 'st-veremedi';
    if(s===STAT_YARIM) return 'st-yarim';
    return 'st-none';
  }
  function canonStat(raw){
    if(!raw) return STAT_NONE;
    let t = String(raw).trim().toLowerCase();
    t = t.replace(/Ä°/g,'i').replace(/Ä±/g,'i')
        .normalize('NFD').replace(/[\u0300-\u036f]/g,'');
    t = t.replace(/[.\-_,]/g,' ').replace(/\s+/g,' ').trim();

    const verdiRe = /^(ver(di|ildi)?)$|^tamam$|^ok$|^oldu$|^hazir$|^geldi$/;
    const veremediHit = /ver(emedi|medi|ilmedi)/.test(t) || /^(yok|bos|hic)$/.test(t);
    const yarimHit = /yarim kaldi|yarisi kaldi|yarilad[Ä±i]?|kismen|kismi/.test(t) || t.startsWith('yar');

    if (verdiRe.test(t) || (t.startsWith('ver') && !t.includes('me') && !t.includes('ilme') && !t.includes('eme'))) {
      return STAT_VERDI;
    }
    if (veremediHit) return STAT_VEREMEDI;
    if (yarimHit) return STAT_YARIM;
    return STAT_NONE;
  }
  function toISO10(any){
    if(!any) return null;
    if(typeof any?.toDate === 'function'){ try{ return any.toDate().toISOString().slice(0,10);}catch(_){ return null; } }
    const s=String(any); return /\d{4}-\d{2}-\d{2}/.test(s)? s.slice(0,10): null;
  }
  function daysLate(lessonDateISO10, islemAny){
    const op10 = toISO10(islemAny);
    if(!op10 || !lessonDateISO10) return 0;
    const d0 = new Date(lessonDateISO10 + 'T00:00:00Z');
    const d1 = new Date(op10 + 'T00:00:00Z');
    const diff = Math.floor((d1 - d0) / 86400000);
    return diff > 0 ? diff : 0;
  }

  /* Loading bar */
  let __loading = { box:null, bar:null, pct:null, lbl:null, timer:null, softCap:85, value:0 };
  function loadingStart(label='Veriler getiriliyorâ€¦', softCap=85){
    loadingEnd();
    const wrap = document.createElement('div'); wrap.className='loadbox';
    wrap.innerHTML = `
      <div class="loadrow">
        <div class="loadpct" id="ldP">0%</div>
        <div class="loadbar"><i id="ldBar"></i></div>
      </div>
      <div class="loadlbl" id="ldLbl"></div>`;
    const host = document.getElementById('outArea') || document.body;
    host.prepend(wrap);
    __loading = { box:wrap, bar:wrap.querySelector('#ldBar'), pct:wrap.querySelector('#ldP'), lbl:wrap.querySelector('#ldLbl'), timer:null, softCap, value:0 };
    __loading.lbl.textContent = label;
    __loading.timer = setInterval(()=>{ if(__loading.value < __loading.softCap){ setLoading(Math.min(__loading.softCap, __loading.value + 0.6)); } }, 90);
  }
  function setLoading(p){ if(!__loading.bar) return; const v=Math.max(0,Math.min(100,p)); __loading.value=v; __loading.bar.style.width=v.toFixed(0)+'%'; __loading.pct.textContent=v.toFixed(0)+'%'; }
  function bumpLoading(to){ if(!__loading.bar) return; if(to>__loading.value) setLoading(to); }
  function loadingLabel(t){ if(__loading.lbl) __loading.lbl.textContent=t; }
  function loadingEnd(){ if(__loading.timer){ clearInterval(__loading.timer); __loading.timer=null; } if(__loading.bar){ setLoading(100);} if(__loading.box){ const b=__loading.box; setTimeout(()=>b.remove(),350);} __loading={ box:null, bar:null, pct:null, lbl:null, timer:null, softCap:85, value:0 }; }

async function startRealtimeListener() {
  if (!state.kitap || !state.ders) return () => {};
  const dersKey = encodeURIComponent(`${state.kitap}__${state.ders}`);
  const dersDay = (state.dersKayitISO || new Date().toISOString()).slice(0,10);
  const colRef  = db.collection(PATHS.byDate).doc(state.devre).collection(dersDay);

  return colRef.onSnapshot(async (snapshot) => {
    // alt belgeleri paralel oku
    const tasks = snapshot.docChanges().map(async (change) => {
      // silinmiÅŸse/parent kaldÄ±rÄ±lmÄ±ÅŸsa boÅŸalt
      if (change.type === 'removed') {
        const uid = change.doc.id;
        if (state.durumMap[uid]) state.durumMap[uid] = { durum: STAT_NONE, islemISO: null, personel: 'â€”' };
        return;
      }

      const dersDoc = await change.doc.ref.collection('dersler').doc(dersKey).get();
      if (!dersDoc.exists) return;
      const x   = dersDoc.data() || {};
      const uid = change.doc.id;

      state.durumMap[uid] = {
        durum:   canonStat(x.durum),
        personel:x.personel,
        islemISO:x.islemISO?.toDate ? x.islemISO.toDate().toISOString() : null
      };
    });

    await Promise.all(tasks);
    renderTalebeListDebounced();
  });
}

  /* Index & data ops */
  async function ensureIndexForDevre(devre){
    const ref = db.collection(PATHS.index).doc(devre);
    const doc = await ref.get();
    if(!doc.exists) await ref.set({ kitaplar: [] });
  }
  async function listKitaplar(devre){
    await ensureIndexForDevre(devre);
    const snap = await db.collection(PATHS.index).doc(devre).get();
    const arr = (snap.exists && Array.isArray(snap.data().kitaplar)) ? snap.data().kitaplar : [];
    return arr.sort((a,b)=>a.localeCompare(b,'tr'));
  }

let __ME  = '';      // oturum adÄ± buraya yazÄ±lacak
let __UID = null;    // uid buraya yazÄ±lacak

async function getAuthUserSafe(){
  // auth.currentUser yoksa kÄ±sa sÃ¼re bekleyip tekrar dene
  if (firebase.auth().currentUser) return firebase.auth().currentUser;

  await new Promise(r => setTimeout(r, 60));
  if (firebase.auth().currentUser) return firebase.auth().currentUser;

  // yine yoksa bir kez daha dene
  await new Promise(r => setTimeout(r, 120));
  return firebase.auth().currentUser || null;
}

async function ensureUserCtx(){
  const u = await getAuthUserSafe();
  if (!u) throw new Error('no-auth');

  // UID
  __UID = u.uid;

  // Ä°sim Ã¶ncelik: kullanicilar/{uid}.adSoyad -> displayName -> mail prefix -> 'â€”'
  if (!__ME) {
    try {
      const snap = await db.collection('kullanicilar').doc(u.uid).get();
      const d = snap.exists ? (snap.data() || {}) : {};
      __ME = (d.adSoyad && String(d.adSoyad).trim())
         || (u.displayName && String(u.displayName).trim())
         || (u.email ? String(u.email).split('@')[0] : '')
         || 'â€”';
    } catch (_) {
      __ME = (u.displayName && String(u.displayName).trim())
         || (u.email ? String(u.email).split('@')[0] : '')
         || 'â€”';
    }
  }
  return { uid: __UID, name: __ME };
}

// Cihaz bilgisi
function getDeviceInfo(){
  const nav = window.navigator || {};
  const ua  = nav.userAgent || '';
  const plt = nav.platform || '';
  const lng = nav.language || nav.userLanguage || '';
  const scr = (window.screen ? `${screen.width}x${screen.height}` : '');
  return `${ua} | ${plt} | ${lng} | ${scr}`;
}

// --- GÃœNCELLE: addKitap ---
async function addKitap(devre, kitap){
  if (!kitap) return;
  const { uid, name } = await ensureUserCtx();   // <-- kritik
  const nowISO = new Date().toISOString();
  const device = getDeviceInfo();

  // index
  await ensureIndexForDevre(devre);
  await db.collection(PATHS.index).doc(devre)
    .set({
      kitaplar: firebase.firestore.FieldValue.arrayUnion(kitap),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge:true });

  // mÃ¼fredat meta
  await db.collection(PATHS.main).doc(devre).collection(kitap).doc('_meta')
    .set({
      created: nowISO,                 // geriye uyum
      createdClientISO: nowISO,
      createdServerTS: firebase.firestore.FieldValue.serverTimestamp(),
      createdBy: name,                 // <-- oturum adÄ±
      createdUid: uid,                 // <-- oturum uid
      createdDevice: device
    }, { merge:true });
}
  async function listDerslerWithMeta(devre, kitap){
    if(!kitap) return [];
    const qs = await db.collection(PATHS.main).doc(devre).collection(kitap).get();
    const rows=[];
    qs.forEach(doc=>{
      if(doc.id==='_meta') return;
      const x=doc.data()||{};
      if(x.created || x.ilkKayitISO || Object.keys(x).length){
        rows.push({ad:doc.id, ilkKayitISO:x.ilkKayitISO||x.created||null, ilkKayitBy:x.ilkKayitBy||null});
      }
    });
    rows.sort((a,b)=>((b.ilkKayitISO||'').localeCompare(a.ilkKayitISO||'')));
    return rows;
  }
// --- GÃœNCELLE: addDers ---
async function addDers(devre, kitap, ders){
  if (!ders) return;
  const { uid, name } = await ensureUserCtx();   // <-- kritik
  const nowISO = new Date().toISOString();
  const device = getDeviceInfo();

  // index/ders
  await db.collection(PATHS.index).doc(devre)
    .collection('dersler').doc(kitap)
    .set({
      dersler: firebase.firestore.FieldValue.arrayUnion(ders),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp()
    }, { merge:true });

  // ders dokÃ¼manÄ±
  await db.collection(PATHS.main).doc(devre).collection(kitap).doc(ders)
    .set({
      created: nowISO,
      ilkKayitISO: nowISO,
      ilkKayitBy: name,                // <-- oturum adÄ±
      createdClientISO: nowISO,
      createdServerTS: firebase.firestore.FieldValue.serverTimestamp(),
      createdBy: name,                 // aynÄ± deÄŸeri ayrÄ±ca tut
      createdUid: uid,                 // <-- oturum uid
      createdDevice: device
    }, { merge:true });

  state.dersKayitISO = nowISO;
}

  async function loadTalebeler(devre){
    const list=[]; const base=db.collection(PATHS.talebeler).doc(devre).collection('Ã¶ÄŸrenciler');
    const qs=await base.get();
    qs.forEach(d=>{ const x=d.data()||{}; list.push({ uid:d.id, ad:x.kullAd||'â€”' }); });
    return list.sort((a,b)=>a.ad.localeCompare(b.ad,'tr'));
  }
async function writeStatusFast({devre, kitap, ders, uid, durum, personel, personelUid, device, dersGun}) {
  if(!devre || !kitap || !ders || !uid) throw new Error('invalid-params');

  const dersDay = (/^\d{4}-\d{2}-\d{2}$/.test(dersGun) ? dersGun : new Date().toLocaleDateString('sv-SE'));
  const opDay   = new Date().toLocaleDateString('sv-SE');
  const dersKey = encodeURIComponent(`${kitap}__${ders}`);
  const nowISOClient = new Date().toISOString();

  const batch = db.batch();

  // 1) ana doc
  const mainRef = db.collection(PATHS.main).doc(devre).collection(kitap).doc(ders)
    .collection('talebeler').doc(uid);
  batch.set(mainRef, {
    durum, personel,
    ...(personelUid ? { personelUid } : {}),
    ...(device ? { device } : {}),
    dersGunu: dersDay,
    islemISO: firebase.firestore.FieldValue.serverTimestamp()
  }, { merge:true });

  // 2) tarih / dersGÃ¼nÃ¼ / uid
  const byDateDocLesson = db.collection(PATHS.byDate).doc(devre).collection(dersDay).doc(uid);
  batch.set(byDateDocLesson, {
    _exists:true,
    kayitlar: firebase.firestore.FieldValue.arrayUnion({
      kitap, ders, durum, personel,
      ...(personelUid ? { personelUid } : {}),
      ...(device ? { device } : {}),
      islemISOStr: nowISOClient
    })
  }, { merge:true });

  // 2a) alt dersler
  const byDateLessonRef = byDateDocLesson.collection('dersler').doc(dersKey);
  batch.set(byDateLessonRef, {
    kitap, ders, durum, personel,
    ...(personelUid ? { personelUid } : {}),
    ...(device ? { device } : {}),
    dersGun: dersDay,
    islemISO: firebase.firestore.FieldValue.serverTimestamp()
  }, { merge:true });

  // 3) iÅŸlem gÃ¼nÃ¼ / uid / dersler/{dersKey}
  const byDateDocOp = db.collection(PATHS.byDate).doc(devre).collection(opDay).doc(uid);
  batch.set(byDateDocOp, {_exists:true}, { merge:true });

  const byDateOpRef = byDateDocOp.collection('dersler').doc(dersKey);
  batch.set(byDateOpRef, {
    kitap, ders, durum, personel,
    ...(personelUid ? { personelUid } : {}),
    ...(device ? { device } : {}),
    dersGun: dersDay,
    opGun: opDay,
    islemISO: firebase.firestore.FieldValue.serverTimestamp()
  }, { merge:true });

  await batch.commit();

  // UI iÃ§in hemen dÃ¶ndÃ¼r (serverTimestampâ€™i bekletme)
  return { dersDay, opDay, dersKey, islemISOClient: nowISOClient };
}

  async function readStatuses({devre, kitap, ders, dersISO}){
    const tKey = (dersISO||'').slice(0,10); if(!tKey) return {};
    const col = db.collection(PATHS.byDate).doc(devre).collection(tKey);
    const qs = await col.get();

    const out={}; const dersKey=encodeURIComponent(`${kitap}__${ders}`);
    for (const d of qs.docs){
      const data=d.data()||{};
      try{
        const dersDoc=await col.doc(d.id).collection('dersler').doc(dersKey).get();
        if(dersDoc.exists){
          const x=dersDoc.data()||{};
          if(x.durum){
            const iso = x.islemISO?.toDate ? x.islemISO.toDate().toISOString() : (x.islemISOStr || null);
            out[d.id] = {durum:canonStat(x.durum), islemISO:iso, personel:x.personel||'â€”'};
            continue;
          }
        }
      }catch(_){}
      if(Array.isArray(data.kayitlar)){
        const relevant=data.kayitlar.filter(x=>x.kitap===kitap && x.ders===ders).sort((a,b)=>(String(b.islemISOStr||'').localeCompare(String(a.islemISOStr||''))));
        if(relevant[0]){ out[d.id] = {durum:canonStat(relevant[0].durum), islemISO:relevant[0].islemISOStr||null, personel:relevant[0].personel||'â€”'}; continue; }
      }
      const mapKey=`${kitap} | ${ders}`;
      if(data[mapKey]?.durum){ out[d.id] = {durum:canonStat(data[mapKey].durum), islemISO:data[mapKey].islemISO||null, personel:data[mapKey].personel||'â€”'}; }
    }
    return out;
  }

  // Bir talebe iÃ§in bir kitaptaki tÃ¼m derslerin durumlarÄ±nÄ± oku
  async function readTalebeStatuses({devre, kitap, talebeUid}){
    if(!devre || !kitap || !talebeUid) return {};
    const out = {};
    
    // Kitaptaki tÃ¼m dersleri al
    const dersler = await listDerslerWithMeta(devre, kitap);
    const dersKeyMap = {}; // dersKey -> ders adÄ± mapping
    
    // TÃ¼m derslerin kayÄ±t tarihlerini topla
    const tarihler = new Set();
    dersler.forEach(dersItem => {
      const ders = dersItem.ad;
      const dersKey = encodeURIComponent(`${kitap}__${ders}`);
      dersKeyMap[dersKey] = ders;
      const dersGun = (dersItem.ilkKayitISO || new Date().toISOString()).slice(0,10);
      tarihler.add(dersGun);
    });
    
    // BugÃ¼n de ekle (iÅŸlem gÃ¼nÃ¼ kayÄ±tlarÄ± iÃ§in)
    tarihler.add(new Date().toISOString().slice(0,10));
    
    // TÃ¼m ilgili tarihlerdeki kayÄ±tlarÄ± topla
    const allRecords = [];
    for(const dateStr of tarihler){
      try{
        const dateDoc = await db.collection(PATHS.byDate).doc(devre).collection(dateStr).doc(talebeUid).get();
        if(dateDoc.exists){
          // dersler alt koleksiyonundan oku
          const derslerSnap = await dateDoc.ref.collection('dersler').get();
          derslerSnap.forEach(dersDoc => {
            const dersKey = dersDoc.id;
            if(dersKeyMap[dersKey]){
              const x = dersDoc.data() || {};
              if(x.kitap === kitap && x.ders){
                allRecords.push({
                  ders: x.ders,
                  dersKey,
                  durum: x.durum,
                  islemISO: x.islemISO?.toDate ? x.islemISO.toDate().toISOString() : (x.islemISOStr || null),
                  personel: x.personel || 'â€”',
                  dersGun: x.dersGun || dateStr,
                  dateStr
                });
              }
            }
          });
          
          // kayitlar array'inden de oku (eski format desteÄŸi)
          const data = dateDoc.data() || {};
          if(Array.isArray(data.kayitlar)){
            data.kayitlar.forEach(kayit => {
              if(kayit.kitap === kitap && kayit.ders && dersler.some(d => d.ad === kayit.ders)){
                allRecords.push({
                  ders: kayit.ders,
                  dersKey: encodeURIComponent(`${kitap}__${kayit.ders}`),
                  durum: kayit.durum,
                  islemISO: kayit.islemISOStr || null,
                  personel: kayit.personel || 'â€”',
                  dersGun: dateStr,
                  dateStr
                });
              }
            });
          }
        }
      }catch(e){
        console.warn(`Tarih ${dateStr} iÃ§in hata:`, e);
      }
    }
    
    // Her ders iÃ§in en son kaydÄ± bul
    dersler.forEach(dersItem => {
      const ders = dersItem.ad;
      const dersGun = (dersItem.ilkKayitISO || new Date().toISOString()).slice(0,10);
      
      // Bu derse ait kayÄ±tlarÄ± bul ve en son olanÄ± seÃ§
      const dersRecords = allRecords
        .filter(r => r.ders === ders)
        .sort((a,b) => {
          // Ã–nce ders gÃ¼nÃ¼ne gÃ¶re (en yeni ders gÃ¼nÃ¼ Ã¶nce)
          const dateCompare = (b.dersGun || '').localeCompare(a.dersGun || '');
          if(dateCompare !== 0) return dateCompare;
          // Sonra iÅŸlem tarihine gÃ¶re (en yeni iÅŸlem Ã¶nce)
          return (b.islemISO || '').localeCompare(a.islemISO || '');
        });
      
      if(dersRecords.length > 0){
        const latest = dersRecords[0];
        out[ders] = {
          durum: canonStat(latest.durum),
          islemISO: latest.islemISO,
          personel: latest.personel,
          dersGun: latest.dersGun || dersGun
        };
      } else {
        // HiÃ§ kayÄ±t yok
        out[ders] = {
          durum: STAT_NONE,
          islemISO: null,
          personel: 'â€”',
          dersGun: dersGun
        };
      }
    });
    
    return out;
  }

  /* UI state */
  let state={ devre:'6.Devre', kitap:'', ders:'', talebeUid:'', talebeAd:'', dersKayitISO:null, mode:'rapor', talebeler:[], durumMap:{}, talebeDersDurumMap:{} };
  let modalCtx={ uid:null, ad:'', pre:STAT_NONE, ders:'' };

  function clearOutput(){ $('outArea').innerHTML=''; $('outTitle').textContent='â€”'; $('islemSection').style.display='none'; }

  async function refreshKitap(resetDers=true){
    const kitaplar=await listKitaplar(state.devre);
    const sel=$('selKitap');
    sel.innerHTML=`<option value="">â€” Kitap SeÃ§ â€”</option>`+kitaplar.map(k=>`<option${k===state.kitap?' selected':''}>${k}</option>`).join('');
    if(resetDers){ state.kitap=sel.value||''; await refreshDers(); }
  }
  async function refreshDers(){
    const dersSel=$('selDers');
    if(!state.kitap){ dersSel.innerHTML=`<option value="">â€” Ders SeÃ§ â€”</option>`; state.ders=''; return; }
    const dersler=await listDerslerWithMeta(state.devre, state.kitap);
    dersSel.innerHTML=`<option value="">â€” Ders SeÃ§ â€”</option>`+dersler.map(d=>{
      const t=d.ilkKayitISO?` (${d.ilkKayitISO.slice(0,10)})`:''; return `<option value="${d.ad}"${state.ders===d.ad?' selected':''}>${d.ad}${t}</option>`;
    }).join('');
    if(!state.ders) state.ders=dersSel.value||'';
  }
  async function refreshTalebe(){
    const talebeSel=$('selTalebe');
    const talebeler=await loadTalebeler(state.devre);
    talebeSel.innerHTML=`<option value="">â€” Talebe SeÃ§ â€”</option>`+talebeler.map(t=>`<option value="${t.uid}"${state.talebeUid===t.uid?' selected':''}>${t.ad}</option>`).join('');
    if(state.talebeUid){
      const selectedTalebe=talebeler.find(t=>t.uid===state.talebeUid);
      if(selectedTalebe) state.talebeAd=selectedTalebe.ad;
    }
  }

  function buildSummaryHTML(counts, total){
    return `
      <div class="table" id="summaryTable">
        <div class="thead"><div>Durum</div><div>Adet</div><div>Oran</div></div>
        ${[['Verdi',counts.verdi],['YarÄ±m kaldÄ±',counts['yarÄ±m kaldÄ±']],['Veremedi',counts.veremedi]]
          .map(([lbl,val])=>{
            const oran=((val/(total||1))*100).toFixed(1)+'%';
            return `<div class="trow" data-status="${lbl.toLowerCase().replace(' ','-')}"><div>${lbl}</div><div id="count-${lbl.toLowerCase().replace(' ','-')}">${val}</div><div id="ratio-${lbl.toLowerCase().replace(' ','-')}">${oran}</div></div>`;
          }).join('')}
      </div>`;
  }
  
  // Ã–zet istatistiklerini gÃ¼ncelle
  function updateSummary(counts, total){
    const summaryTable = document.getElementById('summaryTable');
    if(!summaryTable) return;
    
    [['Verdi',counts.verdi],['YarÄ±m kaldÄ±',counts['yarÄ±m kaldÄ±']],['Veremedi',counts.veremedi]].forEach(([lbl,val])=>{
      const key = lbl.toLowerCase().replace(' ','-');
      const countEl = document.getElementById(`count-${key}`);
      const ratioEl = document.getElementById(`ratio-${key}`);
      if(countEl) countEl.textContent = val;
      if(ratioEl) ratioEl.textContent = ((val/(total||1))*100).toFixed(1)+'%';
    });
  }
  
  // Rapor modunda tek bir talebe satÄ±rÄ±nÄ± gÃ¼ncelle
  function updateRaporRow(uid, ad, status, personel, islemISO, dersGun){
    const row = document.querySelector(`[data-uid="${uid}"]`);
    if(!row) return;
    
    const st = canonStat(status || STAT_NONE);
    const late = (st===STAT_VERDI) ? daysLate(dersGun, islemISO) : 0;
    const iso10 = toISO10(islemISO);
    const lateInfo = (late>0&&iso10) ? `<div class="tiny">! ${iso10} â€” ${late} gÃ¼n geÃ§ verdi</div>` : '';
    const personelInfo = personel ? `<div class="tiny">ğŸ‘¤ ${personel}</div>` : '';
    
    row.className = 'sRow ' + rowClassByStat(st);
    row.innerHTML = `<div><div>${ad}</div>${lateInfo}${personelInfo}</div><div class="statBadge">${st===STAT_NONE?'â€”':st}</div>`;
    row.onclick = () => openRaporTalebeModal({ ad, durum:st, personel:personel||'â€”', dersGun, islemISO:islemISO||null, gecikme:late });
  }
  
  // Talebe gÃ¶rÃ¼nÃ¼mÃ¼nde tek bir ders satÄ±rÄ±nÄ± gÃ¼ncelle
  function updateTalebeDersRow(ders, dersItem, rec){
    const row = document.querySelector(`[data-ders="${ders}"]`);
    if(!row) return;
    
    const st = canonStat(rec.durum || STAT_NONE);
    const late = (st === STAT_VERDI && rec.dersGun) ? daysLate(rec.dersGun, rec.islemISO) : 0;
    const iso10 = toISO10(rec.islemISO);
    const lateInfo = (late > 0 && iso10) ? `<div class="tiny">! ${iso10} â€” ${late} gÃ¼n geÃ§ verdi</div>` : '';
    const personelInfo = rec.personel && rec.personel !== 'â€”' ? `<div class="tiny">ğŸ‘¤ ${rec.personel}</div>` : '';
    const dersGunInfo = rec.dersGun && rec.dersGun !== 'â€”' ? `<div class="tiny">ğŸ“… Ders gÃ¼nÃ¼: ${rec.dersGun}</div>` : '';
    
    row.className = 'sRow ' + rowClassByStat(st);
    row.innerHTML = `<div><div>${ders}${dersItem.ilkKayitISO ? ` <span class="tiny">(${dersItem.ilkKayitISO.slice(0,10)})</span>` : ''}</div>${dersGunInfo}${lateInfo}${personelInfo}</div><div class="statBadge">${st === STAT_NONE ? 'â€”' : st}</div>`;
    row.onclick = () => openTalebeModal({ uid: state.talebeUid, ad: state.talebeAd, ders, stat: st, rec });
  }

  function openRaporTalebeModal({ad, durum, personel, dersGun, islemISO, gecikme}){
    const box=$('raporTalebeContent');
    const iso10 = islemISO ? toISO10(islemISO) : 'â€”';
    const fullTime = islemISO ? new Date(islemISO).toLocaleString('tr-TR') : 'â€”';
    box.innerHTML = `
      <h3>${ad}</h3>
      <p class="tiny" style="margin-bottom:8px">Ders GÃ¼nÃ¼: <strong>${dersGun||'â€”'}</strong></p>
      <p class="tiny" style="margin-bottom:8px">Durum: <strong>${durum||'â€”'}</strong></p>
      <p class="tiny" style="margin-bottom:8px">Personel: <strong>${personel||'â€”'}</strong></p>
      <p class="tiny" style="margin-bottom:8px">KayÄ±t ZamanÄ±: <strong>${fullTime}</strong> ${iso10 && iso10!==dersGun ? `<span class="tiny">(! ${iso10} kaydedildi)</span>`:''}</p>
      ${gecikme>0 ? `<p class="tiny" style="color:#f97316">Bu dersi ${gecikme} gÃ¼n gecikmeli verdi.</p>` : ''}
      <div class="modal-buttons"><button class="btn-ghost" onclick="document.getElementById('raporTalebeModal').classList.remove('open')">Kapat</button></div>`;
    $('raporTalebeModal').classList.add('open');
  }

  async function showRapor(){
    if (!state.dersKayitISO) {
      try {
        const mdoc = await db.collection(PATHS.main).doc(state.devre).collection(state.kitap).doc(state.ders).get();
        const m = mdoc.exists ? mdoc.data() : {};
        state.dersKayitISO = m.ilkKayitISO || m.created || new Date().toISOString();
      } catch(_) {
        state.dersKayitISO = new Date().toISOString();
      }
    }
    $('islemSection').style.display='none';
    bumpLoading(10);
    loadingLabel('Durumlar okunuyorâ€¦');

    const sabitGun = state.dersKayitISO ? state.dersKayitISO.slice(0,10) : 'â€”';
    $('outTitle').textContent = `Rapor â€¢ ${state.devre} â€¢ ${state.kitap} â€¢ ${state.ders||'â€”'} â€¢ ${sabitGun}`;

    const statuses = await readStatuses({devre:state.devre, kitap:state.kitap, ders:state.ders, dersISO:state.dersKayitISO});
    bumpLoading(55);
    loadingLabel('Talebeler yÃ¼kleniyorâ€¦');

    const talebeler = await loadTalebeler(state.devre);
    bumpLoading(80);
    loadingLabel('Ã–zet hazÄ±rlanÄ±yorâ€¦');

    const counts = { verdi:0, 'yarÄ±m kaldÄ±':0, veremedi:0 };
    talebeler.forEach(t=>{
      const st = canonStat((statuses[t.uid]?.durum) || STAT_NONE);
      if(st===STAT_VERDI) counts.verdi++;
      else if(st===STAT_YARIM) counts['yarÄ±m kaldÄ±']++;
      else if(st===STAT_VEREMEDI) counts.veremedi++;
    });

    const wrap=document.createElement('div');
    wrap.innerHTML = buildSummaryHTML(counts, talebeler.length);

    const list=document.createElement('div'); list.className='sList'; list.style.marginTop='10px';
    list.innerHTML=`<div class="sHead">Talebe DÃ¶kÃ¼mÃ¼<span class="tiny">Toplam: ${talebeler.length}</span></div>`;
    const body=document.createElement('div');

    const total = talebeler.length || 1;
    const start = 80, end = 96;

    talebeler.forEach((t, i)=>{
      const rec=statuses[t.uid]||{};
      const st = canonStat(rec.durum || STAT_NONE);
      const late=(st===STAT_VERDI)? daysLate(sabitGun, rec.islemISO) : 0;
      const iso10=toISO10(rec.islemISO);
      const lateInfo=(late>0&&iso10)? `<div class="tiny">! ${iso10} â€” ${late} gÃ¼n geÃ§ verdi</div>` : '';
      const personelInfo = rec.personel ? `<div class="tiny">ğŸ‘¤ ${rec.personel}</div>` : '';
      const row=document.createElement('div'); 
      row.className='sRow '+rowClassByStat(st);
      row.setAttribute('data-uid', t.uid); // ID ekle
      row.innerHTML=`<div><div>${t.ad}</div>${lateInfo}${personelInfo}</div><div class="statBadge">${st===STAT_NONE?'â€”':st}</div>`;
      row.onclick=()=>openRaporTalebeModal({ ad:t.ad, durum:st, personel:rec.personel||'â€”', dersGun:sabitGun, islemISO:rec.islemISO||null, gecikme:late });
      body.appendChild(row);
      const p = start + ((i+1)/total) * (end - start);
      bumpLoading(p);
    });
    bumpLoading(99);
    list.appendChild(body);
    wrap.appendChild(list);

    $('outArea').replaceChildren(wrap);
  }

  async function showIslem(){
    if (!state.dersKayitISO) {
      try {
        const mdoc = await db.collection(PATHS.main).doc(state.devre).collection(state.kitap).doc(state.ders).get();
        const m = mdoc.exists ? mdoc.data() : {};
        state.dersKayitISO = m.ilkKayitISO || m.created || new Date().toISOString();
      } catch(_) {
        state.dersKayitISO = new Date().toISOString();
      }
    }
    bumpLoading(10);
    loadingLabel('Talebeler yÃ¼kleniyorâ€¦');

    const sabitGun = state.dersKayitISO ? state.dersKayitISO.slice(0,10) : 'â€”';
    $('outTitle').textContent = `Ä°ÅŸlem â€¢ ${state.devre} â€¢ ${state.kitap} â€¢ ${state.ders} â€¢ ${sabitGun}`;

    state.talebeler = await loadTalebeler(state.devre);
    bumpLoading(45);
    loadingLabel('Durumlar okunuyorâ€¦');

    state.durumMap  = await readStatuses({devre:state.devre, kitap:state.kitap, ders:state.ders, dersISO:state.dersKayitISO});
    bumpLoading(70);

    const counts={verdi:0,'yarÄ±m kaldÄ±':0,veremedi:0};
    state.talebeler.forEach(t=>{
      const st=canonStat((state.durumMap[t.uid]?.durum)||STAT_NONE);
      if(st===STAT_VERDI) counts.verdi++;
      else if(st===STAT_YARIM) counts['yarÄ±m kaldÄ±']++;
      else if(st===STAT_VEREMEDI) counts.veremedi++;
    });

    const wrap=document.createElement('div');
    wrap.innerHTML = buildSummaryHTML(counts, state.talebeler.length);
    $('outArea').replaceChildren(wrap);

    if (window._takrirUnsub) window._takrirUnsub(); // Ã¶nceki varsa kapat
    window._takrirUnsub = await startRealtimeListener();

    renderTalebeList();
    $('islemSection').style.display='block';
  }

  async function showTalebeView(){
    if (!state.talebeUid || !state.kitap) {
      $('goMsg').textContent = 'Kitap ve talebe seÃ§iniz.';
      return;
    }
    
    safeUnsub();
    $('islemSection').style.display='none';
    bumpLoading(10);
    loadingLabel('Dersler yÃ¼kleniyorâ€¦');
    
    const dersler = await listDerslerWithMeta(state.devre, state.kitap);
    bumpLoading(30);
    loadingLabel('Durumlar okunuyorâ€¦');
    
    state.talebeDersDurumMap = await readTalebeStatuses({
      devre: state.devre,
      kitap: state.kitap,
      talebeUid: state.talebeUid
    });
    
    bumpLoading(70);
    loadingLabel('Liste hazÄ±rlanÄ±yorâ€¦');
    
    $('outTitle').textContent = `Talebe GÃ¶rÃ¼nÃ¼mÃ¼ â€¢ ${state.devre} â€¢ ${state.kitap} â€¢ ${state.talebeAd || 'â€”'}`;
    
    // Ã–zet istatistikler
    const counts = { verdi: 0, 'yarÄ±m kaldÄ±': 0, veremedi: 0 };
    dersler.forEach(d => {
      const rec = state.talebeDersDurumMap[d.ad] || { durum: STAT_NONE };
      const st = canonStat(rec.durum || STAT_NONE);
      if(st === STAT_VERDI) counts.verdi++;
      else if(st === STAT_YARIM) counts['yarÄ±m kaldÄ±']++;
      else if(st === STAT_VEREMEDI) counts.veremedi++;
    });
    
    const wrap = document.createElement('div');
    wrap.innerHTML = buildSummaryHTML(counts, dersler.length);
    
    // Ders listesi
    const list = document.createElement('div');
    list.className = 'sList';
    list.style.marginTop = '10px';
    list.innerHTML = `<div class="sHead">Dersler<span class="tiny">Toplam: ${dersler.length}</span></div>`;
    const body = document.createElement('div');
    
    bumpLoading(75);
    
    dersler.forEach((dersItem, i) => {
      const ders = dersItem.ad;
      const rec = state.talebeDersDurumMap[ders] || { durum: STAT_NONE, islemISO: null, personel: 'â€”', dersGun: dersItem.ilkKayitISO?.slice(0,10) || 'â€”' };
      const st = canonStat(rec.durum || STAT_NONE);
      const late = (st === STAT_VERDI && rec.dersGun) ? daysLate(rec.dersGun, rec.islemISO) : 0;
      const iso10 = toISO10(rec.islemISO);
      const lateInfo = (late > 0 && iso10) ? `<div class="tiny">! ${iso10} â€” ${late} gÃ¼n geÃ§ verdi</div>` : '';
      const personelInfo = rec.personel && rec.personel !== 'â€”' ? `<div class="tiny">ğŸ‘¤ ${rec.personel}</div>` : '';
      const dersGunInfo = rec.dersGun && rec.dersGun !== 'â€”' ? `<div class="tiny">ğŸ“… Ders gÃ¼nÃ¼: ${rec.dersGun}</div>` : '';
      
      const row = document.createElement('div');
      row.className = 'sRow ' + rowClassByStat(st);
      row.setAttribute('data-ders', ders); // ID ekle
      row.innerHTML = `<div><div>${ders}${dersItem.ilkKayitISO ? ` <span class="tiny">(${dersItem.ilkKayitISO.slice(0,10)})</span>` : ''}</div>${dersGunInfo}${lateInfo}${personelInfo}</div><div class="statBadge">${st === STAT_NONE ? 'â€”' : st}</div>`;
      row.style.cursor = 'pointer';
      row.onclick = () => openTalebeModal({ uid: state.talebeUid, ad: state.talebeAd, ders, stat: st, rec });
      body.appendChild(row);
      
      const p = 75 + ((i + 1) / dersler.length) * 20;
      bumpLoading(p);
    });
    
    list.appendChild(body);
    wrap.appendChild(list);
    $('outArea').replaceChildren(wrap);
  }
  
  function openTalebeModal({ uid, ad, ders, stat, rec }){
    modalCtx = { uid, ad, pre: stat, ders };
    $('mHead').textContent = `${ad} â€¢ ${ders}`;
    document.querySelectorAll('input[name="mStat"]').forEach(i => i.checked = (i.value === stat));
    $('mModal').classList.add('open');
  }

  function safeUnsub(){
  if (typeof window._takrirUnsub === 'function') {
    try { window._takrirUnsub(); } catch(_) {}
  }
  window._takrirUnsub = null;
}

  function renderTalebeList(){
    const box=$('talebeList'); box.innerHTML='';
    const sort=$('selSort').value;
    let rows = state.talebeler.map(t=>{
      const rec  = state.durumMap[t.uid] || {durum:STAT_NONE, islemISO:null};
      const stat = canonStat(rec.durum || STAT_NONE);
      const late = (stat===STAT_VERDI) ? daysLate((state.dersKayitISO||'').slice(0,10), rec.islemISO) : 0;
      return { uid:t.uid, ad:t.ad, stat, islemISO:rec.islemISO, late };
    });
    if(sort==='alpha') rows.sort((a,b)=>a.ad.localeCompare(b.ad,'tr'));
    else if(sort==='status'){
      const order = {[STAT_VEREMEDI]:0, [STAT_YARIM]:1, [STAT_NONE]:2, [STAT_VERDI]:3};
      rows.sort((a,b)=>(order[a.stat]??5)-(order[b.stat]??5) || a.ad.localeCompare(b.ad,'tr'));
    }

    const total = rows.length || 1;
    const start = Math.max(__loading.value, 70), end = 96;

    rows.forEach((r, i)=>{
      const iso10=toISO10(r.islemISO);
      const lateInfo=(r.late>0&&iso10)? `<div class="tiny">! ${iso10} â€” ${r.late} gÃ¼n geÃ§ verdi</div>` : '';
      const row=document.createElement('div'); row.className='sRow '+rowClassByStat(r.stat);
      const p = start + ( (i+1)/total ) * (end - start);
      bumpLoading(p);
      row.innerHTML=`<div><div>${r.ad}</div>${lateInfo}</div><div class="statBadge">${r.stat===STAT_NONE?'â€”':r.stat}</div>`;
      row.onclick=()=>openModal(r);
      box.appendChild(row);
    });
  }

  let _renderTimer=null;
function renderTalebeListDebounced(){
  if (_renderTimer) cancelAnimationFrame(_renderTimer);
  _renderTimer = requestAnimationFrame(renderTalebeList);
}

  /* NAV helpers - ortak.js'den geliyor (window.normalizeUrl, window.fetchPanels, window.renderNav) */
  // CURRENT_ALLOW ve CURRENT_DENY ortak.js'den geliyor (window.CURRENT_ALLOW, window.CURRENT_DENY)
  // zaten ortak.js'de tanÄ±mlÄ±, tekrar tanÄ±mlamaya gerek yok - direkt window'dan kullanabiliriz

  // Ä°ÅŸlem modal
  function openModal(r){
    modalCtx={ uid:r.uid, ad:r.ad, pre:r.stat, ders:state.ders };
    $('mHead').textContent=r.ad;
    document.querySelectorAll('input[name="mStat"]').forEach(i=> i.checked=(i.value===r.stat));
    $('mModal').classList.add('open');
  }
  function closeModal(){ $('mModal').classList.remove('open'); }
  $('mCancel').addEventListener('click', closeModal);
$('mSave').addEventListener('click', async () => {
  const sel = [...document.querySelectorAll('input[name="mStat"]')].find(i=>i.checked);
  if(!sel){ $('mModal').classList.remove('open'); return; }
  const durum = sel.value;

  try{
    // Talebe gÃ¶rÃ¼nÃ¼mÃ¼nden mi geldi kontrol et
    const isTalebeView = modalCtx.ders && state.mode === 'talebe';
    const ders = isTalebeView ? modalCtx.ders : state.ders;
    
    if(!ders){
      toast('Ders bilgisi bulunamadÄ±');
      return;
    }
    
    if(!state.kitap){
      toast('Kitap bilgisi bulunamadÄ±');
      return;
    }

    // Ders kayÄ±t tarihini bul
    let dersKayitISO = null;
    if(isTalebeView && state.talebeDersDurumMap[ders]?.dersGun){
      dersKayitISO = state.talebeDersDurumMap[ders].dersGun + 'T00:00:00Z';
    } else {
      try {
        const mdoc = await db.collection(PATHS.main).doc(state.devre).collection(state.kitap).doc(ders).get();
        const m = mdoc.exists ? mdoc.data() : {};
        dersKayitISO = m.ilkKayitISO || m.created || new Date().toISOString();
      } catch(_) {
        dersKayitISO = new Date().toISOString();
      }
    }
    const sabitGun = dersKayitISO ? dersKayitISO.slice(0,10) : new Date().toISOString().slice(0,10);
    
    const { uid: meUid, name: meName } = await ensureUserCtx();
    const device = getDeviceInfo();

    // 1) Optimistic UI: anÄ±nda yansÄ±t
    const nowISO = new Date().toISOString();
    
    if(isTalebeView){
      // Talebe gÃ¶rÃ¼nÃ¼mÃ¼nde - sadece ilgili ders satÄ±rÄ±nÄ± gÃ¼ncelle
      if(!state.talebeDersDurumMap[ders]) state.talebeDersDurumMap[ders] = {};
      state.talebeDersDurumMap[ders] = {
        durum,
        islemISO: nowISO,
        personel: meName,
        dersGun: sabitGun
      };
      
      // Ders satÄ±rÄ±nÄ± gÃ¼ncelle
      const dersler = await listDerslerWithMeta(state.devre, state.kitap);
      const dersItem = dersler.find(d => d.ad === ders);
      if(dersItem){
        updateTalebeDersRow(ders, dersItem, state.talebeDersDurumMap[ders]);
      }
      
      // Ã–zet istatistiklerini gÃ¼ncelle - mevcut satÄ±rlardan say
      const counts = { verdi: 0, 'yarÄ±m kaldÄ±': 0, veremedi: 0 };
      const rows = document.querySelectorAll('[data-ders]');
      rows.forEach(row => {
        const badge = row.querySelector('.statBadge');
        if(badge){
          const stat = badge.textContent.trim();
          if(stat === 'verdi') counts.verdi++;
          else if(stat === 'yarÄ±m kaldÄ±') counts['yarÄ±m kaldÄ±']++;
          else if(stat === 'veremedi') counts.veremedi++;
        }
      });
      updateSummary(counts, dersler.length);
    } else if(state.mode === 'rapor'){
      // Rapor modunda - sadece ilgili talebe satÄ±rÄ±nÄ± gÃ¼ncelle
      const talebeler = await loadTalebeler(state.devre);
      const talebe = talebeler.find(t => t.uid === modalCtx.uid);
      if(talebe){
        updateRaporRow(modalCtx.uid, talebe.ad, durum, meName, nowISO, sabitGun);
      }
      
      // Ã–zet istatistiklerini gÃ¼ncelle - mevcut satÄ±rlardan say
      const counts = { verdi:0, 'yarÄ±m kaldÄ±':0, veremedi:0 };
      const rows = document.querySelectorAll('[data-uid]');
      rows.forEach(row => {
        const badge = row.querySelector('.statBadge');
        if(badge){
          const stat = badge.textContent.trim();
          if(stat === 'verdi') counts.verdi++;
          else if(stat === 'yarÄ±m kaldÄ±') counts['yarÄ±m kaldÄ±']++;
          else if(stat === 'veremedi') counts.veremedi++;
        }
      });
      updateSummary(counts, talebeler.length);
    } else {
      // Ä°ÅŸlem modunda - zaten realtime listener var, sadece state'i gÃ¼ncelle
      state.durumMap[modalCtx.uid] = { durum, islemISO: nowISO, personel: meName };
      renderTalebeList();
    }
    
    $('mModal').classList.remove('open');
    toast('Kaydediliyorâ€¦');

    // 2) Arka planda tek round-trip batch commit
    await writeStatusFast({
      devre: state.devre, kitap: state.kitap, ders: ders,
      uid: modalCtx.uid, durum,
      personel: meName, personelUid: meUid, device,
      dersGun: sabitGun
    });

    toast('Kaydedildi');
  }catch(err){
    console.error(err);
    toast('Kaydedilemedi');  // Ä°stersen roll-back yapabilirsin
  }
});

  // Kitap & Ders modal
  const kdModal=$('kdModal'), kdClose=$('kdClose');
  function openKD(){ kdModal.classList.add('open'); }
  function closeKD(){ kdModal.classList.remove('open'); }
  kdClose.addEventListener('click', closeKD);
  kdModal.addEventListener('click', e=>{ if(e.target===kdModal) closeKD(); });

  // Ayarlar Modal
  const ayarlarModal=$('ayarlarModal'), ayarlarClose=$('ayarlarClose');

  async function openAyarlar(){
    ayarlarModal.classList.add('open');
    await loadAyarlarKitaplar();
    await loadAyarlarKitapSelect();
    // EÄŸer seÃ§ili kitap varsa, onu seÃ§ ve derslerini yÃ¼kle
    if(state.kitap){
      $('ayarlarSelKitap').value=state.kitap;
      await loadAyarlarDersler(state.kitap);
      $('ayarlarDersEkle').style.display='block';
    }
  }
  function closeAyarlar(){
    ayarlarModal.classList.remove('open');
  }
  $('btnAyarlar').addEventListener('click', openAyarlar);
  ayarlarClose.addEventListener('click', closeAyarlar);
  ayarlarModal.addEventListener('click', e=>{ if(e.target===ayarlarModal) closeAyarlar(); });
  document.addEventListener('keydown', e=>{
    if(e.key==='Escape' && ayarlarModal.classList.contains('open')) closeAyarlar();
  });

  // Kitap yÃ¶netimi
  async function loadAyarlarKitaplar(){
    const list=$('ayarlarKitapList');
    list.innerHTML='<div class="muted" style="padding:12px; text-align:center">YÃ¼kleniyor...</div>';
    try{
      const kitaplar=await listKitaplar(state.devre);
      if(!kitaplar.length){
        list.innerHTML='<div class="muted" style="padding:12px; text-align:center">HenÃ¼z kitap yok</div>';
        return;
      }
      list.innerHTML='';
      for(const kitap of kitaplar){
        const item=document.createElement('div');
        item.className='ayarlar-item';
        const metaDoc=await db.collection(PATHS.main).doc(state.devre).collection(kitap).doc('_meta').get();
        const meta=metaDoc.exists?metaDoc.data():{};
        const createdBy=meta.createdBy||meta.ilkKayitBy||'â€”';
        const createdDate=meta.created||meta.ilkKayitISO||meta.createdClientISO||'â€”';
        const dateStr=createdDate!=='â€”'?createdDate.slice(0,10):'â€”';
        
        item.innerHTML=`
          <div class="ayarlar-item-content">
            <div class="ayarlar-item-name">${kitap}</div>
            <div class="ayarlar-item-meta">ğŸ‘¤ ${createdBy} â€¢ ğŸ“… ${dateStr}</div>
          </div>
          <div class="ayarlar-item-actions">
            <button type="button" class="ayarlar-btn ayarlar-btn-edit" data-action="edit-kitap" data-kitap="${kitap.replace(/"/g,'&quot;')}" data-createdby="${createdBy.replace(/"/g,'&quot;')}" data-createddate="${dateStr.replace(/"/g,'&quot;')}">âœï¸ DÃ¼zenle</button>
            <button type="button" class="ayarlar-btn ayarlar-btn-delete" data-action="delete-kitap" data-kitap="${kitap.replace(/"/g,'&quot;')}">ğŸ—‘ï¸ Sil</button>
          </div>`;
        // Event listeners ekle
        item.querySelectorAll('[data-action]').forEach(btn=>{
          btn.addEventListener('click', (e)=>{
            e.preventDefault();
            e.stopPropagation();
            const action=btn.dataset.action;
            if(action==='edit-kitap'){
              ayarlarEditKitap(btn.dataset.kitap, btn.dataset.createdby, btn.dataset.createddate);
            }else if(action==='delete-kitap'){
              ayarlarDeleteKitap(btn.dataset.kitap);
            }
          });
        });
        list.appendChild(item);
      }
    }catch(e){
      console.error(e);
      list.innerHTML='<div style="color:var(--danger); padding:12px">Hata: '+e.message+'</div>';
    }
  }

  // DÃ¼zenleme modalÄ±
  let duzenlemeContext = { type: null, oldName: null, kitap: null, meta: null };
  const duzenlemeModal = $('duzenlemeModal');
  
  function openDuzenlemeModal(type, oldName, kitap, meta){
    duzenlemeContext = { type, oldName, kitap, meta };
    $('duzenlemeTitle').textContent = type === 'kitap' ? 'ğŸ“š Kitap DÃ¼zenle' : 'ğŸ“– Ders DÃ¼zenle';
    $('duzenlemeLabel').textContent = type === 'kitap' ? 'Kitap AdÄ±' : 'Ders AdÄ±';
    $('duzenlemeInput').value = oldName;
    $('duzenlemeInput').focus();
    $('duzenlemeInput').select();
    
    if(meta){
      $('duzenlemeMeta').innerHTML = `
        <div style="display:flex; gap:12px; flex-wrap:wrap">
          <div><strong>ğŸ‘¤ OluÅŸturan:</strong> ${meta.createdBy || 'â€”'}</div>
          <div><strong>ğŸ“… Tarih:</strong> ${meta.createdDate || 'â€”'}</div>
        </div>`;
      $('duzenlemeMeta').style.display = 'block';
    }else{
      $('duzenlemeMeta').style.display = 'none';
    }
    
    duzenlemeModal.classList.add('open');
  }
  
  function closeDuzenlemeModal(){
    duzenlemeModal.classList.remove('open');
    duzenlemeContext = { type: null, oldName: null, kitap: null, meta: null };
  }
  
  $('duzenlemeClose').addEventListener('click', closeDuzenlemeModal);
  $('duzenlemeCancel').addEventListener('click', closeDuzenlemeModal);
  duzenlemeModal.addEventListener('click', e => {
    if(e.target === duzenlemeModal) closeDuzenlemeModal();
  });
  document.addEventListener('keydown', e => {
    if(e.key === 'Escape' && duzenlemeModal.classList.contains('open')) closeDuzenlemeModal();
  });
  
  $('duzenlemeSave').addEventListener('click', async () => {
    const newName = ($('duzenlemeInput').value || '').trim();
    if(!newName || newName === duzenlemeContext.oldName){
      closeDuzenlemeModal();
      return;
    }
    
    // Onay dialog'u
    const typeName = duzenlemeContext.type === 'kitap' ? 'kitap' : 'ders';
    const confirmMsg = `"${duzenlemeContext.oldName}" ${typeName}Ä±nÄ± "${newName}" olarak deÄŸiÅŸtirmek istediÄŸinizden emin misiniz? TÃ¼m tarih kayÄ±tlarÄ± da gÃ¼ncellenecektir.`;
    if(!confirm(confirmMsg)) return;
    
    if(duzenlemeContext.type === 'kitap'){
      await ayarlarSaveKitap(duzenlemeContext.oldName, newName);
    }else if(duzenlemeContext.type === 'ders'){
      await ayarlarSaveDers(duzenlemeContext.kitap, duzenlemeContext.oldName, newName);
    }
    closeDuzenlemeModal();
  });
  
  $('duzenlemeInput').addEventListener('keypress', async (e) => {
    if(e.key === 'Enter'){
      e.preventDefault();
      $('duzenlemeSave').click();
    }
  });

  function ayarlarEditKitap(kitap, createdBy, createdDate){
    openDuzenlemeModal('kitap', kitap, null, { createdBy, createdDate });
  }
  function ayarlarEditDers(kitap, ders, createdBy, createdDate){
    openDuzenlemeModal('ders', ders, kitap, { createdBy, createdDate });
  }
  // Tarih bazlÄ± kayÄ±tlarda kitap adÄ±nÄ± gÃ¼ncelle
  async function updateKitapNameInByDate(devre, oldKitap, newKitap){
    loadingLabel('Tarih kayÄ±tlarÄ± taranÄ±yor...');
    let totalUpdated = 0;
    const BATCH_SIZE = 400;
    let currentBatch = db.batch();
    let batchCount = 0;

    // Son 2 yÄ±l iÃ§indeki tÃ¼m tarihleri tara (yaklaÅŸÄ±k 730 gÃ¼n)
    const today = new Date();
    const startDate = new Date(today);
    startDate.setFullYear(today.getFullYear() - 2);
    
    const dates = [];
    for(let d = new Date(startDate); d <= today; d.setDate(d.getDate() + 1)){
      dates.push(d.toISOString().slice(0,10));
    }

    for(let i = 0; i < dates.length; i++){
      const dateStr = dates[i];
      if(i % 50 === 0){
        loadingLabel(`Tarih kayÄ±tlarÄ± taranÄ±yor... (${i}/${dates.length})`);
        bumpLoading(40 + (i / dates.length) * 40);
      }

      try{
        const dateCol = db.collection(PATHS.byDate).doc(devre).collection(dateStr);
        const dateDocs = await dateCol.get();
        
        for(const dateDoc of dateDocs.docs){
          const data = dateDoc.data() || {};
          let needsUpdate = false;
          const updateData = {};

          // kayitlar array'ini gÃ¼ncelle
          if(Array.isArray(data.kayitlar)){
            const updatedKayitlar = data.kayitlar.map(kayit=>{
              if(kayit.kitap === oldKitap){
                needsUpdate = true;
                return {...kayit, kitap: newKitap};
              }
              return kayit;
            });
            if(needsUpdate){
              updateData.kayitlar = updatedKayitlar;
            }
          }

          // Ana dokÃ¼manÄ± gÃ¼ncelle
          if(needsUpdate){
            currentBatch.update(dateDoc.ref, updateData);
            batchCount++;
          }

          // dersler alt koleksiyonunu gÃ¼ncelle
          const derslerCol = dateDoc.ref.collection('dersler');
          const derslerSnap = await derslerCol.get();
          for(const dersDoc of derslerSnap.docs){
            const dersData = dersDoc.data() || {};
            if(dersData.kitap === oldKitap){
              // Yeni dersKey oluÅŸtur
              const newDersKey = encodeURIComponent(`${newKitap}__${dersData.ders}`);
              const newDersRef = derslerCol.doc(newDersKey);
              currentBatch.set(newDersRef, {
                ...dersData,
                kitap: newKitap
              }, {merge: true});
              currentBatch.delete(dersDoc.ref);
              batchCount++;
              totalUpdated++;
            }
          }

          if(batchCount >= BATCH_SIZE){
            await currentBatch.commit();
            currentBatch = db.batch();
            batchCount = 0;
            await new Promise(r => setTimeout(r, 200)); // Rate limit iÃ§in bekle
          }
        }
      }catch(e){
        console.warn(`Tarih ${dateStr} iÃ§in hata:`, e);
      }
    }

    if(batchCount > 0){
      await currentBatch.commit();
    }
    return totalUpdated;
  }

  async function ayarlarSaveKitap(oldName, newName){
    if(!newName) newName = ($('duzenlemeInput')?.value||'').trim();
    if(!newName || newName===oldName){
      ayarlarCancelEditKitap();
      return;
    }
    if(!confirm(`"${oldName}" kitabÄ±nÄ± "${newName}" olarak deÄŸiÅŸtirmek istediÄŸinizden emin misiniz? TÃ¼m tarih kayÄ±tlarÄ± da gÃ¼ncellenecektir.`)) return;
    
    try{
      await ensureUserCtx();
      loadingStart('Kitap gÃ¼ncelleniyor...', 85);
      toast('GÃ¼ncelleniyor...');
      
      // Yeni kitap adÄ±yla meta kopyala
      const oldMeta=await db.collection(PATHS.main).doc(state.devre).collection(oldName).doc('_meta').get();
      if(oldMeta.exists){
        const metaData=oldMeta.data();
        await db.collection(PATHS.main).doc(state.devre).collection(newName).doc('_meta').set({
          ...metaData,
          updated:new Date().toISOString(),
          updatedBy:__ME,
          updatedUid:__UID,
          renamedFrom:oldName
        });
      }else{
        await db.collection(PATHS.main).doc(state.devre).collection(newName).doc('_meta').set({
          created:new Date().toISOString(),
          createdBy:__ME,
          createdUid:__UID,
          renamedFrom:oldName
        },{merge:true});
      }

      bumpLoading(15);
      loadingLabel('Dersler taÅŸÄ±nÄ±yor...');

      // TÃ¼m dersleri taÅŸÄ±
      const derslerSnap=await db.collection(PATHS.main).doc(state.devre).collection(oldName).get();
      const batch=db.batch();
      derslerSnap.forEach(doc=>{
        if(doc.id==='_meta') return;
        const newRef=db.collection(PATHS.main).doc(state.devre).collection(newName).doc(doc.id);
        batch.set(newRef,doc.data());
      });
      await batch.commit();

      bumpLoading(30);
      loadingLabel('Index gÃ¼ncelleniyor...');

      // Index gÃ¼ncelle
      await db.collection(PATHS.index).doc(state.devre).update({
        kitaplar:firebase.firestore.FieldValue.arrayRemove(oldName)
      });
      await db.collection(PATHS.index).doc(state.devre).update({
        kitaplar:firebase.firestore.FieldValue.arrayUnion(newName)
      });

      bumpLoading(45);
      loadingLabel('Tarih kayÄ±tlarÄ± gÃ¼ncelleniyor...');

      // Tarih bazlÄ± kayÄ±tlarÄ± gÃ¼ncelle
      const updatedCount = await updateKitapNameInByDate(state.devre, oldName, newName);
      
      bumpLoading(75);
      loadingLabel('Eski kayÄ±tlar temizleniyor...');

      // Eski kitabÄ± sil
      const deleteBatch=db.batch();
      derslerSnap.forEach(doc=>{
        deleteBatch.delete(doc.ref);
      });
      deleteBatch.delete(db.collection(PATHS.main).doc(state.devre).collection(oldName).doc('_meta'));
      await deleteBatch.commit();

      // Index dersler gÃ¼ncelle
      const dersIndexRef=db.collection(PATHS.index).doc(state.devre).collection('dersler').doc(oldName);
      const dersIndexSnap=await dersIndexRef.get();
      if(dersIndexSnap.exists){
        const dersData=dersIndexSnap.data();
        await db.collection(PATHS.index).doc(state.devre).collection('dersler').doc(newName).set(dersData);
        await dersIndexRef.delete();
      }

      bumpLoading(100);
      toast(`Kitap gÃ¼ncellendi (${updatedCount} tarih kaydÄ± gÃ¼ncellendi)`);
      // Sadece listeyi yenile
      await loadAyarlarKitaplar();
      await refreshKitap(true);
      if(state.kitap===oldName) state.kitap=newName;
      loadingEnd();
    }catch(e){
      console.error(e);
      toast('GÃ¼ncellenemedi: '+e.message);
      loadingEnd();
    }
  };
  async function ayarlarDeleteKitap(kitap){
    if(!confirm(`"${kitap}" kitabÄ±nÄ± ve iÃ§indeki tÃ¼m dersleri silmek istediÄŸinizden emin misiniz? Bu iÅŸlem geri alÄ±namaz!`)) return;
    try{
      await ensureUserCtx();
      toast('Siliniyor...');
      
      // Index'ten Ã§Ä±kar
      await db.collection(PATHS.index).doc(state.devre).update({
        kitaplar:firebase.firestore.FieldValue.arrayRemove(kitap)
      });
      
      // Dersler index'ini sil
      await db.collection(PATHS.index).doc(state.devre).collection('dersler').doc(kitap).delete().catch(()=>{});
      
      // Kitap ve dersleri sil
      const snap=await db.collection(PATHS.main).doc(state.devre).collection(kitap).get();
      const batch=db.batch();
      snap.forEach(doc=>batch.delete(doc.ref));
      await batch.commit();
      
      toast('Kitap silindi');
      await loadAyarlarKitaplar();
      await refreshKitap(true);
      if(state.kitap===kitap){ state.kitap=''; state.ders=''; }
    }catch(e){
      console.error(e);
      toast('Silinemedi: '+e.message);
    }
  };

  $('ayarlarKitapYenile').addEventListener('click', (e)=>{ e.preventDefault(); loadAyarlarKitaplar(); });
  
  async function addKitapHandler(){
    const kitap=($('ayarlarInpKitap').value||'').trim();
    if(!kitap){ toast('Kitap adÄ± boÅŸ olamaz'); return; }
    try{
      await ensureUserCtx();
      await addKitap(state.devre, kitap);
      $('ayarlarInpKitap').value='';
      toast('Kitap eklendi');
      await loadAyarlarKitaplar();
      await refreshKitap(false);
    }catch(e){
      console.error(e);
      toast('Eklenemedi: '+e.message);
    }
  }
  $('ayarlarBtnKitapEkle').addEventListener('click', async (e)=>{
    e.preventDefault();
    await addKitapHandler();
  });
  $('ayarlarInpKitap').addEventListener('keypress', async (e)=>{
    if(e.key==='Enter'){
      e.preventDefault();
      await addKitapHandler();
    }
  });

  // Ders yÃ¶netimi
  async function loadAyarlarKitapSelect(){
    const sel=$('ayarlarSelKitap');
    const kitaplar=await listKitaplar(state.devre);
    sel.innerHTML='<option value="">Kitap seÃ§iniz</option>'+kitaplar.map(k=>`<option value="${k}">${k}</option>`).join('');
    if(state.kitap && kitaplar.includes(state.kitap)){
      sel.value=state.kitap;
    }
  }
  $('ayarlarSelKitap').addEventListener('change', async ()=>{
    const kitap=$('ayarlarSelKitap').value;
    if(!kitap){
      $('ayarlarDersList').innerHTML='<div class="muted" style="padding:12px; text-align:center">Ã–nce bir kitap seÃ§iniz</div>';
      $('ayarlarDersEkle').style.display='none';
      return;
    }
    await loadAyarlarDersler(kitap);
    $('ayarlarDersEkle').style.display='block';
  });

  async function loadAyarlarDersler(kitap){
    const list=$('ayarlarDersList');
    list.innerHTML='<div class="muted" style="padding:12px; text-align:center">YÃ¼kleniyor...</div>';
    try{
      const dersler=await listDerslerWithMeta(state.devre, kitap);
      if(!dersler.length){
        list.innerHTML='<div class="muted" style="padding:12px; text-align:center">Bu kitapta ders yok</div>';
        return;
      }
      list.innerHTML='';
      for(const ders of dersler){
        const item=document.createElement('div');
        item.className='ayarlar-item';
        const createdBy=ders.ilkKayitBy||'â€”';
        const dateStr=ders.ilkKayitISO?ders.ilkKayitISO.slice(0,10):'â€”';
        
        item.innerHTML=`
          <div class="ayarlar-item-content">
            <div class="ayarlar-item-name">${ders.ad}</div>
            <div class="ayarlar-item-meta">ğŸ‘¤ ${createdBy} â€¢ ğŸ“… ${dateStr}</div>
          </div>
          <div class="ayarlar-item-actions">
            <button type="button" class="ayarlar-btn ayarlar-btn-edit" data-action="edit-ders" data-kitap="${kitap.replace(/"/g,'&quot;')}" data-ders="${ders.ad.replace(/"/g,'&quot;')}" data-createdby="${createdBy.replace(/"/g,'&quot;')}" data-createddate="${dateStr.replace(/"/g,'&quot;')}">âœï¸ DÃ¼zenle</button>
            <button type="button" class="ayarlar-btn ayarlar-btn-delete" data-action="delete-ders" data-kitap="${kitap.replace(/"/g,'&quot;')}" data-ders="${ders.ad.replace(/"/g,'&quot;')}">ğŸ—‘ï¸ Sil</button>
          </div>`;
        // Event listeners ekle
        item.querySelectorAll('[data-action]').forEach(btn=>{
          btn.addEventListener('click', (e)=>{
            e.preventDefault();
            e.stopPropagation();
            const action=btn.dataset.action;
            if(action==='edit-ders'){
              ayarlarEditDers(btn.dataset.kitap, btn.dataset.ders, btn.dataset.createdby, btn.dataset.createddate);
            }else if(action==='delete-ders'){
              ayarlarDeleteDers(btn.dataset.kitap, btn.dataset.ders);
            }
          });
        });
        list.appendChild(item);
      }
    }catch(e){
      console.error(e);
      list.innerHTML='<div style="color:var(--danger); padding:12px">Hata: '+e.message+'</div>';
    }
  }

  // Tarih bazlÄ± kayÄ±tlarda ders adÄ±nÄ± gÃ¼ncelle
  async function updateDersNameInByDate(devre, kitap, oldDers, newDers){
    loadingLabel('Tarih kayÄ±tlarÄ± taranÄ±yor...');
    let totalUpdated = 0;
    const BATCH_SIZE = 400;
    let currentBatch = db.batch();
    let batchCount = 0;
    const oldDersKey = encodeURIComponent(`${kitap}__${oldDers}`);
    const newDersKey = encodeURIComponent(`${kitap}__${newDers}`);

    // Son 2 yÄ±l iÃ§indeki tÃ¼m tarihleri tara
    const today = new Date();
    const startDate = new Date(today);
    startDate.setFullYear(today.getFullYear() - 2);
    
    const dates = [];
    for(let d = new Date(startDate); d <= today; d.setDate(d.getDate() + 1)){
      dates.push(d.toISOString().slice(0,10));
    }

    for(let i = 0; i < dates.length; i++){
      const dateStr = dates[i];
      if(i % 50 === 0){
        loadingLabel(`Tarih kayÄ±tlarÄ± taranÄ±yor... (${i}/${dates.length})`);
        bumpLoading(40 + (i / dates.length) * 40);
      }

      try{
        const dateCol = db.collection(PATHS.byDate).doc(devre).collection(dateStr);
        const dateDocs = await dateCol.get();
        
        for(const dateDoc of dateDocs.docs){
          const data = dateDoc.data() || {};
          let needsUpdate = false;
          const updateData = {};

          // kayitlar array'ini gÃ¼ncelle
          if(Array.isArray(data.kayitlar)){
            const updatedKayitlar = data.kayitlar.map(kayit=>{
              if(kayit.kitap === kitap && kayit.ders === oldDers){
                needsUpdate = true;
                return {...kayit, ders: newDers};
              }
              return kayit;
            });
            if(needsUpdate){
              updateData.kayitlar = updatedKayitlar;
            }
          }

          // Ana dokÃ¼manÄ± gÃ¼ncelle
          if(needsUpdate){
            currentBatch.update(dateDoc.ref, updateData);
            batchCount++;
          }

          // dersler alt koleksiyonunu gÃ¼ncelle
          const derslerCol = dateDoc.ref.collection('dersler');
          const oldDersDoc = await derslerCol.doc(oldDersKey).get();
          if(oldDersDoc.exists){
            const dersData = oldDersDoc.data() || {};
            if(dersData.kitap === kitap && dersData.ders === oldDers){
              const newDersRef = derslerCol.doc(newDersKey);
              currentBatch.set(newDersRef, {
                ...dersData,
                ders: newDers
              }, {merge: true});
              currentBatch.delete(oldDersDoc.ref);
              batchCount++;
              totalUpdated++;
            }
          }

          if(batchCount >= BATCH_SIZE){
            await currentBatch.commit();
            currentBatch = db.batch();
            batchCount = 0;
            await new Promise(r => setTimeout(r, 200)); // Rate limit iÃ§in bekle
          }
        }
      }catch(e){
        console.warn(`Tarih ${dateStr} iÃ§in hata:`, e);
      }
    }

    if(batchCount > 0){
      await currentBatch.commit();
    }
    return totalUpdated;
  }

  async function ayarlarSaveDers(kitap, oldName, newName){
    if(!newName) newName = ($('duzenlemeInput')?.value||'').trim();
    if(!newName || newName===oldName){
      return;
    }
    // Modal'da zaten onay alÄ±ndÄ±, burada tekrar sormaya gerek yok
    
    try{
      await ensureUserCtx();
      loadingStart('Ders gÃ¼ncelleniyor...', 85);
      toast('GÃ¼ncelleniyor...');
      
      bumpLoading(10);
      loadingLabel('Ders dokÃ¼manÄ± gÃ¼ncelleniyor...');
      
      // Ders dokÃ¼manÄ±nÄ± kopyala ve gÃ¼ncelle
      const oldDoc=await db.collection(PATHS.main).doc(state.devre).collection(kitap).doc(oldName).get();
      if(oldDoc.exists){
        const oldData=oldDoc.data();
        await db.collection(PATHS.main).doc(state.devre).collection(kitap).doc(newName).set({
          ...oldData,
          ilkKayitISO:oldData.ilkKayitISO||oldData.created||new Date().toISOString(),
          ilkKayitBy:oldData.ilkKayitBy||oldData.createdBy||__ME,
          updated:new Date().toISOString(),
          updatedBy:__ME,
          updatedUid:__UID,
          renamedFrom:oldName
        });
        await oldDoc.ref.delete();
      }

      bumpLoading(25);
      loadingLabel('Index gÃ¼ncelleniyor...');

      // Index dersler gÃ¼ncelle
      const dersIndexRef=db.collection(PATHS.index).doc(state.devre).collection('dersler').doc(kitap);
      await dersIndexRef.update({
        dersler:firebase.firestore.FieldValue.arrayRemove(oldName)
      });
      await dersIndexRef.update({
        dersler:firebase.firestore.FieldValue.arrayUnion(newName)
      });

      bumpLoading(40);
      loadingLabel('Tarih kayÄ±tlarÄ± gÃ¼ncelleniyor...');

      // Tarih bazlÄ± kayÄ±tlarÄ± gÃ¼ncelle
      const updatedCount = await updateDersNameInByDate(state.devre, kitap, oldName, newName);

      bumpLoading(95);
      toast(`Ders gÃ¼ncellendi (${updatedCount} tarih kaydÄ± gÃ¼ncellendi)`);
      // Sadece gÃ¼ncellenen item'Ä± yenile
      await loadAyarlarDersler(kitap);
      await refreshDers();
      if(state.ders===oldName) state.ders=newName;
      loadingEnd();
    }catch(e){
      console.error(e);
      toast('GÃ¼ncellenemedi: '+e.message);
      loadingEnd();
    }
  };
  async function ayarlarDeleteDers(kitap, ders){
    if(!confirm(`"${ders}" dersini silmek istediÄŸinizden emin misiniz? Bu iÅŸlem geri alÄ±namaz!`)) return;
    try{
      await ensureUserCtx();
      toast('Siliniyor...');
      
      // Index'ten Ã§Ä±kar
      await db.collection(PATHS.index).doc(state.devre).collection('dersler').doc(kitap).update({
        dersler:firebase.firestore.FieldValue.arrayRemove(ders)
      });
      
      // Ders dokÃ¼manÄ±nÄ± sil
      await db.collection(PATHS.main).doc(state.devre).collection(kitap).doc(ders).delete();
      
      toast('Ders silindi');
      await loadAyarlarDersler(kitap);
      await refreshDers();
      if(state.ders===ders) state.ders='';
    }catch(e){
      console.error(e);
      toast('Silinemedi: '+e.message);
    }
  };

  async function addDersHandler(){
    const kitap=$('ayarlarSelKitap').value;
    if(!kitap){ toast('Ã–nce kitap seÃ§iniz'); return; }
    const ders=($('ayarlarInpDers').value||'').trim();
    if(!ders){ toast('Ders adÄ± boÅŸ olamaz'); return; }
    try{
      await ensureUserCtx();
      await addDers(state.devre, kitap, ders);
      $('ayarlarInpDers').value='';
      toast('Ders eklendi');
      await loadAyarlarDersler(kitap);
      await refreshDers();
    }catch(e){
      console.error(e);
      toast('Eklenemedi: '+e.message);
    }
  }
  $('ayarlarBtnDersEkle').addEventListener('click', async (e)=>{
    e.preventDefault();
    await addDersHandler();
  });
  $('ayarlarInpDers').addEventListener('keypress', async (e)=>{
    if(e.key==='Enter'){
      e.preventDefault();
      await addDersHandler();
    }
  });

  $('btnTakvim').addEventListener('click', async ()=>{
    const devre=state.devre;
    const kitaplar=await listKitaplar(devre);
    const kHost=$('kdKitapList'), dHost=$('kdDersList');
    kHost.innerHTML=''; dHost.innerHTML='';

    if(!kitaplar.length){
      kHost.innerHTML='<div class="muted" style="padding:4px">Bu devrede kitap yok.</div>';
      dHost.innerHTML='<div class="muted" style="padding:4px">Ders yok.</div>';
      openKD(); return;
    }

    let active=state.kitap || kitaplar[0] || null;
    kitaplar.forEach(k=>{
      const el=document.createElement('div');
      el.className='kd-item'+(k===active?' active':'');
      el.textContent=k;
      el.onclick=async ()=>{
        active=k;
        [...kHost.children].forEach(c=>c.classList.remove('active'));
        el.classList.add('active');
        const dersler=await listDerslerWithMeta(devre, k);
        dHost.innerHTML = dersler.length
          ? dersler.map(d=>`<div class="kd-item" style="cursor:default">${d.ad}${d.ilkKayitISO?` <span class="tiny">${d.ilkKayitISO.slice(0,10)}</span>`:''}</div>`).join('')
          : '<div class="muted" style="padding:4px">Bu kitapta ders yok.</div>';
      };
      kHost.appendChild(el);
    });

    if(active){
      const dersler=await listDerslerWithMeta(devre, active);
      dHost.innerHTML = dersler.length
        ? dersler.map(d=>`<div class="kd-item" style="cursor:default">${d.ad}${d.ilkKayitISO?` <span class="tiny">${d.ilkKayitISO.slice(0,10)}</span>`:''}</div>`).join('')
        : '<div class="muted" style="padding:4px">Bu kitapta ders yok.</div>';
    }
    openKD();
  });

  // Mod deÄŸiÅŸirken
document.querySelectorAll('input[name="mode"]').forEach(r=>{
  r.addEventListener('change', ()=>{
    state.mode = r.value;
    if (state.mode === 'rapor') safeUnsub();
    // Mode deÄŸiÅŸtiÄŸinde Ã§Ä±ktÄ±yÄ± temizle
    clearOutput();
  });
});

$('selDevre').addEventListener('change', async ()=>{
  safeUnsub();
  state.devre = $('selDevre').value;
  await refreshKitap(true);
  await refreshTalebe();
  clearOutput();
  // EÄŸer ayarlar modalÄ± aÃ§Ä±ksa, listeleri yenile
  if(ayarlarModal.classList.contains('open')){
    await loadAyarlarKitaplar();
    await loadAyarlarKitapSelect();
    $('ayarlarDersList').innerHTML='<div class="muted" style="padding:12px; text-align:center">Ã–nce bir kitap seÃ§iniz</div>';
    $('ayarlarDersEkle').style.display='none';
  }
});
window.addEventListener('beforeunload', safeUnsub);

// Kitap/Ders deÄŸiÅŸirken
$('selKitap').addEventListener('change', async ()=>{
  safeUnsub();
  state.kitap = $('selKitap').value||'';
  await refreshDers(); clearOutput();
});
$('selDers').addEventListener('change', async ()=>{
  safeUnsub();
  state.ders = $('selDers').value||'';
  state.dersKayitISO=null;
});

$('selTalebe').addEventListener('change', async ()=>{
  safeUnsub();
  const talebeUid = $('selTalebe').value||'';
  state.talebeUid = talebeUid;
  if(talebeUid){
    const talebeler = await loadTalebeler(state.devre);
    const selectedTalebe = talebeler.find(t=>t.uid===talebeUid);
    state.talebeAd = selectedTalebe ? selectedTalebe.ad : 'â€”';
  } else {
    state.talebeAd = '';
  }
});

  // GÃ¶ster
  $('btnGit').addEventListener('click', async ()=>{
    $('goMsg').textContent=''; $('islemSection').style.display='none'; $('outArea').innerHTML='';
    const currentMode=(document.querySelector('input[name="mode"]:checked')?.value)||'rapor';
    state.mode=currentMode;
    
    if(state.mode === 'talebe'){
      // Talebe gÃ¶rÃ¼nÃ¼mÃ¼
      if(!state.kitap){ $('goMsg').textContent='Kitap seÃ§iniz.'; return; }
      if(!state.talebeUid){ $('goMsg').textContent='Talebe seÃ§iniz.'; return; }
      loadingStart('Veriler getiriliyorâ€¦', 88);
      try{
        await showTalebeView();
      } finally { loadingEnd(); }
    } else {
      // Normal gÃ¶rÃ¼nÃ¼m (rapor/islem)
      if(!state.kitap){ $('goMsg').textContent='Kitap seÃ§iniz.'; return; }
      if(!state.ders){ $('goMsg').textContent='Ders seÃ§iniz.'; return; }
      loadingStart('Veriler getiriliyorâ€¦', 88);
      try{
        if (state.mode==='rapor') {
          safeUnsub();
          await showRapor();
        } else {
          await showIslem();
        }
      } finally { loadingEnd(); }
    }
});

  // Ekle butonlarÄ±
  $('btnKitapEkleToggle').addEventListener('click', ()=>{ const w=$('kitapEkleWrap'); w.style.display=w.style.display==='none'?'flex':'none'; });
  $('btnDersEkleToggle').addEventListener('click', ()=>{ const w=$('dersEkleWrap'); w.style.display=w.style.display==='none'?'flex':'none'; });
$('btnKitapKaydet').addEventListener('click', async ()=>{
  try{
    await ensureUserCtx();                               // <-- eklendi
    const kitap = ($('inpKitap').value||'').trim();
    if(!kitap){ $('kitapMsg').textContent='Kitap adÄ± boÅŸ olamaz.'; return; }
    $('kitapMsg').textContent='Kaydediliyor...';
    await addKitap(state.devre, kitap);
    $('inpKitap').value=''; $('kitapMsg').textContent='Eklendi.'; await refreshKitap(false);
  }catch(e){ console.error(e); $('kitapMsg').textContent = (e.message==='no-auth'?'GiriÅŸ gerekli.':'Hata (yetki/baÄŸlantÄ±).'); }
});

$('btnDersKaydet').addEventListener('click', async ()=>{
  try{
    await ensureUserCtx();                               // <-- eklendi
    const ders = ($('inpDers').value||'').trim();
    if(!state.kitap){ $('dersMsg').textContent='Ã–nce kitap seÃ§iniz.'; return; }
    if(!ders){ $('dersMsg').textContent='Ders adÄ± boÅŸ olamaz.'; return; }
    $('dersMsg').textContent='Kaydediliyor...';
    await addDers(state.devre, state.kitap, ders);
    $('inpDers').value=''; $('dersMsg').textContent='Eklendi.'; await refreshDers();
  }catch(e){ console.error(e); $('dersMsg').textContent = (e.message==='no-auth'?'GiriÅŸ gerekli.':'Hata (yetki/baÄŸlantÄ±).'); }
});
  $('selSort').addEventListener('change', ()=>renderTalebeList());
  $('btnListeYenile').addEventListener('click', ()=>renderTalebeList());

  // Rapor talebe modal close
  $('raporTalebeModal').addEventListener('click',(e)=>{ if(e.target.id==='raporTalebeModal') e.target.classList.remove('open'); });

  /* Auth + MenÃ¼ - ortak.js'den geliyor, sayfa-Ã¶zel init */
  // Sayfa-Ã¶zel init fonksiyonu (ortak.js'den Ã§aÄŸrÄ±lacak)
  window.initPage = async function(){
    try{
      // CURRENT_ALLOW ve CURRENT_DENY ortak.js'den geliyor - zaten tanÄ±mlÄ±, direkt window'dan kullanabiliriz
      // window.CURRENT_ALLOW ve window.CURRENT_DENY zaten ortak.js'de set edilmiÅŸ
      
      // BaÅŸlangÄ±Ã§ deÄŸerleri
      state.devre = $('selDevre').value;
      await refreshKitap(true);
      await refreshTalebe();
    }catch(e){ 
      console.error(e); 
      if(typeof window.showToast === 'function'){
        window.showToast('error', 'Hata', 'Veriler yÃ¼klenirken hata.');
      }
    }
  };
</script>
</body>
</html>
