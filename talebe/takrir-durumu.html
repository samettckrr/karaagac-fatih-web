<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Takrir Takibi | KaraaÄŸaÃ§ Fatih</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <link rel="icon" type="image/png" href="../img/logo.png" />

  <style>
    :root{
      --appbar-h:56px;
      --radius:14px; --shadow:0 12px 28px rgba(0,0,0,.14);
      --bg:#0f172a; --bg2:#0b1324;
      --grad1:#0ea5e922; --grad2:#22d3ee22;
      --card:rgba(15,23,42,.92); --stroke:rgba(148,163,184,.18);
      --text:#e5e7eb; --muted:#9aa4b2;
      --brand:#38bdf8; --brand2:#0ea5e9;
      --pill:#0b1220; --pill-hover:#101a2b; --surface:rgba(2,6,23,.08);
      --danger:#ef4444; --success:#22c55e;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#eef6ff; --bg2:#f7fbff; --grad1:#38bdf822; --grad2:#22d3ee22;
        --card:rgba(255,255,255,.96); --stroke:rgba(15,23,42,.12);
        --text:#0b1220; --muted:#4b5563; --brand:#0ea5e9; --brand2:#0284c7;
        --pill:#f5f8ff; --pill-hover:#e9f2ff; --surface:#eef3ff;
        --danger:#b91c1c; --success:#16a34a;
      }
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;padding:0;font-family:'Segoe UI',system-ui,-apple-system,Arial,sans-serif;background:var(--bg);color:var(--text)}
    a{color:#c7e9ff; text-decoration:none}
    a:hover{text-decoration:underline}

    /* APPBAR (Ã¶rnek koddaki yapÄ±) */
    .appbar{
      position:sticky; top:0; z-index:60; height:var(--appbar-h);
      background:var(--card); backdrop-filter:blur(10px);
      border-bottom:1px solid var(--stroke);
      display:flex; align-items:center; gap:10px; padding:0 12px;
    }
    .brand{display:flex; align-items:center; gap:10px; cursor:pointer}
    .brand img{width:24px; height:24px}
    .brand span{font-weight:900; letter-spacing:.02em}
    .nav-center{margin:0 auto; height:100%}
    .nav-list{display:flex; gap:22px; align-items:center; height:100%; list-style:none; margin:0; padding:0}
    .nav-item{position:relative; height:100%}
    .nav-btn{height:100%; display:flex; align-items:center; gap:6px; font-weight:800; cursor:pointer}
    .nav-btn:hover{color:var(--brand)}
    .caret{font-size:12px; opacity:.6}
    .dropdown{position:absolute; top:100%; left:0; min-width:240px; background:var(--card); border:1px solid var(--stroke); border-radius:10px; box-shadow:var(--shadow); padding:8px; display:none}
    .dropdown a{display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:8px; color:var(--text); text-decoration:none}
    .dropdown a:hover{background:var(--surface)}
    .nav-item.open .dropdown{display:block}
    .nav-right{display:flex; gap:8px; align-items:center}
    .btn{border:1px solid var(--stroke); background:var(--card); color:var(--text); border-radius:999px; padding:8px 12px; cursor:pointer; white-space:nowrap}
    .hamb{display:none}
    .iconbtn{position:relative; border:1px solid var(--stroke); background:var(--card); color:var(--text); border-radius:999px; padding:8px 12px; cursor:pointer; display:flex; align-items:center; gap:8px}
    .badge{position:absolute; top:-6px; right:-6px; background:var(--danger); color:#fff; font-size:11px; padding:2px 6px; border-radius:999px; border:2px solid var(--card)}
    .drop-right{left:auto; right:0}
    .avatar{width:22px;height:22px;border-radius:999px;background:linear-gradient(180deg,#94a3b8,#64748b)}
    @media (max-width: 960px){ .nav-center{display:none} .hamb{display:inline-flex} }

    /* Drawer (mobil menÃ¼) */
    .drawer{position:fixed; top:var(--appbar-h); right:0; bottom:0; left:30%; transform:translateX(100%); transition:.25s; background:var(--card); border-left:1px solid var(--stroke); z-index:70; overflow:auto; padding:12px}
    .drawer.open{transform:translateX(0)}
    .drawer .panel-title{margin:14px 4px 6px; font-weight:800; color:var(--muted); font-size:13px}
    .drawer a{display:block; padding:10px; border-radius:10px; border:1px solid var(--stroke); margin:6px 0; color:var(--text); background:var(--pill)}
    .drawer a:hover{background:var(--pill-hover)}

    /* CONTENT */
    .container{max-width:1200px; margin:0 auto; padding:16px}
    .card{background:var(--card); border:1px solid var(--stroke); border-radius:14px; box-shadow:var(--shadow); padding:14px}
    .muted{color:var(--muted)}

    /* Header */
    .header-card{display:flex; justify-content:space-between; align-items:center; gap:16px; margin:16px 0}
    .header-left h2{margin:0 0 6px; font-size:18px}

    /* Controls grid (Takrir seÃ§im alanÄ±) */
    .controls-grid{
      display:grid; grid-template-columns:repeat(12,minmax(0,1fr)); gap:10px; align-items:center;
    }
    .grp{grid-column: span 6; border:1px dashed var(--stroke); border-radius:12px; padding:10px; background:var(--pill)}
    .grp .label{ font-size:12.5px; color:var(--muted); font-weight:800; margin-bottom:6px }
    .inline{ display:flex; gap:8px; flex-wrap:wrap; align-items:center }
    select, input[type="text"], input[type="date"]{
      padding:10px 12px; border:1px solid var(--stroke); border-radius:12px; background:var(--card); color:var(--text); font-size:14px;
      min-width:220px;
    }
    .cta{border:1px solid var(--stroke); background:linear-gradient(180deg,var(--brand),var(--brand2)); color:#fff; border-radius:999px; padding:10px 16px; cursor:pointer; font-weight:800; white-space:nowrap}
    .btn-ghost{border:1px solid var(--stroke); background:var(--pill); border-radius:999px; padding:10px 14px; cursor:pointer; white-space:nowrap}
    @media (max-width: 960px){
      .grp{grid-column: span 12}
    }

    /* Lists & tables */
    .sList{ border:1px solid var(--stroke); border-radius:12px; overflow:hidden; background:var(--card) }
    .sHead{ background:var(--pill); padding:8px 10px; font-weight:900; display:flex; gap:10px; align-items:center; justify-content:space-between }
    .sRow{ padding:10px 12px; display:flex; align-items:center; justify-content:space-between; border-top:1px dashed var(--stroke); cursor:pointer }
    .sRow:first-child{ border-top:none }
    .statBadge{ font-size:12px; border:1px solid var(--stroke); border-radius:999px; padding:4px 8px; }
    .tiny{ font-size:11px; color:var(--muted); }

    .st-none{ background:transparent; color:var(--text) }
    .st-verdi{ background:rgba(34,197,94,.08); }
    .st-veremedi{ background:rgba(239,68,68,.12); }
    .st-yarim{ background:rgba(250,204,21,.16); }

    /* Simple table (Ã¶zet) */
    .table{ border:1px solid var(--stroke); border-radius:12px; overflow:hidden }
    .thead, .trow{ display:grid; grid-template-columns:1fr 120px 120px; }
    .thead div{ background:var(--pill); font-weight:900; padding:8px 10px; border-bottom:1px dashed var(--stroke) }
    .trow div{ padding:8px 10px; border-bottom:1px dashed var(--stroke) }
    .trow:last-child div{ border-bottom:none }

    /* Modals & Toast */
    .modal{display:none; position:fixed; inset:0; background:rgba(2,6,23,.6); z-index:99; align-items:center; justify-content:center; padding:16px}
    .modal-content{background:var(--card); border:1px solid var(--stroke); width:95%; max-width:640px; border-radius:16px; box-shadow:var(--shadow); padding:16px}
    .modal-content h3{margin:0 0 10px; text-align:center}
    .modal-content label{display:block; margin-top:8px; font-size:13px; color:var(--muted)}
    .modal-content input, .modal-content select{
      width:100%; padding:10px 12px; border:1px solid var(--stroke); border-radius:10px; background:var(--pill); color:var(--text); margin-top:4px
    }
    .modal-buttons{display:flex; justify-content:flex-end; gap:8px; margin-top:14px}
    .btn-danger{border:1px solid #ef444422; background:#ef4444; color:#fff; border-radius:10px; padding:8px 12px; cursor:pointer}
    .toast{position:fixed; left:50%; bottom:24px; transform:translateX(-50%) translateY(20px); background:rgba(2,6,23,.95); color:#fff; border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:10px 12px; opacity:0; pointer-events:none; transition:opacity .25s, transform .25s; z-index:200}
    .toast.show{opacity:1; transform:translateX(-50%) translateY(0)}
    /* YÃ¼kleniyor progress */
    .loadbox{border:1px dashed var(--stroke); border-radius:12px; padding:10px; background:var(--pill); margin-bottom:10px}
    .loadrow{display:flex; align-items:center; gap:10px}
    .loadbar{position:relative; flex:1; height:10px; background:var(--surface); border:1px solid var(--stroke);
      border-radius:999px; overflow:hidden}
    .loadbar > i{display:block; height:100%; width:0%; background:linear-gradient(90deg,var(--brand),var(--brand2)); transition:width .25s ease}
    .loadpct{min-width:46px; font-weight:800}
    .loadlbl{color:var(--muted); font-size:12.5px}
  </style>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
  <script src="../js/firebase/firebase-init.js"></script>
</head>
<body>

<!-- APPBAR (Ã¶rnek koddaki Ã¼st yÃ¶netim paneli) -->
<div class="appbar">
  <div class="brand" onclick="location.href='../panel.html'">
    <img src="../img/logo.png" alt="logo"><span>KARAAÄAÃ‡ FATÄ°H</span>
  </div>

  <nav class="nav-center"><ul class="nav-list" id="navMain"></ul></nav>

  <div class="nav-right">
    <button class="btn hamb" id="hamburger" title="MenÃ¼">â˜°</button>

    <div class="nav-item">
      <button class="iconbtn" id="btnNotif" title="Bildirimler">ğŸ””
        <span class="badge" id="notifBadge" style="display:none">0</span>
      </button>
      <div class="dropdown drop-right" id="notifDropdown">
        <div class="muted" style="padding:6px 8px">Son bildirimler</div>
        <div id="notifList" style="max-height:300px;overflow:auto"></div>
        <a href="/diger/bildirim.html">TÃ¼m bildirimleri gÃ¶r â†’</a>
      </div>
    </div>

    <div class="nav-item">
      <button class="iconbtn" id="btnProfile" title="Profil">
        <span class="avatar"></span> <span id="profName" class="muted">Profil</span>
      </button>
      <div class="dropdown drop-right" id="profDropdown">
        <a href="/diger/kullanici-yonetimi.html" >ğŸ‘¤ Profil</a>
        <a href="/diger/sistem-ayarlari.html" >âš™ï¸ Ayarlar</a>
        <a href="#" id="btnLogout">ğŸšª Ã‡Ä±kÄ±ÅŸ Yap</a>
      </div>
    </div>
  </div>
</div>

<aside class="drawer" id="drawer"></aside>

<main class="container">

  <!-- HEADER -->
  <section class="card header-card">
    <div class="header-left">
      <h2>Takrir Takibi</h2>
      <div class="muted">BugÃ¼n: <span id="todayText">â€”</span></div>
    </div>
  </section>

  <!-- SEÃ‡Ä°MLER -->
  <section class="card">
    <div class="controls-grid">
      <!-- Devre -->
      <div class="grp">
        <div class="label">Devre SeÃ§</div>
        <div class="inline">
          <select id="selDevre">
            <option value="6.Devre">6.Devre</option>
            <option value="7.Devre">7.Devre</option>
            <option value="8.Devre">8.Devre</option>
          </select>
          <span class="muted">SeÃ§ili devredeki talebeler yÃ¼klenir.</span>
        </div>
      </div>

      <!-- Kitap -->
      <div class="grp">
        <div class="label">Kitap SeÃ§ / Ekle</div>
        <div class="inline">
          <select id="selKitap"><option value="">â€” Kitap SeÃ§ â€”</option></select>
          <button id="btnKitapEkleToggle" class="btn-ghost" type="button">+ Kitap</button>
        </div>
        <div id="kitapEkleWrap" class="inline" style="display:none; margin-top:8px">
          <input id="inpKitap" type="text" placeholder="Kitap adÄ±" />
          <button id="btnKitapKaydet" class="cta" type="button">Kaydet</button>
          <span id="kitapMsg" class="muted"></span>
        </div>
      </div>

      <!-- Ders -->
      <div class="grp">
        <div class="label">Ders SeÃ§ / Ekle (SeÃ§ilen kitaba baÄŸlÄ±)</div>
        <div class="inline">
          <select id="selDers"><option value="">â€” Ders SeÃ§ â€”</option></select>
          <button id="btnDersEkleToggle" class="btn-ghost" type="button">+ Ders</button>
        </div>
        <div id="dersEkleWrap" class="inline" style="display:none; margin-top:8px">
          <input id="inpDers" type="text" placeholder="Ders adÄ±" />
          <button id="btnDersKaydet" class="cta" type="button">Kaydet</button>
          <span id="dersMsg" class="muted"></span>
        </div>
      </div>

      <!-- Rapor / Ä°ÅŸlem -->
      <div class="grp">
        <div class="label">Rapor / Ä°ÅŸlem</div>
        <div class="inline">
          <label><input type="radio" name="mode" value="rapor" checked> Rapor GÃ¶r</label>
          <label><input type="radio" name="mode" value="islem"> Ä°ÅŸlem Yap</label>
          <button id="btnGit" class="cta" type="button">GÃ¶ster</button>
          <button id="btnTakvim" class="btn-ghost" type="button">Kitap &amp; Ders GÃ¶r</button>
          <span id="goMsg" class="muted"></span>
        </div>
      </div>
    </div>
  </section>

  <!-- Ã‡IKTI -->
  <section class="card">
    <div class="sHead">
      <div id="outTitle">â€”</div>
      <div id="subInfo" class="tiny">â€”</div>
    </div>
    <div id="outArea" style="margin-top:10px"></div>
  </section>

  <!-- Ä°ÅLEM: Talebe Listesi -->
  <section id="islemSection" class="card" style="display:none">
    <div class="sList">
      <div class="sHead">
        <div>Talebeler</div>
        <div class="inline">
          <label for="selSort" class="tiny">SÄ±rala:</label>
          <select id="selSort">
            <option value="alpha">Alfabetik (Aâ†’Z)</option>
            <option value="status">Duruma gÃ¶re</option>
          </select>
          <button id="btnListeYenile" class="btn-ghost" type="button">Yenile</button>
        </div>
      </div>
      <div id="talebeList"></div>
    </div>
  </section>

</main>

<!-- DURUM MODAL -->
<div class="modal" id="mModal">
  <div class="modal-content">
    <h3 id="mHead">â€”</h3>
    <label><input type="radio" name="mStat" value="verdi"> Verdi</label>
    <label><input type="radio" name="mStat" value="veremedi"> Veremedi</label>
    <label><input type="radio" name="mStat" value="yarÄ±m kaldÄ±"> YarÄ±m kaldÄ±</label>
    <div class="modal-buttons">
      <button class="btn-ghost" id="mCancel">Kapat</button>
      <button class="cta" id="mSave">Kaydet</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
  /* === Tarih & Tema === */
  (function(){
    const d=new Date();
    const days=['Pazar','Pazartesi','SalÄ±','Ã‡arÅŸamba','PerÅŸembe','Cuma','Cumartesi'];
    document.getElementById('todayText').textContent=`${String(d.getDate()).padStart(2,'0')}.${String(d.getMonth()+1).padStart(2,'0')}.${d.getFullYear()} â€¢ ${days[d.getDay()]}`;
  })();

  /* === Firebase & helpers === */
  const db=firebase.firestore(), auth=firebase.auth();
  const $=(id)=>document.getElementById(id);
  function toast(msg){const t=$('toast'); t.textContent=msg; t.classList.add('show'); clearTimeout(window.__to); window.__to=setTimeout(()=>t.classList.remove('show'),2500);}
  const norm=(s)=>String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();

  /* === ÃœST MENÃœ: Ã¶rnek koddan birebir alÄ±nan akÄ±ÅŸ === */
  let CURRENT_ALLOW=new Set(), CURRENT_DENY=new Set();

  function normalizeUrl(u){
    if(!u) return '#';
    if(/^https?:\/\//i.test(u)) return u;
    if(u.startsWith('/')) return u;
    return '/'+u.replace(/^\.?\//,'');
  }

  async function fetchPanels(allowSet, denySet){
    const res=[];
    try{
      const snap=await db.collection('sayfa_manifesti').get();
      snap.forEach(doc=>{
        const d=doc.data()||{}, id=doc.id, panelTitle=d.title||id;
        const panelGrant = allowSet.has(norm(id)) || allowSet.has(norm(panelTitle));
        let pages = Array.isArray(d.pages)? d.pages : [];
        pages = pages.filter(pg=>{
          const keyNorm=norm(pg.key||pg.title||'');
          const pageGrant=allowSet.has(keyNorm), denied=denySet.has(keyNorm);
          return !denied && (panelGrant || pageGrant);
        }).map(pg=>({ baslik: pg.title||pg.key||'Sayfa', url: pg.path||'#', key: pg.key||pg.title||'', sira: typeof pg.order==='number'? pg.order:9999 }))
          .sort((a,b)=>a.sira-b.sira);
        if(pages.length) res.push({ id, baslik:panelTitle, sira: typeof d.order==='number'? d.order:9999, pages });
      });
      res.sort((a,b)=>a.sira-b.sira);
    }catch(e){ console.error(e); toast('MenÃ¼ manifesti yÃ¼klenemedi.'); }
    return res;
  }

  function renderNav(panels){
    const ul=$('navMain'), drawer=$('drawer');
    ul.innerHTML=''; drawer.innerHTML='';
    if(!panels.length){
      ul.innerHTML='<li class="nav-item"><div class="nav-btn">HiÃ§ panel yok</div></li>';
      drawer.innerHTML='<div style="color:var(--muted);padding:8px">HiÃ§ panel bulunamadÄ±</div>';
      return;
    }
    panels.forEach(p=>{
      const li=document.createElement('li'); li.className='nav-item';
      li.innerHTML=`<div class="nav-btn">${p.baslik} <span class="caret">â–¾</span></div>`;
      const dd=document.createElement('div'); dd.className='dropdown';
      (p.pages||[]).forEach(pg=>{
        const a=document.createElement('a');
        const url=normalizeUrl(pg.url||pg.path||'#');
        a.href=url; a.textContent=pg.baslik;
        a.dataset.key=pg.key||pg.baslik; a.dataset.panel=p.id; a.dataset.panelTitle=p.baslik;
        dd.appendChild(a);
      });
      li.appendChild(dd);
      li.querySelector('.nav-btn').addEventListener('click',(e)=>{
        e.stopPropagation();
        ul.querySelectorAll('.nav-item').forEach(x=>{ if(x!==li) x.classList.remove('open'); });
        li.classList.toggle('open');
      });
      ul.appendChild(li);

      const h=document.createElement('div'); h.className='panel-title'; h.textContent=p.baslik; drawer.appendChild(h);
      (p.pages||[]).forEach(pg=>{
        const a=document.createElement('a');
        const url=normalizeUrl(pg.url||pg.path||'#');
        a.href=url; a.textContent=pg.baslik;
        a.dataset.key=pg.key||pg.baslik; a.dataset.panel=p.id; a.dataset.panelTitle=p.baslik;
        drawer.appendChild(a);
      });
    });
    document.addEventListener('click',(e)=>{ if(!ul.contains(e.target)) ul.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('open')); });
  }

  (function(){ const hamb=$('hamburger'), drawer=$('drawer'); if(!hamb) return; hamb.addEventListener('click',()=>drawer.classList.toggle('open')); document.addEventListener('click',(e)=>{ if(!drawer.contains(e.target) && !hamb.contains(e.target)) drawer.classList.remove('open'); }); })();

  // Link guard
  document.addEventListener('click',(e)=>{
    const a=e.target.closest('a[data-key]'); if(!a) return;
    const key=norm(a.dataset.key), pnl=norm(a.dataset.panel||''), pnlTitle=norm(a.dataset.panelTitle||'');
    if(CURRENT_DENY.has(key)){ e.preventDefault(); toast('Bu sayfa iÃ§in yetkiniz yok.'); return; }
    const allowed = CURRENT_ALLOW.has(key) || CURRENT_ALLOW.has(pnl) || CURRENT_ALLOW.has(pnlTitle);
    if(!allowed){ e.preventDefault(); toast('Bu sayfa iÃ§in yetkiniz yok.'); }
  });

  // Bildirim/Profil dropdown
  (function(){
    const notifBtn=$('btnNotif'), notifDD=$('notifDropdown');
    const profBtn=$('btnProfile'), profDD=$('profDropdown');
    function closeAll(e){
      if(!notifDD.contains(e.target) && e.target!==notifBtn) notifDD.parentElement.classList.remove('open');
      if(!profDD.contains(e.target)  && e.target!==profBtn)  profDD.parentElement.classList.remove('open');
    }
    document.addEventListener('click', closeAll);
    notifBtn?.addEventListener('click',(e)=>{ e.stopPropagation(); notifDD.parentElement.classList.toggle('open'); profDD.parentElement.classList.remove('open'); });
    profBtn ?.addEventListener('click',(e)=>{ e.stopPropagation(); profDD.parentElement.classList.toggle('open'); notifDD.parentElement.classList.remove('open'); });
    $('btnLogout')?.addEventListener('click', async (e) => {
      e.preventDefault();
      try { await auth.signOut(); location.assign('/index.html'); }
      catch (err) { console.error(err); toast('Ã‡Ä±kÄ±ÅŸ yapÄ±lamadÄ±'); }
    });
  })();

  // Bildirim Ã¶rnek
  (async function(){
    try{
      const snap=await db.collection('duyurular').orderBy('createdAt','desc').limit(5).get();
      const badge=$('notifBadge'), list=$('notifList');
      const n=snap.size; if(n>0){ badge.style.display='block'; badge.textContent=n>99?'99+':String(n); }
      if(n===0){ list.innerHTML='<div class="muted" style="padding:6px 8px">Yeni bildirim yok.</div>'; }
      else snap.forEach(doc=>{ const d=doc.data()||{}; const row=document.createElement('a'); row.href='diger/bildirim.html'; row.innerHTML=`<strong>${d.baslik||'Duyuru'}</strong><div class="muted">${d.detay||''}</div>`; list.appendChild(row); });
    }catch(e){}
  })();

  /* === Takrir veri katmanÄ± (revize edilen kÄ±sÄ±mlar) === */
  const PATHS={
    users:'kullanicilar',
    manifest:'sayfa_manifesti',
    talebeler:'talebeler',
    main:'takrir takibi',
    byDate:'takrir takibi tarih',
    index:'takrir_index'
  };

  const STAT_NONE='none', STAT_VERDI='verdi', STAT_VEREMEDI='veremedi', STAT_YARIM='yarÄ±m kaldÄ±';
  function rowClassByStat(s){
    if(s===STAT_VERDI) return 'st-verdi';
    if(s===STAT_VEREMEDI) return 'st-veremedi';
    if(s===STAT_YARIM) return 'st-yarim';
    return 'st-none';
  }
  /* === Durum normalize === */
  function canonStat(raw){
    if(!raw) return STAT_NONE;
    let t = String(raw).trim().toLowerCase();

    // TÃ¼rkÃ§e i varyasyonlarÄ± ve iÅŸaretler
    t = t.replace(/Ä°/g,'i').replace(/Ä±/g,'i')
        .normalize('NFD').replace(/[\u0300-\u036f]/g,''); // diakritik
    t = t.replace(/[.\-_,]/g,' ').replace(/\s+/g,' ').trim();

    const verdiRe = /^(ver(di|ildi)?)$|^tamam$|^ok$|^oldu$|^hazir$|^geldi$/;
    const veremediHit = /ver(emedi|medi|ilmedi)/.test(t) || /^(yok|bos|hic)$/.test(t);
    const yarimHit = /yarim kaldi|yarisi kaldi|yarilad[Ä±i]?|kismen|kismi/.test(t) || t.startsWith('yar');

    if (verdiRe.test(t) || (t.startsWith('ver') && !t.includes('me') && !t.includes('ilme') && !t.includes('eme'))) {
      return STAT_VERDI;
    }
    if (veremediHit) return STAT_VEREMEDI;
    if (yarimHit) return STAT_YARIM;

    return STAT_NONE;
  }
  function toISO10(any){
    if(!any) return null;
    if(typeof any?.toDate === 'function'){ try{ return any.toDate().toISOString().slice(0,10);}catch(_){ return null; } }
    const s=String(any); return /\d{4}-\d{2}-\d{2}/.test(s)? s.slice(0,10): null;
  }
  function daysLate(lessonDateISO10, islemAny){
    const op10 = toISO10(islemAny);
    if(!op10 || !lessonDateISO10) return 0;
    const d0 = new Date(lessonDateISO10 + 'T00:00:00Z');
    const d1 = new Date(op10 + 'T00:00:00Z');
    const diff = Math.floor((d1 - d0) / 86400000);
    return diff > 0 ? diff : 0;
  }

  async function ensureIndexForDevre(devre){
    const ref = db.collection(PATHS.index).doc(devre);
    const doc = await ref.get();
    if(!doc.exists) await ref.set({ kitaplar: [] });
  }
  async function listKitaplar(devre){
    await ensureIndexForDevre(devre);
    const snap = await db.collection(PATHS.index).doc(devre).get();
    const arr = (snap.exists && Array.isArray(snap.data().kitaplar)) ? snap.data().kitaplar : [];
    return arr.sort((a,b)=>a.localeCompare(b,'tr'));
  }
  async function addKitap(devre, kitap){
    if(!kitap) return;
    await ensureIndexForDevre(devre);
    const ref = db.collection(PATHS.index).doc(devre);
    await ref.set({kitaplar: firebase.firestore.FieldValue.arrayUnion(kitap)}, {merge:true});
    await db.collection(PATHS.main).doc(devre).collection(kitap).doc('__meta__').set({created: new Date().toISOString()},{merge:true});
  }
  async function listDerslerWithMeta(devre, kitap){
    if(!kitap) return [];
    const qs = await db.collection(PATHS.main).doc(devre).collection(kitap).get();
    const rows=[];
    qs.forEach(doc=>{
      if(doc.id==='__meta__') return;
      const x=doc.data()||{};
      if(x.created || x.ilkKayitISO || Object.keys(x).length){
        rows.push({ad:doc.id, ilkKayitISO:x.ilkKayitISO||x.created||null, ilkKayitBy:x.ilkKayitBy||null});
      }
    });
    rows.sort((a,b)=>((b.ilkKayitISO||'').localeCompare(a.ilkKayitISO||'')));
    return rows;
  }
  async function addDers(devre, kitap, ders, personel){
    if(!ders) return;
    const nowISO=new Date().toISOString();
    const ref = db.collection(PATHS.index).doc(devre).collection('dersler').doc(kitap);
    await ref.set({ dersler: firebase.firestore.FieldValue.arrayUnion(ders) }, {merge:true});
    await db.collection(PATHS.main).doc(devre).collection(kitap).doc(ders)
      .set({ created: nowISO, ilkKayitISO: nowISO, ilkKayitBy: personel||'â€”' }, {merge:true});
    state.dersKayitISO = nowISO;
  }
  async function loadTalebeler(devre){
    const list=[]; const base=db.collection(PATHS.talebeler).doc(devre).collection('Ã¶ÄŸrenciler');
    const qs=await base.get();
    qs.forEach(d=>{ const x=d.data()||{}; list.push({ uid:d.id, ad:x.kullAd||'â€”' }); });
    return list.sort((a,b)=>a.ad.localeCompare(b.ad,'tr'));
  }
  async function writeStatus({devre, kitap, ders, uid, durum, personel, dersGun}){
    if(!devre || !kitap || !ders || !uid) throw new Error('invalid-params');
    const dersDay = (dersGun && /^\d{4}-\d{2}-\d{2}$/.test(dersGun)) ? dersGun : new Date().toLocaleDateString('sv-SE');
    const opDay   = new Date().toLocaleDateString('sv-SE');
    const dersKey = encodeURIComponent(`${kitap}__${ders}`);
    const nowISOClient = new Date().toISOString();

    const dersTalebeDoc = db.collection(PATHS.main).doc(devre).collection(kitap).doc(ders).collection('talebeler').doc(uid);
    await dersTalebeDoc.set({ durum, personel, dersGunu: dersDay, islemISO: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });

    const byDateDocLesson = db.collection(PATHS.byDate).doc(devre).collection(dersDay).doc(uid);
    await byDateDocLesson.set({ kayitlar: firebase.firestore.FieldValue.arrayUnion({ kitap, ders, durum, personel, islemISOStr: nowISOClient }) }, { merge:true });
    await byDateDocLesson.collection('dersler').doc(dersKey).set({ kitap, ders, durum, personel, dersGun: dersDay, islemISO: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });

    const byDateDocOp = db.collection(PATHS.byDate).doc(devre).collection(opDay).doc(uid);
    await byDateDocOp.set({ _exists:true }, { merge:true });
    await byDateDocOp.collection('dersler').doc(dersKey).set({ kitap, ders, durum, personel, dersGun: dersDay, opGun: opDay, islemISO: firebase.firestore.FieldValue.serverTimestamp() }, { merge:true });

    return { dersDay, opDay, dersKey, islemISOClient: nowISOClient };
  }
  async function readStatuses({devre, kitap, ders, dersISO}){
    const tKey = (dersISO||'').slice(0,10); if(!tKey) return {};
    const col = db.collection(PATHS.byDate).doc(devre).collection(tKey);
    const qs = await col.get();

    const out={}; const dersKey=encodeURIComponent(`${kitap}__${ders}`);
    for (const d of qs.docs){
      const data=d.data()||{};
      try{
        const dersDoc=await col.doc(d.id).collection('dersler').doc(dersKey).get();
        if(dersDoc.exists){
          const x=dersDoc.data()||{};
          if(x.durum){
            const iso = x.islemISO?.toDate ? x.islemISO.toDate().toISOString() : (x.islemISOStr || null);
            out[d.id] = {durum:canonStat(x.durum), islemISO:iso};
            continue;
          }
        }
      }catch(_){}
      if(Array.isArray(data.kayitlar)){
        const relevant=data.kayitlar.filter(x=>x.kitap===kitap && x.ders===ders).sort((a,b)=>(String(b.islemISOStr||'').localeCompare(String(a.islemISOStr||''))));
        if(relevant[0]){ out[d.id] = {durum:canonStat(relevant[0].durum), islemISO:relevant[0].islemISOStr||null}; continue; }
      }
      const mapKey=`${kitap} | ${ders}`;
      if(data[mapKey]?.durum){ out[d.id] = {durum:canonStat(data[mapKey].durum), islemISO:data[mapKey].islemISO||null}; }
    }
    return out;
  }

  /* === UI Durumu === */
  let __ME=''; let state={ devre:'6.Devre', kitap:'', ders:'', dersKayitISO:null, mode:'rapor', talebeler:[], durumMap:{} };
  let modalCtx={ uid:null, ad:'', pre:STAT_NONE };

  function clearOutput(){ $('outArea').innerHTML=''; $('outTitle').textContent='â€”'; $('islemSection').style.display='none'; }

  async function refreshKitap(resetDers=true){
    const kitaplar=await listKitaplar(state.devre);
    const sel=$('selKitap');
    sel.innerHTML=`<option value="">â€” Kitap SeÃ§ â€”</option>`+kitaplar.map(k=>`<option>${k}</option>`).join('');
    state.kitap=sel.value||'';
    if(resetDers) await refreshDers();
  }
  async function refreshDers(){
    const dersSel=$('selDers');
    if(!state.kitap){ dersSel.innerHTML=`<option value="">â€” Ders SeÃ§ â€”</option>`; state.ders=''; return; }
    const dersler=await listDerslerWithMeta(state.devre, state.kitap);
    dersSel.innerHTML=`<option value="">â€” Ders SeÃ§ â€”</option>`+dersler.map(d=>{
      const t=d.ilkKayitISO?` (${d.ilkKayitISO.slice(0,10)})`:'';
      return `<option value="${d.ad}">${d.ad}${t}</option>`;
    }).join('');
    state.ders=dersSel.value||'';
  }

async function showRapor(){
     // dersKayitISO garanti
 if (!state.dersKayitISO) {
   try {
     const mdoc = await db.collection(PATHS.main)
       .doc(state.devre).collection(state.kitap).doc(state.ders).get();
     const m = mdoc.exists ? mdoc.data() : {};
     state.dersKayitISO = m.ilkKayitISO || m.created || new Date().toISOString();
   } catch(_) {
     state.dersKayitISO = new Date().toISOString();
   }
}
  $('islemSection').style.display='none';
  bumpLoading(10);
  loadingLabel('Durumlar okunuyorâ€¦');
    const sabitGun = state.dersKayitISO ? state.dersKayitISO.slice(0,10) : 'â€”';
    $('outTitle').textContent = `Rapor â€¢ ${state.devre} â€¢ ${state.kitap} â€¢ ${state.ders||'â€”'} â€¢ ${sabitGun}`;

  const statuses = await readStatuses({devre:state.devre, kitap:state.kitap, ders:state.ders, dersISO:state.dersKayitISO});
  bumpLoading(55);
  loadingLabel('Talebeler yÃ¼kleniyorâ€¦');

  const talebeler = await loadTalebeler(state.devre);
  bumpLoading(80);
  loadingLabel('Ã–zet hazÄ±rlanÄ±yorâ€¦');

    const total = talebeler.length || 1;
    const start = 80, end = 96; // asÄ±l listede artÄ±racaÄŸÄ±z

    const counts = { verdi:0, 'yarÄ±m kaldÄ±':0, veremedi:0 };
    talebeler.forEach(t=>{
      const st = canonStat((statuses[t.uid]?.durum) || STAT_NONE);
      if(st===STAT_VERDI) counts.verdi++;
      else if(st===STAT_YARIM) counts['yarÄ±m kaldÄ±']++;
      else if(st===STAT_VEREMEDI) counts.veremedi++;
    });

    const wrap=document.createElement('div');

    const table=document.createElement('div'); table.className='table';
    table.innerHTML = `
      <div class="thead"><div>Durum</div><div>Adet</div><div>Oran</div></div>
      ${[['Verdi',counts.verdi],['YarÄ±m kaldÄ±',counts['yarÄ±m kaldÄ±']],['Veremedi',counts.veremedi]]
        .map(([lbl,val])=>{
          const total=talebeler.length||1;
          const oran=((val/total)*100).toFixed(1)+'%';
          return `<div class="trow"><div>${lbl}</div><div>${val}</div><div>${oran}</div></div>`;
        }).join('')}
    `;
    wrap.appendChild(table);

    const list=document.createElement('div'); list.className='sList'; list.style.marginTop='10px';
    list.innerHTML=`<div class="sHead">Talebe DÃ¶kÃ¼mÃ¼<span class="tiny">Toplam: ${talebeler.length}</span></div>`;
    const body=document.createElement('div');

    talebeler.forEach((t, i)=>{
      const rec=statuses[t.uid]||{};
      const st = canonStat(rec.durum || STAT_NONE);
      const late=(st===STAT_VERDI)? daysLate(sabitGun, rec.islemISO) : 0;
      const iso10=toISO10(rec.islemISO);
      const lateInfo=(late>0&&iso10)? `<div class="tiny">! ${iso10} â€” ${late} gÃ¼n geÃ§ verdi</div>` : '';
      const row=document.createElement('div'); row.className='sRow '+rowClassByStat(st);
      row.innerHTML=`<div><div>${t.ad}</div>${lateInfo}</div><div class="statBadge">${st===STAT_NONE?'â€”':st}</div>`;
      body.appendChild(row);
      const p = start + ((i+1)/total) * (end - start);
      bumpLoading(p);
    });
    bumpLoading(99);
    list.appendChild(body);
    wrap.appendChild(list);

    $('outArea').replaceChildren(wrap);
  }

async function showIslem(){
     // dersKayitISO garanti
 if (!state.dersKayitISO) {
   try {
     const mdoc = await db.collection(PATHS.main)
       .doc(state.devre).collection(state.kitap).doc(state.ders).get();
     const m = mdoc.exists ? mdoc.data() : {};
     state.dersKayitISO = m.ilkKayitISO || m.created || new Date().toISOString();
   } catch(_) {
     state.dersKayitISO = new Date().toISOString();
   }
}
  bumpLoading(10);
  loadingLabel('Talebeler yÃ¼kleniyorâ€¦');

    const sabitGun = state.dersKayitISO ? state.dersKayitISO.slice(0,10) : 'â€”';
    $('outTitle').textContent = `Ä°ÅŸlem â€¢ ${state.devre} â€¢ ${state.kitap} â€¢ ${state.ders} â€¢ ${sabitGun}`;

  state.talebeler = await loadTalebeler(state.devre);
  bumpLoading(45);
  loadingLabel('Durumlar okunuyorâ€¦');

  state.durumMap  = await readStatuses({devre:state.devre, kitap:state.kitap, ders:state.ders, dersISO:state.dersKayitISO});
  bumpLoading(70);

    renderTalebeList();
    $('islemSection').style.display='block';
  }

  function renderTalebeList(){
    const box=$('talebeList'); box.innerHTML='';
    const sort=$('selSort').value;
    let rows = state.talebeler.map(t=>{
      const rec  = state.durumMap[t.uid] || {durum:STAT_NONE, islemISO:null};
      const stat = canonStat(rec.durum || STAT_NONE);
      const late = (stat===STAT_VERDI) ? daysLate((state.dersKayitISO||'').slice(0,10), rec.islemISO) : 0;
      return { uid:t.uid, ad:t.ad, stat, islemISO:rec.islemISO, late };
    });
    if(sort==='alpha') rows.sort((a,b)=>a.ad.localeCompare(b.ad,'tr'));
    else if(sort==='status'){
      const order = {[STAT_VEREMEDI]:0, [STAT_YARIM]:1, [STAT_NONE]:2, [STAT_VERDI]:3};
      rows.sort((a,b)=>(order[a.stat]??5)-(order[b.stat]??5) || a.ad.localeCompare(b.ad,'tr'));
    }

    const total = rows.length || 1;
    const start = Math.max(__loading.value, 70), end = 96;

  rows.forEach((r, i)=>{
      const iso10=toISO10(r.islemISO);
      const lateInfo=(r.late>0&&iso10)? `<div class="tiny">! ${iso10} â€” ${r.late} gÃ¼n geÃ§ verdi</div>` : '';
      const row=document.createElement('div'); row.className='sRow '+rowClassByStat(r.stat);
      const p = start + ( (i+1)/total ) * (end - start);
      bumpLoading(p);
      row.innerHTML=`<div><div>${r.ad}</div>${lateInfo}</div><div class="statBadge">${r.stat===STAT_NONE?'â€”':r.stat}</div>`;
      row.onclick=()=>openModal(r);
      box.appendChild(row);
    });
  }

  /* ===== YÃ¼kleniyor %0-100 ===== */
let __loading = { box:null, bar:null, pct:null, lbl:null, timer:null, softCap:85, value:0 };

function loadingStart(label='Veriler getiriliyorâ€¦', softCap=85){
  loadingEnd(); // varsa temizle
  const wrap = document.createElement('div'); wrap.className='loadbox';
  wrap.innerHTML = `
    <div class="loadrow">
      <div class="loadpct" id="ldP">0%</div>
      <div class="loadbar"><i id="ldBar"></i></div>
    </div>
    <div class="loadlbl" id="ldLbl"></div>`;
  const host = document.getElementById('outArea') || document.body;
  host.prepend(wrap);

  __loading = {
    box:wrap,
    bar:wrap.querySelector('#ldBar'),
    pct:wrap.querySelector('#ldP'),
    lbl:wrap.querySelector('#ldLbl'),
    timer:null,
    softCap:softCap,
    value:0
  };
  __loading.lbl.textContent = label;

  // Otomatik kÃ¼Ã§Ã¼k artÄ±ÅŸ (beklerken 85'e kadar)
  __loading.timer = setInterval(()=>{
    if(!__loading) return;
    const cap = __loading.softCap;
    if(__loading.value < cap){
      setLoading(Math.min(cap, __loading.value + 0.6));
    }
  }, 90);
}

function setLoading(p){
  if(!__loading.bar) return;
  const v = Math.max(0, Math.min(100, p));
  __loading.value = v;
  __loading.bar.style.width = v.toFixed(0) + '%';
  __loading.pct.textContent = v.toFixed(0) + '%';
}

function bumpLoading(to){
  if(!__loading.bar) return;
  if(to > __loading.value) setLoading(to);
}

function loadingLabel(t){ if(__loading.lbl) __loading.lbl.textContent = t; }

function loadingEnd(){
  if(__loading.timer){ clearInterval(__loading.timer); __loading.timer=null; }
  if(__loading.bar){ setLoading(100); }
  if(__loading.box){
    const b = __loading.box;
    setTimeout(()=>{ b.remove(); }, 350); // kibarca kaybolsun
  }
  __loading = { box:null, bar:null, pct:null, lbl:null, timer:null, softCap:85, value:0 };
}

  function openModal(r){
    modalCtx={ uid:r.uid, ad:r.ad, pre:r.stat };
    $('mHead').textContent=r.ad;
    document.querySelectorAll('input[name="mStat"]').forEach(i=> i.checked=(i.value===r.stat));
    $('mModal').style.display='flex';
  }
  function closeModal(){ $('mModal').style.display='none'; }
  $('mCancel').addEventListener('click', closeModal);
  $('mSave').addEventListener('click', async ()=>{
    const sel=[...document.querySelectorAll('input[name="mStat"]')].find(i=>i.checked);
    if(!sel){ closeModal(); return; }
    const durum=sel.value;
    try{
      const sabitGun=(state.dersKayitISO||new Date().toISOString()).slice(0,10);
      const wr=await writeStatus({devre:state.devre, kitap:state.kitap, ders:state.ders, uid:modalCtx.uid, durum, personel:__ME||'â€”', dersGun:sabitGun});
      const dersRef=db.collection(PATHS.byDate).doc(state.devre).collection(wr.opDay).doc(modalCtx.uid).collection('dersler').doc(wr.dersKey);
      let islemISO=null;
      try{ const fresh=await dersRef.get(); const x=fresh.exists?(fresh.data()||{}):{}; islemISO = x.islemISO?.toDate ? x.islemISO.toDate().toISOString() : (x.islemISOStr || wr.islemISOClient || null); }
      catch(_){ islemISO=wr.islemISOClient||null; }
      state.durumMap[modalCtx.uid]={durum, islemISO};
      renderTalebeList(); toast('Kaydedildi'); closeModal();
    }catch(err){ console.error(err); alert('Kaydedilemedi'); }
  });

  // Takvim (yalÄ±n â€“ sadece kitap/ders listesi popup yerine toast bilgilendirme)
  $('btnTakvim').addEventListener('click', async ()=>{
    if(!state.kitap){ toast('Ã–nce kitap seÃ§'); return; }
    const dersler=await listDerslerWithMeta(state.devre, state.kitap);
    if(!dersler.length){ toast('Bu kitapta ders yok'); return; }
    toast(`${state.kitap}: ${dersler.map(d=>d.ad).slice(0,5).join(', ')}${dersler.length>5?'â€¦':''}`);
  });

  // SeÃ§imler: eventler
  $('selDevre').addEventListener('change', async ()=>{ state.devre=$('selDevre').value; await refreshKitap(true); clearOutput(); });
  $('selKitap').addEventListener('change', async ()=>{ state.kitap=$('selKitap').value||''; await refreshDers(); clearOutput(); });
  $('selDers').addEventListener('change', async ()=>{
    state.ders=$('selDers').value||''; state.dersKayitISO=null;
    if(state.ders){
      const mdoc=await db.collection(PATHS.main).doc(state.devre).collection(state.kitap).doc(state.ders).get();
      const m=mdoc.exists?mdoc.data():{}; state.dersKayitISO=m.ilkKayitISO||m.created||new Date().toISOString();
    }
  });
  document.querySelectorAll('input[name="mode"]').forEach(r=> r.addEventListener('change', ()=> state.mode=r.value));
$('btnGit').addEventListener('click', async ()=>{
  $('goMsg').textContent='';
  if(!state.kitap){ $('goMsg').textContent='Kitap seÃ§iniz.'; return; }
  if(!state.ders){ $('goMsg').textContent='Ders seÃ§iniz.'; return; }

  loadingStart('Veriler getiriliyorâ€¦', 88);
  try{
    if(state.mode==='rapor') await showRapor();
    else await showIslem();
  } finally {
    loadingEnd();
  }
});

  $('btnKitapEkleToggle').addEventListener('click', ()=>{ const w=$('kitapEkleWrap'); w.style.display=w.style.display==='none'?'flex':'none'; });
  $('btnDersEkleToggle').addEventListener('click', ()=>{ const w=$('dersEkleWrap'); w.style.display=w.style.display==='none'?'flex':'none'; });
  $('btnKitapKaydet').addEventListener('click', async ()=>{
    const kitap=($('inpKitap').value||'').trim(); if(!kitap){ $('kitapMsg').textContent='Kitap adÄ± boÅŸ olamaz.'; return; }
    $('kitapMsg').textContent='Kaydediliyor...';
    try{ await addKitap(state.devre, kitap); $('inpKitap').value=''; $('kitapMsg').textContent='Eklendi.'; await refreshKitap(); }
    catch(e){ console.error(e); $('kitapMsg').textContent='Hata (yetki/baÄŸlantÄ±).'; }
  });
  $('btnDersKaydet').addEventListener('click', async ()=>{
    const ders=($('inpDers').value||'').trim();
    if(!state.kitap){ $('dersMsg').textContent='Ã–nce kitap seÃ§iniz.'; return; }
    if(!ders){ $('dersMsg').textContent='Ders adÄ± boÅŸ olamaz.'; return; }
    $('dersMsg').textContent='Kaydediliyor...';
    try{ await addDers(state.devre, state.kitap, ders, __ME||'â€”'); $('inpDers').value=''; $('dersMsg').textContent='Eklendi.'; await refreshDers(); }
    catch(e){ console.error(e); $('dersMsg').textContent='Hata (yetki/baÄŸlantÄ±).'; }
  });
  $('selSort').addEventListener('change', ()=>renderTalebeList());
  $('btnListeYenile').addEventListener('click', ()=>renderTalebeList());

  /* === Auth + Yetki === */
  try{ firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL); }catch(e){}
  auth.onAuthStateChanged(async (user)=>{
    if(!user){ setTimeout(()=>{ if(!auth.currentUser) location.replace('../index.html'); },150); return; }
    try{
      const uSnap=await db.collection(PATHS.users).doc(user.uid).get();
      const data=uSnap.exists?uSnap.data():{};
      __ME = data.adSoyad || user.displayName || (user.email? user.email.split('@')[0]:'');
      $('profName').textContent = __ME ? (__ME.split(' ')[0]) : 'Profil';

      const rawPerms=Array.isArray(data.yetkiler)? data.yetkiler : [];
      CURRENT_ALLOW=new Set(rawPerms.filter(s=>!String(s).trim().startsWith('-') && !String(s).trim().startsWith('!')).map(norm));
      CURRENT_DENY =new Set(rawPerms.filter(s=> String(s).trim().startsWith('-') || String(s).trim().startsWith('!')).map(s=>norm(String(s).replace(/^[-!]\s*/,''))));

      const panels=await fetchPanels(CURRENT_ALLOW, CURRENT_DENY);
      renderNav(panels);

      // BaÅŸlangÄ±Ã§ verileri
      state.devre = $('selDevre').value;
      await refreshKitap(true);
    }catch(e){ console.error(e); toast('Veriler yÃ¼klenirken hata.'); }
  });
</script>
</body>
</html>
