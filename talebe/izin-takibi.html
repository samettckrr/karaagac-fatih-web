<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>KF | ƒ∞zin Takibi</title>
<link rel="icon" type="image/png" href="../img/logo.png" />

<style>
  /* ========== Tema ========== */
  :root{
    --appbar-h:56px;
    --radius:14px; --shadow:0 12px 28px rgba(0,0,0,.12);
    --bg:#f3f6fc; --card:#ffffff; --stroke:rgba(15,23,42,.12);
    --text:#0b1220; --muted:#4b5563; --surface:#f1f5ff; --surface2:#f6f8ff;
    --brand:#0ea5e9; --brand2:#0284c7;
    --danger:#b91c1c; --success:#16a34a;
    --gap-lg:20px; --gap:14px; --gap-sm:10px;
  }
  @media (prefers-color-scheme: light){
    :root{
      --bg:#f3f6fc; --card:#ffffff; --stroke:rgba(15,23,42,.12);
      --text:#0b1220; --muted:#4b5563; --surface:#f1f5ff; --surface2:#f6f8ff;
      --brand:#0ea5e9; --brand2:#0284c7;
    }
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font-family:'Segoe UI',system-ui,-apple-system,Arial,sans-serif}
  img,svg,video{max-width:100%;height:auto;display:block}

  /* ========== Appbar ========== */
  .appbar{
    position:sticky; top:0; z-index:60; height:var(--appbar-h);
    background:var(--card); backdrop-filter:blur(10px);
    border-bottom:1px solid var(--stroke);
    display:flex; align-items:center; gap:10px; padding:0 12px;
  }
  .brand{display:flex; align-items:center; gap:10px; cursor:pointer}
  .brand img{width:24px; height:24px}
  .brand span{font-weight:900; letter-spacing:.02em}
  .nav-center{margin:0 auto; height:100%}
  .nav-list{display:flex; gap:22px; align-items:center; height:100%; list-style:none; margin:0; padding:0}
  .nav-item{position:relative; height:100%}
  .nav-btn{height:100%; display:flex; align-items:center; gap:6px; font-weight:800; cursor:pointer}
  .nav-btn:hover{color:var(--brand)}
  .caret{font-size:12px; opacity:.6}
  .dropdown{position:absolute; top:100%; left:0; min-width:240px; background:var(--card); border:1px solid var(--stroke); border-radius:12px; box-shadow:var(--shadow); padding:8px; display:none}
  .dropdown a{display:flex; align-items:center; gap:8px; padding:10px 12px; border-radius:10px; color:var(--text); text-decoration:none}
  .dropdown a:hover{background:var(--surface2)}
  .nav-item.open .dropdown{display:block}
  .nav-right{display:flex; gap:8px; align-items:center}
  .btn{border:1px solid var(--stroke); background:var(--card); color:var(--text); border-radius:999px; padding:8px 12px; cursor:pointer; white-space:nowrap}
  .hamb{display:none}
  .iconbtn{position:relative; border:1px solid var(--stroke); background:var(--card); color:var(--text); border-radius:999px; padding:8px 12px; cursor:pointer; display:flex; align-items:center; gap:8px}
  .badge{position:absolute; top:-6px; right:-6px; background:var(--danger); color:#fff; font-size:11px; padding:2px 6px; border-radius:999px; border:2px solid var(--card)}
  .drop-right{left:auto; right:0}
  .avatar{width:22px;height:22px;border-radius:999px;background:linear-gradient(180deg,#94a3b8,#64748b)}
  @media (max-width: 960px){ .nav-center{display:none} .hamb{display:inline-flex} }

  /* ========== Drawer ========== */
  .drawer{position:fixed; top:var(--appbar-h); right:0; bottom:0; left:34%; transform:translateX(100%); transition:.25s; background:var(--card); border-left:1px solid var(--stroke); z-index:70; overflow:auto; padding:16px}
  .drawer.open{transform:translateX(0)}
  .drawer .panel-title{margin:14px 4px 6px; font-weight:800; color:var(--muted); font-size:13px}
  .drawer a{display:block; padding:12px; border-radius:12px; border:1px solid var(--stroke); margin:8px 0; color:var(--text); background:var(--surface2)}
  .drawer a:hover{background:var(--surface)}

  /* ========== Layout ========== */
  .container{max-width:1120px; margin:0 auto; padding:18px; display:grid; gap:var(--gap-lg)}
  .card{background:var(--card); border:1px solid var(--stroke); border-radius:16px; box-shadow:var(--shadow); padding:16px}
  .stack-lg{display:grid; gap:var(--gap-lg)}
  .stack   {display:grid; gap:var(--gap)}
  .row{display:grid; grid-template-columns:repeat(12,minmax(0,1fr)); gap:var(--gap)}
  .col-6{grid-column:span 6} .col-4{grid-column:span 4} .col-3{grid-column:span 3} .col-12{grid-column:span 12}

  @media (max-width: 960px){
    .container{padding:14px}
    .row{grid-template-columns:repeat(6,minmax(0,1fr))}
    .col-6{grid-column:span 6} .col-4{grid-column:span 6} .col-3{grid-column:span 3} .col-12{grid-column:span 6}
  }
  @media (max-width: 640px){
    .row{grid-template-columns:repeat(4,minmax(0,1fr))}
    .col-6,.col-4,.col-3,.col-12{grid-column:span 4}
  }

  .muted{color:var(--muted)}

  /* ========== Form ========== */
  label{display:block; margin-bottom:6px; font-size:13px; color:var(--muted)}
  .field{display:flex; flex-direction:column; gap:6px}
  input,select,textarea{
    width:100%; height:44px; padding:10px 12px; border:1px solid var(--stroke);
    border-radius:12px; background:var(--surface2); color:var(--text); outline:none;
  }
  textarea{height:auto; min-height:88px; resize:vertical}
  input:focus,select:focus,textarea:focus{ box-shadow:0 0 0 3px rgba(14,165,233,.25); border-color:#0ea5e9; background:var(--surface) }
  .hint{font-size:12px; color:var(--muted)}

  /* ========== Minimal Tabs (√ºst) ========== */
  .mini-tabs{
    display:flex; gap:16px; align-items:center;
    border-bottom:1px solid rgba(148,163,184,.16);
    overflow-x:auto; scrollbar-width:none;
  }
  .mini-tabs::-webkit-scrollbar{display:none}
  .mini-tab{
    background:none; border:none; padding:10px 0; font-weight:700; color:var(--muted); cursor:pointer;
    position:relative; white-space:nowrap; font-size:14px;
  }
  .mini-tab.active{color:var(--text)}
  .mini-tab.active::after{
    content:''; position:absolute; left:0; right:0; bottom:-1px; height:2px;
    background:linear-gradient(90deg,var(--brand),var(--brand2));
    border-radius:99px;
  }

  /* ========== Hedef-Teberru alt tabbar ========== */
  .sub-tabs{
    display:flex; gap:14px; margin-bottom:8px;
    overflow-x:auto; scrollbar-width:none;
    padding:3px 3px 2px;
    background:rgba(15,23,42,.04);
    border:1px solid rgba(148,163,184,.08);
    border-radius:999px;
  }
  .sub-tabs::-webkit-scrollbar{display:none}
  .sub-tab{
    background:transparent; border:none; padding:7px 14px 8px;
    font-weight:600; color:var(--muted); cursor:pointer; white-space:nowrap; position:relative; font-size:13px;
    border-radius:999px; transition:.15s ease-out;
  }
  .sub-tab:hover{ background:rgba(148,163,184,.07); color:var(--text); }
  .sub-tab.active{
    color:var(--text); background:rgba(14,165,233,.16);
    box-shadow:0 8px 18px rgba(14,165,233,.22);
  }
  .sub-tab.active::after{
    content:''; position:absolute; right:10px; top:8px; width:6px; height:6px; background:var(--brand); border-radius:999px;
  }

  /* ========== Tables ========== */
  .table-wrap{border:1px solid var(--stroke); border-radius:14px; overflow:auto; background:var(--card)}
  table{width:100%; border-collapse:collapse; min-width:860px}
  th,td{padding:12px 14px; text-align:left; border-bottom:1px solid var(--stroke); font-size:14px}
  thead th{position:sticky; top:0; background:var(--surface)}

  /* ========== Toast ========== */
  .toast{position:fixed; left:50%; bottom:24px; transform:translateX(-50%) translateY(20px); background:rgba(2,6,23,.95); color:#fff; border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:10px 12px; opacity:0; pointer-events:none; transition:opacity .25s, transform .25s; z-index:200}
  .toast.show{opacity:1; transform:translateX(-50%) translateY(0)}

  /* ==== Loader ==== */
  .loading{display:flex; align-items:center; gap:10px; padding:10px 12px; border:1px dashed var(--stroke); border-radius:12px; background:var(--surface); margin-top:10px;}
  .spinner{width:18px; height:18px; border:2px solid rgba(148,163,184,.4); border-top-color: var(--brand); border-radius:50%; animation: spin .8s linear infinite;}
  @keyframes spin{ to{ transform: rotate(360deg); } }
  .btn-ghost{background:transparent; border:1px solid rgba(148,163,184,.16); border-radius:999px; padding:4px 10px; font-size:12px; cursor:pointer; color:var(--text);}

  /* ========== Pretty list rows (ƒ∞≈ülem) ========== */
  .sList{display:grid; gap:10px}
  .sHead{display:flex; align-items:center; justify-content:space-between; padding:6px 2px; color:var(--muted)}
  #iznTalebeList{display:grid; gap:8px}
  .sRow{
    display:flex; align-items:center; justify-content:space-between;
    padding:10px 12px; border:1px solid var(--stroke); border-radius:12px; background:var(--card);
    transition: box-shadow .15s ease, transform .05s ease;
  }
  .sRow:hover{ box-shadow:var(--shadow); transform:translateY(-1px); }
  .sRow .lead{display:flex; gap:10px; align-items:center;}
  .avatar-sm{
    width:32px; height:32px; border-radius:999px; display:inline-flex; align-items:center; justify-content:center;
    font-weight:800; font-size:12px; color:#fff; background:linear-gradient(180deg,#38bdf8,#0ea5e9);
    flex:0 0 32px;
  }
  .sRow .meta{display:grid; gap:2px}
  .sRow .meta .name{font-weight:700}
  .sRow .meta .tiny{color:var(--muted)}
  .sRow .stat{display:flex; gap:10px; align-items:center}
  .chev{opacity:.35; font-size:18px}
  .chip{
    display:inline-flex; align-items:center; gap:6px;
    padding:6px 10px; border-radius:999px; font-size:12px; font-weight:700;
    border:1px solid rgba(148,163,184,.18); background:var(--surface2); color:var(--text);
  }
  .chip--ok{ background:rgba(22,163,74,.12); color:#166534; border-color:rgba(22,163,74,.25); }
  .chip--warn{ background:rgba(245,158,11,.12); color:#92400e; border-color:rgba(245,158,11,.25); }
  .chip--bad{ background:rgba(239,68,68,.12); color:#991b1b; border-color:rgba(239,68,68,.25); }
  .chip--none{ background:rgba(148,163,184,.12); color:#334155; border-color:rgba(148,163,184,.22); }

  /* Row state accents */
  .st-verdi{ box-shadow: inset 0 0 0 1px rgba(22,163,74,.15); }
  .st-yarim{ box-shadow: inset 0 0 0 1px rgba(245,158,11,.15); }
  .st-veremedi{ box-shadow: inset 0 0 0 1px rgba(239,68,68,.15); }
  .st-none{ box-shadow: inset 0 0 0 1px rgba(148,163,184,.15); }

  /* === PRO MODAL v2 (cam-blur + gradient header + sheet) === */
  .modal{
    position:fixed; inset:0; z-index:120;
    display:none; align-items:center; justify-content:center;
    padding:18px;
    background:rgba(2,6,23,.58);
    backdrop-filter:saturate(1.2) blur(6px);
    -webkit-backdrop-filter:saturate(1.2) blur(6px);
    opacity:0; pointer-events:none; transition:opacity .18s ease-out;
  }
  .modal.show{ display:flex; opacity:1; pointer-events:auto; }
  .modal__panel{
    width:96%; max-width:760px; background:var(--card); border:1px solid var(--stroke);
    border-radius:18px; box-shadow:0 20px 60px rgba(0,0,0,.35), 0 1px 0 rgba(255,255,255,.03) inset;
    overflow:hidden; transform:translateY(10px) scale(.985); opacity:.98;
    transition:transform .22s cubic-bezier(.2,.8,.2,1), opacity .22s ease;
  }
  .modal.show .modal__panel{ transform:translateY(0) scale(1); opacity:1; }
  .modal__panel--sm{ max-width:520px; }
  .modal__panel--lg{ max-width:980px; }
  .modal__header{
    position:sticky; top:0; z-index:1; display:flex; align-items:center; justify-content:space-between;
    padding:14px 16px;
    background:
      linear-gradient(180deg, color-mix(in oklab, var(--brand) 28%, transparent), transparent),
      linear-gradient(180deg, var(--surface2, rgba(2,6,23,.06)), transparent);
    border-bottom:1px solid var(--stroke);
  }
  .modal__title{ font-weight:900; letter-spacing:.01em; }
  .modal__close{ border:none; background:transparent; cursor:pointer; font-size:20px; color:var(--muted); line-height:1; border-radius:10px; padding:6px; }
  .modal__close:hover{ color:var(--text); background:rgba(148,163,184,.10); }
  .modal__body{ padding:16px; max-height:calc(80vh - 120px); overflow:auto; display:grid; gap:14px; }
  .modal__footer{
    position:sticky; bottom:0; z-index:1; display:flex; gap:10px; justify-content:flex-end; padding:12px 16px;
    background: linear-gradient(0deg, var(--surface2, rgba(2,6,23,.06)), transparent);
    border-top:1px solid var(--stroke);
  }
  .btn{ border:1px solid var(--stroke); background:var(--surface2, rgba(2,6,23,.06)); color:var(--text); border-radius:999px; padding:10px 14px; cursor:pointer; }
  .btn:hover{ background:rgba(148,163,184,.12); }
  .btn--primary{ border:none; color:#fff; font-weight:800; background:linear-gradient(180deg,var(--brand),var(--brand2)); box-shadow:0 10px 24px color-mix(in oklab, var(--brand2) 30%, transparent); }
  .btn--danger{ border-color:#ef444422; color:#ef4444; }
  @media (max-width:720px){
    .modal{ align-items:flex-end; padding:0; }
    .modal__panel{ width:100%; max-width:none; border-radius:16px 16px 0 0; max-height:86vh; transform:translateY(24px) scale(1); }
    .modal.show .modal__panel{ transform:translateY(0) }
    .modal__body{ max-height:calc(86vh - 120px); }
  }
  @media (prefers-reduced-motion: reduce){ .modal, .modal__panel{ transition:none !important; } }

  /* Modal option grid */
  .option-grid{ display:grid; gap:10px; }
  .option-card{
    display:flex; align-items:center; gap:10px; padding:10px 12px; border:1px solid var(--stroke); border-radius:12px; background:var(--surface2); cursor:pointer;
  }
  .option-card:hover{ background:var(--surface); }
  .option-card .emoji{ font-size:18px }
  .option-card .title{ font-weight:800 }
  .option-card .desc{ font-size:12px; color:var(--muted) }
  .option-card.active{ outline:2px solid color-mix(in oklab, var(--brand) 45%, transparent); background:rgba(14,165,233,.12) }
</style>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
<script src="../js/firebase/firebase-init.js"></script>
</head>
<body>

<!-- APPBAR -->
<div class="appbar">
  <div class="brand" onclick="location.href='../panel.html'">
    <img src="../img/logo.png" alt="logo"><span>KARAAƒûA√á FATƒ∞H</span>
  </div>
  <nav class="nav-center"><ul class="nav-list" id="navMain"></ul></nav>
  <div class="nav-right">
    <button class="btn hamb" id="hamburger" title="Men√º">‚ò∞</button>
    <div class="nav-item">
      <button class="iconbtn" id="btnNotif" title="Bildirimler">üîî
        <span class="badge" id="notifBadge" style="display:none">0</span>
      </button>
      <div class="dropdown drop-right" id="notifDropdown">
        <div class="muted" style="padding:6px 8px">Son bildirimler</div>
        <div id="notifList" style="max-height:300px;overflow:auto"></div>
        <a href="/diger/bildirim.html">T√ºm bildirimleri g√∂r ‚Üí</a>
      </div>
    </div>
    <div class="nav-item">
      <button class="iconbtn" id="btnProfile" title="Profil">
        <span class="avatar"></span> <span id="profName" class="muted">Profil</span>
      </button>
      <div class="dropdown drop-right" id="profDropdown">
        <a href="/diger/kullanici-yonetimi.html" >üë§ Profil</a>
        <a href="/diger/sistem-ayarlari.html" >‚öôÔ∏è Ayarlar</a>
        <a href="#" id="btnLogout">üö™ √áƒ±kƒ±≈ü Yap</a>
      </div>
    </div>
  </div>
</div>
<aside class="drawer" id="drawer"></aside>

<!-- CONTENT -->
<main class="container stack-lg">
  <!-- Ba≈ülƒ±k + √úst Se√ßim -->
  <section class="card stack" id="ustKart">
    <div class="row">
      <div class="col-12">
        <h2 style="margin:0">ƒ∞zin Takibi</h2>
      </div>
      <div class="col-12 muted">Hususi izin ba≈ülatƒ±n, toplu oturum tanƒ±mlayƒ±n ve yoklama raporu olu≈üturun.</div>
    </div>
    <div class="mini-tabs" id="mainFormTabs">
      <button class="mini-tab active" data-target="izinYonetWrap">Hususi ƒ∞zin Y√∂netimi</button>
      <button class="mini-tab" data-target="yoklamaWrap">ƒ∞≈ülem &amp; Rapor</button>
    </div>
  </section>

  <!-- Hususi ƒ∞zin Y√∂netimi -->
  <section class="card stack" id="izinYonetWrap">
    <h3 style="margin:0">Hususi ƒ∞zin Y√∂netimi</h3>
    <div class="muted">Koleksiyon: <strong>izinler</strong> ‚Äî Sadece yetkili kullanƒ±cƒ±lar "aktif izin" ba≈ülatabilir.</div>

    <div class="row" style="margin-top:8px">
      <div class="col-4 field">
        <label>Devre</label>
        <select id="iznt-devre">
          <option value="6.Devre">6.Devre</option>
          <option value="7.Devre">7.Devre</option>
          <option value="8.Devre">8.Devre</option>
        </select>
      </div>
    </div>

    <div class="actions">
      <button class="btn btn--primary" id="btnIzinBaslat">+ ƒ∞zin Ba≈ülat</button>
      <button class="btn" id="btnIzinYenile">Yenile</button>
    </div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>Talebe</th><th>Ba≈ülatan</th><th>Ba≈ülangƒ±√ß</th><th>A√ßƒ±klama</th><th>Durum</th><th>ƒ∞≈ülem</th>
          </tr>
        </thead>
        <tbody id="izinAktifTbody">
          <tr><td colspan="6" class="muted">Kayƒ±t y√ºkleniyor‚Ä¶</td></tr>
        </tbody>
      </table>
    </div>

    <!-- Toplu ƒ∞zin Oturumlarƒ± -->
    <div class="card stack" style="margin-top:12px">
      <h4 style="margin:0">ƒ∞zin Y√∂netimi (T√ºm Talebeye)</h4>
      <div class="muted">T√ºm talebeye ge√ßerli izin oturumunu tanƒ±mlayƒ±n: izin tarihi ve en son d√∂n√º≈ü saati.</div>
      <div class="row">
        <div class="col-4 field">
          <label>ƒ∞zin Tarihi</label>
          <input type="date" id="toplu-izin-tarih" />
        </div>
        <div class="col-4 field">
          <label>En Son D√∂n√º≈ü Saati</label>
          <input type="datetime-local" id="toplu-izin-donus" />
        </div>
        <div class="col-4 field">
          <label>A√ßƒ±klama (ops.)</label>
          <input type="text" id="toplu-izin-aciklama" placeholder="Opsiyonel" />
        </div>
      </div>
      <div class="actions" style="display:flex; gap:8px; flex-wrap:wrap">
        <button class="btn btn--primary" id="topluIzinKaydetBtn" type="button">Kaydet</button>
        <span class="muted" id="topluIzinMsg"></span>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr><th>Tarih</th><th>D√∂n√º≈ü Saati</th><th>A√ßƒ±klama</th><th>ƒ∞≈ülem</th></tr></thead>
          <tbody id="topluIzinTbody"><tr><td colspan="4" class="muted">Oturumlar y√ºkleniyor‚Ä¶</td></tr></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- ƒ∞zin Y√∂netimi (Toplu) ‚Äî √ºstte (izinYonetWrap) i√ßinde yer alƒ±r -->

  <!-- ƒ∞≈ülem & Rapor -->
  <section class="card stack" id="yoklamaWrap" style="display:none">
    <h3 style="margin:0">ƒ∞≈ülem &amp; Rapor</h3>
    <div class="stack" style="margin-top:6px">
      <h4 style="margin:0">Yoklama (Geldi ¬∑ Gelmedi ¬∑ ƒ∞zinli)</h4>
      <div class="muted" style="margin-bottom:6px">Koleksiyonlar: <strong>yoklama</strong> &amp; <strong>yoklama_tarih</strong></div>

      <!-- Controls -->
      <div class="row">
        <div class="col-6 field">
          <label>Devre Se√ß</label>
          <select id="izn-selDevre">
            <option value="6.Devre">6.Devre</option>
            <option value="7.Devre">7.Devre</option>
            <option value="8.Devre">8.Devre</option>
          </select>
        </div>
        <div class="col-6 field">
          <label>ƒ∞zin Oturumu</label>
          <select id="izn-oturum-sel"><option value="">‚Äî Se√ßiniz ‚Äî</option></select>
        </div>
      </div>
      <div class="row">
        <div class="col-12">
          <div class="tiny muted" id="izn-oturum-info">Se√ßili oturum: ‚Äî</div>
          <!-- Hidden inputs kept for internal logic -->
          <input type="hidden" id="izn-tarih" />
          <input type="hidden" id="izn-donus-saat" />
        </div>
      </div>
      <div class="row" style="align-items:end">
        <div class="col-6">
          <div class="sub-tabs" id="iznModeTabs">
            <button type="button" class="sub-tab active" data-mode="rapor">Rapor</button>
            <button type="button" class="sub-tab" data-mode="islem">ƒ∞≈ülem</button>
          </div>
        </div>
        <div class="col-6" style="display:flex; gap:10px; justify-content:flex-end">
          <button class="btn" id="iznYukleBtn" type="button">G√∂ster</button>
          <button class="btn" id="iznYenileBtn" type="button">Yenile</button>
        </div>
      </div>

      <!-- Output -->
      <div class="stack" id="iznRaporWrap" style="display:block">
        <div class="table-wrap" id="iznRaporOut"></div>
      </div>

      <!-- ƒ∞≈ülem listesi -->
      <div class="stack" id="iznIslemWrap" style="display:none">
        <div class="sList">
          <div class="sHead">
            <div>Talebeler (Se√ßili devre)</div>
            <div class="inline">
              <label class="tiny">Sƒ±rala:</label>
              <select id="iznSort">
                <option value="alpha">Alfabetik (A‚ÜíZ)</option>
                <option value="status">Duruma g√∂re</option>
              </select>
              <button class="btn-ghost" id="iznListeYenile" type="button">Yenile</button>
            </div>
          </div>
          <div id="iznTalebeList"></div>
        </div>
      </div>
    </div>
  </section>

  <div style="height:40px"></div>
</main>

<!-- ===== MODALS (PRO v2) ===== -->

<!-- (Sadece izin modallarƒ± a≈üaƒüƒ±da) -->

<!-- ƒ∞zin Ba≈ülat Modal -->
<div class="modal" id="izinBaslatModal" role="dialog" aria-modal="true" aria-labelledby="izinBaslatTitle">
  <div class="modal__panel modal__panel--sm" role="document">
    <div class="modal__header">
      <div class="modal__title" id="izinBaslatTitle">ƒ∞zin Ba≈ülat</div>
      <button class="modal__close" data-close aria-label="Kapat">‚úñ</button>
    </div>
    <div class="modal__body">
      <div class="field">
        <label>Talebe</label>
        <select id="izn-talebe-uid"><option value="">‚Äî Se√ßiniz ‚Äî</option></select>
        <div class="hint">Liste, "ƒ∞zin Ba≈ülat & Y√∂net"te se√ßilen devreye g√∂re y√ºklenir.</div>
      </div>
      <div class="row">
        <div class="col-6 field"><label>Ba≈ülangƒ±√ß</label><input type="datetime-local" id="izn-baslangic" /></div>
        <div class="col-6 field"><label>Planlanan D√∂n√º≈ü (ops.)</label><input type="datetime-local" id="izn-plan-donus" /></div>
      </div>
      <div class="field"><label>A√ßƒ±klama</label><input id="izn-aciklama" placeholder="Opsiyonel" /></div>
    </div>
    <div class="modal__footer">
      <button class="btn" data-close>Vazge√ß</button>
      <button class="btn btn--primary" id="izinBaslatKaydet">Ba≈ülat</button>
    </div>
  </div>
</div>

<!-- ƒ∞zin D√∂n√º≈ü Modal -->
<div class="modal" id="izinDonusModal" role="dialog" aria-modal="true" aria-labelledby="izinDonusTitle">
  <div class="modal__panel modal__panel--sm" role="document">
    <div class="modal__header">
      <div class="modal__title" id="izinDonusTitle">ƒ∞zin D√∂n√º≈ü</div>
      <button class="modal__close" data-close aria-label="Kapat">‚úñ</button>
    </div>
    <div class="modal__body">
      <input type="hidden" id="izn-doc-id" />
      <div class="field"><label>D√∂n√º≈ü Zamanƒ±</label><input type="datetime-local" id="izn-donus-zaman" /></div>
      <div class="field"><label>Not (ops.)</label><input id="izn-donus-not" placeholder="Opsiyonel" /></div>
    </div>
    <div class="modal__footer">
      <button class="btn" data-close>Vazge√ß</button>
      <button class="btn btn--primary" id="izinDonusKaydet">D√∂n√º≈ü√º ƒ∞≈üle</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
/* ===== Helpers ===== */
const db=firebase.firestore(), auth=firebase.auth();
const userAgent = navigator.userAgent || '';
const cihazTipi = ()=> (window.innerWidth<700?'mobile':(window.innerWidth<960?'tablet':'desktop'));
const tsISO = ()=> new Date().toISOString();
const norm=(s)=> String(s||'').normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim();
function toast(msg){const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); clearTimeout(window.__to); window.__to=setTimeout(()=>t.classList.remove('show'),2400);}
function toNum(v){ if (typeof v === 'number') return v; if (typeof v === 'string'){ const n=Number(v.replace(/\./g,'').replace(',', '.')); return isNaN(n)?0:n; } return 0; }
function normalizeUrl(u){ if(!u) return '#'; if(/^https?:\/\//i.test(u)) return u; if(u.startsWith('/')) return u; return '/'+u.replace(/^\.?\//,''); }
const MONTHS_TR=["Ocak","≈ûubat","Mart","Nisan","Mayƒ±s","Haziran","Temmuz","Aƒüustos","Eyl√ºl","Ekim","Kasƒ±m","Aralƒ±k"];
function formatMonthLabel(val){ if(!val) return ''; const [y, m] = val.split('-'); const mi = Number(m); const ad = MONTHS_TR[mi-1] || m; return ad + ' ' + y; }
function initials(name){ const parts=String(name||'').trim().split(/\s+/); const a=(parts[0]||'')[0]||''; const b=(parts[1]||'')[0]||''; return (a+b).toUpperCase(); }
function chipClass(stat){ if(stat==='geldi') return 'chip--ok'; if(stat==='izinli') return 'chip--warn'; if(stat==='gelmedi') return 'chip--bad'; return 'chip--none'; }

/* ===== Modal utils (PRO v2) ===== */
function openModal(id){
  const m=document.getElementById(id);
  if(!m) return;
  m.classList.add('show');
  const fp = m.querySelector('button.btn--primary, .modal__close, button, [href], input, select, textarea');
  fp?.focus?.({preventScroll:true});
}
function closeModal(el){
  const m = el?.closest?.('.modal') || document.querySelector('.modal.show');
  m?.classList.remove('show');
}
document.addEventListener('click',(e)=>{
  if(e.target.matches('[data-close]')) closeModal(e.target);
  if(e.target.classList?.contains('modal')) e.target.classList.remove('show');
});
document.addEventListener('keydown',(e)=>{
  if(e.key==='Escape'){ document.querySelectorAll('.modal.show').forEach(m=>m.classList.remove('show')); }
});

/* ===== NAV (manifest) ===== */
let CURRENT_ALLOW=new Set(), CURRENT_DENY=new Set();
async function fetchPanels(allowSet, denySet){
  const res=[]; try{
    const snap=await db.collection('sayfa_manifesti').get();
    snap.forEach(doc=>{
      const d=doc.data()||{}, id=doc.id, panelTitle=d.title||id;
      const panelGrant = allowSet.has(norm(id)) || allowSet.has(norm(panelTitle));
      let pages = Array.isArray(d.pages)? d.pages : [];
      pages = pages.filter(pg=>{
        const keyNorm=norm(pg.key||pg.title||'');
        const pageGrant=allowSet.has(keyNorm), denied=denySet.has(keyNorm);
        return !denied && (panelGrant || pageGrant);
      }).map(pg=>({ baslik: pg.title||pg.key||'Sayfa', url: pg.path||'#', key: pg.key||pg.title||'', sira: typeof pg.order==='number'? pg.order:9999 }))
        .sort((a,b)=>a.sira-b.sira);
      if(pages.length) res.push({ id, baslik:panelTitle, sira: typeof d.order==='number'? d.order:9999, pages });
    });
    res.sort((a,b)=>a.sira-b.sira);
  }catch(e){ console.error(e); toast('Men√º y√ºklenemedi'); }
  return res;
}
function renderNav(panels){
  const ul=document.getElementById('navMain'), drawer=document.getElementById('drawer');
  ul.innerHTML=''; drawer.innerHTML='';
  if(!panels.length){
    ul.innerHTML='<li class="nav-item"><div class="nav-btn">Panel yok</div></li>';
    drawer.innerHTML='<div class="muted" style="padding:8px">Men√º bulunamadƒ±</div>'; return;
  }
  panels.forEach(p=>{
    const li=document.createElement('li'); li.className='nav-item';
    li.innerHTML=`<div class="nav-btn">${p.baslik} <span class="caret">‚ñæ</span></div>`;
    const dd=document.createElement('div'); dd.className='dropdown';
    (p.pages||[]).forEach(pg=>{
      const a=document.createElement('a');
      a.href=normalizeUrl(pg.url || pg.path || '#'); a.textContent=pg.baslik;
      a.dataset.key=pg.key||pg.baslik; a.dataset.panel=p.id; a.dataset.panelTitle=p.baslik;
      dd.appendChild(a);
    });
    li.appendChild(dd);
    li.querySelector('.nav-btn').addEventListener('click',(e)=>{
      e.stopPropagation();
      ul.querySelectorAll('.nav-item').forEach(x=>{ if(x!==li) x.classList.remove('open'); });
      li.classList.toggle('open');
    });
    ul.appendChild(li);

    const h=document.createElement('div'); h.className='panel-title'; h.textContent=p.baslik; drawer.appendChild(h);
    (p.pages||[]).forEach(pg=>{
      const a=document.createElement('a');
      a.href=normalizeUrl(pg.url || pg.path || '#'); a.textContent=pg.baslik;
      a.dataset.key=pg.key||pg.baslik; a.dataset.panel=p.id; a.dataset.panelTitle=p.baslik;
      drawer.appendChild(a);
    });
  });
  document.addEventListener('click',(e)=>{ if(!ul.contains(e.target)) ul.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('open')); });
}
(function(){ const hamb=document.getElementById('hamburger'), drawer=document.getElementById('drawer'); if(!hamb) return; hamb.addEventListener('click',()=>drawer.classList.toggle('open')); document.addEventListener('click',(e)=>{ if(!drawer.contains(e.target) && !hamb.contains(e.target)) drawer.classList.remove('open'); }); })();
document.addEventListener('click',(e)=>{
  const a=e.target.closest('a[data-key]'); if(!a) return;
  const key=norm(a.dataset.key), pnl=norm(a.dataset.panel||''), pnlTitle=norm(a.dataset.panelTitle||'');
  if(CURRENT_DENY.has(key)){ e.preventDefault(); toast('Bu sayfa i√ßin yetkiniz yok.'); return; }
  const allowed = CURRENT_ALLOW.has(key) || CURRENT_ALLOW.has(pnl) || CURRENT_ALLOW.has(pnlTitle);
  if(!allowed){ e.preventDefault(); toast('Bu sayfa i√ßin yetkiniz yok.'); }
});
(function(){
  const notifBtn=document.getElementById('btnNotif'), notifDD=document.getElementById('notifDropdown');
  const profBtn=document.getElementById('btnProfile'), profDD=document.getElementById('profDropdown');
  function closeAll(e){
    if(!notifDD.contains(e.target) && e.target!==notifBtn) notifDD.parentElement.classList.remove('open');
    if(!profDD.contains(e.target)  && e.target!==profBtn)  profDD.parentElement.classList.remove('open');
  }
  document.addEventListener('click', closeAll);
  notifBtn?.addEventListener('click',(e)=>{ e.stopPropagation(); notifDD.parentElement.classList.toggle('open'); profDD.parentElement.classList.remove('open'); });
  profBtn ?.addEventListener('click',(e)=>{ e.stopPropagation(); profDD.parentElement.classList.toggle('open'); notifDD.parentElement.classList.remove('open'); });
  document.getElementById('btnLogout')?.addEventListener('click', async (e) => {
    e.preventDefault();
    try { await auth.signOut(); location.assign('/index.html'); }
    catch(err){ console.error(err); toast('√áƒ±kƒ±≈ü yapƒ±lamadƒ±'); }
  });
})();

/* ===== √úst minimal sekmeler ===== */
(function(){
  const tabs=document.querySelectorAll('#mainFormTabs .mini-tab');
  tabs.forEach(t=>t.addEventListener('click',()=>{
    tabs.forEach(x=>x.classList.remove('active'));
    t.classList.add('active');
    const target=t.dataset.target;
    const ids=['izinYonetWrap','yoklamaWrap'];
    ids.forEach(id=>{ const el=document.getElementById(id); if(el) el.style.display = (target===id)?'':'none'; });
  }));
})();

/* (ƒ∞zin dƒ±≈üƒ± alt sekmeler kaldƒ±rƒ±ldƒ±) */

/* ===== Auth & profil adƒ± ===== */
let currentUser=null, currentUserName='';
try{ firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL); }catch(e){}
auth.onAuthStateChanged(async (user)=>{
  currentUser=user||null;
  if(!user){
    setTimeout(()=>{ if(!auth.currentUser) location.replace('index.html'); },150);
    return;
  }
  try{
    const profEl = document.getElementById('profName');
    const uSnap = await db.collection('kullanicilar').doc(user.uid).get();
    const data  = uSnap.exists ? (uSnap.data()||{}) : {};
    let gosterilecek = (data.adSoyad || '').trim();
    if(!gosterilecek && user.displayName) gosterilecek = user.displayName.trim();
    if(!gosterilecek && user.email){
      const namePart = user.email.split('@')[0];
      gosterilecek = namePart.charAt(0).toUpperCase() + namePart.slice(1);
    }
    currentUserName = gosterilecek || '';
    profEl.textContent = (gosterilecek.split(' ')[0] || 'Profil');

    const rawPerms=Array.isArray(data.yetkiler)? data.yetkiler : [];
    CURRENT_ALLOW=new Set(rawPerms.filter(s=>!String(s).trim().startsWith('-') && !String(s).trim().startsWith('!')).map(norm));
    CURRENT_DENY =new Set(rawPerms.filter(s=> String(s).trim().startsWith('-') || String(s).trim().startsWith('!')).map(s=>norm(String(s).replace(/^[-!]\s*/,''))));
    const panels=await fetchPanels(CURRENT_ALLOW, CURRENT_DENY);
    renderNav(panels);

    // ƒ∞zin yetki durumunu deƒüerlendir
    applyIzinRights();
    // Aktif izinleri √ßek
    loadAktifIzinler();
  }catch(e){ console.error(e); }
});

/* ===== Bildirimler (ops.) ===== */
(async function(){
  try{
    const snap=await db.collection('duyurular').orderBy('createdAt','desc').limit(5).get();
    const badge=document.getElementById('notifBadge'), list=document.getElementById('notifList');
    const n=snap.size; if(n>0){ badge.style.display='block'; badge.textContent=n>99?'99+':String(n); }
    if(n===0){ list.innerHTML='<div class="muted" style="padding:6px 8px">Yeni bildirim yok.</div>'; }
    else snap.forEach(doc=>{ const d=doc.data()||{}; const row=document.createElement('a'); row.href='/diger/bildirim.html'; row.innerHTML=`<strong>${d.baslik||'Duyuru'}</strong><div class="muted">${d.detay||''}</div>`; list.appendChild(row); });
  }catch(e){}
})();

/* ===== Aidat¬∑Kitap (devre dƒ±≈üƒ±: eleman yoksa atla) ===== */
(function(){
  const kitapIndirimSel = document.getElementById('kitapIndirim');
  const kitapIndWrap = document.getElementById('kitapIndirimWrap');
  function kayitPreviewGuncelle(){
    const prev=document.getElementById('kayitPreview'); if(!prev) return;
    const adEl=document.getElementById('talebeAd'), aidatEl=document.getElementById('aidatTutar'),
          aidatIndEl=document.getElementById('aidatIndirim'), kitapEl=document.getElementById('kitapTutar'),
          kitapIndSel=document.getElementById('kitapIndirim'), kitapIndMEl=document.getElementById('kitapIndirimMiktar');
    if(!adEl||!aidatEl||!aidatIndEl||!kitapEl||!kitapIndSel||!kitapIndMEl) return;
    const ad = adEl.value.trim();
    const aidat = toNum(aidatEl.value||0);
    const aidatInd = parseFloat(aidatIndEl.value||0);
    const kitap = toNum(kitapEl.value||0);
    const kitapIndSec = kitapIndSel.value;
    const kitapIndMiktar = toNum(kitapIndMEl.value||0);
    const aidatOdenecek = Math.max(0, aidat - (aidat * aidatInd));
    const kitapOdenecek = Math.max(0, kitapIndSec==='custom' ? (kitap - kitapIndMiktar) : kitap);
    prev.innerText =
      `${ad || '‚Äî'} toplam bor√ß: ${(aidatOdenecek+kitapOdenecek).toLocaleString('tr-TR')} ‚Ç∫  (Aidat: ${aidatOdenecek.toLocaleString('tr-TR')} ‚Ç∫, Kitap: ${kitapOdenecek.toLocaleString('tr-TR')} ‚Ç∫)`;
  }
  if(kitapIndirimSel && kitapIndWrap){
    kitapIndirimSel.addEventListener('change', e=>{
      kitapIndWrap.style.display = (e.target.value === 'custom' ? 'block' : 'none');
      kayitPreviewGuncelle();
    });
  }
  ['#talebeAd','#aidatTutar','#aidatIndirim','#kitapTutar','#kitapIndirim','#kitapIndirimMiktar']
    .forEach(sel=>{ const el=document.querySelector(sel); if(el) el.addEventListener('input', kayitPreviewGuncelle); });
  if(document.getElementById('kayitPreview')) kayitPreviewGuncelle();
  const btnBorcu=document.getElementById('btnBorcuKaydet');
  if(btnBorcu) btnBorcu.addEventListener('click', async ()=>{
    const ad = (document.getElementById('talebeAd')?.value||'').trim();
    if(!ad) return toast('Talebe adƒ± bo≈ü olamaz.');
    const aidat = toNum(document.getElementById('aidatTutar').value||0);
    const aidatInd = parseFloat(document.getElementById('aidatIndirim').value||0);
    const kitap = toNum(document.getElementById('kitapTutar').value||0);
    const kitapIndSec = document.getElementById('kitapIndirim').value;
    const kitapIndMiktar = toNum(document.getElementById('kitapIndirimMiktar').value||0);
    const aidatOdenecek = Math.max(0, aidat - (aidat * aidatInd));
    const kitapOdenecek = Math.max(0, kitapIndSec==='custom' ? (kitap - kitapIndMiktar) : kitap);
    try{
      await db.collection('talebe_borclar').add({
        isim: ad, toplamAidat: aidatOdenecek, toplamKitap: kitapOdenecek,
        tarih: tsISO(), createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        createdBy: currentUser?.email || null, uid: currentUser?.uid || null, userAgent, cihaz: cihazTipi()
      });
      toast('‚úÖ Talebe bor√ß kaydƒ± olu≈üturuldu.');
    }catch(e){ console.error(e); toast('Kayƒ±t sƒ±rasƒ±nda hata.'); }
  });
  ['#odemeTalebe','#odemeTuru','#odemeMiktar','#odemeYontemi'].forEach(sel=>{
    const el=document.querySelector(sel);
    if(el) el.addEventListener('input', ()=>{
      const ad = (document.getElementById('odemeTalebe')?.value||'').trim();
      const tur = (document.getElementById('odemeTuru')?.value||'');
      const miktar = toNum(document.getElementById('odemeMiktar')?.value||0);
      const yontem = (document.getElementById('odemeYontemi')?.value||'');
      const prev=document.getElementById('odemePreview'); if(prev) prev.innerText = `${ad || '‚Äî'}: ${miktar.toLocaleString('tr-TR')} ‚Ç∫ ${tur} tahsil edildi (${yontem}).`;
    });
  });
  const btnOdeme=document.getElementById('btnOdemeKaydet');
  if(btnOdeme) btnOdeme.addEventListener('click', async ()=>{
    const ad = (document.getElementById('odemeTalebe')?.value||'').trim();
    const tur = (document.getElementById('odemeTuru')?.value||'');
    const miktar = toNum(document.getElementById('odemeMiktar')?.value||0);
    const yontem = (document.getElementById('odemeYontemi')?.value||'');
    if(!ad || !miktar) return toast('Talebe adƒ± ve miktar zorunlu.');
    try{
      await db.collection('aidat_kitap').add({
        isim: ad, islemTuru: tur, miktar, odemeYontemi: yontem,
        tarih: tsISO(), createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        createdBy: currentUser?.email || null, uid: currentUser?.uid || null, userAgent, cihaz: cihazTipi()
      });
      toast('üí∞ Tahsilat kaydedildi.');
    }catch(e){ console.error(e); toast('Tahsilat kaydedilemedi.'); }
  });
})();

/* ===== Veri Giri≈üi (3 mod) ===== */
(function(){
  const vgMode = document.getElementById('vgMode');
  const formHedef = document.getElementById('formHedef');
  const formTeberru = document.getElementById('formTeberru');
  const formKurban = document.getElementById('formKurban');
  const tbrTarih = document.getElementById('tbr-tarih');
  const tbrTarihGoster = document.getElementById('tbr-tarih-goster');

  if(!vgMode) return;
  if(tbrTarih){
    const now = new Date();
    const iso = now.toISOString().slice(0,7);
    tbrTarih.value = iso;
    tbrTarihGoster.value = formatMonthLabel(iso);
    tbrTarih.addEventListener('change', ()=>{ tbrTarihGoster.value = formatMonthLabel(tbrTarih.value); });
  }

  vgMode.addEventListener('click', (e)=>{
    const btn = e.target.closest('.sub-tab'); if(!btn) return;
    vgMode.querySelectorAll('.sub-tab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const mode = btn.dataset.mode;
    formHedef.style.display = (mode==='hedef') ? 'grid' : 'none';
    formTeberru.style.display = (mode==='teberru') ? 'grid' : 'none';
    formKurban.style.display = (mode==='kurban') ? 'grid' : 'none';
  });
})();

/* ===== Veri Giri≈üi Kaydet ===== */
document.getElementById('btnVeriGirisOnay')?.addEventListener('click', ()=>{
  const aktifTab = document.querySelector('#vgMode .sub-tab.active')?.dataset.mode || 'hedef';

  if(aktifTab === 'hedef'){
    const kategori = (document.getElementById('kategoriVG').value || '').trim();
    const personel = document.getElementById('giris-personel').value;
    const veren    = (document.getElementById('giris-veren').value || '').trim();
    const miktar   = toNum(document.getElementById('giris-miktar').value);
    const nereyeGeldi = document.getElementById('giris-turu').value;
    const aciklama = (document.getElementById('giris-aciklama').value || '').trim();
    const tarihSel = document.getElementById('giris-tarih')?.value || '';

    if(!kategori) return toast('Kategori se√ßiniz.');
    if(!personel || !veren || !miktar || !nereyeGeldi) return toast('T√ºm zorunlu alanlarƒ± doldurunuz.');

    const html = `
      <p>T√ºr: <strong>Hedef</strong></p>
      <p>Kategori: ${kategori}</p>
      <p>Personel: ${personel}</p>
      <p>Veren: ${veren}</p>
      <p>Miktar: ${miktar.toLocaleString('tr-TR')} ‚Ç∫</p>
      <p>Giri≈ü: ${nereyeGeldi}</p>
      ${aciklama ? `<p>A√ßƒ±klama: ${aciklama}</p>`:''}
      ${tarihSel ? `<p>Kayƒ±t Zamanƒ±: ${tarihSel.replace('T',' ')}</p>`:''}
    `;
    openOnay(`Veri Giri≈üi > ${kategori}`, html, async ()=>{
      try{
        const payload = { kategori, personel, adSoyad: veren, miktar, nereyeGeldi, tur:'hedef', aciklama: aciklama||'',
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          tarih: tarihSel ? new Date(tarihSel).toISOString() : new Date().toISOString(),
          createdBy: currentUser?.email || null, uid: currentUser?.uid || null, userAgent, cihaz: cihazTipi()
        };
        await db.collection('veriler').add(payload);
        toast('‚úÖ Veri (hedef) kaydedildi.');
        ['giris-veren','giris-miktar','giris-aciklama','giris-tarih'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
      }catch(e){ console.error(e); toast('Veri kaydƒ± sƒ±rasƒ±nda hata olu≈ütu.'); }
      finally{ closeModal(document.getElementById('onayModal')); }
    });
  }

  else if(aktifTab === 'teberru'){
    const donemVal = document.getElementById('tbr-tarih').value;
    const donemLabel = formatMonthLabel(donemVal);
    const personel = document.getElementById('tbr-personel').value;
    const veren = (document.getElementById('tbr-veren').value || '').trim();
    const miktar = toNum(document.getElementById('tbr-miktar').value);
    const nereye = document.getElementById('tbr-nereye').value;
    const aciklama = (document.getElementById('tbr-aciklama').value || '').trim();
    const tarihOps = document.getElementById('tbr-tarih-ops').value;

    if(!donemVal) return toast('Tarih (Ay/Yƒ±l) se√ßiniz.');
    if(!personel || !veren || !miktar || !nereye) return toast('Tarih, personel, veren, miktar ve giri≈ü alanlarƒ± zorunlu.');

    const [yilStr, ayStr] = donemVal.split('-');
    const yil = Number(yilStr), ay = Number(ayStr);

    const html = `
      <p>T√ºr: <strong>Teberru</strong></p>
      <p>D√∂nem: ${donemLabel}</p>
      <p>Personel: ${personel}</p>
      <p>Veren: ${veren}</p>
      <p>Miktar: ${miktar.toLocaleString('tr-TR')} ‚Ç∫</p>
      <p>Giri≈ü: ${nereye}</p>
      ${aciklama ? `<p>A√ßƒ±klama: ${aciklama}</p>`:''}
      ${tarihOps ? `<p>Kayƒ±t Zamanƒ±: ${tarihOps.replace('T',' ')}</p>`:''}
    `;
    openOnay(`Veri Giri≈üi > Teberru (${donemLabel})`, html, async ()=>{
      try{
        const payload = {
          kategori:'Teberru', personel, adSoyad:veren, miktar, nereyeGeldi:nereye, tur:'teberru',
          aciklama: aciklama||'', ay, yil, ayYilKey:donemVal, ayYilLabel:donemLabel,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          tarih: tarihOps ? new Date(tarihOps).toISOString() : new Date().toISOString(),
          createdBy: currentUser?.email || null, uid: currentUser?.uid || null, userAgent, cihaz: cihazTipi()
        };
        await db.collection('veriler').add(payload);
        toast('‚úÖ Teberru kaydedildi.');
        ['tbr-veren','tbr-miktar','tbr-aciklama','tbr-tarih-ops'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
      }catch(e){ console.error(e); toast('Teberru kaydƒ± sƒ±rasƒ±nda hata.'); }
      finally{ closeModal(document.getElementById('onayModal')); }
    });
  }

  else { // kurban
    const kategori = document.getElementById('krb-kategori').value; // kucukbas | buyukbas
    const personel = document.getElementById('krb-personel').value;
    const sahip = (document.getElementById('krb-sahip').value || '').trim();
    const kesimYeri = (document.getElementById('krb-kesim-yeri').value || '').trim();
    const kesimTarih = document.getElementById('krb-kesim-tarih').value;
    const aciklama = (document.getElementById('krb-aciklama').value || '').trim();

    if(!kategori) return toast('Kurban kategorisi se√ßiniz.');
    if(!personel) return toast('Personel se√ßiniz.');
    if(!sahip) return toast('Kurban sahibinin adƒ±nƒ± giriniz.');

    const kesimISO = kesimTarih ? new Date(kesimTarih+'T00:00:00').toISOString() : new Date().toISOString();
    const kesimDate = new Date(kesimISO);
    const yil = kesimDate.getFullYear(), ay = kesimDate.getMonth()+1;
    const ayKey = kesimDate.toISOString().slice(0,7), ayLabel = formatMonthLabel(ayKey);

    const html = `
      <p>T√ºr: <strong>Kurban</strong></p>
      <p>Kategori: ${kategori === 'kucukbas' ? 'K√º√ß√ºkba≈ü' : 'B√ºy√ºkba≈ü'}</p>
      <p>Personel: ${personel}</p>
      <p>Kurban Sahibi: ${sahip}</p>
      <p>Kesim Yeri: ${kesimYeri || '-'}</p>
      <p>Kesim Tarihi: ${kesimTarih ? kesimTarih : 'Bug√ºn (otomatik)'}</p>
      ${aciklama ? `<p>A√ßƒ±klama: ${aciklama}</p>`:''}
      <p>Miktar: 1</p>
      <p>D√∂nem: ${ayLabel}</p>
    `;
    openOnay(`Veri Giri≈üi > Kurban`, html, async ()=>{
      try{
        const payload = {
          kategori:'Kurban', kurbanKategori:kategori, personel, adSoyad:sahip, kesimYeri:kesimYeri||'',
          kesimTarihi: kesimISO, miktar:1, tur:kategori, ay, yil, ayYilKey:ayKey, ayYilLabel:ayLabel,
          aciklama: aciklama||'', createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          tarih: new Date().toISOString(), createdBy: currentUser?.email || null, uid: currentUser?.uid || null,
          userAgent, cihaz: cihazTipi()
        };
        await db.collection('veriler').add(payload);
        toast('‚úÖ Kurban kaydedildi.');
        ['krb-sahip','krb-kesim-yeri','krb-kesim-tarih','krb-aciklama'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
      }catch(e){ console.error(e); toast('Kurban kaydedilemedi.'); }
      finally{ closeModal(document.getElementById('onayModal')); }
    });
  }
});

/* ===== Veri Listeleme / D√ºzenleme ===== */
document.getElementById('vdYukleBtn')?.addEventListener('click', ()=> verileriListele(true));
document.getElementById('kategoriVD')?.addEventListener('change', ()=> verileriListele(true));
document.getElementById('vd-personel')?.addEventListener('change', ()=> verileriListele(true));

async function autoListVD(){ try{ await verileriListele(); }catch(e){} }

async function verileriListele(showLoading = false){
  const kat = (document.getElementById('kategoriVD').value || '').trim();
  const per = document.getElementById('vd-personel').value;
  const kon = document.getElementById('vd-liste');
  const btn = document.getElementById('vdYukleBtn');
  const loader = document.getElementById('vd-loading');

  if(!kat){ kon.innerHTML = '<div class="muted" style="padding:8px">Kategori se√ßiniz.</div>'; return; }

  if(showLoading){ loader.style.display = 'flex'; btn.disabled = true; btn.textContent = 'Y√ºkleniyor‚Ä¶'; }
  kon.innerHTML = '';

  let q = db.collection('veriler').where('kategori','==', kat);
  if (per) q = q.where('personel','==', per);

  let rows = null;
  try {
    const snap = await q.orderBy('createdAt','desc').limit(300).get();
    rows = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
  } catch (err) {
    if (err?.code === 'failed-precondition' || /index/i.test(err?.message||'')) {
      try {
        const snap = await q.limit(300).get();
        rows = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }))
          .sort((a,b)=>{
            const ta = a.createdAt?.toDate ? a.createdAt.toDate().getTime() : (a.tarih ? new Date(a.tarih).getTime() : 0);
            const tb = b.createdAt?.toDate ? b.createdAt.toDate().getTime() : (b.tarih ? new Date(b.tarih).getTime() : 0);
            return tb - ta;
          });
      } catch (e2) { console.error(e2); toast('Liste alƒ±namadƒ±.'); rows = []; }
    } else { console.error(err); toast('Liste alƒ±namadƒ±.'); rows = []; }
  }

  if (!rows || rows.length === 0) {
    kon.innerHTML = '<div class="muted" style="padding:8px">Kayƒ±t bulunamadƒ±.</div>';
  } else {
    let html = `<table><thead><tr><th>Tarih</th><th>Personel</th><th>Ad Soyad</th><th>Miktar</th><th>Giri≈ü</th><th>T√ºr</th><th>A√ßƒ±klama</th><th>ƒ∞≈ülem</th></tr></thead><tbody>`;
    rows.forEach(d=>{
      const t = d.createdAt?.toDate ? d.createdAt.toDate() : (d.tarih ? new Date(d.tarih) : null);
      const tStr = t ? t.toLocaleString('tr-TR') : '-';
      let turGoster = d.tur || 'hedef';
      if (turGoster === 'kucukbas') turGoster = 'Kurban (K√º√ß√ºkba≈ü)';
      else if (turGoster === 'buyukbas') turGoster = 'Kurban (B√ºy√ºkba≈ü)';
      html += `
        <tr data-id="${d.id}">
          <td>${tStr}</td><td>${d.personel || '-'}</td><td>${d.adSoyad || d.veren || d.kurbanSahibi || '-'}</td>
          <td>${d.miktar !== undefined ? '‚Ç∫'+(Number(d.miktar||0)).toLocaleString('tr-TR') : '-'}</td>
          <td>${d.nereyeGeldi || '-'}</td><td>${turGoster}</td><td>${d.aciklama || '-'}</td>
          <td><button class="btn-ghost duzenle">D√ºzenle</button><button class="btn-ghost sil" style="border-color:#ef444422;color:#ef4444">Sil</button></td>
        </tr>`;
    });
    html += `</tbody></table>`;
    kon.innerHTML = html;

    kon.querySelector('tbody').addEventListener('click', (e)=>{
      const tr = e.target.closest('tr'); if(!tr) return;
      const id = tr.getAttribute('data-id');
      if (e.target.classList.contains('duzenle')) veriDuzenleAc(id);
      if (e.target.classList.contains('sil')) veriSil(id);
    });
  }

  if(showLoading){ loader.style.display = 'none'; btn.disabled = false; btn.textContent = 'Y√ºkle'; }
}

/* ===== D√ºzenle/Sil ===== */
const vdModal=document.getElementById('veriDuzenleModal');
async function veriDuzenleAc(docId){
  try{
    const ref=db.collection('veriler').doc(docId);
    const snap=await ref.get();
    if(!snap.exists) return toast('Kayƒ±t bulunamadƒ±.');
    const d=snap.data()||{};
    document.getElementById('vdDocId').value=docId;
    document.getElementById('vdAdSoyad').value=d.adSoyad || d.veren || '';
    document.getElementById('vdMiktar').value=toNum(d.miktar);
    document.getElementById('vdNereyeGeldi').value=d.nereyeGeldi || 'Nakit';
    const turVal = d.tur || 'hedef';
    document.getElementById('vdTur').value = (turVal === 'kucukbas' || turVal === 'buyukbas') ? turVal : turVal;
    document.getElementById('vdAciklama').value=d.aciklama || '';
    openModal('veriDuzenleModal');
  }catch(e){ console.error(e); toast('Kayƒ±t getirilemedi.'); }
}
document.getElementById('vdKaydetBtn')?.addEventListener('click', async ()=>{
  const id=document.getElementById('vdDocId').value;
  if(!id) return;
  try{
    await db.collection('veriler').doc(id).set({
      adSoyad: (document.getElementById('vdAdSoyad').value || '').trim(),
      miktar: toNum(document.getElementById('vdMiktar').value),
      nereyeGeldi: document.getElementById('vdNereyeGeldi').value,
      tur: document.getElementById('vdTur').value,
      aciklama: (document.getElementById('vdAciklama').value || '').trim(),
      updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedBy: currentUser?.email || null
    }, { merge:true });
    toast('‚úÖ Kayƒ±t g√ºncellendi.');
    closeModal(document.getElementById('veriDuzenleModal'));
    verileriListele();
  }catch(e){ console.error(e); toast('G√ºncelleme hatasƒ±.'); }
});
async function veriSil(docId){
  if(!confirm('Bu kaydƒ± silmek istiyor musunuz?')) return;
  try{ await db.collection('veriler').doc(docId).delete(); toast('üóëÔ∏è Kayƒ±t silindi.'); verileriListele(); }
  catch(e){ console.error(e); toast('Silme sƒ±rasƒ±nda hata.'); }
}

/* ===== KATEGORƒ∞ (devre dƒ±≈üƒ±: eleman yoksa atla) ===== */
let KATEGORILER = [];
async function kategorileriYukle(){
  const hasUI = document.getElementById('kgListe') || document.getElementById('kategoriHT') || document.getElementById('kategoriVG') || document.getElementById('kategoriVD');
  if(!hasUI) return;
  try{
    const snap = await db.collection('kategoriler').orderBy('ad','asc').get();
    KATEGORILER = [];
    snap.forEach(doc=>{
      const d=doc.data()||{};
      KATEGORILER.push({
        id:doc.id, ad:d.ad || d.isim || 'Adsƒ±z', tip:d.tip || 'hedef',
        kayitTarihi:d.kayitTarihi || d.createdAt?.toDate?.()?.toISOString?.() || null, createdAt:d.createdAt || null
      });
    });
  }catch(e){
    console.error(e);
    KATEGORILER = [
      {id:'static1',ad:'Kitap Kampanyasƒ±',tip:'hedef',kayitTarihi:null},
      {id:'static6',ad:'Teberru',tip:'teberru',kayitTarihi:null}
    ];
  }
  renderKategoriList(); kategorileriFormlaraYay();
}
function renderKategoriList(){
  const tb = document.getElementById('kgListe');
  if(!tb) return;
  if(!KATEGORILER.length){ tb.innerHTML = `<tr><td colspan="4" class="muted">Kategori bulunamadƒ±.</td></tr>`; return; }
  tb.innerHTML = KATEGORILER.map(k=>{
    const t = k.kayitTarihi ? new Date(k.kayitTarihi).toLocaleString('tr-TR') : '-';
    return `<tr data-id="${k.id}">
      <td>${k.ad}</td><td>${k.tip}</td><td>${t}</td>
      <td><button class="btn-ghost kg-edit">D√ºzenle</button>
          <button class="btn-ghost kg-del" style="color:#ef4444;border-color:#ef444422">Sil</button></td>
    </tr>`;
  }).join('');
  tb.querySelectorAll('.kg-edit').forEach(btn=>{
    btn.addEventListener('click',(e)=>{ const id=e.target.closest('tr').dataset.id; kategoriEditAc(id); });
  });
  tb.querySelectorAll('.kg-del').forEach(btn=>{
    btn.addEventListener('click',async (e)=>{ const id=e.target.closest('tr').dataset.id; await kategoriSil(id); });
  });
}
function kategorileriFormlaraYay(){
  const hedefKats = KATEGORILER.filter(k=>k.tip==='hedef' || k.tip==='herikisi');
  const teberruKats = KATEGORILER.filter(k=>k.tip==='teberru' || k.tip==='herikisi');
  const elHT = document.getElementById('kategoriHT'); if(elHT){ elHT.innerHTML = '<option value="">Se√ßiniz</option>' + hedefKats.map(k=>`<option value="${k.ad}">${k.ad}</option>`).join(''); }
  const elHD = document.getElementById('kategoriHD'); if(elHD){ elHD.innerHTML = '<option value="">Se√ßiniz</option>' + hedefKats.map(k=>`<option value="${k.ad}">${k.ad}</option>`).join(''); }
  const elVG = document.getElementById('kategoriVG'); if(elVG){ elVG.innerHTML = '<option value="">Se√ßiniz</option>' + hedefKats.map(k=>`<option value="${k.ad}">${k.ad}</option>`).join(''); }
  const elVD = document.getElementById('kategoriVD');
  if(elVD){
    elVD.innerHTML = '<option value="">Se√ßiniz</option>'
      + hedefKats.map(k=>`<option value="${k.ad}">${k.ad}</option>`).join('')
      + `<option value="Teberru">Teberru</option>`
      + `<option value="Kurban">Kurban</option>`;
  }
}
document.getElementById('kgKaydetBtn')?.addEventListener('click', async ()=>{
  const ad=(document.getElementById('kgAd').value||'').trim();
  const tip=(document.getElementById('kgTip').value||'hedef');
  if(!ad) return toast('Kategori adƒ± bo≈ü olamaz.');
  try{
    await db.collection('kategoriler').add({
      ad, tip, aktif:true, kayitTarihi: new Date().toISOString(),
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      createdBy: currentUser?.email || null, uid: currentUser?.uid || null, userAgent, cihaz: cihazTipi()
    });
    toast('‚úÖ Kategori eklendi.');
    document.getElementById('kgAd').value='';
    await kategorileriYukle();
  }catch(e){ console.error(e); toast('Kategori kaydedilemedi.'); }
});
const kgModalEl=document.getElementById('kgModal');
function kategoriEditAc(id){
  const k = KATEGORILER.find(x=>x.id===id);
  if(!k) return;
  document.getElementById('kgEditId').value = k.id;
  document.getElementById('kgEditAd').value = k.ad;
  document.getElementById('kgEditTip').value = k.tip;
  openModal('kgModal');
}
document.getElementById('kgEditKaydet')?.addEventListener('click', async ()=>{
  const id=document.getElementById('kgEditId').value;
  const ad=(document.getElementById('kgEditAd').value||'').trim();
  const tip=document.getElementById('kgEditTip').value;
  if(!id || !ad) return toast('Eksik bilgi.');
  try{
    await db.collection('kategoriler').doc(id).set({
      ad, tip, updatedAt: firebase.firestore.FieldValue.serverTimestamp(), updatedBy: currentUser?.email || null
    }, {merge:true});
    toast('‚úÖ Kategori g√ºncellendi.');
    closeModal(kgModalEl);
    await kategorileriYukle();
  }catch(e){ console.error(e); toast('Kategori g√ºncellenemedi.'); }
});
async function kategoriSil(id){
  if(!confirm('Bu kategoriyi silmek istiyor musunuz?')) return;
  try{ await db.collection('kategoriler').doc(id).delete(); toast('üóëÔ∏è Kategori silindi.'); await kategorileriYukle(); }
  catch(e){ console.error(e); toast('Kategori silinemedi.'); }
}

/* ===== ƒ∞Zƒ∞N Y√ñNETƒ∞Mƒ∞ ===== */
const IZIN_YETKILI_EMAILS = new Set([
  'samettckrr@gmail.com',
  'tahakeskin4437@gmail.com',
  'ahmetaliemresahin@gmail.com',
  'frknfz33@gmail.com'
].map(s=>String(s).toLowerCase()));
function applyIzinRights(){
  const btn = document.getElementById('btnIzinBaslat');
  const can = IZIN_YETKILI_EMAILS.has(String(currentUser?.email||'').toLowerCase());
  btn.dataset.locked = can ? '0' : '1';
  btn.title = can ? 'ƒ∞zin ba≈ülat' : 'ƒ∞zin ba≈ülatma yetkiniz yok';
}
// ƒ∞zin ba≈ülat devre/talebe se√ßimi
let __IZNY = { devre:'6.Devre', talebeler:[], uidToName:new Map() };
async function iznyLoadTalebeler(){
  try{
    const list=[]; const base=db.collection('talebeler').doc(__IZNY.devre).collection('√∂ƒürenciler');
    const qs=await base.get();
    __IZNY.uidToName = new Map();
    qs.forEach(d=>{ const x=d.data()||{}; const ad=x.kullAd||'‚Äî'; list.push({uid:d.id, ad}); __IZNY.uidToName.set(d.id, ad); });
    list.sort((a,b)=>a.ad.localeCompare(b.ad,'tr'));
    const sel=document.getElementById('izn-talebe-uid'); if(sel){ sel.innerHTML='<option value=\"\">‚Äî Se√ßiniz ‚Äî</option>'+list.map(t=>`<option value="${t.uid}">${t.ad}</option>`).join(''); }
    __IZNY.talebeler=list;
  }catch(e){ console.error(e); }
}
document.getElementById('iznt-devre')?.addEventListener('change', async ()=>{
  __IZNY.devre = document.getElementById('iznt-devre').value;
  await iznyLoadTalebeler();
});

/* Toplu ƒ∞zin Oturumu ‚Äî FS helpers */
async function topluIzinKaydet({devre, tarihISO10, donusISO, aciklama}){
  if(!devre || !tarihISO10 || !donusISO) throw new Error('invalid');
  const now = new Date().toISOString();
  const ref = db.collection('izin_oturumlari').doc(`${devre}__${tarihISO10}`);
  await ref.set({
    devre, tarihISO10, donusISO, aciklama: aciklama||'',
    updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
    updatedBy: currentUser?.email || null,
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    createdBy: currentUser?.email || null,
    _clientAt: now
  }, { merge:true });
}
async function topluIzinListe(devre){
  const rows=[];
  try{
    const snap=await db.collection('izin_oturumlari').where('devre','==',devre).get();
    snap.forEach(d=>{ const x=d.data()||{}; rows.push({ id:d.id, ...x }); });
  }catch(e){ console.error(e); }
  rows.sort((a,b)=> String(b.tarihISO10||'').localeCompare(String(a.tarihISO10||'')) );
  return rows;
}
async function topluIzinSil(docId){ if(!docId) return; try{ await db.collection('izin_oturumlari').doc(docId).delete(); }catch(e){ console.error(e); } }

async function renderTopluIzinListe(){
  const tb=document.getElementById('topluIzinTbody'); if(!tb) return;
  tb.innerHTML = `<tr><td colspan="4" class="muted">Y√ºkleniyor‚Ä¶</td></tr>`;
  const devre = document.getElementById('iznt-devre')?.value || '6.Devre';
  const rows = await topluIzinListe(devre);
  if(!rows.length){ tb.innerHTML = `<tr><td colspan="4" class="muted">Kayƒ±tlƒ± oturum yok.</td></tr>`; return; }
  tb.innerHTML = rows.map(x=>{
    const tStr = x.tarihISO10 || '‚Äî';
    const dStr = x.donusISO ? new Date(x.donusISO).toLocaleString('tr-TR') : '‚Äî';
    return `<tr data-id="${x.id}" data-date="${tStr}" data-donus="${x.donusISO||''}">
      <td>${tStr}</td><td>${dStr}</td><td>${x.aciklama||'-'}</td>
      <td>
        <button class="btn-ghost ti-use">Se√ß</button>
        <button class="btn-ghost ti-del" style="color:#ef4444;border-color:#ef444422">Sil</button>
      </td>
    </tr>`;
  }).join('');
  // actions
  tb.querySelectorAll('.ti-del').forEach(btn=>{
    btn.addEventListener('click', async (e)=>{
      const tr=e.target.closest('tr'); const id=tr?.dataset?.id; if(!id) return;
      if(!confirm('Bu oturumu silmek istiyor musunuz?')) return;
      await topluIzinSil(id); toast('üóëÔ∏è Oturum silindi.'); renderTopluIzinListe(); renderIzinOturumSelect();
    });
  });
  tb.querySelectorAll('.ti-use').forEach(btn=>{
    btn.addEventListener('click',(e)=>{
      const tr=e.target.closest('tr');
      const date=tr?.dataset?.date||''; const don=tr?.dataset?.donus||'';
      const tInput=document.getElementById('izn-tarih'); const dInput=document.getElementById('izn-donus-saat');
      if(tInput && date) tInput.value=date;
      if(dInput && don)  dInput.value = don; // ISO string as stored (no TZ shift)
      __IZN_STATE.donusSaatISO = don || null;
      toast('Oturum se√ßildi.');
    });
  });
}
async function renderIzinOturumSelect(){
  const sel=document.getElementById('izn-oturum-sel'); if(!sel) return;
  const devre=document.getElementById('izn-selDevre')?.value || '6.Devre';
  const rows = await topluIzinListe(devre);
  sel.innerHTML = '<option value="">‚Äî Se√ßiniz ‚Äî</option>' + rows.map(x=>{
    const lbl = `${x.tarihISO10 || '‚Äî'} ‚Ä¢ ${x.donusISO ? new Date(x.donusISO).toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'}) : '‚Äî'}`;
    return `<option value="${x.id}" data-date="${x.tarihISO10||''}" data-donus="${x.donusISO||''}">${lbl}</option>`;
  }).join('');
}
document.getElementById('topluIzinKaydetBtn')?.addEventListener('click', async ()=>{
  const devre=document.getElementById('iznt-devre')?.value||'6.Devre';
  const t=document.getElementById('toplu-izin-tarih')?.value||'';
  const d=document.getElementById('toplu-izin-donus')?.value||'';
  const a=(document.getElementById('toplu-izin-aciklama')?.value||'').trim();
  const msg=document.getElementById('topluIzinMsg');
  if(!t||!d){ if(msg) msg.textContent='Tarih ve d√∂n√º≈ü saati zorunlu.'; return; }
  try{
    if(msg) msg.textContent='Kaydediliyor...';
    await topluIzinKaydet({devre, tarihISO10:t, donusISO:new Date(d).toISOString(), aciklama:a});
    if(msg) msg.textContent='Kaydedildi.'; toast('‚úÖ Oturum kaydedildi.');
    await renderTopluIzinListe(); await renderIzinOturumSelect();
  }catch(e){ console.error(e); if(msg) msg.textContent='Kaydedilemedi.'; toast('Hata: Kaydedilemedi.'); }
});
document.getElementById('izn-oturum-sel')?.addEventListener('change', (e)=>{
  const opt = e.target.selectedOptions?.[0]; if(!opt) return;
  const date=opt.getAttribute('data-date')||''; const don=opt.getAttribute('data-donus')||'';
  const tInput=document.getElementById('izn-tarih'); const dInput=document.getElementById('izn-donus-saat');
  if(tInput && date) tInput.value=date;
  if(dInput && don)  dInput.value = don; // keep ISO as-is
  // state & info
  __IZN_STATE.iso10 = date || __IZN_STATE.iso10;
  __IZN_STATE.donusSaatISO = don || null;
  const info=document.getElementById('izn-oturum-info');
  if(info){ info.textContent = date ? `Se√ßili oturum: ${date} ‚Ä¢ ${don ? new Date(don).toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'}) : '‚Äî'}` : 'Se√ßili oturum: ‚Äî'; }
  toast('Oturum uygulandƒ±.');
});
document.getElementById('btnIzinYenile').addEventListener('click', loadAktifIzinler);
document.getElementById('btnIzinBaslat').addEventListener('click', ()=>{
  const can = document.getElementById('btnIzinBaslat').dataset.locked !== '1';
  if(!can){ toast('Bu i≈ülem i√ßin yetkiniz yok.'); return; }
  // varsayƒ±lan ba≈ülangƒ±√ß: ≈üimdi, planlanan d√∂n√º≈ü: +2 g√ºn 21:00
  const now = new Date(); const isoNow = now.toISOString().slice(0,16);
  const plan = new Date(now.getTime()+2*24*60*60*1000); plan.setHours(21,0,0,0);
  const planIso = plan.toISOString().slice(0,16);
  const talSel=document.getElementById('izn-talebe-uid'); if(talSel) talSel.value='';
  document.getElementById('izn-baslangic').value=isoNow;
  document.getElementById('izn-plan-donus').value=planIso;
  document.getElementById('izn-aciklama').value='';
  openModal('izinBaslatModal');
});
document.getElementById('izinBaslatKaydet').addEventListener('click', async ()=>{
  const uid = (document.getElementById('izn-talebe-uid')?.value||'').trim();
  if(!uid) return toast('Talebe se√ßiniz.');
  const talebe = __IZNY.uidToName.get(uid) || '‚Äî';
  const bas = document.getElementById('izn-baslangic').value;
  const plan = document.getElementById('izn-plan-donus').value;
  const acik = (document.getElementById('izn-aciklama').value||'').trim();
  try{
    await db.collection('izinler').add({
      talebe, talebeUid: uid,
      devre: __IZNY.devre || null,
      baslatan: currentUserName || (currentUser?.email||''),
      baslangic: bas ? new Date(bas).toISOString() : new Date().toISOString(),
      planlananDonus: plan ? new Date(plan).toISOString() : null,
      aciklama: acik || '',
      durum:'aktif',
      createdAt: firebase.firestore.FieldValue.serverTimestamp(),
      uid: currentUser?.uid || null, createdBy: currentUser?.email || null,
      cihaz: cihazTipi(), userAgent
    });
    toast('‚úÖ ƒ∞zin ba≈ülatƒ±ldƒ±.');
    closeModal(document.getElementById('izinBaslatModal'));
    loadAktifIzinler();
  }catch(e){ console.error(e); toast('ƒ∞zin ba≈ülatƒ±lamadƒ±.'); }
});

async function loadAktifIzinler(){
  const tb = document.getElementById('izinAktifTbody');
  tb.innerHTML = `<tr><td colspan="6" class="muted">Y√ºkleniyor‚Ä¶</td></tr>`;
  try{
    let rows=null;
    try{
      const snap = await db.collection('izinler').where('durum','==','aktif').orderBy('createdAt','desc').limit(200).get();
      rows = snap.docs.map(doc=>({ id:doc.id, ...(doc.data()||{}) }));
    }catch(err){
      // index yoksa/failed-precondition: fallback (orderBy olmadan al, client-side sƒ±rala)
      if (err?.code === 'failed-precondition' || /index/i.test(err?.message||'')) {
        const snap = await db.collection('izinler').where('durum','==','aktif').limit(200).get();
        rows = snap.docs.map(doc=>({ id:doc.id, ...(doc.data()||{}) }))
          .sort((a,b)=>{
            const ta = a.createdAt?.toDate ? a.createdAt.toDate().getTime() : (a.baslangic ? new Date(a.baslangic).getTime() : 0);
            const tb = b.createdAt?.toDate ? b.createdAt.toDate().getTime() : (b.baslangic ? new Date(b.baslangic).getTime() : 0);
            return tb - ta;
          });
      } else { throw err; }
    }
    if(!rows || rows.length===0){ tb.innerHTML = `<tr><td colspan="6" class="muted">Aktif izin yok.</td></tr>`; return; }
    let html='';
    rows.forEach(d=>{
      const t = d.baslangic ? new Date(d.baslangic) : (d.createdAt?.toDate ? d.createdAt.toDate() : null);
      const tStr = t ? t.toLocaleString('tr-TR') : '-';
      html += `<tr data-id="${d.id}">
        <td>${d.talebe||'-'}</td>
        <td>${d.baslatan||'-'}</td>
        <td>${tStr}</td>
        <td>${d.aciklama||'-'}</td>
        <td><span style="color:${'var(--success)'};font-weight:700">Aktif</span></td>
        <td>
          <button class="btn-ghost izn-donus">D√∂n√º≈ü</button>
          <button class="btn-ghost izn-iptal" style="border-color:#ef444422;color:#ef4444">ƒ∞ptal</button>
        </td>
      </tr>`;
    });
    tb.innerHTML = html;
    tb.querySelectorAll('.izn-donus').forEach(btn=>btn.addEventListener('click', e=>{
      const tr = e.target.closest('tr'); const id = tr?.dataset?.id; if(!id) return;
      document.getElementById('izn-doc-id').value = id;
      const now = new Date().toISOString().slice(0,16);
      document.getElementById('izn-donus-zaman').value = now;
      document.getElementById('izn-donus-not').value = '';
      openModal('izinDonusModal');
    }));
    tb.querySelectorAll('.izn-iptal').forEach(btn=>btn.addEventListener('click', async e=>{
      const tr = e.target.closest('tr'); const id = tr?.dataset?.id; if(!id) return;
      if(!confirm('Bu izni iptal etmek istiyor musunuz?')) return;
      try{
        await db.collection('izinler').doc(id).set({
          durum:'iptal', iptalAt: firebase.firestore.FieldValue.serverTimestamp(),
          iptalBy: currentUser?.email || null
        }, {merge:true});
        toast('üóëÔ∏è ƒ∞zin iptal edildi.');
        loadAktifIzinler();
      }catch(err){ console.error(err); toast('ƒ∞zin iptal edilemedi.'); }
    }));
  }catch(e){ console.error(e); tb.innerHTML = `<tr><td colspan="6" class="muted">Liste alƒ±namadƒ±.</td></tr>`; }
}

document.getElementById('izinDonusKaydet').addEventListener('click', async ()=>{
  const id = document.getElementById('izn-doc-id').value;
  if(!id) return;
  const dts = document.getElementById('izn-donus-zaman').value;
  const not = (document.getElementById('izn-donus-not').value||'').trim();
  try{
    await db.collection('izinler').doc(id).set({
      durum:'dondu',
      donusAt: dts ? new Date(dts).toISOString() : new Date().toISOString(),
      donusNot: not || '',
      updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
      updatedBy: currentUser?.email || null
    }, {merge:true});
    toast('‚úÖ D√∂n√º≈ü i≈ülendi.');
    closeModal(document.getElementById('izinDonusModal'));
    loadAktifIzinler();
  }catch(e){ console.error(e); toast('D√∂n√º≈ü i≈ülenemedi.'); }
});

/* ===== Yoklama (Geldi ¬∑ Gelmedi ¬∑ ƒ∞zinli) ===== */
(function setupIzinTabs(){
  const tabs=document.getElementById('iznModeTabs');
  if(!tabs) return;
  tabs.addEventListener('click',(e)=>{
    const btn=e.target.closest('.sub-tab'); if(!btn) return;
    tabs.querySelectorAll('.sub-tab').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    const mode=btn.dataset.mode;
    document.getElementById('iznRaporWrap').style.display = (mode==='rapor')?'':'none';
    document.getElementById('iznIslemWrap').style.display = (mode==='islem')?'':'none';
  });
})();

const IZN_PATHS = { main:'yoklama', byDate:'yoklama_tarih', talebeler:'talebeler' };
const IZN_STAT_GELDI='geldi', IZN_STAT_GELMEDI='gelmedi', IZN_STAT_IZINLI='izinli', IZN_STAT_NONE='none';
function iznCanonStat(s){
  const t=norm(s);
  if(!t) return IZN_STAT_NONE;
  if(t.startsWith('gel') && !t.includes('me')) return IZN_STAT_GELDI;
  if(t.includes('izin')) return IZN_STAT_IZINLI;
  if(t.includes('gelmedi') || t.includes('yok')) return IZN_STAT_GELMEDI;
  return IZN_STAT_NONE;
}
async function iznLoadTalebeler(devre){
  const out=[]; try{
    const qs=await db.collection(IZN_PATHS.talebeler).doc(devre).collection('√∂ƒürenciler').get();
    qs.forEach(d=>{ const x=d.data()||{}; out.push({ uid:d.id, ad:x.kullAd||'‚Äî' }); });
  }catch(_){}
  return out.sort((a,b)=>a.ad.localeCompare(b.ad,'tr'));
}
function iznToISO10(any){ if(!any) return null; if(any?.toDate){ try{return any.toDate().toISOString().slice(0,10);}catch(_){return null;} } const s=String(any); return /^\d{4}-\d{2}-\d{2}/.test(s)? s.slice(0,10): null; }

async function iznWriteStatusFast({devre, iso10, uid, durum, personel, personelUid, donusSaatISO}){
  if(!devre || !iso10 || !uid) throw new Error('invalid-params');
  const nowISO = new Date().toISOString();
  const day = iso10;
  const batch=db.batch();
  // 1) main: yoklama/{devre}/{day}/talebeler/list/{uid}
  const mainRef = db.collection(IZN_PATHS.main).doc(devre).collection(day).doc('talebeler').collection('list').doc(uid);
  batch.set(mainRef, {
    durum, personel, ...(personelUid?{personelUid}:{}),
    donusSaatISO: donusSaatISO || null,
    islemISO: firebase.firestore.FieldValue.serverTimestamp(),
    islemISOClient: nowISO
  }, {merge:true});
  // 2) byDate: yoklama_tarih/{devre}/{day}/{uid}
  const byRef = db.collection(IZN_PATHS.byDate).doc(devre).collection(day).doc(uid);
  batch.set(byRef, {
    _exists:true, durum, personel, ...(personelUid?{personelUid}:{}),
    donusSaatISO: donusSaatISO || null,
    islemISO: firebase.firestore.FieldValue.serverTimestamp(),
    islemISOStr: nowISO
  }, {merge:true});
  await batch.commit();
  return { ok:true };
}

async function iznReadStatuses({devre, iso10}){
  if(!devre || !iso10) return {};
  const out={}; try{
    const col=db.collection(IZN_PATHS.byDate).doc(devre).collection(iso10);
    const qs=await col.get();
    qs.forEach(doc=>{
      const x=doc.data()||{};
      out[doc.id] = {
        durum: iznCanonStat(x.durum||IZN_STAT_NONE),
        personel: x.personel || '‚Äî',
        donusSaatISO: x.donusSaatISO || null,
        islemISO: x.islemISO?.toDate ? x.islemISO.toDate().toISOString() : (x.islemISOStr||null)
      };
    });
  }catch(e){ console.error(e); }
  return out;
}

let __IZN_STATE = { devre:'6.Devre', iso10:(new Date().toISOString().slice(0,10)), donusSaatISO:null, talebeler:[], map:{} };
function iznRowClass(s){
  if(s===IZN_STAT_GELDI) return 'st-verdi';
  if(s===IZN_STAT_IZINLI) return 'st-yarim';
  if(s===IZN_STAT_GELMEDI) return 'st-veremedi';
  return 'st-none';
}
function iznMinutesLate(donusISO, islemISO){
  try{
    if(!donusISO || !islemISO) return 0;
    const d = new Date(donusISO).getTime();
    const i = new Date(islemISO).getTime();
    const diff = Math.floor((i - d) / 60000);
    return diff>0 ? diff : 0;
  }catch(_){ return 0; }
}

async function iznShowRapor(){
  const outHost=document.getElementById('iznRaporOut');
  outHost.innerHTML = '<div class="loading"><div class="spinner"></div><span>Rapor hazƒ±rlanƒ±yor‚Ä¶</span></div>';
  const statuses = await iznReadStatuses({devre:__IZN_STATE.devre, iso10:__IZN_STATE.iso10});
  const list = await iznLoadTalebeler(__IZN_STATE.devre);
  const counts = { [IZN_STAT_GELDI]:0, [IZN_STAT_IZINLI]:0, [IZN_STAT_GELMEDI]:0, [IZN_STAT_NONE]:0 };
  list.forEach(t=>{
    const st = iznCanonStat((statuses[t.uid]?.durum)||IZN_STAT_NONE);
    counts[st] = (counts[st]||0)+1;
  });
  const total=list.length||1;
  const pct=(n)=>((n/total)*100).toFixed(1)+'%';
  let html = `<div class="stack">
    <div class="table-wrap">
      <table style="min-width:520px">
        <thead><tr><th>Durum</th><th>Adet</th><th>Oran</th></tr></thead>
        <tbody>
          <tr><td>Geldi</td><td>${counts[IZN_STAT_GELDI]||0}</td><td>${pct(counts[IZN_STAT_GELDI]||0)}</td></tr>
          <tr><td>ƒ∞zinli</td><td>${counts[IZN_STAT_IZINLI]||0}</td><td>${pct(counts[IZN_STAT_IZINLI]||0)}</td></tr>
          <tr><td>Gelmedi</td><td>${counts[IZN_STAT_GELMEDI]||0}</td><td>${pct(counts[IZN_STAT_GELMEDI]||0)}</td></tr>
          <tr><td>(ƒ∞≈üaret Yok)</td><td>${counts[IZN_STAT_NONE]||0}</td><td>${pct(counts[IZN_STAT_NONE]||0)}</td></tr>
        </tbody>
      </table>
    </div>
    <div class="sList" style="margin-top:10px">
      <div class="sHead"><div>Talebe D√∂k√ºm√º</div><div class="tiny">Tarih: ${__IZN_STATE.iso10}</div></div>
      <div>` +
      list.map(t=>{
        const rec = statuses[t.uid]||{};
        const st = iznCanonStat(rec.durum||IZN_STAT_NONE);
        const iso = rec.islemISO ? new Date(rec.islemISO).toLocaleString('tr-TR') : '‚Äî';
        const extra = rec.personel ? `<div class="tiny">üë§ ${rec.personel}</div>` : '';
        const giris = rec.islemISO ? `<div class="tiny">‚è± Giri≈ü: ${new Date(rec.islemISO).toLocaleString('tr-TR')}</div>` : '';
        const lateMin = iznMinutesLate(rec.donusSaatISO || __IZN_STATE.donusSaatISO, rec.islemISO);
        const lateInfo = (st===IZN_STAT_GELDI && lateMin>0) ? `<div class="tiny" style="color:#f97316">‚è± Ge√ß: ${lateMin} dk</div>` : '';
        return `<div class="sRow ${iznRowClass(st)}"><div><div>${t.ad}</div>${extra}${giris}${lateInfo}</div><div class="statBadge">${st===IZN_STAT_NONE?'‚Äî':st}</div></div>`;
      }).join('') +
      `</div>
    </div>
  </div>`;
  outHost.innerHTML = html;
}

async function iznRenderIslemList(){
  const box=document.getElementById('iznTalebeList'); box.innerHTML='';
  const sort=document.getElementById('iznSort').value;
  if(!__IZN_STATE.talebeler.length){ __IZN_STATE.talebeler = await iznLoadTalebeler(__IZN_STATE.devre); }
  __IZN_STATE.map = await iznReadStatuses({devre:__IZN_STATE.devre, iso10:__IZN_STATE.iso10});
  let rows = __IZN_STATE.talebeler.map(t=>{
    const rec=__IZN_STATE.map[t.uid]||{};
    const stat=iznCanonStat(rec.durum||IZN_STAT_NONE);
    const donus = rec.donusSaatISO || __IZN_STATE.donusSaatISO || null;
    return { uid:t.uid, ad:t.ad, stat, islemISO:rec.islemISO||null, donus };
  });
  if(sort==='alpha') rows.sort((a,b)=>a.ad.localeCompare(b.ad,'tr'));
  else if(sort==='status'){
    const ord={ [IZN_STAT_GELMEDI]:0, [IZN_STAT_IZINLI]:1, [IZN_STAT_NONE]:2, [IZN_STAT_GELDI]:3 };
    rows.sort((a,b)=>(ord[a.stat]??5)-(ord[b.stat]??5) || a.ad.localeCompare(b.ad,'tr'));
  }
  rows.forEach(r=>{
    const ret = r.islemISO ? `<div class="tiny">‚è± Giri≈ü: ${new Date(r.islemISO).toLocaleString('tr-TR')}</div>` : '';
    const lateMin = (r.stat===IZN_STAT_GELDI) ? iznMinutesLate(r.donus, r.islemISO) : 0;
    const lateInfo = (lateMin>0) ? `<div class="tiny" style="color:#f97316">‚è± Ge√ß: ${lateMin} dk</div>` : '';
    const row=document.createElement('div'); row.className='sRow '+iznRowClass(r.stat);
    const label = (r.stat===IZN_STAT_NONE?'‚Äî':r.stat);
    row.innerHTML = `
      <div class="lead">
        <div class="avatar-sm">${initials(r.ad)}</div>
        <div class="meta">
          <div class="name">${r.ad}</div>
          ${ret}${lateInfo}
        </div>
      </div>
      <div class="stat">
        <span class="chip ${chipClass(r.stat)}">${label}</span>
        <span class="chev">‚Ä∫</span>
      </div>
    `;
    row.onclick=()=>iznOpenModal(r);
    box.appendChild(row);
  });
}

// Modal for status (geldi/gelmedi/izinli)
const IZN_MODAL_ID='iznModal';
(function ensureIzinModal(){
  if(document.getElementById(IZN_MODAL_ID)) return;
  const host=document.body;
  const wrap=document.createElement('div');
  wrap.className='modal'; wrap.id=IZN_MODAL_ID; wrap.setAttribute('role','dialog'); wrap.setAttribute('aria-modal','true'); wrap.innerHTML=`
  <div class="modal__panel modal__panel--sm" role="document">
    <div class="modal__header"><div class="modal__title" id="iznModalTitle">Durum Se√ß</div><button class="modal__close" data-close aria-label="Kapat">‚úñ</button></div>
    <div class="modal__body">
      <div class="option-grid" id="iznChoices">
        <div class="option-card" data-val="geldi">
          <div class="emoji">‚úÖ</div>
          <div>
            <div class="title">Geldi</div>
            <div class="desc">Talebe zamanƒ±nda/sonradan geldi olarak i≈üaretlenir.</div>
          </div>
        </div>
        <div class="option-card" data-val="gelmedi">
          <div class="emoji">‚õî</div>
          <div>
            <div class="title">Gelmedi</div>
            <div class="desc">Talebe gelmedi olarak i≈üaretlenir.</div>
          </div>
        </div>
        <div class="option-card" data-val="izinli">
          <div class="emoji">üìù</div>
          <div>
            <div class="title">ƒ∞zinli</div>
            <div class="desc">Talebe resmi/√∂nceden bildirilen izinli.</div>
          </div>
        </div>
      </div>
    </div>
    <div class="modal__footer">
      <button class="btn" data-close>Vazge√ß</button>
      <button class="btn btn--primary" id="iznModalKaydet">Kaydet</button>
    </div>
  </div>`;
  host.appendChild(wrap);
})();
let __IZN_MODAL_CTX = { uid:null, ad:'', pre:IZN_STAT_NONE };
let __IZN_SELECTED = null;
function iznOpenModal(r){
  __IZN_MODAL_CTX = { uid:r.uid, ad:r.ad, pre:r.stat };
  document.getElementById('iznModalTitle').textContent = r.ad;
  __IZN_SELECTED = r.stat && r.stat!=='none' ? r.stat : null;
  const wrap=document.getElementById('iznChoices');
  wrap.querySelectorAll('.btn').forEach(b=>{
    b.classList.toggle('btn--primary', b.dataset.val===__IZN_SELECTED);
  });
  openModal(IZN_MODAL_ID);
}
document.addEventListener('click', (e)=>{
  const card = e.target.closest('#iznChoices .option-card'); if(!card) return;
  const wrap = document.getElementById('iznChoices');
  wrap.querySelectorAll('.option-card').forEach(b=>b.classList.remove('active'));
  card.classList.add('active');
  __IZN_SELECTED = card.dataset.val;
});
document.getElementById('iznModalKaydet').addEventListener('click', async ()=>{
  const durum = __IZN_SELECTED;
  if(!durum){ closeModal(document.getElementById(IZN_MODAL_ID)); return; }
  try{
    const meName = currentUserName || (currentUser?.email||'');
    const meUid  = currentUser?.uid || null;
    // Use selected oturum d√∂n√º≈ü saati as provided (ISO) without re-parsing to avoid TZ shift
    const donusSaatISO = __IZN_STATE.donusSaatISO || null;
    // optimistic
    __IZN_STATE.map[__IZN_MODAL_CTX.uid] = { durum, personel: meName, islemISO:new Date().toISOString(), donusSaatISO };
    iznRenderIslemList();
    closeModal(document.getElementById(IZN_MODAL_ID));
    toast('Kaydediliyor‚Ä¶');
    await iznWriteStatusFast({
      devre: __IZN_STATE.devre,
      iso10: __IZN_STATE.iso10,
      uid: __IZN_MODAL_CTX.uid,
      durum, personel: meName, personelUid: meUid,
      donusSaatISO
    });
    toast('Kaydedildi');
  }catch(e){ console.error(e); toast('Kaydetme hatasƒ±.'); }
});

// Controls wiring
document.getElementById('izn-selDevre').addEventListener('change', async ()=>{
  __IZN_STATE.devre = document.getElementById('izn-selDevre').value;
  __IZN_STATE.talebeler = await iznLoadTalebeler(__IZN_STATE.devre);
});
(function initIznDate(){
  const el=document.getElementById('izn-tarih');
  const iso10=(new Date().toISOString().slice(0,10));
  el.value = iso10; __IZN_STATE.iso10 = iso10;
  el.addEventListener('change', ()=>{ __IZN_STATE.iso10 = el.value || iso10; });
})();
document.getElementById('iznYukleBtn').addEventListener('click', async ()=>{
  const mode = document.querySelector('#iznModeTabs .sub-tab.active')?.dataset.mode || 'rapor';
  if(mode==='rapor') await iznShowRapor();
  else await iznRenderIslemList();
});
document.getElementById('iznYenileBtn').addEventListener('click', async ()=>{
  const mode = document.querySelector('#iznModeTabs .sub-tab.active')?.dataset.mode || 'rapor';
  if(mode==='rapor') await iznShowRapor();
  else await iznRenderIslemList();
});
document.getElementById('iznSort').addEventListener('change', ()=> iznRenderIslemList());
document.getElementById('iznListeYenile').addEventListener('click', ()=> iznRenderIslemList());
// (Toplu d√∂n√º≈ü saati atama kaldƒ±rƒ±ldƒ±; se√ßili oturumun d√∂n√º≈ü saati varsayƒ±lan olarak kullanƒ±lƒ±r.)

/* ===== ƒ∞lk y√ºk ===== */
(async function initOnce(){
  // izin y√∂netimi devre default + talebe listesi
  const izny = document.getElementById('iznt-devre'); if(izny){ __IZNY.devre = izny.value||'6.Devre'; await iznyLoadTalebeler(); }
  try{ await renderTopluIzinListe(); }catch(_){ }
  try{ await renderIzinOturumSelect(); }catch(_){ }
})();

// Devre deƒüi≈üince oturum listesini yenile ve state'i g√ºncelle
document.getElementById('izn-selDevre')?.addEventListener('change', async ()=>{
  __IZN_STATE.devre = document.getElementById('izn-selDevre').value || __IZN_STATE.devre;
  try{ await renderIzinOturumSelect(); }catch(_){ }
});
// Toplu izin b√∂l√ºm√ºnde devre deƒüi≈üince listeyi yenile
document.getElementById('iznt-devre')?.addEventListener('change', async ()=>{
  try{ await renderTopluIzinListe(); }catch(_){ }
});

// set default devre for i≈ülem&rapor
const iznSelDevre = document.getElementById('izn-selDevre'); if(iznSelDevre){ __IZN_STATE.devre = iznSelDevre.value||__IZN_STATE.devre; }
</script>
</body>
</html>
