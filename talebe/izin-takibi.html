<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>İzin Giriş Takibi</title>
  <link rel="stylesheet" href="izin-takibi.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>

<header class="ust-panel">
  <h1>İzin Giriş Takibi</h1>
  <div class="tarih-sec">
    <input type="date" id="tarihFiltre" onchange="filterTable()">
  </div>
</header>

<main>
  <div class="butonlar">
    <button onclick="openModal('girisModal')" class="btn-primary">➕ Giriş Yap</button>
    <button onclick="openModal('duzeltModal')" class="btn-warning">✏️ Veri Düzelt</button>
    <button onclick="openModal('izinSaatModal')" class="btn-danger">⏰ İzin Dönüş Saati</button>
  </div>

  <div class="filtreler">
    <button onclick="setFilter('tumu')" class="btn-filter">Tüm Liste</button>
    <button onclick="setFilter('gelen')" class="btn-filter">Gelenler</button>
    <button onclick="setFilter('izinli')" class="btn-filter">İzinliler</button>
    <button onclick="setFilter('gelmeyen')" class="btn-filter">Gelmeyenler</button>
  </div>

  <h2 id="tabloBaslik">Seçili Tarih: -</h2>

  <table id="izinTablo">
    <thead>
      <tr>
        <th>Talebe Ad Soyad</th>
        <th>Durum</th>
        <th>Giriş Saati</th>
        <th>Mülahaza</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="kisaRapor" class="rapor">
    0 talebeden 0 kişi geldi, 0 kişi izinli, 0 kişi gelmedi.
  </div>
</main>

<!-- Giriş Yap Modal -->
<div id="girisModal" class="modal">
  <div class="modal-content card">
    <div class="modal-header">➕ Giriş Yap</div>
    <div class="modal-body">
      <label>Talebe Seç:</label>
      <select id="girisTalebe"></select>

      <label>Durum Seç:</label>
      <select id="girisDurum">
        <option value="g">Geldi</option>
        <option value="i">İzinli</option>
      </select>

      <div id="izinDetay" style="display:none;">
        <label>İzin Saati: <input type="time" id="izinSaati"></label>
        <label>İzin Aldığı Personel: <input type="text" id="izinPersonel"></label>
        <label>Mülahaza: <input type="text" id="mulahaza"></label>
      </div>
    </div>
    <div class="modal-footer">
      <button onclick="closeAndResetModal('girisModal')" class="btn-cancel">İptal</button>
      <button onclick="kaydetGiris()" class="btn-save">Kaydet</button>
    </div>
  </div>
</div>

<!-- Veri Düzelt Modal -->
<div id="duzeltModal" class="modal">
  <div class="modal-content card">
    <div class="modal-header">✏️ Veri Düzelt</div>
    <div class="modal-body">
      <label>Tarih: <input type="date" id="duzeltTarih"></label>
      <label>Talebe Seç:</label>
      <select id="duzeltTalebe"></select>
      <label>Yeni Durum:</label>
      <select id="duzeltDurum">
        <option value="g">Geldi</option>
        <option value="i">İzinli</option>
        <option value="x">Gelmedi</option>
      </select>
    </div>
    <div class="modal-footer">
      <button onclick="closeAndResetModal('duzeltModal')" class="btn-cancel">İptal</button>
      <button onclick="duzeltKaydet()" class="btn-save">Kaydet</button>
    </div>
  </div>
</div>

<!-- İzin Dönüş Saati Modal -->
<div id="izinSaatModal" class="modal">
  <div class="modal-content card">
    <div class="modal-header">⏰ İzin Dönüş Saati</div>
    <div class="modal-body">
      <label>Tarih: <input type="date" id="izinTarih"></label>
      <label>Dönüş Saati: <input type="time" id="donusSaat"></label>
    </div>
    <div class="modal-footer">
      <button onclick="closeAndResetModal('izinSaatModal')" class="btn-cancel">İptal</button>
      <button onclick="izinSaatKaydet()" class="btn-save">Kaydet</button>
    </div>
  </div>
</div>

<!-- Detay Modal -->
<div id="detayModal" class="modal">
  <div class="modal-content card">
    <div class="modal-header" id="detayBaslik">Talebe Detayı</div>
    <div class="modal-body">
      <p><b>Durum:</b> <span id="detayDurum">-</span></p>
      <p><b>Giriş Saati:</b> <span id="detayGiris">-</span></p>
      <p><b>İzin Saati:</b> <span id="detayIzin">-</span></p>
      <p><b>Personel:</b> <span id="detayPersonel">-</span></p>
      <p><b>Mülahaza:</b> <span id="detayMulahazaText">-</span></p>

      <hr>
      <div class="detay-buttons">
        <button class="btn-save" onclick="seciliIslem='geldi';showInputFields()">✅ Geldi Yap</button>
        <button class="btn-warning" onclick="seciliIslem='izinli';showInputFields()">⏳ İzinli Yap</button>
        <button class="btn-cancel" onclick="seciliIslem='gelmedi';showInputFields()">❌ Gelmedi Yap</button>
      </div>

      <!-- Dinamik input alanları -->
      <div id="detayInputs" style="margin-top:10px;display:none;"></div>
    </div>

    <div class="modal-footer">
      <button class="btn-save" onclick="detayKaydet()">Kaydet</button>
      <button class="btn-danger" onclick="detaySil()">🗑 Sil</button>
      <button class="btn-cancel" onclick="closeAndResetModal('detayModal')">Kapat</button>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="../js/firebase/firebase-init.js"></script>

<script>
let izinSaatiGlobal = null;
let talebeler = [];
let currentFilter = "tumu";
let unsubscribe = null;
let seciliTalebe = null;
let seciliIslem = null;

const talebeIsimleri = [
  "Abdulhak Ali","Abdulkadir Çetin","Abdülmüttalip","Abdülkerim","Ahmet Tunahan Avşar",
  "Ali Ahmat","Arif Emre Anlaş","Beyhaki","Bilal Karkaş","Efe Kul","Elton Qoshku",
  "Eyyüb Berat Aydınyılmaz","Hacı Hasan Demırkıyık","Hammat","Hanif","İsmail Arslan",
  "Mehmet Akif Hanedar","Mugni","Mustafa Gülsoy","Mustafa Melikhan Ateş","Selman Tekbıyık",
  "Sinan Musayev","Turhan Gökmen","Umam","Yusuf Erözcan","Zülkifl Kerem Özdemir","Yavuz Selim İşler"
];

window.onload = () => {
  resetTalebeler();
  populateSelects();
};

function resetTalebeler() {
  talebeler = talebeIsimleri.map(ad => ({
    ad, durum:"gelmedi", giris:"", mulahaza:"", izinSaati:"", izinPersonel:""
  }));
}

function populateSelects() {
  const girisSelect = document.getElementById("girisTalebe");
  const duzeltSelect = document.getElementById("duzeltTalebe");
  girisSelect.innerHTML = ""; duzeltSelect.innerHTML = "";
  talebeler.forEach(t => {
    const opt = document.createElement("option"); opt.value = t.ad; opt.innerText = t.ad;
    girisSelect.appendChild(opt.cloneNode(true));
    duzeltSelect.appendChild(opt);
  });
}

function populateTable() {
  const tbody = document.querySelector("#izinTablo tbody");
  tbody.innerHTML = "";
  let gelen = 0, izinli = 0, gelmeyen = 0;
  const seciliTarih = document.getElementById("tarihFiltre").value;
  if (!seciliTarih) {
    document.getElementById("kisaRapor").innerText = "Lütfen önce tarih seçin.";
    return;
  }

  const simdi = new Date();
  const simdiSaat = simdi.getHours()*60 + simdi.getMinutes();

  talebeler.forEach((t,i)=>{
    if(currentFilter==="gelen" && t.durum!=="geldi") return;
    if(currentFilter==="izinli" && t.durum!=="izinli") return;
    if(currentFilter==="gelmeyen" && t.durum!=="gelmedi") return;

    const tr=document.createElement("tr");
    const ikon = t.durum==="geldi"?"✅":t.durum==="izinli"?"⏳":"❌";
    tr.innerHTML = `
      <td>${t.ad}</td>
      <td><span class="badge ${t.durum}">${ikon} ${t.durum}</span></td>
      <td>${t.giris||"-"}</td>
      <td>${t.mulahaza||"-"}</td>
    `;

    // 🔹 Geç kalan kontrolü
    let gecKalan = false;
    if(t.durum==="gelmedi" && izinSaatiGlobal){
      const [h,m]=izinSaatiGlobal.split(":").map(Number);
      if(simdiSaat>h*60+m) gecKalan=true;
    }
    if(t.durum==="izinli"){
      const saatStr=t.izinSaati||izinSaatiGlobal;
      if(saatStr){
        const [h,m]=saatStr.split(":").map(Number);
        if(simdiSaat>h*60+m) gecKalan=true;
      }
    }
    if(t.durum==="geldi" && izinSaatiGlobal && t.giris){
      const [gh,gm]=t.giris.split(":").map(Number);
      const [ih,im]=izinSaatiGlobal.split(":").map(Number);
      if(gh*60+gm > ih*60+im) gecKalan=true;
    }

    if(gecKalan){
      tr.style.background=t.durum==="gelmedi"?"#ffebeb":"#fff3cd";
      tr.firstChild.innerHTML="⏰ "+tr.firstChild.innerHTML;
    }

    tr.onclick=()=>openDetayModal(i);
    tbody.appendChild(tr);

    if(t.durum==="geldi") gelen++;
    else if(t.durum==="izinli") izinli++;
    else gelmeyen++;
  });

  document.getElementById("kisaRapor").innerText=
    `${talebeler.length} talebeden ${gelen} geldi, ${izinli} izinli, ${gelmeyen} gelmedi.`;
}

function setFilter(f){ currentFilter=f; populateTable(); }

function openModal(id){ document.getElementById(id).style.display="flex"; }
function closeAndResetModal(id){
  const modal=document.getElementById(id); modal.style.display="none";
  modal.querySelectorAll("input").forEach(i=>i.value="");
  modal.querySelectorAll("select").forEach(s=>s.selectedIndex=0);
}

document.getElementById("girisDurum").addEventListener("change",e=>{
  document.getElementById("izinDetay").style.display = e.target.value==="i"?"block":"none";
});

// 🔹 Tarih seçildiğinde tüm talebeleri ve global saati yükle
async function filterTable(){
  const seciliTarih=document.getElementById("tarihFiltre").value;
  document.getElementById("tabloBaslik").innerText=seciliTarih?`Seçili Tarih: ${seciliTarih}`:"Seçili Tarih: -";

  if(!seciliTarih){
    document.querySelector("#izinTablo tbody").innerHTML="";
    document.getElementById("kisaRapor").innerText="Lütfen önce tarih seçin.";
    if(unsubscribe) {unsubscribe(); unsubscribe=null;}
    return;
  }

  const ayarDoc=await db.collection("izin_giris").doc(seciliTarih)
    .collection("ayarlar").doc("global").get();
  izinSaatiGlobal=ayarDoc.exists?ayarDoc.data().donusSaati||null:null;

  resetTalebeler(); currentFilter="tumu"; populateTable();
  if(unsubscribe){unsubscribe();unsubscribe=null;}

  unsubscribe=db.collection("izin_giris").doc(seciliTarih)
    .collection("talebeler").onSnapshot(snap=>{
      resetTalebeler();
      snap.forEach(doc=>{
        const d=doc.data();
        const t=talebeler.find(x=>x.ad===doc.id);
        if(t){
          t.durum=d.durum||"gelmedi";
          t.giris=d.giris||"";
          t.mulahaza=d.mulahaza||"";
          t.izinSaati=d.izinSaati||"";
          t.izinPersonel=d.izinPersonel||"";
        }
      });
      populateTable();
    });
}

// 🔹 Modal açma
function openDetayModal(index){
  seciliTalebe = index;
  const t = talebeler[index];

  document.getElementById("detayBaslik").innerText = t.ad;
  document.getElementById("detayDurum").innerText = t.durum;
  document.getElementById("detayGiris").innerText = t.giris || "-";
  document.getElementById("detayIzin").innerText = t.izinSaati || "-";
  document.getElementById("detayPersonel").innerText = t.izinPersonel || "-";
  document.getElementById("detayMulahazaText").innerText = t.mulahaza || "-";

  seciliIslem = null;
  document.getElementById("detayInputs").style.display = "none";
  document.getElementById("detayInputs").innerHTML = "";

  openModal('detayModal');
}

function showInputFields(){
  const container = document.getElementById("detayInputs");
  container.style.display = "block";
  container.innerHTML = "";

  if(seciliIslem==="geldi"){
    container.innerHTML = `<label>Giriş Saati: <input type="time" id="detayGirisSaati"></label>`;
  } 
  else if(seciliIslem==="izinli"){
    container.innerHTML = `
      <label>İzin Saati: <input type="time" id="detayIzinSaati"></label>
      <label>Personel: <input type="text" id="detayIzinPersonel"></label>
      <label>Mülahaza: <input type="text" id="detayMulahaza"></label>
    `;
  }
}

function detayKaydet(){
  if(seciliTalebe==null || !seciliIslem) return;
  const t = talebeler[seciliTalebe];
  const tarih = document.getElementById("tarihFiltre").value;
  const simdiSaat = new Date().toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'});

  if(seciliIslem==="geldi"){
    const girisSaat = document.getElementById("detayGirisSaati").value || simdiSaat;
    t.durum = "geldi";
    t.giris = girisSaat; // izin bilgileri silinmez
  }
  else if(seciliIslem==="izinli"){
    t.durum = "izinli";
    t.giris = "-";
    t.izinSaati = document.getElementById("detayIzinSaati").value || "";
    t.izinPersonel = document.getElementById("detayIzinPersonel").value || "";
    t.mulahaza = document.getElementById("detayMulahaza").value || "";
  }
  else if(seciliIslem==="gelmedi"){
    t.durum = "gelmedi";
    t.giris = "";
    t.mulahaza = "";
    t.izinSaati = "";
    t.izinPersonel = "";
  }

  // Firebase'e kaydet
  db.collection("izin_giris").doc(tarih)
    .collection("talebeler").doc(t.ad)
    .set({
      durum:t.durum,
      giris:t.giris,
      mulahaza:t.mulahaza||"",
      izinSaati:t.izinSaati||"",
      izinPersonel:t.izinPersonel||"",
      kayitZaman:firebase.firestore.FieldValue.serverTimestamp(),
      kayitPersonel:localStorage.getItem("kullAd")||"Bilinmiyor"
    },{merge:true});

  closeAndResetModal('detayModal');
}
</script>

</body>
</html>
