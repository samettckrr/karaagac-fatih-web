<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ä°zin GiriÅŸ Takibi</title>
  <link rel="stylesheet" href="izin-takibi.css">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
</head>
<body>

<header class="ust-panel">
  <h1>Ä°zin GiriÅŸ Takibi</h1>
  <div class="tarih-sec">
    <input type="date" id="tarihFiltre" onchange="filterTable()">
  </div>
</header>

<main>
  <div class="butonlar">
    <button onclick="openModal('girisModal')" class="btn-primary">â• GiriÅŸ Yap</button>
    <button onclick="openModal('duzeltModal')" class="btn-warning">âœï¸ Veri DÃ¼zelt</button>
    <button onclick="openModal('izinSaatModal')" class="btn-danger">â° Ä°zin DÃ¶nÃ¼ÅŸ Saati</button>
  </div>

  <div class="filtreler">
    <button onclick="setFilter('tumu')" class="btn-filter">TÃ¼m Liste</button>
    <button onclick="setFilter('gelen')" class="btn-filter">Gelenler</button>
    <button onclick="setFilter('izinli')" class="btn-filter">Ä°zinliler</button>
    <button onclick="setFilter('gelmeyen')" class="btn-filter">Gelmeyenler</button>
  </div>

  <h2 id="tabloBaslik">SeÃ§ili Tarih: -</h2>

  <table id="izinTablo">
    <thead>
      <tr>
        <th>Talebe Ad Soyad</th>
        <th>Durum</th>
        <th>GiriÅŸ Saati</th>
        <th>MÃ¼lahaza</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="kisaRapor" class="rapor">
    0 talebeden 0 kiÅŸi geldi, 0 kiÅŸi izinli, 0 kiÅŸi gelmedi.
  </div>
</main>

<!-- GiriÅŸ Yap Modal -->
<div id="girisModal" class="modal">
  <div class="modal-content card">
    <div class="modal-header">â• GiriÅŸ Yap</div>
    <div class="modal-body">
      <label>Talebe SeÃ§:</label>
      <select id="girisTalebe"></select>

      <label>Durum SeÃ§:</label>
      <select id="girisDurum">
        <option value="g">Geldi</option>
        <option value="i">Ä°zinli</option>
      </select>

      <div id="izinDetay" style="display:none;">
        <label>Ä°zin Saati: <input type="time" id="izinSaati"></label>
        <label>Ä°zin AldÄ±ÄŸÄ± Personel: <input type="text" id="izinPersonel"></label>
        <label>MÃ¼lahaza: <input type="text" id="mulahaza"></label>
      </div>
    </div>
    <div class="modal-footer">
      <button onclick="closeAndResetModal('girisModal')" class="btn-cancel">Ä°ptal</button>
      <button onclick="kaydetGiris()" class="btn-save">Kaydet</button>
    </div>
  </div>
</div>

<!-- Veri DÃ¼zelt Modal -->
<div id="duzeltModal" class="modal">
  <div class="modal-content card">
    <div class="modal-header">âœï¸ Veri DÃ¼zelt</div>
    <div class="modal-body">
      <label>Tarih: <input type="date" id="duzeltTarih"></label>
      <label>Talebe SeÃ§:</label>
      <select id="duzeltTalebe"></select>
      <label>Yeni Durum:</label>
      <select id="duzeltDurum">
        <option value="g">Geldi</option>
        <option value="i">Ä°zinli</option>
        <option value="x">Gelmedi</option>
      </select>
    </div>
    <div class="modal-footer">
      <button onclick="closeAndResetModal('duzeltModal')" class="btn-cancel">Ä°ptal</button>
      <button onclick="duzeltKaydet()" class="btn-save">Kaydet</button>
    </div>
  </div>
</div>

<!-- Ä°zin DÃ¶nÃ¼ÅŸ Saati Modal -->
<div id="izinSaatModal" class="modal">
  <div class="modal-content card">
    <div class="modal-header">â° Ä°zin DÃ¶nÃ¼ÅŸ Saati</div>
    <div class="modal-body">
      <label>Tarih: <input type="date" id="izinTarih"></label>
      <label>DÃ¶nÃ¼ÅŸ Saati: <input type="time" id="donusSaat"></label>
    </div>
    <div class="modal-footer">
      <button onclick="closeAndResetModal('izinSaatModal')" class="btn-cancel">Ä°ptal</button>
      <button onclick="izinSaatKaydet()" class="btn-save">Kaydet</button>
    </div>
  </div>
</div>

<!-- Detay Modal -->
<div id="detayModal" class="modal">
  <div class="modal-content card">
    <div class="modal-header" id="detayBaslik">Talebe DetayÄ±</div>
    <div class="modal-body">
      <p><b>Durum:</b> <span id="detayDurum">-</span></p>
      <p><b>GiriÅŸ Saati:</b> <span id="detayGiris">-</span></p>
      <p><b>Ä°zin Saati:</b> <span id="detayIzin">-</span></p>
      <p><b>Personel:</b> <span id="detayPersonel">-</span></p>
      <p><b>MÃ¼lahaza:</b> <span id="detayMulahazaText">-</span></p>

      <hr>
      <div class="detay-buttons">
        <button class="btn-save" onclick="seciliIslem='geldi';showInputFields()">âœ… Geldi Yap</button>
        <button class="btn-warning" onclick="seciliIslem='izinli';showInputFields()">â³ Ä°zinli Yap</button>
        <button class="btn-cancel" onclick="seciliIslem='gelmedi';showInputFields()">âŒ Gelmedi Yap</button>
      </div>

      <!-- Dinamik input alanlarÄ± -->
      <div id="detayInputs" style="margin-top:10px;display:none;"></div>
    </div>

    <div class="modal-footer">
      <button class="btn-save" onclick="detayKaydet()">Kaydet</button>
      <button class="btn-danger" onclick="detaySil()">ğŸ—‘ Sil</button>
      <button class="btn-cancel" onclick="closeAndResetModal('detayModal')">Kapat</button>
    </div>
  </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="../js/firebase/firebase-init.js"></script>

<script>
let izinSaatiGlobal = null;
let talebeler = [];
let currentFilter = "tumu";
let unsubscribe = null;
let seciliTalebe = null;
let seciliIslem = null;

const talebeIsimleri = [
  "Abdulhak Ali","Abdulkadir Ã‡etin","AbdÃ¼lmÃ¼ttalip","AbdÃ¼lkerim","Ahmet Tunahan AvÅŸar",
  "Ali Ahmat","Arif Emre AnlaÅŸ","Beyhaki","Bilal KarkaÅŸ","Efe Kul","Elton Qoshku",
  "EyyÃ¼b Berat AydÄ±nyÄ±lmaz","HacÄ± Hasan DemÄ±rkÄ±yÄ±k","Hammat","Hanif","Ä°smail Arslan",
  "Mehmet Akif Hanedar","Mugni","Mustafa GÃ¼lsoy","Mustafa Melikhan AteÅŸ","Selman TekbÄ±yÄ±k",
  "Sinan Musayev","Turhan GÃ¶kmen","Umam","Yusuf ErÃ¶zcan","ZÃ¼lkifl Kerem Ã–zdemir","Yavuz Selim Ä°ÅŸler"
];

window.onload = () => {
  resetTalebeler();
  populateSelects();
};

function resetTalebeler() {
  talebeler = talebeIsimleri.map(ad => ({
    ad, durum:"gelmedi", giris:"", mulahaza:"", izinSaati:"", izinPersonel:""
  }));
}

function populateSelects() {
  const girisSelect = document.getElementById("girisTalebe");
  const duzeltSelect = document.getElementById("duzeltTalebe");
  girisSelect.innerHTML = ""; duzeltSelect.innerHTML = "";
  talebeler.forEach(t => {
    const opt = document.createElement("option"); opt.value = t.ad; opt.innerText = t.ad;
    girisSelect.appendChild(opt.cloneNode(true));
    duzeltSelect.appendChild(opt);
  });
}

function populateTable() {
  const tbody = document.querySelector("#izinTablo tbody");
  tbody.innerHTML = "";
  let gelen = 0, izinli = 0, gelmeyen = 0;
  const seciliTarih = document.getElementById("tarihFiltre").value;
  if (!seciliTarih) {
    document.getElementById("kisaRapor").innerText = "LÃ¼tfen Ã¶nce tarih seÃ§in.";
    return;
  }

  const simdi = new Date();
  const simdiSaat = simdi.getHours()*60 + simdi.getMinutes();

  talebeler.forEach((t,i)=>{
    if(currentFilter==="gelen" && t.durum!=="geldi") return;
    if(currentFilter==="izinli" && t.durum!=="izinli") return;
    if(currentFilter==="gelmeyen" && t.durum!=="gelmedi") return;

    const tr=document.createElement("tr");
    const ikon = t.durum==="geldi"?"âœ…":t.durum==="izinli"?"â³":"âŒ";
    tr.innerHTML = `
      <td>${t.ad}</td>
      <td><span class="badge ${t.durum}">${ikon} ${t.durum}</span></td>
      <td>${t.giris||"-"}</td>
      <td>${t.mulahaza||"-"}</td>
    `;

    // ğŸ”¹ GeÃ§ kalan kontrolÃ¼
    let gecKalan = false;
    if(t.durum==="gelmedi" && izinSaatiGlobal){
      const [h,m]=izinSaatiGlobal.split(":").map(Number);
      if(simdiSaat>h*60+m) gecKalan=true;
    }
    if(t.durum==="izinli"){
      const saatStr=t.izinSaati||izinSaatiGlobal;
      if(saatStr){
        const [h,m]=saatStr.split(":").map(Number);
        if(simdiSaat>h*60+m) gecKalan=true;
      }
    }
    if(t.durum==="geldi" && izinSaatiGlobal && t.giris){
      const [gh,gm]=t.giris.split(":").map(Number);
      const [ih,im]=izinSaatiGlobal.split(":").map(Number);
      if(gh*60+gm > ih*60+im) gecKalan=true;
    }

    if(gecKalan){
      tr.style.background=t.durum==="gelmedi"?"#ffebeb":"#fff3cd";
      tr.firstChild.innerHTML="â° "+tr.firstChild.innerHTML;
    }

    tr.onclick=()=>openDetayModal(i);
    tbody.appendChild(tr);

    if(t.durum==="geldi") gelen++;
    else if(t.durum==="izinli") izinli++;
    else gelmeyen++;
  });

  document.getElementById("kisaRapor").innerText=
    `${talebeler.length} talebeden ${gelen} geldi, ${izinli} izinli, ${gelmeyen} gelmedi.`;
}

function setFilter(f){ currentFilter=f; populateTable(); }

function openModal(id){ document.getElementById(id).style.display="flex"; }
function closeAndResetModal(id){
  const modal=document.getElementById(id); modal.style.display="none";
  modal.querySelectorAll("input").forEach(i=>i.value="");
  modal.querySelectorAll("select").forEach(s=>s.selectedIndex=0);
}

document.getElementById("girisDurum").addEventListener("change",e=>{
  document.getElementById("izinDetay").style.display = e.target.value==="i"?"block":"none";
});

// ğŸ”¹ Tarih seÃ§ildiÄŸinde tÃ¼m talebeleri ve global saati yÃ¼kle
async function filterTable(){
  const seciliTarih=document.getElementById("tarihFiltre").value;
  document.getElementById("tabloBaslik").innerText=seciliTarih?`SeÃ§ili Tarih: ${seciliTarih}`:"SeÃ§ili Tarih: -";

  if(!seciliTarih){
    document.querySelector("#izinTablo tbody").innerHTML="";
    document.getElementById("kisaRapor").innerText="LÃ¼tfen Ã¶nce tarih seÃ§in.";
    if(unsubscribe) {unsubscribe(); unsubscribe=null;}
    return;
  }

  const ayarDoc=await db.collection("izin_giris").doc(seciliTarih)
    .collection("ayarlar").doc("global").get();
  izinSaatiGlobal=ayarDoc.exists?ayarDoc.data().donusSaati||null:null;

  resetTalebeler(); currentFilter="tumu"; populateTable();
  if(unsubscribe){unsubscribe();unsubscribe=null;}

  unsubscribe=db.collection("izin_giris").doc(seciliTarih)
    .collection("talebeler").onSnapshot(snap=>{
      resetTalebeler();
      snap.forEach(doc=>{
        const d=doc.data();
        const t=talebeler.find(x=>x.ad===doc.id);
        if(t){
          t.durum=d.durum||"gelmedi";
          t.giris=d.giris||"";
          t.mulahaza=d.mulahaza||"";
          t.izinSaati=d.izinSaati||"";
          t.izinPersonel=d.izinPersonel||"";
        }
      });
      populateTable();
    });
}

// ğŸ”¹ Modal aÃ§ma
function openDetayModal(index){
  seciliTalebe = index;
  const t = talebeler[index];

  document.getElementById("detayBaslik").innerText = t.ad;
  document.getElementById("detayDurum").innerText = t.durum;
  document.getElementById("detayGiris").innerText = t.giris || "-";
  document.getElementById("detayIzin").innerText = t.izinSaati || "-";
  document.getElementById("detayPersonel").innerText = t.izinPersonel || "-";
  document.getElementById("detayMulahazaText").innerText = t.mulahaza || "-";

  seciliIslem = null;
  document.getElementById("detayInputs").style.display = "none";
  document.getElementById("detayInputs").innerHTML = "";

  openModal('detayModal');
}

function showInputFields(){
  const container = document.getElementById("detayInputs");
  container.style.display = "block";
  container.innerHTML = "";

  if(seciliIslem==="geldi"){
    container.innerHTML = `<label>GiriÅŸ Saati: <input type="time" id="detayGirisSaati"></label>`;
  } 
  else if(seciliIslem==="izinli"){
    container.innerHTML = `
      <label>Ä°zin Saati: <input type="time" id="detayIzinSaati"></label>
      <label>Personel: <input type="text" id="detayIzinPersonel"></label>
      <label>MÃ¼lahaza: <input type="text" id="detayMulahaza"></label>
    `;
  }
}

function detayKaydet(){
  if(seciliTalebe==null || !seciliIslem) return;
  const t = talebeler[seciliTalebe];
  const tarih = document.getElementById("tarihFiltre").value;
  const simdiSaat = new Date().toLocaleTimeString('tr-TR',{hour:'2-digit',minute:'2-digit'});

  if(seciliIslem==="geldi"){
    const girisSaat = document.getElementById("detayGirisSaati").value || simdiSaat;
    t.durum = "geldi";
    t.giris = girisSaat; // izin bilgileri silinmez
  }
  else if(seciliIslem==="izinli"){
    t.durum = "izinli";
    t.giris = "-";
    t.izinSaati = document.getElementById("detayIzinSaati").value || "";
    t.izinPersonel = document.getElementById("detayIzinPersonel").value || "";
    t.mulahaza = document.getElementById("detayMulahaza").value || "";
  }
  else if(seciliIslem==="gelmedi"){
    t.durum = "gelmedi";
    t.giris = "";
    t.mulahaza = "";
    t.izinSaati = "";
    t.izinPersonel = "";
  }

  // Firebase'e kaydet
  db.collection("izin_giris").doc(tarih)
    .collection("talebeler").doc(t.ad)
    .set({
      durum:t.durum,
      giris:t.giris,
      mulahaza:t.mulahaza||"",
      izinSaati:t.izinSaati||"",
      izinPersonel:t.izinPersonel||"",
      kayitZaman:firebase.firestore.FieldValue.serverTimestamp(),
      kayitPersonel:localStorage.getItem("kullAd")||"Bilinmiyor"
    },{merge:true});

  closeAndResetModal('detayModal');
}
</script>

</body>
</html>
