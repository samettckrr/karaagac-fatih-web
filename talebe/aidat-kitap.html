<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Aidat & Kitap | Karaağaç Fatih</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <link rel="icon" type="image/png" href="../img/logo.png" />

  <style>
    :root{
      --appbar-h:56px;
      --radius:14px; --shadow:0 12px 28px rgba(0,0,0,.14);
      --bg:#0f172a; --bg2:#0b1324;
      --grad1:#0ea5e922; --grad2:#22d3ee22;
      --card:rgba(15,23,42,.92); --stroke:rgba(148,163,184,.18);
      --text:#e5e7eb; --muted:#9aa4b2;
      --brand:#38bdf8; --brand2:#0ea5e9;
      --pill:#0b1220; --pill-hover:#101a2b;
      --link:#c7e9ff; --surface:rgba(2,6,23,.08);
      --danger:#ef4444; --success:#22c55e; --warn:#f59e0b;
      --chip:#0b1220; --chip-border:rgba(148,163,184,.28);
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#eef6ff; --bg2:#f7fbff; --grad1:#38bdf822; --grad2:#22d3ee22;
        --card:rgba(255,255,255,.95);
        --stroke:rgba(15,23,42,.12);
        --text:#0b1220; --muted:#4b5563; --brand:#0ea5e9; --brand2:#0284c7;
        --pill:#f5f8ff; --pill-hover:#e9f2ff; --link:#0b5ea8; --surface:#eef3ff;
        --chip:#f5f8ff; --chip-border:rgba(15,23,42,.12);
      }
    }
    html[data-theme="dark"]{
      --bg:#0f172a; --bg2:#0b1324; --grad1:#0ea5e922; --grad2:#22d3ee22;
      --card:rgba(15,23,42,.92); --stroke:rgba(148,163,184,.18);
      --text:#e5e7eb; --muted:#9aa4b2; --brand:#38bdf8; --brand2:#0ea5e9;
      --pill:#0b1220; --pill-hover:#101a2b; --link:#c7e9ff; --surface:rgba(2,6,23,.08);
      --chip:#0b1220; --chip-border:rgba(148,163,184,.28);
    }
    html[data-theme="light"]{
      --bg:#eef6ff; --bg2:#f7fbff; --grad1:#38bdf822; --grad2:#22d3ee22;
      --card:rgba(255,255,255,.95); --stroke:rgba(15,23,42,.12);
      --text:#0b1220; --muted:#4b5563; --brand:#0ea5e9; --brand2:#0284c7;
      --pill:#f5f8ff; --pill-hover:#e9f2ff; --link:#0b5ea8; --surface:#eef3ff;
      --chip:#f5f8ff; --chip-border:rgba(15,23,42,.12);
    }

    *{box-sizing:border-box} html,body{height:100%}
    body{
      margin:0; color:var(--text);
      font-family:ui-sans-serif,-apple-system,"Segoe UI",Roboto,Arial;
      background:
        radial-gradient(900px 680px at 12% 8%, var(--grad1), transparent 45%),
        radial-gradient(800px 640px at 88% 92%, var(--grad2), transparent 50%),
        linear-gradient(140deg, var(--bg), var(--bg2) 60%);
      overflow-x:hidden; word-wrap:break-word;
    }
    a{color:var(--link); text-decoration:none} a:hover{text-decoration:underline}

    /* APPBAR */
    .appbar{
      position:sticky; top:0; z-index:60;
      height:var(--appbar-h);
      background:var(--card); backdrop-filter:blur(10px);
      border-bottom:1px solid var(--stroke);
      display:flex; align-items:center;
      padding-left:max(12px, env(safe-area-inset-left));
      padding-right:max(12px, env(safe-area-inset-right));
    }
    .brand{display:flex; align-items:center; gap:10px; cursor:pointer}
    .brand img{width:24px; height:24px}
    .brand span{font-weight:900; letter-spacing:.02em; color:var(--text)}

    .nav-center{margin:0 auto; height:100%}
    .nav-list{display:flex; gap:22px; align-items:center; height:100%; list-style:none; margin:0; padding:0}
    .nav-item{position:relative; height:100%}
    .nav-btn{height:100%; display:flex; align-items:center; gap:6px; color:var(--text); font-weight:600; cursor:pointer}
    .nav-btn:hover{color:var(--brand)}
    .caret{font-size:12px; opacity:.6}
    .dropdown{position:absolute; top:100%; left:0; min-width:240px; background:var(--card); border:1px solid var(--stroke); border-radius:10px; box-shadow:var(--shadow); padding:8px; display:none}
    .dropdown a{display:flex; align-items:center; gap:8px; padding:8px 10px; border-radius:8px; color:var(--text); text-decoration:none}
    .dropdown a:hover{background:var(--surface)}
    .nav-item.open .dropdown{display:block}

    .nav-right{display:flex; gap:8px; align-items:center}
    .btn{border:1px solid var(--stroke); background:var(--card); color:var(--text); border-radius:999px; padding:8px 12px; cursor:pointer}
    .hamb{display:none}

    /* DRAWER (mobil) */
    .drawer{
      position:fixed;
      top:var(--appbar-h); right:0; bottom:0; left:30%;
      transform:translateX(100%); transition:transform .25s ease;
      background:var(--card); border-left:1px solid var(--stroke);
      z-index:70; overflow:auto; -webkit-overflow-scrolling:touch; padding:12px;
    }
    .drawer.open{transform:translateX(0)}
    .drawer .panel-title{margin:14px 4px 6px; font-weight:800; color:var(--muted); font-size:13px}
    .drawer a{display:block; padding:10px; border-radius:10px; border:1px solid var(--stroke); margin:6px 0; color:var(--text); background:var(--pill)}
    .drawer a:hover{background:var(--pill-hover)}

    /* CONTENT */
    .container{max-width:1200px; margin:0 auto; padding:16px}
    .hero{display:flex; justify-content:space-between; align-items:flex-start; gap:16px; background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius); padding:16px; margin:16px 0; box-shadow:var(--shadow)}
    .hero h2{margin:0 0 6px; font-size:20px}
    .hero-sub{color:var(--muted); font-size:13px}
    .mini{display:flex; gap:8px; flex-wrap:wrap}
    .pill{padding:6px 10px; border-radius:999px; border:1px solid var(--stroke); background:var(--pill); font-size:12px}

    .grid{display:grid; gap:14px; grid-template-columns:repeat(12, minmax(0,1fr))}
    .col-4{grid-column:span 4} .col-8{grid-column:span 8} .col-12{grid-column:span 12}
    .card{background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius); box-shadow:var(--shadow); padding:14px}
    .card h3{margin:0 0 12px; font-size:16px}

    /* KPI kutuları (özet) */
    .kpi{display:flex; align-items:center; justify-content:space-between; padding:12px; border-radius:14px; border:1px solid var(--stroke); background:var(--surface)}
    .kpi .val{font-size:22px; font-weight:800}
    .kpi .sub{font-size:12px; color:var(--muted)}
    .bar{height:8px; border-radius:999px; background:rgba(148,163,184,.18); overflow:hidden; margin-top:8px}
    .bar > i{display:block; height:100%; background:linear-gradient(90deg,var(--brand),var(--brand2)); width:0%}

    /* Tablo alanı (kompakt) */
    .table-wrap{overflow-x:auto}
    table{
      width:100%; border-collapse:separate; border-spacing:0;
      min-width:640px; /* daha dar */
      background:var(--card); border:1px solid var(--stroke); border-radius:14px; overflow:hidden
    }
    thead th{
      position:sticky; top:0;
      background:linear-gradient(0deg,var(--pill),var(--card));
      border-bottom:1px solid var(--stroke);
      color:var(--text); text-align:center;
      padding:10px; font-weight:800; font-size:12.5px;
    }
    tbody td{
      padding:8px 10px; /* kompakt */
      text-align:center; border-bottom:1px solid var(--stroke);
      font-size:13px; font-variant-numeric: tabular-nums; /* sayılar hizalı */
    }
    tbody tr:nth-child(even){background:rgba(2,6,23,.04)}
    tbody tr:hover{background:var(--surface); cursor:pointer}
    td:first-child, th:first-child { text-align:left; max-width:220px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

    /* Durum stilleri */
    .odendi{background:rgba(34,197,94,.14) !important; color:#10b981; font-weight:700}
    .borclu{color:#ef4444; font-weight:700}
    .tamamlandi{background:rgba(16,185,129,.18) !important; font-weight:700}

    /* Modal */
    .modal{position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:200}
    .modal.open{display:flex}
    .modal-icerik{width:min(580px, 96vw); max-height:90vh; overflow:auto; background:var(--card); border:1px solid var(--stroke); border-radius:16px; box-shadow:var(--shadow); padding:16px; animation:acilis .25s ease}
    @keyframes acilis{from{transform:translateY(8px); opacity:.0} to{transform:translateY(0); opacity:1}}
    .modal-baslik{display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:8px}
    .modal-baslik h3{margin:0; font-size:18px}
    .modal-kapat{border:1px solid var(--stroke); background:var(--pill); color:var(--text); border-radius:10px; padding:6px 10px; cursor:pointer}
    .odeme-kaydi{border:1px solid var(--stroke); background:var(--surface); border-radius:12px; padding:10px; margin:8px 0; font-size:14px}

    /* Form */
    .form{display:grid; gap:8px; margin-top:12px}
    .form label{font-size:12px; color:var(--muted)}
    .form input,.form select{width:100%; padding:10px; border-radius:10px; border:1px solid var(--stroke); background:var(--pill); color:var(--text)}
    .form .row{display:grid; gap:8px; grid-template-columns:1fr 1fr}
    .form .btn-save{margin-top:4px; padding:10px; border-radius:12px; border:1px solid var(--stroke); background:linear-gradient(180deg,var(--brand),var(--brand2)); color:white; font-weight:700; cursor:pointer}

    .toast{position:fixed; left:50%; bottom:24px; transform:translateX(-50%) translateY(20px); background:rgba(2,6,23,.95); color:#fff; border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:10px 12px; opacity:0; pointer-events:none; transition:opacity .25s, transform .25s; z-index:300}
    .toast.show{opacity:1; transform:translateX(-50%) translateY(0)}
    .page-gap{height:120px}

    @media (max-width:1024px){
      .nav-center{display:none} .hamb{display:inline-flex}
      .col-4{grid-column:span 12} .col-8{grid-column:span 12} .col-12{grid-column:span 12}
      .hero{flex-direction:column}
    }
  </style>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="../js/firebase/firebase-init.js"></script>
</head>
<body>

  <!-- APPBAR -->
  <div class="appbar">
    <div class="brand" onclick="location.reload()">
      <img src="../img/logo.png" alt="logo"><span>KARAAĞAÇ FATİH</span>
    </div>
    <nav class="nav-center"><ul class="nav-list" id="navMain"></ul></nav>
    <div class="nav-right">
      <button class="btn hamb" id="hamburger" title="Menü">☰</button>
      <button class="btn" id="themeToggle" title="Tema: Açık/Koyu/Otomatik">🌗 <span id="themeLabel">Auto</span></button>
      <button class="btn" onclick="logout()">Çıkış Yap</button>
    </div>
  </div>

  <!-- Mobil çekmece -->
  <aside class="drawer" id="drawer"></aside>

  <!-- CONTENT -->
  <main class="container">
    <section class="hero">
      <div>
        <h2>Aidat & Kitap Takip</h2>
        <div class="hero-sub">Bu sayfa yalnızca yetkisi olan kullanıcılara görünür.</div>
        <div class="mini">
          <span class="pill">📘 Talebe: <b id="kpiTalebe">—</b></span>
          <span class="pill">💳 Toplam Kalan: <b id="kpiToplam">—</b></span>
        </div>
      </div>
      <div class="mini"><span class="pill">Tema: <span id="themeLabel2">Auto</span></span></div>
    </section>

    <div class="grid">
      <div class="card col-8">
        <h3>Çizelge</h3>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>Talebe</th>
                <th class="aidat">Aidat Ödendi</th>
                <th class="aidat">Aidat Kalan</th>
                <th class="kitap">Kitap Ödendi</th>
                <th class="kitap">Kitap Kalan</th>
                <th class="borc">Toplam Borç</th>
              </tr>
            </thead>
            <tbody id="talebeTablosu"></tbody>
          </table>
        </div>
      </div>

      <div class="card col-4">
        <h3>Özet</h3>

        <div class="kpi">
          <div>
            <div class="val" id="ozToplam">—</div>
            <div class="sub">Toplam Kalan</div>
          </div>
          <div>💰</div>
        </div>
        <div class="bar"><i id="barToplam" style="width:0%"></i></div>

        <div class="kpi" style="margin-top:12px">
          <div>
            <div class="val" id="ozAidat">—</div>
            <div class="sub">Kalan Aidat</div>
          </div>
          <div>🧾</div>
        </div>
        <div class="bar"><i id="barAidat" style="width:0%"></i></div>

        <div class="kpi" style="margin-top:12px">
          <div>
            <div class="val" id="ozKitap">—</div>
            <div class="sub">Kalan Kitap</div>
          </div>
          <div>📚</div>
        </div>
        <div class="bar"><i id="barKitap" style="width:0%"></i></div>
      </div>
    </div>

    <div class="page-gap"></div>
  </main>

  <!-- Modal -->
  <div class="modal" id="detayModal" aria-hidden="true">
    <div class="modal-icerik" role="dialog" aria-modal="true">
      <div class="modal-baslik">
        <h3 id="modalBaslik">Talebe Detayları</h3>
        <button class="modal-kapat" id="modalKapat">Kapat ✕</button>
      </div>
      <div id="odemeDetaylari"></div>

      <div class="form" id="tahsilatForm">
        <div class="row">
          <div>
            <label>İşlem Türü</label>
            <select id="islemTuru">
              <option value="Aidat">Aidat</option>
              <option value="Kitap">Kitap</option>
            </select>
          </div>
          <div>
            <label>Ödeme Yöntemi</label>
            <select id="odemeYontemi">
              <option value="Nakit">Nakit</option>
              <option value="Banka">Banka</option>
            </select>
          </div>
        </div>
        <div>
          <label>Miktar (₺)</label>
          <input type="number" id="tahsilatMiktar" min="0" step="0.01" />
        </div>
        <button class="btn-save" id="btnKaydet">Kaydet</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    /* ===== Tema ===== */
    (function(){
      const root=document.documentElement, btn=document.getElementById('themeToggle');
      const lab1=document.getElementById('themeLabel'), lab2=document.getElementById('themeLabel2');
      const sysDark=()=>window.matchMedia&&window.matchMedia('(prefers-color-scheme: dark)').matches;
      function apply(mode){
        localStorage.setItem('kf_theme',mode);
        const eff=(mode==='auto')?(sysDark()?'dark':'light'):mode;
        root.setAttribute('data-theme',eff);
        const txt=mode[0].toUpperCase()+mode.slice(1);
        if(lab1) lab1.textContent=txt; if(lab2) lab2.textContent=txt;
        const icon=mode==='dark'?'🌙':mode==='light'?'☀️':'🌗';
        btn.innerHTML=icon+' <span id="themeLabel">'+txt+'</span>';
      }
      apply(localStorage.getItem('kf_theme')||'auto');
      btn.addEventListener('click',()=>{const cur=localStorage.getItem('kf_theme')||'auto'; apply(cur==='dark'?'light':(cur==='light'?'auto':'dark'));});
      if(window.matchMedia){ const m=window.matchMedia('(prefers-color-scheme: dark)'); m.addEventListener?.('change',()=>{ if((localStorage.getItem('kf_theme')||'auto')==='auto') apply('auto'); }); }
    })();

    /* ===== Helpers & Firebase ===== */
    const db=firebase.firestore(), auth=firebase.auth();

    const norm = (s)=>String(s||'').trim().toLowerCase();
    const fileBase = ()=> norm((location.pathname.split('/').pop()||'').replace(/\.(html|htm)$/,''));
    const fileName = ()=> (location.pathname.split('/').pop()||'');

    function showToast(msg){const t=document.getElementById('toast'); t.textContent=msg; t.classList.add('show'); clearTimeout(window.__to); window.__to=setTimeout(()=>t.classList.remove('show'),2800);}
    function formatTL(n){const v=Number(n)||0; return new Intl.NumberFormat('tr-TR',{minimumFractionDigits:2, maximumFractionDigits:2}).format(v)+' ₺';}

    /* ===== Yetkiler ===== */
    let CURRENT_ALLOW=new Set();   // pozitif yetkiler
    let CURRENT_DENY =new Set();   // - / !

    /* ===== Manifest ===== */
    const PANEL_ICON={ 'Admin':'🎛️','Talebe':'📘','Personel':'👤','Muhasebe':'💰','Kermes':'🏪','Nehari':'🕌','Sistem Ayarları':'⚙️' };

    async function readManifest(){
      const out=[]; const snap=await db.collection('sayfa_manifesti').get();
      snap.forEach(doc=>{
        const d=doc.data()||{}, id=doc.id;
        out.push({
          id, title:d.title||id, icon:d.icon||PANEL_ICON[id]||'📁',
          order: typeof d.order==='number'? d.order:9999,
          pages:(Array.isArray(d.pages)? d.pages:[]).map(pg=>({
            key:pg.key||pg.title||'', title:pg.title||pg.key||'Sayfa', path:pg.path||'#',
            order: typeof pg.order==='number'? pg.order:9999
          }))
        });
      });
      out.sort((a,b)=>a.order-b.order);
      out.forEach(p=>p.pages.sort((a,b)=>a.order-b.order));
      return out;
    }

    function hasGlobalAllow(){ return CURRENT_ALLOW.has('*') || CURRENT_ALLOW.has('all') || CURRENT_ALLOW.has('full'); }

    function pageAllowed(panelTitle, pageKey){
      if (hasGlobalAllow()) return true;
      const k=norm(pageKey), p=norm(panelTitle);
      if (CURRENT_DENY.has(k)) return false;
      if (CURRENT_ALLOW.has(k)) return true;
      if (CURRENT_ALLOW.has(p)) return true;
      for(const a of CURRENT_ALLOW){ if(a.endsWith(':*') && k.startsWith(a.slice(0,-2))) return true; }
      return false;
    }

    function filterManifestByPerms(manifest){
      const res=[];
      manifest.forEach(p=>{
        const kept = p.pages.filter(pg=>pageAllowed(p.title, pg.key));
        if(kept.length) res.push({...p, pages:kept});
      });
      return res;
    }

    function renderNav(filtered){
      const ul=document.getElementById('navMain'), drawer=document.getElementById('drawer');
      ul.innerHTML=''; drawer.innerHTML='';
      if(!filtered.length){
        ul.innerHTML='<li class="nav-item"><div class="nav-btn">Menü yok</div></li>';
        drawer.innerHTML='<div style="color:var(--muted);padding:8px">Menü bulunamadı</div>';
        return;
      }
      filtered.forEach(p=>{
        const li=document.createElement('li'); li.className='nav-item';
        li.innerHTML=`<div class="nav-btn">${p.title} <span class="caret">▾</span></div>`;
        const dd=document.createElement('div'); dd.className='dropdown';
        p.pages.forEach(pg=>{
          const a=document.createElement('a'); a.href=pg.path; a.textContent=pg.title;
          a.dataset.key=pg.key; a.dataset.panelTitle=p.title; dd.appendChild(a);
        });
        li.appendChild(dd);
        li.querySelector('.nav-btn').addEventListener('click',(e)=>{
          e.stopPropagation();
          ul.querySelectorAll('.nav-item').forEach(x=>{ if(x!==li) x.classList.remove('open'); });
          li.classList.toggle('open');
        });
        ul.appendChild(li);
      });
      document.addEventListener('click',(e)=>{ if(!ul.contains(e.target)) ul.querySelectorAll('.nav-item').forEach(x=>x.classList.remove('open')); });

      filtered.forEach(p=>{
        const h=document.createElement('div'); h.className='panel-title'; h.textContent=p.title; drawer.appendChild(h);
        p.pages.forEach(pg=>{
          const a=document.createElement('a'); a.href=pg.path; a.textContent=pg.title;
          a.dataset.key=pg.key; a.dataset.panelTitle=p.title; drawer.appendChild(a);
        });
      });
    }

    // Link guard – önce yetki, sonra yönlendir
    document.addEventListener('click',(e)=>{
      const a=e.target.closest('a[data-key]'); if(!a) return;
      const key=norm(a.dataset.key||''); const pnl=norm(a.dataset.panelTitle||'');
      if(!pageAllowed(pnl,key)){ e.preventDefault(); showToast('Bu sayfa için yetkiniz yok.'); }
    });

    /* ===== Bu sayfanın erişimi ===== */
    function currentPageAllowed(manifest){
      if(hasGlobalAllow()) return true;
      const fb=fileBase(), fn=fileName();
      for(const p of manifest){
        for(const pg of p.pages){
          const path=String(pg.path||''); const last=path.split('/').pop()||'';
          if(last===fn) return pageAllowed(p.title, pg.key);
          if(norm(pg.key||'')===fb) return pageAllowed(p.title, pg.key);
          if(norm(pg.title||'')===fb) return pageAllowed(p.title, pg.key);
        }
      }
      return false;
    }

    /* ===== DATA (tablo & özet) ===== */
    const tbody = document.getElementById('talebeTablosu');
    const kpiTalebe = document.getElementById('kpiTalebe');
    const ozAidat = document.getElementById('ozAidat');
    const ozKitap = document.getElementById('ozKitap');
    const ozToplam = document.getElementById('ozToplam');
    const kpiToplam = document.getElementById('kpiToplam');
    const barAidat = document.getElementById('barAidat');
    const barKitap = document.getElementById('barKitap');
    const barToplam = document.getElementById('barToplam');

    let aktifIsim=null;
    let tahsilatlarMap={};

    async function tabloyuYenile(){
      tbody.innerHTML='';
      const borclarSnap=await db.collection('talebe_borclar').get();
      const borclar={};
      let sumAidatPlan=0, sumKitapPlan=0;
      borclarSnap.forEach(doc=>{
        const d=doc.data()||{};
        const ta=Number(d.toplamAidat)||0, tk=Number(d.toplamKitap)||0;
        borclar[d.isim]={ toplamAidat:ta, toplamKitap:tk, aidatOdendi:0, kitapOdendi:0 };
        sumAidatPlan+=ta; sumKitapPlan+=tk;
      });

      const thSnap=await db.collection('aidat_kitap').get();
      tahsilatlarMap={};
      let sumAidatPaid=0, sumKitapPaid=0;
      thSnap.forEach(doc=>{
        const d=doc.data()||{};
        if(!d.isim || !borclar[d.isim]) return;
        const mikt=Number(d.miktar)||0;
        if(d.islemTuru==='Aidat'){ borclar[d.isim].aidatOdendi += mikt; sumAidatPaid+=mikt; }
        if(d.islemTuru==='Kitap'){ borclar[d.isim].kitapOdendi += mikt; sumKitapPaid+=mikt; }
        (tahsilatlarMap[d.isim] ||= []).push(d);
      });

      let toplamKalanAidat=0, toplamKalanKitap=0;
      const isimler=Object.keys(borclar).sort((a,b)=>a.localeCompare(b,'tr'));

      isimler.forEach(isim=>{
        const t=borclar[isim];
        const kalanAidat = Math.max(0, t.toplamAidat - t.aidatOdendi);
        const kalanKitap = Math.max(0, t.toplamKitap - t.kitapOdendi);
        const toplamBorc = kalanAidat + kalanKitap;

        toplamKalanAidat += kalanAidat;
        toplamKalanKitap += kalanKitap;

        const tr=document.createElement('tr');
        tr.innerHTML=`
          <td>${isim}</td>
          <td>${formatTL(t.aidatOdendi)}</td>
          <td>${formatTL(kalanAidat)}</td>
          <td>${formatTL(t.kitapOdendi)}</td>
          <td>${formatTL(kalanKitap)}</td>
          <td>${formatTL(toplamBorc)}</td>
        `;

        if(toplamBorc===0){
          tr.classList.add('tamamlandi');
        }else{
          if(kalanAidat===0){ tr.children[1].classList.add('odendi'); tr.children[2].classList.add('odendi'); }
          if(kalanKitap===0){ tr.children[3].classList.add('odendi'); tr.children[4].classList.add('odendi'); }
          tr.children[5].classList.add('borclu');
        }

        tr.addEventListener('click',()=>modalAc(isim));
        tbody.appendChild(tr);
      });

      const totKalan = toplamKalanAidat+toplamKalanKitap;
      const totPlan  = sumAidatPlan + sumKitapPlan;
      const totPaid  = sumAidatPaid + sumKitapPaid;

      ozAidat.textContent = formatTL(toplamKalanAidat);
      ozKitap.textContent = formatTL(toplamKalanKitap);
      ozToplam.textContent = formatTL(totKalan);
      kpiToplam.textContent = formatTL(totKalan);
      kpiTalebe.textContent = isimler.length;

      // Özet barları (kalan/plan yüzdesi)
      const pct = (paid, plan)=> plan>0 ? Math.max(0, Math.min(100, (paid/plan)*100)) : 0;
      barAidat.style.width = pct(sumAidatPaid, sumAidatPlan)+'%';
      barKitap.style.width = pct(sumKitapPaid, sumKitapPlan)+'%';
      barToplam.style.width = pct(totPaid, totPlan)+'%';
    }

    /* ===== Modal ===== */
    const modal = document.getElementById('detayModal');
    const modalBaslik = document.getElementById('modalBaslik');
    const odemeDetaylari = document.getElementById('odemeDetaylari');
    const modalKapatBtn = document.getElementById('modalKapat');

    function modalAc(isim){
      aktifIsim=isim;
      modalBaslik.textContent = `${isim} – Ödeme Detayları`;
      odemeDetaylari.innerHTML='';
      const kayitlar = (tahsilatlarMap[isim]||[]).slice().sort((a,b)=> new Date(b.tarih)-new Date(a.tarih));
      if(!kayitlar.length){
        odemeDetaylari.innerHTML='<div class="odeme-kaydi">Bu talebe için henüz ödeme kaydı yok.</div>';
      }else{
        kayitlar.forEach(k=>{
          const div=document.createElement('div'); div.className='odeme-kaydi';
          const tarih = k.tarih ? new Date(k.tarih) : new Date();
          div.innerHTML = `<strong>${k.islemTuru}</strong> – ${formatTL(k.miktar)} • ${k.odemeYontemi||'—'}
                           <div style="font-size:12px;color:var(--muted);margin-top:4px">${tarih.toLocaleDateString('tr-TR')} ${tarih.toLocaleTimeString('tr-TR')}</div>`;
          odemeDetaylari.appendChild(div);
        });
      }
      modal.classList.add('open');
      modal.setAttribute('aria-hidden','false');
    }
    function modalKapat(){
      modal.classList.remove('open');
      modal.setAttribute('aria-hidden','true');
    }
    modalKapatBtn.addEventListener('click',modalKapat);
    modal.addEventListener('click',(e)=>{ if(e.target===modal) modalKapat(); });
    document.addEventListener('keydown',(e)=>{ if(e.key==='Escape') modalKapat(); });

    // Tahsilat ekle
    document.getElementById('btnKaydet').addEventListener('click', async ()=>{
      const tur = document.getElementById('islemTuru').value;
      const miktar = Number(document.getElementById('tahsilatMiktar').value);
      const odemeYontemi = document.getElementById('odemeYontemi').value;
      if(!aktifIsim || !miktar){ showToast('Lütfen tüm alanları doldurun.'); return; }
      try{
        await db.collection('aidat_kitap').add({
          isim: aktifIsim,
          islemTuru: tur,
          miktar,
          odemeYontemi,
          tarih: new Date().toISOString()
        });
        document.getElementById('tahsilatMiktar').value='';
        showToast('✅ Tahsilat kaydedildi.');
        await tabloyuYenile();
        modalAc(aktifIsim);
      }catch(e){
        console.error(e); showToast('Kayıt sırasında hata.');
      }
    });

    /* ===== Drawer toggle ===== */
    (function(){
      const hamb=document.getElementById('hamburger'), drawer=document.getElementById('drawer');
      if(!hamb) return;
      hamb.addEventListener('click',()=>drawer.classList.toggle('open'));
      document.addEventListener('click',(e)=>{ if(!drawer.contains(e.target) && !hamb.contains(e.target)) drawer.classList.remove('open'); });
    })();

    /* ===== Auth & Yetki akışı ===== */
    function logout(){ auth.signOut().then(()=>location.replace('../index.html')); }
    try{ firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL); }catch(e){}

    async function bootstrap(){
      // 1) kullanıcı
      const user = auth.currentUser;
      if(!user){ location.replace('../index.html'); return; }

      // 2) yetkiler
      const uSnap = await db.collection('kullanicilar').doc(user.uid).get();
      const data  = uSnap.exists ? (uSnap.data()||{}) : {};
      const rawPerms = Array.isArray(data.yetkiler)? data.yetkiler : [];
      CURRENT_ALLOW = new Set(rawPerms.filter(s=>!/^[-!]/.test(String(s).trim())).map(norm));
      CURRENT_DENY  = new Set(rawPerms.filter(s=>/^[-!]/.test(String(s).trim())).map(s=>norm(String(s).replace(/^[-!]\s*/,''))));

      // 3) manifest
      const manifest = await readManifest();

      // 4) bu sayfanın yetkisi
      const allowedHere = currentPageAllowed(manifest);
      if(!allowedHere){ location.replace('../yetki-yok.html'); return; }

      // 5) menü
      const filtered = filterManifestByPerms(manifest);
      renderNav(filtered);

      // 6) veri
      await tabloyuYenile();
    }

    try{ firebase.auth().setPersistence(firebase.auth.Auth.Persistence.LOCAL); }catch(e){}
    auth.onAuthStateChanged(async (user)=>{
      if(!user){ setTimeout(()=>{ if(!auth.currentUser) location.replace('../index.html'); },120); return; }
      try{ await bootstrap(); }catch(e){ console.error(e); showToast('Veriler yüklenirken hata.'); }
    });
  </script>
</body>
</html>
